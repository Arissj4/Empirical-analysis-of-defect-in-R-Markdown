repo_owner,repo_name,commit_hash,author_name,author_email,author_date,committer_name,committer_email,committer_date,message,filenames,touches_rmd,touches_r,touches_r_or_rmd,is_merge,added,deleted,changed,diff
bcgov,CCISS_ShinyApp,58c2b047c663fb7368a27a58869958c293924bfb,Kiri,kiridaust@gmail.com,2025-06-25T00:18:01Z,Kiri,kiridaust@gmail.com,2025-06-25T00:18:01Z,various updated and bug fixes,Deploy_CCISS.R;Summary_Tables.R;app/CCISS_Version_Info.csv;app/app_bcgov_theme.R;app/cciss_export.csv;app/cciss_spatial/plot_functions.R;app/server.R;app/server/CCISS_Spatial.R;app/server/points.R;app/ui.R,False,True,True,False,2202,64,2266,"---FILE: Deploy_CCISS.R---
@@ -6,18 +6,24 @@ server <- analogsea::droplets()$`shiny-server`
 reset_ssh_sessions()
 droplet_ssh(server, ""rm -R /srv/shiny-server/cciss/server"")
 #analogsea::droplet_ssh(server,""rm -R /srv/shiny-server/ccissr/.Renviron"")
+
+analogsea::droplet_ssh(server, ""rm -R /srv/shiny-server/cciss/instructions"")
+analogsea::droplet_ssh(server, ""rm -R /srv/shiny-server/cciss/server/points.R"")
+analogsea::droplet_upload(server, ""./app/server/points.R"", ""/srv/shiny-server/cciss/server/"")
+
 analogsea::droplet_ssh(server, ""rm -R /srv/shiny-server/cciss"")
 analogsea::droplet_ssh(server, ""mkdir /srv/shiny-server/cciss"")
 analogsea::droplet_upload(server, ""./.Renviron"", ""/srv/shiny-server/cciss"")
-analogsea::droplet_ssh(server, ""R -e \""remotes::install_github('bcgov/ccissr@development', upgrade = FALSE)\"""")
+#analogsea::droplet_ssh(server, ""R -e \""remotes::install_github('bcgov/ccissr', upgrade = FALSE)\"""")
 analogsea::droplet_upload(server, ""./app/global.R"", ""/srv/shiny-server/cciss/global.R"")
 analogsea::droplet_upload(server, ""./app/server.R"", ""/srv/shiny-server/cciss/server.R"")
 analogsea::droplet_upload(server, ""./app/ui.R"", ""/srv/shiny-server/cciss/ui.R"")
 analogsea::droplet_upload(server, ""./app/www"", ""/srv/shiny-server/cciss"")
 analogsea::droplet_upload(server, ""./app/server"", ""/srv/shiny-server/cciss"")
+analogsea::droplet_upload(server, ""./app/cciss_spatial"", ""/srv/shiny-server/cciss"")
 analogsea::droplet_upload(server, ""./app/instructions"", ""/srv/shiny-server/cciss"")
 analogsea::droplet_upload(server, ""./app/WNA_SZ_Cols_v13_6.csv"", ""/srv/shiny-server/cciss"")
-analogsea::droplet_upload(server, c(""./app/cciss_metadata.csv"",""./app/README.txt""), ""/srv/shiny-server/cciss"")
+analogsea::droplet_upload(server, c(""./app/cciss_metadata.csv"",""./app/README.txt"",""./app/fonts"",""./app/lib"",""./app/CCISS_Version_Info.csv""), ""/srv/shiny-server/cciss"")
 analogsea::droplet_ssh(server, ""chown -R shiny:shiny /srv/shiny-server"")
 analogsea::droplet_ssh(server, ""systemctl restart shiny-server"")
 
@@ -41,3 +47,8 @@ analogsea::droplet_upload(server, c(""./app/cciss_metadata.csv"",""./app/README.txt
 analogsea::droplet_ssh(server, ""chown -R shiny:shiny /srv/shiny-server"")
 analogsea::droplet_ssh(server, ""systemctl restart shiny-server"")
 
+
+library(data.table)
+dat <- fread(""WNA_BGCs_Info.csv"")
+bgcs <- dat[DataSet == ""BC"",BGC]
+dput(sort(bgcs))

---FILE: Summary_Tables.R---
@@ -0,0 +1,473 @@
+### Colin's summary exports
+
+library(data.table)
+library(ccissr)
+library(climr)
+library(terra)
+library(bcmaps)
+library(ranger)
+library(RPostgres)
+library(pool)
+
+dbCon <- dbPool(
+  drv = RPostgres::Postgres(),
+  dbname = ""cciss_spatial"",
+  host = Sys.getenv(""BCGOV_HOST""),
+  port = 5432, 
+  user = Sys.getenv(""BCGOV_USR""),
+  password = Sys.getenv(""BCGOV_PWD"")
+)
+
+# function for calculating fractional suitabilities. 
+# ISSUE: RENAME SUIT TO FEAS THROUGHOUT THE SCRIPT
+fractionize <- function(x){
+  x[is.na(x)] <- 5 #set the NA values to suitability 5 (weights unsuitable a bit more heavily than suitable classes during averaging)
+  x[x==4] <- 5 #set 4 to suitability 5
+  x <- 1-(x-1)/4 #calculate as fractional suitability
+  return(x)
+}
+
+cciss_basic <- function(bgc_preds, selected_edatope, selected_spp, suit_table){
+  eda_table <- copy(E1)
+  eda_table[,HasPos := if(any(Edatopic == selected_edatope)) T else F, by = .(SS_NoSpace)]
+  eda_table <- eda_table[(HasPos),]
+  eda_table <- eda_table[is.na(SpecialCode),]
+  eda_table <- unique(eda_table[,.(BGC,SS_NoSpace)])
+  setkey(eda_table, BGC)
+  
+  idCols <- names(bgc_preds)
+  idCols <- idCols[!idCols %in% c(""BGC.pred"", ""BGC.ref"")]
+  setkey(bgc_preds,BGC.ref)
+  bgc_ss <- eda_table[bgc_preds, allow.cartesian = T]
+  setnames(bgc_ss, old = c(""BGC"",""SS_NoSpace""), new = c(""BGC.ref"", ""SS.ref""))
+  setkey(bgc_ss, BGC.pred)
+  bgc_ss <- eda_table[bgc_ss, allow.cartesian = T]
+  setnames(bgc_ss, old = c(""BGC"",""SS_NoSpace""), new = c(""BGC.pred"", ""SS.pred""))
+  setorderv(bgc_ss, c(idCols))
+  
+  suit_table <- suit_table[Spp == selected_spp,]
+  suit_table[,`:=`(BGC = NULL,
+                   Spp = NULL)]
+  setkey(bgc_ss, SS.ref)
+  bgc_ss[suit_table, Feas.ref := i.Feasible, on = c(SS.ref = ""SS_NoSpace"")]
+  setkey(bgc_ss, SS.pred)
+  bgc_ss[suit_table, Feas.pred := i.Feasible, on = c(SS.pred = ""SS_NoSpace"")]
+  
+  feas_out <- bgc_ss[,.(Feas.ref = mean(Feas.ref), Feas.pred = mean(Feas.pred)),
+                     by = c(idCols, ""BGC.ref"", ""BGC.pred"")]
+  
+  return(feas_out)
+}
+
+
+##trying to predict all pixels at once crashses due to RAM issues
+##so this function predicts in segments
+tile_predict <- function(Y1, pred_vars, maxSize = 6000000){
+  n = nrow(Y1)
+  brks <- seq(1,n,by = maxSize)
+  brks <- c(brks,n)
+  Y1[,BGC.pred := NA_character_]
+  for(j in 1:(length(brks)-1)){
+    Y1[brks[j]:brks[j+1],BGC.pred := predict(BGCmodel, Y1[brks[j]:brks[j+1],..pred_vars],num.threads = 10)[['predictions']]]
+  }
+  TRUE
+}
+
+dat <- bcmaps::nr_districts()
+
+spps.lookup <- get(data(""T1""))
+edatope.name <- c(""Medium-Mesic"", ""Poor-Subxeric"", ""Rich-Hygric"")
+
+gcms <- c(""ACCESS-ESM1-5"", ""CNRM-ESM2-1"", ""EC-Earth3"", ""GFDL-ESM4"", ""GISS-E2-1-G"", ""MIROC6"", ""MPI-ESM1-2-HR"", ""MRI-ESM2-0"")
+
+edatopes <- c(""B2"", ""C4"", ""D6"")
+edatope.names <- c(""Poor-subxeric"", ""Medium-mesic"", ""Rich-hygric"")
+
+# ssps <- c(""ssp126"", ""ssp245"")
+# ssp.names=c(""SSP1-2.6"", ""SSP2-4.5"")
+ssps <- c(""ssp245"")
+ssp.names=c(""SSP2-4.5"")
+
+periods <- c(""2001_2020"", ""2021_2040"", ""2041_2060"", ""2061_2080"", ""2081_2100"") 
+period.names=c(""2001-2020"", ""2021-2040"", ""2041-2060"", ""2061-2080"", ""2081-2100"")
+
+BGCcolors.BC <- read.csv(""BGCzone_Colorscheme.csv"") #TODO. make this a data object in ccissr or change the colors in the zone colours data object
+BGCcolors <- as.data.frame(get(data(""zones_colours_ref"")))
+BGCcolors.subzone <- as.data.frame(get(data(""subzones_colours_ref"")))
+BGCcolors$colour <- as.character(BGCcolors$colour)
+BGCcolors$colour[match(BGCcolors.BC$zone, BGCcolors$classification)] <- as.character(BGCcolors.BC$HEX) # reset BC colors to traditional BGC zone colors
+ColScheme <- BGCcolors$colour
+levels.bgc <- BGCcolors.subzone[,1]
+levels.zone <- BGCcolors[,1]
+zone.lookup <- levels.bgc
+for(i in levels.zone){ zone.lookup[grep(i,levels.bgc)] <- i }
+
+## attribute BGCs to points
+#bgcs <- st_read(""//objectstore2.nrs.bcgov/ffec/WNA_BGC/WNA_BGC_v12_5Apr2022.gpkg"") ##BGC map. takes forever to download for some reason... maybe vpn?
+bgcs <- st_read(""../Common_Files/WNA_BGC_v13_15Nov2024.gpkg"") ##BGC map.
+
+####step 1
+load(""../Common_Files/BGC_RFresp.Rdata"") ##load RF model
+pred_vars <- BGC_RFresp[[""forest""]][[""independent.variable.names""]] ##required predictors
+BGCmodel <- BGC_RFresp
+
+dem.source <- rast(""../Common_Files/composite_WNA_dem.tif"")
+dem.source <- aggregate(dem.source, fact = 3)
+
+dbExecute(dbCon, ""drop table if exists clim_change, predsum_bgc, predsum_zone, predsum_suit, predsum_spp, su_meta"")
+
+for(dist_i in seq_along(dat$ORG_UNIT)[-c(1:16)]){
+  studyarea <- dat$ORG_UNIT[dist_i]
+  bnd <- dat$geometry[dist_i]
+  message(""Processing "", studyarea)
+  
+  bnd <- vect(bnd)
+  bnd <- project(bnd,""epsg:4326"") # 
+  
+  dcrop <- crop(dem.source, bnd)
+  # fct <- as.integer(sqrt(ncell(dcrop)/80000))
+  # dem <- aggregate(dcrop, fct)
+  dem <- project(dcrop,""epsg:4326"") # 
+  dem <- mask(dem,bnd)
+  
+  metadt <- data.table(studyarea = studyarea, res = res(dem)[1], mn_lat = mean(ext(dem)[3:4]), tot_area = ncell(dem[!is.na(dem)]))
+  print(metadt)
+  dbWriteTable(dbCon, ""su_meta"", metadt, row.names = F, append = T)
+#}
+  ## make the climr input file
+  points_dat <- as.data.frame(dem, cells=T, xy=T)
+  colnames(points_dat) <- c(""id"", ""lon"", ""lat"", ""elev"")
+  points_dat <- points_dat[,c(2,3,4,1)] #restructure for climr input
+  # values(X)[points_dat$id] <- points_dat$el ; plot(X)
+  
+  
+  # library(bcmaps)
+  # bgcs <- bec() ##BGC map from bcmaps package
+  points_sf <- st_as_sf(points_dat, coords = c(""lon"", ""lat""), crs = 4326)
+  points_sf <- st_transform(points_sf,3005)
+  bgc_att <- st_join(points_sf, bgcs)
+  bgc_att <- data.table(st_drop_geometry(bgc_att))
+  
+  ### -------------------------------------------------------
+  ### BGC Projections for reference period
+  ### -------------------------------------------------------
+  
+  clim <- downscale(points_dat,
+                    which_refmap  = ""refmap_prism"",
+                    gcms  = NULL,
+                    return_refperiod  = TRUE, 
+                    vars = list_vars())
+  addVars(clim)
+  identity.grid <- data.table(id=clim$id, GCM=rep(""obs"", dim(clim)[1]), SSP=rep(""obs"", dim(clim)[1]), RUN=rep(NA, dim(clim)[1]), PERIOD=clim$PERIOD)
+  ## calculate mean climate of study area for use in calculating change
+  clim.refmean <- apply(as.data.frame(clim)[,-c(1:2)], 2, FUN=mean, na.rm=T)
+  #write.csv(t(as.data.frame(clim.refmean)), paste(outdir, ""/clim.refMean.csv"", sep="".""), row.names = F)
+  
+  #initiate the table to store the climate change values (zeros because this is the reference period)
+  change <- data.frame(""GCM""=""obs"", ""SSP""=""obs"", ""RUN""=NA, ""PERIOD""=""1961_1990"", as.data.frame(t(rep(0, length(clim.refmean)))))
+  names(change)[-c(1:4)] <- names(clim.refmean)
+  
+  #clean the points_dat and clim tables of NAs
+  points_dat <- points_dat[!is.nan(clim$CMI)|!is.na(clim$CMI),]
+  clim <- clim[!is.nan(CMI)|!is.na(CMI),]
+  
+  tile_predict(clim,pred_vars=pred_vars) 
+  bgc_preds_ref <- clim[,.(id,PERIOD,BGC.pred)] 
+  
+  ### -------------------------------------------------------
+  ### BGC Projections for historical periods
+  ### -------------------------------------------------------
+  
+  clim <- downscale(points_dat,
+                    which_refmap  = ""refmap_prism"",
+                    gcms  = NULL,
+                    obs_periods = ""2001_2020"",
+                    return_refperiod  = F, 
+                    vars = list_vars())
+  addVars(clim)
+  
+  ## calculate climate change
+  clim.mean <- apply(as.data.frame(clim)[,-c(1:2)], 2, FUN=mean, na.rm=T)
+  change.temp <- clim.mean - clim.refmean
+  change <- rbind(change, data.frame(""GCM""=""obs"", ""SSP""=""obs"", ""RUN""=NA, ""PERIOD""=""2001_2020"", as.data.frame(t(change.temp))))
+  
+  # Predict BGC
+  clim <- clim[!is.nan(CMI)|!is.na(CMI),]
+  tile_predict(clim,pred_vars) 
+  bgc_preds_hist <- clim[,.(id,PERIOD,BGC.pred)] 
+  bgc_preds_hist[bgc_preds_ref, BGC.ref := i.BGC.pred, on = ""id""]
+  ### -------------------------------------------------------
+  ### BGC Projections for future periods
+  ### -------------------------------------------------------
+  
+  ssp=ssps[1]
+  for(ssp in ssps){
+    #period=periods[1]
+    for(period in periods){
+      
+      # Climate data
+      clim <- downscale(points_dat,
+                        which_refmap  = ""refmap_prism"",
+                        gcms = gcms,
+                        ssps = ssp,
+                        gcm_periods = period,
+                        max_run = 3L,
+                        return_refperiod = FALSE,
+                        vars = list_vars())
+      addVars(clim)
+      unique(clim$GCM)
+      
+      ## calculate ensemble mean and append to clim
+      clim.ensembleMean <- clim[RUN == ""ensembleMean"", lapply(.SD, mean), by = id, .SDcols = !(id:PERIOD)]
+      identity <- data.table(
+        id = clim.ensembleMean$id,
+        GCM = rep(""ensembleMean"", dim(clim.ensembleMean)[1]),
+        SSP = ssp, 
+        RUN = rep(""ensembleMean"", dim(clim.ensembleMean)[1]), 
+        PERIOD = period
+      )
+      clim.ensembleMean <- cbind(identity, clim.ensembleMean[,!""id""])
+      clim <- rbind(clim, clim.ensembleMean)
+      
+      ## calculate mean climate change across study area [ISSUE: REFACTOR TO DATA.TABLE]
+      clim.mean <- as.data.frame(clim[, lapply(.SD, function(x) mean(x, na.rm = TRUE)), by = .(GCM, SSP, RUN, PERIOD), .SDcols = !(id:PERIOD)]) #mean value for each run across the study area. 
+      change.temp <- sweep(clim.mean[,-c(1:4)], 2, clim.refmean, FUN='-') # subtract the reference period mean vector from each row. 
+      change <- rbind(change, cbind(clim.mean[,c(1:4)], change.temp)) # append to the mean change table. 
+      
+      ## BGC projections 
+      clim <- clim[!is.nan(CMI)|!is.na(CMI),]
+      tile_predict(clim,pred_vars) ##predict BGC!
+      bgc_preds_temp <- clim[,.(id,GCM,SSP,RUN,PERIOD,BGC.pred)] ##this now has all the raw predictions
+      bgc_preds_temp[bgc_preds_ref, BGC.ref := i.BGC.pred, on = ""id""]
+      
+      # append the predictions to the predictions table
+      bgc_preds <- if(period==periods[1] & ssp==ssps[1]) bgc_preds_temp else rbind(bgc_preds, bgc_preds_temp)
+      
+      print(period)
+    }
+    print(ssp)
+  }
+  
+  setDT(change)
+  change_long <- melt(change, id.vars = c(""GCM"",""SSP"",""RUN"",""PERIOD""), value.name = ""value"", variable.name = ""var"")
+  setnames(change_long, c(""gcm"",""ssp"",""run"",""period"",""var"",""value""))
+  change_long[,studyarea := studyarea]
+  dbWriteTable(dbCon, ""clim_change"", change_long, row.names = FALSE, append = TRUE)
+  
+  #mean_change_ls[[studyarea]] <- change
+  #write.csv(change, paste(outdir, ""/clim.meanChange.csv"", sep="".""), row.names = F)
+  
+  #===============================================================================
+  # Make and export summary tables of bgc units for each future
+  #===============================================================================
+  
+  # Reference bgc
+  index=1 # added this because rows are reordered (alphabetically) during dcast and i need a way to preserve row order. 
+  BGC.pred.ref <- bgc_preds_ref$BGC.pred
+  zone.pred.ref <- zone.lookup[match(BGC.pred.ref, levels.bgc)]
+  PredSum.bgc <- data.frame(index=index, ""GCM""=""obs"", ""SSP""=""obs"", ""RUN""=NA, ""PERIOD""=""1961_1990"", as.data.frame(table(BGC.pred.ref, dnn=c(""bgc.pred""))))
+  PredSum.zone <- data.frame(index=index, ""GCM""=""obs"", ""SSP""=""obs"", ""RUN""=NA, ""PERIOD""=""1961_1990"", as.data.frame(table(zone.pred.ref, dnn=c(""zone.pred""))))
+  PredSum.bgc.home <- data.frame(index=index, ""GCM""=""obs"", ""SSP""=""obs"", ""RUN""=NA, ""PERIOD""=""1961_1990"", as.data.frame(table(BGC.pred.ref[which(BGC.pred.ref == BGC.pred.ref)], dnn=c(""bgc.pred""))))
+  PredSum.zone.home <- data.frame(index=index, ""GCM""=""obs"", ""SSP""=""obs"", ""RUN""=NA, ""PERIOD""=""1961_1990"", as.data.frame(table(zone.pred.ref[which(zone.pred.ref == zone.pred.ref)], dnn=c(""zone.pred""))))
+  
+  # Historical bgc
+  index <- index+1
+  bgc.pred <- bgc_preds_hist$BGC.pred
+  zone.pred <- zone.lookup[match(bgc.pred, levels.bgc)]
+  PredSum.bgc <- rbind(PredSum.bgc, data.frame(index=index, ""GCM""=""obs"", ""SSP""=""obs"", ""RUN""=NA, ""PERIOD""=""2001_2020"", as.data.frame(table(bgc.pred, dnn=c(""bgc.pred"")))))
+  PredSum.zone <- rbind(PredSum.zone, data.frame(index=index, ""GCM""=""obs"", ""SSP""=""obs"", ""RUN""=NA, ""PERIOD""=""2001_2020"", as.data.frame(table(zone.pred, dnn=c(""zone.pred"")))))
+  PredSum.bgc.home <- rbind(PredSum.bgc.home, data.frame(index=index, ""GCM""=""obs"", ""SSP""=""obs"", ""RUN""=NA, ""PERIOD""=""2001_2020"", as.data.frame(table(bgc.pred[which(bgc.pred == BGC.pred.ref)], dnn=c(""bgc.pred""))))) #within home range of each bgc unit, for calcuations of persistence and expansion
+  PredSum.zone.home <- rbind(PredSum.zone.home, data.frame(index=index, ""GCM""=""obs"", ""SSP""=""obs"", ""RUN""=NA, ""PERIOD""=""2001_2020"", as.data.frame(table(zone.pred[which(zone.pred == zone.pred.ref)], dnn=c(""zone.pred""))))) #within home range of each bgc unit, for calcuations of persistence and expansion
+  
+  # Future bgc
+  for(ssp in ssps){
+    for(period in periods){
+      for(gcm in unique(bgc_preds$GCM)){
+        runs <- unique(bgc_preds[GCM==gcm, RUN])
+        run=runs[1]
+        for(run in runs){
+          index <- index+1
+          # bgc predictions
+          bgc.pred <- bgc_preds[GCM==gcm & SSP==ssp & RUN==run & PERIOD==period,]
+          bgc.pred <- bgc.pred[order(id), BGC.pred] # extra step here just to ensure that the values are in order of ascending id. 
+          
+          # zone lists
+          zone.pred <- zone.lookup[match(bgc.pred, levels.bgc)]
+          
+          #summary tables
+          PredSum.bgc <- rbind(PredSum.bgc, data.frame(index=index, ""GCM""=gcm, ""SSP""=ssp, ""RUN""=run, ""PERIOD""=period, as.data.frame(table(bgc.pred, dnn=c(""bgc.pred"")))))
+          PredSum.zone <- rbind(PredSum.zone, data.frame(index=index, ""GCM""=gcm, ""SSP""=ssp, ""RUN""=run, ""PERIOD""=period, as.data.frame(table(zone.pred, dnn=c(""zone.pred"")))))
+          temp <- table(bgc.pred[which(bgc.pred == BGC.pred.ref)], dnn=c(""bgc.pred"")) # pulling this out to solve for edge case where there is no persistence (no matches between ref and pred)
+          PredSum.bgc.home <- rbind(PredSum.bgc.home, data.frame(index=index, ""GCM""=gcm, ""SSP""=ssp, ""RUN""=run, ""PERIOD""=period, if(length(temp)==0) data.frame(bgc.pred=NA, Freq=NA) else as.data.frame(temp))) #within home range of each bgc unit, for calculations of persistence and expansion
+          PredSum.zone.home <- rbind(PredSum.zone.home, data.frame(index=index, ""GCM""=gcm, ""SSP""=ssp, ""RUN""=run, ""PERIOD""=period, as.data.frame(table(zone.pred[which(zone.pred == zone.pred.ref)], dnn=c(""zone.pred""))))) #within home range of each bgc unit, for calculations of persistence and expansion
+          # print(run)
+        }
+        # print(gcm)
+      }
+      print(period)
+    }
+    print(ssp)
+  }
+  
+  # write out summary of bgc units for each future. #ISSUE: NEED TO REFACTOR THIS WHOLE SCRIPT TO DATA.TABLE
+  PredSum.bgc.wide <- dcast(setDT(PredSum.bgc), index+GCM+SSP+RUN+PERIOD~bgc.pred, value.var = ""Freq"")
+  PredSum.zone.wide <- dcast(setDT(PredSum.zone), index+GCM+SSP+RUN+PERIOD~zone.pred, value.var = ""Freq"")
+  PredSum.bgc.home.wide <- dcast(setDT(PredSum.bgc.home), index+GCM+SSP+RUN+PERIOD~bgc.pred, value.var = ""Freq"")
+  if(""NA"" %in% names(PredSum.bgc.home.wide)) PredSum.bgc.home.wide <- PredSum.bgc.home.wide[,!""NA""] #remove the NA column if it exists
+  PredSum.zone.home.wide <- dcast(setDT(PredSum.zone.home), index+GCM+SSP+RUN+PERIOD~zone.pred, value.var = ""Freq"")
+  if(""NA"" %in% names(PredSum.zone.home.wide)) PredSum.zone.home.wide <- PredSum.zone.home.wide[,!""NA""]
+
+  ##subzones
+  setDT(PredSum.bgc)
+  setDT(PredSum.bgc.home)
+  setnames(PredSum.bgc, c(""index"",""gcm"",""ssp"",""run"",""period"",""bgc_pred"",""freq""))
+  setnames(PredSum.bgc.home, c(""index"",""gcm"",""ssp"",""run"",""period"",""bgc_pred"",""freq""))
+  PredSum.bgc[,home := FALSE]
+  PredSum.bgc.home[,home := TRUE]
+  predsum_bgc <- rbind(PredSum.bgc,PredSum.bgc.home)
+  predsum_bgc <- predsum_bgc[!is.na(bgc_pred),]
+  predsum_bgc[,studyarea := studyarea]
+  dbWriteTable(dbCon, ""predsum_bgc"",predsum_bgc, row.names = FALSE, append = TRUE)
+  
+  ##zones
+  setDT(PredSum.zone)
+  setDT(PredSum.zone.home)
+  setnames(PredSum.zone, c(""index"",""gcm"",""ssp"",""run"",""period"",""zone_pred"",""freq""))
+  setnames(PredSum.zone.home, c(""index"",""gcm"",""ssp"",""run"",""period"",""zone_pred"",""freq""))
+  PredSum.zone[,home := FALSE]
+  PredSum.zone.home[,home := TRUE]
+  predsum_zone <- rbind(PredSum.zone,PredSum.zone.home)
+  predsum_zone <- predsum_zone[!is.na(zone_pred),]
+  predsum_zone[,studyarea := studyarea]
+  dbWriteTable(dbCon, ""predsum_zone"",predsum_zone, row.names = FALSE, append = TRUE)
+  
+  #===============================================================================
+  #===============================================================================
+  # Species Feasibility Projections
+  #===============================================================================
+  #===============================================================================
+  
+  ##read feasibility table from db
+  data(S1)
+  S1 <- S1[,.(bgc,ss_nospace, spp, newfeas)]
+  setnames(S1,c(""BGC"",""SS_NoSpace"",""Spp"",""Feasible""))
+  
+  # select the species to run the analysis on
+  spps <- unique(S1$Spp)
+  spps <- spps[-which(spps==""X"")]
+  spps.candidate <- spps.lookup$TreeCode[-which(spps.lookup$Exclude==""x"")]
+  spps <- as.character(spps[which(spps%in%spps.candidate)] )
+  # spps <- c(""Pl"", ""Fd"", ""Cw"", ""Ep"", ""Dr"", ""Hw"", ""Mb"", ""Pw"", ""Ss"", ""Ba"", ""Yc"", ""Hm"")
+  
+  ## non-THLB BGCs for exclusion from area summaries 
+  # ## ISSUE: ADD LAKES TO THIS, OR REMOVE LAKE CELLS FROM THE ANALYSIS ENTIRELY
+  # BGCs_notin_THLB <- data(""BGCs_notin_THLB"") # this won't work until the pull request is merged into the loaded version of ccissr. 
+  # exclude <- bgc_att$id[which(bgc_att$MAP_LABEL%in%BGCs_notin_THLB$BGC[which(BGCs_notin_THLB$Exlude==""x"")])]
+  # include <- if(length(exclude)>0) bgc_att$id[-which(bgc_att$id%in%exclude)] else bgc_att$id
+  #dbExecute(dbCon, ""drop table predsum_suit"")
+  edatope=""C4""
+  for(edatope in edatopes){
+    
+    #initiate tables to store summary values
+    PredSum.suit <- data.frame(PredSum.bgc.wide[,1:5], as.data.frame(matrix(rep(NA, length(spps)*dim(PredSum.bgc.wide)[1]), dim(PredSum.bgc.wide)[1])))
+    names(PredSum.suit)[-c(1:5)] <- spps
+    PredSum.spp <- PredSum.suit
+    PredSum.suit.home <- PredSum.suit #home is for counting cells within historical range. 
+    PredSum.spp.home <- PredSum.suit
+    
+    spp=""Fd""
+    for(spp in spps){
+      
+      # get the suitability for the reference period and recent observed predicted BGC.
+      suit.hist <- cciss_basic(bgc_preds_hist, edatope, spp, S1)
+      
+      #reference period suitabilities
+      #suit.ref <- suit.hist[id%in%include]
+      suit.ref <- fractionize(suit.hist[order(id), Feas.ref]) # second step to ensure order of ids is sequential
+      outRange.ref <- which(suit.ref==0)
+      row <- which(PredSum.suit$GCM==""obs"" & PredSum.suit$PERIOD==""1961_1990"")
+      col <- which(names(PredSum.suit)==spp)
+      PredSum.suit[row,col] <- round(sum(suit.ref))
+      PredSum.spp[row,col] <- round(sum(suit.ref>0))
+      PredSum.suit.home[row,col] <- round(sum(suit.ref[-outRange.ref]))
+      PredSum.spp.home[row,col] <- round(sum((suit.ref>0)[-outRange.ref]))
+      
+      #recent observed climate
+      suit.proj <- suit.hist#[id%in%include]
+      suit.proj <- fractionize(suit.proj[order(id), Feas.pred]) # second step to ensure order of ids is sequential
+      row <- which(PredSum.suit$GCM==""obs"" & PredSum.suit$PERIOD==""2001_2020"")
+      PredSum.suit[row,col] <- round(sum(suit.proj))
+      PredSum.spp[row,col] <- round(sum(suit.proj>0))
+      PredSum.suit.home[row,col] <- round(sum(suit.proj[-outRange.ref]))
+      PredSum.spp.home[row,col] <- round(sum((suit.proj>0)[-outRange.ref]))
+      
+      # Future Climates
+      suit <- cciss_basic(bgc_preds, edatope, spp, S1)
+      
+      # Evaluate if species is too minor across all futures for inclusion in results
+      total.area <- dim(points_dat)[1] # this is the total number of cells in the study area
+      suit.area <- sum(table(suit$Feas.pred)[which(names(table(suit$Feas.pred))<4)])/(dim(unique(bgc_preds[,2:5]))[1]) #this is the average number of cells in which the species is suitable
+      small <- suit.area/total.area < 0.01 # establish insignificant species for removal
+      
+      for(ssp in ssps){
+        period=""2001_2020""
+        for(period in periods){
+          for(gcm in unique(bgc_preds$GCM)){
+            runs <- unique(suit[GCM==gcm & SSP==ssp, RUN])
+            run=runs[1]
+            for(run in runs){
+              suit.proj <- suit[GCM==gcm & SSP==ssp & RUN==run & PERIOD==period,] #id%in%include & 
+              suit.proj <- fractionize(suit.proj[order(id), Feas.pred]) # second step to ensure order of ids is sequential
+              row <- which(PredSum.suit$GCM==gcm & PredSum.suit$SSP==ssp & PredSum.suit$RUN==run & PredSum.suit$PERIOD==period)
+              PredSum.suit[row,col] <- round(sum(suit.proj))
+              PredSum.spp[row,col] <- round(sum(suit.proj>0))
+              PredSum.suit.home[row,col] <- round(sum(suit.proj[-outRange.ref]))
+              PredSum.spp.home[row,col] <- round(sum((suit.proj>0)[-outRange.ref]))
+              
+              # print(run)
+            }
+            # print(gcm)
+          }
+          #===============================================================================
+          
+          # print(period)
+        }
+        # print(ssp)
+      }
+      print(paste(spp, "" ("", round(which(spps==spp)/length(spps)*100, 0), ""%)"", sep=""""))
+    }
+    
+    ##spp
+    setDT(PredSum.spp)
+    setDT(PredSum.spp.home)
+    PredSum.spp.long <- melt(PredSum.spp, id.vars = c(""index"",  ""GCM"",    ""SSP"" ,   ""RUN""   , ""PERIOD""), 
+                             variable.name = ""spp"",value.name = ""area"")
+    PredSum.spp.home.long <- melt(PredSum.spp.home, id.vars = c(""index"",  ""GCM"",    ""SSP"" ,   ""RUN""   , ""PERIOD""), 
+                                  variable.name = ""spp"",value.name = ""area"")
+    setnames(PredSum.spp.long, c(""index"",""gcm"",""ssp"",""run"",""period"",""spp"",""area""))
+    setnames(PredSum.spp.home.long, c(""index"",""gcm"",""ssp"",""run"",""period"",""spp"",""area""))
+    PredSum.spp.long[,home := FALSE]
+    PredSum.spp.home.long[,home := TRUE]
+    predsum_spp <- rbind(PredSum.spp.long,PredSum.spp.home.long)
+    predsum_spp[,`:=`(studyarea = studyarea, edatope = edatope)]
+    dbWriteTable(dbCon, ""predsum_spp"",predsum_spp, row.names = FALSE, append = TRUE)
+    
+    ##suit
+    setDT(PredSum.suit)
+    setDT(PredSum.suit.home)
+    PredSum.suit.long <- melt(PredSum.suit, id.vars = c(""index"",  ""GCM"",    ""SSP"" ,   ""RUN""   , ""PERIOD""), 
+                              variable.name = ""spp"",value.name = ""area"")
+    PredSum.suit.home.long <- melt(PredSum.suit.home, id.vars = c(""index"",  ""GCM"",    ""SSP"" ,   ""RUN""   , ""PERIOD""), 
+                                   variable.name = ""spp"",value.name = ""area"")
+    setnames(PredSum.suit.long, c(""index"",""gcm"",""ssp"",""run"",""period"",""spp"",""area""))
+    setnames(PredSum.suit.home.long, c(""index"",""gcm"",""ssp"",""run"",""period"",""spp"",""area""))
+    PredSum.suit.long[,home := FALSE]
+    PredSum.suit.home.long[,home := TRUE]
+    predsum_suit <- rbind(PredSum.suit.long,PredSum.suit.home.long)
+    predsum_suit[,`:=`(studyarea = studyarea, edatope = edatope)]
+    dbWriteTable(dbCon, ""predsum_suit"",predsum_suit, row.names = FALSE, append = TRUE)
+    
+    print(edatope)
+  }
+  message(""Done"",studyarea)
+}

---FILE: app/CCISS_Version_Info.csv---
@@ -4,5 +4,5 @@ WNA_BGC_Map,v13.2,2024-04-01
 climr,v0.1.1,2021-09-10
 BGC_Model,v13.2.0,2025-03-10
 Reference Guide,v2021,2021-09-10
-Suitability Table,v13_16,2025-04-14
-Edatopic Table,v13_9,2025-04-10
+Suitability Table,v13_19,2025-04-14
+Edatopic Table,v13_11,2025-04-10

---FILE: app/app_bcgov_theme.R---
@@ -55,3 +55,10 @@ writeLines(f8, bsw)
 v <- ""lib/bsw5/dist/bcgov/_variables.scss""
 cat(c(""\n$nav-underline-border-width: 0rem !default;"", '\n$theme: ""bcgov"" !default;', '\n$navbar-bg: theme-color(primary-nav);'), file = v, append = TRUE)
 
+bslib::bs_theme(
+  preset = ""bcgov"",
+  ""navbar-brand-padding-y"" = ""0rem"",
+  ""navbar-brand-margin-end"" = ""4rem""
+) |>
+  sass::sass_bundle() |>
+  writeLines(""theme.scss"")

---FILE: app/cciss_spatial/plot_functions.R---
@@ -61,7 +61,7 @@ model_ids <- data.table(model = c(""Novelty_ACCESS-ESM1-5.csv"", ""Novelty_EC-Earth
                                   ""Novelty_GISS-E2-1-G.csv"", ""Novelty_MIROC6.csv"", ""Novelty_MPI-ESM1-2-HR.csv"", 
                                   ""Novelty_MRI-ESM2-0.csv"", ""Novelty_Obs.csv"", ""Novelty_SZ_Ensemble.csv""), id = 1:8)
 
-temp <- c(""Pl"",""Sx"",""Fd"",""Cw"",""Hw"",""Bl"",""At"", ""Ac"", ""Ep"", ""Yc"", ""Pw"", ""Ss"", ""Bg"", ""Lw"")
+temp <- temp <- c(""Pl"",""Sx"",""Fd"",""Cw"",""Hw"",""Py"", ""Bl"",""At"", ""Ac"", ""Ep"", ""Yc"", ""Pw"", ""Ss"", ""Bg"", ""Lw"")
 cw_spp <- data.table(Spp = temp, spp_id = seq_along(temp))
 
 plot_suitability <- function(dbCon, cellid, edatope, spp_name){
@@ -71,7 +71,7 @@ plot_suitability <- function(dbCon, cellid, edatope, spp_name){
                 ""C4"" = 2,
                 ""D6"" = 3
   )
-  
+  browser()
   dat <- dbGetQuery(dbCon, paste0(""select fp_code, newsuit, prop1, prop2, prop3 from cciss_feas where cellid = "",
                                   cellid,"" and edatope = "",eda,"" and spp_id = "",spp_id)) |> as.data.table()
   dat_h <- dbGetQuery(dbCon, paste0(""select suit from cciss_historic where cellid = "",
@@ -92,7 +92,7 @@ plot_suitability <- function(dbCon, cellid, edatope, spp_name){
   dat[,EX := 100L - (E1 + E2 + E3)]
   dat[,CCISS_Suit := as.character(CCISS_Suit/100)]
   dat[CCISS_Suit > 3.5, CCISS_Suit := ""X""]
-  missing <- setdiff(c(1981,2001,2021,2041,2061), dat$Period)
+  missing <- setdiff(c(1981,2001,2021,2041,2061, 2081), dat$Period)
   if(length(missing) >= 1) {
     temp2 <- data.table(Period = missing, CCISS_Suit = ""X"", E1 = 0, E2 = 0, E3 = 0, EX = 100)
     dat <- rbind(dat, temp2)
@@ -107,7 +107,8 @@ plot_suitability <- function(dbCon, cellid, edatope, spp_name){
     scale_color_manual(values = palette.suit, aesthetics = c(""colour"",""fill"")) +
     ylab(""Percent of Votes"") +
     theme_bw() +
-    scale_x_continuous(breaks=seq(1961,2070,by = 20),labels = c(""1961-1990"",""2001-2020 (obs)"",""2001-2020"",""2021-2040"",""2041-2060"",""2061-2080""))
+    scale_x_continuous(breaks=seq(1961,2090,by = 20),labels = c(""1961-1990"",""2001-2020 (obs)"",""2001-2020"",""2021-2040"",""2041-2060"",""2061-2080"",""2081-2100"")) +
+    theme(axis.text.x = element_text(angle = 45, hjust = 1))
   
   x <- girafe(ggobj = fplt)
   x <- girafe_options(x,
@@ -258,7 +259,11 @@ plot_bgc <- function(dbCon, studyarea, xvariable, gcm_nm, run_nm, unit = c(""Zone
   dat_obs[,area := freq/1000]
   
   if(!is.null(focal_bgc)){
+    #browser()
     temp <- data.table(gcm = unique(bgc_area_f$gcm),period = NA, freq = bgc_area_f[gcm == ""obs"",freq], xvar = bgc_area_f[gcm == ""obs"",xvar])
+    if(nrow(temp) == 0) {
+      temp <- data.table(gcm = unique(bgc_area_f$gcm),period = NA, freq = 0, xvar = 1971)
+    }
     temp[is.na(xvar), xvar := if(xvariable == ""Time"") 1971 else 0]
     bgc_area_f <- rbind(temp, bgc_area_f)[gcm != ""obs"",]
     temp_wide <- dcast(bgc_area_f, xvar ~ gcm, value.var = ""freq"")
@@ -300,10 +305,7 @@ plot_bgc <- function(dbCon, studyarea, xvariable, gcm_nm, run_nm, unit = c(""Zone
       ylab(ylabel) +
       xlab(xlabel)
   }
-  x <- girafe(ggobj = ggobj)
-  x <- girafe_options(x,
-                      opts_toolbar(hidden = c(""lasso_select"",""lasso_deselect"")))
-  x
+  ggobj
 }
 
 plot_species <- function(dbCon, studyarea, xvariable,  gcm_nm, run_nm, edatope, spp_select = NULL, focal_species = NULL, plot_obs = TRUE){
@@ -423,10 +425,7 @@ plot_species <- function(dbCon, studyarea, xvariable,  gcm_nm, run_nm, edatope,
       ylab(""Suitable Area ('000 sq.km)"")
     
   }
-  x <- girafe(ggobj = ggobj)
-  x <- girafe_options(x,
-                      opts_toolbar(hidden = c(""lasso_select"",""lasso_deselect"")))
-  x
+  ggobj
 }
 
 

---FILE: app/server.R---
@@ -94,7 +94,7 @@ shinyServer(function(input, output, session) {
   # Reusing Shiny session userData environment
   uData <- session$userData
   portfolio_results <- reactiveValues(data = NULL)
-  session_params <- reactiveValues(estabWt = c(0.3,0.35,0.35),futWt = c(0.25,0.25,0.25,0.25),
+  session_params <- reactiveValues(estabWt = c(0.25,0.25,0.50),futWt = c(0.1,0.3,0.3,0.3),
                                    modelWt = all_weight, rcpWt = rcp_weight, gcmWt = gcm_weight,
                                    show_novelty = TRUE, nov_c = 5, show_ohr = TRUE)
   update_flag <- reactiveVal(0)

---FILE: app/server/CCISS_Spatial.R---
@@ -141,35 +141,37 @@ observe({
   
 })
 
+##turn off novelty when type is changed
+observeEvent(input$type,{
+  updateCheckboxInput(session, ""novelty"", value = FALSE)
+})
+
 observeEvent({c(input$map_stat,input$type, input$novelty)},{
   if(input$novelty) {
     globalLeg$Legend <- c(0,2,4,6,8)
     globalLeg$Colours <- c(""gray90"", ""gray50"", ""#FFF200"", ""#CD0000"", ""#000000"")
     globalLeg$Title <- ""Sigma Novelty""
   } else {
-    if(input$map_stat == ""NewFeas""){
-      globalLeg$Legend <- c(""Primary"",""Secondary"",""Tertiary"")
-      globalLeg$Colours <- c(""#006400"", ""#1E90FF"", ""#EEC900"")
+    if(input$type == ""Suitability""){
+      globalLeg$Legend <- c(""E1: High"",""E2: Moderate"",""E3: Low"",""EX: Unsuitable"")
+      globalLeg$Colours <- c(""#006400"", ""#1E90FF"", ""#EEC900"",""#F7F7F7"")
       globalLeg$Title <- ""Climatic Suitability""
-    } else if(input$map_stat == ""MeanChange"") {
+    }
+    if(input$map_stat == ""MeanChange"") {
       globalLeg$Legend <- c(""-3"",""-2"",""-1"",""No change"",""+1"",""+2"",""+3"",""Becoming unsuitable"",""Newly Suitable (3)"",""Newly Suitable (2)"",""Newly Suitable (1)"")
       globalLeg$Colours <- c(""#67001F"", ""#D6604D"", ""#FDDBC7"", ""#F7F7F7"", 
                              ""#D1E5F0"", ""#4393C3"", ""#053061"", ""#000000"", 
                              ""#FFFFCC"", ""#FFEDA0"", ""#FED976"")
       globalLeg$Title <- ""Change in Suitability""
-    } else {
-      globalLeg$Legend <- c(""Primary"",""Secondary"",""Tertiary"")
-      globalLeg$Colours <- c(""#006400"", ""#1E90FF"", ""#EEC900"")
-      globalLeg$Title <- ""Climatic Suitability""
     }
   }
 })
 
 observe({
   if(!is.null(input$period_type) & input$type != ""BGC"") {
     if(input$period_type == ""Historic""){
-      globalLeg$Legend <- c(""Primary"",""Secondary"",""Tertiary"")
-      globalLeg$Colours <- c(""#006400"", ""#1E90FF"", ""#EEC900"")
+      globalLeg$Legend <- c(""E1: High"",""E2: Moderate"",""E3: Low"",""EX: Unsuitable"")
+      globalLeg$Colours <- c(""#006400"", ""#1E90FF"", ""#EEC900"",""#F7F7F7"")
       globalLeg$Title <- ""Climatic Suitability""
     }
   }
@@ -212,19 +214,28 @@ observeEvent(input$map_click,{
                        texttemplate = ""%{text}"") %>%
           layout(yaxis = list(title = """", tickformat = "".1%""),
                  xaxis = list(showspikes = FALSE, title = list(text = ""Period""),
-                              ticktext = c(""1961-1990"",""2001-2020 (obs)"", ""2001-2020"", ""2021-2040"",""2041-2060"",""2061-2080""),
-                              tickvals = c(1961,1981,2001,2021,2041,2061)),
+                              ticktext = c(""1961-1990"",""2001-2020 (obs)"", ""2001-2020"", ""2021-2040"",""2041-2060"",""2061-2080"",""2081-2100""),
+                              tickvals = c(1961,1981,2001,2021,2041,2061,2081)),
                  barmode = 'stack')
         fig
       })
       
-      output$feas_plot <- renderGirafe({
-        plot_suitability(dbCon, cellid = cell_click, edatope = input$edatope_feas, spp_name = input$species_feas)
-      })
+      
+      
+      if(input$species_feas %in% c(""Ac"",""Ep"",""Pw"",""Ss"",""Bg"")) {
+        output$feas_plot <- NULL
+        output$feas_message <- renderText(""Sorry, plots for this species are not currently available."")
+      } else {
+        output$feas_plot <- renderGirafe({
+          plot_suitability(dbCon, cellid = cell_click, edatope = input$edatope_feas, spp_name = input$species_feas)
+        })
+        output$feas_message <- NULL
+      }
       
       showModal(modalDialog(
         title = paste0(""BGC and Suitability Projections""),
         plotlyOutput(""bgc_plot""),
+        textOutput(""feas_message""),
         girafeOutput(""feas_plot""),
         easyClose = TRUE,
         footer = NULL,
@@ -248,27 +259,28 @@ observeEvent(input$map_click,{
         elev <- dbGetQuery(pool, elev_info_sql)
         point_focal <- data.table(lon = lng, lat = lat, elev = elev$elevation_m[1], id = 1)
         if(input$gcm_select == ""SZ_Ensemble"") {
-          point_clim <- climr::downscale_db(point_focal, gcms = gcms_use, 
+          point_clim <- climr::downscale(point_focal, gcms = gcms_use, 
                                             ssps = ""ssp245"", gcm_periods = input$period_select,
                                             vars = as.vector(outer(c(""Tmin"", ""Tmax"", ""PPT""), c(""wt"", ""sp"", ""sm"", ""at""), paste, sep = ""_"")),
                                             return_refperiod = FALSE)
           point_clim <- point_clim[,lapply(.SD, mean), .SDcols = as.vector(outer(c(""Tmin"", ""Tmax"", ""PPT""), c(""wt"", ""sp"", ""sm"", ""at""), paste, sep = ""_""))]
         } else {
-          point_clim <- climr::downscale_db(point_focal, gcms = input$gcm_select, 
+          point_clim <- climr::downscale(point_focal, gcms = input$gcm_select, 
                                             ssps = ""ssp245"", gcm_periods = input$period_select,
                                             run_nm = runs_use[gcms_use == input$gcm_select],
                                             vars = as.vector(outer(c(""Tmin"", ""Tmax"", ""PPT""), c(""wt"", ""sp"", ""sm"", ""at""), paste, sep = ""_"")),
                                             return_refperiod = FALSE)
+          point_clim <- point_clim[PERIOD != ""1961_1990"",]
         }
         
         
-        output$feas_plot <- renderPlotly({
+        output$novelty_plot <- renderPlotly({
           plot_analog_novelty(clim.target = test_fut, clim.analog = test_hist, clim.icv = test_icv, clim.point = point_clim, analog.focal = input$bgc_pred_click, pcs = NULL)
         })
         
         showModal(modalDialog(
           title = paste0(""Analog Novelty Plot""),
-          plotlyOutput(""feas_plot"", height = ""70vh""),
+          plotlyOutput(""novelty_plot"", height = ""70vh""),
           size = ""l"",
           easyClose = TRUE,
           footer = NULL
@@ -292,8 +304,8 @@ observeEvent(input$map_click,{
                          texttemplate = ""%{text}"") %>%
             layout(yaxis = list(title = """", tickformat = "".1%""),
                    xaxis = list(showspikes = FALSE, title = list(text = ""Period""),
-                                ticktext = c(""1961-1990"",""2001-2020 (obs)"", ""2001-2020"", ""2021-2040"",""2041-2060"",""2061-2080""),
-                                tickvals = c(1961,1981,2001,2021,2041,2061)),
+                                ticktext = c(""1961-1990"",""2001-2020 (obs)"", ""2001-2020"", ""2021-2040"",""2041-2060"",""2061-2080"",""2081-2100""),
+                                tickvals = c(1961,1981,2001,2021,2041,2061,2081)),
                    barmode = 'stack')
           fig
         })
@@ -402,16 +414,6 @@ observeEvent(input$region_type,{
   session$sendCustomMessage(""resize_map"",""waddles"")
 })
 
-# Show or hide the plot based on toggle input
-# observeEvent(input$region_type, {
-#   if (input$region_type == ""None"") {
-#     print(""show plot"")
-#     show(""plot-container"")
-#   } else {
-#     hide(""plot-container"")
-#   }
-# })
-
 
 observe({
   if(input$region_type != ""None""){
@@ -463,16 +465,53 @@ output$summary_plot <- renderGirafe({
   if(input$type == ""BGC""){
     if(input$zone_sz) smry <- ""Zone""
     else smry <- ""Subzone""
-    plot_bgc(dbCon, stdarea, xvariable = input$xvariable, gcm_nm = gcm_curr, run_nm = run_curr, 
-             unit = smry, focal_bgc = plot_vals(), plot_obs = input$plot_obs)
+    p <- plot_bgc(dbCon, stdarea, xvariable = input$xvariable, gcm_nm = gcm_curr, run_nm = run_curr, 
+                                 unit = smry, focal_bgc = plot_vals(), plot_obs = input$plot_obs)
+
   }else{
-    #browser()
-    plot_species(dbCon, stdarea, xvariable = input$xvariable, gcm_nm = gcm_curr, 
-                 run_nm = run_curr, edatope = input$edatope_feas, spp_select = input$species_feas, 
-                 focal_species = plot_vals(), plot_obs = input$plot_obs)
+    p <- plot_species(dbCon, stdarea, xvariable = input$xvariable, gcm_nm = gcm_curr, 
+                      run_nm = run_curr, edatope = input$edatope_feas, spp_select = input$species_feas, 
+                      focal_species = plot_vals(), plot_obs = input$plot_obs)
   }
+  x <- girafe(ggobj = p)
+  x <- girafe_options(x,
+                      opts_toolbar(hidden = c(""lasso_select"",""lasso_deselect"")))
+  x
 })
 
+output$sum_plt_download <- downloadHandler(
+  filename = function(){
+    paste0(input$type, ""_Summary_"", input$dist_click, "".png"")
+  },
+  content = function(file) {
+    stdarea <- input$dist_click
+    if(input$period_type %in% c(""Historic"",""obs"")){
+      gcm_curr <- ""ensembleMean""
+      run_curr <- ""ensembleMean""
+    } else {
+      if(grepl(""Ensemble"", input$gcm_select)){
+        gcm_curr <- ""ensembleMean""
+        run_curr <- ""ensembleMean""
+      }else{
+        gcm_curr <- input$gcm_select
+        run_curr <- runs_use[gcms_use == input$gcm_select]
+      }
+    }
+    if(input$type == ""BGC""){
+      if(input$zone_sz) smry <- ""Zone""
+      else smry <- ""Subzone""
+      p <- plot_bgc(dbCon, stdarea, xvariable = input$xvariable, gcm_nm = gcm_curr, run_nm = run_curr, 
+               unit = smry, focal_bgc = plot_vals(), plot_obs = input$plot_obs)
+    }else{
+      #browser()
+      p <- plot_species(dbCon, stdarea, xvariable = input$xvariable, gcm_nm = gcm_curr, 
+                   run_nm = run_curr, edatope = input$edatope_feas, spp_select = input$species_feas, 
+                   focal_species = plot_vals(), plot_obs = input$plot_obs)
+    }
+    ggsave(file, plot = p, width = 8, height = 6, dpi = 300)
+  }
+)
+
 observeEvent(input$summary_plot_selected,{
   plot_vals(input$summary_plot_selected)
 })

---FILE: app/server/points.R---
@@ -30,7 +30,7 @@ output$points_table <- DT::renderDataTable({
       pts[, uData$pts_show_col, with = FALSE], rownames = FALSE,
       options = list(searching = FALSE, lengthChange = TRUE, pageLength = 5,
                      scrollX = FALSE, scrollY = ""185px"", scrollCollapse = FALSE),
-      editable = list(target = ""row"", disable = list(columns = c(1,5)))
+      editable = list(target = ""row"", disable = list(columns = c(0,4)))
     )
   }else{
     NULL
@@ -59,8 +59,8 @@ new_points <- function(points) {
       res <- as.data.table(dbPointInfo(pool, points))
       if(nrow(points) > 1){
         setnames(res, old = ""id"", new = ""ID"")
-        points[,ID := as.numeric(ID)]
-        res[,ID := as.numeric(ID)]
+        # points[,ID := as.numeric(ID)]
+        # res[,ID := as.numeric(ID)]
         setorder(res, ID)
         setorder(points, ID)
         # res[, popups := paste(""<b>"", tools::toTitleCase(gsub(""_"", "" "", names(.SD))), "":</b>"", .SD, collapse = ""<br />""),
@@ -302,11 +302,12 @@ observeEvent(input$points_table_cell_edit, {
   points <- data.table(
     ID = as.character(info$value[1]),
     Site = as.character(1),
-    Lat = as.numeric(info$value[3]),
-    Long = as.numeric(info$value[4]),
-    Elev = as.numeric(info$value[5]),
-    BGC = as.character(1)
+    Lat = as.numeric(info$value[2]),
+    Long = as.numeric(info$value[3]),
+    Elev = as.numeric(info$value[4]),
+    BGC = as.character(5)
   )
+  #browser()
   points <- new_points(points)
   # Using a copy to trigger reactive change in `userpoints$dt`
   pts <- copy(userpoints$dt)

---FILE: app/ui.R---
@@ -460,7 +460,7 @@ $(document).ready(function(){
           condition = ""input.type !== 'BGC'"",
           h1(""Suitability Options""),
           selectInput(""edatope_feas"",""Select Edatope (SNR/SMR)"", choices = c(""B2"",""C4"",""D6""), selected = ""C4"", multiple = FALSE),
-          selectInput(""species_feas"", ""Select Species"", choices = c(""Pl"",""Sx"",""Fd"",""Cw"",""Hw"",""Bl"",""At"", ""Ac"", ""Ep"", ""Yc"", ""Pw"", ""Ss"", ""Bg"", ""Lw"", ""Sb""), multiple = FALSE)
+          selectInput(""species_feas"", ""Select Species"", choices = c(""Pl"",""Sx"",""Fd"",""Cw"",""Hw"",""Py"", ""Bl"",""At"", ""Ac"", ""Ep"", ""Yc"", ""Pw"", ""Ss"", ""Bg"", ""Lw"", ""Sb""), multiple = FALSE)
         ),
         
         conditionalPanel(
@@ -471,7 +471,7 @@ $(document).ready(function(){
         
         conditionalPanel(
           condition = ""input.type !== 'BGC' & input.period_type == 'Future'"",
-          selectInput(""period_feas"",""Select Period"", choices = c(periods[-5])),     
+          selectInput(""period_feas"",""Select Period"", choices = c(periods)),     
         ),
         conditionalPanel(
           condition = ""input.period_type !== 'Historic' & input.gcm_select !== 'Zone_Ensemble'"",
@@ -534,7 +534,8 @@ $(document).ready(function(){
                             actionButton(""reset_plot"",""Reset Plot""),
                             actionButton(""reset_district"",""Clear Selected Subregion""),
                             actionButton(""action_download"",""Download Data""),
-                            girafeOutput(""summary_plot"")
+                            girafeOutput(""summary_plot""),
+                            downloadButton(""sum_plt_download"",""Download Plot"")
                           )
                       )
                     )"
bcgov,CCISS_ShinyApp,46fc55b82f19f4e4152cc99ddbaec688661c8364,Comeau,Vanessa.Comeau@gov.bc.ca,2025-05-08T23:22:03Z,Comeau,Vanessa.Comeau@gov.bc.ca,2025-05-08T23:22:03Z,VC additions to known issues,instructions-raw/4a_KnownIssues.Rmd,True,False,True,False,33,4,37,"---FILE: instructions-raw/4a_KnownIssues.Rmd---
@@ -12,10 +12,39 @@ editor_options:
 
 ### Known issues with the CCISS tool
 
-This section is focused on aspects of the CCISS analysis related to trade-offs and intrinsic sources of error. We also list bugs or minor enhancements that have not yet been resolved. If you have an problem or suggestion to report, you can enter it as a ""New issue"" in our <a href=""https://github.com/bcgov/CCISS_ShinyApp/issues"" target=""_blank"">GitHub repo </a>. 
-
+This section is focused on aspects of the CCISS analysis related to
+trade-offs and intrinsic sources of error. We also list bugs or minor
+enhancements that have not yet been resolved. If you have an problem or
+suggestion to report, you can enter it as a ""New issue"" in our
+<a href=""https://github.com/bcgov/CCISS_ShinyApp/issues"" target=""_blank"">GitHub
+repo </a>.
 
 #### Issues requiring fixing
 
-- The CCISS tool should only take about 10 seconds to load at startup. However, it has recently been taking up to 50 seconds. We are investigating this issue. 
-- The CCISS tool is currently missing CFRG species suitability ratings (""Suitability"" tab) and silvics information (""Silvics"" tab) for coastal subzone/variants, this is associated with updating to the new coastal BEC version (BEC13). We will update this information using a crosswalk table from BEC v12 coastal site series (LMH 26 & 28) to BEC v13 (LHM77) asap. 
+-   The CCISS tool should only take about 10 seconds to load at startup.
+    However, it has recently been taking up to 50 seconds. We are
+    investigating this issue.
+
+-   The CCISS tool is currently missing CFRG species suitability ratings
+    (""Suitability"" tab) and silvics information (""Silvics"" tab) for
+    coastal subzone/variants, this is associated with updating to the
+    new coastal BEC version (BEC13). We will update this information
+    using a crosswalk table from BEC v12 coastal site series (LMH 26 and
+    28) to BEC v13 (LHM77) asap.
+
+-   OHR (Outside Home Range) species suitability ratings for white pine
+    (Pw) have been added in the Skeena Region. However, the CCISS tool
+    does not include the full extent of white pine suitability outside
+    of home range. Additional modeling and expert knowledge is needed to
+    complete the distribution of white pine OHR suitability. This work
+    is ongoing and will be documented and integrated into the CCISS
+    tool. See ""Methods"" - ""Outside Home Range"" for more information.
+
+-   There are known issues related to the classification and mapping of
+    northern BGC units. This includes unclassified units, labeled ""un"",
+    for example SWBun or ESSFun. Additionally, some current BGC units
+    may need to be split in the future. For example, the SBSwk1 has been
+    mapped differently in the Omineca vs. Cariboo Regions. Douglas-fir
+    is very rare in the Cariboo SBSwk1 but more common in the Omineca.
+    SBSwk1 mapping will likely need substantial revisions in the
+    Omineca."
bcgov,CCISS_ShinyApp,13ca26103b97d746e910d0c3f7a472d7b9c9ec38,Comeau,Vanessa.Comeau@gov.bc.ca,2025-05-01T19:43:39Z,Comeau,Vanessa.Comeau@gov.bc.ca,2025-05-01T19:43:39Z,updated known issues with missing CFRG and silvics info for coast,instructions-raw/4a_KnownIssues.Rmd,True,False,True,False,1,1,2,"---FILE: instructions-raw/4a_KnownIssues.Rmd---
@@ -18,4 +18,4 @@ This section is focused on aspects of the CCISS analysis related to trade-offs a
 #### Issues requiring fixing
 
 - The CCISS tool should only take about 10 seconds to load at startup. However, it has recently been taking up to 50 seconds. We are investigating this issue. 
-- There currently are no site series names for most of the coastal subzone/variants. This is associated with updating to the new coastal BEC version (BEC13). As a result, the **Silvics** tab does not return results for coastal units. We will resolve this asap. 
+- The CCISS tool is currently missing CFRG species suitability ratings (""Suitability"" tab) and silvics information (""Silvics"" tab) for coastal subzone/variants, this is associated with updating to the new coastal BEC version (BEC13). We will update this information using a crosswalk table from BEC v12 coastal site series (LMH 26 & 28) to BEC v13 (LHM77) asap. "
bcgov,CCISS_ShinyApp,04db38162a1320157737c9adc5c1f18ba02a7605,Obrist,Debora.Obrist@gov.bc.ca,2025-04-14T21:57:42Z,Obrist,Debora.Obrist@gov.bc.ca,2025-04-14T21:57:42Z,fixing typo,instructions-raw/3c_SuitabilityRatings.Rmd,True,False,True,False,1,1,2,"---FILE: instructions-raw/3c_SuitabilityRatings.Rmd---
@@ -156,7 +156,7 @@ account for different time periods in the CCISS tool:
 
 **Historic Suitability**: The baseline environmental suitability rating
 based primarily on the expert suitability ratings of the historic period
-(19961-1990).
+(1961-1990).
 
 **Establishment Suitability**: The suitability rating based on the mean
 historic, current (2001-2020), and 2021-2040 future projected"
bcgov,CCISS_ShinyApp,a50370a90f8e8beb3bd45f4d6e1fe9fe3547d0c5,Colin Mahony,colin.mahony@gov.bc.ca,2025-03-31T01:07:28Z,Colin Mahony,colin.mahony@gov.bc.ca,2025-03-31T01:07:28Z,add baselineBGCs rationale to known issues.,app/ui.R;instructions-raw/4c_BaselineBGCs.Rmd;instructions-raw/4c_BaselineBGCs.html,True,True,True,False,149,0,149,"---FILE: app/ui.R---
@@ -686,6 +686,11 @@ $(document).ready(function(){
               value = ""cciss_4b"",
               includeHTML(""./instructions/4b_SourcesOfError.html"") 
             ),
+            tabPanel(
+              title = ""BGC mapping as a baseline"",
+              value = ""cciss_4c"",
+              includeHTML(""./instructions/4c_BaselineBGCs.html"") 
+            ),
             tabPanel(
               title = ""Space-for-time Substitution"",
               value = ""cciss_4d"",

---FILE: instructions-raw/4c_BaselineBGCs.Rmd---
@@ -0,0 +1,24 @@
+---
+title: 
+output: 
+    html_document:
+        theme: null
+        highlight: null
+        mathjax: null
+editor_options: 
+  markdown: 
+    wrap: 72
+---
+
+### BGC mapping as a baseline
+
+CCISS results assess change in species suitability relative to the official biogeoclimatic mapping, rather than the baseline prediction of the biogeoclimatic model. This approach breaks a standard practice of climate impacts modeling: Change in a modeled quantity should be assessed against a modeled baseline. We have taken this approach to simplify interpretation of CCISS results. Our rationale is explained below. 
+
+Biogeoclimatic models are trained on biogeoclimatic mapping (the response variable) and 1961-1990 climate normals (the predictor variables) for a sample of locations. When the model is then used to predict the biogeoclimatic unit from 1961-1990 climate normals, this is called a *baseline prediction*. Baseline predictions do not perfectly reproduce the original biogeoclimatic mapping because of imperfections in the biogeoclimatic model, biogeoclimatic mapping, and climate mapping. Biogeoclimatic models typically have baseline prediction error of ~20%, meaning that the baseline biogeoclimatic prediction is different than the official biogeoclimatic subzone/variant mapping on about 20% of the landscape. In many cases where these differences occur, the predicted unit is closely related to the mapped unit and there is negligible consequence for tree species suitability inferences. 
+
+Baseline predictions are the technically correct point of comparison for biogeoclimatic projections of recent or future climates. If the mapped biogeoclimatic unit is used as a baseline, there is the potential to confuse model error with an actual change in climate. This conflation of model error with real changes causes overestimation of biogeoclimatic turn-over, but it can produce underestimation or overestimation of changes in species suitability. The impact of this conflation will be greatest in the recent period (2001-2020) since the magnitude of prediction error relative to climate change decreases over time. 
+
+Even though a modeled baseline prediction is strictly more correct, we have chosen to use the official biogeoclimatic mapping as the baseline for CCISS results. The benefit of this approach is that the starting point for users will be the expected biogeoclimatic unit and species suitability ratings of their locations of interest. The alternative--using the modeled baseline prediction--would in some cases produce a baseline biogeoclimatic unit that is different than the biogeoclimatic unit of interest. This would not be tenable for core CCISS end uses such as silviculture prescriptions and stocking standards development. 
+
+Given that the mapped and predicted baseline BGC unit are different on <20% of most landscapes, and that these differences are inconsequential for species suitability interpretations in many cases, the practical impact of this approach is likely not large. Nevertheless, we have not yet assessed this issue quantitatively. Users are encouraged to use the CCISS spatial module to assess baseline prediction errors for locations of critical interest and to consider the implications for species suitability interpretations. 
+

---FILE: instructions-raw/4c_BaselineBGCs.html---
@@ -0,0 +1,120 @@
+<!DOCTYPE html>
+
+<html>
+
+<head>
+
+<meta charset=""utf-8"" />
+<meta name=""generator"" content=""pandoc"" />
+<meta http-equiv=""X-UA-Compatible"" content=""IE=EDGE"" />
+
+<meta name=""viewport"" content=""width=device-width, initial-scale=1"" />
+
+
+
+<title>4c_BaselineBGCs.knit</title>
+
+<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
+// be compatible with the behavior of Pandoc < 2.8).
+document.addEventListener('DOMContentLoaded', function(e) {
+  var hs = document.querySelectorAll(""div.section[class*='level'] > :first-child"");
+  var i, h, a;
+  for (i = 0; i < hs.length; i++) {
+    h = hs[i];
+    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
+    a = h.attributes;
+    while (a.length > 0) h.removeAttribute(a[0].name);
+  }
+});
+</script>
+
+<style type=""text/css"">
+code{white-space: pre-wrap;}
+span.smallcaps{font-variant: small-caps;}
+span.underline{text-decoration: underline;}
+div.column{display: inline-block; vertical-align: top; width: 50%;}
+div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
+ul.task-list{list-style: none;}
+.display.math{display: block; text-align: center; margin: 0.5rem auto;}
+</style>
+
+
+
+
+
+
+
+
+
+
+
+</head>
+
+<body>
+
+
+
+
+
+
+
+<div id=""bgc-mapping-as-a-baseline"" class=""section level3"">
+<h3>BGC mapping as a baseline</h3>
+<p>CCISS results assess change in species suitability relative to the
+official biogeoclimatic mapping, rather than the baseline prediction of
+the biogeoclimatic model. This approach breaks a standard practice of
+climate impacts modeling: Change in a modeled quantity should be
+assessed against a modeled baseline. We have taken this approach to
+simplify interpretation of CCISS results. Our rationale is explained
+below.</p>
+<p>Biogeoclimatic models are trained on biogeoclimatic mapping (the
+response variable) and 1961-1990 climate normals (the predictor
+variables) for a sample of locations. When the model is then used to
+predict the biogeoclimatic unit from 1961-1990 climate normals, this is
+called a <em>baseline prediction</em>. Baseline predictions do not
+perfectly reproduce the original biogeoclimatic mapping because of
+imperfections in the biogeoclimatic model, biogeoclimatic mapping, and
+climate mapping. Biogeoclimatic models typically have baseline
+prediction error of ~20%, meaning that the baseline biogeoclimatic
+prediction is different than the official biogeoclimatic subzone/variant
+mapping on about 20% of the landscape. In many cases where these
+differences occur, the predicted unit is closely related to the mapped
+unit and there is negligible consequence for tree species suitability
+inferences.</p>
+<p>Baseline predictions are the technically correct point of comparison
+for biogeoclimatic projections of recent or future climates. If the
+mapped biogeoclimatic unit is used as a baseline, there is the potential
+to confuse model error with an actual change in climate. This conflation
+of model error with real changes causes overestimation of biogeoclimatic
+turn-over, but it can produce underestimation or overestimation of
+changes in species suitability. The impact of this conflation will be
+greatest in the recent period (2001-2020) since the magnitude of
+prediction error relative to climate change decreases over time.</p>
+<p>Even though a modeled baseline prediction is strictly more correct,
+we have chosen to use the official biogeoclimatic mapping as the
+baseline for CCISS results. The benefit of this approach is that the
+starting point for users will be the expected biogeoclimatic unit and
+species suitability ratings of their locations of interest. The
+alternativeusing the modeled baseline predictionwould in some cases
+produce a baseline biogeoclimatic unit that is different than the
+biogeoclimatic unit of interest. This would not be tenable for core
+CCISS end uses such as silviculture prescriptions and stocking standards
+development.</p>
+<p>Given that the mapped and predicted baseline BGC unit are different
+on &lt;20% of most landscapes, and that these differences are
+inconsequential for species suitability interpretations in many cases,
+the practical impact of this approach is likely not large. Nevertheless,
+we have not yet assessed this issue quantitatively. Users are encouraged
+to use the CCISS spatial module to assess baseline prediction errors for
+locations of critical interest and to consider the implications for
+species suitability interpretations.</p>
+</div>
+
+
+
+<!-- code folding -->
+
+
+
+</body>
+</html>"
bcgov,CCISS_ShinyApp,4f15978308cfc2221886e091197cd2b02229fbb6,Obrist,Debora.Obrist@gov.bc.ca,2025-03-28T22:39:41Z,Obrist,Debora.Obrist@gov.bc.ca,2025-03-28T22:39:41Z,Fix merge 2,app/server/LeafletSource.R;app/server/feasibility.R;app/server/futures.R;app/server/generate.R;app/server/map.R;app/server/reportpdf.Rmd;app/server/tooltip_verbage.R;app/ui.R;instructions-raw/0a_documentationStructure.Rmd;instructions-raw/2a_SelectSites.Rmd;instructions-raw/2a_SelectSites.html;instructions-raw/2b_FeasibilityReport.Rmd;instructions-raw/2b_FeasibilityReport.html;instructions-raw/2c_BECFutures.Rmd;instructions-raw/2d_SilvicsEcology.Rmd;instructions-raw/2e_Export.Rmd;instructions-raw/3a_MethodsOverview.Rmd;instructions-raw/3a_MethodsOverview.html;instructions-raw/3b_BEC.Rmd;instructions-raw/3c_FeasibilityRatings.Rmd;instructions-raw/3d_ClimateProjections.Rmd;instructions-raw/3e_BGCmodel.Rmd;instructions-raw/3f_NovelClimates.Rmd;instructions-raw/3g_EdatopicOverlap.Rmd;instructions-raw/3h_Rulesets.Rmd,True,True,True,False,574,370,944,"---FILE: app/server/LeafletSource.R---
@@ -313,7 +313,7 @@ addBGC <- function(map) {
         id:""opacity_slider2"",
         orientation:""horizontal"",
         position:""bottomleft"",
-        logo:\'<img src=""www/opacity.svg"" />\',
+        logo:\'<img src=""opacity.svg"" />\',
         max:1,
         step:0.01,
         syncSlider:true,

---FILE: app/server/feasibility.R---
@@ -119,7 +119,7 @@ cciss_results_dt <- function(data, siteref, siteserie, filter, format = ""html"")
 
     tempTable <- knitr::kable(
       data, format = format, align = c(""l"",""c"",""c"",""c"",""c"",""c"",""c""), escape = FALSE,
-      col.names = c(""Tree Species"", ""Period"", ""Modelled Feasibility"",
+      col.names = c(""Tree Species"", ""Period"", ""Modelled Suitability"",
                     ""CFRG Suitability"", ""CFRG P/A"", ""Environmental"",""Establishment"",
                     ""Maturity"",""<u>Improve/Same</u><br />Decline/Unsuitable""),
       table.attr = 'class=""table table-hover""') %>%

---FILE: app/server/futures.R---
@@ -28,13 +28,13 @@ output$bgc_fut_plot <- plotly::renderPlotly({
   dat_bgc <- copy(uData$bgc)
   dat_bgc[,BGC := NULL]
   plotdat <- merge.data.table(data,dat_bgc, on = c(""SiteRef"",""FuturePeriod"",""BGC.pred""), all= TRUE)
-  bgc_fut_plotly(plotdat, siteref, sseries, minallow)
+  bgc_fut_plotly(plotdat, siteref, sseries, minallow, show_ss = input$future_showss)
 })
 
 # Graph
 
 #' @param data BGC data.table
-bgc_fut_plotly <- function(data, siteref, sseries, minallow, period_map = uData$period_map, ...) {
+bgc_fut_plotly <- function(data, siteref, sseries, minallow, show_ss = ""BGC"", period_map = uData$period_map, ...) {
   #data <- data[SSratio > minallow,]
   dat_order <- data.table(FuturePeriod = c(""1961"",""1991"",""2001"",""2021"",""2041"",""2061"", ""2081""), fpCode = c(1,2,3.5,4.5,5.5,6.5,7.5))
   #browser()
@@ -56,20 +56,31 @@ bgc_fut_plotly <- function(data, siteref, sseries, minallow, period_map = uData$
   color_ref <- {
     colors <- subzones_colours_ref[classification %in% unique(data2$BGC.pred)]
     col <- c(colors$colour,""#000000"")
-    names(col) <- c(colors$classification,""novel"")
+    names(col) <- c(colors$classification,""Novel Climate"")
     col
   }
-  if(input$future_showss == ""BGC""){
+  # data2[,text_col := ""#000000""]
+  data2[BGC.pred == ""novel"", BGC.pred := ""Novel Climate""]
+  temp <- unique(data2$BGC.pred)
+  if(any(grepl(""Novel"",temp))) {
+    data2[,BGC.pred := factor(BGC.pred, levels = c(sort(temp[-grep(""Novel"",temp)]),""Novel Climate""))]
+  } else {
+    data2[,BGC.pred := factor(BGC.pred, levels = sort(temp))]
+  }
+  
+  # data2[,BGC.pred := as.character(BGC.pred)]
+  if(show_ss == ""BGC""){
     plotly::plot_ly(data = data2, x = ~fpCode,
                     y = ~BGC.prop, split = ~BGC.pred, type = 'bar',
                     color = ~BGC.pred, colors = color_ref, hovertemplate = ""%{y}"",
-                    text = ~BGC.pred, textposition = 'inside', textfont = list(color = ""black"", size = 12),
+                    text = ~BGC.pred, insidetextfont = list(size = 12), 
+                    textfont = list(color = ""#FFF""), textposition = 'inside',
                     texttemplate = ""%{text}"") %>%
       plotly::layout(yaxis = list(title = """", tickformat = "".1%""),
                      xaxis = list(showspikes = FALSE, title = list(text = ""Period""),
                                   ticktext = unname(period_map),
                                   tickvals = dat_order$fpCode),
-                     barmode = 'stack', legend = l, hovermode = ""x unified"")
+                     barmode = 'stack', showlegend = FALSE, legend = l, hovermode = ""x unified"")
   }else{
     data <- data[SiteRef == siteref & SS_NoSpace == sseries,]
     data_ss <- merge(data2, data, on = c(""SiteRef"",""FuturePeriod"",""BGC.pred""), all = T)
@@ -83,7 +94,7 @@ bgc_fut_plotly <- function(data, siteref, sseries, minallow, period_map = uData$
                      xaxis = list(showspikes = FALSE, title = list(text = ""Period""),
                                   ticktext = unname(period_map),
                                   tickvals = dat_order$fpCode),
-                     barmode = 'stack', legend = l, hovermode = ""x unified"")
+                     barmode = 'stack',showlegend = FALSE, legend = l, hovermode = ""x unified"")
   }
   
 }

---FILE: app/server/generate.R---
@@ -31,11 +31,10 @@ observeEvent(input$generate_results, priority = 100, {
   tic(""Process CCISS data"", ticker)
   cciss           <- uData$cciss           <- cciss(bgc ,session_params$estabWt,session_params$futWt)
   tic(""Format CCISS Results"", ticker)
-  cciss_results   <- uData$cciss_results   <- cciss_results(cciss, bgc, pts, avg, type = as.logical(input$aggregation))
+  cciss_results   <- uData$cciss_results   <- cciss_results(cciss, bgc, pts, avg, type = as.logical(avg))
   update_flag(update_flag() + 1) ##make sure things recalculate
   # UI select choices
   tic(""Determine UI choices"", ticker)
-  #browser()
   siterefs        <- uData$siterefs        <- sort(unique(bgc$SiteRef))
   ss_opts <- sort(unique(uData$sspreds$SS_NoSpace))
   bgc_opts <- unique(uData$bgc$BGC)
@@ -187,6 +186,7 @@ cciss <- function(bgc,estabWt,futWt) {
     bgc <- bgc[BGC.pred != ""novel"",]
   }
   edaOut <- edatopicOverlap(bgc, copy(E1), copy(E1_Phase))
+  #browser()
   SSPred <- edaOut$NoPhase
   setorder(SSPred,SiteRef,SS_NoSpace,FuturePeriod,BGC.pred,-SSratio)
   uData$eda_out <- edaOut$phase
@@ -219,7 +219,7 @@ cciss_results <- function(cciss, bgc, pts, avg, type, SS = ccissr::stocking_stan
     # use a copy to avoid modifying the original object
     results <- copy(cciss$Raw)
     sumResults <- copy(cciss$Summary)
-    
+    #browser()
     if(session_params$show_novelty){
       bgc_nov <- bgc[BGC.pred == ""novel"",]
       bgc_nov[,FuturePeriod := as.integer(FuturePeriod)]

---FILE: app/server/map.R---
@@ -2,7 +2,7 @@
 # Map main
 output$bec_map <- renderLeaflet({
   leaflet::leaflet() %>%
-    leaflet::setView(lng = -122.77222, lat = 51.2665, zoom = 7) %>%
+    leaflet::setView(lng = -122.77222, lat = 54.2665, zoom = 6) %>%
     leaflet::addProviderTiles(leaflet::providers$CartoDB.PositronNoLabels, group = ""Positron"",
                               options = leaflet::pathOptions(pane = ""mapPane"")) %>%
     leaflet::addProviderTiles(leaflet::providers$CartoDB.DarkMatterNoLabels, group = ""DarkMatter"",
@@ -26,16 +26,15 @@ output$bec_map <- renderLeaflet({
       group = ""Mapbox Labels"",
       options = leaflet::pathOptions(pane = ""overlayPane"")) %>%
     addBGC() %>%
-    #invokeMethod(data = subzones_colours_ref, method = ""addBGCTiles"", ~classification, ~colour) %>%
     leaflet::hideGroup(""DarkMatter Labels"") %>%
     leaflet::hideGroup(""Positron Labels"") %>%
     leaflet.extras::addSearchOSM(options = leaflet.extras::searchOptions(collapsed = TRUE, hideMarkerOnCollapse = TRUE, autoCollapse = TRUE, zoom = 11)) %>%
     leaflet::addLayersControl(
       baseGroups = c(""Positron"", ""DarkMatter"", ""Satellite"", ""Hillshade""),
       overlayGroups = c(""Subzones Variants"",""Districts"", ""Positron Labels"", ""DarkMatter Labels"", ""Mapbox Labels""),
-      position = ""topright"") %>%
+      position = ""topright"")
     ##leaflet::addPolygons(color = ""purple"") %>% 
-    leaflet::addMiniMap(toggleDisplay = TRUE, minimized = TRUE)
+    ##leaflet::addMiniMap(toggleDisplay = TRUE, minimized = TRUE)
 })
 
 # Map proxy

---FILE: app/server/reportpdf.Rmd---
@@ -25,15 +25,16 @@ suppressPackageStartupMessages({
 opts_chunk$set(echo = FALSE, eval = TRUE, include = TRUE, message = FALSE, warning = FALSE)
 
 # Debug mode
-# userdata <- readRDS(""~/Downloads/cciss_export.rds"")
+# userdata <- readRDS(""cciss_export.rds"")
 # for (nm in names(userdata)) {assign(nm, userdata[[nm]])}
 # feasibility_filter = ""a""
 # source(""LeafletSource.R"")
+# source(""tooltip_verbage.R"")
 # pool <- dbPool(
 #   drv = RPostgres::Postgres(),
 #   dbname = Sys.getenv(""BCGOV_DB""),
 #   host = Sys.getenv(""BCGOV_HOST""),
-#   port = 5432, 
+#   port = 5432,
 #   user = Sys.getenv(""BCGOV_USR""),
 #   password = Sys.getenv(""BCGOV_PWD"")
 # )
@@ -56,7 +57,7 @@ if(exists(""pts"") & ncol(pts) > 2){
   # Define the reference for points lookup
   pts_ref <- pts[[{if (avg) {""BGC""} else {""Site""}}]]
 }else{
-  bbox <- st_read(pool, query = paste0(""select ST_Transform(ST_Envelope(ST_Collect(geom)),4326) from bgc_map3005 where bgc IN ('"",paste(bgc_select,collapse = ""','""),""');""))
+  bbox <- st_read(pool, query = paste0(""select ST_Envelope(ST_Collect(geom)) from bgc_map_v13 where \""BGC\"" IN ('"",paste(bgc_select,collapse = ""','""),""');""))
   bbox2 <- st_coordinates(bbox)[,1:2]
   indPoints = F
 }
@@ -84,16 +85,16 @@ if(exists(""pts"") & ncol(pts) > 2){
 
 # Feasibility legend
 legend <- tags$span(
-  ""Legend: "",
   htmltools::HTML(
-    paste0(
-      '<svg viewBox=""0 0 1 1"" height=""14px"" width=""14px""><rect height=1 width=1 style=""fill : ',
-      c(""limegreen"", ""deepskyblue"", ""gold"", ""grey""),
-      '"" /><span>&nbsp;',
-      c(""Primary"", ""Secondary"", ""Tertiary"", ""Not Suitable""),
-      '</span>',
-      collapse = ""&nbsp;&nbsp;&nbsp;""
-    )
+    ""Legend: <br />"",
+            paste0(
+              '<svg viewBox=""0 0 1 1"" height=""14px"" width=""14px""><rect height=1 width=1 style=""fill : ',
+              c(""limegreen"", ""deepskyblue"", ""gold"", ""grey"",""black""),
+              '"" /><span style=""vertical-align:middle"">&nbsp;',
+              c(""E1: High"", ""E2: Moderate"", ""E3: Low"", ""X: Not Suitable"",""Novel Climate""),
+              '</span>',
+              collapse = ""<br />""
+            )
   )
 )
 
@@ -106,14 +107,25 @@ datTP <- dcast(datTP,Summary ~ TimePeriods)
 
 # Recompute svg with smaller height
 cciss_results[, PredFeasSVG := paste0(
-        feasibility_svg(`1_1961`,`2_1961`,`3_1961`,`X_1961`,height = 11), ""<br />"",
-        feasibility_svg(`1_1991`,`2_1991`,`3_1991`,`X_1991`,height = 11), ""<br />"",
-        feasibility_svg(`1_2021`,`2_2021`,`3_2021`,`X_2021`,height = 11), ""<br />"",
-        feasibility_svg(`1_2041`,`2_2041`,`3_2041`,`X_2041`,height = 11), ""<br />"",
-        feasibility_svg(`1_2061`,`2_2061`,`3_2061`,`X_2061`,height = 11), ""<br />"",
-        feasibility_svg(`1_2081`,`2_2081`,`3_2081`,`X_2081`,height = 11)
-      )
+          feasibility_svg(`1_1961`,`2_1961`,`3_1961`,`X_1961`,`NOV_1961`,height = 11), ""<br />"",
+          feasibility_svg(`1_1991`,`2_1991`,`3_1991`,`X_1991`,`NOV_1991`,height = 11), ""<br />"",
+          feasibility_svg(`1_2001`,`2_2001`,`3_2001`,`X_2001`,`NOV_2001`,height = 11), ""<br />"",
+          feasibility_svg(`1_2021`,`2_2021`,`3_2021`,`X_2021`,`NOV_2021`,height = 11), ""<br />"",
+          feasibility_svg(`1_2041`,`2_2041`,`3_2041`,`X_2041`,`NOV_2041`,height = 11), ""<br />"",
+          feasibility_svg(`1_2061`,`2_2061`,`3_2061`,`X_2061`,`NOV_2061`,height = 11), ""<br />"",
+          feasibility_svg(`1_2081`,`2_2081`,`3_2081`,`X_2081`,`NOV_2081`,height = 11)
+        )
 ]
+
+data <- copy(eda_out)
+  #browser()
+data[,Lab := paste(SS.pred,round(SSratio,digits = 2),sep = "": "")]
+data <- data[,.(SSLab = paste(Lab,collapse = ""<br>"")),
+             by = .(SiteRef,SS_NoSpace,FuturePeriod,BGC.pred)]
+dat_bgc <- bgc
+dat_bgc[,BGC := NULL]
+plotdat <- merge.data.table(data,dat_bgc, on = c(""SiteRef"",""FuturePeriod"",""BGC.pred""), all= TRUE)
+
 ```
 
 <style type=""text/css"">
@@ -161,7 +173,7 @@ htmltools::tagList(
       ),
       tags$h5(class = ""bordered"", ""PREDICTED BGC FUTURES""),
       tags$div(class = ""bgc_future"",
-        bgc_fut_plotly(eda_out, siteref, siteseries_list[[siteref]][1],0.1, period_map,height = 450)
+        bgc_fut_plotly(plotdat, siteref, siteseries_list[[siteref]][1],0.1,""BGC"", period_map,height = 450)
       ),
       mapply(FUN = function(siteserie, nm) {
         htmltools::tagList(

---FILE: app/server/tooltip_verbage.R---
@@ -7,11 +7,11 @@ tooltip_text$feas_legend <-  HTML(paste(h6(""E1 -- High environmental suitability
                               p(""Only specific site series conditions are suitable for the species or generally poor growth and survival across the site series.""), 
                               collapse = ""<br />"" ))
 
-tooltip_text$model_agree <-  ""Percent of models predicting each feasibility class""
+tooltip_text$model_agree <-  ""Percent of models predicting each suitability class""
 tooltip_text$cfrg <-  ""Suitability rating and preferred/acceptable classes from the Chief Foresters Reference Guide""
 tooltip_text$es <-  ""Baseline historic environmental suitability""
-tooltip_text$cciss_estab <-  ""Current climate establishment feasibility""
-tooltip_text$cciss_mature <-  ""Future period (2021-2100) feasibility""
+tooltip_text$cciss_estab <-  ""Current climate establishment suitability (1961 - 2040)""
+tooltip_text$cciss_mature <-  ""Future period (2021-2100) suitability""
 tooltip_text$cciss_pa <-  ""Preliminary preferred/acceptable""
 tooltip_text$trends <-  ""Ratio of models indicting improving/stable trends/ models declining or unsuitable""
 

---FILE: app/ui.R---
@@ -80,13 +80,6 @@ $(document).ready(function(){
             )
           ),
           splitLayout(
-            # radioButtons(
-            #   ""aggregation"",
-            #   ""Report Type"",
-            #   c(""Indiv Points"" = ""FALSE"", ""BGC avg"" = ""TRUE""),
-            #   inline = TRUE,
-            #   selected = ""TRUE""
-            # ),
             tagList(
               br(),
               actionButton(""sesh_params"", ""Model Parameters"", icon = icon(""sliders-h""), style = ""width:100%; align:center;"")
@@ -204,7 +197,7 @@ $(document).ready(function(){
 $(document).ready(function(){
     $('[data-toggle=\""popover\""]').popover(); 
 });""),
-    title = navhelplink(""FEASIBILITY REPORT"", ""cciss_instructions_feasibility_report_nav""),
+    title = navhelplink(""SUITABILITY REPORT"", ""cciss_instructions_feasibility_report_nav""),
     value = ""feasibility"",
     tags$style(type='text/css', "".selectize-input { font-size: 54px; line-height: 32px;} .selectize-dropdown { font-size: 28px; line-height: 28px; }""),
     sidebarLayout(
@@ -223,12 +216,12 @@ $(document).ready(function(){
         selectInput(""site_series_feas"", label = ""Choose Site Series"", choices = character()),
         radioButtons(
           ""filter_feas"",
-          label = ""Feasibility"",
-          choices = c(""All"" = ""a"", ""Feasible Only"" = ""f""),
+          label = ""Suitability"",
+          choices = c(""All"" = ""a"", ""Suitable Only"" = ""f""),
           selected = ""a"",
           inline = T
         ),
-        h5(""Feasibility Legend""),
+        h5(""Suitability Legend""),
         bslib::tooltip(
           span(HTML(
             paste0(
@@ -482,7 +475,7 @@ $(document).ready(function(){
         selectInput(
           ""report_filter_feas"",
           label = ""Tree Species"",
-          choices = c(""All"" = ""a"", ""Feasible Only"" = ""f"")
+          choices = c(""All"" = ""a"", ""Suitable Only"" = ""f"")
         ),
         actionButton(
           ""report_filter_all"",
@@ -573,9 +566,9 @@ $(document).ready(function(){
               includeHTML(""./instructions/2a_SelectSites.html"") 
             ),
             tabPanel(
-              title = ""Feasibility Report"",
+              title = ""Suitability Report"",
               value = ""cciss_instructions_feasibility_report"",
-              includeHTML(""./instructions/2b_FeasibilityReport.html"") 
+              includeHTML(""./instructions/2b_SuitabilityReport.html"") 
             ),
             tabPanel(
               title = ""BEC Futures"",
@@ -623,9 +616,9 @@ $(document).ready(function(){
               includeHTML(""./instructions/3b_BEC.html"") 
             ),
             tabPanel(
-              title = ""Feasibility Ratings"",
+              title = ""Suitability Ratings"",
               value = ""cciss_3c"",
-              includeHTML(""./instructions/3c_FeasibilityRatings.html"") 
+              includeHTML(""./instructions/3c_SuitabilityRatings.html"") 
             ),
             tabPanel(
               title = ""Climate Change Projections"",
@@ -651,6 +644,21 @@ $(document).ready(function(){
               title = ""Rule Sets"",
               value = ""cciss_3h"",
               includeHTML(""./instructions/3h_Rulesets.html"") 
+            ),
+            tabPanel(
+              title = ""Outside Home Range"",
+              value = ""cciss_3i"",
+              includeHTML(""./instructions/3i_OHR.html"") 
+            ),
+            tabPanel(
+              title = ""BEC 13"",
+              value = ""cciss_3j"",
+              includeHTML(""./instructions/3j_BEC13.html"") 
+            ),
+            tabPanel(
+              title = ""Expert Review"",
+              value = ""cciss_3k"",
+              includeHTML(""./instructions/3k_ExpertReview.html"") 
             )
 
           )
@@ -678,11 +686,6 @@ $(document).ready(function(){
               value = ""cciss_4b"",
               includeHTML(""./instructions/4b_SourcesOfError.html"") 
             ),
-            tabPanel(
-              title = ""Novel Climates"",
-              value = ""cciss_4c"",
-              includeHTML(""./instructions/4c_NovelClimates.html"") 
-            ),
             tabPanel(
               title = ""Space-for-time Substitution"",
               value = ""cciss_4d"",

---FILE: instructions-raw/0a_documentationStructure.Rmd---
@@ -4,23 +4,23 @@ CCISS Manual Outline
 a.	overview
 2.	Instructions (how to use the CCISS tool)
 a.	Select sites
-b.	Feasibility report
+b.	Suitability report
 c.	BEC futures
 d.	Silvics and ecology
 e.	Export
 3.	Methods (how the CCISS tool works)
 a.	Overview
 b.	Biogeoclimatic Ecosystem Classification
-c.	Feasibility ratings
+c.	Suitability ratings
 d.	Climate change projections
 e.	Biogeoclimatic model
 f.	Novel climates
 g.	Edatopic Overlap
 h.	Rule sets
+i.  OHR
 4.	Known issues
 a.	Overview
 b.	Sources of error
-c.	Novel climates
 d.	Space-for-time substitution
 5.	Making decisions using CCISS
 a.	Decision guidance

---FILE: instructions-raw/2a_SelectSites.Rmd---
@@ -46,37 +46,32 @@ the output.
 
 ## Adjust Session Parameters (Optional)
 
-The CCISS tool makes calculations that differentially weight climate
-models, scenarios, and time periods in results. We have assigned
-recommended weightings for general use of the tool. However, for some
-purposes users may wish to adjust the weights given to these parameters
-based on their specific objectives.
-
-### 1. Establishment feasibility weights
-
-The Feasibility report provides an assessment of **establishment
-feasibility**, representing the likelihood of success in establishing
-the species to free growing if planted in the present climate. This
-value is a weighted average of the environmental feasibility in the
-1961-2020, 2001-2020, and 2021-2040 periods. The default weightings are
-even across these periods to reflect three perspectives on feasibility.
-First, the 1961-1990 period reflects the proven viability of the species
-in the ecosystem. Second, the 2001-2020 period reflects the actual
-climate experienced in the location of interest. Third, the 2021=2040
-period is the expected climate during the establishment of the species.
-Users may want to adjust the establishment feasibility weights based on
-whether they want a more historically-oriented or future-oriented
-assessment. Note that the feasibility in each of these periods is
-visible in the detailed feasibility report.
-
-### 2. Maturation weights
-
-The Feasibility Report provides an assessment of **maturation
-feasibility**: the feasibility of the species through the entire future
-period to rotation (2021 to 2100). The default setting equally weight
-the four 20-year future time periods.
-
-### 3. GCM weights
+This dialog box allows users to view and adjust the default settings of the CCISS tool. Users are encouraged to read the relevant sections of the CCISS tool documentation prior to changing the default settings. 
+
+### 1. Climatic novelty
+
+Climatic novelty refers to the degree of mismatch between a future climate condition and the biogeoclimatic analog it is classified as. Valid inferences of species suitability are not possible in highly novel climates. By default, biogeoclimatic projections with high (5$\sigma$) novelty are removed from CCISS results and replaced with a black bar in the detailed suitability results. Removal of novel climates can be disabled, and the 5$\sigma$ threshold can be adjusted. See Documentation - Methods - Novel Climates.  
+
+### 2. Outside of Home Range (OHR) suitabilities
+
+CCISS includes environmental suitability ratings for Douglas-fir and western larch in biogeoclimatic subzone-variants where there is strong evidence that they were suitable for the baseline 1961-1990 climate despite not occuring there naturally due to migration lag. The inclusion of OHR suitabilities can be disabled. See Documentation - Methods - OHR. 
+
+### 3. Establishment Suitability weights
+
+The suitability Report provides an assessment of **establishment
+suitability**, representing the likelihood of success in establishing
+the species to free growing if planted in the present climate. 
+The default setting almost equally weights the environmental suitability (expert derived) in the baseline
+1961-1990 climate, and the model predicted environmental suitability from observed 2001-2020 climate, and projected 2021-2040 climate, with a slight weighting towards the 2 most recent time periods.  See Documentation - Methods - Rule Sets.  
+
+### 4. Maturation Suitability weights
+
+The suitability Report provides an assessment of **maturation
+suitability**: the suitability of the species through the entire future
+period to rotation (2021 to 2100). The default setting equally weights
+the four 20-year future time periods. See Documentation - Methods - Rule Sets.  
+
+### 5. GCM weights
 
 There are 13 global climate models available in the CCISS tool. However,
 the CCISS tool defaults to the 8-model ensemble of global climate models
@@ -87,9 +82,9 @@ evidence (CanESM5, UKESM1, INM-CM5; explained
 [here](https://www2.gov.bc.ca/assets/gov/environment/natural-resource-stewardship/nrs-climate-change/climatena_8modelrationale.pdf)),
 because they only have a single run for each scenario (BCC-CSM2,
 INM-CM5), or because they exhibit unrealistic localized warming in BC
-(IPSL-CM6A).
+(IPSL-CM6A). See Documentation - Methods - Climate Change Projections.  
 
-### 4. Scenario weights
+### 6. Scenario weights
 
 Global climate model projections follow scenarios of future greenhouse
 gas emissions called [Shared Socioeconomic
@@ -104,4 +99,4 @@ represent scenario uncertainty in climate change projections. We have
 set SSP5-8.5 weighting to 0 in the default scenarios because it is
 extremely unlikely based on current trends in energy economics and
 policy ([Hausfather and Peters
-2020](https://www.nature.com/articles/d41586-020-00177-3)).
+2020](https://www.nature.com/articles/d41586-020-00177-3)). See Documentation - Methods - Climate Change Projections.  

---FILE: instructions-raw/2a_SelectSites.html---
@@ -98,38 +98,57 @@ <h3><strong>Step 3</strong>. Click the Generate Results at the top of
 </div>
 <div id=""adjust-session-parameters-optional"" class=""section level2"">
 <h2>Adjust Session Parameters (Optional)</h2>
-<p>The CCISS tool makes calculations that differentially weight climate
-models, scenarios, and time periods in results. We have assigned
-recommended weightings for general use of the tool. However, for some
-purposes users may wish to adjust the weights given to these parameters
-based on their specific objectives.</p>
+<p>This dialog box allows users to view and adjust the default settings
+of the CCISS tool. Users are encouraged to read the relevant sections of
+the CCISS tool documentation prior to changing the default settings.</p>
+<div id=""climatic-novelty"" class=""section level3"">
+<h3>1. Climatic novelty</h3>
+<p>Climatic novelty refers to the degree of mismatch between a future
+climate condition and the biogeoclimatic analog it is classified as.
+Valid inferences of species suitability are not possible in highly novel
+climates. By default, biogeoclimatic projections with high (5<span class=""math inline""><em></em></span>) novelty are removed from CCISS
+results and replaced with a black bar in the detailed feasibility
+results. Removal of novel climates can be disabled, and the 5<span class=""math inline""><em></em></span> threshold can be adjusted. See
+Documentation - Methods - Novel Climates.</p>
+</div>
+<div id=""outside-of-home-range-ohr-suitabilities"" class=""section level3"">
+<h3>2. Outside of Home Range (OHR) suitabilities</h3>
+<p>CCISS includes environmental suitability ratings for Douglas-fir and
+western larch in biogeoclimatic subzone-variants where there is strong
+evidence that they were suitable for the baseline 1961-1990 climate
+despite not occuring there naturally due to migration lag. The inclusion
+of OHR suitabilities can be disabled. See Documentation - Methods -
+OHR.</p>
+</div>
 <div id=""establishment-feasibility-weights"" class=""section level3"">
-<h3>1. Establishment feasibility weights</h3>
-<p>The Feasibility report provides an assessment of
+<h3>3. Establishment feasibility weights</h3>
+<p>The Feasibility Report provides an assessment of
 <strong>establishment feasibility</strong>, representing the likelihood
 of success in establishing the species to free growing if planted in the
 present climate. This value is a weighted average of the environmental
-feasibility in the 1961-2020, 2001-2020, and 2021-2040 periods. The
-default weightings are even across these periods to reflect three
-perspectives on feasibility. First, the 1961-1990 period reflects the
-proven viability of the species in the ecosystem. Second, the 2001-2020
-period reflects the actual climate experienced in the location of
-interest. Third, the 2021=2040 period is the expected climate during the
-establishment of the species. Users may want to adjust the establishment
-feasibility weights based on whether they want a more
-historically-oriented or future-oriented assessment. Note that the
-feasibility in each of these periods is visible in the detailed
-feasibility report.</p>
+feasibility in the baseline 1961-1990, observed 2001-2020, and projected
+2021-2040 periods. The default weightings are even across these periods
+to reflect three perspectives on feasibility. First, the 1961-1990
+period reflects the proven viability of the species in the ecosystem.
+Second, the observed 2001-2020 period reflects the actual climate
+experienced in the location of interest. Third, the projected 2021=2040
+period is the expected climate during the establishment of the species.
+Users may want to adjust the establishment feasibility weights based on
+whether they want a more historically-oriented or future-oriented
+assessment. Note that the feasibility in each of these periods is
+visible in the detailed feasibility report. See Documentation - Methods
+- Rule Sets.</p>
 </div>
-<div id=""maturation-weights"" class=""section level3"">
-<h3>2. Maturation weights</h3>
+<div id=""maturation-feasibility-weights"" class=""section level3"">
+<h3>4. Maturation feasibility weights</h3>
 <p>The Feasibility Report provides an assessment of <strong>maturation
 feasibility</strong>: the feasibility of the species through the entire
 future period to rotation (2021 to 2100). The default setting equally
-weight the four 20-year future time periods.</p>
+weights the four 20-year future time periods. See Documentation -
+Methods - Rule Sets.</p>
 </div>
 <div id=""gcm-weights"" class=""section level3"">
-<h3>3. GCM weights</h3>
+<h3>5. GCM weights</h3>
 <p>There are 13 global climate models available in the CCISS tool.
 However, the CCISS tool defaults to the 8-model ensemble of global
 climate models recommended by <a href=""https://doi.org/10.1002/joc.7566"">Mahony et al.(2022)</a> and
@@ -138,10 +157,11 @@ <h3>3. GCM weights</h3>
 evidence (CanESM5, UKESM1, INM-CM5; explained <a href=""https://www2.gov.bc.ca/assets/gov/environment/natural-resource-stewardship/nrs-climate-change/climatena_8modelrationale.pdf"">here</a>),
 because they only have a single run for each scenario (BCC-CSM2,
 INM-CM5), or because they exhibit unrealistic localized warming in BC
-(IPSL-CM6A).</p>
+(IPSL-CM6A). See Documentation - Methods - Climate Change
+Projections.</p>
 </div>
 <div id=""scenario-weights"" class=""section level3"">
-<h3>4. Scenario weights</h3>
+<h3>6. Scenario weights</h3>
 <p>Global climate model projections follow scenarios of future
 greenhouse gas emissions called <a href=""https://www.carbonbrief.org/explainer-how-shared-socioeconomic-pathways-explore-future-climate-change"">Shared
 Socioeconomic Pathways</a> (SSPs). The CCISS tool provides the option of
@@ -154,7 +174,8 @@ <h3>4. Scenario weights</h3>
 projections. We have set SSP5-8.5 weighting to 0 in the default
 scenarios because it is extremely unlikely based on current trends in
 energy economics and policy (<a href=""https://www.nature.com/articles/d41586-020-00177-3"">Hausfather and
-Peters 2020</a>).</p>
+Peters 2020</a>). See Documentation - Methods - Climate Change
+Projections.</p>
 </div>
 </div>
 

---FILE: instructions-raw/2b_FeasibilityReport.Rmd---
@@ -1,89 +0,0 @@
----
-title: 
-output: 
-    html_document:
-        theme: null
-        highlight: null
-        mathjax: null
-editor_options: 
-  markdown: 
-    wrap: 72
----
-
-## Tree species feasibility report
-
-This is the main report of the CCISS tool. The Summary mode of this
-report provides a comparison of the Chief Forester's Reference Guide for
-Stocking Standards (CFRG) and the CCISS feasibility assessment. The
-Detailed mode shows the distribution of feasibility ratings for the
-global climate model ensemble in each time period.
-
-The concept and definitions of CCISS feasibility ratings are discussed
-in more detail <a href=""3c_FeasibilityRatings.html"">here</a>.
-
-### Selection/Filter pane
-
-In the left pane select the BGC subzone/variant and then the site series of
-interest. The edatopic space of the selected site series is displayed in
-the graphic below for reference. By default the report will show all
-species that are predicted to be feasible in at least one model and time
-period. Choose the ""Feasible Only"" option to limit the list to species
-that meet the threshold for classification as feasible across the global
-climate model ensemble in any of the time periods.
-
-### Detailed report
-
-This report shows modelled feasibility ratios for each species in the
-selected site series for each time period. The colour legend for
-feasibility ratings is on the left hand pane. The mapped biogeoclimatic
-unit represents the historical equilibrium climate approximated by the
-climatic conditions of the 1961-1990 period. The recent time period
-(2001-2020) has two bars: one for the observed climate (measured by
-weather stations), and one for the climates simulated by the ensemble of
-global climate models. These two bars aren't necessarily expected to
-agree: The modelled climates sample a large range of possible recent
-conditions, of which the observed recent climate is only one.
-
-The report then summarizes the baseline suitability ratings and
-forecasted feasibility ratings for each species in the following order:
-
-1.  The **CFRG suitability** rating: Suitability ratings taken directly
-    from the Chief foresters reference guide
-
-2.  The **CFRG P/A** value: Preferred/Acceptable ratings taken directly
-    from the Chief foresters reference guide
-
-3.  The **Historical Environmental Suitability**: Expert baseline
-    environmental suitability rating for site series.
-
-4.  **CCISS Establishment Feasibility**: The feasibility rating based on
-    the baseline (1961-1990), recent observed (2001-2020), and 2021-2040
-    future projected feasibilities. This indicates the likely level of
-    constraints for successful establishment of the species in the
-    present climate. Default model settings equally weight time periods.
-
-5.  **CCISS Maturation Feasibility**: The mean feasibility rating across
-    the 20-year normal periods (2021-2100). This indicates the inferred
-    feasibility of successfully growing an established to maturity (80
-    years). Default model settings equally weight time periods
-
-6.  **P/A**: Assessed preferred/acceptable rating based on establishment
-    and maturation feasibility.
-
-7.  **Trend**: the proportion of the GCM simulations indicating
-    improving/stable feasibility (numerator) vs. declining feasibility
-    or remaining unfeasible.
-
-The weights used to calculate Establishment Feasibility and Maturation
-Feasibility can be modified using the ""Adjust Parameters"" dialog box in
-the ""Select Sites"" tab.
-
-### Summary report
-
-This report compares CCISS maturation feasibility with the Chief
-Forester's Reference Guide for Stocking Standards. Species codes are
-coloured according to trends in their future feasibility using the
-legend at the bottom of the selection pane: improving (green),
-decreasing (red). Species added to the CCISS stocking standard are
-coloured purple, and species dropped from the CCISS stocking standard
-are strike-through.

---FILE: instructions-raw/2b_FeasibilityReport.html---
@@ -120,6 +120,17 @@ <h3>Detailed report</h3>
 <p>The weights used to calculate Establishment Feasibility and
 Maturation Feasibility can be modified using the Adjust Parameters
 dialog box in the Select Sites tab.</p>
+<div id=""novel-climates"" class=""section level4"">
+<h4>Novel climates</h4>
+<p>Climatic novelty refers to the degree of mismatch between a future
+climate condition and the biogeoclimatic analog it is classified as.
+Valid inferences of species suitability are not possible in highly novel
+climates. By default, biogeoclimatic projections with high (5<span class=""math inline""><em></em></span>) novelty are removed from CCISS
+results and replaced with a black bar in the detailed feasibility
+results. Removal of novel climates can be disabled or adjusted using the
+Adjust Parameters dialog box in the Select Sites tab. See
+Documentation - Methods - Novel Climates for more details.</p>
+</div>
 </div>
 <div id=""summary-report"" class=""section level3"">
 <h3>Summary report</h3>

---FILE: instructions-raw/2c_BECFutures.Rmd---
@@ -12,13 +12,13 @@ editor_options:
 
 ## Projected BEC futures
 
-This section summarizes the biogeoclimatic projections that underlie the species feasibility forecasts. Biogeoclimatic subzone/variants (a.k.a. BGC units) are the climate component of the Biogeoclimatic Ecosystem Classification (BEC). Each user-selected location has a mapped BGC unit representing its historical climate. Biogeoclimatic projections identify a BGC unit whose historical climate is the best match (best analog) for the future climate at a user-selected location. In other words, changes in climatic conditions (temperature, precipitation, etc) are translated into a change in the BGC unit.
+This section summarizes the biogeoclimatic projections that underlie the species suitability forecasts. Biogeoclimatic subzone/variants (a.k.a. BGC units) are the climate component of the Biogeoclimatic Ecosystem Classification (BEC). Each user-selected location has a mapped BGC unit representing its historical climate. Biogeoclimatic projections identify a BGC unit whose historical climate is the best match (best analog) for the future climate at a user-selected location. In other words, changes in climatic conditions (temperature, precipitation, etc) are translated into a change in the BGC unit.
 
 ### Chart
 
 The chart mode displays a stacked bar chart showing the ratio of future BGC analogs by time period predicted across range of global climate model-scenario climate projections. Hovering over a stacked bar will display these proportions numerically.
 
-The recent time period (2001-2020) has two bars: one for the observed climate (measured by weather stations), and one for the modelled climates (simulated by global climate models). These two aren't expected to agree: The modelled climates sample a large range of possible recent conditions, of which the observed recent climate is only one.
+The recent time period (2001-2020) has two bars: one for the observed climate (measured by weather stations and interpolated across the province), and one for the modelled climates (simulated by global climate models). These two aren't expected to agree: The modelled climates sample a large range of possible recent conditions, of which the observed recent climate is only one.
 
 The default mode of this plot simply shows the BGC analog labels. Specifying a site series of interest will display the site series in the BGC analog that overlap with the edatopic position of the historic site series, along with the proportion of the edatopic overlap. The ""minimum site series overlap"" slider allows the user to include or exclude site series with small edatopic overlaps.
 

---FILE: instructions-raw/2d_SilvicsEcology.Rmd---
@@ -16,7 +16,7 @@ This section contains information that may be useful for interpreting CCISS resu
 
 ### A. Silvics and Ecology
 
-This module summarizes the silvics of each species with historic or future feasibility in the selected BGC unit and site series. This information is drawn from Klinka et al. (1999). This information can be explored further at this [link](https://www2.gov.bc.ca/gov/content/industry/forestry/managing-our-forest-resources/silviculture/tree-species-selection/tool-introduction/tree-species-silvics-and-comparisons).
+This module summarizes the silvics of each species with historic or future suitability in the selected BGC unit and site series. This information is drawn from Klinka et al. (1999). This information can be explored further at this [link](https://www2.gov.bc.ca/gov/content/industry/forestry/managing-our-forest-resources/silviculture/tree-species-selection/tool-introduction/tree-species-silvics-and-comparisons).
 
 Klinka, K., J. Worrall, L. Skoda, and P. Varga. 2000. The Distribution and Synopsis of Ecological and Silvical Characteristics of Tree Species of British Columbias Forests. Canadian Cartographics Ltd., Coquitlam, B.C. 
  
@@ -25,4 +25,4 @@ Klinka, K., J. Worrall, L. Skoda, and P. Varga. 2000. The Distribution and Synop
 
 This module provides provincial-scale maps for user-selected species and site types. Three example site series representing different edatopic conditions are currently available: the B2 edatope (nutrient-poor, moisture-subxeric sites), C4 edatope (nutrient-medium, moisture-mesic sites), and D6 edatope (nutrient-rich, moisture-hygric sites).
 
-The figure provides three maps: (left) The historical environmental feasibility rating for each species; (center) the proportion of the GCM ensemble projecting the retreat (historically feasible but projected unfeasible) or expansion (historically unfeasible but projected to be feasible) of the species in the 2041--2060 period; and (right) the mean change in feasibility across the GCM ensemble by the 2041--2060 period.
+The figure provides three maps: (left) The historical environmental suitability rating for each species; (center) the proportion of the GCM ensemble projecting the retreat (historically feasible but projected unfeasible) or expansion (historically unfeasible but projected to be feasible) of the species in the 2041--2060 period; and (right) the mean change in suitability across the GCM ensemble by the 2041--2060 period.

---FILE: instructions-raw/2e_Export.Rmd---
@@ -14,8 +14,8 @@ editor_options:
 
 #### Export Report
 
-The report is designed for documentation and off-line use of a CCISS tool report session, e.g. as an appendix to a site plan. We recommend including only the site series of interest to the user. Choose the ""Feasible Only"" option to limit list to species that meet the threshold for inclusion as feasible in any of the time periods.
+The report is designed for documentation and off-line use of a CCISS tool report session, e.g. as an appendix to a site plan. We recommend including only the site series of interest to the user. Choose the ""Suitable Only"" option to limit list to species that meet the threshold for inclusion as suitable in any of the time periods.
 
 #### Export data
 
-Feasibility data can be exported for conducting further analysis such as calculating summary statistics for your area of interest. Feasibility data exported from the CCISS tool is in ""long form"" with each row showing projected feasibility by site of interest, site series, and tree species. Data is exported as a .CSV file; a PDF metadata report is included in the export folder.
+Suitability data can be exported for conducting further analysis such as calculating summary statistics for your area of interest. Suitability data exported from the CCISS tool is in ""long form"" with each row showing projected suitability by site of interest, site series, and tree species. Data is exported as a .CSV file; a PDF metadata report is included in the export folder.

---FILE: instructions-raw/3a_MethodsOverview.Rmd---
@@ -11,46 +11,118 @@ editor_options:
 ---
 
 ## Overview of CCISS Methods
-The CCISS method can be summarized into two main steps: 
 
-- **Step 1---Biogeoclimatic projections**---Use a statistical model to assign climate analogs for a large ensemble of projected future climates for each location in British Columbia; 
+The CCISS method can be summarized into two main steps:
 
-- **Step 2---Cross-reference tree species feasibility**---For each site series at user-specified locations of interest, find the tree species feasibility ratings of the equivalent site series in the ensemble of climate analogs. 
+-   **Step 1---Biogeoclimatic projections**---Use a statistical model to
+    assign climate analogs for a large ensemble of projected future
+    climates for each location in British Columbia;
 
-### Step 1: Biogeoclimatic projections
-
-CCISS uses spatial climatic analogs to make inferences about future tree species feasibility. A spatial climate analog is a location with a historical climate that is similar to the current or future projected climate of a different location. Biogeoclimatic subzone/variants are a uniquely useful set of spatial climate analogs because they are familiar to resource management practitioners and are the organizing units for site-specific ecological interpretations accumulated over many decades.  
-
-In the CCISS framework, biogeoclimatic analogs are identified by training a statistical or machine learning model to recognize biogeoclimatic subzone-variants in terms of their historical (1961-1990) climatic conditions, and then applying that classification model to new (current or projected) climate conditions (MacKenzie and Mahony 2021). The new climates are thus labelled using their best analog within the BEC system, a process called biogeoclimatic projections (Figure 1).  
-
-To represent the uncertainty in modeling future climates, CCISS incorporates biogeoclimatic projections for 72 climate model simulations of the 21st century (8 climate models x 3 simulation runs x 3 socioeconomic scenarios). 
-
-<img src=""Figure_BGCprojections.png"" alt=""An example of biogeoclimatic projections for British Columbia, excerpted from Mackenzie & Mahony (2021)"" style=""width:70%;""/>
-
-Figure 1: An example of biogeoclimatic projections for British Columbia, excerpted from Mackenzie & Mahony (2021) (a) is the biogeoclimatic mapping for BC; (b) and (c) are biogeoclimatic projections for recent observed climate and a global climate model projection for the 2041-2070 period.
-
-### Step 2: Cross-reference tree species feasibility
-
-Step 2 involves finding the tree species feasibility information for the climate analogs identified by step 1. For each user-specified location at each 20-year period of the 21st century, the CCISS tool provides a historical biogeoclimatic unit and an ensemble of biogeoclimatic analogs. In the example provided in Figure 2, the historical climate is SBSmc2, and the climate analog for the projected future climate is IDFdk3. Both of these BGC units have associated site series, distributed across their unique edatopic grids. Each of these site series has associated tree species feasibility ratings. The CCISS analysis adopts the feasibility ratings of the biogeoclimatic analog as the projected feasibility for that time period. In this example, on the 01 site series, spruce (Sx) and subalpine fir (Bl) are demoted while Douglas-fir (Fd) and trembling aspen (At) are promoted. Since there is an ensemble of 72 climate projections, the CCISS feasibility projections at each time period are typically a distribution indicating the uncertainty in climate futures. 
+-   **Step 2---Cross-reference tree species suitability**---For each
+    site series at user-specified locations of interest, find the tree
+    species environmental suitability ratings of the equivalent site
+    series in the ensemble of climate analogs.
 
-<img src=""Figure_CCISSoverview.png"" alt=""Illustration of the CCISS method of using climate analogs to project site-specific changes in tree species feasibility, excerpted from Mackenzie & Mahony (2021)."" style=""width:90%;""/>
+### Step 1: Biogeoclimatic projections
 
-Figure 2: Illustration of the CCISS method of using climate analogs to project site-specific changes in tree species feasibility, excerpted from Mackenzie & Mahony (2021). (b) An idealized slope profile illustrates that, within each biogeoclimatic subzone/variant (a climate type), the relative soil moisture and nutrients available for tree growth are moderated by site factors such as soil depth, soil parent materials, slope position and slope aspect. (a,c) Edatopic grids show the integrated effect of site factors on soil moisture regime (rows) and soil nutrient regime (columns). The cells of the edatopic grid are called edatopes. Three of the 40 possible edatopes are featured in this figure: the B2 edatope representing nutrient-poor and relatively dry (subxeric) sites; the C4 edatope representing nutrient-medium and moisture-average (mesic) sites; and the D6 edatope representing nutrient-rich and relatively moist (hygric) sites. Site series are groups of edatopes that can support the same mature plant communities. (a,b,c) Relative edatopic position does not change with changing climate, allowing equivalent site series and associated tree feasibility ratings to be aligned between historical and projected climates. (d,e) Tree species environmental feasibility ratings have been developed for all site series in each biogeoclimatic unit. Equivalent relative edatopes support different tree species under different climate regimes.
+CCISS uses spatial climatic analogs to make inferences about future tree
+species suitability. A spatial climate analog is a location with a
+historical climate that is similar to the current or future projected
+climate of a different location. Biogeoclimatic subzone/variants are a
+uniquely useful set of spatial climate analogs because they are familiar
+to resource management practitioners and are the organizing units for
+site-specific ecological interpretations accumulated over many decades.
+
+In the CCISS framework, biogeoclimatic analogs are identified by
+training a statistical or machine learning model to recognize
+biogeoclimatic subzone-variants in terms of their historical (1961-1990)
+climatic conditions, and then applying that classification model to new
+(current or projected) climate conditions (MacKenzie and Mahony 2021).
+The new climates are thus labelled using their best analog within the
+BEC system, a process called biogeoclimatic projections (Figure 1).
+
+To represent the uncertainty in modeling future climates, CCISS
+incorporates biogeoclimatic projections for 72 climate model simulations
+of the 21st century (8 climate models x 3 simulation runs x 3
+socioeconomic scenarios).
+
+<img src=""Figure_BGCprojections.png"" alt=""An example of biogeoclimatic projections for British Columbia, excerpted from Mackenzie &amp; Mahony (2021)"" style=""width:70%;""/>
+
+Figure 1: An example of biogeoclimatic projections for British Columbia,
+excerpted from Mackenzie & Mahony (2021) (a) is the biogeoclimatic
+mapping for BC; (b) and (c) are biogeoclimatic projections for recent
+observed climate and a global climate model projection for the 2041-2070
+period.
+
+### Step 2: Cross-reference tree species suitability
+
+Step 2 involves finding the tree species suitability information for the
+climate analogs identified by step 1. For each user-specified location
+at each 20-year period of the 21st century, the CCISS tool provides a
+historical biogeoclimatic unit and an ensemble of biogeoclimatic
+analogs. In the example provided in Figure 2, the historical climate is
+SBSmc2, and the climate analog for the projected future climate is
+IDFdk3. Both of these BGC units have associated site series, distributed
+across their unique edatopic grids. Each of these site series has
+associated tree species suitability ratings. The CCISS analysis adopts
+the suitability ratings of the biogeoclimatic analog as the projected
+suitability for that time period. In this example, on the 01 site
+series, spruce (Sx) and subalpine fir (Bl) are demoted while Douglas-fir
+(Fd) and trembling aspen (At) are promoted. Since there is an ensemble
+of 72 climate projections, the CCISS suitability projections at each
+time period are typically a distribution indicating the uncertainty in
+climate futures.
+
+<img src=""Figure_CCISSoverview.png"" alt=""Illustration of the CCISS method of using climate analogs to project site-specific changes in tree species suitability, excerpted from Mackenzie &amp; Mahony (2021)."" style=""width:90%;""/>
+
+Figure 2: Illustration of the CCISS method of using climate analogs to
+project site-specific changes in tree species suitability, excerpted
+from Mackenzie & Mahony (2021). (b) An idealized slope profile
+illustrates that, within each biogeoclimatic subzone/variant (a climate
+type), the relative soil moisture and nutrients available for tree
+growth are moderated by site factors such as soil depth, soil parent
+materials, slope position and slope aspect. (a,c) Edatopic grids show
+the integrated effect of site factors on soil moisture regime (rows) and
+soil nutrient regime (columns). The cells of the edatopic grid are
+called edatopes. Three of the 40 possible edatopes are featured in this
+figure: the B2 edatope representing nutrient-poor and relatively dry
+(subxeric) sites; the C4 edatope representing nutrient-medium and
+moisture-average (mesic) sites; and the D6 edatope representing
+nutrient-rich and relatively moist (hygric) sites. Site series are
+groups of edatopes that can support the same mature plant communities.
+(a,b,c) Relative edatopic position does not change with changing
+climate, allowing equivalent site series and associated tree suitability
+ratings to be aligned between historical and projected climates. (d,e)
+Tree species environmental suitability ratings have been developed for
+all site series in each biogeoclimatic unit through expert knowledge.
+Equivalent relative edatopes support different tree species under
+different climate regimes.
 
 ### Further reading
 
-The other tabs in this section provide more detail on the methods underlying the CCISS tool: 
-
-- BEC---Basics of the Biogeoclimatic Ecosystem Classification and the draft classifications for the US and Alberta
-- Feasibility Ratings---Definitions of the tree species feasibility ratings
-- Climate Change Projections---Details on the ensemble of climate model projections
-- BGC Model---Explanation of biogeoclimatic projections and guidance on interpreting them. 
-- Edatopic Overlap---Methods for aligning site series of the historical and analog BGC units
-- Rule Sets---Rules for synthesizing the feasibility projections into species-specific summary values for each site series
-
-
-If you're really motivated, check out our peer-reviewed paper on CCISS: 
-
-MacKenzie, W.H. and C.R. Mahony. 2021. [An ecological approach to climate change-informed tree species selection for reforestation](./downloadable_docs/MacKenzieMahony2021_CCISS_FEM.pdf). Forest Ecology and Management 481:118705
-
-
+The other tabs in this section provide more detail on the methods
+underlying the CCISS tool:
+
+-   BEC---Basics of the Biogeoclimatic Ecosystem Classification and the
+    draft classifications for the US and Alberta
+-   suitability Ratings---Definitions of the tree species environmental
+    suitability ratings.
+-   Climate Change Projections---Details on the ensemble of climate
+    model projections.
+-   BGC Model---Explanation of biogeoclimatic projections and guidance
+    on interpreting them.
+-   Novel climates---Measuring how well biogeoclimatic analogs match
+    current and future climates.
+-   Edatopic Overlap---Methods for aligning site series of the
+    historical and analog BGC units.
+-   Rule Sets---Rules for synthesizing the suitability projections into
+    species-specific summary values for each site series.
+-   OHR suitabilities---Baseline suitability ratings for tree species
+    outside their home range.
+
+Also, check out our peer-reviewed paper on CCISS:
+
+MacKenzie, W.H. and C.R. Mahony. 2021. [An ecological approach to
+climate change-informed tree species selection for
+reforestation](./downloadable_docs/MacKenzieMahony2021_CCISS_FEM.pdf).
+Forest Ecology and Management 481:118705

---FILE: instructions-raw/3a_MethodsOverview.html---
@@ -146,23 +146,25 @@ <h3>Further reading</h3>
 <p>The other tabs in this section provide more detail on the methods
 underlying the CCISS tool:</p>
 <ul>
-<li><a href=""3b_BEC.html"">BEC</a>Basics of the Biogeoclimatic Ecosystem
-Classification and the draft classifications for the US and Alberta</li>
-<li><a href=""3c_FeasibilityRatings.html"">Feasibility
-Ratings</a>Definitions of the tree species feasibility ratings</li>
-<li><a href=""3d_ClimateProjections.html"">Climate Change
-Projections</a>Details on the ensemble of climate model
-projections</li>
-<li><a href=""3e_BGCmodel.html"">BGC Model</a>Explanation of
-biogeoclimatic projections and guidance on interpreting them.</li>
-<li><a href=""3f_EdatopicOverlap.html"">Edatopic Overlap</a>Methods for
-aligning site series of the historical and analog BGC units</li>
-<li><a href=""3g_Rulesets.html"">Rule Sets</a>Rules for synthesizing the
-feasibility projections into species-specific summary values for each
-site series</li>
+<li>BECBasics of the Biogeoclimatic Ecosystem Classification and the
+draft classifications for the US and Alberta</li>
+<li>Feasibility RatingsDefinitions of the tree species feasibility
+ratings.</li>
+<li>Climate Change ProjectionsDetails on the ensemble of climate model
+projections.</li>
+<li>BGC ModelExplanation of biogeoclimatic projections and guidance on
+interpreting them.</li>
+<li>Novel climatesMeasuring how well biogeoclimatic analogs match
+current and future climates.<br />
+</li>
+<li>Edatopic OverlapMethods for aligning site series of the historical
+and analog BGC units.</li>
+<li>Rule SetsRules for synthesizing the feasibility projections into
+species-specific summary values for each site series.</li>
+<li>OHR suitabilitiesBaseline suitability ratings for tree species
+outside their home range.</li>
 </ul>
-<p>If youre really motivated, check out our peer-reviewed paper on
-CCISS:</p>
+<p>Also, check out our peer-reviewed paper on CCISS:</p>
 <p>MacKenzie, W.H. and C.R. Mahony. 2021. <a href=""./downloadable_docs/MacKenzieMahony2021_CCISS_FEM.pdf"">An
 ecological approach to climate change-informed tree species selection
 for reforestation</a>. Forest Ecology and Management 481:118705</p>

---FILE: instructions-raw/3b_BEC.Rmd---
@@ -55,11 +55,11 @@ describing climate and site level differences each based on biological
     of the over-arching climate regime).
 
 More information on BEC can be found at
-[BECweb](<https://www.for.gov.bc.ca/hre/becweb/>)
+[BECweb](https://www.for.gov.bc.ca/hre/becweb/)
 
 #### Composite BEC for western North America
 
-Creating species feasibility projections for the future climates of
+Creating species suitability projections for the future climates of
 British Columbia requires finding climate analogs in Alberta and the
 Western US. For Alberta, we adapted the Ecological Classification of
 Alberta (e.g., Archibald et al. 1996), with 21 natural subregions
@@ -70,12 +70,12 @@ draft biogeoclimatic ecosystem classification for the Western US
 developed by Del Meidinger and Will MacKenzie. The resulting composite
 biogeoclimatic units are shown at the zone level in Figure 1.
 
-<img src=""Figure_BGCmap.png"" alt=""Baseline biogeoclimatic units of British Columbia and adjacent jurisdictions, excerpted from Mackenzie & Mahony (2021)"" style=""width:70%;""/>
+<img src=""Figure_BGCmap.png"" alt=""Baseline biogeoclimatic units of British Columbia and adjacent jurisdictions, excerpted from Mackenzie &amp; Mahony (2021)"" style=""width:70%;""/>
 
 Figure 1: Baseline biogeoclimatic units of British Columbia and adjacent
 jurisdictions, inferred from 20th-century ecosystem observations.
-Excerpted from Mackenzie & Mahony (2021). (a) Biogeoclimatic zones are the
-highest level of the biogeoclimatic classification. (b) Each zone
+Excerpted from Mackenzie & Mahony (2021). (a) Biogeoclimatic zones are
+the highest level of the biogeoclimatic classification. (b) Each zone
 comprises several subzones and subzone/variants. Draft biogeoclimatic
 ecosystem classifications for jurisdictions adjacent to British Columbia
 have recently been developed to support climate change adaptation with

---FILE: instructions-raw/3c_FeasibilityRatings.Rmd---
@@ -1,64 +0,0 @@
----
-title: 
-output: 
-    html_document:
-        theme: null
-        highlight: null
-        mathjax: null
-editor_options: 
-  markdown: 
-    wrap: 72
----
-
-### Feasibility (Environmental Suitability) Ratings
-
-CCISS estimates historical (1961-1990) tree species suitability ratings for all site series in British Columbia to reflect only the feasibility of species for reforestation based on species prominence in natural stands, observed plantation success, and autecological characteristics. Site-level variation in species feasibility within each biogeoclimatic unit for Alberta and the USA was similarly approximated using the plot data located in the modelled climate areas, descriptions available in publications describing forest associations or ecosites, and available autecological interpretations. We define reforestation feasibility using five categories: 
-
-**E1 -- High environmental suitability**: Typically, no environmental limiting conditions for establishment and growth across the full range of site series conditions.
-
-**E2 -- Moderate environmental suitability**: Once tree species are successfully established, they will generally perform well. However;
-
--   species may be more susceptible to occasional but expected climatic extremes leading to mortality, damage, or reduced growth (e.g. drought periods);
-
--   some site types of the site series conditions may have higher constraints for the species leading to poor regeneration success or subsequent growth (e.g. frost prone locations or overly wet sites in Sx -- Horsetail site series),
-
--   may express slow growth rates across all conditions (e.g. woodland subzones or Xeric sites with \~SI50 \< 8m)
-
-**E3 -- Low environmental suitability**: Establishment and growth may be limited to specific site conditions of the site series but may perform well where successfully established.
-
--   expected climatic extremes have a high probability of causing reduced growth, damage or mortality in some years (e.g. drought periods);
-
--   a limited set of site series conditions are considered feasible for the species though it may perform well under these constraints (e.g. only feasible on warm aspect, lower elevations of the ESSF);
-
--   species may express very low growth rates across all conditions (e.g. parkland subzones or rock outcrops with SI50 \< 5m)
-
-**Non-local Feasibility**: Off-site trials indicate that a non-local species was feasible in the pre-climate change period but that migration lag or some other barrier restricted establishment.
-
-**Trial**: Species is not recognized as historically feasible for a site series but is projected to become feasible in the near future. Establishment of small operational trials recommended to provide information on possible inclusion of species in feasible species list.
-
-**Unsuitable**: Unlisted species are considered to be unsuitable to the site series in current and future periods. Future projections may indicate species are becoming unsuitable. This indicates that the climatic regime may impose serious growth constraints on the established species but may not necessarily indicate mortality.
-
-Feasibility for different time periods, given the progression of climate change, are given the following terms in the CCISS tool:
-
-**Historic Feasibility**: The baseline environmental suitability rating based primarily on the CFRG and the historic period pre 1991.
-
-**Establishment Feasibility**: The feasibility rating based on the mean historic, current, and 2021-2040 future projected feasibilities. This indicates the likely level of constraints for successful establishment of the species now.
-
-**Maturation Feasibility**: The mean feasibility rating based on the 4 future modelled 2021-2040 future projected feasibilities. This indicates the likely level of constraints for successful establishment of the species now.
-
-Insect and disease risks need to be considered in reforestation, particularly in the context of climate change. These factors are currently being assessed by Forest Health researchers. However, currently forest health factors need to be assessed as an additional consideration to CCISS feasibility projections. 
-
-
-### Differences from the Chief Forester's Reference Guide
-
-The [Establishment to Free Growing Guidebooks](https://www2.gov.bc.ca/gov/content/industry/forestry/managing-our-forest-resources/silviculture/stocking-standards) and [Chief Forester's Reference Guide for Stocking Standards](https://www2.gov.bc.ca/assets/gov/farming-natural-resources-and-industry/forestry/silviculture/stocking-standards/reference-guide/reference_guide_stocking_standards_20210907.xlsx) (CFRG) rank ecologically acceptable species for each site series. Three criteria are used to determine the most suitable species choices for sawlog production (the assumed management goal) based on an assessment of:
-
--   maximum sustainable productivity
--   crop reliability
--   silvicultural feasibility.
-
-The rankings applied always have at least one ""primary"" species for each site series indicating the best species choice to meet the timber objective.
-
-In contrast, the CCISS tool assesses the environmental suitability rating to species, which focuses on how well the species is suited to the climatic and site conditions of a site series regardless of management objective. Each tree species has adapted to a specific range of environmental conditions, and its growth and behaviour depend on the ecosystem in which it grows. In an unfavourable environment, that species growth potential will not be realized, and its susceptibility to damaging agents will increase. Unlike the ratings applied in the CFRG, site series with generally challenging growing conditions may have no tree species assigned to the highest suitability rating.
-
-

---FILE: instructions-raw/3d_ClimateProjections.Rmd---
@@ -12,7 +12,7 @@ editor_options:
 
 ### Climate Change Projections
 
-CCISS quantifies three types of climate change uncertainty: modeling uncertainty, natural variability, and socioeconomic uncertainty. These uncertainties are represented by calculating CCISS results for a large ensemble of potential future climate states. Rather than producing a single species feasibility value, CCISS provides a distribution of 72 feasibility values (8 climate models x 3 simulation runs x 3 socioeconomic scenarios) for each future time-period. 
+CCISS quantifies three types of climate change uncertainty: modeling uncertainty, natural variability, and socioeconomic uncertainty. These uncertainties are represented by calculating CCISS results for a large ensemble of potential future climate states. Rather than producing a single species suitability value, CCISS provides a distribution of 72 suitability values (8 climate models x 3 simulation runs x 3 socioeconomic scenarios) for each future time-period. 
 
 #### Climate modeling uncertainty
  

---FILE: instructions-raw/3e_BGCmodel.Rmd---
@@ -13,7 +13,7 @@ editor_options:
 ### Biogeoclimatic modeling
 
 CCISS uses spatial climatic analogs to make inferences about future tree
-species feasibility. A spatial climate analog is a location with a
+species suitability. A spatial climate analog is a location with a
 historical climate that is similar to the current or future projected
 climate of a different location. Biogeoclimatic subzone/variants are a
 uniquely useful set of spatial climate analogs because they are familiar
@@ -129,7 +129,7 @@ south coast.
 Figure 2: An example of biogeoclimatic projections for British Columbia,
 excerpted from Mackenzie & Mahony (2021). (a) Mapped biogeoclimatic
 zones, which encompass the 211 biogeoclimatic subzone/variants used to
-model tree species feasibility. (b) Biogeoclimatic projection of the
+model tree species suitability. (b) Biogeoclimatic projection of the
 recent period (1991-2018). (c-e) Biogeoclimatic projections of the
 2041-2070 period (RCP4.5) for two GCMs with medium (CESM1-CAM5), low
 (MRI-CGCM3) and high (CanESM2) regional climate sensitivity. (f)
@@ -141,10 +141,10 @@ biogeoclimatic unit of the 1961-1990 reference period. Boxplots show the
 full range and 25th-75th percentile range of the temperature change
 projected by the 15-GCM ensemble in each RCP/time period combination.
 
-
 #### Guidance for interpretation of biogeoclimatic projections
 
 ##### Evaluating BGC Future Projections
+
 An important consideration when evaluating the quality of any BGC future
 projection is that, ideally, it should be compared to the baseline of
 the same model, rather than to the original BEC linework. In some cases,
@@ -156,26 +156,28 @@ errors in the baseline climate mapping, and should therefore be
 interpreted carefully on case-by-case basis rather than assumed to be
 inaccuracies.
 
-##### Interpreting Spatial Shifts in BGC Projections 
-Although the visual effect of biogeoclimatic projections is of BGC zones and
-subzone/variants shifting across the map, these spatial shifts should
-not be taken literally. No analog is perfect, and projected analogs may
-be highly imperfect for several reasons. The actual future climate at
-any location will be a hybrid of (1) the characteristics of the analog
-climate, (2) novel climatic characteristics (e.g., extremes) that are
-not represented by the analog, and (3) enduring features of the local
-climate such as frost pooling, lake effects, and wind patterns. The
-estimated BGC classifications from any location and time period require
-careful consideration by the end users of CCISS products. 
-
-##### BGC Mapping in a Changing Climate 
-The misinterpretation of biogeoclimatic projections as literal spatial shifts 
-in BGC units has led to a common perception that climate change is rendering
-biogeoclimatic mapping obsolete. This is not the case. The linework of
-biogeoclimatic subzone/variants in many cases will remain useful as
-units of relative climatic variation across landscapes. The terminology
-we use for biogeoclimatic projections can help to emphasize that
-biogeoclimatic analogs are only approximations and that the
+##### Interpreting Spatial Shifts in BGC Projections
+
+Although the visual effect of biogeoclimatic projections is of BGC zones
+and subzone/variants shifting across the map, these spatial shifts
+should not be taken literally. No analog is perfect, and projected
+analogs may be highly imperfect for several reasons. The actual future
+climate at any location will be a hybrid of (1) the characteristics of
+the analog climate, (2) novel climatic characteristics (e.g., extremes)
+that are not represented by the analog, and (3) enduring features of the
+local climate such as frost pooling, lake effects, and wind patterns.
+The estimated BGC classifications from any location and time period
+require careful consideration by the end users of CCISS products.
+
+##### BGC Mapping in a Changing Climate
+
+The misinterpretation of biogeoclimatic projections as literal spatial
+shifts in BGC units has led to a common perception that climate change
+is rendering biogeoclimatic mapping obsolete. This is not the case. The
+linework of biogeoclimatic subzone/variants in many cases will remain
+useful as units of relative climatic variation across landscapes. The
+terminology we use for biogeoclimatic projections can help to emphasize
+that biogeoclimatic analogs are only approximations and that the
 biogeoclimatic units themselves are not undergoing spatial shifts.
 Rather than saying this location is becoming IDFxh1, it is more
 correct to say the future climate at this location is predicted to be

---FILE: instructions-raw/3f_NovelClimates.Rmd---
@@ -10,7 +10,177 @@ editor_options:
     wrap: 72
 ---
 
-### Novel Climate Detection
+# Novel Climate Detection
 
-CCISS uses the best available biogeoclimatic analog for each projected future climate condition. In some cases, the future climate condition does not have a good analog in the pool of historical climates; this is known as a novel climate. The biogeoclimatic model will choose the closest climate analog to the novel climate, but there may be substantial differences between the novel climate conditions and the climate conditions of climate analog. The basic problem of novel climates (poor analogs) is that they give misleading results but are not explicitly identified by the biogeoclimatic model. Detecting novel climates requires an additional step in the CCISS analysis. 
+In the CCISS framework the pool of historical climate analogs consists of biogeoclimatic subzone-variants from British Columbia, Alberta and the Western United States. For each projected future climate, the biogeoclimatic model chooses the most similar climate analog from this analog pool. However, the climates of western North America do not necessarily represent all potential future climate conditions. There may be substantial differences between the future climate condition and the climate conditions of the biogeoclimatic analog. In such cases, the future conditions are a novel climate. The basic problem of novel climates (poor analogs) is that they give misleading results but are not explicitly identified by the biogeoclimatic model. Detecting novel climates requires an additional step in the CCISS analysis. 
 
+CCISS measures climatic novelty relative to the climatic variation of the analog. In each biogeoclimatic projection, we calculate a novelty measurement for each BGC subzone/variant that is being used as an analog. We sample the baseline  (1961-1990) climates found across the current geographical range of each BGC subzone/variant, and combine this spatial variation with the 1951-1990 temporal variation of the analog. This pooled spatiotemporal variation is then used to measure the difference between the climate of the analog and the future climates that are assigned that analog in the biogeoclimatic projection. To make this measurement, we use a metric called sigma dissimilarity (Mahony et al. 2017). 
+
+Novelty detection for machine learning models is non-trivial and imprecise. The novelty metric provides an indication of where CCISS results may be unreliable or require additional expert input. However, it likely underestimates novelty in some locations and overestimates it in others. Users are encouraged to look at the broader pattern of novelty around their query locations to assess whether their local novelty results are representative. Over time, the CCISS team will develop region-specific interpretations of the drivers of climatic novelty and their ecological implications. 
+
+This article describes the CCISS novelty detection methods and results in a coastal case study and at the provincial scale. The goal of this article is to provide users with the ability to interpret novelty results with an understanding of the strengths and limitations of the method. 
+
+## Definitions
+
+The following are definitions of key terms used in this article: 
+
+-	**Baseline** --- The historical climate used to compare observed climates of more recent periods or simulated future climates. The CCISS baseline period is 1961-1990. 
+-	**Target** --- The current or future climate condition for which a historical analog is identified, and for which novelty is being measured. In CCISS, these are climatic averages over 20-year periods (2001-2020 through 2081-2100) for locations throughout BC. 
+-	**Analog** --- The baseline climate condition assessed as being most similar to the target condition, among a set of candidate analogs. The analog pool for CCISS is the 1961-1990 climates of the biogeoclimatic subzone-variants of Western North America. 
+
+## The novelty metric  sigma dissimilarity
+
+The basic question we are asking in novel climate detection is: how similar is the future climate condition to the climatic conditions of the historical climate analog. A statistical rephrasing of this question is: what is the probability that the future climate condition was drawn from the same distribution as the climatic conditions of the historical analog?  Mahalanobis distances are commonly used to answer this type of question. Following Mahony et al. 2017, we translate Mahalanobis distances into a novelty metric called sigma dissimilarity. 
+
+### Mahalanobis distance
+
+The typical understanding of distance is Euclidean distance, in which a line of equal distance from any point has the shape of a circle or sphere. The problem with Euclidean distance for novelty detection is that it doesnt account for correlations among variables. If variables are correlated (as climate variables often are), the standardized Euclidean distance will overestimate the novelty of some points and underestimate the novelty of others. Mahalanobis overcomes this problem by accounting for correlations among variables (Figure 1). Instead of following concentric circles like Euclidian distances do, Mahalanobis distances follow ellipses with eccentricity that matches the correlation of the data. Assuming multivariate normality, Mahalanobis distances represent lines of equal probability that a new observation is an outlier. Mahalanobis distances are equivalent to standardized Euclidean distances in the principal components of the variables. 
+
+<figure>
+  <img src=""Figure_Novelty_MahalDemo.png"" alt="""" style=""width:50%;"">
+  <figcaption style=""font-size: 0.8em; color: gray;"">Figure 1: Illustration of novelty/outlier detection using Mahalanobis distance. Grey dots are individual years of 1951-1990 summer temperature and precipitation at Quesnel, BC. The climate variables are correlated such that there is a dominant mode of variabilitycool/wet years vs. warm/dry yearsthat is detected by a principal components analysis (PCA) as PC1. The more unusual mode of variability (cool/dry vs. warm/wet years) is the second principal component, PC2. Mahalanobis distance is equivalent to Euclidean distance measured in the standardized principal components. The dashed ellipses are the Mahalanobis distances within which 95% and 99.7% of the years would be expected to occur, assuming multivariate normality of the data. A hypothetical new climate observation (black dot) is within the individual (univariate) distributions of historical temperature and precipitation, but it can be identified as an outlier (i.e., a novel climatic condition) because it falls outside their bivariate distribution as described by Mahalanobis distance.  </figcaption>
+</figure>
+
+### Sigma dissimilarity
+
+Mahalanobis distance is not in itself an adequate metric of novelty because the statistical meaning of distances depends on the number of dimensions in which the distances are measured. Since CCISS uses different numbers of principal components for different BGC analogs, these dimensionality effects are important. Thus to obtain an intuitive and statistically consistent novelty metric that can be used to compare across analogs, we use sigma dissimilarity (Mahony et al. 2017). 
+
+#### Theory of sigma dissimilarity
+The effect of dimensionality on the probabilities of distances can be visualized using a random sample from a multivariate normal distribution (Figure 2a).  In any one dimension (either the x or y axis), there is a 68% probability that an observation will be within one standard deviation of the mean. In other words, 68% of the points are expected to have a distance from the mean of less than one. In two dimensions, the probability that an observation will fall within a distance of one from the centroid is reduced to 39%. As the number of dimensions increases, even more observations fall outside a distance of 1, such that all observations become increasingly distant from their own mean. 
+
+The probability of multivariate normal distances (and therefore Mahalanobis distances) are described by the chi distribution with degrees of freedom equaling the dimensionality of the data (Figure 2b-c). Chi percentiles can be expressed using the terminology of univariate z-scores; i.e., 1, 2, and 3 sigma () for the 68th, 95th, and 99.7th normal percentiles, respectively. The chi distribution in 1 dimension is a half-normal distribution, and the sigma levels correspond to distance. This result is expected because Mahalanobis distances in one dimension are the absolute values of z-scores.  At increasing dimensionality, the sigma levels shift away from the origin.  For example, 1 (the 68th percentile) occurs at Mahalanobis distances of 1.0 in one dimension versus 1.5 in two dimensions (Fig 2b, c).  By extending sigma levels into multiple dimensions, sigma dissimilarity serves as a multivariate z-score. 
+
+<figure>
+  <img src=""Figure_Novelty_SigmaDemo.png"" alt="""" style=""width:60%;"">
+  <figcaption style=""font-size: 0.8em; color: gray;"">Figure 2. An illustration of the basis for sigma dissimilarity. a, Geometric illustration of the effect of dimensionality on the probability density of distances. b-c, Use of the chi distribution to describe Mahalanobis distances as sigma () percentiles at increasing dimensionality.  </figcaption>
+</figure>
+
+## Novel climate detection in CCISS
+
+To measure climatic novelty with sigma dissimilarity, we need to define the variation that the Mahalanobis distance is proportioned to. The question we are asking is novel relative to what? 
+
+Since CCISS uses biogeoclimatic (BGC) subzone-variants as climate analogs, it is primarily interested in whether the target (future) climate matches the baseline (historical) climate of any location within the analog. In other words, CCISS is most interested in measuring novelty relative to the spatial climatic variation of the analog. However, we have also found it necessary to include the interannual climatic variability (ICV) of the analog into the measurement (see rationale below). Therefore, we measure novelty relative to the spatiotemporal climatic variation of the analog. This is different from the approach of Mahony et al. (2017), who defined novelty relative to the interannual climatic variability of the target climate. 
+
+Novel climates detection in CCISS is done separately for each BGC analog, in three steps: 
+
+1.	Principal components analysis (PCA)  conduct a PCA on an equal sample of spatial variation in baseline and target climates of the analog, and choose a subset of the PCs that represent 95% of the variance in this pooled sample; 
+2.	z-standardization  standardize the retained PCs so that the pooled analog spatial climatic variation and ICV have a mean of 0 and a standard deviation of 1; and 
+3.	Measure sigma dissimilarity of target (future) climatic conditions. This approach measures dissimilarity from the target climate to the average climate of the BGC analog rather than to the most similar (potentially peripheral) location within the analog. 
+
+### Rationale
+
+#### In step 1, why is the PCA done on a combination of the baseline and target climates? 
+
+Mahalanobis distance can be unstable if all PCs are included. For this reason, we retain only 3-6 PCs that describe 95% of the variance in the data. however, there is no guarantee that the major principal components of the analogs spatial climatic variation include the ways in which the future climate is different than the analog climate. In other words, distance measurement in the primary modes of spatial variation could be blind to the primary modes of climate change. This would cause underestimation of novelty. To ensure that the differences between the future climates and the analog climate are detected, we conduct the PCA on a combination of spatial variation in both the analog and target climates . 
+
+#### In step 2, why are the PCs standardized to both spatial and temporal variation of the analog? 
+
+Scaling the novelty metric to spatial variation alone has two important shortcomings. First, very small BGC subzone/variants often have much less climatic variation relative to larger ones simply due to their size. This can lead to overestimation of climatic novelty for small subzone/variants. Second, spatial variation can be very low in the modes of climate change, especially for analogs that are located on flat terrain. Measuring climatic distances in PCs standardized to very low spatial variation can result in artificially high sigma dissimilarity. To make the novelty metric more robust, we include interannual climatic variability (ICV) in the z-standardization. Specifically, we pool the analog's spatial climatic variation with the climate values of each year in the 1951 -1990 period. A 40-year sample is used because it is more robust than 30 years. The ecological rationale for including ICV is that a future condition can be considered less novel if it is similar to individual years in the baseline climate instead of being entirely unprecedented. The effect of this modification is to reduce novelty in small and/or topographically simple BGC analogs.  
+
+### Variable selection
+
+Novelty should be measured in climate variables that are ecologically meaningful and relevant to the variables that were used to identify the climate analog. Superficially, it seems logical to measure novelty using the variables that were used to train the biogeoclimatic model. However, there are two reasons why the input variables to the BGC model are not necessarily the most appropriate for novelty measurement. 
+
+1.	Machine learning doesnt use input variables equally for differentiating each potential analog from its neighbours. For example, the variable selection and thresholds used to differentiate grassland from forest climates are likely to be different from those used to differentiate subalpine from alpine climates. Mahalanobis distance, in contrast, is blind to the variables that differentiate the focal analog from its neighbours and instead emphasizes the modes of spatial and temporal variation of the analog itself. As a result, even if both the BGC model and the novelty detection were given the same input variables, their results would not necessarily be any more consistent than a novelty detection with different input variables. 
+2.	Mahalanobis distance relies on the assumption of multivariate normality, i.e., that the analog variation can be approximated with a hyperellipse. While this assumption generally holds for temperature and log-transformed precipitation variables, it can be severely violated by the bioclimatic variables often used in biogeoclimatic modeling, such as degree-days and climatic moisture deficit. Violations of the multivariate normality assumption can cause large novelty artefacts. 
+
+For those reasons, CCISS novelty detection uses a basic 12-variable set of Tmin, Tmax, and precipitation of the four seasons. 
+
+### Threshold selection
+
+Novelty is a continuum. Further, the novelty measurement is prone to error because the relevant climates variables and ecological responses are unknown and specific to each ecosystem and tree species. Hence there is no objective basis for a threshold of sigma dissimilarity above which a target climate can be labelled as a novel climate. Nevertheless, it is necessary to establish a threshold of novelty above which BGC analogs will not be used to make inferences of future species suitability. If this threshold is set too high, CCISS will make invalid and misleading inferences. If the threshold is too low, useful information may be discarded. 
+
+The CCISS tool uses a default dissimilarity threshold of 5-sigma (5$\sigma$) to infer a novel climate and discard the biogeoclimatic analog. 5$\sigma$ is a low bar to meet for analog goodness of fit. Assuming multivariate normality, it corresponds to a 1-in-3,500,000 chance that the target climate would occur within the analogs geographical range and/or interannual climatic variability. However, given the many potential sources of error in the CCISS novelty measurement, 5$\sigma$ novelty could be more likely in some cases. This threshold provides a reasonable balance between the risks of making an invalid inference vs. discarding useful information. 
+
+The CCISS tool also indicates the proportion of each species suitability projection that is in the 3-5$\sigma$ range. 3$\sigma$ corresponds to a 1-in-370 event within the analogs spatiotemporal climatic variability.  Novelty in the 3-5$\sigma$ range can be interpreted as a poor analog. In this range, species suitability inferences may be useful but are also likely to be somewhat misleading. 
+
+## Case study  CWHxm_WA
+
+To illustrate the interpretation of climatic novelty in biogeoclimatic projections, we use the example of the CWHxm_WA subzone (Coastal Western Hemlock very dry maritime, Washington variant), which spans the Puget Lowlands in Washington State from the hilltops of the San Juan Islands to Portland, Oregon (Figure 3). The baseline 1961-1990 climate of the CWHxm_WA is widely used as an analog for current and future climates of the near-shore lands surrounding the Strait of Georgia including Greater Vancouver. 
+
+<figure>
+  <img src=""Figure_Novelty_locatorMap_CWHxm_WA_novelty.png"" alt="""" style=""width:30%;"">
+  <figcaption style=""font-size: 0.8em; color: gray;"">Figure 3: Location of the CWHxm_WA subzone in the Puget lowlands of Washington State. The CWHxm_WA is a common analog for novel near-future climates of the Georgia Basin, including Vancouver, BC. Areas of BC are mapped by degree of novelty for an EC-Earth3 SSP2-4.5 simulation for the 2041-2060 period. This image is a screenshot from the CCISS spatial module.  </figcaption>
+</figure>
+
+The variation of the baseline analog climates and the target climates are quantified in a PCA scree plot (Figure 4). The basic interpretation of the scree plot is that there are 12 PCs because there are 12 input variables each standardized to unit variance (st. dev. = 1).  Since the PC was performed on the combined target and analog climates , PC1 is the primary mode of separation between the target and analog climates. PC2 contains the most spatial variation in the analog and target climates but very little separation of their means, as visualized in Figure 5b. Subsequent PCs contain decreasing spatial variation of analog and target climates, such that 95% of the variance in the pooled data is contained within the first four PCs. This was the criterion for exclusion of PCs 5-12. ICV variation does not decline as quickly because it was excluded from the PCA.  
+
+<figure>
+  <img src=""Figure_Novelty_Scree_CWHxm_WA.png"" alt="""" style=""width:50%;"">
+  <figcaption style=""font-size: 0.8em; color: gray;"">Figure 4: Scree plot of the principal components analysis used in novelty detection for future climates (EC-Earth3, 2041-2060, SSP2-4.5) assigned to the CWHxm_WA analog. Circles represent the climatic variation in each PC of the analog climates (baseline climates of the CWHxm_WA), target climates (future climates assigned to the CWHxm_WA analog), and ICV (1951-1990 interannual climatic variability of the CWHxm_WA). Black triangles are the distance between the means of the target and analog climates. 4 PCs are retained for novelty detection based on the criterion of retaining 95% percent of the pooled target and analog variance.   </figcaption>
+</figure>
+
+When viewed in the climate space of the first two PCs (Figure 5a), there is a clear separation in the baseline (1961-1990) climates of the CWHxm_WA (analog climates, blue dots) and the target (2041-2060) climatic conditions that are classified by the model as CWHxm_WA (red, orange, yellow dots). Degrees of novelty in the target climates range from 4 (yellow)---suggesting that the analog is a poor match for the target climate---to 7 (dark red)---suggesting that the analog is non-valid for these highly novel climates.  The small overlap between the analog and target climates is an illusion of the 2-dimensional space of PC1 and PC2: When viewed in PC3 and PC4 (Figure 5c), the yellow target climates are non-overlapping with the analog climates, demonstrating that the 4th PC was required to detect the novelty in these climates. Since PC5 was excluded from the novelty measurement, the additional modes of novelty are not detected (Figure 5d). 
+<figure>
+  <img src=""Figure_Novelty_2D_CWHxm_WA.png"" alt="""" style=""width:50%;"">
+  <figcaption style=""font-size: 0.8em; color: gray;"">Figure 5: Demonstration of novelty of future climates classified as the CWHxm_WA analog. Blue dots are the spatial variation in baseline (1961-1990) climates of the CWHxm_WA subzone. Black dots are the 1951-1990 interannual variability at a representative location  in the CWHxm_WA. Filled circles are projected 2041-2060 climates of locations in British Columbia that are assigned the CWHxm_WA analog by the BGC model, with colors indicating sigma novelty  consistent with the Figure 4 legend. Each panel provides a different orthogonal (perpendicular) view on the multidimensional data cloud, with PC1 being the axis with the most variation in the pooled points, and PC5 having the least.  </figcaption>
+</figure>
+
+The  climatic novelty of the CWHxm_WA target climates can be further visualized in the context of the baseline climates of Western North America (Figure 6). These projected 2041-2060 climates (yellow to red points) have no overlap with the spatial climatic variation of Western North America. The CWHxm_WA (blue points) is the best (i.e., most similar) available analog for these future climatic conditions, but it is a poor analog at best (yellow points) and a non-analog at worst (black points). The primary mode of novelty is positively correlated with mean summer nighttime temperature (Tmin_sm), but is also somewhat correlated with spring and autumn Tmin. Since the mode of novelty is relatively uncorrelated with precipitation and daily maximum temperatures , the CWHxm_WA may be an informative analog for ecological drivers, such as drought, that are primarily dependent on these variables. This illustrates how a climate analog can be useful for some interpretations, but misleading for others. 
+
+<figure>
+  <img src=""Figure_Novelty_3D_CWHxm_WA.png"" alt="""" style=""width:90%;"">
+  <figcaption style=""font-size: 0.8em; color: gray;"">Figure 6: 3-dimensional view of the CWHxm_WA analog and target climate variation in context of other climates of Western North America. Symbology is consistent with Figure 5, with the addition of spatial variation (grey dots) and spatial means (multicolored dots) of the climates of other candidate BGC analogs. Labelled lines indicate correlations of the input variables with the 3 PCs that comprise the viewspace.   </figcaption>
+</figure>
+
+## Provincial-scale results
+
+### Novelty over time
+
+Figure 7 shows the progression of climatic novelty over time in a global climate model simulation of 21st century climate change. Even in the baseline period (1961-1990), scattered locations have some degree of novelty from their model-predicted biogeoclimatic unit (Figure 7a). This baseline novelty can be due to (1) spatial climatic variation within a BGC that violates the assumption of multivariate normality (isnt elliptical in shape) and (2) baseline model predictions that differ from the BEC mapping. Overall, however, there is a very low degree of novelty in the baseline period, as would be expected. 
+
+Novelty in the simulated 2001-2020 climate is also generally low (Figure 7b), with notable novelty inferred only in small areas of the Peace region foothills of Northeastern BC and the Tatshenshini-Alsek provincial park in northwestern BC. By midcentury (Figure 7c), there is widespread inference of moderate novelty (3-5; yellowish colours), indicating poor analogs in these areas. However, the majority of the province still has good analogs in this period (0-2; grey colours).  By the end of the century (Figure 7d), moderately to highly novel (>5) climates occupy most regions of the province. Highly novel climates are projected for Northeastern BC, the coast, the Chilcotin Plateau and southern interior. 
+
+<figure>
+  <img src=""Figure_Novelty_maps_TimePeriod.png"" alt="""" style=""width:60%;"">
+  <figcaption style=""font-size: 0.8em; color: gray;"">Figure 7: Progression of climatic novelty over time. (a) Novelty of baseline observed climate. (b-d) Novelty of the EC-Earth3 simulation in three 20-year periods.   </figcaption>
+</figure>
+
+### Climate model variation 
+
+There is considerable variation among global climate models in the magnitude of climatic novelty (Figure 8). Some of this variation is due to different warming rates in the models, as indicated by the similarity in spatial patterns of novelty among models. However, there is also variation among models in the level of novelty at each warming level (Figure 9). For example, the MIROC6 model induces approximately half of the novelty as the GISS model at warming levels above 2\u00B0C.   
+
+<figure>
+  <img src=""Figure_Novelty_maps_GCMs.png"" alt="""" style=""width:60%;"">
+  <figcaption style=""font-size: 0.8em; color: gray;"">Figure 8: Variation in climatic novelty among individual simulations of global climate models, for the 2041-2060 period (SSP2-4.5 scenario).   </figcaption>
+</figure>
+
+<figure>
+  <img src=""Figure_Novelty_scatterplot_ensemble.png"" alt="""" style=""width:50%;"">
+  <figcaption style=""font-size: 0.8em; color: gray;"">Figure 9: Relationship of BC-mean novelty to warming level. Each point is one of five 20-year periods, 3 simulations, and 3 SSPs for each model, for a total of ~45 points per model.  </figcaption>
+</figure>
+
+## Sensitivity Analysis
+
+This section provides sensitivity analyses demonstrating the effect of key methodological decisions, namely variable selection, PC truncation rules, and how to balance spatial and temporal variation (ICV) in the standardization. Unless otherwise stated, sensitivity analyses use the EC-Earth3 r4i1p1f1 SSP2-4.5 simulation at the 2041-2061 time period. 
+
+### Variable selection
+
+The sensitivity of novelty to variable selection is illustrated in Figure 10. Both variable sets produce common regions of novelty, such as on the coast, southern Kootenays, and northeast BC, though the basic variables detect a lesser degree of novelty on the coast. The high-novelty region in the northern Columbia mountains in Figure 10b is likely an artefact of multivariate normality violation in degree-day and reference evaporation variables, which can have many zeros and highly skewed distributions. The disagreement between the two variable sets in the western Chilcotin is more enigmatic and deserves further investigation. 
+
+<figure>
+  <img src=""Figure_Novelty_maps_varsets.png"" alt="""" style=""width:60%;"">
+  <figcaption style=""font-size: 0.8em; color: gray;"">Figure 10: Sensitivity of climatic novelty to variable selection. Basic variables are Tmin, Tmax, and precipitation for the four seasons. BGC model variables are the 23 variables used to train the Random Forest model used to make the biogeoclimatic projections.  </figcaption>
+</figure>
+
+### Balance of spatial and temporal variation
+
+Novelty is highly sensitive to the relative weight of spatial and temporal variation. When interannual climatic variability (ICV) is excluded from the novelty measurement (Figure 11a), novelty is extreme in areas of interior BC with low topographic relief. This is primarily due to the modes of climate change being different from the few modes of spatial climatic variation on flat terrain. Conversely, when spatial climatic variation is excluded (Figure 11d), novelty is greater on the coast. This is due to lower interannual climatic variability in maritime climates and the prevalence of spatially large biogeoclimatic subzone/variants in the coastal classification. The contrasting drivers of coastal and interior novelty balance each other at intermediate ICV weights  (Figure 11b-c). We chose an ICV weight of 0.5 for novelty detection in CCISS).  
+
+<figure>
+  <img src=""Figure_Novelty_maps_ICVweight_BasicVar.png"" alt="""" style=""width:60%;"">
+  <figcaption style=""font-size: 0.8em; color: gray;"">Figure 11: Sensitivity of climatic novelty to the balance of spatial vs. temporal (ICV) variation. ICV weight is the proportional influence of interannual climatic variability on the calculation of Mahalanobis distance, relative to spatial climatic variation.  </figcaption>
+</figure>
+
+### Dimensionality (PC truncation rule)
+
+The CCISS novelty method retains PCs with a cumulative variance of 95% of the total data variance. Consequently, the dimensionality of the sigma dissimilarity differs among analogs, within the range of 4-6 PCs. Figure 12 illustrates the effect of dimensionality on novelty by measuring sigma dissimilarity at uniform number of PCs throughout BC. In general, novelty increases when more PCs are retained because there are more modes of variation for future conditions to be different from their analog. However, the CCISS novelty method is not highly sensitive to the dimensionality of the measurement (Figure 12). This indicates that the results of novelty detection do not hinge on the decision to the 95% variance criterion vs. other potential truncation rules.
+
+<figure>
+  <img src=""Figure_Novelty_maps_PCs_BasicVar.png"" alt="""" style=""width:60%;"">
+  <figcaption style=""font-size: 0.8em; color: gray;"">Figure 12: Sensitivity of climatic novelty to the number of principal components used to calculate Mahalanobis distance.  </figcaption>
+</figure>
+
+## References
+
+Mahony, C.R., A.J. Cannon, T. Wang, and S.N. Aitken. 2017. A closer look at novel climates: new methods and insights at continental to landscape scales. Global Change Biology 23: 39343955.

---FILE: instructions-raw/3g_EdatopicOverlap.Rmd---
@@ -18,20 +18,20 @@ In the BEC system, variations in site conditions within each climate type (i.e.,
 
 #### Site series misalignment
 
-In the CCISS analysis, the edatope of each location of interest remains constant as the climate changes. If species feasibility ratings were specified for each edatope, and if the edatope of the location of interest were known, then there could be a direct transfer of species feasiblity from the future BGC analog to the location of interest. However, species feasiblity ratings are at the site series level, and typically the management decision is also being made at the site series level.  This creates a problem for the CCISS analysis: since the edatopic distributions of corresponding site series at any edatope do not align among the BGC subzone/variants, there is ambiguity about which site series of the projected future BGC subzone/variant is the correct one to choose for any site series in the historical climate. 
+In the CCISS analysis, the edatope of each location of interest remains constant as the climate changes. If species suitability ratings were specified for each edatope, and if the edatope of the location of interest were known, then there could be a direct transfer of species suitability from the future BGC analog to the location of interest. However, species suitability ratings are at the site series level, and typically the management decision is also being made at the site series level.  This creates a problem for the CCISS analysis: since the edatopic distributions of corresponding site series at any edatope do not align among the BGC subzone/variants, there is ambiguity about which site series of the projected future BGC subzone/variant is the correct one to choose for any site series in the historical climate. 
 
-The problem of site series alignment is illustrated in Figure 1. In this example, the historical site series of interest is the 09 site series, which occupies four edatopes: D5, D6, E5, and E6 (left panel). The BGC subzone/variant analog for the future climate has three site series that overlap with this edatopic space: 07, 08, and 09 (right panel). Tree species feasibility ratings from each of these three site series are applicable to the historical site series 09. 
+The problem of site series alignment is illustrated in Figure 1. In this example, the historical site series of interest is the 09 site series, which occupies four edatopes: D5, D6, E5, and E6 (left panel). The BGC subzone/variant analog for the future climate has three site series that overlap with this edatopic space: 07, 08, and 09 (right panel). Tree species suitability ratings from each of these three site series are applicable to the historical site series 09. 
 
 <img src=""Figure_EdaOverlap1.png"" alt=""Example of the misalignment of site series of a historical BGC subzone/variant (left) and the BGC subzone/variant analog for its projected future climate (right)."" style=""width:50%;""/>
 
 Figure 1: Example of the misalignment of site series of a historical BGC subzone/variant (left) and the BGC subzone/variant analog for its projected future climate (right). 
 
-#### Weighting site series contributions to CCISS feasibility projections
+#### Weighting site series contributions to CCISS suitability projections
 
-Instead of choosing a single best match analog site series, the CCISS tool uses all analog site series weighted by their overlaps with the historical site series (Figure 2). There are two directions of overlap: forward overlap (how much of the historical site series is covered by the analog site series), and reverse overlap (how much of the analog site series is covered by the historical site series). Overlaps are measured at the edatope level: partial occupancy of a site series in an edatope is counted as a full edatope.  In the example from Figure 1, the historical 09 and analog 07 site series have a forward overlap of 25% and a reverse overlap of 50%. These overlaps are multiplied to produce an overlap agreement of 12.5%. After rescaling the overlap agreements by 1.273 so that they sum to 100%, the contribution of the 07 site series to the projected tree species feasibility is 16%. 
+Instead of choosing a single best match analog site series, the CCISS tool uses all analog site series weighted by their overlaps with the historical site series (Figure 2). There are two directions of overlap: forward overlap (how much of the historical site series is covered by the analog site series), and reverse overlap (how much of the analog site series is covered by the historical site series). Overlaps are measured at the edatope level: partial occupancy of a site series in an edatope is counted as a full edatope.  In the example from Figure 1, the historical 09 and analog 07 site series have a forward overlap of 25% and a reverse overlap of 50%. These overlaps are multiplied to produce an overlap agreement of 12.5%. After rescaling the overlap agreements by 1.273 so that they sum to 100%, the contribution of the 07 site series to the projected tree species suitability is 16%. 
 
-<img src=""Figure_EdaOverlap2.png"" alt=""Calculation of the overlap agreement for the example shown in Figure 1. Overlap agreement is weight of each site series to contribute its tree species feasibility ratings to the CCISS projection for the historical site series of interest."" style=""width:50%;""/>
+<img src=""Figure_EdaOverlap2.png"" alt=""Calculation of the overlap agreement for the example shown in Figure 1. Overlap agreement is weight of each site series to contribute its tree species suitability ratings to the CCISS projection for the historical site series of interest."" style=""width:50%;""/>
 
-Figure 2: Calculation of the overlap agreement for the example shown in Figure 1. Overlap agreement is weight of each site series to contribute its tree species feasibility ratings to the CCISS projection for the historical site series of interest.   
+Figure 2: Calculation of the overlap agreement for the example shown in Figure 1. Overlap agreement is weight of each site series to contribute its tree species suitability ratings to the CCISS projection for the historical site series of interest.   
 
 Extra-edatopic site series (e.g. floodplains) are aligned to similar types by predefined rule sets (e.g. historical high-bench floodplain site series aligned to analog high-bench floodplain site series). 

---FILE: instructions-raw/3h_Rulesets.Rmd---
@@ -10,4 +10,63 @@ editor_options:
     wrap: 72
 ---
 
-Under construction
\ No newline at end of file
+### CCISS Rulesets
+
+To account for uncertainty in future climates CCISS uses a suite of 8
+global climate models (GCMs) and 3 emission scenarios (SSPs). This
+strategy usually leads to multiple projected BGCs for each requested
+location (as shown in the ""BGC Futures"" tab) and thus, a range of
+projected suitabilities. While it is often informative to observe the
+full distribution of projected suitabilities, CCISS also uses rulesets
+to ""summarise"" the projected suitabilities into a single value.
+
+#### CCISS Suitability
+
+For each future period, the raw output of CCISS projections consist of
+possible suitability values (E1-high suitability, E2-moderate
+suitability, E3-low suitability or X-not suitable) for each climate
+model/emission scenario combination, i.e. a ""vote"" for a given
+suitability. (Note that due to overlapping edatopic space, there is
+often not a one-to-one match between models and suitability values. See
+the ""Methods - Overview"" tab for a detailed explanation of edatopic
+overlap.) To summarise these votes into a single ""projected suitability""
+for each tree species at each requested location, we use the following
+equation:
+
+$$
+\text{Projected Suitability} = P(E1) + 2P(E2) + 3P(E3) + 5P(X)
+$$
+
+where $P(s)$ represents the proportion of votes for suitability $s$ and
+$P(E1) + P(E2) +P(E3) + P(X) = 1$. In essence, this is a weighted
+average of the suitability values, with slightly higher weight on
+non-suitable predictions. (Note that the E4 suitability class is not yet incorporated into the CCISS model. For more information see ""Methods- Suitability ratings"") 
+
+#### Establishment and Maturity
+
+Using the projected suitability described above, CCISS then further
+summarises these ratings over multiple time periods into an Establishment
+Suitability and a Maturity Suitability. Both of these are calculated as
+weighted averages of period-wise suitability: Establishment Suitability
+uses 1961-1990 (historic environmental suitability), 2001-2020, and 2021-2040
+projected suitabilities, while Maturity uses all future periods (2021 -
+2100). The weighting of the different periods are adjustable in ""Model
+Parameters"", and are by default almost equally weighted.
+
+There is one exception to the Establishment Suitability values: if a
+species is listed as historically unsuitable, but has a E1, E2 or E3
+Maturity Suitability, it gets listed as a ""Trial"" in Establishment
+Suitability.
+
+#### Preferred/Acceptable
+
+In order to align with the Chief Forester's Reference Guide, CCISS also
+creates a projected Preferred/Acceptable rating, based on
+species-specific suitability cutoffs and the Maturity Suitability
+(described above). The CCISS tool uses these in the ""Summary""
+suitability view, as well as in the exported data. For most conifer
+species, a suitability translates of E1 or E2 to $P$ (preferred), and a
+E3 suitability translates to $A$ (acceptable). There are a few
+exceptions, such as **Hm** (mountain hemlock), which is only assigned
+$P$ with a suitability of E1. With the exception of Oaks, most broadleaf
+species are not assigned a $P/A$ value. This may be updated as additional information on broadleaf suitability becomes available. 
\ No newline at end of file"
bcgov,CCISS_ShinyApp,ca1968cc911f5181c462428cded9cedec9465727,Obrist,Debora.Obrist@gov.bc.ca,2025-03-28T22:16:31Z,Obrist,Debora.Obrist@gov.bc.ca,2025-03-28T22:16:31Z,"Edited spelling errors and inconsistencies, updated info for tabs 4, 5, and 6",instructions-raw/1a_About_CCISS.Rmd,True,False,True,False,41,29,70,"---FILE: instructions-raw/1a_About_CCISS.Rmd---
@@ -10,54 +10,66 @@ editor_options:
     wrap: 72
 ---
 
-Climate Change Informed Species Selection (CCISS  pronounced kiss) is a Biogeoclimatic Ecosystem Classification-based analysis framework built to anticipate the change climate implications to tree species environmental suitability at a site specific level. The CCISS tool is a web-based application that makes this analysis accessible to practitioners to help guide climate change adaptation in reforestation decisions.
+Climate Change Informed Species Selection (CCISS  pronounced kiss) is a Biogeoclimatic Ecosystem Classification-based analysis framework built to anticipate the climate change implications to tree species environmental suitability at a site specific level. The CCISS tool is a web-based application that makes this analysis accessible to practitioners to help guide climate change adaptation in reforestation decisions.
 
 Understanding climate- and site-level species suitability is one of the foundational pieces of information that practitioners require for the creation of silvicultural prescriptions that will lead to successful reforestation over a rotation period. Climate change will affect this goal by progressively altering environmental conditions and therefore the suitability of tree species established on a site over time.
 
-To address this challenge, the CCISS tool projects changes to species environmental suitability at a site series level for any user selected location in the province and estimates the future suitability of a tree species to this changing climate. To account for future climate uncertainty the tool looks at a wide range of global climate change models and emissions scenarios to capture the range of plausible climate futures for any location in BC in 20-year periods out to 2100.
+To address this challenge, the CCISS tool projects changes to species environmental suitability at a site series level for any user selected location in the province and estimates the future suitability of a tree species to this changing climate. To account for future climate uncertainty, the tool looks at a wide range of global climate change models and emissions scenarios to capture the range of plausible climate futures for any location in BC in 20-year periods out to 2100.
 
-To assist users, the tool compares the current species selection guidance in the Chief Foresters Reference Guide with the future forecast from the CCISS analysis. Reports from the tool highlight where currently acceptable species are stable/improving or declining/unsuitable and where new species have become suitable and could be considered as candidates for assisted migration.
+To assist users, the tool compares the current species selection guidance in the Chief Forester's Reference Guide (CFRG) with the future forecast from the CCISS analysis. Reports from the tool highlight where currently acceptable species are stable/improving or declining/unsuitable and where new species have become suitable and could be considered as candidates for assisted migration.
 
-### How Can CCISS Be Applied In Climate Change Adaption?
+### How can CCISS be applied in climate change adaption?
 
-1. Designing Climate-change Stocking Standards
-2. Identifying current management practices that may lead to higer levels of risk with climate change.
-3. Setting Landscape Level Stocking Standards to Manage Uncertainty
-4. Identifying best locations for off-site species reforestation trials/ assisted range expansion
-5. Identifying regions and site conditions where forests and tree species are at highest risk to climate change stresses.
-6. Identifying climate change refugia 
+1. Designing stocking standards informed by climate change
+2. Identifying current management practices that may lead to higher levels of risk with climate change
+3. Setting landscape-level stocking standards to manage uncertainty
+4. Identifying best locations for off-site species reforestation trials and/or assisted range expansion
+5. Identifying regions and site conditions where forests and tree species are at highest risk to climate change stresses
+6. Identifying areas that could act as refugia from climate change
 
 The CCISS tool is a web-based R-shiny application organized into six tabs.
 
-1.	__Select Sites:__ User selects points or areas of interest using one of 3 methods
+1.	__SELECT SITES:__ User selects points or areas of interest using one of 3 methods
     i.	Single points
     ii.	By selected BGCs or BGCs within districts
     iii.	By submitted CSV file with user site locations
   
-2.	__Feasibility Report:__ 2 options
-    a.	__Detailed__: report suitability predictions for each species for a chosen site series at each point or AOI
-    b.	__Stocking Standard__: A comparison of the CFRG stocking standards and the CCISS predicted suitability ratings
+2.	__SUITABILITY REPORT:__ Reports on suitability projections, presented in detailed or summary form. 
+    a.	__Detailed__: This generates a report showing the suitability projections for each species for a chosen site series at each point or area of interest
+    b.	__Summary__: This generates a comparison of the Chief Forester's Reference Guide stocking standards and the CCISS projected suitability ratings
     
-3.	__BEC Futures:__ The model ratio of predicted BGCs by time period shown by 2 options.
-    a.	__Chart__: A stacked bar chart shows the ratio of biogeoclimatic units being predicted from the selected GMC and climate scenario models in each time period. Optionaly show the site series that are equivalent within each BGC
-    b.	__Map__: Show BGC map of western North America with the target BGC highlighted and the source BGCs for a selected future time period shown in greyscale. 
+3.	__BEC FUTURES:__ The modeled ratio of projected biogeoclimatic (BGC) units, by time period, presented in two options.
+    a.	__Chart__: A stacked bar chart that shows the ratio of BGC units being predicted from the selected global climate models (GCMs) and climate scenario models in each time period. Optionally, the site series that are equivalent within each BGC unit can be displayed.
+    b.	__Map__: Show biogeoclimatic map of western North America with the target BGC unit highlighted and the source BGC units for a selected future time period shown in greyscale. 
 
-4.	__Supporting Info:__ This tab has several subtabs.
-    a.	__Silvics and Ecology__: Tables of species from Klinka et al. 2000
-    b.	__Trends__: Summary of future trends for every tree species
+4.	__SILVICS & ECOLOGY:__ This tab has several subtabs of tables, all based on Klinka et al. (2000)'s comparison of silvical characteristics.
+    a.	__Tolerance__: Comparison of species tolerances
+    b.	__Resistance__: Comparison of species resistance and potential risk comparisons
+    c.  __Regeneration stage__: Comparison of regeneration stage characteristics
+    d.  __Maturing stage__: Comparison of maturing stage characteristics
 
-5.	__Reports__: Exporting reports or data for off-line use
-    a.	__Export reports__ of the web-tool screens (last report)in HTML or PDF
-    b.	__Export datasets__ in CSV or RDS file formats for further analysis
+5.	__EXPORT__: Exporting reports or data for off-line use
+    i. Produce report: Select report format (html or pdf)
+    ii. Export data: Select data format (csv or rds)
 
-6.	__About__: Help files and data sources
-    a.	__Executive Summary__: summary and links to supporting documents
-    b.	__Instructions__: how to use the tool
-    c.	__Model Info__: Data table versions used in the current CCISS analysis and change log.
-    d.	__Shiny App information__: Server information
+6.	__DOCUMENTATION__: Help files and data sources
+    a.	__Overview__: 
+    b.	__Instructions (How to CCISS)__: Instructions on how to use the tool
+    c.	__Methods (How the tool works)__: Detailed background information about what's happening ""under the hood""
+    d.	__Known issues__: Documentation on current known issues with the tool
+    e.  __Using CCISS for decisions__: Support and guidance for using CCISS as a decision-making tool
+    f.  __Providing feedback__: Ways users can report issues or provide suggestions for future improvements
+    g.  __FAQs__: Frequently asked questions
+    h.  __Model information__: Summary of the model information
+    i.  __Shiny app information__: Information about the Shiny app
 
+##### References: 
+Chief Forester's Reference Guide: https://www2.gov.bc.ca/gov/content/industry/forestry/managing-our-forest-resources/silviculture/stocking-standards
 
-##### Additional Documents:
+Klinka, K., J. Worrall, L. Skoda, and P. Varga. 2000. The Distribution and Synopsis of 
+Ecological and Silvical Characteristics of Tree Species of British Columbia's Forests. Canadian Cartographics 
+Ltd., Coquitlam, B.C.
 
+##### Additional Documents:
 [Forest Ecology and Management Science Paper](./downloadable_docs/MacKenzieMahony2021_CCISS_FEM.pdf)
 "
bcgov,CCISS_ShinyApp,3604af217485218e6198a66d87d1081b4c797efd,Kiri,kiridaust@gmail.com,2025-03-28T01:10:25Z,Kiri,kiridaust@gmail.com,2025-03-28T01:10:25Z,fix bgc futures,app/server/futures.R;app/ui.R,False,True,True,False,23,7,30,"---FILE: app/server/futures.R---
@@ -62,13 +62,19 @@ bgc_fut_plotly <- function(data, siteref, sseries, minallow, show_ss = ""BGC"", pe
   # data2[,text_col := ""#000000""]
   data2[BGC.pred == ""novel"", BGC.pred := ""Novel Climate""]
   temp <- unique(data2$BGC.pred)
-  data2[,BGC.pred := factor(BGC.pred, levels = c(sort(temp[-grep(""Novel"",temp)]),""Novel Climate""))]
+  if(any(grepl(""Novel"",temp))) {
+    data2[,BGC.pred := factor(BGC.pred, levels = c(sort(temp[-grep(""Novel"",temp)]),""Novel Climate""))]
+  } else {
+    data2[,BGC.pred := factor(BGC.pred, levels = sort(temp))]
+  }
+  
   # data2[,BGC.pred := as.character(BGC.pred)]
   if(show_ss == ""BGC""){
     plotly::plot_ly(data = data2, x = ~fpCode,
                     y = ~BGC.prop, split = ~BGC.pred, type = 'bar',
                     color = ~BGC.pred, colors = color_ref, hovertemplate = ""%{y}"",
-                    text = ~BGC.pred, insidetextfont = list(size = 12), textfont = list(color = ""#FFF""), textposition = 'inside',
+                    text = ~BGC.pred, insidetextfont = list(size = 12), 
+                    textfont = list(color = ""#FFF""), textposition = 'inside',
                     texttemplate = ""%{text}"") %>%
       plotly::layout(yaxis = list(title = """", tickformat = "".1%""),
                      xaxis = list(showspikes = FALSE, title = list(text = ""Period""),
@@ -88,7 +94,7 @@ bgc_fut_plotly <- function(data, siteref, sseries, minallow, show_ss = ""BGC"", pe
                      xaxis = list(showspikes = FALSE, title = list(text = ""Period""),
                                   ticktext = unname(period_map),
                                   tickvals = dat_order$fpCode),
-                     barmode = 'stack', legend = l, hovermode = ""x unified"")
+                     barmode = 'stack',showlegend = FALSE, legend = l, hovermode = ""x unified"")
   }
   
 }

---FILE: app/ui.R---
@@ -566,9 +566,9 @@ $(document).ready(function(){
               includeHTML(""./instructions/2a_SelectSites.html"") 
             ),
             tabPanel(
-              title = ""Feasibility Report"",
+              title = ""Suitability Report"",
               value = ""cciss_instructions_feasibility_report"",
-              includeHTML(""./instructions/2b_FeasibilityReport.html"") 
+              includeHTML(""./instructions/2b_SuitabilityReport.html"") 
             ),
             tabPanel(
               title = ""BEC Futures"",
@@ -616,9 +616,9 @@ $(document).ready(function(){
               includeHTML(""./instructions/3b_BEC.html"") 
             ),
             tabPanel(
-              title = ""Feasibility Ratings"",
+              title = ""Suitability Ratings"",
               value = ""cciss_3c"",
-              includeHTML(""./instructions/3c_FeasibilityRatings.html"") 
+              includeHTML(""./instructions/3c_SuitabilityRatings.html"") 
             ),
             tabPanel(
               title = ""Climate Change Projections"",
@@ -649,6 +649,16 @@ $(document).ready(function(){
               title = ""Outside Home Range"",
               value = ""cciss_3i"",
               includeHTML(""./instructions/3i_OHR.html"") 
+            ),
+            tabPanel(
+              title = ""BEC 13"",
+              value = ""cciss_3j"",
+              includeHTML(""./instructions/3j_BEC13.html"") 
+            ),
+            tabPanel(
+              title = ""Expert Review"",
+              value = ""cciss_3k"",
+              includeHTML(""./instructions/3k_ExpertReview.html"") 
             )
 
           )"
bcgov,CCISS_ShinyApp,b5abad4907e7df86009a2a9a589c005cbc0b69af,Kiri,kiridaust@gmail.com,2025-03-28T00:34:37Z,Kiri,kiridaust@gmail.com,2025-03-28T00:34:37Z,"fix report downloads, update BEC future plot, feasible etc",Deploy_CCISS.R;app/server.R;app/server/download.R;app/server/futures.R;app/server/reportpdf.Rmd;app/ui.R,True,True,True,False,65,45,110,"---FILE: Deploy_CCISS.R---
@@ -4,7 +4,7 @@ library(ccissr)
 
 server <- analogsea::droplets()$`shiny-server`
 reset_ssh_sessions()
-droplet_ssh(server, ""rm -R /srv/shiny-server/cciss/instructions"")
+#droplet_ssh(server, ""rm -R /srv/shiny-server/cciss/instructions"")
 #analogsea::droplet_ssh(server,""rm -R /srv/shiny-server/ccissr/.Renviron"")
 analogsea::droplet_ssh(server, ""rm -R /srv/shiny-server/cciss"")
 analogsea::droplet_ssh(server, ""mkdir /srv/shiny-server/cciss"")
@@ -17,5 +17,20 @@ analogsea::droplet_upload(server, ""./app/www"", ""/srv/shiny-server/cciss"")
 analogsea::droplet_upload(server, ""./app/server"", ""/srv/shiny-server/cciss"")
 analogsea::droplet_upload(server, ""./app/instructions"", ""/srv/shiny-server/cciss"")
 analogsea::droplet_upload(server, ""./app/WNA_SZ_Cols_v13_6.csv"", ""/srv/shiny-server/cciss"")
+analogsea::droplet_upload(server, c(""./app/cciss_metadata.csv"",""./app/README.txt""), ""/srv/shiny-server/cciss"")
+analogsea::droplet_ssh(server, ""chown -R shiny:shiny /srv/shiny-server"")
+analogsea::droplet_ssh(server, ""systemctl restart shiny-server"")
+
+analogsea::droplet_ssh(server, ""rm -R /srv/shiny-server/ccissdev"")
+analogsea::droplet_ssh(server, ""mkdir /srv/shiny-server/ccissdev"")
+analogsea::droplet_upload(server, ""./.Renviron"", ""/srv/shiny-server/ccissdev"")
+#analogsea::droplet_ssh(server, ""R -e \""remotes::install_github('bcgov/ccissr@development', upgrade = FALSE)\"""")
+analogsea::droplet_upload(server, ""./app/global.R"", ""/srv/shiny-server/ccissdev/global.R"")
+analogsea::droplet_upload(server, ""./app/server.R"", ""/srv/shiny-server/ccissdev/server.R"")
+analogsea::droplet_upload(server, ""./app/ui.R"", ""/srv/shiny-server/ccissdev/ui.R"")
+analogsea::droplet_upload(server, ""./app/www"", ""/srv/shiny-server/ccissdev"")
+analogsea::droplet_upload(server, ""./app/server"", ""/srv/shiny-server/ccissdev"")
+analogsea::droplet_upload(server, ""./app/instructions"", ""/srv/shiny-server/ccissdev"")
+analogsea::droplet_upload(server, ""./app/WNA_SZ_Cols_v13_6.csv"", ""/srv/shiny-server/ccissdev"")
 analogsea::droplet_ssh(server, ""chown -R shiny:shiny /srv/shiny-server"")
 analogsea::droplet_ssh(server, ""systemctl restart shiny-server"")

---FILE: app/server.R---
@@ -18,18 +18,18 @@ sppDb <- dbPool(
   user = Sys.getenv(""BCGOV_USR""),
   password = Sys.getenv(""BCGOV_PWD"")
 )
-poolclim <- dbPool(
-  drv = RPostgres::Postgres(),
-  dbname = ""bgc_climate_data"",
-  host = Sys.getenv(""BCGOV_HOST""),
-  port = 5432, 
-  user = Sys.getenv(""BCGOV_USR""),
-  password = Sys.getenv(""BCGOV_PWD"")
-)
+# poolclim <- dbPool(
+#   drv = RPostgres::Postgres(),
+#   dbname = ""bgc_climate_data"",
+#   host = Sys.getenv(""BCGOV_HOST""),
+#   port = 5432, 
+#   user = Sys.getenv(""BCGOV_USR""),
+#   password = Sys.getenv(""BCGOV_PWD"")
+# )
 onStop(function() {
   poolClose(pool)
   poolClose(sppDb)
-  poolClose(poolclim)
+  #poolClose(poolclim)
 })
 
 DEV = TRUE
@@ -210,13 +210,13 @@ shinyServer(function(input, output, session) {
       switchInput(""show_ohr"", value = session_params$show_ohr, onLabel = ""Use OHR Suitabilities"", 
                   offLabel = ""Remove OHR Suitabilities"", width = '100%'),
       
-      h6(""Establishment Feasibility Weights""),
+      h6(""Establishment Suitability Weights""),
       splitLayout(
         numericInput(""hwt961"",""1961-1990"", value = session_params$estabWt[1], min = 0, max = 1,step = 0.05),
         numericInput(""hwt991"",""1991-2020"", value = session_params$estabWt[2], min = 0, max = 1,step = 0.05),
         numericInput(""hwt21"",""2021-2040"", value = session_params$estabWt[3], min = 0, max = 1,step = 0.05)
       ),
-      h6(""Future Period Weights""),
+      h6(""Maturity Suitability Weights""),
       splitLayout(
         numericInput(""wt21"",""2021-2040"", value = session_params$futWt[1], min = 0, max = 1,step = 0.05),
         numericInput(""wt41"",""2041-2060"", value = session_params$futWt[2], min = 0, max = 1,step = 0.05),

---FILE: app/server/download.R---
@@ -24,7 +24,7 @@ output$report_download <- downloadHandler(
     withProgress(min = 0, max = 4, value = 1, message = ""Processing report"", {
 
       if (input$report_format == ""html"") {
-        reportmd <- ""reporthtml.Rmd""
+        reportmd <- ""reportpdf.Rmd""
       } else if (input$report_format == ""pdf"") {
         reportmd <- ""reportpdf.Rmd""
       } else {

---FILE: app/server/futures.R---
@@ -28,13 +28,13 @@ output$bgc_fut_plot <- plotly::renderPlotly({
   dat_bgc <- copy(uData$bgc)
   dat_bgc[,BGC := NULL]
   plotdat <- merge.data.table(data,dat_bgc, on = c(""SiteRef"",""FuturePeriod"",""BGC.pred""), all= TRUE)
-  bgc_fut_plotly(plotdat, siteref, sseries, minallow)
+  bgc_fut_plotly(plotdat, siteref, sseries, minallow, show_ss = input$future_showss)
 })
 
 # Graph
 
 #' @param data BGC data.table
-bgc_fut_plotly <- function(data, siteref, sseries, minallow, period_map = uData$period_map, ...) {
+bgc_fut_plotly <- function(data, siteref, sseries, minallow, show_ss = ""BGC"", period_map = uData$period_map, ...) {
   #data <- data[SSratio > minallow,]
   dat_order <- data.table(FuturePeriod = c(""1961"",""1991"",""2001"",""2021"",""2041"",""2061"", ""2081""), fpCode = c(1,2,3.5,4.5,5.5,6.5,7.5))
   #browser()
@@ -64,7 +64,7 @@ bgc_fut_plotly <- function(data, siteref, sseries, minallow, period_map = uData$
   temp <- unique(data2$BGC.pred)
   data2[,BGC.pred := factor(BGC.pred, levels = c(sort(temp[-grep(""Novel"",temp)]),""Novel Climate""))]
   # data2[,BGC.pred := as.character(BGC.pred)]
-  if(input$future_showss == ""BGC""){
+  if(show_ss == ""BGC""){
     plotly::plot_ly(data = data2, x = ~fpCode,
                     y = ~BGC.prop, split = ~BGC.pred, type = 'bar',
                     color = ~BGC.pred, colors = color_ref, hovertemplate = ""%{y}"",
@@ -74,7 +74,7 @@ bgc_fut_plotly <- function(data, siteref, sseries, minallow, period_map = uData$
                      xaxis = list(showspikes = FALSE, title = list(text = ""Period""),
                                   ticktext = unname(period_map),
                                   tickvals = dat_order$fpCode),
-                     barmode = 'stack', legend = l, hovermode = ""x unified"")
+                     barmode = 'stack', showlegend = FALSE, legend = l, hovermode = ""x unified"")
   }else{
     data <- data[SiteRef == siteref & SS_NoSpace == sseries,]
     data_ss <- merge(data2, data, on = c(""SiteRef"",""FuturePeriod"",""BGC.pred""), all = T)

---FILE: app/server/reportpdf.Rmd---
@@ -25,15 +25,16 @@ suppressPackageStartupMessages({
 opts_chunk$set(echo = FALSE, eval = TRUE, include = TRUE, message = FALSE, warning = FALSE)
 
 # Debug mode
-# userdata <- readRDS(""~/Downloads/cciss_export.rds"")
+# userdata <- readRDS(""cciss_export.rds"")
 # for (nm in names(userdata)) {assign(nm, userdata[[nm]])}
 # feasibility_filter = ""a""
 # source(""LeafletSource.R"")
+# source(""tooltip_verbage.R"")
 # pool <- dbPool(
 #   drv = RPostgres::Postgres(),
 #   dbname = Sys.getenv(""BCGOV_DB""),
 #   host = Sys.getenv(""BCGOV_HOST""),
-#   port = 5432, 
+#   port = 5432,
 #   user = Sys.getenv(""BCGOV_USR""),
 #   password = Sys.getenv(""BCGOV_PWD"")
 # )
@@ -56,7 +57,7 @@ if(exists(""pts"") & ncol(pts) > 2){
   # Define the reference for points lookup
   pts_ref <- pts[[{if (avg) {""BGC""} else {""Site""}}]]
 }else{
-  bbox <- st_read(pool, query = paste0(""select ST_Transform(ST_Envelope(ST_Collect(geom)),4326) from bgc_map3005 where bgc IN ('"",paste(bgc_select,collapse = ""','""),""');""))
+  bbox <- st_read(pool, query = paste0(""select ST_Envelope(ST_Collect(geom)) from bgc_map_v13 where \""BGC\"" IN ('"",paste(bgc_select,collapse = ""','""),""');""))
   bbox2 <- st_coordinates(bbox)[,1:2]
   indPoints = F
 }
@@ -84,16 +85,16 @@ if(exists(""pts"") & ncol(pts) > 2){
 
 # Feasibility legend
 legend <- tags$span(
-  ""Legend: "",
   htmltools::HTML(
-    paste0(
-      '<svg viewBox=""0 0 1 1"" height=""14px"" width=""14px""><rect height=1 width=1 style=""fill : ',
-      c(""limegreen"", ""deepskyblue"", ""gold"", ""grey""),
-      '"" /><span>&nbsp;',
-      c(""Primary"", ""Secondary"", ""Tertiary"", ""Not Suitable""),
-      '</span>',
-      collapse = ""&nbsp;&nbsp;&nbsp;""
-    )
+    ""Legend: <br />"",
+            paste0(
+              '<svg viewBox=""0 0 1 1"" height=""14px"" width=""14px""><rect height=1 width=1 style=""fill : ',
+              c(""limegreen"", ""deepskyblue"", ""gold"", ""grey"",""black""),
+              '"" /><span style=""vertical-align:middle"">&nbsp;',
+              c(""E1: High"", ""E2: Moderate"", ""E3: Low"", ""X: Not Suitable"",""Novel Climate""),
+              '</span>',
+              collapse = ""<br />""
+            )
   )
 )
 
@@ -106,14 +107,25 @@ datTP <- dcast(datTP,Summary ~ TimePeriods)
 
 # Recompute svg with smaller height
 cciss_results[, PredFeasSVG := paste0(
-        feasibility_svg(`1_1961`,`2_1961`,`3_1961`,`X_1961`,height = 11), ""<br />"",
-        feasibility_svg(`1_1991`,`2_1991`,`3_1991`,`X_1991`,height = 11), ""<br />"",
-        feasibility_svg(`1_2021`,`2_2021`,`3_2021`,`X_2021`,height = 11), ""<br />"",
-        feasibility_svg(`1_2041`,`2_2041`,`3_2041`,`X_2041`,height = 11), ""<br />"",
-        feasibility_svg(`1_2061`,`2_2061`,`3_2061`,`X_2061`,height = 11), ""<br />"",
-        feasibility_svg(`1_2081`,`2_2081`,`3_2081`,`X_2081`,height = 11)
-      )
+          feasibility_svg(`1_1961`,`2_1961`,`3_1961`,`X_1961`,`NOV_1961`,height = 11), ""<br />"",
+          feasibility_svg(`1_1991`,`2_1991`,`3_1991`,`X_1991`,`NOV_1991`,height = 11), ""<br />"",
+          feasibility_svg(`1_2001`,`2_2001`,`3_2001`,`X_2001`,`NOV_2001`,height = 11), ""<br />"",
+          feasibility_svg(`1_2021`,`2_2021`,`3_2021`,`X_2021`,`NOV_2021`,height = 11), ""<br />"",
+          feasibility_svg(`1_2041`,`2_2041`,`3_2041`,`X_2041`,`NOV_2041`,height = 11), ""<br />"",
+          feasibility_svg(`1_2061`,`2_2061`,`3_2061`,`X_2061`,`NOV_2061`,height = 11), ""<br />"",
+          feasibility_svg(`1_2081`,`2_2081`,`3_2081`,`X_2081`,`NOV_2081`,height = 11)
+        )
 ]
+
+data <- copy(eda_out)
+  #browser()
+data[,Lab := paste(SS.pred,round(SSratio,digits = 2),sep = "": "")]
+data <- data[,.(SSLab = paste(Lab,collapse = ""<br>"")),
+             by = .(SiteRef,SS_NoSpace,FuturePeriod,BGC.pred)]
+dat_bgc <- bgc
+dat_bgc[,BGC := NULL]
+plotdat <- merge.data.table(data,dat_bgc, on = c(""SiteRef"",""FuturePeriod"",""BGC.pred""), all= TRUE)
+
 ```
 
 <style type=""text/css"">
@@ -161,7 +173,7 @@ htmltools::tagList(
       ),
       tags$h5(class = ""bordered"", ""PREDICTED BGC FUTURES""),
       tags$div(class = ""bgc_future"",
-        bgc_fut_plotly(eda_out, siteref, siteseries_list[[siteref]][1],0.1, period_map,height = 450)
+        bgc_fut_plotly(plotdat, siteref, siteseries_list[[siteref]][1],0.1,""BGC"", period_map,height = 450)
       ),
       mapply(FUN = function(siteserie, nm) {
         htmltools::tagList(

---FILE: app/ui.R---
@@ -80,13 +80,6 @@ $(document).ready(function(){
             )
           ),
           splitLayout(
-            # radioButtons(
-            #   ""aggregation"",
-            #   ""Report Type"",
-            #   c(""Indiv Points"" = ""FALSE"", ""BGC avg"" = ""TRUE""),
-            #   inline = TRUE,
-            #   selected = ""TRUE""
-            # ),
             tagList(
               br(),
               actionButton(""sesh_params"", ""Model Parameters"", icon = icon(""sliders-h""), style = ""width:100%; align:center;"")
@@ -223,7 +216,7 @@ $(document).ready(function(){
         selectInput(""site_series_feas"", label = ""Choose Site Series"", choices = character()),
         radioButtons(
           ""filter_feas"",
-          label = ""Feasibility"",
+          label = ""Suitability"",
           choices = c(""All"" = ""a"", ""Suitable Only"" = ""f""),
           selected = ""a"",
           inline = T"
bcgov,CCISS_ShinyApp,685d1f2d9c951f11690de6d3717d09fc8fd6b5aa,Kiri,kiridaust@gmail.com,2025-03-25T17:23:22Z,Kiri,kiridaust@gmail.com,2025-03-25T17:23:22Z,Fix select BGC,app/server.R;app/server/generate.R;app/ui.R,False,True,True,False,8,8,16,"---FILE: app/server.R---
@@ -208,7 +208,7 @@ shinyServer(function(input, output, session) {
       
       h6(""Outside of Home Range (OHR) Species""),
       switchInput(""show_ohr"", value = session_params$show_ohr, onLabel = ""Use OHR Suitabilities"", 
-                  offLabel = ""Remove OHR Suitabilies"", width = '100%'),
+                  offLabel = ""Remove OHR Suitabilities"", width = '100%'),
       
       h6(""Establishment Feasibility Weights""),
       splitLayout(

---FILE: app/server/generate.R---
@@ -31,7 +31,7 @@ observeEvent(input$generate_results, priority = 100, {
   tic(""Process CCISS data"", ticker)
   cciss           <- uData$cciss           <- cciss(bgc ,session_params$estabWt,session_params$futWt)
   tic(""Format CCISS Results"", ticker)
-  cciss_results   <- uData$cciss_results   <- cciss_results(cciss, bgc, pts, avg, type = as.logical(input$aggregation))
+  cciss_results   <- uData$cciss_results   <- cciss_results(cciss, bgc, pts, avg, type = as.logical(avg))
   update_flag(update_flag() + 1) ##make sure things recalculate
   # UI select choices
   tic(""Determine UI choices"", ticker)
@@ -219,7 +219,7 @@ cciss_results <- function(cciss, bgc, pts, avg, type, SS = ccissr::stocking_stan
     # use a copy to avoid modifying the original object
     results <- copy(cciss$Raw)
     sumResults <- copy(cciss$Summary)
-    
+    #browser()
     if(session_params$show_novelty){
       bgc_nov <- bgc[BGC.pred == ""novel"",]
       bgc_nov[,FuturePeriod := as.integer(FuturePeriod)]

---FILE: app/ui.R---
@@ -651,6 +651,11 @@ $(document).ready(function(){
               title = ""Rule Sets"",
               value = ""cciss_3h"",
               includeHTML(""./instructions/3h_Rulesets.html"") 
+            ),
+            tabPanel(
+              title = ""Outside Home Range"",
+              value = ""cciss_3i"",
+              includeHTML(""./instructions/3i_OHR.html"") 
             )
 
           )
@@ -678,11 +683,6 @@ $(document).ready(function(){
               value = ""cciss_4b"",
               includeHTML(""./instructions/4b_SourcesOfError.html"") 
             ),
-            tabPanel(
-              title = ""Novel Climates"",
-              value = ""cciss_4c"",
-              includeHTML(""./instructions/4c_NovelClimates.html"") 
-            ),
             tabPanel(
               title = ""Space-for-time Substitution"",
               value = ""cciss_4d"","
bcgov,CCISS_ShinyApp,93c690267e601306ac891260384b9c48b73ee258,Colin Mahony,colin.mahony@gov.bc.ca,2025-03-24T12:37:28Z,Colin Mahony,colin.mahony@gov.bc.ca,2025-03-24T12:37:28Z,remove novel climates article from known issues,instructions-raw/4c_NovelClimates.Rmd;instructions-raw/4c_NovelClimates.html,True,False,True,False,0,168,168,"---FILE: instructions-raw/4c_NovelClimates.Rmd---
@@ -1,32 +0,0 @@
----
-title: 
-output: 
-    html_document:
-        theme: null
-        highlight: null
-        mathjax: null
-editor_options: 
-  markdown: 
-    wrap: 72
----
-
-### Novel climates
-
-CCISS uses the best available biogeoclimatic analog for each projected future climate condition. In some cases, the future climate condition does not have a good analog in the pool of historical climates; this is known as a novel climate. The biogeoclimatic model will choose the closest climate analog to the novel climate, but there may be substantial differences between the novel climate conditions and the climate conditions of climate analog. The basic problem of novel climates (poor analogs) is that they give misleading results but are not explicitly identified by the model. 
-
-The spatial pattern of novel climates is quite well-defined and limited to a minority of British Columbias area (Figure 1). Figure 1 indicates that some regions of climatic novelty are sensitive to how climate is defined (i.e., which climate variables are used), for example on Haida Gwaii and southern Vancouver Island. Figure 1 (c & d) shows that using US and Alberta analogs reduces the problem of novel climates, especially in Northeast BC and the rocky mountain trench. Nevertheless, there are regions of BC with future climates that are novel to North America (Figure 1c), notably the hypermaritime fringe, the major valleys of southern BC, and the west Kootenays. CCISS results in these regions are prone to errors due to the confounding effects of novel climates. 
-
-<img src=""Figure_NovelClimates.png"" alt=""Patterns of climatic novelty for British Columbia for the 2041-2070 period (RCP4.5), following the method of Mahony et al. (2018). Rows show novelty relative to locations limited to BC vs. North America. Columns show novelty measured in terms of different climate variables."" style=""width:70%;""/>
-
-Figure 1: Patterns of climatic novelty for British Columbia for the 2041-2070 period (RCP4.5), following the method of [Mahony et al. (2018)](https://www.sciencedirect.com/science/article/abs/pii/S0378112717319175). Rows show novelty relative to locations limited to BC vs. North America. Columns show novelty measured in terms of different climate variables.  
-
-Novel climates cause the following examples of misleading results: 
-
-- Hypermaritime climates (e.g., CWHvh) tend to self-analog even under significantly different climates because there is no warmer version of these very rainy climates in North America. As a result, feasibility changes in hypermaritime regions are likely underestimated in CCISS. 
-- CWHvh analogs for future climates of the submontane CWHvm1. While superficially warmer than the vm, inland and uphill movement of hypermaritime climates is not a credible shift under climate change. 
-- CWHms/ds and MHmm2 analogs for future climates of the ICH and ESSF in the west Kootenays.  These reflect a lack of warmer-but-wet mountain climates south of the border. Feasibility declines are likely underestimated by these analogs for coastal species (Cw, Hw, Fd) and overestimated for interior species (Lw, Py). 
-- Coastal Redwood Forest (CRF) analogs for the future climates of the CDFmm. There are substantial differences in the climate of coastal northern California (e.g., persistent summer fog) that suggest this is likely a poor analog. 
-- Washington CWH analogs for the future climates of the dry CWH of the Georgia Basin are an under-representation of the degree of climate change. In general, climate changes are under-represented by the climate analogs for novel climates: the best analog for novel future climates tends to be similar to the local historical climate (Mahony et al. 2018). The lack of decline in projected Cw feasibility in the Georgia basin may be an artefact of this under-representation of climate change due to novel climates. 
-
-
- "
bcgov,CCISS_ShinyApp,4676c6535a27963f3c5ced7b4109ed6f20463df2,Obrist,Debora.Obrist@gov.bc.ca,2025-03-20T22:44:05Z,Obrist,Debora.Obrist@gov.bc.ca,2025-03-20T22:44:05Z,Fixed minor misalignment issue,instructions-raw/3e_BGCmodel.Rmd,True,False,True,False,1,1,2,"---FILE: instructions-raw/3e_BGCmodel.Rmd---
@@ -166,7 +166,7 @@ climate, (2) novel climatic characteristics (e.g., extremes) that are
 not represented by the analog, and (3) enduring features of the local
 climate such as frost pooling, lake effects, and wind patterns. The
 estimated BGC classifications from any location and time period require
-careful consideration by the end users of CCISS products. The Role of
+careful consideration by the end users of CCISS products. 
 
 ##### BGC Mapping in a Changing Climate 
 The misinterpretation of biogeoclimatic projections as literal spatial shifts "
bcgov,CCISS_ShinyApp,9f94451ea5d19c835714352cdbb7188986a2b8d8,Obrist,Debora.Obrist@gov.bc.ca,2025-03-20T22:10:35Z,Obrist,Debora.Obrist@gov.bc.ca,2025-03-20T22:10:35Z,Updated the text about BGC projections known issues.,instructions-raw/4b_SourcesOfError.Rmd,True,False,True,False,3,6,9,"---FILE: instructions-raw/4b_SourcesOfError.Rmd---
@@ -66,12 +66,9 @@ in the climate mapping.
 Biogeoclimatic modeling involves using machine learning to classify
 climate conditions as biogeoclimatic units (subzones/variants). We have
 found that BGC projections are sensitive to many aspects of model
-training, especially climate variable selection. 
-
-The current version of the BGC projections is a work in progress, and future
-refinements will be made. As more end users engage with the CCISS tool,
-additional issues may come to light. Users can report any issues or
-discrepancies *here*.
+training, especially climate variable selection. The current version of the BGC 
+projections is a work in progress, and future refinements will be made. As more
+end users engage with the CCISS tool, additional issues may come to light. 
 
 We have already identified several areas for improvement. One key issue
 is that the baseline maps are not being perfectly reconstructed,"
bcgov,CCISS_ShinyApp,73b2d13fdf8aa0b6917d5b04f5259969a9b59ce3,Obrist,Debora.Obrist@gov.bc.ca,2025-03-20T22:07:57Z,Obrist,Debora.Obrist@gov.bc.ca,2025-03-20T22:07:57Z,Updating the known issues about BGC projections.,instructions-raw/4b_SourcesOfError.Rmd,True,False,True,False,18,7,25,"---FILE: instructions-raw/4b_SourcesOfError.Rmd---
@@ -66,13 +66,24 @@ in the climate mapping.
 Biogeoclimatic modeling involves using machine learning to classify
 climate conditions as biogeoclimatic units (subzones/variants). We have
 found that BGC projections are sensitive to many aspects of model
-training, especially climate variable selection. Improving BGC modeling
-methods and representing uncertainty in BGC projections is a current
-priority for the CCISS team. An example of these planned improvements is
-integrating climate variables that capture extremes such as heat waves
-and drought. Even with these future improvements, biogeoclimatic
-modeling will retain inherent imprecision and will continue to be a
-source of error in CCISS projections.
+training, especially climate variable selection. 
+
+The current version of the BGC projections is a work in progress, and future
+refinements will be made. As more end users engage with the CCISS tool,
+additional issues may come to light. Users can report any issues or
+discrepancies *here*.
+
+We have already identified several areas for improvement. One key issue
+is that the baseline maps are not being perfectly reconstructed,
+resulting in fuzzy boundaries, and the over- and underrepresentation of
+certain BGC units. For example, the Coastal Mountain-heather Alpine
+(CMA) zone in the Pemberton region appears to be consistently
+underrepresented.
+
+Additionally, future projections appear highly sensitive to changes in
+sampling scheme, climate variable sets, and RF model
+hyperparameters. These factors will be closely examined in future
+iterations to improve the models predictive ability.
 
 #### Climate data downscaling
 "
bcgov,CCISS_ShinyApp,9957b152d49594f99c6d4aa17ec75c7206b9b500,Obrist,Debora.Obrist@gov.bc.ca,2025-03-20T22:06:00Z,Obrist,Debora.Obrist@gov.bc.ca,2025-03-20T22:06:00Z,"Removed the ""known issues"" about BGC projections to move them into the 04 known issues rmd instead.",instructions-raw/3e_BGCmodel.Rmd,True,False,True,False,0,18,18,"---FILE: instructions-raw/3e_BGCmodel.Rmd---
@@ -141,24 +141,6 @@ biogeoclimatic unit of the 1961-1990 reference period. Boxplots show the
 full range and 25th-75th percentile range of the temperature change
 projected by the 15-GCM ensemble in each RCP/time period combination.
 
-#### Known issues
-
-This version of the BGC projections is a work in progress, and future
-refinements will be made. As more end users engage with the CCISS tool,
-additional issues may come to light. Users can report any issues or
-discrepancies here.
-
-We have already identified several areas for improvement. One key issue
-is that the baseline maps are not being perfectly reconstructed,
-resulting in fuzzy boundaries, and the over- and underrepresentation of
-certain BGC units. For example, the Coastal Mountain-heather Alpine
-(CMA) zone in the Pemberton region appears to be consistently
-underrepresented.
-
-Additionally, future projections appear highly sensitive to changes in
-sampling scheme (Appendix A4), climate variable sets, and RF model
-hyperparameters. These factors will be closely examined in future
-iterations to improve the models predictive ability.
 
 #### Guidance for interpretation of biogeoclimatic projections
 "
bcgov,CCISS_ShinyApp,c39ae24bb82c944df5059fa06e6d2404813515c3,Obrist,Debora.Obrist@gov.bc.ca,2025-03-20T21:51:04Z,Obrist,Debora.Obrist@gov.bc.ca,2025-03-20T21:51:04Z,"Updated the CCISS BGC Model section with 3 subsections (more info), added a ""known issues"" section, and updated the caveats. Also added new image file.",instructions-raw/3e_BGCmodel.Rmd;instructions-raw/Figure_BGCprojections_sampling_scheme_diagnostics_v2.png,True,False,True,False,173,10,183,"---FILE: instructions-raw/3e_BGCmodel.Rmd---
@@ -12,28 +12,191 @@ editor_options:
 
 ### Biogeoclimatic modeling
 
-CCISS uses spatial climatic analogs to make inferences about future tree species feasibility. A spatial climate analog is a location with a historical climate that is similar to the current or future projected climate of a different location. Biogeoclimatic subzone/variants are a uniquely useful set of spatial climate analogs because they are familiar to resource management practitioners and are the organizing units for site-specific ecological interpretations accumulated over many decades.  
+CCISS uses spatial climatic analogs to make inferences about future tree
+species feasibility. A spatial climate analog is a location with a
+historical climate that is similar to the current or future projected
+climate of a different location. Biogeoclimatic subzone/variants are a
+uniquely useful set of spatial climate analogs because they are familiar
+to resource management practitioners and are the organizing units for
+site-specific ecological interpretations accumulated over many decades.
 
-In the CCISS framework, biogeoclimatic analogs are identified by training a statistical or machine learning model to recognize biogeoclimatic subzone-variants in terms of their historical (1961-1990) climatic conditions, and then applying that classification model to new (current or projected) climate conditions. The new climates are thus labelled using their best analog within the BEC system, a process called biogeoclimatic projections.  
+In the CCISS framework, biogeoclimatic analogs are identified by
+training a statistical or machine learning model to recognize
+biogeoclimatic subzone-variants in terms of their historical (1961-1990)
+climatic conditions, and then applying that classification model to new
+(current or projected) climate conditions. The new climates are thus
+labelled using their best analog within the BEC system, a process called
+biogeoclimatic projections.
 
 #### The CCISS BGC model
 
-CCISS uses a Random Forest machine learning model trained on a balanced set of training points for the BGC units of western North America. The climate predictors in this model are a set of seasonal bioclimate variables selected for low correlation, ecological relevance, and predictive importance. Biogeoclimatic modeling methods are a current focus of the CCISS team and the biogeoclimatic model is expected to evolve over the next year. 
+##### Training point sampling scheme
+
+To balance trade-offs between oversampling large BGC units and
+undersampling small BGC units, CCISS assigns training points to BGC
+units proportionally to the square root of the area of each BGC unit.
+This method ensures that smaller BGC units receive a relatively larger
+proportion of points compared to their total size, which prevents overly
+small units from being underrepresented in predictions. The number of
+points per BGC unit is then scaled by the interquartile range (IQR) of
+mean annual temperature (MAT), which results in BGC units with greater
+spatial climatic variation receiving more training points (Figure 1).
+
+<img src=""Figure_BGCprojections_sampling_scheme_diagnostics_v2.png"" alt=""Diagnostic plots for training point sampling scheme"" style=""width:70%;""/>
+
+Figure 1: Diagnostic plots for the chosen sampling scheme. Top panels
+show the number of possible points (i.e., pixels) by BGC
+subzone/variant, organized by smallest to largest BGC unit area on
+linear (top left) and logarithmic scale (top right), represented by the
+solid black line. The dashed line represents the number of training
+points (i.e., sample size). HVC labels on the axis are a subset of the
+300+ BGC units represented in the plot. Bottom panels show sample size
+selected by each BGC unit area (bottom left) and based on the IQR of MAT
+(bottom right).
+
+##### Climate variable set
+
+At the provincial scale, many variables effectively distinguish between
+coastal and interior climates, which is useful for broad-scale
+differentiation. However, these same variables can be less effective in
+distinguishing nearby BGC units from one another. Thus, to ensure that
+the retained variables were relevant for both local and regional
+differentiation, expert knowledge was combined with a local feature
+selection approach. Specifically, a set of ecologically relevant
+seasonal and annual climate variables was pre-selected, in addition to
+several derived variables. Any highly correlated variables were removed
+at this stage. A list was created, where each BGC unit was paired with
+all neighbouring BGC units. Separate random forest models were run, each
+with 101 trees, to determine the most important climate variables for
+each BGC unit, considering only that BGC unit and its neighbouring BGC
+units. These RF models used the Gini split rule, and variable
+importance was calculated based on Gini impurity. Once a list of
+variable importance was created for each BGC unit, the most important
+variables were retained. Care was taken to include even those that may
+have only been important for a few select BGC units to retain the
+ability to differentiate between BGC units at a local scale.
+
+In summary, the final expert variable set was chosen based on ecological
+relevance, low correlation, and high predictive importance within each
+BGC unit.
+
+##### Random forest model details
+
+To classify BGC units, a random forest (RF) machine learning model was
+trained using the ranger package in R (Wright and Ziegler 2017). This
+model was built using 500 decision trees, the extraTrees split rule, and
+a minimum node size of two, with training points selected according to
+the sampling scheme and climate variable set outlined above. This model
+underwent validation and comparison against alternative approaches,
+including multiple sensitivity analyses to assess robustness, accuracy,
+and sensitivity to training selection schemes and various model
+hyperparameters. For more information, see: LINK
 
 #### Overview of BGC projection trends
 
-Biogeoclimatic projections are illustrated in Figure 1, excerpted from Mackenzie & Mahony (2021). While there is considerable variability in the pace and character of biogeoclimatic projections driven by different climate models, there are some common zone-level trends: the expansion of the IDF analogs northward into the current SBPS zone and into higher elevations in the current MS zone; the expansion of ICH analogs northward into the current SBS zone and into higher elevations in the current ESSF zone; the expansion of CWH analogs into higher elevations in the current MH zone and eastward into the current SBS zone; and the displacement of the current SWB zone by the ESSF analogs. Inter-model differences in precipitation changes are reflected in the biogeoclimatic projections, such as in the expansion of ICH analogs into the central interior in the wetter CanESM2 model instead of IDF analogs in the drier CESM1-CAM5 model. However, the tight relationship between warming and climatic displacement (Figure 1f) suggests that inter-model differences in the rate of displacement of historical climates are primarily driven by the amount and regional pattern of warming. 
+Biogeoclimatic projections are illustrated in Figure 2, excerpted from
+Mackenzie & Mahony (2021). While there is considerable variability in
+the pace and character of biogeoclimatic projections driven by different
+climate models, there are some common zone-level trends: the expansion
+of the IDF analogs northward into the current SBPS zone and into higher
+elevations in the current MS zone; the expansion of ICH analogs
+northward into the current SBS zone and into higher elevations in the
+current ESSF zone; the expansion of CWH analogs into higher elevations
+in the current MH zone and eastward into the current SBS zone; and the
+displacement of the current SWB zone by the ESSF analogs. Inter-model
+differences in precipitation changes are reflected in the biogeoclimatic
+projections, such as in the expansion of ICH analogs into the central
+interior in the wetter CanESM2 model instead of IDF analogs in the drier
+CESM1-CAM5 model. However, the tight relationship between warming and
+climatic displacement (Figure 1f) suggests that inter-model differences
+in the rate of displacement of historical climates are primarily driven
+by the amount and regional pattern of warming.
 
-The biogeoclimatic projections for the 2011-2040 period include the incursion of exotic biogeoclimatic zone analogs into the province; e.g., the Sub-Boreal Aspen Parkland (SBAP) zone from Southeastern Alberta and the Interior Grand Fir (IGF) zone from Northwestern Oregon. In addition to these exotic biogeoclimatic zones, analogs for the projected future climates of BC also include exotic subzone/variants of familiar zones. The largest area of projected exotic subzone/variant analogs is in the boreal northeast of the province, where Albertan subzone/variants of the BWBS zone dominate. In later periods (2050s and 2080s), exotic analogs are also projected in the major valley systems of southern BC and on the south coast. 
+The biogeoclimatic projections for the 2011-2040 period include the
+incursion of exotic biogeoclimatic zone analogs into the province; e.g.,
+the Sub-Boreal Aspen Parkland (SBAP) zone from Southeastern Alberta and
+the Interior Grand Fir (IGF) zone from Northwestern Oregon. In addition
+to these exotic biogeoclimatic zones, analogs for the projected future
+climates of BC also include exotic subzone/variants of familiar zones.
+The largest area of projected exotic subzone/variant analogs is in the
+boreal northeast of the province, where Albertan subzone/variants of the
+BWBS zone dominate. In later periods (2050s and 2080s), exotic analogs
+are also projected in the major valley systems of southern BC and on the
+south coast.
 
-<img src=""Figure_BGCprojections.Full.2055.png"" alt=""An example of biogeoclimatic projections for British Columbia, excerpted from Mackenzie & Mahony (2021)"" style=""width:70%;""/>
+<img src=""Figure_BGCprojections.Full.2055.png"" alt=""An example of biogeoclimatic projections for British Columbia, excerpted from Mackenzie &amp; Mahony (2021)"" style=""width:70%;""/>
 
-Figure 1: An example of biogeoclimatic projections for British Columbia, excerpted from Mackenzie & Mahony (2021). (a) Mapped biogeoclimatic zones, which encompass the 211 biogeoclimatic subzone/variants used to model tree species feasibility. (b) Biogeoclimatic projection of the recent period (1991-2018). (c-e) Biogeoclimatic projections of the 2041-2070 period (RCP4.5) for two GCMs with medium (CESM1-CAM5), low (MRI-CGCM3) and high (CanESM2) regional climate sensitivity. (f) Biogeoclimatic displacement relative to the change in the BC-mean temperature change for each of 90 model projections. Biogeoclimatic displacement is the proportion of grid cells across BC that have a different projected biogeoclimatic unit than their model-predicted biogeoclimatic unit of the 1961-1990 reference period. Boxplots show the full range and 25th-75th percentile range of the temperature change projected by the 15-GCM ensemble in each RCP/time period combination. 
+Figure 2: An example of biogeoclimatic projections for British Columbia,
+excerpted from Mackenzie & Mahony (2021). (a) Mapped biogeoclimatic
+zones, which encompass the 211 biogeoclimatic subzone/variants used to
+model tree species feasibility. (b) Biogeoclimatic projection of the
+recent period (1991-2018). (c-e) Biogeoclimatic projections of the
+2041-2070 period (RCP4.5) for two GCMs with medium (CESM1-CAM5), low
+(MRI-CGCM3) and high (CanESM2) regional climate sensitivity. (f)
+Biogeoclimatic displacement relative to the change in the BC-mean
+temperature change for each of 90 model projections. Biogeoclimatic
+displacement is the proportion of grid cells across BC that have a
+different projected biogeoclimatic unit than their model-predicted
+biogeoclimatic unit of the 1961-1990 reference period. Boxplots show the
+full range and 25th-75th percentile range of the temperature change
+projected by the 15-GCM ensemble in each RCP/time period combination.
 
-#### Guidance for interpretation of biogeoclimatic projections
+#### Known issues
+
+This version of the BGC projections is a work in progress, and future
+refinements will be made. As more end users engage with the CCISS tool,
+additional issues may come to light. Users can report any issues or
+discrepancies here.
 
-Although the visual effect of biogeoclimatic projections is of BGC zones and subzone/variants shifting across the map, these spatial shifts should not be taken literally. No analog is perfect, and analogs may be highly imperfect for a number of reasons. The actual future climate at any location will be a hybrid of (1) the characteristics of the analog climate, (2) novel climatic characteristics (e.g., extremes) that are not represented by the analog, and (3) enduring features of the local climate such as frost pooling, lake effects, and wind patterns. The likely proportions of these categories in any location and time period deserve careful consideration by the end users of CCISS products. 
+We have already identified several areas for improvement. One key issue
+is that the baseline maps are not being perfectly reconstructed,
+resulting in fuzzy boundaries, and the over- and underrepresentation of
+certain BGC units. For example, the Coastal Mountain-heather Alpine
+(CMA) zone in the Pemberton region appears to be consistently
+underrepresented.
+
+Additionally, future projections appear highly sensitive to changes in
+sampling scheme (Appendix A4), climate variable sets, and RF model
+hyperparameters. These factors will be closely examined in future
+iterations to improve the models predictive ability.
+
+#### Guidance for interpretation of biogeoclimatic projections
 
-The misinterpretation of biogeoclimatic projections as literal spatial shifts in BGC units has led to a common perception that climate change is rendering biogeoclimatic mapping obsolete. This is not the case. The linework of biogeoclimatic subzone/variants in many cases will remain useful as units of relative climatic variation across landscapes. The terminology we use for biogeoclimatic projections can help to emphasize that biogeoclimatic analogs are only approximations and that the biogeoclimatic units themselves are not undergoing spatial shifts. Rather than saying this location is becoming IDFxh1, it is more correct to say the future climate at this location is predicted to be similar to the historical climate of the IDFxh1. Rather than the IDF is moving north into the SBS, it is better to say the SBS is transitioning into more IDF-like climates.   
+##### Evaluating BGC Future Projections
+An important consideration when evaluating the quality of any BGC future
+projection is that, ideally, it should be compared to the baseline of
+the same model, rather than to the original BEC linework. In some cases,
+the BEC linework and climate data informing the model might not align. A
+mismatch between the model and linework does not necessarily indicate an
+error. Discrepancies between BGC mapping and baseline BGC projections
+can, in some cases, indicate errors in the BGC mapping, and in others,
+errors in the baseline climate mapping, and should therefore be
+interpreted carefully on case-by-case basis rather than assumed to be
+inaccuracies.
 
+##### Interpreting Spatial Shifts in BGC Projections 
+Although the visual effect of biogeoclimatic projections is of BGC zones and
+subzone/variants shifting across the map, these spatial shifts should
+not be taken literally. No analog is perfect, and projected analogs may
+be highly imperfect for several reasons. The actual future climate at
+any location will be a hybrid of (1) the characteristics of the analog
+climate, (2) novel climatic characteristics (e.g., extremes) that are
+not represented by the analog, and (3) enduring features of the local
+climate such as frost pooling, lake effects, and wind patterns. The
+estimated BGC classifications from any location and time period require
+careful consideration by the end users of CCISS products. The Role of
 
+##### BGC Mapping in a Changing Climate 
+The misinterpretation of biogeoclimatic projections as literal spatial shifts 
+in BGC units has led to a common perception that climate change is rendering
+biogeoclimatic mapping obsolete. This is not the case. The linework of
+biogeoclimatic subzone/variants in many cases will remain useful as
+units of relative climatic variation across landscapes. The terminology
+we use for biogeoclimatic projections can help to emphasize that
+biogeoclimatic analogs are only approximations and that the
+biogeoclimatic units themselves are not undergoing spatial shifts.
+Rather than saying this location is becoming IDFxh1, it is more
+correct to say the future climate at this location is predicted to be
+similar to the historical climate of the IDFxh1. Rather than the IDF
+is moving north into the SBS, it is better to say the SBS is
+transitioning into more IDF-like climates."
bcgov,CCISS_ShinyApp,38ff5c83b26fdf1e7ce788312f416edbfa1523ec,Kiri,kiridaust@gmail.com,2025-03-11T23:19:18Z,Kiri,kiridaust@gmail.com,2025-03-11T23:19:18Z,udpates and bug fixes,Deploy_CCISS.R;app/server.R;app/server/LeafletSource.R;app/server/feasibility.R;app/server/generate.R;app/server/points.R;app/server/silviculture.R;app/ui.R,False,True,True,False,395,184,579,"---FILE: Deploy_CCISS.R---
@@ -4,16 +4,18 @@ library(ccissr)
 
 server <- analogsea::droplets()$`shiny-server`
 reset_ssh_sessions()
+droplet_ssh(server, ""rm -R /srv/shiny-server/cciss/instructions"")
 #analogsea::droplet_ssh(server,""rm -R /srv/shiny-server/ccissr/.Renviron"")
-analogsea::droplet_ssh(server, ""rm -R /srv/shiny-server/cciss13"")
-analogsea::droplet_ssh(server, ""mkdir /srv/shiny-server/cciss13"")
-analogsea::droplet_upload(server, ""./.Renviron"", ""/srv/shiny-server/cciss13"")
+analogsea::droplet_ssh(server, ""rm -R /srv/shiny-server/cciss"")
+analogsea::droplet_ssh(server, ""mkdir /srv/shiny-server/cciss"")
+analogsea::droplet_upload(server, ""./.Renviron"", ""/srv/shiny-server/cciss"")
 #analogsea::droplet_ssh(server, ""R -e \""remotes::install_github('bcgov/ccissr@development', upgrade = FALSE)\"""")
-analogsea::droplet_upload(server, ""./app/global.R"", ""/srv/shiny-server/cciss13/global.R"")
-analogsea::droplet_upload(server, ""./app/server.R"", ""/srv/shiny-server/cciss13/server.R"")
-analogsea::droplet_upload(server, ""./app/ui.R"", ""/srv/shiny-server/cciss13/ui.R"")
-analogsea::droplet_upload(server, ""./app/www"", ""/srv/shiny-server/cciss13"")
-analogsea::droplet_upload(server, ""./app/server"", ""/srv/shiny-server/cciss13"")
-analogsea::droplet_upload(server, ""./app/instructions"", ""/srv/shiny-server/cciss13"")
+analogsea::droplet_upload(server, ""./app/global.R"", ""/srv/shiny-server/cciss/global.R"")
+analogsea::droplet_upload(server, ""./app/server.R"", ""/srv/shiny-server/cciss/server.R"")
+analogsea::droplet_upload(server, ""./app/ui.R"", ""/srv/shiny-server/cciss/ui.R"")
+analogsea::droplet_upload(server, ""./app/www"", ""/srv/shiny-server/cciss"")
+analogsea::droplet_upload(server, ""./app/server"", ""/srv/shiny-server/cciss"")
+analogsea::droplet_upload(server, ""./app/instructions"", ""/srv/shiny-server/cciss"")
+analogsea::droplet_upload(server, ""./app/WNA_SZ_Cols_v13_6.csv"", ""/srv/shiny-server/cciss"")
 analogsea::droplet_ssh(server, ""chown -R shiny:shiny /srv/shiny-server"")
 analogsea::droplet_ssh(server, ""systemctl restart shiny-server"")

---FILE: app/server.R---
@@ -35,7 +35,9 @@ onStop(function() {
 DEV = TRUE
 
 #####load feas table from database
-S1 <- setDT(dbGetQuery(sppDb,""select bgc,ss_nospace,spp,newfeas from feasorig""))
+#S1 <- setDT(dbGetQuery(sppDb,""select bgc,ss_nospace,spp,newfeas from feasorig""))
+S1 <- ccissr::S1
+S1 <- S1[,.(bgc,ss_nospace, spp, newfeas)]
 setnames(S1,c(""BGC"",""SS_NoSpace"",""Spp"",""Feasible""))
 #####
 bcgov_tileserver <- Sys.getenv(""BCGOV_TILESERVER"")

---FILE: app/server/LeafletSource.R---
@@ -1,11 +1,13 @@
 ##javascript source
-bcgov_tileserver <- ""https://tileserver.thebeczone.ca/data/BGC_v13/{z}/{x}/{y}.pbf""
-bcgov_tilelayer <- ""BGC_v13""
+bcgov_tileserver <- ""https://tileserver.thebeczone.ca/data/BGC_v13_Mar10/{z}/{x}/{y}.pbf""
+bcgov_tilelayer <- ""BEC13_Mar9""
 district_tileserver <- ""https://tileserver.thebeczone.ca/data/Districts/{z}/{x}/{y}.pbf""
 district_tilelayer <- ""Districts""
 wna_tileserver <- ""https://tileserver.thebeczone.ca/data/WNA_MAP/{z}/{x}/{y}.pbf""
 wna_tilelayer <- ""WNA_MAP""
 
+subzones_colours_ref <- fread(""WNA_SZ_Cols_v13_6.csv"")
+
 plugins <- {
   list(vgplugin =
          htmltools::htmlDependency(

---FILE: app/server/feasibility.R---
@@ -1,5 +1,5 @@
 # Update site series selector when site ref is modified
-observeEvent(input$siteref_feas, priority = 50, {
+observeEvent(input$siteref_feas, priority = 500, {
   if (is.null(uData$cciss_results)) return(NULL)
   siteref <- input$siteref_feas
   updateSelectInput(inputId = ""site_series_feas"", choices = uData$siteseries_list[[siteref]])
@@ -9,26 +9,21 @@ output$results_feas_all <- renderUI({
   if(input$feas_type){
     tableOutput(""results_feas"")
   }else{
-    tagList(uiOutput(""silviculture_block""),
-    h6(""Legend""),
-    HTML(
-      paste0(
-        '<svg viewBox=""0 0 1 1"" height=""14px"" width=""14px""><rect height=1 width=1 style=""fill : ',
-        c(""green"", ""red"", ""purple""),
-        '"" /><span style=""vertical-align:middle"">&nbsp;',
-        c(""Improving"", ""Decreasing"", ""Adding""),
-        '</span>',
-        collapse = ""<br />""
-      )
-    )
-    )
+    #browser()
+    siteref <- selected_site$siteref
+    siteserie <- selected_site$ss
+    cciss_results <- uData$cciss_results
+    if (is.null(cciss_results)) return(NULL)
+    temp <- standardblocks(cciss_results, siteref, siteserie)
+    temp
   }
 })
 
 # CCISS Results
 output$results_feas <- function() {
-  siteref <- selected_site$siteref
-  siteserie <- selected_site$ss
+  #browser()
+  siteref <- input$siteref_feas
+  siteserie <- input$site_series_feas
   update_flag()
   cciss_results <- copy(uData$cciss_results)
   #browser()
@@ -66,7 +61,7 @@ grd1y <- seq(1.5,7.5,1)
 # Dual utility function to format dt, app mode and report mode use different
 # format. Report has no javascript, just a plain table.
 cciss_results_dt <- function(data, siteref, siteserie, filter, format = ""html"") {
-  
+  #browser()
   if(filter == ""a""){
     for(i in c(""NewSuit_1991"",""NewSuit_2001"",""NewSuit_2021"",""NewSuit_2041"",""NewSuit_2061"",""NewSuit_2081"")){ ##set NA to X
       data[is.na(get(i)), (i) := 4]

---FILE: app/server/generate.R---
@@ -12,7 +12,7 @@ observeEvent(input$generate_results, priority = 100, {
   
   # Input from the app
   if(input$acc == ""acc2""){
-    pointNums <- dbGetBGC(pool,bgc = uData$bgc_select,district = NULL, maxPoints = 150) #uData$dist_select
+    pointNums <- dbGetBGC(pool,bgc = uData$bgc_select,district = uData$dist_select, maxPoints = 150) #uData$dist_select
     userpoints$bgc_pts <- pointNums
     avg <- uData$avg <- TRUE
     pts <- uData$pts <- data.table(Site = pointNums)
@@ -30,7 +30,7 @@ observeEvent(input$generate_results, priority = 100, {
   tic(""Process CCISS data"", ticker)
   cciss           <- uData$cciss           <- cciss(bgc,session_params$estabWt,session_params$futWt)
   tic(""Format CCISS Results"", ticker)
-  cciss_results   <- uData$cciss_results   <- cciss_results(cciss, pts, avg, type = input$preselected)
+  cciss_results   <- uData$cciss_results   <- cciss_results(cciss, pts, avg, type = as.logical(input$aggregation))
   update_flag(update_flag() + 1) ##make sure things recalculate
   # UI select choices
   tic(""Determine UI choices"", ticker)
@@ -83,6 +83,7 @@ observeEvent(input$generate_results, priority = 100, {
   }
   
   # Dynamic UI select choices that depends on previous select choice
+  #browser() ##issue for HG is that siteseries aren't correct. Need to investigate
   siteref <- head(siterefs, 1)
   siteseries <- siteseries_list[[siteref]]
 
@@ -118,6 +119,7 @@ observeEvent(input$generate_results, priority = 100, {
   output$timings <- plotly::renderPlotly({
     tocker
   })
+  #browser()
   print(""done generate"")
 })
 
@@ -161,8 +163,10 @@ observeEvent(input$rcp_scenario, {generateState()})
 bgc <- function(con, siteno, avg, modWeights) {
   siteno <- siteno[!is.na(siteno)]
   withProgress(message = ""Processing..."", detail = ""Futures"", {
-    dbGetCCISS_v13(con, siteno, avg, modWeights = modWeights)
+    dat <- dbGetCCISS_v13(con, siteno, avg, modWeights = modWeights)
+    dat[FuturePeriod == '1991', BGC.prop := BGC.prop/sum(BGC.prop), by = .(SiteRef)]
   })
+  dat
 }
 
 # bgc <- dbGetCCISS(pool,siteno = 676813, avg = F, modWeights = all_weight)
@@ -196,6 +200,7 @@ swap_up_down <- '<svg xmlns=""http://www.w3.org/2000/svg"" width=""30px"" height=""30
 trending_up <- '<svg xmlns=""http://www.w3.org/2000/svg"" width=""30px"" height=""30px"" viewBox=""0 0 512 512""><title>ionicons-v5-c</title><polyline points=""352 144 464 144 464 256"" style=""fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px""/><path d=""M48,368,169.37,246.63a32,32,0,0,1,45.26,0l50.74,50.74a32,32,0,0,0,45.26,0L448,160"" style=""fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px""/></svg>'
 trending_down <- '<svg xmlns=""http://www.w3.org/2000/svg"" width=""30px"" height=""30px"" viewBox=""0 0 512 512""><title>ionicons-v5-c</title><polyline points=""352 368 464 368 464 256"" style=""fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px""/><path d=""M48,144,169.37,265.37a32,32,0,0,0,45.26,0l50.74-50.74a32,32,0,0,1,45.26,0L448,352"" style=""fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px""/></svg>'
 stable <- '<svg xmlns=""http://www.w3.org/2000/svg"" width=""30px"" height=""30px"" viewBox=""0 0 512 512""><line x1=""118"" y1=""304"" x2=""394"" y2=""304"" style=""fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:44px""/><line x1=""118"" y1=""208"" x2=""394"" y2=""208"" style=""fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:44px""/></svg>'
+
 ##function for creating full results table
 cciss_results <- function(cciss, pts, avg, type, SS = ccissr::stocking_standards, period_map = uData$period_map) {
   withProgress(message = ""Processing..."", detail = ""Feasibility results"", {
@@ -226,7 +231,7 @@ cciss_results <- function(cciss, pts, avg, type, SS = ccissr::stocking_standards
       ""1_2081"",""2_2081"",""3_2081"",""X_2081""
     ))
     # Append region
-    if(type == ""N""){
+    if(!type){
       region_map <- pts[[{if (avg) {""BGC""} else {""Site""}}]]
       results$Region <- pts$ForestRegion[match(results$SiteRef, region_map)]
       results$ZoneSubzone <- pts$BGC[match(results$SiteRef, region_map)]

---FILE: app/server/points.R---
@@ -54,6 +54,7 @@ new_points <- function(points) {
     if (nrow(points) == 0L) {
       points <- uData$basepoints
     } else {
+      #browser()
       points[,`:=`(Long = round(Long, 5), Lat = round(Lat, 5))]
       res <- as.data.table(dbPointInfo(pool, points))
       if(nrow(points) > 1){

---FILE: app/server/silviculture.R---
@@ -4,13 +4,13 @@ observeEvent(input$siteref_silv, priority = 50, {
   updateSelectInput(inputId = ""site_series_silv"", choices = uData$siteseries_list[[siteref]])
 })
 
-output$silviculture_block <- renderUI({
-  siteref <- selected_site$siteref
-  siteserie <- selected_site$ss
-  cciss_results <- uData$cciss_results
-  if (is.null(cciss_results)) return(NULL)
-  standardblocks(cciss_results, siteref, siteserie)
-})
+# output$silviculture_block <- renderUI({
+#   siteref <- selected_site$siteref
+#   siteserie <- selected_site$ss
+#   cciss_results <- uData$cciss_results
+#   if (is.null(cciss_results)) return(NULL)
+#   standardblocks(cciss_results, siteref, siteserie)
+# })
 
 output$silvics_tol_dt <- function() {
   cciss_results <- uData$cciss_results
@@ -103,150 +103,229 @@ standardblocks <- function(data, siteref, siteserie) {
     list(Region, ZoneSubzone, SS_NoSpace, ccissFeas,EstabFeas, Improve,PrefAcc, Spp)
     ]
   ss <- stocking_standards[
-    Region %in% sc$Region & ZoneSubzone %in% sc$ZoneSubzone & SS_NoSpace %in% sc$SS_NoSpace
-    ]
-  do.call(span, lapply(unique(ss$Standard), standardblock, ss = ss, sc = sc))
+    SS_NoSpace %in% sc$SS_NoSpace
+    ] #Region %in% sc$Region & ZoneSubzone %in% sc$ZoneSubzone & 
+  if(nrow(ss) > 1){
+    res <- do.call(span, lapply(unique(ss$Standard), standardblock, ss = ss, sc = sc))
+  } else {
+    res <- standardblock(std = NULL, ss = NULL, sc = sc)
+  }
+  res
 }
 
 uData$standardblocks <- standardblocks
 
 standardblock <- function(std, ss, sc) {
-  ss <- ss[Standard %in% std]
-  ss[, TextStyle := """"]
   sc[,TxtCciss := """"]
-
-  # Some logic to flag specie with different Suitability than CCISS
-  ss[sc, on = ""Species==Spp"", ProjFeas := suppressWarnings(as.integer(i.ccissFeas))]
-  setnafill(ss, fill = 4L, cols = ""ProjFeas"")
-  ss[Suitability > ProjFeas, TextStyle := ""color:green""]
-  ss[Suitability < ProjFeas, TextStyle := ""color:red""]
-  ss[!ProjFeas %in% c(1,2,3), TextStyle := ""color:red;text-decoration:line-through""]
-  ss[Suitability == 0, TextStyle := NA]
-  #browser()
-  # cciss colouring
-  sc[ss, on = ""Spp == Species"", CFRGSuit := i.Suitability]
-  sc[ccissFeas < CFRGSuit, TxtCciss := ""color:green""]
-  sc[ccissFeas > CFRGSuit, TxtCciss := ""color:red""]
-  sc[!CFRGSuit %in% c(1,2,3), TxtCciss := ""color:purple""]
-  sc[CFRGSuit == 0, TxtCciss := NA]
-
-  si <- stocking_info[Standard == std]
-  sh <- stocking_height[Standard == std]
-  list(
-
-    #tags$h6(""CFRG: "", tags$b(si$Region, .noWS = c(""before"", ""after"")), ""Standards_ID: "", paste(ss[!is.na(Standard), unique(Standard)], collapse = "", ""), .noWS = ""inside""),
-    tags$h5(""CFRG Standards_ID: "", paste(ss[!is.na(Standard), unique(Standard)], collapse = "", ""), tags$p(si$Region, .noWS = c(""before"", ""after"")), .noWS = ""inside""),
+  if(!is.null(ss)){
+    ss <- ss[Standard %in% std]
+    ss[, TextStyle := """"]
+    
+    ss[sc, on = ""Species==Spp"", ProjFeas := suppressWarnings(as.integer(i.ccissFeas))]
+    setnafill(ss, fill = 4L, cols = ""ProjFeas"")
+    ss[Suitability > ProjFeas, TextStyle := ""color:green""]
+    ss[Suitability < ProjFeas, TextStyle := ""color:red""]
+    ss[!ProjFeas %in% c(1,2,3), TextStyle := ""color:red;text-decoration:line-through""]
+    ss[Suitability == 0, TextStyle := NA]
+    
+    #browser()
+    # cciss colouring
+    sc[ss, on = ""Spp == Species"", CFRGSuit := i.Suitability]
+    sc[ccissFeas < CFRGSuit, TxtCciss := ""color:green""]
+    sc[ccissFeas > CFRGSuit, TxtCciss := ""color:red""]
+    sc[!CFRGSuit %in% c(1,2,3), TxtCciss := ""color:purple""]
+    sc[CFRGSuit == 0, TxtCciss := NA]
+    
+    si <- stocking_info[Standard == std]
+    sh <- stocking_height[Standard == std]
+    list(
+      
+      #tags$h6(""CFRG: "", tags$b(si$Region, .noWS = c(""before"", ""after"")), ""Standards_ID: "", paste(ss[!is.na(Standard), unique(Standard)], collapse = "", ""), .noWS = ""inside""),
+      tags$h5(""CFRG Standards_ID: "", paste(ss[!is.na(Standard), unique(Standard)], collapse = "", ""), tags$p(si$Region, .noWS = c(""before"", ""after"")), .noWS = ""inside""),
       tags$table(style = ""max-width: 100%; white-space: nowrap;"",
-               # Report formatting gray out the first row, so faking a row
-               tags$tr(
-                 tags$td(width = ""50%"", style = ""vertical-align: top; padding:0; background-color:white; border:1px solid black"",
-
-                         tags$table(
-                           width = ""500px"",
-                           
-                           tags$th(
-                             tags$td(tags$b(""CFRG""), style = ""border-left: 1px solid; width: 150px;""),
-                             tags$td(tags$b(""CCISS""), style = ""border-left: 1px solid; width: 150px;"")
-                           ),
-                           
+                 # Report formatting gray out the first row, so faking a row
+                 tags$tr(
+                   tags$td(width = ""50%"", style = ""vertical-align: top; padding:0; background-color:white; border:1px solid black"",
                            
-                           tags$tr(
-                             tags$td(""Primary/E1"", style = ""border-right: 1px solid;""),
-                             ss[!is.na(Species) & Suitability %in% 1L, sppnotes(Species, Footnotes, TextStyle)],
-                             sc[!is.na(Spp) & ccissFeas %in% ""1"", sppnotes_cciss(Spp,TxtCciss)]
-                           ),
-                           
-                           #tags$hr(style = ""padding: 0px; margin: 0 0 3px 0; height: 2px; background-color: darkgreen; border: 0px""),
-
-                           tags$tr(
-                             tags$td(""Secondary/E2"", style = ""border-right: 1px solid;""),
-                             ss[!is.na(Species) & Suitability %in% 2L, sppnotes(Species, Footnotes, TextStyle)],
-                             sc[!is.na(Spp) & ccissFeas %in% ""2"", sppnotes_cciss(Spp,TxtCciss)]
-                           ),
-
-                           tags$tr(
-                             tags$td(""Tertiary/E3"", style = ""border-right: 1px solid;""),
-                             ss[!is.na(Species) & Suitability %in% 3L, sppnotes(Species, Footnotes, TextStyle)],
-                             sc[!is.na(Spp) & ccissFeas %in% ""3"", sppnotes_cciss(Spp,TxtCciss)]
-                           ),
-
-                           tags$tr(
-                             tags$td(""Trial"",style = ""border-right: 1px solid;"" ),
-                             tags$td(""""),
-                             sc[!is.na(Spp) & EstabFeas == ""Trial"", sppnotes_cciss(Spp,TxtCciss)]
-                           ),
-                           tags$tr(
-                             tags$td(""Broadleaf"", style = ""border-right: 1px solid;""),
-                             ss[!is.na(Species) & Suitability %in% 0L, sppnotes(Species, Footnotes, TextStyle)],
-                             tags$td("""", style = ""border-left: 1px solid;""),
-                             style = ""border-bottom:1px solid black;""
-                           ),
-
-                           tags$tr(
-                             tags$td(""Preferred (p)"",style = ""border-right: 1px solid;""),
-                             ss[!is.na(Species) & PreferredAcceptable %in% ""P"", sppnotes(Species, Footnotes, TextStyle)],
-                             sc[!is.na(Spp) & PrefAcc %in% ""P"", sppnotes_cciss(Spp,TxtCciss)],
-                           ),
-                           tags$tr(
-                             tags$td(""Acceptable (a)"",style = ""border-right: 1px solid;""),
-                             ss[!is.na(Species) & PreferredAcceptable %in% ""A"", sppnotes(Species, Footnotes, TextStyle)],
-                             sc[!is.na(Spp) & PrefAcc %in% ""A"", sppnotes_cciss(Spp,TxtCciss)],
-                             style = ""border-bottom:1px solid black;""
-                           ),
-                           tags$tr(
-                             tags$td(colspan = ""2"", style = ""white-space:normal; vertical-align: top; padding:0; background-color:white; border:none"",
-                                     tags$small(tags$b(""Footnotes"")),
-                                     tags$hr(style = ""padding: 0; margin: 0 0 3px 0; height: 2px; background-color: #003366; border: 0px""),
-                                     {
-                                       fn <- ss[PreferredAcceptable %in% c(""A"", ""P"") | Suitability %in% 1:3, sort(as.integer(unique(unlist(Footnotes))))]
-                                       fnt <- footnotes[match(fn, `Revised Footnote`), `Revised Footnote Text`]
-                                       fnshiny <- mapply(function(footnote, text) {list(tags$sup(footnote), tags$small(text), tags$br())}, fn, fnt, SIMPLIFY = FALSE, USE.NAMES = FALSE)
-                                       do.call(span, fnshiny)
-                                     }
+                           tags$table(
+                             width = ""500px"",
+                             
+                             tags$th(
+                               tags$td(tags$b(""CFRG""), style = ""border-left: 1px solid; width: 150px;""),
+                               tags$td(tags$b(""CCISS""), style = ""border-left: 1px solid; width: 150px;"")
+                             ),
+                             
+                             
+                             tags$tr(
+                               tags$td(""Primary/E1"", style = ""border-right: 1px solid;""),
+                               ss[!is.na(Species) & Suitability %in% 1L, sppnotes(Species, Footnotes, TextStyle)],
+                               sc[!is.na(Spp) & ccissFeas %in% ""1"", sppnotes_cciss(Spp,TxtCciss)]
+                             ),
+                             
+                             #tags$hr(style = ""padding: 0px; margin: 0 0 3px 0; height: 2px; background-color: darkgreen; border: 0px""),
+                             
+                             tags$tr(
+                               tags$td(""Secondary/E2"", style = ""border-right: 1px solid;""),
+                               ss[!is.na(Species) & Suitability %in% 2L, sppnotes(Species, Footnotes, TextStyle)],
+                               sc[!is.na(Spp) & ccissFeas %in% ""2"", sppnotes_cciss(Spp,TxtCciss)]
+                             ),
+                             
+                             tags$tr(
+                               tags$td(""Tertiary/E3"", style = ""border-right: 1px solid;""),
+                               ss[!is.na(Species) & Suitability %in% 3L, sppnotes(Species, Footnotes, TextStyle)],
+                               sc[!is.na(Spp) & ccissFeas %in% ""3"", sppnotes_cciss(Spp,TxtCciss)]
+                             ),
+                             
+                             tags$tr(
+                               tags$td(""Trial"",style = ""border-right: 1px solid;"" ),
+                               tags$td(""""),
+                               sc[!is.na(Spp) & EstabFeas == ""Trial"", sppnotes_cciss(Spp,TxtCciss)]
+                             ),
+                             tags$tr(
+                               tags$td(""Broadleaf"", style = ""border-right: 1px solid;""),
+                               ss[!is.na(Species) & Suitability %in% 0L, sppnotes(Species, Footnotes, TextStyle)],
+                               tags$td("""", style = ""border-left: 1px solid;""),
+                               style = ""border-bottom:1px solid black;""
+                             ),
+                             
+                             tags$tr(
+                               tags$td(""Preferred (p)"",style = ""border-right: 1px solid;""),
+                               ss[!is.na(Species) & PreferredAcceptable %in% ""P"", sppnotes(Species, Footnotes, TextStyle)],
+                               sc[!is.na(Spp) & PrefAcc %in% ""P"", sppnotes_cciss(Spp,TxtCciss)],
+                             ),
+                             tags$tr(
+                               tags$td(""Acceptable (a)"",style = ""border-right: 1px solid;""),
+                               ss[!is.na(Species) & PreferredAcceptable %in% ""A"", sppnotes(Species, Footnotes, TextStyle)],
+                               sc[!is.na(Spp) & PrefAcc %in% ""A"", sppnotes_cciss(Spp,TxtCciss)],
+                               style = ""border-bottom:1px solid black;""
+                             ),
+                             tags$tr(
+                               tags$td(colspan = ""2"", style = ""white-space:normal; vertical-align: top; padding:0; background-color:white; border:none"",
+                                       tags$small(tags$b(""Footnotes"")),
+                                       tags$hr(style = ""padding: 0; margin: 0 0 3px 0; height: 2px; background-color: #003366; border: 0px""),
+                                       {
+                                         fn <- ss[PreferredAcceptable %in% c(""A"", ""P"") | Suitability %in% 1:3, sort(as.integer(unique(unlist(Footnotes))))]
+                                         fnt <- footnotes[match(fn, `Revised Footnote`), `Revised Footnote Text`]
+                                         fnshiny <- mapply(function(footnote, text) {list(tags$sup(footnote), tags$small(text), tags$br())}, fn, fnt, SIMPLIFY = FALSE, USE.NAMES = FALSE)
+                                         do.call(span, fnshiny)
+                                       }
+                               )
                              )
                            )
-                         )
-                         ),
-                 tags$td(width = ""50%"", style = ""vertical-align: top; padding:0px 0px 0px 8px; background-color:white; border:1px solid black"",
-                         tags$small(tags$b(""Stocking (i) - well spaced/ha"")),
-                         tags$hr(style = ""padding: 0; margin: 0 0 3px 0; height: 2px; background-color: darkgreen; border: 0px""),
-                         tags$table(
-                           #width = ""20%"",
-                           tags$tr(
-                             tags$td(tags$b(""Target"")),
-                             tags$td(tags$b(""Min pa"")),
-                             tags$td(tags$b(""Min p"")),
-                             tags$td(tags$b(""Regen Delay (max yrs)""))
-                           ),
-                           tags$tr(
-                             tags$td(si$StockingTarget),
-                             tags$td(si$StockingMINpa),
-                             tags$td(si$StockingMINp),
-                             tags$td(si$StockingDelay)
-                           )
-                         ),
-                         tags$br(),
-                         tags$small(tags$b(""Free Growing Guide"")),
-                         tags$hr(style = ""padding: 0; margin: 0 0 3px 0; height: 2px; background-color: #003366; border: 0px""),
-                         tags$table(
-                           #width = ""100%"",
-                           tags$tr(
-                             tags$td(tags$b(""Earliest (yrs)"")),
-                             tags$td(tags$b(""Latest(yrs)"")),
-                             tags$td(tags$b(""Min Height (m)"")),
-                             tags$td(tags$b(""Min Height (m)""))
+                   ),
+                   tags$td(width = ""50%"", style = ""vertical-align: top; padding:0px 0px 0px 8px; background-color:white; border:1px solid black"",
+                           tags$small(tags$b(""Stocking (i) - well spaced/ha"")),
+                           tags$hr(style = ""padding: 0; margin: 0 0 3px 0; height: 2px; background-color: darkgreen; border: 0px""),
+                           tags$table(
+                             #width = ""20%"",
+                             tags$tr(
+                               tags$td(tags$b(""Target"")),
+                               tags$td(tags$b(""Min pa"")),
+                               tags$td(tags$b(""Min p"")),
+                               tags$td(tags$b(""Regen Delay (max yrs)""))
+                             ),
+                             tags$tr(
+                               tags$td(si$StockingTarget),
+                               tags$td(si$StockingMINpa),
+                               tags$td(si$StockingMINp),
+                               tags$td(si$StockingDelay)
+                             )
                            ),
-                           tags$tr(
-                             tags$td(si$AssessmentEarliest),
-                             tags$td(si$AssessmentLatest),
-                             tags$td(style = ""white-space: normal;"", sh[!Flag %in% TRUE, paste(Species, Height, sep = "": "", collapse = "", "")]),
-                             tags$td(style = ""white-space: normal;"", sh[Flag %in% TRUE, paste(Species, Height, sep = "": "", collapse = "", "")])
+                           tags$br(),
+                           tags$small(tags$b(""Free Growing Guide"")),
+                           tags$hr(style = ""padding: 0; margin: 0 0 3px 0; height: 2px; background-color: #003366; border: 0px""),
+                           tags$table(
+                             #width = ""100%"",
+                             tags$tr(
+                               tags$td(tags$b(""Earliest (yrs)"")),
+                               tags$td(tags$b(""Latest(yrs)"")),
+                               tags$td(tags$b(""Min Height (m)"")),
+                               tags$td(tags$b(""Min Height (m)""))
+                             ),
+                             tags$tr(
+                               tags$td(si$AssessmentEarliest),
+                               tags$td(si$AssessmentLatest),
+                               tags$td(style = ""white-space: normal;"", sh[!Flag %in% TRUE, paste(Species, Height, sep = "": "", collapse = "", "")]),
+                               tags$td(style = ""white-space: normal;"", sh[Flag %in% TRUE, paste(Species, Height, sep = "": "", collapse = "", "")])
+                             )
                            )
-                         )
+                   )
                  )
+      ),
+      h6(""Legend""),
+      HTML(
+        paste0(
+          '<svg viewBox=""0 0 1 1"" height=""14px"" width=""14px""><rect height=1 width=1 style=""fill : ',
+          c(""green"", ""red"", ""purple""),
+          '"" /><span style=""vertical-align:middle"">&nbsp;',
+          c(""Improving"", ""Decreasing"", ""Adding""),
+          '</span>',
+          collapse = ""<br />""
+        )
+      )
+    )
+  } else {
+    list(
+      tags$h5(""CFRG Standards_ID: Does Not Exist"", .noWS = ""inside""),
+      tags$table(style = ""max-width: 100%; white-space: nowrap;"",
+                 # Report formatting gray out the first row, so faking a row
+                 tags$tr(
+                   tags$td(width = ""50%"", style = ""vertical-align: top; padding:0; background-color:white; border:1px solid black"",
+                           
+                           tags$table(
+                             width = ""500px"",
+                             
+                             tags$th(
+                               tags$td(tags$b(""CFRG""), style = ""border-left: 1px solid;""),
+                               tags$td(tags$b(""CCISS""), style = ""border-left: 1px solid;"")
+                             ),
+                             
+                             
+                             tags$tr(
+                               tags$td(""Primary/E1"", style = ""border-right: 1px solid;""),
+                               tags$td(""""),
+                               sc[!is.na(Spp) & ccissFeas %in% ""1"", sppnotes_cciss(Spp,TxtCciss)]
+                             ),
+                             
+                             #tags$hr(style = ""padding: 0px; margin: 0 0 3px 0; height: 2px; background-color: darkgreen; border: 0px""),
+                             
+                             tags$tr(
+                               tags$td(""Secondary/E2"", style = ""border-right: 1px solid;""),
+                               tags$td(""""),
+                               sc[!is.na(Spp) & ccissFeas %in% ""2"", sppnotes_cciss(Spp,TxtCciss)]
+                             ),
+                             
+                             tags$tr(
+                               tags$td(""Tertiary/E3"", style = ""border-right: 1px solid;""),
+                               tags$td(""""),
+                               sc[!is.na(Spp) & ccissFeas %in% ""3"", sppnotes_cciss(Spp,TxtCciss)]
+                             ),
+                             
+                             tags$tr(
+                               tags$td(""Trial"",style = ""border-right: 1px solid;"" ),
+                               tags$td(""""),
+                               sc[!is.na(Spp) & EstabFeas == ""Trial"", sppnotes_cciss(Spp,TxtCciss)]
+                             ),
+                             
+                             tags$tr(
+                               tags$td(""Preferred (p)"",style = ""border-right: 1px solid;""),
+                               tags$td(""""),
+                               sc[!is.na(Spp) & PrefAcc %in% ""P"", sppnotes_cciss(Spp,TxtCciss)],
+                             ),
+                             tags$tr(
+                               tags$td(""Acceptable (a)"",style = ""border-right: 1px solid;""),
+                               tags$td(""""),
+                               sc[!is.na(Spp) & PrefAcc %in% ""A"", sppnotes_cciss(Spp,TxtCciss)],
+                               style = ""border-bottom:1px solid black;""
+                             ),
+                           )
+                   )
                  )
-               )
-  )
+      )
+    )
+    
+  }
+  
 
 }
 

---FILE: app/ui.R---
@@ -41,7 +41,7 @@ navbarPage(
   id = ""cciss_navbar"",
   # Select sites ----
   tabPanel(
-    title = navhelplink(""SELECT SITES"", ""cciss_instructions_select_sites_nav""),
+    title = navhelplink(""SELECT SITES"", ""cciss_instructions_select_sites""),
     value = ""sites"",
     class = ""tabcontainer"",
     tags$head(includeCSS(""./www/style.css"")),
@@ -65,6 +65,7 @@ $(document).ready(function(){
       sidebarPanel(
         width = 4,
         sidebarhelplink(""cciss_instructions_select_sites""),
+        p(""Welcome to CCISS v0.999 (beta)! Note that this tool uses a yet-to-be released version of BEC (v13), which includes changes to the coastal BEC classification that will be published in Spring 2025. If you would like to use the previous version based on BEC 12, you can find it "", a(""here!"",href = ""https://thebeczone.ca/shiny/cciss12"")),
         style = ""padding: 5px 5px 5px 5px; margin:0%; overflow-y:scroll; max-height: 90vh; position:relative; align: centre"",
         
         wellPanel(
@@ -93,7 +94,7 @@ $(document).ready(function(){
             tagList(
               br(),
               # p(""Report by:""),
-              switchInput(""aggregation"", value = TRUE, onLabel = ""Report averaged by BGC    "", offLabel = ""Report by individual sites"", width = '100%')
+              switchInput(""aggregation"", value = FALSE, onLabel = ""Report averaged by BGC    "", offLabel = ""Report by individual sites"", width = '100%')
             )
             
           )
@@ -537,52 +538,52 @@ $(document).ready(function(){
   ),
   # Tech specs ----
   navbarMenu(
-    title = ""APP INFO"",
+    title = ""DOCUMENTATION"",
     menuName = ""cciss_help"",
     tabPanel(
-      title = ""About"",
+      title = ""Overview"",
       value = ""cciss_about"",
       fluidRow(
         column(
           width = 6,
           offset = 1,
           tabPanel(
             title = """",
-            includeHTML(""./instructions/About_CCISS.html"") 
+            includeHTML(""./instructions/1a_About_CCISS.html"") 
           )
         )
       )
     ),
     tabPanel(
-      title = ""Instructions"",
+      title = ""Instructions (How to CCISS)"",
       value = ""cciss_instructions"",
       fluidRow(
         column(
           width = 8,
           offset = 1,
-          tags$h4(""Instructions""),
+          tags$h4(""Instructions (How to CCISS)""),
           tabsetPanel(
             id = ""cciss_instructions_set"",
             type = ""pills"",
             tabPanel(
               title = ""Select Sites"",
               value = ""cciss_instructions_select_sites"",
-              includeHTML(""./instructions/SelectSites.html"") 
+              includeHTML(""./instructions/2a_SelectSites.html"") 
             ),
             tabPanel(
               title = ""Feasibility Report"",
               value = ""cciss_instructions_feasibility_report"",
-              includeHTML(""./instructions/FeasibilityReport.html"") 
+              includeHTML(""./instructions/2b_FeasibilityReport.html"") 
             ),
             tabPanel(
               title = ""BEC Futures"",
               value = ""cciss_instructions_bec_futures"",
-              includeHTML(""./instructions/BECFutures.html"") 
+              includeHTML(""./instructions/2c_BECFutures.html"") 
             ),
             tabPanel(
               title = ""Silvics & Ecology"",
               value = ""cciss_instructions_silvics_ecology"",
-              includeHTML(""./instructions/SilvicsEcology.html"") 
+              includeHTML(""./instructions/2d_SilvicsEcology.html"") 
             ),
             # tabPanel(
             #   title = ""Species Portfolio"",
@@ -592,15 +593,139 @@ $(document).ready(function(){
             tabPanel(
               title = ""Export"",
               value = ""cciss_instructions_export"",
-              includeHTML(""./instructions/Export.html"") 
+              includeHTML(""./instructions/2e_Export.html"") 
             )
           )
         )
       )       
     ),
     tabPanel(
-      title = ""Feasibility Ratings"",
-      includeHTML(""./instructions/FeasibilityRatings.html"")
+      title = ""Methods (how the tool works)"",
+      value = ""cciss_methods"",
+      fluidRow(
+        column(
+          width = 8,
+          offset = 1,
+          tags$h4(""Methods""),
+          tabsetPanel(
+            id = ""cciss_methods_set"",
+            type = ""pills"",
+            tabPanel(
+              title = ""Overview"",
+              value = ""cciss_3a"",
+              includeHTML(""./instructions/3a_MethodsOverview.html"") 
+            ),
+            tabPanel(
+              title = ""BEC"",
+              value = ""cciss_3b"",
+              includeHTML(""./instructions/3b_BEC.html"") 
+            ),
+            tabPanel(
+              title = ""Feasibility Ratings"",
+              value = ""cciss_3c"",
+              includeHTML(""./instructions/3c_FeasibilityRatings.html"") 
+            ),
+            tabPanel(
+              title = ""Climate Change Projections"",
+              value = ""cciss_3d"",
+              includeHTML(""./instructions/3d_ClimateProjections.html"") 
+            ),
+            tabPanel(
+              title = ""BGC Model"",
+              value = ""cciss_3e"",
+              includeHTML(""./instructions/3e_BGCmodel.html"") 
+            ),
+            tabPanel(
+              title = ""Edatopic Overlap"",
+              value = ""cciss_3f"",
+              includeHTML(""./instructions/3f_EdatopicOverlap.html"") 
+            ),
+            tabPanel(
+              title = ""Rule Sets"",
+              value = ""cciss_3g"",
+              includeHTML(""./instructions/3g_Rulesets.html"") 
+            )
+
+          )
+        )
+      )       
+    ),
+    tabPanel(
+      title = ""Known Issues"",
+      value = ""cciss_issues"",
+      fluidRow(
+        column(
+          width = 8,
+          offset = 1,
+          tags$h4(""Known Issues""),
+          tabsetPanel(
+            id = ""cciss_issues"",
+            type = ""pills"",
+            tabPanel(
+              title = ""Overview"",
+              value = ""cciss_4a"",
+              includeHTML(""./instructions/4a_KnownIssues.html"") 
+            ),
+            tabPanel(
+              title = ""Sources of Error"",
+              value = ""cciss_4b"",
+              includeHTML(""./instructions/4b_SourcesOfError.html"") 
+            ),
+            tabPanel(
+              title = ""Novel Climates"",
+              value = ""cciss_4c"",
+              includeHTML(""./instructions/4c_NovelClimates.html"") 
+            ),
+            tabPanel(
+              title = ""Space-for-time Substitution"",
+              value = ""cciss_4d"",
+              includeHTML(""./instructions/4d_SpaceForTime.html"") 
+            )
+          )
+        )
+      )       
+    ),
+    tabPanel(
+      title = ""Using CCISS for Decisions"",
+      value = ""cciss_decisions"",
+      fluidRow(
+        column(
+          width = 6,
+          offset = 1,
+          tabPanel(
+            title = """",
+            includeHTML(""./instructions/5a_DecisionGuidance.html"") 
+          )
+        )
+      )
+    ),
+    tabPanel(
+      title = ""Providing Feedback"",
+      value = ""cciss_feedback"",
+      fluidRow(
+        column(
+          width = 6,
+          offset = 1,
+          tabPanel(
+            title = """",
+            includeHTML(""./instructions/6a_ProvidingFeedback.html"") 
+          )
+        )
+      )
+    ),
+    tabPanel(
+      title = ""FAQs"",
+      value = ""cciss_faqs"",
+      fluidRow(
+        column(
+          width = 6,
+          offset = 1,
+          tabPanel(
+            title = """",
+            includeHTML(""./instructions/7a_FAQs.html"") 
+          )
+        )
+      )
     ),
     tabPanel(
       title = ""Model information"","
bcgov,CCISS_ShinyApp,2eaf59f03e03c32103af7f38584611025f6b5844,Kiri,kiridaust@gmail.com,2024-11-07T01:03:45Z,Kiri,kiridaust@gmail.com,2024-11-07T01:03:45Z,Fix csv sorting error,app/server/points.R,False,True,True,False,19,1,20,"---FILE: app/server/points.R---
@@ -55,7 +55,25 @@ new_points <- function(points) {
       points <- uData$basepoints
     } else {
       points[,`:=`(Long = round(Long, 5), Lat = round(Lat, 5))]
-      res <- dbPointInfo(pool, points)
+      res <- as.data.table(dbPointInfo(pool, points))
+      if(nrow(points) > 1){
+        setnames(res, old = ""id"", new = ""ID"")
+        points[,ID := as.numeric(ID)]
+        res[,ID := as.numeric(ID)]
+        setorder(res, ID)
+        setorder(points, ID)
+        # res[, popups := paste(""<b>"", tools::toTitleCase(gsub(""_"", "" "", names(.SD))), "":</b>"", .SD, collapse = ""<br />""),
+        #                                   by=1:NROW(res)]$V1
+        # points[, popups := sapply(popups, HTML)]
+        # points[res, `:=`(
+        #   BGC = map_label,
+        #   ForestRegion = forest_region,
+        #   Site = Site_no,
+        #   Elev = elevation_m,
+        #   onbcland = onbcland,
+        # )]
+      }
+      #browser()
       points[, `:=`(
         BGC = if(uData$bec_click_flag) input$bgc_point_click else res$map_label,
         ForestRegion = res$forest_region,"
bcgov,CCISS_ShinyApp,421b4a3f4a9121dffa5a26db5c5492545a46611d,Kiri,kiridaust@gmail.com,2024-11-04T17:27:24Z,Kiri,kiridaust@gmail.com,2024-11-04T17:27:24Z,Fix issue with large batches,app/global.R;app/server/generate.R,False,True,True,False,65,44,109,"---FILE: app/global.R---
@@ -1,37 +1,56 @@
-# Shared shiny setup ----
-if (!requireNamespace(""Require"")) {
-  install.packages(""Require"")
-}
+# # Shared shiny setup ----
+# if (!requireNamespace(""Require"")) {
+#   install.packages(""Require"")
+# }
+# 
+# suppressPackageStartupMessages({
+#   Require::Require(c(
+#     ""colourvalues"",
+#     ""leaflet.extras"",
+#     ""pagedown"",
+#     ""prettydoc"",
+#     ""prompter"",
+#     ""RPostgres""
+#   ), require = FALSE)  ## don't load
+# })
+# 
+# suppressPackageStartupMessages({
+#   Require::Require(c(
+#     ""bslib"",
+#     ""bcgov/ccissr@main"",
+#     ""data.table"",
+#     ""DT"",
+#     ""ggplot2"",
+#     ""ggthemes"",
+#     ""kableExtra"",
+#     ""leaflet"",
+#     ""plotly"",
+#     ""pool"",
+#     ""rAmCharts4"",
+#     ""rhandsontable"",
+#     ""shiny"",
+#     ""shinyWidgets""
+#   ))
+# })
 
-suppressPackageStartupMessages({
-  Require::Require(c(
-    ""colourvalues"",
-    ""leaflet.extras"",
-    ""pagedown"",
-    ""prettydoc"",
-    ""prompter"",
-    ""RPostgres""
-  ), require = FALSE)  ## don't load
-})
-
-suppressPackageStartupMessages({
-  Require::Require(c(
-    ""bslib"",
-    ""bcgov/ccissr@main"",
-    ""data.table"",
-    ""DT"",
-    ""ggplot2"",
-    ""ggthemes"",
-    ""kableExtra"",
-    ""leaflet"",
-    ""plotly"",
-    ""pool"",
-    ""rAmCharts4"",
-    ""rhandsontable"",
-    ""shiny"",
-    ""shinyWidgets""
-  ))
-})
+req_libs <- list(
+  ""bslib"",
+  ""ccissr"",
+  ""data.table"",
+  ""DT"",
+  ""ggplot2"",
+  ""ggthemes"",
+  ""kableExtra"",
+  ""leaflet"",
+  ""plotly"",
+  ""pool"",
+  ""rAmCharts4"",
+  ""rhandsontable"",
+  ""shiny"",
+  ""shinyWidgets"",
+  ""RPostgres""
+)
 
+lapply(req_libs, library, character.only = TRUE)
 source(""./server/tooltip_verbage.R"")
 bgc_choices <- SS[grep(""BEC"",Source),BGC]

---FILE: app/server/generate.R---
@@ -34,7 +34,7 @@ observeEvent(input$generate_results, priority = 100, {
   update_flag(update_flag() + 1) ##make sure things recalculate
   # UI select choices
   tic(""Determine UI choices"", ticker)
-  
+  #browser()
   siterefs        <- uData$siterefs        <- sort(unique(bgc$SiteRef))
   ss_opts <- sort(unique(uData$sspreds$SS_NoSpace))
   bgc_opts <- unique(uData$bgc$BGC)
@@ -62,7 +62,7 @@ observeEvent(input$generate_results, priority = 100, {
     ss
   })
   names(ssl) <- siterefs
-  print(ssl)
+  #print(ssl)
   
   ssa <- unique(unname(unlist(ssl)))
   names(ssa) <- paste(
@@ -87,16 +87,18 @@ observeEvent(input$generate_results, priority = 100, {
   siteseries <- siteseries_list[[siteref]]
 
   tic(""Populate UI choices"", ticker)
-  updateSelectInput(inputId = ""siteref_feas"", choices = siterefs, selected = siteref)
-  updateSelectInput(inputId = ""siteref_bgc_fut"", choices = siterefs, selected = siteref)
-  updateSelectInput(inputId = ""siteref_bgc_fut_spatial"", choices = siterefs, selected = siteref)
-  updateSelectInput(inputId = ""ss_bgc_fut"", choices = siteseries, selected = siteseries[1])
-  updateSelectInput(inputId = ""siteref_silv"", choices = siterefs, selected = siteref)
-  updateSelectInput(inputId = ""site_series_feas"", choices = siteseries, selected = head(siteseries, 1))
-  updateSelectInput(inputId = ""site_series_silv"", choices = siteseries, selected = head(siteseries, 1))
+  updateSelectizeInput(inputId = ""siteref_feas"", choices = siterefs, selected = siteref, server = TRUE)
+  updateSelectizeInput(inputId = ""siteref_bgc_fut"", choices = siterefs, selected = siteref,server = TRUE)
+  updateSelectizeInput(inputId = ""siteref_bgc_fut_spatial"", choices = siterefs, selected = siteref,server = TRUE)
+  updateSelectizeInput(inputId = ""ss_bgc_fut"", choices = siteseries, selected = siteseries[1],server = TRUE)
+  updateSelectizeInput(inputId = ""siteref_silv"", choices = siterefs, selected = siteref,server = TRUE)
+  updateSelectizeInput(inputId = ""site_series_feas"", choices = siteseries, selected = head(siteseries, 1),server = TRUE)
+  updateSelectizeInput(inputId = ""site_series_silv"", choices = siteseries, selected = head(siteseries, 1),server = TRUE)
   updateSelectInput(inputId = ""port_bgc"", choices = bgc_opts, select = bgc_opts[1])
-  updateCheckboxGroupInput(inputId = ""report_filter"",choices = siteseries_all, selected = siteseries_all)
-  
+  if(length(siteseries_all) < 25){ ## app crashes with too many options here
+    updateCheckboxGroupInput(inputId = ""report_filter"",choices = siteseries_all, selected = siteseries_all)
+    
+  }
   # Use UI injected javascript to show download button and hide generate button
   tic(""Inject javascript"", ticker)
   session$sendCustomMessage(type=""jsCode"", list("
bcgov,CCISS_ShinyApp,d13e60ffddb8495056bf27c1e170ad41e023283a,Kiri,kiridaust@gmail.com,2024-08-07T21:11:45Z,Kiri,kiridaust@gmail.com,2024-08-07T21:11:45Z,Fix export bug,app/server/download.R,False,True,True,False,5,3,8,"---FILE: app/server/download.R---
@@ -90,10 +90,12 @@ output$data_download <- downloadHandler(
       zip(file,c(""cciss_export.rds"",""./www/downloadable_docs/CCISS_DataExport_MetaData.pdf""))
     } else if (input$data_format == ""csv"") {
       #browser()
-      id_vals <- uData$pts[,.(ID,Site)]
       dat_export <- uData$cciss_results[, -c(""PredFeasSVG"")]
-      dat_export[id_vals, ID := i.ID, on = c(SiteRef = ""Site"")]
-      setcolorder(dat_export,""ID"")
+      if(is.null(uData$bgc_select)){
+        id_vals <- uData$pts[,.(ID,Site)]
+        dat_export[id_vals, ID := i.ID, on = c(SiteRef = ""Site"")]
+        setcolorder(dat_export,""ID"")
+      }
       fwrite(dat_export, ""cciss_data.csv"")
       zip(file,c(""cciss_data.csv""))
     }"
bcgov,CCISS_ShinyApp,06461a953eb8a6f70eafb657436ced38231759cb,Mahony,Colin.Mahony@gov.bc.ca,2024-08-06T23:59:48Z,Mahony,Colin.Mahony@gov.bc.ca,2024-08-06T23:59:48Z,fixed extension,cciss_export_metadata.csv,False,False,False,False,0,0,0,
bcgov,CCISS_ShinyApp,5481631f393e21510ac6f14f543b71035f248306,Mahony,Colin.Mahony@gov.bc.ca,2024-03-22T02:22:17Z,Mahony,Colin.Mahony@gov.bc.ca,2024-03-22T02:22:17Z,edge case bug fix,CCISS_Spatial_exports.R,False,True,True,False,1,3,4,"---FILE: CCISS_Spatial_exports.R---
@@ -1,8 +1,6 @@
 ## Input data for CCISS spatial app
 ## Kiri Daust, Colin Mahony, 2023
 
-remotes::install_github(""bcgov/ccissr"")
-
 library(data.table)
 library(sf)
 library(RPostgreSQL)
@@ -676,7 +674,7 @@ for(edatope in edatopes){
           binary <- rep(0, dim(suit.hist)[1])
           binary[outRange.ref.all] <- NA
           binary[outRange.ref.all] <- apply(suit.ensemble[outRange.ref.all,], 1, function(x){return(if(sum(!is.na(x))==0) NA else if((sum(x<4, na.rm=T)/sum(!is.na(x)))>0) sum(x<4, na.rm=T)/sum(!is.na(x)) else NA)})
-          binary[-outRange.ref.all] <- apply(suit.ensemble[-outRange.ref.all,], 1, function(x){return(0-sum(x==4, na.rm=T)/sum(!is.na(x)))})
+          if(length(outRange.ref.all)<(dim(suit.hist)[1]-1)) binary[-outRange.ref.all] <- apply(suit.ensemble[-outRange.ref.all,], 1, function(x){return(0-sum(x==4, na.rm=T)/sum(!is.na(x)))})
           values(X) <- NA
           values(X)[points_dat$id] <- binary
           # plot(X)"
bcgov,CCISS_ShinyApp,ccbf05c71549cd5f44eda54fc3bb13e576920c39,Mahony,Colin.Mahony@gov.bc.ca,2024-03-22T02:21:43Z,Mahony,Colin.Mahony@gov.bc.ca,2024-03-22T02:21:43Z,minor edge case bug fix,spatial_app/app.R,False,True,True,False,1,1,2,"---FILE: spatial_app/app.R---
@@ -35,7 +35,7 @@ options(shiny.maxRequestSize = 60*1024^2)
 
 # setwd(""C:/Users/CMAHONY/OneDrive - Government of BC/Shiny_Apps/CCISS_ShinyApp/spatial_app"") # for local testing
 
-studyarea <- ""BC""
+studyarea <- ""BuMo""
 indir <- paste(""data"", studyarea, """", sep=""/"")
 
 edatopes <- c(""B2"", ""C4"", ""D6"")"
bcgov,CCISS_ShinyApp,7a0962b905499c6378c330e4536a8cd0f71a8308,cmahony,colin.mahony@gov.bc.ca,2024-01-21T19:15:40Z,cmahony,colin.mahony@gov.bc.ca,2024-01-21T19:15:40Z,bug fix in climate scatterplot,spatial_app/app.R,False,True,True,False,10,8,18,"---FILE: spatial_app/app.R---
@@ -35,7 +35,7 @@ options(shiny.maxRequestSize = 60*1024^2)
 
 # setwd(""C:/Users/CMAHONY/OneDrive - Government of BC/Shiny_Apps/CCISS_ShinyApp/spatial_app"") # for local testing
 
-studyarea <- ""BC""
+studyarea <- ""CDFCP""
 indir <- paste(""data"", studyarea, """", sep=""/"")
 
 edatopes <- c(""B2"", ""C4"", ""D6"")
@@ -362,7 +362,7 @@ ui <- fluidPage(
                                       conditionalPanel(
                                         condition = ""input.type == 2"",
 
-                                        checkboxInput(""zonelevel"", label = ""Generalize to BGC zone level"", value = T),
+                                        checkboxInput(""zonelevel"", label = ""Generalize to BGC zone level"", value = F),
 
                                         radioButtons(""plotbgc"", inline = TRUE,
                                                      label = ""Choose a plot type"",
@@ -853,22 +853,22 @@ server <- function(input, output, session) {
         values(X) <- factor(pred, levels=units)
         values(X)[1:length(units)] <- 1:length(units) # this is a patch that is necessary to get the color scheme right.
 
-        png(file, width = 5*300, height = 4.5*300, res = 300)
+        png(file, width = 5*300, height = 3.5*300, res = 300)
         par(mar=c(0,0,0,0))
 
         plot(X, xaxt=""n"", yaxt=""n"", col=alpha(ColScheme, 1), legend=FALSE, legend.mar=0, maxpixels=ncell(X), bty=""n"", box=FALSE)
         values(X)[-(1:length(units))] <- NA # cover up the color bar
         image(X, add=T, col=""white"") # cover up the color bar
-        # plot(bdy, add=T, lwd=1)
+        plot(bdy, add=T, lwd=1)
 
         totalarea <- sum(bgc.count[1,])
         temp <- table(pred)/totalarea
         temp <- rev(sort(temp))
         temp <- temp[which(temp > 0.005)]
         legendunits <- names(temp)
 
-        if(zonelevel==T) legend(""topright"", legend=paste(legendunits, "" ("", round(temp*100, 0), ""%)"", sep=""""), fill=zonecolors$colour[match(legendunits, zonecolors$classification)], ncol= if(length(legendunits)<12) 1 else if(length(legendunits)<23) 2 else 3, bty=""n"", cex=1)
-        if(zonelevel==F) legend(""topright"", legend=paste(legendunits, "" ("", round(temp*100, 0), ""%)"", sep=""""), fill=bgccolors$colour[match(legendunits, bgccolors$classification)], ncol= if(length(legendunits)<12) 1 else if(length(legendunits)<23) 2 else 3, bty=""n"", cex=0.9)
+        if(zonelevel==T) legend(""topright"", legend=paste(legendunits, "" ("", round(temp*100, 0), ""%)"", sep=""""), fill=zonecolors$colour[match(legendunits, zonecolors$classification)], ncol= if(length(legendunits)<12) 1 else if(length(legendunits)<23) 2 else 3, bty=""n"", cex=0.7)
+        if(zonelevel==F) legend(""topright"", legend=paste(legendunits, "" ("", round(temp*100, 0), ""%)"", sep=""""), fill=bgccolors$colour[match(legendunits, bgccolors$classification)], ncol= if(length(legendunits)<12) 1 else if(length(legendunits)<23) 2 else 3, bty=""n"", cex=0.5)
 
         # box()
         dev.off()
@@ -1104,7 +1104,7 @@ server <- function(input, output, session) {
   ## Plot window (done as a function so that the user can export)
   scatterPlot <- function() {
 
-    # period <- ""2041_2060""
+    # period <- ""2081_2100""
     # scenario <- scenarios[2]
     # var1 <- ""MAT""
     # var2 <- ""MAP""
@@ -1166,9 +1166,11 @@ server <- function(input, output, session) {
         text(x1,y1, ""2001-2020 (observed)"", cex=1, font=2, pos=4, col=""gray"", offset=0.9)
       }
 
+      # gcm=gcms[3]
       for(gcm in gcms){
         i=which(gcms==gcm)
         runs <- unique(identity$RUN[which(identity$GCM==gcm)])
+        # run=runs[4]
         for(run in runs){
           is.focalSim <- paste(gcm, substr(run,1,2), sep=""_"")==sim.focal
           x2 <- data[c(1, which(identity$GCM==gcm & identity$SSP==scenario & identity$RUN==run)), which(variables==var1)]
@@ -1178,7 +1180,7 @@ server <- function(input, output, session) {
             y3 <- if(unique(sign(diff(x2)))==-1) rev(y2) else y2
             s <- stinterp(x3,y3, seq(min(x3),max(x3), diff(xlim)/500)) # way better than interpSpline, not prone to oscillations
             if(run==""ensembleMean"") lines(s, col=ColScheme.gcms[i], lwd=2)
-          } else lines(x2, y2, col=ColScheme.gcms[i], lwd=2)
+          } else if(run==""ensembleMean"") lines(x2, y2, col=ColScheme.gcms[i], lwd=2)
           j=which(periods==period)
           if(length(runs)>2) points(x2[j],y2[j], pch=21, bg=if(is.focalSim==T) ""black"" else ColScheme.gcms[i], cex=1)
           if(run==""ensembleMean"") points(x2[j],y2[j], pch=21, bg=ColScheme.gcms[i], cex=if(gcm==""ensembleMean"") 3.5 else 3)"
bcgov,CCISS_ShinyApp,898a4b07ef9d1860b958b599dba2990a81ccfb2c,cmahony,colin.mahony@gov.bc.ca,2024-01-21T16:52:54Z,cmahony,colin.mahony@gov.bc.ca,2024-01-21T16:52:54Z,minor fixes,CCISS_Spatial_exports.R,False,True,True,False,16,15,31,"---FILE: CCISS_Spatial_exports.R---
@@ -165,7 +165,7 @@ cciss_basic <- function(bgc_preds, selected_edatope, selected_spp, suit_table){
 ### study area setup
 ### -------------------------------------------------------
 
-studyarea <- ""BC""
+studyarea <- ""CDFCP""
 
 # output directory for data created in this script
 dir.create(file.path(""spatial_app/data"", studyarea))
@@ -214,23 +214,25 @@ vars_needed <- c(""DD5"",""DD_0_at"",""DD_0_wt"",""PPT05"",""PPT06"",""PPT07"",""PPT08"",""PPT0
 if(studyarea==""BC""){
   dem <- rast(""//objectstore2.nrs.bcgov/ffec/Climatologies/PRISM_BC/PRISM_dem/PRISM_dem.asc"")
   dem <- aggregate(dem, fact=3)
-  bnd <- st_read(paste(""spatial_app/bdy/bdy"", studyarea, ""shp"", sep=""."")) #boundary file
-  bnd <- vect(bnd)
+  bnd <- vect(paste(""spatial_app/bdy/bdy"", studyarea, ""shp"", sep=""."")) #boundary file
   bnd <- project(bnd,""epsg:4326"") # project to albers to be able to specify resolution in meters. 
   dem <- mask(dem,bnd)
   dem <- trim(dem)
 } else {
   ##make study area dem
   dem_source <- rast(""../Common_Files/WNA_DEM_SRT_30m_cropped.tif"") ##DEM - I'm using a 30 m one
-  bnd <- st_read(paste(""spatial_app/bdy/bdy"", studyarea, ""shp"", sep=""."")) #boundary file
-  bnd <- vect(bnd)
+  bnd <- vect(paste(""spatial_app/bdy/bdy"", studyarea, ""shp"", sep=""."")) #boundary file
   bnd <- project(bnd,""epsg:4326"") # project to albers to be able to specify resolution in meters. 
+  bdy.bc <- vect(""C:/Users/CMAHONY/OneDrive - Government of BC/SpatialData/50k_layers/BC_int.shp"")
+  bdy.bc <- project(bdy.bc, ""epsg:4326"")
+  bnd <- crop(bnd, bdy.bc)
   dem <- rast(bnd,res = 0.006) ## ENHANCEMENT NEEDED: CHANGE HARD-CODED RESOLUTION TO DYNAMIC RESOLUTION MATCHING USER-SPECIFIED NUMBER OF CELLS
   dem <- project(dem_source,dem, method=""near"") ## extract 30m dem values to the custom raster. use nearest neighbour to preserve elevation variance. 
   dem <- mask(dem,bnd)
 }
-
+# sum(!is.na(values(dem)))
 # plot(dem)
+
 X <- dem # base raster
 values(X) <- NA
 
@@ -241,9 +243,10 @@ points_dat <- points_dat[,c(2,3,4,1)] #restructure for climr input
 # values(X)[points_dat$id] <- points_dat$el ; plot(X)
 
 ## attribute BGCs to points
-# bgcs <- st_read(""../Common_Files/BGC/WNA_BGC_v12_5Apr2022.gpkg"") ##BGC map. [COLIN] THIS DOESN'T WORK IN MY CODE; THE ST_JOIN FAILS
-library(bcmaps)
-bgcs <- bec() ##BGC map from bcmaps package
+# bgcs <- st_read(""//objectstore2.nrs.bcgov/ffec/WNA_BGC/WNA_BGC_v12_5Apr2022.gpkg"") ##BGC map.
+bgcs <- st_read(""C:/Users/CMAHONY/OneDrive - Government of BC/Shiny_Apps/Common_Files/WNA_BGC_v12_5Apr2022.gpkg"") ##BGC map.
+# library(bcmaps)
+# bgcs <- bec() ##BGC map from bcmaps package
 points_sf <- st_as_sf(points_dat, coords = c(""x"",""y""), crs = 4326)
 points_sf <- st_transform(points_sf,3005)
 bgc_att <- st_join(points_sf, bgcs)
@@ -256,7 +259,7 @@ bgc_att <- data.table(st_drop_geometry(bgc_att))
 ### -------------------------------------------------------
 
 # reference BGC units
-bgc.ref <- bgc_att$MAP_LABEL
+bgc.ref <- bgc_att$BGC
 values(X) <- NA
 X[points_dat$id] <- factor(bgc.ref, levels=levels.bgc) 
 writeRaster(X, datatype=""FLT4S"", paste(outdir,""/bgc.ref.tif"",sep = "".""), overwrite=T)
@@ -327,7 +330,7 @@ bgc_preds_ref <- clim[,.(ID,PERIOD,BGC.pred)]
 
 values(X) <- NA
 X[bgc_preds_ref$ID] <- factor(bgc_preds_ref$BGC.pred, levels=levels.bgc) #ISSUE: THE LEVELS.BGC IS NOT ALIGNED WITH THE RF MODEL. NEED TO RESOLVE AND GET THE CORRECT LEVELS. 
-plot(X)
+# plot(X)
 writeRaster(X, paste(outdir, ""/BGC.pred.ref.tif"", sep="".""),overwrite=TRUE)
 
 # # [ISSUE: THE LEVELS IN THE BGC MODEL DON'T APPEAR TO BE COMPLETE]
@@ -558,8 +561,8 @@ fractionize <- function(x){
 ## non-THLB BGCs for exclusion from area summaries 
 ## ISSUE: ADD LAKES TO THIS, OR REMOVE LAKE CELLS FROM THE ANALYSIS ENTIRELY
 BGCs_notin_THLB <- read.csv(""data-raw/data_tables/BGCs_notin_THLB.csv"")
-exclude <- bgc_att$id.x[which(bgc_att$MAP_LABEL%in%BGCs_notin_THLB$BGC[which(BGCs_notin_THLB$Exlude==""x"")])]
-include <- if(length(exclude>0)) bgc_att$id.x[-which(bgc_att$id.x%in%exclude)] else bgc_att$id.x
+exclude <- bgc_att$id[which(bgc_att$MAP_LABEL%in%BGCs_notin_THLB$BGC[which(BGCs_notin_THLB$Exlude==""x"")])]
+include <- if(length(exclude)>0) bgc_att$id[-which(bgc_att$id%in%exclude)] else bgc_att$id
 
 edatope=""C4""
 for(edatope in edatopes){
@@ -663,8 +666,6 @@ for(edatope in edatopes){
     print(paste(spp, "" ("", round(which(spps==spp)/length(spps)*100, 0), ""%)"", sep=""""))
   }
   
-  assign(paste(""PredSum.suit"", edatope, sep="".""), PredSum.suit)
-  
   write.csv(PredSum.suit, paste(outdir, ""/PredSum.suit"", edatope,""csv"", sep="".""), row.names = F)
   write.csv(PredSum.spp, paste(outdir, ""/PredSum.spp"", edatope,""csv"", sep="".""), row.names = F)
   write.csv(PredSum.suit.home, paste(outdir, ""/PredSum.suit.home"", edatope,""csv"", sep="".""), row.names = F)"
bcgov,CCISS_ShinyApp,35fbd7d8aafa0424adfb26131805d4f2dd03ebb8,Kiri,kiridaust@gmail.com,2024-01-21T01:51:58Z,Kiri,kiridaust@gmail.com,2024-01-21T01:51:58Z,Fixed issue with ID not being exported,app/server/download.R;data-raw/scripts/bigshinygisstudio.R;trial_locations/Bedford EP0995 experiment descriptions.csv,False,True,True,False,9,4,13,"---FILE: app/server/download.R---
@@ -89,8 +89,13 @@ output$data_download <- downloadHandler(
       saveRDS(uData, ""cciss_export.rds"")
       zip(file,c(""cciss_export.rds"",""./www/downloadable_docs/CCISS_DataExport_MetaData.pdf""))
     } else if (input$data_format == ""csv"") {
-      fwrite(uData$cciss_results[, -c(""PredFeasSVG"")], ""cciss_data.csv"")
-      zip(file,c(""cciss_data.csv"",""CCISS_DataExport_MetaData.pdf""))
+      #browser()
+      id_vals <- uData$pts[,.(ID,Site)]
+      dat_export <- uData$cciss_results[, -c(""PredFeasSVG"")]
+      dat_export[id_vals, ID := i.ID, on = c(SiteRef = ""Site"")]
+      setcolorder(dat_export,""ID"")
+      fwrite(dat_export, ""cciss_data.csv"")
+      zip(file,c(""cciss_data.csv""))
     }
   }
 )
\ No newline at end of file

---FILE: data-raw/scripts/bigshinygisstudio.R---
@@ -114,7 +114,7 @@ reset_ssh_sessions()
 analogsea::droplet_ssh(server, ""rm -R /srv/shiny-server/cciss"")
 analogsea::droplet_ssh(server, ""mkdir /srv/shiny-server/cciss"")
 analogsea::droplet_upload(server, ""./.Renviron"", ""/srv/shiny-server/cciss"")
-analogsea::droplet_ssh(server, ""R -e \""remotes::install_github('bcgov/CCISS_ShinyApp', upgrade = FALSE, dependencies = FALSE, force = TRUE)\"""")
+#analogsea::droplet_ssh(server, ""R -e \""remotes::install_github('bcgov/CCISS_ShinyApp', upgrade = FALSE, dependencies = FALSE, force = TRUE)\"""")
 analogsea::droplet_upload(server, ""./app/global.R"", ""/srv/shiny-server/cciss/global.R"")
 analogsea::droplet_upload(server, ""./app/server.R"", ""/srv/shiny-server/cciss/server.R"")
 analogsea::droplet_upload(server, ""./app/ui.R"", ""/srv/shiny-server/cciss/ui.R"")

---FILE: trial_locations/Bedford EP0995 experiment descriptions.csv---
@@ -1,4 +1,4 @@
-ID1,Latitude,Longitude,Elevation (m)
+ID,Latitude,Longitude,Elevation (m)
 Inga Lake,56.61666667,-121.6333333,890
 Iron Creek,56.63333333,-122.3166667,820
 Stewart Lake,55.9,-120.9833333,805"
bcgov,CCISS_ShinyApp,9d14f244cbaf5b4673392d520051ba1f3727d417,Kiri,kiridaust@gmail.com,2023-12-21T01:09:35Z,Kiri,kiridaust@gmail.com,2023-12-21T01:09:35Z,Fix error with NaN values,CCISS_Spatial_exports.R,False,True,True,False,5,2,7,"---FILE: CCISS_Spatial_exports.R---
@@ -217,7 +217,7 @@ bnd <- vect(bnd)
 bnd <- project(bnd,""epsg:4326"") # project to albers to be able to specify resolution in meters. 
 
 #source dem
-dem_source <- rast(""../Common_Files/dem/WNA_DEM_SRT_30m_cropped.tif"") ##DEM - I'm using a 30 m one
+dem_source <- rast(""../Common_Files/WNA_DEM_SRT_30m_cropped.tif"") ##DEM - I'm using a 30 m one
 dem_source <- crop(dem_source,bnd)
 # dem_source <- aggregate(dem_source, fact=10) #upsample for large study areas (e.g., BC)
 
@@ -289,7 +289,7 @@ write.csv(unique(zone.ref[!is.na(zone.ref)]), paste(outdir, ""/zones.native.csv"",
 # ===============================================================================
 # ===============================================================================
 
-load(""../Common_Files/BGCModels/BGCModel_Extratrees_FullData.Rdata"") ##load RF model
+load(""../Common_Files/BGCModel_Extratrees_FullData.Rdata"") ##load RF model
 pred_vars <- BGCmodel[[""forest""]][[""independent.variable.names""]] ##required predictors
 
 ### -------------------------------------------------------
@@ -313,6 +313,7 @@ change <- data.frame(""GCM""=""obs"", ""SSP""=""obs"", ""RUN""=NA, ""PERIOD""=""1961_1990"", a
 names(change)[-c(1:4)] <- names(clim.refmean)
 
 # Predict BGC
+clim <- clim[!is.nan(CMI)|!is.na(CMI),]
 tile_predict(clim,pred_vars=pred_vars) 
 bgc_preds_ref <- clim[,.(ID,PERIOD,BGC.pred)] 
 
@@ -344,6 +345,7 @@ change.temp <- clim.mean - clim.refmean
 change <- rbind(change, data.frame(""GCM""=""obs"", ""SSP""=""obs"", ""RUN""=NA, ""PERIOD""=""2001_2020"", as.data.frame(t(change.temp))))
 
 # Predict BGC
+clim <- clim[!is.nan(CMI)|!is.na(CMI),]
 tile_predict(clim,pred_vars) 
 bgc_preds_hist <- clim[,.(ID,PERIOD,BGC.pred)] 
 bgc_preds_hist[bgc_preds_ref, BGC.ref := i.BGC.pred, on = ""ID""]
@@ -390,6 +392,7 @@ for(ssp in ssps){
       change <- rbind(change, cbind(clim.mean[,c(1:4)], change.temp)) # append to the mean change table. 
       
       ## BGC projections 
+      clim <- clim[!is.nan(CMI)|!is.na(CMI),]
       tile_predict(clim,pred_vars) ##predict BGC!
       bgc_preds_temp <- clim[,.(ID,GCM,SSP,RUN,PERIOD,BGC.pred)] ##this now has all the raw predictions
       bgc_preds_temp[bgc_preds_ref, BGC.ref := i.BGC.pred, on = ""ID""]"
bcgov,CCISS_ShinyApp,acca574b472ed8492d6d3e617256a5b1741da5e9,cmahony,colin.mahony@gov.bc.ca,2023-12-11T22:23:28Z,cmahony,colin.mahony@gov.bc.ca,2023-12-11T22:23:28Z,"bug fix. case was incorrect in ""Change[s]uit"", causing crash on deployed version.",spatial_app/app.R,False,True,True,False,7,7,14,"---FILE: spatial_app/app.R---
@@ -35,7 +35,7 @@ options(shiny.maxRequestSize = 60*1024^2)
 
 # setwd(""C:/Users/CMAHONY/OneDrive - Government of BC/Shiny_Apps/CCISS_ShinyApp/spatial_app"") # for local testing
 
-studyarea <- ""Nimpkish""
+studyarea <- ""Sunshine""
 indir <- paste(""data"", studyarea, """", sep=""/"")
 
 edatopes <- c(""B2"", ""C4"", ""D6"")
@@ -712,7 +712,7 @@ server <- function(input, output, session) {
             if(sim.focal==""Ensemble mean""){
               suit.ref <- suit[match(levels.bgc[values(bgc.pred.ref)], SiteLookup$BGC)]
               suit.ref[is.na(suit.ref)] <- 4 #set non-suitable to 4
-              change.proj <- values(raster(paste(indir,paste(""Spp.ChangeSuit"", spp.focal, edatope, scenario, period, ""tif"", sep="".""), sep="""")))
+              change.proj <- values(raster(paste(indir,paste(""Spp.Changesuit"", spp.focal, edatope, scenario, period, ""tif"", sep="".""), sep="""")))
               temp <- suit.ref-change.proj
               temp[which(temp>3.5)] <- NA #set non-suitable to NA
               temp[which(temp<1)] <- 1 #set non-suitable to NA
@@ -734,7 +734,7 @@ server <- function(input, output, session) {
       if(input$mapspp==2){
         values(X) <- NA
         if(input$periodtype==3){
-          if(spp.focal!=""none"") X <- raster(paste(indir,paste(""Spp.ChangeSuit"", spp.focal, edatope, scenario, period, ""tif"", sep="".""), sep=""""))
+          if(spp.focal!=""none"") X <- raster(paste(indir,paste(""Spp.Changesuit"", spp.focal, edatope, scenario, period, ""tif"", sep="".""), sep=""""))
           leafletProxy(""map"") %>%
             addProviderTiles(""Esri.WorldTopoMap"", group = ""Base map"") %>%
             addRasterImage(X, colors =  ColScheme.change, method=""ngb"", opacity = transparency, maxBytes = 6 * 1024 * 1024)%>%
@@ -902,7 +902,7 @@ server <- function(input, output, session) {
             if(sim.focal==""Ensemble mean""){
               suit.ref <- suit[match(levels.bgc[values(bgc.pred.ref)], SiteLookup$BGC)]
               suit.ref[is.na(suit.ref)] <- 4 #set non-suitable to 4
-              change.proj <- values(raster(paste(indir,paste(""Spp.ChangeSuit"", spp.focal, edatope, scenario, period, ""tif"", sep="".""), sep="""")))
+              change.proj <- values(raster(paste(indir,paste(""Spp.Changesuit"", spp.focal, edatope, scenario, period, ""tif"", sep="".""), sep="""")))
               temp <- suit.ref-change.proj
               temp[which(temp>3.5)] <- NA #set non-suitable to NA
               temp[which(temp<1)] <- 1 #set non-suitable to NA
@@ -952,7 +952,7 @@ server <- function(input, output, session) {
           ColScheme <- c(""darkgreen"", ""dodgerblue1"", ""gold2"", ""white"")
           legendTitle <- ""Projected feasibility""
         } else if(input$mapspp==2){
-          if(spp.focal!=""none"") X <- raster(paste(indir,paste(""Spp.ChangeSuit"", spp.focal, edatope, scenario, period, ""tif"", sep="".""), sep=""""))
+          if(spp.focal!=""none"") X <- raster(paste(indir,paste(""Spp.Changesuit"", spp.focal, edatope, scenario, period, ""tif"", sep="".""), sep=""""))
           breakpoints <- seq(-3,3,0.5); length(breakpoints)
           labels <- c(""-3"",""-2"", ""-1"", ""no change"", ""+1"",""+2"",""+3"")
           ColScheme <- c(""black"", brewer.pal(11,""RdBu"")[c(1,2,3,4)], ""grey90"", ""grey90"", brewer.pal(11,""RdBu"")[c(7,8,9,10,11)]);
@@ -1060,7 +1060,7 @@ server <- function(input, output, session) {
               if(sim.focal==""Ensemble mean""){
                 suit.ref <- suit[match(levels.bgc[values(bgc.pred.ref)], SiteLookup$BGC)]
                 suit.ref[is.na(suit.ref)] <- 4 #set non-suitable to 4
-                change.proj <- values(raster(paste(indir,paste(""Spp.ChangeSuit"", spp.focal, edatope, scenario, period, ""tif"", sep="".""), sep="""")))
+                change.proj <- values(raster(paste(indir,paste(""Spp.Changesuit"", spp.focal, edatope, scenario, period, ""tif"", sep="".""), sep="""")))
                 temp <- suit.ref-change.proj
                 temp[which(temp>3.5)] <- NA #set non-suitable to NA
                 temp[which(temp<1)] <- 1 #set non-suitable to NA
@@ -1078,7 +1078,7 @@ server <- function(input, output, session) {
         if(input$mapspp==2){
           values(X) <- NA
           if(input$periodtype==3){
-            if(spp.focal!=""none"") X <- raster(paste(indir,paste(""Spp.ChangeSuit"", spp.focal, edatope, scenario, period, ""tif"", sep="".""), sep=""""))
+            if(spp.focal!=""none"") X <- raster(paste(indir,paste(""Spp.Changesuit"", spp.focal, edatope, scenario, period, ""tif"", sep="".""), sep=""""))
           }
         }
         if(input$mapspp==3){"
bcgov,CCISS_ShinyApp,e49234f0e08141873b88756095cc3a654bce0341,cmahony,colin.mahony@gov.bc.ca,2023-12-11T05:38:43Z,cmahony,colin.mahony@gov.bc.ca,2023-12-11T05:38:43Z,"bug fix. ""BGC"" in file name should have been ""bgc"" and that prevented the deploy to shinyapps.io",spatial_app/app.R,False,True,True,False,3,7,10,"---FILE: spatial_app/app.R---
@@ -15,9 +15,6 @@
 # See the License for the specific language governing permissions and
 # limitations under the License.
 
-
-# setwd(""C:/Users/CMAHONY/OneDrive - Government of BC/Shiny_Apps/CCISS_ShinyApp/spatial_app/"")
-
 # library(shiny)
 library(RColorBrewer)
 library(stinepack) # for interpolation splines
@@ -46,7 +43,6 @@ scenarios <- c(""ssp126"", ""ssp245"")
 scenario.names=c(""SSP1-2.6"", ""SSP2-4.5"")
 scenario <- scenarios[2] # only one scenario currently supported. would need to revise the script to support more than one scenario. 
 
-
 period.names=c(""2001-2020"", ""2021-2040"", ""2041-2060"", ""2061-2080"", ""2081-2100"")
 
 bdy <- st_read(dsn = paste(""bdy/bdy"", studyarea, ""shp"", sep="".""))
@@ -96,7 +92,7 @@ bgcs.native <- as.vector(unlist(read.csv(paste(indir,""bgcs.native.csv"", sep=""""))
 zones.native <- as.vector(unlist(read.csv(paste(indir,""zones.native.csv"", sep=""""))))
 
 ## projected area of biogeoclimatic units
-bgc.area <- read.csv(paste(indir,""PredSum.BGC.csv"", sep=""""))
+bgc.area <- read.csv(paste(indir,""PredSum.bgc.csv"", sep=""""))
 temp <- bgc.area[-which(bgc.area$GCM==""ensembleMean""),] #remove ensemble vote
 temp.ens <- bgc.area[which(bgc.area$GCM==""ensembleMean""),] #ensemble vote
 bgc.area <- bgc.area[,-c(1:5)] # matches the ""identity"" table
@@ -154,7 +150,7 @@ levels.bgc <- read.csv(""data/levels.bgc.csv"")[,1]
 ## persistence and expansion of bgc units
 
     #bgc total table
-    bgc.count <- read.csv(paste(indir,""PredSum.BGC.csv"", sep=""""))
+    bgc.count <- read.csv(paste(indir,""PredSum.bgc.csv"", sep=""""))
     bgc.count[is.na(bgc.count)] <- 0
     bgc.count <- bgc.count[,-c(1:5)] # matches the ""identity"" table
 
@@ -164,7 +160,7 @@ levels.bgc <- read.csv(""data/levels.bgc.csv"")[,1]
     zone.count <- zone.count[,-c(1:5)] # matches the ""identity"" table
 
     #bgc table for home range
-    bgc.count.home <- read.csv(paste(indir,""PredSum.BGC.home.csv"", sep=""""))
+    bgc.count.home <- read.csv(paste(indir,""PredSum.bgc.home.csv"", sep=""""))
     bgc.count.home[is.na(bgc.count.home)] <- 0
     bgc.count.home <- bgc.count.home[,-c(1:5)] # matches the ""identity"" table
 "
bcgov,CCISS_ShinyApp,36489e6020fe6885b26f1472d51fd73accb4621d,Kiri,kiridaust@gmail.com,2023-11-24T23:45:32Z,Kiri,kiridaust@gmail.com,2023-11-24T23:45:32Z,Fixed (hopefully) special units issue with edatopic overlap,CCISS_Testing.R;R/eda_overlap.R,False,True,True,False,32,22,54,"---FILE: CCISS_Testing.R---
@@ -28,4 +28,6 @@ points <- dbGetQuery(pool, ""select siteno from preselected_points where bgc = 'I
 sitenos <- points$siteno[1:150]
 bgc <- dbGetCCISS(pool, sitenos, avg = T, modWeights = all_weight)
 setDT(bgc)
+eda <- edatopicOverlap(bgc, E1, E1_Phase)
 t1 <- bgc[,.(BGC.Sum = sum(BGC.prop)), by = .(FuturePeriod)]
+BGC <- bgc[FuturePeriod == ""2041"",]

---FILE: R/eda_overlap.R---
@@ -134,15 +134,23 @@ edatopicOverlap <- function(BGC,E1,E1_Phase,onlyRegular = FALSE){
   combAll <- combAll[,list(SiteRef, FuturePeriod, BGC, BGC.pred, SS_NoSpace, 
                         allOverlap, SS.pred, BGC.prop)]
   combAll <- na.omit(combAll)
-  combAllSave <- combAll
+  #combAllSave <- combAll
   combAll <- unique(combAll)
   combAll <- merge(combAll,SSsp.out,
                    by = c(""SiteRef"",""FuturePeriod"",""BGC"",""BGC.pred"",""SS_NoSpace"",""SS.pred""), all = T)
+  ##which ones are not current special site series
+  combAll[E1[,.(SS_NoSpace,SpecialCode)], SppCode := i.SpecialCode, on = ""SS_NoSpace""]
+  combAll[E1[,.(SS_NoSpace,SpecialCode)], SppCodePred := i.SpecialCode, on = c(SS.pred = ""SS_NoSpace"")]
+  combAll[SppCode != SppCodePred, Flag := F]
+  combAll <- combAll[is.na(Flag),]
   combAll[,Flag := if(all(is.na(allOverlap.y))) T else F, by = list(SiteRef,FuturePeriod,BGC,SS_NoSpace,BGC.pred)]
-  comb_reg <- combAll[(Flag),]
-  comb_reg[,c(""allOverlap.y"",""BGC.prop.y"",""Flag"") := NULL]
-  setnames(comb_reg,old = c(""allOverlap.x"",""BGC.prop.x""), new = c(""allOverlap"",""BGC.prop""))
-  combAll <- rbind(comb_reg, SSsp.out)
+  combAll[is.na(SppCode) & !is.na(SppCodePred), rmFlag := T]
+  combAll[!is.na(SppCode) & is.na(SppCodePred) & Flag == FALSE, rmFlag := T]
+  
+  combAll <- combAll[is.na(rmFlag),]
+  combAll[!is.na(allOverlap.y), `:=`(allOverlap.x = allOverlap.y, BGC.prop.x = BGC.prop.y)]
+  combAll[,c(""allOverlap.y"",""BGC.prop.y"",""Flag"",""rmFlag"",""SppCode"",""SppCodePred"") := NULL]
+  setnames(combAll,old = c(""allOverlap.x"",""BGC.prop.x""), new = c(""allOverlap"",""BGC.prop""))
   #combAll[!is.na(allOverlap.y), `:=`(allOverlap.x = allOverlap.y, BGC.prop.x = BGC.prop.y)]
   #temp <- combAll[!is.na(allOverlap.y),]
   #temp[,c(""allOverlap.x"",""BGC.prop.x"") := NULL]
@@ -181,7 +189,7 @@ edatopicOverlap <- function(BGC,E1,E1_Phase,onlyRegular = FALSE){
   ##now redo for phases
   numEdaPh <- E1_Phase[,list(NumEdas = .N), by = list(SS_NoSpace)]
   phaseSmall <- unique(edaPhase[,list(BGC,MainUnit,Phase = SS_NoSpace)])
-  combPhase <- phaseSmall[combAllSave, on = c(MainUnit = ""SS.pred""), allow.cartesian = T]
+  combPhase <- phaseSmall[noPhase, on = c(MainUnit = ""SS.pred""), allow.cartesian = T]
   justPhase <- combPhase[!is.na(Phase),]
   curr <- unique(justPhase[,list(SiteRef, FuturePeriod, BGC = i.BGC, BGC.pred, SS_NoSpace)])
   fut <- unique(justPhase[,list(SiteRef, FuturePeriod, BGC = i.BGC, BGC.pred, MainUnit, Phase)])
@@ -213,8 +221,8 @@ edatopicOverlap <- function(BGC,E1,E1_Phase,onlyRegular = FALSE){
                                   SS.pred = MainUnit.y, PhasePred,phaseOverlap = allOverlap)]
   combPhaseAll <- na.omit(combPhaseAll)
   setkey(combPhaseAll,SiteRef,FuturePeriod,BGC,BGC.pred,SS_NoSpace,SS.pred)
-  setkey(combAllSave,SiteRef,FuturePeriod,BGC,BGC.pred,SS_NoSpace,SS.pred)
-  combAll <- combPhaseAll[combAllSave]
+  setkey(noPhase,SiteRef,FuturePeriod,BGC,BGC.pred,SS_NoSpace,SS.pred)
+  combAll <- combPhaseAll[noPhase]
   ####add phase to non-phase###
   combAll[,PhaseSum := sum(phaseOverlap), by = list(SiteRef,FuturePeriod,BGC,BGC.pred,SS_NoSpace,SS.pred)]
   combAll[,phaseOverlap := phaseOverlap/PhaseSum]
@@ -223,20 +231,20 @@ edatopicOverlap <- function(BGC,E1,E1_Phase,onlyRegular = FALSE){
   combAll[,c(""phaseOverlap"",""PhaseSum"",""PhasePred"") := NULL]
   ###done phases
   
-  combAll <- merge(combAll,SSsp.out,
-                   by = c(""SiteRef"",""FuturePeriod"",""BGC"",""BGC.pred"",""SS_NoSpace"",""SS.pred""), all = T)
-  temp <- combAll[!is.na(allOverlap.y),]
-  temp[,c(""allOverlap.x"",""BGC.prop.x"") := NULL]
-  setnames(temp,old = c(""allOverlap.y"",""BGC.prop.y""), new = c(""allOverlap"",""BGC.prop""))
-  combAll[,Flag := if(all(is.na(allOverlap.y))) T else F, by = list(SiteRef,FuturePeriod,BGC,SS_NoSpace,BGC.pred)]
-  combAll <- combAll[(Flag),!""Flag""]
-  combAll[,c(""allOverlap.y"",""BGC.prop.y"") := NULL]
-  setnames(combAll,old = c(""allOverlap.x"",""BGC.prop.x""), new = c(""allOverlap"",""BGC.prop""))
-  combAll <- rbind(combAll,temp)
-  combAll[,MainUnit := gsub(""[a-c]$|\\.[1-9]$"","""",SS.pred)]
-  combAll <- combAll[!(BGC == BGC.pred  &  SS_NoSpace != MainUnit),] ### removes overlap where past BGC = future BGC
-  combAll[,MainUnit := NULL]
-  combAll <- unique(combAll[!is.na(SS_NoSpace),])
+  # combAll <- merge(combAll,SSsp.out,
+  #                  by = c(""SiteRef"",""FuturePeriod"",""BGC"",""BGC.pred"",""SS_NoSpace"",""SS.pred""), all = T)
+  # temp <- combAll[!is.na(allOverlap.y),]
+  # temp[,c(""allOverlap.x"",""BGC.prop.x"") := NULL]
+  # setnames(temp,old = c(""allOverlap.y"",""BGC.prop.y""), new = c(""allOverlap"",""BGC.prop""))
+  # combAll[,Flag := if(all(is.na(allOverlap.y))) T else F, by = list(SiteRef,FuturePeriod,BGC,SS_NoSpace,BGC.pred)]
+  # combAll <- combAll[(Flag),!""Flag""]
+  # combAll[,c(""allOverlap.y"",""BGC.prop.y"") := NULL]
+  # setnames(combAll,old = c(""allOverlap.x"",""BGC.prop.x""), new = c(""allOverlap"",""BGC.prop""))
+  # combAll <- rbind(combAll,temp)
+  # combAll[,MainUnit := gsub(""[a-c]$|\\.[1-9]$"","""",SS.pred)]
+  # combAll <- combAll[!(BGC == BGC.pred  &  SS_NoSpace != MainUnit),] ### removes overlap where past BGC = future BGC
+  # combAll[,MainUnit := NULL]
+  # combAll <- unique(combAll[!is.na(SS_NoSpace),])
 
   
   ##add in BGC probability"
bcgov,CCISS_ShinyApp,ccb1a6dc27561eb16742a96f7772377f9066aa5f,Kiri,kiridaust@gmail.com,2023-11-22T03:33:33Z,Kiri,kiridaust@gmail.com,2023-11-22T03:33:33Z,Fixes to edatopic overlap,R/eda_overlap.R;app/server/futures.R,False,True,True,False,18,10,28,"---FILE: R/eda_overlap.R---
@@ -89,9 +89,10 @@ edatopicOverlap <- function(BGC,E1,E1_Phase,onlyRegular = FALSE){
   new <- CurrBGC[FutBGC, allow.cartesian=TRUE]
   new <- new[!is.na(SS_NoSpace),] ##this removes special site series that don't align
   SSsp.out <- new[,list(allOverlap = 1/.N,SS.pred,BGC.prop), keyby = list(SiteRef,FuturePeriod,BGC,BGC.pred,SS_NoSpace)]
+  SSsp.out <- unique(SSsp.out)
   
   ##regular site series edatopes
-  SS <- E1[is.na(SpecialCode),list(BGC,SS_NoSpace,Edatopic)]
+  SS <- E1[,list(BGC,SS_NoSpace,Edatopic)]
   temp <- rbind(SS,E1_Phase[is.na(SpecialCode),list(BGC,SS_NoSpace,Edatopic)])
   CurrBGC <- temp[BGC, on = ""BGC"", allow.cartesian = T]
   CurrBGC <- CurrBGC[!duplicated(CurrBGC),]
@@ -134,17 +135,24 @@ edatopicOverlap <- function(BGC,E1,E1_Phase,onlyRegular = FALSE){
                         allOverlap, SS.pred, BGC.prop)]
   combAll <- na.omit(combAll)
   combAllSave <- combAll
-  
+  combAll <- unique(combAll)
   combAll <- merge(combAll,SSsp.out,
                    by = c(""SiteRef"",""FuturePeriod"",""BGC"",""BGC.pred"",""SS_NoSpace"",""SS.pred""), all = T)
-  temp <- combAll[!is.na(allOverlap.y),]
-  temp[,c(""allOverlap.x"",""BGC.prop.x"") := NULL]
-  setnames(temp,old = c(""allOverlap.y"",""BGC.prop.y""), new = c(""allOverlap"",""BGC.prop""))
   combAll[,Flag := if(all(is.na(allOverlap.y))) T else F, by = list(SiteRef,FuturePeriod,BGC,SS_NoSpace,BGC.pred)]
-  combAll <- combAll[(Flag),!""Flag""]
-  combAll[,c(""allOverlap.y"",""BGC.prop.y"") := NULL]
-  setnames(combAll,old = c(""allOverlap.x"",""BGC.prop.x""), new = c(""allOverlap"",""BGC.prop""))
-  combAll <- rbind(combAll,temp)
+  comb_reg <- combAll[(Flag),]
+  comb_reg[,c(""allOverlap.y"",""BGC.prop.y"",""Flag"") := NULL]
+  setnames(comb_reg,old = c(""allOverlap.x"",""BGC.prop.x""), new = c(""allOverlap"",""BGC.prop""))
+  combAll <- rbind(comb_reg, SSsp.out)
+  #combAll[!is.na(allOverlap.y), `:=`(allOverlap.x = allOverlap.y, BGC.prop.x = BGC.prop.y)]
+  #temp <- combAll[!is.na(allOverlap.y),]
+  #temp[,c(""allOverlap.x"",""BGC.prop.x"") := NULL]
+  
+  # setnames(temp,old = c(""allOverlap.y"",""BGC.prop.y""), new = c(""allOverlap"",""BGC.prop""))
+  # combAll[,Flag := if(all(is.na(allOverlap.y))) T else F, by = list(SiteRef,FuturePeriod,BGC,SS_NoSpace,BGC.pred)]
+  # combAll <- combAll[(Flag),!""Flag""]
+  # combAll[,c(""allOverlap.y"",""BGC.prop.y"") := NULL]
+  # setnames(combAll,old = c(""allOverlap.x"",""BGC.prop.x""), new = c(""allOverlap"",""BGC.prop""))
+  # combAll <- rbind(combAll,temp)
   combAll[,MainUnit := gsub(""[a-c]$|\\.[1-9]$"","""",SS.pred)]
   combAll <- combAll[!(BGC == BGC.pred  &  SS_NoSpace != MainUnit),] ### removes overlap where past BGC = future BGC
   combAll[,MainUnit := NULL]

---FILE: app/server/futures.R---
@@ -73,7 +73,7 @@ bgc_fut_plotly <- function(data, siteref, sseries, minallow, period_map = uData$
                      barmode = 'stack', legend = l, hovermode = ""x unified"")
   }else{
     data <- data[SiteRef == siteref & SS_NoSpace == sseries,]
-    data_ss <- merge.data.table(data2, data, on = c(""SiteRef"",""FuturePeriod"",""BGC.pred""), all = T)
+    data_ss <- merge(data2, data, on = c(""SiteRef"",""FuturePeriod"",""BGC.pred""), all = T)
     data_ss[dat_order, fpCode := i.fpCode, on = ""FuturePeriod""]
     plotly::plot_ly(data = data_ss, x = ~fpCode,
                     y = ~BGC.prop, split = ~BGC.pred, type = 'bar',"
bcgov,CCISS_ShinyApp,f8f7283bb4695b019abcc3fd3c06fc4c7c2ddcb4,Kiri,kiridaust@gmail.com,2023-11-20T00:21:58Z,Kiri,kiridaust@gmail.com,2023-11-20T00:21:58Z,Fixed future plots,CCISS_Testing.R;Feasibility_Maps.R;R/eda_overlap.R;app/server/feasibility.R;app/server/futures.R,False,True,True,False,81,13,94,"---FILE: CCISS_Testing.R---
@@ -24,6 +24,8 @@ all_weight[gcm_weight,wgcm := i.weight, on = ""gcm""]
 all_weight[rcp_weight,wrcp := i.weight, on = ""rcp""]
 all_weight[,weight := wgcm*wrcp]
 
-points <- dbGetQuery(pool, ""select siteno from preselected_points where bgc = 'SBSdw3'"")
+points <- dbGetQuery(pool, ""select siteno from preselected_points where bgc = 'IDFdk3'"")
 sitenos <- points$siteno[1:150]
 bgc <- dbGetCCISS(pool, sitenos, avg = T, modWeights = all_weight)
+setDT(bgc)
+t1 <- bgc[,.(BGC.Sum = sum(BGC.prop)), by = .(FuturePeriod)]

---FILE: Feasibility_Maps.R---
@@ -187,7 +187,7 @@ timeperiods <- c(2001, 2021, 2041, 2061, 2081)
 timeperiod.names <- c(""2001-2020"", ""2021-2040"", ""2041-2060"", ""2061-2080"", ""2081-2100"")
 
 ###load up bgc predictions data
-timeperiod <- ""2041""
+timeperiod <- ""2081""
 for(timeperiod in timeperiods[-1]){
   bgc <- setDT(dbGetQuery(con,paste0(""select * from mapdata_2km where futureperiod = '"",timeperiod,""'""))) ##takes about 15 seconds
   setnames(bgc, c(""SiteRef"",""FuturePeriod"",""BGC"",""BGC.pred"",""BGC.prop""))
@@ -217,6 +217,7 @@ for(timeperiod in timeperiods[-1]){
       edaZonal[,HasPos := NULL]
       ##edatopic overlap
       SSPreds <- edatopicOverlap(bgc,edaZonal,E1_Phase,onlyRegular = TRUE) ##takes about 30 seconds
+      SSPreds <- edatopicOverlap(bgc,E1,E1_Phase,onlyRegular = TRUE) ##takes about 30 seconds
       
       # ## ------------------------------------
       # ## 3 panel map with add/retreat and mean feasibility change
@@ -571,6 +572,60 @@ for(timeperiod in timeperiods[-1]){
   print(timeperiod)
 }
 
+qry <- ""WITH sspred as (
+select * from map2km_sspred 
+where ss_nospace in (
+select distinct ss_nospace from edatopic where edatopic = 'C4'
+)
+),
+feas as (select ss_nospace, newfeas from feasibility where spp = 'Fd') 
+SELECT siteref, sspred.ss_nospace, feas.newfeas, SUM(ss_prob) 
+FROM sspred INNER JOIN feas ON (sspred.ss_pred = feas.ss_nospace)
+GROUP BY (siteref, sspred.ss_nospace, newfeas)
+""
+
+dat <- dbGetQuery(con, qry)
+suitMerge <- as.data.table(dat)
+feas_spp <- S1[Spp == 'Fd',.(SS_NoSpace,Feasible)]
+suitVotes <- data.table::dcast(suitMerge, siteref + ss_nospace ~ newfeas, 
+                               value.var = ""sum"")
+colNms <- c(""1"",""2"",""3"",""X"")
+set(suitVotes, j = as.character(1:5)[!as.character(1:5) %in% names(suitVotes)], value = 0)
+
+suitVotes[is.na(suitVotes)] <- 0
+suitVotes[,VoteSum := `1`+`2`+`3`+`4`+`5`]
+suitVotes[,X := 1 - VoteSum]
+suitVotes[,VoteSum := NULL]
+suitVotes[,X := X + `5` + `4`]
+suitVotes[,`:=`(`5` = NULL, `4` = NULL)]
+setkey(suitVotes, ss_nospace)
+setkey(feas_spp, SS_NoSpace)
+suitVotes[feas_spp, Curr := i.Feasible]
+suitVotes[is.na(Curr), Curr := 5]
+#setorder(suitVotes,SiteRef,SS_NoSpace,Spp,FuturePeriod)
+suitVotes[Curr > 3.5, Curr := 4]
+
+suitVotes <- suitVotes[,lapply(.SD, sum),.SDcols = colNms, 
+                       by = .(siteref, ss_nospace,Curr)]
+suitVotes[,NewSuit := `1`+(`2`*2)+(`3`*3)+(X*5)]
+suitRes <- suitVotes[,.(Curr = mean(Curr),NewSuit = mean(NewSuit)), by = .(siteref)]
+
+
+##send sspred to database
+SSPreds[,BGC.prop := NULL]
+SSPreds[,allOverlap := NULL]
+SSPreds[,SSratio := NULL]
+setnames(SSPreds,c(""siteref"",""period"",""bgc"",""bgc_pred"",""ss_nospace"",""ss_pred"",""ss_prob""))
+dbWriteTable(con, ""map2km_sspred"", SSPreds, row.names = F, append = T)
+dbExecute(con,""create index on map2km_sspred(ss_nospace)"")
+
+eda <- fread(""data-raw/data_tables/Edatopic_v12_15.csv"")
+setnames(eda, c(""source"",""bgc"",""ss_nospace"",""edatopic""))
+dbWriteTable(con,""edatopic"",eda, row.names = F)
+
+feas <- fread(""data-raw/data_tables/Feasibility_v12_15.csv"")
+dbWriteTable(con, ""feasibility"", feas, row.names = F)
+
 ### -------------------------------------------------------
 ### -------------------------------------------------------
 ### export rasters of mean feasibility change

---FILE: R/eda_overlap.R---
@@ -242,7 +242,7 @@ edatopicOverlap <- function(BGC,E1,E1_Phase,onlyRegular = FALSE){
   temp <- unique(temp)
   combAll[,BGC.prop := NULL]
   combAll <- temp[combAll]
-  combAll[,SSprob := SSratio*BGC.prop]
+  combAll[,SSprob := SSratio*BGC.prop] ##this part may not be correct
   combAll <- combAll[!duplicated(combAll),]
   print(""Done EDA"")
   return(list(phase = combAll, NoPhase = noPhase))

---FILE: app/server/feasibility.R---
@@ -31,6 +31,7 @@ output$results_feas <- function() {
   siteserie <- selected_site$ss
   update_flag()
   cciss_results <- copy(uData$cciss_results)
+  #browser()
   feas_filter <- input$filter_feas
   if (is.null(cciss_results)) return(NULL)
   cciss_results_dt(cciss_results, siteref, siteserie, feas_filter)

---FILE: app/server/futures.R---
@@ -20,23 +20,30 @@ output$bgc_fut_plot <- plotly::renderPlotly({
   minallow <- input$min_ssoverlap
   update_flag()
   if (is.null(uData$eda_out)) return(NULL)
-  bgc_fut_plotly(copy(uData$eda_out), siteref, sseries, minallow)
+  data <- copy(uData$eda_out)
+  #browser()
+  data[,Lab := paste(SS.pred,round(SSratio,digits = 2),sep = "": "")]
+  data <- data[,.(SSLab = paste(Lab,collapse = ""<br>"")),
+               by = .(SiteRef,SS_NoSpace,FuturePeriod,BGC.pred)]
+  dat_bgc <- copy(uData$bgc)
+  dat_bgc[,BGC := NULL]
+  plotdat <- merge.data.table(data,dat_bgc, on = c(""SiteRef"",""FuturePeriod"",""BGC.pred""), all= TRUE)
+  bgc_fut_plotly(plotdat, siteref, sseries, minallow)
 })
 
 # Graph
 
 #' @param data BGC data.table
 bgc_fut_plotly <- function(data, siteref, sseries, minallow, period_map = uData$period_map, ...) {
-  data <- data[SSratio > minallow,]
+  #data <- data[SSratio > minallow,]
   
   dat_order <- data.table(FuturePeriod = c(""1961"",""1991"",""2001"",""2021"",""2041"",""2061"", ""2081""), fpCode = c(1,2,3.5,4.5,5.5,6.5,7.5))
   #browser()
   #data[,allOverlap := allOverlap/sum(allOverlap), by = .(SiteRef,SS_NoSpace,FuturePeriod,BGC.pred,BGC.prop)]
-  data[,Lab := paste(SS.pred,round(SSratio,digits = 2),sep = "": "")]
-  data <- data[,.(SSLab = paste(Lab,collapse = ""<br>"")),
-                    by = .(SiteRef,SS_NoSpace,FuturePeriod,BGC.pred,BGC.prop)]
-  data <- data[SiteRef == siteref & SS_NoSpace == sseries,]
-  data[dat_order, fpCode := i.fpCode, on = ""FuturePeriod""]
+  
+  #data <- data[SiteRef == siteref & SS_NoSpace == sseries,]
+  data2 <- unique(data[SiteRef == siteref,.(FuturePeriod,BGC.pred,BGC.prop)])
+  data2[dat_order, fpCode := i.fpCode, on = ""FuturePeriod""]
   l <- list(
     font = list(
       size = 12,
@@ -48,13 +55,13 @@ bgc_fut_plotly <- function(data, siteref, sseries, minallow, period_map = uData$
     y = 1.25,
     x = -0.05)
   color_ref <- {
-    colors <- subzones_colours_ref[unique(data$BGC.pred)]
+    colors <- subzones_colours_ref[unique(data2$BGC.pred)]
     col <- colors$colour
     names(col) <- colors$classification
     col
   }
   if(input$future_showss == ""BGC""){
-    plotly::plot_ly(data = data, x = ~fpCode,
+    plotly::plot_ly(data = data2, x = ~fpCode,
                     y = ~BGC.prop, split = ~BGC.pred, type = 'bar',
                     color = ~BGC.pred, colors = color_ref, hovertemplate = ""%{y}"",
                     text = ~BGC.pred, textposition = 'inside', textfont = list(color = ""black"", size = 12),
@@ -65,7 +72,10 @@ bgc_fut_plotly <- function(data, siteref, sseries, minallow, period_map = uData$
                                   tickvals = dat_order$fpCode),
                      barmode = 'stack', legend = l, hovermode = ""x unified"")
   }else{
-    plotly::plot_ly(data = data, x = ~fpCode,
+    data <- data[SiteRef == siteref & SS_NoSpace == sseries,]
+    data_ss <- merge.data.table(data2, data, on = c(""SiteRef"",""FuturePeriod"",""BGC.pred""), all = T)
+    data_ss[dat_order, fpCode := i.fpCode, on = ""FuturePeriod""]
+    plotly::plot_ly(data = data_ss, x = ~fpCode,
                     y = ~BGC.prop, split = ~BGC.pred, type = 'bar',
                     color = ~BGC.pred, colors = color_ref,
                     text = ~SSLab, textposition = 'inside', textfont = list(color = ""black"", size = 12),"
bcgov,CCISS_ShinyApp,bfe20f8869ccbac92b80672f6b56b55ce6457100,cmahony,colin.mahony@gov.bc.ca,2023-11-12T19:52:35Z,cmahony,colin.mahony@gov.bc.ca,2023-11-12T19:52:35Z,add issues to be resolved.,CCISS_Spatial_exports.R,False,True,True,False,10,231,241,"---FILE: CCISS_Spatial_exports.R---
@@ -16,6 +16,15 @@ library(RColorBrewer)
 library(terra)
 library(ccissdev)
 
+# =============================================================
+# Issues:
+# - need BGC projections for the 2001-2020 observed normals
+# - need a function to calculate species suitability from a vector of BGCs. the current edatopicOverlap() function is specific to the mapdata_2km output
+# - the future BGC projections do not have a consistent set of rast_ids, and a few thousand duplicate records. need to find out why. 
+# - the function to calculate change in feasibility is currently uses mapped bgc as the reference bgc. it would be more correct to use the reference period predicted bgc as the reference bgc. 
+# - ideally, we could have a function to supply a raster and return the biogeoclimatic projections for this raster. 
+# =============================================================
+
 ##some setup
 con <- dbPool(
   drv = RPostgres::Postgres(),
@@ -439,234 +448,4 @@ write.csv(PredSum.zone.home.wide, paste(outdir, ""/data/PredSum.zone.home"",studya
 #===============================================================================
 #===============================================================================
 
-
-#===============================================================================
-# find the species suitability each projection/edatope/species combination
-#===============================================================================
-
-spp <- ""Pl""
-# for(spp in c(""Pl"", ""Fd"", ""Cw"", ""Sx"")){
-for(spp in spps){
-  for(edatope in edatopes){
-    # get the suitability for the reference period predicted BGC.
-    bgc.pred <- levels.bgc[values(raster(paste(outdir, paste(""/data/bgc.pred"", studyarea, ""ref.tif"", sep="".""), sep="""")))[land]]
-    
-    # get the suitability for the selected species associated with each site series
-    suit <- S1$Feasible[which(S1$Spp==spp)][match(as.vector(unlist(SiteLookup[which(names(SiteLookup)==edatope)])), as.character(S1$SS_NoSpace[which(S1$Spp==spp)]))]
-    Suit.ref <- suit[match(bgc.pred, SiteLookup$BGC)]
-    Suit.ref[is.na(Suit.ref)] <- 5 #set the NA values to suitability 5
-    Suit.ref[Suit.ref==4] <- 5 #set 4 to suitability 5
-    assign(paste(""Suit.ref"", spp, edatope, sep="".""), Suit.ref)
-    # write.csv(Suit.ref, paste(outdir, ""/data/Suit.ref"", studyarea, spp, edatope, ""csv"", sep="".""), row.names = F)
-    
-    # get the suitability for historical periods, for each edatope/species combination
-    bgc.pred <- levels.bgc[values(raster(paste(outdir, paste(""/data/bgc.pred"", studyarea, ""hist.2001.tif"", sep="".""), sep="""")))[land]]
-    ## identify cells with no suitability interpretations
-    bgc.exotic <- (1:length(bgc.pred))[-which(bgc.pred%in%unique(bgc))]
-    bgc.exotic.noSuit <- bgc.exotic[-which(bgc.pred[bgc.exotic]%in%unique(S1$BGC))]
-    
-    suit <- S1$Feasible[which(S1$Spp==spp)][match(as.vector(unlist(SiteLookup[which(names(SiteLookup)==edatope)])), S1$SS_NoSpace[which(S1$Spp==spp)])]
-    temp <- suit[match(bgc.pred, SiteLookup$BGC)]
-    temp[is.na(temp)] <- 5 #set the NA values to suitability 5
-    temp[temp==4] <- 5 #set 4 to suitability 5
-    temp[bgc.exotic.noSuit] <- NA # set cells with no suitability interpretation to NA
-    assign(paste(""Suit"", hist.year, spp, edatope, sep="".""), temp)
-    # write.csv(temp, paste(outdir, ""/data/Suit"", studyarea, hist.year, spp, edatope, ""csv"", sep="".""), row.names = F)
-    # print(hist.year)
-    
-    # get the suitability for future periods, for each projection/edatope/species combination
-    for(GCM in GCMs){
-      # for(scenario in scenarios){
-      for(proj.year in proj.years){
-        # get the bgc projection and sub in the crosswalk between the modeled units and the table units
-        bgc.pred <- levels.bgc[values(raster(paste(outdir, paste(""/data/bgc.pred"", studyarea, GCM, scenario, proj.year,""tif"", sep="".""), sep="""")))[land]]
-        # bgc.pred[which(bgc.pred%in%Crosswalk$Modeled)] <- as.character(Crosswalk$Tables[match(bgc.pred[which(bgc.pred%in%Crosswalk$Modeled)], Crosswalk$Modeled)]) # XXX THIS IS NOT CORRECT. NEED TO FIGURE OUT HOW TO INCORPORATE THE CROSSWALK TABLE PROPERLY. sub in the crosswalk between the modeled units and the table units
-        
-        ## identify cells with no suitability interpretations
-        bgc.exotic <- (1:length(bgc.pred))[-which(bgc.pred%in%unique(bgc))]
-        bgc.exotic.noSuit <- bgc.exotic[-which(bgc.pred[bgc.exotic]%in%unique(S1$BGC))]
-        
-        # get the suitability for the selected species associated with each site series
-        suit <- S1$Feasible[which(S1$Spp==spp)][match(as.vector(unlist(SiteLookup[which(names(SiteLookup)==edatope)])), S1$SS_NoSpace[which(S1$Spp==spp)])]
-        temp <- suit[match(bgc.pred, SiteLookup$BGC)]
-        temp[is.na(temp)] <- 5 #set the NA values to suitability 5 (weights unsuitable a bit more heavily than suitable classes during averaging)
-        temp[temp==4] <- 5 #set 4 to suitability 5
-        temp[bgc.exotic.noSuit] <- NA # set cells with no suitabilty interpretation to NA
-        assign(paste(""Suit"", GCM, scenario, proj.year, spp, edatope, sep="".""), temp)
-        # write.csv(temp, paste(outdir, ""/delete/Suit"", studyarea, GCM, scenario, proj.year, spp, edatope, ""csv"", sep="".""), row.names = F)
-        # print(proj.year)
-      }
-      # print(scenario)
-      # }
-      # print(GCM)
-    }
-    # print(edatope)
-  }
-  print(paste(spp, "" ("", round(which(spps==spp)/length(spps)*100, 0), ""%)"", sep=""""))
-}
-
-for each edatope: 
-  raster of mean feasibility changes
-raster of loss/gain
-  table of species suitability changes
-  
-
-
-#===============================================================================
-# summarize the suitability of species for each scenario. 
-#===============================================================================
-
-## non-THLB bgcs for exclusion from results
-points <- read.csv(paste(""inputs/"",studyarea,"".csv"", sep=""""))
-bgc <- points$id2
-bgc <- gsub("" "","""",bgc)
-exclude <- which(bgc%in%BGCs_notin_THLB$BGC[which(BGCs_notin_THLB$Exlude==""x"")])
-include <- if(length(exclude>0)) seq(1,length(bgc))[-exclude] else seq(1,length(bgc))
-
-for(edatope in edatopes){
-  
-  #initiate tables to store summary values
-  PredSum.suit <- data.frame(PredSum.bgc.wide[1:3], as.data.frame(matrix(rep(NA, length(spps)*dim(PredSum.bgc.wide)[1]), dim(PredSum.bgc.wide)[1])))
-  names(PredSum.suit)[-c(1:3)] <- spps
-  PredSum.spp <- PredSum.suit
-  PredSum.suit.home <- PredSum.suit #home is for counting cells within historical range. 
-  PredSum.spp.home <- PredSum.suit
-  
-  for(spp in spps){
-    
-    #reference period suitabilities
-    Suit.ref <- get(paste(""Suit.ref"", spp, edatope, sep="".""))[include]
-    # Suit.ref <- read.csv(paste(outdir, ""/data/Suit.ref"", spp, edatope, ""csv"", sep="".""))[include,1]
-    # Suit.ref <- read.csv(paste(outdir, ""/data/Suit.ref"", studyarea, spp, edatope, ""csv"", sep="".""))[,1]
-    Suit.ref[Suit.ref==5] <- NA
-    outRange.ref <- is.na(Suit.ref)
-    Suit.ref[is.na(Suit.ref)] <- 5
-    Suit.ref[Suit.ref==4] <- 3 #added this based on email from Will May 18, 2021
-    Suit.ref <- 1-(Suit.ref-1)/4
-    
-    row <- 1
-    col <- which(names(PredSum.suit)==spp)
-    PredSum.suit[row,col] <- round(sum(Suit.ref))
-    PredSum.spp[row,col] <- round(sum(Suit.ref>0))
-    PredSum.suit.home[row,col] <- round(sum(Suit.ref[outRange.ref==F]))
-    PredSum.spp.home[row,col] <- round(sum((Suit.ref>0)[outRange.ref==F]))
-    
-    for(hist.year in hist.years){
-      Suit.proj <- get(paste(""Suit"", hist.year, spp, edatope, sep="".""))[include]
-      Suit.proj[is.na(Suit.proj)] <- 5
-      Suit.proj[Suit.proj==4] <- 3 #added this based on email from Will May 18, 2021
-      Suit.proj <- 1-(Suit.proj-1)/4
-      
-      row <- which(PredSum.suit$proj.year==hist.year)
-      PredSum.suit[row,col] <- round(sum(Suit.proj))
-      PredSum.spp[row,col] <- round(sum(Suit.proj>0))
-      PredSum.suit.home[row,col] <- round(sum(Suit.proj[outRange.ref==F]))
-      PredSum.spp.home[row,col] <- round(sum((Suit.proj>0)[outRange.ref==F]))
-    }
-    
-    for(GCM in GCMs){
-      # for(scenario in scenarios){
-      for(proj.year in proj.years){
-        Suit.proj <- get(paste(""Suit"", GCM, scenario, proj.year, spp, edatope, sep="".""))[include]
-        # Suit.proj <- read.csv(paste(outdir, ""/delete/Suit"", studyarea, GCM, scenario, proj.year, spp, edatope, ""csv"", sep="".""))[,1][include]
-        Suit.proj[is.na(Suit.proj)] <- 5
-        Suit.proj[Suit.proj==4] <- 3 #added this based on email from Will May 18, 2021
-        Suit.proj <- 1-(Suit.proj-1)/4
-        
-        row <- which(PredSum.suit$GCM==GCM & PredSum.suit$scenario==scenario & PredSum.suit$proj.year==proj.year)
-        PredSum.suit[row,col] <- round(sum(Suit.proj))
-        PredSum.spp[row,col] <- round(sum(Suit.proj>0))
-        PredSum.suit.home[row,col] <- round(sum(Suit.proj[outRange.ref==F]))
-        PredSum.spp.home[row,col] <- round(sum((Suit.proj>0)[outRange.ref==F]))
-        # print(proj.year)
-      }
-      # print(scenario)
-      # }
-      # print(GCM)
-    }
-    print(paste(spp, "" ("", round(which(spps==spp)/length(spps)*100, 0), ""%)"", sep=""""))
-  }
-  
-  assign(paste(""PredSum.suit"", edatope, sep="".""), PredSum.suit)
-  
-  write.csv(PredSum.suit, paste(outdir, ""/data/PredSum.suit"",studyarea, edatope,""csv"", sep="".""), row.names = F)
-  write.csv(PredSum.spp, paste(outdir, ""/data/PredSum.spp"",studyarea, edatope,""csv"", sep="".""), row.names = F)
-  write.csv(PredSum.suit.home, paste(outdir, ""/data/PredSum.suit.home"",studyarea, edatope,""csv"", sep="".""), row.names = F)
-  write.csv(PredSum.spp.home, paste(outdir, ""/data/PredSum.spp.home"",studyarea, edatope,""csv"", sep="".""), row.names = F)
-  
-  print(edatope)
-}
-
-#===============================================================================
-# Write rasters of mean feasibilty change and binary appearance
-#===============================================================================
-X <- dem
-edatope=""C4""
-for(edatope in edatopes){
-  
-  # exclude insignificant species
-  suit.area <-  read.csv(paste(outdir, ""/data/PredSum.suit"",studyarea, edatope,""csv"", sep="".""))[,-c(1:3)]
-  totalarea <- sum(suit.area[1,]) #historical distribution 
-  small <- which(apply(suit.area, 2, sum, na.rm=T)/totalarea < 0.25) # establish insignificant species for removal
-  
-  for(spp in spps[-small]){
-    
-    RefSuit <- get(paste(""Suit.ref"", spp, edatope, sep="".""))
-    outRange.base <- RefSuit==5
-    RefSuit[RefSuit==4] <- 3 #added this based on email from Will May 18, 2021
-    RefSuit[RefSuit==5] <- 4
-    RefSuit[is.na(RefSuit)] <- 4
-    table(RefSuit)
-    
-    for(proj.year in proj.years){
-      # compile the GCM projections into a data frame
-      ProjSuit <- data.frame(temp=rep(NA, length(RefSuit))) #initiate the data frame with a dummy column
-      ChangeSuit <- data.frame(temp=rep(NA, length(RefSuit))) #initiate the data frame with a dummy column
-      for(GCM in GCMs){
-        temp <- get(paste(""Suit"", GCM, scenario, proj.year, spp, edatope, sep="".""))
-        # temp <- read.csv(paste(outdir, ""/delete/Suit"", studyarea, GCM, scenario, proj.year, spp, edatope, ""csv"", sep="".""))[,1]
-        temp[temp==4] <- 3 #added this based on email from Will May 18, 2021
-        temp[temp==5] <- 4
-        temp[is.na(temp)] <- 4
-        ProjSuit <- cbind(ProjSuit,temp)
-        ChangeSuit <- cbind(ChangeSuit,RefSuit-temp)
-      }
-      ProjSuit <- ProjSuit[,-1] #remove the dummy column
-      ChangeSuit <- ChangeSuit[,-1] #remove the dummy column
-      names(ProjSuit) <- GCMs[-which(GCMs==""ensemble"")]
-      names(ChangeSuit) <- GCMs[-which(GCMs==""ensemble"")]
-      
-      # calculate ensemble mean suitability change. this isn't biased by missing suitabilties for exotic bgcs
-      ChangeSuit.mean <- apply(ChangeSuit, 1, mean, na.rm=T)
-      
-      outRange <- outRange.base
-      outRange[which(ChangeSuit.mean!=0)] <- FALSE
-      ChangeSuit.mean[outRange==T] <- NA
-      
-      values(X) <- NA
-      values(X)[land] <- ChangeSuit.mean
-      # plot(X)
-      writeRaster(X, paste(outdir, ""/data/Spp.ChangeSuit"", studyarea, spp, edatope, scenario, proj.year,""tif"", sep="".""),overwrite=TRUE)
-      
-      ##=================================
-      # binary appearance/disappearance
-      Suit.ensemble <- as.matrix(ProjSuit)
-      Suit.ensemble[Suit.ensemble==5] <- 4
-      binary <- rep(0, length(RefSuit))
-      binary[outRange.base==T] <- NA
-      binary[outRange.base] <- apply(Suit.ensemble[outRange.base,], 1, function(x){return(if((sum(x<4, na.rm=T)/sum(!is.na(x)))>0) sum(x<4, na.rm=T)/sum(!is.na(x)) else NA)})
-      binary[outRange.base==F] <- apply(Suit.ensemble[outRange.base==F,], 1, function(x){return(0-sum(x==4, na.rm=T)/sum(!is.na(x)))})
-      values(X) <- NA
-      values(X)[land] <- binary
-      writeRaster(X, paste(outdir, ""/data/Spp.binary"", studyarea, spp, edatope, scenario, proj.year,""tif"", sep="".""),overwrite=TRUE)
-      
-      # print(proj.year)
-    }
-    
-    print(spp)
-  }
-  
-  print(edatope)
-}
-
-
+# complete this once the issues above have been resolved. 
\ No newline at end of file"
bcgov,CCISS_ShinyApp,3bfe7abbe175ca678e51bf86162176ba14ef6a70,Daust,Kiri.Daust@gov.bc.ca,2023-11-02T19:11:06Z,Daust,Kiri.Daust@gov.bc.ca,2023-11-02T19:11:06Z,Fixed edatopic overlap,CCISS_Testing.R;R/eda_overlap.R;app/server.R,False,True,True,False,78,44,122,"---FILE: CCISS_Testing.R---
@@ -0,0 +1,29 @@
+library(ccissdev)
+library(data.table)
+library(pool)
+
+pool <- dbPool(
+  drv = RPostgres::Postgres(),
+  dbname = Sys.getenv(""BCGOV_DB""),
+  host = Sys.getenv(""BCGOV_HOST""),
+  port = 5432, 
+  user = Sys.getenv(""BCGOV_USR""),
+  password = Sys.getenv(""BCGOV_PWD"")
+)
+
+gcm_weight <- data.table(gcm = c(""ACCESS-ESM1-5"", ""BCC-CSM2-MR"", ""CanESM5"", ""CNRM-ESM2-1"", ""EC-Earth3"", 
+                                 ""GFDL-ESM4"", ""GISS-E2-1-G"", ""INM-CM5-0"", ""IPSL-CM6A-LR"", ""MIROC6"", 
+                                 ""MPI-ESM1-2-HR"", ""MRI-ESM2-0"", ""UKESM1-0-LL""),
+                         weight = c(1,0,0,1,1,1,1,0,0,1,1,1,0))
+
+rcp_weight <- data.table(rcp = c(""ssp126"",""ssp245"",""ssp370"",""ssp585""), 
+                         weight = c(0.8,1,0.8,0))
+
+all_weight <- as.data.table(expand.grid(gcm = gcm_weight$gcm,rcp = rcp_weight$rcp))
+all_weight[gcm_weight,wgcm := i.weight, on = ""gcm""]
+all_weight[rcp_weight,wrcp := i.weight, on = ""rcp""]
+all_weight[,weight := wgcm*wrcp]
+
+points <- dbGetQuery(pool, ""select siteno from preselected_points where bgc = 'SBSdw3'"")
+sitenos <- points$siteno[1:150]
+bgc <- dbGetCCISS(pool, sitenos, avg = T, modWeights = all_weight)

---FILE: R/eda_overlap.R---
@@ -91,6 +91,7 @@ edatopicOverlap <- function(BGC,E1,E1_Phase,onlyRegular = FALSE){
   SSsp.out <- new[,list(allOverlap = 1/.N,SS.pred,BGC.prop), keyby = list(SiteRef,FuturePeriod,BGC,BGC.pred,SS_NoSpace)]
   
   ##regular site series edatopes
+  SS <- E1[is.na(SpecialCode),list(BGC,SS_NoSpace,Edatopic)]
   temp <- rbind(SS,E1_Phase[is.na(SpecialCode),list(BGC,SS_NoSpace,Edatopic)])
   CurrBGC <- temp[BGC, on = ""BGC"", allow.cartesian = T]
   CurrBGC <- CurrBGC[!duplicated(CurrBGC),]

---FILE: app/server.R---
@@ -32,6 +32,8 @@ onStop(function() {
   poolClose(poolclim)
 })
 
+DEV = TRUE
+
 #####load feas table from database
 S1 <- setDT(dbGetQuery(sppDb,""select bgc,ss_nospace,spp,newfeas from feasorig""))
 setnames(S1,c(""BGC"",""SS_NoSpace"",""Spp"",""Feasible""))
@@ -93,54 +95,56 @@ shinyServer(function(input, output, session) {
   source(""./server/instructions.R"", local = TRUE)
   
   ##login
-  showModal(
-    modalDialog(
-      size = ""xl"",
-      footer = NULL,
-      textOutput(""login_error""),
-      splitLayout(
-        wellPanel(
-          h4(""Sign Up""),
-          textInput(""su_email"",""Email:""),
-          textInput(""su_uname"", ""Create Username""),
-          selectInput(""su_role"",""What are you?"", choices = c("""", ""Forester"",""Government"",""Academic"",""Student"",""Unicorn"",""Good CCISSer""), 
-                      selected = NULL),
-          actionButton(""su_go"",""Sign Up!"")
-        ),
-        wellPanel(
-          h4(""Log In""),
-          textInput(""login_uname"",""Enter Username""),
-          actionButton(""login_go"",""Log In!"")
+  if(!DEV){
+    showModal(
+      modalDialog(
+        size = ""xl"",
+        footer = NULL,
+        textOutput(""login_error""),
+        splitLayout(
+          wellPanel(
+            h4(""Sign Up""),
+            textInput(""su_email"",""Email:""),
+            textInput(""su_uname"", ""Create Username""),
+            selectInput(""su_role"",""What are you?"", choices = c("""", ""Forester"",""Government"",""Academic"",""Student"",""Unicorn"",""Good CCISSer""), 
+                        selected = NULL),
+            actionButton(""su_go"",""Sign Up!"")
+          ),
+          wellPanel(
+            h4(""Log In""),
+            textInput(""login_uname"",""Enter Username""),
+            actionButton(""login_go"",""Log In!"")
+          )
         )
       )
     )
-  )
-  
-  output$login_error <- renderText({login_text$message})
-  
-  observeEvent(input$su_go, {
-    if(input$su_email == """" | input$su_uname == """" | input$su_role == """"){
-      login_text$message <- ""Please enter your email and password.""
-    }else{
-      tryCatch({
-        dbExecute(pool, paste0(""INSERT INTO cciss_users (username, email, role, nsession) VALUES ('"",
-                               input$su_uname,""', '"",input$su_email,""','"",input$su_role,""',0)""))
+    
+    output$login_error <- renderText({login_text$message})
+    
+    observeEvent(input$su_go, {
+      if(input$su_email == """" | input$su_uname == """" | input$su_role == """"){
+        login_text$message <- ""Please enter your email and password.""
+      }else{
+        tryCatch({
+          dbExecute(pool, paste0(""INSERT INTO cciss_users (username, email, role, nsession) VALUES ('"",
+                                 input$su_uname,""', '"",input$su_email,""','"",input$su_role,""',0)""))
+          removeModal()
+        },
+        error = function(e) {
+          login_text$message <- ""Username Exists. Please login or choose a new one.""
+        })
+      }
+    })
+    
+    observeEvent(input$login_go, {
+      if(dbGetQuery(pool, paste0(""SELECT exists (SELECT 1 FROM cciss_users WHERE username = '"",input$login_uname,""' LIMIT 1);""))[,1]){
+        dbExecute(pool,paste0(""UPDATE cciss_users SET nsession = nsession + 1 WHERE username = '"",input$login_uname,""';""))
         removeModal()
-      },
-      error = function(e) {
-        login_text$message <- ""Username Exists. Please login or choose a new one.""
-      })
-    }
-  })
-  
-  observeEvent(input$login_go, {
-    if(dbGetQuery(pool, paste0(""SELECT exists (SELECT 1 FROM cciss_users WHERE username = '"",input$login_uname,""' LIMIT 1);""))[,1]){
-      dbExecute(pool,paste0(""UPDATE cciss_users SET nsession = nsession + 1 WHERE username = '"",input$login_uname,""';""))
-      removeModal()
-    }else{
-      login_text$message <- ""Username does not exist.""
-    }
-  })
+      }else{
+        login_text$message <- ""Username does not exist.""
+      }
+    })
+  }
   
   ##hover text for feasibility report
   hoverText <- c(""Species"",""Time Period"",""Percentage of models preciting each feasibility"","
bcgov,CCISS_ShinyApp,fac82fad2826ca6fe0e89f29d0ca7289d857acee,Kiri,kiridaust@gmail.com,2023-09-28T18:16:50Z,Kiri,kiridaust@gmail.com,2023-09-28T18:16:50Z,Fixed find a bec,app/global.R;app/ui.R;data-raw/scripts/create_package_data.R;data/SS.rda,False,True,True,False,17,9,26,"---FILE: app/global.R---
@@ -20,4 +20,5 @@ suppressPackageStartupMessages({
   library(bslib)
 })
 
-source(""./server/tooltip_verbage.R"")
\ No newline at end of file
+source(""./server/tooltip_verbage.R"")
+bgc_choices <- SS[grep(""BEC"",Source),BGC]
\ No newline at end of file

---FILE: app/ui.R---
@@ -164,17 +164,23 @@ sidebarhelplink <- function(inputId) {
           id = ""acc""),
           br(),
           hr(style = ""border-top: 1px solid #8f0e7e;""),
-          wellPanel(
-            h3(""Find-a-BEC""),
+          #wellPanel(
             splitLayout(
-              selectInput(""findbec"",""Select BGC"", 
-                          choices = c(NA,subzones_colours_ref$classification), 
+              selectInput(""findbec"",""Find-a-BEC"", 
+                          choices = c(""(N)"",bgc_choices), 
                           multiple = F),
               tagList(br(),
                       actionButton(""findbecclear"",""Clear"")
-              )
-            )
-          )
+              ),
+              tags$head(tags$style(HTML(""
+                              .shiny-split-layout > div {
+                                overflow: visible;
+                              }
+                              "")))
+            ),
+            br(),
+            br()
+          #)
           
           
           

---FILE: data-raw/scripts/create_package_data.R---
@@ -48,7 +48,7 @@ TreeCols <- TreeCols[HexColour != """",]
 save(TreeCols, file = ""./data/TreeCols.rda"")
 
 
-SS <- SS[,.(SS_NoSpace,SpecialCode)]
+SS <- SS[,.(Source, BGC, SS_NoSpace,SpecialCode)]
 SS <- SS[SpecialCode != """",]
 E1 <- SS[E1, on = ""SS_NoSpace""]
 setcolorder(E1,c(""Source"",""BGC"",""SS_NoSpace"",""Edatopic"",""SpecialCode""))
@@ -61,6 +61,7 @@ E1_Phase[,MainUnit := gsub(""[a-z]$"","""",SS_NoSpace)]
 E1_Phase[,MainUnit := gsub(""\\.[1-9]$"","""",MainUnit)]
 use_data(E1_Phase,E1,overwrite = T)
 use_data(S1,E1,N1,overwrite = T)
+use_data(SS, overwrite = T)
 
 R1 <- fread(""./data-raw/data_tables/RuleTable.csv"")
 F1 <- fread(""./data-raw/data_tables/FeasibilityLabels.csv"", key = ""SuitDiff"")"
bcgov,CCISS_ShinyApp,a77dc9b1e8655f91200d90cec4a428aa58730c6a,Kiri Daust,kiridaust@gmail.com,2022-03-29T20:52:29Z,Kiri Daust,kiridaust@gmail.com,2022-03-29T20:52:29Z,Fixes,ProvincialFeasibility.R,False,True,True,False,26,11,37,"---FILE: ProvincialFeasibility.R---
@@ -25,7 +25,7 @@ sppDb <- dbPool(
 ##adapted feasibility function
 cciss_feasibility <- function(SSPred,suit,spp_select){
   
-  suit <- suit[Spp == spp_select,.(BGC,SS_NoSpace,Spp,Feasible)]
+  suit <- suit[Spp %chin% spp_select,.(BGC,SS_NoSpace,Spp,Feasible)]
   suit <- unique(suit)
   suit <- na.omit(suit)
   SSPred <- SSPred[,.(SiteRef,FuturePeriod,BGC,SS_NoSpace,SS.pred,SSprob)]
@@ -35,6 +35,9 @@ cciss_feasibility <- function(SSPred,suit,spp_select){
   setkey(suit,SS_NoSpace)
   suitMerge <- suit[SSPred, allow.cartesian = T]
   suitMerge <- na.omit(suitMerge)
+  if(nrow(suitMerge) < 3){
+    return(NULL)
+  }
   setnames(suitMerge, old = c(""SS_NoSpace"", ""i.SS_NoSpace""), new = c(""SS.pred"", ""SS_NoSpace""))
   suitVotes <- data.table::dcast(suitMerge, SiteRef + Spp + FuturePeriod + SS_NoSpace ~ Feasible, 
                                  value.var = ""SSprob"", fun.aggregate = sum)
@@ -182,19 +185,31 @@ runCCISS <- function(con, bgcSelect, weights, spp_select){
   "")
   
   dat <- setDT(dbGetQuery(con, cciss_sql))
-  setorder(dat, bgc, dist_code, futureperiod, bgc_pred)
-  dat[,SiteRef := paste0(bgc,""_"",dist_code)]
-  setnames(dat, new = c(""FuturePeriod"",""BGC"",""BGC.pred"",""BGC.prop""),
-           old = c(""futureperiod"",""bgc"",""bgc_pred"",""bgc_prop""))
+  if(nrow(dat) < 5){
+    return(NULL)
+  }else{
+    setorder(dat, bgc, dist_code, futureperiod, bgc_pred)
+    dat[,SiteRef := paste0(bgc,""_"",dist_code)]
+    setnames(dat, new = c(""FuturePeriod"",""BGC"",""BGC.pred"",""BGC.prop""),
+             old = c(""futureperiod"",""bgc"",""bgc_pred"",""bgc_prop""))
+    
+    dat <- dat[,.(SiteRef,FuturePeriod,BGC,BGC.pred,BGC.prop)]
+    SSPreds <- edatopicOverlap(dat, E1, E1_Phase, onlyRegular = T)
+    
+    cciss_feas <- cciss_feasibility(SSPreds, S1, spp_select = spp_select)
+    return(cciss_feas)
+  }
   
-  dat <- dat[,.(SiteRef,FuturePeriod,BGC,BGC.pred,BGC.prop)]
-  SSPreds <- edatopicOverlap(dat, E1, E1_Phase, onlyRegular = T)
-  
-  cciss_feas <- cciss_feasibility(SSPreds, S1, spp_select = spp_select)
-  return(cciss_feas)
 }
 
-dat1 <- runCCISS(pool,c(""SBSdk"",""SBSmc2""),weights,""Pl"")
+bgcOpts <- dbGetQuery(pool, ""select distinct bgc from preselected_points"")[,1]
+library(foreach)
+out <- foreach(bgc = bgcOpts, .combine = rbind) %do% {
+  cat(""Processing"",bgc,""\n"")
+  dat1 <- runCCISS(pool,c(bgc),weights,c(""Py"",""Pl"",""Sx""))
+  dat1
+}
+
 
 
 ##setnames(dat, c(""SiteRef"",""FuturePeriod"",""BGC"",""BGC.pred"",""BGC.prop""))"
bcgov,CCISS_ShinyApp,af04b7003623966124eb4c3c2d544f5555cc31d9,Kiri Daust,34073038+kdaust@users.noreply.github.com,2022-03-25T00:19:07Z,Kiri Daust,34073038+kdaust@users.noreply.github.com,2022-03-25T00:19:07Z,Fixed preselected bgc function,R/data_etl.R;data/S1.rda,False,True,True,False,2,2,4,"---FILE: R/data_etl.R---
@@ -168,9 +168,9 @@ dbBbox <- function(con, points, buffer) {
 #' @export
 dbGetBGC <- function(con,bgc,district = NULL,maxPoints){
   if(is.null(district)){
-    query <- paste0(""select siteno from bgc_points where bgc IN ('"",paste(bgc,collapse = ""','""),""') limit "",maxPoints)
+    query <- paste0(""select siteno from bgc_points where bgc IN ('"",paste(bgc,collapse = ""','""),""')"")
   }else{
-    query <- paste0(""select siteno from bgc_points where bgc IN ('"",paste(bgc,collapse = ""','""),""') and dist_code = '"",district,""' limit "",maxPoints)
+    query <- paste0(""select siteno from bgc_points where bgc IN ('"",paste(bgc,collapse = ""','""),""') and dist_code = '"",district,""'"")
   }
   dat <- RPostgres::dbGetQuery(con, query)$siteno
   return(dat)"
bcgov,CCISS_ShinyApp,5227d2487e8dc2689d1a000cdae3302ea108738d,Kiri Daust,kiridaust@gmail.com,2022-01-18T21:33:57Z,Kiri Daust,kiridaust@gmail.com,2022-01-18T21:33:57Z,Fixed bug,CFRG_Review.Rmd,True,False,True,False,2,2,4,"---FILE: CFRG_Review.Rmd---
@@ -210,7 +210,7 @@ reg_cw <- fread(""District_Region_Crosswalk.csv"")
 ```
 
 ```{r, results='asis'}
-dist_select <- ""BUL""
+dist_select <- ""DQU""
 bgcFlags <- list()
 bgc_opts <- dbGetQuery(pool,paste0(""select distinct bgc from preselected_points where dist_code = '"",dist_select,""'""))[,1]
 for(bgc_select in bgc_opts){
@@ -310,7 +310,7 @@ for(bgc_select in bgc_opts){
     ssnum = 1
     for(siteserie in siteseries){
         s1 <- stocking_standards[
-          Region %in% f1$Region & ZoneSubzone %in% f1$ZoneSubzone & SS_NoSpace %in% f1$SS_NoSpace
+          Region %in% feasSum$Region & ZoneSubzone %in% feasSum$ZoneSubzone & SS_NoSpace %in% feasSum$SS_NoSpace
         ]
         if(nrow(s1) > 0){
           cat(""\n"")"
bcgov,CCISS_ShinyApp,fab92e0b275e980a553242db33e89de8d0a3917a,Kiri Daust,kiridaust@gmail.com,2022-01-18T19:26:31Z,Kiri Daust,kiridaust@gmail.com,2022-01-18T19:26:31Z,Fixed report,app/server/download.R;app/server/reporthtml.Rmd;app/server/reportpdf.Rmd,True,True,True,False,3,2,5,"---FILE: app/server/download.R---
@@ -20,6 +20,7 @@ output$report_download <- downloadHandler(
   content = function(file) {
     uData$site_series_filter <- input$report_filter
     uData$feasibility_filter <- input$report_filter_feas
+    uData$pool <- pool
     withProgress(min = 0, max = 4, value = 1, message = ""Processing report"", {
 
       if (input$report_format == ""html"") {

---FILE: app/server/reporthtml.Rmd---
@@ -80,7 +80,7 @@ if(exists(""pts"") & !exists(""bgc_select"")){
   bgc_select <- NULL
   dist_select <- NULL
 }else{
-  bbox <- st_read(pool, query = paste0(""select ST_Envelope(ST_Collect(geom)) from bgc_map where \""BGC\"" IN ('"",paste(bgc_select,collapse = ""','""),""');""))
+  bbox <- st_read(pool, query = paste0(""select ST_Transform(ST_Envelope(ST_Collect(geom)),4326) from bgc_map3005 where bgc IN ('"",paste(bgc_select,collapse = ""','""),""');""))
   bbox2 <- st_coordinates(bbox)[,1:2]
   indPoints = F
 }

---FILE: app/server/reportpdf.Rmd---
@@ -56,7 +56,7 @@ if(exists(""pts"") & ncol(pts) > 2){
   # Define the reference for points lookup
   pts_ref <- pts[[{if (avg) {""BGC""} else {""Site""}}]]
 }else{
-  bbox <- st_read(pool, query = paste0(""select ST_Envelope(ST_Collect(geom)) from bgc_map where \""BGC\"" IN ('"",paste(bgc_select,collapse = ""','""),""');""))
+  bbox <- st_read(pool, query = paste0(""select ST_Transform(ST_Envelope(ST_Collect(geom)),4326) from bgc_map3005 where bgc IN ('"",paste(bgc_select,collapse = ""','""),""');""))
   bbox2 <- st_coordinates(bbox)[,1:2]
   indPoints = F
 }"
bcgov,CCISS_ShinyApp,611429589a8ee2fc0b186885f647778ac0a4b716,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-11-16T00:06:42Z,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-11-16T00:06:42Z,fix phases,R/data_etl.R;R/eda_overlap.R;app/server/generate.R,False,True,True,False,46,14,60,"---FILE: R/data_etl.R---
@@ -213,7 +213,7 @@ dbGetCCISS <- function(con, siteno, avg, modWeights){
   JOIN bgc_attribution
     ON (cciss_future12_array.siteno = bgc_attribution.siteno),
        unnest(bgc_pred_id) WITH ordinality as source(bgc_pred_id, row_idx)
-  JOIN (SELECT ROW_NUMBER() OVER(ORDER BY gcm, scenario, futureperiod) row_idx,
+  JOIN (SELECT ROW_NUMBER() OVER(ORDER BY gcm_id, scenario_id, futureperiod_id) row_idx,
                gcm,
                scenario,
                futureperiod

---FILE: R/eda_overlap.R---
@@ -132,12 +132,45 @@ edatopicOverlap <- function(BGC,E1,E1_Phase){
   combAll <- combAll[,list(SiteRef, FuturePeriod, BGC, BGC.pred, SS_NoSpace, 
                         allOverlap, SS.pred, BGC.prop)]
   combAll <- na.omit(combAll)
+  combAllSave <- combAll
+  
+  combAll <- merge(combAll,SSsp.out,
+                   by = c(""SiteRef"",""FuturePeriod"",""BGC"",""BGC.pred"",""SS_NoSpace"",""SS.pred""), all = T)
+  temp <- combAll[!is.na(allOverlap.y),]
+  temp[,c(""allOverlap.x"",""BGC.prop.x"") := NULL]
+  setnames(temp,old = c(""allOverlap.y"",""BGC.prop.y""), new = c(""allOverlap"",""BGC.prop""))
+  combAll[,Flag := if(all(is.na(allOverlap.y))) T else F, by = list(SiteRef,FuturePeriod,BGC,SS_NoSpace,BGC.pred)]
+  combAll <- combAll[(Flag),!""Flag""]
+  combAll[,c(""allOverlap.y"",""BGC.prop.y"") := NULL]
+  setnames(combAll,old = c(""allOverlap.x"",""BGC.prop.x""), new = c(""allOverlap"",""BGC.prop""))
+  combAll <- rbind(combAll,temp)
+  combAll[,MainUnit := gsub(""[a-c]$|\\.[1-9]$"","""",SS.pred)]
+  combAll <- combAll[!(BGC == BGC.pred  &  SS_NoSpace != MainUnit),] ### removes overlap where past BGC = future BGC
+  combAll[,MainUnit := NULL]
+  combAll <- unique(combAll[!is.na(SS_NoSpace),])
+  
+  
+  ##add in BGC probability
+  combAll <- na.omit(combAll)
+  combAll[,SSratio := allOverlap/sum(allOverlap), by = list(SiteRef, FuturePeriod, BGC, BGC.pred,SS_NoSpace)] ##should check this?
+  setorder(combAll, SiteRef, FuturePeriod, BGC, BGC.pred, SS_NoSpace)
+  
+  setkey(combAll, SiteRef, FuturePeriod, BGC,BGC.pred)
+  temp <- unique(combAll[,list(SiteRef,FuturePeriod,BGC,BGC.pred,BGC.prop)])
+  temp[,BGC.prop := BGC.prop/sum(BGC.prop), by = list(SiteRef,FuturePeriod,BGC)]
+  temp <- unique(temp)
+  combAll[,BGC.prop := NULL]
+  combAll <- temp[combAll]
+  combAll[,SSprob := SSratio*BGC.prop]
+  combAll <- combAll[!duplicated(combAll),]
+  noPhase <- combAll
+  
   ###########################################################################
   ##now redo for phases
   
   numEdaPh <- E1_Phase[,list(NumEdas = .N), by = list(SS_NoSpace)]
   phaseSmall <- unique(edaPhase[,list(BGC,MainUnit,Phase = SS_NoSpace)])
-  combPhase <- phaseSmall[combAll, on = c(MainUnit = ""SS.pred""), allow.cartesian = T]
+  combPhase <- phaseSmall[combAllSave, on = c(MainUnit = ""SS.pred""), allow.cartesian = T]
   justPhase <- combPhase[!is.na(Phase),]
   curr <- unique(justPhase[,list(SiteRef, FuturePeriod, BGC = i.BGC, BGC.pred, SS_NoSpace)])
   fut <- unique(justPhase[,list(SiteRef, FuturePeriod, BGC = i.BGC, BGC.pred, MainUnit, Phase)])
@@ -169,8 +202,8 @@ edatopicOverlap <- function(BGC,E1,E1_Phase){
                                   SS.pred = MainUnit.y, PhasePred,phaseOverlap = allOverlap)]
   combPhaseAll <- na.omit(combPhaseAll)
   setkey(combPhaseAll,SiteRef,FuturePeriod,BGC,BGC.pred,SS_NoSpace,SS.pred)
-  setkey(combAll,SiteRef,FuturePeriod,BGC,BGC.pred,SS_NoSpace,SS.pred)
-  combAll <- combPhaseAll[combAll]
+  setkey(combAllSave,SiteRef,FuturePeriod,BGC,BGC.pred,SS_NoSpace,SS.pred)
+  combAll <- combPhaseAll[combAllSave]
   ####add phase to non-phase###
   combAll[,PhaseSum := sum(phaseOverlap), by = list(SiteRef,FuturePeriod,BGC,BGC.pred,SS_NoSpace,SS.pred)]
   combAll[,phaseOverlap := phaseOverlap/PhaseSum]
@@ -209,5 +242,5 @@ edatopicOverlap <- function(BGC,E1,E1_Phase){
   combAll[,SSprob := SSratio*BGC.prop]
   combAll <- combAll[!duplicated(combAll),]
   print(""Done EDA"")
-  return(combAll)
+  return(list(phase = combAll, NoPhase = noPhase))
 }

---FILE: app/server/generate.R---
@@ -164,20 +164,19 @@ bgc <- function(con, siteno, avg, modWeights) {
   })
 }
 
-# testSitenos <- as.integer(c(""1247944"", ""1486662"", ""1866401"", ""2275827"", ""3060730"", ""3865683"", 
-# ""5023732"", ""4842832"", ""2761637"", ""2111482"", ""2370320"", ""3013159"", 
-# ""3466294"", ""3716379"", ""4828480"", ""5103315"", ""4638702"", ""3557707"", 
-# ""4055121"", ""2243917"", ""1944094"", ""4125428"", ""4635548"", ""5737786"", 
-# ""5321717"", ""1703309"", ""1338735"", ""1313609"", ""1345347"", ""1741741"", 
-# ""3457355"", ""3606245""))
-# bgc <- dbGetCCISS(pool,siteno = 5402703, avg = T, modWeights = all_weight)
+# bgc <- dbGetCCISS(pool,siteno = 676813, avg = F, modWeights = all_weight)
+# SSPreds <- edatopicOverlap(bgc, E1, E1_Phase)
+# out <- ccissOutput(SSPred = SSPreds, suit = S1, rules = R1, feasFlag = F1,
+#             histWeights = c(0.3,0.35,0.35), futureWeights = rep(0.25,4))
+
 # bgc <- sqlTest(pool,siteno = c(6476259,6477778,6691980,6699297),avg = T, scn = ""ssp370"")
 
 
 cciss <- function(bgc,estabWt,futWt) {
-  SSPred <- edatopicOverlap(bgc, copy(E1), copy(E1_Phase))
+  edaOut <- edatopicOverlap(bgc, copy(E1), copy(E1_Phase))
+  SSPred <- edaOut$NoPhase
   setorder(SSPred,SiteRef,SS_NoSpace,FuturePeriod,BGC.pred,-SSratio)
-  uData$eda_out <- SSPred
+  uData$eda_out <- edaOut$phase
   ccissOutput(SSPred = SSPred, suit = S1, rules = R1, feasFlag = F1, 
               histWeights = estabWt, futureWeights = futWt)
 }"
bcgov,CCISS_ShinyApp,ac82d27651329a6a47e753e16f3db1336be89134,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-11-14T22:44:42Z,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-11-14T22:44:42Z,upload fix,data-raw/scripts/bigshinygisstudio.R,False,True,True,False,1,0,1,"---FILE: data-raw/scripts/bigshinygisstudio.R---
@@ -120,6 +120,7 @@ analogsea::droplet_upload(server, ""./app/server.R"", ""/srv/shiny-server/ccissdev/
 analogsea::droplet_upload(server, ""./app/ui.R"", ""/srv/shiny-server/ccissdev/ui.R"")
 analogsea::droplet_upload(server, ""./app/www"", ""/srv/shiny-server/ccissdev"")
 analogsea::droplet_upload(server, ""./app/server"", ""/srv/shiny-server/ccissdev"")
+analogsea::droplet_upload(server, ""./app/instructions"", ""/srv/shiny-server/ccissdev"")
 analogsea::droplet_ssh(server, ""chown -R shiny:shiny /srv/shiny-server"")
 analogsea::droplet_ssh(server, ""systemctl restart shiny-server"")
 "
bcgov,CCISS_ShinyApp,b529f2ad047db7749362873c3ae473cbb8883bb8,Kiri Daust,kiridaust@gmail.com,2021-11-14T22:35:58Z,Kiri Daust,kiridaust@gmail.com,2021-11-14T22:35:58Z,Fix db error,Provincial_Maps.R;R/data_etl.R;app/server.R;data-raw/scripts/cciss_future_table_downsizing.R,False,True,True,False,62,30,92,"---FILE: Provincial_Maps.R---
@@ -94,7 +94,7 @@ dev.off()
 gcm_weight <- data.table(gcm = c(""ACCESS-ESM1-5"", ""BCC-CSM2-MR"", ""CanESM5"", ""CNRM-ESM2-1"", ""EC-Earth3"", 
                                  ""GFDL-ESM4"", ""GISS-E2-1-G"", ""INM-CM5-0"", ""IPSL-CM6A-LR"", ""MIROC6"", 
                                  ""MPI-ESM1-2-HR"", ""MRI-ESM2-0"", ""UKESM1-0-LL""),
-                         weight = c(1,1,0,1,1,1,1,0,1,1,1,1,0))
+                         weight = c(1,1,0,0,1,1,1,0,1,1,1,1,0))
 
 rcp_weight <- data.table(rcp = c(""ssp126"",""ssp245"",""ssp370"",""ssp585""), 
                          weight = c(0.8,1,0.8,0))
@@ -105,7 +105,7 @@ all_weight[rcp_weight,wrcp := i.weight, on = ""rcp""]
 all_weight[,weight := wgcm*wrcp]
 modWeights <- all_weight
 
-dbGetCCISSv2 <- function(con, modWeights){
+dbGetCCISSv2 <- function(con,timeperiod = ""2041"", modWeights){
   
   groupby = ""siteno""
   modWeights[,comb := paste0(""('"",gcm,""','"",rcp,""',"",weight,"")"")]
@@ -128,19 +128,20 @@ dbGetCCISSv2 <- function(con, modWeights){
   INNER JOIN pts2km_ids
     ON pts2km_ids.siteno = cciss_future12_array.siteno,
        unnest(bgc_pred_id) WITH ordinality as source(bgc_pred_id, row_idx)
-  JOIN (SELECT ROW_NUMBER() OVER() row_idx,
+  JOIN (SELECT ROW_NUMBER() OVER(ORDER BY gcm, scenario, futureperiod) row_idx,
                gcm,
                scenario,
                futureperiod
         FROM gcm 
         CROSS JOIN scenario
-        CROSS JOIN futureperiod where futureperiod IN ('2021','2041','2061','2081')) labels
+        CROSS JOIN futureperiod) labels
     ON labels.row_idx = source.row_idx
     JOIN (values "",weights,"") 
     AS w(gcm,scenario,weight)
     ON labels.gcm = w.gcm AND labels.scenario = w.scenario
   JOIN bgc
     ON bgc.bgc_id = source.bgc_pred_id
+    WHERE futureperiod = '"",timeperiod,""'
   
   ), cciss_count_den AS (
   
@@ -171,7 +172,7 @@ dbGetCCISSv2 <- function(con, modWeights){
   JOIN cciss_count_den b
     ON a.siteref = b.siteref
    AND a.futureperiod = b.futureperiod
-   WHERE a.w <> 0 AND a.futureperiod = '2041'"")
+   WHERE a.w <> 0"")
   
   dat2 <- setDT(RPostgres::dbGetQuery(con, cciss_sql))
   
@@ -221,7 +222,7 @@ ccissMap <- function(SSPred,suit,spp_select){
 
 ###load up bgc predictions data
 
-bgc <- dbGetCCISSv2(con,all_weight) ##takes about 5 mins
+bgc <- dbGetCCISSv2(con,""2041"", all_weight) ##takes about 5 mins
 
 
 ##figure 3c (mean change in feasibiltiy)
@@ -233,7 +234,7 @@ ColScheme <- c(brewer.pal(11,""RdBu"")[c(1,2,3,4,4)], ""grey50"", brewer.pal(11,""RdB
 timeperiods <- ""2041-2060""
 edaPos <- ""C4""
 edaTemp <- data.table::copy(E1)
-edaTemp <- edaTemp %>% filter(is.na(SpecialCode))
+edaTemp <- edaTemp[is.na(SpecialCode),]
 
 edaTemp[,HasPos := if(any(Edatopic == edaPos)) T else F, by = .(SS_NoSpace)]
 edaZonal <- edaTemp[(HasPos),]
@@ -314,7 +315,7 @@ ColScheme <- c(brewer.pal(11,""RdBu"")[c(1:4)], ""grey50"",""grey99"", brewer.pal(11,""
 # addret2 <- addret[SiteRef %in% pts$rast_id,]
 
 
-for(spp in c(""Cw"", ""Yc"", ""Oa"", ""Yp"")){ ##ignore warnings,""Fd"",""Sx"",""Pl"", ""Yc""
+for(spp in c(""Cw"", ""Fd"",""Sx"",""Pl"", ""Yc"")){ ##ignore warnings,""Fd"",""Sx"",""Pl"", ""Yc""
   cat(""Plotting "",spp,""\n"")
   addret <- add_retreat(SSPreds,S1,spp) ##~ 15 seconds
   addret[Flag == ""Same"",PropMod := 0]

---FILE: R/data_etl.R---
@@ -213,20 +213,21 @@ dbGetCCISS <- function(con, siteno, avg, modWeights){
   JOIN bgc_attribution
     ON (cciss_future12_array.siteno = bgc_attribution.siteno),
        unnest(bgc_pred_id) WITH ordinality as source(bgc_pred_id, row_idx)
-  JOIN (SELECT ROW_NUMBER() OVER() row_idx,
+  JOIN (SELECT ROW_NUMBER() OVER(ORDER BY gcm, scenario, futureperiod) row_idx,
                gcm,
                scenario,
                futureperiod
         FROM gcm 
         CROSS JOIN scenario
-        CROSS JOIN futureperiod where futureperiod IN ('2021','2041','2061','2081')) labels
+        CROSS JOIN futureperiod) labels
     ON labels.row_idx = source.row_idx
     JOIN (values "",weights,"") 
     AS w(gcm,scenario,weight)
     ON labels.gcm = w.gcm AND labels.scenario = w.scenario
   JOIN bgc
     ON bgc.bgc_id = source.bgc_pred_id
   WHERE cciss_future12_array.siteno IN ("", paste(unique(siteno), collapse = "",""), "")
+  AND futureperiod IN ('2021','2041','2061','2081')
   
   ), cciss_count_den AS (
   

---FILE: app/server.R---
@@ -60,7 +60,7 @@ edaGrid[,Col := ""grey""]
 gcm_weight <- data.table(gcm = c(""ACCESS-ESM1-5"", ""BCC-CSM2-MR"", ""CanESM5"", ""CNRM-ESM2-1"", ""EC-Earth3"", 
                                  ""GFDL-ESM4"", ""GISS-E2-1-G"", ""INM-CM5-0"", ""IPSL-CM6A-LR"", ""MIROC6"", 
                                  ""MPI-ESM1-2-HR"", ""MRI-ESM2-0"", ""UKESM1-0-LL""),
-                         weight = c(1,1,0,1,1,1,1,0,1,1,1,1,0))
+                         weight = c(1,1,0,0,1,1,1,0,1,1,1,1,0))
 
 rcp_weight <- data.table(rcp = c(""ssp126"",""ssp245"",""ssp370"",""ssp585""), 
                          weight = c(0.8,1,0.8,0))

---FILE: data-raw/scripts/cciss_future_table_downsizing.R---
@@ -260,12 +260,37 @@ dbGetQuery(conn, ""SELECT pg_total_relation_size('cciss_future12_array')"") /
 # pg_total_relation_size
 # 1             0.01450527
 
-dbGetQuery(conn, ""SELECT ROW_NUMBER() OVER() row_idx, gcm, scenario, futureperiod FROM gcm CROSS JOIN scenario CROSS JOIN futureperiod"")
+testLabel <- dbGetQuery(conn, ""SELECT ROW_NUMBER() OVER(ORDER BY gcm, scenario, futureperiod) row_idx, gcm, scenario, futureperiod FROM gcm CROSS JOIN scenario CROSS JOIN futureperiod"")
 
-siteno <- ""240500""
+siteno <- ""2318928""
+
+testLabel <- dbGetQuery(conn, ""SELECT gcm, scenario, futureperiod FROM futureperiod CROSS JOIN scenario CROSS JOIN gcm"")
+
+# Example on how to transform into original cciss_future12
+dt1 <- setDT(dbGetQuery(conn, ""
+           SELECT siteno,
+         labels.gcm,
+         labels.scenario,
+         labels.futureperiod,
+         bgc.bgc
+  FROM cciss_future12_array,
+       unnest(bgc_pred_id) WITH ordinality as source(bgc_pred_id, row_idx)
+  JOIN (SELECT ROW_NUMBER() OVER(ORDER BY gcm, scenario, futureperiod) row_idx,
+               gcm,
+               scenario,
+               futureperiod
+        FROM gcm 
+        CROSS JOIN scenario
+        CROSS JOIN futureperiod) labels
+    ON labels.row_idx = source.row_idx
+  JOIN bgc
+    ON bgc.bgc_id = source.bgc_pred_id
+  WHERE siteno = 1942688 AND futureperiod IN ('2021','2041','2061','2081')""))
 # Example on how to transform into original cciss_future12
-dt1 <- dbGetQuery(conn, paste0(""
-  SELECT cciss_future12_array.siteno,
+
+modWeights[,comb := paste0(""('"",gcm,""','"",rcp,""',"",weight,"")"")]
+weights <- paste(modWeights$comb,collapse = "","")
+dt1 <- dbGetQuery(conn, paste0(""SELECT cciss_future12_array.siteno,
          labels.gcm,
          labels.scenario,
          labels.futureperiod,
@@ -276,39 +301,44 @@ dt1 <- dbGetQuery(conn, paste0(""
   JOIN bgc_attribution
     ON (cciss_future12_array.siteno = bgc_attribution.siteno),
        unnest(bgc_pred_id) WITH ordinality as source(bgc_pred_id, row_idx)
-  JOIN (SELECT ROW_NUMBER() OVER() row_idx,
+  JOIN (SELECT ROW_NUMBER() OVER(ORDER BY gcm, scenario, futureperiod) row_idx,
                gcm,
                scenario,
                futureperiod
         FROM gcm 
         CROSS JOIN scenario
-        CROSS JOIN futureperiod where futureperiod IN ('2021','2041','2061','2081')) labels
+        CROSS JOIN futureperiod) labels
     ON labels.row_idx = source.row_idx
     JOIN (values "",weights,"") 
     AS w(gcm,scenario,weight)
     ON labels.gcm = w.gcm AND labels.scenario = w.scenario
   JOIN bgc
     ON bgc.bgc_id = source.bgc_pred_id
   WHERE cciss_future12_array.siteno IN ("", paste(unique(siteno), collapse = "",""), "")
-""))
+  AND futureperiod IN ('2021','2041','2061','2081')""))
 
-dt1 <- dbGetQuery(conn, paste0(""
-  SELECT *
+dt3 <- dbGetQuery(conn,""SELECT *
   FROM cciss_future12_array,
-       unnest(bgc_pred_id) WITH ordinality as source(bgc_pred_id, row_idx)
-  WHERE siteno IN ("", paste(unique(siteno), collapse = "",""), "")
-""))
+       unnest(bgc_pred_id) WITH ordinality as source(bgc_pred_id, row_idx) where siteno = 2318928"")
 
-""JOIN (values "",weights,"") 
-AS w(gcm,scenario,weight)
-ON cciss_future12.gcm = w.gcm AND cciss_future12.scenario = w.scenario""
+dt4 <- dbGetQuery(conn,""SELECT 
+               futureperiod,
+               scenario,
+               gcm
+        FROM futureperiod 
+        CROSS JOIN scenario
+        CROSS JOIN gcm"")
 
-dt2 <- dbGetQuery(conn, ""
+dt2 <- setDT(dbGetQuery(conn, ""
   SELECT siteno,
          gcm,
          scenario,
          futureperiod,
-         bgc_pred bgc
+         bgc_pred
   FROM cciss_future12
-  WHERE siteno = 240500
-  ORDER BY siteno, gcm, scenario, futureperiod"")
+  WHERE siteno = 1942688""))
+
+dt2[,futureperiod := substr(futureperiod,1,4)]
+
+dt2[dt1,XPred := i.bgc, on = c(""siteno"",""gcm"",""scenario"",""futureperiod"")]
+dt2[,Same := bgc_pred == XPred]"
bcgov,CCISS_ShinyApp,9ede80160b5693a66f8ba72f9fb18d079e5edb08,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-11-14T00:58:34Z,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-11-14T00:58:34Z,Minor fix,Provincial_Maps.R,False,True,True,False,24,22,46,"---FILE: Provincial_Maps.R---
@@ -9,6 +9,8 @@ library(tictoc)
 library(rasterVis)
 library(raster)
 library(ccissdev)
+library(RPostgreSQL)
+library(sf)
 
 ##some setup
 drv <- dbDriver(""PostgreSQL"")
@@ -67,24 +69,24 @@ outline <- st_read(con,query = ""select * from bc_outline"")
 ##########################################################
 
 ##make projected bgc maps - can skip this part
-scn <- ""ssp245"";fp <- ""2021-2040"";gcm <- ""EC-Earth3"" ##select options
-dat <- dbGetQuery(con,paste0(""select rast_id, bgc_pred from pts2km_future where gcm = '"",gcm,""' and scenario = '"",
-                             scn,""' and futureperiod = '"",fp,""'""))
-setDT(dat)
-bgcs <- unique(dat$bgc_pred)
-bgcID <- data.table(bgc = bgcs, id = 1:length(bgcs))
-cols <- subzones_colours_ref
-dat[cols,Col := i.colour, on = c(bgc_pred = ""classification"")]
-dat[bgcID,bgcID := i.id, on = c(bgc_pred = ""bgc"")]
-
-X[dat$rast_id] <- dat$bgcID
-X2 <- ratify(X)
-rat <- as.data.table(levels(X2)[[1]])
-rat[dat,`:=`(bgc = i.bgc_pred, col = i.Col), on = c(ID = ""bgcID"")]
-pdf(file=paste0(""./BGCFuturesMaps/BGC_Projections"",gcm,fp,scn,"".pdf""), width=6.5, height=7, pointsize=10)
-plot(X2,col = rat$col,legend = FALSE,axes = FALSE, box = FALSE, main = paste0(gcm,"" ("",fp,"", "",scn,"")""))
-plot(outline, col = NA, add = T)
-dev.off()
+# scn <- ""ssp245"";fp <- ""2021-2040"";gcm <- ""EC-Earth3"" ##select options
+# dat <- dbGetQuery(con,paste0(""select rast_id, bgc_pred from pts2km_future where gcm = '"",gcm,""' and scenario = '"",
+#                              scn,""' and futureperiod = '"",fp,""'""))
+# setDT(dat)
+# bgcs <- unique(dat$bgc_pred)
+# bgcID <- data.table(bgc = bgcs, id = 1:length(bgcs))
+# cols <- subzones_colours_ref
+# dat[cols,Col := i.colour, on = c(bgc_pred = ""classification"")]
+# dat[bgcID,bgcID := i.id, on = c(bgc_pred = ""bgc"")]
+# 
+# X[dat$rast_id] <- dat$bgcID
+# X2 <- ratify(X)
+# rat <- as.data.table(levels(X2)[[1]])
+# rat[dat,`:=`(bgc = i.bgc_pred, col = i.Col), on = c(ID = ""bgcID"")]
+# pdf(file=paste0(""./BGCFuturesMaps/BGC_Projections"",gcm,fp,scn,"".pdf""), width=6.5, height=7, pointsize=10)
+# plot(X2,col = rat$col,legend = FALSE,axes = FALSE, box = FALSE, main = paste0(gcm,"" ("",fp,"", "",scn,"")""))
+# plot(outline, col = NA, add = T)
+# dev.off()
 
 ##cciss feasibility
 ##script to process 4km subsampled data and create feasibility ratings
@@ -224,7 +226,7 @@ labels <- c(""-3"",""-2"", ""-1"", ""no change"", ""+1"",""+2"",""+3"")
 ColScheme <- c(brewer.pal(11,""RdBu"")[c(1,2,3,4,4)], ""grey80"", brewer.pal(11,""RdBu"")[c(7,8,8,9,10,11)]); length(ColScheme)
 
 timeperiods <- ""2041-2060""
-bgc <- dbGetCCISSv2(con,all_weight) ##takes about 1.5 mins
+bgc <- dbGetCCISSv2(con,all_weight) ##takes about 5 mins
 edaPos <- ""C4""
 edaTemp <- data.table::copy(E1)
 edaTemp[,HasPos := if(any(Edatopic == edaPos)) T else F, by = .(SS_NoSpace)]
@@ -302,15 +304,15 @@ labels <- c(""Retreat"", ""Expansion"")
 ColScheme <- c(brewer.pal(11,""RdBu"")[c(1:4)], ""grey90"",""grey90"", brewer.pal(11,""RdBu"")[c(8:11)]); length(ColScheme)
 
 # ##testing
-pts <- dbGetQuery(con,""select rast_id from pts2km_ids where siteno in (select siteno from preselected_points where bgc = 'BWBSdk')"")
-addret2 <- addret[SiteRef %in% pts$rast_id,]
+# pts <- dbGetQuery(con,""select rast_id from pts2km_ids where siteno in (select siteno from preselected_points where bgc = 'BWBSdk')"")
+# addret2 <- addret[SiteRef %in% pts$rast_id,]
 
 
 for(spp in c(""Cw"",""Fd"",""Sx"",""Pl"", ""Yc"")){ ##ignore warnings
   cat(""Plotting "",spp,""\n"")
   addret <- add_retreat(SSPreds,S1,spp) ##~ 15 seconds
-  addret <- addret[addret[, .I[which.max(abs(PropMod))], by= .(SiteRef)]$V1]
   addret[Flag == ""Same"",PropMod := 0]
+  addret <- addret[addret[, .I[which.max(abs(PropMod))], by= .(SiteRef)]$V1]
   X <- raster::setValues(X,NA)
   X[addret$SiteRef] <- addret$PropMod
   png(file=paste(""./FeasibilityMaps/Add_Retreat"",timeperiods,spp,"".png"",sep = ""_""), type=""cairo"", units=""in"", width=6.5, height=7, pointsize=10, res=800)"
bcgov,CCISS_ShinyApp,214863f1cb13061f008b59ef30128617941eb9cf,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-11-13T22:54:08Z,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-11-13T22:54:08Z,Bunch of fixes,Provincial_Maps.R,False,True,True,False,46,26,72,"---FILE: Provincial_Maps.R---
@@ -103,25 +103,42 @@ all_weight[rcp_weight,wrcp := i.weight, on = ""rcp""]
 all_weight[,weight := wgcm*wrcp]
 modWeights <- all_weight
 
-##function to process data in postgres
-dbGetCCISS_4km <- function(con, period = ""2041-2060"", modWeights){
+dbGetCCISSv2 <- function(con, modWeights){
   
+  groupby = ""siteno""
   modWeights[,comb := paste0(""('"",gcm,""','"",rcp,""',"",weight,"")"")]
   weights <- paste(modWeights$comb,collapse = "","")
-  groupby = ""rast_id""
+  
   ##cciss_future is now test_future  
   cciss_sql <- paste0(""
   WITH cciss AS (
-    SELECT rast_id,
-           futureperiod,
-           bgc,
-           bgc_pred,
-           w.weight
-    FROM pts2km_future
+    SELECT
+          pts2km_ids.rast_id siteno,
+         labels.gcm,
+         labels.scenario,
+         labels.futureperiod,
+         bgc_attribution.bgc,
+         bgc.bgc bgc_pred,
+         w.weight
+  FROM cciss_future12_array
+  JOIN bgc_attribution
+    ON (cciss_future12_array.siteno = bgc_attribution.siteno)
+  INNER JOIN pts2km_ids
+    ON pts2km_ids.siteno = cciss_future12_array.siteno,
+       unnest(bgc_pred_id) WITH ordinality as source(bgc_pred_id, row_idx)
+  JOIN (SELECT ROW_NUMBER() OVER() row_idx,
+               gcm,
+               scenario,
+               futureperiod
+        FROM gcm 
+        CROSS JOIN scenario
+        CROSS JOIN futureperiod where futureperiod IN ('2021','2041','2061','2081')) labels
+    ON labels.row_idx = source.row_idx
     JOIN (values "",weights,"") 
     AS w(gcm,scenario,weight)
-    ON pts2km_future.gcm = w.gcm AND pts2km_future.scenario = w.scenario
-    WHERE futureperiod IN ('"",period,""')
+    ON labels.gcm = w.gcm AND labels.scenario = w.scenario
+  JOIN bgc
+    ON bgc.bgc_id = source.bgc_pred_id
   
   ), cciss_count_den AS (
   
@@ -152,20 +169,16 @@ dbGetCCISS_4km <- function(con, period = ""2041-2060"", modWeights){
   JOIN cciss_count_den b
     ON a.siteref = b.siteref
    AND a.futureperiod = b.futureperiod
-   WHERE a.w <> 0
-  "")
+   WHERE a.w <> 0 AND a.futureperiod = '2041'"")
   
-  dat <- setDT(RPostgres::dbGetQuery(con, cciss_sql))
+  dat2 <- setDT(RPostgres::dbGetQuery(con, cciss_sql))
   
-  setnames(dat, c(""SiteRef"",""FuturePeriod"",""BGC"",""BGC.pred"",""BGC.prop""))
-  dat <- unique(dat) ##should fix database so not necessary
+  setnames(dat2, c(""SiteRef"",""FuturePeriod"",""BGC"",""BGC.pred"",""BGC.prop""))
+  dat2 <- unique(dat2) ##should fix database so not necessary
   #print(dat)
-  return(dat)
+  return(dat2)
 }
 
-
-
-
 ##adapted feasibility function
 ccissMap <- function(SSPred,suit,spp_select){
   ### generate raw feasibility ratios
@@ -211,9 +224,12 @@ labels <- c(""-3"",""-2"", ""-1"", ""no change"", ""+1"",""+2"",""+3"")
 ColScheme <- c(brewer.pal(11,""RdBu"")[c(1,2,3,4,4)], ""grey80"", brewer.pal(11,""RdBu"")[c(7,8,8,9,10,11)]); length(ColScheme)
 
 timeperiods <- ""2041-2060""
-bgc <- dbGetCCISS_4km(con,timeperiods,all_weight) ##takes about 1.5 mins
+bgc <- dbGetCCISSv2(con,all_weight) ##takes about 1.5 mins
 edaPos <- ""C4""
-edaZonal <- E1[Edatopic == edaPos,]
+edaTemp <- data.table::copy(E1)
+edaTemp[,HasPos := if(any(Edatopic == edaPos)) T else F, by = .(SS_NoSpace)]
+edaZonal <- edaTemp[(HasPos),]
+edaZonal[,HasPos := NULL]
 ##edatopic overlap
 SSPreds <- edatopicOverlap(bgc,edaZonal,E1_Phase) ##takes about 30 seconds
 #SSPreds <- SSPreds[grep(""01$|h$|00$"",SS_NoSpace),] ##note that all below plots are reusing this SSPreds data
@@ -272,8 +288,8 @@ add_retreat <- function(SSPred,suit,spp_select){
   suitMerge[!is.na(OrigFeas) & is.na(PredFeas),Flag := ""Retreat""]
   suitMerge[!is.na(OrigFeas) & !is.na(PredFeas),Flag := ""Same""]
   suitMerge[is.na(OrigFeas) & is.na(PredFeas),Flag := ""Same""]
-  suitMerge[,PropMod := sum(SSprob), by = .(SiteRef,Flag)]
-  suitMerge[,PropAll := sum(SSprob), by = .(SiteRef)]
+  suitMerge[,PropMod := sum(SSprob), by = .(SiteRef,FuturePeriod, Flag)]
+  suitMerge[,PropAll := sum(SSprob), by = .(SiteRef,FuturePeriod)]
   suitMerge[,PropMod := PropMod/PropAll]
   suitRes <- unique(suitMerge[,.(SiteRef,Flag,PropMod)])
   suitRes[,SiteRef := as.integer(SiteRef)]
@@ -283,14 +299,18 @@ add_retreat <- function(SSPred,suit,spp_select){
 
 breakpoints <- seq(-1,1,0.2); length(breakpoints)
 labels <- c(""Retreat"", ""Expansion"")
-ColScheme <- c(brewer.pal(11,""RdBu"")[c(1:4)], ""grey90"", brewer.pal(11,""RdBu"")[c(7:11)]); length(ColScheme)
+ColScheme <- c(brewer.pal(11,""RdBu"")[c(1:4)], ""grey90"",""grey90"", brewer.pal(11,""RdBu"")[c(8:11)]); length(ColScheme)
+
+# ##testing
+pts <- dbGetQuery(con,""select rast_id from pts2km_ids where siteno in (select siteno from preselected_points where bgc = 'BWBSdk')"")
+addret2 <- addret[SiteRef %in% pts$rast_id,]
 
 
 for(spp in c(""Cw"",""Fd"",""Sx"",""Pl"", ""Yc"")){ ##ignore warnings
   cat(""Plotting "",spp,""\n"")
   addret <- add_retreat(SSPreds,S1,spp) ##~ 15 seconds
-  addret[Flag == ""Same"",PropMod := 0]
   addret <- addret[addret[, .I[which.max(abs(PropMod))], by= .(SiteRef)]$V1]
+  addret[Flag == ""Same"",PropMod := 0]
   X <- raster::setValues(X,NA)
   X[addret$SiteRef] <- addret$PropMod
   png(file=paste(""./FeasibilityMaps/Add_Retreat"",timeperiods,spp,"".png"",sep = ""_""), type=""cairo"", units=""in"", width=6.5, height=7, pointsize=10, res=800)"
bcgov,CCISS_ShinyApp,fdcecc945987f9a21afc94fe99a3e022d9060a81,Kiri Daust,kiridaust@gmail.com,2021-11-10T20:04:33Z,Kiri Daust,kiridaust@gmail.com,2021-11-10T20:04:33Z,Fix CFRG,CFRG_Review.Rmd,True,False,True,False,109,97,206,"---FILE: CFRG_Review.Rmd---
@@ -39,7 +39,7 @@ all_weight[,weight := wgcm*wrcp]
 standardblocks <- function(data, siteref, siteserie) {
   sc <- data[
     SiteRef %in% siteref & SS_NoSpace %in% siteserie,
-    list(Region, ZoneSubzone, SS_NoSpace, ccissSuit,Improve,PrefAcc, Spp)
+    list(Region, ZoneSubzone, SS_NoSpace, ccissSuit,Improve,PrefAcc,Spp)
   ]
   ss <- stocking_standards[
     Region %in% sc$Region & ZoneSubzone %in% sc$ZoneSubzone & SS_NoSpace %in% sc$SS_NoSpace
@@ -68,101 +68,101 @@ standardblock <- function(std, ss, sc) {
   list(
     tags$small(""Forest Region: "", tags$b(si$Region, .noWS = c(""before"", ""after"")), .noWS = ""inside""),
     tags$table(width = ""100%"", style = ""white-space: nowrap;"",
-      # Report formatting gray out the first row, so faking a row
-      tags$tr(
-        tags$td(width = ""50%"", style = ""vertical-align: top; padding:0; background-color:white; border:none"",
-          tags$small(tags$b(""Regeneration"")),
-          tags$hr(style = ""padding: 0; margin: 0 0 3px 0; height: 2px; background-color: darkgreen; border: 0px""),
-          tags$table(
-            width = ""100%"",
-            tags$tr(
-              tags$td(tags$b(""Standards ID"")),
-              tags$td(tags$b(paste(ss[!is.na(Standard), unique(Standard)], collapse = "", ""))),
-              tags$td(tags$b(""Climate Change""))
-            ),
-            tags$tr(
-              tags$td(""Primary""),
-              ss[!is.na(Species) & Suitability %in% 1L, sppnotes(Species, Footnotes, TextStyle)],
-              sc[!is.na(Spp) & ccissSuit %in% ""1"", sppnotes_cciss(Spp,TxtCciss)]
-              #tags$td(paste(sc[!is.na(Spp) & ccissSuit %in% ""1"", unique(Spp)], collapse = "", ""))
-            ),
-            tags$tr(
-              tags$td(""Preferred (p)""),
-              ss[!is.na(Species) & PreferredAcceptable %in% ""P"", sppnotes(Species, Footnotes, TextStyle)],
-              sc[!is.na(Spp) & PrefAcc %in% ""P"", sppnotes_cciss(Spp,TxtCciss)],
-              tags$td("""")
-            ),
-            tags$tr(
-              tags$td(""Secondary""),
-              ss[!is.na(Species) & Suitability %in% 2L, sppnotes(Species, Footnotes, TextStyle)],
-              sc[!is.na(Spp) & ccissSuit %in% ""2"", sppnotes_cciss(Spp,TxtCciss)]
-              #tags$td(paste(sc[!is.na(Spp) & ccissSuit %in% ""2"", unique(Spp)], collapse = "", ""))
-            ),
-            tags$tr(
-              tags$td(""Acceptable (a)""),
-              ss[!is.na(Species) & PreferredAcceptable %in% ""A"", sppnotes(Species, Footnotes, TextStyle)],
-              sc[!is.na(Spp) & PrefAcc %in% ""A"", sppnotes_cciss(Spp,TxtCciss)],
-              tags$td("""")
-            ),
-            tags$tr(
-              tags$td(""Tertiary""),
-              ss[!is.na(Species) & Suitability %in% 3L, sppnotes(Species, Footnotes, TextStyle)],
-              sc[!is.na(Spp) & ccissSuit %in% ""3"", sppnotes_cciss(Spp,TxtCciss)]
-
-              #tags$td(paste(sc[!is.na(Spp) & ccissSuit %in% ""3"", unique(Spp)], collapse = "", ""))
-            )
-          )
-        ),
-        tags$td(width = ""50%"", style = ""vertical-align: top; padding:0px 0px 0px 8px; background-color:white; border:none"",
-          tags$small(tags$b(""Stocking (i) - well spaced/ha"")),
-          tags$hr(style = ""padding: 0; margin: 0 0 3px 0; height: 2px; background-color: darkgreen; border: 0px""),
-          tags$table(
-            width = ""100%"",
-            tags$tr(
-              tags$td(tags$b(""Target"")),
-              tags$td(tags$b(""Min pa"")),
-              tags$td(tags$b(""Min p"")),
-              tags$td(tags$b(""Regen Delay (max yrs)""))
-            ),
-            tags$tr(
-              tags$td(si$StockingTarget),
-              tags$td(si$StockingMINpa),
-              tags$td(si$StockingMINp),
-              tags$td(si$StockingDelay)
-            )
-          ),
-          tags$br(),
-          tags$small(tags$b(""Free Growing Guide"")),
-          tags$hr(style = ""padding: 0; margin: 0 0 3px 0; height: 2px; background-color: #003366; border: 0px""),
-          tags$table(
-            width = ""100%"",
-            tags$tr(
-              tags$td(tags$b(""Earliest (yrs)"")),
-              tags$td(tags$b(""Latest(yrs)"")),
-              tags$td(tags$b(""Min Height (m)"")),
-              tags$td(tags$b(""Min Height (m)""))
-            ),
-            tags$tr(
-              tags$td(si$AssessmentEarliest),
-              tags$td(si$AssessmentLatest),
-              tags$td(style = ""white-space: normal;"", sh[!Flag %in% TRUE, paste(Species, Height, sep = "": "", collapse = "", "")]),
-              tags$td(style = ""white-space: normal;"", sh[Flag %in% TRUE, paste(Species, Height, sep = "": "", collapse = "", "")])
-            )
-          )
-        )
-      ),
-      tags$tr(
-        tags$td(colspan = ""2"", style = ""white-space:normal; vertical-align: top; padding:0; background-color:white; border:none"",
-          tags$small(tags$b(""Footnotes"")),
-          tags$hr(style = ""padding: 0; margin: 0 0 3px 0; height: 2px; background-color: #003366; border: 0px""),
-          {
-            fn <- ss[PreferredAcceptable %in% c(""A"", ""P"") | Suitability %in% 1:3, sort(as.integer(unique(unlist(Footnotes))))]
-            fnt <- footnotes[match(fn, `Revised Footnote`), `Revised Footnote Text`]
-            fnshiny <- mapply(function(footnote, text) {list(tags$sup(footnote), tags$small(text), tags$br())}, fn, fnt, SIMPLIFY = FALSE, USE.NAMES = FALSE)
-            do.call(span, fnshiny)
-          }
-        )
-      )
+               # Report formatting gray out the first row, so faking a row
+               tags$tr(
+                 tags$td(width = ""50%"", style = ""vertical-align: top; padding:0; background-color:white; border:none"",
+                         tags$small(tags$b(""Regeneration"")),
+                         tags$hr(style = ""padding: 0; margin: 0 0 3px 0; height: 2px; background-color: darkgreen; border: 0px""),
+                         tags$table(
+                           width = ""100%"",
+                           tags$tr(
+                             tags$td(tags$b(""Standards ID"")),
+                             tags$td(tags$b(paste(ss[!is.na(Standard), unique(Standard)], collapse = "", ""))),
+                             tags$td(tags$b(""Climate Change""))
+                           ),
+                           tags$tr(
+                             tags$td(""Primary""),
+                             ss[!is.na(Species) & Suitability %in% 1L, sppnotes(Species, Footnotes, TextStyle)],
+                             sc[!is.na(Spp) & ccissSuit %in% ""1"", sppnotes_cciss(Spp,TxtCciss)]
+                             #tags$td(paste(sc[!is.na(Spp) & ccissFeas %in% ""1"", unique(Spp)], collapse = "", ""))
+                           ),
+                           tags$tr(
+                             tags$td(""Preferred (p)""),
+                             ss[!is.na(Species) & PreferredAcceptable %in% ""P"", sppnotes(Species, Footnotes, TextStyle)],
+                             sc[!is.na(Spp) & PrefAcc %in% ""P"", sppnotes_cciss(Spp,TxtCciss)],
+                             tags$td("""")
+                           ),
+                           tags$tr(
+                             tags$td(""Secondary""),
+                             ss[!is.na(Species) & Suitability %in% 2L, sppnotes(Species, Footnotes, TextStyle)],
+                             sc[!is.na(Spp) & ccissSuit %in% ""2"", sppnotes_cciss(Spp,TxtCciss)]
+                             #tags$td(paste(sc[!is.na(Spp) & ccissFeas %in% ""2"", unique(Spp)], collapse = "", ""))
+                           ),
+                           tags$tr(
+                             tags$td(""Acceptable (a)""),
+                             ss[!is.na(Species) & PreferredAcceptable %in% ""A"", sppnotes(Species, Footnotes, TextStyle)],
+                             sc[!is.na(Spp) & PrefAcc %in% ""A"", sppnotes_cciss(Spp,TxtCciss)],
+                             tags$td("""")
+                           ),
+                           tags$tr(
+                             tags$td(""Tertiary""),
+                             ss[!is.na(Species) & Suitability %in% 3L, sppnotes(Species, Footnotes, TextStyle)],
+                             sc[!is.na(Spp) & ccissSuit %in% ""3"", sppnotes_cciss(Spp,TxtCciss)]
+                             
+                             #tags$td(paste(sc[!is.na(Spp) & ccissFeas %in% ""3"", unique(Spp)], collapse = "", ""))
+                           )
+                         )
+                 ),
+                 tags$td(width = ""50%"", style = ""vertical-align: top; padding:0px 0px 0px 8px; background-color:white; border:none"",
+                         tags$small(tags$b(""Stocking (i) - well spaced/ha"")),
+                         tags$hr(style = ""padding: 0; margin: 0 0 3px 0; height: 2px; background-color: darkgreen; border: 0px""),
+                         tags$table(
+                           width = ""100%"",
+                           tags$tr(
+                             tags$td(tags$b(""Target"")),
+                             tags$td(tags$b(""Min pa"")),
+                             tags$td(tags$b(""Min p"")),
+                             tags$td(tags$b(""Regen Delay (max yrs)""))
+                           ),
+                           tags$tr(
+                             tags$td(si$StockingTarget),
+                             tags$td(si$StockingMINpa),
+                             tags$td(si$StockingMINp),
+                             tags$td(si$StockingDelay)
+                           )
+                         ),
+                         tags$br(),
+                         tags$small(tags$b(""Free Growing Guide"")),
+                         tags$hr(style = ""padding: 0; margin: 0 0 3px 0; height: 2px; background-color: #003366; border: 0px""),
+                         tags$table(
+                           width = ""100%"",
+                           tags$tr(
+                             tags$td(tags$b(""Earliest (yrs)"")),
+                             tags$td(tags$b(""Latest(yrs)"")),
+                             tags$td(tags$b(""Min Height (m)"")),
+                             tags$td(tags$b(""Min Height (m)""))
+                           ),
+                           tags$tr(
+                             tags$td(si$AssessmentEarliest),
+                             tags$td(si$AssessmentLatest),
+                             tags$td(style = ""white-space: normal;"", sh[!Flag %in% TRUE, paste(Species, Height, sep = "": "", collapse = "", "")]),
+                             tags$td(style = ""white-space: normal;"", sh[Flag %in% TRUE, paste(Species, Height, sep = "": "", collapse = "", "")])
+                           )
+                         )
+                 )
+               ),
+               tags$tr(
+                 tags$td(colspan = ""2"", style = ""white-space:normal; vertical-align: top; padding:0; background-color:white; border:none"",
+                         tags$small(tags$b(""Footnotes"")),
+                         tags$hr(style = ""padding: 0; margin: 0 0 3px 0; height: 2px; background-color: #003366; border: 0px""),
+                         {
+                           fn <- ss[PreferredAcceptable %in% c(""A"", ""P"") | Suitability %in% 1:3, sort(as.integer(unique(unlist(Footnotes))))]
+                           fnt <- footnotes[match(fn, `Revised Footnote`), `Revised Footnote Text`]
+                           fnshiny <- mapply(function(footnote, text) {list(tags$sup(footnote), tags$small(text), tags$br())}, fn, fnt, SIMPLIFY = FALSE, USE.NAMES = FALSE)
+                           do.call(span, fnshiny)
+                         }
+                 )
+               )
     )
   )
 }
@@ -190,6 +190,8 @@ sppnotes_cciss <- function(spp, textstyle) {
   do.call(tags$td, ret)
 }
 
+
+
 reg_cw <- fread(""District_Region_Crosswalk.csv"")
 ```
 
@@ -219,9 +221,19 @@ for(bgc_select in bgc_opts){
     feasSum[,ZoneSubzone := SiteRef]
     feasSum[
         stocking_standards, 
-        CFSuitability := as.character(i.Suitability),
+        `:=`(CFSuitability = as.character(i.Suitability),
+        PrefAcc = i.PreferredAcceptable),
         on = c(Region = ""Region"", ZoneSubzone = ""ZoneSubzone"", SS_NoSpace = ""SS_NoSpace"", Spp = ""Species"")
       ]
+    
+    feasSum[cfrg_rules,PrefAcc_cciss := i.PrefAcc, on = c(""Spp"",ccissSuit = ""Feasible"")]
+    feasSum[is.na(PrefAcc_cciss),PrefAcc_cciss := ""X""]
+    feasSum[,NoPref := if(any(PrefAcc_cciss == ""P"")) T else F, by = .(SS_NoSpace)]
+    feasSum[NoPref == F & PrefAcc_cciss == ""A"", PrefAcc_cciss := ""P""]
+    feasSum[,NoPref := NULL]
+    feasSum[is.na(PrefAcc), PrefAcc := ""X""]
+    
+
     siteseries <- unique(feasSum$SS_NoSpace)
     print(
       tagList(tags$hr(style = ""padding: 0; margin: 0 0 3px 0; height: 2px; background-color: purple; border: 0px""),"
bcgov,CCISS_ShinyApp,52ba4019d88bad30fea5f5b130755d2e683877c5,Bruno Tremblay,meztez@neoxone.com,2021-11-01T05:55:07Z,Bruno Tremblay,meztez@neoxone.com,2021-11-01T05:55:07Z,"make sidebarhelplink function ,fix duplicated inputId for BEC futures Spatial",app/server/instructions.R;app/ui.R,False,True,True,False,20,35,55,"---FILE: app/server/instructions.R---
@@ -13,6 +13,11 @@ observeEvent(input$cciss_instructions_bec_futures, {
   updateTabsetPanel(inputId = ""cciss_instructions_set"", selected = ""cciss_instructions_bec_futures"")
 })
 
+observeEvent(input$cciss_instructions_bec_futures_spatial, {
+  updateNavbarPage(inputId = ""cciss_navbar"", selected = ""cciss_instructions"")
+  updateTabsetPanel(inputId = ""cciss_instructions_set"", selected = ""cciss_instructions_bec_futures"")
+})
+
 observeEvent(input$cciss_instructions_silvics_ecology, {
   updateNavbarPage(inputId = ""cciss_navbar"", selected = ""cciss_instructions"")
   updateTabsetPanel(inputId = ""cciss_instructions_set"", selected = ""cciss_instructions_silvics_ecology"")

---FILE: app/ui.R---
@@ -16,6 +16,14 @@ navhelplink <- function(title, inputId) {
   )
 }
 
+sidebarhelplink <- function(inputId) {
+  tags$p(style = ""text-align: center;"", shiny::actionLink(
+    inputId = inputId,
+    label = ""Section Insctructions"", 
+    icon = icon(""question-circle"")
+  ))
+}
+
 suppressWarnings(
   navbarPage(
     title = HTML('&nbsp;&nbsp;<img src=""/logo.svg"" class=""navbar-logo"">'),
@@ -42,11 +50,7 @@ suppressWarnings(
         # Inputs
         sidebarPanel(
           width = 3,
-          tags$p(style = ""text-align: center;"", shiny::actionLink(
-            inputId = ""cciss_instructions_select_sites"",
-            label = ""Section Insctructions"", 
-            icon = icon(""question-circle"")
-          )),
+          sidebarhelplink(""cciss_instructions_select_sites""),
           wellPanel(splitLayout(
             actionButton(""sesh_params"", ""Adjust Parameters"", icon = icon(""sliders-h"")),
             
@@ -143,11 +147,7 @@ suppressWarnings(
         # Inputs
         sidebarPanel(
           width = 2,
-          tags$p(style = ""text-align: center;"", shiny::actionLink(
-            inputId = ""cciss_instructions_feasibility_report"",
-            label = ""Section Insctructions"", 
-            icon = icon(""question-circle"")
-          )),
+          sidebarhelplink(""cciss_instructions_feasibility_report""),
           h6(""Filters""),
           selectInput(""siteref_feas"", label = ""Sites:"", choices = character()),
           selectInput(""site_series_feas"", label = ""Site Series"", choices = character()),
@@ -183,11 +183,7 @@ suppressWarnings(
                  # Inputs
                  sidebarPanel(
                    width = 2,
-                   tags$p(style = ""text-align: center;"", shiny::actionLink(
-                     inputId = ""cciss_instructions_bec_futures"",
-                     label = ""Section Insctructions"", 
-                     icon = icon(""question-circle"")
-                   )),
+                   sidebarhelplink(""cciss_instructions_bec_futures""),
                    h6(""Filter""),
                    selectInput(""siteref_bgc_fut"", label = ""Sites:"", choices = character()),
                    selectInput(""ss_bgc_fut"", label = ""Site Series:"", choices = character()),
@@ -214,11 +210,7 @@ suppressWarnings(
                  # Inputs
                  sidebarPanel(
                    width = 2,
-                   tags$p(style = ""text-align: center;"", shiny::actionLink(
-                     inputId = ""cciss_instructions_bec_futures"",
-                     label = ""Section Insctructions"", 
-                     icon = icon(""question-circle"")
-                   )),
+                   sidebarhelplink(""cciss_instructions_bec_futures_spatial""),
                    h6(""Filter""),
                    selectInput(
                      ""siteref_bgc_fut_spatial"",
@@ -249,11 +241,7 @@ suppressWarnings(
                # Inputs
                sidebarPanel(
                  width = 2,
-                 tags$p(style = ""text-align: center;"", shiny::actionLink(
-                   inputId = ""cciss_instructions_silvics_ecology"",
-                   label = ""Section Insctructions"",
-                   icon = icon(""question-circle"")
-                 )),
+                 sidebarhelplink(""cciss_instructions_silvics_ecology""),
                  h6(""Filters""),
                  selectInput(""siteref_silv"", label = ""Sites:"", choices = character()),
                  selectInput(""site_series_silv"", label = ""Site Series"", choices = character()),
@@ -288,11 +276,7 @@ suppressWarnings(
         # Inputs
         sidebarPanel(
           width = 3,
-          tags$p(style = ""text-align: center;"", shiny::actionLink(
-            inputId = ""cciss_instructions_species_portfolio"",
-            label = ""Section Insctructions"", 
-            icon = icon(""question-circle"")
-          )),
+          sidebarhelplink(""cciss_instructions_species_portfolio""),
           h6(""Data Options""),
           selectInput(""port_bgc"", label = ""Select BGC:"", choices = character()),
           radioButtons(
@@ -412,11 +396,7 @@ suppressWarnings(
         # Inputs
         sidebarPanel(
           width = 2,
-          tags$p(style = ""text-align: center;"", shiny::actionLink(
-            inputId = ""cciss_instructions_export"",
-            label = ""Section Insctructions"", 
-            icon = icon(""question-circle"")
-          )),
+          sidebarhelplink(""cciss_instructions_export""),
           h6(""Filter""),
           selectInput(
             ""report_filter_feas"","
bcgov,CCISS_ShinyApp,a42d2395e66998839698b8c6dd031312f7ee4129,Kiri Daust,kiridaust@gmail.com,2021-10-27T18:58:16Z,Kiri Daust,kiridaust@gmail.com,2021-10-27T18:58:16Z,Minor fix,data-raw/scripts/cciss_future_table_downsizing.R,False,True,True,False,9,3,12,"---FILE: data-raw/scripts/cciss_future_table_downsizing.R---
@@ -38,7 +38,10 @@ simple_table <- function(conn, table, values, replace = FALSE) {
 simple_table(conn, ""futureperiod"", sort(unique(future_params$futureperiod)), replace = TRUE)
 simple_table(conn, ""gcm"", sort(unique(future_params$gcm)), replace = TRUE)
 simple_table(conn, ""scenario"", sort(unique(future_params$scenario)), replace = TRUE)
-simple_table(conn, ""bgc"", sort(bgc_attribution$bgc), replace = TRUE)
+
+dat <- fread(""~/CommonTables/WNA_SSeries_v12_6.csv"")
+bgcs <- unique(dat$BGC)
+simple_table(conn, ""bgc"", sort(bgcs), replace = TRUE)
 
 
 # Now cciss_future12
@@ -49,8 +52,11 @@ dbExecute(conn, query)
 
 query <- ""
   CREATE TABLE cciss_future12SMLR (
-    siteno INTEGER REFERENCES hex_points
-    futureperiod 
+    siteno INTEGER REFERENCES hex_points,
+    gcm SMALLSERIAL REFERENCES gcm,
+    scenario SMALLSERIAL REFERENCES scenario,
+    futureperiod SMALLSERIAL REFERENCES futureperiod,
+    bgc_pred SMALLSERIAL REFERENCES bgc
   )
 ""
 "
bcgov,CCISS_ShinyApp,56b4d631533a95cf921ac1e58dbf29ec5ce754aa,Kiri Daust,kiridaust@gmail.com,2021-10-20T21:50:59Z,Kiri Daust,kiridaust@gmail.com,2021-10-20T21:50:59Z,Fix dbGetCCISS,Provincial_Maps.R;R/data_etl.R;app/server/generate.R,False,True,True,False,26,7,33,"---FILE: Provincial_Maps.R---
@@ -54,6 +54,13 @@ dat <- suit[edaSub,on = ""SS_NoSpace""]
 setorder(dat,Spp,SS_NoSpace)
 dat2 <- dat[,.(NumSites = .N, Range = max(Feasible) - min(Feasible), Avg = mean(Feasible)),
             by = .(Spp,BGC)]
+
+dat[,SS_NoSpace := paste0(SS_NoSpace,"": "",Feasible)]
+dat[,SSNum := seq_along(SS_NoSpace), by = .(Spp,BGC)]
+dat <- dcast(dat, BGC + Spp ~ SSNum, value.var = ""SS_NoSpace"")
+setnames(dat,c(""BGC"",""Spp"",""SS1"",""SS2"",""SS3"",""SS4"",""SS5""))
+
+datAll <- dat2[dat, on = c(""BGC"",""Spp"")]
 fwrite(dat2,""FeasibilityStatsC4.csv"")
 
 

---FILE: R/data_etl.R---
@@ -203,15 +203,17 @@ dbGetCCISS <- function(con, siteno, avg, modWeights){
   WITH cciss AS (
     SELECT substring(futureperiod,1,4) futureperiod,
            cciss_future12.siteno,
-           bgc,
+           bgc_attribution.bgc,
            bgc_pred,
            cciss_future12.gcm,
            w.weight
     FROM cciss_future12
+    JOIN bgc_attribution
+    ON (cciss_future12.siteno = bgc_attribution.siteno)
     JOIN (values "",weights,"") 
     AS w(gcm,scenario,weight)
     ON cciss_future12.gcm = w.gcm AND cciss_future12.scenario = w.scenario
-    WHERE siteno IN ("", paste(unique(siteno), collapse = "",""), "")
+    WHERE cciss_future12.siteno IN ("", paste(unique(siteno), collapse = "",""), "")
     AND substring(futureperiod,1,4) IN ('2021','2041','2061','2081')
   
   ), cciss_count_den AS (
@@ -232,11 +234,21 @@ dbGetCCISS <- function(con, siteno, avg, modWeights){
     FROM cciss
     GROUP BY "", groupby, "", futureperiod, bgc, bgc_pred
   
+  ), cciss_curr AS (
+      SELECT cciss_prob12.siteno,
+      period,
+      bgc_attribution.bgc,
+      bgc_pred,
+      prob
+      FROM cciss_prob12
+      JOIN bgc_attribution
+      ON (cciss_prob12.siteno = bgc_attribution.siteno)
+      WHERE cciss_prob12.siteno IN ("", paste(unique(siteno), collapse = "",""), "")
+      
   ), curr_temp AS (
     SELECT "", groupby, "" siteref,
            COUNT(distinct siteno) n
-    FROM cciss_prob12
-    WHERE siteno IN ("", paste(unique(siteno), collapse = "",""), "")
+    FROM cciss_curr
     GROUP BY "", groupby, ""
   )
   
@@ -258,7 +270,7 @@ dbGetCCISS <- function(con, siteno, avg, modWeights){
           bgc,
           bgc_pred,
           SUM(prob)/b.n bgc_prop
-  FROM cciss_prob12 a
+  FROM cciss_curr a
   JOIN curr_temp b
     ON a."",groupby,"" = b.siteref
   WHERE siteno in ("", paste(unique(siteno), collapse = "",""), "")
@@ -272,7 +284,7 @@ dbGetCCISS <- function(con, siteno, avg, modWeights){
             bgc,
             bgc as bgc_pred,
             cast(1 as numeric) bgc_prop
-    FROM cciss_prob12
+    FROM cciss_curr
     WHERE siteno IN ("", paste(unique(siteno), collapse = "",""), "")
   "")
   

---FILE: app/server/generate.R---
@@ -170,7 +170,7 @@ bgc <- function(con, siteno, avg, modWeights) {
 # ""4055121"", ""2243917"", ""1944094"", ""4125428"", ""4635548"", ""5737786"", 
 # ""5321717"", ""1703309"", ""1338735"", ""1313609"", ""1345347"", ""1741741"", 
 # ""3457355"", ""3606245""))
-#bgc <- dbGetCCISS(pool,siteno = 1958596, avg = T, modWeights = all_weight)
+# bgc <- dbGetCCISS(pool,siteno = 5402703, avg = T, modWeights = all_weight)
 # bgc <- sqlTest(pool,siteno = c(6476259,6477778,6691980,6699297),avg = T, scn = ""ssp370"")
 
 "
bcgov,CCISS_ShinyApp,ad047349737d3f2424c7662685453f50b877bba5,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-10-17T02:56:06Z,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-10-17T02:56:06Z,Fixed maps,Provincial_Maps.R,False,True,True,False,33,29,62,"---FILE: Provincial_Maps.R---
@@ -20,26 +20,26 @@ X <- raster(""BC_Raster.tif"")
 X <- raster::setValues(X,NA)
 outline <- st_read(con,query = ""select * from bc_outline"")
 ##code to check that none have the same predictions
-allSites <- dbGetQuery(con,""select distinct rast_id from pts2km_future"")
-selectSites <- sample(allSites$rast_id, size = 500, replace = F)
-dat <- dbGetQuery(con,paste0(""select * from pts2km_future where rast_id IN ("",
-                             paste(selectSites,collapse = "",""),"") and futureperiod = '2041-2060' and scenario = 'ssp245'""))
-setDT(dat)
-dat <- dcast(dat,rast_id ~ gcm,value.var = ""bgc_pred"", fun.aggregate = function(x)x[1])
-mods <- names(dat)[-1]
-dat[,rast_id := NULL]
-
-for(i in 1:(length(mods)-1)){
-  for(j in (i+1):length(mods)){
-    if(all(dat[,..i] == dat[,..j])){
-      cat(""Predictions"", mods[i],""and"",mods[j], ""are identical!"")
-    }
-    cat(""Models:"",mods[i],mods[j],""\n"")
-    temp <- dat[,..i] == dat[,..j]
-    print(table(temp))
-  }
-}
-fwrite(dat, ""./GCM_BEC_agreement.csv"")
+# allSites <- dbGetQuery(con,""select distinct rast_id from pts2km_future"")
+# selectSites <- sample(allSites$rast_id, size = 500, replace = F)
+# dat <- dbGetQuery(con,paste0(""select * from pts2km_future where rast_id IN ("",
+#                              paste(selectSites,collapse = "",""),"") and futureperiod = '2041-2060' and scenario = 'ssp245'""))
+# setDT(dat)
+# dat <- dcast(dat,rast_id ~ gcm,value.var = ""bgc_pred"", fun.aggregate = function(x)x[1])
+# mods <- names(dat)[-1]
+# dat[,rast_id := NULL]
+# 
+# for(i in 1:(length(mods)-1)){
+#   for(j in (i+1):length(mods)){
+#     if(all(dat[,..i] == dat[,..j])){
+#       cat(""Predictions"", mods[i],""and"",mods[j], ""are identical!"")
+#     }
+#     cat(""Models:"",mods[i],mods[j],""\n"")
+#     temp <- dat[,..i] == dat[,..j]
+#     print(table(temp))
+#   }
+# }
+# fwrite(dat, ""./GCM_BEC_agreement.csv"")
 
 ##########################################################
 
@@ -144,7 +144,7 @@ dbGetCCISS_4km <- function(con, period = ""2041-2060"", modWeights){
 ccissMap <- function(SSPred,suit,spp_select){
   ### generate raw feasibility ratios
   
-  suit <- suit[Spp == spp_select,,.(BGC,SS_NoSpace,Spp,Feasible)]
+  suit <- suit[Spp == spp_select,.(BGC,SS_NoSpace,Spp,Feasible)]
   suit <- unique(suit)
   suit <- na.omit(suit)
   SSPred <- SSPred[,.(SiteRef,FuturePeriod,BGC,SS_NoSpace,SS.pred,SSprob)]
@@ -169,14 +169,13 @@ ccissMap <- function(SSPred,suit,spp_select){
   suitVotes[suit, Curr := i.Feasible]
   suitVotes[is.na(Curr), Curr := 5]
   setorder(suitVotes,SiteRef,SS_NoSpace,Spp,FuturePeriod)
-  suitVotes[,FuturePeriod := as.integer(FuturePeriod)]
   suitVotes[Curr > 3.5, Curr := 4]
   colNms <- c(""1"",""2"",""3"",""X"")
   suitVotes <- suitVotes[,lapply(.SD, sum),.SDcols = colNms, 
                          by = .(SiteRef,FuturePeriod, SS_NoSpace,Spp,Curr)]
   suitVotes[,NewSuit := `1`+(`2`*2)+(`3`*3)+(X*5)]
-  suitVotes <- suitVotes[,.(SiteRef,FuturePeriod,SS_NoSpace,Spp,Curr,NewSuit)]
-  return(suitVotes)
+  suitRes <- suitVotes[,.(Curr = mean(Curr),NewSuit = mean(NewSuit)), by = .(SiteRef)]
+  return(suitRes)
 }
 
 ##figure 3c (mean change in feasibiltiy)
@@ -196,7 +195,6 @@ SSPreds <- edatopicOverlap(bgc,edaZonal,E1_Phase) ##takes about 30 seconds
 for(spp in c(""Cw"",""Fd"",""Sx"",""Pl"")){ ##ignore warnings
   cat(""Plotting "",spp,""\n"")
   newFeas <- ccissMap(SSPreds,S1,spp) ##~ 15 seconds
-  newFeas <- newFeas[,.(Curr = mean(Curr), NewSuit = mean(NewSuit)), by = .(SiteRef)]
   newFeas[NewSuit > 3.49, NewSuit := 4]
   newFeas[,FeasChange := Curr - NewSuit]
   newFeas <- unique(newFeas, by = ""SiteRef"")
@@ -207,7 +205,9 @@ for(spp in c(""Cw"",""Fd"",""Sx"",""Pl"")){ ##ignore warnings
   X[feasVals$SiteRef] <- feasVals$FeasChange
   png(file=paste(""./FeasibilityMaps/MeanChange"",timeperiods,spp,"".png"",sep = ""_""), type=""cairo"", units=""in"", width=6.5, height=7, pointsize=10, res=800)
   ##pdf(file=paste(""./FeasibilityMaps/MeanChange"",timeperiods,spp,"".pdf"",sep = ""_""), width=6.5, height=7, pointsize=10)
-  image(X,xlab = NA,ylab = NA, xaxt=""n"", yaxt=""n"", col=ColScheme, breaks=breakpoints, maxpixels= ncell(X))
+  image(X,xlab = NA,ylab = NA, xaxt=""n"", yaxt=""n"", col=ColScheme, 
+        breaks=breakpoints, maxpixels= ncell(X),
+        main = paste0(T1[TreeCode == spp,EnglishName],"" ("",spp,"")\nSite Type: "",edaPos))
   plot(outline, add=T, border=""black"",col = NA, lwd=0.4)
   
   par(xpd=T)
@@ -256,7 +256,7 @@ add_retreat <- function(SSPred,suit,spp_select){
 
 breakpoints <- seq(-1,1,0.2); length(breakpoints)
 labels <- c(""Retreat"", ""Expansion"")
-ColScheme <- c(brewer.pal(11,""RdBu"")[c(1:5)], ""grey90"", brewer.pal(11,""RdBu"")[c(8:11)]); length(ColScheme)
+ColScheme <- c(brewer.pal(11,""RdBu"")[c(1:4)], ""grey90"", brewer.pal(11,""RdBu"")[c(7:11)]); length(ColScheme)
 
 
 for(spp in c(""Cw"",""Fd"",""Sx"",""Pl"")){ ##ignore warnings
@@ -268,11 +268,15 @@ for(spp in c(""Cw"",""Fd"",""Sx"",""Pl"")){ ##ignore warnings
   X[addret$SiteRef] <- addret$PropMod
   png(file=paste(""./FeasibilityMaps/Add_Retreat"",timeperiods,spp,"".png"",sep = ""_""), type=""cairo"", units=""in"", width=6.5, height=7, pointsize=10, res=800)
   #pdf(file=paste(""./FeasibilityMaps/Add_Retreat"",timeperiods,spp,"".pdf"",sep = ""_""), width=6.5, height=7, pointsize=10)
-  image(X,bty = ""n"",  xaxt=""n"", yaxt=""n"", col=ColScheme, breaks=breakpoints, maxpixels= ncell(X))
+  image(X,xlab = NA,ylab = NA,bty = ""n"",  xaxt=""n"", yaxt=""n"", 
+        col=ColScheme, breaks=breakpoints, maxpixels= ncell(X),
+        main = paste0(T1[TreeCode == spp,EnglishName],"" ("",spp,"")\nSite Type: "",edaPos))
   plot(outline, add=T, border=""black"",col = NA, lwd=0.4)
   
   par(xpd=T)
-  xl <- 325000; yb <- 900000; xr <- 425000; yt <- 1525000
+  
+  #xl <- 325000; yb <- 900000; xr <- 425000; yt <- 1525000
+  xl <- 1600000; yb <- 1000000; xr <- 1700000; yt <- 1700000
   rect(xl,  head(seq(yb,yt,(yt-yb)/length(ColScheme)),-1),  xr,  tail(seq(yb,yt,(yt-yb)/length(ColScheme)),-1),  col=ColScheme)
   text(rep(xr+10000,length(labels)),seq(yb,yt,(yt-yb)/(15-1))[c(3,9)],labels,pos=4,cex=0.9,font=0.8, srt=90)
   text(rep(xr-20000,length(labels)),seq(yb,yt,(yt-yb)/(15-1))[c(1,8,15)],c(""100%"", ""0%"", ""100%""),pos=4,cex=0.8,font=1)"
bcgov,CCISS_ShinyApp,451ed5b64fdb7f41e170397fdc866c5cc4644c6d,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-10-14T22:29:06Z,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-10-14T22:29:06Z,Fix merge,Provincial_Maps.R,False,True,True,False,0,22,22,"---FILE: Provincial_Maps.R---
@@ -20,7 +20,6 @@ X <- raster(""BC_Raster.tif"")
 X <- raster::setValues(X,NA)
 outline <- st_read(con,query = ""select * from bc_outline"")
 ##code to check that none have the same predictions
-<<<<<<< HEAD
 allSites <- dbGetQuery(con,""select distinct rast_id from pts2km_future"")
 selectSites <- sample(allSites$rast_id, size = 500, replace = F)
 dat <- dbGetQuery(con,paste0(""select * from pts2km_future where rast_id IN ("",
@@ -41,28 +40,7 @@ for(i in 1:(length(mods)-1)){
   }
 }
 fwrite(dat, ""./GCM_BEC_agreement.csv"")
-=======
-# allSites <- dbGetQuery(con,""select distinct rast_id from pts2km_future"")
-# selectSites <- sample(allSites$rast_id, size = 500, replace = F)
-# dat <- dbGetQuery(con,paste0(""select * from pts2km_future where rast_id IN ("",
-#                              paste(selectSites,collapse = "",""),"") and futureperiod = '2041-2060' and scenario = 'ssp245'""))
-# setDT(dat)
-# dat <- dcast(dat,rast_id ~ gcm,value.var = ""bgc_pred"", fun.aggregate = function(x)x[1])
-# mods <- names(dat)[-1]
-# dat[,rast_id := NULL]
-# 
-# for(i in 1:(length(mods)-1)){
-#   for(j in (i+1):length(mods)){
-#     if(all(dat[,..i] == dat[,..j])){
-#       cat(""Predictions"", mods[i],""and"",mods[j], ""are identical!"")
-#     }
-#     cat(""Models:"",mods[i],mods[j],""\n"")
-#     temp <- dat[,..i] == dat[,..j]
-#     print(table(temp))
-#   }
-# }
 
->>>>>>> 29ade9628250f77c21dfafec39e02ce244402472
 ##########################################################
 
 ##make projected bgc maps"
bcgov,CCISS_ShinyApp,c4bfd2c8faccbff5c40667f72c0e4efab182ebd1,Bruno Tremblay,meztez@neoxone.com,2021-10-06T20:24:40Z,Bruno Tremblay,meztez@neoxone.com,2021-10-06T20:25:32Z,Fix package build failed checks. Still some Non-ascii character in stocking_info/stocking_standards. Might be on purpose so did not touch.,.Rbuildignore;DESCRIPTION;NAMESPACE;R/PortfolioOpt_R.R;R/data_etl.R;R/eda_overlap.R;R/feasibility.R;R/portfolio_fns.R;R/z_data.R;man/bccciss-data.Rd;man/ccissOutput.Rd;man/cleanData.Rd;man/dbGetClimSum.Rd;man/dbGetSppLimits.Rd;man/edatopicOverlap.Rd;man/edatopicSubset.Rd;man/ef_plot.Rd;man/run_portfolio.Rd;man/simulateClimate.Rd;src/RcppExports.cpp,False,True,True,False,372,66,438,"---FILE: .Rbuildignore---
@@ -15,3 +15,4 @@
 ^\.mbtiles$
 ^scripts
 ^app
+^trial_locations

---FILE: DESCRIPTION---
@@ -24,7 +24,13 @@ Imports:
     plotly,
     pool,
     prettydoc,
-    pagedown
+    pagedown,
+    foreach,
+    nloptr,
+    ggplot2,
+    ggthemes,
+    magrittr,
+    scales
 Suggests:
     bcdata,
     bcmaps,
@@ -38,5 +44,5 @@ Remotes:
 LinkingTo: Rcpp
 LazyData: true
 Roxygen: list(markdown = TRUE)
-RoxygenNote: 7.1.1
+RoxygenNote: 7.1.2
 SystemRequirements: chromium-browser

---FILE: NAMESPACE---
@@ -50,8 +50,12 @@ importFrom(dplyr,mutate)
 importFrom(dplyr,select)
 importFrom(matrixStats,rowMaxs)
 importFrom(nloptr,slsqp)
+importFrom(stats,approx)
 importFrom(stats,complete.cases)
 importFrom(stats,na.omit)
+importFrom(stats,quantile)
+importFrom(stats,rnorm)
+importFrom(stats,weighted.mean)
 importFrom(tools,file_path_sans_ext)
 importFrom(utils,browseURL)
 importFrom(utils,menu)

---FILE: R/PortfolioOpt_R.R---
@@ -13,6 +13,12 @@
 #' @author Kiri Daust
 #' @export
 optimise_portfolio <- function(returns, cov_matrix, boundDat, minTot){
+  
+  # Declare binding for checks
+  if (FALSE) {
+    Spp <- sharpe <- NULL
+  }
+  
   spp <- colnames(cov_matrix)
   sppUse <- spp
   mean_returns <- colMeans(returns)

---FILE: R/data_etl.R---
@@ -187,6 +187,11 @@ dbGetBGC <- function(con,bgc,district = NULL,maxPoints){
 #' @export
 dbGetCCISS <- function(con, siteno, avg, modWeights){
 
+  # Declare binding for checks
+  if (FALSE) {
+    comb <- gcm <- rcp <- weight <- NULL
+  }
+  
   groupby = ""siteno""
   if (isTRUE(avg)) {
     groupby = ""bgc""

---FILE: R/eda_overlap.R---
@@ -24,21 +24,53 @@
 
 #' EDA Topic Overlap
 #' @param BGC BGC
-#' @param Edatope A data.table?
+#' @param E1 A data.table?
+#' @param E1_Phase A phase?
 #' @details What the function does
 #' @return What the function returns
 #' @import data.table
 #' @importFrom dplyr left_join distinct
 #' @importFrom stats complete.cases na.omit
 #' @export
 edatopicOverlap <- function(BGC,E1,E1_Phase){
-  SS <- E1[,.(BGC,SS_NoSpace,Edatopic)]
+  
+  # Declare binding for checks
+  if (FALSE) {
+    SS_NoSpace <- 
+      Edatopic <- 
+      SpecialCode <- 
+      BGC.pred <- 
+      SS.pred <- 
+      SiteRef <- 
+      FuturePeriod <- 
+      BGC.prop <- 
+      SS.Curr <- 
+      i.NumEdas <- 
+      SSProb <- 
+      SS.prob <- 
+      SSProbRev <- 
+      allOverlap <- 
+      MainUnit <- 
+      Phase <- 
+      i.BGC <- 
+      PhasePred <- 
+      MainUnit.y <- 
+      PhaseSum <- 
+      phaseOverlap <- 
+      allOverlap.y <- 
+      Flag <- 
+      SSratio <- 
+      SSprob <- 
+      NULL
+  }
+  
+  SS <- E1[,list(BGC,SS_NoSpace,Edatopic)]
   edaPhase <- E1_Phase
   SS <- unique(SS)
   BGC <- unique(BGC)
-  SSsp <- E1[!is.na(SpecialCode),.(BGC,SS_NoSpace,SpecialCode)]
+  SSsp <- E1[!is.na(SpecialCode),list(BGC,SS_NoSpace,SpecialCode)]
   SSsp <- unique(SSsp)
-  SSsp_phase <- edaPhase[!is.na(SpecialCode),.(BGC,SS_NoSpace,SpecialCode)]
+  SSsp_phase <- edaPhase[!is.na(SpecialCode),list(BGC,SS_NoSpace,SpecialCode)]
   edaPhase <- edaPhase[is.na(SpecialCode),!""SpecialCode""]
   SSsp <- rbind(SSsp,SSsp_phase)
   
@@ -56,10 +88,10 @@ edatopicOverlap <- function(BGC,E1,E1_Phase){
   # setting it to allow.cartesian, might need to investigate.
   new <- CurrBGC[FutBGC, allow.cartesian=TRUE]
   new <- new[!is.na(SS_NoSpace),] ##this removes special site series that don't align
-  SSsp.out <- new[,.(allOverlap = 1/.N,SS.pred,BGC.prop), keyby = .(SiteRef,FuturePeriod,BGC,BGC.pred,SS_NoSpace)]
+  SSsp.out <- new[,list(allOverlap = 1/.N,SS.pred,BGC.prop), keyby = list(SiteRef,FuturePeriod,BGC,BGC.pred,SS_NoSpace)]
   
   ##regular site series edatopes
-  temp <- rbind(SS,E1_Phase[is.na(SpecialCode),.(BGC,SS_NoSpace,Edatopic)])
+  temp <- rbind(SS,E1_Phase[is.na(SpecialCode),list(BGC,SS_NoSpace,Edatopic)])
   CurrBGC <- temp[BGC, on = ""BGC"", allow.cartesian = T]
   CurrBGC <- CurrBGC[!duplicated(CurrBGC),]
   setkey(BGC, BGC.pred)
@@ -79,37 +111,37 @@ edatopicOverlap <- function(BGC,E1,E1_Phase){
   setkey(new, SiteRef,FuturePeriod,BGC,BGC.pred,SS_NoSpace,SS.pred)
   ##new <- new[complete.cases(new),]
   
-  numEda <- E1[,.(NumEdas = .N), by = .(BGC,SS_NoSpace)]
+  numEda <- E1[,list(NumEdas = .N), by = list(BGC,SS_NoSpace)]
   
   ###forwards overlap
-  SS.out <- new[,.(SS.prob = .N,BGC.prop = BGC.prop[1]), 
-                keyby = .(SiteRef,FuturePeriod,BGC,BGC.pred,SS_NoSpace,SS.pred)]
+  SS.out <- new[,list(SS.prob = .N,BGC.prop = BGC.prop[1]), 
+                keyby = list(SiteRef,FuturePeriod,BGC,BGC.pred,SS_NoSpace,SS.pred)]
   SS.out[numEda,SS.Curr := i.NumEdas, on = c(SS_NoSpace = ""SS_NoSpace""), allow.cartesian = T]
   SS.out[,SSProb := SS.prob/SS.Curr]
   
   ###reverse overlap
-  SS.out.rev <- new[,.(SS.prob = .N,BGC.prop = BGC.prop[1]), 
-                    keyby = .(SiteRef,FuturePeriod,BGC,BGC.pred,SS.pred,SS_NoSpace)]
+  SS.out.rev <- new[,list(SS.prob = .N,BGC.prop = BGC.prop[1]), 
+                    keyby = list(SiteRef,FuturePeriod,BGC,BGC.pred,SS.pred,SS_NoSpace)]
   SS.out.rev[numEda,SS.Curr := i.NumEdas, on = c(SS.pred = ""SS_NoSpace"")]
   SS.out.rev[,SSProbRev := SS.prob/SS.Curr]
 
   ##combine them
   combAll <- merge(SS.out,SS.out.rev,by = c(""SiteRef"",""FuturePeriod"",""BGC"",""BGC.pred"",""SS_NoSpace"",""SS.pred""))
   combAll[,allOverlap := SSProb*SSProbRev]
   setnames(combAll, old = ""BGC.prop.x"",new = ""BGC.prop"")
-  combAll <- combAll[,.(SiteRef, FuturePeriod, BGC, BGC.pred, SS_NoSpace, 
+  combAll <- combAll[,list(SiteRef, FuturePeriod, BGC, BGC.pred, SS_NoSpace, 
                         allOverlap, SS.pred, BGC.prop)]
   combAll <- na.omit(combAll)
   ###########################################################################
   ##now redo for phases
   
-  numEdaPh <- E1_Phase[,.(NumEdas = .N), by = .(SS_NoSpace)]
-  phaseSmall <- unique(edaPhase[,.(BGC,MainUnit,Phase = SS_NoSpace)])
+  numEdaPh <- E1_Phase[,list(NumEdas = .N), by = list(SS_NoSpace)]
+  phaseSmall <- unique(edaPhase[,list(BGC,MainUnit,Phase = SS_NoSpace)])
   combPhase <- phaseSmall[combAll, on = c(MainUnit = ""SS.pred""), allow.cartesian = T]
   justPhase <- combPhase[!is.na(Phase),]
-  curr <- unique(justPhase[,.(SiteRef, FuturePeriod, BGC = i.BGC, BGC.pred, SS_NoSpace)])
-  fut <- unique(justPhase[,.(SiteRef, FuturePeriod, BGC = i.BGC, BGC.pred, MainUnit, Phase)])
-  phaseTemp <- E1_Phase[,.(SS_NoSpace,Edatopic)]
+  curr <- unique(justPhase[,list(SiteRef, FuturePeriod, BGC = i.BGC, BGC.pred, SS_NoSpace)])
+  fut <- unique(justPhase[,list(SiteRef, FuturePeriod, BGC = i.BGC, BGC.pred, MainUnit, Phase)])
+  phaseTemp <- E1_Phase[,list(SS_NoSpace,Edatopic)]
   curr <- E1[curr, on = ""SS_NoSpace"", allow.cartesian = T] 
   fut <- phaseTemp[fut, on = c(SS_NoSpace = ""Phase""),allow.cartesian = T]
   setnames(fut,old = ""SS_NoSpace"", new = ""PhasePred"")
@@ -119,28 +151,28 @@ edatopicOverlap <- function(BGC,E1,E1_Phase){
   new <- new[!is.na(PhasePred),]
   
   ###forwards overlap
-  SS.out <- new[,.(SS.prob = .N,MainUnit = MainUnit[1]), 
-                keyby = .(SiteRef,FuturePeriod,BGC,BGC.pred,SS_NoSpace,PhasePred)]
+  SS.out <- new[,list(SS.prob = .N,MainUnit = MainUnit[1]), 
+                keyby = list(SiteRef,FuturePeriod,BGC,BGC.pred,SS_NoSpace,PhasePred)]
   SS.out[numEda,SS.Curr := i.NumEdas, on = c(SS_NoSpace = ""SS_NoSpace""), allow.cartesian = T]
   SS.out[,SSProb := SS.prob/SS.Curr]
   
   ###reverse overlap
-  SS.out.rev <- new[,.(SS.prob = .N,MainUnit = MainUnit[1]), 
-                    keyby = .(SiteRef,FuturePeriod,BGC,BGC.pred,PhasePred,SS_NoSpace)]
+  SS.out.rev <- new[,list(SS.prob = .N,MainUnit = MainUnit[1]), 
+                    keyby = list(SiteRef,FuturePeriod,BGC,BGC.pred,PhasePred,SS_NoSpace)]
   SS.out.rev[numEdaPh,SS.Curr := i.NumEdas, on = c(PhasePred = ""SS_NoSpace""), allow.cartesian = T]
   SS.out.rev[,SSProbRev := SS.prob/SS.Curr]
 
   ##combine them
   combPhaseAll <- merge(SS.out,SS.out.rev,by = c(""SiteRef"",""FuturePeriod"",""BGC"",""BGC.pred"",""SS_NoSpace"",""PhasePred""))
   combPhaseAll[,allOverlap := SSProb*SSProbRev]
-  combPhaseAll <- combPhaseAll[,.(SiteRef,FuturePeriod,BGC,BGC.pred,SS_NoSpace,
+  combPhaseAll <- combPhaseAll[,list(SiteRef,FuturePeriod,BGC,BGC.pred,SS_NoSpace,
                                   SS.pred = MainUnit.y, PhasePred,phaseOverlap = allOverlap)]
   combPhaseAll <- na.omit(combPhaseAll)
   setkey(combPhaseAll,SiteRef,FuturePeriod,BGC,BGC.pred,SS_NoSpace,SS.pred)
   setkey(combAll,SiteRef,FuturePeriod,BGC,BGC.pred,SS_NoSpace,SS.pred)
   combAll <- combPhaseAll[combAll]
   ####add phase to non-phase###
-  combAll[,PhaseSum := sum(phaseOverlap), by = .(SiteRef,FuturePeriod,BGC,BGC.pred,SS_NoSpace,SS.pred)]
+  combAll[,PhaseSum := sum(phaseOverlap), by = list(SiteRef,FuturePeriod,BGC,BGC.pred,SS_NoSpace,SS.pred)]
   combAll[,phaseOverlap := phaseOverlap/PhaseSum]
   combAll[!is.na(phaseOverlap),allOverlap := allOverlap * phaseOverlap]
   combAll[!is.na(phaseOverlap),SS.pred := PhasePred]
@@ -152,7 +184,7 @@ edatopicOverlap <- function(BGC,E1,E1_Phase){
   temp <- combAll[!is.na(allOverlap.y),]
   temp[,c(""allOverlap.x"",""BGC.prop.x"") := NULL]
   setnames(temp,old = c(""allOverlap.y"",""BGC.prop.y""), new = c(""allOverlap"",""BGC.prop""))
-  combAll[,Flag := if(all(is.na(allOverlap.y))) T else F, by = .(SiteRef,FuturePeriod,BGC,SS_NoSpace,BGC.pred)]
+  combAll[,Flag := if(all(is.na(allOverlap.y))) T else F, by = list(SiteRef,FuturePeriod,BGC,SS_NoSpace,BGC.pred)]
   combAll <- combAll[(Flag),!""Flag""]
   combAll[,c(""allOverlap.y"",""BGC.prop.y"") := NULL]
   setnames(combAll,old = c(""allOverlap.x"",""BGC.prop.x""), new = c(""allOverlap"",""BGC.prop""))
@@ -165,12 +197,12 @@ edatopicOverlap <- function(BGC,E1,E1_Phase){
   
   ##add in BGC probability
   combAll <- na.omit(combAll)
-  combAll[,SSratio := allOverlap/sum(allOverlap), by = .(SiteRef, FuturePeriod, BGC, BGC.pred,SS_NoSpace)] ##should check this?
+  combAll[,SSratio := allOverlap/sum(allOverlap), by = list(SiteRef, FuturePeriod, BGC, BGC.pred,SS_NoSpace)] ##should check this?
   setorder(combAll, SiteRef, FuturePeriod, BGC, BGC.pred, SS_NoSpace)
   
   setkey(combAll, SiteRef, FuturePeriod, BGC,BGC.pred)
-  temp <- unique(combAll[,.(SiteRef,FuturePeriod,BGC,BGC.pred,BGC.prop)])
-  temp[,BGC.prop := BGC.prop/sum(BGC.prop), by = .(SiteRef,FuturePeriod,BGC)]
+  temp <- unique(combAll[,list(SiteRef,FuturePeriod,BGC,BGC.pred,BGC.prop)])
+  temp[,BGC.prop := BGC.prop/sum(BGC.prop), by = list(SiteRef,FuturePeriod,BGC)]
   temp <- unique(temp)
   combAll[,BGC.prop := NULL]
   combAll <- temp[combAll]

---FILE: R/feasibility.R---
@@ -26,22 +26,64 @@
 #' @param suit A data.table. Suitability.
 #' @param rules A data.table. Set of rules.
 #' @param feasFlag A data.table. Flag depending on feasibility differential.
+#' @param histWeights A numeric vector of length 3.
+#' @param futureWeights A numeric vector of length 4.
 #' @details What the function does
 #' @return What the function returns
 #' @importFrom matrixStats rowMaxs
 #' @importFrom dplyr select everything mutate across full_join filter
+#' @importFrom stats weighted.mean
 #' @export
 ccissOutput <- function(SSPred,suit,rules,feasFlag,histWeights,futureWeights){
+  
+  # Declare binding for checks
+  if (FALSE) {
+    BGC <-
+      SS_NoSpace <-
+      Spp <-
+      Feasible <-
+      SiteRef <-
+      FuturePeriod <-
+      SS.pred <-
+      SSprob <-
+      VoteSum <-
+      `1` <-
+      `2` <-
+      `3` <-
+      `4` <-
+      `5` <-
+      X <-
+      Curr <-
+      i.Feasible <-
+      ModAgree <-
+      NewSuit <-
+      SuitDiff <-
+      Xadj <-
+      X2 <-
+      NewSuitFrac <-
+      Flag <-
+      i.Flag <-
+      Improve <-
+      Decline <-
+      Weight <-
+      i.Weight <-
+      ccissSuit <-
+      ccissSuitFrac <-
+      OrderCol <-
+      IncludeFlag <-
+      NULL
+  }
+  
  ### generate raw feasibility ratios
   ccissWt <- data.table(FuturePeriod = c(2021,2041,2061,2081),
                         Weight = futureWeights)
   
-  suit <- suit[,.(BGC,SS_NoSpace,Spp,Feasible)]
+  suit <- suit[,list(BGC,SS_NoSpace,Spp,Feasible)]
   ## replace the coast/interior divisions of species
   suit <- unique(suit)
   suit <- na.omit(suit)
-  SSPred <- SSPred[,.(SiteRef,FuturePeriod,BGC,SS_NoSpace,SS.pred,SSprob)]
-  Site_BGC <- unique(SSPred[,.(SiteRef,BGC)])
+  SSPred <- SSPred[,list(SiteRef,FuturePeriod,BGC,SS_NoSpace,SS.pred,SSprob)]
+  Site_BGC <- unique(SSPred[,list(SiteRef,BGC)])
   SSPred <- na.omit(SSPred)
   setkey(SSPred,SS.pred)
   setkey(suit,SS_NoSpace)
@@ -67,7 +109,7 @@ ccissOutput <- function(SSPred,suit,rules,feasFlag,histWeights,futureWeights){
   suitVotes[,FuturePeriod := as.integer(FuturePeriod)]
   suitVotes[Curr > 3.5, Curr := 4]
   suitVotes[NewSuit > 3.5, NewSuit := 4]
-  suitVotes[,SuitDiff := stepDiff(FuturePeriod,NewSuit,Curr), by = .(SiteRef,SS_NoSpace,Spp)] ## final raw output table
+  suitVotes[,SuitDiff := stepDiff(FuturePeriod,NewSuit,Curr), by = list(SiteRef,SS_NoSpace,Spp)] ## final raw output table
 
   ##Generate summary feasibility from raw proportions
   histWt <- histWeights[1]
@@ -81,7 +123,7 @@ ccissOutput <- function(SSPred,suit,rules,feasFlag,histWeights,futureWeights){
   datFeas[FuturePeriod == 1991, (colNms) := lapply(.SD,""*"",currWt), .SDcols = colNms]
   datFeas[FuturePeriod == 2021, (colNms) := lapply(.SD,""*"",earlyWt), .SDcols = colNms]
 
-  datFeas <- datFeas[,lapply(.SD, sum),.SDcols = colNms, by = .(SiteRef,SS_NoSpace,Spp,Curr)]
+  datFeas <- datFeas[,lapply(.SD, sum),.SDcols = colNms, by = list(SiteRef,SS_NoSpace,Spp,Curr)]
   ## ADD VARIABLE THAT IS 1-SUM OF 1-4 COLUMNS THAN ADD VALUE TO x COLUMN TO ACCOUNT FOR nULL FUTURES AND MAKE ROW SUM = 1
 
   datFeas[,Xadj := rowSums(.SD), .SDcols = colNms]
@@ -111,19 +153,19 @@ ccissOutput <- function(SSPred,suit,rules,feasFlag,histWeights,futureWeights){
   datRot[,Improve := ModelDir(as.matrix(.SD), Curr = Curr, dir = ""Improve""),.SDcols = colNms]
   datRot[,Decline := ModelDir(as.matrix(.SD), Curr = Curr, dir = ""Decline""),.SDcols = colNms]
   
-  datRot <- datRot[,lapply(.SD, mean),.SDcols = c(""Improve"",""Decline""), by = .(SiteRef,SS_NoSpace,Spp,Curr)]
+  datRot <- datRot[,lapply(.SD, mean),.SDcols = c(""Improve"",""Decline""), by = list(SiteRef,SS_NoSpace,Spp,Curr)]
   datRot[,`:=`(Improve = round(Improve*100),Decline = round(Decline*100))]
   #datRot[,Trend := paste0(Improve,"":"",Decline)]
-  datRot <- datRot[,.(SiteRef,SS_NoSpace,Spp,Improve,Decline)] ##final
+  datRot <- datRot[,list(SiteRef,SS_NoSpace,Spp,Improve,Decline)] ##final
   
 ###################################################################
   datFuture <- suitVotes[FuturePeriod %in% c(2021,2041,2061,2081),]
   datFuture <- datFuture[,lapply(.SD, sum),.SDcols = colNms, 
-                         by = .(SiteRef,FuturePeriod, SS_NoSpace,Spp,Curr)]
+                         by = list(SiteRef,FuturePeriod, SS_NoSpace,Spp,Curr)]
   datFuture[,NewSuit := `1`+(`2`*2)+(`3`*3)+(X*5)]
   datFuture[ccissWt, Weight := i.Weight, on = ""FuturePeriod""]
-  datFuture <- datFuture[,.(ccissSuitFrac = weighted.mean(NewSuit,Weight)), 
-                         by = .(SiteRef,SS_NoSpace,Spp,Curr)]
+  datFuture <- datFuture[,list(ccissSuitFrac = stats::weighted.mean(NewSuit,Weight)), 
+                         by = list(SiteRef,SS_NoSpace,Spp,Curr)]
   datFuture[,ccissSuit := round(ccissSuitFrac)]
   
   ###merge data to make summary tables############################################################
@@ -146,21 +188,21 @@ ccissOutput <- function(SSPred,suit,rules,feasFlag,histWeights,futureWeights){
 
 ### merge in rulesets
 # ruleSub <- rules[Type == ""PeriodTraj"",]
-# suitVotes[ruleSub, PeriodTraj := i.Label, on = .(SuitDiff < mx, SuitDiff >= mn)]
+# suitVotes[ruleSub, PeriodTraj := i.Label, on = list(SuitDiff < mx, SuitDiff >= mn)]
 # ruleSub <- rules[Type == ""Risk"",]
-# suitVotes[ruleSub, Risk := i.Label, on = .(X < mx, X >= mn)]
+# suitVotes[ruleSub, Risk := i.Label, on = list(X < mx, X >= mn)]
 # ruleSub <- rules[Type == ""ModAgr"",]
-# suitVotes[ruleSub, ModAgrClass := i.Label, on = .(ModAgree < mx, ModAgree >= mn)]
+# suitVotes[ruleSub, ModAgrClass := i.Label, on = list(ModAgree < mx, ModAgree >= mn)]
 # 
 # ruleSub <- rules[Type == ""OverallTraj"",]
-# datMid[ruleSub, OverallTraj := i.Label, on = .(SuitDiff < mx, SuitDiff >= mn)]
+# datMid[ruleSub, OverallTraj := i.Label, on = list(SuitDiff < mx, SuitDiff >= mn)]
 # datMid[Bifurc == T, OverallTraj := ""Bifurcating""]
 # 
 # ruleSub <- rules[Type == ""EstabRisk"",]
-# datFeas[ruleSub, Estab.Risk := i.Label, on = .(FeasEstab < mx, FeasEstab >= mn)]
+# datFeas[ruleSub, Estab.Risk := i.Label, on = list(FeasEstab < mx, FeasEstab >= mn)]
 # 
-# temp1 <- datFeas[,.(SiteRef,Spp,SS_NoSpace,Curr,NewSuit,Flag,Estab.Risk)]
-# temp2 <- datMid[,.(SiteRef,Spp,SS_NoSpace,OverallTraj,ModAgree,Improve,Stable,Decline)]
+# temp1 <- datFeas[,list(SiteRef,Spp,SS_NoSpace,Curr,NewSuit,Flag,Estab.Risk)]
+# temp2 <- datMid[,list(SiteRef,Spp,SS_NoSpace,OverallTraj,ModAgree,Improve,Stable,Decline)]
 # summOut <- merge(temp1,temp2, by = c(""SiteRef"",""Spp"",""SS_NoSpace""), all = T)
 # summOut <- summOut[complete.cases(summOut),]
 # summOut[NewSuit > 3.5,NewSuit := 4]
@@ -170,7 +212,7 @@ ccissOutput <- function(SSPred,suit,rules,feasFlag,histWeights,futureWeights){
 
 #### use flag to update next section where species is added in current period
 # datEarly <- suitVotes[FuturePeriod == 2021,]
-# datEarly <- datEarly[,lapply(.SD, sum),.SDcols = colNms, by = .(SiteRef,SS_NoSpace,Spp,Curr)]
+# datEarly <- datEarly[,lapply(.SD, sum),.SDcols = colNms, by = list(SiteRef,SS_NoSpace,Spp,Curr)]
 # datEarly[,Suit2025 := `1`+(`2`*2)+(`3`*3)+(X*4)]
 # datEarly[,change2025 := Curr - Suit2025]
 # 
@@ -182,5 +224,5 @@ ccissOutput <- function(SSPred,suit,rules,feasFlag,histWeights,futureWeights){
 # datEarly[,FailRisk2025 := fifelse(X>.5, ""High"", 
 #                                   fifelse(X>.2 & X<.5, ""Increased"", ""Normal""))]
 # 
-# datEarly <- datEarly[,.(SiteRef,SS_NoSpace,Spp, Suit2025,
+# datEarly <- datEarly[,list(SiteRef,SS_NoSpace,Spp, Suit2025,
 #                         Trajectory2025, FailRisk2025)]
\ No newline at end of file

---FILE: R/portfolio_fns.R---
@@ -3,18 +3,45 @@
 
 #' Clean Portfolio Data
 
+#' @param SSPredAll cleanData parameter.
+#' @param SIBEC cleanData parameter.
+#' @param SuitTable cleanData parameter.
+#' @param SNum cleanData parameter.
+#' @param Trees cleanData parameter.
+#' @param timePer cleanData parameter.
+#' @param selectBGC cleanData parameter.
 #' @details What the function does
 #' @return What the function returns
 #' @import data.table
 #' @import foreach
 #' @export
 cleanData <- function(SSPredAll,SIBEC,SuitTable,SNum,Trees,timePer,selectBGC){
+  
+  # Declare binding for checks
+  if (FALSE) {
+    SiteNo <- 
+      TreeSpp <- 
+      FuturePeriod <- 
+      SS_NoSpace <- 
+      SS.pred <- 
+      SSprob <- 
+      Year <- 
+      SS <- 
+      Suitability <- 
+      i.Suitability <- 
+      MeanPlotSiteIndex <- 
+      Spp <- 
+      MeanSuit <- 
+      MeanSI <- 
+      NULL
+  }
+  
   SSPred <- SSPredAll[SiteNo == SNum,] ###subset
   
   ##Merge SIBEC data
   SIBEC <- SIBEC[TreeSpp %in% Trees,]
   SSPred <- SSPred[SSPred$FuturePeriod %in% timePer,]
-  SSPred <- SSPred[,.(FuturePeriod, SS_NoSpace,SS.pred, SSprob)]
+  SSPred <- SSPred[,list(FuturePeriod, SS_NoSpace,SS.pred, SSprob)]
   SSPred <- SIBEC[SSPred, on = c(SS_NoSpace = ""SS.pred"")]
   setnames(SSPred, old = c(""SS_NoSpace"",""i.SS_NoSpace""), new = c(""SS.pred"",""SS_NoSpace""))
   
@@ -50,9 +77,9 @@ cleanData <- function(SSPredAll,SIBEC,SuitTable,SNum,Trees,timePer,selectBGC){
   }
   
   ##Summarise data- average SI and Suit weighted by SSProb
-  SS.sum <- SSPred[,.(MeanSI = sum(MeanPlotSiteIndex*(SSprob/sum(SSprob))),
+  SS.sum <- SSPred[,list(MeanSI = sum(MeanPlotSiteIndex*(SSprob/sum(SSprob))),
                       MeanSuit = round(sum(Suitability*(SSprob/sum(SSprob))), digits = 0)),
-                   by = .(Spp,FuturePeriod)]
+                   by = list(Spp,FuturePeriod)]
   
   SS.sum <- SS.sum[FuturePeriod %in% timePer,]
   ###not sure what we were doing here?
@@ -66,8 +93,17 @@ cleanData <- function(SSPredAll,SIBEC,SuitTable,SNum,Trees,timePer,selectBGC){
 }
 
 #' Portfolio Subset
+#' @param SSPredOrig A parameter
+#' @param eda A parameter
+#' @param pos A parameter
 #' @export
 edatopicSubset <- function(SSPredOrig, eda, pos = ""Zonal""){
+  
+  # Declare binding for checks
+  if (FALSE) {
+    Edatopic <- SS_NoSpace <- BGC_analysis <- NULL
+  }
+  
   if(pos == ""Zonal""){
     SSPredFull <- SSPredOrig[grep(""01"",SSPredOrig$SS_NoSpace),]
   }else{
@@ -81,10 +117,19 @@ edatopicSubset <- function(SSPredOrig, eda, pos = ""Zonal""){
 }
 
 #' Get Climate Summary Data
+#' @param con A DBI connection object.
+#' @param BGC A character vector of BGC.
+#' @param Scn A character vector of length 1 matching a scenario.
 #' @importFrom RPostgres dbGetQuery
 #' @export
 
 dbGetClimSum <- function(con,BGC,Scn){
+  
+  # Declare binding for checks
+  if (FALSE) {
+    period <- NULL
+  }
+  
   cat(""in get clim sum"")
   climVarFut <- RPostgres::dbGetQuery(con, paste0(""select bgc,period,stat,climvar,value from szsum_fut where bgc in ('""
                                        ,BGC,""') and period in ('2021-2040','2041-2060','2061-2080') 
@@ -105,24 +150,36 @@ dbGetClimSum <- function(con,BGC,Scn){
 }
 
 #' Simulate Climate for Portfolio
+#' @param climInfo A parameter.
+#' @importFrom stats approx rnorm
 #' @export
 
 simulateClimate <- function(climInfo){ ##package function
+  
+  # Declare binding for checks
+  if (FALSE) {
+    climvar <-
+      value <-
+      period <-
+      Var <-
+      NULL
+  }
+  
   climParams <- list()
   simResults <- data.table()
   climVar <- climInfo$Mean
   climVarSD <- climInfo$SD
   for(cvar in c(""CMD"",""Tmin_sp"",""Tmax_sm"")){
-    climSub <- climVar[climvar == cvar,.(value = mean(value)), by = .(period)]
+    climSub <- climVar[climvar == cvar,list(value = mean(value)), by = list(period)]
     climSD <- climVarSD[climvar == cvar,value]
     ##table of means by period
     dat <- data.table(Year = c(2000,2025,2055,2085),Mean = climSub$value)
-    s <- approx(dat$Year, dat$Mean, n = 101) ##smooth
+    s <- stats::approx(dat$Year, dat$Mean, n = 101) ##smooth
     
     ##simulate using mean and variance
     res <- numeric()
     for(i in 1:101){
-      res[i] <- rnorm(1,mean = s$y[i],sd = climSD)
+      res[i] <- stats::rnorm(1,mean = s$y[i],sd = climSD)
     }
     temp <- data.table(Year = 2000:2100, Value = res)
     temp[,Var := cvar]
@@ -133,11 +190,27 @@ simulateClimate <- function(climInfo){ ##package function
 }
 
 #' Species Limits
+#' @param con A DBI connection object.
+#' @param SuitTable A suitability data.frame.
+#' @param Trees A list of tree species.
 #' @import foreach
 #' @importFrom RPostgres dbGetQuery
 #' @export
 
 dbGetSppLimits <- function(con,SuitTable,Trees){
+  
+  # Declare binding for checks
+  if (FALSE) {
+    Suitability <-
+      Spp <-
+      spp <-
+      value <-
+      climvar <-
+      Min <-
+      Max <-
+      NULL
+  }
+  
   cat(""in get limits"")
   sppLimits <- foreach(spp = Trees, .combine = rbind) %do% {##package function
     temp <- SuitTable[Suitability == 1 & Spp == spp,] ##what units is Fd 1?
@@ -147,8 +220,8 @@ dbGetSppLimits <- function(con,SuitTable,Trees){
                                       ,paste(sppUnits,collapse = ""','""),""') and period = '1991 - 2020' 
                                     and climvar in ('CMD','Tmin_sp','Tmax_sm')""))
     climSum <- setDT(climSum)
-    climSum2 <- climSum[,.(Min = min(value),Max = max(value)),
-                        by = .(stat,climvar)]
+    climSum2 <- climSum[,list(Min = min(value),Max = max(value)),
+                        by = list(stat,climvar)]
     climSum3 <- data.table(CMDMin = climSum2[stat == ""mean"" & climvar == ""CMD"",Min],
                            CMDMax = climSum2[stat == ""mean"" & climvar == ""CMD"",Max],
                            Tlow = climSum2[stat == ""mean"" & climvar == ""Tmin_sp"",Min],
@@ -159,15 +232,48 @@ dbGetSppLimits <- function(con,SuitTable,Trees){
 }
 
 #' Run species Portfolio
+#' @param SiteList A parameter
+#' @param climVar A parameter
+#' @param SSPredAll A parameter
+#' @param SIBEC A parameter
+#' @param SuitTable A parameter
+#' @param Trees A parameter
+#' @param TimePeriods A parameter
+#' @param selectBGC A parameter
+#' @param SuitProb A parameter
+#' @param returnValue A parameter
+#' @param sppLimits A parameter
+#' @param minAccept A parameter
+#' @param boundDat A parameter
+#' @param ProbPest A parameter
 #' @import foreach
 #' @import scales
 #' @import magrittr
 #' @importFrom dplyr mutate 
+#' @importFrom stats approx quantile
 #' @export
 
 run_portfolio <- function(SiteList,climVar,SSPredAll,SIBEC,SuitTable,Trees,
                           TimePeriods,selectBGC,SuitProb,returnValue,sppLimits,
                           minAccept,boundDat,ProbPest){
+  
+  # Declare binding for checks
+  if (FALSE) {
+    SNum <-
+      FuturePeriod <-
+      Spp <-
+      Year <-
+      covMat <-
+      ..use <-
+      Return <-
+      RealRet <-
+      SiteNo <-
+      Sharpe <-
+      . <-
+      Sd <-
+      NULL
+  }
+  
   cat(""in portfolio"")
   nSpp <- length(Trees)
   treeList <- Trees
@@ -205,11 +311,11 @@ run_portfolio <- function(SiteList,climVar,SSPredAll,SIBEC,SuitTable,Trees,
                                                  ""SIBEC"" = DatSpp$MeanSI/50, ""Suit"" = DatSpp$MeanSuit)
                                
                                dat <- merge(dat, SuitProb, by = ""Suit"")
-                               s <- approx(dat$Period, dat$SIBEC, n = 101) ##Smooth SI
-                               p <- approx(dat$Period, dat$ProbDead, n = 101) ###Smooth Prob Dead
-                               m <- approx(dat$Period, dat$NoMort, n = 101) ##Smooth No Mort
-                               r <- approx(dat$Period, dat$Suit, n = 101)
-                               ##r <- approx(dat$Period, dat$RuinSeverity, n = 101)
+                               s <- stats::approx(dat$Period, dat$SIBEC, n = 101) ##Smooth SI
+                               p <- stats::approx(dat$Period, dat$ProbDead, n = 101) ###Smooth Prob Dead
+                               m <- stats::approx(dat$Period, dat$NoMort, n = 101) ##Smooth No Mort
+                               r <- stats::approx(dat$Period, dat$Suit, n = 101)
+                               ##r <- stats::approx(dat$Period, dat$RuinSeverity, n = 101)
                                
                                ###data frame of annual data
                                annualDat <- data.table(""Growth"" = s[[""y""]], ""MeanDead"" = p[[""y""]], ""NoMort"" = m[[""y""]], ""Suit"" = r[[""y""]]) ##create working data
@@ -232,7 +338,7 @@ run_portfolio <- function(SiteList,climVar,SSPredAll,SIBEC,SuitTable,Trees,
                              returns <- output
                              returns[,Year := NULL]
                              ###only include species with mean return > 1 in portfolio
-                             use <- colnames(returns)[colMeans(returns) > quantile(colMeans(returns),0.25)] ###should probably be higher
+                             use <- colnames(returns)[colMeans(returns) > stats::quantile(colMeans(returns),0.25)] ###should probably be higher
                              use <- use[use %in% colnames(covMat)]
                              if(length(use) > 1){
                                returns <- returns[,..use]
@@ -259,7 +365,7 @@ run_portfolio <- function(SiteList,climVar,SSPredAll,SIBEC,SuitTable,Trees,
   efAll <- dcast(efAll,Return ~ Spp, fun.aggregate = function(x){sum(x)/(length(SiteList))})
   efAll <- na.omit(efAll)
   #efAll$RealRet <- efAll$RealRet/max(efAll$RealRet) ##standardise return
-  RetCurve <- approx(efAll$RealRet,efAll$Sd,xout = returnValue)
+  RetCurve <- stats::approx(efAll$RealRet,efAll$Sd,xout = returnValue)
   ret90 <- RetCurve$y
   maxSharpe <- efAll[Sharpe == max(Sharpe),!c(""Return"",""Sharpe"")]
   maxSPos <- maxSharpe$Sd
@@ -282,10 +388,24 @@ run_portfolio <- function(SiteList,climVar,SSPredAll,SIBEC,SuitTable,Trees,
 }
 
 #' Plot Efficient Frontier
+#' @param efAll A parameter
+#' @param intDat A parameter
+#' @param colScale A parameter
 #' @import ggplot2
 #' @import ggthemes
 #' @export
 ef_plot <- function(efAll,intDat,colScale){
+  
+  # Declare binding for checks
+  if (FALSE) {
+    Sd <-
+      value <-
+      variable <-
+      Sharpe_Opt <-
+      Set_Return <-
+      NULL
+  }
+  
   # efAll <- outAll$GraphDat
   # intDat <- outAll$MaxS
   efAll$variable <- factor(efAll$variable, levels = sort(unique(as.character(efAll$variable))))

---FILE: R/z_data.R---
@@ -3,5 +3,5 @@
 #' @name bccciss-data
 #' @docType data
 #' @keywords data
-#' @aliases BGCRegions E1 F1 footnotes models_info N1 R1 S1 SIBEC silvics_mature silvics_regen silvics_resist silvics_tol stocking_height stocking_info stocking_standards subzones_colours_ref T1 TreeCols V1 zones_colours_ref
+#' @aliases BGCRegions E1 F1 footnotes models_info N1 R1 S1 SIBEC silvics_mature silvics_regen silvics_resist silvics_tol stocking_height stocking_info stocking_standards subzones_colours_ref T1 TreeCols V1 zones_colours_ref E1_Phase covMat
 NULL

---FILE: man/bccciss-data.Rd---
@@ -3,10 +3,12 @@
 \docType{data}
 \name{bccciss-data}
 \alias{bccciss-data}
+\alias{BGCRegions}
 \alias{E1}
 \alias{F1}
 \alias{footnotes}
 \alias{models_info}
+\alias{N1}
 \alias{R1}
 \alias{S1}
 \alias{SIBEC}
@@ -22,6 +24,8 @@
 \alias{TreeCols}
 \alias{V1}
 \alias{zones_colours_ref}
+\alias{E1_Phase}
+\alias{covMat}
 \title{Data to be included in bccciss package}
 \description{
 Data to be included in bccciss package

---FILE: man/ccissOutput.Rd---
@@ -14,6 +14,10 @@ ccissOutput(SSPred, suit, rules, feasFlag, histWeights, futureWeights)
 \item{rules}{A data.table. Set of rules.}
 
 \item{feasFlag}{A data.table. Flag depending on feasibility differential.}
+
+\item{histWeights}{A numeric vector of length 3.}
+
+\item{futureWeights}{A numeric vector of length 4.}
 }
 \value{
 What the function returns

---FILE: man/cleanData.Rd---
@@ -6,6 +6,21 @@
 \usage{
 cleanData(SSPredAll, SIBEC, SuitTable, SNum, Trees, timePer, selectBGC)
 }
+\arguments{
+\item{SSPredAll}{cleanData parameter.}
+
+\item{SIBEC}{cleanData parameter.}
+
+\item{SuitTable}{cleanData parameter.}
+
+\item{SNum}{cleanData parameter.}
+
+\item{Trees}{cleanData parameter.}
+
+\item{timePer}{cleanData parameter.}
+
+\item{selectBGC}{cleanData parameter.}
+}
 \value{
 What the function returns
 }

---FILE: man/dbGetClimSum.Rd---
@@ -6,6 +6,13 @@
 \usage{
 dbGetClimSum(con, BGC, Scn)
 }
+\arguments{
+\item{con}{A DBI connection object.}
+
+\item{BGC}{A character vector of BGC.}
+
+\item{Scn}{A character vector of length 1 matching a scenario.}
+}
 \description{
 Get Climate Summary Data
 }

---FILE: man/dbGetSppLimits.Rd---
@@ -6,6 +6,13 @@
 \usage{
 dbGetSppLimits(con, SuitTable, Trees)
 }
+\arguments{
+\item{con}{A DBI connection object.}
+
+\item{SuitTable}{A suitability data.frame.}
+
+\item{Trees}{A list of tree species.}
+}
 \description{
 Species Limits
 }

---FILE: man/edatopicOverlap.Rd---
@@ -4,12 +4,14 @@
 \alias{edatopicOverlap}
 \title{EDA Topic Overlap}
 \usage{
-edatopicOverlap(BGC, Edatope)
+edatopicOverlap(BGC, E1, E1_Phase)
 }
 \arguments{
 \item{BGC}{BGC}
 
-\item{Edatope}{A data.table?}
+\item{E1}{A data.table?}
+
+\item{E1_Phase}{A phase?}
 }
 \value{
 What the function returns

---FILE: man/edatopicSubset.Rd---
@@ -6,6 +6,13 @@
 \usage{
 edatopicSubset(SSPredOrig, eda, pos = ""Zonal"")
 }
+\arguments{
+\item{SSPredOrig}{A parameter}
+
+\item{eda}{A parameter}
+
+\item{pos}{A parameter}
+}
 \description{
 Portfolio Subset
 }

---FILE: man/ef_plot.Rd---
@@ -6,6 +6,13 @@
 \usage{
 ef_plot(efAll, intDat, colScale)
 }
+\arguments{
+\item{efAll}{A parameter}
+
+\item{intDat}{A parameter}
+
+\item{colScale}{A parameter}
+}
 \description{
 Plot Efficient Frontier
 }

---FILE: man/run_portfolio.Rd---
@@ -21,6 +21,35 @@ run_portfolio(
   ProbPest
 )
 }
+\arguments{
+\item{SiteList}{A parameter}
+
+\item{climVar}{A parameter}
+
+\item{SSPredAll}{A parameter}
+
+\item{SIBEC}{A parameter}
+
+\item{SuitTable}{A parameter}
+
+\item{Trees}{A parameter}
+
+\item{TimePeriods}{A parameter}
+
+\item{selectBGC}{A parameter}
+
+\item{SuitProb}{A parameter}
+
+\item{returnValue}{A parameter}
+
+\item{sppLimits}{A parameter}
+
+\item{minAccept}{A parameter}
+
+\item{boundDat}{A parameter}
+
+\item{ProbPest}{A parameter}
+}
 \description{
 Run species Portfolio
 }

---FILE: man/simulateClimate.Rd---
@@ -6,6 +6,9 @@
 \usage{
 simulateClimate(climInfo)
 }
+\arguments{
+\item{climInfo}{A parameter.}
+}
 \description{
 Simulate Climate for Portfolio
 }

---FILE: src/RcppExports.cpp---
@@ -5,6 +5,11 @@
 
 using namespace Rcpp;
 
+#ifdef RCPP_USE_GLOBAL_ROSTREAM
+Rcpp::Rostream<true>&  Rcpp::Rcout = Rcpp::Rcpp_cout_get();
+Rcpp::Rostream<false>& Rcpp::Rcerr = Rcpp::Rcpp_cerr_get();
+#endif
+
 // gs2gw
 NumericVector gs2gw(NumericVector x, double a, double b);
 RcppExport SEXP _ccissdev_gs2gw(SEXP xSEXP, SEXP aSEXP, SEXP bSEXP) {"
bcgov,CCISS_ShinyApp,f1a67bb01e4323b7094e7a8820995858b68938ff,Kiri Daust,kiridaust@gmail.com,2021-10-06T18:21:27Z,Kiri Daust,kiridaust@gmail.com,2021-10-06T18:21:27Z,Fixed preselected points,R/data_etl.R;app/server/generate.R,False,True,True,False,3,3,6,"---FILE: R/data_etl.R---
@@ -168,9 +168,9 @@ dbBbox <- function(con, points, buffer) {
 #' @export
 dbGetBGC <- function(con,bgc,district = NULL,maxPoints){
   if(is.null(district)){
-    query <- paste0(""select siteno from bgc_points where bgc IN ('"",paste(bgc,collapse = ""','""),""') limit "",maxPoints)
+    query <- paste0(""select siteno from preselected_points where bgc IN ('"",paste(bgc,collapse = ""','""),""') limit "",maxPoints)
   }else{
-    query <- paste0(""select siteno from bgc_points where bgc IN ('"",paste(bgc,collapse = ""','""),""') and dist_code = '"",district,""' limit "",maxPoints)
+    query <- paste0(""select siteno from preselected_points where bgc IN ('"",paste(bgc,collapse = ""','""),""') and dist_code = '"",district,""' limit "",maxPoints)
   }
   dat <- RPostgres::dbGetQuery(con, query)$siteno
   return(dat)

---FILE: app/server/generate.R---
@@ -12,7 +12,7 @@ observeEvent(input$generate_results, priority = 100, {
   
   # Input from the app
   if(input$preselected != ""N""){
-    pointNums <- dbGetBGC(pool,bgc = uData$bgc_select,district = uData$dist_select, maxPoints = 100)
+    pointNums <- dbGetBGC(pool,bgc = uData$bgc_select,district = uData$dist_select, maxPoints = 150)
     userpoints$bgc_pts <- pointNums
     avg <- uData$avg <- TRUE
     pts <- uData$pts <- data.table(Site = pointNums)"
bcgov,CCISS_ShinyApp,7597e1163decacc2e3fd0f84a52dfd2048ae2768,Kiri Daust,kiridaust@gmail.com,2021-10-04T21:35:00Z,Kiri Daust,kiridaust@gmail.com,2021-10-04T21:35:00Z,Fix feasibility filter,R/feasibility.R;app/server/feasibility.R;app/server/generate.R,False,True,True,False,6,3,9,"---FILE: R/feasibility.R---
@@ -130,6 +130,7 @@ ccissOutput <- function(SSPred,suit,rules,feasFlag,histWeights,futureWeights){
   summOut <- merge(datFeas_final, datRot, by = c('SiteRef','SS_NoSpace','Spp'),all = T)
   summOut <- merge(summOut, datFuture, by = c('SiteRef','SS_NoSpace','Spp'), all = T)
   summOut[,OrderCol := (Curr + NewSuitFrac + ccissSuitFrac)/3]
+  summOut[,IncludeFlag := fifelse(ccissSuitFrac > 0.1,TRUE,FALSE)]
   summOut[,c(""Flag"",""SuitDiff"",""NewSuitFrac"",""ccissSuitFrac"") := NULL]
   #summOut <- summOut[Flag != ""NotIn"",]
   summOut[,`:=`(Curr = as.character(Curr),

---FILE: app/server/feasibility.R---
@@ -30,9 +30,10 @@ cciss_results_dt <- function(data, siteref, siteserie, filter, format = ""html"")
     for(i in c(""NewSuit_1991"",""NewSuit_2021"",""NewSuit_2041"",""NewSuit_2061"",""NewSuit_2081"")){ ##set NA to X
       data[is.na(get(i)), (i) := 4]
     }
-    data <- data[(NewSuit_1991 < 4 | NewSuit_2021 < 4 | NewSuit_2041 < 4 |NewSuit_2061 < 4 | NewSuit_2081 < 4),]
+    data <- data[(IncludeFlag) | Curr %in% c(1,2,3) | CFSuitability %in% c(1,2,3),]
   }else if (filter == ""f""){
-    data <- data[Curr %in% c(1,2,3) | CFSuitability %in% c(1,2,3),]
+    data <- data[(ccissFeas %in% c(1,2,3) | EstabFeas %in% c(1,2,3) | Curr %in% c(1,2,3) | CFSuitability %in% c(1,2,3)),]
+    
   }
   data[,Trend := paste0(""SU"", Improve,""EUPUPPY"",Decline)] ##have to do this so the br isn't escaped by cell_spec
   data <- data[!is.na(Trend) & !is.na(Improve),]

---FILE: app/server/generate.R---
@@ -245,7 +245,8 @@ cciss_results <- function(cciss, pts, avg, type, SS = ccissdev::stocking_standar
            ccissFeas = i.ccissSuit,
            Improve = i.Improve,
            Decline = i.Decline,
-           OrderCol = i.OrderCol),
+           OrderCol = i.OrderCol,
+           IncludeFlag = i.IncludeFlag),
       on = c(""SiteRef"",""SS_NoSpace"",""Spp"")
     ]
     "
bcgov,CCISS_ShinyApp,5f99a3a2ad172aace9855f807bc63fb7cf594b1d,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-09-30T23:33:36Z,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-09-30T23:33:36Z,CSV issue,app/server/generate.R;app/server/points.R,False,True,True,False,33,6,39,"---FILE: app/server/generate.R---
@@ -14,7 +14,6 @@ observeEvent(input$generate_results, priority = 100, {
   if(input$preselected != ""N""){
     pointNums <- dbGetBGC(pool,bgc = uData$bgc_select,district = uData$dist_select, maxPoints = 100)
     userpoints$bgc_pts <- pointNums
-    print(""finished getting sitenos"")
     avg <- uData$avg <- TRUE
     pts <- uData$pts <- data.table(Site = pointNums)
     uData$dist_select <- NULL
@@ -51,20 +50,28 @@ observeEvent(input$generate_results, priority = 100, {
   
   ssl <- lapply(siterefs, function(sr) {
     ss <- sort(unique(cciss_results[SiteRef %in% sr]$SS_NoSpace))
+    if(!is.null(uData$ss_list) & isFALSE(avg) & (sr %in% pts$Site)){
+      selected_ss <- uData$ss_list[[pts[Site == sr,ID][1]]]
+      if(any(selected_ss %in% ss)){
+        ss <- selected_ss
+      }
+    }
     names(ss) <- paste(
       ss,
       N1$SiteSeriesLongName[match(ss, N1$SS_NoSpace)]
     )
     ss
   })
   names(ssl) <- siterefs
+  print(ssl)
   
-  ssa <- sort(unique(cciss_results$SS_NoSpace))
+  ssa <- unique(unname(unlist(ssl)))
   names(ssa) <- paste(
     ssa,
     N1$SiteSeriesLongName[match(ssa, N1$SS_NoSpace)]
   )
-
+  
+  
   siteseries_list <- uData$siteseries_list <- ssl
   siteseries_all  <- uData$siteseries_all  <- ssa
   

---FILE: app/server/points.R---
@@ -113,7 +113,7 @@ observeEvent(input$upload_button,{
       fileInput(inputId = ""points_upload"", label =  ""Delimited file (csv, txt)"",
                 accept = c("".csv"", "".txt""), buttonLabel = ""Browse..."", placeholder = ""My points""),
       span(""The app will detect the first case-insensitive column names that match"",
-           tags$code(""id""), "","",
+           tags$code(""id""), ""or"",tags$code(""site""),"","",
            tags$code(""latitude""), "","",
            tags$code(""longitude""), ""and"",
            tags$code(""elevation""), ""."",
@@ -160,7 +160,7 @@ insert_points_file <- function(datapath){
   }
   
   nm <- names(points)
-  id_j <- head(grep(""^id"", nm, ignore.case = TRUE), 1)
+  id_j <- head(grep(""^id|^site"", nm, ignore.case = TRUE), 1)
   lat_j <- head(grep(""^lat|latitude"", nm, ignore.case = TRUE), 1)
   lng_j <- head(grep(""^lng|^long|longitude"", nm, ignore.case = TRUE), 1)
   ele_j <- head(grep(""^elev|elevation"", nm, ignore.case = TRUE), 1)
@@ -184,11 +184,31 @@ insert_points_file <- function(datapath){
     )
     return(NULL)
   }
+  
+  if(any(grepl(""siteseries"", names(points),ignore.case = T))){
+    showModal(
+      modalDialog(
+        title = ""SiteSeries"",
+        ""Importing Selected Site series"",
+        easyClose = TRUE
+      )
+    )
+    ss_cols <- grep(""siteseries"",names(points),ignore.case = T)
+    ss_list <- list()
+    for(j in 1:nrow(points)){
+      temp <- unname(unlist(points[j,..ss_cols]))
+      temp <- temp[!is.na(temp) & temp != """"]
+      ss_list[[points[[id_j]][j]]] <- temp
+    }
+    uData$ss_list <- ss_list
+  }
 
   cln_j <- function(j) {if (length(j) > 0) {as.numeric(points[[j]])} else {NA_real_}}
   clc_j <- function(j) {if (length(j) > 0) {as.character(points[[j]])} else {NA_character_}}
-  points <- data.table(ID = clc_j(id_j), Long = cln_j(lng_j), Lat = cln_j(lat_j),
+  points <- data.table(ID = clc_j(id_j), Long = -(abs(cln_j(lng_j))), Lat = cln_j(lat_j),
                        Elev = cln_j(ele_j))
+  
+  updateRadioButtons(session,""aggregation"",selected = ""FALSE"")
   points <- new_points(points)
   insert_points(points)
   set_map_bound()"
bcgov,CCISS_ShinyApp,1f10a5945fe0da2fa4be351b0cf2dff99512a0fc,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-09-29T20:48:58Z,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-09-29T20:48:58Z,Fix issue with wna colours,app/server/futures.R,False,True,True,False,1,1,2,"---FILE: app/server/futures.R---
@@ -73,7 +73,7 @@ observe({
     data <- data[SiteRef == siteref & FuturePeriod == timeper,]
     data <- data[BGC.prop > 0.034,] ##exclude single model predictions
     dat <- data.table(BGC = c(data$BGC.pred,data$BGC[1]),
-                      Col = c(colourvalues::colour_values(c(0,1,data$BGC.prop),palette = ""plasma"", 
+                      Col = c(colourvalues::colour_values(c(-1,1,data$BGC.prop),palette = ""greys"", 
                                                           include_alpha = F)[-(1:2)],""#FFFB00""))
     session$sendCustomMessage(""colour_wna"",dat)
   }"
bcgov,CCISS_ShinyApp,cabbeb1c820eeb026a2e4ebc6fda5bda21dc15d8,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-09-28T23:04:27Z,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-09-28T23:04:27Z,fixing issues,app/index.Rmd;app/server/points.R;app/server/reportpdf.Rmd;data-raw/scripts/bigshinygisstudio.R,True,False,True,False,30,15,45,"---FILE: app/index.Rmd---
@@ -1,5 +1,5 @@
 ---
-title: ""The Climate Change Informed Species Selection Tool""
+title: ""The CCISS Tool""
 output: 
   flexdashboard::flex_dashboard:
     orientation: rows
@@ -88,15 +88,15 @@ $(""body"").on(""shown.bs.tab"", ""a[data-toggle='tab']"", function(e) {
 SELECT SITES
 =====================================
 
-Inputs {.sidebar data-width=550}
+Inputs {.sidebar data-width=450}
 -------------------------------------
 
 ```{r}
 actionButton(""show_instr"",""Show Instructions"",icon = icon(""circle-question""), style = ""width:100%; background-color:#003366; color: #FFF"")
 br()
 wellPanel(
   splitLayout(
-    actionButton(""sesh_params"",""Adjust Session Parameters"",icon = icon(""sliders-h"")),
+    actionButton(""sesh_params"",""Adjust Parameters"",icon = icon(""sliders-h"")),
 
 radioButtons(
       ""aggregation"",
@@ -162,6 +162,12 @@ hr(style = ""border-top: 1px solid #8f0e7e;"")
 
 ---
 
+```{r}
+actionButton(""clear_selections"",""Clear Selections"",
+             style = ""width:100%; background-color:#c21104; color: #FFF"")
+hr(style = ""border-top: 1px solid #8f0e7e;"")
+```
+
 ##### Ready to Go!
 
 ```{r}
@@ -264,7 +270,7 @@ leafletOutput(""wna_map"", height = ""auto"")
 ```
 
 
-SILVICS and ECOLOGY INFO
+SILVICS & ECOLOGY
 =====================================     
 
 Inputs {.sidebar data-width=230}

---FILE: app/server/points.R---
@@ -238,6 +238,12 @@ observeEvent(input$clear_button,{
   clear_mk()
 })
 
+observeEvent(input$clear_selections,{
+  userpoints$dt <- uData$basepoints
+  clear_mk()
+  updateRadioButtons(session,""preselected"",selected = ""N"")
+})
+
 ##redraw point when going back to select tab
 observeEvent(input$active_tab,{
   if(input$active_tab == 0){

---FILE: app/server/reportpdf.Rmd---
@@ -144,17 +144,6 @@ leaflet::leaflet(height = ""400px"") %>%
 
 ```
 
-```{r session params, results='asis'}
-tags$h2(""SESSION PARAMETERS"")
-tags$h6(""General Parameters"")
-knitr::kable(data.table(""Parameters"" = c(""Number of Points<br />Considered"", ""Averaged?"", ""Date"", ""Time""), ""User Selections"" = c(nrow(pts), avg, format(Sys.Date(), ""%Y/%m/%d""), format(Sys.time(), ""%H:%M"", usetz = TRUE))),html = T)
-tags$h6(""Time Period Weights"")
-knitr::kable(datTP)
-tags$h6(""GCM Weights"")
-knitr::kable(session_params$gcmWt)
-tags$h6(""Scenario Weights"")
-knitr::kable(session_params$rcpWt)
-```
 
 ```{r siteloop, results='asis'}
 htmltools::tagList(
@@ -196,6 +185,19 @@ htmltools::tagList(
 )
 ```
 
+```{r session params, results='asis'}
+tags$h2(""SESSION PARAMETERS"")
+tags$h6(""General Parameters"")
+knitr::kable(data.table(""Parameters"" = c(""Number of Points<br />Considered"", ""Averaged?"", ""Date"", ""Time""), ""User Selections"" = c(nrow(pts), avg, format(Sys.Date(), ""%Y/%m/%d""), format(Sys.time(), ""%H:%M"", usetz = TRUE))),html = T)
+tags$h6(""Time Period Weights"")
+knitr::kable(datTP)
+tags$h6(""GCM Weights"")
+knitr::kable(session_params$gcmWt)
+tags$h6(""Scenario Weights"")
+knitr::kable(session_params$rcpWt)
+```
+
+
 <!-- Logo -->
 ```{r logo, results='asis'}
 htmltools::HTML('<svg style=""position:absolute; top:20px; left:20px;"" width=""168px"" height=""45px"" viewBox=""0 0 168 45"" fill=""none"" xmlns=""http://www.w3.org/2000/svg""><path d=""M9.67889 37.3287C20.2192 37.3287 34.7999 43.2635 45.3794 43.2635C52.9289 43.2635 60.2958 41.2487 64.4889 38.282C64.7817 36.5397 64.9369 34.751 64.9369 32.9255C64.9369 15.2105 50.5755 0.849609 32.8605 0.849609C15.1455 0.849609 0.784363 15.2105 0.784363 32.9255C0.784363 34.73 0.935741 36.4985 1.22223 38.2216C2.37831 38.0075 6.30919 37.3287 9.67889 37.3287Z"" fill=""white""/><path d=""M81.7877 43.6133H155.983V44.5128H81.7877V43.6133Z"" fill=""#E3A82B""/><path d=""M85.5411 18.8965C85.5411 19.6293 85.5861 20.667 86.0155 21.115C86.4449 21.5831 87.1228 21.6847 87.8004 21.6847C89.8108 21.6847 91.347 20.871 91.347 18.8356C91.347 17.2278 90.4434 15.3551 86.8516 15.3551C85.6316 15.3551 85.5411 15.4772 85.5411 15.8842V18.8965ZM85.5411 14.1745C85.5411 14.7449 85.5637 14.7852 86.7158 14.7449C89.0199 14.6631 90.2628 14.0524 90.2628 12.1394C90.2628 10.1448 88.6132 9.3917 86.8969 9.3917C86.3996 9.3917 86.0605 9.43249 85.8575 9.51384C85.6316 9.57491 85.5411 9.67701 85.5411 10.0427V14.1745ZM83.6887 11.4678C83.6887 9.96184 83.5823 9.56288 82.5658 9.48106L81.8587 9.43249C81.7436 9.341 81.7762 8.93308 81.8813 8.92365C83.1006 8.81495 84.6375 8.76096 86.7384 8.76096C88.1617 8.76096 89.5172 8.86258 90.5342 9.33063C91.5054 9.75812 92.251 10.5721 92.251 11.8746C92.251 13.3403 91.3019 14.0934 89.9466 14.6631C89.9466 14.8665 90.1274 14.9278 90.3757 14.9682C91.5957 15.1721 93.4028 16.1896 93.4028 18.3673C93.4028 20.7283 91.4604 22.3159 87.3934 22.3159C86.7384 22.3159 85.6316 22.2546 84.6825 22.2546C83.6887 22.2546 82.9207 22.2959 82.0846 22.3159C81.949 22.2546 81.9037 21.9292 82.0393 21.8068L82.4463 21.7458C83.6432 21.5625 83.6887 21.3388 83.6887 19.2018V11.4678Z"" fill=""white""/><path d=""M109.105 13.471C109.105 11.6283 109.066 11.3328 107.928 11.246L107.445 11.2111C107.329 11.1416 107.368 10.8284 107.484 10.7763C108.448 10.811 109.105 10.8284 109.915 10.8284C110.687 10.8284 111.343 10.811 112.308 10.7763C112.424 10.8284 112.462 11.1416 112.346 11.2111L111.864 11.246C110.725 11.3328 110.687 11.6283 110.687 13.471V19.6602C110.687 21.5027 110.725 21.7463 111.864 21.8682L112.346 21.9201C112.462 21.9896 112.424 22.3023 112.308 22.3546C111.343 22.3197 110.687 22.3023 109.915 22.3023C109.105 22.3023 108.448 22.3197 107.484 22.3546C107.368 22.3023 107.329 22.0243 107.445 21.9201L107.928 21.8682C109.066 21.7463 109.105 21.5027 109.105 19.6602V13.471Z"" fill=""white""/><path d=""M119.811 19.6964C119.811 21.5216 119.846 21.7824 120.896 21.8694L121.474 21.9215C121.582 21.9908 121.546 22.3035 121.438 22.3561C120.407 22.3212 119.793 22.3035 119.069 22.3035C118.346 22.3035 117.713 22.3212 116.556 22.3561C116.448 22.3035 116.411 22.0085 116.556 21.9215L117.207 21.8694C118.238 21.7824 118.328 21.5216 118.328 19.6964V11.9249C118.328 11.3861 118.328 11.3691 117.786 11.3691H116.791C116.014 11.3691 115.02 11.4038 114.567 11.8035C114.134 12.1859 113.953 12.5686 113.754 13.0029C113.609 13.1074 113.356 13.0204 113.284 12.8813C113.573 12.0992 113.844 10.9865 113.97 10.2911C114.025 10.2564 114.26 10.239 114.314 10.2911C114.423 10.8471 115.02 10.8299 115.851 10.8299H123.173C124.15 10.8299 124.312 10.7952 124.583 10.3432C124.674 10.3086 124.873 10.326 124.909 10.3951C124.71 11.1084 124.583 12.5163 124.638 13.0378C124.566 13.177 124.258 13.177 124.168 13.0727C124.114 12.6377 123.987 11.9947 123.716 11.8035C123.3 11.5076 122.613 11.3691 121.619 11.3691H120.335C119.793 11.3691 119.811 11.3861 119.811 11.9598V19.6964Z"" fill=""white""/><path d=""M127.559 13.471C127.559 11.6283 127.52 11.3328 126.382 11.246L125.899 11.2111C125.784 11.1416 125.822 10.8284 125.938 10.7763C126.903 10.811 127.559 10.8284 128.37 10.8284C129.141 10.8284 129.797 10.811 130.762 10.7763C130.878 10.8284 130.917 11.1416 130.801 11.2111L130.318 11.246C129.18 11.3328 129.141 11.6283 129.141 13.471V19.6602C129.141 21.5027 129.18 21.7463 130.318 21.8682L130.801 21.9201C130.917 21.9896 130.878 22.3023 130.762 22.3546C129.797 22.3197 129.141 22.3023 128.37 22.3023C127.559 22.3023 126.903 22.3197 125.938 22.3546C125.822 22.3023 125.784 22.0243 125.899 21.9201L126.382 21.8682C127.52 21.7463 127.559 21.5027 127.559 19.6602V13.471Z"" fill=""white""/><path d=""M136.208 22.5321C134.484 22.5321 133.397 22.08 133.008 21.8891C132.761 21.5064 132.494 20.2722 132.453 19.455C132.556 19.3333 132.864 19.2987 132.946 19.4029C133.254 20.2894 134.095 21.9928 136.474 21.9928C138.198 21.9928 139.039 21.0369 139.039 19.9938C139.039 19.2291 138.854 18.3772 137.356 17.5599L135.408 16.4819C134.382 15.9084 133.192 14.9174 133.192 13.492C133.192 11.8403 134.71 10.5017 137.377 10.5017C138.012 10.5017 138.751 10.606 139.285 10.7276C139.551 10.7972 139.838 10.8318 140.003 10.8318C140.187 11.2497 140.372 12.223 140.372 12.953C140.29 13.0575 139.961 13.1094 139.859 13.0051C139.592 12.1709 139.039 11.0408 137.069 11.0408C135.059 11.0408 134.628 12.1709 134.628 12.9702C134.628 13.9787 135.613 14.7092 136.372 15.1089L138.012 15.978C139.305 16.6559 140.577 17.6641 140.577 19.3159C140.577 21.2281 138.875 22.5321 136.208 22.5321Z"" fill=""white""/><path d=""M146.533 16.6872C145.635 16.6872 145.598 16.7218 145.598 17.2434V19.6949C145.598 21.5202 145.692 21.7637 146.739 21.8682L147.281 21.9201C147.394 21.9896 147.356 22.3021 147.244 22.3546C146.234 22.3197 145.598 22.3021 144.868 22.3021C144.064 22.3021 143.428 22.337 142.698 22.3546C142.586 22.3021 142.549 22.0243 142.661 21.9201L142.979 21.8682C144.027 21.6942 144.064 21.5202 144.064 19.6949V13.4363C144.064 11.6108 143.933 11.3156 142.96 11.246L142.474 11.2111C142.362 11.1416 142.399 10.8284 142.511 10.7763C143.428 10.7938 144.064 10.8284 144.868 10.8284C145.598 10.8284 146.234 10.811 147.038 10.7763C147.151 10.8284 147.188 11.1416 147.076 11.2111L146.72 11.246C145.635 11.3503 145.598 11.6108 145.598 13.4363V15.4353C145.598 15.9741 145.635 15.9918 146.533 15.9918H151.883C152.782 15.9918 152.819 15.9741 152.819 15.4353V13.4363C152.819 11.6108 152.782 11.3503 151.678 11.246L151.322 11.2111C151.21 11.1416 151.247 10.8284 151.36 10.7763C152.221 10.811 152.856 10.8284 153.623 10.8284C154.353 10.8284 154.989 10.811 155.831 10.7763C155.943 10.8284 155.98 11.1416 155.868 11.2111L155.476 11.246C154.391 11.3503 154.353 11.6108 154.353 13.4363V19.6949C154.353 21.5202 154.391 21.7463 155.476 21.8682L155.925 21.9201C156.037 21.9896 155.999 22.3021 155.887 22.3546C154.989 22.3197 154.353 22.3021 153.623 22.3021C152.856 22.3021 152.183 22.3197 151.36 22.3546C151.247 22.3021 151.21 22.0243 151.322 21.9201L151.678 21.8682C152.819 21.6942 152.819 21.5202 152.819 19.6949V17.2434C152.819 16.7218 152.782 16.6872 151.883 16.6872H146.533Z"" fill=""white""/><path d=""M72.9825 26.1757C74.5201 24.9795 76.4791 24.3919 78.6698 24.3919C79.807 24.3919 81.4076 24.6225 82.3979 24.8956C82.6507 24.9585 82.7981 25.0007 82.9876 24.9795C83.0086 25.4624 83.114 26.7842 83.2824 28.0648C83.1772 28.2117 82.8613 28.233 82.7139 28.107C82.3979 26.6798 81.45 25.0422 78.3958 25.0422C75.173 25.0422 72.4348 27.0785 72.4348 31.4232C72.4348 35.8309 75.2362 38.2659 78.6906 38.2659C81.4076 38.2659 82.6085 36.5026 83.0928 35.264C83.2404 35.1596 83.5566 35.2011 83.6405 35.3482C83.4934 36.4397 82.9454 37.8247 82.6295 38.2239C82.3767 38.2659 82.1242 38.3498 81.8924 38.4333C81.4288 38.6019 79.9124 38.9164 78.5642 38.9164C76.6687 38.9164 74.8573 38.5389 73.3195 37.5099C71.6343 36.3555 70.3285 34.4461 70.3285 31.7385C70.3285 29.4081 71.3817 27.4143 72.9825 26.1757Z"" fill=""white""/><path d=""M95.5106 33.3289C95.5106 30.4603 94.1783 27.3657 90.6917 27.3657C88.7933 27.3657 86.3293 28.6001 86.3293 32.4077C86.3293 34.9804 87.6434 38.3185 91.2392 38.3185C93.4299 38.3185 95.5106 36.7538 95.5106 33.3289ZM84.5036 32.9637C84.5036 29.4867 87.2418 26.827 91.0022 26.827C95.2186 26.827 97.3361 29.73 97.3361 32.7899C97.3361 36.3018 94.5249 38.8573 91.0022 38.8573C86.9499 38.8573 84.5036 36.0929 84.5036 32.9637Z"" fill=""white""/><path d=""M117.93 31.4711C117.93 30.3933 117.893 28.3935 117.58 27.8724C117.451 27.6637 117.119 27.5418 116.658 27.5069L116.198 27.4723C116.088 27.3506 116.124 27.1247 116.235 27.0549C116.935 27.0896 117.617 27.1073 118.335 27.1073C119.11 27.1073 119.607 27.0896 120.271 27.0554C120.418 27.1424 120.4 27.3681 120.307 27.4723L119.865 27.5069C119.404 27.5418 119.054 27.6984 118.944 27.9245C118.686 28.498 118.686 30.4975 118.686 31.4711V33.4355C118.686 34.9483 118.427 36.5474 117.396 37.5903C116.603 38.4076 115.24 38.8596 113.876 38.8596C112.605 38.8596 111.333 38.6335 110.43 37.9035C109.453 37.1388 108.993 35.8695 108.993 33.8009V29.6977C108.993 27.8899 108.956 27.5942 107.887 27.5069L107.426 27.4723C107.316 27.4027 107.352 27.1075 107.463 27.0549C108.385 27.0896 109.011 27.1073 109.748 27.1073C110.504 27.1073 111.112 27.0896 112.015 27.0554C112.125 27.1075 112.162 27.4027 112.052 27.4723L111.609 27.5069C110.54 27.5942 110.504 27.8899 110.504 29.6977V33.4529C110.504 36.2517 111.425 38.0949 114.244 38.0949C116.916 38.0949 117.93 36.1126 117.93 33.4706V31.4711Z"" fill=""white""/><path d=""M141.018 35.706C141.018 36.3381 141.058 37.2334 141.445 37.6199C141.832 38.0238 142.443 38.1115 143.054 38.1115C144.867 38.1115 146.252 37.4091 146.252 35.6532C146.252 34.266 145.437 32.6511 142.199 32.6511C141.099 32.6511 141.018 32.7558 141.018 33.1073V35.706ZM141.018 31.632C141.018 32.1241 141.038 32.159 142.076 32.1241C144.154 32.0538 145.274 31.5271 145.274 29.8763C145.274 28.1555 143.788 27.5056 142.24 27.5056C141.791 27.5056 141.486 27.5408 141.303 27.6113C141.099 27.6639 141.018 27.7516 141.018 28.0675V31.632ZM139.347 29.2969C139.347 27.9975 139.266 27.6639 138.349 27.5938L137.697 27.5304C137.623 27.4634 137.584 27.1116 137.718 27.1017C138.818 27.0194 140.203 26.9617 142.097 26.9617C143.38 26.9617 144.602 27.0494 145.519 27.4528C146.395 27.8218 147.067 28.5243 147.067 29.6483C147.067 30.9121 146.211 31.5622 144.989 32.0538C144.989 32.2295 145.152 32.2821 145.376 32.3172C146.476 32.4926 148.106 33.371 148.106 35.2493C148.106 37.286 146.354 38.6557 142.688 38.6557C142.097 38.6557 141.099 38.6032 140.244 38.6032C139.347 38.6032 138.655 38.6381 137.901 38.6557C137.779 38.6032 137.738 38.3223 137.86 38.2172L138.227 38.1644C139.307 38.0064 139.347 37.813 139.347 35.9696V29.2969Z"" fill=""white""/><path d=""M99.1234 16.2084C98.773 16.2084 98.0725 16.3388 98.0725 15.8736V12.5388C98.0725 11.2351 98.114 11.0486 99.6797 11.0486C101.513 11.0486 102.646 11.9797 102.646 13.6935C102.646 14.4388 102.379 15.128 101.699 15.5937C100.916 16.1342 100.071 16.2084 99.1234 16.2084ZM106.157 21.9212L105.674 21.8795C105.576 21.8691 105.49 21.8568 105.407 21.8431C104.701 21.7182 104.419 21.0896 104.086 20.5062L102.418 17.6001C102.129 17.1158 101.82 16.4638 101.161 16.3709C102.871 16.1658 104.416 15.1787 104.416 13.4836C104.416 11.5273 102.479 10.652 100.522 10.652C99.3477 10.652 98.2774 10.6838 97.0824 10.6838C96.4234 10.6838 95.6391 10.652 94.9801 10.652C94.6139 10.652 94.6092 10.7265 94.6092 10.9314C94.6092 11.2337 94.7368 11.1491 95.1246 11.171C96.5168 11.2493 96.4635 11.5089 96.4635 12.701V20.3202C96.4635 21.4105 96.5578 21.7361 95.413 21.8387C95.413 21.8387 95.2376 21.8568 95.1381 21.8674L94.6531 21.9172C94.5371 22.0212 94.5762 22.2994 94.6917 22.3515C94.9497 22.3421 95.4069 22.3242 95.4069 22.3242C96.0407 22.3053 96.6743 22.257 97.3081 22.257C97.9454 22.257 98.5552 22.306 99.1819 22.3244V22.3249C99.4043 22.3319 99.6393 22.3397 99.8966 22.3489C100.013 22.2968 100.052 22.0188 99.9353 21.9146L99.4472 21.8684C99.3477 21.8578 99.1765 21.8424 99.1765 21.8424C98.0204 21.7642 98.0914 21.4381 98.0914 20.3202V17.4513C98.0914 17.2836 98.0702 16.8368 98.1942 16.7062C98.2972 16.594 98.4823 16.6128 98.6471 16.6128C100.214 16.6128 100.192 16.7621 100.934 18.066L102.953 21.6984C103.118 21.978 103.242 22.3317 103.654 22.3317H105.408C105.629 22.3388 105.861 22.3461 106.118 22.3555C106.233 22.3034 106.272 22.0252 106.157 21.9212Z"" fill=""white""/><path d=""M99.5001 29.7566C99.5001 27.9313 99.4619 27.6526 98.2575 27.5658L97.7791 27.5312C97.6645 27.4616 97.7027 27.149 97.8173 27.0964C98.8885 27.1313 99.5383 27.1485 100.303 27.1485C101.049 27.1485 101.699 27.1313 102.656 27.0971C102.77 27.149 102.808 27.4616 102.694 27.5312L102.235 27.5658C101.107 27.6526 101.068 27.9313 101.068 29.7566V35.8067C101.068 36.902 101.126 37.354 101.47 37.6841C101.68 37.8751 102.044 38.084 103.554 38.084C105.18 38.084 105.581 38.0142 105.888 37.8581C106.27 37.6492 106.767 37.0237 107.149 36.1369C107.265 36.0503 107.628 36.1192 107.628 36.2411C107.628 36.4325 107.092 38.2059 106.824 38.6749C105.849 38.6403 104.032 38.6228 102.062 38.6228H100.303C99.5001 38.6228 98.8885 38.6403 97.8173 38.6749C97.7027 38.6228 97.6645 38.3446 97.7791 38.2404L98.353 38.1885C99.4619 38.084 99.5001 37.8405 99.5001 36.0154V29.7566Z"" fill=""white""/><path d=""M150.731 29.7912C150.731 27.9488 150.693 27.6528 149.586 27.5658L149.116 27.5314C149.004 27.4616 149.041 27.1492 149.154 27.0964C150.092 27.1315 150.731 27.1487 151.519 27.1487C152.27 27.1487 152.909 27.1315 153.848 27.0971C153.96 27.1492 153.998 27.4616 153.885 27.5314L153.415 27.5658C152.308 27.6528 152.27 27.9488 152.27 29.7912V35.9808C152.27 37.8235 152.308 38.0668 153.415 38.1885L153.885 38.2406C153.998 38.3101 153.96 38.6228 153.848 38.6751C152.909 38.6403 152.27 38.6228 151.519 38.6228C150.731 38.6228 150.092 38.6403 149.154 38.6751C149.041 38.6228 149.004 38.3446 149.116 38.2406L149.586 38.1885C150.693 38.0668 150.731 37.8235 150.731 35.9808V29.7912Z"" fill=""white""/><path d=""M135.728 38.1849C135.631 38.1746 135.451 38.1604 135.451 38.1604C135.254 38.1406 135.076 38.1121 134.936 37.9588C134.692 37.6999 134.712 36.9624 134.712 36.6671V29.0494C134.712 28.7172 134.631 27.998 134.875 27.7394C134.997 27.6033 135.25 27.5805 135.476 27.5677V27.5668C135.613 27.5564 135.616 27.5559 135.736 27.55L136.219 27.5156C136.335 27.4458 136.296 27.1332 136.18 27.0808C135.922 27.0898 135.688 27.0865 135.465 27.0933V27.0943H133.414C133.191 27.0943 132.988 27.0943 132.866 27.3341L128.686 36.0402L124.994 27.6293C124.872 27.3341 124.852 27.0943 124.466 27.0943H122.331C122.109 27.0874 121.863 27.0898 121.605 27.0808C121.49 27.1332 121.451 27.4458 121.567 27.5156L122.049 27.55C122.149 27.5581 122.329 27.5703 122.329 27.5703C123.13 27.6217 123.18 27.8007 123.107 28.6436L122.478 36.8145C122.423 37.6351 122.378 38.0687 121.518 38.1486C121.518 38.1486 121.337 38.1713 121.237 38.1819L120.755 38.2342C120.639 38.338 120.678 38.6162 120.794 38.6683C121.048 38.6589 121.5 38.6457 121.5 38.6457C121.936 38.6242 122.379 38.5855 122.823 38.5855C123.302 38.5855 123.781 38.6308 124.26 38.6499V38.6509C124.483 38.6577 124.717 38.6655 124.975 38.6744C125.091 38.6223 125.13 38.3443 125.014 38.2401L124.532 38.188C124.405 38.1781 124.262 38.164 124.262 38.164C123.022 38.0791 123.05 37.2036 123.127 36.1326L123.716 28.5333H123.858L127.855 37.8848C127.895 38.0138 127.956 38.2352 128.159 38.2352C128.342 38.2352 128.403 38.0326 128.463 37.9029L132.967 28.3112H133.109V36.6671C133.109 36.9991 133.15 37.6818 132.805 37.9397C132.625 38.0739 132.039 38.1545 132.039 38.1545C131.958 38.1673 131.873 38.179 131.777 38.1892L131.295 38.2411C131.179 38.3453 131.218 38.6233 131.334 38.6756C131.588 38.6664 132.039 38.6523 132.039 38.6523C132.693 38.6341 133.357 38.5855 134.022 38.5855C134.5 38.5855 135.437 38.6311 135.437 38.6311C135.66 38.6379 135.914 38.6622 136.172 38.6714C136.288 38.6193 136.326 38.3413 136.21 38.2373L135.728 38.1849Z"" fill=""white""/><path d=""M162.012 33.9263H159.754C159.676 33.9263 159.048 34.0001 159.048 33.816C159.048 33.7605 159.087 33.65 159.106 33.595L160.461 30.2402C160.5 30.148 160.638 29.687 160.795 29.687C160.913 29.687 161.07 30.1664 161.109 30.2402L162.444 33.3734C162.444 33.4104 162.581 33.7054 162.581 33.7792C162.581 33.9819 162.13 33.9263 162.012 33.9263ZM167.08 38.2295L167.015 38.1774C166.919 38.1672 166.833 38.1557 166.752 38.1423C166.001 37.9744 165.708 37.0689 165.43 36.4238L161.561 27.2671C161.522 27.1572 161.446 26.9202 161.293 26.9202C161.082 26.9202 161.025 27.1756 160.967 27.3211L157.271 36.4604C157.136 36.807 156.792 37.6466 156.543 37.9013C156.352 38.0967 156.103 38.1342 155.838 38.1616C155.838 38.1616 155.63 38.1814 155.53 38.1922L155.076 38.2385C154.96 38.3424 154.999 38.6207 155.115 38.673C155.372 38.6638 155.83 38.6471 155.83 38.6471C156.335 38.6402 156.841 38.5763 157.347 38.5763C157.773 38.5763 158.199 38.6216 158.624 38.6405C158.624 38.6405 159.081 38.6568 159.339 38.6667C159.455 38.6141 159.493 38.3358 159.378 38.2319L158.895 38.1795C158.799 38.1696 158.633 38.154 158.633 38.154C158.189 38.1048 157.635 38.0253 157.635 37.5363C157.635 37.208 157.788 36.8249 157.903 36.533L158.477 35.1654C158.765 34.5089 158.65 34.4354 159.415 34.4354H162.021C162.94 34.4354 162.805 34.4354 163.208 35.3663L163.821 36.7518C163.917 36.9895 164.089 37.3906 164.089 37.6466C164.089 38.1048 163.588 38.1349 163.121 38.1746C163.121 38.1746 162.966 38.1875 162.831 38.1979L162.367 38.2316C162.251 38.3356 162.29 38.6138 162.406 38.6662C162.664 38.6568 163.121 38.6381 163.121 38.6381C163.666 38.6183 164.214 38.5763 164.74 38.5763C165.411 38.5763 166.082 38.6219 166.752 38.641V38.6402C166.973 38.6471 166.787 38.6549 167.041 38.6641C167.157 38.6117 167.196 38.3335 167.08 38.2295Z"" fill=""white""/><path d=""M53.6069 25.5067L54.8752 26.0325L57.688 24.0707L53.6069 25.5067Z"" fill=""#E3A82B""/><path d=""M6.34557 23.3141L3.01172 22.1411L3.17889 21.7327L6.9334 22.9845L6.94967 22.9753L7.44507 22.6945L7.64266 22.5707L3.54861 20.8291L3.72168 20.4009L12.8595 24.0967L13.1609 23.9717L4.09824 19.5554L4.30032 19.1404L13.9041 23.61L14.0369 23.5426L4.72498 18.2609L4.9162 17.8643L18.3632 25.1811C18.4733 24.9776 18.7039 24.6067 18.8222 24.4073C13.7098 19.6004 8.77635 15.9914 8.77635 15.9914C8.77635 15.9914 13.8499 19.3891 20.1116 22.548C20.3183 22.2898 20.4881 22.0826 20.709 21.8376L9.23732 11.7382L9.54526 11.422L18.8041 19.3132L10.2262 10.7231L10.5474 10.3906L20.178 19.698L11.2133 9.74786L11.5561 9.43874L19.8418 18.3111L12.2793 8.78229L12.6049 8.48614L22.2988 20.2833C22.5494 20.067 22.7576 19.9043 23.0198 19.7034C20.0875 13.3578 16.8852 8.19588 16.8852 8.19588C16.8852 8.19588 20.2936 13.2131 24.8922 18.4674C25.1731 18.3092 25.4579 18.1576 25.7489 18.0149L25.7 17.9834L18.9064 4.4251L19.3103 4.24755L24.9389 15.0322L20.2035 3.85401L20.6258 3.66656L26.0686 15.9037L21.4836 3.31971L21.9175 3.16149L26.2763 14.492L22.8338 2.82384L23.2471 2.67152L27.779 17.1435L27.7703 17.1817L27.7816 17.1772C28.083 17.076 28.3895 16.9869 28.6977 16.903C28.3527 9.95182 27.3244 4.00563 27.3244 4.00563C27.3244 4.00563 28.5977 9.89947 30.8806 16.4712C31.1985 16.4321 31.5184 16.3988 31.841 16.3771L31.8309 16.362H31.8705L31.8478 16.3288L30.6279 1.21315L31.0688 1.19924L32.2473 13.3076L32.0447 1.16953L32.5059 1.15397L32.9686 14.5389L33.4307 1.15373L33.8929 1.16953L33.6898 13.3076L34.8686 1.19947L35.3093 1.21315L34.0893 16.3288L34.0664 16.362H34.073L34.0697 16.3668H34.0897C34.4052 16.3866 34.7181 16.4182 35.0287 16.4554C37.3085 9.89004 38.5797 4.00563 38.5797 4.00563C38.5797 4.00563 37.5545 9.9339 37.2079 16.8723C37.5191 16.9546 37.827 17.0449 38.1305 17.1444L42.6464 2.72269L43.0602 2.87524L39.6172 14.5434L43.9765 3.2129L44.4099 3.37135L39.8247 15.9551L45.2674 3.71773L45.6902 3.90542L40.9546 15.0838L46.5834 4.29895L46.9871 4.4765L40.2175 17.9862L40.229 17.9909C40.508 18.1267 40.781 18.2717 41.0513 18.4217C45.6301 13.1841 49.0189 8.19588 49.0189 8.19588C49.0189 8.19588 45.8385 13.3225 42.9147 19.6372C43.176 19.8343 43.4316 20.038 43.6796 20.25L53.2596 8.58116L53.5864 8.87755L46.0229 18.4064L54.3093 9.534L54.6515 9.84335L45.6864 19.7931L55.3171 10.4857L55.6385 10.8181L47.0606 19.4085L56.3195 11.5177L56.6274 11.8332L45.2957 21.8187L45.3023 21.8256C45.5002 22.046 45.6907 22.2736 45.8777 22.5047C52.0997 19.3585 57.1278 15.9914 57.1278 15.9914C57.1278 15.9914 52.2422 19.5653 47.1564 24.3377C47.2957 24.5702 47.5207 24.9673 47.6492 25.2068L60.9056 17.989L61.0973 18.3863L50.5152 24.3879L61.5215 19.2658L61.7233 19.6808L51.4716 24.6763L51.6682 24.7449L62.0999 20.5257L62.2732 20.9541L52.577 25.0783L52.7583 25.1535L59.2195 22.9996L60.1933 22.3198L60.5165 22.5667L62.6427 21.8579L62.8099 22.2658L60.9704 22.913L63.6281 24.9411L64.4797 25.416C61.0629 11.1322 48.2141 0.512848 32.8834 0.512848C17.2835 0.512848 4.25339 11.5088 1.11595 26.1719C1.15627 26.1523 1.19518 26.1342 1.2355 26.1144L1.62479 25.938L1.86365 25.8265L6.34557 23.3141Z"" fill=""#E3A82B""/><path d=""M0.933402 38.9104C0.933402 38.9104 5.72586 37.9534 9.7263 37.9534C20.2667 37.9534 34.8473 43.8885 45.4268 43.8885C53.1876 43.8885 60.757 41.7595 64.8822 38.6555C65.2045 36.8192 65.3733 34.9305 65.3733 33.0017C65.3733 30.3896 65.0633 27.8504 64.4809 25.4163L60.0704 22.9568L54.8955 26.5859L51.4142 25.2303C50.2358 25.8259 42.9649 30.6882 42.9649 30.6882L40.1743 28.6681L37.1802 28.0751L33.1878 25.1685L28.6082 28.3126C28.6082 28.3126 23.4989 31.2793 23.3235 31.2793C23.1471 31.2793 17.1589 26.5321 17.1589 26.5321L14.3999 23.6255C13.93 23.9221 12.0533 24.7832 12.0533 24.7832L11.9569 24.8087L10.1408 24.247L7.93547 23.0773L1.23663 26.1147C1.19631 26.1345 1.1574 26.1529 1.11708 26.1725C0.645737 28.3746 0.395798 30.6589 0.395798 33.0017C0.395798 35.0196 0.58113 36.9944 0.933402 38.9104Z"" fill=""#65799E""/></svg>')

---FILE: data-raw/scripts/bigshinygisstudio.R---
@@ -106,6 +106,7 @@ analogsea::debian_apt_get_install(server,
                                   ""chromium-browser"")
 analogsea::droplet_ssh(server, ""R -e \""install.packages('remotes')\"""")
 
+droplet_ssh(server, ""rm -R /srv/shiny-server/ccissdev/server"")
 # upload app to server
 server <- analogsea::droplets()$`shiny-server`
 reset_ssh_sessions()"
bcgov,CCISS_ShinyApp,32c7372b47645a017506834348bc69790595a766,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-09-27T22:18:36Z,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-09-27T22:18:36Z,Another bug fix,app/server/feasibility.R;app/server/reporthtml.Rmd,True,True,True,False,38,32,70,"---FILE: app/server/feasibility.R---
@@ -45,38 +45,43 @@ cciss_results_dt <- function(data, siteref, siteserie, filter, format = ""html"")
 
   data <- data[SiteRef == siteref & SS_NoSpace %in% siteserie,
                .(Species, Period, PredFeasSVG, CFSuitability, Curr, EstabFeas, ccissFeas, Trend)]
-  data[Curr == 4,Curr := ""X""]
-  data[Curr != ""X"", Curr := paste0(""E"", Curr)]
-  data[!EstabFeas %in% c(""X"",""Trial""), EstabFeas := paste0(""E"", EstabFeas)]
-  data[ccissFeas != ""X"", ccissFeas := paste0(""E"", ccissFeas)]
-  # for(i in 1:ncol(data)){
-  #   data[,(i) := cell_spec(get(names(data)[i]),
-  #                          popover = spec_popover(
-  #                            content = hoverText[i],
-  #                            title = NULL,                           # title will add a Title Panel on top
-  #                            position = ""right""
-  #                          ))]
-  # }
-  # data[,lapply(.SD, function(x){cell_spec(x,font_size = 24)}),
-  #      .SDcols = c(""CFSuitability"",""Curr"",""EstabFeas"",""ccissFeas"")]
+  if(nrow(data) > 0){
+    data[Curr == 4,Curr := ""X""]
+    data[Curr != ""X"", Curr := paste0(""E"", Curr)]
+    data[!EstabFeas %in% c(""X"",""Trial""), EstabFeas := paste0(""E"", EstabFeas)]
+    data[ccissFeas != ""X"", ccissFeas := paste0(""E"", ccissFeas)]
+    # for(i in 1:ncol(data)){
+    #   data[,(i) := cell_spec(get(names(data)[i]),
+    #                          popover = spec_popover(
+    #                            content = hoverText[i],
+    #                            title = NULL,                           # title will add a Title Panel on top
+    #                            position = ""right""
+    #                          ))]
+    # }
+    # data[,lapply(.SD, function(x){cell_spec(x,font_size = 24)}),
+    #      .SDcols = c(""CFSuitability"",""Curr"",""EstabFeas"",""ccissFeas"")]
+    
+    tempTable <- knitr::kable(
+      data, format = format, align = c(""l"",""c"",""c"",""c"",""c"",""c"",""c"",""c""), escape = FALSE,
+      col.names = c(""Tree Species"", ""Period"", ""Modelled Feasibility"",
+                    ""CFRG"", ""Environmental"",""Establishment"",
+                    ""Future (cciss)"",""<u>Improve/Same</u><br />Decline/Unsuitable""),
+      table.attr = 'class=""table table-hover""') %>%
+      add_header_above(c("" "" = 2, ""Raw Votes"" = 1, ""Historic"" = 2, 
+                         ""Projected Feasibility"" = 2, ""Trend"" = 1)) %>%
+      column_spec(4:8,bold = T, extra_css = ""vertical-align:middle;"") %>%
+      column_spec(1, tooltip = hoverText[1]) %>%
+      column_spec(2, tooltip = hoverText[2]) %>%
+      column_spec(3, tooltip = hoverText[3]) %>%
+      column_spec(4, tooltip = hoverText[4]) %>%
+      column_spec(5, tooltip = hoverText[5]) %>%
+      column_spec(6, tooltip = hoverText[6]) %>%
+      column_spec(7, tooltip = hoverText[7]) %>%
+      column_spec(8, tooltip = hoverText[8]) %>%
+      kable_styling(full_width = F, font_size = 16)
+  }else{
+    NULL
+  }
   
-  tempTable <- knitr::kable(
-    data, format = format, align = c(""l"",""c"",""c"",""c"",""c"",""c"",""c"",""c""), escape = FALSE,
-    col.names = c(""Tree Species"", ""Period"", ""Modelled Feasibility"",
-                  ""CFRG"", ""Environmental"",""Establishment"",
-                  ""Future (cciss)"",""<u>Improve/Same</u><br />Decline/Unsuitable""),
-    table.attr = 'class=""table table-hover""') %>%
-    add_header_above(c("" "" = 2, ""Raw Votes"" = 1, ""Historic"" = 2, 
-                       ""Projected Feasibility"" = 2, ""Trend"" = 1)) %>%
-    column_spec(4:8,bold = T, extra_css = ""vertical-align:middle;"") %>%
-    column_spec(1, tooltip = hoverText[1]) %>%
-    column_spec(2, tooltip = hoverText[2]) %>%
-    column_spec(3, tooltip = hoverText[3]) %>%
-    column_spec(4, tooltip = hoverText[4]) %>%
-    column_spec(5, tooltip = hoverText[5]) %>%
-    column_spec(6, tooltip = hoverText[6]) %>%
-    column_spec(7, tooltip = hoverText[7]) %>%
-    column_spec(8, tooltip = hoverText[8]) %>%
-    kable_styling(full_width = F, font_size = 16)
 }
 uData$cciss_results_dt <- cciss_results_dt

---FILE: app/server/reporthtml.Rmd---
@@ -139,6 +139,7 @@ htmltools::tagList(
     siteseries <- siteseries[siteseries %in% cciss_results$SS_NoSpace] ##sometimes error here
     htmltools::tagList(
       mapply(FUN = function(siteserie, nm) {
+        cat(siteserie,nm)
         siteserie2 <- gsub(""/"",""_"",siteserie)
         htmltools::tagList(
           tags$h2(paste0(""Site Unit "", siteserie2)),"
bcgov,CCISS_ShinyApp,7649eada39227de9676d735e6341bae159145fe7,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-09-27T21:21:31Z,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-09-27T21:21:31Z,fix,.gitignore,False,False,False,False,1,0,1,"---FILE: .gitignore---
@@ -7,6 +7,7 @@ docs
 .RData
 .Rproj.user
 .Rhistory
+.Renviron
 inst/doc
 .httr-oauth
 *.RDS"
bcgov,CCISS_ShinyApp,f301c8c8ed72d9a2626555097088b701cea66fa4,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-09-27T21:17:47Z,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-09-27T21:17:47Z,Bug fixes,app/server/download.R;app/server/feasibility.R;app/server/generate.R;app/server/reporthtml.Rmd,True,True,True,False,8,5,13,"---FILE: app/server/download.R---
@@ -78,7 +78,6 @@ output$report_download <- downloadHandler(
 )
 
 output$data_download <- downloadHandler(
-  # For PDF output, change this to ""report.pdf""
   filename = function() {
     paste(""cciss_export"", input$data_format, sep = ""."")
   },

---FILE: app/server/feasibility.R---
@@ -32,10 +32,11 @@ cciss_results_dt <- function(data, siteref, siteserie, filter, format = ""html"")
     }
     data <- data[(NewSuit_1991 < 4 | NewSuit_2021 < 4 | NewSuit_2041 < 4 |NewSuit_2061 < 4 | NewSuit_2081 < 4),]
   }else if (filter == ""f""){
-    data <- data[Curr %in% c(1,2,3) | CFSuitability %in% c(1,2,3) | ccissFeas %in% c(1,2,3),]
+    data <- data[Curr %in% c(1,2,3) | CFSuitability %in% c(1,2,3),]
   }
   data[,Trend := paste0(""SU"", Improve,""EUPUPPY"",Decline)] ##have to do this so the br isn't escaped by cell_spec
-  data <- data[!is.na(Trend),]
+  data <- data[!is.na(Trend) & !is.na(Improve),]
+  #print(data[,.(Trend,Improve)])
   data[,Trend := cell_spec(Trend,""html"", color = fifelse(Improve > 67,'green',fifelse(Improve < 33, ""red"",""purple"")))]
   data[,Trend := gsub(""PUPPY"",""<br />"",Trend)]
   data[,Trend := gsub(""SU"",""<u>"",Trend)]

---FILE: app/server/generate.R---
@@ -258,6 +258,7 @@ cciss_results <- function(cciss, pts, avg, type, SS = ccissdev::stocking_standar
       )
     )]
     
+    results <- results[!is.na(ProjFeas),]
     setorder(results, SiteRef, SS_NoSpace, OrderCol, na.last = TRUE)
     return(results)
   })

---FILE: app/server/reporthtml.Rmd---
@@ -20,13 +20,14 @@ suppressPackageStartupMessages({
 })
 opts_chunk$set(echo = FALSE, eval = TRUE, include = TRUE, message = FALSE, warning = FALSE)
 
-# Debug mode
-# userdata <- readRDS(""../../report.rds"")
+#Debug mode
+# userdata <- readRDS(""../cciss_export.rds"")
 # for (nm in names(userdata)) {assign(nm, userdata[[nm]])}
 
 # Deployment mode
 # assign in current environment
 for (nm in names(params$userdata)) {assign(nm, params$userdata[[nm]])}
+cciss_results <- cciss_results[!is.na(ProjFeas),]
 
 # Env variable for map
 bcgov_tileserver <- Sys.getenv(""BCGOV_TILESERVER"")
@@ -135,6 +136,7 @@ htmltools::tagList(
   lapply(names(siteseries_list), function(siteref) {
     siteseries <- siteseries_list[[siteref]]
     siteseries <- siteseries[siteseries %in% site_series_filter]
+    siteseries <- siteseries[siteseries %in% cciss_results$SS_NoSpace] ##sometimes error here
     htmltools::tagList(
       mapply(FUN = function(siteserie, nm) {
         siteserie2 <- gsub(""/"",""_"",siteserie)"
bcgov,CCISS_ShinyApp,28c9842a1ab0849d4b937870c1f77aa5d5d09349,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-09-26T02:54:24Z,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-09-26T02:54:24Z,Fix so Pam doesn't make it crash,app/server/map.R,False,True,True,False,4,0,4,"---FILE: app/server/map.R---
@@ -78,8 +78,12 @@ observeEvent(input$bec_map_click, {
 observeEvent(input$preselected,{
   print(input$preselected)
   if(input$preselected == ""BGC_Dist""){
+    userpoints$dt <- uData$basepoints
+    clear_mk()
     session$sendCustomMessage(""selectDist"",""puppy"")
   }else if(input$preselected == ""BGC""){
+    userpoints$dt <- uData$basepoints
+    clear_mk()
     session$sendCustomMessage(""selectBGC"",""puppy"")
     session$sendCustomMessage(""typeFlag"",""select"")
   }else{"
bcgov,CCISS_ShinyApp,a41f30a4476e80fdc830d8c69a79ae3fa386b891,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-09-23T21:54:05Z,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-09-23T21:54:05Z,Fixed spatial futures,app/server/futures.R;app/server/generate.R,False,True,True,False,5,3,8,"---FILE: app/server/futures.R---
@@ -71,8 +71,10 @@ observe({
   data <- copy(uData$bgc)
   if(!is.null(data) & !is.null(siteref)){
     data <- data[SiteRef == siteref & FuturePeriod == timeper,]
-    dat <- data.table(BGC = c(data$BGC[1],data$BGC.pred),
-                      Col = c(""#000000"",colourvalues::colour_values(data$BGC.prop,include_alpha = F)))
+    data <- data[BGC.prop > 0.034,] ##exclude single model predictions
+    dat <- data.table(BGC = c(data$BGC.pred,data$BGC[1]),
+                      Col = c(colourvalues::colour_values(c(0,1,data$BGC.prop),palette = ""plasma"", 
+                                                          include_alpha = F)[-(1:2)],""#FFFB00""))
     session$sendCustomMessage(""colour_wna"",dat)
   }
 })

---FILE: app/server/generate.R---
@@ -163,7 +163,7 @@ bgc <- function(con, siteno, avg, modWeights) {
 # ""4055121"", ""2243917"", ""1944094"", ""4125428"", ""4635548"", ""5737786"", 
 # ""5321717"", ""1703309"", ""1338735"", ""1313609"", ""1345347"", ""1741741"", 
 # ""3457355"", ""3606245""))
-#bgc <- dbGetCCISS(pool,siteno = 4954059, avg = T, modWeights = all_weight)
+#bgc <- dbGetCCISS(pool,siteno = 1958596, avg = T, modWeights = all_weight)
 # bgc <- sqlTest(pool,siteno = c(6476259,6477778,6691980,6699297),avg = T, scn = ""ssp370"")
 
 "
bcgov,CCISS_ShinyApp,1f2cd7f6e8b0dd059e34a32f09d5c285f9198a90,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-09-21T21:18:56Z,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-09-21T21:18:56Z,Yet another bug,app/server/generate.R,False,True,True,False,1,0,1,"---FILE: app/server/generate.R---
@@ -246,6 +246,7 @@ cciss_results <- function(cciss, pts, avg, type, SS = ccissdev::stocking_standar
     results[, `:=`(
       Species = T1[Spp, paste(paste0(""<b>"", TreeCode, ""</b>""), EnglishName, sep = "": "")],
       Period = paste0(period_map, collapse = ""<br />""),
+      ProjFeas = EstabFeas,
       PredFeasSVG = paste0(
         feasibility_svg(`1_1961`,`2_1961`,`3_1961`,`X_1961`), ""<br />"",
         feasibility_svg(`1_1991`,`2_1991`,`3_1991`,`X_1991`), ""<br />"","
bcgov,CCISS_ShinyApp,872b24c8b9cfb2b71762ec6a344abd19f4a50438,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-09-21T19:32:31Z,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-09-21T19:32:31Z,Bug fix,R/feasibility.R;app/server/feasibility.R;app/server/generate.R,False,True,True,False,8,7,15,"---FILE: R/feasibility.R---
@@ -137,7 +137,7 @@ ccissOutput <- function(SSPred,suit,rules,feasFlag,histWeights,futureWeights){
   summOut[,c(""Curr"",""ccissSuit"") := lapply(.SD,function(x){fifelse(x >= 4,""X"",x)}), 
           .SDcols = c(""Curr"",""ccissSuit"")]
   summOut[is.na(NewSuit) | NewSuit == 4,NewSuit := ""X""]
-  summOut[NewSuit == ""X"" & ccissSuit %in% c(""1"",""2"",""3""), NewSuit := ""Trial""]
+  #summOut[NewSuit == ""X"" & ccissSuit %in% c(""1"",""2"",""3""), NewSuit := ""Trial""]
   summOut <- summOut[!is.na(ccissSuit),]
   print(""Done Feas"")
   return(list(Summary = summOut, Raw = suitVotes))

---FILE: app/server/feasibility.R---
@@ -19,6 +19,13 @@ output$results_feas <- function() {
 # Dual utility function to format dt, app mode and report mode use different
 # format. Report has no javascript, just a plain table.
 cciss_results_dt <- function(data, siteref, siteserie, filter, format = ""html"") {
+  data[,Curr := as.character(Curr)]
+  for(i in c(""Curr"",""EstabFeas"",""CFSuitability"")){ ##set NA to X
+    data[is.na(get(i)) | get(i) == 4, (i) := ""X""]
+  }
+  #print(data[,.(CFSuitability,Curr,ccissFeas)])
+  data[CFSuitability == ""X"" & Curr == ""X"" 
+          & ccissFeas %in% c(1,2,3), EstabFeas := ""Trial""]
   if(filter == ""a""){
     for(i in c(""NewSuit_1991"",""NewSuit_2021"",""NewSuit_2041"",""NewSuit_2061"",""NewSuit_2081"")){ ##set NA to X
       data[is.na(get(i)), (i) := 4]
@@ -37,11 +44,7 @@ cciss_results_dt <- function(data, siteref, siteserie, filter, format = ""html"")
 
   data <- data[SiteRef == siteref & SS_NoSpace %in% siteserie,
                .(Species, Period, PredFeasSVG, CFSuitability, Curr, EstabFeas, ccissFeas, Trend)]
-  data[,Curr := as.character(Curr)]
   data[Curr == 4,Curr := ""X""]
-  for(i in c(""Curr"",""EstabFeas"")){ ##set NA to X
-    data[is.na(get(i)), (i) := ""X""]
-  }
   data[Curr != ""X"", Curr := paste0(""E"", Curr)]
   data[!EstabFeas %in% c(""X"",""Trial""), EstabFeas := paste0(""E"", EstabFeas)]
   data[ccissFeas != ""X"", ccissFeas := paste0(""E"", ccissFeas)]

---FILE: app/server/generate.R---
@@ -241,13 +241,11 @@ cciss_results <- function(cciss, pts, avg, type, SS = ccissdev::stocking_standar
       on = c(""SiteRef"",""SS_NoSpace"",""Spp"")
     ]
     
-    results[is.na(CFSuitability), CFSuitability := ""X""]
     # Append custom generated feasibility svg bars and Trend + ETL
     current = as.integer(names(period_map)[match(""Current"", period_map)])
     results[, `:=`(
       Species = T1[Spp, paste(paste0(""<b>"", TreeCode, ""</b>""), EnglishName, sep = "": "")],
       Period = paste0(period_map, collapse = ""<br />""),
-      ProjFeas = EstabFeas,
       PredFeasSVG = paste0(
         feasibility_svg(`1_1961`,`2_1961`,`3_1961`,`X_1961`), ""<br />"",
         feasibility_svg(`1_1991`,`2_1991`,`3_1991`,`X_1991`), ""<br />"","
bcgov,CCISS_ShinyApp,919024c6017fd65a7cea110bfbeed20b334f20df,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-09-20T21:16:53Z,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-09-20T21:16:53Z,Fixed X,app/server/feasibility.R;app/server/generate.R;data-raw/scripts/bigshinygisstudio.R;data-raw/scripts/create_package_data.R;data/S1.rda,False,True,True,False,13,7,20,"---FILE: app/server/feasibility.R---
@@ -27,7 +27,6 @@ cciss_results_dt <- function(data, siteref, siteserie, filter, format = ""html"")
   }else if (filter == ""f""){
     data <- data[Curr %in% c(1,2,3) | CFSuitability %in% c(1,2,3) | ccissFeas %in% c(1,2,3),]
   }
-  print(head(data))
   data[,Trend := paste0(""SU"", Improve,""EUPUPPY"",Decline)] ##have to do this so the br isn't escaped by cell_spec
   data <- data[!is.na(Trend),]
   data[,Trend := cell_spec(Trend,""html"", color = fifelse(Improve > 67,'green',fifelse(Improve < 33, ""red"",""purple"")))]

---FILE: app/server/generate.R---
@@ -162,7 +162,7 @@ bgc <- function(con, siteno, avg, modWeights) {
 # ""4055121"", ""2243917"", ""1944094"", ""4125428"", ""4635548"", ""5737786"", 
 # ""5321717"", ""1703309"", ""1338735"", ""1313609"", ""1345347"", ""1741741"", 
 # ""3457355"", ""3606245""))
-# bgc <- dbGetCCISS(pool,siteno = testSitenos, avg = T, modWeights = all_weight)
+#bgc <- dbGetCCISS(pool,siteno = 4954059, avg = T, modWeights = all_weight)
 # bgc <- sqlTest(pool,siteno = c(6476259,6477778,6691980,6699297),avg = T, scn = ""ssp370"")
 
 
@@ -175,7 +175,7 @@ cciss <- function(bgc,estabWt,futWt) {
 }
 
 
-# test <- ccissOutput(SSPred = SSPred, suit = S1, rules = R1, feasFlag = F1, 
+# test <- ccissOutput(SSPred = SSPred, suit = S1, rules = R1, feasFlag = F1,
 #                     histWeights = c(0.3,0.3,0.35), futureWeights = rep(0.25,4))
 #SSPred2 <- SSPred[SS_NoSpace == ""ICHmw1/01"",]
 # This map is used to determine output labels from raw period

---FILE: data-raw/scripts/bigshinygisstudio.R---
@@ -110,7 +110,15 @@ analogsea::droplet_ssh(server, ""R -e \""install.packages('remotes')\"""")
 server <- analogsea::droplets()$`shiny-server`
 reset_ssh_sessions()
 #analogsea::droplet_ssh(server,""rm -R /srv/shiny-server/ccissdev/.Renviron"")
- 
+analogsea::droplet_ssh(server, ""rm -R /srv/shiny-server/ccissdev"")
+analogsea::droplet_ssh(server, ""mkdir /srv/shiny-server/ccissdev"")
+analogsea::droplet_upload(server, ""./.Renviron"", ""/srv/shiny-server/ccissdev"")
+analogsea::droplet_ssh(server, ""R -e \""remotes::install_github('FLNRO-Smithers-Research/CCISS_ShinyApp_v12', upgrade = FALSE, dependencies = FALSE, force = TRUE)\"""")
+analogsea::droplet_upload(server, ""./app/index.Rmd"", ""/srv/shiny-server/ccissdev/index.Rmd"")
+analogsea::droplet_upload(server, ""./app/www"", ""/srv/shiny-server/ccissdev"")
+analogsea::droplet_upload(server, ""./app/server"", ""/srv/shiny-server/ccissdev"")
+analogsea::droplet_ssh(server, ""chown -R shiny:shiny /srv/shiny-server"")
+analogsea::droplet_ssh(server, ""systemctl restart shiny-server"")
 
 
 utils::browseURL(paste0(""http://"", analogsea:::droplet_ip_safe(server), ""/shiny/ccissdev""))

---FILE: data-raw/scripts/create_package_data.R---
@@ -5,7 +5,7 @@ library(data.table)
 library(usethis)
 library(readxl)
 E1 <- fread(""./data-raw/data_tables/Edatopic_v12_11.csv"")
-S1 <- fread(""./data-raw/data_tables/Feasibility_v12_10.csv"")
+S1 <- fread(""./data-raw/data_tables/Feasibility_v12_11.csv"")
 N1 <- fread(""./data-raw/data_tables/SiteSeries_names_v12_10.csv"")
 N1[,SiteSeriesLongName := gsub(""\x96"",""-"",SiteSeriesLongName)]
 use_data(N1,overwrite = T)
@@ -23,8 +23,7 @@ S1[Spp %in% c(""Sw"",""Se"",""Sxw""),Spp := ""Sx""]
 S1[Spp %in% c(""Ss"", ""Sxl"",""Sxs""),Spp := ""Ss""]
 S1[Spp %in% c(""Pyi"",""Pyc""),Spp := ""Py""]
 S1[Spp %in% c(""Acb"",""Act""),Spp := ""Ac""]
-S1 <- S1[Spp != ""X"",]
-save(S1, file = ""./data/S1.rda"")
+use_data(S1, overwrite = T)
 use_data(N1,overwrite = T)
 
 SIBEC <- fread(""~/SIBEC_Modelled/PredSI_Sept2021_2.csv"") "
bcgov,CCISS_ShinyApp,656b844f391ebe6516384671cec0560d934b2741,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-09-19T23:50:28Z,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-09-19T23:50:28Z,Bug fixes,R/eda_overlap.R;app/index.Rmd;app/server/feasibility.R;app/server/generate.R;app/server/map.R;app/server/points.R;data-raw/scripts/bigshinygisstudio.R,True,True,True,False,23,18,41,"---FILE: R/eda_overlap.R---
@@ -84,7 +84,7 @@ edatopicOverlap <- function(BGC,E1,E1_Phase){
   ###forwards overlap
   SS.out <- new[,.(SS.prob = .N,BGC.prop = BGC.prop[1]), 
                 keyby = .(SiteRef,FuturePeriod,BGC,BGC.pred,SS_NoSpace,SS.pred)]
-  SS.out[numEda,SS.Curr := i.NumEdas, on = c(SS_NoSpace = ""SS_NoSpace"")]
+  SS.out[numEda,SS.Curr := i.NumEdas, on = c(SS_NoSpace = ""SS_NoSpace""), allow.cartesian = T]
   SS.out[,SSProb := SS.prob/SS.Curr]
   
   ###reverse overlap
@@ -110,24 +110,24 @@ edatopicOverlap <- function(BGC,E1,E1_Phase){
   curr <- unique(justPhase[,.(SiteRef, FuturePeriod, BGC = i.BGC, BGC.pred, SS_NoSpace)])
   fut <- unique(justPhase[,.(SiteRef, FuturePeriod, BGC = i.BGC, BGC.pred, MainUnit, Phase)])
   phaseTemp <- E1_Phase[,.(SS_NoSpace,Edatopic)]
-  curr <- E1[curr, on = ""SS_NoSpace""] 
-  fut <- phaseTemp[fut, on = c(SS_NoSpace = ""Phase"")]
+  curr <- E1[curr, on = ""SS_NoSpace"", allow.cartesian = T] 
+  fut <- phaseTemp[fut, on = c(SS_NoSpace = ""Phase""),allow.cartesian = T]
   setnames(fut,old = ""SS_NoSpace"", new = ""PhasePred"")
   setkey(curr, SiteRef, FuturePeriod, BGC, BGC.pred,Edatopic)
   setkey(fut,SiteRef,FuturePeriod,BGC,BGC.pred,Edatopic)
-  new <- fut[curr]
+  new <- fut[curr, allow.cartesian = T]
   new <- new[!is.na(PhasePred),]
   
   ###forwards overlap
   SS.out <- new[,.(SS.prob = .N,MainUnit = MainUnit[1]), 
                 keyby = .(SiteRef,FuturePeriod,BGC,BGC.pred,SS_NoSpace,PhasePred)]
-  SS.out[numEda,SS.Curr := i.NumEdas, on = c(SS_NoSpace = ""SS_NoSpace"")]
+  SS.out[numEda,SS.Curr := i.NumEdas, on = c(SS_NoSpace = ""SS_NoSpace""), allow.cartesian = T]
   SS.out[,SSProb := SS.prob/SS.Curr]
   
   ###reverse overlap
   SS.out.rev <- new[,.(SS.prob = .N,MainUnit = MainUnit[1]), 
                     keyby = .(SiteRef,FuturePeriod,BGC,BGC.pred,PhasePred,SS_NoSpace)]
-  SS.out.rev[numEdaPh,SS.Curr := i.NumEdas, on = c(PhasePred = ""SS_NoSpace"")]
+  SS.out.rev[numEdaPh,SS.Curr := i.NumEdas, on = c(PhasePred = ""SS_NoSpace""), allow.cartesian = T]
   SS.out.rev[,SSProbRev := SS.prob/SS.Curr]
 
   ##combine them

---FILE: app/index.Rmd---
@@ -444,7 +444,6 @@ tags$script(HTML('
 # bslib::bs_themer()
 # Reusing Shiny session userData environment
 uData <- session$userData
-
 portfolio_results <- reactiveValues(data = NULL)
 session_params <- reactiveValues(estabWt = c(0.3,0.35,0.35),futWt = c(0.25,0.25,0.25,0.25),
                              modelWt = all_weight, rcpWt = rcp_weight, gcmWt = gcm_weight)
@@ -470,6 +469,7 @@ output$modal_ui <- renderUI({
   HTML(readLines(rmarkdown::render(""./server/CCISS_Instructions.Rmd"",encoding = ""UTF-8"",envir = new.env()),encoding = ""UTF-8""))
 })
 
+uData$bec_click_flag <- FALSE
 ##default session parameters
 output$rcp_select <- renderAmChart4({
   amBarChart(

---FILE: app/server/feasibility.R---
@@ -27,6 +27,7 @@ cciss_results_dt <- function(data, siteref, siteserie, filter, format = ""html"")
   }else if (filter == ""f""){
     data <- data[Curr %in% c(1,2,3) | CFSuitability %in% c(1,2,3) | ccissFeas %in% c(1,2,3),]
   }
+  print(head(data))
   data[,Trend := paste0(""SU"", Improve,""EUPUPPY"",Decline)] ##have to do this so the br isn't escaped by cell_spec
   data <- data[!is.na(Trend),]
   data[,Trend := cell_spec(Trend,""html"", color = fifelse(Improve > 67,'green',fifelse(Improve < 33, ""red"",""purple"")))]

---FILE: app/server/generate.R---
@@ -156,7 +156,13 @@ bgc <- function(con, siteno, avg, modWeights) {
   })
 }
 
-# bgc <- dbGetCCISS(pool,siteno = c(3347864,3271530,3439610,3586472), avg = F, modWeights = all_weight)
+# testSitenos <- as.integer(c(""1247944"", ""1486662"", ""1866401"", ""2275827"", ""3060730"", ""3865683"", 
+# ""5023732"", ""4842832"", ""2761637"", ""2111482"", ""2370320"", ""3013159"", 
+# ""3466294"", ""3716379"", ""4828480"", ""5103315"", ""4638702"", ""3557707"", 
+# ""4055121"", ""2243917"", ""1944094"", ""4125428"", ""4635548"", ""5737786"", 
+# ""5321717"", ""1703309"", ""1338735"", ""1313609"", ""1345347"", ""1741741"", 
+# ""3457355"", ""3606245""))
+# bgc <- dbGetCCISS(pool,siteno = testSitenos, avg = T, modWeights = all_weight)
 # bgc <- sqlTest(pool,siteno = c(6476259,6477778,6691980,6699297),avg = T, scn = ""ssp370"")
 
 
@@ -168,6 +174,9 @@ cciss <- function(bgc,estabWt,futWt) {
               histWeights = estabWt, futureWeights = futWt)
 }
 
+
+# test <- ccissOutput(SSPred = SSPred, suit = S1, rules = R1, feasFlag = F1, 
+#                     histWeights = c(0.3,0.3,0.35), futureWeights = rep(0.25,4))
 #SSPred2 <- SSPred[SS_NoSpace == ""ICHmw1/01"",]
 # This map is used to determine output labels from raw period
 #uData$period_map <- c(""1975"" = ""Historic"", ""2000"" = ""Current"", ""2025"" = ""2010-2040"", ""2055"" = ""2040-2070"", ""2085"" = ""2070-2100"")

---FILE: app/server/map.R---
@@ -68,6 +68,7 @@ set_map_bound <- function(data = userpoints$dt) {
 observeEvent(input$bec_map_click, {
   if(input$preselected == ""N""){
     print(""In BGC Click"")
+    uData$bec_click_flag <- TRUE
     pos <- input$bec_map_click
     points <- new_points(data.table(Lat = pos$lat, Long = pos$lng))
     insert_points(points)

---FILE: app/server/points.R---
@@ -24,6 +24,7 @@ observeEvent(input$bgc_click,{
 # Input management ----
 output$points_table <- DT::renderDataTable({
   pts <- userpoints$dt
+  print(dput(pts$Site))
   DT::datatable(
     pts[, uData$pts_show_col, with = FALSE], rownames = FALSE,
     options = list(searching = FALSE, lengthChange = TRUE, pageLength = 5,
@@ -51,7 +52,7 @@ new_points <- function(points) {
       points[,`:=`(Long = round(Long, 5), Lat = round(Lat, 5))]
       res <- dbPointInfo(pool, points)
       points[, `:=`(
-        BGC = input$bgc_point_click,
+        BGC = if(uData$bec_click_flag) input$bgc_point_click else res$map_label,
         ForestRegion = res$forest_region,
         Site = res$site_no,
         # Only replace elevation with DEM when not provided by the user
@@ -87,6 +88,7 @@ new_points <- function(points) {
     } else {
       removeModal()
     }
+    uData$bec_click_flag <- FALSE
     return(points)
   })
 }

---FILE: data-raw/scripts/bigshinygisstudio.R---
@@ -110,15 +110,7 @@ analogsea::droplet_ssh(server, ""R -e \""install.packages('remotes')\"""")
 server <- analogsea::droplets()$`shiny-server`
 reset_ssh_sessions()
 #analogsea::droplet_ssh(server,""rm -R /srv/shiny-server/ccissdev/.Renviron"")
-analogsea::droplet_ssh(server, ""rm -R /srv/shiny-server/ccissdev"")
-analogsea::droplet_ssh(server, ""mkdir /srv/shiny-server/ccissdev"")
-analogsea::droplet_upload(server, ""./.Renviron"", ""/srv/shiny-server/ccissdev"")
-analogsea::droplet_ssh(server, ""R -e \""remotes::install_github('FLNRO-Smithers-Research/CCISS_ShinyApp_v12', upgrade = FALSE, dependencies = FALSE, force = TRUE)\"""")
-analogsea::droplet_upload(server, ""./app/index.Rmd"", ""/srv/shiny-server/ccissdev/index.Rmd"")
-analogsea::droplet_upload(server, ""./app/www"", ""/srv/shiny-server/ccissdev"")
-analogsea::droplet_upload(server, ""./app/server"", ""/srv/shiny-server/ccissdev"")
-analogsea::droplet_ssh(server, ""chown -R shiny:shiny /srv/shiny-server"")
-analogsea::droplet_ssh(server, ""systemctl restart shiny-server"")
+ 
 
 
 utils::browseURL(paste0(""http://"", analogsea:::droplet_ip_safe(server), ""/shiny/ccissdev""))"
bcgov,CCISS_ShinyApp,668009d8af8cfce57ec5e36feb8c3c2b72155f8a,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-09-18T20:36:34Z,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-09-18T20:36:34Z,Fix join error,R/eda_overlap.R;app/server/generate.R,False,True,True,False,2,2,4,"---FILE: R/eda_overlap.R---
@@ -105,7 +105,7 @@ edatopicOverlap <- function(BGC,E1,E1_Phase){
   
   numEdaPh <- E1_Phase[,.(NumEdas = .N), by = .(SS_NoSpace)]
   phaseSmall <- unique(edaPhase[,.(BGC,MainUnit,Phase = SS_NoSpace)])
-  combPhase <- phaseSmall[combAll, on = c(MainUnit = ""SS.pred"")]
+  combPhase <- phaseSmall[combAll, on = c(MainUnit = ""SS.pred""), allow.cartesian = T]
   justPhase <- combPhase[!is.na(Phase),]
   curr <- unique(justPhase[,.(SiteRef, FuturePeriod, BGC = i.BGC, BGC.pred, SS_NoSpace)])
   fut <- unique(justPhase[,.(SiteRef, FuturePeriod, BGC = i.BGC, BGC.pred, MainUnit, Phase)])

---FILE: app/server/generate.R---
@@ -156,7 +156,7 @@ bgc <- function(con, siteno, avg, modWeights) {
   })
 }
 
-#bgc <- dbGetCCISS(pool,siteno = 1985468, avg = F, modWeights = all_weight)
+# bgc <- dbGetCCISS(pool,siteno = c(3347864,3271530,3439610,3586472), avg = F, modWeights = all_weight)
 # bgc <- sqlTest(pool,siteno = c(6476259,6477778,6691980,6699297),avg = T, scn = ""ssp370"")
 
 "
bcgov,CCISS_ShinyApp,2ee97fbb7649fe754fecca3294692524c3e6ad55,Kiri Daust,kiridaust@gmail.com,2021-09-17T22:54:35Z,Kiri Daust,kiridaust@gmail.com,2021-09-17T22:54:35Z,Fixed stocking standards,data-raw/data_tables/StockingStds/StockStands_v12.csv;data-raw/scripts/create_package_data.R;data/stocking_standards.rda,False,True,True,False,8750,8738,17488,"---FILE: data-raw/scripts/create_package_data.R---
@@ -71,7 +71,7 @@ zones_colours_ref <- fread(""./data-raw/data_tables/WNAv11_Zone_Colours.csv"", key
 subzones_colours_ref <- fread(""./data-raw/data_tables/WNAv12_3_SubzoneCols.csv"", key = ""classification"")
 save(subzones_colours_ref, file = ""./data/subzones_colours_ref.rda"")
 # StockingStds
-stocking_standards_v12 <- fread(""./data-raw/data_tables/StockingStds/StockStands_v12.csv"", key = c(""Region"", ""ZoneSubzone"", ""Species""), colClasses = c(""Standard"" = ""numeric""))
+stocking_standards_v12 <- fread(""./data-raw/data_tables/StockingStds/StockStands_v12.csv"", key = c(""Region"", ""ZoneSubzone"",""SiteSeries"", ""Species""), colClasses = c(""Standard"" = ""numeric""))
 stocking_info_v12 <- fread(""./data-raw/data_tables/StockingStds/StockingInfo_v12.csv"", key = ""Standard"", colClasses = c(""Standard"" = ""numeric""))
 stocking_height_v12 <- fread(""./data-raw/data_tables/StockingStds/StockingHeight_v12.csv"", key = c(""Standard"", ""Species""), colClasses = c(""Standard"" = ""numeric""))
 crosswalk <- fread(""./data-raw/data_tables/StockingStds/Crosswalk.csv"", key = ""Modeled"")
@@ -96,7 +96,7 @@ dupPairs(stocking_height_v12)
 
 # Remove duplicates for now, keeping the first of each combination
 remDups <- function(d) {
-  d[!duplicated(d[, key(d), with = FALSE])]
+  d[!duplicated(d[, data.table::key(d), with = FALSE])]
 }
 stocking_standards_v12 <- remDups(stocking_standards_v12)
 stocking_info_v12 <- remDups(stocking_info_v12)
@@ -116,7 +116,7 @@ a <- a[crosswalk, on = c(ZoneSubzone = ""Tables""), allow.cartesian = TRUE, nomatc
 nrow(stocking_standards[a, on = c(Region = ""Region"", ZoneSubzone = ""Modeled"", SS_NoSpace = ""SS_NoSpace"", Species = ""Species""), nomatch = NULL])
 # Does not seems like it, so it is safe to add all of them
 a[, `:=`(ZoneSubzone = Modeled, Modeled = NULL)]
-k <- key(stocking_standards)
+k <- data.table::key(stocking_standards)
 stocking_standards <- rbindlist(list(stocking_standards, a))
 setkeyv(stocking_standards, k)
 # Recheck for dups
@@ -133,6 +133,9 @@ stocking_standards[,RegionNew := NULL]
 PSXT_cw <- data.table(PreferredAcceptable = c(""P"",""S"",""T"",""X""), Suitability = c(""1"",""2"",""3"",""X""))
 stocking_standards[PSXT_cw, Suitability := i.Suitability, on = ""PreferredAcceptable""]
 stocking_standards[,FN6 := NULL]
+temp <- stocking_standards[grep(""BWBS"",ZoneSubzone),]
+temp[,Region := ""Pr Rupert""]
+stocking_standards <- rbind(stocking_standards,temp)
 use_data(stocking_standards,overwrite = T)
 # Stocking height formatting
 stocking_height <- copy(stocking_height_v12[,.(Standard, Species, Height)])"
bcgov,CCISS_ShinyApp,fd07fd0cbdff876b7f7cbb33f8f1fec2f404bd92,Kiri Daust,kiridaust@gmail.com,2021-09-17T20:38:00Z,Kiri Daust,kiridaust@gmail.com,2021-09-17T20:38:00Z,Fixes,app/index.Rmd;app/server/LeafletSource.R;app/server/feasibility.R;app/server/map.R;app/server/points.R,True,False,True,False,28,163,191,"---FILE: app/index.Rmd---
@@ -79,6 +79,11 @@ all_weight[rcp_weight,wrcp := i.weight, on = ""rcp""]
 all_weight[,weight := wgcm*wrcp]
 ```
 
+<script>
+$(""body"").on(""shown.bs.tab"", ""a[data-toggle='tab']"", function(e) {
+   Shiny.setInputValue(""active_tab"", $(e.target).parent().index());
+})
+</script>
 
 SELECT SITES
 =====================================
@@ -418,6 +423,7 @@ Shiny App Information {data-navmenu=""ABOUT""}
 tableOutput(""shinyinfo"")
 ```
 
+
 ```{r}
 tags$script(HTML('
   Shiny.addCustomMessageHandler(""jsCode"",

---FILE: app/server/LeafletSource.R---
@@ -206,6 +206,11 @@ addBGC <- function(map) {
         flag = false;
       });
       
+      Shiny.addCustomMessageHandler(""clearDist"",function(x){
+        distLayer.resetFeatureStyle(distHL);
+        Shiny.setInputValue(""dist_click"",null);
+      });
+      
       distLayer.bindTooltip(function(e) {
         return e.properties.dist_code;
       }, {sticky: true, textsize: ""10px"", opacity: 1});

---FILE: app/server/feasibility.R---
@@ -27,10 +27,12 @@ cciss_results_dt <- function(data, siteref, siteserie, filter, format = ""html"")
   }else if (filter == ""f""){
     data <- data[Curr %in% c(1,2,3) | CFSuitability %in% c(1,2,3) | ccissFeas %in% c(1,2,3),]
   }
-  data[,Trend := paste0(Improve,""PUPPY"",Decline)] ##have to do this so the br isn't escaped by cell_spec
+  data[,Trend := paste0(""SU"", Improve,""EUPUPPY"",Decline)] ##have to do this so the br isn't escaped by cell_spec
   data <- data[!is.na(Trend),]
   data[,Trend := cell_spec(Trend,""html"", color = fifelse(Improve > 67,'green',fifelse(Improve < 33, ""red"",""purple"")))]
   data[,Trend := gsub(""PUPPY"",""<br />"",Trend)]
+  data[,Trend := gsub(""SU"",""<u>"",Trend)]
+  data[,Trend := gsub(""EU"",""</u>"",Trend)]
   #data[,Period := cell_spec(Period,font_size = 12)]
 
   data <- data[SiteRef == siteref & SS_NoSpace %in% siteserie,
@@ -58,7 +60,7 @@ cciss_results_dt <- function(data, siteref, siteserie, filter, format = ""html"")
     data, format = format, align = c(""l"",""c"",""c"",""c"",""c"",""c"",""c"",""c""), escape = FALSE,
     col.names = c(""Tree Species"", ""Period"", ""Modelled Feasibility"",
                   ""CFRG"", ""Environmental"",""Establishment"",
-                  ""Future (cciss)"",""Improve/Same<br />Decline/Unsuitable""),
+                  ""Future (cciss)"",""<u>Improve/Same</u><br />Decline/Unsuitable""),
     table.attr = 'class=""table table-hover""') %>%
     add_header_above(c("" "" = 2, ""Raw Votes"" = 1, ""Historic"" = 2, 
                        ""Projected Feasibility"" = 2, ""Trend"" = 1)) %>%

---FILE: app/server/map.R---
@@ -1,164 +1,4 @@
-# # Map vector tiling plugin + opacity slider plugin
-# plugins <- {
-#   list(vgplugin =
-#          htmltools::htmlDependency(
-#            name = ""leaflet.vectorgrid"",
-#            version = ""1.3.0"",
-#            src = system.file(""htmlwidgets"", package = ""ccissdev""),
-#            script = ""lfx-vgrid-prod.js""
-#          ),
-#        sliderplugin = htmltools::htmlDependency(
-#          name = ""leaflet.slider"",
-#          version = ""1.0.0"",
-#          stylesheet = ""lfx-slider.css"",
-#          src = system.file(""htmlwidgets"", package = ""ccissdev""),
-#          script = ""lfx-slider.js""
-#        )
-#   )
-# }
-# uData$plugins <- plugins
-# 
-# registerPlugin <- function(map, plugin) {
-#   map$dependencies <- c(map$dependencies, list(plugin))
-#   map
-# }
-# uData$registerPlugin <- registerPlugin
-# 
-# # Use VectorGrid to display ZoneSubZone layers and do some highlighting
-# # App mode is more interactive, report mode is static
-# addVectorGridTilesDev <- function(map, app = TRUE) {
-#   map <- registerPlugin(map, plugins$vgplugin)
-#   if (app) {
-#     map <- registerPlugin(map, plugins$sliderplugin)
-#   }
-#   # This is a custom javascript to enable VectorGrid with Shiny
-#   # https://leaflet.github.io/Leaflet.VectorGrid/vectorgrid-api-docs.html
-#   # It also adds a slider control for the layers opacity
-#   map <- htmlwidgets::onRender(map, paste0('
-#     function(el, x, data) {
-#       ', paste0(""var subzoneColors = {"", paste0(""'"", subzones_colours_ref$classification, ""':'"", subzones_colours_ref$colour,""'"", collapse = "",""), ""}""), '
-# 
-#       L.bec_layer_opacity = 0.65;
-#       
-#       var vectorTileOptions=function(layerName, layerId, activ,
-#                              lfPane, colorMap, prop, id) {
-#         return {
-#           vectorTileLayerName: layerName,
-#           interactive: true, // makes it able to trigger js events like click
-#           vectorTileLayerStyles: {
-#             [layerId]: function(properties, zoom) {
-#               return {
-#                 weight: 0,
-#                 fillColor: colorMap[properties[prop]],
-#                 fill: true,
-#                 fillOpacity: L.bec_layer_opacity
-#               }
-#             }
-#           },
-#           pane : lfPane,
-#           getFeatureId: function(f) {
-#               return f.properties[id];
-#           }
-#         }
-#         
-#       };
-#       
-#       var subzLayer = L.vectorGrid.protobuf(
-#         ""', bcgov_tileserver, '"",
-#         vectorTileOptions(""bec_subz"", ""', bcgov_tilelayer, '"", true,
-#                           ""tilePane"", subzoneColors, ""MAP_LABEL"", ""MAP_LABEL"")
-#       );
-#       this.layerManager.addLayer(subzLayer, ""tile"", ""bec_subz"", ""Subzones Variants"")
-#       console.log(subzLayer);
-#       //Now districts regions
-#       var vectorTileOptionsDist=function(layerName, layerId, activ,
-#                                      lfPane, prop, id) {
-#         return {
-#           vectorTileLayerName: layerName,
-#           interactive: true, // makes it able to trigger js events like click
-#           vectorTileLayerStyles: {
-#             [layerId]: function(properties, zoom) {
-#               return {
-#                 weight: 0.5,
-#                 color: ""#000000"",
-#                 fill: false,
-#                 fillOpacity: 0
-#               }
-#             }
-#           },
-#           pane : lfPane,
-#           getFeatureId: function(f) {
-#             return f.properties[id];
-#           }
-#         }
-#       };
-#       var distLayer = L.vectorGrid.protobuf(
-#         ""', district_tileserver, '"",
-#         vectorTileOptionsDist(""Districts"", ""', district_tilelayer, '"", true,
-#                           ""tilePane"", ""dist_code"", ""dist_code"")
-#       )
-#       this.layerManager.addLayer(distLayer, ""tile"", ""Districts"", ""Districts"")
-#       // end districts
-#       
-#       ', if (app) {'
-#       
-#       var highlight;
-# 		  var clearHighlight = function() {
-# 		  	if (highlight) {
-# 		  		subzLayer.resetFeatureStyle(highlight);
-# 		  	}
-# 		  	highlight = null;
-# 		  }
-#       
-#       // Subzones
-#       
-#       subzLayer.bindTooltip(function(e) {
-#         return e.properties.MAP_LABEL
-#       }, {sticky: true, textsize: ""10px"", opacity: 1})
-#       
-#       subzLayer.on(""mouseover"", function(e) {
-#           var properties = e.layer.properties
-#           console.log(e.layer);
-#   			  highlight = properties.MAP_LABEL;
-#   			  var style = {
-#             weight: 1,
-#             color: ""#555"",
-#             fillColor: subzoneColors[properties.MAP_LABEL],
-#             fillOpacity: 0.4,
-#             fill: true
-#           }
-#           subzLayer.setFeatureStyle(properties.MAP_LABEL, style);
-#       })
-#       subzLayer.on(""mouseout"", function(e) {
-#         clearHighlight();
-#       });
-#       
-#       updateOpacity = function(value) {
-#         L.bec_layer_opacity = parseFloat(value);
-#       }
-#       
-#       var opacityslider = L.control.slider(updateOpacity, {
-#         id:""opacity_slider"",
-#         orientation:""horizontal"",
-#         position:""bottomleft"",
-#         logo:\'<img src=""www/opacity.svg"" />\',
-#         max:1,
-#         step:0.01,
-#         syncSlider:true,
-#         size:""250px"",
-#         // Starting opacity value for bec map layers
-#         value:0.65,
-#         showValue:true
-#       })
-#       
-#       opacityslider.addTo(this)
-#       
-#       '} else {''}, '
-#     }'
-#   ))
-#   map
-# }
-# uData$addVectorGridTilesDev <- addVectorGridTilesDev
+
 # Map main
 output$bec_map <- renderLeaflet({
   leaflet::leaflet() %>%
@@ -263,5 +103,9 @@ observeEvent(input$dist_click,{
 })
 
 observeEvent(input$clear_highlight,{
+  session$sendCustomMessage(""clearDist"",""puppy"")
   session$sendCustomMessage(""clearBGC"",""puppy"")
+  if(input$preselected == ""BGC_Dist""){
+    session$sendCustomMessage(""selectDist"",""puppy"")
+  }
 })

---FILE: app/server/points.R---
@@ -236,6 +236,14 @@ observeEvent(input$clear_button,{
   clear_mk()
 })
 
+##redraw point when going back to select tab
+observeEvent(input$active_tab,{
+  if(input$active_tab == 0){
+    clear_mk()
+    draw_mk()
+  }
+})
+
 ## Edit points logic
 observeEvent(input$points_table_cell_edit, {
   info = input$points_table_cell_edit"
bcgov,CCISS_ShinyApp,b6dd2cc95c20872ae2d0722c1d8ff8f70fd7668d,Kiri Daust,kiridaust@gmail.com,2021-09-15T17:55:21Z,Kiri Daust,kiridaust@gmail.com,2021-09-15T17:55:21Z,"Fix ordering, report",R/feasibility.R;app/server/generate.R;app/server/reporthtml.Rmd;app/server/silviculture.R,True,True,True,False,19,15,34,"---FILE: R/feasibility.R---
@@ -101,7 +101,7 @@ ccissOutput <- function(SSPred,suit,rules,feasFlag,histWeights,futureWeights){
   datFeas[Curr == 10 & NewSuit == 10, Flag := ""NotIn""]
   added <- c(""A1"", ""A2"", ""A3"")
   datFeas <- datFeas[Curr == 10 & (Flag %in% added), Curr := 4 ]
-  datFeas_final <- datFeas %>% dplyr::select(SiteRef,SS_NoSpace,Spp,NewSuit, SuitDiff, Flag) %>% dplyr::mutate(dplyr::across(NewSuit, round, 0))%>%
+  datFeas_final <- datFeas %>% dplyr::select(SiteRef,SS_NoSpace,Spp,NewSuit,NewSuitFrac, SuitDiff, Flag) %>% dplyr::mutate(dplyr::across(NewSuit, round, 0))%>%
            dplyr::mutate(NewSuit = sub('10', 'X', NewSuit)) 
   
   ###mid rotation trend using 41-60 and 61-80 - used for bifurcation
@@ -122,14 +122,15 @@ ccissOutput <- function(SSPred,suit,rules,feasFlag,histWeights,futureWeights){
                          by = .(SiteRef,FuturePeriod, SS_NoSpace,Spp,Curr)]
   datFuture[,NewSuit := `1`+(`2`*2)+(`3`*3)+(X*5)]
   datFuture[ccissWt, Weight := i.Weight, on = ""FuturePeriod""]
-  datFuture <- datFuture[,.(ccissSuit = weighted.mean(NewSuit,Weight)), 
+  datFuture <- datFuture[,.(ccissSuitFrac = weighted.mean(NewSuit,Weight)), 
                          by = .(SiteRef,SS_NoSpace,Spp,Curr)]
-  datFuture[,ccissSuit := round(ccissSuit)]
+  datFuture[,ccissSuit := round(ccissSuitFrac)]
   
   ###merge data to make summary tables############################################################
   summOut <- merge(datFeas_final, datRot, by = c('SiteRef','SS_NoSpace','Spp'),all = T)
   summOut <- merge(summOut, datFuture, by = c('SiteRef','SS_NoSpace','Spp'), all = T)
-  summOut[,c(""Flag"",""SuitDiff"") := NULL]
+  summOut[,OrderCol := (Curr + NewSuitFrac + ccissSuitFrac)/3]
+  summOut[,c(""Flag"",""SuitDiff"",""NewSuitFrac"",""ccissSuitFrac"") := NULL]
   #summOut <- summOut[Flag != ""NotIn"",]
   summOut[,`:=`(Curr = as.character(Curr),
                 ccissSuit = as.character(ccissSuit))]

---FILE: app/server/generate.R---
@@ -227,7 +227,8 @@ cciss_results <- function(cciss, pts, avg, type, SS = ccissdev::stocking_standar
       `:=`(EstabFeas = i.NewSuit,
            ccissFeas = i.ccissSuit,
            Trend = i.Trend,
-           Improve = i.Improve),
+           Improve = i.Improve,
+           OrderCol = i.OrderCol),
       on = c(""SiteRef"",""SS_NoSpace"",""Spp"")
     ]
     
@@ -248,7 +249,7 @@ cciss_results <- function(cciss, pts, avg, type, SS = ccissdev::stocking_standar
       )
     )]
     
-    setorder(results, SiteRef, SS_NoSpace, ccissFeas, na.last = TRUE)
+    setorder(results, SiteRef, SS_NoSpace, OrderCol, na.last = TRUE)
     return(results)
   })
 }

---FILE: app/server/reporthtml.Rmd---
@@ -92,12 +92,12 @@ leaflet::leaflet() %>%
     attribution = '&#169; <a href=""https://www.mapbox.com/feedback/"">Mapbox</a>',
     options = leaflet::tileOptions(zIndex = 600)) %>%
   {if(indPoints) leaflet::addMarkers(.,data = data_points, lng = ~Long, lat = ~Lat) else .} %>%
-  leaflet::fitBounds(unname(bbox2[1,1])-1,unname(bbox2[1,2])-1,unname(bbox2[3,1])+1,unname(bbox2[2,2])+1)
+  leaflet::fitBounds(unname(bbox2[1,1])-0.5,unname(bbox2[1,2])-0.5,unname(bbox2[3,1])+0.5,unname(bbox2[2,2])+0.5)
 ```
 
 
 ```{r index, results='asis'}
-tags$h2(""Report Units"")
+tags$h2(""2. Report Units"")
 siterefs <- names(siteseries_list)
 for(i in 1:length(siterefs)){
   siteseries <- siteseries_list[[siterefs[i]]]
@@ -257,19 +257,19 @@ tags$h2(""B. SILVICULTURE REFERENCE"")
 ```
 
 ```{r silref1 , results='asis', out.width=""100%""}
-silv_ref_dt(silvics_tol, filter = ""f"", title = ""Tolerance comparisons"")
+silv_ref_dt(silvics_tol, cciss_results, filter = ""f"", title = ""Tolerance comparisons"")
 ```
 
 ```{r silref2 , results='asis', out.width=""100%""}
-silv_ref_dt(silvics_resist, filter = ""f"", title = ""Resistance and potential risk comparisons"")
+silv_ref_dt(silvics_resist,cciss_results, filter = ""f"", title = ""Resistance and potential risk comparisons"")
 ```
 
 ```{r silref3 , results='asis', out.width=""100%""}
-silv_ref_dt(silvics_regen, filter = ""f"", title = ""Comparison of silvical characteristics; regeneration stage"")
+silv_ref_dt(silvics_regen,cciss_results, filter = ""f"", title = ""Comparison of silvical characteristics; regeneration stage"")
 ```
 
 ```{r silref4 , results='asis', out.width=""100%""}
-silv_ref_dt(silvics_mature, filter = ""f"", title = ""Comparison of silvical characteristics; maturing stage"")
+silv_ref_dt(silvics_mature,cciss_results, filter = ""f"", title = ""Comparison of silvical characteristics; maturing stage"")
 ```
 
 <!-- Logo -->

---FILE: app/server/silviculture.R---
@@ -53,10 +53,12 @@ output$silvics_mature_dt <- function() {
 }
 
 # Ref template for other tables
-silv_ref_dt <- function(silv, data, siteref, siteserie, filter, format = ""html"", title = """") {
+silv_ref_dt <- function(silv, data, siteref = NULL, siteserie = NULL, filter, format = ""html"", title = """") {
   if (filter == ""f"") {
-    data <- data[SiteRef %in% siteref & SS_NoSpace %in% siteserie]
-    silv <- silv[`Tree Code` %in% data[ProjFeas %chin% c(""1"", ""2"", ""3""), Spp]]
+    if(!is.null(siteref)){
+      data <- data[SiteRef == siteref & SS_NoSpace == siteserie,]
+    }
+    silv <- silv[`Tree Code` %in% data[Curr %in% c(1,2,3) | CFSuitability %in% c(1,2,3) | ccissFeas %in% c(1,2,3),Spp]]
   }
   colalign <- rep(""c"", length.out = ncol(silv))
   colalign[3] <- ""l"""
bcgov,CCISS_ShinyApp,e8973662851a6fc0f4d0dc7600b448fb6d1100ea,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-09-10T21:58:27Z,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-09-10T21:58:27Z,Fix error,R/portfolio_fns.R,False,True,True,False,3,2,5,"---FILE: R/portfolio_fns.R---
@@ -217,7 +217,7 @@ run_portfolio <- function(SiteList,climVar,SSPredAll,SIBEC,SuitTable,Trees,
                                limits <- sppLimits[Spp == treeList[k],]
                                Returns <- SimGrowth(DF = annualDat,
                                                        cmdMin = limits[[1]],cmdMax = limits[[2]],
-                                                       tempMin = limits[[3]],tempMax = limits[[4]],climLoss = 0.015)
+                                                       tempMin = limits[[3]],tempMax = limits[[4]],climLoss = 0.005)
                                tmpR <- c(0,Returns)
                                assets <- Returns - tmpR[-length(tmpR)]
                                temp <- data.frame(Spp = treeList[k], 
@@ -233,10 +233,11 @@ run_portfolio <- function(SiteList,climVar,SSPredAll,SIBEC,SuitTable,Trees,
                              returns[,Year := NULL]
                              ###only include species with mean return > 1 in portfolio
                              use <- colnames(returns)[colMeans(returns) > quantile(colMeans(returns),0.25)] ###should probably be higher
+                             use <- use[use %in% colnames(covMat)]
                              if(length(use) > 1){
                                returns <- returns[,..use]
                                #print(use)
-                               ##sigma2 <- cor(returns) ###to create cov mat from returns
+                               #sigma2 <- cor(returns) ###to create cov mat from returns
                                sigma2 <- covMat[use,use]
                                #print(colnames(sigma2))
                                ef <- optimise_portfolio(returns, sigma2, boundDat,minAccept) "
bcgov,CCISS_ShinyApp,6600e6286df31e51f5e81b4bca7251ede5da48cf,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-09-10T21:39:02Z,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-09-10T21:39:02Z,Fixing portfolio,R/portfolio_fns.R;app/NoData.gpkg;data-raw/scripts/create_package_data.R;data/covMat.rda;src/RcppExports.cpp;src/ccissdev.cpp,False,True,True,False,9,9,18,"---FILE: R/portfolio_fns.R---
@@ -217,7 +217,7 @@ run_portfolio <- function(SiteList,climVar,SSPredAll,SIBEC,SuitTable,Trees,
                                limits <- sppLimits[Spp == treeList[k],]
                                Returns <- SimGrowth(DF = annualDat,
                                                        cmdMin = limits[[1]],cmdMax = limits[[2]],
-                                                       tempMin = limits[[3]],tempMax = limits[[4]],climLoss = 0.05)
+                                                       tempMin = limits[[3]],tempMax = limits[[4]],climLoss = 0.015)
                                tmpR <- c(0,Returns)
                                assets <- Returns - tmpR[-length(tmpR)]
                                temp <- data.frame(Spp = treeList[k], 
@@ -235,8 +235,10 @@ run_portfolio <- function(SiteList,climVar,SSPredAll,SIBEC,SuitTable,Trees,
                              use <- colnames(returns)[colMeans(returns) > quantile(colMeans(returns),0.25)] ###should probably be higher
                              if(length(use) > 1){
                                returns <- returns[,..use]
-                               sigma2 <- cor(returns) ###to create cov mat from returns
-                               cat(""about to optimise"")
+                               #print(use)
+                               ##sigma2 <- cor(returns) ###to create cov mat from returns
+                               sigma2 <- covMat[use,use]
+                               #print(colnames(sigma2))
                                ef <- optimise_portfolio(returns, sigma2, boundDat,minAccept) 
                                setnames(ef,old = c(""frontier_sd"",""return"",""sharpe""),
                                         new = c(""Sd"",""RealRet"",""Sharpe""))

---FILE: data-raw/scripts/create_package_data.R---
@@ -11,6 +11,9 @@ N1[,SiteSeriesLongName := gsub(""\x96"",""-"",SiteSeriesLongName)]
 use_data(N1,overwrite = T)
 SS <- fread(""./data-raw/data_tables/WNA_SSeries_v12_10.csv"")
 
+load(""app/Feas_CovMat.rda"")
+use_data(covMat,overwrite = T)
+
 S1[,Confirmed := NULL]
 S1 <- S1[!is.na(Feasible),]
 setnames(S1, old = ""SppVar"",new = ""Spp"")

---FILE: src/RcppExports.cpp---
@@ -5,11 +5,6 @@
 
 using namespace Rcpp;
 
-#ifdef RCPP_USE_GLOBAL_ROSTREAM
-Rcpp::Rostream<true>&  Rcpp::Rcout = Rcpp::Rcpp_cout_get();
-Rcpp::Rostream<false>& Rcpp::Rcerr = Rcpp::Rcpp_cerr_get();
-#endif
-
 // gs2gw
 NumericVector gs2gw(NumericVector x, double a, double b);
 RcppExport SEXP _ccissdev_gs2gw(SEXP xSEXP, SEXP aSEXP, SEXP bSEXP) {

---FILE: src/ccissdev.cpp---
@@ -72,7 +72,7 @@ NumericVector SimGrowth(DataFrame DF, double cmdMin,
     }
     nTrees = nTrees - climDead;
     if(Rcpp::runif(1,0,100)[0] > NoMort[i]){//regular environmental loss
-      percentDead = Rcpp::rgamma(1, 1.5, MeanDead[i])[0];
+      percentDead = Rcpp::rgamma(1, 2, MeanDead[i])[0];
       numDead = (percentDead/100)*prevTrees;
       nTrees = nTrees - numDead;
     }"
bcgov,CCISS_ShinyApp,eab9201bc1ba40b2d99591e181dc8f305344df1b,Kiri Daust,kiridaust@gmail.com,2021-09-10T18:58:12Z,Kiri Daust,kiridaust@gmail.com,2021-09-10T18:58:12Z,Fixes,app/index.Rmd;app/server/feasibility.R;app/server/map.R;data-raw/scripts/bigshinygisstudio.R;data-raw/scripts/create_package_data.R;data/SIBEC.rda,True,False,True,False,10,7,17,"---FILE: app/index.Rmd---
@@ -167,6 +167,7 @@ actionButton(""generate_results"", label = ""Generate results"", icon = icon(""plus-s
 
 Biogeoclimatic Zones + Subzones Variants Map
 -------------------------------------
+
 ```{r}
 leafletOutput(""bec_map"", height = ""auto"")
 ```
@@ -431,9 +432,6 @@ tags$script(HTML('
 # Reusing Shiny session userData environment
 uData <- session$userData
 
-library(sf)
-noDat <- st_read(""./NoData.gpkg"")
-
 portfolio_results <- reactiveValues(data = NULL)
 session_params <- reactiveValues(estabWt = c(0.3,0.35,0.35),futWt = c(0.25,0.25,0.25,0.25),
                              modelWt = all_weight, rcpWt = rcp_weight, gcmWt = gcm_weight)

---FILE: app/server/feasibility.R---
@@ -23,7 +23,7 @@ cciss_results_dt <- function(data, siteref, siteserie, filter, format = ""html"")
     for(i in c(""NewSuit_1991"",""NewSuit_2021"",""NewSuit_2041"",""NewSuit_2061"",""NewSuit_2081"")){ ##set NA to X
       data[is.na(get(i)), (i) := 4]
     }
-    data <- data[(NewSuit_1991+NewSuit_2021+NewSuit_2041+NewSuit_2061+NewSuit_2081) < 24,]
+    data <- data[(NewSuit_1991 < 4 | NewSuit_2021 < 4 | NewSuit_2041 < 4 |NewSuit_2061 < 4 | NewSuit_2081 < 4),]
   }else if (filter == ""f""){
     data <- data[Curr %in% c(1,2,3) | CFSuitability %in% c(1,2,3) | ccissFeas %in% c(1,2,3),]
   }

---FILE: app/server/map.R---
@@ -161,7 +161,7 @@
 # uData$addVectorGridTilesDev <- addVectorGridTilesDev
 # Map main
 output$bec_map <- renderLeaflet({
-  leaflet::leaflet(noDat) %>%
+  leaflet::leaflet() %>%
     leaflet::setView(lng = -122.77222, lat = 51.2665, zoom = 7) %>%
     leaflet::addProviderTiles(leaflet::providers$CartoDB.PositronNoLabels, group = ""Positron"",
                               options = leaflet::pathOptions(pane = ""mapPane"")) %>%
@@ -186,7 +186,6 @@ output$bec_map <- renderLeaflet({
       group = ""Mapbox Labels"",
       options = leaflet::pathOptions(pane = ""overlayPane"")) %>%
     addBGC() %>%
-    addPolygons(fillColor = ""gray"",fillOpacity = 0.8) %>%
     #invokeMethod(data = subzones_colours_ref, method = ""addBGCTiles"", ~classification, ~colour) %>%
     leaflet::hideGroup(""DarkMatter Labels"") %>%
     leaflet::hideGroup(""Positron Labels"") %>%

---FILE: data-raw/scripts/bigshinygisstudio.R---
@@ -117,7 +117,6 @@ analogsea::droplet_ssh(server, ""R -e \""remotes::install_github('FLNRO-Smithers-R
 analogsea::droplet_upload(server, ""./app/index.Rmd"", ""/srv/shiny-server/ccissdev/index.Rmd"")
 analogsea::droplet_upload(server, ""./app/www"", ""/srv/shiny-server/ccissdev"")
 analogsea::droplet_upload(server, ""./app/server"", ""/srv/shiny-server/ccissdev"")
-analogsea::droplet_upload(server, ""./app/NoData.gpkg"", ""/srv/shiny-server/ccissdev/NoData.gpkg"")
 analogsea::droplet_ssh(server, ""chown -R shiny:shiny /srv/shiny-server"")
 analogsea::droplet_ssh(server, ""systemctl restart shiny-server"")
 

---FILE: data-raw/scripts/create_package_data.R---
@@ -23,8 +23,15 @@ S1[Spp %in% c(""Acb"",""Act""),Spp := ""Ac""]
 S1 <- S1[Spp != ""X"",]
 save(S1, file = ""./data/S1.rda"")
 use_data(N1,overwrite = T)
+
 SIBEC <- fread(""~/SIBEC_Modelled/PredSI_Sept2021_2.csv"") 
 setnames(SIBEC,old = ""SppVar"", new = ""Spp"")
+SIBEC[Spp %in% c(""Fdi"",""Fdc""),Spp := ""Fd""]
+SIBEC[Spp %in% c(""Pli"",""Plc""),Spp := ""Pl""]
+SIBEC[Spp %in% c(""Sw"",""Se"",""Sxw""),Spp := ""Sx""]
+SIBEC[Spp %in% c(""Ss"", ""Sxl"",""Sxs""),Spp := ""Ss""]
+SIBEC[Spp %in% c(""Pyi"",""Pyc""),Spp := ""Py""]
+SIBEC[Spp %in% c(""Acb"",""Act""),Spp := ""Ac""]
 SIBECnew <- fread(""~/PortfolioKiri/InputsGit/SI_to_add.csv"")
 SIBEC <- rbind(SIBEC, SIBECnew)
 ###import SI data (currently from BART)"
bcgov,CCISS_ShinyApp,0ef5814dc089e2fde2824340125fddfd936d84e1,Kiri Daust,kiridaust@gmail.com,2021-09-07T23:30:05Z,Kiri Daust,kiridaust@gmail.com,2021-09-07T23:30:05Z,Various fixes,R/data_etl.R;R/feasibility.R;app/server/LeafletSource.R;app/server/feasibility.R;app/server/generate.R;app/server/points.R;app/server/reporthtml.Rmd,True,True,True,False,43,46,89,"---FILE: R/data_etl.R---
@@ -46,6 +46,16 @@ dbPointInfo <- function(con, points) {
     GROUP BY pts
   "")
   
+  # bec_subz_sql <- paste0(""
+  #   WITH pts4326 AS (
+  #     "", paste0(""SELECT st_pointfromtext('POINT("", Long, "" "", Lat, "")', 4326) geom"", collapse = ""\n UNION ALL \n"") ,""
+  #   )
+  #   
+  #   SELECT bgc_map.BGC
+  #   FROM pts4326
+  #   LEFT JOIN bgc_map
+  #   ON ST_Intersects(pts4326.geom, bgc_map.geom)
+  #                        "")
   
   bec_info_sql <- paste0(""
     WITH pts3005 AS (

---FILE: R/feasibility.R---
@@ -114,8 +114,7 @@ ccissOutput <- function(SSPred,suit,rules,feasFlag,histWeights,futureWeights){
   datRot <- datRot[,lapply(.SD, mean),.SDcols = c(""Improve"",""Decline""), by = .(SiteRef,SS_NoSpace,Spp,Curr)]
   datRot[,`:=`(Improve = round(Improve*100),Decline = round(Decline*100))]
   datRot[,Trend := paste0(Improve,"":"",Decline)]
-  datRot[,MaxAgr := rowMaxs(as.matrix(.SD)),.SDcols = c(""Improve"",""Decline"")]
-  datRot <- datRot[,.(SiteRef,SS_NoSpace,Spp,Trend,MaxAgr)] ##final
+  datRot <- datRot[,.(SiteRef,SS_NoSpace,Spp,Trend,Improve,Decline)] ##final
   
 ###################################################################
   datFuture <- suitVotes[FuturePeriod %in% c(2021,2041,2061,2081),]

---FILE: app/server/LeafletSource.R---
@@ -138,6 +138,8 @@ addBGC <- function(map) {
           Shiny.setInputValue(""bgc_click"",selectedNames);
   			  bgcHL = e.layer.properties.BGC;
           subzLayer.setFeatureStyle(bgcHL, styleHL);
+        }else{
+          Shiny.setInputValue(""bgc_point_click"",e.layer.properties.BGC);
         }
       });
       

---FILE: app/server/feasibility.R---
@@ -5,29 +5,6 @@ observeEvent(input$siteref_feas, priority = 50, {
   updateSelectInput(inputId = ""site_series_feas"", choices = uData$siteseries_list[[siteref]])
 })
 
-# # CCISS Summary of results
-# output$summary_feas <- function() {
-#   siteref <- input$siteref_feas
-#   siteserie <- input$site_series_feas
-#   cciss_summary <- uData$cciss_summary
-#   if (is.null(cciss_summary)) return(NULL)
-#   cciss_summary_dt(cciss_summary, siteref, siteserie)
-# }
-# 
-# # Dual utility function to format dt, app mode and report mode use different
-# # format. Report has no javascript, just a plain table.
-# cciss_summary_dt <- function(data, siteref, siteserie, format = ""html"") {
-#   data <- data[SiteRef == siteref & SS_NoSpace %in% siteserie,
-#                list(Species, CFSuitability, ProjFeas, Flag, Period, FutProjFeas, FailRisk)]
-#   knitr::kable(
-#     data, format = format, align = c(""l"",""c"",""c"",""c"",""c"",""c"",""c""), escape = FALSE,
-#     col.names = c(""Tree Species"", ""CFRG Suitability"",
-#                   ""Projected Feasibility"", ""Flag"", ""Period"",
-#                   ""Future Projected Feasibility"", ""Fail Risk""),
-#     table.attr = 'class=""table table-hover""')
-# }
-# uData$cciss_summary_dt <- cciss_summary_dt
-
 # CCISS Results
 output$results_feas <- function() {
   siteref <- selected_site$siteref
@@ -50,8 +27,8 @@ cciss_results_dt <- function(data, siteref, siteserie, filter, format = ""html"")
   }else if (filter == ""f""){
     data <- data[Curr %in% c(1,2,3) | CFSuitability %in% c(1,2,3) | ccissFeas %in% c(1,2,3),]
   }
-  data <- data[!is.na(Trend) & !is.na(MaxAgr),]
-  data[,Trend := cell_spec(Trend,""html"", color = fifelse(MaxAgr < 65,'red','black'))]
+  data <- data[!is.na(Trend),]
+  data[,Trend := cell_spec(Trend,""html"", color = fifelse(Improve > 67,'green',fifelse(Improve < 33, ""red"",""purple"")))]
   #data[,Period := cell_spec(Period,font_size = 12)]
   data <- data[SiteRef == siteref & SS_NoSpace %in% siteserie,
                list(Species, Period, PredFeasSVG, CFSuitability, Curr, EstabFeas, ccissFeas, Trend)]

---FILE: app/server/generate.R---
@@ -156,7 +156,7 @@ bgc <- function(con, siteno, avg, modWeights) {
   })
 }
 
-#bgc <- dbGetCCISS(pool,siteno = 4629842, avg = F, modWeights = all_weight)
+# bgc <- dbGetCCISS(pool,siteno = 6293406, avg = F, modWeights = all_weight)
 # bgc <- sqlTest(pool,siteno = c(6476259,6477778,6691980,6699297),avg = T, scn = ""ssp370"")
 
 
@@ -227,7 +227,7 @@ cciss_results <- function(cciss, pts, avg, type, SS = ccissdev::stocking_standar
       `:=`(EstabFeas = i.NewSuit,
            ccissFeas = i.ccissSuit,
            Trend = i.Trend,
-           MaxAgr = i.MaxAgr),
+           Improve = i.Improve),
       on = c(""SiteRef"",""SS_NoSpace"",""Spp"")
     ]
     
@@ -248,7 +248,7 @@ cciss_results <- function(cciss, pts, avg, type, SS = ccissdev::stocking_standar
       )
     )]
     
-    setorder(results, SiteRef, SS_NoSpace, EstabFeas, ccissFeas, na.last = TRUE)
+    setorder(results, SiteRef, SS_NoSpace, ccissFeas, na.last = TRUE)
     return(results)
   })
 }

---FILE: app/server/points.R---
@@ -51,7 +51,7 @@ new_points <- function(points) {
       points[,`:=`(Long = round(Long, 5), Lat = round(Lat, 5))]
       res <- dbPointInfo(pool, points)
       points[, `:=`(
-        BGC = res$map_label,
+        BGC = input$bgc_point_click,
         ForestRegion = res$forest_region,
         Site = res$site_no,
         # Only replace elevation with DEM when not provided by the user

---FILE: app/server/reporthtml.Rmd---
@@ -44,6 +44,7 @@ mblbstyle <- Sys.getenv(""BCGOV_MAPBOX_LABELS_STYLE"")
   table.table-centered {margin-left:auto !important; margin-right:auto !important}
 </style>
 
+
 ```{r section1, results='asis'}
 tags$h2(""1. SITE LOCATION"")
 ```
@@ -82,25 +83,33 @@ tags$h2(""2. SESSION PARAMETERS"")
 ```
 
 ```{r}
-tagList(
-  tags$h4(""General Parameters""),
-  knitr::kable(data.table(""Parameters"" = c(""Number of Points<br />Considered"", ""Averaged?"", ""Date"", ""Time""), ""User Selections"" = c(nrow(pts), avg, format(Sys.Date(), ""%Y/%m/%d""), format(Sys.time(), ""%H:%M"", usetz = TRUE))),html = T),
-  # tags$h4(""Time Period Weights""),
-  # datTP <- data.table(TimePeriods = c(""1960-1991"",""1991-2020"",""2021-2040"",""2041-2060"",""2061-2080"",""2081-2100""),
-  #                     Estab_Weights = c(session_params$estabWt),rep(0,3),
-  #                     Future_Weights = c(0,0,session_params$futWt)),
-  # datTP <- melt(datTP, id.var = ""TimePeriods"",variable.name = ""Summary""),
-  # datTP <- dcast(datTP,Summary ~ TimePeriods, fun.aggregate = ""mean""),
-  #knitr::kable(datTP),
-  tags$h4(""GCM Weights""),
-  knitr::kable(session_params$gcmWt),
-  tags$h4(""Scenario Weights""),
-  knitr::kable(session_params$rcpWt)
-)
+tags$h4(""General Parameters"")
+knitr::kable(data.table(""Parameters"" = c(""Number of Points<br />Considered"", ""Averaged?"", ""Date"", ""Time""), ""User Selections"" = c(nrow(pts), avg, format(Sys.Date(), ""%Y/%m/%d""), format(Sys.time(), ""%H:%M"", usetz = TRUE))),html = T)
+```
+
+```{r}
+  tags$h4(""Time Period Weights"")
+  datTP <- data.table(TimePeriods = c(""1960-1991"",""1991-2020"",""2021-2040"",""2041-2060"",""2061-2080"",""2081-2100""),
+                      Estab_Weights = c(session_params$estabWt,rep(0,3)),
+                      Future_Weights = c(0,0,session_params$futWt))
+  datTP <- melt(datTP, id.var = ""TimePeriods"",variable.name = ""Summary"")
+  datTP <- dcast(datTP,Summary ~ TimePeriods)
+  knitr::kable(datTP)
+```
 
 
+```{r}
+  tags$h4(""GCM Weights"")
+  knitr::kable(session_params$gcmWt)
 ```
 
+
+```{r}
+  tags$h4(""Scenario Weights"")
+  knitr::kable(session_params$rcpWt)
+```
+
+
 ```{r section3, results='asis'}
 tags$h2(""3. CCISS TREE FEASIBILITY"")
 ```"
bcgov,CCISS_ShinyApp,9a170950c3cab101f5c5af35b8bde6bfefe6317d,Kiri Daust,kiridaust@gmail.com,2021-09-07T00:18:32Z,Kiri Daust,kiridaust@gmail.com,2021-09-07T00:18:32Z,Fixed report,app/index.Rmd;app/server/LeafletSource.R;app/server/generate.R;app/server/reporthtml.Rmd;app/server/reportpdf.Rmd;data-raw/config/tileserver/config.json;data-raw/scripts/create_package_data.R;data/N1.rda,True,False,True,False,56,13,69,"---FILE: app/index.Rmd---
@@ -373,7 +373,7 @@ dl_style <- ""max-width: 300px; width:100%; height: 40px !important;""
 splitLayout(
   div(
     textInput(""report_name"", ""Name for Report"", value = ""report""),
-    radioButtons(""report_format"", ""Report Format"", c(""html"", ""pdf""), inline = TRUE),
+    radioButtons(""report_format"", ""Report Format"", c(""html""), inline = TRUE), ##temporarily removed pdf option
     span(downloadButton(""report_download"", ""Produce Report"", style = dl_style), id = ""download_report_span"")
   ),
   div(

---FILE: app/server/LeafletSource.R---
@@ -321,7 +321,9 @@ addBGC_report <- function(map,bgcSelect,distSelect) {
       this.layerManager.addLayer(distLayer, ""tile"", ""Districts"", ""Districts"")
       
       if(bgcHL){
-        console.log(""In bgcHL"");
+        if(!Array.isArray(bgcHL)){
+          bgcHL = [bgcHL];
+        }
         bgcHL.forEach((ID) => {
           subzLayer.setFeatureStyle(ID,styleHL);
         })

---FILE: app/server/generate.R---
@@ -23,7 +23,7 @@ observeEvent(input$generate_results, priority = 100, {
     avg             <- uData$avg             <- as.logical(input$aggregation)
     pts             <- uData$pts             <- userpoints$dt
   }
-  
+  uData$session_params <- reactiveValuesToList(session_params) 
   
   # Results from processing
   tic(""Fetch CCISS Data from DB"", ticker)

---FILE: app/server/reporthtml.Rmd---
@@ -49,22 +49,56 @@ tags$h2(""1. SITE LOCATION"")
 ```
 
 ```{r map, out.width=""100%"", results='asis'}
-data_points <- pts[!is.na(Long) & !is.na(Lat)]
+if(exists(""pts"") & !exists(""bgc_select"")){
+  indPoints = T
+  data_points <- pts[!is.na(Long) & !is.na(Lat)]
+  bgc_select <- NULL
+  dist_select <- NULL
+}else{
+  bbox <- st_read(pool, query = paste0(""select ST_Envelope(ST_Collect(geom)) from bgc_map where \""BGC\"" IN ('"",paste(bgc_select,collapse = ""','""),""');""))
+  bbox2 <- st_coordinates(bbox)[,1:2]
+  indPoints = F
+}
+
 leaflet::leaflet() %>%
   leaflet::addProviderTiles(leaflet::providers$CartoDB.PositronNoLabels, group = ""Positron"") %>%
-  addBGC_report(bgcSelect = c(""SBSdk"",""SBSmc2""),distSelect = NULL) %>%
+  addBGC_report(bgcSelect = bgc_select,distSelect = dist_select) %>%
   leaflet::addTiles(
     urlTemplate = paste0(""https://api.mapbox.com/styles/v1/"", mblbstyle, ""/tiles/{z}/{x}/{y}?access_token="", mbtk),
     attribution = '&#169; <a href=""https://www.mapbox.com/feedback/"">Mapbox</a>',
     options = leaflet::tileOptions(zIndex = 600)) %>%
-  leaflet::addMarkers(data = data_points, lng = ~Long, lat = ~Lat)
-
-#session$sendCustomMessage(""highlight_bec"",c(""SBSdk"",""SBSmc2""))
+  {if(indPoints) leaflet::addMarkers(.,data = data_points, lng = ~Long, lat = ~Lat) else .} %>%
+  {if(!indPoints) leaflet::fitBounds(.,unname(bbox2[1,1]),unname(bbox2[1,2]),unname(bbox2[3,1]),unname(bbox2[2,2])) else .}
 ```
 
 ```{r section2, results='asis'}
+if(!indPoints){
+  numPts <- 100
+  avg <- TRUE
+}else{
+  numPts <- nrow(pts)
+}
 tags$h2(""2. SESSION PARAMETERS"")
-tags$p(""Coming soon..."")
+```
+
+```{r}
+tagList(
+  tags$h4(""General Parameters""),
+  knitr::kable(data.table(""Parameters"" = c(""Number of Points<br />Considered"", ""Averaged?"", ""Date"", ""Time""), ""User Selections"" = c(nrow(pts), avg, format(Sys.Date(), ""%Y/%m/%d""), format(Sys.time(), ""%H:%M"", usetz = TRUE))),html = T),
+  # tags$h4(""Time Period Weights""),
+  # datTP <- data.table(TimePeriods = c(""1960-1991"",""1991-2020"",""2021-2040"",""2041-2060"",""2061-2080"",""2081-2100""),
+  #                     Estab_Weights = c(session_params$estabWt),rep(0,3),
+  #                     Future_Weights = c(0,0,session_params$futWt)),
+  # datTP <- melt(datTP, id.var = ""TimePeriods"",variable.name = ""Summary""),
+  # datTP <- dcast(datTP,Summary ~ TimePeriods, fun.aggregate = ""mean""),
+  #knitr::kable(datTP),
+  tags$h4(""GCM Weights""),
+  knitr::kable(session_params$gcmWt),
+  tags$h4(""Scenario Weights""),
+  knitr::kable(session_params$rcpWt)
+)
+
+
 ```
 
 ```{r section3, results='asis'}
@@ -155,7 +189,12 @@ tags$h2(""7. DATA POINT GEOREFERENCING"")
 ```
 
 ```{r points, results='asis', out.width=""100%""}
-knitr::kable(pts[,list(ID, Site, Latitude = Lat, Longitude = Long, Elevation = Elev, BGC)], table.attr = ""class=\""table table-hover table-centered\"""", format = ""html"")
+if(indPoints){
+  knitr::kable(pts[,list(ID, Site, Latitude = Lat, Longitude = Long, Elevation = Elev, BGC)], table.attr = ""class=\""table table-hover table-centered\"""", format = ""html"")
+}else{
+  print(paste0(""Preselected Points by BGC: "",bgc_select))
+}
+
 ```
 
 ```{r appendix, results='asis'}

---FILE: app/server/reportpdf.Rmd---
@@ -53,8 +53,8 @@ domap <- function(mappts) {
 pts_ref <- pts[[{if (avg) {""BGC""} else {""Site""}}]]
 
 # Selected options
-p <- data.table(""Parameters"" = c(""Representative<br />Concentration Pathways"", ""Number of Points<br />Considered"", ""Averaged?"", ""Date"", ""Time""), ""User Selections"" = c(paste(rcp, collapse = "" and ""), nrow(pts), avg, format(Sys.Date(), ""%Y/%m/%d""), format(Sys.time(), ""%H:%M"", usetz = TRUE)))
-opt_tb <- HTML(knitr::kable(p, row.names = FALSE, escape = FALSE, table.attr = ""class=\""table-centered\"""", format = ""html""))
+# p <- data.table(""Parameters"" = c(""Representative<br />Concentration Pathways"", ""Number of Points<br />Considered"", ""Averaged?"", ""Date"", ""Time""), ""User Selections"" = c(paste(rcp, collapse = "" and ""), nrow(pts), avg, format(Sys.Date(), ""%Y/%m/%d""), format(Sys.time(), ""%H:%M"", usetz = TRUE)))
+# opt_tb <- HTML(knitr::kable(p, row.names = FALSE, escape = FALSE, table.attr = ""class=\""table-centered\"""", format = ""html""))
 
 # Model information
 models_info_tb <- tags$div(style = ""display: flex"",

---FILE: data-raw/config/tileserver/config.json---
@@ -41,7 +41,7 @@
       ""mbtiles"": ""districts.mbtiles""
     },
     ""BC_BGC"": {
-      ""mbtiles"": ""bcbgc_old.mbtiles""
+      ""mbtiles"": ""bc_bgc12.mbtiles""
     }
   }
 }
\ No newline at end of file

---FILE: data-raw/scripts/create_package_data.R---
@@ -7,6 +7,8 @@ library(readxl)
 E1 <- fread(""./data-raw/data_tables/Edatopic_v12_10.csv"")
 S1 <- fread(""./data-raw/data_tables/Feasibility_v12_10.csv"")
 N1 <- fread(""./data-raw/data_tables/SiteSeries_names_v12_10.csv"")
+N1[,SiteSeriesLongName := gsub(""\x96"",""-"",SiteSeriesLongName)]
+use_data(N1,overwrite = T)
 SS <- fread(""./data-raw/data_tables/WNA_SSeries_v12_10.csv"")
 
 S1[,Confirmed := NULL]"
bcgov,CCISS_ShinyApp,aceb9595cb1a487a54371b3f09330bcd315379e5,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-09-03T23:47:23Z,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-09-03T23:47:23Z,Fixed header,data-raw/data_tables/SiteSeries_names_v12_9.csv;data-raw/scripts/create_package_data.R;data/N1.rda,False,True,True,False,2,1,3,"---FILE: data-raw/data_tables/SiteSeries_names_v12_9.csv---
@@ -1,3 +1,4 @@
+SS_NoSpace,SiteSeriesLongName
 BGxh1/102,Py  Antelope-brush  Bluebunch wheatgrass
 BGxh1/103,Py(Fd)  Rabbit-brush  Bluebunch wheatgrass
 BGxh1/110,Py  Sumac  Mock-orange

---FILE: data-raw/scripts/create_package_data.R---
@@ -18,7 +18,7 @@ S1[Spp %in% c(""Pyi"",""Pyc""),Spp := ""Py""]
 S1[Spp %in% c(""Acb"",""Act""),Spp := ""Ac""]
 S1 <- S1[Spp != ""X"",]
 save(S1, file = ""./data/S1.rda"")
-
+use_data(N1,overwrite = T)
 SIBEC <- fread(""~/PortfolioKiri/InputsGit/PredSI_May2020.csv"") 
 SIBECnew <- fread(""~/PortfolioKiri/InputsGit/SI_to_add.csv"")
 SIBEC <- rbind(SIBEC, SIBECnew)"
bcgov,CCISS_ShinyApp,9fef7187cde39733e4cd27a412085d439eb01c75,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-09-02T06:16:12Z,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-09-02T06:16:12Z,Fixed SS_Names,app/server/generate.R;data-raw/scripts/bigshinygisstudio.R,False,True,True,False,2,3,5,"---FILE: app/server/generate.R---
@@ -53,7 +53,7 @@ observeEvent(input$generate_results, priority = 100, {
     ss <- sort(unique(cciss_results[SiteRef %in% sr]$SS_NoSpace))
     names(ss) <- paste(
       ss,
-      stocking_info$SiteSeriesName[match(ss, stocking_info[, paste(ZoneSubzone, SiteSeries, sep = ""/"")])]
+      N1$SiteSeriesLongName[match(ss, N1$SS_NoSpace)]
     )
     ss
   })

---FILE: data-raw/scripts/bigshinygisstudio.R---
@@ -117,8 +117,7 @@ analogsea::droplet_ssh(server, ""R -e \""remotes::install_github('FLNRO-Smithers-R
 analogsea::droplet_upload(server, ""./app/index.Rmd"", ""/srv/shiny-server/ccissdev/index.Rmd"")
 analogsea::droplet_upload(server, ""./app/www"", ""/srv/shiny-server/ccissdev"")
 analogsea::droplet_upload(server, ""./app/server"", ""/srv/shiny-server/ccissdev"")
-analogsea::droplet_upload(server, ""./app/TileOutline.gpkg"", ""/srv/shiny-server/ccissdev/TileOutline.gpkg"")
-analogsea::droplet_upload(server, ""./app/RCB_Outline.gpkg"", ""/srv/shiny-server/ccissdev/RCB_Outline.gpkg"")
+analogsea::droplet_upload(server, ""./app/NoData.gpkg"", ""/srv/shiny-server/ccissdev/NoData.gpkg"")
 analogsea::droplet_ssh(server, ""chown -R shiny:shiny /srv/shiny-server"")
 analogsea::droplet_ssh(server, ""systemctl restart shiny-server"")
 "
bcgov,CCISS_ShinyApp,54b96189218dec19c33b8369e7750ca27f9293fa,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-09-01T15:05:09Z,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-09-01T15:05:09Z,Fixed yaml,app/NoData.gpkg;app/index.Rmd,True,False,True,False,2,4,6,"---FILE: app/index.Rmd---
@@ -100,7 +100,7 @@ radioButtons(
 hr(style = ""border-top: 1px solid #8f0e7e;"")
 ```
 
----
+
 ##### Add Points of Interest Using One of the 3 Methods Below
 
 ###### 1. Enter Lat/Long or Click on Map to Add Points
@@ -119,7 +119,6 @@ actionButton(""clear_button"", ""Clear All"", icon(""broom""), width=120)
 hr(style = ""border-top: 1px solid #8f0e7e;"")
 ```
 
----
 
 ###### 2. Generate summary using preselected points by BGC or BGC+Distict:
 
@@ -129,7 +128,7 @@ Click BGC on map to use points across an entire BGC subzone/variant or only BGCs
   radioButtons(
       ""preselected"",
       label = NULL,
-      choiceNames =  c(""None"", ""BGC"",""BGC and District""),
+      choiceNames =  c(""None"", ""BGC"",""District then BGC""),
       choiceValues = c(""N"",""BGC"",""BGC_Dist""),
       inline = T
     )
@@ -140,7 +139,6 @@ splitLayout(actionButton(""clear_highlight"",""Clear Selections""),
 hr(style = ""border-top: 1px solid #8f0e7e;"")
 ```
 
----
 ###### 3. Upload a CSV file contain points of interests
 
 Upload a csv file with columns named ID1, Latitude, and Longitude (negative values) with your points of interest."
bcgov,CCISS_ShinyApp,a377deec6b6e516bc644e5037e7b9e38c7e01687,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-08-29T19:43:26Z,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-08-29T19:43:26Z,Fixed model trend,src/ccissdev.cpp,False,False,False,False,6,0,6,"---FILE: src/ccissdev.cpp---
@@ -166,13 +166,19 @@ NumericVector ModelDir(NumericMatrix x, NumericVector Curr, std::string dir){
       temp = x(i,_);
       temp.push_front(0);
       curr_suit = Curr[i];
+      if(curr_suit == 4){
+        curr_suit = 3;
+      }
       res[i] = sum(temp[Range(0,curr_suit)]);
     }
   }else{
     for(int i = 0; i < n; i++){
       temp = x(i,_);
       temp.push_back(0);
       curr_suit = Curr[i];
+      if(curr_suit == 4){
+        curr_suit = 3;
+      }
       res[i] = sum(temp[Range(curr_suit,4)]);
     }
   }"
bcgov,CCISS_ShinyApp,fb742d218918858ff5889503eeddb2a8fa6baccc,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-08-27T03:42:57Z,Kiri Daust,34073038+kdaust@users.noreply.github.com,2021-08-27T03:42:57Z,Fixed data,data-raw/scripts/create_package_data.R;data/E1.rda;data/S1.rda,False,True,True,False,1,1,2,"---FILE: data-raw/scripts/create_package_data.R---
@@ -29,7 +29,7 @@ TreeCols <- fread(""~/PortfolioKiri/InputsGit/PortfolioSppColours.csv"") ##in pack
 TreeCols <- TreeCols[HexColour != """",]
 save(TreeCols, file = ""./data/TreeCols.rda"")
 
-SS <- fread(""~/CommonTables/WNA_SSeries_v12_8.csv"")
+SS <- fread(""./data-raw/data_tables/WNA_SSeries_v12_8.csv"")
 SS <- SS[,.(SS_NoSpace,SpecialCode)]
 SS <- SS[SpecialCode != """",]
 E1 <- SS[E1, on = ""SS_NoSpace""]"
bcgov,CCISS_ShinyApp,d7e919d0cb7a181854f614c2410a149b013d98a6,Kiri Daust,kiridaust@gmail.com,2021-08-24T18:37:10Z,Kiri Daust,kiridaust@gmail.com,2021-08-24T18:37:10Z,Fixed multiple bugs,R/feasibility.R;app/index.Rmd;app/server/feasibility.R;app/server/generate.R;app/server/generate_portfolio.R,True,True,True,False,38,40,78,"---FILE: R/feasibility.R---
@@ -105,19 +105,17 @@ ccissOutput <- function(SSPred,suit,rules,feasFlag,histWeights,futureWeights){
            dplyr::mutate(NewSuit = sub('10', 'X', NewSuit)) 
   
   ###mid rotation trend using 41-60 and 61-80 - used for bifurcation
-  wt41 <- 0.5
-  wt61 <- 0.5
-  datRot <- suitVotes[FuturePeriod %in% c(2041,2061),]
-  datRot[FuturePeriod == 2041, (colNms) := lapply(.SD,""*"",wt41), .SDcols = colNms]
-  datRot[FuturePeriod == 2061, (colNms) := lapply(.SD,""*"",wt61), .SDcols = colNms]
-  datRot <- datRot[,lapply(.SD, sum),.SDcols = colNms, by = .(SiteRef,SS_NoSpace,Spp,Curr)]
+  # wt41 <- 0.5
+  # wt61 <- 0.5
+  datRot <- suitVotes[FuturePeriod %in% c(2061,2081),]
+  # datRot[FuturePeriod == 2041, (colNms) := lapply(.SD,""*"",wt41), .SDcols = colNms]
+  # datRot[FuturePeriod == 2061, (colNms) := lapply(.SD,""*"",wt61), .SDcols = colNms]
+  datRot <- datRot[,lapply(.SD, mean),.SDcols = colNms, by = .(SiteRef,SS_NoSpace,Spp,Curr)]
   datRot[,Xadj := rowSums(.SD), .SDcols = colNms]
-  datRot[,X2 := X + (1-Xadj)]
   ##calculate bifurcating
-  colNms2 <- c(""1"",""2"",""3"",""X2"")
-  datRot[,Improve := ModelDir(as.matrix(.SD), Curr = Curr, dir = ""Improve""),.SDcols = colNms2]
-  datRot[,Stable := ModelDir(as.matrix(.SD), Curr = Curr, dir = ""Stable""),.SDcols = colNms2]
-  datRot[,Decline := ModelDir(as.matrix(.SD), Curr = Curr, dir = ""Decline""),.SDcols = colNms2]
+  datRot[,Improve := ModelDir(as.matrix(.SD), Curr = Curr, dir = ""Improve""),.SDcols = colNms]
+  datRot[,Stable := ModelDir(as.matrix(.SD), Curr = Curr, dir = ""Stable""),.SDcols = colNms]
+  datRot[,Decline := ModelDir(as.matrix(.SD), Curr = Curr, dir = ""Decline""),.SDcols = colNms]
   datRot[,Bifurc := bifurcTrend(Imp = Improve, Decl = Decline, cutoff = 0.2)]
   datRot[,ModAgr := max(Improve,Stable,Decline), by = 1:nrow(datRot)]
   datRot[,ModAgr := round(ModAgr, digits = 2)]
@@ -130,8 +128,7 @@ ccissOutput <- function(SSPred,suit,rules,feasFlag,histWeights,futureWeights){
                          by = .(SiteRef,FuturePeriod, SS_NoSpace,Spp,Curr)]
   datFuture[,NewSuit := `1`+(`2`*2)+(`3`*3)+(X*4)]
   datFuture[ccissWt, Weight := i.Weight, on = ""FuturePeriod""]
-  datFuture[,NewSuit := NewSuit * Weight]
-  datFuture <- datFuture[,.(ccissSuit = sum(NewSuit)), 
+  datFuture <- datFuture[,.(ccissSuit = weighted.mean(NewSuit,Weight)), 
                          by = .(SiteRef,SS_NoSpace,Spp,Curr)]
   datFuture[,ccissSuit := round(ccissSuit)]
   

---FILE: app/index.Rmd---
@@ -148,11 +148,11 @@ HTML(
 )
 ```
 
-SPECIES FEASIBILITY
-===================================== 
+CCISS Report
+-------------------------------------
 
 ```{r}
-tableOutput(""results_feas"")
+column(12, align=""center"", tableOutput(""results_feas""))
 ```
 
 
@@ -383,7 +383,7 @@ tOut <- st_read(""./TileOutline.gpkg"")
 tOut2 <- st_read(""./RCB_Outline.gpkg"")
 tOut <- st_union(tOut,tOut2)
 portfolio_results <- reactiveValues(data = NULL)
-session_params <- reactiveValues(estabWt = c(0.3,0.35,0.35),midWt = c(0.5,0.5),
+session_params <- reactiveValues(estabWt = c(0.3,0.35,0.35),futWt = c(0.25,0.25,0.25,0.25),
                              modelWt = all_weight, rcpWt = rcp_weight, gcmWt = gcm_weight)
 update_flag <- reactiveVal(0)
 source(""./server/generate.R"", local = TRUE)
@@ -438,14 +438,16 @@ observeEvent(input$sesh_params,{
     h2(""Adjust Session Parameters""),
     h6(""Establishment Feasibility Weights""),
     splitLayout(
-      numericInput(""wt961"",""1961-1990"", value = session_params$estabWt[1], min = 0, max = 1,step = 0.05),
-      numericInput(""wt991"",""1991-2020"", value = session_params$estabWt[2], min = 0, max = 1,step = 0.05),
-      numericInput(""wt21"",""2021-2040"", value = session_params$estabWt[3], min = 0, max = 1,step = 0.05)
+      numericInput(""hwt961"",""1961-1990"", value = session_params$estabWt[1], min = 0, max = 1,step = 0.05),
+      numericInput(""hwt991"",""1991-2020"", value = session_params$estabWt[2], min = 0, max = 1,step = 0.05),
+      numericInput(""hwt21"",""2021-2040"", value = session_params$estabWt[3], min = 0, max = 1,step = 0.05)
     ),
-    h6(""Mid Rotation Weights""),
+    h6(""Future Period Weights""),
     splitLayout(
-      numericInput(""wt41"",""2041-2060"", value = session_params$midWt[1], min = 0, max = 1,step = 0.05),
-      numericInput(""wt61"",""2061-2080"", value = session_params$midWt[2], min = 0, max = 1,step = 0.05)
+      numericInput(""wt21"",""2021-2040"", value = session_params$futWt[1], min = 0, max = 1,step = 0.05),
+      numericInput(""wt41"",""2041-2060"", value = session_params$futWt[2], min = 0, max = 1,step = 0.05),
+      numericInput(""wt61"",""2061-2080"", value = session_params$futWt[3], min = 0, max = 1,step = 0.05),
+      numericInput(""wt81"",""2081-2100"", value = session_params$futWt[4], min = 0, max = 1,step = 0.05)
     ),
     h6(""GCM Weights""),
     p(""Click and drag bars to adjust weights""),
@@ -462,10 +464,10 @@ observeEvent(input$sesh_params,{
 })
 
 observeEvent(input$adj_params,{
-  estabWt <- as.numeric(c(input$wt961,input$wt991,input$wt21))
+  estabWt <- as.numeric(c(input$hwt961,input$hwt991,input$hwt21))
   estabWt <- estabWt/sum(estabWt)
-  midWt <- as.numeric(c(input$wt41,input$wt61))
-  midWt <- midWt/sum(midWt)
+  futWt <- as.numeric(c(input$wt21,input$wt41,input$wt61,input$wt81))
+  futWt <- futWt/sum(futWt)
   
   gcm_weight <- as.data.table(input$gcm_select)
   setnames(gcm_weight,c(""gcm"",""weight""))
@@ -476,7 +478,7 @@ observeEvent(input$adj_params,{
   all_weight[rcp_weight,wrcp := i.weight, on = ""rcp""]
   all_weight[,weight := wgcm*wrcp]
   session_params$estabWt <- estabWt
-  session_params$midWt <- midWt; session_params$modelWt <- all_weight;
+  session_params$futWt <- futWt; session_params$modelWt <- all_weight;
   session_params$rcpWt <- rcp_weight; session_params$gcmWt <- gcm_weight
   session$sendCustomMessage(type=""jsCode"", list(code= ""$('#generate_results').prop('disabled', false)""))
   removeModal()

---FILE: app/server/feasibility.R---
@@ -1,6 +1,6 @@
 # Update site series selector when site ref is modified
 observeEvent(input$siteref_feas, priority = 50, {
-  if (is.null(uData$cciss_results) | is.null(uData$cciss_summary)) return(NULL)
+  if (is.null(uData$cciss_results)) return(NULL)
   siteref <- input$siteref_feas
   updateSelectInput(inputId = ""site_series_feas"", choices = uData$siteseries_list[[siteref]])
 })
@@ -54,10 +54,10 @@ cciss_results_dt <- function(data, siteref, siteserie, filter, format = ""html"")
   data <- data[SiteRef == siteref & SS_NoSpace %in% siteserie,
                list(Species, Period, PredFeasSVG, CFSuitability, Curr, EstabFeas, ccissFeas, modAgr)]
   
-  for(i in c(""Curr"",""EstabFeas"",""Risk60"",""Risk80"")){ ##set NA to X
+  for(i in c(""Curr"",""EstabFeas"")){ ##set NA to X
     data[is.na(get(i)), (i) := ""X""]
   }
-    
+  
   tempTable <- knitr::kable(
     data, format = format, align = c(""l"",""c"",""c"",""c"",""c"",""c"",""c"",""c""), escape = FALSE,
     col.names = c(""Tree Species"", ""Period"", ""Modelled Feasibility"",

---FILE: app/server/generate.R---
@@ -18,11 +18,10 @@ observeEvent(input$generate_results, priority = 100, {
   tic(""Fetch CCISS Data from DB"", ticker)
   bgc             <- uData$bgc             <- bgc(pool, pts$Site, avg, session_params$modelWt)
   tic(""Process CCISS data"", ticker)
-  cciss           <- uData$cciss           <- cciss(bgc,session_params$estabWt,session_params$midWt)
+  cciss           <- uData$cciss           <- cciss(bgc,session_params$estabWt,session_params$futWt)
   tic(""Format CCISS Results"", ticker)
   cciss_results   <- uData$cciss_results   <- cciss_results(cciss, pts, avg)
   update_flag(update_flag() + 1) ##make sure things recalculate
-  
   # UI select choices
   tic(""Determine UI choices"", ticker)
   
@@ -31,9 +30,8 @@ observeEvent(input$generate_results, priority = 100, {
   bgc_opts <- unique(uData$bgc$BGC)
   
   #prepare tree choices for portfolio selection
-  suitTrees <- copy(uData$cciss$Summary)
-  #print(colnames(suitTrees))
-  suitTrees <- suitTrees[NewSuit %in% c(1,2,3,4),.(Spp, BGC = SS_NoSpace)] ##need to fix this
+  suitTrees <- copy(cciss_results)
+  suitTrees <- suitTrees[EstabFeas %in% c(1,2,3,4),.(Spp, BGC = ZoneSubzone)] ##need to fix this
   suitTrees <- unique(suitTrees)
   tree_opts <- suitTrees[BGC == bgc_opts[1],Spp]
   updateSelectInput(inputId = ""tree_species"",
@@ -100,6 +98,7 @@ observeEvent(input$generate_results, priority = 100, {
   output$timings <- plotly::renderPlotly({
     tocker
   })
+  print(""done generate"")
 })
 
 generateState <- function() {
@@ -128,16 +127,16 @@ bgc <- function(con, siteno, avg, modWeights) {
   })
 }
 
-#bgc <- dbGetCCISS(pool,siteno = 3140263, avg = F, modWeights = all_weight)
+#bgc <- dbGetCCISS(pool,siteno = 4629842, avg = F, modWeights = all_weight)
 # bgc <- sqlTest(pool,siteno = c(6476259,6477778,6691980,6699297),avg = T, scn = ""ssp370"")
 
 
-cciss <- function(bgc,estabWt,midWt) {
+cciss <- function(bgc,estabWt,futWt) {
   SSPred <- edatopicOverlap(bgc, Edatope = E1)
   setorder(SSPred,SiteRef,SS_NoSpace,FuturePeriod,BGC.pred,-SSratio)
   uData$eda_out <- SSPred
   ccissOutput(SSPred = SSPred, suit = S1, rules = R1, feasFlag = F1, 
-              histWeights = estabWt, futureWeights = rep(0.25,4))
+              histWeights = estabWt, futureWeights = futWt)
 }
 
 #SSPred2 <- SSPred[SS_NoSpace == ""ICHmw1/01"",]

---FILE: app/server/generate_portfolio.R---
@@ -14,9 +14,9 @@ makeColScale <- function(Trees){
 ##update possible species
 observeEvent(input$port_bgc,{
   if(input$generate_results > 0){
-    suitTrees <- copy(uData$cciss_summary)
+    suitTrees <- copy(uData$cciss_results)
     #print(colnames(suitTrees))
-    suitTrees <- suitTrees[NewSuit %in% c(1,2,3,4),.(Spp, BGC = ZoneSubzone)]
+    suitTrees <- suitTrees[EstabFeas %in% c(1,2,3,4),.(Spp, BGC = ZoneSubzone)]
     suitTrees <- unique(suitTrees)
     tree_opts <- suitTrees[BGC == input$port_bgc,Spp]
     tree_opts <- tree_opts[tree_opts != ""Ac""]"
bcgov,CCISS_ShinyApp,dac8aa38caa0567ba42b3e24bc752d3e0c5a460d,Kiri Daust,kiridaust@gmail.com,2021-08-23T19:36:33Z,Kiri Daust,kiridaust@gmail.com,2021-08-23T19:36:33Z,Fix Edatopic error,R/eda_overlap.R;app/server/futures.R;app/server/generate.R,False,True,True,False,15,14,29,"---FILE: R/eda_overlap.R---
@@ -32,7 +32,7 @@
 #' @importFrom stats complete.cases na.omit
 #' @export
 edatopicOverlap <- function(BGC,Edatope){
-  SS <- Edatope[is.na(SpecialCode),.(BGC,SS_NoSpace,Edatopic)]
+  SS <- Edatope[,.(BGC,SS_NoSpace,Edatopic)]
   SS <- unique(SS)
   BGC <- unique(BGC)
   SSsp <- Edatope[!is.na(SpecialCode),.(BGC,SS_NoSpace,SpecialCode)]
@@ -51,6 +51,7 @@ edatopicOverlap <- function(BGC,Edatope){
   # ""CWHvh2"" BGC gives out Join results in 258 rows; more than 135 = nrow(x)+nrow(i), I'm
   # setting it to allow.cartesian, might need to investigate.
   new <- CurrBGC[FutBGC, allow.cartesian=TRUE]
+  new <- new[!is.na(SS_NoSpace),] ##this removes special site series that don't align
   SSsp.out <- new[,.(allOverlap = 1/.N,SS.pred,BGC.prop), keyby = .(SiteRef,FuturePeriod,BGC,BGC.pred,SS_NoSpace)]
   
   ##regular site series edatopes
@@ -68,8 +69,7 @@ edatopicOverlap <- function(BGC,Edatope){
   FutBGC[,BGC.prop := NULL]
  
   setkey(CurrBGC,SiteRef,FuturePeriod, BGC,BGC.pred, Edatopic)
-  new <- FutBGC[CurrBGC]
-  #new <- dplyr::left_join(CurrBGC,FutBGC)#  was merge with, all = T bit failing with some predictions make sure not causing issue
+  new <- FutBGC[CurrBGC, allow.cartesian = T]
   setkey(new, SiteRef,FuturePeriod,BGC,BGC.pred,SS_NoSpace,SS.pred)
   ##new <- new[complete.cases(new),]
   
@@ -79,7 +79,6 @@ edatopicOverlap <- function(BGC,Edatope){
   SS.out2 <- new[,.(SS.Curr = length(unique(Edatopic)), BGC = unique(BGC.prop)), 
                  keyby = .(SiteRef,FuturePeriod,BGC,BGC.pred,SS_NoSpace)]
   comb <- SS.out2[SS.out]
-  #comb <- comb %>% tidyr::drop_na()
   
   ###reverse overlap
   SS.out.rev <- new[,.(SS.prob = .N), 
@@ -92,21 +91,24 @@ edatopicOverlap <- function(BGC,Edatope){
   comb[,SSProb := SS.prob/SS.Curr]
   combRev[,SSProbRev := SS.prob/SS.Curr]
   combAll <- merge(comb,combRev,by = c(""SiteRef"",""FuturePeriod"",""BGC"",""BGC.pred"",""SS_NoSpace"",""SS.pred""))
-  combAll <-combAll[!(combAll$BGC == combAll$BGC.pred  &  combAll$SS_NoSpace != combAll$SS.pred),] ### removes overlap where past BGC = future BGC
+  combAll <- combAll[!(BGC == BGC.pred  &  SS_NoSpace != SS.pred),] ### removes overlap where past BGC = future BGC
   combAll[,allOverlap := SSProb*SSProbRev]
   setnames(combAll, old = ""BGC.1.x"",new = ""BGC.prop"")
   combAll <- combAll[,.(SiteRef, FuturePeriod, BGC, BGC.pred, SS_NoSpace, 
                         allOverlap, SS.pred, BGC.prop)]
-  combAll <- rbind(combAll, SSsp.out)
-  combAll <- combAll[!is.na(SS_NoSpace),] %>% dplyr::distinct()
+  combAll <- merge(combAll,SSsp.out,
+                   by = c(""SiteRef"",""FuturePeriod"",""BGC"",""BGC.pred"",""SS_NoSpace"",""SS.pred""), all = T)
+  combAll[!is.na(allOverlap.y),`:=`(allOverlap.x = allOverlap.y,BGC.prop.x = BGC.prop.y)]
+  combAll[,c(""allOverlap.y"",""BGC.prop.y"") := NULL]
+  setnames(combAll,old = c(""allOverlap.x"",""BGC.prop.x""), new = c(""allOverlap"",""BGC.prop""))
+  combAll <- unique(combAll[!is.na(SS_NoSpace),])
 
   
   ##add in BGC probability
-  combAll <- combAll[stats::complete.cases(combAll),]
+  combAll <- na.omit(combAll)
   combAll[,SSratio := allOverlap/sum(allOverlap), by = .(SiteRef, FuturePeriod, BGC, BGC.pred,SS_NoSpace)] ##should check this?
   setorder(combAll, SiteRef, FuturePeriod, BGC, BGC.pred, SS_NoSpace)
   
-  combAll <- unique(combAll)
   setkey(combAll, SiteRef, FuturePeriod, BGC,BGC.pred)
   temp <- unique(combAll[,.(SiteRef,FuturePeriod,BGC,BGC.pred,BGC.prop)])
   temp[,BGC.prop := BGC.prop/sum(BGC.prop), by = .(SiteRef,FuturePeriod,BGC)]

---FILE: app/server/futures.R---
@@ -27,9 +27,9 @@ output$bgc_fut_plot <- plotly::renderPlotly({
 
 #' @param data BGC data.table
 bgc_fut_plotly <- function(data, siteref, sseries, minallow, period_map = uData$period_map, ...) {
-  data <- data[allOverlap > minallow,]
-  data[,allOverlap := allOverlap/sum(allOverlap), by = .(SiteRef,SS_NoSpace,FuturePeriod,BGC.pred,BGC.prop)]
-  data[,Lab := paste(SS.pred,round(allOverlap,digits = 2),sep = "": "")]
+  data <- data[SSratio > minallow,]
+  #data[,allOverlap := allOverlap/sum(allOverlap), by = .(SiteRef,SS_NoSpace,FuturePeriod,BGC.pred,BGC.prop)]
+  data[,Lab := paste(SS.pred,round(SSratio,digits = 2),sep = "": "")]
   data <- data[,.(SSLab = paste(Lab,collapse = ""<br>"")), 
                     by = .(SiteRef,SS_NoSpace,FuturePeriod,BGC.pred,BGC.prop)]
   data <- data[SiteRef == siteref & SS_NoSpace == sseries,]

---FILE: app/server/generate.R---
@@ -12,7 +12,6 @@ observeEvent(input$generate_results, priority = 100, {
   
   # Input from the app
   avg             <- uData$avg             <- as.logical(input$aggregation)
-  rcp             <- uData$rcp             <- input$rcp_scenario
   pts             <- uData$pts             <- userpoints$dt
   
   # Results from processing
@@ -131,7 +130,7 @@ bgc <- function(con, siteno, avg, modWeights) {
   })
 }
 
-# bgc <- dbGetCCISS(pool,siteno = c(4532735,4546791,4548548),avg = F, modWeights = all_weight)
+#bgc <- dbGetCCISS(pool,siteno = 3140263, avg = F, modWeights = all_weight)
 # bgc <- sqlTest(pool,siteno = c(6476259,6477778,6691980,6699297),avg = T, scn = ""ssp370"")
 
 "
bcgov,CCISS_ShinyApp,58352873ec671c78630e0b565998159873000f4f,Kiri Daust,kiridaust@gmail.com,2021-08-19T17:43:02Z,Kiri Daust,kiridaust@gmail.com,2021-08-19T17:43:02Z,Fixed reactivity with session parameters,app/index.Rmd;app/server/feasibility.R;app/server/futures.R;app/server/generate.R,True,False,True,False,50,50,100,"---FILE: app/index.Rmd---
@@ -73,40 +73,6 @@ all_weight <- as.data.table(expand.grid(gcm = gcm_weight$gcm,rcp = rcp_weight$rc
 all_weight[gcm_weight,wgcm := i.weight, on = ""gcm""]
 all_weight[rcp_weight,wrcp := i.weight, on = ""rcp""]
 all_weight[,weight := wgcm*wrcp]
-
-gcm_amchart <- amBarChart(
-  data = gcm_weight,
-  category = ""gcm"", values = ""weight"",
-  draggable = TRUE,
-  columnWidth = 80,
-  tooltip =
-    ""[bold]{valueY}[/]"",
-  xAxis = list(title = amText(text = ""GCM""),
-               labels = amAxisLabels(fontSize = 10,rotation = 90)),
-  yAxis = list(
-    title = amText(text = ""Weight"", color = ""maroon""),
-    labels = amAxisLabels(fontSize = 10),
-    gridLines = amLine(color = ""orange"", width = 1, opacity = 0.4)
-  ),
-  yLimits = c(0, 1),
-  valueFormatter = ""#.##"",
-  theme = ""dataviz"")
-
-rcp_amchart <- amBarChart(
-  data = rcp_weight,
-  category = ""rcp"", values = ""weight"",
-  draggable = TRUE,
-  tooltip =
-    ""[bold]{valueY}[/]"",
-  xAxis = list(title = amText(text = ""Scenario"")),
-  yAxis = list(
-    title = amText(text = ""Weight"", color = ""maroon""),
-    labels = amAxisLabels(fontSize = 10),
-    gridLines = amLine(color = ""orange"", width = 1, opacity = 0.4)
-  ),
-  yLimits = c(0, 1),
-  valueFormatter = ""#.##"",
-  theme = ""dataviz"")
 ```
 
 SELECT SITES
@@ -419,11 +385,15 @@ tags$script(HTML('
 # bslib::bs_themer()
 # Reusing Shiny session userData environment
 uData <- session$userData
+
 library(sf)
 tOut <- st_read(""./TileOutline.gpkg"")
 tOut2 <- st_read(""./RCB_Outline.gpkg"")
 tOut <- st_union(tOut,tOut2)
 portfolio_results <- reactiveValues(data = NULL)
+session_params <- reactiveValues(estabWt = c(0.3,0.35,0.35),midWt = c(0.5,0.5),
+                             modelWt = all_weight, rcpWt = rcp_weight, gcmWt = gcm_weight)
+update_flag <- reactiveVal(0)
 source(""./server/generate.R"", local = TRUE)
 source(""./server/points.R"", local = TRUE)
 source(""./server/map.R"", local = TRUE)
@@ -434,28 +404,56 @@ source(""./server/download.R"", local = TRUE)
 source(""./server/generate_portfolio.R"", local = TRUE)
 
 ##default session parameters
-uData$session_params <- list(estabWt = c(0.3,0.35,0.35),midWt = c(0.5,0.5),
-                             modelWt = all_weight)
 output$rcp_select <- renderAmChart4({
-  rcp_amchart
+  amBarChart(
+    data = session_params$rcpWt,
+    category = ""rcp"", values = ""weight"",
+    draggable = TRUE,
+    tooltip =
+      ""[bold]{valueY}[/]"",
+    xAxis = list(title = amText(text = ""Scenario"")),
+    yAxis = list(
+      title = amText(text = ""Weight"", color = ""maroon""),
+      labels = amAxisLabels(fontSize = 10),
+      gridLines = amLine(color = ""orange"", width = 1, opacity = 0.4)
+    ),
+    yLimits = c(0, 1),
+    valueFormatter = ""#.##"",
+    theme = ""dataviz"")
 })
 output$gcm_select <- renderAmChart4({
-  gcm_amchart
+  amBarChart(
+    data = session_params$gcmWt,
+    category = ""gcm"", values = ""weight"",
+    draggable = TRUE,
+    columnWidth = 80,
+    tooltip =
+      ""[bold]{valueY}[/]"",
+    xAxis = list(title = amText(text = ""GCM""),
+                 labels = amAxisLabels(fontSize = 10,rotation = 90)),
+    yAxis = list(
+      title = amText(text = ""Weight"", color = ""maroon""),
+      labels = amAxisLabels(fontSize = 10),
+      gridLines = amLine(color = ""orange"", width = 1, opacity = 0.4)
+    ),
+    yLimits = c(0, 1),
+    valueFormatter = ""#.##"",
+    theme = ""dataviz"")
 })
 
 observeEvent(input$sesh_params,{
   showModal(modalDialog(
     h2(""Adjust Session Parameters""),
     h6(""Establishment Feasibility Weights""),
     splitLayout(
-      numericInput(""wt961"",""1961-1990"", value = 0.3, min = 0, max = 1,step = 0.05),
-      numericInput(""wt991"",""1991-2020"", value = 0.35, min = 0, max = 1,step = 0.05),
-      numericInput(""wt21"",""2021-2040"", value = 0.35, min = 0, max = 1,step = 0.05)
+      numericInput(""wt961"",""1961-1990"", value = session_params$estabWt[1], min = 0, max = 1,step = 0.05),
+      numericInput(""wt991"",""1991-2020"", value = session_params$estabWt[2], min = 0, max = 1,step = 0.05),
+      numericInput(""wt21"",""2021-2040"", value = session_params$estabWt[3], min = 0, max = 1,step = 0.05)
     ),
     h6(""Mid Rotation Weights""),
     splitLayout(
-      numericInput(""wt41"",""2041-2060"", value = 0.5, min = 0, max = 1,step = 0.05),
-      numericInput(""wt61"",""2061-2080"", value = 0.5, min = 0, max = 1,step = 0.05)
+      numericInput(""wt41"",""2041-2060"", value = session_params$midWt[1], min = 0, max = 1,step = 0.05),
+      numericInput(""wt61"",""2061-2080"", value = session_params$midWt[2], min = 0, max = 1,step = 0.05)
     ),
     h6(""GCM Weights""),
     p(""Click and drag bars to adjust weights""),
@@ -475,7 +473,7 @@ observeEvent(input$adj_params,{
   estabWt <- as.numeric(c(input$wt961,input$wt991,input$wt21))
   estabWt <- estabWt/sum(estabWt)
   midWt <- as.numeric(c(input$wt41,input$wt61))
-  midWt <- uData$midWt <- midWt/sum(midWt)
+  midWt <- midWt/sum(midWt)
   
   gcm_weight <- as.data.table(input$gcm_select)
   setnames(gcm_weight,c(""gcm"",""weight""))
@@ -485,8 +483,9 @@ observeEvent(input$adj_params,{
   all_weight[gcm_weight,wgcm := i.weight, on = ""gcm""]
   all_weight[rcp_weight,wrcp := i.weight, on = ""rcp""]
   all_weight[,weight := wgcm*wrcp]
-  uData$session_params <- list(estabWt = estabWt,midWt = midWt,
-                             modelWt = all_weight)
+  session_params$estabWt <- estabWt
+  session_params$midWt <- midWt; session_params$modelWt <- all_weight;
+  session_params$rcpWt <- rcp_weight; session_params$gcmWt <- gcm_weight
   session$sendCustomMessage(type=""jsCode"", list(code= ""$('#generate_results').prop('disabled', false)""))
   removeModal()
 })

---FILE: app/server/feasibility.R---
@@ -32,6 +32,7 @@ uData$cciss_summary_dt <- cciss_summary_dt
 output$results_feas <- function() {
   siteref <- input$siteref_feas
   siteserie <- input$site_series_feas
+  update_flag()
   cciss_results <- copy(uData$cciss_results)
   feas_filter <- input$filter_feas
   if (is.null(cciss_results)) return(NULL)

---FILE: app/server/futures.R---
@@ -18,6 +18,7 @@ output$bgc_fut_plot <- plotly::renderPlotly({
   siteref <- input$siteref_bgc_fut
   sseries <- input$ss_bgc_fut
   minallow <- input$min_ssoverlap
+  update_flag()
   if (is.null(uData$eda_out)) return(NULL)
   bgc_fut_plotly(copy(uData$eda_out), siteref, sseries, minallow)
 })

---FILE: app/server/generate.R---
@@ -15,17 +15,16 @@ observeEvent(input$generate_results, priority = 100, {
   rcp             <- uData$rcp             <- input$rcp_scenario
   pts             <- uData$pts             <- userpoints$dt
   
-  params <- uData$session_params
   # Results from processing
   tic(""Fetch CCISS Data from DB"", ticker)
-  bgc             <- uData$bgc             <- bgc(pool, pts$Site, avg, params$modelWt)
+  bgc             <- uData$bgc             <- bgc(pool, pts$Site, avg, session_params$modelWt)
   tic(""Process CCISS data"", ticker)
-  cciss           <- uData$cciss           <- cciss(bgc,params$estabWt,params$midWt)
+  cciss           <- uData$cciss           <- cciss(bgc,session_params$estabWt,session_params$midWt)
   tic(""Format CCISS Results"", ticker)
   cciss_results   <- uData$cciss_results   <- cciss_results(cciss, pts, avg)
   tic(""Format CCISS Summary"", ticker)
   cciss_summary   <- uData$cciss_summary   <- cciss_summary(cciss, pts, avg)
-  
+  update_flag(update_flag() + 1) ##make sure things recalculate
   
   # UI select choices
   tic(""Determine UI choices"", ticker)"
bcgov,CCISS_ShinyApp,7926ea8b8ea95e8bb721f9015fba8ffd8936b562,Kiri Daust,kiridaust@gmail.com,2021-08-09T17:36:37Z,Kiri Daust,kiridaust@gmail.com,2021-08-09T17:36:37Z,Fixed issue,R/data_etl.R;app/server/generate_portfolio.R,False,True,True,False,3,3,6,"---FILE: R/data_etl.R---
@@ -172,8 +172,9 @@ dbGetCCISS <- function(con, siteno, avg, scn = c(""ssp126"",""ssp245"",""ssp370"",""ssp
            bgc_pred,
            gcm
     FROM test_future
-    WHERE scenario IN ('"", paste(scn, collapse = ""','""), ""') and
-          siteno IN ("", paste(unique(siteno), collapse = "",""), "")
+    WHERE siteno IN ("", paste(unique(siteno), collapse = "",""), "")
+    AND scenario IN ('"", paste(scn, collapse = ""','""), ""')
+    AND futureperiod IN ('2021','2041','2061','2081')
     
     UNION ALL
     

---FILE: app/server/generate_portfolio.R---
@@ -121,7 +121,6 @@ output$growth_sim <- renderPlot({
 output$port_table <- renderTable({
   if(is.null(portfolio_results$data)) return(NULL)
   dat <- copy(portfolio_results$data)
-  print(dat$simulated)
   temp <- dat$summary
   temp <- temp[!Spp %chin% c(""RealRet"",""Sd""),.(Spp,Sharpe_Opt,Set_Return)]
   setnames(temp,c(""Species"",""Sharpe"",""SetReturn""))"
bcgov,CCISS_ShinyApp,c0fc1f2bcf0c074dd7b31fa7f5083e8ef9605019,Kiri Daust,kiridaust@gmail.com,2021-08-06T22:56:20Z,Kiri Daust,kiridaust@gmail.com,2021-08-06T22:56:20Z,Fixed stuff,R/data_etl.R;app/RCB_Outline.gpkg;app/index.Rmd;app/index_files/ionRangeSlider-2.3.1/font.css;app/index_files/ionRangeSlider-2.3.1/fonts/1Ptxg8zYS_SKggPN4iEgvnHyvveLxVs9pbCIPrc.woff;app/index_files/ionRangeSlider-2.3.1/fonts/1Ptxg8zYS_SKggPN4iEgvnHyvveLxVvaorCIPrc.woff;app/index_files/ionRangeSlider-2.3.1/fonts/4iCs6KVjbNBYlgo6ew.woff;app/index_files/ionRangeSlider-2.3.1/fonts/4iCs6KVjbNBYlgoKfw7w.woff;app/index_files/ionRangeSlider-2.3.1/fonts/4iCv6KVjbNBYlgoCxCvTtA.woff;app/index_files/ionRangeSlider-2.3.1/fonts/4iCv6KVjbNBYlgoCxCvjsGyL.woff;app/index_files/ionRangeSlider-2.3.1/fonts/6xK1dSBYKcSV-LCoeQqfX1RYOo3qPZ7nsDQ.woff;app/index_files/ionRangeSlider-2.3.1/fonts/6xK1dSBYKcSV-LCoeQqfX1RYOo3qPa7j.woff;app/index_files/ionRangeSlider-2.3.1/fonts/6xK3dSBYKcSV-LCoeQqfX1RYOo3aPA.woff;app/index_files/ionRangeSlider-2.3.1/fonts/6xK3dSBYKcSV-LCoeQqfX1RYOo3qOK7j.woff;app/index_files/ionRangeSlider-2.3.1/fonts/6xKydSBYKcSV-LCoeQqfX1RYOo3i54rAkw.woff;app/index_files/ionRangeSlider-2.3.1/fonts/6xKydSBYKcSV-LCoeQqfX1RYOo3ig4vAkw.woff;app/index_files/ionRangeSlider-2.3.1/fonts/6xKydSBYKcSV-LCoeQqfX1RYOo3ig4vwlxdo.woff;app/index_files/ionRangeSlider-2.3.1/fonts/6xKydSBYKcSV-LCoeQqfX1RYOo3ik4zAkw.woff;app/index_files/ionRangeSlider-2.3.1/fonts/6xKydSBYKcSV-LCoeQqfX1RYOo3ik4zwlxdo.woff;app/index_files/ionRangeSlider-2.3.1/fonts/CSR54z1Qlv-GDxkbKVQ_dFsvWNRevw.woff;app/index_files/ionRangeSlider-2.3.1/fonts/CSR54z1Qlv-GDxkbKVQ_dFsvaNA.woff;app/index_files/ionRangeSlider-2.3.1/fonts/CSR64z1Qlv-GDxkbKVQ_TOQ.woff;app/index_files/ionRangeSlider-2.3.1/fonts/CSR64z1Qlv-GDxkbKVQ_fOAKSw.woff;app/index_files/ionRangeSlider-2.3.1/fonts/JTURjIg1_i6t8kCHKm45_ZpC7g0.woff;app/index_files/ionRangeSlider-2.3.1/fonts/JTURjIg1_i6t8kCHKm45_dJE7g0.woff;app/index_files/ionRangeSlider-2.3.1/fonts/JTUSjIg1_i6t8kCHKm45xW0.woff;app/index_files/ionRangeSlider-2.3.1/fonts/KFOlCnqEu92Fr1MmEU9fBBc-.woff;app/index_files/ionRangeSlider-2.3.1/fonts/KFOlCnqEu92Fr1MmEU9vAA.woff;app/index_files/ionRangeSlider-2.3.1/fonts/KFOlCnqEu92Fr1MmSU5fBBc-.woff;app/index_files/ionRangeSlider-2.3.1/fonts/KFOlCnqEu92Fr1MmSU5vAA.woff;app/index_files/ionRangeSlider-2.3.1/fonts/KFOlCnqEu92Fr1MmWUlfBBc-.woff;app/index_files/ionRangeSlider-2.3.1/fonts/KFOlCnqEu92Fr1MmWUlvAA.woff;app/index_files/ionRangeSlider-2.3.1/fonts/KFOmCnqEu92Fr1Me5g.woff;app/index_files/ionRangeSlider-2.3.1/fonts/KFOmCnqEu92Fr1Mu4mxM.woff;app/index_files/ionRangeSlider-2.3.1/fonts/QGYpz_kZZAGCONcK2A4bGOj8mNhL.woff;app/index_files/ionRangeSlider-2.3.1/fonts/S6u8w4BMUTPHjxsAXC-s.woff;app/index_files/ionRangeSlider-2.3.1/fonts/S6u8w4BMUTPHjxswWA.woff;app/index_files/ionRangeSlider-2.3.1/fonts/S6u9w4BMUTPHh6UVSwiPHw.woff;app/index_files/ionRangeSlider-2.3.1/fonts/S6u9w4BMUTPHh6UVeww.woff;app/index_files/ionRangeSlider-2.3.1/fonts/S6u9w4BMUTPHh7USSwiPHw.woff;app/index_files/ionRangeSlider-2.3.1/fonts/S6u9w4BMUTPHh7USeww.woff;app/index_files/ionRangeSlider-2.3.1/fonts/S6uyw4BMUTPHjx4wWA.woff;app/index_files/ionRangeSlider-2.3.1/fonts/S6uyw4BMUTPHvxo.woff;app/index_files/ionRangeSlider-2.3.1/fonts/bootstrap/glyphicons-halflings-regular.eot;app/index_files/ionRangeSlider-2.3.1/fonts/bootstrap/glyphicons-halflings-regular.svg;app/index_files/ionRangeSlider-2.3.1/fonts/bootstrap/glyphicons-halflings-regular.ttf;app/index_files/ionRangeSlider-2.3.1/fonts/bootstrap/glyphicons-halflings-regular.woff;app/index_files/ionRangeSlider-2.3.1/fonts/bootstrap/glyphicons-halflings-regular.woff2;app/index_files/ionRangeSlider-2.3.1/fonts/mem5YaGs126MiZpBA-UN7rg-Vg.woff;app/index_files/ionRangeSlider-2.3.1/fonts/mem5YaGs126MiZpBA-UN7rgOUuhv.woff;app/index_files/ionRangeSlider-2.3.1/fonts/mem5YaGs126MiZpBA-UN_r8-Vg.woff;app/index_files/ionRangeSlider-2.3.1/fonts/mem5YaGs126MiZpBA-UN_r8OUuhv.woff;app/index_files/ionRangeSlider-2.3.1/fonts/mem6YaGs126MiZpBA-UFUJ0d.woff;app/index_files/ionRangeSlider-2.3.1/fonts/mem6YaGs126MiZpBA-UFUK0Zdcs.woff;app/index_files/ionRangeSlider-2.3.1/fonts/mem8YaGs126MiZpBA-U1UQ.woff;app/index_files/ionRangeSlider-2.3.1/fonts/mem8YaGs126MiZpBA-UFVZ0d.woff;app/index_files/ionRangeSlider-2.3.1/fonts/memnYaGs126MiZpBA-UFUKWiUNhrIqU.woff;app/index_files/ionRangeSlider-2.3.1/fonts/memnYaGs126MiZpBA-UFUKWiUOhv.woff;app/index_files/ionRangeSlider-2.3.1/fonts/memnYaGs126MiZpBA-UFUKWyV-hv.woff;app/index_files/ionRangeSlider-2.3.1/fonts/memnYaGs126MiZpBA-UFUKWyV9hrIqU.woff;app/index_files/ionRangeSlider-2.3.1/fonts/pe03MImSLYBIv1o4X1M8cc9iB_5p.woff;app/index_files/ionRangeSlider-2.3.1/fonts/pe0qMImSLYBIv1o4X1M8cfe5.woff;app/index_files/ionRangeSlider-2.3.1/fonts/q5uGsou0JOdh94bfvQlr.woff;app/index_files/ionRangeSlider-2.3.1/ionRangeSlider.css;app/server/generate.R,True,True,True,False,600,4,604,"---FILE: R/data_etl.R---
@@ -177,12 +177,12 @@ dbGetCCISS <- function(con, siteno, avg, scn = c(""ssp126"",""ssp245"",""ssp370"",""ssp
     
     UNION ALL
     
-    SELECT '1961' as futureperiod,
-            test_historic.siteno,
+    SELECT DISTINCT '1961' as futureperiod,
+            test_prob.siteno,
             bgc,
             bgc as bgc_pred,
             'Historic' as gcm
-    FROM test_historic
+    FROM test_prob
     WHERE siteno IN ("", paste(unique(siteno), collapse = "",""), "")
   
   ), cciss_count_den AS (
@@ -238,6 +238,7 @@ dbGetCCISS <- function(con, siteno, avg, scn = c(""ssp126"",""ssp245"",""ssp370"",""ssp
   dat <- setDT(RPostgres::dbGetQuery(con, cciss_sql))
 
   setnames(dat, c(""SiteRef"",""FuturePeriod"",""BGC"",""BGC.pred"",""BGC.prop""))
+  dat <- unique(dat) ##should fix database so not necessary
   #print(dat)
   return(dat)
 }

---FILE: app/index.Rmd---
@@ -378,6 +378,8 @@ tags$script(HTML('
 uData <- session$userData
 library(sf)
 tOut <- st_read(""./TileOutline.gpkg"")
+tOut2 <- st_read(""./RCB_Outline.gpkg"")
+tOut <- st_union(tOut,tOut2)
 portfolio_results <- reactiveValues(data = NULL)
 source(""./server/generate.R"", local = TRUE)
 source(""./server/points.R"", local = TRUE)

---FILE: app/index_files/ionRangeSlider-2.3.1/font.css---
@@ -0,0 +1,42 @@
+@font-face {
+  font-family: 'Open Sans';
+  font-style: italic;
+  font-weight: 300;
+  font-display: swap;
+  src: url(fonts/memnYaGs126MiZpBA-UFUKWyV-hv.woff) format('woff');
+}
+@font-face {
+  font-family: 'Open Sans';
+  font-style: italic;
+  font-weight: 400;
+  font-display: swap;
+  src: url(fonts/mem6YaGs126MiZpBA-UFUJ0d.woff) format('woff');
+}
+@font-face {
+  font-family: 'Open Sans';
+  font-style: italic;
+  font-weight: 700;
+  font-display: swap;
+  src: url(fonts/memnYaGs126MiZpBA-UFUKWiUOhv.woff) format('woff');
+}
+@font-face {
+  font-family: 'Open Sans';
+  font-style: normal;
+  font-weight: 300;
+  font-display: swap;
+  src: url(fonts/mem5YaGs126MiZpBA-UN_r8-Vg.woff) format('woff');
+}
+@font-face {
+  font-family: 'Open Sans';
+  font-style: normal;
+  font-weight: 400;
+  font-display: swap;
+  src: url(fonts/mem8YaGs126MiZpBA-U1UQ.woff) format('woff');
+}
+@font-face {
+  font-family: 'Open Sans';
+  font-style: normal;
+  font-weight: 700;
+  font-display: swap;
+  src: url(fonts/mem5YaGs126MiZpBA-UN7rg-Vg.woff) format('woff');
+}

---FILE: app/index_files/ionRangeSlider-2.3.1/ionRangeSlider.css---
@@ -0,0 +1,263 @@
+@charset ""UTF-8"";
+/* 'shiny' skin for Ion.RangeSlider, largely based on the 'big' skin, but with smaller dimensions, grayscale grid text, and without gradients
+ RStudio, Inc, 2014
+ Denis Ineshin, 2014  https://github.com/IonDen
+ guybowden, 2014  https://github.com/guybowden
+*/
+.irs {
+  position: relative;
+  display: block;
+  -webkit-touch-callout: none;
+  -webkit-user-select: none;
+  -khtml-user-select: none;
+  -moz-user-select: none;
+  -ms-user-select: none;
+  user-select: none;
+  font-size: 12px;
+  font-family: Arial, sans-serif;
+}
+
+.irs-line {
+  position: relative;
+  display: block;
+  overflow: hidden;
+  outline: none !important;
+}
+
+.irs-bar {
+  position: absolute;
+  display: block;
+  left: 0;
+  width: 0;
+}
+
+.irs-shadow {
+  position: absolute;
+  display: none;
+  left: 0;
+  width: 0;
+}
+
+.irs-handle {
+  position: absolute;
+  display: block;
+  box-sizing: border-box;
+  cursor: pointer;
+  z-index: 1;
+}
+
+.irs-handle.type_last {
+  z-index: 2;
+}
+
+.irs-min, .irs-max {
+  position: absolute;
+  display: block;
+  cursor: default;
+}
+
+.irs-min {
+  left: 0;
+}
+
+.irs-max {
+  right: 0;
+}
+
+.irs-from, .irs-to, .irs-single {
+  position: absolute;
+  display: block;
+  top: 0;
+  left: 0;
+  cursor: default;
+  white-space: nowrap;
+}
+
+.irs-grid {
+  position: absolute;
+  display: none;
+  bottom: 0;
+  left: 0;
+  width: 100%;
+  height: 20px;
+}
+
+.irs-with-grid .irs-grid {
+  display: block;
+}
+
+.irs-grid-pol {
+  position: absolute;
+  top: 0;
+  left: 0;
+  width: 1px;
+  height: 8px;
+  background: #000;
+}
+
+.irs-grid-pol.small {
+  height: 4px;
+}
+
+.irs-grid-text {
+  position: absolute;
+  bottom: 0;
+  left: 0;
+  white-space: nowrap;
+  text-align: center;
+  font-size: 9px;
+  line-height: 9px;
+  padding: 0 3px;
+  color: #000;
+}
+
+.irs-disable-mask {
+  position: absolute;
+  display: block;
+  top: 0;
+  left: -1%;
+  width: 102%;
+  height: 100%;
+  cursor: default;
+  background: rgba(0, 0, 0, 0);
+  z-index: 2;
+}
+
+.lt-ie9 .irs-disable-mask {
+  background: #000;
+  filter: alpha(opacity=0);
+  cursor: not-allowed;
+}
+
+.irs-disabled {
+  opacity: 0.4;
+}
+
+.irs-hidden-input {
+  position: absolute !important;
+  display: block !important;
+  top: 0 !important;
+  left: 0 !important;
+  width: 0 !important;
+  height: 0 !important;
+  font-size: 0 !important;
+  line-height: 0 !important;
+  padding: 0 !important;
+  margin: 0 !important;
+  overflow: hidden;
+  outline: none !important;
+  z-index: -9999 !important;
+  background: none !important;
+  border-style: solid !important;
+  border-color: transparent !important;
+}
+
+.irs {
+  font-family: ""Open Sans"", -apple-system, BlinkMacSystemFont, ""Segoe UI"", Roboto, ""Helvetica Neue"", Arial, sans-serif, ""Apple Color Emoji"", ""Segoe UI Emoji"", ""Segoe UI Symbol"";
+}
+
+.irs--shiny {
+  height: 40px;
+}
+
+.irs--shiny.irs-with-grid {
+  height: 60px;
+}
+
+.irs--shiny .irs-line {
+  top: 25px;
+  height: 8px;
+  background: linear-gradient(to bottom, #e7e8e9 -50%, #fff 150%);
+  background-color: #f2f3f3;
+  border: 1px solid #dbdcdd;
+  border-radius: 8px;
+}
+
+.irs--shiny .irs-bar {
+  top: 25px;
+  height: 8px;
+  border-top: 1px solid #003366;
+  border-bottom: 1px solid #003366;
+  background: #003366;
+}
+
+.irs--shiny .irs-bar--single {
+  border-radius: 8px 0 0 8px;
+}
+
+.irs--shiny .irs-shadow {
+  top: 38px;
+  height: 2px;
+  background: rgba(73, 80, 87, 0.3);
+  border-radius: 5px;
+}
+
+.irs--shiny .lt-ie9 .irs-shadow {
+  filter: alpha(opacity=30);
+}
+
+.irs--shiny .irs-handle {
+  top: 17px;
+  width: 22px;
+  height: 22px;
+  border: 1px solid #c3c5c8;
+  background-color: #e7e8e9;
+  box-shadow: 1px 1px 3px rgba(255, 255, 255, 0.3);
+  border-radius: 22px;
+}
+
+.irs--shiny .irs-handle.state_hover, .irs--shiny .irs-handle:hover {
+  background: #fff;
+}
+
+.irs--shiny .irs-min,
+.irs--shiny .irs-max {
+  top: 0;
+  padding: 1px 3px;
+  color: #6d7379;
+  text-shadow: none;
+  background-color: rgba(73, 80, 87, 0.1);
+  border-radius: 3px;
+  font-size: 10px;
+  line-height: 1.333;
+}
+
+.irs--shiny .lt-ie9 .irs-min,
+.irs--shiny .lt-ie9 .irs-max {
+  background: #dbdcdd;
+}
+
+.irs--shiny .irs-from,
+.irs--shiny .irs-to,
+.irs--shiny .irs-single {
+  color: #fff;
+  text-shadow: none;
+  padding: 1px 3px;
+  background-color: #003366;
+  border-radius: 3px;
+  font-size: 11px;
+  line-height: 1.333;
+}
+
+.irs--shiny .lt-ie9 .irs-from,
+.irs--shiny .lt-ie9 .irs-to,
+.irs--shiny .lt-ie9 .irs-single {
+  background: #b6b9bc;
+}
+
+.irs--shiny .irs-grid {
+  height: 27px;
+}
+
+.irs--shiny .irs-grid-pol {
+  background-color: #495057;
+}
+
+.irs--shiny .irs-grid-text {
+  bottom: 5px;
+  color: #5b6268;
+}
+
+.irs--shiny .irs-grid-pol.small {
+  background-color: #b6b9bc;
+}

---FILE: app/server/generate.R---
@@ -131,7 +131,7 @@ bgc <- function(con, siteno, avg, rcp) {
   })
 }
 
-# bgc <- dbGetCCISS(pool,siteno = c(6671461,6669161,6653961),avg = F, scn = ""ssp370"")
+##bgc <- dbGetCCISS(pool,siteno = c(4532735,4546791,4548548),avg = T, scn = ""ssp370"")
 # bgc <- sqlTest(pool,siteno = c(6476259,6477778,6691980,6699297),avg = T, scn = ""ssp370"")
 
 "
bcgov,CCISS_ShinyApp,676587802df09ee78e54f047d3d2a70ce49c7bc4,Kiri Daust,kiridaust@gmail.com,2021-08-03T19:15:33Z,Kiri Daust,kiridaust@gmail.com,2021-08-03T19:15:33Z,Fixed formatting,app/index.Rmd;app/server/generate_portfolio.R,True,False,True,False,19,5,24,"---FILE: app/index.Rmd---
@@ -225,7 +225,7 @@ BGC Futures: ratio of future models predicting BGC
 plotly::plotlyOutput(""bgc_fut_plot"", width = ""100%"", height = ""auto"")
 ```
 
-SPECIES PORTFOLIO
+SPECIES PORTFOLIO {data-orientation=columns}
 =====================================
 
 Inputs {.sidebar data-width=300}
@@ -259,6 +259,7 @@ sliderInput(""min_accept"",""Minimum allowed weight:"",min = 0.01,max = 0.2,value =
 sliderInput(""prob_pest"",""Probability of Pest Outbreak:"", min = 0, max = 0.1, value = 0.02)
 actionButton(""generate_portfolio"", label = ""Run Portfolio"", icon = icon(""plus-square""),
              style = ""width:100%; background-color:#003366; color: #FFF"")
+sliderInput(""sim_group"", ""Select Simulation to Plot: "", min = 1, max = 25, value = 1, step = 1)
 ```
 
 
@@ -271,13 +272,25 @@ Row
 plotOutput(""efficient_frontier"", width = ""100%"", height = ""auto"")
 ```
 
+### Growth Simulations
+
+```{r}
+plotOutput(""growth_sim"",  width = ""100%"", height = ""auto"")
+```
+
+Row
+-------------------------------------
+
 ### Optimised Weights
 
 ```{r}
-actionButton(""show_sssum"",label = ""Show Site Index and Feasibility"")
 tableOutput(""port_table"")
-sliderInput(""sim_group"", ""Select Simulation: "", min = 1, max = 25, value = 1, step = 1)
-plotOutput(""growth_sim"")
+```
+
+### Site Index and Feasibility
+
+```{r}
+DTOutput(""port_sssum"")
 ```
 
 EXPORT

---FILE: app/server/generate_portfolio.R---
@@ -114,7 +114,8 @@ output$growth_sim <- renderPlot({
   dat <- dat[It == input$sim_group,]
   ggplot(dat, aes(x = Year, y = Returns, color = Spp)) +
     geom_line() +
-    theme_few()
+    theme_few() + 
+    expand_limits(y = 0)
 })
 
 output$port_table <- renderTable({"
bcgov,CCISS_ShinyApp,eb36053633facc614fb8ce4a2b19926e6d02f413,Kiri Daust,kiridaust@gmail.com,2021-07-23T23:50:21Z,Kiri Daust,kiridaust@gmail.com,2021-07-23T23:50:21Z,Fixed portfolio,R/portfolio_fns.R;app/index.Rmd;app/server/generate.R;app/server/generate_portfolio.R,True,True,True,False,79,70,149,"---FILE: R/portfolio_fns.R---
@@ -71,7 +71,7 @@ edatopicSubset <- function(SSPredOrig, eda, pos = ""Zonal""){
     SSPredFull <- SSPredOrig[grep(""01"",SSPredOrig$SS_NoSpace),]
   }else{
     edaSub <- eda[Edatopic == pos,]
-    SSPredFull <- SSPredOrig[SS_NoSpace %in% edaSub$SS.pred,]
+    SSPredFull <- SSPredOrig[SS_NoSpace %in% edaSub$SS_NoSpace,]
   }
   SSPredFull[,BGC_analysis := gsub(""/.*"","""", SS_NoSpace)]
   SSPredFull <- SSPredFull[,c(""MergedBGC"", ""SS.pred"", ""SSprob"", ""SS_NoSpace"", 
@@ -163,7 +163,8 @@ dbGetSppLimits <- function(con,SuitTable,Trees){
 #' @export
 
 run_portfolio <- function(SiteList,climVar,SSPredAll,SIBEC,SuitTable,Trees,
-                          TimePeriods,selectBGC,SuitProb,returnValue,sppLimits,minAccept,boundDat){
+                          TimePeriods,selectBGC,SuitProb,returnValue,sppLimits,
+                          minAccept,boundDat,ProbPest){
   nSpp <- length(Trees)
   treeList <- Trees
   allSitesSpp <- foreach(SNum = SiteList, .combine = rbind) %do% {
@@ -204,7 +205,7 @@ run_portfolio <- function(SiteList,climVar,SSPredAll,SIBEC,SuitTable,Trees,
                                annualDat <- data.table(""Growth"" = s[[""y""]], ""MeanDead"" = p[[""y""]], ""NoMort"" = m[[""y""]], ""Suit"" = r[[""y""]]) ##create working data
                                annualDat <- cbind(simResults,annualDat)
                                limits <- sppLimits[Spp == treeList[k],]
-                               Returns <- SimGrowth(DF = annualDat,ProbPest = 0.005,
+                               Returns <- SimGrowth(DF = annualDat,ProbPest = ProbPest,
                                                        cmdMin = limits[[1]],cmdMax = limits[[2]],
                                                        tempMin = limits[[3]],tempMax = limits[[4]],climLoss = 0.08)
                                tmpR <- c(0,Returns)

---FILE: app/index.Rmd---
@@ -39,6 +39,17 @@ pool <- dbPool(
 onStop(function() {
   poolClose(pool)
 })
+poolclim <- dbPool(
+    drv = RPostgres::Postgres(),
+    dbname = ""bgc_climate_data"",
+    host = Sys.getenv(""BCGOV_HOST""),
+    port = 5432, 
+    user = Sys.getenv(""BCGOV_USR""),
+    password = Sys.getenv(""BCGOV_PWD"")
+  )
+  onStop(function() {
+    poolClose(poolclim)
+  })
 bcgov_tileserver <- Sys.getenv(""BCGOV_TILESERVER"")
 bcgov_tilelayer <- Sys.getenv(""BCGOV_TILELAYER"")
 if (is.null(bcgov_tileserver) || is.null(bcgov_tilelayer)) stop(""tileserver env not set"")
@@ -221,19 +232,21 @@ Inputs {.sidebar data-width=230}
 ###### Data Options
 
 ```{r}
+selectInput(""port_bgc"",label = ""Select BGC:"", choices = character())
+radioButtons(""port_ss"",label = ""Select Site Postion:"",choices = c(""B2"",""Zonal"",""D6""), selected = ""Zonal"")
 treeOpts <- c(""Py"",""Fd"",""At"",""Pl"",""Sx"",""Bl"",""Cw"",""Hw"",""Pw"",""Ss"",""Lw"",""Ba"",""Hm"",""Dr"",""Mb"")
 selectInput(""tree_species"",label = ""Included Species:"", choices = treeOpts, selected = treeOpts, multiple = T)
 selectInput(""time_periods"",label = ""Time Periods:"", 
             choices = c(""1961-1990"" = 1961,""1991-2020"" = 1991, ""2021-2040"" = 2021,
                         ""2041-2060"" = 2041,""2061-2080"" = 2061,""2081-2100"" = 2081),
             selected = c(1961,1991,2021,2041,2061), multiple = T)
-radioButtons(
-    ""fut_scn"",
-    ""RCP Scenario:"",
-    selected = ""ssp370"",
-    c(""2.6 W/m2"" = ""ssp126"", ""4.5 W/m2"" = ""ssp245"", ""7.0 W/m2"" = ""ssp370"", ""8.5 W/m2"" = ""ssp585""),
-    
-  )
+# radioButtons(
+#     ""fut_scn"",
+#     ""RCP Scenario:"",
+#     selected = ""ssp370"",
+#     c(""2.6 W/m2"" = ""ssp126"", ""4.5 W/m2"" = ""ssp245"", ""7.0 W/m2"" = ""ssp370"", ""8.5 W/m2"" = ""ssp585""),
+#     
+#   )
 ```
 
 ###### Portfolio Parameters
@@ -342,7 +355,7 @@ tags$script(HTML('
 uData <- session$userData
 library(sf)
 tOut <- st_read(""./TileOutline.gpkg"")
-portFlag <- reactiveVal()
+portfolio_results <- reactiveValues(data = NULL)
 source(""./server/generate.R"", local = TRUE)
 source(""./server/points.R"", local = TRUE)
 source(""./server/map.R"", local = TRUE)

---FILE: app/server/generate.R---
@@ -30,6 +30,7 @@ observeEvent(input$generate_results, priority = 100, {
   tic(""Determine UI choices"", ticker)
   siterefs        <- uData$siterefs        <- sort(unique(bgc$SiteRef))
   ss_opts <- sort(unique(uData$sspreds$SS_NoSpace))
+  bgc_opts <- unique(uData$bgc$BGC)
   
   ssl <- lapply(siterefs, function(sr) {
     ss <- sort(unique(cciss_results[SiteRef %in% sr]$SS_NoSpace))
@@ -69,6 +70,7 @@ observeEvent(input$generate_results, priority = 100, {
   updateSelectInput(inputId = ""siteref_silv"", choices = siterefs, selected = siteref)
   updateSelectInput(inputId = ""site_series_feas"", choices = siteseries, selected = head(siteseries, 1))
   updateSelectInput(inputId = ""site_series_silv"", choices = siteseries, selected = head(siteseries, 1))
+  updateSelectInput(inputId = ""port_bgc"", choices = bgc_opts, select = bgc_opts[1])
   updateCheckboxGroupInput(inputId = ""report_filter"",choices = siteseries_all, selected = siteseries_all)
   
   # Use UI injected javascript to show download button and hide generate button

---FILE: app/server/generate_portfolio.R---
@@ -17,75 +17,68 @@ observeEvent(input$generate_portfolio,{
   Trees <- treeList <- input$tree_species
   minAccept <- input$min_accept
   ProbPest <- input$prob_pest
-  FutScn <- input$fut_scn
+  BGC <- input$port_bgc
+  siteLoc <- input$port_ss
+  FutScn <- ""ssp245""
   #EdaPos <- input$eda_pos
   SiteList <- uData$pts$Site
   ##setup climate_data connection
-  poolclim <- dbPool(
-    drv = RPostgres::Postgres(),
-    dbname = ""bgc_climate_data"",
-    host = Sys.getenv(""BCGOV_HOST""),
-    port = 5432, 
-    user = Sys.getenv(""BCGOV_USR""),
-    password = Sys.getenv(""BCGOV_PWD"")
-  )
-  onStop(function() {
-    poolClose(poolclim)
-  })
-  
-  #Trees <- treeList <- c(""Py"",""Fd"",""At"",""Pl"",""Sx"",""Bl"",""Cw"",""Hw"",""Pw"",""Ss"",""Lw"",""Ba"",""Hm"",""Dr"",""Mb"")
-  SuitProb <- data.frame(""Suit"" = c(1,2,3,4), ""ProbDead"" = c(0.1,0.5,1,4), ""NoMort"" = c(95,85,75,50))
-  boundDat <- data.table(Spp = Trees)
-  boundDat[,`:=`(minWt = 0, maxWt = 1)]
-  #timePeriods = c(1961,1991,2021,2041,2061)
-  #returnValue = 0.9
-  #FutScn <- ""ssp370""
-  #minAccept <- 0.01
-  SuitTable <- copy(S1)
-  setnames(SuitTable,old = ""Feasible"",new = ""Suitability"",skip_absent = T)
-  
-  # siteids <- c(6487982,6484391,6484900,6485410,6485920)
-  # bgcDat <- dbGetCCISS(pool,siteids,avg = F, scn = ""ssp370"")
-  # sspreds <- edatopicOverlap(bgcDat,Edatope = E1) ##reuse from uData$sspreds
-  # SSPredOrig <- sspreds
   
-  SSPredOrig <- copy(uData$eda_out) ##migtht need to think what happens if multiple scenarios selected
-  SSPredOrig[,allOverlap := NULL]
-  setnames(SSPredOrig, old = c(""BGC"",""SiteRef""), new = c(""MergedBGC"",""SiteNo""))
-  SSPredOrig <- SSPredOrig[,.(MergedBGC,SS_NoSpace,SSratio,SSprob,SS.pred,FuturePeriod,SiteNo)]
-  
-  SSPredFull <- edatopicSubset(SSPredOrig,eda,pos = ""Zonal"") ##this should be changeable
-  nSpp <- length(treeList)
-  Units <- unique(SSPredFull$BGC_analysis)
-  BGC = Units[1]
-  SSPredBGC <- SSPredFull[BGC_analysis == BGC,-(""BGC_analysis"")]
-  SSList <- unique(SSPredBGC$SS_NoSpace)
-  selectBGC = SSList[1] ##this is where we change it to allow multiple BGCs
-  SSPredAll <- SSPredBGC[SSPredBGC$SS_NoSpace == selectBGC,]
-  SiteList <- unique(SSPredAll$SiteNo)
-  SSPredAll <- SSPredAll[SiteNo %in% SiteList & !is.na(SSprob),]
-  
-  climVar <- dbGetClimSum(poolclim,BGC,FutScn)
-  sppLimits <- dbGetSppLimits(poolclim,SuitTable,Trees)
+  withProgress(message = ""Optimising..."", detail = ""Lots of calculations..."", {
+    #Trees <- treeList <- c(""Py"",""Fd"",""At"",""Pl"",""Sx"",""Bl"",""Cw"",""Hw"",""Pw"",""Ss"",""Lw"",""Ba"",""Hm"",""Dr"",""Mb"")
+    SuitProb <- data.frame(""Suit"" = c(1,2,3,4), ""ProbDead"" = c(0.1,0.5,1,4), ""NoMort"" = c(95,85,75,50))
+    boundDat <- data.table(Spp = Trees)
+    boundDat[,`:=`(minWt = 0, maxWt = 1)]
+    #timePeriods = c(1961,1991,2021,2041,2061)
+    #returnValue = 0.9
+    #FutScn <- ""ssp370""
+    #minAccept <- 0.01
+    SuitTable <- copy(S1)
+    setnames(SuitTable,old = ""Feasible"",new = ""Suitability"",skip_absent = T)
+    
+    # siteids <- c(6487982,6484391,6484900,6485410,6485920)
+    # bgcDat <- dbGetCCISS(pool,siteids,avg = F, scn = ""ssp370"")
+    # sspreds <- edatopicOverlap(bgcDat,Edatope = E1) ##reuse from uData$sspreds
+    # SSPredOrig <- sspreds
+    
+    SSPredOrig <- copy(uData$eda_out)
+    SSPredOrig[,allOverlap := NULL]
+    setnames(SSPredOrig, old = c(""BGC"",""SiteRef""), new = c(""MergedBGC"",""SiteNo""))
+    SSPredOrig <- SSPredOrig[,.(MergedBGC,SS_NoSpace,SSratio,SSprob,SS.pred,FuturePeriod,SiteNo)]
+    
+    SSPredFull <- edatopicSubset(SSPredOrig,E1,pos = siteLoc) ##this should be changeable
+    nSpp <- length(treeList)
+    Units <- unique(SSPredFull$BGC_analysis)
+    SSPredBGC <- SSPredFull[BGC_analysis == BGC,-(""BGC_analysis"")]
+    SSList <- unique(SSPredBGC$SS_NoSpace)
+    selectBGC = SSList[1] ##this is where we change it to allow multiple BGCs
+    SSPredAll <- SSPredBGC[SSPredBGC$SS_NoSpace == selectBGC,]
+    SiteList <- unique(SSPredAll$SiteNo)
+    SSPredAll <- SSPredAll[SiteNo %in% SiteList & !is.na(SSprob),]
+    
+    incProgress()
+    climVar <- dbGetClimSum(poolclim,BGC,FutScn)
+    sppLimits <- dbGetSppLimits(poolclim,SuitTable,Trees)
+    incProgress()
+    
+    SL <- SiteList
+    numTimes <- as.integer(10/length(SL))
+    SL <- rep(SL, each = numTimes)
+    port_results <- run_portfolio(SL,climVar,SSPredAll,SIBEC,SuitTable,
+                                  Trees,timePeriods,selectBGC,SuitProb,returnValue,
+                                  sppLimits,minAccept,boundDat,ProbPest)
+    incProgress(amount = 0.6)
+    print(""Done Portfolio"")
+    portfolio_results$data <- port_results
+  })
   
-  SL <- SiteList
-  numTimes <- as.integer(10/length(SL))
-  SL <- rep(SL, each = numTimes)
-  port_results <- run_portfolio(SL,climVar,SSPredAll,SIBEC,SuitTable,
-                                Trees,timePeriods,selectBGC,SuitProb,returnValue,sppLimits,minAccept,boundDat)
-  print(""Done Portfolio"")
-  uData$port_results <- port_results
-  portFlag(""Done Port"")
 })
 
 output$efficient_frontier <- renderPlot({
-  input$prob_pest
-  portFlag()
-  print(""Oof"")
-  if(is.null(uData$port_results)) return(NULL)
+  if(is.null(portfolio_results$data)) return(NULL)
   
   colScale <- makeColScale(input$tree_species)
-  dat <- copy(uData$port_results)
+  dat <- copy(portfolio_results$data)
   print(""About to Plot"")
   print(ef_plot(dat$raw,dat$summary,colScale))
 })"
bcgov,CCISS_ShinyApp,8283dc20a58405757e4d115864ba33a2a36e3549,Kiri Daust,kiridaust@gmail.com,2021-07-23T19:26:03Z,Kiri Daust,kiridaust@gmail.com,2021-07-23T19:26:03Z,Fixed BGC Avg,R/data_etl.R;app/index.Rmd;app/server/generate.R,True,True,True,False,20,7,27,"---FILE: R/data_etl.R---
@@ -203,6 +203,12 @@ dbGetCCISS <- function(con, siteno, avg, scn = c(""ssp126"",""ssp245"",""ssp370"",""ssp
     FROM cciss
     GROUP BY "", groupby, "", futureperiod, bgc, bgc_pred
   
+  ), curr_temp AS (
+    SELECT "", groupby, "" siteref,
+           COUNT(distinct siteno) n
+    FROM test_prob
+    WHERE siteno IN ("", paste(unique(siteno), collapse = "",""), "")
+    GROUP BY "", groupby, ""
   )
   
   SELECT cast(a.siteref as text) siteref,
@@ -216,14 +222,17 @@ dbGetCCISS <- function(con, siteno, avg, scn = c(""ssp126"",""ssp245"",""ssp370"",""ssp
    AND a.futureperiod = b.futureperiod
   
   UNION ALL
-  
-  SELECT cast(siteno as text) siteref,
+
+  SELECT cast("", groupby, "" as text) siteref,
           period as futureperiod,
           bgc,
           bgc_pred,
-          prob as bgc_prop
-  FROM test_prob
+          SUM(prob)/b.n bgc_prop
+  FROM test_prob a
+  JOIN curr_temp b
+    ON a."",groupby,"" = b.siteref
   WHERE siteno in ("", paste(unique(siteno), collapse = "",""), "")
+  GROUP BY "", groupby, "",period,b.n, bgc, bgc_pred
   "")
   
   dat <- setDT(RPostgres::dbGetQuery(con, cciss_sql))
@@ -232,3 +241,4 @@ dbGetCCISS <- function(con, siteno, avg, scn = c(""ssp126"",""ssp245"",""ssp370"",""ssp
   #print(dat)
   return(dat)
 }
+

---FILE: app/index.Rmd---
@@ -70,13 +70,14 @@ splitLayout(
   checkboxGroupInput(
     ""rcp_scenario"",
     ""RCP Scenario:"",
-    selected = ""ssp585"",
+    selected = c(""ssp126"",""ssp245"",""ssp370""),
     c(""2.6 W/m2"" = ""ssp126"", ""4.5 W/m2"" = ""ssp245"", ""7.0 W/m2"" = ""ssp370"", ""8.5 W/m2"" = ""ssp585"")
   ),
   radioButtons(
     ""aggregation"",
     ""Multiple Point Aggregation:"",
-    c(""Individual"" = ""FALSE"", ""Averaged by BGC Zone"" = ""TRUE"")
+    c(""Individual"" = ""FALSE"", ""Averaged by BGC Subzone"" = ""TRUE""),
+    selected = ""TRUE""
   )
 )
 

---FILE: app/server/generate.R---
@@ -118,7 +118,9 @@ bgc <- function(con, siteno, avg, rcp) {
   })
 }
 
-#bgc <- dbGetCCISS(pool,siteno = c(6665984),avg = F, scn = ""ssp370"")
+# bgc <- dbGetCCISS(pool,siteno = c(6476259,6477778,6691980,6699297),avg = F, scn = ""ssp370"")
+# bgc <- sqlTest(pool,siteno = c(6476259,6477778,6691980,6699297),avg = T, scn = ""ssp370"")
+
 
 cciss <- function(bgc) {
   SSPred <- edatopicOverlap(bgc, Edatope = E1)"
bcgov,CCISS_ShinyApp,e63656a18a640946650057e932c6eeaecaf7c21d,Bruno Tremblay,meztez@neoxone.com,2021-03-30T04:29:06Z,Bruno Tremblay,meztez@neoxone.com,2021-03-30T04:29:06Z,fix remaining style problem with stocking standards,app/server/silviculture.R,False,True,True,False,3,5,8,"---FILE: app/server/silviculture.R---
@@ -113,9 +113,8 @@ standardblock <- function(std, ss, sc) {
     tags$small(""Forest Region: "", tags$b(si$Region, .noWS = c(""before"", ""after"")), .noWS = ""inside""),
     tags$table(width = ""100%"", style = ""white-space: nowrap;"",
       # Report formatting gray out the first row, so faking a row
-      tags$tr(height = 0),         
       tags$tr(
-        tags$td(width = ""50%"", style = ""vertical-align: top; padding:0;"",
+        tags$td(width = ""50%"", style = ""vertical-align: top; padding:0; background-color:white; border:none"",
           tags$small(tags$b(""Regeneration"")),
           tags$hr(style = ""padding: 0; margin: 0 0 3px 0; height: 2px; background-color: darkgreen; border: 0px""),
           tags$table(
@@ -152,7 +151,7 @@ standardblock <- function(std, ss, sc) {
             )
           )
         ),
-        tags$td(width = ""50%"", style = ""vertical-align: top; padding:0px 0px 0px 8px;"",
+        tags$td(width = ""50%"", style = ""vertical-align: top; padding:0px 0px 0px 8px; background-color:white; border:none"",
           tags$small(tags$b(""Stocking (i) - well spaced/ha"")),
           tags$hr(style = ""padding: 0; margin: 0 0 3px 0; height: 2px; background-color: darkgreen; border: 0px""),
           tags$table(
@@ -190,9 +189,8 @@ standardblock <- function(std, ss, sc) {
           )
         )
       ),
-      tags$tr(height = 0),
       tags$tr(
-        tags$td(colspan = ""2"", style = ""white-space:normal;"",
+        tags$td(colspan = ""2"", style = ""white-space:normal; vertical-align: top; padding:0; background-color:white; border:none"",
           tags$small(tags$b(""Footnotes"")),
           tags$hr(style = ""padding: 0; margin: 0 0 3px 0; height: 2px; background-color: #003366; border: 0px""),
           {"
bcgov,CCISS_ShinyApp,515f776e8a6f566ba8590e2bd6c58a8638b47e2d,Bruno Tremblay,meztez@neoxone.com,2021-03-30T04:08:55Z,Bruno Tremblay,meztez@neoxone.com,2021-03-30T04:08:55Z,fix sysreq name,DESCRIPTION,False,False,False,False,1,1,2,"---FILE: DESCRIPTION---
@@ -39,4 +39,4 @@ LinkingTo: Rcpp
 LazyData: true
 Roxygen: list(markdown = TRUE)
 RoxygenNote: 7.1.1
-SystemRequirements: chromium
+SystemRequirements: chromium-browser"
bcgov,CCISS_ShinyApp,593a24ed134e679ac3584b17b23bce1a3e025226,Bruno Tremblay,meztez@neoxone.com,2021-03-30T04:08:11Z,Bruno Tremblay,meztez@neoxone.com,2021-03-30T04:08:11Z,"Add pdf report as described, fix bug with dcast when some columns are not produced, add pagedown dep, fix styling bugs, refresh shiny debug",DESCRIPTION;R/feasibility.R;app/server/download.R;app/server/futures.R;app/server/generate.R;app/server/reporthtml.Rmd;app/server/reportpdf.Rmd;app/server/silviculture.R;data-raw/scripts/bigshinygisstudio.R;data-raw/scripts/debug_shiny.R,True,True,True,False,314,52,366,"---FILE: DESCRIPTION---
@@ -23,7 +23,8 @@ Imports:
     flexdashboard (>= 0.5.2.90),
     plotly,
     pool,
-    prettydoc
+    prettydoc,
+    pagedown
 Suggests:
     bcdata,
     bcmaps,
@@ -38,3 +39,4 @@ LinkingTo: Rcpp
 LazyData: true
 Roxygen: list(markdown = TRUE)
 RoxygenNote: 7.1.1
+SystemRequirements: chromium

---FILE: R/feasibility.R---
@@ -43,6 +43,8 @@ ccissOutput <- function(SSPred,suit,rules,feasFlag){
   setnames(suitMerge, old = c(""SS_NoSpace"", ""i.SS_NoSpace""), new = c(""SS.pred"", ""SS_NoSpace""))
   suitVotes <- data.table::dcast(suitMerge, SiteRef + Spp + FuturePeriod + SS_NoSpace ~ Feasible, 
                                  value.var = ""SSprob"", fun.aggregate = sum)
+  # Fill with 0 if columns does not exist, encountered the error at SiteRef 3104856 
+  set(suitVotes, j = as.character(1:5)[!as.character(1:5) %in% names(suitVotes)], value = 0)
   suitVotes[,VoteSum := `1`+`2`+`3`+`4`+`5`]
   suitVotes[,X := 1 - VoteSum]
   suitVotes[,VoteSum := NULL]

---FILE: app/server/download.R---
@@ -35,18 +35,37 @@ output$report_download <- downloadHandler(
       # can happen when deployed).
       tempReport <- file.path(tempdir(), reportmd)
       file.copy(file.path(""./server"", reportmd), tempReport, overwrite = TRUE)
-      file.copy(""./server/www"", tempReport, recursive = TRUE, overwrite = TRUE)
       # Set up parameters to pass to Rmd document
       
       params <- list(userdata = uData)
       
       # Knit the document, passing in the `params` list, and eval it in a
       # child of the global environment (this isolates the code in the document
       # from the code in this app).
-      rmarkdown::render(tempReport, output_file = file,
-                        params = params,
-                        envir = new.env(parent = globalenv())
-      )
+      if (input$report_format == ""html"") {
+        rmarkdown::render(tempReport, output_file = file,
+                          params = params,
+                          envir = new.env(parent = globalenv())
+        )
+      } else if (input$report_format == ""pdf"") {
+        has_chrome <- tryCatch({
+          pagedown::find_chrome()
+          TRUE
+        }, error = function(e) {FALSE})
+        if (has_chrome) {
+          htmlreport <- rmarkdown::render(
+            tempReport, params = params, envir = new.env(parent = globalenv()))
+          pagedown::chrome_print(input = htmlreport, output = file, timeout = 120)
+        } else {
+          showModal(
+            modalDialog(
+              title = ""PDF Rendering"",
+              paste(""Chromium could not be found on this host.""),
+              easyClose = TRUE
+            )
+          )
+        }
+      }
     })
   }
 )

---FILE: app/server/futures.R---
@@ -17,7 +17,7 @@ output$bgc_fut_plot <- plotly::renderPlotly({
 # Graph
 
 #' @param data BGC data.table
-bgc_fut_plotly <- function(data, siteref, period_map = uData$period_map) {
+bgc_fut_plotly <- function(data, siteref, period_map = uData$period_map, ...) {
   data <- data[SiteRef == siteref]
   l <- list(
     font = list(
@@ -27,7 +27,7 @@ bgc_fut_plotly <- function(data, siteref, period_map = uData$period_map) {
     bordercolor = ""#FFFFFF"",
     borderwidth = 2,
     orientation = 'h',
-    y = 1.1,
+    y = 1.25,
     x = -0.05)
   color_ref <- {
     colors <- subzones_colours_ref[unique(data$BGC.pred)]
@@ -39,7 +39,7 @@ bgc_fut_plotly <- function(data, siteref, period_map = uData$period_map) {
                   y = ~BGC.prop, split = ~BGC.pred, type = 'bar',
                   color = ~BGC.pred, colors = color_ref,
                   text = ~BGC.pred, textposition = 'inside', textfont = list(color = ""black"", size = 20),
-                  texttemplate = ""%{text}"", hovertemplate = ""%{y}"") %>%
+                  texttemplate = ""%{text}"", hovertemplate = ""%{y}"", ...) %>%
     plotly::layout(yaxis = list(title = """", tickformat = "".1%""),
                    xaxis = list(showspikes = FALSE, title = list(text = ""Period""),
                                 ticktext = unname(period_map),

---FILE: app/server/generate.R---
@@ -1,5 +1,5 @@
 observeEvent(input$generate_results, priority = 100, {
-  
+
   ticker <- tic(""Save Map Inputs"")
   # On generate click, we are taking a snapshot of the current points
   # and calculating results. All relevant results will be stored in the
@@ -161,6 +161,15 @@ cciss_results <- function(cciss, pts, avg, SS = bccciss::stocking_standards, per
     # dcast (pivot)
     results <- dcast(results, SiteRef + SS_NoSpace + Spp ~ FuturePeriod,
                      value.var = c(""Curr"", ""NewSuit"", ""1"", ""2"", ""3"", ""X"", ""ModAgree"", ""SuitDiff""))
+    # Required columns, set them if not created by dcast (safety)
+    reqj <- c(
+      ""1_1975"",""2_1975"",""3_1975"",""X_1975"", ""NewSuit_1975"",
+      ""1_2000"",""2_2000"",""3_2000"",""X_2000"", ""NewSuit_2000"",
+      ""1_2025"",""2_2025"",""3_2025"",""X_2025"", ""NewSuit_2025"",
+      ""1_2055"",""2_2055"",""3_2055"",""X_2055"", ""NewSuit_2055"",
+      ""1_2085"",""2_2085"",""3_2085"",""X_2085"", ""NewSuit_2085""
+    )
+    set(results, j = reqj[!reqj %in% names(results)], value = NA_real_)
     setnafill(results, fill = 0, cols = c(
       ""1_1975"",""2_1975"",""3_1975"",""X_1975"",
       ""1_2000"",""2_2000"",""3_2000"",""X_2000"",
@@ -235,6 +244,7 @@ feasibility_svg <- function(..., width = 220L, height = 14L, colors = c(""limegre
     '</svg>'
   )]
 }
+uData$feasibility_svg <- feasibility_svg
 
 pfsvg <- function(x, pos_x, width_el, pos_text, height, color) {
   # Format svg text
@@ -250,6 +260,7 @@ pfsvg <- function(x, pos_x, width_el, pos_text, height, color) {
   )
   svgs
 }
+uData$pfsvg <- pfsvg
 
 # Replace trend image with svg so they can be embedded
 swap_up_down <- '<svg xmlns=""http://www.w3.org/2000/svg"" width=""30px"" height=""30px"" viewBox=""0 0 512 512""><polyline points=""464 208 352 96 240 208"" style=""fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px""/><line x1=""352"" y1=""113.13"" x2=""352"" y2=""416"" style=""fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px""/><polyline points=""48 304 160 416 272 304"" style=""fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px""/><line x1=""160"" y1=""398"" x2=""160"" y2=""96"" style=""fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px""/></svg>'

---FILE: app/server/reporthtml.Rmd---
@@ -7,7 +7,6 @@ output:
     mode: selfcontained
 params:
   userdata: NA
-classoption: landscape
 ---
 
 ```{r setup, include=FALSE}
@@ -67,7 +66,7 @@ tags$h2(""2. REPORT OPTIONS"")
 
 ```{r parameters, results='asis'}
 p <- data.table(""Parameters"" = c(""Representative Concentration Pathways"", ""Number of Points Considered"", ""Averaged?"", ""Date"", ""Time""), ""User Selections"" = c(paste(rcp, collapse = "" and ""), nrow(pts), avg, format(Sys.Date(), ""%Y/%m/%d""), format(Sys.time(), ""%H:%M"", usetz = TRUE)))
-knitr::kable(p, row.names = FALSE, escape = FALSE, table.attr = ""class=\""table-centered\"""", format = ""html"")
+knitr::kable(p, row.names = FALSE, escape = FALSE, table.attr = ""class=\""table table-hover table-centered\"""", format = ""html"")
 ```
 
 ```{r section3, results='asis'}
@@ -158,7 +157,7 @@ tags$h2(""7. DATA POINT GEOREFERENCING"")
 ```
 
 ```{r points, results='asis', out.width=""100%""}
-knitr::kable(pts[,list(ID, Site, Latitude = Lat, Longitude = Long, Elevation = Elev, BGC)], table.attr = ""class=\""centered\"""", format = ""html"")
+knitr::kable(pts[,list(ID, Site, Latitude = Lat, Longitude = Long, Elevation = Elev, BGC)], table.attr = ""class=\""table table-hover table-centered\"""", format = ""html"")
 ```
 
 ```{r appendix, results='asis'}

---FILE: app/server/reportpdf.Rmd---
@@ -0,0 +1,178 @@
+---
+title: CCISS REPORT 
+output:
+  prettydoc::html_pretty:
+    theme: cayman
+    self_contained: yes
+    mode: selfcontained
+params:
+  userdata: NA
+---
+
+```{r setup, include=FALSE}
+suppressPackageStartupMessages({
+  library(bccciss)
+  library(leaflet)
+  library(plotly)
+  library(knitr)
+  library(htmltools)
+})
+opts_chunk$set(echo = FALSE, eval = TRUE, include = TRUE, message = FALSE, warning = FALSE)
+
+# Debug mode
+# userdata <- readRDS(""../../cciss_export.rds"")
+# for (nm in names(userdata)) {assign(nm, userdata[[nm]])}
+
+# Deployment mode
+# assign in current environment
+for (nm in names(params$userdata)) {assign(nm, params$userdata[[nm]])}
+
+# Env variable for map
+bcgov_tileserver <- Sys.getenv(""BCGOV_TILESERVER"")
+bcgov_tilelayer <- Sys.getenv(""BCGOV_TILELAYER"")
+mbtk <- Sys.getenv(""BCGOV_MAPBOX_TOKEN"")
+mblbstyle <- Sys.getenv(""BCGOV_MAPBOX_LABELS_STYLE"")
+
+# Map Creation
+domap <- function(mappts) {
+  
+  mappts <- mappts[!is.na(Long) & !is.na(Lat)]
+  
+  leaflet::leaflet(height = ""220px"") %>%
+  leaflet::addProviderTiles(leaflet::providers$CartoDB.PositronNoLabels, group = ""Positron"") %>%
+  addVectorGridTilesDev(app = FALSE) %>% leaflet::hideGroup(""Zones"") %>%
+  leaflet::addTiles(
+    urlTemplate = paste0(""https://api.mapbox.com/styles/v1/"", mblbstyle, ""/tiles/{z}/{x}/{y}?access_token="", mbtk),
+    attribution = '&#169; <a href=""https://www.mapbox.com/feedback/"">Mapbox</a>',
+    options = leaflet::tileOptions(zIndex = 600)) %>%
+  leaflet::addMarkers(data = mappts, lng = ~Long, lat = ~Lat)
+  
+}
+
+# Define the reference for points lookup
+pts_ref <- pts[[{if (avg) {""BGC""} else {""Site""}}]]
+
+# Selected options
+p <- data.table(""Parameters"" = c(""Representative<br />Concentration Pathways"", ""Number of Points<br />Considered"", ""Averaged?"", ""Date"", ""Time""), ""User Selections"" = c(paste(rcp, collapse = "" and ""), nrow(pts), avg, format(Sys.Date(), ""%Y/%m/%d""), format(Sys.time(), ""%H:%M"", usetz = TRUE)))
+opt_tb <- HTML(knitr::kable(p, row.names = FALSE, escape = FALSE, table.attr = ""class=\""table-centered\"""", format = ""html""))
+
+# Model information
+models_info_tb <- tags$div(style = ""display: flex"",
+  tags$div(style = ""flex: 0 0 46%"",
+    HTML(
+      knitr::kable(
+        models_info[seq_len(ceiling(nrow(models_info) / 2))],
+        format = ""html"",
+        table.attr = 'class=""table table-hover table-centered""')
+    )
+  ),
+  tags$div(style = ""flex: 0 0 46%"",
+    HTML(
+      knitr::kable(
+        models_info[-seq_len(ceiling(nrow(models_info) / 2))],
+        format = ""html"",
+        table.attr = 'class=""table table-hover table-centered""')
+    )
+  )
+)
+
+# Feasibility legend
+legend <- tags$span(
+  ""Legend: "",
+  htmltools::HTML(
+    paste0(
+      '<svg viewBox=""0 0 1 1"" height=""14px"" width=""14px""><rect height=1 width=1 style=""fill : ',
+      c(""limegreen"", ""deepskyblue"", ""gold"", ""grey""),
+      '"" /><span>&nbsp;',
+      c(""Primary"", ""Secondary"", ""Tertiary"", ""Not Suitable""),
+      '</span>',
+      collapse = ""&nbsp;&nbsp;&nbsp;""
+    )
+  )
+)
+
+# Recompute svg with smaller height
+cciss_results[, PredFeasSVG := paste0(
+        feasibility_svg(`1_1975`,`2_1975`,`3_1975`,`X_1975`, height = 11), ""<br />"",
+        feasibility_svg(`1_2000`,`2_2000`,`3_2000`,`X_2000`, height = 11), ""<br />"",
+        feasibility_svg(`1_2025`,`2_2025`,`3_2025`,`X_2025`, height = 11), ""<br />"",
+        feasibility_svg(`1_2055`,`2_2055`,`3_2055`,`X_2055`, height = 11), ""<br />"",
+        feasibility_svg(`1_2085`,`2_2085`,`3_2085`,`X_2085`, height = 11)
+      )
+]
+```
+
+<style type=""text/css"">
+  table, tbody, thead {line-height:1 !important}
+  .page-header {text-align:right !important}
+  h5, h6 {margin:1em 0 1em 0 !important; padding:0 !important}
+  .page-breaker-before {page-break-before: always}
+  .bordered {border-top:3px solid !important;}
+  .main-content {max-width: none !important; padding:0 !important}
+  .table {width: auto !important;}
+  .table tbody {white-space: nowrap;}
+  thead, tbody {font-size: 0.75em !important;}
+  .table td {vertical-align: middle !important;}
+  table.table-centered, .bgc_future {margin-left:auto !important; margin-right:auto !important}
+</style>
+
+```{r siteloop, results='asis'}
+htmltools::tagList(
+  lapply(names(siteseries_list), function(siteref) {
+    siteseries <- siteseries_list[[siteref]]
+    siteseries <- siteseries[siteseries %in% site_series_filter]
+    data_points <- pts[pts_ref %in% siteref]
+    htmltools::tagList(
+      tags$div(class = if (siteref != names(siteseries_list)[1]) {""page-breaker-before""} else {""""},
+               style = ""display: flex"",
+        tags$div(style = ""flex: 0 0 50%; padding-right: 1em"",
+          tags$h5(""SITE LOCATION "",
+                  tags$b(siteref, .noWS = c(""before"", ""after"")),
+                  if (avg) {"" AVERAGED""} else {""""}),
+          domap(data_points)
+        ),
+        tags$div(style = ""flex: 0 0 50%"",
+          tags$h5(""REPORT OPTIONS""),
+          opt_tb
+        )
+      ),
+      tags$h5(class = ""bordered"", ""PREDICTED BGC FUTURES""),
+      tags$div(class = ""bgc_future"",
+        bgc_fut_plotly(bgc, siteref, period_map, height = 350)
+      ),
+      tags$h5(""SITE GEOREFERENCING""),
+      HTML(
+        knitr::kable(
+          data_points[,list(ID, Site, Latitude = Lat, Longitude = Long, Elevation = Elev, BGC)],
+          format = ""html""
+        )
+      ),
+      tags$h5(""MODEL INFORMATION""),
+      models_info_tb,
+      mapply(FUN = function(siteserie, nm) {
+        htmltools::tagList(
+          tags$h5(class = ""page-breaker-before"",
+            ""SITE "",
+            tags$b(siteref, .noWS = c(""before"", ""after"")),
+            if (avg) {"" AVERAGED""} else {""""}, "" / "", 
+            ""SERIES "",
+            tags$b(siteserie, .noWS = c(""before"", ""after"")),
+            gsub(siteserie, """", nm), .noWS = ""inside""
+          ),
+          tags$h6(""CCISS TREE FEASIBILITY""),
+          legend,
+          HTML(cciss_results_dt(cciss_results, siteref, siteserie, filter = ""f"")),
+          tags$h6(""STOCKING STANDARDS""),
+          standardblocks(cciss_results, siteref, siteserie)
+        )
+      }, siteseries, names(siteseries))
+    )
+  })
+)
+```
+
+<!-- Logo -->
+```{r logo, results='asis'}
+htmltools::HTML('<svg style=""position:absolute; top:20px; left:20px;"" width=""168px"" height=""45px"" viewBox=""0 0 168 45"" fill=""none"" xmlns=""http://www.w3.org/2000/svg""><path d=""M9.67889 37.3287C20.2192 37.3287 34.7999 43.2635 45.3794 43.2635C52.9289 43.2635 60.2958 41.2487 64.4889 38.282C64.7817 36.5397 64.9369 34.751 64.9369 32.9255C64.9369 15.2105 50.5755 0.849609 32.8605 0.849609C15.1455 0.849609 0.784363 15.2105 0.784363 32.9255C0.784363 34.73 0.935741 36.4985 1.22223 38.2216C2.37831 38.0075 6.30919 37.3287 9.67889 37.3287Z"" fill=""white""/><path d=""M81.7877 43.6133H155.983V44.5128H81.7877V43.6133Z"" fill=""#E3A82B""/><path d=""M85.5411 18.8965C85.5411 19.6293 85.5861 20.667 86.0155 21.115C86.4449 21.5831 87.1228 21.6847 87.8004 21.6847C89.8108 21.6847 91.347 20.871 91.347 18.8356C91.347 17.2278 90.4434 15.3551 86.8516 15.3551C85.6316 15.3551 85.5411 15.4772 85.5411 15.8842V18.8965ZM85.5411 14.1745C85.5411 14.7449 85.5637 14.7852 86.7158 14.7449C89.0199 14.6631 90.2628 14.0524 90.2628 12.1394C90.2628 10.1448 88.6132 9.3917 86.8969 9.3917C86.3996 9.3917 86.0605 9.43249 85.8575 9.51384C85.6316 9.57491 85.5411 9.67701 85.5411 10.0427V14.1745ZM83.6887 11.4678C83.6887 9.96184 83.5823 9.56288 82.5658 9.48106L81.8587 9.43249C81.7436 9.341 81.7762 8.93308 81.8813 8.92365C83.1006 8.81495 84.6375 8.76096 86.7384 8.76096C88.1617 8.76096 89.5172 8.86258 90.5342 9.33063C91.5054 9.75812 92.251 10.5721 92.251 11.8746C92.251 13.3403 91.3019 14.0934 89.9466 14.6631C89.9466 14.8665 90.1274 14.9278 90.3757 14.9682C91.5957 15.1721 93.4028 16.1896 93.4028 18.3673C93.4028 20.7283 91.4604 22.3159 87.3934 22.3159C86.7384 22.3159 85.6316 22.2546 84.6825 22.2546C83.6887 22.2546 82.9207 22.2959 82.0846 22.3159C81.949 22.2546 81.9037 21.9292 82.0393 21.8068L82.4463 21.7458C83.6432 21.5625 83.6887 21.3388 83.6887 19.2018V11.4678Z"" fill=""white""/><path d=""M109.105 13.471C109.105 11.6283 109.066 11.3328 107.928 11.246L107.445 11.2111C107.329 11.1416 107.368 10.8284 107.484 10.7763C108.448 10.811 109.105 10.8284 109.915 10.8284C110.687 10.8284 111.343 10.811 112.308 10.7763C112.424 10.8284 112.462 11.1416 112.346 11.2111L111.864 11.246C110.725 11.3328 110.687 11.6283 110.687 13.471V19.6602C110.687 21.5027 110.725 21.7463 111.864 21.8682L112.346 21.9201C112.462 21.9896 112.424 22.3023 112.308 22.3546C111.343 22.3197 110.687 22.3023 109.915 22.3023C109.105 22.3023 108.448 22.3197 107.484 22.3546C107.368 22.3023 107.329 22.0243 107.445 21.9201L107.928 21.8682C109.066 21.7463 109.105 21.5027 109.105 19.6602V13.471Z"" fill=""white""/><path d=""M119.811 19.6964C119.811 21.5216 119.846 21.7824 120.896 21.8694L121.474 21.9215C121.582 21.9908 121.546 22.3035 121.438 22.3561C120.407 22.3212 119.793 22.3035 119.069 22.3035C118.346 22.3035 117.713 22.3212 116.556 22.3561C116.448 22.3035 116.411 22.0085 116.556 21.9215L117.207 21.8694C118.238 21.7824 118.328 21.5216 118.328 19.6964V11.9249C118.328 11.3861 118.328 11.3691 117.786 11.3691H116.791C116.014 11.3691 115.02 11.4038 114.567 11.8035C114.134 12.1859 113.953 12.5686 113.754 13.0029C113.609 13.1074 113.356 13.0204 113.284 12.8813C113.573 12.0992 113.844 10.9865 113.97 10.2911C114.025 10.2564 114.26 10.239 114.314 10.2911C114.423 10.8471 115.02 10.8299 115.851 10.8299H123.173C124.15 10.8299 124.312 10.7952 124.583 10.3432C124.674 10.3086 124.873 10.326 124.909 10.3951C124.71 11.1084 124.583 12.5163 124.638 13.0378C124.566 13.177 124.258 13.177 124.168 13.0727C124.114 12.6377 123.987 11.9947 123.716 11.8035C123.3 11.5076 122.613 11.3691 121.619 11.3691H120.335C119.793 11.3691 119.811 11.3861 119.811 11.9598V19.6964Z"" fill=""white""/><path d=""M127.559 13.471C127.559 11.6283 127.52 11.3328 126.382 11.246L125.899 11.2111C125.784 11.1416 125.822 10.8284 125.938 10.7763C126.903 10.811 127.559 10.8284 128.37 10.8284C129.141 10.8284 129.797 10.811 130.762 10.7763C130.878 10.8284 130.917 11.1416 130.801 11.2111L130.318 11.246C129.18 11.3328 129.141 11.6283 129.141 13.471V19.6602C129.141 21.5027 129.18 21.7463 130.318 21.8682L130.801 21.9201C130.917 21.9896 130.878 22.3023 130.762 22.3546C129.797 22.3197 129.141 22.3023 128.37 22.3023C127.559 22.3023 126.903 22.3197 125.938 22.3546C125.822 22.3023 125.784 22.0243 125.899 21.9201L126.382 21.8682C127.52 21.7463 127.559 21.5027 127.559 19.6602V13.471Z"" fill=""white""/><path d=""M136.208 22.5321C134.484 22.5321 133.397 22.08 133.008 21.8891C132.761 21.5064 132.494 20.2722 132.453 19.455C132.556 19.3333 132.864 19.2987 132.946 19.4029C133.254 20.2894 134.095 21.9928 136.474 21.9928C138.198 21.9928 139.039 21.0369 139.039 19.9938C139.039 19.2291 138.854 18.3772 137.356 17.5599L135.408 16.4819C134.382 15.9084 133.192 14.9174 133.192 13.492C133.192 11.8403 134.71 10.5017 137.377 10.5017C138.012 10.5017 138.751 10.606 139.285 10.7276C139.551 10.7972 139.838 10.8318 140.003 10.8318C140.187 11.2497 140.372 12.223 140.372 12.953C140.29 13.0575 139.961 13.1094 139.859 13.0051C139.592 12.1709 139.039 11.0408 137.069 11.0408C135.059 11.0408 134.628 12.1709 134.628 12.9702C134.628 13.9787 135.613 14.7092 136.372 15.1089L138.012 15.978C139.305 16.6559 140.577 17.6641 140.577 19.3159C140.577 21.2281 138.875 22.5321 136.208 22.5321Z"" fill=""white""/><path d=""M146.533 16.6872C145.635 16.6872 145.598 16.7218 145.598 17.2434V19.6949C145.598 21.5202 145.692 21.7637 146.739 21.8682L147.281 21.9201C147.394 21.9896 147.356 22.3021 147.244 22.3546C146.234 22.3197 145.598 22.3021 144.868 22.3021C144.064 22.3021 143.428 22.337 142.698 22.3546C142.586 22.3021 142.549 22.0243 142.661 21.9201L142.979 21.8682C144.027 21.6942 144.064 21.5202 144.064 19.6949V13.4363C144.064 11.6108 143.933 11.3156 142.96 11.246L142.474 11.2111C142.362 11.1416 142.399 10.8284 142.511 10.7763C143.428 10.7938 144.064 10.8284 144.868 10.8284C145.598 10.8284 146.234 10.811 147.038 10.7763C147.151 10.8284 147.188 11.1416 147.076 11.2111L146.72 11.246C145.635 11.3503 145.598 11.6108 145.598 13.4363V15.4353C145.598 15.9741 145.635 15.9918 146.533 15.9918H151.883C152.782 15.9918 152.819 15.9741 152.819 15.4353V13.4363C152.819 11.6108 152.782 11.3503 151.678 11.246L151.322 11.2111C151.21 11.1416 151.247 10.8284 151.36 10.7763C152.221 10.811 152.856 10.8284 153.623 10.8284C154.353 10.8284 154.989 10.811 155.831 10.7763C155.943 10.8284 155.98 11.1416 155.868 11.2111L155.476 11.246C154.391 11.3503 154.353 11.6108 154.353 13.4363V19.6949C154.353 21.5202 154.391 21.7463 155.476 21.8682L155.925 21.9201C156.037 21.9896 155.999 22.3021 155.887 22.3546C154.989 22.3197 154.353 22.3021 153.623 22.3021C152.856 22.3021 152.183 22.3197 151.36 22.3546C151.247 22.3021 151.21 22.0243 151.322 21.9201L151.678 21.8682C152.819 21.6942 152.819 21.5202 152.819 19.6949V17.2434C152.819 16.7218 152.782 16.6872 151.883 16.6872H146.533Z"" fill=""white""/><path d=""M72.9825 26.1757C74.5201 24.9795 76.4791 24.3919 78.6698 24.3919C79.807 24.3919 81.4076 24.6225 82.3979 24.8956C82.6507 24.9585 82.7981 25.0007 82.9876 24.9795C83.0086 25.4624 83.114 26.7842 83.2824 28.0648C83.1772 28.2117 82.8613 28.233 82.7139 28.107C82.3979 26.6798 81.45 25.0422 78.3958 25.0422C75.173 25.0422 72.4348 27.0785 72.4348 31.4232C72.4348 35.8309 75.2362 38.2659 78.6906 38.2659C81.4076 38.2659 82.6085 36.5026 83.0928 35.264C83.2404 35.1596 83.5566 35.2011 83.6405 35.3482C83.4934 36.4397 82.9454 37.8247 82.6295 38.2239C82.3767 38.2659 82.1242 38.3498 81.8924 38.4333C81.4288 38.6019 79.9124 38.9164 78.5642 38.9164C76.6687 38.9164 74.8573 38.5389 73.3195 37.5099C71.6343 36.3555 70.3285 34.4461 70.3285 31.7385C70.3285 29.4081 71.3817 27.4143 72.9825 26.1757Z"" fill=""white""/><path d=""M95.5106 33.3289C95.5106 30.4603 94.1783 27.3657 90.6917 27.3657C88.7933 27.3657 86.3293 28.6001 86.3293 32.4077C86.3293 34.9804 87.6434 38.3185 91.2392 38.3185C93.4299 38.3185 95.5106 36.7538 95.5106 33.3289ZM84.5036 32.9637C84.5036 29.4867 87.2418 26.827 91.0022 26.827C95.2186 26.827 97.3361 29.73 97.3361 32.7899C97.3361 36.3018 94.5249 38.8573 91.0022 38.8573C86.9499 38.8573 84.5036 36.0929 84.5036 32.9637Z"" fill=""white""/><path d=""M117.93 31.4711C117.93 30.3933 117.893 28.3935 117.58 27.8724C117.451 27.6637 117.119 27.5418 116.658 27.5069L116.198 27.4723C116.088 27.3506 116.124 27.1247 116.235 27.0549C116.935 27.0896 117.617 27.1073 118.335 27.1073C119.11 27.1073 119.607 27.0896 120.271 27.0554C120.418 27.1424 120.4 27.3681 120.307 27.4723L119.865 27.5069C119.404 27.5418 119.054 27.6984 118.944 27.9245C118.686 28.498 118.686 30.4975 118.686 31.4711V33.4355C118.686 34.9483 118.427 36.5474 117.396 37.5903C116.603 38.4076 115.24 38.8596 113.876 38.8596C112.605 38.8596 111.333 38.6335 110.43 37.9035C109.453 37.1388 108.993 35.8695 108.993 33.8009V29.6977C108.993 27.8899 108.956 27.5942 107.887 27.5069L107.426 27.4723C107.316 27.4027 107.352 27.1075 107.463 27.0549C108.385 27.0896 109.011 27.1073 109.748 27.1073C110.504 27.1073 111.112 27.0896 112.015 27.0554C112.125 27.1075 112.162 27.4027 112.052 27.4723L111.609 27.5069C110.54 27.5942 110.504 27.8899 110.504 29.6977V33.4529C110.504 36.2517 111.425 38.0949 114.244 38.0949C116.916 38.0949 117.93 36.1126 117.93 33.4706V31.4711Z"" fill=""white""/><path d=""M141.018 35.706C141.018 36.3381 141.058 37.2334 141.445 37.6199C141.832 38.0238 142.443 38.1115 143.054 38.1115C144.867 38.1115 146.252 37.4091 146.252 35.6532C146.252 34.266 145.437 32.6511 142.199 32.6511C141.099 32.6511 141.018 32.7558 141.018 33.1073V35.706ZM141.018 31.632C141.018 32.1241 141.038 32.159 142.076 32.1241C144.154 32.0538 145.274 31.5271 145.274 29.8763C145.274 28.1555 143.788 27.5056 142.24 27.5056C141.791 27.5056 141.486 27.5408 141.303 27.6113C141.099 27.6639 141.018 27.7516 141.018 28.0675V31.632ZM139.347 29.2969C139.347 27.9975 139.266 27.6639 138.349 27.5938L137.697 27.5304C137.623 27.4634 137.584 27.1116 137.718 27.1017C138.818 27.0194 140.203 26.9617 142.097 26.9617C143.38 26.9617 144.602 27.0494 145.519 27.4528C146.395 27.8218 147.067 28.5243 147.067 29.6483C147.067 30.9121 146.211 31.5622 144.989 32.0538C144.989 32.2295 145.152 32.2821 145.376 32.3172C146.476 32.4926 148.106 33.371 148.106 35.2493C148.106 37.286 146.354 38.6557 142.688 38.6557C142.097 38.6557 141.099 38.6032 140.244 38.6032C139.347 38.6032 138.655 38.6381 137.901 38.6557C137.779 38.6032 137.738 38.3223 137.86 38.2172L138.227 38.1644C139.307 38.0064 139.347 37.813 139.347 35.9696V29.2969Z"" fill=""white""/><path d=""M99.1234 16.2084C98.773 16.2084 98.0725 16.3388 98.0725 15.8736V12.5388C98.0725 11.2351 98.114 11.0486 99.6797 11.0486C101.513 11.0486 102.646 11.9797 102.646 13.6935C102.646 14.4388 102.379 15.128 101.699 15.5937C100.916 16.1342 100.071 16.2084 99.1234 16.2084ZM106.157 21.9212L105.674 21.8795C105.576 21.8691 105.49 21.8568 105.407 21.8431C104.701 21.7182 104.419 21.0896 104.086 20.5062L102.418 17.6001C102.129 17.1158 101.82 16.4638 101.161 16.3709C102.871 16.1658 104.416 15.1787 104.416 13.4836C104.416 11.5273 102.479 10.652 100.522 10.652C99.3477 10.652 98.2774 10.6838 97.0824 10.6838C96.4234 10.6838 95.6391 10.652 94.9801 10.652C94.6139 10.652 94.6092 10.7265 94.6092 10.9314C94.6092 11.2337 94.7368 11.1491 95.1246 11.171C96.5168 11.2493 96.4635 11.5089 96.4635 12.701V20.3202C96.4635 21.4105 96.5578 21.7361 95.413 21.8387C95.413 21.8387 95.2376 21.8568 95.1381 21.8674L94.6531 21.9172C94.5371 22.0212 94.5762 22.2994 94.6917 22.3515C94.9497 22.3421 95.4069 22.3242 95.4069 22.3242C96.0407 22.3053 96.6743 22.257 97.3081 22.257C97.9454 22.257 98.5552 22.306 99.1819 22.3244V22.3249C99.4043 22.3319 99.6393 22.3397 99.8966 22.3489C100.013 22.2968 100.052 22.0188 99.9353 21.9146L99.4472 21.8684C99.3477 21.8578 99.1765 21.8424 99.1765 21.8424C98.0204 21.7642 98.0914 21.4381 98.0914 20.3202V17.4513C98.0914 17.2836 98.0702 16.8368 98.1942 16.7062C98.2972 16.594 98.4823 16.6128 98.6471 16.6128C100.214 16.6128 100.192 16.7621 100.934 18.066L102.953 21.6984C103.118 21.978 103.242 22.3317 103.654 22.3317H105.408C105.629 22.3388 105.861 22.3461 106.118 22.3555C106.233 22.3034 106.272 22.0252 106.157 21.9212Z"" fill=""white""/><path d=""M99.5001 29.7566C99.5001 27.9313 99.4619 27.6526 98.2575 27.5658L97.7791 27.5312C97.6645 27.4616 97.7027 27.149 97.8173 27.0964C98.8885 27.1313 99.5383 27.1485 100.303 27.1485C101.049 27.1485 101.699 27.1313 102.656 27.0971C102.77 27.149 102.808 27.4616 102.694 27.5312L102.235 27.5658C101.107 27.6526 101.068 27.9313 101.068 29.7566V35.8067C101.068 36.902 101.126 37.354 101.47 37.6841C101.68 37.8751 102.044 38.084 103.554 38.084C105.18 38.084 105.581 38.0142 105.888 37.8581C106.27 37.6492 106.767 37.0237 107.149 36.1369C107.265 36.0503 107.628 36.1192 107.628 36.2411C107.628 36.4325 107.092 38.2059 106.824 38.6749C105.849 38.6403 104.032 38.6228 102.062 38.6228H100.303C99.5001 38.6228 98.8885 38.6403 97.8173 38.6749C97.7027 38.6228 97.6645 38.3446 97.7791 38.2404L98.353 38.1885C99.4619 38.084 99.5001 37.8405 99.5001 36.0154V29.7566Z"" fill=""white""/><path d=""M150.731 29.7912C150.731 27.9488 150.693 27.6528 149.586 27.5658L149.116 27.5314C149.004 27.4616 149.041 27.1492 149.154 27.0964C150.092 27.1315 150.731 27.1487 151.519 27.1487C152.27 27.1487 152.909 27.1315 153.848 27.0971C153.96 27.1492 153.998 27.4616 153.885 27.5314L153.415 27.5658C152.308 27.6528 152.27 27.9488 152.27 29.7912V35.9808C152.27 37.8235 152.308 38.0668 153.415 38.1885L153.885 38.2406C153.998 38.3101 153.96 38.6228 153.848 38.6751C152.909 38.6403 152.27 38.6228 151.519 38.6228C150.731 38.6228 150.092 38.6403 149.154 38.6751C149.041 38.6228 149.004 38.3446 149.116 38.2406L149.586 38.1885C150.693 38.0668 150.731 37.8235 150.731 35.9808V29.7912Z"" fill=""white""/><path d=""M135.728 38.1849C135.631 38.1746 135.451 38.1604 135.451 38.1604C135.254 38.1406 135.076 38.1121 134.936 37.9588C134.692 37.6999 134.712 36.9624 134.712 36.6671V29.0494C134.712 28.7172 134.631 27.998 134.875 27.7394C134.997 27.6033 135.25 27.5805 135.476 27.5677V27.5668C135.613 27.5564 135.616 27.5559 135.736 27.55L136.219 27.5156C136.335 27.4458 136.296 27.1332 136.18 27.0808C135.922 27.0898 135.688 27.0865 135.465 27.0933V27.0943H133.414C133.191 27.0943 132.988 27.0943 132.866 27.3341L128.686 36.0402L124.994 27.6293C124.872 27.3341 124.852 27.0943 124.466 27.0943H122.331C122.109 27.0874 121.863 27.0898 121.605 27.0808C121.49 27.1332 121.451 27.4458 121.567 27.5156L122.049 27.55C122.149 27.5581 122.329 27.5703 122.329 27.5703C123.13 27.6217 123.18 27.8007 123.107 28.6436L122.478 36.8145C122.423 37.6351 122.378 38.0687 121.518 38.1486C121.518 38.1486 121.337 38.1713 121.237 38.1819L120.755 38.2342C120.639 38.338 120.678 38.6162 120.794 38.6683C121.048 38.6589 121.5 38.6457 121.5 38.6457C121.936 38.6242 122.379 38.5855 122.823 38.5855C123.302 38.5855 123.781 38.6308 124.26 38.6499V38.6509C124.483 38.6577 124.717 38.6655 124.975 38.6744C125.091 38.6223 125.13 38.3443 125.014 38.2401L124.532 38.188C124.405 38.1781 124.262 38.164 124.262 38.164C123.022 38.0791 123.05 37.2036 123.127 36.1326L123.716 28.5333H123.858L127.855 37.8848C127.895 38.0138 127.956 38.2352 128.159 38.2352C128.342 38.2352 128.403 38.0326 128.463 37.9029L132.967 28.3112H133.109V36.6671C133.109 36.9991 133.15 37.6818 132.805 37.9397C132.625 38.0739 132.039 38.1545 132.039 38.1545C131.958 38.1673 131.873 38.179 131.777 38.1892L131.295 38.2411C131.179 38.3453 131.218 38.6233 131.334 38.6756C131.588 38.6664 132.039 38.6523 132.039 38.6523C132.693 38.6341 133.357 38.5855 134.022 38.5855C134.5 38.5855 135.437 38.6311 135.437 38.6311C135.66 38.6379 135.914 38.6622 136.172 38.6714C136.288 38.6193 136.326 38.3413 136.21 38.2373L135.728 38.1849Z"" fill=""white""/><path d=""M162.012 33.9263H159.754C159.676 33.9263 159.048 34.0001 159.048 33.816C159.048 33.7605 159.087 33.65 159.106 33.595L160.461 30.2402C160.5 30.148 160.638 29.687 160.795 29.687C160.913 29.687 161.07 30.1664 161.109 30.2402L162.444 33.3734C162.444 33.4104 162.581 33.7054 162.581 33.7792C162.581 33.9819 162.13 33.9263 162.012 33.9263ZM167.08 38.2295L167.015 38.1774C166.919 38.1672 166.833 38.1557 166.752 38.1423C166.001 37.9744 165.708 37.0689 165.43 36.4238L161.561 27.2671C161.522 27.1572 161.446 26.9202 161.293 26.9202C161.082 26.9202 161.025 27.1756 160.967 27.3211L157.271 36.4604C157.136 36.807 156.792 37.6466 156.543 37.9013C156.352 38.0967 156.103 38.1342 155.838 38.1616C155.838 38.1616 155.63 38.1814 155.53 38.1922L155.076 38.2385C154.96 38.3424 154.999 38.6207 155.115 38.673C155.372 38.6638 155.83 38.6471 155.83 38.6471C156.335 38.6402 156.841 38.5763 157.347 38.5763C157.773 38.5763 158.199 38.6216 158.624 38.6405C158.624 38.6405 159.081 38.6568 159.339 38.6667C159.455 38.6141 159.493 38.3358 159.378 38.2319L158.895 38.1795C158.799 38.1696 158.633 38.154 158.633 38.154C158.189 38.1048 157.635 38.0253 157.635 37.5363C157.635 37.208 157.788 36.8249 157.903 36.533L158.477 35.1654C158.765 34.5089 158.65 34.4354 159.415 34.4354H162.021C162.94 34.4354 162.805 34.4354 163.208 35.3663L163.821 36.7518C163.917 36.9895 164.089 37.3906 164.089 37.6466C164.089 38.1048 163.588 38.1349 163.121 38.1746C163.121 38.1746 162.966 38.1875 162.831 38.1979L162.367 38.2316C162.251 38.3356 162.29 38.6138 162.406 38.6662C162.664 38.6568 163.121 38.6381 163.121 38.6381C163.666 38.6183 164.214 38.5763 164.74 38.5763C165.411 38.5763 166.082 38.6219 166.752 38.641V38.6402C166.973 38.6471 166.787 38.6549 167.041 38.6641C167.157 38.6117 167.196 38.3335 167.08 38.2295Z"" fill=""white""/><path d=""M53.6069 25.5067L54.8752 26.0325L57.688 24.0707L53.6069 25.5067Z"" fill=""#E3A82B""/><path d=""M6.34557 23.3141L3.01172 22.1411L3.17889 21.7327L6.9334 22.9845L6.94967 22.9753L7.44507 22.6945L7.64266 22.5707L3.54861 20.8291L3.72168 20.4009L12.8595 24.0967L13.1609 23.9717L4.09824 19.5554L4.30032 19.1404L13.9041 23.61L14.0369 23.5426L4.72498 18.2609L4.9162 17.8643L18.3632 25.1811C18.4733 24.9776 18.7039 24.6067 18.8222 24.4073C13.7098 19.6004 8.77635 15.9914 8.77635 15.9914C8.77635 15.9914 13.8499 19.3891 20.1116 22.548C20.3183 22.2898 20.4881 22.0826 20.709 21.8376L9.23732 11.7382L9.54526 11.422L18.8041 19.3132L10.2262 10.7231L10.5474 10.3906L20.178 19.698L11.2133 9.74786L11.5561 9.43874L19.8418 18.3111L12.2793 8.78229L12.6049 8.48614L22.2988 20.2833C22.5494 20.067 22.7576 19.9043 23.0198 19.7034C20.0875 13.3578 16.8852 8.19588 16.8852 8.19588C16.8852 8.19588 20.2936 13.2131 24.8922 18.4674C25.1731 18.3092 25.4579 18.1576 25.7489 18.0149L25.7 17.9834L18.9064 4.4251L19.3103 4.24755L24.9389 15.0322L20.2035 3.85401L20.6258 3.66656L26.0686 15.9037L21.4836 3.31971L21.9175 3.16149L26.2763 14.492L22.8338 2.82384L23.2471 2.67152L27.779 17.1435L27.7703 17.1817L27.7816 17.1772C28.083 17.076 28.3895 16.9869 28.6977 16.903C28.3527 9.95182 27.3244 4.00563 27.3244 4.00563C27.3244 4.00563 28.5977 9.89947 30.8806 16.4712C31.1985 16.4321 31.5184 16.3988 31.841 16.3771L31.8309 16.362H31.8705L31.8478 16.3288L30.6279 1.21315L31.0688 1.19924L32.2473 13.3076L32.0447 1.16953L32.5059 1.15397L32.9686 14.5389L33.4307 1.15373L33.8929 1.16953L33.6898 13.3076L34.8686 1.19947L35.3093 1.21315L34.0893 16.3288L34.0664 16.362H34.073L34.0697 16.3668H34.0897C34.4052 16.3866 34.7181 16.4182 35.0287 16.4554C37.3085 9.89004 38.5797 4.00563 38.5797 4.00563C38.5797 4.00563 37.5545 9.9339 37.2079 16.8723C37.5191 16.9546 37.827 17.0449 38.1305 17.1444L42.6464 2.72269L43.0602 2.87524L39.6172 14.5434L43.9765 3.2129L44.4099 3.37135L39.8247 15.9551L45.2674 3.71773L45.6902 3.90542L40.9546 15.0838L46.5834 4.29895L46.9871 4.4765L40.2175 17.9862L40.229 17.9909C40.508 18.1267 40.781 18.2717 41.0513 18.4217C45.6301 13.1841 49.0189 8.19588 49.0189 8.19588C49.0189 8.19588 45.8385 13.3225 42.9147 19.6372C43.176 19.8343 43.4316 20.038 43.6796 20.25L53.2596 8.58116L53.5864 8.87755L46.0229 18.4064L54.3093 9.534L54.6515 9.84335L45.6864 19.7931L55.3171 10.4857L55.6385 10.8181L47.0606 19.4085L56.3195 11.5177L56.6274 11.8332L45.2957 21.8187L45.3023 21.8256C45.5002 22.046 45.6907 22.2736 45.8777 22.5047C52.0997 19.3585 57.1278 15.9914 57.1278 15.9914C57.1278 15.9914 52.2422 19.5653 47.1564 24.3377C47.2957 24.5702 47.5207 24.9673 47.6492 25.2068L60.9056 17.989L61.0973 18.3863L50.5152 24.3879L61.5215 19.2658L61.7233 19.6808L51.4716 24.6763L51.6682 24.7449L62.0999 20.5257L62.2732 20.9541L52.577 25.0783L52.7583 25.1535L59.2195 22.9996L60.1933 22.3198L60.5165 22.5667L62.6427 21.8579L62.8099 22.2658L60.9704 22.913L63.6281 24.9411L64.4797 25.416C61.0629 11.1322 48.2141 0.512848 32.8834 0.512848C17.2835 0.512848 4.25339 11.5088 1.11595 26.1719C1.15627 26.1523 1.19518 26.1342 1.2355 26.1144L1.62479 25.938L1.86365 25.8265L6.34557 23.3141Z"" fill=""#E3A82B""/><path d=""M0.933402 38.9104C0.933402 38.9104 5.72586 37.9534 9.7263 37.9534C20.2667 37.9534 34.8473 43.8885 45.4268 43.8885C53.1876 43.8885 60.757 41.7595 64.8822 38.6555C65.2045 36.8192 65.3733 34.9305 65.3733 33.0017C65.3733 30.3896 65.0633 27.8504 64.4809 25.4163L60.0704 22.9568L54.8955 26.5859L51.4142 25.2303C50.2358 25.8259 42.9649 30.6882 42.9649 30.6882L40.1743 28.6681L37.1802 28.0751L33.1878 25.1685L28.6082 28.3126C28.6082 28.3126 23.4989 31.2793 23.3235 31.2793C23.1471 31.2793 17.1589 26.5321 17.1589 26.5321L14.3999 23.6255C13.93 23.9221 12.0533 24.7832 12.0533 24.7832L11.9569 24.8087L10.1408 24.247L7.93547 23.0773L1.23663 26.1147C1.19631 26.1345 1.1574 26.1529 1.11708 26.1725C0.645737 28.3746 0.395798 30.6589 0.395798 33.0017C0.395798 35.0196 0.58113 36.9944 0.933402 38.9104Z"" fill=""#65799E""/></svg>')
+```
+<span style=""color:white; position: absolute; top:16px; padding:10px; left: 190px; font-size:0.5em; font-weight:800"">Ministry of Forests, Lands, Natural<br />Resource Operations & Rural Development<br />Climate Change and Integrated Planning Branch</span>
\ No newline at end of file

---FILE: app/server/silviculture.R---
@@ -77,6 +77,7 @@ sppnotes <- function(spp, notes, textstyle) {
                           tags$sup(fn, .noWS = htmltools:::noWSOptions),
                           if (i < length(spp)) {"", ""} else {""""}, .noWS = htmltools:::noWSOptions)
   }
+  ret[[""style""]] <- ""white-space:normal;""
   do.call(tags$td, ret)
 }
 uData$sppnotes <- sppnotes
@@ -149,16 +150,7 @@ standardblock <- function(std, ss, sc) {
               ss[!is.na(Species) & Suitability %in% 3L, sppnotes(Species, Footnotes, TextStyle)],
               tags$td(paste(sc[!is.na(Spp) & ProjFeas %in% ""3"", unique(Spp)], collapse = "", ""))
             )
-          ),
-          tags$br(),
-          tags$small(tags$b(""Footnotes"")),
-          tags$hr(style = ""padding: 0; margin: 0 0 3px 0; height: 2px; background-color: #003366; border: 0px""),
-          {
-            fn <- ss[PreferredAcceptable %in% c(""A"", ""P"") | Suitability %in% 1:3, sort(as.integer(unique(unlist(Footnotes))))]
-            fnt <- footnotes[match(fn, `Revised Footnote`), `Revised Footnote Text`]
-            fnshiny <- mapply(function(footnote, text) {list(tags$sup(footnote), tags$small(text), tags$br())}, fn, fnt, SIMPLIFY = FALSE, USE.NAMES = FALSE)
-            do.call(span, fnshiny)
-          }
+          )
         ),
         tags$td(width = ""50%"", style = ""vertical-align: top; padding:0px 0px 0px 8px;"",
           tags$small(tags$b(""Stocking (i) - well spaced/ha"")),
@@ -197,6 +189,19 @@ standardblock <- function(std, ss, sc) {
             )
           )
         )
+      ),
+      tags$tr(height = 0),
+      tags$tr(
+        tags$td(colspan = ""2"", style = ""white-space:normal;"",
+          tags$small(tags$b(""Footnotes"")),
+          tags$hr(style = ""padding: 0; margin: 0 0 3px 0; height: 2px; background-color: #003366; border: 0px""),
+          {
+            fn <- ss[PreferredAcceptable %in% c(""A"", ""P"") | Suitability %in% 1:3, sort(as.integer(unique(unlist(Footnotes))))]
+            fnt <- footnotes[match(fn, `Revised Footnote`), `Revised Footnote Text`]
+            fnshiny <- mapply(function(footnote, text) {list(tags$sup(footnote), tags$small(text), tags$br())}, fn, fnt, SIMPLIFY = FALSE, USE.NAMES = FALSE)
+            do.call(span, fnshiny)
+          }
+        )
       )
     )
   )

---FILE: data-raw/scripts/bigshinygisstudio.R---
@@ -72,6 +72,7 @@ bccciss:::install_nginx(server, config = ""./data-raw/config/bsgs/nginx.conf"", na
 # Install Shiny App
 
 # system dependencies
+# Install chromium to support pdf printing
 analogsea::debian_apt_get_install(server,
                                   ""git"",
                                   ""libaio1"",
@@ -99,9 +100,13 @@ analogsea::debian_apt_get_install(server,
                                   ""libfribidi-dev"",
                                   ""texlive"",
                                   ""texlive-extra-utils"",
-                                  ""texlive-latex-extra"")
+                                  ""texlive-latex-extra"",
+                                  ""chromium-browser"")
 analogsea::droplet_ssh(server, ""R -e \""install.packages('remotes')\"""")
 
+
+
+
 # upload app to server
 server <- analogsea::droplets()$BigShinyGisStudio
 analogsea::droplet_ssh(server, ""rm -R /srv/shiny-server/cciss"")

---FILE: data-raw/scripts/debug_shiny.R---
@@ -22,20 +22,25 @@ pool <- dbPool(
 )
 bcgov_tileserver <- Sys.getenv(""BCGOV_TILESERVER"")
 bcgov_tilelayer <- Sys.getenv(""BCGOV_TILELAYER"")
+if (is.null(bcgov_tileserver) || is.null(bcgov_tilelayer)) stop(""tileserver env not set"")
+mbtk <- Sys.getenv(""BCGOV_MAPBOX_TOKEN"")
+mblbstyle <- Sys.getenv(""BCGOV_MAPBOX_LABELS_STYLE"")
+mbhsstyle <- Sys.getenv(""BCGOV_MAPBOX_HILLSHADE_STYLE"")
+
 curr_wd <- getwd()
 setwd(""./app/"")
 
+dl_style <- ""max-width: 300px; width:100%; height: 40px !important;""
+
 ui <- fixedPage(
   # Actions on points
-  actionButton(""add_button"", ""Add"", icon(""plus"")),
-  actionButton(""delete_button"", ""Delete"", icon(""trash-alt"")),
-  actionButton(""upload_button"", ""Upload"", icon(""upload"")),
-  actionButton(""clear_button"", ""Clear"", icon(""broom"")),
+  actionButton(""upload_button"", ""Upload"", icon(""upload""), width=120),
+  actionButton(""add_dialog"", ""Add"", icon(""plus""), width=120),
+  actionButton(""delete_button"", ""Delete"", icon(""trash-alt""), width=120),
+  actionButton(""clear_button"", ""Clear"", icon(""broom""), width=120),
   
   # Points
   DT::DTOutput(""points_table"", width=""100%""),
-  actionButton(""generate_results"", label = ""Generate results"", icon = icon(""plus-square"")),
-  
   
   # Control results
   splitLayout(
@@ -52,36 +57,58 @@ ui <- fixedPage(
     )
   ),
   
+  # Generate results
+  actionButton(""generate_results"", label = ""Generate results"", icon = icon(""plus-square""),
+               style = ""width:100%; background-color:#003366; color: #FFF""),
+  
+  
   leafletOutput(""bec_map""),
   
   selectInput(""siteref_feas"", label = ""Sites:"", choices = character()),
   selectInput(""site_series_feas"", label = ""Site Series"", choices = character()),
-  span(""Averaged:""),
-  textOutput(""avg_feas"", inline = TRUE),
-  span(""RCP Scenario:""),
-  textOutput(""rcp_feas"", inline = TRUE),
-  span(""Legend""),
-  HTML(
-    paste0(
-      '<svg viewBox=""0 0 1 1"" height=""14px"" width=""14px""><rect height=1 width=1 style=""fill : ',
-      c(""limegreen"", ""deepskyblue"", ""gold"", ""grey""),
-      '""><span>&nbsp;',
-      c(""Primary"", ""Secondary"", ""Tertiary"", ""Not Suitable""),
-      '</span>',
-      collapse = ""<br />""
-    )
-  ),
+  selectInput(""filter_feas"", label = ""Feasibility"", choices = c(""All"" = ""a"", ""Feasible Only"" = ""f"")),
+  
+  tableOutput(""results_feas""),
+  tableOutput(""summary_feas""),
+  
+  selectInput(""siteref_silv"", label = ""Sites:"", choices = character()),
+  selectInput(""site_series_silv"", label = ""Site Series"", choices = character()),
+  selectInput(""filter_silv"", label = ""Tree Species"", choices = c(""Feasible Species"" = ""f"", ""All Species"" = ""a"")),
   
-  DT::DTOutput(""results_feas""),
-  DT::DTOutput(""summary_feas""),
+  uiOutput(""silviculture_block""),
+  tableOutput(""silvics_tol_dt""),
+  
+  tableOutput(""silvics_resist_dt""),
+  tableOutput(""silvics_regen_dt""),
+  tableOutput(""silvics_mature_dt""),
   
   selectInput(""siteref_bgc_fut"", label = ""Sites:"", choices = character()),
-  textOutput(""current_bgc_fut"", inline = TRUE),
+  
   plotly::plotlyOutput(""bgc_fut_plot""),
-
-  textInput(""report_name"", ""Name"", value = ""report""),
-  selectInput(""report_format"", ""Format"", c(""html"", ""pdf"")),
-  span(downloadButton(""report_download"", ""Download"", style = ""max-width: 300px; width:100%; height: 40px !important;""), id = ""download_span""),
+  
+  actionButton(""report_filter_all"", label = ""Check All"", icon = icon(""check"")),
+  actionButton(""report_filter_none"", label = ""Uncheck All"", icon = icon(""ban"")),
+  div(
+    checkboxGroupInput(""report_filter"", label = ""Site Series"", choices = character(), width = 400),
+    style = ""line-height: 1.5; color: #222; background-color: #fff; margin: 10px 0px 10px 0px; padding: 0px 10px 0px 10px""
+  ),
+  
+  splitLayout(
+    div(
+      textInput(""report_name"", ""Name"", value = ""report""),
+      radioButtons(""report_format"", ""Format"", c(""html"", ""pdf""), inline = TRUE),
+      span(downloadButton(""report_download"", ""Download"", style = dl_style), id = ""download_report_span"")
+    ),
+    div(
+      radioButtons(""data_format"", ""Data Format"", c(""csv"", ""rds""), inline = TRUE),
+      span(downloadButton(""data_download"", ""Download Data"", style = dl_style), id = ""download_data_span"")
+    ) 
+  ),
+  div(
+    tableOutput(""modelsinfo""),
+    plotly::plotlyOutput(""timings"", width = ""100%"")
+  ),
+  tableOutput(""shinyinfo""),
   tags$script(HTML('
   Shiny.addCustomMessageHandler(""jsCode"",
     function(message) {
@@ -90,9 +117,12 @@ ui <- fixedPage(
     }
   );'
   ))
+  
 )
 
 server <- function(input, output, session) {
+  # bslib::bs_themer()
+  # Reusing Shiny session userData environment
   uData <- session$userData
   source(""./server/generate.R"", local = TRUE)
   source(""./server/points.R"", local = TRUE)
@@ -101,6 +131,17 @@ server <- function(input, output, session) {
   source(""./server/silviculture.R"", local = TRUE)
   source(""./server/futures.R"", local = TRUE)
   source(""./server/download.R"", local = TRUE)
+  output$shinyinfo <- function() {
+    app_info <- data.table(
+      Information = c(""Shiny host"",""Database host"",""Tiles source"",""Tileserver"",""Github"",""Copyright"",""License""),
+      Value = c(system(""hostname"", intern = TRUE), Sys.getenv(""BCGOV_HOST""), Sys.getenv(""BCGOV_TILESERVER""),
+                strsplit(Sys.getenv(""BCGOV_TILESERVER""), split = ""data"")[[1]][1],
+                as.character(tags$a(href = ""https://github.com/bcgov/CCISS_ShinyApp"", ""bcgov/CCISS_ShinyApp"")),
+                paste(format(Sys.Date(), ""%Y""), ""Province of British Columbia""),
+                as.character(tags$a(href = ""http://www.apache.org/licenses/LICENSE-2.0"", ""Apache 2.0 LICENSE"")))
+    )
+    knitr::kable(app_info, format = ""html"", table.attr = 'class=""table table-hover table-centered""', escape = FALSE)
+  }
   
   onStop(function() {
     poolClose(pool)"
bcgov,CCISS_ShinyApp,90b24e4d40484566763d7feaf06840037133fe3b,Bruno Tremblay,meztez@neoxone.com,2021-03-21T20:29:11Z,Bruno Tremblay,meztez@neoxone.com,2021-03-21T20:29:11Z,fix non ascii characters in stocking standards site series names,data-raw/scripts/create_package_data.R;data/stocking_standards.rda,False,True,True,False,9,0,9,"---FILE: data-raw/scripts/create_package_data.R---
@@ -86,6 +86,15 @@ setkey(stocking_standards, Region, ZoneSubzone, SS_NoSpace, Species)
 # Recheck for dups
 dupPairs(stocking_standards)
 # All good
+# Replace non ascii characters in SiteSeriesName and trim
+# Remove extras spaces
+stocking_standards[, SiteSeriesName := {
+  x <- chartr(""\U2013\U2019\U0024\U00A0"",""-'  "", SiteSeriesName)
+  x <- trimws(x)
+  x <- gsub(""\\s+;"", "";"", x)
+  x <- gsub(""\\s{2,}"", "" "", x)
+  x
+}]
 
 # Notes
 footnotes <- read_xlsx(""./data-raw/data_tables/StockingStds/Revised Reference Guide Footnotes.xlsx"", ""Sheet1"")"
bcgov,CCISS_ShinyApp,fac8b26da5ac5eca1523209bfaba5a21d181595e,Bruno Tremblay,meztez@neoxone.com,2021-03-21T15:18:08Z,Bruno Tremblay,meztez@neoxone.com,2021-03-21T15:18:08Z,adding fixed silviculture ref info from Klinka,R/z_data.R;app/index.Rmd;app/server/common.R;app/server/generate.R;data-raw/scripts/create_package_data.R;data/silvics.rda;data/silvics_mature.rda;data/silvics_regen.rda;data/silvics_resist.rda;data/silvics_tol.rda;man/bccciss-data.Rd,True,True,True,False,121,53,174,"---FILE: R/z_data.R---
@@ -3,5 +3,5 @@
 #' @name bccciss-data
 #' @docType data
 #' @keywords data
-#' @aliases E1 F1 footnotes R1 S1 silvics stocking_standards subzones_colours_ref T1 V1 zones_colours_ref
+#' @aliases E1 F1 footnotes R1 S1 silvics_mature silvics_regen silvics_resist silvics_tol stocking_standards subzones_colours_ref T1 V1 zones_colours_ref
 NULL

---FILE: app/index.Rmd---
@@ -7,13 +7,13 @@ output:
     logo: www/logo.svg
     favicon: www/favicon.ico
     css: www/style.css
-    theme:
-      version: 4
-      bootswatch: yeti
-      primary: ""#003366""
-runtime: shiny_prerendered
-#     theme : yeti
+#     theme:
+#       version: 4
+#       bootswatch: yeti
+#       primary: ""#003366""
 # runtime: shiny_prerendered
+    theme : yeti
+runtime: shiny_prerendered
 ---
 
 ```{r global, include=FALSE}
@@ -139,16 +139,88 @@ DT::DTOutput(""detailed_feas"", width = ""100%"", height = ""auto"")
 SILVICULTURE
 =====================================     
 
+Inputs {.sidebar data-width=230}
+-------------------------------------
+
+###### Filters  
+
+```{r}
+selectInput(""siteref_silv"", label = ""Sites:"", choices = character())
+selectInput(""site_series_silv"", label = ""Site Series"", choices = character())
+```
+
+Silviculture {.tabset}
+-------------------------------------
+
 ### Silviculture
 
-Site Series
-{insert name of site series}
+```{r}
+uiOutput(""silviculture"")
+```
+
+### Tolerance
+
+```{r}
+tags$h5(""Tolerance comparisons"")
+DT::datatable(
+  silvics_tol, rownames = FALSE, width = ""100%"", height = ""auto"", 
+  options = list(scrollCollapse = FALSE, lengthChange = FALSE, 
+                 searching = FALSE, pageLength = nrow(silvics_tol),
+                 columnDefs = list(
+                   list(className = 'dt-center', targets = (seq_len(ncol(silvics_tol))-1)[-3])
+                 )
+  )
+)
+tags$small(""From Klinka et al. 2000. Ecological and Silvical Characteristics of Tree Species"")
+```
+
+### Resistance
+
+```{r}
+tags$h5(""Resistance and potential risk comparisons"")
+DT::datatable(
+  silvics_resist, rownames = FALSE, width = ""100%"", height = ""auto"", 
+  options = list(scrollCollapse = FALSE, lengthChange = FALSE, 
+                 searching = FALSE, pageLength = nrow(silvics_resist),
+                 columnDefs = list(
+                   list(className = 'dt-center', targets = (seq_len(ncol(silvics_resist))-1)[-3])
+                 )
+  )
+)
+tags$small(""From Klinka et al. 2000. Ecological and Silvical Characteristics of Tree Species"")
+```
+
+### Regeneration stage
 
-Forest Region:
-    
 ```{r}
+tags$h5(""Comparison of silvical characteristics; regeneration stage"")
+DT::datatable(
+  silvics_regen, rownames = FALSE, width = ""100%"", height = ""auto"", 
+  options = list(scrollCollapse = FALSE, lengthChange = FALSE, 
+                 searching = FALSE, pageLength = nrow(silvics_regen),
+                 columnDefs = list(
+                   list(className = 'dt-center', targets = (seq_len(ncol(silvics_regen))-1)[-3])
+                 )
+  )
+)
+tags$small(""From Klinka et al. 2000. Ecological and Silvical Characteristics of Tree Species"")
 ```
 
+### Maturing stage
+
+```{r}
+tags$h5(""Comparison of silvical characteristics; maturing stage"")
+DT::datatable(
+  silvics_mature, rownames = FALSE, width = ""100%"", height = ""auto"", 
+  options = list(scrollCollapse = FALSE, lengthChange = FALSE, 
+                 searching = FALSE, pageLength = nrow(silvics_mature),
+                 columnDefs = list(
+                   list(className = 'dt-center', targets = (seq_len(ncol(silvics_mature))-1)[-3])
+                 )
+  )
+)
+tags$small(""From Klinka et al. 2000. Ecological and Silvical Characteristics of Tree Species"")
+```
 
 BGC FUTURES
 =====================================
@@ -175,15 +247,18 @@ plotly::plotlyOutput(""bgc_fut_plot"", width = ""100%"", height = ""auto"")
 EXPORT
 =====================================
 
-Inputs {.sidebar data-width=230}
+Inputs {.sidebar data-width=400}
 -------------------------------------
 
 ###### Filter
 
 ```{r}
-actionButton(""report_filter_all"", label = ""Check All"")
-actionButton(""report_filter_none"", label = ""Uncheck All"")
-checkboxGroupInput(""report_filter"", label = ""Site Series"", choices = character())
+actionButton(""report_filter_all"", label = ""Check All"", icon = icon(""check""))
+actionButton(""report_filter_none"", label = ""Uncheck All"", icon = icon(""ban""))
+div(
+  checkboxGroupInput(""report_filter"", label = ""Site Series"", choices = character(), width = 380),
+  style = ""line-height: 1.5; color: #222; background-color: #fff; margin: 10px 0px 10px 0px; padding: 0px 10px 0px 10px""
+)
 ```
 
 Export a report on selected points.

---FILE: app/server/common.R---
@@ -35,7 +35,8 @@ cciss <- function(bgc) {
 
 cciss_summary <- function(cciss, pts, avg, SS = bccciss::stocking_standards) {
   withProgress(message = ""Processing..."", detail = ""Feasibility summary"", {
-    summary <- cciss$Summary
+    # use a copy to avoid modifying the original object
+    summary <- copy(cciss$Summary)
     # Append region
     region_map <- pts[[{if (avg) {""BGC""} else {""Site""}}]]
     summary$Region <- pts$ForestRegion[match(summary$SiteRef, region_map)]
@@ -74,7 +75,8 @@ period_map <- c(""1975"" = ""Historic"", ""2000"" = ""Current"", ""2025"" = ""2010-2040"", ""
 
 cciss_detailed <- function(cciss, pts, avg, SS = bccciss::stocking_standards) {
   withProgress(message = ""Processing..."", detail = ""Feasibility detailed"", {
-    detailed <- cciss$Raw
+    # use a copy to avoid modifying the original object
+    detailed <- copy(cciss$Raw)
     # Append region
     region_map <- pts[[{if (avg) {""BGC""} else {""Site""}}]]
     detailed$Region <- pts$ForestRegion[match(detailed$SiteRef, region_map)]

---FILE: app/server/generate.R---
@@ -18,9 +18,12 @@ observeEvent(input$generate_results, priority = 100, {
   cciss_detailed <- uData$cciss_detailed <- cciss_detailed(cciss, pts, avg)
   
   # UI select choices
-  siteseries_all <- uData$siteseries_all <- sort(
-    unique(c(cciss_detailed$`Site Series`, cciss_summary$`Site Series`))
+  ssa <- sort(unique(c(cciss_detailed$`Site Series`, cciss_summary$`Site Series`)))
+  names(ssa) <- paste(
+    ssa,
+    stocking_standards$SiteSeriesName[match(ssa, stocking_standards$SS_NoSpace)]
   )
+  siteseries_all <- uData$siteseries_all <- ssa
   siterefs       <- uData$siterefs       <- unique(bgc$SiteRef)
   if (!isTRUE(avg)) {
     # ordering choices to match order in points table and create a name for each choice
@@ -31,19 +34,19 @@ observeEvent(input$generate_results, priority = 100, {
   
   # Dynamic UI select choices that depends on previous select choice
   siteref <- head(siterefs, 1)
-  siteseries <- sort(
-    unique(
-      c(cciss_detailed[SiteRef == siteref]$`Site Series`,
-        cciss_summary[SiteRef == siteref]$`Site Series`
-      )
-    )
-  )
+  siteseries <- {
+    x <- c(cciss_detailed[SiteRef == siteref]$`Site Series`, cciss_summary[SiteRef == siteref]$`Site Series`)
+    x <- unique(x)
+    x <- sort(x)
+  }
+  
   updateSelectInput(inputId = ""siteref_feas"", choices = siterefs, selected = siteref)
   updateSelectInput(inputId = ""siteref_bgc_fut"", choices = siterefs, selected = siteref)
-  updateSelectInput(inputId = ""site_series_feas"", choices = siteseries)
+  updateSelectInput(inputId = ""siteref_silv"", choices = siterefs, selected = siteref)
+  updateSelectInput(inputId = ""site_series_feas"", choices = siteseries, selected = head(siteseries, 1))
+  updateSelectInput(inputId = ""site_series_silv"", choices = siteseries, selected = head(siteseries, 1))
   updateCheckboxGroupInput(inputId = ""report_filter"",choices = siteseries_all, selected = siteseries_all)
   
-  
   # Use ui injected javascript to show download button and hide generate button
   session$sendCustomMessage(type=""jsCode"", list(code= ""$('#download_span').show()""))
   session$sendCustomMessage(type=""jsCode"", list(code= ""$('#generate_results').prop('disabled', true)""))

---FILE: data-raw/scripts/create_package_data.R---
@@ -107,33 +107,18 @@ silvics_resist <- setDT(read_xlsx(""./data-raw/data_tables/StockingStds/EcoSilvic
 names(silvics_resist) <- c(""Life form"", ""Tree code"", ""Tree species"", ""Snow Resistance Class"", ""Wind Resistance Class"",
                            ""Fire Risk Class"", ""Insect Risk Class"", ""Fungi Risk Class"", ""Other Risk Class"")
 
-silvics <- merge(
-  x = silvics_tol,
-  y = silvics_regen[, .(`tree species`, `reproduction capacity`, `seed dissemination capacity`, `potential for regeneration`, `potential for regeneration in the open`, `potential for initial growth rate (over 5 years)`)],
-  by.x = ""Tree species"",
-  by.y = ""tree species"",
-  all.x = TRUE
-)
-
-silvics <- merge(
-  x = silvics,
-  y = silvics_mature[, .(`Tree species`, `response of advance regeneration to release`, `self- pruning capacity in dense stands`, `crown spatial requirements`, `light conditions beneath closed-canopy, mature stands`, `potential productivity`, longevity)],
-  by = ""Tree species"",
-  all.x = TRUE
-)
-
-silvics <- merge(
-  x = silvics,
-  y = silvics_resist[, .(`Tree species`, `Snow Resistance Class`, `Wind Resistance Class`, `Fire Risk Class`,`Insect Risk Class`,`Fungi Risk Class`,`Other Risk Class`)],
-  by = ""Tree species"",
-  all.x = TRUE
-)
-
-names(silvics) <- tools::toTitleCase(names(silvics))
+names(silvics_tol) <- tools::toTitleCase(names(silvics_tol))
+names(silvics_regen) <- tools::toTitleCase(names(silvics_regen))
+names(silvics_mature) <- tools::toTitleCase(names(silvics_mature))
+names(silvics_resist) <- tools::toTitleCase(names(silvics_resist))
 names(footnotes) <- tools::toTitleCase(names(footnotes))
 names(stocking_standards) <- tools::toTitleCase(names(stocking_standards))
 
-use_data(E1, S1, R1, F1, T1, V1, zones_colours_ref, subzones_colours_ref, stocking_standards, footnotes, silvics, overwrite = TRUE)
+use_data(E1, S1, R1, F1, T1, V1,
+         zones_colours_ref, subzones_colours_ref,
+         stocking_standards, footnotes,
+         silvics_tol, silvics_regen, silvics_mature, silvics_resist,
+         overwrite = TRUE)
 # see version in ?usethis::use_data, if you all use R 3.5 and up. You should bump to version 3
 # use_data(E1, S1, R1, F1, zones_colours_ref, subzones_colours_ref, overwrite = TRUE, version = 3)
 

---FILE: man/bccciss-data.Rd---
@@ -8,7 +8,10 @@
 \alias{footnotes}
 \alias{R1}
 \alias{S1}
-\alias{silvics}
+\alias{silvics_mature}
+\alias{silvics_regen}
+\alias{silvics_resist}
+\alias{silvics_tol}
 \alias{stocking_standards}
 \alias{subzones_colours_ref}
 \alias{T1}"
bcgov,CCISS_ShinyApp,2a30c10b7ecfadd775aef434bdd6dc5e8f824cde,Bruno Tremblay,meztez@neoxone.com,2021-03-18T12:26:32Z,Bruno Tremblay,meztez@neoxone.com,2021-03-18T12:26:32Z,fix doc,man/dbBbox.Rd;man/dbGetCCISS.Rd;man/dbPointInfo.Rd,False,False,False,False,5,6,11,"---FILE: man/dbBbox.Rd---
@@ -7,7 +7,7 @@
 dbBbox(con, points, buffer)
 }
 \arguments{
-\item{con}{An active postgre DBI connection.}
+\item{con}{An active postgres DBI connection.}
 
 \item{points}{A data.frame with two columns representing longitude
 (Long) and latitude (Lat) with GPS values (EPSG:4326)}

---FILE: man/dbGetCCISS.Rd---
@@ -4,13 +4,12 @@
 \alias{dbGetCCISS}
 \title{Pull CCISS from a vector of SiteNo}
 \usage{
-dbGetCCISS(con, points, avg, scn = c(""rcp45"", ""rcp85""))
+dbGetCCISS(con, siteno, avg, scn = c(""rcp45"", ""rcp85""))
 }
 \arguments{
-\item{con}{An active postgre DBI connection.}
+\item{con}{An active postgres DBI connection.}
 
-\item{points}{A data.frame with two columns representing longitude
-(Long) and latitude (Lat) with GPS values (EPSG:4326)}
+\item{siteno}{A character vector of siteno.}
 
 \item{avg}{A boolean.}
 

---FILE: man/dbPointInfo.Rd---
@@ -7,7 +7,7 @@
 dbPointInfo(con, points)
 }
 \arguments{
-\item{con}{An active postgre DBI connection.}
+\item{con}{An active postgres DBI connection.}
 
 \item{points}{A data.frame with two columns representing longitude
 (Long) and latitude (Lat) with GPS values (EPSG:4326)}"
bcgov,CCISS_ShinyApp,0f25fda58a7c2755b3a6dd79299e43d5e57a1dd9,Bruno Tremblay,meztez@neoxone.com,2021-03-18T04:21:54Z,Bruno Tremblay,meztez@neoxone.com,2021-03-18T04:21:54Z,fix futures legend and labels,app/server/common.R,False,True,True,False,3,2,5,"---FILE: app/server/common.R---
@@ -107,7 +107,6 @@ cciss_detailed <- function(cciss) {
 bgc_fut_plotly <- function(data) {
   l <- list(
     font = list(
-      family = ""BCSans"",
       size = 12,
       color = ""#000""),
     bgcolor = ""#E2E2E2"",
@@ -128,7 +127,9 @@ bgc_fut_plotly <- function(data) {
                   text = ~BGC.pred, textposition = 'inside', textfont = list(color = ""black"", size = 20),
                   texttemplate = ""%{text}"", hovertemplate = ""%{y}"") %>%
     plotly::layout(yaxis = list(title = """", tickformat = "".1%""),
-                   xaxis = list(showspikes = FALSE, title = list(text = ""Period"")),
+                   xaxis = list(showspikes = FALSE, title = list(text = ""Period""),
+                                ticktext = unname(tail(period_map, 4)),
+                                tickvals = names(tail(period_map, 4))),
                    barmode = 'stack', legend = l, hovermode = ""x unified"")
 }
 "
bcgov,CCISS_ShinyApp,3088ad9d991498326a4b4fe4bd7080442faca98b,Bruno Tremblay,meztez@neoxone.com,2021-03-14T02:55:01Z,Bruno Tremblay,meztez@neoxone.com,2021-03-14T02:55:01Z,"Encountered a bug while testing out locations with siteno CWHvh2, added allow.cartesian.",R/eda_overlap.R;data-raw/scripts/debug_shiny.R,False,True,True,False,5,1,6,"---FILE: R/eda_overlap.R---
@@ -44,7 +44,9 @@ edatopicOverlap <- function(BGC,Edatope){
   FutBGC <- FutBGC[!is.na(SS.pred),]
   setkey(FutBGC, SiteRef, FuturePeriod, BGC,BGC.pred, Codes)
   setkey(CurrBGC,SiteRef,FuturePeriod, BGC,BGC.pred, Codes)
-  new <- CurrBGC[FutBGC]
+  # ""CWHvh2"" BGC gives out Join results in 258 rows; more than 135 = nrow(x)+nrow(i), I'm
+  # setting it to allow.cartesian, might need to investigate.
+  new <- CurrBGC[FutBGC, allow.cartesian=TRUE]
   SSsp.out <- new[,.(allOverlap = 1/.N,SS.pred,BGC.prop), keyby = .(SiteRef,FuturePeriod,BGC,BGC.pred,SS_NoSpace)]
   
   ##regular site series edatopes

---FILE: data-raw/scripts/debug_shiny.R---
@@ -32,6 +32,8 @@ ui <- fixedPage(
   radioButtons(""aggregation"", ""Multiple Point Aggregation:"", c(""Individual"" = ""FALSE"", ""Averaged by BGC Zone"" = ""TRUE""), inline = TRUE),
   leafletOutput(""bec_map""),
   uiOutput(""ss_site_ref_select""),
+  uiOutput(""ss_legend""),
+  uiOutput(""species_suitability_summary""),
   uiOutput(""species_suitability_detailed""),
   uiOutput(""bgc_site_ref_select""),
   uiOutput(""bgc_futures""),"
bcgov,CCISS_ShinyApp,12bc725edd24c04aa942c10a768b999702aad02c,Bruno Tremblay,meztez@neoxone.com,2021-03-13T23:35:23Z,Bruno Tremblay,meztez@neoxone.com,2021-03-13T23:35:23Z,"Add suitability tables summary + detail. Couple layout fixes, labeling fixes, detect id in uploaded files, use it for marker label, change map markers.",R/data_etl.R;R/eda_overlap.R;R/suitability.R;R/z_data.R;app/index.Rmd;app/server/common.R;app/server/futures.R;app/server/map.R;app/server/points.R;app/server/silviculture.R;app/server/suitability.R;app/www/reorder-two.svg;app/www/swap-vertical.svg;app/www/trending-down.svg;app/www/trending-up.svg;data-raw/scripts/create_package_data.R;data-raw/scripts/debug_shiny.R;data/F1.rda;data/T1.rda;data/V1.rda;inst/htmlwidgets/bec-styling.js;man/bccciss-data.Rd;man/edatopicOverlap.Rd,True,True,True,False,379,549,928,"---FILE: R/data_etl.R---
@@ -34,9 +34,9 @@ dbGetHexID <- function(con, points) {
   
   hexid_sql <- paste0(""
   
-  SELECT DISTINCT siteno
+  SELECT cast(siteno as text) siteref
   FROM ("", paste0(""SELECT st_pointfromtext('"", txt, ""', 3005) geom"", collapse = ""\n UNION ALL \n"") ,"") pts
-  INNER JOIN hex_grid
+  LEFT JOIN hex_grid
   ON ST_Intersects(pts.geom, hex_grid.geom)
   
   "")

---FILE: R/eda_overlap.R---
@@ -19,15 +19,15 @@
 #dat = dat; Edatope = E1
 
 #' EDA Topic Overlap
-#' @param dat dat
+#' @param BGC BGC
 #' @param Edatope A data.table?
 #' @details What the function does
 #' @return What the function returns
 #' @import data.table
 #' @importFrom dplyr left_join distinct
 #' @importFrom stats complete.cases na.omit
 #' @export
-edatopicOverlap <- function(dat,Edatope){
+edatopicOverlap <- function(BGC,Edatope){
   SS <- Edatope[is.na(Special),.(BGC,SS_NoSpace,Edatopic)]
   SS <- unique(SS)
   BGC <- unique(BGC)
@@ -42,10 +42,10 @@ edatopicOverlap <- function(dat,Edatope){
   setnames(FutBGC, old = c(""BGC"",""SS_NoSpace"",""i.BGC""), 
            new = c(""BGC.pred"",""SS.pred"",""BGC""))
   FutBGC <- FutBGC[!is.na(SS.pred),]
-  setkey(FutBGC, SiteNo, FuturePeriod, BGC,BGC.pred, Codes)
-  setkey(CurrBGC,SiteNo,FuturePeriod, BGC,BGC.pred, Codes)
+  setkey(FutBGC, SiteRef, FuturePeriod, BGC,BGC.pred, Codes)
+  setkey(CurrBGC,SiteRef,FuturePeriod, BGC,BGC.pred, Codes)
   new <- CurrBGC[FutBGC]
-  SSsp.out <- new[,.(allOverlap = 1/.N,SS.pred,BGC.prop), keyby = .(SiteNo,FuturePeriod,BGC,BGC.pred,SS_NoSpace)]
+  SSsp.out <- new[,.(allOverlap = 1/.N,SS.pred,BGC.prop), keyby = .(SiteRef,FuturePeriod,BGC,BGC.pred,SS_NoSpace)]
   
   ##regular site series edatopes
   CurrBGC <- SS[BGC, on = ""BGC"", allow.cartesian = T]
@@ -58,51 +58,51 @@ edatopicOverlap <- function(dat,Edatope){
            new = c(""BGC.pred"",""SS.pred"",""BGC""))
   FutBGC <- na.omit(FutBGC)
   
-  setkey(FutBGC, SiteNo, FuturePeriod, BGC,BGC.pred, Edatopic)
+  setkey(FutBGC, SiteRef, FuturePeriod, BGC,BGC.pred, Edatopic)
   FutBGC[,BGC.prop := NULL]
  
-  setkey(CurrBGC,SiteNo,FuturePeriod, BGC,BGC.pred, Edatopic)
+  setkey(CurrBGC,SiteRef,FuturePeriod, BGC,BGC.pred, Edatopic)
   new <- dplyr::left_join(CurrBGC,FutBGC)#  was merge with, all = T bit failing with some predictions make sure not causing issue
-  setkey(new, SiteNo,FuturePeriod,BGC,BGC.pred,SS_NoSpace,SS.pred)
+  setkey(new, SiteRef,FuturePeriod,BGC,BGC.pred,SS_NoSpace,SS.pred)
   ##new <- new[complete.cases(new),]
   
   ###forwards overlap
   SS.out <- new[,.(SS.prob = .N), 
-                keyby = .(SiteNo,FuturePeriod,BGC,BGC.pred,SS_NoSpace,SS.pred)]
+                keyby = .(SiteRef,FuturePeriod,BGC,BGC.pred,SS_NoSpace,SS.pred)]
   SS.out2 <- new[,.(SS.Curr = length(unique(Edatopic)), BGC = unique(BGC.prop)), 
-                 keyby = .(SiteNo,FuturePeriod,BGC,BGC.pred,SS_NoSpace)]
+                 keyby = .(SiteRef,FuturePeriod,BGC,BGC.pred,SS_NoSpace)]
   comb <- SS.out2[SS.out]
   #comb <- comb %>% tidyr::drop_na()
   
   ###reverse overlap
   SS.out.rev <- new[,.(SS.prob = .N), 
-                    keyby = .(SiteNo,FuturePeriod,BGC,BGC.pred,SS.pred,SS_NoSpace)]
+                    keyby = .(SiteRef,FuturePeriod,BGC,BGC.pred,SS.pred,SS_NoSpace)]
   SS.out2.rev <- new[,.(SS.Curr = length(unique(Edatopic)), BGC = unique(BGC.prop)), 
-                     keyby = .(SiteNo,FuturePeriod,BGC,BGC.pred,SS.pred)]
+                     keyby = .(SiteRef,FuturePeriod,BGC,BGC.pred,SS.pred)]
   combRev <- SS.out2.rev[SS.out.rev]
   #combRev <- combRev %>% tidyr::drop_na()
   ##combine them
   comb[,SSProb := SS.prob/SS.Curr]
   combRev[,SSProbRev := SS.prob/SS.Curr]
-  combAll <- merge(comb,combRev,by = c(""SiteNo"",""FuturePeriod"",""BGC"",""BGC.pred"",""SS_NoSpace"",""SS.pred""))
+  combAll <- merge(comb,combRev,by = c(""SiteRef"",""FuturePeriod"",""BGC"",""BGC.pred"",""SS_NoSpace"",""SS.pred""))
   combAll <-combAll[!(combAll$BGC == combAll$BGC.pred  &  combAll$SS_NoSpace != combAll$SS.pred),] ### removes overlap where past BGC = future BGC
   combAll[,allOverlap := SSProb*SSProbRev]
   setnames(combAll, old = ""BGC.1.x"",new = ""BGC.prop"")
-  combAll <- combAll[,.(SiteNo, FuturePeriod, BGC, BGC.pred, SS_NoSpace, 
+  combAll <- combAll[,.(SiteRef, FuturePeriod, BGC, BGC.pred, SS_NoSpace, 
                         allOverlap, SS.pred, BGC.prop)]
   combAll <- rbind(combAll, SSsp.out)
   combAll <- combAll[!is.na(SS_NoSpace),] %>% dplyr::distinct()
 
   
   ##add in BGC probability
   combAll <- combAll[stats::complete.cases(combAll),]
-  combAll[,SSratio := allOverlap/sum(allOverlap), by = .(SiteNo, FuturePeriod, BGC, BGC.pred,SS_NoSpace)] ##should check this?
-  setorder(combAll, SiteNo, FuturePeriod, BGC, BGC.pred, SS_NoSpace)
+  combAll[,SSratio := allOverlap/sum(allOverlap), by = .(SiteRef, FuturePeriod, BGC, BGC.pred,SS_NoSpace)] ##should check this?
+  setorder(combAll, SiteRef, FuturePeriod, BGC, BGC.pred, SS_NoSpace)
   
   combAll <- unique(combAll)
-  setkey(combAll, SiteNo, FuturePeriod, BGC,BGC.pred)
-  temp <- unique(combAll[,.(SiteNo,FuturePeriod,BGC,BGC.pred,BGC.prop)])
-  temp[,BGC.prop := BGC.prop/sum(BGC.prop), by = .(SiteNo,FuturePeriod,BGC)]
+  setkey(combAll, SiteRef, FuturePeriod, BGC,BGC.pred)
+  temp <- unique(combAll[,.(SiteRef,FuturePeriod,BGC,BGC.pred,BGC.prop)])
+  temp[,BGC.prop := BGC.prop/sum(BGC.prop), by = .(SiteRef,FuturePeriod,BGC)]
   temp <- unique(temp)
   combAll[,BGC.prop := NULL]
   combAll <- temp[combAll]

---FILE: R/suitability.R---
@@ -33,15 +33,15 @@ ccissOutput <- function(SSPred,suit,rules,feasFlag){
   ## replace the coast/interior divisions of species
   suit <- unique(suit)
   suit <- na.omit(suit)
-  SSPred <- SSPreds[,.(SiteNo,FuturePeriod,BGC,SS_NoSpace,SS.pred,SSprob)]
-  Site_BGC <- unique(SSPred[,.(SiteNo,BGC)])
+  SSPred <- SSPred[,.(SiteRef,FuturePeriod,BGC,SS_NoSpace,SS.pred,SSprob)]
+  Site_BGC <- unique(SSPred[,.(SiteRef,BGC)])
   SSPred <- na.omit(SSPred)
   setkey(SSPred,SS.pred)
   setkey(suit,SS_NoSpace)
   suitMerge <- suit[SSPred, allow.cartesian = T]
   suitMerge <- na.omit(suitMerge)
   setnames(suitMerge, old = c(""SS_NoSpace"", ""i.SS_NoSpace""), new = c(""SS.pred"", ""SS_NoSpace""))
-  suitVotes <- data.table::dcast(suitMerge, SiteNo + Spp + FuturePeriod + SS_NoSpace ~ Feasible, 
+  suitVotes <- data.table::dcast(suitMerge, SiteRef + Spp + FuturePeriod + SS_NoSpace ~ Feasible, 
                                  value.var = ""SSprob"", fun.aggregate = sum)
   suitVotes[,VoteSum := `1`+`2`+`3`+`4`+`5`]
   suitVotes[,X := 1 - VoteSum]
@@ -54,12 +54,12 @@ ccissOutput <- function(SSPred,suit,rules,feasFlag){
   suitVotes[is.na(Curr), Curr := 5]
   suitVotes[,ModAgree := matrixStats::rowMaxs(as.matrix(.SD)), .SDcols = c(""1"",""2"",""3"",""X"")]
   suitVotes[,NewSuit := NewSuitNoCurr(as.matrix(.SD),c(1,2,3,5)), .SDcols = c(""1"",""2"",""3"",""X"")]
-  setorder(suitVotes,SiteNo,SS_NoSpace,Spp,FuturePeriod)
+  setorder(suitVotes,SiteRef,SS_NoSpace,Spp,FuturePeriod)
   suitVotes[,FuturePeriod := as.integer(FuturePeriod)]
   suitVotes[Curr > 3.5, Curr := 4]
   suitVotes[NewSuit > 3.5, NewSuit := 4]
-  suitVotes[,SuitDiff := stepDiff(FuturePeriod,NewSuit,Curr), by = .(SiteNo,SS_NoSpace,Spp)] ## final raw output table
-  suitVotes <- suitVotes %>% dplyr::select(SiteNo, Spp, FuturePeriod, SS_NoSpace, Curr, NewSuit, dplyr::everything() )
+  suitVotes[,SuitDiff := stepDiff(FuturePeriod,NewSuit,Curr), by = .(SiteRef,SS_NoSpace,Spp)] ## final raw output table
+  suitVotes <- suitVotes %>% dplyr::select(SiteRef, Spp, FuturePeriod, SS_NoSpace, Curr, NewSuit, dplyr::everything() )
   
   ##Generate summary feasibility from raw proportions
   histWt <- 0.3
@@ -72,7 +72,7 @@ ccissOutput <- function(SSPred,suit,rules,feasFlag){
   datFeas[FuturePeriod == 2000, (colNms) := lapply(.SD,""*"",currWt), .SDcols = colNms]##Write c function
   datFeas[FuturePeriod == 2025, (colNms) := lapply(.SD,""*"",earlyWt), .SDcols = colNms]
 
-  datFeas <- datFeas[,lapply(.SD, sum),.SDcols = colNms, by = .(SiteNo,SS_NoSpace,Spp,Curr)]
+  datFeas <- datFeas[,lapply(.SD, sum),.SDcols = colNms, by = .(SiteRef,SS_NoSpace,Spp,Curr)]
   datFeas2 <- datFeas
   ## ADD VARIABLE THAT IS 1-SUM OF 1-4 COLUMNS THAN ADD VALUE TO x COLUMN TO ACCOUNT FOR nULL FUTURES AND MAKE ROW SUM = 1
   datFeas2[,Xadj := rowSums(.SD), .SDcols = colNms]
@@ -93,13 +93,13 @@ ccissOutput <- function(SSPred,suit,rules,feasFlag){
   datFeas[Curr == 10 & NewSuit == 10, Flag := ""NotIn""]
   added <- c(""A1"", ""A2"", ""A3"")
   datFeas <- datFeas[Curr == 10 & (Flag %in% added), Curr := 4 ]
-  datFeas_final <- datFeas %>% dplyr::select(SiteNo,SS_NoSpace,Spp,Curr,NewSuit, SuitDiff, Flag) %>% dplyr::mutate(dplyr::across(NewSuit, round, 0))%>%
+  datFeas_final <- datFeas %>% dplyr::select(SiteRef,SS_NoSpace,Spp,Curr,NewSuit, SuitDiff, Flag) %>% dplyr::mutate(dplyr::across(NewSuit, round, 0))%>%
            dplyr::mutate(NewSuit = sub('10', 'X', NewSuit)) 
   
   #### use flag to update next section where species is added in current period
   datEarly <- suitVotes[FuturePeriod == 2025,]
   
-  datEarly <- datEarly[,lapply(.SD, sum),.SDcols = colNms, by = .(SiteNo,SS_NoSpace,Spp,Curr)]
+  datEarly <- datEarly[,lapply(.SD, sum),.SDcols = colNms, by = .(SiteRef,SS_NoSpace,Spp,Curr)]
   datEarly2 <- datEarly
   datEarly2 <- datEarly2 %>% dplyr::mutate(Suit2025 = `1` +(`2` * 2 ) + (`3` * 3) + (X * 4)) %>% dplyr::mutate (change2025 = Curr- Suit2025) %>% 
     dplyr::mutate(dplyr::across(Suit2025, round, 0)) %>% dplyr::mutate(Suit2025 = sub('4', 'X', Suit2025))
@@ -112,13 +112,13 @@ ccissOutput <- function(SSPred,suit,rules,feasFlag){
   datEarly2 <- datEarly2 %>% dplyr::mutate(FailRisk2025 = 
                                   ifelse(X>.5, ""High"", 
                                          ifelse(X>.2 & X<.5, ""Increased"", ""Normal"")))
-  datEarly3 <- datEarly2 %>% dplyr::select(SiteNo,SS_NoSpace,Spp, Curr, Suit2025,
+  datEarly3 <- datEarly2 %>% dplyr::select(SiteRef,SS_NoSpace,Spp, Curr, Suit2025,
                                        Trajectory2025, FailRisk2025)
   
    ###mid rotation (2055) compare to historic (trending down or up - flag where becoming unsuitable)
   datMid <- suitVotes[FuturePeriod == 2055,]
   
-  datMid <- datMid[,lapply(.SD, sum),.SDcols = colNms, by = .(SiteNo,SS_NoSpace,Spp,Curr)]
+  datMid <- datMid[,lapply(.SD, sum),.SDcols = colNms, by = .(SiteRef,SS_NoSpace,Spp,Curr)]
   datMid2 <- datMid
   datMid2 <- datMid2 %>% dplyr::mutate(Suit2055 = `1` +(`2` * 2 ) + (`3` * 3) + (X * 4)) %>% dplyr::mutate (change2055 = Curr- Suit2055) %>% 
     dplyr::mutate(dplyr::across(Suit2055, round, 0)) %>% dplyr::mutate(Suit2055 = sub('4', 'X', Suit2055))
@@ -131,13 +131,13 @@ ccissOutput <- function(SSPred,suit,rules,feasFlag){
   datMid2 <- datMid2 %>% dplyr::mutate(FailRisk2055 = 
                                   ifelse(X>.5, ""High"", 
                                          ifelse(X>.2 & X<.5, ""Increased"", ""Normal"")))
-  datMid3 <- datMid2 %>% dplyr::select(SiteNo,SS_NoSpace,Spp, Curr, Suit2055,
+  datMid3 <- datMid2 %>% dplyr::select(SiteRef,SS_NoSpace,Spp, Curr, Suit2055,
                                        Trajectory2055, FailRisk2055)
   
   ###end rotation (2085) compare to historic (trending down or up - flag where becoming unsuitable)
   datLong <- suitVotes[FuturePeriod == 2085,]
   
-  datLong <- datLong[,lapply(.SD, sum),.SDcols = colNms, by = .(SiteNo,SS_NoSpace,Spp,Curr)]
+  datLong <- datLong[,lapply(.SD, sum),.SDcols = colNms, by = .(SiteRef,SS_NoSpace,Spp,Curr)]
   datLong2 <- datLong
   datLong2 <- datLong2 %>% dplyr::mutate(Suit2085 = `1` +(`2` * 2 ) + (`3` * 3) + (X * 4)) %>% dplyr::mutate (change2085 = Curr- Suit2085) %>% 
     dplyr::mutate(dplyr::across(Suit2085, round, 0))%>% dplyr::mutate(Suit2085 = sub('4', 'X', Suit2085))
@@ -150,11 +150,11 @@ ccissOutput <- function(SSPred,suit,rules,feasFlag){
                                   ifelse(X>.5, ""High"", 
                                          ifelse(X>.2 & X<.5, ""Increased"", ""Normal"")))
   
-  datLong3 <- datLong2 %>% dplyr::select(SiteNo,SS_NoSpace,Spp,Curr, Suit2085, Trajectory2085, FailRisk2085)
+  datLong3 <- datLong2 %>% dplyr::select(SiteRef,SS_NoSpace,Spp,Curr, Suit2085, Trajectory2085, FailRisk2085)
   
-  summOut <- dplyr::full_join(datFeas_final, datEarly3, by = c('SiteNo','SS_NoSpace','Spp', 'Curr'))
-   summOut <- dplyr::full_join(summOut, datMid3, by = c('SiteNo','SS_NoSpace','Spp', 'Curr'))
- summOut <- dplyr::full_join(summOut, datLong3, by = c('SiteNo','SS_NoSpace','Spp', 'Curr')) %>% dplyr::filter(!Flag == 'NotIn')
+  summOut <- dplyr::full_join(datFeas_final, datEarly3, by = c('SiteRef','SS_NoSpace','Spp', 'Curr'))
+   summOut <- dplyr::full_join(summOut, datMid3, by = c('SiteRef','SS_NoSpace','Spp', 'Curr'))
+ summOut <- dplyr::full_join(summOut, datLong3, by = c('SiteRef','SS_NoSpace','Spp', 'Curr')) %>% dplyr::filter(!Flag == 'NotIn')
  summOut <-  summOut %>% dplyr::select (-SuitDiff, -Trajectory2025, -Trajectory2055,-Trajectory2085)
    ### merge in rulesets
   # ruleSub <- rules[Type == ""PeriodTraj"",]
@@ -171,9 +171,9 @@ ccissOutput <- function(SSPred,suit,rules,feasFlag){
   # ruleSub <- rules[Type == ""EstabRisk"",]
   # datFeas[ruleSub, Estab.Risk := i.Label, on = .(FeasEstab < mx, FeasEstab >= mn)]
   # 
-  # temp1 <- datFeas[,.(SiteNo,Spp,SS_NoSpace,Curr,NewSuit,Flag,Estab.Risk)]
-  # temp2 <- datMid[,.(SiteNo,Spp,SS_NoSpace,OverallTraj,ModAgree,Improve,Stable,Decline)]
-  # summOut <- merge(temp1,temp2, by = c(""SiteNo"",""Spp"",""SS_NoSpace""), all = T)
+  # temp1 <- datFeas[,.(SiteRef,Spp,SS_NoSpace,Curr,NewSuit,Flag,Estab.Risk)]
+  # temp2 <- datMid[,.(SiteRef,Spp,SS_NoSpace,OverallTraj,ModAgree,Improve,Stable,Decline)]
+  # summOut <- merge(temp1,temp2, by = c(""SiteRef"",""Spp"",""SS_NoSpace""), all = T)
   # summOut <- summOut[complete.cases(summOut),]
   # summOut[NewSuit > 3.5,NewSuit := 4]
   # summOut[Curr > 3.5,Curr := 4]

---FILE: R/z_data.R---
@@ -3,5 +3,5 @@
 #' @name bccciss-data
 #' @docType data
 #' @keywords data
-#' @aliases bec_info E1 F1 R1 S1 subzones_colours_ref zones_colours_ref
+#' @aliases bec_info E1 F1 R1 S1 subzones_colours_ref T1 V1 zones_colours_ref
 NULL

---FILE: app/index.Rmd---
@@ -35,7 +35,6 @@ onStop(function() {
 bcgov_tileserver <- Sys.getenv(""BCGOV_TILESERVER"")
 bcgov_tilelayer <- Sys.getenv(""BCGOV_TILELAYER"")
 if (is.null(bcgov_tileserver) || is.null(bcgov_tilelayer)) stop(""tileserver env not set"")
-
 ```
 
 
@@ -71,14 +70,32 @@ leafletOutput(""bec_map"", height = ""auto"")
 SPECIES SUITABILITY
 =====================================     
 
-### Species Suitability
+Inputs {.sidebar data-width=200}
+-------------------------------------
 
-Site Series
-{insert name of site series}
+### Site reference
+
+```{r}
+uiOutput(""ss_site_ref_select"")
+uiOutput(""ss_legend"")
+
+```
 
-Predicted Suitability
+Species Suitability {.tabset}
+-------------------------------------
+
+### Summary
+
+```{r}
+uiOutput(""species_suitability_summary"")
+
+```
+
+### Detailed
 
 ```{r}
+uiOutput(""species_suitability_detailed"")
+
 ```
    
 SILVICULTURE
@@ -111,7 +128,7 @@ uiOutput(""bgc_site_ref_select"")
 BGC Futures: ratio of models predicting BGC
 -------------------------------------
 
-### BGC Futures: ratio of models predicting BGC  
+### Ratio of Models Predicting BGC `r textOutput(""current_futures_bgc"", inline = TRUE)`
 
 ```{r}
 uiOutput(""bgc_futures"")
@@ -148,9 +165,10 @@ Copyright 2021 Province of British Columbia
 [LICENSE](http://www.apache.org/licenses/LICENSE-2.0)
 
 ```{r server, context = ""server""}
+source(""./server/common.R"", local = TRUE)
 source(""./server/points.R"", local = TRUE)
 source(""./server/map.R"", local = TRUE)
+source(""./server/suitability.R"", local = TRUE)
 source(""./server/futures.R"", local = TRUE)
-source(""./server/common.R"", local = TRUE)
 source(""./server/download.R"", local = TRUE)
 ```

---FILE: app/server/common.R---
@@ -1,3 +1,83 @@
+# Data
+
+bgc_react <- reactive({
+  avg <- input$aggregation
+  rcp <- input$rcp_scenario
+  # to invalidate reactive with points table change
+  # and force this value and all others that depends
+  # on it to recompute
+  pts_react <- input$points_table_rows_all
+  
+  pts <- uData$points[!is.na(Long) & !is.na(Lat), list(Long, Lat)]
+  if (nrow(pts) == 0) return(NULL)
+  res <- dbGetCCISS(pool, pts, as.logical(avg), rcp)
+  return(res[FuturePeriod > ""1975""])
+})
+
+cciss_react <- reactive({
+  bgc <- bgc_react()
+  if (is.null(bgc)) return(NULL)
+  SSPred <- edatopicOverlap(bgc, Edatope = E1)
+  ccissOutput(SSPred = SSPred, suit = S1, rules = R1, feasFlag = F1)
+})
+
+cciss_summary <- reactive({
+  cciss <- cciss_react()
+  if (is.null(cciss)) return(NULL)
+  cciss_summary <- cciss$Summary
+  # TODO
+  # Validate how they want the table to look like
+  cciss_summary[, Spp := T1[Spp, paste(TreeCode, EnglishName, sep = "": "")]]
+  setnames(
+    cciss_summary,
+    names(cciss_summary),
+    # Using &nbsp; as using DT::datatable options to set column width breaks display
+    c(""SiteRef"", ""Site Series"", ""Tree Species"",
+      ""Chief Forester Recommended Suitability"", ""Projected Feasibility"", ""Flag"",
+      ""Projected Feasibility 2025"", ""Fail Risk 2025"",
+      ""Projected Feasibility 2055"", ""Fail Risk 2055"",
+      ""Projected Feasibility 2085"", ""Fail Risk 2085"")
+  )
+  return(cciss_summary)
+})
+
+cciss_raw <- reactive({
+  cciss <- cciss_react()
+  if (is.null(cciss)) return(NULL)
+  cciss_raw <- cciss$Raw
+  period_map <- c(""2000"" = ""Current"", ""2025"" = ""2010-2040"", ""2055"" = ""2040-2070"", ""2085"" = ""2070-2100"")
+  cciss_raw[, `:=`(
+    NewSuit = round(NewSuit, 0),
+    SuitDiff = round(SuitDiff, 0),
+    SuitSVG = suitability_svg(`1`, `2`, `3`, `X`),
+    Period = period_map[as.character(FuturePeriod)])
+  ]
+  setorder(cciss_raw, SiteRef, SS_NoSpace, Spp, FuturePeriod)
+  cciss_raw <- cciss_raw[, list(
+    ""Site Series"" = SS_NoSpace,
+    ""Tree Species"" = T1[unique(Spp), paste(TreeCode, EnglishName, sep = "": "")],
+    ""&nbsp;&nbsp;Period&nbsp;&nbsp;"" = paste(Period, collapse = ""<br/>""),
+    ""Predicted Suitability"" =  paste(SuitSVG, collapse = ""<br/>""),
+    ""Chief Forester Recommended Suitability"" = Curr[FuturePeriod == 2000],
+    # TODO :
+    # How do you determine projected feasibility and what logic drive round flag color vs SuitDiff
+    ""Projected Feasibility"" = NewSuit[FuturePeriod == 2000],
+    # TODO :
+    # Validate trend logic
+    ""Continuing Trend at Mid Rotation (2040-2070)"" = suitability_trend(NewSuit),
+    ModAgree = mean(ModAgree, na.rm = TRUE)
+  ), by=c(""SiteRef"", ""SS_NoSpace"", ""Spp"")]
+  # some do not have a current value, setting it to 4
+  cciss_raw[is.na(`Chief Forester Recommended Suitability`), `Chief Forester Recommended Suitability` := 4]
+  cciss_raw[is.na(`Projected Feasibility`), `Projected Feasibility` := 4]
+  setorder(cciss_raw, SiteRef, SS_NoSpace, `Chief Forester Recommended Suitability`, `Projected Feasibility`, -ModAgree)
+  cciss_raw[, c(""Spp"", ""SS_NoSpace"", ""ModAgree"") := NULL]
+  cciss_raw
+})
+
+# Graph
+
+#' @param data BGC data.table
 cm_bcg_fplot <- function(data) {
   l <- list(
     font = list(
@@ -16,9 +96,97 @@ cm_bcg_fplot <- function(data) {
     names(col) <- colors$classification
     col
   }
-  plotly::plot_ly(data = data[FuturePeriod > ""1975""], x = ~FuturePeriod,
+  plotly::plot_ly(data = data, x = ~FuturePeriod,
                   y = ~BGC.prop, split = ~BGC.pred, type = 'bar',
                   color = ~BGC.pred, colors = color_ref) %>%
     plotly::layout(yaxis = list(title = """", tickformat = "".1%""),
                    barmode = 'stack', legend = l, hovermode = 'x unified')
 }
+
+#' @param ... a list of numeric vector, column names will be used as color. This
+#' function assumes that x rowSums are all equal to 1 and that there is no NA values.
+#' @param width output width of svg
+#' @param height output height of svg
+#' @param colors character vector of colors to use for svg, same length as
+#' ncol x.
+#' @return an svg image of suitability prediction, one per row in data.frame
+suitability_svg <- function(..., width = 200, height = 14, colors = c(""limegreen"", ""deepskyblue"", ""gold"", ""grey"")) {
+  x <- list(...)
+  col_x <- length(x)
+  x <- matrix(unlist(x), ncol = col_x)
+  row_x <- nrow(x)
+  row_cumsums <- matrixStats::rowCumsums(x)
+  pos_x <- cbind(integer(row_x), row_cumsums[,-col_x]) * width
+  width_el <- x * width
+  pos_text <- width_el / 2 + pos_x
+  svg <- paste0('<rect x=""', pos_x, '"" y=""0"" width=""', width_el, '"" height=""', height,'"" style=""fill: ', rep(colors, each = row_x), '""/><text text-anchor=""middle"" style=""font: 600 ', height / 2 + 2, 'px Arial"" x=""', pos_text, '"" y=""', height * 0.75, '"">', round(x*100,1), '%</text>')
+  svg <- vapply(1:row_x, function(i) {
+    paste0('<svg viewBox=""0 0 ', width,' ', height,'"" x=""0px"" y=""0px"" width=""', width,'px"" height=""', height,'px"">',
+           paste0(svg[seq(i, by = row_x, length.out = col_x)], collapse = """"),
+           '</svg>')
+  }, character(1))
+  return(svg)
+}
+
+suitability_legend <- function(text = c(""Primary"", ""Secondary"", ""Tertiary"", ""Not Suitable""),
+                               height = 14,
+                               colors = c(""limegreen"", ""deepskyblue"", ""gold"", ""grey"")) {
+  HTML(
+    paste0(
+      '<svg viewBox=""0 0 1 1"" height=""',
+      height,
+      'px"" width=""',
+      height,
+      'px""><rect height=1 width=1 style=""fill : ',
+      colors,
+      '""><span>&nbsp;',
+      text,
+      '</span>',
+      collapse = ""<br />""
+    )
+  )
+}
+
+#' Return a suitability trend icon
+#' @param x A numeric vector.
+#' @return a trend icon
+suitability_trend <- function(x) {
+  trends <- paste0('<img src=""www/', c(""swap-vertical"", ""trending-up"", ""trending-down"", ""reorder-two""),'.svg"" width=""30px"" height=""30px"" />')
+  mod <- head(x, -1) - tail(x, -1)
+  if (any(mod > 0) & any(mod < 0)) {
+    return(trends[1])
+  } else if (any(mod > 0)) {
+    return(trends[2])
+  } else if (any(mod < 0)) {
+    return(trends[3])
+  }
+  return(trends[4])
+}
+
+#' Return a suitability flag icon
+#' @param x A numeric vector.
+#' @return a flag icon
+suitability_flag <- function(x) {
+}
+
+# UI elements
+
+radio_select_siteref <- function(subid) {
+  renderUI({
+    b <- bgc_react()
+    avg <- input$aggregation
+    rcp <- paste(input$rcp_scenario, collapse = "", "")
+    if (is.null(b)) return(span(""Add points to generate selection menu.""))
+    choices <- unique(b$SiteRef)
+    if (!isTRUE(as.logical(avg))) {
+      IDs <- uData$points$ID[match(choices, uData$points$Site)]
+      IDs[is.na(IDs)] <- seq_len(length(IDs))[is.na(IDs)]
+      names(choices) <- paste(choices, IDs, sep = ""/"")
+    }
+    list(
+      radioButtons(paste(""current_siteref"", subid, sep = ""_""), label = ""Results:"", choices = choices),
+      span(""Averaged: "", br(), avg, br(), br(),
+           ""RCP scenratio: "", br(), rcp)
+    )
+  })
+}

---FILE: app/server/futures.R---
@@ -1,52 +1,28 @@
-bgc_react <- reactive({
-  avg <- input$aggregation
-  rcp <- input$rcp_scenario
-  # to invalidate reactive with points table change
-  # and force this value and all others that depends
-  # on it to recompute
-  pts_react <- input$points_table_rows_all
-  
-  pts <- uData$points[!is.na(Longitude) & !is.na(Latitude), list(Longitude, Latitude)]
-  if (nrow(pts) == 0) return(NULL)
-  withProgress({
-    incProgress(1)
-    res <- dbGetCCISS(pool, pts, as.logical(avg), rcp)
-    incProgress(2)
-  }, min = 0, max = 2, message = ""Fetching BGC futures"", detail = ""waiting for db"")
-  return(res)
-})
+output$bgc_site_ref_select <- radio_select_siteref(""bgc"")
 
-output$bgc_site_ref_select <- renderUI({
-  b <- bgc_react()
-  avg <- input$aggregation
-  rcp <- paste(input$rcp_scenario, collapse = "", "")
-  if (is.null(b)) return(span(""Add points to generate BGC Futures""))
-  list(
-    radioButtons(""current_siteref"", label = ""Results:"", choices = unique(b$SiteRef)),
-    span(""Averaged: "", br(), avg, br(), br(),
-         ""RCP scenratio: "", br(), rcp)
-  )
-})
-
-observeEvent(input$current_siteref, priority = 100, {
+observeEvent(input$current_siteref_bgc, priority = 100, {
   output$bgc_futures <- renderUI({
     b <- bgc_react()
-    siteref <- input$current_siteref
+    siteref <- input$current_siteref_bgc
     if (is.null(b)) return(NULL)
     b <- b[SiteRef == siteref]
     bgc <- unique(b$BGC)
-    list(span(paste(""Current BGC :"", bgc)), br(), br(),
-         plotly::plotlyOutput(""bgc_futures_plot"", width = ""100%"", height = ""100%""))
+    output$current_futures_bgc <- renderText(bgc)
+    plotly::plotlyOutput(""bgc_futures_plot"", width = ""100%"", height = ""100%"")
   })
 })
 
-observeEvent(input$current_siteref, priority = 50, {
-  b <- bgc_react()
-  siteref <- input$current_siteref
-  if (is.null(b)) return(NULL)
-  output$bgc_futures_plot <- renderPlotly({
-    b <- b[SiteRef == siteref]
-    bgc <- unique(b$BGC)
-    cm_bcg_fplot(b[BGC == bgc]) %>% plotly::layout(margin = list(b = 125))
-  })
+observeEvent(input$current_siteref_bgc, priority = 50, {
+  withProgress({
+    b <- bgc_react()
+    incProgress(1, message = ""Plotting BGC futures"", detail = """")
+    siteref <- input$current_siteref_bgc
+    if (is.null(b)) return(NULL)
+    output$bgc_futures_plot <- plotly::renderPlotly({
+      b <- b[SiteRef == siteref]
+      bgc <- unique(b$BGC)
+      cm_bcg_fplot(b[BGC == bgc])
+    })
+    incProgress(2, message = ""Done"", detail = """")
+  }, min = 0, max = 2, message = ""Fetching BGC futures"", detail = ""waiting for db"")
 })
\ No newline at end of file

---FILE: app/server/map.R---
@@ -32,7 +32,7 @@ plugins <- {
       name = ""leaflet.vectorgrid"",
       version = ""1.3.0"",
       src = system.file(""htmlwidgets"", package = ""bccciss""),
-      script = c(""lfx-vgrid-prod.js"", ""bec-styling.js"")
+      script = c(""lfx-vgrid-prod.js"")
     )
   )
 }
@@ -48,7 +48,8 @@ addVectorGridTilesDev <- function(map) {
   # https://leaflet.github.io/Leaflet.VectorGrid/vectorgrid-api-docs.html
   map <- htmlwidgets::onRender(map, paste0('
     function(el, x, data) {
-    
+      ', paste0(""var subzoneColors = {"", paste0(""'"", subzones_colours_ref$classification, ""':'"", subzones_colours_ref$colour,""'"", collapse = "",""), ""}""), '
+      ', paste0(""var zoneColors = {"", paste0(""'"", zones_colours_ref$classification, ""':'"", zones_colours_ref$colour,""'"", collapse = "",""), ""}""), '
       var vectorTileOptions=function(layerName, layerId, activ,
                              lfPane, colorMap, prop, id, opacity) {
         return {
@@ -164,16 +165,16 @@ clear_mk <- function() {
 }
 
 draw_mk <- function(data = uData$points) {
-  non_na_idx <- which(!is.na(data$Longitude) & !is.na(data$Latitude))
-  leaflet::addCircleMarkers(map_proxy, lng = ~Longitude, lat = ~Latitude,
-                            data = data[i = non_na_idx],
-                            radius = 9, color = ""#444"", fillColor = ""orangered"", stroke = TRUE,
-                            fillOpacity = 0.6, opacity = 0.8, weight = 2,
-                            popup = ~popups) 
+  non_na_idx <- which(!is.na(data$Long) & !is.na(data$Lat))
+  leaflet::addAwesomeMarkers(
+    map_proxy, data = data[i = non_na_idx], lng = ~Long, lat = ~Lat, 
+    icon = makeAwesomeIcon(icon = 'tree', markerColor = 'OrangeRed', library = 'fa', iconColor = '#FFF'),
+    popup = ~popups, label = ~ID
+  ) 
 }
 
 set_map_bound <- function(data = uData$points) {
-  bbox <- st_as_sf(data[, list(Longitude, Latitude)], coords = 1L:2L, crs = 4326) %>%
+  bbox <- st_as_sf(data[, list(Long, Lat)], coords = 1L:2L, crs = 4326) %>%
     sf::st_transform(3005) %>%
     sf::st_buffer(units::as_units(1, ""km""), nQuadSegs = 3) %>%
     sf::st_transform(4326) %>%
@@ -185,6 +186,6 @@ set_map_bound <- function(data = uData$points) {
 ## Map click logic
 observeEvent(input$bec_map_click, {
   pos <- input$bec_map_click
-  points <- new_points(data.table(Latitude = pos$lat, Longitude = pos$lng))
+  points <- new_points(data.table(Lat = pos$lat, Long = pos$lng))
   insert_points(points)
 })

---FILE: app/server/points.R---
@@ -7,48 +7,56 @@ DT_proxy <- DT::dataTableProxy(""points_table"")
 uData <- session$userData
 
 uData$points <- uData$basepoints <- data.table(
-  ID = integer(),
-  Latitude = numeric(),
-  Longitude = numeric(),
-  Elevation = numeric(),
+  ID = character(),
+  Site = character(),
+  Lat = numeric(),
+  Long = numeric(),
+  Elev = numeric(),
   BGC = character(),
   popups = character()
 )
 
+uData$pts_col <- 1L:ncol(uData$basepoints)
 ## Exclude popups column
+uData$pts_show_col <- 1L:(ncol(uData$basepoints) - 1L)
+
 output$points_table <- DT::renderDataTable({
   DT::datatable(
-    uData$points[j = 1L:5L], rownames = FALSE,
+    uData$points[,uData$pts_show_col, with = FALSE], rownames = FALSE,
     options = list(searching = FALSE, lengthChange = TRUE, pageLength = 5, scrollX = FALSE, scrollY = ""175px"", scrollCollapse = FALSE),
-    editable = list(target = ""row"", disable = list(columns = c(0,4)))
+    editable = list(target = ""row"", disable = list(columns = c(1,5)))
   )
 })
 
 ## DT methods
 update_DT <- function() {
-  DT::replaceData(DT_proxy, uData$points[j = 1L:5L], clearSelection = ""all"", rownames = FALSE)
+  DT::replaceData(DT_proxy, uData$points[,uData$pts_show_col, with = FALSE], clearSelection = ""all"", rownames = FALSE)
 }
 
 ## Points update logic
 update_ID <- function() {
-  uData$points[, ID := seq_len(nrow(uData$points))]
+  uData$points[is.na(ID), ID := as.character(seq_len(nrow(uData$points))[is.na(uData$points$ID)])]
 }
 
 new_points <- function(points) {
   beg <- nrow(points)
   withProgress(min = 0, max = 3, detail = ""Adding points ..."", {
     setProgress(1, message = ""Fetch points details"")
-    points <- points[!is.na(Longitude) & !is.na(Latitude)]
-    points[,`:=`(Longitude = round(Longitude, 5), Latitude = round(Latitude, 5))]
-    res <- dbGetBecInfo(pool, points[, list(Longitude, Latitude)])
+    points <- points[!is.na(Long) & !is.na(Lat)]
+    points[,`:=`(Long = round(Long, 5), Lat = round(Lat, 5))]
+    res <- dbGetBecInfo(pool, points[, list(Long, Lat)])
     points[, BGC := res$bgc_label]
+    points[, Site := dbGetHexID(pool, points[, list(Long, Lat)])]
     # TODO
     # Fetch elevation from where?
-    # points[is.na(Elevevation), Elevation := bcmaps::cded(...)]
+    # points[is.na(Elevevation), Elev := bcmaps::cded(...)]
     setProgress(2, message = ""Create popup info"")
-    popups <- res[, paste(""<b>"", names(.SD), "":</b>"", .SD, collapse = ""<br />""), by=1:NROW(res)]$V1
+    onbcland <- res$onbcland
+    popups <- res[, onbcland := NULL][, 
+      paste(""<b>"", tools::toTitleCase(gsub(""_"", "" "", names(.SD))), "":</b>"", .SD, collapse = ""<br />""),
+      by=1:NROW(res)]$V1
     points[, popups := sapply(popups, HTML)]
-    points <- points[!is.na(BGC) & res$onbcland]
+    points <- points[!is.na(BGC) & onbcland]
     points <- rbindlist(list(uData$basepoints, points), fill = TRUE)
     setProgress(3, message = ""Done"")
   })
@@ -72,7 +80,7 @@ insert_points <- function(points) {
     uData$points <- rbindlist(list(uData$points, points), fill = TRUE)
     update_ID()
     update_DT()
-    draw_mk(points)
+    draw_mk(tail(uData$points, nrow(points)))
   }
 }
 
@@ -93,18 +101,15 @@ observeEvent(input$points_upload,{
 insert_points_file <- function(datapath){
   # Columns detection using regular expression, hopefully column names have a match
   points <- fread(datapath)
-  lat_j <- head(grep(""^lat|latitude"", names(points), ignore.case = TRUE), 1)
-  lng_j <- head(grep(""^lng|^long|longitude"", names(points), ignore.case = TRUE), 1)
-  ele_j <- head(grep(""^elev|elevation"", names(points), ignore.case = TRUE), 1)
-  cln_j <- function(j) {
-    if (length(j) > 0) {
-      as.numeric(points[[j]])
-    } else {
-      NA_real_
-    }
-  }
-  points <- data.table(Longitude = cln_j(lng_j), Latitude = cln_j(lat_j),
-                       Elevation = cln_j(ele_j))
+  nm <- names(points)
+  id_j <- head(grep(""^id"", nm, ignore.case = TRUE), 1)
+  lat_j <- head(grep(""^lat|latitude"", nm, ignore.case = TRUE), 1)
+  lng_j <- head(grep(""^lng|^long|longitude"", nm, ignore.case = TRUE), 1)
+  ele_j <- head(grep(""^elev|elevation"", nm, ignore.case = TRUE), 1)
+  cln_j <- function(j) {if (length(j) > 0) {as.numeric(points[[j]])} else {NA_real_}}
+  clc_j <- function(j) {if (length(j) > 0) {as.character(points[[j]])} else {NA_character_}}
+  points <- data.table(ID = clc_j(id_j), Long = cln_j(lng_j), Lat = cln_j(lat_j),
+                       Elev = cln_j(ele_j))
   points <- new_points(points)
   insert_points(points)
   set_map_bound()
@@ -146,14 +151,16 @@ observeEvent(input$clear_button,{
 observeEvent(input$points_table_cell_edit, {
   info = input$points_table_cell_edit
   points <- data.table(
-    ID = as.numeric(info$value[1]),
-    Longitude = as.numeric(info$value[2]),
-    Latitude = as.numeric(info$value[3]),
-    Elevation = as.numeric(info$value[4])
+    ID = as.character(info$value[1]),
+    Site = as.character(1),
+    Lat = as.numeric(info$value[3]),
+    Long = as.numeric(info$value[4]),
+    Elev = as.numeric(info$value[5]),
+    BGC = as.character(1)
   )
   points <- new_points(points)
   if (nrow(points)) {
-    set(uData$points, info$row[1], points)
+    set(uData$points, i = info$row[1], j = uData$pts_col, value = points)
     clear_mk()
     draw_mk()
   }

---FILE: app/server/suitability.R---
@@ -0,0 +1,59 @@
+output$ss_site_ref_select <- radio_select_siteref(""ss"")
+output$ss_legend <- renderUI({
+  list(
+    br(),
+    span(""Legend""),
+    br(),
+    suitability_legend()
+  )
+})
+
+observeEvent(input$current_siteref_ss, priority = 100, {
+  siteref <- input$current_siteref_ss
+  output$species_suitability_summary <- renderUI({
+    DT::DTOutput(""species_suitability_summary_dt"", width = ""100%"", height = ""100%"")
+  })
+  output$species_suitability_detailed <- renderUI({
+    DT::DTOutput(""species_suitability_detailed_dt"", width = ""100%"", height = ""100%"")
+  })
+})
+
+observeEvent(input$current_siteref_ss, priority = 50, {
+  withProgress({
+    cciss_summary <- cciss_summary()
+    cciss_raw <- cciss_raw()
+    incProgress(1, message = ""Rendering table"", detail = """")
+    if (is.null(cciss_summary) || is.null(cciss_raw)) return(NULL)
+    siteref <- input$current_siteref_ss
+    output$species_suitability_summary_dt <- DT::renderDataTable({
+      cciss_summary <- cciss_summary[SiteRef == siteref]
+      DT::datatable(
+        cciss_summary[, SiteRef := NULL], escape = FALSE, rownames = FALSE,
+        options = list(
+          columnDefs = list(
+            list(className = 'dt-center', targets = 2:10),
+            list(width = ""150px"", targets = 1)
+          ),
+          autoWidth = TRUE,
+          scrollCollapse = FALSE
+        )
+      )
+    })
+    output$species_suitability_detailed_dt <- DT::renderDataTable({
+      cciss_raw <- cciss_raw[SiteRef == siteref]
+      DT::datatable(
+        cciss_raw[, SiteRef := NULL], escape = FALSE, rownames = FALSE,
+        options = list(
+          columnDefs = list(
+            list(className = 'dt-center', targets = 2:6),
+            list(width = ""150px"", targets = 1)
+          ),
+          autoWidth = TRUE,
+          scrollCollapse = FALSE
+        )
+      )
+    })
+    incProgress(2, message = ""Done"", detail = """")
+  }, min = 0, max = 2, message = ""CCISS"", detail = ""processing..."")
+})
+

---FILE: app/www/reorder-two.svg---
@@ -0,0 +1 @@
+<svg xmlns=""http://www.w3.org/2000/svg"" width=""512"" height=""512"" viewBox=""0 0 512 512""><title>ionicons-v5-p</title><line x1=""118"" y1=""304"" x2=""394"" y2=""304"" style=""fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:44px""/><line x1=""118"" y1=""208"" x2=""394"" y2=""208"" style=""fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:44px""/></svg>
\ No newline at end of file

---FILE: app/www/swap-vertical.svg---
@@ -0,0 +1 @@
+<svg xmlns=""http://www.w3.org/2000/svg"" width=""512"" height=""512"" viewBox=""0 0 512 512""><title>ionicons-v5-b</title><polyline points=""464 208 352 96 240 208"" style=""fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px""/><line x1=""352"" y1=""113.13"" x2=""352"" y2=""416"" style=""fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px""/><polyline points=""48 304 160 416 272 304"" style=""fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px""/><line x1=""160"" y1=""398"" x2=""160"" y2=""96"" style=""fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px""/></svg>
\ No newline at end of file

---FILE: app/www/trending-down.svg---
@@ -0,0 +1 @@
+<svg xmlns=""http://www.w3.org/2000/svg"" width=""512"" height=""512"" viewBox=""0 0 512 512""><title>ionicons-v5-c</title><polyline points=""352 368 464 368 464 256"" style=""fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px""/><path d=""M48,144,169.37,265.37a32,32,0,0,0,45.26,0l50.74-50.74a32,32,0,0,1,45.26,0L448,352"" style=""fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px""/></svg>
\ No newline at end of file

---FILE: app/www/trending-up.svg---
@@ -0,0 +1 @@
+<svg xmlns=""http://www.w3.org/2000/svg"" width=""512"" height=""512"" viewBox=""0 0 512 512""><title>ionicons-v5-c</title><polyline points=""352 144 464 144 464 256"" style=""fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px""/><path d=""M48,368,169.37,246.63a32,32,0,0,1,45.26,0l50.74,50.74a32,32,0,0,0,45.26,0L448,160"" style=""fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px""/></svg>
\ No newline at end of file

---FILE: data-raw/scripts/create_package_data.R---
@@ -3,15 +3,16 @@
 
 library(data.table)
 library(usethis)
-library(bcdata)
 E1 <- fread(""./data-raw/data_tables/Edatopic_v11_22.csv"")
 S1 <- fread(""./data-raw/data_tables/Feasibility_v11_22.csv"")
 R1 <- fread(""./data-raw/data_tables/RuleTable.csv"")
-F1 <- fread(""./data-raw/data_tables/FeasibilityLabels.csv"")
+F1 <- fread(""./data-raw/data_tables/FeasibilityLabels.csv"", key = ""SuitDiff"")
+T1 <- fread(""./data-raw/data_tables/Tree speciesand codes_2.0_2May2019.csv"", key = ""TreeCode"")
+V1 <- fread(""./data-raw/data_tables/Variables_ClimateBC.csv"", key = ""Code"")
 zones_colours_ref <- fread(""./data-raw/data_tables/WNAv11_Zone_Colours.csv"", key = ""classification"")
 subzones_colours_ref <- fread(""./data-raw/data_tables/WNAv11_Subzone_Colours.csv"", key = ""classification"")
 
-use_data(E1, S1, R1, F1, zones_colours_ref, subzones_colours_ref, overwrite = TRUE)
+use_data(E1, S1, R1, F1, T1, V1, zones_colours_ref, subzones_colours_ref, overwrite = TRUE)
 # see version in ?usethis::use_data, if you all use R 3.5 and up. You should bump to version 3
 # use_data(E1, S1, R1, F1, zones_colours_ref, subzones_colours_ref, overwrite = TRUE, version = 3)
 

---FILE: data-raw/scripts/debug_shiny.R---
@@ -31,17 +31,20 @@ ui <- fixedPage(
   selectInput(""rcp_scenario"", ""RCP Scenario:"", selected = ""rcp45"", c(""4.5"" = ""rcp45"", ""8.5"" = ""rcp85""), multiple = TRUE, width = 150),
   radioButtons(""aggregation"", ""Multiple Point Aggregation:"", c(""Individual"" = ""FALSE"", ""Averaged by BGC Zone"" = ""TRUE""), inline = TRUE),
   leafletOutput(""bec_map""),
+  uiOutput(""ss_site_ref_select""),
+  uiOutput(""species_suitability_detailed""),
   uiOutput(""bgc_site_ref_select""),
   uiOutput(""bgc_futures""),
   plotly::plotlyOutput(""bgc_futures_plot""),
   uiOutput(""downloadUI"")
 )
 
 server <- function(input, output, session) {
+  source(""./server/common.R"", local = TRUE)
   source(""./server/points.R"", local = TRUE)
   source(""./server/map.R"", local = TRUE)
+  source(""./server/suitability.R"", local = TRUE)
   source(""./server/futures.R"", local = TRUE)
-  source(""./server/common.R"", local = TRUE)
   source(""./server/download.R"", local = TRUE)
   
   onStop(function() {

---FILE: inst/htmlwidgets/bec-styling.js---
@@ -1,409 +0,0 @@
-var subzoneColors = {
-'BAFAun':'#E2F5F1',
-'BAFAunp':'#F0E1DD',
-'BGdh_OR':'#D85740',
-'BGdw_WA':'#B91D1A',
-'BGmk_MT':'#C6353D',
-'BGmm_MT':'#BE2E2C',
-'BGmw_WA':'#D4696E',
-'BGwm_WA':'#DC4E58',
-'BGxh_WA':'#DB1010',
-'BGxh1':'#D93949',
-'BGxh2':'#E03030',
-'BGxh3':'#E11923',
-'BGxw1':'#DA7775',
-'BGxw2':'#E67C7C',
-'BSJPap':'#7240D6',
-'BSJPku':'#8E6ECA',
-'BSJPpa':'#8234E8',
-'BWBScm':'#286AE2',
-'BWBSdk':'#7687E3',
-'BWBSdm':'#8398ED',
-'BWBSlb':'#1831F0',
-'BWBSlf':'#74A8E7',
-'BWBSmk':'#1633F0',
-'BWBSmw':'#5087EC',
-'BWBSnm':'#485CC9',
-'BWBSpp':'#444EDB',
-'BWBSub':'#151EC0',
-'BWBSuf':'#287DEC',
-'BWBSvk':'#2C3BE0',
-'BWBSwk1':'#7A88E2',
-'BWBSwk2':'#5B69C9',
-'BWBSwk3':'#5F5DCC',
-'CCHun_CA':'#65494D',
-'CDFmm':'#FAEA05',
-'CDFmm_OR':'#E1E42B',
-'CDFmm_WA':'#EBDE1B',
-'CDFxm_CA':'#FCFC1F',
-'CMAun':'#E8E9F3',
-'CMAun_CA':'#DEF2EA',
-'CMAun_OR':'#CFDECF',
-'CMAun_WA':'#EAEADA',
-'CMAunp':'#E4F3EA',
-'CMAwh':'#F3E9EE',
-'CMXdm_OR':'#CC87E9',
-'CMXwm_OR':'#DCA3DA',
-'CMXxm_CA':'#BB8FD6',
-'CRFdh_CA':'#891A14',
-'CVGdm_CA':'#EEEEA9',
-'CWFds_CA':'#3B73CE',
-'CWFmm_OR':'#0D47AB',
-'CWFwm_OR':'#2168CB',
-'CWHdm':'#63EF39',
-'CWHdm_OR':'#38EE56',
-'CWHdm_WA':'#2AEE37',
-'CWHds_WA':'#95D75B',
-'CWHds1':'#69D01B',
-'CWHds2':'#71D429',
-'CWHmh_OR':'#69E075',
-'CWHmm1':'#76E7B0',
-'CWHmm2':'#7EDD69',
-'CWHms_OR':'#53E33C',
-'CWHms_WA':'#33E15F',
-'CWHms1':'#65DC65',
-'CWHms2':'#87CB78',
-'CWHvh_WA':'#359041',
-'CWHvh1':'#1E9513',
-'CWHvh2':'#2DA82F',
-'CWHvh3':'#398E40',
-'CWHvm_OR':'#56A056',
-'CWHvm_WA':'#64CA55',
-'CWHvm1':'#51CE53',
-'CWHvm1_PR':'#51CE53',
-'CWHvm2':'#56AE42',
-'CWHwh_WA':'#32AF35',
-'CWHwh1':'#13D219',
-'CWHwh2':'#68E41A',
-'CWHwm':'#60C87B',
-'CWHws1':'#41E377',
-'CWHws2':'#41D45C',
-'CWHxm_OR':'#87EC91',
-'CWHxm_WA':'#A6F59A',
-'CWHxm1':'#85EA9D',
-'CWHxm2':'#5DD991',
-'ESSFab':'#AA39CF',
-'ESSFdc1':'#C45AD6',
-'ESSFdc2':'#B855CC',
-'ESSFdc3':'#B782DF',
-'ESSFdcp':'#8817DE',
-'ESSFdcw':'#9732DE',
-'ESSFdh_WA':'#591484',
-'ESSFdk_MT':'#AD21EE',
-'ESSFdk1':'#7015DF',
-'ESSFdk2':'#A622CE',
-'ESSFdkp':'#C27AD8',
-'ESSFdkp_MT':'#AA51CD',
-'ESSFdkw':'#5F2AF0',
-'ESSFdm_ID':'#5F2AF0',
-'ESSFdmp_ID':'#B074D0',
-'ESSFdv1':'#BC67DD',
-'ESSFdv2':'#CB7EE0',
-'ESSFdvp':'#981DC8',
-'ESSFdvw':'#A01DC8',
-'ESSFmc':'#C482D6',
-'ESSFmcp':'#B23AD3',
-'ESSFmh':'#CD79E0',
-'ESSFmk':'#A317D5',
-'ESSFmkp':'#B350D6',
-'ESSFmm1':'#B861D4',
-'ESSFmm2':'#AB2BCB',
-'ESSFmm3':'#C41BE5',
-'ESSFmmp':'#C684E7',
-'ESSFmmw':'#C360ED',
-'ESSFmv1':'#B54DD7',
-'ESSFmv2':'#BE79E2',
-'ESSFmv3':'#AD3FE4',
-'ESSFmv4':'#974CEB',
-'ESSFmvp':'#AF47CB',
-'ESSFmw':'#AB1CDF',
-'ESSFmw_WA':'#8710E1',
-'ESSFmw1':'#AE3AE0',
-'ESSFmw2':'#A16CD2',
-'ESSFmwp':'#BA6DD4',
-'ESSFmwp_WA':'#B635D6',
-'ESSFmww':'#E189D1',
-'ESSFun':'#921AD2',
-'ESSFunp':'#A52EEA',
-'ESSFvc':'#B525D1',
-'ESSFvcp':'#BF4DC9',
-'ESSFvcw':'#CE6AC4',
-'ESSFvh_ID':'#A117CF',
-'ESSFwc2':'#C31AED',
-'ESSFwc3':'#CA3FEC',
-'ESSFwc4':'#DB45EB',
-'ESSFwcp':'#B22DCF',
-'ESSFwcw':'#E613DC',
-'ESSFwh_MT':'#BF68CE',
-'ESSFwh1':'#CD35DA',
-'ESSFwh2':'#AF2CD6',
-'ESSFwh3':'#B125DB',
-'ESSFwk1':'#AC5BCF',
-'ESSFwk2':'#BC1CD8',
-'ESSFwm_MT':'#D97EE1',
-'ESSFwm1':'#D484EE',
-'ESSFwm2':'#B861CE',
-'ESSFwm3':'#D520EC',
-'ESSFwm4':'#C556E6',
-'ESSFwmp':'#C35AD8',
-'ESSFwmp_MT':'#B429CC',
-'ESSFwmw':'#E115BF',
-'ESSFwv':'#C031D3',
-'ESSFwvp':'#A13ACA',
-'ESSFxc_CO':'#A72FD2',
-'ESSFxc_WA':'#A76FCB',
-'ESSFxc1':'#A11ADA',
-'ESSFxc2':'#AE4AD6',
-'ESSFxc3':'#871FD0',
-'ESSFxcp':'#AD41EC',
-'ESSFxcp_CO':'#AA4FD8',
-'ESSFxcp_WA':'#AD61D0',
-'ESSFxcw':'#A553DF',
-'ESSFxh_WA':'#C97BEF',
-'ESSFxk_MT':'#D683DD',
-'ESSFxk_UT':'#A97ADC',
-'ESSFxkp_MT':'#A422D3',
-'ESSFxkp_UT':'#E981E9',
-'ESSFxv1':'#A881EB',
-'ESSFxv2':'#441AEC',
-'ESSFxvp':'#7145DE',
-'ESSFxvw':'#8C5FCA',
-'ESSFxw_OR':'#7230C8',
-'ESSFxwp_OR':'#D3689C',
-'FGff':'#DBB74A',
-'FGnf':'#C69B23',
-'FGwk':'#A07A19',
-'GBDdw_UT':'#B7B79A',
-'GBDxh_NV':'#7A7761',
-'GBDxx_UT':'#7D7B65',
-'GOun_CO':'#5D65D0',
-'ICHdh_ID':'#71D86B',
-'ICHdk':'#71DE73',
-'ICHdm':'#71EF65',
-'ICHdw_ID':'#1BE714',
-'ICHdw1':'#4AEF58',
-'ICHdw3':'#1CD52F',
-'ICHdw4':'#4DDF42',
-'ICHmc1':'#5CEE59',
-'ICHmc1a':'#80D07D',
-'ICHmc2':'#20DC3F',
-'ICHmh_MT':'#64C829',
-'ICHmk1':'#64E46F',
-'ICHmk2':'#0DDD18',
-'ICHmk3':'#0DDD0D',
-'ICHmk4':'#1DE11D',
-'ICHmk5':'#41CA3C',
-'ICHmm':'#39E639',
-'ICHmw_MT':'#86E869',
-'ICHmw1':'#45E732',
-'ICHmw2':'#96DB71',
-'ICHmw3':'#7CDC71',
-'ICHmw4':'#73D582',
-'ICHmw5':'#92E681',
-'ICHvc':'#81E689',
-'ICHvk_ID':'#66D83C',
-'ICHvk1':'#16E024',
-'ICHvk2':'#30DA4C',
-'ICHwc':'#6DE380',
-'ICHwk1':'#93D478',
-'ICHwk2':'#92E188',
-'ICHwk3':'#4CCC38',
-'ICHwk4':'#85DF62',
-'ICHxw':'#75E67D',
-'ICHxw_WA':'#75E67D',
-'ICHxwa':'#80CD1A',
-'IDFdc':'#DED822',
-'IDFdh_MT':'#AEB60F',
-'IDFdh_UT':'#DBE33C',
-'IDFdh_WA':'#DEEC18',
-'IDFdk_MT':'#D7E051',
-'IDFdk_WA':'#D0CC51',
-'IDFdk1':'#B2B24A',
-'IDFdk2':'#AFA818',
-'IDFdk3':'#C0B846',
-'IDFdk4':'#BEB80F',
-'IDFdk5':'#B0B012',
-'IDFdm_MT':'#DBD679',
-'IDFdm_WA':'#D5D66C',
-'IDFdm1':'#E9E56E',
-'IDFdm2':'#E9D924',
-'IDFdw':'#CEC622',
-'IDFdx_MT':'#DAD974',
-'IDFmw1':'#DDDA13',
-'IDFmw2':'#DDD313',
-'IDFww':'#E9E55C',
-'IDFww1':'#EFE937',
-'IDFxc':'#CEC819',
-'IDFxh_ID':'#E4EE21',
-'IDFxh_WA':'#DFDF27',
-'IDFxh1':'#E9E91D',
-'IDFxh2':'#D7DA0A',
-'IDFxh4':'#EBE51D',
-'IDFxk':'#E0EC6D',
-'IDFxm':'#E0EC6D',
-'IDFxm_CO':'#D4CF29',
-'IDFxw':'#E8E785',
-'IDFxx_MT':'#E0DF7D',
-'IDFxx_WA':'#E7E967',
-'IDFxx1':'#E6E375',
-'IDFxx2':'#E4E485',
-'IGFdk_WA':'#479EDC',
-'IGFdw_OR':'#4C9EDC',
-'IGFmm_OR':'#81B8D8',
-'IMAab':'#DFF8F1',
-'IMAun':'#E9E4F4',
-'IMAun_CO':'#EAEAD9',
-'IMAun_MT':'#E5E9F3',
-'IMAun_WA':'#F2EFFE',
-'IMAun_WY':'#EBF3F3',
-'IMAunp':'#EDECE1',
-'IWFdm_CO':'#1BD79C',
-'IWFdw_OR':'#77D0AD',
-'IWFxk_NV':'#3AE3A8',
-'IWFxm_CA':'#20DC85',
-'JPWdm_WY':'#9F677D',
-'JPWdw_UT':'#C58D8F',
-'JPWmk_WY':'#AA4A51',
-'JPWwm_CO':'#AD737F',
-'JPWxh_CA':'#9F5F6C',
-'JPWxw_NV':'#C37389',
-'MDCHun_NV':'#BD2F12',
-'MGPdm':'#BB8027',
-'MGPmg':'#BB8F3D',
-'MGPmw_MT':'#A76E1F',
-'MHdm_OR':'#7F0FEF',
-'MHds_OR':'#9A4DEC',
-'MHmm_WA':'#901B92',
-'MHmm1':'#A75FEF',
-'MHmm2':'#984FCB',
-'MHmmp':'#9A6BCD',
-'MHmmp_WA':'#C77DE7',
-'MHms_WA':'#A14EE4',
-'MHmsp_WA':'#B849E0',
-'MHRFdm_OR':'#74477A',
-'MHRFds_CA':'#80718A',
-'MHRFdsp_CA':'#602B83',
-'MHRFmm_OR':'#805FB2',
-'MHRFmmp_OR':'#5D1CD6',
-'MHun':'#924DD3',
-'MHunp':'#A748DA',
-'MHwh':'#B969D8',
-'MHwh1':'#C17DE3',
-'MHwhp':'#BB53EF',
-'MSab':'#D437A0',
-'MSab_N':'#D437A0',
-'MSdc1':'#E760AF',
-'MSdc2':'#F066E0',
-'MSdc3':'#CF2C5D',
-'MSdh_UT':'#D158A1',
-'MSdh_WY':'#E02DAB',
-'MSdk':'#D23E90',
-'MSdk_CO':'#E50F6F',
-'MSdm_WA':'#E03F9D',
-'MSdm1':'#E03A7A',
-'MSdm2':'#DB4FB8',
-'MSdm3':'#D12785',
-'MSdv':'#DC70AF',
-'MSdw':'#C96CAA',
-'MSdw_MT':'#DD0EA6',
-'MSmm_ID':'#DF49C9',
-'MSmw1':'#E421A0',
-'MSmw2':'#EC89DE',
-'MSSDun_NV':'#C6A48B',
-'MSxh_OR':'#D266AE',
-'MSxk_WA':'#D720A9',
-'MSxk1':'#DF82E3',
-'MSxk2':'#E133E1',
-'MSxk3':'#CD47BB',
-'MSxm_CO':'#E875AD',
-'MSxv':'#CB1B5E',
-'MSxx_NV':'#E88092',
-'OWun_CA':'#C4BD7D',
-'PPmx_WY':'#EF9C15',
-'PPxh_CO':'#F4A316',
-'PPxh_WA':'#E7AB1D',
-'PPxh1':'#DB8B28',
-'PPxh2':'#C36C09',
-'PPxh3':'#E18112',
-'PPxk_OR':'#D3730D',
-'PPxm_OR':'#E58714',
-'PPxw_MT':'#CD8F25',
-'PPxx_OR':'#D28212',
-'SASbo':'#2D4870',
-'SBAPcp':'#7AC0DC',
-'SBAPfp':'#1DA5E8',
-'SBAPmw':'#50D2D2',
-'SBPSdc':'#2AD1E0',
-'SBPSmc':'#3AC6CD',
-'SBPSmk':'#6AC6C9',
-'SBPSxc':'#76E4E5',
-'SBSdh1':'#29A9E4',
-'SBSdh2':'#129EE9',
-'SBSdk':'#6CBFEF',
-'SBSdw1':'#3EA8EA',
-'SBSdw2':'#0EBBE6',
-'SBSdw3':'#59A7E3',
-'SBSmc1':'#55B5F0',
-'SBSmc2':'#189EF1',
-'SBSmc3':'#2CB3EC',
-'SBSmh':'#86A7E0',
-'SBSmk1':'#6D8CD4',
-'SBSmk2':'#448CEA',
-'SBSmm':'#119DD8',
-'SBSmw':'#7AA2D5',
-'SBSun':'#2F93F0',
-'SBSvk':'#225D93',
-'SBSwk1':'#1479F4',
-'SBSwk2':'#3D8BF1',
-'SBSwk3':'#2979BE',
-'SBSwk3a':'#7A94E0',
-'SGPdm_CO':'#DED479',
-'SWBmk':'#92BEC2',
-'SWBmks':'#79AEB6',
-'SWBun':'#8DC4D2',
-'SWBuns':'#80CCD4',
-'SWBvk':'#A4BED3',
-'SWBvks':'#ADD5DE',
-'WJPxm_OR':'#D3B65D'
-}
-
-
-var zoneColors = {
-'BAFA':'#EEE4F1',
-'BG':'#DD1320',
-'CCH':'#7E22CA',
-'CDF':'#EDF418',
-'CMA':'#EAE1EE',
-'CMX':'#71D29E',
-'CRF':'#AF3A13',
-'CVG':'#C9EDD3',
-'CWF':'#7577E7',
-'CWH':'#488612',
-'ESSF':'#AE38B8',
-'FG':'#92696C',
-'GBD':'#4D433F',
-'GO':'#F0A325',
-'ICH':'#1FEC26',
-'IDF':'#E5D521',
-'IGF':'#77A2EB',
-'IMA':'#E3F1FA',
-'IWF':'#D44273',
-'JPW':'#96B3A5',
-'MDCH':'#2D0CD4',
-'MGP':'#F0AEAB',
-'MH':'#6F2997',
-'MHRF':'#2612DC',
-'MS':'#E44EBC',
-'MSSD':'#DAC370',
-'OW':'#582511',
-'PP':'#EA7200',
-'SBAP':'#51D5A7',
-'SGP':'#CCA261',
-'WJP':'#73330E',
-'SBPS':'#6EDDE9',
-'SBS':'#2F7BD2',
-'BWBS':'#4F54CF',
-'SWB':'#A1DBDE',
-'BSJP':'#424160',
-'SAS':'#92B1B6'
-}

---FILE: man/bccciss-data.Rd---
@@ -9,6 +9,8 @@
 \alias{R1}
 \alias{S1}
 \alias{subzones_colours_ref}
+\alias{T1}
+\alias{V1}
 \alias{zones_colours_ref}
 \title{Data to be included in bccciss package}
 \description{

---FILE: man/edatopicOverlap.Rd---
@@ -4,10 +4,10 @@
 \alias{edatopicOverlap}
 \title{EDA Topic Overlap}
 \usage{
-edatopicOverlap(dat, Edatope)
+edatopicOverlap(BGC, Edatope)
 }
 \arguments{
-\item{dat}{dat}
+\item{BGC}{BGC}
 
 \item{Edatope}{A data.table?}
 }"
bcgov,CCISS_ShinyApp,e8a1e172b7a0fa13022dd8466df59769a678ad63,Bruno Tremblay,meztez@neoxone.com,2021-03-11T03:32:14Z,Bruno Tremblay,meztez@neoxone.com,2021-03-11T03:32:14Z,do not deploy app with package to reduce package size as the app will be deployed on a shiny server. Couple bug fixes on map pane and rcp selection.,.Rbuildignore;.gitignore;R/bccciss.R;README.md;app/index.Rmd;app/server/common.R;app/server/download.R;app/server/futures.R;app/server/map.R;app/server/points.R;app/server/report.Rmd;app/www/favicon.ico;app/www/logo.svg;app/www/style.css;data-raw/scripts/bigshinygisstudio.R,True,True,True,False,43,55,98,"---FILE: .Rbuildignore---
@@ -14,3 +14,4 @@
 ^\.httr-oauth$
 ^\.mbtiles$
 ^scripts
+^app

---FILE: .gitignore---
@@ -15,4 +15,5 @@ inst/doc
 /data-raw/shp
 *.geojson
 .httr-oauth
-/inst/application/index.html
\ No newline at end of file
+/app/index.html
+/app/server/report.html
\ No newline at end of file

---FILE: R/bccciss.R---
@@ -1,3 +1,3 @@
 # import compiled code from this package
 #' @useDynLib bccciss, .registration = TRUE
-NULL
+NULL
\ No newline at end of file

---FILE: README.md---
@@ -24,6 +24,10 @@ remotes::install_github(""bcgov/CCISS_ShinyApp"")
 
 #### R packages folders
 
+##### app
+
+CCISS Flexdashboard app
+
 ##### data
 Standard R package folder for the
 [Data in packages](https://cran.r-project.org/doc/manuals/R-exts.html#Data-in-packages).
@@ -39,8 +43,7 @@ the package repository.
 
 ##### inst
 Standard R package folder. The contents of the `inst` subdirectory will be copied recursively
-to the installation directory. This would be where you put your `Shiny` app or `plumber` api with
-there required assets. Again, this is described in
+to the installation directory. This is described in
 [Data in packages](https://cran.r-project.org/doc/manuals/R-exts.html#Data-in-packages)
 
 ##### man
@@ -56,11 +59,6 @@ will be included with the package when it is built.
 [Also standard](https://cran.r-project.org/doc/manuals/R-exts.html#Non_002dR-scripts-in-packages).
 Code which needs to be compiled.
 
-##### tests
-The fun part. [Tests are a great way](https://testthat.r-lib.org/) to make sure changes do not
-break package behavior. Writing tests is pretty straightforward and should be done as you
-build functions. You are doing it anyway, might as well make it a test.
-
 #### Building packages
 R is a great community. There is a lot of great resources on how to build packages. I highly
 recommend [R packages by Hadley Wickham and Jenny Bryan](https://r-pkgs.org/).

---FILE: app/index.Rmd---
@@ -32,9 +32,9 @@ pool <- dbPool(
 onStop(function() {
   poolClose(pool)
 })
-tileserver <- Sys.getenv(""BCGOV_TILESERVER"")
-tilelayer <- Sys.getenv(""BCGOV_TILELAYER"")
-if (is.null(tileserver) || is.null(tilelayer)) stop(""tileserver env not set"")
+bcgov_tileserver <- Sys.getenv(""BCGOV_TILESERVER"")
+bcgov_tilelayer <- Sys.getenv(""BCGOV_TILELAYER"")
+if (is.null(bcgov_tileserver) || is.null(bcgov_tilelayer)) stop(""tileserver env not set"")
 
 ```
 
@@ -140,22 +140,12 @@ Shiny app information {data-navmenu=""ABOUT""}
 
 Shiny host: `r system(""hostname"", intern = TRUE)`  
 Database host: `r Sys.getenv(""BCGOV_HOST"")`  
-Tiles source: `r Sys.getenv(""BCGOV_TILESERVER"")`
+Tiles source: `r Sys.getenv(""BCGOV_TILESERVER"")`  
 Github: [bcgov/CCISS_ShinyApp](https://github.com/bcgov/CCISS_ShinyApp/tree/code_with_us)  
   
 Copyright 2021 Province of British Columbia  
   
-Licensed under the Apache License, Version 2.0 (the ""License"");
-you may not use this file except in compliance with the License.
-You may obtain a copy of the License at  
-  
-http://www.apache.org/licenses/LICENSE-2.0
-  
-Unless required by applicable law or agreed to in writing, software
-distributed under the License is distributed on an ""AS IS"" BASIS,
-WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-See the License for the specific language governing permissions and
-limitations under the License.  
+[LICENSE](http://www.apache.org/licenses/LICENSE-2.0)
 
 ```{r server, context = ""server""}
 source(""./server/points.R"", local = TRUE)

---FILE: app/server/download.R---
@@ -1,9 +1,6 @@
 output$downloadUI <- renderUI({
-  # to invalidate reactive with points table change
-  # and force this value and all others that depends
-  # on it to recompute
-  pts_react <- input$points_table_rows_all
-  if (is.null(bgc_react())) {
+  bgc <- bgc_react()
+  if (is.null(bgc)) {
     return(span(""Add points to generate report.""))
   }
   style <- ""max-width: 300px; width:100%; height: 40px !important;""

---FILE: app/server/futures.R---
@@ -16,39 +16,36 @@ bgc_react <- reactive({
   return(res)
 })
 
-output$bgc_site_ref_select <- renderUI({span(""Add points to generate BGC Futures"")})
-
-observeEvent(input$points_table_rows_all, {
-  output$bgc_site_ref_select <- renderUI({
-    b <- bgc_react()
-    if (is.null(b)) return(
-      span(""Add points to generate BGC Futures"")
-    )
-    list(
-      radioButtons(""current_siteref"", label = ""Results:"", choices = unique(b$SiteRef)),
-      span(""Averaged: "", input$aggregation, br(),
-           ""RCP scenratio: "", input$rcp_scenario)
-    )
-  })
+output$bgc_site_ref_select <- renderUI({
+  b <- bgc_react()
+  avg <- input$aggregation
+  rcp <- paste(input$rcp_scenario, collapse = "", "")
+  if (is.null(b)) return(span(""Add points to generate BGC Futures""))
+  list(
+    radioButtons(""current_siteref"", label = ""Results:"", choices = unique(b$SiteRef)),
+    span(""Averaged: "", br(), avg, br(), br(),
+         ""RCP scenratio: "", br(), rcp)
+  )
 })
 
 observeEvent(input$current_siteref, priority = 100, {
   output$bgc_futures <- renderUI({
     b <- bgc_react()
+    siteref <- input$current_siteref
     if (is.null(b)) return(NULL)
-    b <- b[SiteRef == input$current_siteref]
+    b <- b[SiteRef == siteref]
     bgc <- unique(b$BGC)
     list(span(paste(""Current BGC :"", bgc)), br(), br(),
-         plotly::plotlyOutput(""bgc_futures_plot"", width = ""100%"", height = ""100%""),
-         span(""Page close test""))
+         plotly::plotlyOutput(""bgc_futures_plot"", width = ""100%"", height = ""100%""))
   })
 })
-  
+
 observeEvent(input$current_siteref, priority = 50, {
   b <- bgc_react()
+  siteref <- input$current_siteref
   if (is.null(b)) return(NULL)
   output$bgc_futures_plot <- renderPlotly({
-    b <- b[SiteRef == input$current_siteref]
+    b <- b[SiteRef == siteref]
     bgc <- unique(b$BGC)
     cm_bcg_fplot(b[BGC == bgc]) %>% plotly::layout(margin = list(b = 125))
   })

---FILE: app/server/map.R---
@@ -73,13 +73,13 @@ addVectorGridTilesDev <- function(map) {
       };
     
       var zLayer = L.vectorGrid.protobuf(
-        ""', tileserver, '"",
-        vectorTileOptions(""bec_z"", ""', tilelayer, '"", true,
+        ""', bcgov_tileserver, '"",
+        vectorTileOptions(""bec_z"", ""', bcgov_tilelayer, '"", true,
                           ""overlayPane"", zoneColors, ""ZONE"", ""OBJECTID"", 0.85)
       )
       var subzLayer = L.vectorGrid.protobuf(
-        ""', tileserver, '"",
-        vectorTileOptions(""bec_subz"", ""', tilelayer, '"", true,
+        ""', bcgov_tileserver, '"",
+        vectorTileOptions(""bec_subz"", ""', bcgov_tilelayer, '"", true,
                           ""overlayPane"", subzoneColors, ""MAP_LABEL"", ""OBJECTID"", 0.5)
       )
       this.layerManager.addLayer(zLayer, ""tile"", ""bec_z"", ""Zones"")

---FILE: app/server/report.Rmd---
@@ -21,6 +21,10 @@ When you click the **Knit** button a document will be generated that includes bo
 params$points
 ```
 
+## Quotes test
+
+""Quotes""
+
 ## Including Plots
 
 You can also embed plots, for example:

---FILE: data-raw/scripts/bigshinygisstudio.R---
@@ -101,10 +101,10 @@ analogsea::droplet_ssh(server, ""R -e \""install.packages('remotes')\"""")
 server <- analogsea::droplets()$BigShinyGisStudio
 analogsea::droplet_ssh(server, ""mkdir /srv/shiny-server/cciss"")
 analogsea::droplet_ssh(server, ""R -e \""remotes::install_github('bcgov/CCISS_ShinyAPP@code_with_us', upgrade = TRUE, dependencies = TRUE, force = TRUE)\"""")
-analogsea::droplet_upload(server, ""./inst/application/index.Rmd"", ""/srv/shiny-server/cciss/index.Rmd"")
+analogsea::droplet_upload(server, ""./app/index.Rmd"", ""/srv/shiny-server/cciss/index.Rmd"")
 analogsea::droplet_ssh(server, ""rm /srv/shiny-server/cciss/index.html"")
-analogsea::droplet_upload(server, ""./inst/application/www"", ""/srv/shiny-server/cciss"")
-analogsea::droplet_upload(server, ""./inst/application/server"", ""/srv/shiny-server/cciss"")
+analogsea::droplet_upload(server, ""./app/www"", ""/srv/shiny-server/cciss"")
+analogsea::droplet_upload(server, ""./app/server"", ""/srv/shiny-server/cciss"")
 analogsea::droplet_ssh(server, ""chown -R shiny:shiny /srv/shiny-server"")
 
 utils::browseURL(paste0(""http://"", analogsea:::droplet_ip_safe(server), ""/shiny/cciss""))"
bcgov,CCISS_ShinyApp,d0190aebd7f83cd61cff3334d41d44cf4fbf2393,Bruno Tremblay,meztez@neoxone.com,2021-03-10T06:10:02Z,Bruno Tremblay,meztez@neoxone.com,2021-03-10T06:10:02Z,fix app on mobile and regular Shiny,inst/application/index.Rmd;inst/application/www/style.css,True,False,True,False,6,3,9,"---FILE: inst/application/index.Rmd---
@@ -7,6 +7,7 @@ output:
     logo: www/logo.svg
     favicon: www/favicon.ico
     theme: yeti
+    css: www/style.css
 runtime: shiny_prerendered
 ---
 
@@ -38,7 +39,7 @@ onStop(function() {
 BEC MAP
 =====================================  
 
-Inputs {.sidebar data-width=500}
+Inputs {.sidebar data-width=450}
 -------------------------------------
 
 #### Points
@@ -65,8 +66,7 @@ span(""Shiny host: "", system(""hostname"", intern = TRUE), br(),
 Biogeoclimatic Zones + Subzones Variants Map
 -------------------------------------
 ```{r}
-# Remove width and height for use in regular Shiny app, it messes up the map
-leafletOutput(""bec_map"", width = ""100%"", height = ""100%"")
+leafletOutput(""bec_map"", height = ""auto"")
 
 ```
 

---FILE: inst/application/www/style.css---
@@ -0,0 +1,3 @@
+#bec_map {
+  min-height: 400px;
+}
\ No newline at end of file"
