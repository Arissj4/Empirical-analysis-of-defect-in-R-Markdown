repo_owner,repo_name,commit_hash,author_name,author_email,author_date,committer_name,committer_email,committer_date,message,filenames,touches_rmd,touches_r,touches_r_or_rmd,is_merge,added,deleted,changed,diff
tsahota,NMproject,52561ef20f38f0481c9bf5e24a1bfbe61003ec55,tarjinde,tarjinder.z.sahota@gsk.com,2022-09-05T18:12:52Z,tarjinde,tarjinder.z.sahota@gsk.com,2022-09-05T18:12:52Z,doc fix,R/run_nm.R;man/run_nm.Rd,False,True,True,False,0,5,5,"---FILE: R/run_nm.R---
@@ -212,8 +212,6 @@ run_nm_single.nm_list <- Vectorize_nm_list(run_nm_single.nm_generic, SIMPLIFY =
 #' @inheritParams run_nm_single
 #' @param threads Numeric.  Number of jobs to run concurrently (default =
 #'   `Inf`).  Will block the console until all jobs are submitted.
-#' @param single_batch_job Logical. Should all runs be submitted as a single
-#'   system command?
 #'
 #' @details In grid environment it is recommended to run [nm_tran()] via the
 #'   RStudio 'Addin' prior to executing this code.

---FILE: man/run_nm.Rd---
@@ -39,9 +39,6 @@ contents with cache?}
 
 \item{cache_ignore_data}{Logical (default = \code{FALSE}). Should check dataset with
 cache?}
-
-\item{single_batch_job}{Logical. Should all runs be submitted as a single
-system command?}
 }
 \value{
 \code{m} with \code{job_info} fields populated."
tsahota,NMproject,edd666a36aef38db4d5c3c510d1e8e38417e4db7,tarjinde,tarjinder.z.sahota@gsk.com,2022-08-29T15:27:22Z,tarjinde,tarjinder.z.sahota@gsk.com,2022-08-29T15:27:22Z,Prevented `summary()` from treating parameters as different if FIX status is different,R/post-run-summaries.R,False,True,True,False,1,12,13,"---FILE: R/post-run-summaries.R---
@@ -631,18 +631,6 @@ summary.nm_list <- function(object, ref_model = NA, parameters = c(""none"", ""new""
     ds <- split(d, seq_len(nrow(d)))
 
     ds <- lapply(ds, function(d) {
-      # rri <- rr(c(d$parent,d$m), ...)
-      # rri <- rri[grepl(""THETA|OMEGA|SIGMA"", rri$type), ]
-      #
-      # index <- !rri$unit %in% """" & !is.na(rri$unit)
-      # rri$parameter[index] <-
-      #   paste0(rri$parameter[index], "" ("", rri$unit[index], "")"")
-      #
-      # if(""trans"" %in% names(rri)){
-      #   index <- !rri$trans %in% """" & !is.na(rri$trans)
-      #   rri$parameter[index] <-
-      #     paste0(rri$parameter[index], "" ("", rri$trans[index],"")"")
-      # }
 
       rri <- rr2(c(d$parent, d$m), ...)
       rri$type <- NULL
@@ -1135,6 +1123,7 @@ rr2 <- function(m, trans = TRUE) {
     dplyr::mutate(par_no = max(.data$par_no))
   
   m_names <- unique(d$run_name)
+  d$FIX <- NULL ## don't want FIX to split rows that should match
   d <- d %>% tidyr::pivot_wider(names_from = ""run_name"", values_from = ""estimate"")
   names1 <- names(d)[!names(d) %in% m_names]
   d <- d[, c(names1, m_names)]"
tsahota,NMproject,4eb2a1c9c2f8d2e679b8e71c62a27e446790d716,tarjinde,tarjinder.z.sahota@gsk.com,2022-08-17T13:32:15Z,tarjinde,tarjinder.z.sahota@gsk.com,2022-08-17T13:32:15Z,trans = FALSE coef fix,R/post-run-summaries.R,False,True,True,False,1,1,2,"---FILE: R/post-run-summaries.R---
@@ -390,7 +390,7 @@ coef.nm_generic <- function(object, trans = TRUE, ...) {
   
   if (!trans) {
     ## add FIX column and return
-    d <- merge(d, d1[, c(""parameter"", ""FIX"")] , sort = FALSE)
+    d <- merge(d, d1[, c(""parameter"", ""FIX"")] , sort = FALSE, all.x = TRUE)
     d <- dplyr::as_tibble(d)
     return(d)
   }"
tsahota,NMproject,678d9e6245200d7b554936623a869402e4e7edae,tarjinde,tarjinder.z.sahota@gsk.com,2022-07-22T15:51:14Z,tarjinde,tarjinder.z.sahota@gsk.com,2022-07-22T15:51:14Z,but fix where FIX column wasn't appearing if trans = FALSE,R/post-run-summaries.R,False,True,True,False,7,3,10,"---FILE: R/post-run-summaries.R---
@@ -382,15 +382,19 @@ coef.nm_generic <- function(object, trans = TRUE, ...) {
   d$run_name <- gsub(""execute\\."", ""\\1"", unique_id(object))
   if (!unique(d$is_final)) d$run_name <- paste0(d$run_name, ""*"")
   d$is_final <- NULL
-  if (!trans) {
-    return(d)
-  }
   
   p <- param_info2(object)
   
   d0 <- d[, names(d)[!names(d) %in% ""unit""]]
   d1 <- p[, c(""name"", ""parameter"", ""unit"", ""trans"", ""FIX"")]
   
+  if (!trans) {
+    ## add FIX column and return
+    d <- merge(d, d1[, c(""parameter"", ""FIX"")] , sort = FALSE)
+    d <- dplyr::as_tibble(d)
+    return(d)
+  }
+  
   d <- merge(d0, d1, all.x = TRUE, by = ""parameter"", sort = FALSE)
   d$name[is.na(d$name)] <- as.character(d$parameter)[is.na(d$name)]
   d$name <- factor(d$name, levels = unique(d$name))"
tsahota,NMproject,a8aff74296f57bb4b88fc2d3100257cc535f5beb,tarjinde,tarjinder.z.sahota@gsk.com,2022-07-22T12:06:47Z,tarjinde,tarjinder.z.sahota@gsk.com,2022-07-22T12:37:10Z,Fixed bug when OMEGAS have same names as THETAS,NEWS.md;R/post-run-summaries.R,False,True,True,False,7,2,9,"---FILE: NEWS.md---
@@ -40,6 +40,8 @@
   
 * Replaced caching mechanism of `nm_render()` and `nm_list_render()` with xfun.
 
+* Fixed bug when OMEGAS have same names as THETAS.
+
 # NMproject 0.6.7
 
 * Added ability to use NMproject-specific code completion snippets `setup_code_completion()`.

---FILE: R/post-run-summaries.R---
@@ -148,7 +148,10 @@ rr.nm_list <- function(m, trans = TRUE) {
   d$param_flag <- NULL
   d$Estimate[d$FIX %in% TRUE] <- gsub(""\\(.*?\\)"", ""(FIX)"", d$Estimate[d$FIX %in% TRUE])
   d <- d[, names(d)[!names(d) %in% c(""SE"", ""FINAL"")]]
-  d <- d %>% tidyr::pivot_wider(names_from = ""run_name"", values_from = ""Estimate"")
+    
+  d <- d %>% tidyr::pivot_wider(names_from = ""run_name"", values_from = ""Estimate"", values_fn = list) %>%
+    tidyr::unnest(!c(""parameter"",""type"",""SEunit"", ""unit"",""trans"",""FIX""))  ## all columns apart from estimate
+  
   d <- as.data.frame(d)
   ## fix ordering of columns so it's same as m - dcast ruins it
   non_matches <- names(d)[!seq_along(names(d)) %in% match(unique_id(m), names(d))]
@@ -389,7 +392,7 @@ coef.nm_generic <- function(object, trans = TRUE, ...) {
   
   d <- merge(d0, d1, all.x = TRUE, by = ""parameter"", sort = FALSE)
   d$name[is.na(d$name)] <- as.character(d$parameter)[is.na(d$name)]
-  d$name <- factor(d$name, levels = d$name)
+  d$name <- factor(d$name, levels = unique(d$name))
   d$trans_unit <- d$unit
   d$transSEunit <- d$SEunit
   ## transformations"
tsahota,NMproject,88c49bc8ced348724d80c63b44d64b6ebc76b70a,tarjinde,tarjinder.z.sahota@gsk.com,2022-05-30T12:07:41Z,tarjinde,tarjinder.z.sahota@gsk.com,2022-05-30T12:07:41Z,spelling fix,vignettes/articles/a04_code_library.Rmd,True,False,True,False,1,1,2,"---FILE: vignettes/articles/a04_code_library.Rmd---
@@ -17,7 +17,7 @@ library(NMproject)
 
 The first step in NONMEM model development is usually to borrow NONMEM code that a colleague who worked on a similar to use code from one of your previous project and then an adapt it to your problem.
 
-This is certaintly better than starting from scratch, however consider these problems: the code you borrow where the `$EST` code is fine for the problem it was originally written for, but works poorly on your problem.  Or the file is stylistically different from what you are used to, you may have trouble reading it or the person QCing your work may find it an awkward slow to read/understand. Or little potential issues like prehaps the code didn't have `PRINT=E` in the `$COV` step because it didn't need and then you are later asked for eigenvalues, requiring you to go back and rerun the final model...
+This is certaintly better than starting from scratch, however consider these problems: the code you borrow where the `$EST` code is fine for the problem it was originally written for, but works poorly on your problem.  Or the file is stylistically different from what you are used to, you may have trouble reading it or the person QCing your work may find it an awkward slow to read/understand. Or little potential issues like perhaps the code didn't have `PRINT=E` in the `$COV` step because it didn't need and then you are later asked for eigenvalues, requiring you to go back and rerun the final model...
 
 These are all reasons to replace the borrowing from colleague strategy with a maintained code library - a standardised library/directory of templated code that follows best practices and has been reviewed and used by a wide range of people.
 "
tsahota,NMproject,5cb28031b16f833a9cbb8087f330420b47e977be,tarjinde,tarjinder.z.sahota@gsk.com,2022-05-24T13:06:09Z,tarjinde,tarjinder.z.sahota@gsk.com,2022-05-30T12:00:05Z,bug fix `nm_list_render()` trying to save multiple files,R/nm_render.R,False,True,True,False,1,2,3,"---FILE: R/nm_render.R---
@@ -188,8 +188,7 @@ nm_list_render <- function(m,
         ...
       )
     }, hash = list(tools::md5sum(input), output_file, output_dir, args),
-    dir = file.path("".cache"", ""rmarkdown"", """"), 
-    file = paste0(basename(input), ""."", file_friendly_unique_id(m)))    
+    dir = file.path("".cache"", ""rmarkdown"", """"))
   } else {
     rmarkdown::render(
       input = input,"
tsahota,NMproject,ed6c3d734a3e3535b4f9c1efa7e2bdf13baae948,tarjinde,tarjinder.z.sahota@gsk.com,2022-05-24T12:38:41Z,tarjinde,tarjinder.z.sahota@gsk.com,2022-05-30T12:00:05Z,rr and coef handle FIXed parameters better,R/post-run-summaries.R,False,True,True,False,16,9,25,"---FILE: R/post-run-summaries.R---
@@ -142,8 +142,11 @@ rr.nm_list <- function(m, trans = TRUE) {
   if (""trans"" %in% d$trans) d$trans[is.na(d$trans)] <- """" ## optional item
   d <- d[, names(d)[!names(d) %in% c(""EVALUATION"", ""EST.NO"", ""EST.NAME"")]]
   d$Estimate <- NA
-  d$Estimate[d$parameter != ""OBJ""] <- paste0(signif(d$FINAL[d$parameter != ""OBJ""], 3), "" ("", signif(d$SE[d$parameter != ""OBJ""], 3), d$SEunit[d$parameter != ""OBJ""], "")"")
-  d$Estimate[d$parameter == ""OBJ""] <- round(d$FINAL[d$parameter == ""OBJ""], 3)
+  d$param_flag <- grepl(""THETA"", d$type) | grepl(""OMEGA"", d$type) | grepl(""SIGMA"", d$type)
+  d$Estimate[d$param_flag] <- paste0(signif(d$FINAL[d$param_flag], 3), "" ("", signif(d$SE[d$param_flag], 3), d$SEunit[d$param_flag], "")"")
+  d$Estimate[!d$param_flag] <- round(d$FINAL[!d$param_flag], 3)
+  d$param_flag <- NULL
+  d$Estimate[d$FIX %in% TRUE] <- gsub(""\\(.*?\\)"", ""(FIX)"", d$Estimate[d$FIX %in% TRUE])
   d <- d[, names(d)[!names(d) %in% c(""SE"", ""FINAL"")]]
   d <- d %>% tidyr::pivot_wider(names_from = ""run_name"", values_from = ""Estimate"")
   d <- as.data.frame(d)
@@ -382,7 +385,7 @@ coef.nm_generic <- function(object, trans = TRUE, ...) {
   p <- param_info2(object)
   
   d0 <- d[, names(d)[!names(d) %in% ""unit""]]
-  d1 <- p[, c(""name"", ""parameter"", ""unit"", ""trans"")]
+  d1 <- p[, c(""name"", ""parameter"", ""unit"", ""trans"", ""FIX"")]
   
   d <- merge(d0, d1, all.x = TRUE, by = ""parameter"", sort = FALSE)
   d$name[is.na(d$name)] <- as.character(d$parameter)[is.na(d$name)]
@@ -488,6 +491,7 @@ coef.nm_generic <- function(object, trans = TRUE, ...) {
   d$nm_name <- d$parameter
   d$parameter <- d$name
   d$name <- NULL
+  d$SE[!d$FIX %in% FALSE] <- NA_real_
   d
 }
 
@@ -639,17 +643,20 @@ summary.nm_list <- function(object, ref_model = NA, parameters = c(""none"", ""new""
       rri$trans <- NULL
       rri$par_no <- NULL
       rri$key <- NULL
+      rri$FIX <- NULL
       
-      if (ncol(rri) < 3) {
+      base_col_ns <- 3 # the number of columns expected in a simple rri object
+      
+      if (ncol(rri) < base_col_ns) {
         return(d)
       }
-      if (ncol(rri) == 3) {
-        names(rri)[3] <- c(""m"")
+      if (ncol(rri) == base_col_ns) {
+        names(rri)[base_col_ns] <- c(""m"")
       }
-      if (ncol(rri) == 4) {
-        names(rri)[3:4] <- c(""parent"", ""m"")
+      if (ncol(rri) == (base_col_ns + 1)) {
+        names(rri)[base_col_ns:(base_col_ns+1)] <- c(""parent"", ""m"")
       }
-      if (ncol(rri) > 4) browser() # stop(""stop something wrong, debug"")
+      if (ncol(rri) > (base_col_ns + 1)) browser() # stop(""stop something wrong, debug"")
       
       if (parameters == ""new"") {
         param_names <- rri$parameter[!grepl(""se_"", rri$parameter) &"
tsahota,NMproject,644e591839be36be5f968aa05b2c39197aad5062,tarjinde,tarjinder.z.sahota@gsk.com,2022-03-10T11:14:08Z,tarjinde,tarjinder.z.sahota@gsk.com,2022-03-10T12:26:05Z,bug fix `modify_patch_app()` not remembering text replacement point,R/manual-edit.R,False,True,True,False,14,14,28,"---FILE: R/manual-edit.R---
@@ -180,8 +180,8 @@ view_patch <- function(patch_id) {
 
 }
 
-new_patch_app <- function() {
-  ctx <- rstudioapi::getSourceEditorContext()
+new_patch_app <- function(ctx) {
+  if (missing(ctx)) ctx <- rstudioapi::getSourceEditorContext()
   selected_text <- ctx$selection[[1]]$text
   final_pipe_present <- grepl(""\\s*%>%\\s*$"", selected_text)
   final_newline_present <- grepl(""\\n\\s*$"", selected_text)
@@ -241,8 +241,8 @@ Follow the above instructions and indicate if you happy to proceed?"", yes = ""Yes
   
 }
 
-modify_patch_app <- function() {
-  ctx <- rstudioapi::getSourceEditorContext()
+modify_patch_app <- function(ctx) {
+  if (missing(ctx)) ctx <- rstudioapi::getSourceEditorContext()
   selected_text <- ctx$selection[[1]]$text
   final_pipe_present <- grepl(""\\s*%>%\\s*$"", selected_text)
   final_newline_present <- grepl(""\\n\\s*$"", selected_text)
@@ -295,7 +295,7 @@ Follow the above instructions and indicate if you happy to proceed?"", yes = ""Yes
   apply_manual_edit(\"""", res$patch_id, ""\"")"")
   }
 
-  rstudioapi::insertText(
+  rstudioapi::insertText(ctx$selection[[1]]$range,
     text = code_to_add,
     id = ctx$id
   )
@@ -304,8 +304,8 @@ Follow the above instructions and indicate if you happy to proceed?"", yes = ""Yes
 
 }
 
-resolve_manual_edit <- function() {
-  ctx <- rstudioapi::getSourceEditorContext()
+resolve_manual_edit <- function(ctx) {
+  if (missing(ctx)) ctx <- rstudioapi::getSourceEditorContext()
   selected_text <- ctx$selection[[1]]$text
   final_pipe_present <- grepl(""\\s*%>%\\s*$"", selected_text)
   final_newline_present <- grepl(""\\n\\s*$"", selected_text)
@@ -364,7 +364,7 @@ Follow the above instructions and indicate if you happy to proceed?"", yes = ""Yes
   apply_manual_edit(\"""", res$patch_id, ""\"")"")
   }
 
-  rstudioapi::insertText(
+  rstudioapi::insertText(ctx$selection[[1]]$range,
     text = code_to_add,
     id = ctx$id
   )
@@ -374,9 +374,9 @@ Follow the above instructions and indicate if you happy to proceed?"", yes = ""Yes
 }
 
 make_patch_app <- function() {
-  check_git_uservalues()
 
   ctx <- rstudioapi::getSourceEditorContext()
+  check_git_uservalues()
   selected_text <- ctx$selection[[1]]$text
   selected_text <- gsub(""\\s*%>%\\s*$"", """", selected_text)
   ## see if last function is apply_manual_edit
@@ -397,16 +397,16 @@ make_patch_app <- function() {
   }
 
   if (last_fun_name == ""apply_manual_edit"") {
-    modify_patch_app()
+    modify_patch_app(ctx)
   } else {
-    new_patch_app()
+    new_patch_app(ctx)
   }
 }
 
 resolve_manual_edit_app <- function() {
-  check_git_uservalues()
-
+  
   ctx <- rstudioapi::getSourceEditorContext()
+  check_git_uservalues()
   selected_text <- ctx$selection[[1]]$text
   selected_text <- gsub(""\\s*%>%\\s*$"", """", selected_text)
   ## see if last function is apply_manual_edit
@@ -427,7 +427,7 @@ resolve_manual_edit_app <- function() {
   }
 
   if (last_fun_name == ""apply_manual_edit"") {
-    resolve_manual_edit()
+    resolve_manual_edit(ctx)
   } else {
     stop(""the last function applied to selection needs to be apply_manual_edit()"")
   }"
tsahota,NMproject,02f1896f09e7187b32907a1f026e3db21f75afcf,tarjinde,tarjinder.z.sahota@gsk.com,2022-03-07T20:29:47Z,tarjinde,tarjinder.z.sahota@gsk.com,2022-03-07T20:37:08Z,bug fix args/params was being unlisted by `mapply()`,R/nm_render.R,False,True,True,False,2,1,3,"---FILE: R/nm_render.R---
@@ -135,7 +135,8 @@ nm_render.nm_generic <- function(m,
 }
 
 #' @export
-nm_render.nm_list <- Vectorize_nm_list(nm_render.nm_generic, SIMPLIFY = FALSE, invisible = TRUE)
+nm_render.nm_list <- Vectorize_nm_list(nm_render.nm_generic, SIMPLIFY = FALSE, invisible = TRUE, 
+                                       vectorize.args = c(""m"", ""input"", ""output_file""))
 
 #' @rdname nm_render
 #' @export"
tsahota,NMproject,ac15e93e7289f8a3e6ee60fe98ff4e31aa07b2c7,tarjinde,tarjinder.z.sahota@gsk.com,2022-03-06T13:14:11Z,tarjinde,tarjinder.z.sahota@gsk.com,2022-03-06T13:16:49Z,added error message if a table can't be found,R/nm_read_table.R,False,True,True,False,3,0,3,"---FILE: R/nm_read_table.R---
@@ -23,6 +23,9 @@ suppressWarnings(
 #' @export
 
 nm_read_table <- function(file, ...) {
+  if (!file.exists(file)) {
+    usethis::ui_stop(""The file {usethis::ui_path(file)} could not be found"")
+  }
   tmp <- suppressWarnings(utils::read.table(file, fill = T, colClasses = ""dummy.numeric"", ...))
   return(tmp[stats::complete.cases(tmp[, sapply(tmp, function(i) !all(is.na(i)))]), ])
 }"
tsahota,NMproject,773f3307d7e168f36dc360ae7a02ca4594ff7d80,tarjinde,tarjinder.z.sahota@gsk.com,2022-03-05T16:58:00Z,tarjinde,tarjinder.z.sahota@gsk.com,2022-03-05T16:58:00Z,tryCatch errors in `devtools::build_readme()`,R/make_project.R,False,True,True,False,8,1,9,"---FILE: R/make_project.R---
@@ -193,7 +193,14 @@ nm_create_analysis_project <- function(path, dirs = nm_default_dirs(),
 
   set_default_dirs_in_rprofile(file.path(folder, name, "".Rprofile""), dirs)
 
-  suppressMessages(devtools::build_readme(path = path))
+  tryCatch(
+    {
+      suppressMessages(devtools::build_readme(path = path))   
+    },
+    error = function(e) {
+      usethis::ui_info(""skipping {usethis::ui_path('README.Rmd')} build"")
+    }
+  )
 
   ## No R directory for simple package - advanced users needs to create this manually
   ##  This is because RStudio by default tries to save files in the R directory."
tsahota,NMproject,96716252b48c0844f3a7f046352ebb2351bf01e0,tarjinde,tarjinder.z.sahota@gsk.com,2022-03-03T21:03:26Z,tarjinde,tarjinder.z.sahota@gsk.com,2022-03-03T21:03:26Z,`init_omega()` and `init_sigma()` exponential notation fix (#21),R/init_funs.R,False,True,True,False,1,1,2,"---FILE: R/init_funs.R---
@@ -791,7 +791,7 @@ raw_init_random <- function(m, replace, dollar = ""OMEGA"") {
     d$init <- NA
     d$upper <- NA
 
-    number_regex <- ""\\(?\\-?[0-9\\.]+\\)?F?I?X?\\)?""
+    number_regex <- ""\\(?\\-?[0-9\\.eE\\+\\-]+\\)?F?I?X?\\)?""
     single_number_regex <- paste0(""^("", number_regex, "")$"")
     lower_init_regex <- paste0(""^\\(("", number_regex, ""),("", number_regex, "")\\)F?I?X?$"")
     lower_init_upper_regex <- paste0(""^\\(("", number_regex, ""),("", number_regex, ""),("", number_regex, "")\\)F?I?X?$"")"
tsahota,NMproject,36011fb8af59b53fc08bc8d5fb146fda205cf0e3,tarjinde,tarjinder.z.sahota@gsk.com,2022-03-02T12:46:39Z,tarjinde,tarjinder.z.sahota@gsk.com,2022-03-02T13:07:25Z,informative error message if ext file doesn't exist yet,R/read_ext.R,False,True,True,False,3,0,3,"---FILE: R/read_ext.R---
@@ -50,6 +50,9 @@ read_ext.default <- function(r, trans = FALSE) {
   base_nm_run_path <- file.path(run_dir_path(r), ""NM_run1"")
 
   # d <- read_ext0(r$output$psn.ext)
+  
+  if (!file.exists(file.path(base_nm_run_path, ""psn.ext""))) usethis::ui_stop(""psn.ext file exist (yet)"")
+  
   d <- read_ext0(file.path(base_nm_run_path, ""psn.ext""))
 
   if (!trans) {"
tsahota,NMproject,369f147822e5fe73dcad18b40bbeaa1698b7a3c2,tarjinde,tarjinder.z.sahota@gsk.com,2022-03-02T11:35:34Z,tarjinde,tarjinder.z.sahota@gsk.com,2022-03-02T11:35:34Z,bug fix - caching wasn't using the contents of input file (script template),R/nm_render.R,False,True,True,False,2,2,4,"---FILE: R/nm_render.R---
@@ -110,7 +110,7 @@ nm_render.nm_generic <- function(m,
         quiet = TRUE,
         ...
       )
-    }, hash = list(input, output_file, output_dir, args),
+    }, hash = list(tools::md5sum(input), output_file, output_dir, args),
     dir = file.path("".cache"", ""rmarkdown"", """"), 
     file = paste0(basename(input), ""."", file_friendly_unique_id(m)))    
   } else {
@@ -186,7 +186,7 @@ nm_list_render <- function(m,
         quiet = TRUE,
         ...
       )
-    }, hash = list(input, output_file, output_dir, args),
+    }, hash = list(tools::md5sum(input), output_file, output_dir, args),
     dir = file.path("".cache"", ""rmarkdown"", """"), 
     file = paste0(basename(input), ""."", file_friendly_unique_id(m)))    
   } else {"
tsahota,NMproject,957d342a9f13dbe94b08b0cebecb4979f6c42df8,tarjinde,tarjinder.z.sahota@gsk.com,2022-03-01T20:17:01Z,tarjinde,tarjinder.z.sahota@gsk.com,2022-03-01T20:17:01Z,Bug fix in `nobs()` for correct handling of datasets with 0s instead of NAs,R/ofv.R,False,True,True,False,2,2,4,"---FILE: R/ofv.R---
@@ -112,10 +112,10 @@ nobs.nm_generic <- function(object, ...) {
     d <- input_data(object, filter = TRUE)
   )
   if (""AMT"" %in% names(d)) {
-    d <- d %>% dplyr::filter(is.na(.data$AMT))
+    d <- d %>% dplyr::filter(is.na(.data$AMT) | .data$AMT %in% 0)
   }
   if (""EVID"" %in% names(d)) {
-    d <- d %>% dplyr::filter(.data$EVID %in% 0)
+    d <- d %>% dplyr::filter(is.na(.data$EVID) | .data$EVID %in% 0)
   }
   if (""MDV"" %in% names(d)) {
     d <- d %>% dplyr::filter(!.data$MDV %in% 1)"
tsahota,NMproject,c9c36b95b2660f04a91c541f16020d2c4ed00648,Tarjy,hsdlfj,2022-02-28T20:17:54Z,Tarjy,hsdlfj,2022-02-28T20:17:54Z,Bug fix (resolves #21),R/init_funs.R,False,True,True,False,1,1,2,"---FILE: R/init_funs.R---
@@ -589,7 +589,7 @@ raw_init_theta <- function(m, replace) {
     d$init <- NA
     d$upper <- NA
 
-    number_regex <- ""\\(?\\-?[0-9\\.]+\\)?F?I?X?\\)?""
+    number_regex <- ""\\(?\\-?[0-9\\.eE\\+\\-]+\\)?F?I?X?\\)?""
     single_number_regex <- paste0(""^("", number_regex, "")$"")
     lower_init_regex <- paste0(""^\\(("", number_regex, ""),("", number_regex, "")\\)F?I?X?$"")
     lower_init_upper_regex <- paste0(""^\\(("", number_regex, ""),("", number_regex, ""),("", number_regex, "")\\)F?I?X?$"")"
tsahota,NMproject,9621b93f057c78e1975360e8589a705226c60072,tarjinde,tarjinder.z.sahota@gsk.com,2022-02-27T17:42:37Z,tarjinde,tarjinder.z.sahota@gsk.com,2022-02-27T17:43:41Z,bug fix allow for TOL= notation,R/subroutine.R,False,True,True,False,3,3,6,"---FILE: R/subroutine.R---
@@ -693,7 +693,7 @@ tol.nm_generic <- function(m, text) {
     if (is_single_na(sub_text)) {
       return(NA_integer_)
     }
-    tol_match_text <- "".*\\bTOL([0-9]+)\\b.*""
+    tol_match_text <- "".*\\bTOL\\s*=?\\s*([0-9]+)\\b.*""
     tol_match <- grepl(tol_match_text, sub_text)
     tol <- gsub(tol_match_text, ""\\1"", sub_text[tol_match])
     tol <- as.integer(tol)
@@ -705,9 +705,9 @@ tol.nm_generic <- function(m, text) {
 
   if (any(grepl(""TOL"", text(m)))) { ## TOL already exists
     if (!is.na(text)) {
-      m <- m %>% gsub_ctl(""TOL[0-9]+"", paste0(""TOL"", text))
+      m <- m %>% gsub_ctl(""(TOL\\s*=?\\s*)[0-9]+"", paste0(""\\1"", text))
     } else {
-      m <- m %>% gsub_ctl(""TOL[0-9]+"", """")
+      m <- m %>% gsub_ctl(""TOL=?[0-9]+"", """")
     }
   } else {
     if (!is.na(text)) {"
tsahota,NMproject,1e68f95c5a7ce0f1ddab78d31a60157dcae19a9d,tarjinde,tarjinder.z.sahota@gsk.com,2022-02-26T21:49:58Z,tarjinde,tarjinder.z.sahota@gsk.com,2022-02-26T21:49:58Z,Bug fix where IGNORE(...) notation is used,R/data_filter.R,False,True,True,False,2,2,4,"---FILE: R/data_filter.R---
@@ -30,8 +30,8 @@ data_ignore_char.nm_generic <- function(r, data) {
     )
   }
 
-  ignore_present <- any(grepl("".*IGNORE\\s*=\\s*\\("", dol_data))
-  accept_present <- any(grepl("".*ACCEPT\\s*=\\s*\\("", dol_data))
+  ignore_present <- any(grepl("".*IGNORE\\s*=?\\s*\\("", dol_data))
+  accept_present <- any(grepl("".*ACCEPT\\s*=?\\s*\\("", dol_data))
 
 
   ## can now assume that only one is TRUE"
tsahota,NMproject,fe6a877a4d483df100aa30d973ffcbce5c8604af,tarjinde,tarjinder.z.sahota@gsk.com,2022-02-26T20:45:19Z,tarjinde,tarjinder.z.sahota@gsk.com,2022-02-26T20:46:54Z,Fixed resolve manual edit failure when directory change was responsible for failure.,NEWS.md;R/manual-edit.R,False,True,True,False,3,1,4,"---FILE: NEWS.md---
@@ -30,6 +30,8 @@
 
 * Added support for ""name [unit] :trans"" type parameter comments.
 
+* Fixed resolve manual edit failure when directory change was responsible for failure.
+
 # NMproject 0.6.7
 
 * Added ability to use NMproject-specific code completion snippets `setup_code_completion()`.

---FILE: R/manual-edit.R---
@@ -36,7 +36,7 @@ start_manual_edit <- function(m, combine_patch = NA_character_, replace_ctl = NA
   dir.create(dirname(patch_path), showWarnings = FALSE, recursive = TRUE)
 
   #temp_ctl_path <- file.path(run_in(m), paste0(""manual_"", ctl_name(m)))
-  temp_ctl_path <- file.path(nm_dir(""models""), paste0(""base-"", patch_id))
+  temp_ctl_path <- file.path(run_in(m), paste0(""base-"", patch_id))
   mnew <- m %>%
     ctl_path(temp_ctl_path) %>%
     write_ctl(force = TRUE)"
tsahota,NMproject,fbf14f913ff162eeeb4d7a1ea70cd405e6cbb821,tarjinde,tarjinder.z.sahota@gsk.com,2022-02-26T17:29:02Z,tarjinde,tarjinder.z.sahota@gsk.com,2022-02-26T20:46:54Z,"better error message if `rr(m1, m2)` is used",R/post-run-summaries.R,False,True,True,False,12,0,12,"---FILE: R/post-run-summaries.R---
@@ -118,6 +118,18 @@ rr <- function(m, trans = TRUE) {
 
 #' @export
 rr.nm_list <- function(m, trans = TRUE) {
+  if (is_nm_list(trans) & is_nm_list(m)) {
+    existing_call <- match.call()
+    existing <- paste0(""rr("", paste0(as.character(existing_call[2:3]), collapse = "", ""), "")"")
+    proposed <- paste0(""rr(c("", paste0(as.character(existing_call[2:3]), collapse = "", ""), ""))"")
+    reasonable_proposals <- all(grepl(""rr"", c(existing, proposed)))
+    if (!reasonable_proposals) {
+      usethis::ui_stop(""Looks like you're trying to do something like {usethis::ui_code('rr(m1, m2)')}, however this function takes a single nm_list argument, e.g. {usethis::ui_code('rr(c(m1, m2))')}"") 
+    } else {
+      usethis::ui_stop(""This function takes a single nm_list argument, consider: {usethis::ui_code(proposed)}"")
+    }
+  }
+  if (!is.logical(trans)) usethis::ui_stop(""the trans argument must be TRUE or FALSE"")
   d <- coef(m, trans = trans)
   d <- do.call(rbind, d)
   if (nrow(d) == 0) {"
tsahota,NMproject,6ed8156681f029e0e8d87d8960cb6510cbee1702,tarjinde,tarjinder.z.sahota@gsk.com,2022-02-24T14:30:55Z,tarjinde,tarjinder.z.sahota@gsk.com,2022-02-26T20:46:54Z,Bug fix `check_installation()` was running with a different set of environment variables within test_that blocks,R/check_installation.R,False,True,True,False,12,10,22,"---FILE: R/check_installation.R---
@@ -24,16 +24,19 @@ Ensure PsN is installed: 'https://uupharmacometrics.github.io/PsN/'.
 If PsN is installed ensure `system_nm()` is correctly configured.
 See ?system_nm for help."")
     
-    nm_tran_cmd <- nm_tran_command()
-    nm_tran_test <- FALSE
-    if (!is.null(nm_tran_cmd)) {
-      if (length(nm_tran_cmd) > 0) {
-        if (is.character(nm_tran_cmd)) {
-          if (nchar(nm_tran_cmd) > 0) nm_tran_test <- TRUE
-        }
+  })
+  
+  nm_tran_cmd <- nm_tran_command()
+  nm_tran_test <- FALSE
+  if (!is.null(nm_tran_cmd)) {
+    if (length(nm_tran_cmd) > 0) {
+      if (is.character(nm_tran_cmd)) {
+        if (nchar(nm_tran_cmd) > 0) nm_tran_test <- TRUE
       }
     }
-  })
+  }
+  
+  code_completion_status <- check_code_completion()
   
   testthat::test_that(""Recommended configuration"", {
     
@@ -45,8 +48,7 @@ However if working in a grid environment, it is highly recommended that this
 check succeed as without it NMTRAN checks will not work.  NMTRAN checks provide 
 fast feedback of control file and dataset errors.  See ?nm_tran_command for 
 instructions"")
-    
-    testthat::expect(check_code_completion(),
+    testthat::expect(code_completion_status,
                      ""Code completion has not been configured.
 It is recommended to configure this as it helps greatly with NMproject
 scripting.  It is not mandatory though for NMproject to work."
tsahota,NMproject,982fefc1971587b653d9b5813e19f9c6344d90f2,tarjinde,tarjinder.z.sahota@gsk.com,2022-02-14T16:19:06Z,tarjinde,tarjinder.z.sahota@gsk.com,2022-02-14T23:03:31Z,Bug in parameter ordering when there were more than 10 THETAs. Retain nonmem names of parameters,R/post-run-summaries.R,False,True,True,False,89,89,178,"---FILE: R/post-run-summaries.R---
@@ -283,17 +283,17 @@ coef_wide <- function(m, trans = TRUE) {
   d$SEunit[is.na(d$SEunit)] <- """"
   if (""trans"" %in% d$trans) d$trans[is.na(d$trans)] <- """" ## optional item
   d <- d[, names(d)[!names(d) %in% c(""EVALUATION"", ""EST.NO"", ""EST.NAME"")]]
-
+  
   d <- d[grepl(""THETA|OMEGA|SIGMA"", d$type), ]
-
-  d <- d[order(paste(d$m_no, d$par_no, d$key)), ]
+  
+  d <- d[order(paste(d$m_no)), ]
   d$m_no <- NULL
   # d$par_no <- NULL
   d$run_name <- gsub(""execute:"", """", d$run_name)
-
+  
   tmp <- sapply(d, is.factor)
   d[tmp] <- lapply(d[tmp], as.character)
-
+  
   d
 }
 
@@ -319,19 +319,19 @@ coef_long <- function(m, trans = TRUE) {
   d$SEunit[is.na(d$SEunit)] <- """"
   if (""trans"" %in% d$trans) d$trans[is.na(d$trans)] <- """" ## optional item
   d <- d[, names(d)[!names(d) %in% c(""EVALUATION"", ""EST.NO"", ""EST.NAME"")]]
-
+  
   d <- d[grepl(""THETA|OMEGA|SIGMA"", d$type), ]
-
+  
   d <- d %>% tidyr::gather(key = ""key"", value = ""estimate"", .data$FINAL:.data$SE)
-
+  
   d <- d[order(paste(""m"", d$m_no, ""p"", d$par_no, d$key)), ]
   d$m_no <- NULL
   # d$par_no <- NULL
   d$run_name <- gsub(""execute:"", """", d$run_name)
-
+  
   tmp <- sapply(d, is.factor)
   d[tmp] <- lapply(d[tmp], as.character)
-
+  
   d
 }
 
@@ -344,39 +344,39 @@ coef.nm_generic <- function(object, trans = TRUE, ...) {
   if (!is_finished(object)) {
     return(invisible(data.frame()))
   }
-
+  
   ext_file_path <- object %>% nm_output_path(""ext"")
-
+  
   d <- coef_ext0(ext_file_path)
   if (nrow(d) == 0) {
     return(data.frame())
   }
-
+  
   d$run_name <- gsub(""execute\\."", ""\\1"", unique_id(object))
   if (!unique(d$is_final)) d$run_name <- paste0(d$run_name, ""*"")
   d$is_final <- NULL
   if (!trans) {
     return(d)
   }
-
+  
   p <- param_info2(object)
-
+  
   d0 <- d[, names(d)[!names(d) %in% ""unit""]]
   d1 <- p[, c(""name"", ""parameter"", ""unit"", ""trans"")]
-
-  d <- merge(d0, d1, all.x = TRUE, by = ""parameter"")
+  
+  d <- merge(d0, d1, all.x = TRUE, by = ""parameter"", sort = FALSE)
   d$name[is.na(d$name)] <- as.character(d$parameter)[is.na(d$name)]
   d$name <- factor(d$name, levels = d$name)
   d$trans_unit <- d$unit
   d$transSEunit <- d$SEunit
   ## transformations
   d$FINAL.TRANS <- d$FINAL
   d$SE.TRANS <- d$SE
-
+  
   th <- d$type %in% ""THETA""
   om <- d$type %in% ""OMEGAVAR""
   sg <- d$type %in% ""SIGMA""
-
+  
   ## RATIO data
   d$SE.TRANS[d$trans %in% ""RATIO"" & th] <- 100 * d$SE[d$trans %in% ""RATIO"" & th] / d$FINAL[d$trans %in% ""RATIO"" & th]
   d$transSEunit[d$trans %in% ""RATIO"" & th] <- ""%""
@@ -397,7 +397,7 @@ coef.nm_generic <- function(object, trans = TRUE, ...) {
     # d$SE.TRANS[d$trans %in% ""LOGIT""] <- 100*delt$SE
   }
   ## OMEGA
-
+  
   ## https://www.cognigen.com/nmusers/2008-February/0811.html
   ## delta method:
   ## FINAL = E[OM^2]
@@ -407,7 +407,7 @@ coef.nm_generic <- function(object, trans = TRUE, ...) {
   ## SE(OM) ~= SE/(2*sqrt(FINAL))
   ## E(OM) ~= sqrt(E[OM^2]) = sqrt(FINAL)
   ## RSE(OM) = SE(OM) / (2* E(OM))
-
+  
   d$SE.TRANS[d$trans %in% ""LOG"" & om] <- 100 * (d$SE[d$trans %in% ""LOG"" & om] / d$FINAL[d$trans %in% ""LOG"" & om]) / 2
   d$FINAL.TRANS[d$trans %in% ""LOG"" & om] <- 100 * sqrt(exp(d$FINAL[d$trans %in% ""LOG"" & om]) - 1)
   d$trans_unit[d$trans %in% ""LOG"" & om] <- ""CV%""
@@ -449,13 +449,13 @@ coef.nm_generic <- function(object, trans = TRUE, ...) {
   #   }
   #
   # }
-
+  
   ## SIGMA
   d$SE.TRANS[d$type %in% ""SIGMA""] <- 100 * (d$SE[d$type %in% ""SIGMA""] / d$FINAL[d$type %in% ""SIGMA""]) / 2
   d$FINAL.TRANS[d$type %in% ""SIGMA""] <- sqrt(d$FINAL[d$type %in% ""SIGMA""])
   d$trans_unit[d$type %in% ""SIGMA""] <- ""SD""
   d$transSEunit[d$type %in% ""SIGMA""] <- ""%""
-
+  
   ## get names back to what they should be
   d$FINAL <- d$FINAL.TRANS
   d$FINAL.TRANS <- NULL
@@ -465,6 +465,7 @@ coef.nm_generic <- function(object, trans = TRUE, ...) {
   d$trans_unit <- NULL
   d$SEunit <- d$transSEunit
   d$transSEunit <- NULL
+  d$nm_name <- d$parameter
   d$parameter <- d$name
   d$name <- NULL
   d
@@ -538,15 +539,15 @@ summary.nm_list <- function(object, ref_model = NA, parameters = c(""none"", ""new""
   cat(""done\n"", append = TRUE)
   cat(""summarising..."")
   d$status <- status(d$m)
-
+  
   n_parameters_fun <- function(coef) {
     if (!""type"" %in% names(coef)) {
       return(NA)
     }
     coef <- coef[grepl(""THETA|OMEGA|SIGMA"", coef$type), ]
     nrow(coef)
   }
-
+  
   # browser()
   #
   # f <- function(x) {
@@ -559,7 +560,7 @@ summary.nm_list <- function(object, ref_model = NA, parameters = c(""none"", ""new""
   #   dplyr::mutate(
   #     parent = list(parent_run(.data$m[[1]]))
   #   )
-
+  
   d <- d %>%
     dplyr::group_by(.data$parent_run_id, .data$parent_run_in) %>%
     dplyr::mutate(
@@ -578,8 +579,8 @@ summary.nm_list <- function(object, ref_model = NA, parameters = c(""none"", ""new""
       df = .data$n_params - .data$parent_n_params,
       p_chisq =
         ifelse(.data$df >= 0,
-          1 - stats::pchisq(-.data$dofv, df = .data$df),
-          1 - stats::pchisq(.data$dofv, df = -.data$df)
+               1 - stats::pchisq(-.data$dofv, df = .data$df),
+               1 - stats::pchisq(.data$dofv, df = -.data$df)
         ),
       AIC = .data$ofv + 2 * .data$n_params,
       BIC = .data$ofv + log(.data$nobs) * .data$n_params,
@@ -589,16 +590,15 @@ summary.nm_list <- function(object, ref_model = NA, parameters = c(""none"", ""new""
   d$coef_obs <- NULL
   d$parent_coef_obs <- NULL
   d$parent <- as_nm_list(d$parent)
-
+  
   parameters <- match.arg(parameters)
   if (parameters != ""none"") {
     ## for each row, compute rr(d$m[i]) and rr(d$parent[i])
     ## remove nm_list classes - they screw up in dplyr
-
+    
     ds <- split(d, seq_len(nrow(d)))
 
     ds <- lapply(ds, function(d) {
-
       # rri <- rr(c(d$parent,d$m), ...)
       # rri <- rri[grepl(""THETA|OMEGA|SIGMA"", rri$type), ]
       #
@@ -619,50 +619,50 @@ summary.nm_list <- function(object, ref_model = NA, parameters = c(""none"", ""new""
       rri$trans <- NULL
       rri$par_no <- NULL
       rri$key <- NULL
-
-      if (ncol(rri) < 2) {
+      
+      if (ncol(rri) < 3) {
         return(d)
       }
-      if (ncol(rri) == 2) {
-        names(rri)[-1] <- c(""m"")
-      }
       if (ncol(rri) == 3) {
-        names(rri)[-1] <- c(""parent"", ""m"")
+        names(rri)[3] <- c(""m"")
       }
-      if (ncol(rri) > 3) browser() # stop(""stop something wrong, debug"")
-
+      if (ncol(rri) == 4) {
+        names(rri)[3:4] <- c(""parent"", ""m"")
+      }
+      if (ncol(rri) > 4) browser() # stop(""stop something wrong, debug"")
+      
       if (parameters == ""new"") {
         param_names <- rri$parameter[!grepl(""se_"", rri$parameter) &
-          !is.na(rri$m)]
-
+                                       !is.na(rri$m)]
+        
         parent_param_names <- rri$parameter[!grepl(""se_"", rri$parameter) &
-          !is.na(rri$parent)]
-
+                                              !is.na(rri$parent)]
+        
         new_param_names <- param_names[!param_names %in% parent_param_names]
-
+        
         se_param_names <- paste0(""se_"", new_param_names)
-
+        
         rri <- rri[rri$parameter %in% c(new_param_names, se_param_names), ]
         if (nrow(rri) == 0) {
           return(d)
         }
-
+        
         # rri$parameter[is.na(rri$parent)]
         #
         # rri <- rri[is.na(rri$parent), ]
         # rri <- rri[!is.na(rri$m), ]
       }
-
+      
       if (inherits(try(t(rri$m)), ""try-error"")) browser()
-
+      
       pars_to_add <- dplyr::as_tibble(t(rri$m))
       names(pars_to_add) <- rri$parameter
-
+      
       dplyr::bind_cols(d, pars_to_add) # %>%
       # mutate(m = nm_list2list(m),
       #        parent = nm_list2list(parent))
     })
-
+    
     ## nm_lists screw up in dplyr...
     ds <- lapply(ds, function(x) {
       x %>%
@@ -676,11 +676,11 @@ summary.nm_list <- function(object, ref_model = NA, parameters = c(""none"", ""new""
     d$m <- as_nm_list(d$m)
     d$parent <- as_nm_list(d$parent)
   }
-
+  
   #############################
   ## remove columns that we dont want
   ##  Note: may need reinsert them if they ever are needed in reverse dependencies
-
+  
   d <- d %>%
     dplyr::ungroup() %>%
     dplyr::select(
@@ -691,12 +691,12 @@ summary.nm_list <- function(object, ref_model = NA, parameters = c(""none"", ""new""
       -.data$parent_n_params,
       -.data$n_params
     )
-
+  
   if (!keep_m) d$m <- NULL
-
+  
   #############################
-
-
+  
+  
   cat(""done"", append = TRUE)
   d <- d %>% dplyr::ungroup()
   d
@@ -811,21 +811,21 @@ summary_long <- function(..., parameters = c(""none"", ""new"", ""all"")) {
 covariance_plot <- function(r, trans = TRUE) {
   dc <- nm_output_path(r, extn = ""cor"") %>%
     nm_read_table(header = TRUE, skip = 1)
-
+  
   names(dc)[1] <- ""Var1""
   dc$Var1 <- names(dc)[-1]
-
+  
   n_ests <- nrow(dc) / length(unique(dc$Var1))
-
+  
   dc$EST.NO <- rep(1:n_ests, each = length(unique(dc$Var1)))
   dc <- dc %>% dplyr::filter(.data$EST.NO == max(.data$EST.NO))
   dc$EST.NO <- NULL
-
+  
   dc <- dc %>% tidyr::gather(key = ""Var2"", value = ""value"", -.data$Var1)
-
+  
   dc$Var1 <- factor(dc$Var1)
   dc$Var2 <- factor(dc$Var2)
-
+  
   if (trans) {
     dp <- param_info(r)
     current_levels <- levels(dc$Var1)
@@ -842,11 +842,11 @@ covariance_plot <- function(r, trans = TRUE) {
     levels(dc$Var1) <- dl$new_names
     levels(dc$Var2) <- dl$new_names
   }
-
+  
   dc <- dc %>% dplyr::filter(!.data$value %in% 0)
   dc <- dc %>% dplyr::filter(as.numeric(.data$Var1) > as.numeric(.data$Var2)) ## lower corner
   dc$label <- round(dc$value, 2)
-
+  
   p <- ggplot2::ggplot(dc, ggplot2::aes_string(x = ""Var1"", y = ""Var2"", fill = ""value"")) +
     ggplot2::theme_bw() +
     ggplot2::geom_tile() +
@@ -857,7 +857,7 @@ covariance_plot <- function(r, trans = TRUE) {
     ) +
     ggplot2::geom_text(ggplot2::aes_string(label = ""label"")) +
     ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, vjust = 0))
-
+  
   p
 }
 
@@ -905,15 +905,15 @@ omega_matrix <- function(r) {
   dc_mirror$ROW <- dc_mirror$COLOLD
   dc_mirror$COLOLD <- NULL
   dc_mirror$ROWOLD <- NULL
-
+  
   dc <- rbind(dc, dc_mirror)
   dc <- unique(dc)
-
+  
   d_all <- expand.grid(ROW = 1:max_size, COL = 1:max_size)
   d_all <- merge(dc, d_all, all = TRUE)
   d_all$FINAL[is.na(d_all$FINAL)] <- 0
   d_all <- d_all[order(d_all$ROW, d_all$COL), ]
-
+  
   matrix(d_all$FINAL, nrow = max_size)
 }
 
@@ -922,12 +922,12 @@ omega_matrix <- Vectorize(omega_matrix, vectorize.args = list(""r""), SIMPLIFY = F
 
 ext2coef <- function(extout, file_name) {
   ## raw function to generate parameter table from ext.file.
-
+  
   d <- extout
   if (nrow(d) == 0) {
     return(data.frame())
   }
-
+  
   has_final_est <- ""FINAL"" %in% d$TYPE
   if (has_final_est) {
     cond_num <- d$THETA1[d$TYPE %in% ""CONDNUM"" & d$EST.NO %in% max(d$EST.NO)]
@@ -937,35 +937,35 @@ ext2coef <- function(extout, file_name) {
     cond_num <- numeric()
     d <- utils::tail(d, 1)
   }
-
+  
   d <- d[, c(
     names(d)[grepl(""THETA|SIGMA|OMEGA"", names(d))],
     c(""OBJ"", ""EST.NAME"", ""EST.NO"", ""EVALUATION"", ""TYPE"")
   )]
-
-
+  
+  
   par.names <- names(d)[match(""THETA1"", names(d)):match(""OBJ"", names(d))]
-
+  
   d <- tidyr::gather(d, key = ""parameter"", value = ""value"", par.names)
   d$parameter <- factor(d$parameter, levels = par.names)
   
   d <- tidyr::spread(d, key = ""TYPE"", value = ""value"")
-
+  
   ## messy hard coding - consider refactoring if need more than just eigenvalues
   if (has_final_est & length(cond_num) > 0) {
     dlast <- d[nrow(d), ]
     dlast$parameter <- ""CONDNUM""
     dlast$FINAL <- cond_num
     dlast$SE <- 0
-
+    
     d <- rbind(d, dlast)
   }
-
+  
   if (!has_final_est) names(d)[names(d) %in% ""ITER""] <- ""FINAL""
-
+  
   d <- d[order(d$EST.NO, decreasing = TRUE), ]
   d$file <- file_name
-
+  
   is.diag.omega <- grepl(""OMEGA.([0-9]+\\.)\\1"", d$parameter)
   is.omega <- grepl(""OMEGA.([0-9]+\\.)+"", d$parameter)
   is.off.diag.omega <- is.omega & !is.diag.omega
@@ -974,17 +974,17 @@ ext2coef <- function(extout, file_name) {
   is.sigma <- grepl(""SIGMA.([0-9]+\\.)+"", d$parameter)
   is.off.diag.sigma <- is.sigma & !is.diag.sigma
   d <- d[!(is.off.diag.sigma & d$FINAL == 0), ] ## get rid of off diag 0s
-
-
+  
+  
   is.diag.omega <- grepl(""OMEGA.([0-9]+\\.)\\1"", d$parameter) ## redefine
   is.omega <- grepl(""OMEGA.([0-9]+\\.)+"", d$parameter) ## redefine
   is.off.diag.omega <- is.omega & !is.diag.omega ## redefine
   is.diag.sigma <- grepl(""SIGMA.([0-9]+\\.)\\1"", d$parameter) ## redefine
   is.sigma <- grepl(""SIGMA.([0-9]+\\.)+"", d$parameter) ## redefine
   is.off.diag.sigma <- is.sigma & !is.diag.sigma ## redefine
-
+  
   ## sort so that THETAs first, then diagonal OMEGAs, then off diag, then SIGMA, then OBJ
-
+  
   par.char <- as.character(d$parameter)
   par.order <- c(
     sort(par.char[grepl(""THETA"", par.char)]),
@@ -1038,33 +1038,33 @@ param_info2 <- function(m) {
 
 rr2 <- function(m, trans = TRUE) {
   d <- coef_long(m, trans = trans)
-
+  
   if (nrow(d) == 0) {
     return(data.frame())
   }
-
+  
   index <- !d$unit %in% """" & !is.na(d$unit)
   d$parameter[index] <-
     paste0(d$parameter[index], "" ("", d$unit[index], "")"")
-
+  
   if (""trans"" %in% names(d)) {
     index <- !d$trans %in% """" & !is.na(d$trans)
     d$parameter[index] <-
       paste0(d$parameter[index], "" ("", d$trans[index], "")"")
   }
-
+  
   d$parameter[d$key %in% ""SE""] <- paste0(""se_"", d$parameter[d$key %in% ""SE""])
   d <- d %>%
     dplyr::group_by(.data$parameter) %>%
     dplyr::mutate(par_no = max(.data$par_no))
-
+  
   m_names <- unique(d$run_name)
   d <- d %>% tidyr::spread(key = ""run_name"", value = ""estimate"")
   names1 <- names(d)[!names(d) %in% m_names]
   d <- d[, c(names1, m_names)]
   # d <- d[order(d$key, d$par_no), ]
   d <- d[order(d$par_no, d$key), ]
   row.names(d) <- NULL
-
+  
   d
 }"
tsahota,NMproject,84afa469e0eb4c45a30f74b0ee8b78e048fe469e,tarjinde,tarjinder.z.sahota@gsk.com,2022-01-10T15:13:48Z,tarjinde,tarjinder.z.sahota@gsk.com,2022-01-10T15:13:48Z,Readme typo fix,README.Rmd;README.md,True,False,True,False,8,10,18,"---FILE: README.Rmd---
@@ -130,18 +130,17 @@ m2s %>% nm_render(""Scripts/basic_ppc.Rmd"")
 ```
 
 Advanced functionality enables groups of runs to be handled with the same
-concise syntax (no loops):
+concise syntax (no loops).  For example:
 
 - create 5 child runs
-- Perturb the initial estimates of \$THETA and \$OMEGA
-- move them to their own subdirectory
-- run them all
+- Randomly perturb the initial estimates of \$THETA and \$OMEGA
+- run them all in their own subdirectory for tidiness.
 
 ```{r eval = FALSE}
 
 m1rep <- m1 %>% child(run_id = 1:5) %>% 
   init_theta(init = rnorm(init, mean = init, sd = 0.3)) %>%
-  init_omega(init = runif(init, min = init/2, max = init/2)) %>%
+  init_omega(init = runif(init, min = init/2, max = init*2)) %>%
   run_in(""Models/m1_perturb_inits"") %>%
   run_nm()
 

---FILE: README.md---
@@ -123,17 +123,16 @@ m2s %>% nm_render(""Scripts/basic_ppc.Rmd"")
 ```
 
 Advanced functionality enables groups of runs to be handled with the
-same concise syntax (no loops):
+same concise syntax (no loops). For example:
 
 -   create 5 child runs
--   Perturb the initial estimates of $THETA and $OMEGA
--   move them to their own subdirectory
--   run them all
+-   Randomly perturb the initial estimates of $THETA and $OMEGA
+-   run them all in their own subdirectory for tidiness.
 
 ``` r
 m1rep <- m1 %>% child(run_id = 1:5) %>% 
   init_theta(init = rnorm(init, mean = init, sd = 0.3)) %>%
-  init_omega(init = runif(init, min = init/2, max = init/2)) %>%
+  init_omega(init = runif(init, min = init/2, max = init*2)) %>%
   run_in(""Models/m1_perturb_inits"") %>%
   run_nm()
 ```"
tsahota,NMproject,2bb1b47ac24bb8d1c7f7dbc2c96540b15920ec52,Tarj,t.sahota0@gmail.com,2021-12-24T16:41:22Z,Tarj,t.sahota0@gmail.com,2021-12-24T16:41:22Z,bug fix starttime and stoptime in `job_stats()`,R/job_stats.R,False,True,True,False,2,2,4,"---FILE: R/job_stats.R---
@@ -73,8 +73,8 @@ job_stats <- function(m) {
   m_time_f <- function(path) lubridate::ymd_hms(file.info(path)$mtime)
 
   d %>% dplyr::mutate(
-    starttime = purrr::map_chr(.data$xml, ~ .x$start_datetime),
-    stoptime = purrr::map_chr(.data$xml, ~ .x$stop_datetime),
+    starttime = purrr::map_chr(.data$xml, ~ .x$start_datetime[[1]]),
+    stoptime = purrr::map_chr(.data$xml, ~ .x$stop_datetime[[1]]),
     starttime = lubridate::ymd_hms(.data$starttime),
     stoptime = lubridate::ymd_hms(.data$stoptime),
     Rtime = difftime(.data$stoptime, .data$starttime, units = ""mins""),"
tsahota,NMproject,fb954913b243bcc082ea727ea416a79f34959341,Tarj,t.sahota0@gmail.com,2021-12-24T16:15:18Z,Tarj,t.sahota0@gmail.com,2021-12-24T16:25:07Z,unparseable example fix,R/decision.R;man/decision.Rd,False,True,True,False,2,2,4,"---FILE: R/decision.R---
@@ -70,7 +70,7 @@
 #'   inputs = summary_wide(c(m1, m2, m2WT)),
 #'   file_inputs = c(
 #'     ""Results/basic_gof.m1.nb.html"",
-#'     ""Results/basic_gof.m2.nb.html""]
+#'     ""Results/basic_gof.m2.nb.html""
 #'   ),
 #'   outcome = ""m1 is better""
 #' ) # next line must be end of chunk

---FILE: man/decision.Rd---
@@ -88,7 +88,7 @@ decision(
   inputs = summary_wide(c(m1, m2, m2WT)),
   file_inputs = c(
     ""Results/basic_gof.m1.nb.html"",
-    ""Results/basic_gof.m2.nb.html""]
+    ""Results/basic_gof.m2.nb.html""
   ),
   outcome = ""m1 is better""
 ) # next line must be end of chunk"
tsahota,NMproject,e482d6f146e00c5ba84e2ee7cd5d1682f6347aa6,Tarj,t.sahota0@gmail.com,2021-11-16T22:21:31Z,Tarj,t.sahota0@gmail.com,2021-11-16T22:21:31Z,broken commit: fixed peripheral volume formulas for init transformation,R/subroutine.R,False,True,True,False,18,18,36,"---FILE: R/subroutine.R---
@@ -40,18 +40,18 @@ dp <- dplyr::bind_rows(
   ),
   dplyr::tibble(
     advan = 3, trans = 3,
-    base_name = c(""R2T0"", ""R2T3"", ""V2"", ""V3""),
-    relation = c(""R2T0*V2"", ""R2T3*V2"", NA, ""V3+V2""),
-    inv_relation = c(""R2T0/V2"", ""R2T3/V2"", NA, ""V3-V2""),
+    base_name = c(""R2T0"", ""R2T3"", ""V2"", ""R3T2""),
+    relation = c(""R2T0*V2"", ""R2T3*V2"", NA, ""V2+V2*R2T3/R3T2""),
+    inv_relation = c(""R2T0/V2"", ""R2T3/V2"", NA, ""V2*R2T3/(R3T2-V2)""),
     nm_name = c(""CL"", ""Q"", ""V"", ""VSS""),
     cmt = 2,
     oral = FALSE
   ),
   dplyr::tibble(
     advan = 3, trans = 4,
-    base_name = c(""R2T0"", ""R2T3"", ""V2"", ""V3""),
-    relation = c(""R2T0*V2"", ""R2T3*V2"", NA, NA),
-    inv_relation = c(""R2T0/V2"", ""R2T3/V2"", NA, NA),
+    base_name = c(""R2T0"", ""R2T3"", ""V2"", ""R3T2""),
+    relation = c(""R2T0*V2"", ""R2T3*V2"", NA, ""V2*R2T3/R3T2""),
+    inv_relation = c(""R2T0/V2"", ""R2T3/V2"", NA, ""V2*R2T3/R3T2""),
     nm_name = c(""CL"", ""Q"", ""V1"", ""V2""),
     cmt = 2,
     oral = FALSE
@@ -66,18 +66,18 @@ dp <- dplyr::bind_rows(
   ),
   dplyr::tibble(
     advan = 4, trans = 3,
-    base_name = c(""R1T2"", ""R2T0"", ""R2T3"", ""V2"", ""V3""),
-    relation = c(NA, ""R2T0*V2"", ""R2T3*V2"", NA, ""V3+V2""),
-    inv_relation = c(NA, ""R2T0/V2"", ""R2T3/V2"", NA, ""V3-V2""),
+    base_name = c(""R1T2"", ""R2T0"", ""R2T3"", ""V2"", ""R3T2""),
+    relation = c(NA, ""R2T0*V2"", ""R2T3*V2"", NA, ""V2+V2*R2T3/R3T2""),
+    inv_relation = c(NA, ""R2T0/V2"", ""R2T3/V2"", NA, ""V2*R2T3/(R3T2-V2)""),
     nm_name = c(""KA"", ""CL"", ""Q"", ""V"", ""VSS""),
     cmt = 2,
     oral = TRUE
   ),
   dplyr::tibble(
     advan = 4, trans = 4,
-    base_name = c(""R1T2"", ""R2T0"", ""R2T3"", ""V2"", ""V3""),
-    relation = c(NA, ""R2T0*V2"", ""R2T3*V2"", NA, NA),
-    inv_relation = c(NA, ""R2T0/V2"", ""R2T3/V2"", NA, NA),
+    base_name = c(""R1T2"", ""R2T0"", ""R2T3"", ""V2"", ""R3T2""),
+    relation = c(NA, ""R2T0*V2"", ""R2T3*V2"", NA, ""V2*R2T3/R3T2""),
+    inv_relation = c(NA, ""R2T0/V2"", ""R2T3/V2"", NA, ""V2*R2T3/R3T2""),
     nm_name = c(""KA"", ""CL"", ""Q"", ""V2"", ""V3""),
     cmt = 2,
     oral = TRUE
@@ -92,9 +92,9 @@ dp <- dplyr::bind_rows(
   ),
   dplyr::tibble(
     advan = 11, trans = 4,
-    base_name = c(""R2T0"", ""R2T3"", ""V2"", ""V3"", ""R2T4"", ""V4""),
-    relation = c(""R2T0*V2"", ""R2T3*V2"", NA, NA, ""R2T4*V2"", NA),
-    inv_relation = c(""R2T0/V2"", ""R2T3/V2"", NA, NA, ""R2T4/V2"", NA),
+    base_name = c(""R2T0"", ""R2T3"", ""V2"", ""R3T2"", ""R2T4"", ""R4T2""),
+    relation = c(""R2T0*V2"", ""R2T3*V2"", NA, ""V2*R2T3/R3T2"", ""R2T4*V2"", ""V2*R2T4/R4T2""),
+    inv_relation = c(""R2T0/V2"", ""R2T3/V2"", NA, ""V2*R2T3/R3T2"", ""R2T4/V2"", ""V2*R2T4/R4T2""),
     nm_name = c(""CL"", ""Q2"", ""V1"", ""V2"", ""Q3"", ""V3""),
     cmt = 3,
     oral = FALSE
@@ -109,9 +109,9 @@ dp <- dplyr::bind_rows(
   ),
   dplyr::tibble(
     advan = 12, trans = 4,
-    base_name = c(""R1T2"", ""R2T0"", ""R2T3"", ""V2"", ""V3"", ""R2T4"", ""V4""),
-    relation = c(NA, ""R2T0*V2"", ""R2T3*V2"", NA, NA, ""R2T4*V2"", NA),
-    inv_relation = c(NA, ""R2T0/V2"", ""R2T3/V2"", NA, NA, ""R2T4/V2"", NA),
+    base_name = c(""R1T2"", ""R2T0"", ""R2T3"", ""V2"", ""R3T2"", ""R2T4"", ""R4T2""),
+    relation = c(NA, ""R2T0*V2"", ""R2T3*V2"", NA, ""V2*R2T3/R3T2"", ""R2T4*V2"", ""V2*R2T4/R4T2""),
+    inv_relation = c(NA, ""R2T0/V2"", ""R2T3/V2"", NA, ""V2*R2T3/R3T2"", ""R2T4/V2"", ""V2*R2T4/R4T2""),
     nm_name = c(""KA"", ""CL"", ""Q3"", ""V2"", ""V3"", ""Q4"", ""V4""),
     cmt = 3,
     oral = TRUE"
tsahota,NMproject,55b95f3e653b4575789000a08af828236a4d7997,Tarj,t.sahota0@gmail.com,2021-11-16T00:37:01Z,Tarj,t.sahota0@gmail.com,2021-11-16T00:37:01Z,bug fix $DES,R/subroutine.R,False,True,True,False,8,2,10,"---FILE: R/subroutine.R---
@@ -291,8 +291,14 @@ subroutine.nm_generic <- function(m, advan = NA, trans = 1, recursive = TRUE) {
 
   if (""RXTY"" %in% dold$base_name) {
 
-    tv_vars <- m %>% grab_variables(""\\bTV\\w*?\\b"")
-    vars <- gsub(""TV"", """", tv_vars)
+    ## get all variables in
+
+    txt <- text(m)
+    txt_words <- unlist(stringr::str_split(txt, stringr::boundary(""word"")))
+    vars <- unique(txt_words[grepl(""^K([0-9]+)T?([0-9]+)$"", txt_words)])
+
+    # tv_vars <- m %>% grab_variables(""\\bTV\\w*?\\b"")
+    # vars <- gsub(""TV"", """", tv_vars)
 
     ## get nm_name and base_name from vars
     dold0 <- data.frame(nm_name = vars)"
tsahota,NMproject,bdcc8e7a88c914d5f8b2aa04834b0e8e01bee921,Tarj,t.sahota0@gmail.com,2021-11-15T23:13:05Z,Tarj,t.sahota0@gmail.com,2021-11-15T23:13:05Z,bug fix $DES A1 -> A(1),R/subroutine.R,False,True,True,False,27,27,54,"---FILE: R/subroutine.R---
@@ -290,34 +290,34 @@ subroutine.nm_generic <- function(m, advan = NA, trans = 1, recursive = TRUE) {
   )
 
   if (""RXTY"" %in% dold$base_name) {
-    
+
     tv_vars <- m %>% grab_variables(""\\bTV\\w*?\\b"")
     vars <- gsub(""TV"", """", tv_vars)
-    
+
     ## get nm_name and base_name from vars
     dold0 <- data.frame(nm_name = vars)
     dold0$base_name <- gsub(""K([0-9]+)T?([0-9]+)"", ""R\\1T\\2"", dold0$nm_name)
-    
+
     ## create a new dold based on this
     dold_names <- names(dold)
     dold <- merge(
       dold[1, names(dold)[!names(dold) %in% c(""base_name"",""nm_name"")]],
       dold0
     )
-    
+
     dold <- dplyr::as_tibble(dold[, dold_names])
-    
+
   }
-  
+
   dnew <- dp %>% dplyr::filter(
     .data$advan %in% new_advan,
     .data$trans %in% new_trans
   )
-  
+
   ## if one of them is KXY type and other isn't, can use the other to normalize this
   ## if both are KXY type then no parameter transformation is needed
-  
-  ## use these to modify dold to be more specific 
+
+  ## use these to modify dold to be more specific
 
   #if (new_advan %in% 6) stop(""not yet implemented"")
 
@@ -327,10 +327,10 @@ subroutine.nm_generic <- function(m, advan = NA, trans = 1, recursive = TRUE) {
     ## can assume that dold is trans 1 and compatible
     dnew <- dold
     dnew$advan <- new_advan
-    dnew$trans <- new_trans    
-    
+    dnew$trans <- new_trans
+
     dnew$nm_name <- gsub(""R"", ""K"",dnew$base_name)
-    
+
   }
 
   thetas <- raw_init_theta(m)
@@ -345,7 +345,7 @@ subroutine.nm_generic <- function(m, advan = NA, trans = 1, recursive = TRUE) {
   d <- dplyr::full_join(dold, dnew, by = ""base_name"")
 
   ## loop through rows
-  
+
   for (i in seq_len(nrow(d))) {
     di <- d[i, ]
     strategy <- ""none""
@@ -387,24 +387,24 @@ subroutine.nm_generic <- function(m, advan = NA, trans = 1, recursive = TRUE) {
       relation_expr <- parse(text = relation)
       new_theta <-
         try(with(theta_vec, eval(relation_expr)), silent = TRUE)
-      
+
       if (new_advan %in% c(linear_advans, ode_advans) & !is.na(relation)) {
-        ## if going to DES or advan 5 type advan, assume no reparameterisation 
+        ## if going to DES or advan 5 type advan, assume no reparameterisation
         ## just add K2T0 = CL/V2 definition to bottom of $PK
         add_to_dollar_PK <- paste(di$nm_name.y, ""="", relation)
-        
-        m <- m %>% dollar(""PK"", add_to_dollar_PK, append = TRUE) 
-        
+
+        m <- m %>% dollar(""PK"", add_to_dollar_PK, append = TRUE)
+
       } else {
-        
+
         ## if not going to $DES or advan 5 type, assume reparameterisation
         ## just rename the parameter
-        
+
         m <- m %>% rename_parameter_(
           new_name = di$nm_name.y,
           name = di$nm_name.x
         )
-        
+
         ## modify initials
         if (!inherits(new_theta, ""try-error"")) {
           ithetai <- init_theta(m)
@@ -419,7 +419,7 @@ subroutine.nm_generic <- function(m, advan = NA, trans = 1, recursive = TRUE) {
           }
           ithetai$init[ithetai$name == di$nm_name.y] <-
             signif(ithetai$init[ithetai$name == di$nm_name.y], 5)
-          
+
           m <- m %>% init_theta(ithetai)
         }
       }
@@ -448,9 +448,9 @@ subroutine.nm_generic <- function(m, advan = NA, trans = 1, recursive = TRUE) {
   ##########################
 
   if (new_advan %in% c(linear_advans, ode_advans)) {
-    
+
     ## find no. of compartments needed.
-    
+
     R_regex <- ""R([0-9]+)T([0-9]+)""
     #R_names <- thetas$name[grepl(R_regex, thetas$name)]
     R_names <- dnew$base_name[grepl(R_regex, dnew$base_name)]
@@ -511,7 +511,7 @@ subroutine.nm_generic <- function(m, advan = NA, trans = 1, recursive = TRUE) {
 
       d_param <- data.frame(
         name = basic_param_names,
-        term = paste0(basic_param_names, ""*A"" ,comp_from),
+        term = paste0(basic_param_names, ""*A("" ,comp_from, "")""),
         comp_from,
         comp_to
       )
@@ -554,11 +554,11 @@ subroutine.nm_generic <- function(m, advan = NA, trans = 1, recursive = TRUE) {
   }
 
   ## trim white space lines
-  
+
   txt <- text(m)
   trimmed_txt <- strsplit(gsub(""\n{3,}"", ""\n\n"", paste(txt, collapse = ""\n"")), ""\n"")[[1]]
   m <- m %>% ctl_contents_simple(trimmed_txt)
-  
+
   m
 }
 #' @export"
tsahota,NMproject,1a466f6981f14360d9104209030c2c6691331f46,Tarj,t.sahota0@gmail.com,2021-11-15T20:52:14Z,Tarj,t.sahota0@gmail.com,2021-11-15T20:52:14Z,bug fix subroutine tests,tests/testthat/test-subroutine.R,False,True,True,False,21,20,41,"---FILE: tests/testthat/test-subroutine.R---
@@ -3,60 +3,61 @@ proj_name <- ""test_nmproject""
 proj_path <- file.path(tempdir(), proj_name)
 
 test_that(""manual_edit"", {
-  
+
   skip_if_not(rmarkdown::pandoc_available(""1.12.3""))
-  
+
   currentwd <- getwd()
   if (file.exists(proj_path)) unlink(proj_path, recursive = TRUE, force = TRUE)
   with_temp_git_config(nm_create_analysis_project(proj_path))
   on.exit({
     setwd(currentwd)
     unlink(proj_path, recursive = TRUE, force = TRUE)
   })
-  
-  
+
+
   testfilesloc <- file.path(currentwd, ""theopp"")
   zip_file <- file.path(currentwd, ""theopp.zip"")
   unzip(zip_file)
-  
+
   setwd(proj_path)
-  
+
   file.copy(file.path(testfilesloc, "".""), ""."", recursive = TRUE)
   file.rename(""cache"", "".cache"")
-  
+
   unlink(testfilesloc, recursive = TRUE)
-  
+
   ## end boiler plate
   ############################
-  
+
+  overwrite_behaviour(""skip"")
   run_all_scripts(index = 1:2)
-  
+
   m1 <- readRDS(""Results/m1.RDS"")
-  
+
   ## check all conversions work without errors
   mt <- .available_advans %>%
-    mutate(m = m1 %>% child(run_id = .data$label) %>% 
+    mutate(m = m1 %>% child(run_id = .data$label) %>%
              subroutine(advan = .data$advan,
                         trans = .data$trans))
-  
+
   ## check advans and trans are the way they should be
   expect_equal(advan(mt$m), mt$advan)
-  expect_equal(trans(mt$m), mt$trans)  
-  
+  expect_equal(trans(mt$m), mt$trans)
+
   ### advan 5 conversion
   m1a5 <- m1 %>% subroutine(advan = 5)
   expect_true(any(grepl(""K1T2"", text(m1a5)[[1]])))
-  
+
   ### diff tests
   expect_true(length(nm_diff(m1, m1a5)) > 0)
   expect_true(length(nm_diff(m1, text(m1a5)[[1]])) > 0)
-  
+
   ### advan 13 conversion
   m1a13 <- m1 %>% subroutine(advan = 13)
   expect_true(any(grepl(""K1T2"", text(m1a13)[[1]])))
   expect_true(any(grepl(""\\$DES"", text(m1a13)[[1]])))
-  
+
   m1reverse <- m1a13 %>% subroutine(advan = 2)
-  
-  
+
+
 })"
tsahota,NMproject,99c268378614db2dceb5ca574cf91c8da0ccf48a,tarjinde,tarjinder.z.sahota@gsk.com,2021-11-15T16:02:06Z,tarjinde,tarjinder.z.sahota@gsk.com,2021-11-15T16:02:06Z,example update and template vpc namespace fix,inst/extdata/examples/theopp/Scripts/basic_boot.Rmd;inst/extdata/examples/theopp/Scripts/basic_gof.Rmd;inst/extdata/examples/theopp/Scripts/basic_ppc.Rmd;inst/extdata/examples/theopp/Scripts/basic_vpc.Rmd;inst/extdata/examples/theopp/Scripts/s05_advanced_usage.Rmd;inst/extdata/theopp.zip;inst/rmarkdown/templates/basic_ppc/skeleton/skeleton.Rmd;inst/rmarkdown/templates/basic_vpc/skeleton/skeleton.Rmd;tests/testthat/theopp.zip,True,False,True,False,42,27,69,"---FILE: inst/extdata/examples/theopp/Scripts/basic_boot.Rmd---
@@ -26,14 +26,16 @@ params:
 <!--   4. use nm_render() to run on other model objects -->
 
 
-```{r setup2, include=F}
+```{r setup, include=F}
 ## DO NOT MODIFY THIS BLOCK (unless you know what you're doing)
 library(knitr)
 library(rprojroot)
-opts_knit$set(root.dir = find_root(has_file("".Rprofile"") | 
-                                     is_rstudio_project | 
-                                     is_r_package | 
-                                     is_git_root))
+opts_knit$set(root.dir = find_root(
+  has_file("".Rprofile"") | 
+    is_rstudio_project | 
+    is_r_package | 
+    is_git_root
+))
 opts_chunk$set(echo = FALSE)
 opts_chunk$set(message = FALSE)
 if(!is.null(knitr::opts_knit$get('rmarkdown.pandoc.to'))){

---FILE: inst/extdata/examples/theopp/Scripts/basic_gof.Rmd---
@@ -24,14 +24,16 @@ date: ""`r Sys.time()`""
 <!--   4. use nm_render() to run on other model objects -->
 
 
-```{r setup2, include=F}
+```{r setup, include=F}
 ## DO NOT MODIFY THIS BLOCK (unless you know what you're doing)
 library(knitr)
 library(rprojroot)
-opts_knit$set(root.dir = find_root(has_file("".Rprofile"") | 
-                                     is_rstudio_project | 
-                                     is_r_package | 
-                                     is_git_root))
+opts_knit$set(root.dir = find_root(
+  has_file("".Rprofile"") | 
+    is_rstudio_project | 
+    is_r_package | 
+    is_git_root
+))
 opts_chunk$set(echo = FALSE)
 opts_chunk$set(message = FALSE)
 if(!is.null(knitr::opts_knit$get('rmarkdown.pandoc.to'))){
@@ -88,6 +90,13 @@ library(ggplot2)
   geom_point() +
   geom_abline()
 
+.m %>%
+  output_table_first() %>%
+  ggplot(aes(x = TIME, y = DV)) +
+  theme_bw() +
+  geom_point() +
+  geom_line(aes(y = IPRED, group = ID), colour = ""red"")
+
 ```
 
 ```{r xpose_plot, warning=FALSE}

---FILE: inst/extdata/examples/theopp/Scripts/basic_ppc.Rmd---
@@ -24,14 +24,16 @@ date: ""`r Sys.time()`""
 <!--   4. use nm_render() to run on other model objects -->
 
 
-```{r setup2, include=F}
+```{r setup, include=F}
 ## DO NOT MODIFY THIS BLOCK (unless you know what you're doing)
 library(knitr)
 library(rprojroot)
-opts_knit$set(root.dir = find_root(has_file("".Rprofile"") | 
-                                     is_rstudio_project | 
-                                     is_r_package | 
-                                     is_git_root))
+opts_knit$set(root.dir = find_root(
+  has_file("".Rprofile"") | 
+    is_rstudio_project | 
+    is_r_package | 
+    is_git_root
+))
 opts_chunk$set(echo = FALSE)
 opts_chunk$set(message = FALSE)
 if(!is.null(knitr::opts_knit$get('rmarkdown.pandoc.to'))){

---FILE: inst/extdata/examples/theopp/Scripts/basic_vpc.Rmd---
@@ -24,14 +24,16 @@ date: ""`r Sys.time()`""
 <!--   4. use nm_render() to run on other model objects -->
 
 
-```{r setup2, include=F}
+```{r setup, include=F}
 ## DO NOT MODIFY THIS BLOCK (unless you know what you're doing)
 library(knitr)
 library(rprojroot)
-opts_knit$set(root.dir = find_root(has_file("".Rprofile"") | 
-                                     is_rstudio_project | 
-                                     is_r_package | 
-                                     is_git_root))
+opts_knit$set(root.dir = find_root(
+  has_file("".Rprofile"") | 
+    is_rstudio_project | 
+    is_r_package | 
+    is_git_root
+))
 opts_chunk$set(echo = FALSE)
 opts_chunk$set(message = FALSE)
 if(!is.null(knitr::opts_knit$get('rmarkdown.pandoc.to'))){
@@ -92,7 +94,7 @@ sim$DV <- sim$DV_OUT  ## needed because output_table puts DV in DV_OUT
 
 ```{r vpc_basic}
 
-vpc(
+vpc::vpc(
   sim = sim,
   obs = obs,
   obs_cols = list(idv = ""TPERIOD""),
@@ -104,7 +106,7 @@ vpc(
 
 ```{r pred_corr}
 
-vpc(
+vpc::vpc(
   sim = sim,
   obs = obs,
   obs_cols = list(idv = ""TPERIOD""),
@@ -121,7 +123,7 @@ vpc(
 sim$WT_c = Hmisc::cut2(sim$WT, g = 2)
 obs$WT_c = Hmisc::cut2(obs$WT, g = 2)
 
-vpc(
+vpc::vpc(
   sim = sim,
   obs = obs,
   obs_cols = list(idv = ""TPERIOD""),

---FILE: inst/extdata/examples/theopp/Scripts/s05_advanced_usage.Rmd---
@@ -168,7 +168,7 @@ dc <- tibble::tibble(cores = c(1, 2, 3)) %>%  ## only 3 different values to test
            ## run them all with the following execute command
            cmd(parallel_execute) %>%
            ## and the following parafile
-           parafile(""/opt/NONMEM/nm750/run/mpilinux8.pnm"") %>%
+           parafile(""/opt/NONMEM/nm75/run/mpilinux8.pnm"") %>%
            ## and finally set the cores to the ""cores"" vector
            cores(cores))
 

---FILE: inst/rmarkdown/templates/basic_vpc/skeleton/skeleton.Rmd---
@@ -94,7 +94,7 @@ sim$DV <- sim$DV_OUT  ## needed because output_table puts DV in DV_OUT
 
 ```{r vpc_basic}
 
-vpc(
+vpc::vpc(
   sim = sim,
   obs = obs,
   obs_cols = list(idv = ""TPERIOD""),
@@ -106,7 +106,7 @@ vpc(
 
 ```{r pred_corr}
 
-vpc(
+vpc::vpc(
   sim = sim,
   obs = obs,
   obs_cols = list(idv = ""TPERIOD""),
@@ -123,7 +123,7 @@ vpc(
 sim$WT_c = Hmisc::cut2(sim$WT, g = 2)
 obs$WT_c = Hmisc::cut2(obs$WT, g = 2)
 
-vpc(
+vpc::vpc(
   sim = sim,
   obs = obs,
   obs_cols = list(idv = ""TPERIOD""),"
tsahota,NMproject,2839300286d9cf35a7b6e9a83aaa9b3635567858,tarjinde,tarjinder.z.sahota@gsk.com,2021-11-15T16:01:38Z,tarjinde,tarjinder.z.sahota@gsk.com,2021-11-15T16:01:38Z,bug fix nm_list_render when running within `run_all_scripts()`,R/nm_render.R,False,True,True,False,7,0,7,"---FILE: R/nm_render.R---
@@ -221,6 +221,13 @@ nm_list_render <- function(m,
       )
     })
   } else {
+    
+    ## replace setup chunks with setup2 to prevent clash
+    input_contents0 <- readLines(input)
+    input_contents <- gsub(""^(```\\{r setup)([, \\}])"", ""\\12\\2"", input_contents0)
+    write(input_contents, input)
+    on.exit(write(input_contents0, input))
+    
     rmarkdown::render(
       input = input,
       output_file = output_file,"
tsahota,NMproject,7d876c3e164c48508e1b73efda9993637c73a328,Tarj,t.sahota0@gmail.com,2021-09-19T19:49:24Z,Tarj,t.sahota0@gmail.com,2021-09-19T19:49:24Z,"bug fix subroutine, ADVAN 5 conversion",R/subroutine.R;man/subroutine.Rd,False,True,True,False,60,28,88,"---FILE: R/subroutine.R---
@@ -202,11 +202,11 @@ default_trans <- function(advan) {
 #'
 #' @seealso [advan()]
 #'
-#' @examples 
-#' 
+#' @examples
+#'
 #' # create example object m1 from package demo files
 #' exdir <- system.file(""extdata"", ""examples"", ""theopp"", package = ""NMproject"")
-#' m1 <- new_nm(run_id = ""m1"", 
+#' m1 <- new_nm(run_id = ""m1"",
 #'              based_on = file.path(exdir, ""Models"", ""ADVAN2.mod""),
 #'              data_path = file.path(exdir, ""SourceData"", ""THEOPP.csv""))
 #'
@@ -222,11 +222,11 @@ default_trans <- function(advan) {
 #'     m = m1 %>% child(run_id = label) %>%
 #'       subroutine(advan = advan, trans = trans)
 #'   )
-#' 
+#'
 #' ds
-#' 
+#'
 #' ds$m %>% dollar(""PK"")
-#' 
+#'
 #' @export
 
 subroutine <- function(m, advan = NA, trans = 1, recursive = TRUE) {
@@ -235,6 +235,10 @@ subroutine <- function(m, advan = NA, trans = 1, recursive = TRUE) {
 
 #' @export
 subroutine.nm_generic <- function(m, advan = NA, trans = 1, recursive = TRUE) {
+
+  ode_advans <- c(6, 8, 9, 13, 14, 15, 16, 17, 18)
+  linear_advans <- c(5, 7)
+
   dps <- available_advans
   dps$trans[dps$trans %in% NA] <- 1
   dp$trans[dp$trans %in% NA] <- 1
@@ -269,7 +273,7 @@ subroutine.nm_generic <- function(m, advan = NA, trans = 1, recursive = TRUE) {
     stop(""stopping..."", call. = FALSE)
   }
 
-  if (new_advan %in% c(6, 7, 8, 9, 13)) { ## first to ADVAN5
+  if (new_advan %in% ode_advans) { ## first to ADVAN5
     m <- m %>% subroutine(advan = 5)
     old_advan <- advan(m)
     old_trans <- trans(m)
@@ -289,9 +293,9 @@ subroutine.nm_generic <- function(m, advan = NA, trans = 1, recursive = TRUE) {
     .data$trans %in% new_trans
   )
 
-  if (new_advan %in% 6) stop(""not yet implemented"")
+  #if (new_advan %in% 6) stop(""not yet implemented"")
 
-  if (new_advan %in% c(5, 6, 7, 8, 9, 13)) {
+  if (new_advan %in% c(linear_advans, ode_advans)) {
 
     ## grab all existing variables.
     tv_vars <- m %>% grab_variables(""\\bTV\\w*?\\b"")
@@ -300,7 +304,7 @@ subroutine.nm_generic <- function(m, advan = NA, trans = 1, recursive = TRUE) {
     dtrans_detect <- dp %>%
       dplyr::group_by(.data$advan, .data$trans) %>%
       dplyr::summarise(
-        match_trans = all(vars %in% .data$nm_name),
+        match_trans = all(.data$nm_name %in% vars),#all(vars %in% .data$nm_name),
         n_params = length(.data$nm_name)
       ) %>%
       dplyr::filter(.data$match_trans)
@@ -309,12 +313,15 @@ subroutine.nm_generic <- function(m, advan = NA, trans = 1, recursive = TRUE) {
       stop(""can't match $PK parameters to an available advan/trans combo (available_trans)"", call. = FALSE)
     }
 
-    dtrans_detect <- dtrans_detect[1, ] ## simplest
+    dtrans_detect <- dtrans_detect[
+      dtrans_detect$n_params %in% max(dtrans_detect$n_params),
+      ] ## largest no. of parameters is going to be best
+    dtrans_detect <- dtrans_detect[1, ] ## should be only 1 left
 
     old_matched_trans <- dtrans_detect$trans
     old_matched_advan <- dtrans_detect$advan
 
-    ## redefine dold
+    ## redefine dnew based on dold
     dnew <- dp %>% dplyr::filter(
       .data$advan %in% old_matched_advan,
       .data$trans %in% old_matched_trans
@@ -323,9 +330,14 @@ subroutine.nm_generic <- function(m, advan = NA, trans = 1, recursive = TRUE) {
     dnew$advan <- new_advan
     dnew$trans <- new_trans
 
-    ## add KXY definitions to $PK
+    ## dnew$nm_name will be used to rename/create new parameters
+    ##  in the case of no relation (no transform needed)
+    ##    a simple rename will be sufficient
+    ##  in case of a relation (e.g. CL)
+    ##    want to keep TVCL = ....
+    ##    but just add a K2T0 = CL/V
 
-    if (!old_advan %in% c(5, 6, 7, 8, 9, 13)) {
+    if (!old_advan %in% c(linear_advans, ode_advans)) {
       ## not needed if already KXTY type advan
       for (i in seq_len(nrow(dold))) {
         if (!is.na(dold$inv_relation[i])) {
@@ -336,22 +348,32 @@ subroutine.nm_generic <- function(m, advan = NA, trans = 1, recursive = TRUE) {
           definition_to_add <- paste0(
             gsub(""R"", ""K"", dold$base_name[i]), "" = "", inv_relation, ""\n""
           )
+          m <- m %>%
+            target(""PK"") %>%
+            text(definition_to_add, append = TRUE) %>%
+            untarget()
+
         } else {
-          definition_to_add <- paste0(
-            gsub(""R"", ""K"", dold$base_name[i]), "" = "", dold$nm_name[i], ""\n""
-          )
+          dnew$nm_name[i] <- gsub(""R"", ""K"", dnew$base_name[i])
         }
 
-        m <- m %>%
-          target(""PK"") %>%
-          text(definition_to_add, append = TRUE) %>%
-          untarget()
+
+        # else {
+        #   definition_to_add <- paste0(
+        #     gsub(""R"", ""K"", dold$base_name[i]), "" = "", dold$nm_name[i], ""\n""
+        #   )
+        # }
+
+        # m <- m %>%
+        #   target(""PK"") %>%
+        #   text(definition_to_add, append = TRUE) %>%
+        #   untarget()
       }
     }
   }
 
 
-  if (old_advan %in% c(5, 6, 7, 8, 9, 13)) {
+  if (old_advan %in% c(linear_advans, ode_advans)) {
     dold <- dnew
     dold$advan <- old_advan
     dold$trans <- old_trans
@@ -417,6 +439,7 @@ subroutine.nm_generic <- function(m, advan = NA, trans = 1, recursive = TRUE) {
         name = di$nm_name.x
       )
 
+      ## modify initials
       if (!inherits(new_theta, ""try-error"")) {
         ithetai <- init_theta(m)
         ithetai$init[ithetai$name == di$nm_name.y] <- new_theta
@@ -457,7 +480,7 @@ subroutine.nm_generic <- function(m, advan = NA, trans = 1, recursive = TRUE) {
 
   ##########################
 
-  if (new_advan %in% c(5, 6, 7, 8, 9, 13)) {
+  if (new_advan %in% c(linear_advans, ode_advans)) {
     R_regex <- ""R([0-9]+)T([0-9]+)""
     R_names <- dnew$base_name[grepl(R_regex, dnew$base_name)]
 
@@ -470,7 +493,6 @@ subroutine.nm_generic <- function(m, advan = NA, trans = 1, recursive = TRUE) {
 
     if (any(grepl(""\\s*\\$MODEL"", text(m)))) {
       ## there's already a $MODEL remove it
-
       models_text <- m %>% dollar(""MODEL"")
       ## look for number of = signs
 
@@ -486,7 +508,17 @@ subroutine.nm_generic <- function(m, advan = NA, trans = 1, recursive = TRUE) {
       }
     } else {
       ## no $MODEL, create
+      ## add DEFDOSE and DEFOBS
+      defdose_comp <- 1
+      if (all(dnew$oral)) {
+        defobs_comp <- 2
+      } else {
+        defobs_comp <- 1
+      }
+
       models_text <- paste0(""COMP = (COMP"", seq_len(n_compartments), "")"")
+      models_text[defdose_comp] <- gsub(""\\)"", "", DEFDOSE)"", models_text[defdose_comp])
+      models_text[defobs_comp] <- gsub(""\\)"", "", DEFOBS)"", models_text[defobs_comp])
       models_text <- c(""$MODEL"", models_text)
 
       if (!old_advan %in% c(5, 6, 7, 8, 9, 13)) {
@@ -496,7 +528,7 @@ subroutine.nm_generic <- function(m, advan = NA, trans = 1, recursive = TRUE) {
       }
     }
 
-    if (new_advan %in% c(6, 7, 8, 9, 13)) { ## insert $DES
+    if (new_advan %in% ode_advans) { ## insert $DES
 
       lhs <- paste0(""DADT("", seq_len(n_current_compartments), "")"")
 
@@ -569,11 +601,11 @@ subroutine.nm_list <- Vectorize_nm_list(subroutine.nm_generic, SIMPLIFY = FALSE)
 #'
 #' @param m An nm object.
 #' @param text Optional number/character number to set to.
-#' 
+#'
 #' @return If `text` is specified returns an nm object with modified
 #'   `ctl_contents` field.  Otherwise returns the value of the advan, trans, or
 #'   tol.
-#' 
+#'
 #' @seealso [subroutine()]
 #' @name dollar_subroutine
 #' @export

---FILE: man/subroutine.Rd---
@@ -31,7 +31,7 @@ Can only switch between subroutines listed in \code{available_advans}.
 
 # create example object m1 from package demo files
 exdir <- system.file(""extdata"", ""examples"", ""theopp"", package = ""NMproject"")
-m1 <- new_nm(run_id = ""m1"", 
+m1 <- new_nm(run_id = ""m1"",
              based_on = file.path(exdir, ""Models"", ""ADVAN2.mod""),
              data_path = file.path(exdir, ""SourceData"", ""THEOPP.csv""))
 "
tsahota,NMproject,dd00a53333340a4c98f18f77a9eb3ad5151b7181,tarjinde,tarjinder.z.sahota@gsk.com,2021-09-09T13:53:04Z,tarjinde,tarjinder.z.sahota@gsk.com,2021-09-09T13:53:04Z,used based file info from patch file instead of parent,R/apply_manual_edit.R,False,True,True,False,10,7,17,"---FILE: R/apply_manual_edit.R---
@@ -34,17 +34,20 @@ apply_manual_edit.nm_generic <- function(m, patch_id, return_merge_conf_ctl = FA
   
   ## retrain backwards compatibility with ""patch-sdlkfjs.."" format patch ids.
   patch_id <- gsub(""patch-"", """", patch_id)
-  
-  temp_ctl_path <- file.path(nm_dir(""models""), paste0(""base-"", patch_id))
-  mnew <- m %>%
-    ctl_path(temp_ctl_path) %>%
-    write_ctl(force = TRUE)
-  on.exit(unlink(temp_ctl_path))
-  
   patch_name <- paste0(""patch-"", patch_id)
   patch_path <- file.path(nm_dir(""models""), ""patches"", patch_name)
   patch_file_exists <- file.exists(patch_path)
   if (!patch_file_exists) stop(""patch file doesn't exist"")
+  patch_contents <- readLines(patch_path)
+  
+  temp_ctl_path <- patch_contents[grepl(""^---"", patch_contents)]
+  temp_ctl_path <- gsub(""\\S+\\s.{2}(.*)"", ""\\1"", temp_ctl_path)
+  
+  #temp_ctl_path <- file.path(run_in(m), paste0(""base-"", patch_id))
+  mnew <- m %>%
+    simple_field(ctl_path = temp_ctl_path, ctl_name = basename(temp_ctl_path))
+  mnew %>% text() %>% writeLines(temp_ctl_path)
+  on.exit(unlink(temp_ctl_path))
   
   patch_cmd <- paste(""git apply -C1"", patch_path)
   "
tsahota,NMproject,a0a05b425891785353f7f3b3fd995635f0442722,tarjinde,tarjinder.z.sahota@gsk.com,2021-09-09T13:39:29Z,tarjinde,tarjinder.z.sahota@gsk.com,2021-09-09T13:39:29Z,new snippet bug fix,R/snippet_setup.R,False,True,True,False,9,9,18,"---FILE: R/snippet_setup.R---
@@ -93,15 +93,15 @@ setup_code_completion <- function(force = FALSE,
 
     dir.create(dirname(snippet_path), showWarnings = FALSE, recursive = TRUE)
     write(snippet_contents, file = snippet_path)
-    usethis::ui_done(""Snippet file updated: {usethis::ui_path(snippet_path)}"")
-
-    if (!is.null(rstudioapi::getActiveProject())) {
-      ans <- usethis::ui_yeah(""RStudio needs to restart for changes to come into effect"",
-                              yes = ""Restart now"", no = ""I'll do it later"", shuffle = FALSE)
-      if (ans) rstudioapi::openProject()
-    } else {
-      usethis::ui_todo(""Restart RStudio (Session -> Quit Session) for changes to take effect"")
-    }
+  }
+  usethis::ui_done(""Snippet file updated: {usethis::ui_path(snippet_path)}"")
+  
+  if (!is.null(rstudioapi::getActiveProject())) {
+    ans <- usethis::ui_yeah(""RStudio needs to restart for changes to come into effect"",
+                            yes = ""Restart now"", no = ""I'll do it later"", shuffle = FALSE)
+    if (ans) rstudioapi::openProject()
+  } else {
+    usethis::ui_todo(""Restart RStudio (Session -> Quit Session) for changes to take effect"")
   }
 }
 "
tsahota,NMproject,3981b4939efe905703128a975c8c0e819982393e,tarjinde,tarjinder.z.sahota@gsk.com,2021-09-09T09:58:30Z,tarjinde,tarjinder.z.sahota@gsk.com,2021-09-09T09:58:30Z,bug dir.create before writing snippet,R/snippet_setup.R,False,True,True,False,3,0,3,"---FILE: R/snippet_setup.R---
@@ -17,6 +17,7 @@
 #'
 #' @export
 
+
 setup_code_completion <- function(force = FALSE,
                                             snippet_path = find_snippet_path()) {
 
@@ -67,6 +68,7 @@ setup_code_completion <- function(force = FALSE,
   ## can now assume we have consent
 
   if (!snippet_exists) {
+    dir.create(dirname(snippet_path), showWarnings = FALSE, recursive = TRUE)
     file.copy(template_path, snippet_path)
   } else {
     ## modify the snippets file
@@ -89,6 +91,7 @@ setup_code_completion <- function(force = FALSE,
       stop(""Hit an error in modifying r.snippets, aborting to be safe"")
     })
 
+    dir.create(dirname(snippet_path), showWarnings = FALSE, recursive = TRUE)
     write(snippet_contents, file = snippet_path)
     usethis::ui_done(""Snippet file updated: {usethis::ui_path(snippet_path)}"")
 "
tsahota,NMproject,d72ff1bcccb7645b1e56cd52c920c62df07fb212,Tarj,t.sahota0@gmail.com,2021-09-06T18:04:41Z,Tarj,t.sahota0@gmail.com,2021-09-06T18:04:41Z,bug fix as_nm_list -> as.list in selected_text,R/addin-apps.R,False,True,True,False,2,2,4,"---FILE: R/addin-apps.R---
@@ -29,8 +29,8 @@ get_single_object_for_app <- function() {
   on.exit(overwrite_behaviour(old_behaviour))
 
   ## temporarily disable run_nm
-  selected_text <- gsub(""\\brun_nm\\b\\("", ""as_nm_list("", selected_text)
-  selected_text <- gsub(""\\brun_nm_batch\\b\\("", ""as_nm_list("", selected_text)
+  selected_text <- gsub(""\\brun_nm\\b\\("", ""as.list("", selected_text)
+  selected_text <- gsub(""\\brun_nm_batch\\b\\("", ""as.list("", selected_text)
 
   suppressMessages({
     m <- eval(parse(text = selected_text), envir = parent.frame(n = 3))"
tsahota,NMproject,ea142480526383f2b1a1f81a3b55d9a989e7947f,Tarj,t.sahota0@gmail.com,2021-09-05T22:45:12Z,Tarj,t.sahota0@gmail.com,2021-09-06T16:34:54Z,"selected_text is modified by text

bug fix windows",R/addin-apps.R,False,True,True,False,3,2,5,"---FILE: R/addin-apps.R---
@@ -28,8 +28,9 @@ get_single_object_for_app <- function() {
   overwrite_behaviour(""skip"")
   on.exit(overwrite_behaviour(old_behaviour))
 
-  ## temporarily disable run_nm  
-  run_nm <- identity
+  ## temporarily disable run_nm
+  selected_text <- gsub(""\\brun_nm\\b\\("", ""as_nm_list("", selected_text)
+  selected_text <- gsub(""\\brun_nm_batch\\b\\("", ""as_nm_list("", selected_text)
 
   suppressMessages({
     m <- eval(parse(text = selected_text), envir = parent.frame(n = 3))"
tsahota,NMproject,4835e2582154bb73c5618bb103fd77ebda204d11,Jane,jane@example.com,2021-09-04T16:18:11Z,Jane,jane@example.com,2021-09-04T16:18:11Z,bug fix where dataset has missing values in columns featuring in IGNORE statements,R/output_table.R,False,True,True,False,7,3,10,"---FILE: R/output_table.R---
@@ -6,13 +6,13 @@
 #' @param r An nm object.
 #' @param dorig Optional `data.frame`. NONMEM input dataset.
 #' @param ... Additional arguments to pass on to [read.csv()].
-#' 
+#'
 #' @return A list of `tibble`s with merged version of all output $TABLEs and the
 #'   input data.  Additional columns will be `INNONMEM` which will be TRUE for
 #'   rows that were not ignored by NONMEM.  For simulation control files there
 #'   is also `DV_OUT` which will contain simulated `DV` values. `DV` will always
 #'   be unmodified from the input dataset.
-#' 
+#'
 #' @keywords internal
 #' @export
 
@@ -46,7 +46,11 @@ nm_output.nm_generic <- function(r, dorig, ...) {
     dORD <- seq_len(nrow(dorig))
   } else {
     expre <- parse(text = filter_statements)
-    dORD <- which(with(dorig, eval(expre)))
+    ## temporarily put NAs to zero for applying filtering
+    ## this is what NONMEM does where ""."" = 0
+    dorig_zeros <- dorig
+    dorig_zeros[is.na(dorig_zeros)] <- 0
+    dORD <- which(with(dorig_zeros, eval(expre)))
   }
 
   if (nrow(d) %% length(dORD) != 0) {"
tsahota,NMproject,aeb9eba37e2deb344ba4092312ef2696d678987a,tarj,t.sahota0@gmail.com,2021-09-04T13:30:28Z,tarj,t.sahota0@gmail.com,2021-09-04T13:30:28Z,test fix,DESCRIPTION;R/with_temp_git_config.R;tests/testthat/test-basic.R;tests/testthat/test-manual_edit.R;tests/testthat/test-theopp.R,False,True,True,False,50,30,80,"---FILE: DESCRIPTION---
@@ -122,5 +122,6 @@ Collate:
     'system-hooks.R'
     'text.R'
     'update_parameters.R'
+    'with_temp_git_config.R'
     'zzz.R'
 Roxygen: list(markdown = TRUE)

---FILE: R/with_temp_git_config.R---
@@ -0,0 +1,19 @@
+with_temp_git_config <- function(code,
+                                 user.name = ""user"",
+                                 user.email = ""user@email.com""){
+
+  on.exit(invisible())
+
+  if (!git_user_name_exists()) {
+    git2r::config(global = TRUE, user.name = user.name)
+    on.exit(git2r::config(global = TRUE, user.name = NULL), add = TRUE)
+  }
+
+  if (!git_user_email_exists()) {
+    git2r::config(global = TRUE, user.email = user.email)
+    on.exit(git2r::config(global = TRUE, user.email = NULL), add = TRUE)
+  }
+
+  eval(code)
+
+}

---FILE: tests/testthat/test-basic.R---
@@ -2,11 +2,11 @@ proj_name <- ""test_nmproject""
 proj_path <- file.path(tempdir(), proj_name)
 
 test_that(""Project has basic functionality"", {
-  
+
   skip_if_not(rmarkdown::pandoc_available(""1.12.3""))
-  
+
   currentwd <- getwd()
-  nm_create_analysis_project(proj_path)
+  with_temp_git_config(nm_create_analysis_project(proj_path))
   on.exit({
     setwd(currentwd)
     unlink(proj_path, recursive = TRUE, force = TRUE)
@@ -40,11 +40,11 @@ test_that(""Project has basic functionality"", {
 
 
 test_that(""set up"", {
-  
+
   skip_if_not(rmarkdown::pandoc_available(""1.12.3""))
-  
+
   currentwd <- getwd()
-  nm_create_analysis_project(proj_path)
+  with_temp_git_config(nm_create_analysis_project(proj_path))
   on.exit({
     setwd(currentwd)
     unlink(proj_path, recursive = TRUE, force = TRUE)

---FILE: tests/testthat/test-manual_edit.R---
@@ -3,58 +3,58 @@ proj_name <- ""test_nmproject""
 proj_path <- file.path(tempdir(), proj_name)
 
 test_that(""manual_edit"", {
-  
+
   skip_if_not(rmarkdown::pandoc_available(""1.12.3""))
-  
+
   currentwd <- getwd()
   if (file.exists(proj_path)) unlink(proj_path, recursive = TRUE, force = TRUE)
-  nm_create_analysis_project(proj_path)
+  with_temp_git_config(nm_create_analysis_project(proj_path))
   on.exit({
     setwd(currentwd)
     unlink(proj_path, recursive = TRUE, force = TRUE)
   })
-  
-  
+
+
   testfilesloc <- file.path(currentwd, ""theopp"")
   zip_file <- file.path(currentwd, ""theopp.zip"")
   unzip(zip_file)
-  
+
   setwd(proj_path)
-  
+
   file.copy(file.path(testfilesloc, "".""), ""."", recursive = TRUE)
   file.rename(""cache"", "".cache"")
-  
+
   unlink(testfilesloc, recursive = TRUE)
-  
+
   ## end boiler plate
   ############################
-  
+
   run_all_scripts(index = 1)
-  
+
   m1 <- new_nm(run_id = ""m1"",
                based_on = ""staging/Models/ADVAN2.mod"",
                data_path = ""DerivedData/data.csv"") %>%
     fill_input() %>%
     init_theta(init = c(0.5, -2.5, -0.5)) %>%
     init_sigma(init = c(0.1, 0.1))
-  
-  m1s_temp <- m1 %>% child(""m1s_temp"") %>%  
+
+  m1s_temp <- m1 %>% child(""m1s_temp"") %>%
     update_parameters(m1) %>%
     apply_manual_edit(""tarjinde-2021-08-15-16-55-38"")
-  
+
   ## test that the manual edit made a $SIM
-  
+
   expect_false(m1 %>% dollar(""SIM"") %>% {.[[1]][1]} %>% {grepl(""^\\$SIM"", .)})
   expect_true(m1s_temp %>% dollar(""SIM"") %>% {.[[1]][1]} %>% {grepl(""^\\$SIM"", .)})
-  
+
   ## induce a merge conflict and check we get an error
   expect_error(
     suppressWarnings(
-      m1 %>% child(""m1s_temp"") %>%  
+      m1 %>% child(""m1s_temp"") %>%
         update_parameters(m1) %>%
-        gsub_ctl(""ISAMPLE=300"", ""ISAMPLE=600"") %>% 
+        gsub_ctl(""ISAMPLE=300"", ""ISAMPLE=600"") %>%
         apply_manual_edit(""tarjinde-2021-08-15-16-55-38"")
     )
   )
-  
+
 })

---FILE: tests/testthat/test-theopp.R---
@@ -3,12 +3,12 @@ proj_name <- ""test_nmproject""
 proj_path <- file.path(tempdir(), proj_name)
 
 test_that(""run and post"", {
-  
+
   skip_if_not(rmarkdown::pandoc_available(""1.12.3""))
-  
+
   currentwd <- getwd()
   if (file.exists(proj_path)) unlink(proj_path, recursive = TRUE, force = TRUE)
-  nm_create_analysis_project(proj_path)
+  with_temp_git_config(nm_create_analysis_project(proj_path))
   on.exit({
     setwd(currentwd)
     unlink(proj_path, recursive = TRUE, force = TRUE)
@@ -24,15 +24,15 @@ test_that(""run and post"", {
   file.rename(""cache"", "".cache"")
 
   unlink(testfilesloc, recursive = TRUE)
-  
+
   ## end boiler plate
   ############################
 
   options(nm.force_render = TRUE)
 
   ## run all scripts
   overwrite_behaviour(""skip"")
-  
+
   res <- tryCatch(run_all_scripts(), error = function(e) {
     on.exit({
       dump.frames(to.file = TRUE)"
tsahota,NMproject,9cbe3097ce8327c9bd6d2892915aa93b370b7d26,Jane,jane@example.com,2021-09-03T12:05:27Z,Jane,jane@example.com,2021-09-03T12:05:27Z,more informative error message if commit functionality is not there,R/manual-edit.R,False,True,True,False,51,42,93,"---FILE: R/manual-edit.R---
@@ -50,15 +50,15 @@ start_manual_edit <- function(m, combine_patch = NA_character_, replace_ctl = NA
   git2r::commit(message = paste(""pre-manual edit: "", patch_id))
 
   if (!is.na(combine_patch)) {
-    mnew <- mnew %>% 
+    mnew <- mnew %>%
       apply_manual_edit(combine_patch) %>%
       write_ctl(force = TRUE)
   }
-  
+
   if (!identical(replace_ctl, NA_character_)) {
     writeLines(replace_ctl, ctl_path(mnew))
   }
-  
+
   usethis::ui_silence(usethis::edit_file(ctl_path(mnew))) ## edit new one
 
   res <- list()
@@ -86,9 +86,9 @@ user_values_exist <- function() {
 }
 
 check_git_uservalues <- function() {
-  
+
   cmd <- NA_character_
-  
+
   if (!git_user_name_exists()) {
     txt <- ""user.name""
     cmd <- ""usethis::use_git_config(user.name = 'Jane')""
@@ -101,13 +101,13 @@ check_git_uservalues <- function() {
     txt <- ""user.name & user.email""
     cmd <- ""usethis::use_git_config(user.name = 'Jane', user.email = 'jane@example.com')""
   }
-  
+
   if(is.na(cmd)) return(invisible())
-  
-  usethis::ui_stop(paste0(""git "", txt, ""not set up. Set up like so:\n   "", 
+
+  usethis::ui_stop(paste0(""git "", txt, ""not set up. Set up like so:\n   "",
                           ""{usethis::ui_code(\"""", cmd, ""\"")}"",
                           ""\nto set up""))
-  
+
 }
 
 check_git_username <- function() {
@@ -143,15 +143,15 @@ a user.name and user.email, set this up with:
 }
 
 diff_manual_edit <- function(m, res) {
-  
+
   git2r::add(path = res$new_ctl_path)
   ## git2r::reset() doesn't work for some reason
   on.exit(system(""git reset HEAD"", intern = TRUE))
-  
+
   diff_text <- git2r::diff(git2r::repository(), index = TRUE, as_char = TRUE)
   diff_text <- strsplit(diff_text, ""\n"")[[1]]
   writeLines(diff_text, res$patch_path)
-  
+
   ## following doesn't work for some reason
   #git2r::diff(git2r::repository(), index = TRUE, as_char = TRUE, filename = res$patch_path)
   ## remove last commit and file
@@ -176,7 +176,7 @@ view_patch <- function(patch_id) {
   if (!file.exists(patch_path)) stop(""patch file doesn't exist"")
   patch_contents <- readLines(patch_path)
   cat(patch_contents, sep = ""\n"")
-  
+
 }
 
 new_patch_app <- function() {
@@ -191,18 +191,21 @@ new_patch_app <- function() {
   if (!git_cmd_available) stop(""need git available from system() for this to work"")
   if (!user_values_exist()) stop(""git user.name and/or user.email not set"")
   git_log <- git2r::commits()
+  if (length(git_log) == 0) stop(""Need a least one commit to continue.
+One should have been created on directory creation.  Run \""git commit\"" on
+command line diagnose the error"")
   orig_commit <- git_log[[1]]
-  
+
   res <- start_manual_edit(m)
   on.exit(unlink(res$new_ctl_path))
-  
-  ans <- usethis::ui_yeah(""---INSTRUCTIONS--- 
+
+  ans <- usethis::ui_yeah(""---INSTRUCTIONS---
 
  1) {usethis::ui_field('EDIT')} control file
  2) {usethis::ui_field('SAVE')} the file
- 
+
 Follow the above instructions and indicate if you happy to proceed?"", yes = ""Yes"", no = ""Abort"", shuffle = FALSE)
-  
+
   if(!ans) {
     system(paste(""git reset"", orig_commit$sha), intern = TRUE)
     return(invisible())
@@ -244,23 +247,26 @@ modify_patch_app <- function() {
   patch_id <- gsub("".*%>%.*apply_manual_edit\\(\""(.*)\""\\).*"", ""\\1"", selected_text)
 
   m <- eval(parse(text = before_edit))
-  
+
   ## before doing start_manual_edit - log the current commit for later resetting
   if (!git_cmd_available) stop(""need git available from system() for this to work"")
   if (!user_values_exist()) stop(""git user.name and/or user.email not set"")
   git_log <- git2r::commits()
+  if (length(git_log) == 0) stop(""Need a least one commit to continue.
+One should have been created on directory creation.  Run \""git commit\"" on
+command line diagnose the error"")
   orig_commit <- git_log[[1]]
-  
+
   res <- start_manual_edit(m, combine_patch = patch_id)
   on.exit(unlink(res$new_ctl_path))
-  
-  ans <- usethis::ui_yeah(""---INSTRUCTIONS--- 
+
+  ans <- usethis::ui_yeah(""---INSTRUCTIONS---
 
  1) {usethis::ui_field('EDIT')} control file
  2) {usethis::ui_field('SAVE')} the file
- 
+
 Follow the above instructions and indicate if you happy to proceed?"", yes = ""Yes"", no = ""Abort"", shuffle = FALSE)
-  
+
   if(!ans) {
     system(paste(""git reset"", orig_commit$sha), intern = TRUE)
     return(invisible())
@@ -297,40 +303,43 @@ resolve_manual_edit <- function() {
   final_newline_present <- grepl(""\\n\\s*$"", selected_text)
 
   before_edit <- gsub(""(.*)%>%.*apply_manual_edit.*"", ""\\1"", selected_text)
-  
+
   patch_id <- gsub("".*%>%.*apply_manual_edit\\(\""(.*)\""\\).*"", ""\\1"", selected_text)
-  
+
   m <- eval(parse(text = before_edit))
 
   ctl_with_merge <- m %>%
     apply_manual_edit(patch_id, return_merge_conf_ctl = TRUE)
-  
+
   ctl_with_merge <- ctl_with_merge[[1]]
-  
+
   ## before doing start_manual_edit - log the current commit for later resetting
   if (!git_cmd_available) stop(""need git available from system() for this to work"")
   if (!user_values_exist()) stop(""git user.name and/or user.email not set"")
   git_log <- git2r::commits()
+  if (length(git_log) == 0) stop(""Need a least one commit to continue.
+One should have been created on directory creation.  Run \""git commit\"" on
+command line diagnose the error"")
   orig_commit <- git_log[[1]]
-  
+
   res <- start_manual_edit(m, replace_ctl = ctl_with_merge)
   on.exit(unlink(res$new_ctl_path))
-  ans <- usethis::ui_yeah(""---INSTRUCTIONS--- 
+  ans <- usethis::ui_yeah(""---INSTRUCTIONS---
 
  1) {usethis::ui_field('REPAIR')} control file
     a) Merge conflicts are indicated by the markers <<<<<<<, =======, and >>>>>>>
     b) {usethis::ui_field('EDIT')} these sections
  2) {usethis::ui_field('SAVE')} the file
- 
+
 Follow the above instructions and indicate if you happy to proceed?"", yes = ""Yes"", no = ""Abort"", shuffle = FALSE)
-  
+
   if(!ans) {
     system(paste(""git reset"", orig_commit$sha), intern = TRUE)
     return(invisible())
   }
-  
+
   ## now diff ctl_path(m) and old_file_path
-  
+
   diff_manual_edit(m, res)
 
   if (final_pipe_present) {
@@ -349,9 +358,9 @@ Follow the above instructions and indicate if you happy to proceed?"", yes = ""Yes
     text = code_to_add,
     id = ctx$id
   )
-  
+
   message(""apply_manual_edit() statement modified in script"")
-  
+
 }
 
 make_patch_app <- function() {
@@ -386,27 +395,27 @@ make_patch_app <- function() {
 
 resolve_manual_edit_app <- function() {
   check_git_uservalues()
-  
+
   ctx <- rstudioapi::getSourceEditorContext()
   selected_text <- ctx$selection[[1]]$text
   selected_text <- gsub(""\\s*%>%\\s*$"", """", selected_text)
   ## see if last function is apply_manual_edit
-  
+
   ## get last function used in piping
   full_expr <- parse(text = selected_text)[[1]]
-  
+
   if (as.character(full_expr[[1]]) == ""<-"") {
     full_expr <- full_expr[[3]] ## rhs of assignment
   }
-  
+
   if (as.character(full_expr[[1]]) == ""%>%"") {
     last_fun_name <- as.character(full_expr[[3]][[1]])
   }
-  
+
   if (as.character(full_expr[[1]]) != ""%>%"") { ## normal function
     last_fun_name <- as.character(full_expr[[1]])
   }
-  
+
   if (last_fun_name == ""apply_manual_edit"") {
     resolve_manual_edit()
   } else {"
tsahota,NMproject,8f35a59379ee18ef29ea663d300634e44c31a89c,tarjinde,tarjinder.z.sahota@gsk.com,2021-08-20T11:47:15Z,tarjinde,tarjinder.z.sahota@gsk.com,2021-08-20T11:47:15Z,fixed bug in cran note handle and macOS error,.covrignore;DESCRIPTION;R/NMproject-package.R;R/cran_note_handle.R;tests/testthat/test-basic.R;tests/testthat/test-manual_edit.R,False,True,True,False,17,9,26,"---FILE: .covrignore---
@@ -14,4 +14,4 @@ R/prompt_overwrite.R
 R/nmsave.R
 R/system-hooks.R
 R/zzz.R
-R/NMproject-package.R
+R/cran_note_handle.R

---FILE: DESCRIPTION---
@@ -79,6 +79,7 @@ Collate:
     'nm_object.R'
     'cache.R'
     'covariate-explore.R'
+    'cran_note_handle.R'
     'data_filter.R'
     'decision.R'
     'deprecated.R'

---FILE: R/NMproject-package.R---
@@ -69,13 +69,6 @@
 ## usethis namespace: end
 NULL
 
-# Function to suppress R CMD check notes
-cran_note_handle <- function(){
-  
-  lifecycle::badge
-  
-  invisible()
-  
-}
+
 
 

---FILE: R/cran_note_handle.R---
@@ -0,0 +1,8 @@
+# Function to suppress R CMD check notes
+cran_note_handle <- function(){
+  
+  lifecycle::badge
+  
+  invisible()
+  
+}
\ No newline at end of file

---FILE: tests/testthat/test-basic.R---
@@ -2,6 +2,9 @@ proj_name <- ""test_nmproject""
 proj_path <- file.path(tempdir(), proj_name)
 
 test_that(""Project has basic functionality"", {
+  
+  skip_if_not(rmarkdown::pandoc_available(""1.12.3""))
+  
   currentwd <- getwd()
   nm_create_analysis_project(proj_path)
   on.exit({

---FILE: tests/testthat/test-manual_edit.R---
@@ -3,6 +3,9 @@ proj_name <- ""test_nmproject""
 proj_path <- file.path(tempdir(), proj_name)
 
 test_that(""manual_edit"", {
+  
+  skip_if_not(rmarkdown::pandoc_available(""1.12.3""))
+  
   currentwd <- getwd()
   if (file.exists(proj_path)) unlink(proj_path, recursive = TRUE, force = TRUE)
   nm_create_analysis_project(proj_path)"
tsahota,NMproject,2943172198142017a59fc2592ca4e94e01d07ab1,Tarjy,hsdlfj,2021-08-16T23:34:07Z,Tarjy,hsdlfj,2021-08-16T23:34:07Z,windows compatibility fixes,R/apply_manual_edit.R;R/manual-edit.R,False,True,True,False,85,17,102,"---FILE: R/apply_manual_edit.R---
@@ -45,17 +45,21 @@ apply_manual_edit.nm_generic <- function(m, patch_id, return_merge_conf_ctl = FA
   
   patch_cmd <- paste(""git apply -C1"", patch_path)
   
-  res <- system_cmd(patch_cmd, intern = TRUE) ## win = no need to use system_nm, no file sync issues
+  suppressWarnings(
+    res <- system_cmd(patch_cmd, intern = TRUE) ## win = no need to use system_nm, no file sync issues    
+  )
+
   
-  if (1 %in% attributes(res)$status) {
+  if (isTRUE(attributes(res)$status > 0)) {
     ## try again with whitespace fix, needed for some versions of git
     patch_cmd <- paste(""git apply --whitespace=fix -C1"", patch_path)
-    res <- system_cmd(patch_cmd, intern = TRUE)
+    suppressWarnings(
+      res <- system_cmd(patch_cmd, intern = TRUE)
+    )
     
-    if (1 %in% attributes(res)$status) {
+    if (isTRUE(attributes(res)$status > 0)) {
       
       if (!git_cmd_available) stop(""need git available from system() for this to work"")
-      #if (!user_values_exist()) stop(""git user.name and/or user.email not set"")
       
       ## get current commit for later resetting
       git_log <- git2r::commits()
@@ -74,32 +78,55 @@ apply_manual_edit.nm_generic <- function(m, patch_id, return_merge_conf_ctl = FA
       commit_found <- length(found_commits) == 1
       
       if (commit_found) {
+        check_git_uservalues()
         ## create a commit so the 3way can be done
         system(""git reset"", intern = TRUE) ## for some reason git2r::reset() doesn't reset
         git2r::add(path = temp_ctl_path)
         on.exit(system(paste(""git reset"", orig_commit$sha), intern = TRUE), add = TRUE)
+        
+        ## If no changes are present, we can exit
+        commit_diff <- git2r::diff(git2r::repository(), index = TRUE, as_char = TRUE)
+        commit_diff <- strsplit(commit_diff, ""\n"")[[1]]
+        empty_commit_coming <- length(commit_diff) == 0
+        
+        if (empty_commit_coming) {
+          usethis::ui_stop(""apply_manual_edit() hit an unresolvable merge conflict, 
+            this is normally due to the control file having changed significantly
+            since the manual edit was performed. Right clicking the patch text and 
+            selecting  Addins -> View patch will show the edits the patch is attempting 
+            to apply.  This can be used to create a new patch."")
+        }
+        
         commit_msg <- paste(""temp commit: "", ctl_path(m))
-        system(paste0(""git commit --allow-empty -m '"", commit_msg, ""'""), intern = TRUE)
+        git2r::commit(message = commit_msg)
         
-        patch_cmd <- paste(""git apply -C1 --3way"", patch_path)
+        patch_cmd <- paste(""git am -C1 --3way <"", patch_path)
         
         res <- suppressWarnings(
-          system_cmd(patch_cmd, intern = TRUE, ignore.stdout = TRUE, ignore.stderr = TRUE)
+          system_cmd(patch_cmd, intern = TRUE)
         )
         
-        if (1 %in% attributes(res)$status) { ## error detected
+        if (any(grepl(""git config"", res))) {
+          usethis::ui_stop(""Need to set project level user.name and user.email:
+            {usethis::ui_code(\""usethis::use_git_config(scope = 'project', user.name = 'Jane', user.email = 'jane@example.com')\"")}
+          retry when finished"")
+        }
+        
+        if (isTRUE(attributes(res)$status > 0)) { ## error detected
           ## two options:
           ##   merge conflict 
           ##   other fail (e.g. whitespace)
           git2r::add(path = temp_ctl_path)
           added_stuff <- git2r::diff(git2r::repository(), index = TRUE, as_char = TRUE)
           conflict_present <- FALSE
           if (length(added_stuff) == 1) {
-            conflict_present <- any(grepl(""\\+<<<<<<< ours"", added_stuff))
+            conflict_present <- any(grepl(""\\+<<<<<<<"", added_stuff))
           }
           ## can now use conflict_present
           
           if (conflict_present) {
+            #on.exit(system(""git am --abort"", intern = TRUE))
+            
             warn_msg <- paste0(""manual edit merge conflict detected:\n\n"", 
                                ""-------------------------------------------\n"",
                                added_stuff,
@@ -118,10 +145,10 @@ apply_manual_edit.nm_generic <- function(m, patch_id, return_merge_conf_ctl = FA
             ## behaviour.  The patch wouldnt' match up to what is done.
           }
           
-          patch_cmd <- paste(""git apply --whitespace=fix -C1 --3way"", patch_path)
+          patch_cmd <- paste(""git am --whitespace=fix -C1 --3way <"", patch_path)
           res <- system_cmd(patch_cmd, intern = TRUE)
           
-          if (1 %in% attributes(res)$status) { ## error detected
+          if (isTRUE(attributes(res)$status > 0)) { ## error detected
             ## two options:
             ##   merge conflict 
             ##   other fail (non whitespace but other)

---FILE: R/manual-edit.R---
@@ -70,11 +70,46 @@ start_manual_edit <- function(m, combine_patch = NA_character_, replace_ctl = NA
   res
 }
 
+git_user_name_exists <- function() {
+  config_names <- c(names(git2r::config()$global), names(git2r::config()$local))
+  ""user.name"" %in% config_names
+}
+
+git_user_email_exists <- function() {
+  config_names <- c(names(git2r::config()$global), names(git2r::config()$local))
+  ""user.email"" %in% config_names
+}
+
 user_values_exist <- function() {
   config_names <- c(names(git2r::config()$global), names(git2r::config()$local))
   all(c(""user.email"", ""user.name"") %in% config_names)
 }
 
+check_git_uservalues <- function() {
+  
+  cmd <- NA_character_
+  
+  if (!git_user_name_exists()) {
+    txt <- ""user.name""
+    cmd <- ""usethis::use_git_config(user.name = 'Jane')""
+  }
+  if (!git_user_email_exists()) {
+    txt <- ""user.email""
+    cmd <- ""usethis::use_git_config(user.email = 'jane@example.com')""
+  }
+  if (!git_user_name_exists() & !git_user_email_exists()) {
+    txt <- ""user.name & user.email""
+    cmd <- ""usethis::use_git_config(user.name = 'Jane', user.email = 'jane@example.com')""
+  }
+  
+  if(is.na(cmd)) return(invisible())
+  
+  usethis::ui_stop(paste0(""git "", txt, ""not set up. Set up like so:\n   "", 
+                          ""{usethis::ui_code(\"""", cmd, ""\"")}"",
+                          ""\nto set up""))
+  
+}
+
 check_git_username <- function() {
   if (!user_values_exist()) {
     message(""manual edits need git a user.name and user.email"")
@@ -110,10 +145,16 @@ a user.name and user.email, set this up with:
 diff_manual_edit <- function(m, res) {
   
   git2r::add(path = res$new_ctl_path)
-  git2r::diff(git2r::repository(), index = TRUE, as_char = TRUE, filename = res$patch_path)
-  #git2r::commit(message = paste(""manual edit: "", res$patch_id))
+  ## git2r::reset() doesn't work for some reason
+  on.exit(system(""git reset HEAD"", intern = TRUE))
+  
+  diff_text <- git2r::diff(git2r::repository(), index = TRUE, as_char = TRUE)
+  diff_text <- strsplit(diff_text, ""\n"")[[1]]
+  writeLines(diff_text, res$patch_path)
+  
+  ## following doesn't work for some reason
+  #git2r::diff(git2r::repository(), index = TRUE, as_char = TRUE, filename = res$patch_path)
   ## remove last commit and file
-  system(""git reset HEAD"", intern = TRUE) ## for some reason git2r::reset() doesn't reset
   unlink(res$new_ctl_path)
 }
 
@@ -315,7 +356,7 @@ Finished & happy to proceed?"", yes = ""Yes"", no = ""Abort"", shuffle = FALSE)
 }
 
 make_patch_app <- function() {
-  check_git_username()
+  check_git_uservalues()
 
   ctx <- rstudioapi::getSourceEditorContext()
   selected_text <- ctx$selection[[1]]$text
@@ -345,7 +386,7 @@ make_patch_app <- function() {
 }
 
 resolve_manual_edit_app <- function() {
-  check_git_username()
+  check_git_uservalues()
   
   ctx <- rstudioapi::getSourceEditorContext()
   selected_text <- ctx$selection[[1]]$text"
tsahota,NMproject,e66c47cd06ab6904eed2a26ee9cf3119401d00a8,Tarj Sahota,t.sahota0@gmail.com,2021-08-16T13:17:22Z,Tarj Sahota,t.sahota0@gmail.com,2021-08-16T13:17:22Z,windows bug fix nm_create_analysis_project(),R/make_project.R,False,True,True,False,3,0,3,"---FILE: R/make_project.R---
@@ -88,6 +88,9 @@ nm_create_analysis_project <- function(path, dirs = nm_default_dirs(),
     path <- file.path(normalizePath(getwd()), path)
     path <- normalizePath(path, mustWork = FALSE)    
   }
+  ## needed because usethis::create_project and R can disagree on ~ location
+  ## R should take precendence
+  path <- path.expand(path)   
   
   if (file.exists(path)) {
     stop(""Directory already exists. Aborting."")"
tsahota,NMproject,c82286736b367776ef6b3ef28bcbe962aeaf8a92,tarj sahota,t.sahota0@gmail.com,2021-08-14T17:52:15Z,tarj sahota,t.sahota0@gmail.com,2021-08-14T17:52:15Z,more informative error msg on manual edit merge conflict,R/apply_manual_edit.R,False,True,True,False,5,1,6,"---FILE: R/apply_manual_edit.R---
@@ -61,7 +61,11 @@ apply_manual_edit.nm_generic <- function(m, patch_name) {
     res <- system_cmd(patch_cmd, intern = TRUE)
 
     if (1 %in% attributes(res)$status) {
-      stop(""patch failed"", call. = TRUE)
+      usethis::ui_oops(""apply_manual_edit() failed to apply patch, 
+           this is normally due to the control file having changed since the 
+           patch was created. Right clicking the patch text and selecting 
+           Addins -> View patch will show the edits the patch is attempting to 
+           apply.  This can be used to create a new patch."")
     }
   }
 "
tsahota,NMproject,366770789d3e3ad32f5e330afdfd2ee7fe3df4bd,tarjinde,tarjinder.z.sahota@gsk.com,2021-08-13T13:18:12Z,tarjinde,tarjinder.z.sahota@gsk.com,2021-08-13T13:18:12Z,error if dir already exists,R/make_project.R,False,True,True,False,4,0,4,"---FILE: R/make_project.R---
@@ -88,6 +88,10 @@ nm_create_analysis_project <- function(path, dirs = nm_default_dirs(),
     path <- file.path(normalizePath(getwd()), path)
     path <- normalizePath(path, mustWork = FALSE)    
   }
+  
+  if (file.exists(path)) {
+    stop(""Directory already exists. Aborting."")
+  }
 
   style <- match.arg(style)
   name <- basename(path)"
tsahota,NMproject,4639ac54d0c959e499eedfc357da52f838435b86,tarjinde,tarjinder.z.sahota@gsk.com,2021-08-13T12:56:46Z,tarjinde,tarjinder.z.sahota@gsk.com,2021-08-13T12:56:46Z,doc typo fix,R/run_nm.R;man/temp_files.Rd,False,True,True,False,6,2,8,"---FILE: R/run_nm.R---
@@ -321,7 +321,7 @@ ctl_table_files.default <- function(ctl) {
 #' NONMEM produces a lot of temporary files which can add up to a lot of disk
 #' space.  One strategy to remove this is to use the `clean` option in the PsN
 #' command.  However, this can automatically remove files as soon as the run
-#' finishes that may be useful for debugging.  `ls_tempfiles()`` allows you to
+#' finishes that may be useful for debugging.  `ls_tempfiles()` allows you to
 #' list the paths of all temporary files, for a single run or for all runs for
 #' inspection and deletion. `clean_run()` is a wrapper function that runs
 #' `ls_tempfiles()` and deletes everything returned.  For safety is limited to

---FILE: man/temp_files.Rd---
@@ -47,7 +47,11 @@ A \code{character} vector of temporary file paths
 NONMEM produces a lot of temporary files which can add up to a lot of disk
 space.  One strategy to remove this is to use the \code{clean} option in the PsN
 command.  However, this can automatically remove files as soon as the run
-finishes that may be useful for debugging.  \verb{ls_tempfiles()`` allows you to list the paths of all temporary files, for a single run or for all runs for inspection and deletion. }clean_run()\verb{is a wrapper function that runs}ls_tempfiles()\verb{and deletes everything returned.  For safety is limited to only deleting files associated with}nm` objects though.
+finishes that may be useful for debugging.  \code{ls_tempfiles()} allows you to
+list the paths of all temporary files, for a single run or for all runs for
+inspection and deletion. \code{clean_run()} is a wrapper function that runs
+\code{ls_tempfiles()} and deletes everything returned.  For safety is limited to
+only deleting files associated with \code{nm} objects though.
 }
 \details{
 Setting \code{include_psn_exports = TRUE} will break 'Pirana' and 'xpose'"
tsahota,NMproject,bc31a51071bdd1415a708573e4d7a61382ffc12a,tarjinde,tarjinder.z.sahota@gsk.com,2021-08-11T20:53:51Z,tarjinde,tarjinder.z.sahota@gsk.com,2021-08-11T20:59:26Z,better first model dev template instructions and error if based_on is in models,NEWS.md;R/nm_object.R;inst/rmarkdown/templates/nm_log/skeleton/skeleton.Rmd;man/new_nm.Rd;tests/testthat/test-new_nm.R,True,True,True,False,45,6,51,"---FILE: NEWS.md---
@@ -1,6 +1,11 @@
 # NMproject (development version)
 
-* made `run_id` argument mandatory in `child()`.
+* Made `run_id` argument mandatory in `child()`.
+* Added example code for first object creation in code library dialog boxes 
+  when a model file is imported
+* `new_nm()` will now fail if user tries to use a run based on one in the
+  Models.  This is for safety as the Models directry should only contain 
+  NMproject generated code.
 
 # NMproject 0.6.2
 

---FILE: R/nm_object.R---
@@ -19,6 +19,8 @@
 #' @param cmd Optional character. PsN command to use. If unspecified will use
 #'   `getOption(""nm_default_fields"")` value of `cmd`. Use glue notation for
 #'   inheritance.  See details.
+#' @param force (Default = `FALSE`). Forces object creation even if `based_on`
+#'   model is in the `nm_dir(""models"")` directory.
 #'
 #' @details The `cmd` field uses `glue` notation.  So instead of specifying
 #'   `execute runm1.mod -dir=m1`, it is best to specify `execute {ctl_name}
@@ -94,8 +96,20 @@
 new_nm <- function(based_on,
                    run_id = NA_character_,
                    data_path,
-                   cmd) {
+                   cmd,
+                   force = FALSE) {
   m <- nm(run_id = run_id)
+  if (!force) {
+    in_models_dir <- identical(
+      normalizePath(dirname(based_on), mustWork = FALSE), 
+      normalizePath(nm_dir(""models""), mustWork = FALSE)
+    )
+    if (in_models_dir) {
+      stop(""The '"", nm_dir(""models""), ""' directory is meant for automatically generated models, 
+ this is risky. Move the 'based_on' to another directory in the analysis project, 
+ or rerun with force=TRUE"")
+    }
+  }
   if (!missing(based_on)) m <- m %>% based_on(based_on)
   if (!missing(data_path)) m <- m %>% data_path(data_path)
   if (!missing(cmd)) m <- m %>% cmd(cmd)

---FILE: inst/rmarkdown/templates/nm_log/skeleton/skeleton.Rmd---
@@ -49,10 +49,13 @@ set.seed(1234)
 ```{r}
 
 ## REPLACE ME BELOW
+## instructions:
+##   either use the Addins -> code library to import NONMEM code and then copy-paste the code in the pop up.
+##   OR copy a NONMEM model file (and data set) into your analysis project and fill out relative paths below
+
 m1 <- new_nm(run_id = ""m1"",
-             based_on = ""staging/Models/runm1.mod"",
-             data_path = ""DerivedData/THEOPP.csv"",
-             cmd = ""execute {ctl_name} -dir={run_dir}"") %>%
+             based_on = ""relative/path/to/your/NONMEM/file"",
+             data_path = ""relative/path/to/your/NONMEM/ready/file.csv"") %>%
   fill_input() %>%
   run_nm()
   

---FILE: man/new_nm.Rd---
@@ -4,7 +4,7 @@
 \alias{new_nm}
 \title{Create a new (parent) nm object}
 \usage{
-new_nm(based_on, run_id = NA_character_, data_path, cmd)
+new_nm(based_on, run_id = NA_character_, data_path, cmd, force = FALSE)
 }
 \arguments{
 \item{based_on}{Character. Relative path to an existing control file from
@@ -23,6 +23,9 @@ explicitly as a relative path.}
 \item{cmd}{Optional character. PsN command to use. If unspecified will use
 \code{getOption(""nm_default_fields"")} value of \code{cmd}. Use glue notation for
 inheritance.  See details.}
+
+\item{force}{(Default = \code{FALSE}). Forces object creation even if \code{based_on}
+model is in the \code{nm_dir(""models"")} directory.}
 }
 \value{
 An object of class \code{nm_list}.  Attributes can be viewed by printing

---FILE: tests/testthat/test-new_nm.R---
@@ -0,0 +1,14 @@
+test_that(""new_nm"", {
+  exdir <- system.file(""extdata"", ""examples"", ""theopp"", package = ""NMproject"")
+  m1 <- new_nm(run_id = ""m1"", 
+               based_on = file.path(exdir, ""Models"", ""ADVAN2.mod""),
+               data_path = file.path(exdir, ""SourceData"", ""THEOPP.csv""))
+  
+  expect_error(
+    m1 <- new_nm(run_id = ""m1"", 
+               based_on = ""Models/ADVAN2.mod"",
+               data_path = file.path(exdir, ""SourceData"", ""THEOPP.csv""))
+  )
+
+  
+})"
tsahota,NMproject,00aa7c1279f116641259540dd5f17360d3407f88,tarjinde,tarjinder.z.sahota@gsk.com,2021-08-11T20:30:34Z,tarjinde,tarjinder.z.sahota@gsk.com,2021-08-11T20:30:34Z,test fix,inst/extdata/examples/theopp/Scripts/Readme.txt;inst/extdata/examples/theopp/Scripts/s02_model_log.Rmd;inst/extdata/examples/theopp/SourceData/Readme.txt;inst/extdata/theopp.zip;inst/rmarkdown/templates/basic_gof/skeleton/skeleton.Rmd;inst/rmarkdown/templates/basic_vpc/skeleton/skeleton.Rmd;tests/testthat/theopp.zip,True,False,True,False,7,22,29,"---FILE: inst/extdata/examples/theopp/Scripts/Readme.txt---
@@ -1 +1 @@
-This directory is for R scripts to be run in the main project directory
+Directory for R and Rmd scripts

---FILE: inst/extdata/examples/theopp/Scripts/s02_model_log.Rmd---
@@ -147,7 +147,7 @@ m1s_temp <- m1 %>% child(""m1s_temp"") %>%
 m1 %>% saveRDS(""Results/m1.RDS"")
 
 # create a child run where we investigate a different TRANS subroutine
-m2 <- m1 %>% child() %>%
+m2 <- m1 %>% child(""m2"") %>%
   subroutine(trans = 2) %>% 
   # see nm_diff app to see if you're happy with the changes being made
   run_nm()
@@ -200,7 +200,7 @@ decision(inputs = summary_wide(c(m1, m2, m2WT), m = FALSE),
 # calculated - see the s01 script for how to make them
 # only running 4 samples for demo purposes
 
-m1_boot <- m1 %>% make_boot_datasets(samples = 4, overwrite = TRUE)
+m1_boot <- m1 %>% make_boot_datasets(samples = 4)
 
 m1_boot ## display data.frame
 

---FILE: inst/extdata/examples/theopp/SourceData/Readme.txt---
@@ -1 +1 @@
-This directory is for unmodified source datasets.  Data in this directory should not be modified.
+Directory for unmodified source data

---FILE: inst/rmarkdown/templates/basic_gof/skeleton/skeleton.Rmd---
@@ -81,28 +81,13 @@ covariance_plot(.m)
 
 library(ggplot2)
 
-## output_table_first() returns a merged version of all $TABLE outputs and your
-## input data.  See ?output_table_first for more info.
-
 .m %>%
   output_table_first() %>%
   ggplot(aes(x = PRED, y = DV)) +
   theme_bw() +
   geom_point() +
   geom_abline()
 
-
-## The following is an example of an exploratory data analysis (EDA) type plot
-## but with an additional layer with model predictions (in this case IPREDs).
-## Since EDA plots often highlight the more interesting aspects of the data, we
-## can recycle to see if the model predicting these aspects of the data.
-
-.m %>%
-  output_table_first() %>%
-  ggplot(aes(x = TIME, y = DV)) + theme_bw() +
-  geom_point() +
-  geom_line(aes(y = IPRED, group = ID), colour = ""red"") ## additional prediction layer
-
 ```
 
 ```{r xpose_plot, warning=FALSE}

---FILE: inst/rmarkdown/templates/basic_vpc/skeleton/skeleton.Rmd---
@@ -92,7 +92,7 @@ sim$DV <- sim$DV_OUT  ## needed because output_table puts DV in DV_OUT
 
 ```{r vpc_basic}
 
-vpc::vpc(
+vpc(
   sim = sim,
   obs = obs,
   obs_cols = list(idv = ""TPERIOD""),
@@ -104,7 +104,7 @@ vpc::vpc(
 
 ```{r pred_corr}
 
-vpc::vpc(
+vpc(
   sim = sim,
   obs = obs,
   obs_cols = list(idv = ""TPERIOD""),
@@ -121,7 +121,7 @@ vpc::vpc(
 sim$WT_c = Hmisc::cut2(sim$WT, g = 2)
 obs$WT_c = Hmisc::cut2(obs$WT, g = 2)
 
-vpc::vpc(
+vpc(
   sim = sim,
   obs = obs,
   obs_cols = list(idv = ""TPERIOD""),"
tsahota,NMproject,4f8068a679fc82667b954bc6fab40a6345ae9d19,tarj sahota,t.sahota0@gmail.com,2021-08-10T16:40:46Z,tarj sahota,t.sahota0@gmail.com,2021-08-10T16:46:49Z,child run_id mandatory. parent arg fix,R/nm_object.R;man/child.Rd;tests/testthat/test-child.R,False,True,True,False,36,28,64,"---FILE: R/nm_object.R---
@@ -243,7 +243,7 @@ nm <- Vectorize_nm_list(nm_generic, SIMPLIFY = FALSE)
 #' @param m Parent nm object.
 #' @param run_id Character.  New `run_id` to assign to child object.
 #' @param type Character (default = `""execute""`). Type of child object.
-#' @param parent Optional nm object (default = `nm(NA)`) . Parent object will by
+#' @param parent Optional nm object (default = `m`) . Parent object will by
 #'   default be `m`, but this argument will force parent to be a different
 #'   object.
 #' @param silent Logical (default = `FALSE`). Should warn if conflicts detected.
@@ -267,18 +267,21 @@ nm <- Vectorize_nm_list(nm_generic, SIMPLIFY = FALSE)
 #' nm_diff(m2, m1)
 #'
 #' @export
-child <- function(m, run_id = NA_character_, type = ""execute"", parent = nm(NA), silent = FALSE) {
+child <- function(m, run_id = NA_character_, type = ""execute"",
+                  parent = m, silent = FALSE) {
   UseMethod(""child"")
 }
 #' @export
-child.nm_generic <- function(m, run_id = NA_character_, type = ""execute"", parent = nm(NA), silent = FALSE) {
+child.nm_generic <- function(m, run_id = NA_character_, type = ""execute"",
+                             parent = m, silent = FALSE) {
+  
+  if (is.na(run_id)) {
+    stop(""child() needs a run_id argument e.g. m2 <- m1 %>% child(run_id = \""m2\"")"")
+  }
+  
   mparent <- m
-  # if(is.environment(m)){
-  #   old_classes <- class(m)
-  #   m <- as.environment(as.list(m, all.names=TRUE))
-  #   class(m) <- old_classes
-  # }
-
+  parent <- parent # evaluate now rather than lazily
+  
   m <- m %>% executed(FALSE)
   m <- m %>% job_info(NA_character_)
   m[[""result_files""]] <- c()
@@ -287,13 +290,6 @@ child.nm_generic <- function(m, run_id = NA_character_, type = ""execute"", parent
   m <- m %>% parent_ctl_name(ctl_name(m))
   m <- m %>% parent_results_dir(results_dir(m))
 
-  ## if missing increment run_id
-  if (is.na(run_id)) {
-    if (!is.na(run_id(m))) {
-      run_id <- increment_run_id(run_id(m))
-      message(""child run_id automatically set to: "", run_id)
-    }
-  }
   if (!is.na(run_id)) m <- m %>% run_id(run_id)
 
   m <- m %>% ctl_contents(ctl_contents(m),
@@ -305,13 +301,15 @@ child.nm_generic <- function(m, run_id = NA_character_, type = ""execute"", parent
 
   ## check for file conficts
   if (!is_single_na(m[[""ctl_contents""]])) {
-    file_conflicts <- intersect(psn_exported_files(mparent), psn_exported_files(m))
+    file_conflicts <- intersect(
+      psn_exported_files(parent),
+      psn_exported_files(m)
+    )
     if (length(file_conflicts) > 0) {
       if (!silent) {
         warning(""Child file(s) currently in conflict with parent:\n"",
           paste(paste0("" "", file_conflicts), collapse = ""\n""),
-          ""\nYou will overwrite parent object outputs if you run now"",
-          call. = FALSE
+          ""\nYou will overwrite parent object outputs if you run now""
         )
       }
     }
@@ -331,7 +329,7 @@ child.nm_generic <- function(m, run_id = NA_character_, type = ""execute"", parent
     }
   }
 
-  if (!is.na(parent)) m <- m %>% change_parent(parent)
+  if (!identical(parent, mparent)) m <- m %>% change_parent(parent)
 
   m
 }

---FILE: man/child.Rd---
@@ -4,13 +4,7 @@
 \alias{child}
 \title{Make child nm object from parent}
 \usage{
-child(
-  m,
-  run_id = NA_character_,
-  type = ""execute"",
-  parent = nm(NA),
-  silent = FALSE
-)
+child(m, run_id = NA_character_, type = ""execute"", parent = m, silent = FALSE)
 }
 \arguments{
 \item{m}{Parent nm object.}
@@ -19,7 +13,7 @@ child(
 
 \item{type}{Character (default = \code{""execute""}). Type of child object.}
 
-\item{parent}{Optional nm object (default = \code{nm(NA)}) . Parent object will by
+\item{parent}{Optional nm object (default = \code{m}) . Parent object will by
 default be \code{m}, but this argument will force parent to be a different
 object.}
 

---FILE: tests/testthat/test-child.R---
@@ -0,0 +1,16 @@
+test_that(""child"", {
+  exdir <- system.file(""extdata"", ""examples"", ""theopp"", package = ""NMproject"")
+  m1 <- new_nm(run_id = ""m1"", 
+               based_on = file.path(exdir, ""Models"", ""ADVAN2.mod""),
+               data_path = file.path(exdir, ""SourceData"", ""THEOPP.csv""))
+  
+  expect_error(m1 %>% child())
+  
+  m1 <- m1 %>% gsub_ctl(""tabm1"", ""tab"")  ## cause table name conflict
+  
+  expect_silent(m2 <- m1 %>% child(""m2""))
+  
+  m3 <- m2 %>% child(""m3"", parent = m1)
+  expect_equal(parent_run_id(m3), ""m1"")
+  
+})"
tsahota,NMproject,2416bfc384d77047c26354dbbd2a96913cc848c8,tarj sahota,t.sahota0@gmail.com,2021-08-09T00:36:36Z,tarj sahota,t.sahota0@gmail.com,2021-08-09T00:36:36Z,fix example,R/nm_object.R;man/nm_list_gather.Rd,False,True,True,False,2,2,4,"---FILE: R/nm_object.R---
@@ -566,7 +566,7 @@ nm_list2list <- function(m) {
 #' m_all <- nm_list_gather()
 #' 
 #' identical(
-#'   m_all %>% subset(run_id(.) %in% ""m1""),
+#'   m_all %>% subset(run_id(m_all) %in% ""m1""),
 #'   m1
 #' )
 #' 

---FILE: man/nm_list_gather.Rd---
@@ -32,7 +32,7 @@ m2 <- m1 \%>\% child(""m2"")
 m_all <- nm_list_gather()
 
 identical(
-  m_all \%>\% subset(run_id(.) \%in\% ""m1""),
+  m_all \%>\% subset(run_id(m_all) \%in\% ""m1""),
   m1
 )
 "
tsahota,NMproject,7fa39dab61fa3875aac97b6b0da1a01ed5f9ca07,tarjinde,tarjinder.z.sahota@gsk.com,2021-08-08T21:56:11Z,tarjinde,tarjinder.z.sahota@gsk.com,2021-08-08T21:56:11Z,equation format fix,R/post-run-summaries.R;man/coef_widelong.Rd;man/rr.Rd,False,True,True,False,12,12,24,"---FILE: R/post-run-summaries.R---
@@ -54,7 +54,7 @@
 #' 
 #' \describe{
 #'     \item{`LOG`}{
-#'       \eqn{FINAL = exp(\theta), RSE = 100\sqrt(exp^(se(\theta)^2) - 1)}
+#'       \eqn{FINAL = exp(\theta), RSE = 100\sqrt(exp(se(\theta)^2) - 1)}
 #'     }
 #'     \item{`RATIO`}{
 #'       \eqn{FINAL = \theta, RSE = 100se(\theta)/\theta}
@@ -76,7 +76,7 @@
 #'   
 #' \describe{
 #'     \item{`LOG`}{
-#'       \eqn{FINAL = 100\sqrt(exp^(\omega^2) - 1), RSE = 100(se(\omega^2)/\omega^2)/2}
+#'       \eqn{FINAL = 100\sqrt(exp(\omega^2) - 1), RSE = 100(se(\omega^2)/\omega^2)/2}
 #'     }
 #'     \item{missing}{
 #'       \eqn{FINAL = \omega^2, SE = se(\omega^2)}
@@ -93,7 +93,7 @@
 #' 
 #' \describe{
 #'     \item{all sigmas}{
-#'       \eqn{FINAL = \sqrt\sigma^2, RSE = 100se(\sigma^2) / \sigma^2}
+#'       \eqn{FINAL = \sqrt(\sigma^2), RSE = 100se(\sigma^2) / \sigma^2}
 #'     }
 #' }
 #'
@@ -218,7 +218,7 @@ rr.nm_generic <- function(m, trans = TRUE) {
 #' 
 #' \describe{
 #'     \item{`LOG`}{
-#'       \eqn{FINAL = exp(\theta), RSE = 100\sqrt(exp^(se(\theta)^2) - 1)}
+#'       \eqn{FINAL = exp(\theta), RSE = 100\sqrt(exp(se(\theta)^2) - 1)}
 #'     }
 #'     \item{`RATIO`}{
 #'       \eqn{FINAL = \theta, RSE = 100se(\theta)/\theta}
@@ -240,7 +240,7 @@ rr.nm_generic <- function(m, trans = TRUE) {
 #'   
 #' \describe{
 #'     \item{`LOG`}{
-#'       \eqn{FINAL = 100\sqrt(exp^(\omega^2) - 1), RSE = 100(se(\omega^2)/\omega^2)/2}
+#'       \eqn{FINAL = 100\sqrt(exp(\omega^2) - 1), RSE = 100(se(\omega^2)/\omega^2)/2}
 #'     }
 #'     \item{missing}{
 #'       \eqn{FINAL = \omega^2, SE = se(\omega^2)}
@@ -257,7 +257,7 @@ rr.nm_generic <- function(m, trans = TRUE) {
 #' 
 #' \describe{
 #'     \item{all sigmas}{
-#'       \eqn{FINAL = \sqrt\sigma^2, RSE = 100se(\sigma^2) / \sigma^2}
+#'       \eqn{FINAL = \sqrt(\sigma^2), RSE = 100se(\sigma^2) / \sigma^2}
 #'     }
 #' }
 #'

---FILE: man/coef_widelong.Rd---
@@ -76,7 +76,7 @@ parameters and standard errors, respectively:
 
 \describe{
 \item{\code{LOG}}{
-\eqn{FINAL = exp(\theta), RSE = 100\sqrt(exp^(se(\theta)^2) - 1)}
+\eqn{FINAL = exp(\theta), RSE = 100\sqrt(exp(se(\theta)^2) - 1)}
 }
 \item{\code{RATIO}}{
 \eqn{FINAL = \theta, RSE = 100se(\theta)/\theta}
@@ -100,7 +100,7 @@ parameters and standard errors, respectively
 
 \describe{
 \item{\code{LOG}}{
-\eqn{FINAL = 100\sqrt(exp^(\omega^2) - 1), RSE = 100(se(\omega^2)/\omega^2)/2}
+\eqn{FINAL = 100\sqrt(exp(\omega^2) - 1), RSE = 100(se(\omega^2)/\omega^2)/2}
 }
 \item{missing}{
 \eqn{FINAL = \omega^2, SE = se(\omega^2)}
@@ -119,7 +119,7 @@ standard deviations.
 
 \describe{
 \item{all sigmas}{
-\eqn{FINAL = \sqrt\sigma^2, RSE = 100se(\sigma^2) / \sigma^2}
+\eqn{FINAL = \sqrt(\sigma^2), RSE = 100se(\sigma^2) / \sigma^2}
 }
 }
 }

---FILE: man/rr.Rd---
@@ -67,7 +67,7 @@ parameters and standard errors, respectively:
 
 \describe{
 \item{\code{LOG}}{
-\eqn{FINAL = exp(\theta), RSE = 100\sqrt(exp^(se(\theta)^2) - 1)}
+\eqn{FINAL = exp(\theta), RSE = 100\sqrt(exp(se(\theta)^2) - 1)}
 }
 \item{\code{RATIO}}{
 \eqn{FINAL = \theta, RSE = 100se(\theta)/\theta}
@@ -91,7 +91,7 @@ parameters and standard errors, respectively
 
 \describe{
 \item{\code{LOG}}{
-\eqn{FINAL = 100\sqrt(exp^(\omega^2) - 1), RSE = 100(se(\omega^2)/\omega^2)/2}
+\eqn{FINAL = 100\sqrt(exp(\omega^2) - 1), RSE = 100(se(\omega^2)/\omega^2)/2}
 }
 \item{missing}{
 \eqn{FINAL = \omega^2, SE = se(\omega^2)}
@@ -110,7 +110,7 @@ standard deviations.
 
 \describe{
 \item{all sigmas}{
-\eqn{FINAL = \sqrt\sigma^2, RSE = 100se(\sigma^2) / \sigma^2}
+\eqn{FINAL = \sqrt(\sigma^2), RSE = 100se(\sigma^2) / \sigma^2}
 }
 }
 }"
tsahota,NMproject,61163e265430759f0f7f52e4221ad52e8d80d788,tarjinde,tarjinder.z.sahota@gsk.com,2021-08-07T12:17:33Z,tarjinde,tarjinder.z.sahota@gsk.com,2021-08-07T12:20:52Z,formatting fix,R/post-run-summaries.R;man/coef_widelong.Rd;man/rr.Rd,False,True,True,False,8,8,16,"---FILE: R/post-run-summaries.R---
@@ -75,7 +75,7 @@
 #' parameters and standard errors, respectively
 #'   
 #' \describe{
-#'     \item{LOG:}{
+#'     \item{`LOG`}{
 #'       \eqn{FINAL = 100*\sqrt(exp^(\omega^2) - 1), RSE% = 100*(se(\omega^2)/\omega^2)/2}
 #'     }
 #'     \item{missing}{
@@ -92,7 +92,7 @@
 #' standard deviations.
 #' 
 #' \describe{
-#'     \item{all sigmas:}{
+#'     \item{all sigmas}{
 #'       \eqn{FINAL = \sqrt \sigma^2, RSE% = 100*se(\sigma^2) / \sigma^2}
 #'     }
 #' }
@@ -237,7 +237,7 @@ rr.nm_generic <- function(m, trans = TRUE) {
 #' parameters and standard errors, respectively
 #'   
 #' \describe{
-#'     \item{LOG:}{
+#'     \item{`LOG`}{
 #'       \eqn{FINAL = 100*\sqrt(exp^(\omega^2) - 1), RSE% = 100*(se(\omega^2)/\omega^2)/2}
 #'     }
 #'     \item{missing}{
@@ -254,7 +254,7 @@ rr.nm_generic <- function(m, trans = TRUE) {
 #' standard deviations.
 #' 
 #' \describe{
-#'     \item{all sigmas:}{
+#'     \item{all sigmas}{
 #'       \eqn{FINAL = \sqrt \sigma^2, RSE% = 100*se(\sigma^2) / \sigma^2}
 #'     }
 #' }

---FILE: man/coef_widelong.Rd---
@@ -99,7 +99,7 @@ where \eqn{\omega^2} and \eqn{se(\omega^2)} are the NONMEM reported values of
 parameters and standard errors, respectively
 
 \describe{
-\item{LOG:}{
+\item{\code{LOG}}{
 \eqn{FINAL = 100*\sqrt(exp^(\omega^2) - 1), RSE% = 100*(se(\omega^2)/\omega^2)/2}
     }
 \item{missing}{
@@ -118,7 +118,7 @@ parameters and standard errors, respectively.  All sigmas are reported as
 standard deviations.
 
 \describe{
-\item{all sigmas:}{
+\item{all sigmas}{
 \eqn{FINAL = \sqrt \sigma^2, RSE% = 100*se(\sigma^2) / \sigma^2}
     }
 }

---FILE: man/rr.Rd---
@@ -90,7 +90,7 @@ where \eqn{\omega^2} and \eqn{se(\omega^2)} are the NONMEM reported values of
 parameters and standard errors, respectively
 
 \describe{
-\item{LOG:}{
+\item{\code{LOG}}{
 \eqn{FINAL = 100*\sqrt(exp^(\omega^2) - 1), RSE% = 100*(se(\omega^2)/\omega^2)/2}
     }
 \item{missing}{
@@ -109,7 +109,7 @@ parameters and standard errors, respectively.  All sigmas are reported as
 standard deviations.
 
 \describe{
-\item{all sigmas:}{
+\item{all sigmas}{
 \eqn{FINAL = \sqrt \sigma^2, RSE% = 100*se(\sigma^2) / \sigma^2}
     }
 }"
tsahota,NMproject,07c823c3442f60e4394886dc5f49ddeaeae975b0,tarjinde,tarjinder.z.sahota@gsk.com,2021-08-07T12:17:33Z,tarjinde,tarjinder.z.sahota@gsk.com,2021-08-07T12:17:33Z,formatting fix,R/post-run-summaries.R;man/coef_widelong.Rd;man/rr.Rd,False,True,True,False,8,8,16,"---FILE: R/post-run-summaries.R---
@@ -75,7 +75,7 @@
 #' parameters and standard errors, respectively
 #'   
 #' \describe{
-#'     \item{LOG:}{
+#'     \item{`LOG`}{
 #'       \eqn{FINAL = 100*\sqrt(exp^(\omega^2) - 1), RSE% = 100*(se(\omega^2)/\omega^2)/2}
 #'     }
 #'     \item{missing}{
@@ -92,7 +92,7 @@
 #' standard deviations.
 #' 
 #' \describe{
-#'     \item{all sigmas:}{
+#'     \item{all sigmas}{
 #'       \eqn{FINAL = \sqrt \sigma^2, RSE% = 100*se(\sigma^2) / \sigma^2}
 #'     }
 #' }
@@ -237,7 +237,7 @@ rr.nm_generic <- function(m, trans = TRUE) {
 #' parameters and standard errors, respectively
 #'   
 #' \describe{
-#'     \item{LOG:}{
+#'     \item{`LOG`}{
 #'       \eqn{FINAL = 100*\sqrt(exp^(\omega^2) - 1), RSE% = 100*(se(\omega^2)/\omega^2)/2}
 #'     }
 #'     \item{missing}{
@@ -254,7 +254,7 @@ rr.nm_generic <- function(m, trans = TRUE) {
 #' standard deviations.
 #' 
 #' \describe{
-#'     \item{all sigmas:}{
+#'     \item{all sigmas}{
 #'       \eqn{FINAL = \sqrt \sigma^2, RSE% = 100*se(\sigma^2) / \sigma^2}
 #'     }
 #' }

---FILE: man/coef_widelong.Rd---
@@ -99,7 +99,7 @@ where \eqn{\omega^2} and \eqn{se(\omega^2)} are the NONMEM reported values of
 parameters and standard errors, respectively
 
 \describe{
-\item{LOG:}{
+\item{\code{LOG}}{
 \eqn{FINAL = 100*\sqrt(exp^(\omega^2) - 1), RSE% = 100*(se(\omega^2)/\omega^2)/2}
     }
 \item{missing}{
@@ -118,7 +118,7 @@ parameters and standard errors, respectively.  All sigmas are reported as
 standard deviations.
 
 \describe{
-\item{all sigmas:}{
+\item{all sigmas}{
 \eqn{FINAL = \sqrt \sigma^2, RSE% = 100*se(\sigma^2) / \sigma^2}
     }
 }

---FILE: man/rr.Rd---
@@ -90,7 +90,7 @@ where \eqn{\omega^2} and \eqn{se(\omega^2)} are the NONMEM reported values of
 parameters and standard errors, respectively
 
 \describe{
-\item{LOG:}{
+\item{\code{LOG}}{
 \eqn{FINAL = 100*\sqrt(exp^(\omega^2) - 1), RSE% = 100*(se(\omega^2)/\omega^2)/2}
     }
 \item{missing}{
@@ -109,7 +109,7 @@ parameters and standard errors, respectively.  All sigmas are reported as
 standard deviations.
 
 \describe{
-\item{all sigmas:}{
+\item{all sigmas}{
 \eqn{FINAL = \sqrt \sigma^2, RSE% = 100*se(\sigma^2) / \sigma^2}
     }
 }"
tsahota,NMproject,c13fd1db1e4d9d95bb759661488242047a0d37bf,tarj sahota,t.sahota0@gmail.com,2021-08-06T20:45:38Z,tarj sahota,t.sahota0@gmail.com,2021-08-06T20:45:38Z,bootstrap spelling fix,R/boot.R;cran-comments.md,False,True,True,False,7,2,9,"---FILE: R/boot.R---
@@ -3,7 +3,7 @@
 #' Used by [make_boot_datasets()], run once per bootstrap sample
 #'
 #' @param d Dataset to merge.
-#' @param rsplit An object from `sample::bootstraps()`.
+#' @param rsplit An object from `rsample::bootstraps()`.
 #' @param data_name Name of dataset.
 #' @param data_folder Path to bootstrap datasets.
 #' @param id_var Character (default = `""ID""`). Name of ID column.

---FILE: cran-comments.md---
@@ -16,7 +16,12 @@ This is a resubmission. In this version I have:
 * Removed options(warn=-1) statements.
 * Removed examples from non-exported functions.
 * Added \value entries to all .Rd files
-* Restrained multi-core to use a single core in the vignettes and tests
+* Restrained multi-core to use a single core in the vignettes 
+  and tests.
+* Apologies, I cannot see where I am modifying .GlobalEnv. I 
+  have checked the global environment with 
+  ls(envir = .GlobalEnv, all.names = TRUE)
+  
 
 ## Test environments
 * local windows R installation, R 4.0.3"
tsahota,NMproject,84435a1f3d9f5447cde1513d24c9d0dc2aa914cf,tarjinde,tarjinder.z.sahota@gsk.com,2021-08-06T15:12:58Z,tarjinde,tarjinder.z.sahota@gsk.com,2021-08-06T15:12:58Z,doc fix LOGODDS removal,R/post-run-summaries.R;man/coef_widelong.Rd;man/rr.Rd,False,True,True,False,6,6,12,"---FILE: R/post-run-summaries.R---
@@ -19,8 +19,8 @@
 #' are the NONMEM reported values of parameters and standard errors, respectively
 #' 
 #' \describe{
-#'     \item{LOG or LOGODDS:}{
-#'       \eqn{FINAL = exp(\theta), RSE% = 100*\sqrt(exp^(se(\theta)) - 1)}
+#'     \item{LOG:}{
+#'       \eqn{FINAL = exp(\theta), RSE% = 100*\sqrt(exp^(se(\theta)^2) - 1)}
 #'     }
 #'     \item{RATIO:}{
 #'       \eqn{FINAL = \theta, RSE% = 100*se(\theta) / \theta}
@@ -138,7 +138,7 @@ rr.nm_generic <- function(m, trans = TRUE) {
 #' are the NONMEM reported values of parameters and standard errors, respectively
 #' 
 #' \describe{
-#'     \item{LOG or LOGODDS:}{
+#'     \item{LOG:}{
 #'       \eqn{FINAL = exp(\theta), RSE% = 100*\sqrt(exp^(se(\theta)) - 1)}
 #'     }
 #'     \item{RATIO:}{

---FILE: man/coef_widelong.Rd---
@@ -39,7 +39,7 @@ the reported standard error (where applicable) and \eqn{\theta} and \eqn{se(\the
 are the NONMEM reported values of parameters and standard errors, respectively
 
 \describe{
-\item{LOG or LOGODDS:}{
+\item{LOG:}{
 \eqn{FINAL = exp(\theta), RSE% = 100*\sqrt(exp^(se(\theta)) - 1)}
     }
 \item{RATIO:}{

---FILE: man/rr.Rd---
@@ -30,8 +30,8 @@ the reported standard error (where applicable) and \eqn{\theta} and \eqn{se(\the
 are the NONMEM reported values of parameters and standard errors, respectively
 
 \describe{
-\item{LOG or LOGODDS:}{
-\eqn{FINAL = exp(\theta), RSE% = 100*\sqrt(exp^(se(\theta)) - 1)}
+\item{LOG:}{
+\eqn{FINAL = exp(\theta), RSE% = 100*\sqrt(exp^(se(\theta)^2) - 1)}
     }
 \item{RATIO:}{
 \eqn{FINAL = \theta, RSE% = 100*se(\theta) / \theta}"
tsahota,NMproject,ef67564c999d82abb662da2ae0919e109c491a0b,tarjinde,tarjinder.z.sahota@gsk.com,2021-07-21T16:41:35Z,tarjinde,tarjinder.z.sahota@gsk.com,2021-07-21T16:41:35Z,"bug fix, run_nm was partially running.  Disabled the function.",R/addin-apps.R,False,True,True,False,3,0,3,"---FILE: R/addin-apps.R---
@@ -28,6 +28,9 @@ get_single_object_for_app <- function() {
   overwrite_behaviour(""skip"")
   on.exit(overwrite_behaviour(old_behaviour))
 
+  ## temporarily disable run_nm  
+  run_nm <- identity
+
   suppressMessages({
     m <- eval(parse(text = selected_text))
   })"
tsahota,NMproject,b301ebaf6a0b5e17ff4d0018180f17bee953e168,tarjinde,tarjinder.z.sahota@gsk.com,2021-07-21T15:03:03Z,tarjinde,tarjinder.z.sahota@gsk.com,2021-07-21T15:03:03Z,nm_diff bug fix stopped pop up,R/nm_diff.R,False,True,True,False,4,2,6,"---FILE: R/nm_diff.R---
@@ -59,10 +59,12 @@ nm_diff <- function(m, ref_m, format = ""raw"") {
   new_ctl <- as.character(ctl_character(ctl_contents(as_nm_generic(m))))
   # ""ansi256""
   dff <- diffobj::diffChr(old_ctl, new_ctl, format = format)
+  dff <- as.character(dff)
 
-  if (grepl(""No visible differences between objects"", as.character(dff)[1])) {
+  if (grepl(""No visible differences between objects"", dff[1])) {
     dff <- character()
   }
+  cat(dff, sep = ""\n"")
 
-  dff
+  invisible(dff)
 }"
tsahota,NMproject,b770bf7311c87262ed4907e285a175e1f576a84f,tarjinde,tarjinder.z.sahota@gsk.com,2021-07-21T10:34:20Z,tarjinde,tarjinder.z.sahota@gsk.com,2021-07-21T10:34:20Z,bug fix ofv always returns NA_real_ if it can't compute ofv,R/ofv.R,False,True,True,False,3,1,4,"---FILE: R/ofv.R---
@@ -48,7 +48,9 @@ ofv.nm_generic <- function(r) {
   if (inherits(dc, ""try-error"")) {
     return(NA_real_)
   }
-  dc$FINAL[dc$parameter %in% ""OBJ""]
+  ofv <- dc$FINAL[dc$parameter %in% ""OBJ""]
+  if (length(ofv) == 0) ofv <- NA_real_
+  ofv
 }
 #' @export
 ofv.nm_list <- Vectorize_nm_list(ofv.nm_generic)"
tsahota,NMproject,2e9e53a6018356494d227b02e07ccacdf4ffd3ce,kjh,lksfj,2021-07-17T20:59:58Z,kjh,lksfj,2021-07-17T21:17:46Z,"bug fix readme build error when using renv to create project

simplified README rmd template",R/make_project.R;inst/templates/README.Rmd,True,True,True,False,7,7,14,"---FILE: R/make_project.R---
@@ -105,7 +105,7 @@ nm_create_analysis_project <- function(path, dirs = nm_default_dirs(),
   usethis::use_build_ignore(file.path(""R"", ""Readme.txt""))
 
   usethis::use_template(""README.Rmd"",
-    data = list(Package = name),
+    data = c(Package = name, dirs),
     package = readme_template_package
   )
 

---FILE: inst/templates/README.Rmd---
@@ -11,7 +11,7 @@ knitr::opts_chunk$set(
   fig.path = ""man/figures/README-"",
   out.width = ""100%""
 )
-source("".Rprofile"")
+if (file.exists("".Rprofile"")) source("".Rprofile"")
 ```
 # {{{ Package }}}
 
@@ -26,12 +26,12 @@ The goal of {{{ Package }}} is to ...
 
 ## Directory structure
 
-- **`r NMproject::nm_dir(""scripts"")`**: Location of Script files for data cleaning, analysis and post-processing.
-- **`r NMproject::nm_dir(""models"")`**: Location of model files (e.g. NONMEM, Stan, ...).
+- **{{{scripts}}}**: Location of Script files for data cleaning, analysis and post-processing.
+- **{{{models}}}**: Location of model files (e.g. NONMEM, Stan, ...).
 - **R**: Location of any custom R functions used in scripts.  These can be loaded with `devtools::load_all()` or by sourcing indivdiually via `source(""R/functionname.R"")`.
-- **`r NMproject::nm_dir(""results"")`**: Location of Results files
-- **`r NMproject::nm_dir(""source_data"")`**: Location of unmodified source datasets
-- **`r NMproject::nm_dir(""derived_data"")`**: Location of analysis-ready datasets.  The production of these should be scripted.
+- **{{{results}}}**: Location of Results files
+- **{{{source_data}}}**: Location of unmodified source datasets
+- **{{{derived_data}}}**: Location of analysis-ready datasets.  The production of these should be scripted.
 
 ## Data sources
 "
tsahota,NMproject,8aad82001409fdc8f2b7242fa70f033803056e07,kjh,lksfj,2021-07-17T10:44:35Z,kjh,lksfj,2021-07-17T10:44:35Z,bug fix readme creation in custom dirs,R/make_project.R,False,True,True,False,5,1,6,"---FILE: R/make_project.R---
@@ -78,6 +78,10 @@ nm_create_analysis_project <- function(path, dirs = nm_default_dirs(),
   
   if(is.character(dirs) & length(dirs) == 1) dirs <- parse_dirs(dirs)
   
+  current_default_dirs <- nm_default_dirs()
+  nm_default_dirs(dirs)
+  on.exit(nm_default_dirs(current_default_dirs))
+  
   path <- normalizePath(path, mustWork = FALSE)
 
   style <- match.arg(style)
@@ -95,7 +99,7 @@ nm_create_analysis_project <- function(path, dirs = nm_default_dirs(),
     current_proj <- NULL
   }
   usethis::proj_set(path)
-  on.exit(usethis::proj_set(current_proj))
+  on.exit(usethis::proj_set(current_proj), add = TRUE)
 
   write(""This directory is for .R files containing R functions"", file.path(path, ""R"", ""Readme.txt""))
   usethis::use_build_ignore(file.path(""R"", ""Readme.txt""))"
tsahota,NMproject,80ca13855ded365645e379153f0a27b0188f0390,kjh,lksfj,2021-07-16T09:41:13Z,kjh,lksfj,2021-07-16T09:41:13Z,bug fix explicit DerivedData referral,R/boot.R;man/make_boot_datasets.Rd;man/make_xv_datasets.Rd,False,True,True,False,6,5,11,"---FILE: R/boot.R---
@@ -109,11 +109,12 @@ boot_to_csv <- function(d,
 #' @export
 make_boot_datasets <- function(m,
                                samples = 10,
-                               data_folder = ""DerivedData/bootstrap_datasets"",
+                               data_folder = file.path(nm_dir(""derived_data""), ""bootstrap_datasets""),
                                overwrite = FALSE,
                                id_var = ""ID"",
                                ...) {
-  bootsplits <- readRDS(paste0(""DerivedData/bootsplit_"", basename(data_path(m)), "".RData""))
+  bootsplits <- readRDS(file.path(nm_dir(""derived_data""), 
+                                  paste0(""bootsplit_"", basename(data_path(m)), "".RData"")))
 
   dboots <- bootsplits[seq_len(samples), ] # datasets created
   dboots$run_id <- 1:nrow(dboots)
@@ -167,7 +168,7 @@ make_boot_datasets <- function(m,
 #'
 #' @export
 make_xv_datasets <- function(dboot,
-                             data_folder = ""DerivedData/bootstrap_datasets"",
+                             data_folder = file.path(nm_dir(""derived_data""), ""bootstrap_datasets""),
                              overwrite = FALSE,
                              id_var = ""ID"") {
   d <- input_data(parent_run(dboot$m[1])) ## originally input_data(m)

---FILE: man/make_boot_datasets.Rd---
@@ -7,7 +7,7 @@
 make_boot_datasets(
   m,
   samples = 10,
-  data_folder = ""DerivedData/bootstrap_datasets"",
+  data_folder = file.path(nm_dir(""derived_data""), ""bootstrap_datasets""),
   overwrite = FALSE,
   id_var = ""ID"",
   ...

---FILE: man/make_xv_datasets.Rd---
@@ -6,7 +6,7 @@
 \usage{
 make_xv_datasets(
   dboot,
-  data_folder = ""DerivedData/bootstrap_datasets"",
+  data_folder = file.path(nm_dir(""derived_data""), ""bootstrap_datasets""),
   overwrite = FALSE,
   id_var = ""ID""
 )"
tsahota,NMproject,ab69d1a63c21b5c7231f333c394d33fa13d5e48e,kjh,lksfj,2021-07-05T19:15:54Z,kjh,lksfj,2021-07-05T19:15:54Z,bug import direct files,R/import-code.R,False,True,True,False,4,2,6,"---FILE: R/import-code.R---
@@ -178,8 +178,10 @@ import <- function(copy_table, overwrite = FALSE, silent = FALSE,
     )
   }
 
-  copy_table_orig$imported <- copy_table_orig$destination %in%
-    copy_table$destination
+  if(inherits(copy_table_orig, ""data.frame"")){
+    copy_table_orig$imported <- copy_table_orig$destination %in%
+      copy_table$destination 
+  }
 
   invisible(copy_table_orig)
 }"
tsahota,NMproject,03a99e63b5c1592950fd93d76d5d8e804f298a13,kjh,lksfj,2021-06-11T11:31:33Z,kjh,lksfj,2021-06-11T11:31:33Z,minor error msg update,R/make_project.R,False,True,True,False,1,1,2,"---FILE: R/make_project.R---
@@ -78,7 +78,7 @@ nm_create_analysis_project <- function(path, dirs = nm_default_dirs(),
   folder <- dirname(path)
 
   if (grepl(""package"", style) & !valid_package_name(name)) {
-    stop(""directory name is compliant for style = \""analysis-package\"" see ?validate_dir_list"")
+    stop(""directory name is not compliant for style = \""analysis-package\"" see ?nm_create_analysis_project"")
   }
 
   usethis::create_project(path = path, rstudio = TRUE, open = FALSE)"
tsahota,NMproject,dd6d574688c48826f3bb570cde1974b6ed75fccb,kjh,lksfj,2021-06-10T16:50:35Z,kjh,lksfj,2021-06-10T16:50:35Z,"fix, back to development version",DESCRIPTION,False,False,False,False,1,1,2,"---FILE: DESCRIPTION---
@@ -3,7 +3,7 @@ Type: Package
 Title: Script Based 'NONMEM' Model Development
 URL: https://tsahota.github.io/NMproject/, https://github.com/tsahota/NMproject
 BugReports: https://github.com/tsahota/NMproject/issues
-Version: 0.6.0
+Version: 0.5.9.9000
 Authors@R: c(
  person(""Tarj"", ""Sahota"", email = ""t.sahota0@gmail.com"", 
     role = c(""aut"", ""cre"", ""cph"")),"
tsahota,NMproject,880a452d4632e94130378dde13ad683c84e8b0c6,kjh,lksfj,2021-06-10T13:24:32Z,kjh,lksfj,2021-06-10T13:24:32Z,broken link fix,README.Rmd;README.md;vignettes/articles/NMproject.Rmd,True,False,True,False,9,13,22,"---FILE: README.Rmd---
@@ -72,10 +72,9 @@ library(NMproject)
 Two options:
 
 1. Running the
-[demo](https://tsahota.github.io/NMproject/articles/NMproject.html#demo-learn-by-doing-1)
+[demo](https://tsahota.github.io/NMproject/articles/articles/NMproject.html#demo-1)
 is easiest way to familiarise your with NMproject.
-2. Reading the 
-[vignette](https://tsahota.github.io/NMproject/articles/NMproject.html).
+2. Reading the website [vignette](https://tsahota.github.io/NMproject/articles/articles/NMproject.html).
 
 ## Code snippets
 
@@ -151,6 +150,5 @@ m1rep <- m1 %>% child(1:5) %>%
 
 ```
 
-See the
-[vignette](https://tsahota.github.io/NMproject/articles/NMproject.html) for more
+See the website [vignette](https://tsahota.github.io/NMproject/articles/articles/NMproject.html) for more
 examples

---FILE: README.md---
@@ -27,7 +27,7 @@ Script based NONMEM model development in RStudio.
 -   100% flexibility through tracked manual edits to model files
 -   Customisable to multiple infrastructure types
 
-[Two-minute Youtube
+[Two-minute YouTube
 summary](https://www.youtube.com/watch?v=b7oBb6QZub8) *WARNING: this is
 the prototype alpha interface. The new interface has a different
 syntax and is not backwards compatible. Video is to be replaced*
@@ -71,10 +71,10 @@ library(NMproject)
 Two options:
 
 1.  Running the
-    [demo](https://tsahota.github.io/NMproject/articles/NMproject.html#demo-learn-by-doing-1)
+    [demo](https://tsahota.github.io/NMproject/articles/articles/NMproject.html#demo-1)
     is easiest way to familiarise your with NMproject.
-2.  Reading the
-    [vignette](https://tsahota.github.io/NMproject/articles/NMproject.html).
+2.  Reading the website
+    [vignette](https://tsahota.github.io/NMproject/articles/articles/NMproject.html).
 
 ## Code snippets
 
@@ -145,6 +145,6 @@ m1rep <- m1 %>% child(1:5) %>%
   run_nm()
 ```
 
-See the
-[vignette](https://tsahota.github.io/NMproject/articles/NMproject.html)
+See the website
+[vignette](https://tsahota.github.io/NMproject/articles/articles/NMproject.html)
 for more examples

---FILE: vignettes/articles/NMproject.Rmd---
@@ -9,8 +9,6 @@ vignette: >
   %\VignetteEncoding{UTF-8}
 ---
 
-The best way to view this vignette link is on the [website](https://tsahota.github.io/NMproject/articles/NMproject.html).  If you're viewing this as a PDF, you will not able to see all the formatting including YouTube video demonstrations of certain parts of the interface.
-
 # Why NMproject?
 
 ## History"
tsahota,NMproject,c8a56fa2adf3661ce2057e671b413151f244b07c,Tarj Sahota,t.sahota0@gmail.com,2021-06-06T17:30:43Z,Tarj Sahota,t.sahota0@gmail.com,2021-06-06T17:30:43Z,nm_create_analysis_project normalizePath for home directory bug fix on windows,R/make_project.R,False,True,True,False,4,0,4,"---FILE: R/make_project.R---
@@ -67,6 +67,10 @@ nm_create_analysis_project <- function(path, dirs = nm_default_dirs(),
                                        style = c(""analysis"", ""analysis-package""), 
                                        use_renv = FALSE, ...){
   
+  ## need to normalize path because usethis has different
+  ## home directory, so use use R normalizePath to remove abiguity
+  path <- normalizePath(path, mustWork = FALSE)
+  
   validate_dir_list(dirs)
   
   style <- match.arg(style)"
tsahota,NMproject,220b0b8a36039b69b1984f817ef7ab547b795620,kjh,lksfj,2021-06-05T19:12:22Z,kjh,lksfj,2021-06-05T19:17:49Z,bug fix staging was writing to package ignore in tests,R/make_project.R,False,True,True,False,8,0,8,"---FILE: R/make_project.R---
@@ -213,7 +213,15 @@ stage <- function(files, root_dir,
   
   d <- d[!is.na(d$destination), ]
   dir_names <- unique(dirname(d$staging))
+  ### create staging with usethis
+  current_proj <- try(usethis::proj_get(), silent = TRUE)
+  if (inherits(current_proj, ""try-error"")) {
+    current_proj <- NULL
+  }
+  usethis::ui_silence(usethis::proj_set(getwd()))
+  on.exit(usethis::ui_silence(usethis::proj_set(current_proj)))
   usethis::use_directory(""staging"", ignore = TRUE)
+  usethis::ui_silence(usethis::proj_set(current_proj))
   for(dir_name in dir_names) dir.create(dir_name, recursive = TRUE, showWarnings = FALSE)
   
   existing_files <- d$staging[file.exists(d$staging)]"
tsahota,NMproject,77d46a28f505ce89b228ca6bad5e291de83f1f57,kjh,lksfj,2021-06-05T19:11:52Z,kjh,lksfj,2021-06-05T19:11:52Z,"separated rmd_to_vignette, added test and fixed bug in new directories (no vignette dir existing)",DESCRIPTION;R/nm.R;R/rmd_to_vignette.R;man/rmd_to_vignettes.Rd;tests/testthat/test-theopp.R,False,True,True,False,87,66,153,"---FILE: DESCRIPTION---
@@ -95,6 +95,7 @@ Collate:
     'prompt_overwrite.R'
     'psn_style_scm.R'
     'read_ext.R'
+    'rmd_to_vignette.R'
     'run_nm.R'
     'run_record.R'
     'shiny_apps.R'

---FILE: R/nm.R---
@@ -127,71 +127,6 @@ run_all_scripts <- function(index, quiet = FALSE){
 }
 
 
-#' Convert Rmarkdown scripts to vignettes
-#'
-#' @description 
-#' 
-#' `r lifecycle::badge(""experimental"")`
-#'
-#' Copies (by default) all scripts `s01_XXX.Rmd`, `s02_XXX.Rmd` into the
-#' ""vignettes"" and reformats so they meet vignette standards.  Use of
-#' [devtools::build_vignettes()] can then be used to build vignettes.
-#' 
-#' @param script_files Optional character vector of scripts.  If empty will find
-#' scripting making the `s##_XXX.Rmd` convention.  Must be .Rmd files
-#' @param overwrite Logical (default = `FALSE`). Overwrites existing vignettes
-#'   of the same name.
-#'
-#' @details Uses of [decision()] must pass without stopping so these must have
-#'   been run interactively prior to use of [devtools::build_vignettes()].
-#'   
-#' @export
-rmd_to_vignettes <- function(script_files, overwrite = FALSE){
-  
-  if(missing(script_files))
-    script_files <- dir(nm_default_dir(""scripts""), ""s[0-9]+_.*?\\.Rmd$"", full.names = TRUE)
-  
-  for(script in script_files){
-
-    contents <- readLines(script)
-    vignette_path <- file.path(""vignettes"", basename(script))
-    
-    match_start <- grep(""\\{r setup"", contents)
-    if(length(match_start) == 0) stop(""can't find setup block in"", script, call. = FALSE)
-    if(length(match_start) > 1) stop(""multiple setup block matches in"", script, call. = FALSE)
-    
-    vignette_title <- tools::file_path_sans_ext(basename(script))
-    
-    vignette_start <- c(""---"", 
-      paste0(""title: \"""",vignette_title,""\""""), 
-      ""output: rmarkdown::html_vignette"", 
-      ""vignette: >"", 
-      paste0(""  %\\VignetteIndexEntry{"",vignette_title,""}""), 
-      ""  %\\VignetteEngine{knitr::rmarkdown}"", 
-      ""  %\\VignetteEncoding{UTF-8}"", 
-      ""---"", 
-      """", 
-      ""```{r, include = FALSE}"", 
-      ""knitr::opts_chunk$set("", ""  collapse = TRUE,"", ""  comment = \""#>\"""", "")"", 
-      ""```"", 
-      """")
-    
-    contents <- c(vignette_start, contents[match_start:length(contents)])
-
-    if(!file.exists(vignette_path) | overwrite){
-      write(contents, vignette_path)
-      usethis::ui_done(paste0(""Writing '"", vignette_path, ""'""))      
-    } else {
-      if(file.exists(vignette_path))
-        usethis::ui_oops(paste0(""Cannot overwrite '"", vignette_path, ""' use 'overwrite' argument is TRUE""))      
-    }
-    
-  }
-
-}
-
-
-
 update_ignore <- function(ctl, ignore_char){
   ctl <- ctl_list(ctl)
   

---FILE: R/rmd_to_vignette.R---
@@ -0,0 +1,81 @@
+#' Convert Rmarkdown scripts to vignettes
+#'
+#' @description 
+#' 
+#' `r lifecycle::badge(""experimental"")`
+#'
+#' Copies (by default) all scripts `s01_XXX.Rmd`, `s02_XXX.Rmd` into the
+#' ""vignettes"" and reformats so they meet vignette standards.  Use of
+#' [devtools::build_vignettes()] can then be used to build vignettes.
+#' 
+#' @param script_files Optional character vector of scripts.  If empty will find
+#' scripting making the `s##_XXX.Rmd` convention.  Must be .Rmd files
+#' @param overwrite Logical (default = `FALSE`). Overwrites existing vignettes
+#'   of the same name.
+#'
+#' @details Uses of [decision()] must pass without stopping so these must have
+#'   been run interactively prior to use of [devtools::build_vignettes()].
+#'   
+#' @export
+rmd_to_vignettes <- function(script_files, overwrite = FALSE){
+  
+  if(missing(script_files))
+    script_files <- dir(nm_default_dir(""scripts""), ""s[0-9]+_.*?\\.Rmd$"", full.names = TRUE)
+  
+  for(script in script_files){
+    
+    contents <- readLines(script)
+    vignette_path <- file.path(""vignettes"", basename(script))
+    
+    match_start <- grep(""\\{r setup"", contents)
+    if(length(match_start) == 0) stop(""can't find setup block in"", script, call. = FALSE)
+    if(length(match_start) > 1) stop(""multiple setup block matches in"", script, call. = FALSE)
+    
+    vignette_title <- tools::file_path_sans_ext(basename(script))
+    
+    vignette_start <- c(""---"", 
+                        paste0(""title: \"""",vignette_title,""\""""), 
+                        ""output: rmarkdown::html_vignette"", 
+                        ""vignette: >"", 
+                        paste0(""  %\\VignetteIndexEntry{"",vignette_title,""}""), 
+                        ""  %\\VignetteEngine{knitr::rmarkdown}"", 
+                        ""  %\\VignetteEncoding{UTF-8}"", 
+                        ""---"", 
+                        """", 
+                        ""```{r, include = FALSE}"", 
+                        ""knitr::opts_chunk$set("", ""  collapse = TRUE,"", ""  comment = \""#>\"""", "")"", 
+                        ""```"", 
+                        """")
+    
+    contents <- c(vignette_start, contents[match_start:length(contents)])
+    
+    if(!file.exists(vignette_path) | overwrite){
+      if(!file.exists(""vignettes"")) {
+        ## switch to local project
+        current_proj <- try(usethis::proj_get(), silent = TRUE)
+        if (inherits(current_proj, ""try-error"")) {
+          current_proj <- NULL
+        }
+        usethis::proj_set(getwd())
+        on.exit(usethis::proj_set(current_proj))
+        
+        ## the following follows the usethis::use_vignette() steps without opening a file
+        usethis::ui_silence(usethis::use_package(""knitr"", ""Suggests""))
+        desc::desc_set(""VignetteBuilder"", ""knitr"")
+        usethis::use_git_ignore(""inst/doc"")
+        usethis::use_directory(""vignettes"")
+        usethis::use_git_ignore(c(""*.html"", ""*.R""), directory = ""vignettes"")
+        usethis::ui_silence(usethis::use_package(""rmarkdown"", ""Suggests""))
+        usethis::proj_set(current_proj)
+      }
+      write(contents, vignette_path)
+      usethis::ui_done(paste0(""Writing '"", vignette_path, ""'""))      
+    } else {
+      if(file.exists(vignette_path))
+        usethis::ui_oops(paste0(""Cannot overwrite '"", vignette_path, ""' use 'overwrite' argument is TRUE""))      
+    }
+    
+  }
+  
+}
+

---FILE: man/rmd_to_vignettes.Rd---
@@ -1,5 +1,5 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/nm.R
+% Please edit documentation in R/rmd_to_vignette.R
 \name{rmd_to_vignettes}
 \alias{rmd_to_vignettes}
 \title{Convert Rmarkdown scripts to vignettes}

---FILE: tests/testthat/test-theopp.R---
@@ -225,6 +225,10 @@ test_that(""run and post"",{
   expect_error(m1 %>% add_cov(param = ""K"", cov = ""DUMMY""))
   expect_error(m1 %>% add_cov(param = ""K"", cov = ""WT"", state = ""2"", additional_state_text = c(""2"" = ""nonsense"")))
   
+  ## rmd to vignettes
+  rmd_to_vignettes()
+  expect_true(length(dir(""vignettes"", pattern = ""\\.Rmd$"")) >= 5)
+  
   ## shouldn't be any temp files for m1 in zip
   expect_true(length(ls_tempfiles(m1)) == 0)
   "
tsahota,NMproject,9fad9662e3e4a587bc7e794d474ee99ffd293f08,kjh,lksfj,2021-06-04T15:53:59Z,kjh,lksfj,2021-06-04T15:53:59Z,bug fix,R/nm_object.R,False,True,True,False,6,4,10,"---FILE: R/nm_object.R---
@@ -46,20 +46,22 @@ To use the alpha interface, install NMproject 0.3.2"",
   m$ctl_contents <- NA_character_
   m$ctl_orig <- NA_character_
   m$data_path <- NA_character_
-  m$cmd <- getOption(""nm.cmd_default"")
+  m$cmd <- NA_character_
   m$cores <- as.integer(1)
   m$parafile <- NA_character_
   m$walltime <- NA_integer_
   
   unique_id <- ""{type}.{run_in}{.Platform$file.sep}{run_dir}""
   ## the following is in order of glueing
-  m$glue_fields <- list(run_dir, ctl_name, results_dir, unique_id, lst_path, NA_character_)
-  names(m$glue_fields) <- c(""run_dir"", ""ctl_name"", ""results_dir"", ""unique_id"", ""lst_path"", ""data_path"")
+  m$glue_fields <- list(run_dir, ctl_name, results_dir, unique_id, 
+                        lst_path, NA_character_, getOption(""nm.cmd_default""))
+  names(m$glue_fields) <- c(""run_dir"", ""ctl_name"", ""results_dir"", ""unique_id"", 
+                            ""lst_path"", ""data_path"", ""cmd"")
   
   for(field in names(m$glue_fields)){
     m <- replace_tag(m, field)
   }
-  
+
   m
 }
 "
tsahota,NMproject,206f7b1cbec62ee11494a9ef2bb599ddac1c93b8,tarj sahota,t.sahota0@gmail.com,2021-06-03T15:26:19Z,tarj sahota,t.sahota0@gmail.com,2021-06-03T15:26:19Z,converted IGNORE=C to warning instead of error,R/data_filter.R,False,True,True,False,2,2,4,"---FILE: R/data_filter.R---
@@ -21,9 +21,9 @@ data_ignore_char.nm_generic <- function(r, data){
   dol_data <- gsub(""IGNORE\\s*=\\s*#"", """", dol_data)
   
   if(any(grepl(""IGNORE\\s*=\\s*C\\b"",dol_data)))
-    stop(""NMproject currently doesn't work with IGNORE=C type runs.
+    warning(""NMproject currently doesn't work with IGNORE=C type runs.
        It is recommended to modify the control file to use IGNORE=@ instead."",
-         call. = FALSE)
+            call. = FALSE)
   
   ignore_present <- any(grepl("".*IGNORE\\s*=\\s*\\("",dol_data))
   accept_present <- any(grepl("".*ACCEPT\\s*=\\s*\\("",dol_data))"
tsahota,NMproject,4e9c8da1a2a55782cd6feab10a0b27845d878781,tarj sahota,t.sahota0@gmail.com,2021-06-02T13:16:45Z,tarj sahota,t.sahota0@gmail.com,2021-06-02T13:16:45Z,doc fix,.covrignore;R/find_nonmem.R;man/find_nonmem.Rd,False,True,True,False,3,2,5,"---FILE: .covrignore---
@@ -14,3 +14,4 @@ R/prompt_overwrite.R
 R/preview.R
 R/nmsave.R
 R/system_hooks.R
+R/zzz.R

---FILE: R/find_nonmem.R---
@@ -46,7 +46,7 @@ find_nm_install_path <- function(name = ""default""){
 #' @rdname find_nonmem
 #' @param warn Logical (default = `TRUE`) to warn if fails to find NMTRAN.exe
 #' 
-#' @details The function `find_nm_tran_path` will attempt to use a locally
+#' @details The function `find_nm_tran_path()` will attempt to use a locally
 #'   available PsN installation to get this information.  If the PsN
 #'   installation is on a remote server, this function will not work (it will
 #'   return a `NULL`). This is normally used to set [nm_tran_command()].  If

---FILE: man/find_nonmem.Rd---
@@ -30,7 +30,7 @@ The function \code{find_nm_install_path()} will attempt to use a locally availab
 installation to get this information.  If the PsN installation is on a
 remote server, this function will not work (it will return a \code{NULL})
 
-The function \code{find_nm_tran_path} will attempt to use a locally
+The function \code{find_nm_tran_path()} will attempt to use a locally
 available PsN installation to get this information.  If the PsN
 installation is on a remote server, this function will not work (it will
 return a \code{NULL}). This is normally used to set \code{\link[=nm_tran_command]{nm_tran_command()}}.  If"
tsahota,NMproject,6444748e53c98d28cc03bdef2e7c4a31716e603c,tarj sahota,t.sahota0@gmail.com,2021-06-01T15:37:08Z,tarj sahota,t.sahota0@gmail.com,2021-06-01T15:37:08Z,doc fix and na.omit reference,R/nm_object.R;man/run_all_scripts.Rd,False,True,True,False,7,4,11,"---FILE: R/nm_object.R---
@@ -1998,7 +1998,7 @@ init_theta.nm_generic <- function(m, replace, ...){
             names(entry_eval) <- NULL
             if(length(replace[replace$name %in% par_name, col_name]) == 0)
               stop(""parameter name not found, must be one of the following:\n "", 
-                   paste(na.omit(replace$name), collapse = "", ""), call. = FALSE)
+                   paste(stats::na.omit(replace$name), collapse = "", ""), call. = FALSE)
             replace[replace$name %in% par_name, col_name] <- entry_eval
           }
         }
@@ -2085,7 +2085,7 @@ init_omega.nm_generic <- function(m, replace, ...){
             names(entry_eval) <- NULL
             if(length(replace[replace$name %in% par_name, col_name]) == 0)
               stop(""parameter name not found, must be one of the following:\n "", 
-                   paste(na.omit(replace$name), collapse = "", ""), call. = FALSE)
+                   paste(stats::na.omit(replace$name), collapse = "", ""), call. = FALSE)
             replace[replace$name %in% par_name, col_name] <- entry_eval
           }
         }
@@ -2160,7 +2160,7 @@ init_sigma.nm_generic <- function(m, replace, ...){
             names(entry_eval) <- NULL
             if(length(replace[replace$name %in% par_name, col_name]) == 0)
               stop(""parameter name not found, must be one of the following:\n "", 
-                   paste(na.omit(replace$name), collapse = "", ""), call. = FALSE)
+                   paste(stats::na.omit(replace$name), collapse = "", ""), call. = FALSE)
             replace[replace$name %in% par_name, col_name] <- entry_eval
           }
         }

---FILE: man/run_all_scripts.Rd---
@@ -4,9 +4,12 @@
 \alias{run_all_scripts}
 \title{Run all project scripts sequentially}
 \usage{
-run_all_scripts(quiet = FALSE)
+run_all_scripts(index, quiet = FALSE)
 }
 \arguments{
+\item{index}{Numeric or logical vector (needs to be same length of number of
+scripts) for subsetting or reordering scripts to execute}
+
 \item{quiet}{Argument passed to \code{rmarkdown::render}}
 }
 \description{"
tsahota,NMproject,1e98b0e7452dd29826dfe9937618457a77a4253a,kjh,lksfj,2021-06-01T12:54:46Z,kjh,lksfj,2021-06-01T12:54:46Z,bug fix and expanded interface for init_*,R/Vectorize.R;R/nm.R;R/nm_object.R;inst/extdata/CodeLibrary/Scripts/AUC.R;tests/testthat/test-theopp.R,False,True,True,False,194,18,212,"---FILE: R/Vectorize.R---
@@ -1,10 +1,14 @@
 Vectorize_nm_list <- function (FUN, vectorize.args = arg.names, SIMPLIFY = FALSE, USE.NAMES = TRUE, 
                                invisible = FALSE, replace_arg = ""text"", pre_glue = FALSE,
-                               exclude_classes = c(""ggplot""))
+                               exclude_classes = c(""ggplot""),
+                               lazy_eval = c(),
+                               non_lazy_eval = c())
 {
   ## used create nm_list methods
   ## rule = if single arg, it will simplify (unlist) output i.e. get
   ##  otherwise it will set
+  if(length(lazy_eval) > 0 & length(non_lazy_eval) > 0)
+    stop(""cannot have both lazy_eval and non_lazy_eval specified"")
   
   missing_SIMPLIFY <- missing(SIMPLIFY)
   arg.names <- as.list(formals(FUN))
@@ -21,7 +25,13 @@ Vectorize_nm_list <- function (FUN, vectorize.args = arg.names, SIMPLIFY = FALSE
     stop(sQuote(""FUN""), "" may not have argument(s) named "", 
          paste(sQuote(arg.names[collisions]), collapse = "", ""))
   FUNV <- function() {
-    args <- lapply(as.list(match.call())[-1L], eval, parent.frame())
+    args <- as.list(match.call())[-1L]
+    ## if non_lazy_eval is specified, convert to lazy_eval
+    if(length(non_lazy_eval) > 0) lazy_eval <- setdiff(names(args), non_lazy_eval)
+    
+    args_eval <- lapply(args[!names(args) %in% lazy_eval], eval, parent.frame())
+    args_lazy <- args[names(args) %in% lazy_eval] 
+    args <- c(args_eval, args_lazy)[names(args)]
     ## MODIFIED: additional line to ensure if no args, the function is executed once
     if(length(args) == 0) args = formals(FUN)
     names <- if (is.null(names(args))) 

---FILE: R/nm.R---
@@ -100,14 +100,16 @@ setup_nm_demo <- function(demo_name = ""theopp"",
 #' Run all project scripts sequentially
 #'
 #' Runs all scripts s01_XXX, s02_XXX in the designated ""scripts"" directory
-#' 
+#'
+#' @param index Numeric or logical vector (needs to be same length of number of
+#'   scripts) for subsetting or reordering scripts to execute
 #' @param quiet Argument passed to `rmarkdown::render`
 #'
 #' @details works with .R and .Rmd extensions.  Behaviour is to `source` .R
 #'   files and use `rmarkdown::render` on .Rmd files
 #'
 #' @export
-run_all_scripts <- function(quiet = FALSE){
+run_all_scripts <- function(index, quiet = FALSE){
   
   script_files <- dir(nm_default_dir(""scripts""), ""s[0-9]+_.*?\\.R(md)?$"", full.names = TRUE)
   
@@ -121,6 +123,8 @@ run_all_scripts <- function(quiet = FALSE){
                    paste0(""source(\"""",script_files,""\"")""))
     )
   
+  if(!missing(index)) dplan <- dplan[index, ]
+  
   exprs <- rlang::parse_exprs(dplan$cmd)
   
   res <- lapply(exprs, rlang::eval_tidy)

---FILE: R/nm_object.R---
@@ -1974,7 +1974,36 @@ init_theta.nm_generic <- function(m, replace, ...){
   if(missing(replace)){  ## get
     if(length(mutate_args) > 0){
       current_init <- init_theta(m)
-      replace <- current_init %>% dplyr::mutate(!!!mutate_args)
+      
+      ## determine quosures produces named lists
+      mutate_style <- rep(TRUE, length(mutate_args))
+      
+      args_eval <- try(lapply(mutate_args, rlang::eval_tidy), silent = TRUE)
+      if(!inherits(args_eval, ""try-error"")){
+        ## evaluation worked, see if names are present
+        arg_names <- sapply(args_eval, function(x) length(names(x)))
+        mutate_style <- arg_names == 0
+      }
+      
+      replace <- current_init %>% dplyr::mutate(!!!(mutate_args)[mutate_style])
+      
+      ## handle mutate_args[!mutate_style]
+      ## use names to subset
+      if(!inherits(args_eval, ""try-error"")){
+        ## do simple replace of non mutate args
+        ## loop through columns and parameter values
+        for(col_name in names(args_eval)){
+          for(par_name in names(args_eval[[col_name]])){
+            entry_eval <- args_eval[[col_name]][par_name]
+            names(entry_eval) <- NULL
+            if(length(replace[replace$name %in% par_name, col_name]) == 0)
+              stop(""parameter name not found, must be one of the following:\n "", 
+                   paste(na.omit(replace$name), collapse = "", ""), call. = FALSE)
+            replace[replace$name %in% par_name, col_name] <- entry_eval
+          }
+        }
+      }
+      
       replace <- replace %>% dplyr::mutate_if(is.numeric, ~signif(., 5))
     } else {
       d <- d[!is.na(d$parameter), ]
@@ -1997,10 +2026,25 @@ init_theta.nm_generic <- function(m, replace, ...){
 }
 
 #' @export
-init_theta.nm_list <- Vectorize_nm_list(init_theta.nm_generic, SIMPLIFY = FALSE, 
+init_theta.nm_list <- Vectorize_nm_list(init_theta.nm_generic, SIMPLIFY = FALSE,
                                         replace_arg = ""replace"",
-                                        exclude_classes = c(""data.frame""))
-
+                                        exclude_classes = c(""data.frame""),
+                                        non_lazy_eval = c(""m"", ""replace""))
+
+
+# init_theta.nm_list <- function(m, replace, ...){
+#   current_call <- match.call()
+#   calling_env <- parent.frame()
+#   result <- lapply(m, function(m){
+#     current_call[[1]] <- as.symbol(""init_theta"")
+#     current_call[[2]] <- m
+#     eval(current_call, envir = calling_env)
+#   })
+#   if(is_nm_list(result)){
+#     result <- as_nm_list(result)
+#   }
+#   result
+# }
 
 #' @rdname init_theta
 #' @export
@@ -2017,7 +2061,36 @@ init_omega.nm_generic <- function(m, replace, ...){
   if(missing(replace)){  ## get
     if(length(mutate_args) > 0){
       current_init <- init_omega(m)
-      replace <- current_init %>% mutate_cond(!is.na(current_init$name), !!!mutate_args)
+      
+      ## determine quosures produces named lists
+      mutate_style <- rep(TRUE, length(mutate_args))
+      
+      args_eval <- try(lapply(mutate_args, rlang::eval_tidy), silent = TRUE)
+      if(!inherits(args_eval, ""try-error"")){
+        ## evaluation worked, see if names are present
+        arg_names <- sapply(args_eval, function(x) length(names(x)))
+        mutate_style <- arg_names == 0
+      }
+      
+      replace <- current_init %>% mutate_cond(!is.na(current_init$name), !!!(mutate_args)[mutate_style])
+      
+      ## handle mutate_args[!mutate_style]
+      ## use names to subset
+      if(!inherits(args_eval, ""try-error"")){
+        ## do simple replace of non mutate args
+        ## loop through columns and parameter values
+        for(col_name in names(args_eval)){
+          for(par_name in names(args_eval[[col_name]])){
+            entry_eval <- args_eval[[col_name]][par_name]
+            names(entry_eval) <- NULL
+            if(length(replace[replace$name %in% par_name, col_name]) == 0)
+              stop(""parameter name not found, must be one of the following:\n "", 
+                   paste(na.omit(replace$name), collapse = "", ""), call. = FALSE)
+            replace[replace$name %in% par_name, col_name] <- entry_eval
+          }
+        }
+      }
+      
       replace <- replace %>% dplyr::mutate_if(is.numeric, ~signif(., 5))
     } else {
       d$value <- NULL
@@ -2046,7 +2119,8 @@ init_omega.nm_generic <- function(m, replace, ...){
 #' @export
 init_omega.nm_list <- Vectorize_nm_list(init_omega.nm_generic, SIMPLIFY = FALSE, 
                                         replace_arg = ""replace"",
-                                        exclude_classes = c(""data.frame""))
+                                        exclude_classes = c(""data.frame""),
+                                        non_lazy_eval = c(""m"", ""replace""))
 
 #' @name init_theta
 #' @export
@@ -2063,7 +2137,35 @@ init_sigma.nm_generic <- function(m, replace, ...){
   if(missing(replace)){  ## get
     if(length(mutate_args) > 0){
       current_init <- init_sigma(m)
-      replace <- current_init %>% mutate_cond(!is.na(current_init$name), !!!mutate_args)
+      ## determine quosures produces named lists
+      mutate_style <- rep(TRUE, length(mutate_args))
+      
+      args_eval <- try(lapply(mutate_args, rlang::eval_tidy), silent = TRUE)
+      if(!inherits(args_eval, ""try-error"")){
+        ## evaluation worked, see if names are present
+        arg_names <- sapply(args_eval, function(x) length(names(x)))
+        mutate_style <- arg_names == 0
+      }
+      
+      replace <- current_init %>% mutate_cond(!is.na(current_init$name), !!!(mutate_args)[mutate_style])
+      
+      ## handle mutate_args[!mutate_style]
+      ## use names to subset
+      if(!inherits(args_eval, ""try-error"")){
+        ## do simple replace of non mutate args
+        ## loop through columns and parameter values
+        for(col_name in names(args_eval)){
+          for(par_name in names(args_eval[[col_name]])){
+            entry_eval <- args_eval[[col_name]][par_name]
+            names(entry_eval) <- NULL
+            if(length(replace[replace$name %in% par_name, col_name]) == 0)
+              stop(""parameter name not found, must be one of the following:\n "", 
+                   paste(na.omit(replace$name), collapse = "", ""), call. = FALSE)
+            replace[replace$name %in% par_name, col_name] <- entry_eval
+          }
+        }
+      }
+      
       replace <- replace %>% dplyr::mutate_if(is.numeric, ~signif(., 5))
     } else {
       d$value <- NULL
@@ -2091,7 +2193,8 @@ init_sigma.nm_generic <- function(m, replace, ...){
 #' @export
 init_sigma.nm_list <- Vectorize_nm_list(init_sigma.nm_generic, SIMPLIFY = FALSE, 
                                         replace_arg = ""replace"",
-                                        exclude_classes = c(""data.frame""))
+                                        exclude_classes = c(""data.frame""),
+                                        non_lazy_eval = c(""m"", ""replace""))
 
 
 update_variable_in_text_numbers <- function(m, before_number, after_number){

---FILE: inst/extdata/CodeLibrary/Scripts/AUC.R---
@@ -1,7 +1,39 @@
-## Description: Basic NCA AUC function
-## Key words: NCA, AUC, function
-## Author: Tarj Sahota, Peter Lawrence
-## Run interactively: FALSE
+#' @title Calculate AUC
+#'
+#' @description Computes AUC by trapezoidal rule.
+#'
+#' @author Tarj Sahota, Peter Lawrence
+#'
+#' @param time Numeric vector of times to integrate over.
+#' @param conc Numeric vector of concentrations to integrate.
+#' @param loq Numeric value (default = 0).  Conc values below this will be set
+#'   to 0.
+#' @param method Character indicating calculation method of trapezoidal area.
+#'
+#' @return Will return a single number for the AUC.  This function is most
+#'   useful using `dplyr`.
+#'
+#' @seealso [NMproject::ppc_data()]
+#' @examples
+#'
+#' \dontrun{
+#'
+#' AUC(d$TIME, d$DV)  ## return AUC number
+#'
+#' ## data.frame with AUC value for each ID (one row per ID)
+#' d %>% group_by(ID) %>%
+#'   summarise(AUC = AUC(TIME, DV),
+#'             CMAX = max(DV),
+#'             TMAX = TIME[which.max(DV)])
+#'
+#' ## Add exposure columns to a dataset
+#' d %>% group_by(ID) %>%
+#'   mutate(AUC = AUC(TIME, DV),
+#'             CMAX = max(DV),
+#'             TMAX = TIME[which.max(DV)])
+#'
+#' }
+#' @export
 
 AUC <- function(time, conc, loq=0,method=c(""linuplogdown"",""linuplogdowntmax"",""linear""))
 {

---FILE: tests/testthat/test-theopp.R---
@@ -32,7 +32,7 @@ test_that(""run and post"",{
 
   ## run all scripts
   overwrite_behaviour(""skip"")
-  
+
   res <- tryCatch(run_all_scripts(), error = function(e){
     on.exit({
       dump.frames(to.file = TRUE)
@@ -95,8 +95,35 @@ test_that(""run and post"",{
   expect_true(nrow(df) > 0 & nrow(df) < nrow(d))
 
   it <- m1 %>% init_theta() %>% dplyr::first()
-  it$init[1] <- 1
   m1 <- m1 %>% init_theta(it)
+  
+  ## test out 
+  m1 <- readRDS(""Results/m1.RDS"")
+  
+  expect_true(identical(0.5, it$init[it$name %in% ""KA""]))
+  
+  it <- m1 %>% init_theta(init = c(KA = 1)) %>% 
+    init_theta() %>% dplyr::first()
+  expect_true(identical(1, it$init[it$name %in% ""KA""]))
+  
+  it <- m1 %>% init_theta(init = rnorm(init, mean=init, sd = 0.3)) %>% 
+    init_theta() %>% dplyr::first()
+  expect_true(!identical(0.5, it$init[it$name %in% ""KA""]))
+  
+  expect_error(m1 %>% init_omega(init = c(FAKENAME = 1)))
+  
+  io <- m1 %>% init_omega(init = c(IIV_KA = 1)) %>% 
+    init_omega() %>% dplyr::first()
+  expect_true(identical(1, io$init[io$name %in% ""IIV_KA""]))
+
+  io <- m1 %>% init_omega(init = runif(init, min = init/2, max = init*2)) %>% 
+    init_omega() %>% dplyr::first()
+  expect_true(!identical(0.1, io$init[io$name %in% ""IIV_KA""]))
+  
+  is <- m1 %>% init_sigma(init = c(""prop error"" = 0.3)) %>% 
+    init_sigma() %>% dplyr::first()
+  expect_true(identical(0.3, is$init[is$name %in% ""prop error""]))
+  
   ##################
   ## omega block/unblock test - can delete this, it's in demo
   io <- m1 %>% init_omega()"
tsahota,NMproject,2f5e173fef585a7eee335f338355a04a34d6b92b,kjh,lksfj,2021-05-31T12:26:15Z,kjh,lksfj,2021-05-31T12:26:15Z,shiny code library bug fix + better dialog text,R/make_project.R;inst/extdata/code_library_shiny/server.R,False,True,True,False,42,12,54,"---FILE: R/make_project.R---
@@ -235,6 +235,8 @@ import <- function(copy_table, overwrite = FALSE, silent = FALSE,
   ## Code in Models/. not to be copied - this will be handled by nm() %>% ctl(""staging/..."")
   ## everything else copied as is
   
+  copy_table_orig <- copy_table
+  
   if(is.character(copy_table)){
     copy_table <- stage(copy_table, overwrite = overwrite, silent = silent)
   }
@@ -262,13 +264,16 @@ import <- function(copy_table, overwrite = FALSE, silent = FALSE,
   dirs <- unique(dirs)
   for(path in dirs) dir.create(path, recursive = TRUE, showWarnings = FALSE)
   
-  file.copy(d_R$staging, d_R$destination, overwrite = overwrite)
-  file.copy(d_other$staging, d_other$destination, overwrite = overwrite)
+  R_copy <- file.copy(d_R$staging, d_R$destination, overwrite = overwrite)
+  other_copy <- file.copy(d_other$staging, d_other$destination, overwrite = overwrite)
+  
+  if(!silent) message(""Files imported:\n "",
+                      paste(copy_table$destination, collapse = ""\n ""))
   
-  message(""Files imported:\n "",
-          paste(copy_table$destination, collapse = ""\n ""))
+  copy_table_orig$imported <- copy_table_orig$destination %in%
+    copy_table$destination
   
-  invisible()
+  invisible(copy_table_orig)
   
 }
 

---FILE: inst/extdata/code_library_shiny/server.R---
@@ -45,15 +45,40 @@ function(input, output, session) {
         title = ""Error"",
         ""Select a row first""
       )))
-    NMproject::stage(NMproject::ls_code_library(objects()$NAME), overwrite = TRUE) %>%
-      NMproject::import()
+
+    stage_ob <- NMproject::stage(
+      NMproject::ls_code_library(objects()$NAME), 
+      overwrite = TRUE,
+      silent = TRUE
+    )
+    import_ob <- NMproject::import(stage_ob, silent = TRUE)
+    
+    destinations <- ifelse(import_ob$imported, 
+                           import_ob$destination, 
+                           import_ob$staging)
+    
+    new_nm_text <- character()
+    if(any(!import_ob$imported)) 
+      new_nm_text <- paste0(
+        ""Create nm objects based on this file with:\n "",
+        ""<code>new_nm(.... , based_on = \"""", 
+        import_ob$staging[!import_ob$imported],
+        ""\"", ....)</code>\n\n""
+      )
+    
+    popup_text <- paste0(
+      ""File has been imported into following location:\n "",
+      ""<code>"",paste0(destinations, collapse = "" \n""), ""</code>\n\n"",
+      new_nm_text,
+      ""Close browser to go back to RStudio or press \""Dismiss\"" to import more""
+    )
+
+    popup_text <- HTML(gsub(""\n"", ""<br>"", popup_text))
+    
     return(showModal(modalDialog(
-      title = ""file imported"",
-      ""File has been imported into project.
-      Model files are in the \""staging\"" area and can be referred to with 
-      new_nm(.... , based_on = \""staging/path/to/file\"", ....).  
-      Close shiny app to go back to console.""
+      title = ""file imported"", popup_text
     )))
+    
   })
   
   observeEvent(input$import, eval(import_expr))"
tsahota,NMproject,1a021b32305cad119bb8f1808ac5f8e0d8f5b247,tarj sahota,t.sahota0@gmail.com,2021-05-30T23:15:01Z,tarj sahota,t.sahota0@gmail.com,2021-05-30T23:15:01Z,link fix,README.Rmd;README.md;vignettes/NMproject.Rmd,True,False,True,False,9,9,18,"---FILE: README.Rmd---
@@ -60,9 +60,9 @@ library(NMproject)
 
 ## Getting started with NMproject
 
-See the [vignette](https://tsahota.github.io/NMproject/articles/NMproject.html) for instructions on how to get started.
+The easiest way to familiarise your with NMproject is to follow through the [demo](https://tsahota.github.io/NMproject/articles/NMproject.html#demo-learn-by-doing-1).
 
-The easiest way to familiarise your with NMproject is to follow through the [demo](https://tsahota.github.io/NMproject/articles/NMproject.html#demo-1). 
+See the [vignette](https://tsahota.github.io/NMproject/articles/NMproject.html) for overall package documentation.
 
 ## Example code
 

---FILE: README.md---
@@ -62,13 +62,13 @@ library(NMproject)
 
 ## Getting started with NMproject
 
-See the
-[vignette](https://tsahota.github.io/NMproject/articles/NMproject.html)
-for instructions on how to get started.
-
 The easiest way to familiarise your with NMproject is to follow through
 the
-[demo](https://tsahota.github.io/NMproject/articles/NMproject.html#demo-1).
+[demo](https://tsahota.github.io/NMproject/articles/NMproject.html#demo-learn-by-doing-1).
+
+See the
+[vignette](https://tsahota.github.io/NMproject/articles/NMproject.html)
+for overall package documentation.
 
 ## Example code
 

---FILE: vignettes/NMproject.Rmd---
@@ -85,9 +85,9 @@ orig_dir <- getwd()
 
 ```
 
-# Demo: Learning by doing
+# Demo: Learn by doing
 
-The easiest way to familiarise your with NMproject is to run through the demo.  Here's a short YouTube video on running the demo
+The easiest way to familiarise your with NMproject is to run through the demo scripts line by line.  Here's a short YouTube video on running the demo
 
 <iframe width=""560"" height=""315"" src=""https://www.youtube.com/embed/nAkcEFz0RLg"" frameborder=""0"" allow=""accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"" allowfullscreen></iframe>
 "
tsahota,NMproject,2d6ad670de7110bd6743167ac119b7423fc691e4,tarj sahota,t.sahota0@gmail.com,2021-05-28T18:48:35Z,tarj sahota,t.sahota0@gmail.com,2021-05-28T18:48:35Z,bug fix NONMEM_version,R/find_nonmem.R,False,True,True,False,3,3,6,"---FILE: R/find_nonmem.R---
@@ -117,15 +117,15 @@ NONMEM_version <- function(){
   
   if(length(psn_nm_version) == 0) psn_nm_version <- ""not found""
   
-  nm_compiler_version <- system_nm(""gfortran --version"", intern = TRUE)[1]
+  nm_compiler_version <- system_nm(""gfortran --version"", intern = TRUE, ignore.stderr = TRUE, wait = TRUE)[1]
   if(length(nm_compiler_version) == 0) {
     nm_compiler_version <- ""not found""
   }
   
-  psn_version <- system_nm(""psn --version"", intern = TRUE)
+  psn_version <- system_nm(""psn --version"", intern = TRUE, ignore.stderr = TRUE, wait = TRUE)
   if(length(psn_version) == 0) psn_version <- ""not found""
   
-  perl_version <- system_nm(""perl --version"", intern = TRUE)
+  perl_version <- system_nm(""perl --version"", intern = TRUE, ignore.stderr = TRUE, wait = TRUE)
   perl_version <- perl_version[grepl(""This is"", perl_version)]
   perl_version <- gsub(""^.*\\((v.*)\\).*$"",""\\1"",perl_version)
   if(length(perl_version) == 0) perl_version <- ""not found"""
tsahota,NMproject,31011d8cc6ff5510f551b2b0b934aa02ce0d3a93,tarj sahota,t.sahota0@gmail.com,2021-05-24T21:35:59Z,tarj sahota,t.sahota0@gmail.com,2021-05-24T21:35:59Z,doc fix,R/nm_gettersetters.R;R/nm_object.R;R/nm_render.R;R/run_nm.R;R/shiny_apps.R;man/fill_input.Rd;man/init_theta.Rd;man/new_nm.Rd;man/nm_getsetters.Rd;man/nm_list_render.Rd;man/nm_render.Rd;man/run_nm.Rd;man/run_nm_batch.Rd;man/shiny_nm.Rd,False,True,True,False,292,198,490,"---FILE: R/nm_gettersetters.R---
@@ -44,15 +44,27 @@ ctl_path <- function(m, text) {
 #'
 #' @title Functions to access and modify fields of nm objects
 #'
-#' @param m nm object
-#' @param text optional character for replacing field. If present function will
+#' The fields of an object can be viewed by printing the object.  Each field has
+#' a corresponding function of the same name to access and modify it's value.
+#' 
+#' @param m An nm object.
+#' @param text Optional character for replacing field. If present function will
 #'   modify field (of same name as function) otherwise will return value of
-#'   field (of same name as function)
+#'   field (of same name as function).
 #'
 #' @details Easiest way to see all fields of an object is to type the object
 #'   into the console and hit enter. This will display the value of each field.
 #'   some fields like `cmd` are glue fields.  In these cases inserting
 #'   expressions inside braces in `text` will evaluate the expression
+#'   
+#'   The fundamental structure of all these functions is the same:
+#'   
+#'   To access the value of a field: 
+#'   `m %>% fieldname()` or equivalently `fieldname(m)`
+#'   
+#'   To modify the value of a field:
+#'   `m <- m %>% fieldname(""newvalue"")`
+#
 
 NULL
 

---FILE: R/nm_object.R---
@@ -102,12 +102,11 @@ nm <- Vectorize_nm_list(nm_generic, SIMPLIFY = FALSE)
 
 #'Create a new (parent) nm object
 #'
-#'@description `r lifecycle::badge(""stable"")`
+#'  escription `r lifecycle::badge(""stable"")`
 #'
-#'  Wrapper function around [nm()] to create a new parent `nm` object.  Normally
-#'  the first NONMEM you create will be using this functions.  Subsequent
-#'  objects created with the [child()] function will inherit the properties of
-#'  the parent run.
+#'  Create a new parent `nm` object.  Normally the first NONMEM you create will
+#'  be using this functions.  Subsequent objects created with the [child()]
+#'  function will inherit the properties of the parent run.
 #'
 #'@param based_on Character. Prior ctl file to base run on
 #'@param run_id Character. Run identifier
@@ -122,8 +121,11 @@ nm <- Vectorize_nm_list(nm_generic, SIMPLIFY = FALSE)
 #'  fields and if these change value like when the `child()` function is used to
 #'  create a separate child object, the `cmd` field will update automatically.
 #'
-#'@section object fields (see [nm_getsetters()] for accessing):
+#'@section object fields:
 #'
+#'  Each field has a corresponding function (documented in [nm_getsetters]) of the same name to access and
+#'  modify it's value.
+#'  
 #'  \describe{ 
 #'  \item{type}{
 #'    The PsN run type.  Default is `execute`.
@@ -799,21 +801,34 @@ fill_dollar_data <- function(m, data_name){
 }
 
 #' Fill $INPUT
-#' 
-#' Uses dataset to fill $INPUT in ctl_contents
-#' 
+#'
+#' @description
+#'
+#' `r lifecycle::badge(""stable"")`
+#'
+#' Uses dataset to automatically fill $INPUT in control file.
+#'
 #' @param m nm object
 #' @param ... either keep, drop, rename
-#' 
-#' @examples 
+#'
+#' @details If a new dataset with different columns is assigned to an `nm`
+#'   object, `$INPUT` will not be correct and so it may necessary to apply
+#'   `fill_input()` again.
+#'
+#' @examples
 #' \dontrun{
-#' 
-#'  m1 <- m1 %>% fill_input(rename = c(""DAT0"" = ""DATE""))
-#'  m1 %>% dollar(""INPUT"") ## view $INPUT
-#' 
+#'
+#'  m1 <- m1 %>% fill_input() m1 %>% dollar(""INPUT"") ## view $INPUT
+#'
+#'  ## following will will drop the ""RATE"" column
 #'  m1 <- m1 %>% fill_input(drop = ""RATE"")
 #'  m1 %>% dollar(""INPUT"")
-#'  
+#'
+#'  ## following will rename ""DATE"" to be ""DAT0""
+#'  m1 <- m1 %>% fill_input(rename = c(""DAT0"" = ""DATE""))
+#'  m1 %>% dollar(""INPUT"") ## view $INPUT
+#'
+#'
 #' }
 #' @export
 fill_input <- function(m, ...){
@@ -2064,32 +2079,51 @@ print.nm_subroutine <- function(x, ...){
 
 #' Get/set initial parameters
 #' 
+#' @description 
+#' 
+#' `r lifecycle::badge(""stable"")
+#' 
+#' These functions are useful to obtain and modify initial values of `$THETA`, `$OMEGA` and `$SIGMA`.
+#' 
 #' @param m nm object
 #' @param replace optional tibble for replacement
 #' @param ... mutate init_theta
 #' 
 #' @examples
 #' \dontrun{
 #' 
-#'  ## fix THETA on KA
-#'   ip <- init_theta(m1)
-#'   ip[[1]]$FIX[ip[[1]]$name %in% ""KA""] <- TRUE
-#'   m1 <- m1 %>% init_theta(ip)
+#' ## set initial values
+#' 
+#' m1 <- new_nm(run_id = ""m1"",
+#'              based_on = ""staging/Models/ADVAN2.mod"",
+#'              data_path = ""DerivedData/data.csv"") %>%
+#'       fill_input() %>%
+#'       init_theta(init = c(-2, 0.5, 1)) %>%
+#'       init_sigma(init = c(0.1, 0.1)) %>%
+#'       run_nm()
+#'       
+#' init_theta(m1)  ## display current $THETA in tibble-form
+#' init_omega(m1)  ## display current $OMEGA in tibble-form
+#' 
+#' ## fix THETA on KA
+#' ip <- init_theta(m1)[[1]]
+#' ip$FIX[ip$name %in% ""KA""] <- TRUE
+#' m1 <- m1 %>% init_theta(ip)
 #'   
-#'  ## fix OMEGA on KA to 0.0225
-#'   ip <- init_omega(m1)
-#'   ip[[1]]$init[ip[[1]]$name %in% ""IIV_KA""] <- 0.0225
-#'   ip[[1]]$FIX[ip[[1]]$name %in% ""IIV_KA""] <- TRUE
-#'   m1 <- m1 %>% init_omega(ip)
+#' ## fix OMEGA on KA to 0.0225
+#' ip <- init_omega(m1)[[1]]
+#' ip$init[ip$name %in% ""IIV_KA""] <- 0.0225
+#' ip$FIX[ip$name %in% ""IIV_KA""] <- TRUE
+#' m1 <- m1 %>% init_omega(ip)
 #'   
-#'  ## perturb all log transformed parameters by ~10%
-#'   m1 <- m1 %>% init_theta(
+#' ## perturb all log transformed parameters by ~10%
+#' m1 <- m1 %>% init_theta(
 #'     init = ifelse(
-#'       trans %in% ""LOG"",
-#'       rnorm(length(init), mean = init, sd = 0.1),
-#'       init
-#'     )
+#'     trans %in% ""LOG"",
+#'     rnorm(length(init), mean = init, sd = 0.1),
+#'     init
 #'   )
+#' )
 #' 
 #' }
 #' @name init_theta

---FILE: R/nm_render.R---
@@ -1,29 +1,54 @@
-#' Render function for nm objects
-#' 
-#' @param m nm object
-#' @param input character. Same as rmarkdown::render() arg
-#' @param output_file character. Same as rmarkdown::render() arg
-#' @param args list. Same as ""params"" arg in rmarkdown::render()
-#' @param force logical (default = `getOption(""nm.force_render"")`). will force execution
-#' @param async experimental option to use future package
-#' @param ... additional argument passed to rmarkdown::render()
-#' 
-#' @details 
-#' `input` must refer to a properly specified Rmd document.
-#' The R markdown template ""model diagnostic"" in RStudio sets this up 
-#' for you.
+#' @name nm_render
+#' @rdname nm_render
+#' @title Create run reports
+#'
+#' @description
+#'
+#' `r lifecycle::badge(""stable"")`
+#'
+#' A wrapper around `rmarkdown::render` for nm objects.  Use markdown templates
+#' to create a customised set of diagnostics to reuse on multiple models.
+#' Ideally, your model selection criteria in your run diagnostics.  To create a
+#' rmarkdown diagnostic template go to `FILE` -> `New File` -> `R markdown` ->
+#' `From Template` the select from one of the following:
+#'
+#' \itemize{ 
+#'   \item model diagnostic
+#'   \item VPC diagnostic 
+#'   \item PPC diagnostic
+#'   \item bootstrap results (`nm_list_render`)
+#' }
+#'
+#' These are intentionally minimal templates that can be run as notebooks or as
+#' automated diagnostics run with `nm_render`.  Follow the instructions at the
+#' top of the template for more details.
 #' 
+#' @param m An nm object.
+#' @param input Character. Same as `rmarkdown::render()` arg.
+#' @param output_file Character. Same as `rmarkdown::render()` arg.
+#' @param args List. Same as ""params"" arg in `rmarkdown::render()`.
+#' @param force Logical (default = `getOption(""nm.force_render"")`). Will force
+#'   execution.
+#' @param async Experimental option to use future package.
+#' @param ... Additional argument passed to `rmarkdown::render()`.
+#'
+#' @details `input` must refer to a properly specified Rmd document. The R
+#' markdown template ""model diagnostic"" in RStudio sets this up for you.
+#'
 #' These R markdown templates are usable as R Notebooks (e.g. for code
-#' development and debugging) if the object `.m` is defined in the
-#' global work space first.
+#' development and debugging) if the object `.m` is defined in the global work
+#' space first.
 #' 
-#' @examples 
+#' `nm_list_render()` is mostly used for bootstraps, and other routines where a
+#' parent run spawns multiple children in the form of an nm_list
+#'
+#' @examples
 #' \dontrun{
 #'   m1 %>% nm_render(""Scripts/basic_gof.Rmd"")
-#' 
+#'
 #'   ## to run ""Scripts/basic_gof.Rmd"" as an R Notebook
 #'   ## first define .m
-#'   
+#'
 #'   .m <- m1 ## Now you can run ""Scripts/basic_gof.Rmd"" as a Notebook
 #' }
 #' @export
@@ -116,19 +141,7 @@ nm_render.nm_generic <- function(m,
 #' @export
 nm_render.nm_list <- Vectorize_nm_list(nm_render.nm_generic, SIMPLIFY = FALSE, invisible = TRUE)
 
-#' Render function for child nm_lists
-#' 
-#' Mostly used for bootstraps, and other routines where
-#'   a parent run spawns multiple children in the form of an nm_list
-#' 
-#' @param m nm object
-#' @param input character. Same as rmarkdown::render() arg
-#' @param output_file character. Same as rmarkdown::render() arg
-#' @param args list. Same as ""params"" arg in rmarkdown::render()
-#' @param force logical (default = FALSE). will force execution
-#' @param async experiment - should future be used to run asynchronously
-#' @param ... additional arguments passed to rmarkdown::render()
-#' 
+#' @rdname nm_render
 #' @export
 nm_list_render <- function(m, 
                            input, 

---FILE: R/run_nm.R---
@@ -2,7 +2,10 @@
 
 NULL
 
-#' Run NONMEM jobs
+#' @name run_nm
+#' @rdname run_nm
+#'
+#' @title Run NONMEM jobs
 #'
 #' @description
 #'
@@ -37,7 +40,7 @@ NULL
 #'
 #' @return m with `job_info` fields populated.
 #'
-#' @seealso [nm_tran()], [run_nm_batch()]
+#' @seealso [nm_tran()]
 #'
 #' @examples
 #' \dontrun{
@@ -158,21 +161,15 @@ run_nm.nm_generic <- function(m,
 #' @export
 run_nm.nm_list <- Vectorize_nm_list(run_nm.nm_generic, SIMPLIFY = FALSE, invisible = TRUE)
 
-#' Execute run_nm in batches
-#'
-#' a variant of [run_nm()] that will submit [run_nm()]'s in
-#' batches and wait for them to complete
-#'
-#' @param m nm object
-#' @param threads numeric.  Number of threads to un
-#' @param ... additional arguments passed to run_nm()
-#'
-#' @details if you need all the runs to complete ensure you use a
+#' @rdname run_nm
+#' @param threads Numeric.  Number of threads to run concurrently.
+#' @param ... Additional arguments passed to `run_nm()`.
+#' 
+#' @details `run_nm_batch` is a variant of `run_nm()` containing a `threads` argument that will submit [run_nm()]'s in
+#' batches and wait for them to complete. If you need all the runs to complete ensure you use a
 #'   [wait_finish()] statement afterwards as R console will only be
 #'   blocked for until the last batch has been submitted which will be before
 #'   all runs have completed
-#'
-#' @seealso [run_nm()]
 #' @export
 
 run_nm_batch <- function(m, threads = 10, ...){

---FILE: R/shiny_apps.R---
@@ -1,10 +1,18 @@
 #' Run monitor & summary app
 #' 
-#' Interactively monitor NONMEM runs.  This interface is intentionally limited to monitoring
-#'  activities only.  Running and post processing should be scripted
+#' @description 
 #' 
-#' @param m either nm_list object, or data.frame or list or environment contain nm_lists
-#' @param envir if missing, the environment to search
+#' `r lifecycle::badge(""stable"")`
+#' 
+#' Interactively monitor NONMEM runs.  This interface is intentionally limited
+#' to monitoring runs, and does not include the ability to create, modify,
+#' launch or post-process runs since actions performed in the shiny app are not
+#' traceable/reproducible and not part of the workflow you create when
+#' scripting.
+#' 
+#' @param m Either an nm object, or data.frame or list or environment contain
+#'   nm_lists.
+#' @param envir If missing, the environment to search.
 #' @examples
 #' \dontrun{
 #'

---FILE: man/fill_input.Rd---
@@ -12,16 +12,28 @@ fill_input(m, ...)
 \item{...}{either keep, drop, rename}
 }
 \description{
-Uses dataset to fill $INPUT in ctl_contents
+\ifelse{html}{\href{https://lifecycle.r-lib.org/articles/stages.html#stable}{\figure{lifecycle-stable.svg}{options: alt='[Stable]'}}}{\strong{[Stable]}}
+
+Uses dataset to automatically fill $INPUT in control file.
+}
+\details{
+If a new dataset with different columns is assigned to an \code{nm}
+object, \verb{$INPUT} will not be correct and so it may necessary to apply
+\code{fill_input()} again.
 }
 \examples{
 \dontrun{
 
- m1 <- m1 \%>\% fill_input(rename = c(""DAT0"" = ""DATE""))
- m1 \%>\% dollar(""INPUT"") ## view $INPUT
+ m1 <- m1 \%>\% fill_input() m1 \%>\% dollar(""INPUT"") ## view $INPUT
 
+ ## following will will drop the ""RATE"" column
  m1 <- m1 \%>\% fill_input(drop = ""RATE"")
  m1 \%>\% dollar(""INPUT"")
- 
+
+ ## following will rename ""DATE"" to be ""DAT0""
+ m1 <- m1 \%>\% fill_input(rename = c(""DAT0"" = ""DATE""))
+ m1 \%>\% dollar(""INPUT"") ## view $INPUT
+
+
 }
 }

---FILE: man/init_theta.Rd---
@@ -20,30 +20,45 @@ init_sigma(m, replace, ...)
 \item{...}{mutate init_theta}
 }
 \description{
-Get/set initial parameters
+`r lifecycle::badge(""stable"")
+
+These functions are useful to obtain and modify initial values of \verb{$THETA}, \verb{$OMEGA} and \verb{$SIGMA}.
 }
 \examples{
 \dontrun{
 
- ## fix THETA on KA
-  ip <- init_theta(m1)
-  ip[[1]]$FIX[ip[[1]]$name \%in\% ""KA""] <- TRUE
-  m1 <- m1 \%>\% init_theta(ip)
+## set initial values
+
+m1 <- new_nm(run_id = ""m1"",
+             based_on = ""staging/Models/ADVAN2.mod"",
+             data_path = ""DerivedData/data.csv"") \%>\%
+      fill_input() \%>\%
+      init_theta(init = c(-2, 0.5, 1)) \%>\%
+      init_sigma(init = c(0.1, 0.1)) \%>\%
+      run_nm()
+      
+init_theta(m1)  ## display current $THETA in tibble-form
+init_omega(m1)  ## display current $OMEGA in tibble-form
+
+## fix THETA on KA
+ip <- init_theta(m1)[[1]]
+ip$FIX[ip$name \%in\% ""KA""] <- TRUE
+m1 <- m1 \%>\% init_theta(ip)
   
- ## fix OMEGA on KA to 0.0225
-  ip <- init_omega(m1)
-  ip[[1]]$init[ip[[1]]$name \%in\% ""IIV_KA""] <- 0.0225
-  ip[[1]]$FIX[ip[[1]]$name \%in\% ""IIV_KA""] <- TRUE
-  m1 <- m1 \%>\% init_omega(ip)
+## fix OMEGA on KA to 0.0225
+ip <- init_omega(m1)[[1]]
+ip$init[ip$name \%in\% ""IIV_KA""] <- 0.0225
+ip$FIX[ip$name \%in\% ""IIV_KA""] <- TRUE
+m1 <- m1 \%>\% init_omega(ip)
   
- ## perturb all log transformed parameters by ~10\%
-  m1 <- m1 \%>\% init_theta(
+## perturb all log transformed parameters by ~10\%
+m1 <- m1 \%>\% init_theta(
     init = ifelse(
-      trans \%in\% ""LOG"",
-      rnorm(length(init), mean = init, sd = 0.1),
-      init
-    )
+    trans \%in\% ""LOG"",
+    rnorm(length(init), mean = init, sd = 0.1),
+    init
   )
+)
 
 }
 }

---FILE: man/new_nm.Rd---
@@ -21,21 +21,23 @@ details.}
 An object of class \code{nm_list}.  Attributes
 }
 \description{
-\ifelse{html}{\href{https://lifecycle.r-lib.org/articles/stages.html#stable}{\figure{lifecycle-stable.svg}{options: alt='[Stable]'}}}{\strong{[Stable]}}
-
-Wrapper function around \code{\link[=nm]{nm()}} to create a new parent \code{nm} object.  Normally
-the first NONMEM you create will be using this functions.  Subsequent
-objects created with the \code{\link[=child]{child()}} function will inherit the properties of
-the parent run.
+escription \ifelse{html}{\href{https://lifecycle.r-lib.org/articles/stages.html#stable}{\figure{lifecycle-stable.svg}{options: alt='[Stable]'}}}{\strong{[Stable]}}
 }
 \details{
+Create a new parent \code{nm} object.  Normally the first NONMEM you create will
+be using this functions.  Subsequent objects created with the \code{\link[=child]{child()}}
+function will inherit the properties of the parent run.
+
 The \code{cmd} field uses \code{glue} notation.  So instead of specifying
 \verb{execute runm1.mod -dir=m1}, it is best to specify \verb{execute \{ctl_name\} -dir=\{run_dir\}}.  The values of \code{ctl_name} and \code{run_dir} refer to object
 fields and if these change value like when the \code{child()} function is used to
 create a separate child object, the \code{cmd} field will update automatically.
 }
-\section{object fields (see \code{\link[=nm_getsetters]{nm_getsetters()}} for accessing)}{
+\section{object fields}{
+
 
+Each field has a corresponding function (documented in \link{nm_getsetters}) of the same name to access and
+modify it's value.
 
 \describe{
 \item{type}{

---FILE: man/nm_getsetters.Rd---
@@ -20,7 +20,10 @@
 \alias{run_in}
 \alias{run_id}
 \alias{result_files}
-\title{Functions to access and modify fields of nm objects}
+\title{Functions to access and modify fields of nm objects
+
+The fields of an object can be viewed by printing the object.  Each field has
+a corresponding function of the same name to access and modify it's value.}
 \usage{
 run_dir(m, text)
 
@@ -59,20 +62,31 @@ run_id(m, text)
 result_files(m, text)
 }
 \arguments{
-\item{m}{nm object}
+\item{m}{An nm object.}
 
-\item{text}{optional character for replacing field. If present function will
+\item{text}{Optional character for replacing field. If present function will
 modify field (of same name as function) otherwise will return value of
-field (of same name as function)}
+field (of same name as function).}
 }
 \description{
 Functions to access and modify fields of nm objects
+
+The fields of an object can be viewed by printing the object.  Each field has
+a corresponding function of the same name to access and modify it's value.
 }
 \details{
 Easiest way to see all fields of an object is to type the object
 into the console and hit enter. This will display the value of each field.
 some fields like \code{cmd} are glue fields.  In these cases inserting
 expressions inside braces in \code{text} will evaluate the expression
+
+The fundamental structure of all these functions is the same:
+
+To access the value of a field:
+\code{m \%>\% fieldname()} or equivalently \code{fieldname(m)}
+
+To modify the value of a field:
+\code{m <- m \%>\% fieldname(""newvalue"")}
 }
 \examples{
 \dontrun{

---FILE: man/nm_list_render.Rd---
@@ -1,35 +0,0 @@
-% Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/nm_render.R
-\name{nm_list_render}
-\alias{nm_list_render}
-\title{Render function for child nm_lists}
-\usage{
-nm_list_render(
-  m,
-  input,
-  output_file = NA,
-  args = list(),
-  force = getOption(""nm.force_render""),
-  async = FALSE,
-  ...
-)
-}
-\arguments{
-\item{m}{nm object}
-
-\item{input}{character. Same as rmarkdown::render() arg}
-
-\item{output_file}{character. Same as rmarkdown::render() arg}
-
-\item{args}{list. Same as ""params"" arg in rmarkdown::render()}
-
-\item{force}{logical (default = FALSE). will force execution}
-
-\item{async}{experiment - should future be used to run asynchronously}
-
-\item{...}{additional arguments passed to rmarkdown::render()}
-}
-\description{
-Mostly used for bootstraps, and other routines where
-a parent run spawns multiple children in the form of an nm_list
-}

---FILE: man/nm_render.Rd---
@@ -2,7 +2,8 @@
 % Please edit documentation in R/nm_render.R
 \name{nm_render}
 \alias{nm_render}
-\title{Render function for nm objects}
+\alias{nm_list_render}
+\title{Create run reports}
 \usage{
 nm_render(
   m,
@@ -13,41 +14,71 @@ nm_render(
   async = FALSE,
   ...
 )
+
+nm_list_render(
+  m,
+  input,
+  output_file = NA,
+  args = list(),
+  force = getOption(""nm.force_render""),
+  async = FALSE,
+  ...
+)
 }
 \arguments{
-\item{m}{nm object}
+\item{m}{An nm object.}
 
-\item{input}{character. Same as rmarkdown::render() arg}
+\item{input}{Character. Same as \code{rmarkdown::render()} arg.}
 
-\item{output_file}{character. Same as rmarkdown::render() arg}
+\item{output_file}{Character. Same as \code{rmarkdown::render()} arg.}
 
-\item{args}{list. Same as ""params"" arg in rmarkdown::render()}
+\item{args}{List. Same as ""params"" arg in \code{rmarkdown::render()}.}
 
-\item{force}{logical (default = \code{getOption(""nm.force_render"")}). will force execution}
+\item{force}{Logical (default = \code{getOption(""nm.force_render"")}). Will force
+execution.}
 
-\item{async}{experimental option to use future package}
+\item{async}{Experimental option to use future package.}
 
-\item{...}{additional argument passed to rmarkdown::render()}
+\item{...}{Additional argument passed to \code{rmarkdown::render()}.}
 }
 \description{
-Render function for nm objects
+\ifelse{html}{\href{https://lifecycle.r-lib.org/articles/stages.html#stable}{\figure{lifecycle-stable.svg}{options: alt='[Stable]'}}}{\strong{[Stable]}}
+
+A wrapper around \code{rmarkdown::render} for nm objects.  Use markdown templates
+to create a customised set of diagnostics to reuse on multiple models.
+Ideally, your model selection criteria in your run diagnostics.  To create a
+rmarkdown diagnostic template go to \code{FILE} -> \verb{New File} -> \verb{R markdown} ->
+\verb{From Template} the select from one of the following:
+
+\itemize{
+\item model diagnostic
+\item VPC diagnostic
+\item PPC diagnostic
+\item bootstrap results (\code{nm_list_render})
+}
+
+These are intentionally minimal templates that can be run as notebooks or as
+automated diagnostics run with \code{nm_render}.  Follow the instructions at the
+top of the template for more details.
 }
 \details{
-\code{input} must refer to a properly specified Rmd document.
-The R markdown template ""model diagnostic"" in RStudio sets this up
-for you.
+\code{input} must refer to a properly specified Rmd document. The R
+markdown template ""model diagnostic"" in RStudio sets this up for you.
 
 These R markdown templates are usable as R Notebooks (e.g. for code
-development and debugging) if the object \code{.m} is defined in the
-global work space first.
+development and debugging) if the object \code{.m} is defined in the global work
+space first.
+
+\code{nm_list_render()} is mostly used for bootstraps, and other routines where a
+parent run spawns multiple children in the form of an nm_list
 }
 \examples{
 \dontrun{
   m1 \%>\% nm_render(""Scripts/basic_gof.Rmd"")
 
   ## to run ""Scripts/basic_gof.Rmd"" as an R Notebook
   ## first define .m
-  
+
   .m <- m1 ## Now you can run ""Scripts/basic_gof.Rmd"" as a Notebook
 }
 }

---FILE: man/run_nm.Rd---
@@ -2,6 +2,7 @@
 % Please edit documentation in R/run_nm.R
 \name{run_nm}
 \alias{run_nm}
+\alias{run_nm_batch}
 \title{Run NONMEM jobs}
 \usage{
 run_nm(
@@ -15,6 +16,8 @@ run_nm(
   cache_ignore_ctl = FALSE,
   cache_ignore_data = FALSE
 )
+
+run_nm_batch(m, threads = 10, ...)
 }
 \arguments{
 \item{m}{An nm object.}
@@ -38,6 +41,10 @@ contents with cache?}
 
 \item{cache_ignore_data}{Logical (default = FALSE). Should check dataset with
 cache?}
+
+\item{threads}{Numeric.  Number of threads to run concurrently.}
+
+\item{...}{Additional arguments passed to \code{run_nm()}.}
 }
 \value{
 m with \code{job_info} fields populated.
@@ -58,6 +65,12 @@ For vector \code{nm} objects of length more than 1, all runs will be launched at
 the same time.  This could overwhelm resources if not in a grid
 environment.  In this case see \code{\link[=run_nm_batch]{run_nm_batch()}} for batched execution of a
 vector valued \code{nm} object.
+
+\code{run_nm_batch} is a variant of \code{run_nm()} containing a \code{threads} argument that will submit \code{\link[=run_nm]{run_nm()}}'s in
+batches and wait for them to complete. If you need all the runs to complete ensure you use a
+\code{\link[=wait_finish]{wait_finish()}} statement afterwards as R console will only be
+blocked for until the last batch has been submitted which will be before
+all runs have completed
 }
 \examples{
 \dontrun{
@@ -71,5 +84,5 @@ m1 <- new_nm(run_id = ""m1"",
 }
 }
 \seealso{
-\code{\link[=nm_tran]{nm_tran()}}, \code{\link[=run_nm_batch]{run_nm_batch()}}
+\code{\link[=nm_tran]{nm_tran()}}
 }

---FILE: man/run_nm_batch.Rd---
@@ -1,28 +0,0 @@
-% Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/run_nm.R
-\name{run_nm_batch}
-\alias{run_nm_batch}
-\title{Execute run_nm in batches}
-\usage{
-run_nm_batch(m, threads = 10, ...)
-}
-\arguments{
-\item{m}{nm object}
-
-\item{threads}{numeric.  Number of threads to un}
-
-\item{...}{additional arguments passed to run_nm()}
-}
-\description{
-a variant of \code{\link[=run_nm]{run_nm()}} that will submit \code{\link[=run_nm]{run_nm()}}'s in
-batches and wait for them to complete
-}
-\details{
-if you need all the runs to complete ensure you use a
-\code{\link[=wait_finish]{wait_finish()}} statement afterwards as R console will only be
-blocked for until the last batch has been submitted which will be before
-all runs have completed
-}
-\seealso{
-\code{\link[=run_nm]{run_nm()}}
-}

---FILE: man/shiny_nm.Rd---
@@ -7,13 +7,19 @@
 shiny_nm(m, envir = .GlobalEnv)
 }
 \arguments{
-\item{m}{either nm_list object, or data.frame or list or environment contain nm_lists}
+\item{m}{Either an nm object, or data.frame or list or environment contain
+nm_lists.}
 
-\item{envir}{if missing, the environment to search}
+\item{envir}{If missing, the environment to search.}
 }
 \description{
-Interactively monitor NONMEM runs.  This interface is intentionally limited to monitoring
-activities only.  Running and post processing should be scripted
+\ifelse{html}{\href{https://lifecycle.r-lib.org/articles/stages.html#stable}{\figure{lifecycle-stable.svg}{options: alt='[Stable]'}}}{\strong{[Stable]}}
+
+Interactively monitor NONMEM runs.  This interface is intentionally limited
+to monitoring runs, and does not include the ability to create, modify,
+launch or post-process runs since actions performed in the shiny app are not
+traceable/reproducible and not part of the workflow you create when
+scripting.
 }
 \examples{
 \dontrun{"
tsahota,NMproject,f29c49c3adc92e759bde26cc686252c7b62ed99b,tarj sahota,t.sahota0@gmail.com,2021-05-19T19:45:08Z,tarj sahota,t.sahota0@gmail.com,2021-05-19T19:45:08Z,url fix,README.Rmd;README.md,True,False,True,False,16,12,28,"---FILE: README.Rmd---
@@ -49,17 +49,17 @@ Two-minute Youtube summary (alpha interface): https://www.youtube.com/watch?v=b7
 
 ## Installation
 
-NONMEM, PsN, and Rstudio are required to be installed prior to these steps.  To install a specific release version (e.g. v0.5.1) from [GitHub](https://github.com/):
+NONMEM, PsN, and Rstudio are required to be installed prior to these steps.  To install the latest development version from [GitHub](https://github.com/):
 
 ```{r eval = FALSE}
 if(!require(""devtools"")) install.packages(""devtools"")
-devtools::install_github(""tsahota/NMproject@v0.5.1"")
+devtools::install_github(""tsahota/NMproject"")
 ```
 
-To install the latest developmental version:
+To install a specific release (e.g. v0.5.1) use the following command:
 
 ```{r eval = FALSE}
-devtools::install_github(""tsahota/NMproject"")
+devtools::install_github(""tsahota/NMproject@v0.5.1"")
 ```
 
 Load the package with 
@@ -70,7 +70,9 @@ library(NMproject)
 
 ## Getting started with NMproject
 
-The easiest way to familiarise your with NMproject is to follow through the demo.  The (vignette)[https://tsahota.github.io/NMproject/articles/NMproject.html] gives instructions for how to get started.
+See the [vignette](https://tsahota.github.io/NMproject/articles/NMproject.html) for instructions on how to get started.
+
+The easiest way to familiarise your with NMproject is to follow through the demo. 
 
 ## Example code
 

---FILE: README.md---
@@ -57,18 +57,18 @@ Two-minute Youtube summary (alpha interface):
 ## Installation
 
 NONMEM, PsN, and Rstudio are required to be installed prior to these
-steps. To install a specific release version (e.g.v0.5.1) from
+steps. To install the latest development version from
 [GitHub](https://github.com/):
 
 ``` r
 if(!require(""devtools"")) install.packages(""devtools"")
-devtools::install_github(""tsahota/NMproject@v0.5.1"")
+devtools::install_github(""tsahota/NMproject"")
 ```
 
-To install the latest developmental version:
+To install a specific release (e.g.v0.5.1) use the following command:
 
 ``` r
-devtools::install_github(""tsahota/NMproject"")
+devtools::install_github(""tsahota/NMproject@v0.5.1"")
 ```
 
 Load the package with
@@ -79,10 +79,12 @@ library(NMproject)
 
 ## Getting started with NMproject
 
+See the
+[vignette](https://tsahota.github.io/NMproject/articles/NMproject.html)
+for instructions on how to get started.
+
 The easiest way to familiarise your with NMproject is to follow through
-the demo. The
-(vignette)\[<https://tsahota.github.io/NMproject/articles/NMproject.html>\]
-gives instructions for how to get started.
+the demo.
 
 ## Example code
 "
tsahota,NMproject,08c0ee0e297f4ece668eeb0e6ccde9d56f7b0c8b,tarj sahota,t.sahota0@gmail.com,2021-05-18T20:32:41Z,tarj sahota,t.sahota0@gmail.com,2021-05-18T20:34:04Z,cran fix,R/apply_manual_edit.R;tests/testthat/test-theopp.R,False,True,True,False,24,4,28,"---FILE: R/apply_manual_edit.R---
@@ -37,13 +37,19 @@ apply_manual_edit.nm_generic <- function(m, patch_name){
   patch_path_tmp <- paste0(patch_path, "".tmp"")
   writeLines(patch_text, patch_path_tmp)
   
-  patch_cmd <- paste(""git apply"", patch_path_tmp, ""-C1"")
+  patch_cmd <- paste(""git apply -C1"", patch_path_tmp)
   
   if(!git_cmd_available) stop(""need git available from system() for this to work"")  
-  res <- system(patch_cmd, intern = TRUE)  ## win = no need to use system_nm, no file sync issues
+  res <- system_cmd(patch_cmd, intern = TRUE)  ## win = no need to use system_nm, no file sync issues
   
   if(1 %in% attributes(res)$status){
-    stop(""patch failed"", call. = TRUE)
+    ## try again with whitespace fix, needed for some versions of git 
+    patch_cmd <- paste(""git apply --whitespace=fix -C1"", patch_path_tmp)
+    res <- system_cmd(patch_cmd, intern = TRUE)
+    
+    if(1 %in% attributes(res)$status){
+      stop(""patch failed"", call. = TRUE) 
+    }
   }
   
   out_file <- readLines(temp_ctl_path)

---FILE: tests/testthat/test-theopp.R---
@@ -32,7 +32,21 @@ test_that(""run and post"",{
 
   ## run all scripts
   overwrite_behaviour(""skip"")
-  expect_true(run_all_scripts())
+  
+  res <- tryCatch(run_all_scripts(), error = function(e){
+    on.exit({
+      dump.frames(to.file = TRUE)
+      debug_zip_file <- paste0(proj_path, "".zip"")
+      setwd("".."")
+      unlink(debug_zip_file)
+      utils::zip(basename(debug_zip_file), proj_name)
+      file.copy(debug_zip_file, file.path(currentwd, basename(debug_zip_file)))
+      setwd(currentwd)
+    })
+    stop(e)
+  })
+  
+  expect_true(res)
   
   res_files <- dir(""Results"", pattern = ""\\.html"", full.names = TRUE)
   expect_true(length(res_files) > 0)"
tsahota,NMproject,671eca05dc1644b507efc7a5e8281e11620c6753,tarj sahota,t.sahota0@gmail.com,2021-05-08T22:52:02Z,tarj sahota,t.sahota0@gmail.com,2021-05-08T22:52:02Z,bug fix cairo warning,R/nm_render.R,False,True,True,False,3,2,5,"---FILE: R/nm_render.R---
@@ -105,8 +105,9 @@ nm_render.nm_generic <- function(m,
                                  async = FALSE,
                                  ...){
   
-  if(getOption(""bitmapType"") != ""cairo"") 
-    warning(""if this step fails try setting options(bitmapType=\""cairo\"")"")
+  if(.Platform$OS.type == ""unix"")
+    if(!""cairo"" %in% getOption(""bitmapType"")) 
+      warning(""if this step fails try setting options(bitmapType=\""cairo\"")"")
   
   if(is.na(output_file))
     output_file <- paste0("
tsahota,NMproject,d57e122006b31c6b7b1ac33f8b87b1e7f8af1bbd,tarj sahota,t.sahota0@gmail.com,2021-05-08T22:01:23Z,tarj sahota,t.sahota0@gmail.com,2021-05-08T22:01:23Z,bug fix,R/nm_render.R,False,True,True,False,2,1,3,"---FILE: R/nm_render.R---
@@ -105,7 +105,8 @@ nm_render.nm_generic <- function(m,
                                  async = FALSE,
                                  ...){
   
-  if(getOption(""bitmapType"") != ""cairo"")
+  if(getOption(""bitmapType"") != ""cairo"") 
+    warning(""if this step fails try setting options(bitmapType=\""cairo\"")"")
   
   if(is.na(output_file))
     output_file <- paste0("
tsahota,NMproject,755a557ea6e2951a2173a16172904114c360a825,tarj sahota,t.sahota0@gmail.com,2021-04-30T11:11:52Z,tarj sahota,t.sahota0@gmail.com,2021-04-30T11:11:52Z,bug fix walltime,R/nm_object.R,False,True,True,False,1,0,1,"---FILE: R/nm_object.R---
@@ -49,6 +49,7 @@ To use the alpha interface, install NMproject 0.3.2"",
   m$cmd <- NA_character_
   m$cores <- as.integer(1)
   m$parafile <- NA_character_
+  m$walltime <- NA_integer_
   
   unique_id <- ""{type}.{run_in}{.Platform$file.sep}{run_dir}""
   ## the following is in order of glueing"
tsahota,NMproject,0a4306d8ee017cd4d4f21d5c4b70a0815dad3c3e,tarj sahota,t.sahota0@gmail.com,2021-04-29T22:34:37Z,tarj sahota,t.sahota0@gmail.com,2021-04-29T22:34:37Z,url fix,R/NMproject.R;R/make_project.R;man/NMproject.Rd;man/code_library.Rd,False,True,True,False,4,4,8,"---FILE: R/NMproject.R---
@@ -5,7 +5,7 @@
 #'
 #' @section Getting started:
 #'
-#'   URL: \url{http://tsahota.github.io/NMproject/}
+#'   URL: \url{https://tsahota.github.io/NMproject/}
 #'
 #'   The primary source of documentation is the webpage. The vignette is on the
 #'   ""Getting Started"" and the demo is accessible via the

---FILE: R/make_project.R---
@@ -380,7 +380,7 @@ ls_code_library <- function(pattern = ""."") {
 #' Function not designed for direct use.  Instead use the RStudio ""addin"" on the
 #' Addins menu. In the shiny, select the file, and click ""preview"" to view and
 #' \code{\link{stage}} to bring into the ""staging"" area of your project.  See
-#' vignette at \url{http://tsahota.github.io/NMproject/} for a video showing use
+#' vignette at \url{https://tsahota.github.io/NMproject/} for a video showing use
 #' of the app. Non-NONMEM code can then be imported into the project separately
 #' with the the \code{\link{import}} function.
 #'

---FILE: man/NMproject.Rd---
@@ -11,7 +11,7 @@ development workflows.
 \section{Getting started}{
 
 
-  URL: \url{http://tsahota.github.io/NMproject/}
+  URL: \url{https://tsahota.github.io/NMproject/}
 
   The primary source of documentation is the webpage. The vignette is on the
   ""Getting Started"" and the demo is accessible via the

---FILE: man/code_library.Rd---
@@ -30,7 +30,7 @@ code_library(
 Function not designed for direct use.  Instead use the RStudio ""addin"" on the
 Addins menu. In the shiny, select the file, and click ""preview"" to view and
 \code{\link{stage}} to bring into the ""staging"" area of your project.  See
-vignette at \url{http://tsahota.github.io/NMproject/} for a video showing use
+vignette at \url{https://tsahota.github.io/NMproject/} for a video showing use
 of the app. Non-NONMEM code can then be imported into the project separately
 with the the \code{\link{import}} function.
 }"
tsahota,NMproject,0151bcc4a64c8eaf0451b3607acf79562c746073,tarj sahota,t.sahota0@gmail.com,2021-04-29T21:02:34Z,tarj sahota,t.sahota0@gmail.com,2021-04-29T21:02:34Z,url fix,R/NMproject.R;R/make_project.R;man/NMproject.Rd;man/code_library.Rd,False,True,True,False,4,4,8,"---FILE: R/NMproject.R---
@@ -5,7 +5,7 @@
 #'
 #' @section Getting started:
 #'
-#'   URL: \url{http://tsahota.github.io/NMproject}
+#'   URL: \url{http://tsahota.github.io/NMproject/}
 #'
 #'   The primary source of documentation is the webpage. The vignette is on the
 #'   ""Getting Started"" and the demo is accessible via the

---FILE: R/make_project.R---
@@ -380,7 +380,7 @@ ls_code_library <- function(pattern = ""."") {
 #' Function not designed for direct use.  Instead use the RStudio ""addin"" on the
 #' Addins menu. In the shiny, select the file, and click ""preview"" to view and
 #' \code{\link{stage}} to bring into the ""staging"" area of your project.  See
-#' vignette at \url{http://tsahota.github.io/NMproject} for a video showing use
+#' vignette at \url{http://tsahota.github.io/NMproject/} for a video showing use
 #' of the app. Non-NONMEM code can then be imported into the project separately
 #' with the the \code{\link{import}} function.
 #'

---FILE: man/NMproject.Rd---
@@ -11,7 +11,7 @@ development workflows.
 \section{Getting started}{
 
 
-  URL: \url{http://tsahota.github.io/NMproject}
+  URL: \url{http://tsahota.github.io/NMproject/}
 
   The primary source of documentation is the webpage. The vignette is on the
   ""Getting Started"" and the demo is accessible via the

---FILE: man/code_library.Rd---
@@ -30,7 +30,7 @@ code_library(
 Function not designed for direct use.  Instead use the RStudio ""addin"" on the
 Addins menu. In the shiny, select the file, and click ""preview"" to view and
 \code{\link{stage}} to bring into the ""staging"" area of your project.  See
-vignette at \url{http://tsahota.github.io/NMproject} for a video showing use
+vignette at \url{http://tsahota.github.io/NMproject/} for a video showing use
 of the app. Non-NONMEM code can then be imported into the project separately
 with the the \code{\link{import}} function.
 }"
tsahota,NMproject,897dcd4df9a83c37e1132181e84b576e6a4e1162,tarj sahota,t.sahota0@gmail.com,2021-04-28T19:13:44Z,tarj sahota,t.sahota0@gmail.com,2021-04-28T19:13:44Z,cran fixes,DESCRIPTION;NAMESPACE;R/read.table.nm.R;R/shiny_apps.R;README.md,False,True,True,False,21,7,28,"---FILE: DESCRIPTION---
@@ -10,7 +10,7 @@ Authors@R: c(
 Maintainer: Tarj Sahota <t.sahota0@gmail.com>
 Description: Industrialisation of 'NONMEM'
   <https://www.iconplc.com/innovation/nonmem/> model development 
-  via end-to-end model development workflows.
+  via end-to-end model development 'workflows'.
 License: GPL (>= 3)
 Encoding: UTF-8
 Imports:
@@ -29,7 +29,6 @@ Imports:
     miniUI (>= 0.1.1),
     rstudioapi (>= 0.7),
     crayon (>= 1.3.4),
-    devtools,
     rprojroot,
     htmltools,
     rmarkdown,
@@ -51,7 +50,8 @@ Suggests:
     desc,
     purrr,
     digest,
-    covr
+    covr,
+    devtools
 Collate: 
     'NMproject.R'
     'addin_apps.R'

---FILE: NAMESPACE---
@@ -352,6 +352,7 @@ importFrom(magrittr,""%$%"")
 importFrom(magrittr,""%<>%"")
 importFrom(magrittr,""%>%"")
 importFrom(magrittr,""%T>%"")
+importFrom(methods,setAs)
 importFrom(rlang,.data)
 importFrom(stats,AIC)
 importFrom(stats,BIC)

---FILE: R/read.table.nm.R---
@@ -1,4 +1,10 @@
-suppressWarnings(suppressMessages(methods::setAs(""character"",""dummy.numeric"", function(from) as.numeric(from))))
+#' @importFrom methods setAs
+
+suppressWarnings(
+  suppressMessages(
+    methods::setAs(""character"",""dummy.numeric"", function(from) as.numeric(from))
+  )
+)
 
 #' Fast read of NONMEM output table
 #'
@@ -7,6 +13,7 @@ suppressWarnings(suppressMessages(methods::setAs(""character"",""dummy.numeric"", fu
 #' @export
 
 nm_read_table <- function(file,...){
+  
   tmp <- suppressWarnings(utils::read.table(file, fill=T, colClasses=""dummy.numeric"",...))
   return(tmp[stats::complete.cases(tmp[,sapply(tmp,function(i) !all(is.na(i)))]),])
 }

---FILE: R/shiny_apps.R---
@@ -32,8 +32,8 @@ shiny_nm <- function(m, envir = .GlobalEnv){
   if(!requireNamespace(""dygraphs"", quietly = TRUE))
     stop(""dygraphs needed for this function to work. Please install it."",
          call. = FALSE)
-  dygraphs::dygraph
-  DT::datatable
+  dygraphs::dygraph  ## check main function exists
+  DT::datatable      ## check main function exists
   shiny_dir <- system.file(""extdata/shiny"",package=""NMproject"")
   .sso_env$.currentwd <- getwd()  # see zzz.R for .sso_env
   .sso_env$.m <- m  # see zzz.R for .sso_env
@@ -56,6 +56,12 @@ code_library_app <- function(){
 
 overwrite_behaviour_app <- function() {
   
+  if(!requireNamespace(""miniUI"", quietly = TRUE))
+    stop(""miniUI needed for this function to work. Please install it."",
+         call. = FALSE)
+  
+  miniUI::miniPage  ## main function needed
+  
   shiny_dir <- system.file(""extdata/overwrite_behaviour"", package=""NMproject"")
   .sso_env$.currentwd <- getwd()  # see zzz.R for .sso_env
   on.exit({

---FILE: README.md---
@@ -12,7 +12,7 @@ Status](https://coveralls.io/repos/github/tsahota/NMproject/badge.svg?branch=mas
 [![AppVeyor Build
 Status](https://ci.appveyor.com/api/projects/status/github/tsahota/NMproject?branch=master&svg=true)](https://ci.appveyor.com/project/tsahota/NMproject)
 [![Lifecycle:
-maturing](https://img.shields.io/badge/lifecycle-maturing-blue.svg)](https://www.tidyverse.org/lifecycle/#maturing)
+maturing](https://img.shields.io/badge/lifecycle-maturing-blue.svg)](https://lifecycle.r-lib.org/articles/stages.html)
 [![Codecov test
 coverage](https://codecov.io/gh/tsahota/NMproject/branch/master/graph/badge.svg)](https://codecov.io/gh/tsahota/NMproject?branch=master)
 <!-- badges: end -->"
tsahota,NMproject,28e96f7dcc72416021f462a02d6b1b018947aaf5,tarj sahota,t.sahota0@gmail.com,2021-04-27T21:33:54Z,tarj sahota,t.sahota0@gmail.com,2021-04-27T21:33:54Z,"added walltime, is_rstudio + doc fix",NAMESPACE;R/nm_gettersetters.R;R/nm_object.R;R/utils.R;man/is_rstudio.Rd;man/nm_getsetters.Rd;vignettes/NMproject.Rmd,True,True,True,False,30,1,31,"---FILE: NAMESPACE---
@@ -232,6 +232,7 @@ export(insert_dollar)
 export(is_finished)
 export(is_nm_generic)
 export(is_nm_list)
+export(is_rstudio)
 export(is_successful)
 export(job_info)
 export(job_stats)
@@ -339,6 +340,7 @@ export(update_sizes)
 export(view_patch)
 export(wait_finish)
 export(wait_for)
+export(walltime)
 export(wipe_run)
 export(write_ctl)
 export(write_derived_data)

---FILE: R/nm_gettersetters.R---
@@ -171,6 +171,12 @@ parafile <- function(m, text) {
   }
 }
 
+#' @rdname nm_getsetters
+#' @export
+walltime <- function(m, text) {
+  if(missing(text)) custom_1d_field(m, ""walltime"") else custom_1d_field(m, ""walltime"", text)
+}
+
 #' @rdname nm_getsetters
 #' @export
 executed <- function(m, text) {

---FILE: R/nm_object.R---
@@ -49,6 +49,7 @@ To use the alpha interface, install NMproject 0.3.2"",
   m$cmd <- NA_character_
   m$cores <- as.integer(1)
   m$parafile <- NA_character_
+  m$walltime <- NA_integer_
   
   unique_id <- ""{type}.{run_in}{.Platform$file.sep}{run_dir}""
   ## the following is in order of glueing

---FILE: R/utils.R---
@@ -82,3 +82,9 @@ relative_path <- function(path, relative_path){
 }
 
 relative_path <- Vectorize(relative_path, USE.NAMES = FALSE)
+
+
+#' Logical flag for detecting if R session is on rstudio not
+#' @export
+is_rstudio <- function() Sys.getenv(""RSTUDIO"") == ""1""
+

---FILE: man/is_rstudio.Rd---
@@ -0,0 +1,11 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/utils.R
+\name{is_rstudio}
+\alias{is_rstudio}
+\title{Logical flag for detecting if R session is on rstudio not}
+\usage{
+is_rstudio()
+}
+\description{
+Logical flag for detecting if R session is on rstudio not
+}

---FILE: man/nm_getsetters.Rd---
@@ -14,6 +14,7 @@
 \alias{results_dir}
 \alias{cores}
 \alias{parafile}
+\alias{walltime}
 \alias{executed}
 \alias{lst_path}
 \alias{run_in}
@@ -45,6 +46,8 @@ cores(m, text)
 
 parafile(m, text)
 
+walltime(m, text)
+
 executed(m, text)
 
 lst_path(m, text)

---FILE: vignettes/NMproject.Rmd---
@@ -68,7 +68,7 @@ The easiest way to familiarise your with NMproject is to follow through the demo
 
 <iframe width=""560"" height=""315"" src=""https://www.youtube.com/embed/nAkcEFz0RLg"" frameborder=""0"" allow=""accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"" allowfullscreen></iframe>
 
-First create a new tidyproject (`FILE` -> `New Project` -> `New Directory` -> `New tidyproject`). You'll see a clean analysis directory with empty subfolders.  Run the following in the new R session:
+First create a new NMproject (`FILE` -> `New Project` -> `New Directory` -> `New NMproject`). You'll see a clean analysis directory with empty subfolders.  Run the following in the new R session:
 
 ```{r eval = FALSE}
 library(NMproject)"
tsahota,NMproject,aa67a22079924a27f5bf752abda2a872406b181e,tarj sahota,t.sahota0@gmail.com,2021-04-27T13:49:30Z,tarj sahota,t.sahota0@gmail.com,2021-04-27T13:49:30Z,decision bug fix,R/nm_object.R,False,True,True,False,1,1,2,"---FILE: R/nm_object.R---
@@ -2937,7 +2937,7 @@ decision <- function(inputs = c(),
       stop(error_msg, call. =  FALSE)
     }
     if(ans %in% ""c""){
-      return(FALSE)
+      stop(""have a look at inputs and if you agree with decision, rerun this answering [y] "", call. =  FALSE)
     }
     if(ans %in% ""y""){
       return(TRUE)"
tsahota,NMproject,0d18ca3f3aae6e7c5efbd99f0cb3fcc5a3db109e,tarj sahota,t.sahota0@gmail.com,2021-04-25T23:56:23Z,tarj sahota,t.sahota0@gmail.com,2021-04-25T23:56:23Z,"removed load_sse, bug fix .covrignore",.covrignore;R/load_sse.R,False,True,True,False,2,67,69,"---FILE: .covrignore---
@@ -1,2 +1,2 @@
-developer_funs.R
-shiny_apps.R
+R/developer_funs.R
+R/shiny_apps.R

---FILE: R/load_sse.R---
@@ -1,65 +0,0 @@
-#' Load SSE data
-#'
-#' Experimental function to load simulation data from PsN SSE
-#' This facilitates extracting data needed for postprocessing of simulations
-#' poptentially helpfor after simulation with uncertainty (e.g. obtained through PsN bootstrap or impance sampling)
-#'
-#' @param x object class nm
-#' @param parr logical. include description here#'
-#' @param nodes include description here
-#' @export
-
-load_sse <- function(x, parr=F, nodes=1) {
-# Load SSE data -----------------------------------------------------------
-## create list of paths for the tables
-  # If you're not using NMprojects, you can skip this part
-  dir <- ""/m1"" # Path to simulated data
-  full_dir <- paste(run_dir(x), dir, sep = """")
-  
-  cmd <- as.vector(strsplit(cmd(x), "" ""), mode = 'list')
-  
-  if (!'sse' %in% cmd[[1]])
-    stop(""Object not an SSE PsN object"")
- 
-  nruns <- as.numeric(strsplit(cmd[[1]][grep(""-samples"", cmd[[1]])],""="")[[1]][2])
-  # If you're not using NMprojects, you can skip this part
-  # provide full dir <- ""/path""
-  # provide nruns <- number of samples
-  
-  paths <- c()
-  for (i in 1:nruns) {       ## create a vector of data set paths
-    path <- paste(full_dir,""/mc-sim-"",i,"".dat"",sep="""")
-    paths <- append(paths, path)
-  }
-  
-  # Read in dataframes and d0 dataprocessing
-  process1 <- function(data_path){
-    d <- utils::read.csv(data_path, skip = 1, header = T)
-    # If you are working with large dataframes, you may be required to implement dataprocessing steps, depending on your capacity, check/set memory.limit()
-    save(d, file = paste0(data_path,""processed.RData""))
-  }
-  
-  #Apply the function to the paths using either lapply or a parallel version for computational demanding steps
-  #if you are running this code, choose one of the options and specify the number of nodes if you wish to use multiple
-  
-  if (parr) {
-    parallel::mclapply(paths, process1, mc.cores = nodes)
-    } else { ## will run the processing in parallel
-      lapply(paths, process1)
-    }
-  
-  #load processed.Rdata into R environment and create list of dataframes
-  get_processed <- function(data_path){
-    load(paste0(data_path,""processed.RData""))
-    d
-  }
-  
-  # apply to paths
-  d <- lapply(paths, get_processed)
-  
-  print(""Only data from simulation step will be loaded, you may adapt this function to load data from estimation step, or to do both."")
-  
-  # rbind dataframes
-  d <- do.call(rbind, d)
-  
-}"
tsahota,NMproject,8dcccc7b63c584b2759df9e0a3105a9eea85f12b,tarj sahota,t.sahota0@gmail.com,2021-04-25T20:45:08Z,tarj sahota,t.sahota0@gmail.com,2021-04-25T20:45:08Z,NMprojectExtra -> nm_object + template location fix,DESCRIPTION;R/cache.R;R/nm_object.R;inst/templates/README.Rmd;man/add_mixed_param.Rd;man/block.Rd;man/change_parent.Rd;man/child.Rd;man/convert_to_simulation.Rd;man/data_path.Rd;man/decision.Rd;man/delete_dollar.Rd;man/dollar.Rd;man/fill_input.Rd;man/ignore.Rd;man/init_theta.Rd;man/input_data.Rd;man/insert_dollar.Rd;man/ls_tempfiles.Rd;man/make_OCC_every_dose.Rd;man/new_nm.Rd;man/nm.Rd;man/nm_diff.Rd;man/nm_list_gather.Rd;man/nm_row.Rd;man/nm_tree.Rd;man/parent_run.Rd;man/ppc.Rd;man/read_derived_data.Rd;man/remove_parameter.Rd;man/rename_parameter.Rd;man/result_file.Rd;man/run_dir_path.Rd;man/show_ctl.Rd;man/show_out.Rd;man/simple_field.Rd;man/target.Rd;man/unblock.Rd;man/untarget.Rd;man/update_parameters.Rd;man/write_derived_data.Rd;tests/testthat/test-theopp.R,True,True,True,False,41,40,81,"---FILE: DESCRIPTION---
@@ -52,10 +52,10 @@ Suggests:
     covr
 Collate: 
     'NMproject.R'
+    'boot.R'
     'utils.R'
     'utilsExtra.R'
-    'NMprojectExtra.R'
-    'boot.R'
+    'nm_object.R'
     'cache.R'
     'covariate_building.R'
     'nm.R'

---FILE: R/cache.R---
@@ -1,3 +1,5 @@
+#' @include nm_object.R
+
 run_checksums <- function(m){  ## only works on single m
   ## information determinative to whether run should be rerun
   mtmp <- m %>% run_in(file.path(run_in(m), ""temp""))

---FILE: man/add_mixed_param.Rd---
@@ -1,5 +1,5 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R
+% Please edit documentation in R/nm_object.R
 \name{add_mixed_param}
 \alias{add_mixed_param}
 \title{add a mixed effect parameter to $PK (or $PRED)}

---FILE: man/block.Rd---
@@ -1,5 +1,5 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R
+% Please edit documentation in R/nm_object.R
 \name{block}
 \alias{block}
 \title{Create omega/sigma block from init_omega() and init_sigma() output}

---FILE: man/change_parent.Rd---
@@ -1,5 +1,5 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R
+% Please edit documentation in R/nm_object.R
 \name{change_parent}
 \alias{change_parent}
 \title{Change parent object}

---FILE: man/child.Rd---
@@ -1,5 +1,5 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R
+% Please edit documentation in R/nm_object.R
 \name{child}
 \alias{child}
 \title{Make child nm object from parent}

---FILE: man/convert_to_simulation.Rd---
@@ -1,5 +1,5 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R
+% Please edit documentation in R/nm_object.R
 \name{convert_to_simulation}
 \alias{convert_to_simulation}
 \title{convert a NONMEM run to a simulation}

---FILE: man/data_path.Rd---
@@ -1,5 +1,5 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R
+% Please edit documentation in R/nm_object.R
 \name{data_path}
 \alias{data_path}
 \title{Get/set path to dataset}

---FILE: man/decision.Rd---
@@ -1,5 +1,5 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R
+% Please edit documentation in R/nm_object.R
 \name{decision}
 \alias{decision}
 \title{make decision point}

---FILE: man/delete_dollar.Rd---
@@ -1,5 +1,5 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R
+% Please edit documentation in R/nm_object.R
 \name{delete_dollar}
 \alias{delete_dollar}
 \title{Delete a $ subroutine from ctl_contents}

---FILE: man/dollar.Rd---
@@ -1,5 +1,5 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R
+% Please edit documentation in R/nm_object.R
 \name{dollar}
 \alias{dollar}
 \title{Get/set existing subroutine}

---FILE: man/fill_input.Rd---
@@ -1,5 +1,5 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R
+% Please edit documentation in R/nm_object.R
 \name{fill_input}
 \alias{fill_input}
 \title{fill $INPUT}

---FILE: man/ignore.Rd---
@@ -1,5 +1,5 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R
+% Please edit documentation in R/nm_object.R
 \name{ignore}
 \alias{ignore}
 \title{Get/set ignore statement from ctl_contents}

---FILE: man/init_theta.Rd---
@@ -1,5 +1,5 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R
+% Please edit documentation in R/nm_object.R
 \name{init_theta}
 \alias{init_theta}
 \alias{init_omega}

---FILE: man/input_data.Rd---
@@ -1,5 +1,5 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R
+% Please edit documentation in R/nm_object.R
 \name{input_data}
 \alias{input_data}
 \title{Read input dataset}

---FILE: man/insert_dollar.Rd---
@@ -1,5 +1,5 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R
+% Please edit documentation in R/nm_object.R
 \name{insert_dollar}
 \alias{insert_dollar}
 \title{Insert a new subroutine into ctl_contents}

---FILE: man/ls_tempfiles.Rd---
@@ -1,5 +1,5 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R
+% Please edit documentation in R/nm_object.R
 \name{ls_tempfiles}
 \alias{ls_tempfiles}
 \title{get all temp files}

---FILE: man/make_OCC_every_dose.Rd---
@@ -1,5 +1,5 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R
+% Please edit documentation in R/nm_object.R
 \name{make_OCC_every_dose}
 \alias{make_OCC_every_dose}
 \title{Experiment - make an OCC column for NONMEM in dataset}

---FILE: man/new_nm.Rd---
@@ -1,5 +1,5 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R
+% Please edit documentation in R/nm_object.R
 \name{new_nm}
 \alias{new_nm}
 \title{create a new nm object}

---FILE: man/nm.Rd---
@@ -1,5 +1,5 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R
+% Please edit documentation in R/nm_object.R
 \name{nm}
 \alias{nm}
 \title{Create core NM object}

---FILE: man/nm_diff.Rd---
@@ -1,5 +1,5 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R
+% Please edit documentation in R/nm_object.R
 \name{nm_diff}
 \alias{nm_diff}
 \title{Compute diff between two NONMEM runs}

---FILE: man/nm_list_gather.Rd---
@@ -1,5 +1,5 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R
+% Please edit documentation in R/nm_object.R
 \name{nm_list_gather}
 \alias{nm_list_gather}
 \title{get all nm_list objects}

---FILE: man/nm_row.Rd---
@@ -1,5 +1,5 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R
+% Please edit documentation in R/nm_object.R
 \name{nm_row}
 \alias{nm_row}
 \title{convert nm objects to a rowwise tibble/data.frame}

---FILE: man/nm_tree.Rd---
@@ -1,5 +1,5 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R
+% Please edit documentation in R/nm_object.R
 \name{nm_tree}
 \alias{nm_tree}
 \title{Make data.tree object}

---FILE: man/parent_run.Rd---
@@ -1,5 +1,5 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R
+% Please edit documentation in R/nm_object.R
 \name{parent_run}
 \alias{parent_run}
 \title{get parent object of nm object}

---FILE: man/ppc.Rd---
@@ -1,5 +1,5 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R, R/sim_reestExtra.R
+% Please edit documentation in R/nm_object.R, R/sim_reestExtra.R
 \name{ppc}
 \alias{ppc}
 \alias{ppc_whisker_plot}

---FILE: man/read_derived_data.Rd---
@@ -1,5 +1,5 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R
+% Please edit documentation in R/nm_object.R
 \name{read_derived_data}
 \alias{read_derived_data}
 \title{Read derived data}

---FILE: man/remove_parameter.Rd---
@@ -1,5 +1,5 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R
+% Please edit documentation in R/nm_object.R
 \name{remove_parameter}
 \alias{remove_parameter}
 \title{remove parameter from NONMEM control file}

---FILE: man/rename_parameter.Rd---
@@ -1,5 +1,5 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R
+% Please edit documentation in R/nm_object.R
 \name{rename_parameter}
 \alias{rename_parameter}
 \title{rename a parameter in NONMEM control stream}

---FILE: man/result_file.Rd---
@@ -1,5 +1,5 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R
+% Please edit documentation in R/nm_object.R
 \name{result_file}
 \alias{result_file}
 \title{Name of result file}

---FILE: man/run_dir_path.Rd---
@@ -1,5 +1,5 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R
+% Please edit documentation in R/nm_object.R
 \name{run_dir_path}
 \alias{run_dir_path}
 \title{get path to run_dir}

---FILE: man/show_ctl.Rd---
@@ -1,5 +1,5 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R
+% Please edit documentation in R/nm_object.R
 \name{show_ctl}
 \alias{show_ctl}
 \title{Show an uneditable version of the control file}

---FILE: man/show_out.Rd---
@@ -1,5 +1,5 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R
+% Please edit documentation in R/nm_object.R
 \name{show_out}
 \alias{show_out}
 \title{Show lst file}

---FILE: man/simple_field.Rd---
@@ -1,5 +1,5 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R
+% Please edit documentation in R/nm_object.R
 \name{simple_field}
 \alias{simple_field}
 \title{get/set simple fields of nm objects}

---FILE: man/target.Rd---
@@ -1,5 +1,5 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R
+% Please edit documentation in R/nm_object.R
 \name{target}
 \alias{target}
 \title{Target part of control object for further modification}

---FILE: man/unblock.Rd---
@@ -1,5 +1,5 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R
+% Please edit documentation in R/nm_object.R
 \name{unblock}
 \alias{unblock}
 \title{Remove $OMEGA/$SIGMA BLOCK from init_omega() and init_sigma() output}

---FILE: man/untarget.Rd---
@@ -1,5 +1,5 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R
+% Please edit documentation in R/nm_object.R
 \name{untarget}
 \alias{untarget}
 \title{Remove target on control object}

---FILE: man/update_parameters.Rd---
@@ -1,5 +1,5 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R
+% Please edit documentation in R/nm_object.R
 \name{update_parameters}
 \alias{update_parameters}
 \title{update parameters from a control stream}

---FILE: man/write_derived_data.Rd---
@@ -1,5 +1,5 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R
+% Please edit documentation in R/nm_object.R
 \name{write_derived_data}
 \alias{write_derived_data}
 \title{Write derived data file.}

---FILE: tests/testthat/test-theopp.R---
@@ -32,7 +32,6 @@ test_that(""run and post"",{
   ## run all scripts
   overwrite_behaviour(""skip"")
 
-  browser()
   expect_true(run_all_scripts())
   
   res_files <- dir(""Results"", pattern = ""\\.html"", full.names = TRUE)"
tsahota,NMproject,cd6c1bab369815052bf3231ec4f16eda75f78a0e,tarj sahota,t.sahota0@gmail.com,2021-04-25T19:20:28Z,tarj sahota,t.sahota0@gmail.com,2021-04-25T19:20:28Z,bug fix,R/make_project.R;templates/README.Rmd,True,True,True,False,33,7,40,"---FILE: R/make_project.R---
@@ -36,13 +36,10 @@ nm_create_analysis_project <- function(path, dirs = nm_default_dirs(),
     usethis::proj_set(path)
     on.exit(usethis::proj_set(current_proj))
     
-    #if(requireNamespace(""starters"", quietly = TRUE)){
-    #  usethis::use_template(""README.Rmd"", data = list(Package = name), 
-    #                        package = ""starters"")      
-    #} else {
-      usethis::use_readme_rmd(open = FALSE) 
-    #}
-
+    
+    usethis::use_template(""README.Rmd"", data = list(Package = name),
+                          package = ""NMproject"")
+    
     usethis::use_build_ignore(""README.Rmd"")
     
     ## no badges - skip this part of starters for now

---FILE: templates/README.Rmd---
@@ -0,0 +1,29 @@
+---
+output: github_document
+---
+
+<!-- README.md is generated from README.Rmd. Please edit that file -->
+
+```{r, include = FALSE}
+knitr::opts_chunk$set(
+  collapse = TRUE,
+  comment = ""#>"",
+  fig.path = ""man/figures/README-"",
+  out.width = ""100%""
+)
+```
+# {{{ Package }}}
+
+<!-- badges: start -->
+<!-- badges: end -->
+
+## Objective
+
+The goal of {{{ Package }}} is to ...
+
+## Data sources
+
+The data was obtained from ...
+
+## More information
+"
tsahota,NMproject,424c0c5a086251db2872ae62272c582bc20def6a,tarj sahota,t.sahota0@gmail.com,2021-04-24T22:49:20Z,tarj sahota,t.sahota0@gmail.com,2021-04-24T22:49:20Z,test bug fix,inst/extdata/examples/theopp/Scripts/s02_model_log.Rmd;inst/extdata/theopp.zip;tests/testthat/theopp.zip,True,False,True,False,1,1,2,"---FILE: inst/extdata/examples/theopp/Scripts/s02_model_log.Rmd---
@@ -185,7 +185,7 @@ Make a decision point in the script.  This will enable us to skip past decisions
 In this case we are making a decision that `m1` is better than `m2`, and `m2WT` and we're basing that decision on the `summary_wide` information. We can also include the goodness of fit diagnostics via specifying the file names in the `file_inputs` argument
 
 ```{r}
-decision(inputs = summary_wide(c(m1, m2, m2WT)), 
+decision(inputs = summary_wide(c(m1, m2, m2WT), m = FALSE), 
          outcome = ""m1 is better"") # next line must be end of chunk
 ```
 "
tsahota,NMproject,0c1b9d2c4a055a2df25eeb71fbeddc13d23aadaf,tarj sahota,t.sahota0@gmail.com,2021-04-24T22:21:40Z,tarj sahota,t.sahota0@gmail.com,2021-04-24T22:21:40Z,test fix,R/NMprojectExtra.R;inst/extdata/examples/theopp/Scripts/s02_model_log.Rmd;inst/extdata/theopp.zip;tests/testthat/test-basic.R;tests/testthat/test-theopp.R;tests/testthat/theopp.zip,True,True,True,False,8,7,15,"---FILE: R/NMprojectExtra.R---
@@ -5838,23 +5838,24 @@ decision <- function(inputs = c(),
   call_ob <- match.call()
   decision_cache_path <- file.path(nm_default_dir(""models""), ""decision_cache"")
   dir.create(decision_cache_path, recursive = TRUE, showWarnings = FALSE)
-  cache_name <- digest::digest(call_ob)
-  input_md5 <- digest::digest(list(inputs = inputs))
+  cache_name <- paste0(digest::digest(call_ob), "".RDS"")
+  decision_info <- list(inputs = inputs)
   cache_path <- file.path(decision_cache_path, cache_name)
   
   ############
   ## check cache
   cache_match <- file.exists(cache_path) ## and contents match
   if(cache_match){
-    cache_match <- readLines(cache_path) == input_md5
+    stored_decision <- readRDS(cache_path)
+    cache_match <- identical(stored_decision, decision_info)
   }
   ############
   if(!cache_match){
     decision_accurate <- wait_input(inputs)    
     
     if(decision_accurate){
       ## save cache with a record of the decision
-      write(input_md5, cache_path)
+      saveRDS(decision_info, cache_path)
     } else {
       ## delete cache of inaccurate decisions
       unlink(cache_path, force = TRUE)

---FILE: inst/extdata/examples/theopp/Scripts/s02_model_log.Rmd---
@@ -185,7 +185,8 @@ Make a decision point in the script.  This will enable us to skip past decisions
 In this case we are making a decision that `m1` is better than `m2`, and `m2WT` and we're basing that decision on the `summary_wide` information. We can also include the goodness of fit diagnostics via specifying the file names in the `file_inputs` argument
 
 ```{r}
-decision(inputs = summary_wide(c(m1, m2, m2WT)), outcome = ""m1 is better"")
+decision(inputs = summary_wide(c(m1, m2, m2WT)), 
+         outcome = ""m1 is better"") # next line must be end of chunk
 ```
 
 ```{r boot}

---FILE: tests/testthat/test-basic.R---
@@ -49,7 +49,6 @@ test_that(""set up"",{
   options(nmtran_exe_path=old.opt)
 
   find_nm_install_path()
-  find_nm_tran_path()
   
   d <- code_library(viewer = FALSE, return_info = TRUE)
   expect_true(nrow(d) > 10)

---FILE: tests/testthat/test-theopp.R---
@@ -31,7 +31,7 @@ test_that(""run and post"",{
 
   ## run all scripts
   overwrite_behaviour(""skip"")
-  
+
   expect_true(run_all_scripts())
   
   res_files <- dir(""Results"", pattern = ""\\.html"", full.names = TRUE)"
tsahota,NMproject,a5fdfd051d85ca33a3819799edee2052ba897587,tarj sahota,t.sahota0@gmail.com,2021-04-24T00:40:43Z,tarj sahota,t.sahota0@gmail.com,2021-04-24T00:40:43Z,cleanup. omega_matrix fix,NAMESPACE;R/NMproject.R;R/NMprojectExtra.R;R/ctl_handling.R;R/potential_deletion.R;man/change_to_sim.Rd;man/new_script.Rd;man/theta_r2nm.Rd;tests/testthat/test-theopp.R,False,True,True,False,208,260,468,"---FILE: NAMESPACE---
@@ -181,7 +181,6 @@ export(based_on)
 export(bind_covariate_results)
 export(change_parent)
 export(change_seed)
-export(change_to_sim)
 export(child)
 export(clean_run)
 export(cmd)
@@ -249,7 +248,6 @@ export(make_OCC_every_dose)
 export(make_boot_datasets)
 export(make_xv_datasets)
 export(new_nm)
-export(new_script)
 export(nm)
 export(nm_create_analysis_project)
 export(nm_default_dir)
@@ -332,7 +330,6 @@ export(tail_lst)
 export(target)
 export(test_relations)
 export(theta_nm2r)
-export(theta_r2nm)
 export(tol)
 export(trans)
 export(type)

---FILE: R/NMproject.R---
@@ -495,41 +495,6 @@ update_dollar_data <- function(ctl_name,new_data_name){
   ctl
 }
 
-#' Create new R script
-#' @param name character indicating name of script to create
-#' @param overwrite logical. Whether to overwrite existing file (default = FALSE)
-#' @param open_file logical. Whether function should open script (default = TRUE)
-#' @param libs character. What libraries to add.
-#' @export
-new_script <- function(name, overwrite = FALSE, open_file = TRUE, libs=c(""NMproject"")) {
-  ## create black script with comment fields. Add new_script to git
-  # if (name != basename(name)) 
-  #   stop(""name must not be a path"")
-  if (name == basename(name)) {
-    to_path <- file.path(nm_default_dir(""scripts""), name)  ## destination path
-  } else {
-    to_path <- name
-  }
-  if (file.exists(to_path) & !overwrite) 
-    stop(paste(to_path, ""already exists. Rerun with overwrite = TRUE""))
-  s <- c(paste0(""## "", ""Author: "", Sys.info()[""user""]),
-         paste0(""## "", ""First created: "", Sys.Date()),
-         paste0(""## "", ""Description: ""),
-         paste0(""## "", ""Keywords: ""),
-         """",
-         ""########################################"",
-         ""## load packages and source functions here"",
-         """",
-         paste0(""library("",libs,"")""),
-         """",
-         ""########################################"",
-         ""## main script here"", 
-         """")
-  writeLines(s, to_path)
-  if (open_file) 
-    get(""file.edit"")(to_path)
-}
-
 #' Get Omega matrix from run
 #'
 #' @param r object of class nm
@@ -562,6 +527,8 @@ omega_matrix <- function(r){
   matrix(d_all$FINAL,nrow=max_size)
 }
 
+omega_matrix <- Vectorize(omega_matrix, vectorize.args = list(""r""), SIMPLIFY = FALSE)
+
 #' Get NONMEM version info
 #' 
 #' @return returns list with version info for NONMEM, PsN, perl and

---FILE: R/NMprojectExtra.R---
@@ -3628,97 +3628,7 @@ update_variable_in_text_numbers <- function(m, before_number, after_number){
   m
 }
 
-insert_theta <- function(itheta,
-                         theta_number = NA,
-                         init = 0.1,
-                         name = NA,
-                         lower = NA,
-                         upper = NA,
-                         FIX = FALSE,
-                         unit = NA,
-                         trans = NA){
-  
-  if(missing(theta_number)) theta_number <- max(c(0,stats::na.omit(itheta$theta))) +1
-  
-  insert_line <- max(c(0, itheta$line[itheta$theta %in% (theta_number-1)])) + 1
-  
-  itheta_pre <- itheta[itheta$line < insert_line, ]
-  itheta_post <- itheta[itheta$line >= insert_line, ]
-  itheta_post$line <- itheta_post$line + 1
-  
-  itheta_post$theta[(itheta_post$theta >= theta_number) %in% TRUE] <- 
-    itheta_post$theta[(itheta_post$theta >= theta_number) %in% TRUE] + 1
-  
-  
-  dinsert <- data.frame(theta = theta_number,
-                        init = init, 
-                        name = name,
-                        lower = lower,
-                        upper = upper,
-                        FIX = FIX,
-                        unit = unit,
-                        trans = trans,
-                        line = insert_line,
-                        pos = 1)
-  
-  suppressWarnings(dplyr::bind_rows(itheta_pre, dinsert, itheta_post))
-  
-}
 
-insert_omega <- function(iomega,
-                         omega_number = NA,
-                         init = 0.1,
-                         name = NA,
-                         lower = NA,
-                         upper = NA,
-                         FIX = FALSE,
-                         unit = NA,
-                         trans = NA){
-  
-  #iomega$new_line <- iomega$line
-  #iomega$new_pos <- iomega$pos
-  
-  if(missing(omega_number)) omega_number <- max(c(0,stats::na.omit(iomega$omega1))) +1
-  
-  insert_line <- max(c(0, iomega$line[iomega$omega1 %in% (omega_number-1)])) + 1
-  
-  #iomega_pre <- iomega[iomega$line[iomega$line < insert_line], ]
-  #iomega_post <- iomega[iomega$line[iomega$line >= insert_line], ]
-  iomega_pre <- iomega[iomega$line < insert_line, ]
-  iomega_post <- iomega[iomega$line >= insert_line, ]
-  iomega_post$line <- iomega_post$line + 1
-  
-  iomega_post$omega1[(iomega_post$omega1 >= omega_number) %in% TRUE] <- 
-    iomega_post$omega1[(iomega_post$omega1 >= omega_number) %in% TRUE] + 1
-  
-  iomega_post$omega2[(iomega_post$omega2 >= omega_number) %in% TRUE] <- 
-    iomega_post$omega2[(iomega_post$omega2 >= omega_number) %in% TRUE] + 1
-  
-  iomega_post$block <- iomega_post$block + 1
-  
-  insert_block <- max(c(0, stats::na.omit(iomega$block[iomega$omega1 %in% (omega_number-1)]))) + 1
-  
-  insert_mblock <- max(c(0, stats::na.omit(iomega$mblock[iomega$omega1 %in% (omega_number-1)])))
-  if(length(which(iomega$omega1 %in% (omega_number-1))) > 1)
-    insert_mblock <- insert_mblock + 1
-  
-  dinsert <- data.frame(omega1 = omega_number,
-                        omega2 = omega_number,
-                        init = init, 
-                        name = name,
-                        lower = lower,
-                        upper = upper,
-                        block = insert_block,
-                        mblock = insert_mblock,
-                        FIX = FIX,
-                        unit = unit,
-                        trans = trans,
-                        line = insert_line,
-                        pos = 1)
-  
-  suppressWarnings(dplyr::bind_rows(iomega_pre, dinsert, iomega_post))
-  
-}
 
 block <- function(iomega,
                   eta_numbers = NA,

---FILE: R/ctl_handling.R---
@@ -264,28 +264,6 @@ rem_trailing_spaces <- function(x){
   x
 }
 
-#' Convert R abstraction layer to $THETA
-#' @param x object abstracting $THETA contents
-#' @return character vector with $THETA information
-#' @export
-
-theta_r2nm <- function(x){
-  x0 <- x
-  x0$name[is.na(x0$name)] <- paste0(""THETA"",x0$N[is.na(x0$name)])
-  x0$unit[!is.na(x0$unit)] <- paste("";"",x0$unit[!is.na(x0$unit)])
-  x0$unit[is.na(x0$unit)] <- """"
-  x0$trans[!is.na(x0$trans)] <- paste("";"",x0$trans[!is.na(x0$trans)])
-  x0$trans[is.na(x0$trans)] <- """"
-  x0$COM <- paste(x0$name,x0$unit,x0$trans)
-  x0$COM <- rem_trailing_spaces(x0$COM)
-  x <- by(x,x$N,function(d){
-    if(!is.na(d$lower)) paste0(""("",d$lower,"","",d$init,"")"") else d$init
-  })
-  x <- unlist(x)
-  x <- paste(x,"";"",x0$COM)
-  setup_dollar(x,""$THETA"")
-}
-
 #' Get parameter information
 #'
 #' @param ctl character. Path to control file
@@ -402,62 +380,7 @@ gsub_ctl.default <- function(ctl, pattern, replacement, ..., dollar = NA_charact
   ctl_list(ctl)
 }
 
-append_dollar <- function(ctl_lines, after = NULL, ...){
-  ctl_lines <- ctl_list(ctl_lines)
-  if(is.null(after)) append_after <- length(ctl_lines) else
-    append_after <- max(which(grepl(after,names(ctl_lines))))
-  if(length(after)!=1) stop(""cannot find determine \""after\"""")
-  if(is.na(after)) stop(""cannot find determine \""after\"""")
-  if(after %in% -Inf) stop(""cannot find determine \""after\"""")
-  attributes_ctl_lines <- attributes(ctl_lines)
-  attributes_ctl_lines$names <- NULL
-  ctl_lines <- append(ctl_lines, list(...) ,after = append_after)
-  attributes_ctl_lines$names <- names(ctl_lines)
-  attributes(ctl_lines) <- attributes_ctl_lines
-  ctl_lines
-}
-
-#' change to estimation control stream to sim
-#'
-#' @param ctl_lines character vector. ctl file read into R
-#' @param subpr numeric. Number of subproblems
-#' @param seed numeric
-#' @export
-
-change_to_sim <- function(ctl_lines,subpr=1,seed=1){
-  ctl_lines <- ctl_list(ctl_lines)
-  ctl_lines$EST <- paste0("";"",ctl_lines$EST)
-  ctl_lines$COV <- paste0("";"",ctl_lines$COV)
-  if(""SIM"" %in% names(ctl_lines)){
-    ctl_lines$SIM <- gsub(""^\\s*;+(.*)"",""\\1"",ctl_lines$SIM)
-    ctl_lines$SIM <- gsub(""(SUBPR[^=]*\\s*=\\s*)[0-9]+"",paste0(""\\1"",subpr),ctl_lines$SIM)
-    ctl_lines$SIM <- gsub(""(\\$SIM[^\\s]*\\s*\\()[0-9]+(\\))"",paste0(""\\1"",seed,""\\2""),ctl_lines$SIM)
-  } else {
-    ## insert before $TABLE, after $ERROR/$PRED
-    #pred_error_pos <- which(grepl(""ERROR|PRED"",names(ctl_lines)))
-    #if(length(pred_error_pos) > 1) stop(""multiple $ERROR/$PREDs detected - should only have one or the other?"")
-    #ctl_lines <- append(ctl_lines,list(SIM=NA),pred_error_pos)
-    ctl_lines <- append_dollar(ctl_lines, SIM=NA, ""ERROR|PRED|SIGMA|OMEGA"")
-    ctl_lines$SIM <- paste0(""$SIM ("",seed,"") ONLYSIM SUBPR="",subpr)
-  }
 
-  e <- ctl_lines$ERROR
-  fflag1_pos <- grep(""F_FLAG\\s*=\\s*1"",e)
-  if(length(fflag1_pos) > 0) {
-    message(""attempting to remove F_FLAG code... check this"")
-    y_line <- grep(""^\\s*Y\\s*=.*(EPS|ETA).*$"",e)
-    if_pos <- grep(""^\\s*IF.*\\sTHEN"",e)
-    endif_pos <- grep(""^\\s*ENDIF"",e)
-    if_statements <- lapply(seq_along(if_pos),function(i)if_pos[i]:endif_pos[i])
-
-    y_if_pos <- which(sapply(if_statements,function(i) y_line %in% i))
-
-    if_statements[[y_if_pos]]
-    e[setdiff(if_statements[[y_if_pos]], y_line)] <- paste("";"",e[setdiff(if_statements[[y_if_pos]], y_line)])
-    ctl_lines$ERROR <- e
-  }
-  ctl_list(ctl_lines)
-}
 
 #' Add a covariate to a NONMEM model
 #'

---FILE: R/potential_deletion.R---
@@ -1,5 +1,193 @@
 if(0){
 
+  insert_theta <- function(itheta,
+                           theta_number = NA,
+                           init = 0.1,
+                           name = NA,
+                           lower = NA,
+                           upper = NA,
+                           FIX = FALSE,
+                           unit = NA,
+                           trans = NA){
+    
+    if(missing(theta_number)) theta_number <- max(c(0,stats::na.omit(itheta$theta))) +1
+    
+    insert_line <- max(c(0, itheta$line[itheta$theta %in% (theta_number-1)])) + 1
+    
+    itheta_pre <- itheta[itheta$line < insert_line, ]
+    itheta_post <- itheta[itheta$line >= insert_line, ]
+    itheta_post$line <- itheta_post$line + 1
+    
+    itheta_post$theta[(itheta_post$theta >= theta_number) %in% TRUE] <- 
+      itheta_post$theta[(itheta_post$theta >= theta_number) %in% TRUE] + 1
+    
+    
+    dinsert <- data.frame(theta = theta_number,
+                          init = init, 
+                          name = name,
+                          lower = lower,
+                          upper = upper,
+                          FIX = FIX,
+                          unit = unit,
+                          trans = trans,
+                          line = insert_line,
+                          pos = 1)
+    
+    suppressWarnings(dplyr::bind_rows(itheta_pre, dinsert, itheta_post))
+    
+  }
+  
+  insert_omega <- function(iomega,
+                           omega_number = NA,
+                           init = 0.1,
+                           name = NA,
+                           lower = NA,
+                           upper = NA,
+                           FIX = FALSE,
+                           unit = NA,
+                           trans = NA){
+    
+    #iomega$new_line <- iomega$line
+    #iomega$new_pos <- iomega$pos
+    
+    if(missing(omega_number)) omega_number <- max(c(0,stats::na.omit(iomega$omega1))) +1
+    
+    insert_line <- max(c(0, iomega$line[iomega$omega1 %in% (omega_number-1)])) + 1
+    
+    #iomega_pre <- iomega[iomega$line[iomega$line < insert_line], ]
+    #iomega_post <- iomega[iomega$line[iomega$line >= insert_line], ]
+    iomega_pre <- iomega[iomega$line < insert_line, ]
+    iomega_post <- iomega[iomega$line >= insert_line, ]
+    iomega_post$line <- iomega_post$line + 1
+    
+    iomega_post$omega1[(iomega_post$omega1 >= omega_number) %in% TRUE] <- 
+      iomega_post$omega1[(iomega_post$omega1 >= omega_number) %in% TRUE] + 1
+    
+    iomega_post$omega2[(iomega_post$omega2 >= omega_number) %in% TRUE] <- 
+      iomega_post$omega2[(iomega_post$omega2 >= omega_number) %in% TRUE] + 1
+    
+    iomega_post$block <- iomega_post$block + 1
+    
+    insert_block <- max(c(0, stats::na.omit(iomega$block[iomega$omega1 %in% (omega_number-1)]))) + 1
+    
+    insert_mblock <- max(c(0, stats::na.omit(iomega$mblock[iomega$omega1 %in% (omega_number-1)])))
+    if(length(which(iomega$omega1 %in% (omega_number-1))) > 1)
+      insert_mblock <- insert_mblock + 1
+    
+    dinsert <- data.frame(omega1 = omega_number,
+                          omega2 = omega_number,
+                          init = init, 
+                          name = name,
+                          lower = lower,
+                          upper = upper,
+                          block = insert_block,
+                          mblock = insert_mblock,
+                          FIX = FIX,
+                          unit = unit,
+                          trans = trans,
+                          line = insert_line,
+                          pos = 1)
+    
+    suppressWarnings(dplyr::bind_rows(iomega_pre, dinsert, iomega_post))
+    
+  }
+  
+  append_dollar <- function(ctl_lines, after = NULL, ...){
+    ctl_lines <- ctl_list(ctl_lines)
+    if(is.null(after)) append_after <- length(ctl_lines) else
+      append_after <- max(which(grepl(after,names(ctl_lines))))
+    if(length(after)!=1) stop(""cannot find determine \""after\"""")
+    if(is.na(after)) stop(""cannot find determine \""after\"""")
+    if(after %in% -Inf) stop(""cannot find determine \""after\"""")
+    attributes_ctl_lines <- attributes(ctl_lines)
+    attributes_ctl_lines$names <- NULL
+    ctl_lines <- append(ctl_lines, list(...) ,after = append_after)
+    attributes_ctl_lines$names <- names(ctl_lines)
+    attributes(ctl_lines) <- attributes_ctl_lines
+    ctl_lines
+  }
+  
+  change_to_sim <- function(ctl_lines,subpr=1,seed=1){
+    ctl_lines <- ctl_list(ctl_lines)
+    ctl_lines$EST <- paste0("";"",ctl_lines$EST)
+    ctl_lines$COV <- paste0("";"",ctl_lines$COV)
+    if(""SIM"" %in% names(ctl_lines)){
+      ctl_lines$SIM <- gsub(""^\\s*;+(.*)"",""\\1"",ctl_lines$SIM)
+      ctl_lines$SIM <- gsub(""(SUBPR[^=]*\\s*=\\s*)[0-9]+"",paste0(""\\1"",subpr),ctl_lines$SIM)
+      ctl_lines$SIM <- gsub(""(\\$SIM[^\\s]*\\s*\\()[0-9]+(\\))"",paste0(""\\1"",seed,""\\2""),ctl_lines$SIM)
+    } else {
+      ## insert before $TABLE, after $ERROR/$PRED
+      #pred_error_pos <- which(grepl(""ERROR|PRED"",names(ctl_lines)))
+      #if(length(pred_error_pos) > 1) stop(""multiple $ERROR/$PREDs detected - should only have one or the other?"")
+      #ctl_lines <- append(ctl_lines,list(SIM=NA),pred_error_pos)
+      ctl_lines <- append_dollar(ctl_lines, SIM=NA, ""ERROR|PRED|SIGMA|OMEGA"")
+      ctl_lines$SIM <- paste0(""$SIM ("",seed,"") ONLYSIM SUBPR="",subpr)
+    }
+    
+    e <- ctl_lines$ERROR
+    fflag1_pos <- grep(""F_FLAG\\s*=\\s*1"",e)
+    if(length(fflag1_pos) > 0) {
+      message(""attempting to remove F_FLAG code... check this"")
+      y_line <- grep(""^\\s*Y\\s*=.*(EPS|ETA).*$"",e)
+      if_pos <- grep(""^\\s*IF.*\\sTHEN"",e)
+      endif_pos <- grep(""^\\s*ENDIF"",e)
+      if_statements <- lapply(seq_along(if_pos),function(i)if_pos[i]:endif_pos[i])
+      
+      y_if_pos <- which(sapply(if_statements,function(i) y_line %in% i))
+      
+      if_statements[[y_if_pos]]
+      e[setdiff(if_statements[[y_if_pos]], y_line)] <- paste("";"",e[setdiff(if_statements[[y_if_pos]], y_line)])
+      ctl_lines$ERROR <- e
+    }
+    ctl_list(ctl_lines)
+  }
+  
+  theta_r2nm <- function(x){
+    x0 <- x
+    x0$name[is.na(x0$name)] <- paste0(""THETA"",x0$N[is.na(x0$name)])
+    x0$unit[!is.na(x0$unit)] <- paste("";"",x0$unit[!is.na(x0$unit)])
+    x0$unit[is.na(x0$unit)] <- """"
+    x0$trans[!is.na(x0$trans)] <- paste("";"",x0$trans[!is.na(x0$trans)])
+    x0$trans[is.na(x0$trans)] <- """"
+    x0$COM <- paste(x0$name,x0$unit,x0$trans)
+    x0$COM <- rem_trailing_spaces(x0$COM)
+    x <- by(x,x$N,function(d){
+      if(!is.na(d$lower)) paste0(""("",d$lower,"","",d$init,"")"") else d$init
+    })
+    x <- unlist(x)
+    x <- paste(x,"";"",x0$COM)
+    setup_dollar(x,""$THETA"")
+  }
+  
+  new_script <- function(name, overwrite = FALSE, open_file = TRUE, libs=c(""NMproject"")) {
+    ## create black script with comment fields. Add new_script to git
+    # if (name != basename(name)) 
+    #   stop(""name must not be a path"")
+    if (name == basename(name)) {
+      to_path <- file.path(nm_default_dir(""scripts""), name)  ## destination path
+    } else {
+      to_path <- name
+    }
+    if (file.exists(to_path) & !overwrite) 
+      stop(paste(to_path, ""already exists. Rerun with overwrite = TRUE""))
+    s <- c(paste0(""## "", ""Author: "", Sys.info()[""user""]),
+           paste0(""## "", ""First created: "", Sys.Date()),
+           paste0(""## "", ""Description: ""),
+           paste0(""## "", ""Keywords: ""),
+           """",
+           ""########################################"",
+           ""## load packages and source functions here"",
+           """",
+           paste0(""library("",libs,"")""),
+           """",
+           ""########################################"",
+           ""## main script here"", 
+           """")
+    writeLines(s, to_path)
+    if (open_file) 
+      get(""file.edit"")(to_path)
+  }
+  
   #' @importFrom dplyr mutate
   #' @export
   dplyr::mutate

---FILE: man/change_to_sim.Rd---
@@ -1,18 +0,0 @@
-% Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/ctl_handling.R
-\name{change_to_sim}
-\alias{change_to_sim}
-\title{change to estimation control stream to sim}
-\usage{
-change_to_sim(ctl_lines, subpr = 1, seed = 1)
-}
-\arguments{
-\item{ctl_lines}{character vector. ctl file read into R}
-
-\item{subpr}{numeric. Number of subproblems}
-
-\item{seed}{numeric}
-}
-\description{
-change to estimation control stream to sim
-}

---FILE: man/new_script.Rd---
@@ -1,20 +0,0 @@
-% Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMproject.R
-\name{new_script}
-\alias{new_script}
-\title{Create new R script}
-\usage{
-new_script(name, overwrite = FALSE, open_file = TRUE, libs = c(""NMproject""))
-}
-\arguments{
-\item{name}{character indicating name of script to create}
-
-\item{overwrite}{logical. Whether to overwrite existing file (default = FALSE)}
-
-\item{open_file}{logical. Whether function should open script (default = TRUE)}
-
-\item{libs}{character. What libraries to add.}
-}
-\description{
-Create new R script
-}

---FILE: man/theta_r2nm.Rd---
@@ -1,17 +0,0 @@
-% Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/ctl_handling.R
-\name{theta_r2nm}
-\alias{theta_r2nm}
-\title{Convert R abstraction layer to $THETA}
-\usage{
-theta_r2nm(x)
-}
-\arguments{
-\item{x}{object abstracting $THETA contents}
-}
-\value{
-character vector with $THETA information
-}
-\description{
-Convert R abstraction layer to $THETA
-}

---FILE: tests/testthat/test-theopp.R---
@@ -78,12 +78,30 @@ test_that(""run and post"",{
   
   m1 <- readRDS(""Results/m1.RDS"")
   expect_true(is_successful(m1))
+  
+  om_matrix <- m1 %>% omega_matrix() %>% dplyr::first()
+  expect_true(inherits(om_matrix, ""matrix""))
+  expect_true(nrow(om_matrix) > 0)
+  expect_true(nrow(om_matrix) == ncol(om_matrix))
+  
   d <- output_table_first(m1)
   expect_true(nrow(d) > 0)
   
   d <- d %>% append_nonmem_var(m1, ""K"")
   expect_true(!is.null(d$K))
   
+  
+  m1 <- readRDS(""Results/m1.RDS"")
+  m1 <- m1 %>% insert_dollar(""DES"", ""
+  $DES
+  DADT(1) = ...
+  "",""PK"")
+  expect_true(any(grepl(""\\$DES"", text(m1)[[1]])))
+  
+  m1 <- m1 %>% delete_dollar(""DES"")
+  expect_false(any(grepl(""\\$DES"", text(m1)[[1]])))
+  
+  m1 <- readRDS(""Results/m1.RDS"")
   ## shouldn't be any temp files for m1 in zip
   expect_true(length(ls_tempfiles(m1)) == 0)
   "
tsahota,NMproject,a5d205596f4244de60d7f489be678afe83541936,tarj sahota,t.sahota0@gmail.com,2021-04-21T20:06:36Z,tarj sahota,t.sahota0@gmail.com,2021-04-21T20:06:36Z,doc fix,NAMESPACE;man/run.Rd,False,False,False,False,0,15,15,"---FILE: NAMESPACE---
@@ -304,7 +304,6 @@ export(result_files)
 export(results_dir)
 export(rr)
 export(rr2)
-export(run)
 export(run_all_scripts)
 export(run_dir)
 export(run_dir_path)

---FILE: man/run.Rd---
@@ -1,14 +0,0 @@
-% Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/run_nm.R
-\name{run}
-\alias{run}
-\title{Run NONMEM}
-\usage{
-run(...)
-}
-\arguments{
-\item{...}{objects}
-}
-\description{
-Use run_nm instead. run was deprecated due to naming conflict with future package's run() function
-}"
tsahota,NMproject,dd941ab664ce986ae681931c60a7ada70b068f25,Tarj Sahota,t.sahota0@gmail.com,2021-04-20T20:33:52Z,Tarj Sahota,t.sahota0@gmail.com,2021-04-20T20:33:52Z,bug fix relative_path when two of the same directory are present in path,R/utils.R,False,True,True,False,2,2,4,"---FILE: R/utils.R---
@@ -72,10 +72,10 @@ relative_path <- function(path, relative_path){
   
   last_common_piece <- max(which(mainPieces[1:shorterLength] == refPieces[1:shorterLength]),1)
   
-  dots <- setdiff(refPieces,refPieces[1:last_common_piece])
+  dots <- refPieces[!seq_along(refPieces) %in% 1:last_common_piece]
   dots <- rep("".."", length(dots))
   
-  mainPieces <- setdiff(mainPieces,mainPieces[1:last_common_piece])
+  mainPieces <- mainPieces[!seq_along(mainPieces) %in% 1:last_common_piece]
   
   relativePieces <- c(dots, mainPieces)
   do.call(file.path, as.list(relativePieces))"
tsahota,NMproject,d029c5a11db72380f6398f394076733632cb8c79,tarj sahota,t.sahota0@gmail.com,2021-04-19T17:44:13Z,tarj sahota,t.sahota0@gmail.com,2021-04-19T17:44:13Z,bug fix stage,R/make_project.R,False,True,True,False,1,3,4,"---FILE: R/make_project.R---
@@ -97,15 +97,13 @@ stage <- function(files, destination, additional_sub_dirs = nm_dirs(),
   ##########################
   sub_dirs <- c(""SourceData"",
                 ""DerivedData"",
-                ""localpackage"",
+                ""R"",
                 ""Scripts"",
                 ""Models"",
                 models_dir(),
                 ""Results"",
                 unlist(additional_sub_dirs))
   
-  sub_dirs <- unique(sub_dirs)
-  
   sub_dirs <- basename(sub_dirs)
   
   sub_dirs <- unique(sub_dirs)"
tsahota,NMproject,9609203ecafdd32d01ab5c31d320e04e215e3acc,tarj sahota,t.sahota0@gmail.com,2021-04-17T18:39:21Z,tarj sahota,t.sahota0@gmail.com,2021-04-17T18:39:21Z,added error for test appveyor/travis,tests/testthat/test-theopp.R,False,True,True,False,4,0,4,"---FILE: tests/testthat/test-theopp.R---
@@ -35,6 +35,10 @@ test_that(""run and post"",{
 
   ## run all scripts
   overwrite_behaviour(""skip"")
+  
+  if(!all(c("".Rprofile"", ""OpenProject.Rproj"") %in% dir(all.files = TRUE)))
+    stop(paste(""files missing: "", paste(dir(all.files = TRUE), collapse = "","")))
+  
   expect_true(run_all_scripts())
   
   res_files <- dir(""Results"", pattern = ""\\.html"", full.names = TRUE)"
tsahota,NMproject,e1f66bad9dfc288600f0fe10178469b169f71b7b,tarj sahota,t.sahota0@gmail.com,2021-04-15T18:43:00Z,tarj sahota,t.sahota0@gmail.com,2021-04-15T18:43:00Z,stopped nonmem search functions returning error if no nonmem -return NULL,R/NMproject.R;tests/testthat/test-basic.R,False,True,True,False,9,2,11,"---FILE: R/NMproject.R---
@@ -131,7 +131,9 @@ find_nm_install_path <- function(name = ""default""){
 
   nm_versions <- try(system_nm(""psn -nm_versions"", intern = TRUE, ignore.stderr = TRUE, wait = TRUE),
                      silent = TRUE)
-  if(inherits(nm_versions, ""try-error"")) stop(""can't find nonmem installation"")
+  if(inherits(nm_versions, ""try-error"")) {
+    return(NULL)
+  }
   
   nm_version <- nm_versions[grepl(paste0(""^"", name), nm_versions)]
   
@@ -464,7 +466,10 @@ NONMEM_version <- function(){
   ## scrape version info
   psn_nm_versions <- try(system_nm(""psn -nm_versions"", intern = TRUE, ignore.stderr = TRUE, wait = TRUE),
                      silent = TRUE)
-  if(inherits(psn_nm_versions, ""try-error"")) stop(""can't find nonmem installation"")
+  if(inherits(psn_nm_versions, ""try-error"")) {
+    warning(""can't find nonmem installation"")
+    return(NULL)
+  }
   
   psn_nm_version <- psn_nm_versions[grepl(""default is"", psn_nm_versions)]
   psn_nm_version <- basename(gsub(""^.* (/.*)$"",""\\1"", psn_nm_version))

---FILE: tests/testthat/test-basic.R---
@@ -56,4 +56,6 @@ test_that(""set up"",{
   expect_error(nm_tran(""run1.mod""))
   options(nmtran_exe_path=old.opt)
 
+  find_nm_install_path()
+  
 })"
tsahota,NMproject,92322109fc5f60caca48d28a48c75173dd307410,tarj sahota,t.sahota0@gmail.com,2021-04-12T18:29:16Z,tarj sahota,t.sahota0@gmail.com,2021-04-12T18:29:16Z,doc fix,README.md,False,False,False,False,3,1,4,"---FILE: README.md---
@@ -255,7 +255,9 @@ m1 %>%
 
 Set up dockerized NMTRAN checking with:
 
-`nm_tran_command(""docker run --rm --user=$(id -u):$(id -g) -v $(pwd):/data -w /data humanpredictions/psn /bin/bash -c '/opt/NONMEM/nm_current/tr/NMTRAN.exe < {ctl_name}'"")`
+```R
+nm_tran_command(""docker run --rm --user=$(id -u):$(id -g) -v $(pwd):/data -w /data humanpredictions/psn /bin/bash -c '/opt/NONMEM/nm_current/tr/NMTRAN.exe < {ctl_name}'"")
+```
 
 
 ### + My Rstudio Server is on a different linux server to my NONMEM cluster.  How can I set up NMproject to work with this?"
tsahota,NMproject,25c3c818c7ce0ec8c6c0013992e0b87a082da830,Tarj Sahota,t.sahota0@gmail.com,2021-03-27T13:48:16Z,Tarj Sahota,t.sahota0@gmail.com,2021-03-27T13:48:16Z,windows test fix,DESCRIPTION;tests/testthat/test-theopp.R,False,True,True,False,3,2,5,"---FILE: DESCRIPTION---
@@ -32,12 +32,12 @@ Imports:
     crayon (>= 1.3.4),
     devtools,
     rprojroot,
-    htmltools
+    htmltools,
+    rmarkdown
 RoxygenNote: 7.1.1
 Suggests:
     testthat,
     knitr,
-    rmarkdown,
     ggplot2,
     future,
     data.tree,

---FILE: tests/testthat/test-theopp.R---
@@ -34,6 +34,7 @@ test_that(""run and post"",{
   options(nm.force_render = TRUE)
 
   ## run all scripts
+  overwrite_behaviour(""skip"")
   expect_true(run_all_scripts())
   
   res_files <- dir(""Results"", pattern = ""\\.html"", full.names = TRUE)"
tsahota,NMproject,63b06c784f8566ccf5fe7eb7f5482df2b51c50e8,tarj sahota,t.sahota0@gmail.com,2021-03-25T18:06:29Z,tarj sahota,t.sahota0@gmail.com,2021-03-25T18:06:29Z,"bug fix if psn doesn't exist, package can still load",DESCRIPTION;R/NMproject.R;man/reexports.Rd,False,True,True,False,16,4,20,"---FILE: DESCRIPTION---
@@ -33,7 +33,7 @@ Imports:
     devtools,
     rprojroot,
     htmltools
-RoxygenNote: 7.1.0
+RoxygenNote: 7.1.1
 Suggests:
     testthat,
     knitr,

---FILE: R/NMproject.R---
@@ -129,7 +129,9 @@ sge_parallel_execute <- ""execute -run_on_sge -parafile={parafile} -sge_prepend_f
 #' @export
 find_nm_install_path <- function(name = ""default""){
 
-  nm_versions <- system_nm(""psn -nm_versions"", intern = TRUE)
+  nm_versions <- try(system_nm(""psn -nm_versions"", intern = TRUE),
+                     silent = TRUE)
+  if(inherits(nm_versions, ""try-error"")) stop(""can't find nonmem installation"")
   
   nm_version <- nm_versions[grepl(paste0(""^"", name), nm_versions)]
   
@@ -146,7 +148,17 @@ find_nm_install_path <- function(name = ""default""){
 
 find_nm_tran_path <- function(name = ""default""){
 
-  nm_versions <- system_nm(""psn -nm_versions"", intern = TRUE)
+  nm_versions <- try(system_nm(""psn -nm_versions"", intern = TRUE), 
+                     silent = TRUE)
+  if(inherits(nm_versions, ""try-error"")) {
+    message(""Could not determine path to nmtran from psn -nm_versions."")
+    message(""To set manually add the following command:"")
+    message(""  options(nmtran_exe_path=\""path/to/nmtran\"")"")
+    message(""     1. (for this session only) in the console"")
+    message(""     2. (for this user) to ~/.Rprofile"")
+    message(paste0(""     3. (for all users) to "",file.path(R.home(component = ""home""), ""etc"", ""Rprofile.site"")))
+    return(NULL)
+  }
   
   nm_version <- nm_versions[grepl(paste0(""^"", name), nm_versions)]
   

---FILE: man/reexports.Rd---
@@ -18,6 +18,6 @@ below to see their documentation.
 \describe{
   \item{dplyr}{\code{\link[dplyr]{filter}}, \code{\link[dplyr]{mutate}}}
 
-  \item{stats}{\code{\link[stats]{AIC}}, \code{\link[stats]{BIC}}, \code{\link[stats]{coef}}, \code{\link[stats]{nobs}}}
+  \item{stats}{\code{\link[stats]{AIC}}, \code{\link[stats:AIC]{BIC}}, \code{\link[stats]{coef}}, \code{\link[stats]{nobs}}}
 }}
 "
tsahota,NMproject,ace789e0d11c57685ce953a2d7d5c22a6199a423,tarj sahota,t.sahota0@gmail.com,2021-03-23T16:17:24Z,tarj sahota,t.sahota0@gmail.com,2021-03-23T16:17:24Z,bug fix can't use .data in mutate_cond. removed warnings in raw_init_theta,R/NMprojectExtra.R,False,True,True,False,25,22,47,"---FILE: R/NMprojectExtra.R---
@@ -2862,26 +2862,29 @@ raw_init_theta <- function(m, replace){
     d$FIX <- grepl(""FIX"", d$value)
     d$value <- gsub(""FIX"", """", d$value)
     
-    d$init[d$format %in% ""single_number""] <- 
-      as.numeric(grep(single_number_regex,
-                      d$value[d$format %in% ""single_number""], value = TRUE))
-    
-    d$lower[d$format %in% ""lower_init""] <- 
-      as.numeric(gsub(lower_init_regex,""\\1"",d$value[d$format %in% ""lower_init""]))
-    d$init[d$format %in% ""lower_init""] <- 
-      as.numeric(gsub(lower_init_regex,""\\2"",d$value[d$format %in% ""lower_init""]))
-    
-    d$lower[d$format %in% ""lower_init_upper""] <- 
-      as.numeric(gsub(lower_init_upper_regex,""\\1"",d$value[d$format %in% ""lower_init_upper""]))
-    d$init[d$format %in% ""lower_init_upper""] <- 
-      as.numeric(gsub(lower_init_upper_regex,""\\2"",d$value[d$format %in% ""lower_init_upper""]))
-    d$upper[d$format %in% ""lower_init_upper""] <- 
-      as.numeric(gsub(lower_init_upper_regex,""\\3"",d$value[d$format %in% ""lower_init_upper""]))
-    
-    d$lower[d$format %in% ""lower_upper""] <- 
-      as.numeric(gsub(lower_upper_regex,""\\1"",d$value[d$format %in% ""lower_upper""]))
-    d$upper[d$format %in% ""lower_upper""] <- 
-      as.numeric(gsub(lower_upper_regex,""\\2"",d$value[d$format %in% ""lower_upper""]))
+    suppressWarnings({ ## ignore as.numeric(""..."") warnings
+      d$init[d$format %in% ""single_number""] <- 
+        as.numeric(grep(single_number_regex,
+                        d$value[d$format %in% ""single_number""], value = TRUE))
+      
+      d$lower[d$format %in% ""lower_init""] <- 
+        as.numeric(gsub(lower_init_regex,""\\1"",d$value[d$format %in% ""lower_init""]))
+      d$init[d$format %in% ""lower_init""] <- 
+        as.numeric(gsub(lower_init_regex,""\\2"",d$value[d$format %in% ""lower_init""]))
+      
+      d$lower[d$format %in% ""lower_init_upper""] <- 
+        as.numeric(gsub(lower_init_upper_regex,""\\1"",d$value[d$format %in% ""lower_init_upper""]))
+      d$init[d$format %in% ""lower_init_upper""] <- 
+        as.numeric(gsub(lower_init_upper_regex,""\\2"",d$value[d$format %in% ""lower_init_upper""]))
+      d$upper[d$format %in% ""lower_init_upper""] <- 
+        as.numeric(gsub(lower_init_upper_regex,""\\3"",d$value[d$format %in% ""lower_init_upper""]))
+      
+      d$lower[d$format %in% ""lower_upper""] <- 
+        as.numeric(gsub(lower_upper_regex,""\\1"",d$value[d$format %in% ""lower_upper""]))
+      d$upper[d$format %in% ""lower_upper""] <- 
+        as.numeric(gsub(lower_upper_regex,""\\2"",d$value[d$format %in% ""lower_upper""]))      
+    })
+
     
     d$format <- NULL
     
@@ -3532,7 +3535,7 @@ init_omega.nm_generic <- function(m, replace, ...){
   if(missing(replace)){  ## get
     if(length(mutate_args) > 0){
       current_init <- init_omega(m)
-      replace <- current_init %>% mutate_cond(!is.na(.data$name), !!!mutate_args)
+      replace <- current_init %>% mutate_cond(!is.na(current_init$name), !!!mutate_args)
       replace <- replace %>% dplyr::mutate_if(is.numeric, ~signif(., 5))
     } else {
       d$value <- NULL
@@ -3587,7 +3590,7 @@ init_sigma.nm_generic <- function(m, replace, ...){
   if(missing(replace)){  ## get
     if(length(mutate_args) > 0){
       current_init <- init_sigma(m)
-      replace <- current_init %>% mutate_cond(!is.na(.data$name), !!!mutate_args)
+      replace <- current_init %>% mutate_cond(!is.na(current_init$name), !!!mutate_args)
       replace <- replace %>% dplyr::mutate_if(is.numeric, ~signif(., 5))
     } else {
       d$value <- NULL"
tsahota,NMproject,7a3599db1fbd641a323b06842684875dd638fe6d,tarj sahota,t.sahota0@gmail.com,2021-03-23T16:04:49Z,tarj sahota,t.sahota0@gmail.com,2021-03-23T16:04:49Z,bug fix git apply was messing up eof,R/manual_edit.R,False,True,True,False,2,2,4,"---FILE: R/manual_edit.R---
@@ -149,8 +149,8 @@ apply_manual_edit.nm_generic <- function(m, patch_name){
   patch_path_tmp <- paste0(patch_path, "".tmp"")
   writeLines(patch_text, patch_path_tmp)
   
-  patch_cmd <- paste(""git apply"", patch_path_tmp, ""-C1 --inaccurate-eof"")
-
+  patch_cmd <- paste(""git apply"", patch_path_tmp, ""-C1"")
+  
   if(!git_cmd_available) stop(""need git available from system() for this to work"")  
   res <- system(patch_cmd, intern = TRUE)  ## win = no need to use system_nm, no file sync issues
 "
tsahota,NMproject,df9681e95cedb8d572850b5fda7dd24ff68e48d6,tarj sahota,t.sahota0@gmail.com,2021-03-09T01:38:33Z,tarj sahota,t.sahota0@gmail.com,2021-03-09T01:38:33Z,fix cran checks,DESCRIPTION;R/NMprojectExtra.R;R/plot_iter.R,False,True,True,False,7,8,15,"---FILE: DESCRIPTION---
@@ -9,7 +9,9 @@ Description: A light interface between R and NONMEM for script based model devel
 License: GPL-3 | file LICENSE
 Encoding: UTF-8
 LazyData: true
-Remotes: tsahota/tidyproject@newinterface
+Remotes: 
+    tsahota/tidyproject@newinterface,
+    gluc/data.tree
 Imports:
     tidyproject (>= 0.5.0),
     shiny,
@@ -28,8 +30,6 @@ Imports:
     miniUI (>= 0.1.1),
     rstudioapi (>= 0.7),
     crayon (>= 1.3.4),
-    drake (>= 5.3.0),
-    rsample,
     devtools,
     rprojroot,
     htmltools
@@ -44,7 +44,9 @@ Suggests:
     xpose,
     lubridate,
     pmxTools,
-    Hmisc
+    Hmisc,
+    drake (>= 5.3.0),
+    rsample,
 Collate: 
     'NMproject.R'
     'nm.R'

---FILE: R/NMprojectExtra.R---
@@ -1352,7 +1352,6 @@ result_file <- function(m, name){
 #' @export
 result_file.nm_generic <- function(m, name){
   name <- glue_text_nm(m, name)
-  #name <- stringr::str_glue(name, .envir = m)
   file.path(results_dir(m), name)
 }
 #' @export

---FILE: R/plot_iter.R---
@@ -99,9 +99,8 @@ plot_iter <- function(r,trans=TRUE,skip=0,yvar=""OBJ""){
 #' @param trans logical. should parameter transformations be performed
 #' @export
 plot_iter_dygraph <- function(m, trans = TRUE){
-  requireNamespace(""dygraphs"")
+  if(!requireNamespace(""dygraphs"")) stop(""install dygraphs"")
   psn_ext_path <- m %>% nm_output_path(""ext"")
-  #if(is.null(m$output$psn.ext)) return(dygraphs::dygraph(data.frame(x=0,y=0)))
   if(!file.exists(psn_ext_path)) return(dygraphs::dygraph(data.frame(x=0,y=0)))
   d <- try(plot_iter_data(m,trans = trans, skip = 0),silent=TRUE)
   if(inherits(d,""try-error"")) return(dygraphs::dygraph(data.frame(x=0,y=0)))
@@ -114,7 +113,6 @@ plot_iter_dygraph <- function(m, trans = TRUE){
       dygraphs::dyRangeSelector()
   }
   #htmltools::browsable(htmltools::tagList(p))
-  
   #get_plot_bootstrapjs_div(p)
   htmltools::browsable(get_plot_bootstrapjs_div(p))
 }"
tsahota,NMproject,4640696836150ea4c542cc0679570329e65fb9c4,tarj sahota,t.sahota0@gmail.com,2021-03-08T20:22:07Z,tarj sahota,t.sahota0@gmail.com,2021-03-08T20:22:07Z,doc fixes,NAMESPACE;R/NMprojectExtra.R;R/manual_edit.R;R/nm.R;R/nm_gettersetters.R;R/potential_deletion.R;R/read_ext.R;man/nm_getsetters.Rd;man/rename_parameter.Rd;man/status_table.Rd,False,True,True,False,108,57,165,"---FILE: NAMESPACE---
@@ -116,14 +116,11 @@ S3method(print,nm_list)
 S3method(print,nm_subroutine)
 S3method(remove_cov,nm_generic)
 S3method(remove_cov,nm_list)
-S3method(rename_parameter_,nm_generic)
-S3method(rename_parameter_,nm_list)
 S3method(result_file,nm_generic)
 S3method(result_file,nm_list)
 S3method(result_files,nm_generic)
 S3method(result_files,nm_list)
 S3method(rr,nm_list)
-S3method(run_dir,nm)
 S3method(run_dir,nm_generic)
 S3method(run_dir,nm_list)
 S3method(run_id,nm_generic)
@@ -249,7 +246,6 @@ export(make_OCC_every_dose)
 export(make_boot_datasets)
 export(make_xv_datasets)
 export(manual_edit)
-export(manual_patch)
 export(mutate)
 export(n_thetas)
 export(new_function_template)
@@ -305,7 +301,6 @@ export(read_derived_data)
 export(remove_cov)
 export(remove_parameter)
 export(rename_parameter)
-export(rename_parameter_)
 export(result_file)
 export(result_files)
 export(results_dir)

---FILE: R/NMprojectExtra.R---
@@ -1001,7 +1001,6 @@ coef.nm_generic <- function(object,trans=TRUE,...){
   }
   
   ext_file_path <- object %>% nm_output_path(""ext"")
-  #ext_file_path <- file.path(run_dir(object, full_path = TRUE), ""NM_run1"",""psn.ext"")
   
   d <- coef_ext0(ext_file_path)
   if(nrow(d) == 0) {
@@ -1405,7 +1404,7 @@ status.nm_generic <- function(x, simple = TRUE){
     contents[file.info(contents)$isdir]
   }
   
-  execution_dirs <- get_sub_dirs(run_dir(m, full_path = TRUE))
+  execution_dirs <- get_sub_dirs(run_dir_path(m))
   
   ##############################
   ## for bootstraps, etc. go to modelfit_dir1
@@ -1451,6 +1450,10 @@ status.nm_generic <- function(x, simple = TRUE){
 #' @export
 status.nm_list <- Vectorize_nm_list(status.nm_generic)
 
+#' get status of multiple runs in form of table
+#' 
+#' @param m nm objects
+#' 
 #' @export
 status_table <- function(m){
   tab <- m %>% status %>% 
@@ -2574,12 +2577,11 @@ _NEWPARAM_ = EXP(MU__MU_PARAM_+ETA(_MU_PARAM_))
   m %>% target(old_target)
 }
 
-#' @export
+
 rename_parameter_ <- function(m, new_name, name){
   UseMethod(""rename_parameter_"")
 }
 
-#' @export
 rename_parameter_.nm_generic <- function(m, new_name, name){
   
   ## comment out ""new_param ="" rows
@@ -2605,9 +2607,20 @@ rename_parameter_.nm_generic <- function(m, new_name, name){
   
 }
 
-#' @export
 rename_parameter_.nm_list <- Vectorize_nm_list(rename_parameter_.nm_generic, SIMPLIFY = FALSE)
 
+#' rename a parameter in NONMEM control stream
+#' 
+#' @param m nm object
+#' @param ... renaming arguments
+#' 
+#' @examples 
+#' \dontrun{
+#' 
+#' m1 %>% rename_parameter(CL = KE)
+#' ## renames KE to CL
+#' 
+#' }
 #' @export
 rename_parameter <- function(m, ...){
   rename_list <- list(...)
@@ -6067,7 +6080,7 @@ job_stats <- function(m){
     starttime = lubridate::ymd_hms(.data$starttime),
     stoptime = lubridate::ymd_hms(.data$stoptime),
     Rtime = difftime(.data$stoptime, .data$starttime, units = ""mins""), 
-    launchtime = m %>% run_dir(full_path = TRUE) %>% file.path(""command.txt"") %>% m_time_f(),
+    launchtime = m %>% run_dir_path() %>% file.path(""command.txt"") %>% m_time_f(),
     Qtime = difftime(.data$starttime, .data$launchtime, units = ""mins""),
     Ttime = difftime(.data$stoptime, .data$launchtime, units = ""mins"")
   )

---FILE: R/manual_edit.R---
@@ -47,33 +47,6 @@ stop_manual_edit <- function(m){
   invisible(m)
 }
 
-#' @export
-manual_patch <- function(m){
-  
-  res <- start_manual_edit_unix(m)
-  
-  message(
-    ""---Manual edit---
-    Instructions:
-    1) edit control file
-    2) save & close
-    Press ENTER when done..."")
-  readline()
-  
-  ## now diff ctl_path(m) and old_file_path
-  
-  diff_manual_edit(m, res)
-  
-  message(""patch created:\n "", res$patch_path, ""\n"")
-  
-  message(""copy-paste the following into your script to apply:\n
-  [nm_object] %>%
-  apply_manual_edit(\"""", res$patch_name,""\"")
-
-(dont forget to comment your code)"")
-  
-}
-
 #' @export
 start_manual_edit_unix <- function(m, combine_patch = NA_character_){
   # if(.Platform$OS.type != ""unix"") 

---FILE: R/nm.R---
@@ -315,7 +315,7 @@ output_table <- function(r, ...){
 
 #' @export
 output_table.default <- function(r, ...){
-  out_path <- file.path(run_dir(r, full_path = TRUE), ""NMout.RDS"")
+  out_path <- file.path(run_dir_path(r), ""NMout.RDS"")
   if(!file.exists(out_path)) {
     do <- nm_output(r, ...)
     saveRDS(do, file = out_path)

---FILE: R/nm_gettersetters.R---
@@ -38,23 +38,6 @@ ctl_path <- function(m, text) {
   }
 }
 
-#' @export
-run_dir <- function(m, text, full_path = FALSE) {
-  UseMethod(""run_dir"")
-}
-#' @export
-run_dir.nm <- function(m, text, full_path = FALSE) m$run_dir
-#' @export
-run_dir.nm_generic <- function(m, text, full_path = FALSE) {
-  if(missing(text)) {
-    if(!full_path) custom_1d_field(m, ""run_dir"") else
-      file.path(run_in(m), custom_1d_field(m, ""run_dir""))
-  } else custom_1d_field(m, ""run_dir"", text, glue = TRUE)
-}
-#' @export
-run_dir.nm_list <- run_dir.nm_generic
-#run_dir.nm_list <- Vectorize_nm_list(run_dir.nm_generic, SIMPLIFY = TRUE)
-
 #' @name nm_getsetters
 #' @rdname nm_getsetters
 #'
@@ -64,6 +47,7 @@ run_dir.nm_list <- run_dir.nm_generic
 #' @param text optional character for replacing field. If present function will
 #'   modify field (of same name as function) otherwise will return value of
 #'   field (of same name as function)
+#' @param full_path logical (default = FALSE) used in run_dir()
 #'
 #' @details Easiest way to see all fields of an object is to type the object
 #'   into the console and hit enter. This will display the value of each field.
@@ -72,6 +56,23 @@ run_dir.nm_list <- run_dir.nm_generic
 
 NULL
 
+#' @rdname nm_getsetters
+#' @export
+run_dir <- function(m, text) {
+  UseMethod(""run_dir"")
+}
+
+#' @export
+run_dir.nm_generic <- function(m, text) {
+  if(missing(text)) {
+    custom_1d_field(m, ""run_dir"")
+  } else custom_1d_field(m, ""run_dir"", text, glue = TRUE)
+}
+#' @export
+run_dir.nm_list <- run_dir.nm_generic
+
+
+
 #' @rdname nm_getsetters
 #' @examples 
 #' \dontrun{

---FILE: R/potential_deletion.R---
@@ -114,3 +114,29 @@ in_cache.nm_generic <- function(r,
 }
 
 in_cache.nm_list <- Vectorize_nm_list(in_cache.nm_generic)
+
+manual_patch <- function(m){
+  
+  res <- start_manual_edit_unix(m)
+  
+  message(
+    ""---Manual edit---
+    Instructions:
+    1) edit control file
+    2) save & close
+    Press ENTER when done..."")
+  readline()
+  
+  ## now diff ctl_path(m) and old_file_path
+  
+  diff_manual_edit(m, res)
+  
+  message(""patch created:\n "", res$patch_path, ""\n"")
+  
+  message(""copy-paste the following into your script to apply:\n
+  [nm_object] %>%
+  apply_manual_edit(\"""", res$patch_name,""\"")
+
+(dont forget to comment your code)"")
+  
+}

---FILE: R/read_ext.R---
@@ -44,7 +44,7 @@ read_ext <- function(r,trans=FALSE){
 
 read_ext.default <- function(r,trans=FALSE){
   
-  base_nm_run_path <- file.path(run_dir(r, full_path = TRUE), ""NM_run1"")
+  base_nm_run_path <- file.path(run_dir_path(r), ""NM_run1"")
   
   #d <- read_ext0(r$output$psn.ext)
   d <- read_ext0(file.path(base_nm_run_path, ""psn.ext""))

---FILE: man/nm_getsetters.Rd---
@@ -2,6 +2,7 @@
 % Please edit documentation in R/nm_gettersetters.R
 \name{nm_getsetters}
 \alias{nm_getsetters}
+\alias{run_dir}
 \alias{cmd}
 \alias{type}
 \alias{parent_run_id}
@@ -20,6 +21,8 @@
 \alias{result_files}
 \title{functions to access and modify fields of nm objects}
 \usage{
+run_dir(m, text)
+
 cmd(m, text)
 
 type(m, text)
@@ -58,6 +61,8 @@ result_files(m, text)
 \item{text}{optional character for replacing field. If present function will
 modify field (of same name as function) otherwise will return value of
 field (of same name as function)}
+
+\item{full_path}{logical (default = FALSE) used in run_dir()}
 }
 \description{
 functions to access and modify fields of nm objects

---FILE: man/rename_parameter.Rd---
@@ -0,0 +1,24 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/NMprojectExtra.R
+\name{rename_parameter}
+\alias{rename_parameter}
+\title{rename a parameter in NONMEM control stream}
+\usage{
+rename_parameter(m, ...)
+}
+\arguments{
+\item{m}{nm object}
+
+\item{...}{renaming arguments}
+}
+\description{
+rename a parameter in NONMEM control stream
+}
+\examples{
+\dontrun{
+
+m1 \%>\% rename_parameter(CL = KE)
+## renames KE to CL
+
+}
+}

---FILE: man/status_table.Rd---
@@ -0,0 +1,14 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/NMprojectExtra.R
+\name{status_table}
+\alias{status_table}
+\title{get status of multiple runs in form of table}
+\usage{
+status_table(m)
+}
+\arguments{
+\item{m}{nm objects}
+}
+\description{
+get status of multiple runs in form of table
+}"
tsahota,NMproject,017fccd62945760a0cea7f96c82b70f10894d59b,tarj sahota,t.sahota0@gmail.com,2021-03-08T18:49:27Z,tarj sahota,t.sahota0@gmail.com,2021-03-08T18:49:27Z,doc fixes,NAMESPACE;R/NMproject.R;R/NMprojectExtra.R;R/ctl_handling.R;R/manual_edit.R;R/nm.R;R/nm_gettersetters.R;R/sim_reestExtra.R;R/utilsExtra.R;man/as_nm_list.Rd;man/cov_cov_plot.Rd;man/find_nm_install_path.Rd;man/find_result_files.Rd;man/gsub_ctl.Rd;man/is_nm_generic.Rd;man/is_nm_list.Rd;man/is_successful.Rd;man/job_stats.Rd;man/nm.Rd;man/nm_getsetters.Rd;man/nm_list_render.Rd;man/ppc.Rd;man/run_id.Rd;man/wait_finish.Rd;man/write.csv.nm.Rd,False,True,True,False,216,101,317,"---FILE: NAMESPACE---
@@ -20,10 +20,6 @@ S3method(as_nm_list,nm_generic)
 S3method(as_nm_list,nm_list)
 S3method(c,nm_generic)
 S3method(c,nm_list)
-S3method(cache_history,nm_generic)
-S3method(cache_history,nm_list)
-S3method(cached_object,nm_generic)
-S3method(cached_object,nm_list)
 S3method(change_parent,nm_generic)
 S3method(change_parent,nm_list)
 S3method(child,nm_generic)
@@ -44,8 +40,6 @@ S3method(ctl_list,character)
 S3method(ctl_list,ctl_character)
 S3method(ctl_list,ctl_list)
 S3method(ctl_list,nmexecute)
-S3method(ctl_table_paths,nm_generic)
-S3method(ctl_table_paths,nm_list)
 S3method(data_name,default)
 S3method(data_path,nm_generic)
 S3method(data_path,nm_list)
@@ -189,8 +183,6 @@ export(as_nm_generic)
 export(as_nm_list)
 export(based_on)
 export(bind_covariate_results)
-export(cache_history)
-export(cached_object)
 export(change_parent)
 export(change_seed)
 export(change_to_sim)
@@ -218,20 +210,17 @@ export(ctl_name)
 export(ctl_nm2r)
 export(ctl_path)
 export(ctl_r2nm)
-export(ctl_table_paths)
 export(data_filter_char)
 export(data_ignore_char)
 export(data_name)
 export(data_path)
 export(decision)
 export(delete_dollar)
-export(diff_manual_edit)
 export(dollar)
 export(environment_info)
 export(exclude_rows)
 export(executed)
 export(file_name)
-export(fill_dollar_data)
 export(fill_input)
 export(filter)
 export(find_nm_install_path)
@@ -254,7 +243,6 @@ export(job_info)
 export(job_stats)
 export(kill_job)
 export(load_sse)
-export(ls_output)
 export(ls_tempfiles)
 export(lst_path)
 export(make_OCC_every_dose)
@@ -331,7 +319,6 @@ export(run_id)
 export(run_in)
 export(run_nm)
 export(run_nm_batch)
-export(set_simple_field)
 export(setup_nm_demo)
 export(sge_parallel_execute)
 export(shiny_nm)
@@ -366,7 +353,6 @@ export(view_patch)
 export(wait_default)
 export(wait_finish)
 export(wipe_run)
-export(write.csv.nm)
 export(write_ctl)
 export(write_derived_data)
 importFrom(dplyr,filter)

---FILE: R/NMproject.R---
@@ -116,6 +116,11 @@ set_nm_opts <- function(){
 #' @export
 sge_parallel_execute <- ""execute -run_on_sge -parafile={parafile} -sge_prepend_flags='-pe orte {cores} -V' {ctl_name} -dir={run_dir} -nodes={cores}""
 
+
+#' Find location of NONMEM
+#' 
+#' @param name character name of nonmem installation (according PsN)
+#' 
 #' @export
 find_nm_install_path <- function(name = ""default""){
 
@@ -258,16 +263,6 @@ new_jobs <- function(txt = c(""ask"", ""overwrite"", ""stop new"", ""skip"")){
   overwrite_behaviour(match.arg(txt))
 }
 
-#' Get run id
-#'
-#' @param m character or nm or ctl_list/ctl_character
-#' @param text optional character to set run_id 
-#' @param ... additional arguments
-#' @export
-run_id <- function(m, text, ...)
-  UseMethod(""run_id"")
-
-
 #' path of directory from models dir
 #'
 #' @param x character vector. Relative path from models.dir

---FILE: R/NMprojectExtra.R---
@@ -79,7 +79,6 @@ To use the alpha interface, install NMproject 0.3.2"",
 #' @param results_dir character (default = ""Results"").
 #'    Directory to store results of this run
 #' @param lst_path character (default = ""{run_dir}/NM_run1/psn.lst"") expected location of lst file
-#' @param data_path character (default = NA) expected location of dataset file
 #' 
 #' @return An object of class nm_list.  Object is concatenatable.
 #'    Length of object corresponds to length of run_id
@@ -409,11 +408,6 @@ custom_1d_field.nm_generic <- function(m, field, replace, glue = FALSE){
 }
 custom_1d_field.nm_list <- Vectorize_nm_list(custom_1d_field.nm_generic, replace_arg = ""replace"")
 
-#' @export
-set_simple_field <- function(m, ...){
-  UseMethod(""set_simple_field"")  
-}
-
 set_simple_field <- function(m, ...){
 
   dots <- list(...)
@@ -804,7 +798,6 @@ data_path.nm_generic <- function(m, text){
 #' @export
 data_path.nm_list <- Vectorize_nm_list(data_path.nm_generic)
 
-#' @export
 fill_dollar_data <- function(m, data_name){
   old_target <- m %>% target()
   m <- m %>% target(""$DATA"")
@@ -1378,15 +1371,15 @@ nm_tran.nm_generic <- function(x){
 #' @export
 nm_tran.nm_list <- Vectorize_nm_list(nm_tran.nm_generic, SIMPLIFY = FALSE, invisible = TRUE)
 
-#' @export
+
 cache_history <- function(r){
   UseMethod(""cache_history"")
 }
-#' @export
+
 cache_history.nm_generic <- function(r){
   lapply(run_cache_paths(r), readRDS)
 }
-#' @export
+
 cache_history.nm_list <- Vectorize_nm_list(cache_history.nm_generic, SIMPLIFY = FALSE)
 
 cache_current <- function(m) run_checksums(m)
@@ -1800,8 +1793,12 @@ is_finished.nm_generic <- function(r, initial_timeout=NA){
 #' @export
 is_finished.nm_list <- Vectorize_nm_list(is_finished.nm_generic)
 
+#' test if NONMEM ran without errors
+#' 
+#' @param r nm object
+#' 
 #' @export
-is_successful <- function(r, initial_timeout=NA, na = FALSE) {
+is_successful <- function(r) {
   res <- all(status(r) %in% ""finished"")
   res[is.na(res)] <- FALSE
   res
@@ -1815,11 +1812,11 @@ is_successful <- function(r, initial_timeout=NA, na = FALSE) {
 #' @param r nm object
 #' @param timeout numeric seconds to wait before timeout
 #' @export
-wait_finish <- function(r, timeout=NA, force = FALSE){
+wait_finish <- function(r, timeout=NA){
   UseMethod(""wait_finish"")
 }
 #' @export
-wait_finish.nm_list <- function(r, timeout=NA, force = FALSE){
+wait_finish.nm_list <- function(r, timeout=NA){
   r_orig <- r
   r <- r[!is_finished(r)]
   #r <- r[]
@@ -1833,8 +1830,8 @@ wait_finish.nm_list <- function(r, timeout=NA, force = FALSE){
 }
 
 #' @export
-wait_finish.nm_generic <- function(r, timeout=NA, force = FALSE){
-  wait_finish.nm_list(as_nm_list(r), timeout = timeout, force = force)
+wait_finish.nm_generic <- function(r, timeout=NA){
+  wait_finish.nm_list(as_nm_list(r), timeout = timeout)
 }
 
 # wait_finish.nm_list <- function(r, timeout=NA, force = FALSE){
@@ -3370,7 +3367,6 @@ nm_output_path.nm_list <- Vectorize_nm_list(nm_output_path.nm_generic, SIMPLIFY
 #' @export
 output_location <- function(m) file.path(run_in(m), dirname(lst_path(m)))
 
-#' @export
 ls_output <- function(m, pattern = ""."", recursive = TRUE) {
   output <- dir(output_location(m), recursive = recursive, full.names = TRUE, pattern = pattern)
   return(normalizePath(output, winslash = ""/""))
@@ -3942,17 +3938,16 @@ new_function_template <- function(function_name, overwrite = FALSE, open_file =
 }
 
 
-#' @export
 ctl_table_paths <- function(ctl) {
   UseMethod(""ctl_table_paths"")
 }
-#' @export
+
 ctl_table_paths.nm_generic <- function(ctl) {
   ## path should go from base directory
   ## in psn directory
   file.path(output_location(ctl), ctl_table_files(ctl_contents(ctl)))
 }
-#' @export
+
 ctl_table_paths.nm_list <- Vectorize_nm_list(ctl_table_paths.nm_generic, SIMPLIFY = FALSE)
 
 
@@ -4073,17 +4068,16 @@ run_cache_paths <- function(m){
   
 }
 
-#' @export
 cached_object <- function(m){
   UseMethod(""cached_object"")
 }
-#' @export
+
 cached_object.nm_generic <- function(m){
   path <- unique_run_cache_path(m)
   if(!file.exists(path)) return(nm(NA))
   readRDS(path)$object
 }
-#' @export
+
 cached_object.nm_list <- Vectorize_nm_list(cached_object.nm_generic, SIMPLIFY = FALSE)
 
 
@@ -4373,6 +4367,8 @@ nm_render.nm_list <- Vectorize_nm_list(nm_render.nm_generic, SIMPLIFY = FALSE, i
 #' @param output_file character. Same as rmarkdown::render() arg
 #' @param args list. Same as ""params"" arg in rmarkdown::render()
 #' @param force logical (default = FALSE). will force execution
+#' @param async experiment - should future be used to run asynchronously
+#' @param ... additional arguments passed to rmarkdown::render()
 #' 
 #' @export
 nm_list_render <- function(m, 
@@ -5402,13 +5398,16 @@ ppc_histogram_plot <- function(d, var1, var2, statistic = ""statistic""){
 
 }
 
+#' Plot correlation between two covariates
+#' 
+#' @param d dataset with covariates
+#' @param cov vector of length 2 for covariate names
+#' @param continuous logical vector of length 2 for whether cov is continuous or not
+#' @param log_transform_plot should plot be log transformed or not
+#' @param dcov_info option dataframe with covariate information
+#' @param by character (default = ""ID"") variable to split over
+#' 
 #' @export
-#cov_cov_plot <- function(d,
-#                         cov1, cov2,
-#                         continuous1, continuous2,
-#                         log_transform_plot1 = FALSE, log_transform_plot2 = FALSE,
-#                         dcov_info,
-#                         by = ""ID""){
 cov_cov_plot <- function(d,
                          cov,
                          continuous,
@@ -6023,6 +6022,9 @@ covariance_plot <- function(r,trans=TRUE){
 }
 
 #' get job stats
+#' 
+#' @param m nm object
+#' 
 #' @export
 job_stats <- function(m){
   
@@ -6146,14 +6148,14 @@ make_boot_datasets <- function(m,
   dboots <- dboots %>% mutate(
     m = m %>%
       ## the following run_in will screw up parent_run_in, fix later
-      run_in(file.path(run_in(.), paste0(run_id(.), ""_boot""))) %>%
-      data_path(csv_name[1]) %>%
+      run_in(file.path(run_in(m), paste0(run_id(m), ""_boot""))) %>%
+      data_path(.data$csv_name[1]) %>%
       fill_input(...) %>% ## doing this before child() speeds up execution
       child(run_id) %>% ## expand to fill dboots
-      data_path(csv_name) %>% ## set data_paths
+      data_path(.data$csv_name) %>% ## set data_paths
       change_parent(m) %>%
       #parent_run_in(run_in(m)) %>% ## fix run_in
-      results_dir(run_in(.))
+      results_dir(run_in(m))
   )
   
   dboots
@@ -6178,7 +6180,7 @@ make_xv_datasets <- function(dboot,
     dplyr::group_by(run_id) %>%
     dplyr::mutate(
       oob_csv_name = purrr::map2_chr(
-        splits, run_id,
+        .data$splits, .data$run_id,
         ~boot_to_csv(d = d, rsplit = .x, data_name = .y, 
                      overwrite = overwrite, id_var = id_var, oob = TRUE)
       )
@@ -6187,8 +6189,8 @@ make_xv_datasets <- function(dboot,
     dplyr::mutate(
       m_xv = #ifelse(is_successful(m), 
                     m %>% 
-                      child(paste0(run_id(.), ""eval"")) %>%
-                      data_path(oob_csv_name)#,
+                      child(paste0(run_id(dboot$m), ""eval"")) %>%
+                      data_path(.data$oob_csv_name)#,
               #      nm(NA))
       )
 }

---FILE: R/ctl_handling.R---
@@ -421,6 +421,7 @@ update_parameters0 <- function(ctl,coef_from,type = c(""THETA"",""OMEGA"",""SIGMA"")){
 #' @param ctl object coercible into ctl_character
 #' @param pattern argument passed to gsub
 #' @param replacement argument passed to gsub
+#' @param ... additional arguments passed to gsub
 #' @param dollar character name of subroutine
 #' @export
 

---FILE: R/manual_edit.R---
@@ -113,7 +113,6 @@ start_manual_edit_unix <- function(m, combine_patch = NA_character_){
   res
 }
 
-#' @export
 diff_manual_edit <- function(m, res){
   git2r::add(path = res$new_ctl_path)
   git2r::diff(git2r::repository(), index = TRUE, as_char = TRUE, filename = res$patch_path)

---FILE: R/nm.R---
@@ -195,11 +195,14 @@ ctl_out_files.default <- function(ctl_file){ ## will get vector of $TABLE file n
 }
 
 #' write csv for NONMEM control files
+#' 
+#' Internal function 
+#' 
+#' @param d dataset to be saved
 #' @param ... arguments for write.csv
 #' @param na character. Default changed to ""."".
 #' @param row.names logical. Default changed to FALSE.
 #' @param quote logical. Fefault changed to FALSE
-#' @export
 
 write.csv.nm <- function(d, ...,na=""."",
                          row.names=FALSE,
@@ -274,7 +277,7 @@ run_all_scripts <- function(){
   
   dplan <- dplan %>%
     dplyr::mutate(
-      cmd = ifelse(rmd, 
+      cmd = ifelse(.data$rmd, 
                    paste0(""rmarkdown::render(\"""",script_files,""\"")""),
                    paste0(""source(\"""",script_files,""\"")""))
     )

---FILE: R/nm_gettersetters.R---
@@ -185,18 +185,18 @@ job_info.nm_list <- Vectorize_nm_list(job_info.nm_generic)
 
 #' @rdname nm_getsetters
 #' @export
-run_in <- function(x, text)
+run_in <- function(m, text)
   UseMethod(""run_in"")
 
 #' @export
-run_in.nm_generic <- function(x, text){
-  if(missing(text)) custom_1d_field(x, ""run_in"") else {
-    x <- custom_1d_field(x, ""run_in"", text)
+run_in.nm_generic <- function(m, text){
+  if(missing(text)) custom_1d_field(m, ""run_in"") else {
+    m <- custom_1d_field(m, ""run_in"", text)
     
     ## additional code to ensure data_path is redone
-    data_path <- data_path(x)
-    x <- x %>% data_path(data_path) ## reset data path
-    x
+    data_path <- data_path(m)
+    m <- m %>% data_path(data_path) ## reset data path
+    m
   }
 }
 #' @export
@@ -232,18 +232,23 @@ run_id.nm_list <- Vectorize_nm_list(run_id.nm_generic)
 
 #' @rdname nm_getsetters
 #' @export
-result_files <- function(r, text){
+result_files <- function(m, text){
   UseMethod(""result_files"")
 }
 #' @export
-result_files.nm_generic <- function(r, text){
-  if(missing(text)) return(r[[""result_files""]])
-  r[[""result_files""]] <- unique(c(r[[""result_files""]], text))
-  r
+result_files.nm_generic <- function(m, text){
+  if(missing(text)) return(m[[""result_files""]])
+  m[[""result_files""]] <- unique(c(m[[""result_files""]], text))
+  m
 }
 #' @export
 result_files.nm_list <- Vectorize_nm_list(result_files.nm_generic, SIMPLIFY = FALSE)
 
+#' get paths of results files 
+#' 
+#' @param r nm object
+#' @param pattern grep matching pattern
+#' 
 #' @export
 find_result_files <- function(r, pattern = "".""){
   UseMethod(""find_result_files"")

---FILE: R/sim_reestExtra.R---
@@ -345,11 +345,12 @@ psn_style_scm <- function(base, run_in, dtest,
 #'   returns data.frame with a column ""statistic""
 #' @param ... additional arguments for FUN
 #' @param pre_proc function to mutate dataset prior to compute statistics
-#' @param max_mod_mo integer. Maximum model number to read (set low for debugging)
+#' @param max_mod_no integer. Maximum model number to read (set low for debugging)
 #' @param DV character (default = ""DV"")
 #' @param statistic character (default = ""statistic"") name of statistic column
 #'   returned by FUN
 #' @param group,var1,var2 grouping variables for plotting
+#' @param d dataset
 #'   
 #' @seealso \code{\link{nm_render}}
 #' @examples 

---FILE: R/utilsExtra.R---
@@ -86,6 +86,11 @@ Vectorize_nm_list <- function (FUN, vectorize.args = arg.names, SIMPLIFY = FALSE
   FUNV
 }
 
+
+#' test if object is an nm_list object
+#' 
+#' @param x object
+#' 
 #' @export
 is_nm_list <- function(x){
   if(inherits(x, ""nm_list"")) return(TRUE)
@@ -105,6 +110,9 @@ run_id0 <- function(m){
   val
 }
 
+#' coerce object into nm_list
+#' 
+#' @param m nm object
 #' @export
 as_nm_list <- function(m){
   UseMethod(""as_nm_list"")
@@ -133,7 +141,12 @@ as_nm_list.nm_generic <- function(m){
   as_nm_list.list(m)
 }
 
+#' test if object is an nm_generic object
+#' 
+#' @param x object
+#' 
 #' @export
+
 is_nm_generic <- function(x){
   inherits(x, ""nm_generic"")
 }

---FILE: man/as_nm_list.Rd---
@@ -0,0 +1,14 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/utilsExtra.R
+\name{as_nm_list}
+\alias{as_nm_list}
+\title{coerce object into nm_list}
+\usage{
+as_nm_list(m)
+}
+\arguments{
+\item{m}{nm object}
+}
+\description{
+coerce object into nm_list
+}

---FILE: man/cov_cov_plot.Rd---
@@ -0,0 +1,31 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/NMprojectExtra.R
+\name{cov_cov_plot}
+\alias{cov_cov_plot}
+\title{Plot correlation between two covariates}
+\usage{
+cov_cov_plot(
+  d,
+  cov,
+  continuous,
+  log_transform_plot = rep(FALSE, length(cov)),
+  dcov_info,
+  by = ""ID""
+)
+}
+\arguments{
+\item{d}{dataset with covariates}
+
+\item{cov}{vector of length 2 for covariate names}
+
+\item{continuous}{logical vector of length 2 for whether cov is continuous or not}
+
+\item{log_transform_plot}{should plot be log transformed or not}
+
+\item{dcov_info}{option dataframe with covariate information}
+
+\item{by}{character (default = ""ID"") variable to split over}
+}
+\description{
+Plot correlation between two covariates
+}

---FILE: man/find_nm_install_path.Rd---
@@ -0,0 +1,14 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/NMproject.R
+\name{find_nm_install_path}
+\alias{find_nm_install_path}
+\title{Find location of NONMEM}
+\usage{
+find_nm_install_path(name = ""default"")
+}
+\arguments{
+\item{name}{character name of nonmem installation (according PsN)}
+}
+\description{
+Find location of NONMEM
+}

---FILE: man/find_result_files.Rd---
@@ -0,0 +1,16 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/nm_gettersetters.R
+\name{find_result_files}
+\alias{find_result_files}
+\title{get paths of results files}
+\usage{
+find_result_files(r, pattern = ""."")
+}
+\arguments{
+\item{r}{nm object}
+
+\item{pattern}{grep matching pattern}
+}
+\description{
+get paths of results files
+}

---FILE: man/gsub_ctl.Rd---
@@ -13,6 +13,8 @@ gsub_ctl(ctl, pattern, replacement, ..., dollar = NA_character_)
 
 \item{replacement}{argument passed to gsub}
 
+\item{...}{additional arguments passed to gsub}
+
 \item{dollar}{character name of subroutine}
 }
 \description{

---FILE: man/is_nm_generic.Rd---
@@ -0,0 +1,14 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/utilsExtra.R
+\name{is_nm_generic}
+\alias{is_nm_generic}
+\title{test if object is an nm_generic object}
+\usage{
+is_nm_generic(x)
+}
+\arguments{
+\item{x}{object}
+}
+\description{
+test if object is an nm_generic object
+}

---FILE: man/is_nm_list.Rd---
@@ -0,0 +1,14 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/utilsExtra.R
+\name{is_nm_list}
+\alias{is_nm_list}
+\title{test if object is an nm_list object}
+\usage{
+is_nm_list(x)
+}
+\arguments{
+\item{x}{object}
+}
+\description{
+test if object is an nm_list object
+}

---FILE: man/is_successful.Rd---
@@ -0,0 +1,14 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/NMprojectExtra.R
+\name{is_successful}
+\alias{is_successful}
+\title{test if NONMEM ran without errors}
+\usage{
+is_successful(r)
+}
+\arguments{
+\item{r}{nm object}
+}
+\description{
+test if NONMEM ran without errors
+}

---FILE: man/job_stats.Rd---
@@ -6,6 +6,9 @@
 \usage{
 job_stats(m)
 }
+\arguments{
+\item{m}{nm object}
+}
 \description{
 get job stats
 }

---FILE: man/nm.Rd---
@@ -41,8 +41,6 @@ nm(
 Directory to store results of this run}
 
 \item{lst_path}{character (default = ""{run_dir}/NM_run1/psn.lst"") expected location of lst file}
-
-\item{data_path}{character (default = NA) expected location of dataset file}
 }
 \value{
 An object of class nm_list.  Object is concatenatable.

---FILE: man/nm_getsetters.Rd---
@@ -46,11 +46,11 @@ executed(m, text)
 
 lst_path(m, text)
 
-run_in(x, text)
+run_in(m, text)
 
 run_id(m, text)
 
-result_files(r, text)
+result_files(m, text)
 }
 \arguments{
 \item{m}{nm object}

---FILE: man/nm_list_render.Rd---
@@ -24,6 +24,10 @@ nm_list_render(
 \item{args}{list. Same as ""params"" arg in rmarkdown::render()}
 
 \item{force}{logical (default = FALSE). will force execution}
+
+\item{async}{experiment - should future be used to run asynchronously}
+
+\item{...}{additional arguments passed to rmarkdown::render()}
 }
 \description{
 Mostly used for bootstraps, and other routines where

---FILE: man/ppc.Rd---
@@ -22,6 +22,8 @@ ppc_data(
 )
 }
 \arguments{
+\item{d}{dataset}
+
 \item{group, var1, var2}{grouping variables for plotting}
 
 \item{statistic}{character (default = ""statistic"") name of statistic column
@@ -36,9 +38,9 @@ returns data.frame with a column ""statistic""}
 
 \item{pre_proc}{function to mutate dataset prior to compute statistics}
 
-\item{DV}{character (default = ""DV"")}
+\item{max_mod_no}{integer. Maximum model number to read (set low for debugging)}
 
-\item{max_mod_mo}{integer. Maximum model number to read (set low for debugging)}
+\item{DV}{character (default = ""DV"")}
 }
 \description{
 PPC functions: process data from simulation and plot

---FILE: man/run_id.Rd---
@@ -1,18 +0,0 @@
-% Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMproject.R
-\name{run_id}
-\alias{run_id}
-\title{Get run id}
-\usage{
-run_id(m, text)
-}
-\arguments{
-\item{m}{character or nm or ctl_list/ctl_character}
-
-\item{text}{optional character to set run_id}
-
-\item{...}{additional arguments}
-}
-\description{
-Get run id
-}

---FILE: man/wait_finish.Rd---
@@ -4,7 +4,7 @@
 \alias{wait_finish}
 \title{wait for runs to finish}
 \usage{
-wait_finish(r, timeout = NA, force = FALSE)
+wait_finish(r, timeout = NA)
 }
 \arguments{
 \item{r}{nm object}

---FILE: man/write.csv.nm.Rd---
@@ -7,6 +7,8 @@
 write.csv.nm(d, ..., na = ""."", row.names = FALSE, quote = FALSE)
 }
 \arguments{
+\item{d}{dataset to be saved}
+
 \item{...}{arguments for write.csv}
 
 \item{na}{character. Default changed to ""."".}
@@ -16,5 +18,5 @@ write.csv.nm(d, ..., na = ""."", row.names = FALSE, quote = FALSE)
 \item{quote}{logical. Fefault changed to FALSE}
 }
 \description{
-write csv for NONMEM control files
+Internal function
 }"
tsahota,NMproject,e3f0c735f19d4a146f7011de8aa8330d3e2df6be,tarj sahota,t.sahota0@gmail.com,2021-03-08T18:02:19Z,tarj sahota,t.sahota0@gmail.com,2021-03-08T18:02:19Z,removed cran errors,R/NMprojectExtra.R,False,True,True,False,12,8,20,"---FILE: R/NMprojectExtra.R---
@@ -3505,7 +3505,7 @@ init_omega.nm_generic <- function(m, replace, ...){
   if(missing(replace)){  ## get
     if(length(mutate_args) > 0){
       current_init <- init_omega(m)
-      replace <- current_init %>% mutate_cond(!is.na(name), !!!mutate_args)
+      replace <- current_init %>% mutate_cond(!is.na(.data$name), !!!mutate_args)
       replace <- replace %>% dplyr::mutate_if(is.numeric, ~signif(., 5))
     } else {
       d$value <- NULL
@@ -3560,7 +3560,7 @@ init_sigma.nm_generic <- function(m, replace, ...){
   if(missing(replace)){  ## get
     if(length(mutate_args) > 0){
       current_init <- init_sigma(m)
-      replace <- current_init %>% mutate_cond(!is.na(name), !!!mutate_args)
+      replace <- current_init %>% mutate_cond(!is.na(.data$name), !!!mutate_args)
       replace <- replace %>% dplyr::mutate_if(is.numeric, ~signif(., 5))
     } else {
       d$value <- NULL
@@ -5979,7 +5979,7 @@ covariance_plot <- function(r,trans=TRUE){
   n_ests <- nrow(dc)/length(unique(dc$Var1))
   
   dc$EST.NO <- rep(1:n_ests,each=length(unique(dc$Var1)))
-  dc <- dc %>% dplyr::filter(EST.NO == max(.data$EST.NO))
+  dc <- dc %>% dplyr::filter(.data$EST.NO == max(.data$EST.NO))
   dc$EST.NO <- NULL
   
   dc <- dc %>% tidyr::gather(key = ""Var2"", value=""value"",-.data$Var1)
@@ -6033,18 +6033,22 @@ job_stats <- function(m){
     stop(""install lubridate"", call. = FALSE)
   
   d <- m %>% nm_row()
-  
-  d <- d %>% ungroup() %>%
-    dplyr::mutate(xml_path = nm_output_path(.data$m, ""xml""),
+
+  d <- d %>% dplyr::ungroup() %>%
+    dplyr::mutate(xml_path = nm_output_path(m, ""xml""),
                   xml = purrr::map(.data$xml_path, pmxTools::read_nm))
   
+
+  ## this is to avoid CRAN error below - before it was inline
+  m_time_f <- function(path) lubridate::ymd_hms(file.info(path)$mtime)
+  
   d %>% dplyr::mutate(
     starttime = purrr::map_chr(.data$xml, ~.x$start_datetime),
-    stoptime = purrr::map_chr(xml, ~.x$stop_datetime),
+    stoptime = purrr::map_chr(.data$xml, ~.x$stop_datetime),
     starttime = lubridate::ymd_hms(.data$starttime),
     stoptime = lubridate::ymd_hms(.data$stoptime),
     Rtime = difftime(.data$stoptime, .data$starttime, units = ""mins""), 
-    launchtime = .data$m %>% run_dir(full_path = TRUE) %>% file.path(""command.txt"") %>% file.info() %>% .$mtime %>% lubridate::ymd_hms(),
+    launchtime = m %>% run_dir(full_path = TRUE) %>% file.path(""command.txt"") %>% m_time_f(),
     Qtime = difftime(.data$starttime, .data$launchtime, units = ""mins""),
     Ttime = difftime(.data$stoptime, .data$launchtime, units = ""mins"")
   )"
tsahota,NMproject,d0097fd80b15e6bac3bd07539b0ba17bfbbe4cea,tarj sahota,t.sahota0@gmail.com,2021-03-08T14:54:26Z,tarj sahota,t.sahota0@gmail.com,2021-03-08T14:54:26Z,doc fix + make potential_deletion.R for things that will perhaps be deleted in future,DESCRIPTION;NAMESPACE;R/NMprojectExtra.R;R/potential_deletion.R;man/reexports.Rd;man/set_simple_field.Rd,False,True,True,False,118,187,305,"---FILE: DESCRIPTION---
@@ -61,6 +61,7 @@ Collate:
     'nm_data.R'
     'nm_gettersetters.R'
     'plot_iter.R'
+    'potential_deletion.R'
     'read.table.nm.R'
     'read_ext.R'
     'run_nm.R'

---FILE: NAMESPACE---
@@ -67,7 +67,6 @@ S3method(init_sigma,nm_generic)
 S3method(init_sigma,nm_list)
 S3method(init_theta,nm_generic)
 S3method(init_theta,nm_list)
-S3method(input_data,default)
 S3method(input_data,nm_generic)
 S3method(input_data,nm_list)
 S3method(insert_dollar,nm_generic)
@@ -240,7 +239,6 @@ export(find_result_files)
 export(from_models)
 export(get_PMX_code_library)
 export(get_data_name)
-export(get_simple_field)
 export(gsub_ctl)
 export(ignore)
 export(init_omega)

---FILE: R/NMprojectExtra.R---
@@ -414,22 +414,6 @@ set_simple_field <- function(m, ...){
   UseMethod(""set_simple_field"")  
 }
 
-#' Add a simple field to nm object
-#' 
-#' @param m nm object
-#' @param ... arguments to set fields
-#' 
-#' @examples 
-#' \dontrun{
-#' 
-#' core_list <- c(1,4,12)
-#' 
-#' mc <- m1 %>% child(run_id = paste0(corelist)) %>%
-#'   set_simple_field(cores = corelist) %>%
-#'   cmd(""qpsn -c {cores} -t 59 -- execute {ctl_name} -dir={run_dir}"")
-#' 
-#' }
-#' @export
 set_simple_field <- function(m, ...){
 
   dots <- list(...)
@@ -442,7 +426,6 @@ set_simple_field <- function(m, ...){
 }
 
 
-#' @export
 get_simple_field <- function(m, field){
 
   field <- rlang::enquo(field)
@@ -483,37 +466,6 @@ simple_field <- function(m, ...){
   }
 }
 
-#' @importFrom dplyr mutate
-#' @export
-dplyr::mutate
-
-#' @export
-mutate.nm_list <- function(.data, ...){
-  dots_exp <- rlang::enexprs(...)
-  data_extra <- dplyr::mutate(nm_row(.data), ...)
-  
-  for(name in names(dots_exp)){
-    .data <- .data %>% custom_1d_field(field = name, replace = data_extra[[name]])
-  }
-  .data
-  
-}
-
-#' @importFrom dplyr filter
-#' @export
-dplyr::filter
-
-#' @export
-filter.nm_list <- function(.data, ...){
-  dots_exp <- rlang::enexprs(...)
-  object <- .data
-  .data <- nm_row(object)
-  .data$m <- object
-
-  data_extra <- dplyr::filter(.data, ...)
-  data_extra$m
-}
-
 glue_text_nm <- function(m, text){
   UseMethod(""glue_text_nm"")
 }
@@ -592,17 +544,6 @@ ctl_list2.nm_generic <- function(r) r[[""ctl_contents""]]
 
 ctl_list2.nm_list <- Vectorize_nm_list(ctl_list2.nm_generic, SIMPLIFY = FALSE)
 
-
-
-new_ctl_extra <- function(m, ctl, dir = getOption(""models.dir"")){
-  
-  ctl$TABLE <- gsub(paste0(""(FILE\\s*=\\s*\\S*tab)\\S*\\b""),paste0(""\\1"",run_id(m)),ctl$TABLE)
-  ctl[[1]] <- gsub(""^(\\s*;;\\s*[0-9]*\\.\\s*Based on:).*"",paste(""\\1"",parent_run_id(m)),ctl[[1]])
-  ctl[[1]] <- gsub(""^(\\s*;;\\s*\\w*\\.\\s*Author:).*"",paste(""\\1"",Sys.info()[""user""]),ctl[[1]])
-  
-  ctl
-}
-
 #' Write control file to disk
 #' 
 #' Normally used by other functions
@@ -647,15 +588,6 @@ write_ctl.nm_generic <- function(m, force = FALSE){
 #' @export
 write_ctl.nm_list <- Vectorize_nm_list(write_ctl.nm_generic, SIMPLIFY = FALSE, invisible = TRUE)
 
-delete_ctl <- function(m){
-  UseMethod(""delete_ctl"")
-}
-delete_ctl.nm_generic <- function(m){
-  unlink(ctl_path(m))
-  invisible(m)
-}
-delete_ctl.nm_list <- Vectorize_nm_list(delete_ctl.nm_generic, SIMPLIFY = FALSE, invisible = TRUE)
-
 #' @include ctl_handling.R
 #' @export
 update_dollar.nm_generic <- function(ctl,..., which_dollar = 1, append = FALSE){
@@ -956,30 +888,6 @@ input_data.nm_list <- function(m, filter = FALSE, na = ""."", ...){
   d
 }
 
-#' @export
-input_data.default <- function(m, filter = FALSE, na = ""."", ...){   ## old get_data
-  ## doesn't rely on data base or r object contents
-  if(inherits(m, ""nm"")) {
-    file_name <- file.path(run_in(m), get_data_name(ctl_character(m)))
-  } else {
-    from <- dirname(attr(m, ""file_name""))
-    file_name <- file.path(from, get_data_name(ctl_character(m)))
-  }
-  if(!grepl(""[a-zA-Z0-9]"",basename(file_name))) stop(""$DATA doesn't look like it refers to a file. Is this correct?"")
-  
-  if(normalizePath(dirname(file_name), mustWork = FALSE) == normalizePath(""DerivedData"")){
-    d <- read_derived_data(basename(tools::file_path_sans_ext(file_name)),...)
-  } else {
-    d <- utils::read.csv(file_name, ...)
-  }
-  
-  if(filter) {
-    data_filter <- parse(text = data_filter_char(m, data = d))
-    d <- subset(d, eval(data_filter))
-  }
-  d
-}
-
 #' Get/set ignore statement from ctl_contents
 #' 
 #' @param ctl nm object
@@ -1470,71 +1378,6 @@ nm_tran.nm_generic <- function(x){
 #' @export
 nm_tran.nm_list <- Vectorize_nm_list(nm_tran.nm_generic, SIMPLIFY = FALSE, invisible = TRUE)
 
-
-in_cache <- function(r,
-                     cache_ignore_cmd = FALSE, cache_ignore_ctl = FALSE, cache_ignore_data = FALSE,
-                     return_checksums = FALSE){
-  UseMethod(""in_cache"")
-}
-
-in_cache.nm_generic <- function(r,
-                                cache_ignore_cmd = FALSE, cache_ignore_ctl = FALSE, cache_ignore_data = FALSE,
-                                return_checksums = FALSE){
-  
-  .Deprecated(""overwrite_behaviour"", 
-              msg = ""this function is no longer needed with overwrite_behaviour (see app) and will probably be removed"")
-  r %>% write_ctl()
-  ## get all md5_files
-  
-  run_cache_disk <- lapply(run_cache_paths(r), readRDS)
-  if(length(run_cache_disk) > 0){
-    current_checksums <- run_checksums(r)
-    checksums_reduced <- lapply(run_cache_disk, function(i) {
-      
-      if(cache_ignore_cmd){  ## remove cmd check
-        keep <- !names(current_checksums) %in% ""cmd""
-        i$checksums <- i$checksums[keep]
-        current_checksums <- current_checksums[keep]
-      }
-      
-      if(cache_ignore_ctl){  ## remove cmd check
-        keep <- !names(current_checksums) %in% ""ctl""
-        i$checksums <- i$checksums[keep]
-        current_checksums <- current_checksums[keep]
-      }        
-      
-      if(cache_ignore_data){  ## remove cmd check
-        keep <- !names(current_checksums) %in% ""data""
-        i$checksums <- i$checksums[keep]
-        current_checksums <- current_checksums[keep]
-      }
-      
-      ## ignore names
-      #names(current_checksums) <- NULL
-      #names(i$checksums) <- NULL
-
-      list(
-        checksums = current_checksums,
-        stored_checksums = i$checksums
-        )
-      
-      #identical(i$checksums, current_checksums)
-    })
-
-    matches <- sapply(checksums_reduced,
-                      function(i) identical(i$checksums, 
-                                            i$stored_checksums))
-    
-    if(any(matches)){
-      return(TRUE)    ## if up to date, skip
-    }
-  }
-  if(return_checksums) return(checksums_reduced)
-  return(FALSE)
-}
-
-in_cache.nm_list <- Vectorize_nm_list(in_cache.nm_generic)
-
 #' @export
 cache_history <- function(r){
   UseMethod(""cache_history"")

---FILE: R/potential_deletion.R---
@@ -0,0 +1,116 @@
+#' @importFrom dplyr mutate
+#' @export
+dplyr::mutate
+
+#' @export
+mutate.nm_list <- function(.data, ...){
+  dots_exp <- rlang::enexprs(...)
+  data_extra <- dplyr::mutate(nm_row(.data), ...)
+  
+  for(name in names(dots_exp)){
+    .data <- .data %>% custom_1d_field(field = name, replace = data_extra[[name]])
+  }
+  .data
+  
+}
+
+#' @importFrom dplyr filter
+#' @export
+dplyr::filter
+
+#' @export
+filter.nm_list <- function(.data, ...){
+  dots_exp <- rlang::enexprs(...)
+  object <- .data
+  .data <- nm_row(object)
+  .data$m <- object
+  
+  data_extra <- dplyr::filter(.data, ...)
+  data_extra$m
+}
+
+
+new_ctl_extra <- function(m, ctl, dir = getOption(""models.dir"")){
+  
+  ctl$TABLE <- gsub(paste0(""(FILE\\s*=\\s*\\S*tab)\\S*\\b""),paste0(""\\1"",run_id(m)),ctl$TABLE)
+  ctl[[1]] <- gsub(""^(\\s*;;\\s*[0-9]*\\.\\s*Based on:).*"",paste(""\\1"",parent_run_id(m)),ctl[[1]])
+  ctl[[1]] <- gsub(""^(\\s*;;\\s*\\w*\\.\\s*Author:).*"",paste(""\\1"",Sys.info()[""user""]),ctl[[1]])
+  
+  ctl
+}
+
+## shouldn't need to delete ctls anymore
+
+delete_ctl <- function(m){
+  UseMethod(""delete_ctl"")
+}
+delete_ctl.nm_generic <- function(m){
+  unlink(ctl_path(m))
+  invisible(m)
+}
+delete_ctl.nm_list <- Vectorize_nm_list(delete_ctl.nm_generic, SIMPLIFY = FALSE, invisible = TRUE)
+
+
+in_cache <- function(r,
+                     cache_ignore_cmd = FALSE, cache_ignore_ctl = FALSE, cache_ignore_data = FALSE,
+                     return_checksums = FALSE){
+  UseMethod(""in_cache"")
+}
+
+in_cache.nm_generic <- function(r,
+                                cache_ignore_cmd = FALSE, cache_ignore_ctl = FALSE, cache_ignore_data = FALSE,
+                                return_checksums = FALSE){
+  
+  .Deprecated(""overwrite_behaviour"", 
+              msg = ""this function is no longer needed with overwrite_behaviour (see app) and will probably be removed"")
+  r %>% write_ctl()
+  ## get all md5_files
+  
+  run_cache_disk <- lapply(run_cache_paths(r), readRDS)
+  if(length(run_cache_disk) > 0){
+    current_checksums <- run_checksums(r)
+    checksums_reduced <- lapply(run_cache_disk, function(i) {
+      
+      if(cache_ignore_cmd){  ## remove cmd check
+        keep <- !names(current_checksums) %in% ""cmd""
+        i$checksums <- i$checksums[keep]
+        current_checksums <- current_checksums[keep]
+      }
+      
+      if(cache_ignore_ctl){  ## remove cmd check
+        keep <- !names(current_checksums) %in% ""ctl""
+        i$checksums <- i$checksums[keep]
+        current_checksums <- current_checksums[keep]
+      }        
+      
+      if(cache_ignore_data){  ## remove cmd check
+        keep <- !names(current_checksums) %in% ""data""
+        i$checksums <- i$checksums[keep]
+        current_checksums <- current_checksums[keep]
+      }
+      
+      ## ignore names
+      #names(current_checksums) <- NULL
+      #names(i$checksums) <- NULL
+      
+      list(
+        checksums = current_checksums,
+        stored_checksums = i$checksums
+      )
+      
+      #identical(i$checksums, current_checksums)
+    })
+    
+    matches <- sapply(checksums_reduced,
+                      function(i) identical(i$checksums, 
+                                            i$stored_checksums))
+    
+    if(any(matches)){
+      return(TRUE)    ## if up to date, skip
+    }
+  }
+  if(return_checksums) return(checksums_reduced)
+  return(FALSE)
+}
+
+in_cache.nm_list <- Vectorize_nm_list(in_cache.nm_generic)

---FILE: man/reexports.Rd---
@@ -1,5 +1,5 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R, R/run_record.R
+% Please edit documentation in R/potential_deletion.R, R/run_record.R
 \docType{import}
 \name{reexports}
 \alias{reexports}

---FILE: man/set_simple_field.Rd---
@@ -1,27 +0,0 @@
-% Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R
-\name{set_simple_field}
-\alias{set_simple_field}
-\title{Add a simple field to nm object}
-\usage{
-set_simple_field(m, ...)
-}
-\arguments{
-\item{m}{nm object}
-
-\item{...}{arguments to set fields}
-}
-\description{
-Add a simple field to nm object
-}
-\examples{
-\dontrun{
-
-core_list <- c(1,4,12)
-
-mc <- m1 \%>\% child(run_id = paste0(corelist)) \%>\%
-  set_simple_field(cores = corelist) \%>\%
-  cmd(""qpsn -c {cores} -t 59 -- execute {ctl_name} -dir={run_dir}"")
-
-}
-}"
tsahota,NMproject,a87c4a62ce28152def97456060dbccfb54384771,tarj sahota,t.sahota0@gmail.com,2021-03-07T00:05:38Z,tarj sahota,t.sahota0@gmail.com,2021-03-07T00:05:38Z,removed nm_boot + doc fixes,NAMESPACE;R/NMprojectExtra.R;R/developer_funs.R;R/sim_reestExtra.R;man/add_mixed_param.Rd;man/boot_to_csv.Rd;man/copy_demo_to_demo.Rd;man/copy_demo_to_test.Rd;man/dollar.Rd;man/gen_sim_path.Rd;man/nm_boot.Rd,False,True,True,False,106,137,243,"---FILE: NAMESPACE---
@@ -279,7 +279,6 @@ export(new_nm)
 export(new_notebook_template)
 export(new_script)
 export(nm)
-export(nm_boot)
 export(nm_diff)
 export(nm_list_gather)
 export(nm_list_render)

---FILE: R/NMprojectExtra.R---
@@ -2027,10 +2027,35 @@ show_ctl.nm_generic <- function(r) {
 show_ctl.nm_list <- show_ctl.nm_generic
 
 #' Get/set existing subroutine
-#' 
+#'
+#' The fast way to see the contents of a particular subroutine. This can be used
+#' in place of manual edits to (re)write the contents of a NONMEM subroutine
+#' from within R
+#'
 #' @param m nm object
 #' @param dollar character.  Subroutine to target
 #' @param ... arguments to be passed to text()
+#' @param add_dollar_text logical (default = TRUE). Should the $XXXX be added to
+#'   text
+#'
+#' @seealso \code{\link{insert_dollar}}
+#'
+#' @examples
+#' \dontrun{
+#'
+#' m1 %>% dollar(""PK"")  ## displays existing $PK
+#'
+#' m1 <- m1 %>% dollar(""DES"",
+#' ""
+#' DADT(1) = -K*A(1)
+#' ""
+#' )  
+#' ## This will rewrite an existing $DES
+#' ## if control file doesn't already have a $DES
+#' ## use insert_dollar() instead
+#'
+#' }
+#'
 #' @export
 dollar <- function(m, dollar, ..., add_dollar_text = TRUE) {
   orig_target <- m %>% target()
@@ -2643,6 +2668,18 @@ remove_parameter <- function(m, name){
 }
 
 
+#' add a mixed effect parameter to $PK (or $PRED)
+#' 
+#' This will (by default) add a parameter (mixed effect) to your code
+#' 
+#' @param m nm object
+#' @param name character. name of NONMEM variable to create
+#' @param init numeric. initial value of fixed effect
+#' @param unit character. unit of variable
+#' @param trans character. tranformation to log scale?
+#' @param position integer. not used
+#' @param after character. patter to match and include the mixed effect after
+#' 
 #' @export
 add_mixed_param <- function(m, name, 
                             init = 1, unit ="""", trans = c(""LOG""),
@@ -6050,86 +6087,6 @@ decision <- function(inputs = c(),
   }
 }
 
-#' Write bootstrap dataset
-#'
-#' @param m nm object
-#' @param replicates numeric vector of bootstrap replicate numbers
-#' @param dboot_rds path to bootstrap RDS file
-#' @export
-nm_boot <- function(m, replicates, dboot_rds = ""dboots_big.RDS""){
-  
-  dboot_rds <- file.path(
-    tools::file_path_sans_ext(data_path(m)), dboot_rds
-  )
-  
-  if(!requireNamespace(""rsample""))
-    stop(""install rsample"", call. = FALSE)
-  
-  write_boot_replicate <- function(rsplit, dbase, csv_name, id = ""ID""){
-    
-    ## need an orginal dataset.
-    dd_boot <- rsample::analysis(rsplit)
-    dd_boot[[id]] <- 1:nrow(dd_boot)
-    
-    dd_boot <- dd_boot %>%
-      dplyr::inner_join(dbase)
-    
-    dd_boot %>%
-      write_derived_data(csv_name)
-    
-    return(csv_name)
-    
-  }
-  
-  
-  drpl <- suppressWarnings(
-    drake::drake_plan(
-      base_data = data_path(m1),
-      base_data_dir = tools::file_path_sans_ext(base_data),
-      dboots_big = readRDS(drake::file_in(!!dboot_rds)),
-      dboot = dboots_big[replicates, ],
-      dbase = input_data(m1, filter = TRUE),
-      csv_name = file.path(base_data_dir, paste0(""boot"", 1:nrow(dboot), "".csv"")),
-      csv_name2 = write_boot_replicate(dboot$splits[[1]], 
-                                       dbase, 
-                                       drake::file_out(csv_name[1]),
-                                       id = ""ID"")
-    )
-  )
-  
-  ## get csv_names as own variable for later
-  csv_names <- file.path(tools::file_path_sans_ext(data_path(m1)),
-                         paste0(""boot"",replicates, "".csv""))
-  
-  drpl_add <- drpl %>% dplyr::filter(target == ""csv_name2"")
-  
-  drpl_repl <- tibble::tibble(target = paste0(""csv_name"", replicates),
-                              command = drpl_add$command)
-  
-  drpl_repl$command <- sapply(seq_along(replicates), function(i){
-    command <- drpl_repl$command[i]
-    command <- gsub(""\\[\\[1\\]\\]"",paste0(""[["",replicates[i],""]]""), command) 
-    command <- gsub(""csv_name\\[1\\]"",paste0(""'"",csv_names[i],""'""), command) 
-  })
-  
-  drpl <- dplyr::anti_join(drpl, drpl_add)
-  drpl <- dplyr::bind_rows(drpl, drpl_repl)
-  
-  suppressMessages(suppressWarnings({
-    drake::make(drpl)    
-  }))
-  
-  dboot <- tibble::tibble(data_path = csv_names, rep = replicates)
-  dboot <- dboot %>%
-    dplyr::mutate(
-      m = m %>% child(.data$rep) %>%
-        data_path(.data$data_path)
-    )
-  
-  return(dboot$m)  ## only return the nm_list
-  
-}
-
 #' Plot covariance matrix
 #' 
 #' @param r nm object
@@ -6231,6 +6188,7 @@ job_stats <- function(m){
 #' @param data_name name of dataset
 #' @param data_folder path to bootstrap datasets
 #' @param id_var character (default = ""ID""). Name of ID column
+#' @param oob logical.  Should out of bag dataset be written (default = FALSE)
 #' @param overwrite should datasets be overwritten
 #' 
 boot_to_csv <- function(d,
@@ -6300,7 +6258,7 @@ make_boot_datasets <- function(m,
     dplyr::group_by(run_id) %>%
     dplyr::mutate(
       csv_name = purrr::map2_chr(
-        splits, run_id,
+        .data$splits, .data$run_id,
         ~boot_to_csv(d = d, rsplit = .x, data_name = .y, 
                      overwrite = overwrite, id_var = id_var)
       )

---FILE: R/developer_funs.R---
@@ -25,11 +25,6 @@ copy_demo_to_templates <- function(){
   
 }
 
-#' Copy demo source files to package
-#' 
-#' Internal function (non exported)
-#'   Use within a demo directory
-
 copy_demo_to_demo <- function(demo = ""theopp""){
   
   ## 3 things to handle
@@ -81,11 +76,6 @@ copy_demo_to_demo <- function(demo = ""theopp""){
   c(res1, res2, res3)
 }
 
-#' Copy demo source files + relevant NM outputs to package testfiles
-#' 
-#' Internal function (non exported)
-#'   Use within a demo directory
-
 copy_demo_to_test <- function(demo = ""theopp""){
   
   easy_directories <- c(""localpackage"",

---FILE: R/sim_reestExtra.R---
@@ -2,8 +2,9 @@
 #' 
 #' @param dsc tibble::tibble with experimental factors to vary
 #' @param start_dir directory name within which all runs should take place.
+#' @param include_names logical (default = TRUE). 
 
-gen_sim_path <- function(dsc,start_dir,include_names = TRUE){
+gen_sim_path <- function(dsc, start_dir, include_names = TRUE){
   
   ## run as dsc$location <- gen_sim_path(dsc, ...)
   

---FILE: man/add_mixed_param.Rd---
@@ -0,0 +1,34 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/NMprojectExtra.R
+\name{add_mixed_param}
+\alias{add_mixed_param}
+\title{add a mixed effect parameter to $PK (or $PRED)}
+\usage{
+add_mixed_param(
+  m,
+  name,
+  init = 1,
+  unit = """",
+  trans = c(""LOG""),
+  position = NA_integer_,
+  after = character()
+)
+}
+\arguments{
+\item{m}{nm object}
+
+\item{name}{character. name of NONMEM variable to create}
+
+\item{init}{numeric. initial value of fixed effect}
+
+\item{unit}{character. unit of variable}
+
+\item{trans}{character. tranformation to log scale?}
+
+\item{position}{integer. not used}
+
+\item{after}{character. patter to match and include the mixed effect after}
+}
+\description{
+This will (by default) add a parameter (mixed effect) to your code
+}

---FILE: man/boot_to_csv.Rd---
@@ -25,6 +25,8 @@ boot_to_csv(
 
 \item{id_var}{character (default = ""ID""). Name of ID column}
 
+\item{oob}{logical.  Should out of bag dataset be written (default = FALSE)}
+
 \item{overwrite}{should datasets be overwritten}
 }
 \description{

---FILE: man/copy_demo_to_demo.Rd---
@@ -1,12 +0,0 @@
-% Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/developer_funs.R
-\name{copy_demo_to_demo}
-\alias{copy_demo_to_demo}
-\title{Copy demo source files to package}
-\usage{
-copy_demo_to_demo(demo = ""theopp"")
-}
-\description{
-Internal function (non exported)
-  Use within a demo directory
-}

---FILE: man/copy_demo_to_test.Rd---
@@ -1,12 +0,0 @@
-% Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/developer_funs.R
-\name{copy_demo_to_test}
-\alias{copy_demo_to_test}
-\title{Copy demo source files + relevant NM outputs to package testfiles}
-\usage{
-copy_demo_to_test(demo = ""theopp"")
-}
-\description{
-Internal function (non exported)
-  Use within a demo directory
-}

---FILE: man/dollar.Rd---
@@ -12,7 +12,32 @@ dollar(m, dollar, ..., add_dollar_text = TRUE)
 \item{dollar}{character.  Subroutine to target}
 
 \item{...}{arguments to be passed to text()}
+
+\item{add_dollar_text}{logical (default = TRUE). Should the $XXXX be added to
+text}
 }
 \description{
-Get/set existing subroutine
+The fast way to see the contents of a particular subroutine. This can be used
+in place of manual edits to (re)write the contents of a NONMEM subroutine
+from within R
+}
+\examples{
+\dontrun{
+
+m1 \%>\% dollar(""PK"")  ## displays existing $PK
+
+m1 <- m1 \%>\% dollar(""DES"",
+""
+DADT(1) = -K*A(1)
+""
+)  
+## This will rewrite an existing $DES
+## if control file doesn't already have a $DES
+## use insert_dollar() instead
+
+}
+
+}
+\seealso{
+\code{\link{insert_dollar}}
 }

---FILE: man/gen_sim_path.Rd---
@@ -10,6 +10,8 @@ gen_sim_path(dsc, start_dir, include_names = TRUE)
 \item{dsc}{tibble::tibble with experimental factors to vary}
 
 \item{start_dir}{directory name within which all runs should take place.}
+
+\item{include_names}{logical (default = TRUE).}
 }
 \description{
 generate paths for simulation runs

---FILE: man/nm_boot.Rd---
@@ -1,18 +0,0 @@
-% Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R
-\name{nm_boot}
-\alias{nm_boot}
-\title{Write bootstrap dataset}
-\usage{
-nm_boot(m, replicates, dboot_rds = ""dboots_big.RDS"")
-}
-\arguments{
-\item{m}{nm object}
-
-\item{replicates}{numeric vector of bootstrap replicate numbers}
-
-\item{dboot_rds}{path to bootstrap RDS file}
-}
-\description{
-Write bootstrap dataset
-}"
tsahota,NMproject,1296f2cfd8da2ea88d57cef86888fab142bf4b37,tarj sahota,t.sahota0@gmail.com,2021-03-06T22:12:02Z,tarj sahota,t.sahota0@gmail.com,2021-03-06T22:12:02Z,fixed test bugs and removed old funs,DESCRIPTION;NAMESPACE;R/NMproject.R;R/NMprojectExtra.R;R/ctl_handling.R;R/nm.R;R/nm_gettersetters.R;R/sim_reestExtra.R;man/ctl_fix_eta.Rd;man/ctl_param_set.Rd;man/ctl_path.Rd;man/ctl_unfix_eta.Rd;man/extra_files.Rd;man/get_data.Rd;man/interactive_mode.Rd;man/ls_tempfiles.Rd;man/ls_tempfiles_old.Rd;man/non_interactive_mode.Rd;man/update_dollar_input.Rd,False,True,True,False,75,709,784,"---FILE: DESCRIPTION---
@@ -29,7 +29,10 @@ Imports:
     rstudioapi (>= 0.7),
     crayon (>= 1.3.4),
     drake (>= 5.3.0),
-    rsample
+    rsample,
+    devtools,
+    rprojroot,
+    htmltools
 RoxygenNote: 7.1.0
 Suggests:
     testthat,
@@ -38,7 +41,10 @@ Suggests:
     ggplot2,
     future,
     data.tree,
-    xpose4
+    xpose,
+    lubridate,
+    pmxTools,
+    Hmisc
 Collate: 
     'NMproject.R'
     'nm.R'

---FILE: NAMESPACE---
@@ -1,7 +1,5 @@
 # Generated by roxygen2: do not edit by hand
 
-S3method(""%ns>%"",nm_generic)
-S3method(""%ns>%"",nm_list)
 S3method(""["",nm_list)
 S3method(AIC,data.frame)
 S3method(AIC,nm_generic)
@@ -48,7 +46,6 @@ S3method(ctl_list,ctl_list)
 S3method(ctl_list,nmexecute)
 S3method(ctl_table_paths,nm_generic)
 S3method(ctl_table_paths,nm_list)
-S3method(data_ignore_char,default)
 S3method(data_name,default)
 S3method(data_path,nm_generic)
 S3method(data_path,nm_list)
@@ -95,7 +92,6 @@ S3method(nm_render,nm_list)
 S3method(nm_row,nm_generic)
 S3method(nm_row,nm_list)
 S3method(nm_tran,default)
-S3method(nm_tran,nm)
 S3method(nm_tran,nm_generic)
 S3method(nm_tran,nm_list)
 S3method(nmsave_multiplot,nm_generic)
@@ -182,7 +178,6 @@ S3method(wipe_run,nm_generic)
 S3method(wipe_run,nm_list)
 S3method(write_ctl,nm_generic)
 S3method(write_ctl,nm_list)
-export(""%ns>%"")
 export(.available_advans)
 export(.overwrite_behaviour)
 export(AIC)
@@ -223,18 +218,14 @@ export(cov_forest_data)
 export(cov_forest_plot)
 export(covariance_plot)
 export(covariate_step_tibble)
-export(covariates_define)
 export(ctl_character)
 export(ctl_contents)
-export(ctl_fix_eta)
 export(ctl_list)
 export(ctl_name)
 export(ctl_nm2r)
-export(ctl_param_set)
 export(ctl_path)
 export(ctl_r2nm)
 export(ctl_table_paths)
-export(ctl_unfix_eta)
 export(data_filter_char)
 export(data_ignore_char)
 export(data_name)
@@ -246,7 +237,6 @@ export(dollar)
 export(environment_info)
 export(exclude_rows)
 export(executed)
-export(extra_files)
 export(file_name)
 export(fill_dollar_data)
 export(fill_input)
@@ -255,7 +245,6 @@ export(find_nm_install_path)
 export(find_result_files)
 export(from_models)
 export(get_PMX_code_library)
-export(get_data)
 export(get_data_name)
 export(get_simple_field)
 export(gsub_ctl)
@@ -266,7 +255,6 @@ export(init_sigma)
 export(init_theta)
 export(input_data)
 export(insert_dollar)
-export(interactive_mode)
 export(is_finished)
 export(is_nm_generic)
 export(is_nm_list)
@@ -306,7 +294,6 @@ export(nmsave_multiplot)
 export(nmsave_plot)
 export(nmsave_table)
 export(nobs)
-export(non_interactive_mode)
 export(nonmem_code_to_r)
 export(ofv)
 export(omega_matrix)
@@ -382,7 +369,6 @@ export(unique_id)
 export(untarget)
 export(update_dollar)
 export(update_dollar_data)
-export(update_dollar_input)
 export(update_ignore)
 export(update_parameters)
 export(update_sizes)

---FILE: R/NMproject.R---
@@ -374,22 +374,6 @@ update_dollar_data <- function(ctl_name,new_data_name){
   ctl
 }
 
-#' update dollar inpute in NONMEM control stream
-#'
-#' Generic function
-#' @param ctl object coercible into ctl_lst
-#' @param ... arguments to be passed to dollar_input
-#' @export
-
-update_dollar_input <- function(ctl, ...){
-  if(is_single_na(ctl)) return(NA)
-  ctl <- ctl_list(ctl)
-  d <- suppressMessages(get_data(ctl))
-  replace_with <- suppressMessages(dollar_input(d, ...))
-  ctl$INPUT <- c(""$INPUT"", replace_with, """")
-  ctl
-}
-
 #' Check tidyproject for best practice compliance
 #'
 #' @param proj_name character. default = current working directory. path to directory.

---FILE: R/NMprojectExtra.R---
@@ -1664,7 +1664,7 @@ wipe_run.nm_generic <- function(r){
   behaviour <- overwrite_behaviour()
   if(""stop"" %in% behaviour & length(existing_ctl_out_files) > 0)
     stop(""no overwriting allowed, stopping due to following files/directories:\n "",
-         paste(paste(paths, collapse = ""\n "")))
+         paste(paste(existing_ctl_out_files, collapse = ""\n "")))
   prompt_overwrite(rev(existing_ctl_out_files))
   
   unlink(ctl_out_files, recursive = TRUE, force = TRUE)
@@ -1742,113 +1742,15 @@ clean_run.nm_list <- function(m, output_loc = c(""run_dir"", ""base""), include_grid
 #' list all tempfiles (normally for deletion)
 #'
 #' @param object nm object or path to project (default = ""."")
-#' @param output_loc character either ""run_dir"" or ""base
+#' @param output_loc character either ""run_dir"" (default) for psn runs or ""base"" for nmfe runs
 #' @param run_files optional character with NM_run* file paths
 #' @param include_grid_files logical (default = TRUE) should slurm files be included
+#' @param ctl_extension character. Extension of control file (default = ""mod"")
+#' @param remove_psn_exports logical (default = FALSE). should psn exports be considered temporary
 #'
-ls_tempfiles_old <- function(object = ""."", output_loc = c(""run_dir"", ""base""),
-                         run_files = NA_character_, include_grid_files = TRUE){
-  
-  UseMethod(""ls_tempfiles_old"")
-  
-}
-
-ls_tempfiles_old.default <- function(object = ""."", output_loc = c(""run_dir"", ""base""),
-                                 run_files = NA_character_, include_grid_files = TRUE){
-  
-  output_loc <- match.arg(output_loc)
-
-  ## get all_run_files (in NM_run1 dir)
-  if(identical(run_files, NA_character_)){
-    all_run_dirs <- list_dirs(
-      object, 
-      pattern = ""NM_run[0-9]+"", 
-      recursive = TRUE, full.names = TRUE, maxdepth = Inf
-    )
-    
-    all_run_files <- dir(all_run_dirs, full.names = TRUE)
-  } else {
-    all_run_files <- run_files 
-  }
-  
-  all_psn.mod <- all_run_files[basename(all_run_files) == ""psn.mod""]
-  
-  all_run_dir_table_files <- 
-    lapply(all_psn.mod, function(psn.mod){
-      file.path(dirname(psn.mod), ctl_table_files(psn.mod))
-    })
-  all_run_dir_table_files <- unlist(all_run_dir_table_files)
-
-  all_base_tables <- all_run_dir_table_files
-  all_base_table_dir <- dirname(all_base_tables)
-  all_base_table_dir <- file.path(all_base_table_dir, "".."", "".."")
-  all_base_table_dir <- normalizePath(all_base_table_dir)
-  
-  if(output_loc == ""run_dir""){ ## add base tables to temp files
-    all_base_tables <- file.path(all_base_table_dir, basename(all_run_dir_table_files))
-    all_base_tables <- all_base_tables[file.exists(all_base_tables)]
-    
-    all_base_mod_files <- dir(unique(all_base_table_dir),
-                              pattern = ""\\.mod$"",
-                              full.names = TRUE)
-    
-    all_base_stubs <- tools::file_path_sans_ext(all_base_mod_files)
-    
-    all_base_psn_files <- lapply(all_base_stubs, function(base_mod_stub){
-      base_dir <- dirname(base_mod_stub)
-      stub <- basename(base_mod_stub)
-      dir(base_dir, pattern = paste0(""^"", stub, ""\\..*""), full.names = TRUE)
-    })
-    all_base_psn_files <- unlist(all_base_psn_files)
-    
-    all_base_psn_files <- all_base_psn_files[
-      ## exclude mod and lst files
-      !tools::file_ext(all_base_psn_files) %in% c(""mod"", ""lst"")
-    ]
-  }
-  
-  temp_files <- all_run_files
-  ## exclude all_run_dir_table_files
-  if(output_loc == ""run_dir"")
-    temp_files <- temp_files[!temp_files %in% all_run_dir_table_files]
-  ## exclude csvs (psns intermediate results)
-  temp_files <- temp_files[!tools::file_ext(temp_files) == ""csv""]
-  ## exclude psn.something (psns intermediate results)
-  temp_files <- temp_files[!grepl(""psn-?[0-9]?"", tools::file_path_sans_ext(basename(temp_files)))]
-  
-  if(output_loc == ""run_dir"")
-    temp_files <- c(temp_files, all_base_tables, all_base_psn_files)
-  
-  if(length(temp_files) == 0) return(character())
-  
-  temp_files <- tidyproject::relative_path(temp_files, getwd())
-  
-  return(temp_files)
-  
-}
-
-ls_tempfiles_old.nm_list <- function(object = ""."", output_loc = c(""run_dir"", ""base""),
-                                 run_files = NA_character_, include_grid_files = TRUE){
-  
-  all_run_dirs <- list_dirs(
-    run_dir_path(object), 
-    pattern = ""NM_run[0-9]+"", 
-    full.names = TRUE)
-  
-  all_run_files <- dir(all_run_dirs, full.names = TRUE)
-  
-  ls_tempfiles_old(run_files = all_run_files, output_loc = output_loc)
-}
-
-
-#' get all temp files
-#'
-#' list all tempfiles (normally for deletion)
-#'
-#' @param object nm object or path to project (default = ""."")
-#' @param output_loc character either ""run_dir"" or ""base
-#' @param run_files optional character with NM_run* file paths
-#' @param include_grid_files logical (default = TRUE) should slurm files be included
+#' @details
+#' Having \code{remove_psn_exposure = TRUE} will break pirana and xpose capability
+#'   as these software use exported files 
 #'
 #' @export
 ls_tempfiles <- function(object = ""."", output_loc = c(""run_dir"", ""base""),
@@ -1969,7 +1871,8 @@ ls_tempfiles.default <- function(object = ""."", output_loc = c(""run_dir"", ""base"")
 #' @export
 ls_tempfiles.nm_list <- function(object = ""."", output_loc = c(""run_dir"", ""base""),
                                  run_files = NA_character_, include_grid_files = TRUE,
-                                 ctl_extension = ""mod""){
+                                 ctl_extension = ""mod"",
+                                 remove_psn_exports = FALSE){
   
   all_run_dirs <- list_dirs(
     run_dir_path(object), 
@@ -1979,7 +1882,8 @@ ls_tempfiles.nm_list <- function(object = ""."", output_loc = c(""run_dir"", ""base"")
   all_run_files <- dir(all_run_dirs, full.names = TRUE)
   
   ls_tempfiles(run_files = all_run_files, output_loc = output_loc, 
-               ctl_extension = tools::file_ext(ctl_name(object)))
+               ctl_extension = tools::file_ext(ctl_name(object)),
+               remove_psn_exports = remove_psn_exports)
   
 }
 
@@ -2136,59 +2040,6 @@ dollar <- function(m, dollar, ..., add_dollar_text = TRUE) {
   ans
 }
 
-## pipe for string functions
-
-#' @export
-'%ns>%' <- function(m, expr){
-  UseMethod('%ns>%')
-}
-#' @export
-'%ns>%.nm_generic' <- function(m, expr){
-  if(!requireNamespace(""stringr"")) stop(""install stringr to use this pipe"")
-  string <- m %>% text
-  expr <- substitute(expr)
-  list_expr <- as.list(expr)
-  list_expr <- append(list_expr, list(string), after = 1)
-  list_expr <- as.call(list_expr)
-  string <- eval(list_expr)
-  m %>% text(string)
-}
-
-#' @export
-'%ns>%.nm_list' <- function(m, expr){
-  if(!requireNamespace(""stringr"")) stop(""install stringr to use this pipe"")
-  strings <- m %>% text ## list of chars
-  
-  expr <- substitute(expr)
-  list_expr <- as.list(expr)
-  
-  ## vectorize the stringr function
-  stringr_fun <- list_expr[[1]]
-  stringr_fun <- eval(stringr_fun) 
-  stringr_fun_vec <- Vectorize(stringr_fun, SIMPLIFY = FALSE)
-  
-  ## evaluate args
-  args <- list_expr
-  args[[1]] <- strings  ## only args remaining
-  args <- lapply(args, eval) ## evaluate them
-  
-  ## make new call with vectorized stringr fun
-  ##  and pre-evaluated args
-  new_call <- rlang::call2(""stringr_fun_vec"", !!!args)
-  strings_new <- eval(new_call)
-  
-  ## text() isn't vectorized for lists of characters
-  ## need to loop
-  m <- lapply(seq_along(strings_new), function(i){
-    mi <- m[[i]] ## nm_generic
-    string_new <- strings_new[[i]]
-    mi %>% text(string_new)
-  })
-  
-  as_nm_list(m)
-}
-
-
 #' @export
 n_thetas <- function(m){
   param_info <- param_info(m)
@@ -3878,13 +3729,13 @@ perturb_inits.nm_generic <- function(m, theta_log, omega_diag){
   it <- m %>% init_theta()
   is_log <- which(it$trans %in% ""LOG"")
   it$init[is_log] <- 
-    rnorm(length(is_log), mean = it$init[is_log], sd = theta_log)
+    stats::rnorm(length(is_log), mean = it$init[is_log], sd = theta_log)
   
   io <- m %>% init_omega()
   is_diag <- which(io$omega1 == io$omega2)
   io$init[is_diag] <- 
-    rlnorm(length(is_diag), meanlog = log(io$init[is_diag]),
-           sdlog = omega_diag)
+    stats::rlnorm(length(is_diag), meanlog = log(io$init[is_diag]),
+                  sdlog = omega_diag)
   
   m %>% init_theta(it) %>% init_omega(io)
 }
@@ -4224,27 +4075,19 @@ nm_output.nm_generic <- function(r,dorig,...){
   r <- as_nm_generic(r)  ## because nm_list method is identical
   wait_finish(r)
   
-  # if(requireNamespace(""xpose4"", quietly = TRUE)) {
-  #   xpdb <- xpose4::xpose.data(run_id(r), directory=paste0(run_in(r),""/""))
-  #   d <- xpdb@Data
-  # } else 
-    d <- data.frame()
+  ctl_out_files <- ctl_table_paths(as_nm_generic(r))
   
-  if(nrow(d) == 0){
-    ctl_out_files <- ctl_table_paths(as_nm_generic(r))
-    
-    d <- lapply(ctl_out_files, function(out_file){
-      d <- nm_read_table(out_file, skip = 1, header = TRUE)
-    })
-    
-    ## TODO: this will break if some tables have FIRSTONLY
-    nrows <- sapply(d, nrow)
-    if(length(unique(nrows[!nrows %in% 0])) > 1)
-      stop(""output tables are different sizes"")
-    
-    d <- do.call(cbind,d)
-    d <- d[,!duplicated(names(d))]
-  }
+  d <- lapply(ctl_out_files, function(out_file){
+    d <- nm_read_table(out_file, skip = 1, header = TRUE)
+  })
+  
+  ## TODO: this will break if some tables have FIRSTONLY
+  nrows <- sapply(d, nrow)
+  if(length(unique(nrows[!nrows %in% 0])) > 1)
+    stop(""output tables are different sizes"")
+  
+  d <- do.call(cbind,d)
+  d <- d[,!duplicated(names(d))]
   
   if(missing(dorig)) dorig <- input_data(r,...)
   
@@ -4877,8 +4720,8 @@ summary.nm_list <- function(object, ref_model = NA, parameters = c(""none"", ""new""
     ## nm_lists screw up in dplyr...
     ds <- lapply(ds, function(x) {
       x %>% 
-        mutate(m = nm_list2list(m),
-               parent = nm_list2list(parent))
+        dplyr::mutate(m = nm_list2list(.data$m),
+                      parent = nm_list2list(.data$parent))
     })
     
     d <- suppressWarnings(dplyr::bind_rows(ds))
@@ -6305,10 +6148,10 @@ covariance_plot <- function(r,trans=TRUE){
   n_ests <- nrow(dc)/length(unique(dc$Var1))
   
   dc$EST.NO <- rep(1:n_ests,each=length(unique(dc$Var1)))
-  dc <- dc %>% dplyr::filter(EST.NO == max(EST.NO))
+  dc <- dc %>% dplyr::filter(EST.NO == max(.data$EST.NO))
   dc$EST.NO <- NULL
   
-  dc <- dc %>% tidyr::gather(key = ""Var2"", value=""value"",-Var1)
+  dc <- dc %>% tidyr::gather(key = ""Var2"", value=""value"",-.data$Var1)
   
   dc$Var1 <- factor(dc$Var1)
   dc$Var2 <- factor(dc$Var2)
@@ -6329,18 +6172,19 @@ covariance_plot <- function(r,trans=TRUE){
     
   }
   
-  dc <- dc %>% dplyr::filter(!value %in% 0)
-  dc <- dc %>% dplyr::filter(as.numeric(Var1) > as.numeric(Var2)) ## lower corner
+  dc <- dc %>% dplyr::filter(!.data$value %in% 0)
+  dc <- dc %>% dplyr::filter(as.numeric(.data$Var1) > as.numeric(.data$Var2)) ## lower corner
+  dc$label <- round(dc$value, 2)
   
-  p <- ggplot2::ggplot(dc, ggplot2::aes(x= Var1, y= Var2, fill = value)) + 
+  p <- ggplot2::ggplot(dc, ggplot2::aes_string(x= ""Var1"", y= ""Var2"", fill = ""value"")) + 
     ggplot2::theme_bw() +
     ggplot2::geom_tile() + 
     ggplot2::scale_fill_gradient2(
       low = ""blue"", high = ""red"", mid = ""white"", 
       midpoint = 0, limit = c(-1,1), space = ""Lab"", 
       name=""Correlation""
     ) +
-    ggplot2::geom_text(ggplot2::aes(label = round(value,2))) +
+    ggplot2::geom_text(ggplot2::aes_string(label = ""label"")) +
     ggplot2::theme(axis.text.x  = ggplot2::element_text(angle=90,vjust=0))
   
   p
@@ -6354,20 +6198,25 @@ job_stats <- function(m){
   if(!requireNamespace(""pmxTools""))
     stop(""install pmxTools"", call. = FALSE)
   
+  if(!requireNamespace(""lubridate""))
+    stop(""install lubridate"", call. = FALSE)
+  
   d <- m %>% nm_row()
   
   d <- d %>% ungroup() %>%
-    mutate(xml_path = nm_output_path(m, ""xml""),
-           xml = purrr::map(xml_path, pmxTools::read_nm))
-  
-  d %>% mutate(starttime = purrr::map_chr(xml, ~.x$start_datetime),
-               stoptime = purrr::map_chr(xml, ~.x$stop_datetime),
-               starttime = lubridate::ymd_hms(starttime),
-               stoptime = lubridate::ymd_hms(stoptime),
-               Rtime = difftime(stoptime, starttime, units = ""mins""), 
-               launchtime = m %>% run_dir(full_path = TRUE) %>% file.path(""command.txt"") %>% file.info() %>% .$mtime %>% lubridate::ymd_hms(),
-               Qtime = difftime(starttime, launchtime, units = ""mins""),
-               Ttime = difftime(stoptime, launchtime, units = ""mins""))
+    dplyr::mutate(xml_path = nm_output_path(.data$m, ""xml""),
+                  xml = purrr::map(.data$xml_path, pmxTools::read_nm))
+  
+  d %>% dplyr::mutate(
+    starttime = purrr::map_chr(.data$xml, ~.x$start_datetime),
+    stoptime = purrr::map_chr(xml, ~.x$stop_datetime),
+    starttime = lubridate::ymd_hms(.data$starttime),
+    stoptime = lubridate::ymd_hms(.data$stoptime),
+    Rtime = difftime(.data$stoptime, .data$starttime, units = ""mins""), 
+    launchtime = .data$m %>% run_dir(full_path = TRUE) %>% file.path(""command.txt"") %>% file.info() %>% .$mtime %>% lubridate::ymd_hms(),
+    Qtime = difftime(.data$starttime, .data$launchtime, units = ""mins""),
+    Ttime = difftime(.data$stoptime, .data$launchtime, units = ""mins"")
+  )
   
 }
 
@@ -6407,8 +6256,9 @@ boot_to_csv <- function(d,
   suppressMessages({
     dd_boot <- rsample_fun(rsplit) %>%
       dplyr::ungroup() %>%
-      dplyr::select(id_var) %>% 
-      dplyr::mutate(NEWID = 1:nrow(.)) %>%
+      dplyr::select(id_var)
+    dd_boot <- dd_boot %>%
+      dplyr::mutate(NEWID = 1:nrow(dd_boot)) %>%
       dplyr::inner_join(d)
   })
   dd_boot$OLDID <- dd_boot[[id_var]]
@@ -6417,7 +6267,7 @@ boot_to_csv <- function(d,
   
   dir.create(data_folder, showWarnings = FALSE, recursive = TRUE)
   
-  write.csv(dd_boot, file = csv_name, quote = FALSE, row.names = FALSE, na = ""."")
+  utils::write.csv(dd_boot, file = csv_name, quote = FALSE, row.names = FALSE, na = ""."")
   
   return(csv_name)
 }

---FILE: R/ctl_handling.R---
@@ -788,36 +788,6 @@ change_seed <- function(ctl,new_seed){
   gsub(""(^\\$SIM\\S*\\s+\\()[0-9]+(\\).*$)"",paste0(""\\1"",new_seed,""\\2""),ctl)
 }
 
-#' get data set
-#'
-#' @param r object coercible into ctl_character
-#' @param filter logical (default = FALSE). Should NONMEM ignore filter be applied
-#' @param ... additional arguments for read.csv
-#' @export
-get_data <- function(r, filter = FALSE, ...){
-  .Deprecated(""input_data"")
-  ## doesn't rely on data base or r object contents
-  if(inherits(r, ""nm"")) {
-    file_name <- file.path(run_in(r), get_data_name(ctl_character(r)))
-  } else {
-    from <- dirname(attr(r, ""file_name""))
-    file_name <- file.path(from, get_data_name(ctl_character(r)))
-  }
-  if(!grepl(""[a-zA-Z0-9]"",basename(file_name))) stop(""$DATA doesn't look like it refers to a file. Is this correct?"")
-
-  if(normalizePath(dirname(file_name), mustWork = FALSE) == normalizePath(""DerivedData"")){
-    d <- read_derived_data(basename(get_stub_name(file_name)),...)
-  } else {
-    d <- utils::read.csv(file_name, ...)
-  }
-
-  if(filter) {
-    data_filter <- parse(text = data_filter_char(r, data = d))
-    d <- subset(d, eval(data_filter))
-  }
-  d
-}
-
 #' convert nonmem code to R ready
 #' 
 #' This is a developer function
@@ -860,80 +830,3 @@ nonmem_code_to_r <- function(code, eta_to_0 = TRUE){
   
   
 }
-
-#' set parameter value
-#' 
-#' @param ctl object coercible into ctl_list
-#' @param param character, name of paramater
-#' @param to character/numeric, number to fix to 
-#' @export
-
-ctl_param_set <- function(ctl, param, to){
-  ctl <- ctl_character(ctl)
-  d <- data.frame(param, to)
-  for(i in 1:nrow(d)){
-    match_txt_nofix <- paste0(""(\\s*)(\\S+)()(\\s*;\\s*"", d$param[i],"")"")
-    match_txt_fix <- paste0(""(\\s*)(\\S+)(\\s+FIX)(\\s*;\\s*"", d$param[i],"")"")
-    match_index_nofix <- grep(match_txt_nofix, ctl)
-    match_index_fix <- grep(match_txt_fix, ctl)
-    
-    fixed_param <- FALSE
-    if(length(match_index_nofix) == 1 & length(match_index_fix) == 0) {
-      
-    } else if(length(match_index_nofix) == 0 & length(match_index_fix) == 1){
-      fixed_param <- TRUE
-    } else {
-      if(length(match_index_nofix) +  length(match_index_fix) > 1) warning(""more than one line matched for "",d$param[i],"" in "",file_name(ctl),"", check control stream"")
-      if(length(match_index_nofix) +  length(match_index_fix) < 1) warning(""no matches for "",d$param[i],"" in "",file_name(ctl),"", no change will take place"")
-    }
-    
-    match_txt <- ifelse(fixed_param, match_txt_fix, match_txt_nofix)
-    match_index <- ifelse(fixed_param, match_index_fix, match_index_nofix)
-    
-    replace_txt <- paste0(""\\1"",d$to[i],"" \\4"")
-    ctl <- gsub_ctl(ctl, match_txt, replace_txt)
-  }
-  ctl
-}
-
-#' fix etas
-#' 
-#' @param ctl object coercible into ctl_list
-#' @param param character, name of paramater
-#' @param to optional character/numeric, number to fix to 
-#' @export
-
-ctl_fix_eta <- function(ctl, param, to){
-  ctl <- ctl_character(ctl)
-  if(missing(to)) to <- ""\\2""  ## current parameter
-  d <- data.frame(param, to)
-  for(i in 1:nrow(d)){
-    match_txt <- paste0(""(\\s*)(\\S+)(\\s*; IIV_"", d$param[i],"")"")
-    match_index <- grep(match_txt, ctl)
-    if(length(match_index) > 1) warning(""more than one line matched for "",d$param[i],"" in "",file_name(ctl),"", check control stream"")
-    if(length(match_index) < 1) warning(""no matches for "",d$param[i],"" in "",file_name(ctl),"", no change will take place"")
-    replace_txt <- paste0(""\\1"",d$to[i],"" FIX\\3"")
-    ctl <- gsub_ctl(ctl, match_txt, replace_txt)
-  }
-  ctl
-}
-
-#' unfix etas
-#' 
-#' @param ctl object coercible into ctl_list
-#' @param param character, name of paramater
-#' @export
-
-ctl_unfix_eta <- function(ctl, param){
-  ctl <- ctl_character(ctl)
-  d <- data.frame(param)
-  for(i in 1:nrow(d)){
-    match_txt <- paste0(""(\\s*)(\\S+)(\\s+FIX)(\\s*; IIV_"", d$param[i],"")"")
-    match_index <- grep(match_txt, ctl)
-    if(length(match_index) > 1) warning(""more than one line matched for "",d$param[i],"" in "",file_name(ctl),"", check control stream"")
-    if(length(match_index) < 1) warning(""no matches for "",d$param[i],"" in "",file_name(ctl),"", no change will take place"")
-    replace_txt <- paste0(""\\1\\2    \\4"")
-    ctl <- gsub_ctl(ctl, match_txt, replace_txt)
-  }
-  ctl
-}

---FILE: R/nm.R---
@@ -158,60 +158,6 @@ wait_default <- function(x) options(""wait""=x)
 
 overwrite_default <- function(x) options(""run_overwrite""=x)
 
-#' Should run() work in non interactive mode
-#'
-#' Depreciated
-#'
-#' @export
-non_interactive_mode <- function() {
-  .Deprecated(""interactive_mode"")
-}
-
-#' Should run() work in interactive mode
-#'
-#' @param value logical. TRUE = use interactive mode. FALSE = use non-interactive mode
-#' @export
-interactive_mode <- function(value) {
-  if(missing(value)) stop(""expecting TRUE/FALSE argument"")
-  if(!is.logical(value)) stop(""expecting TRUE/FALSE argument"")
-  if(value){
-    overwrite_default(FALSE)
-    wait_default(FALSE)
-  } else {
-    overwrite_default(TRUE)
-    wait_default(TRUE)
-  }
-}
-
-#' @export
-nm_tran.nm <- function(x){
-  tidyproject::check_if_tidyproject()
-  nm_tran.default(x$ctl)
-}
-
-#' List files to be cleaned up
-#' 
-#' @param r object class nm
-#' @export
-#' @examples 
-#' \dontrun{
-#' mod1 %>% extra_files
-#' mod1 %>% extra_files %>% cleanup
-#' }
-
-extra_files <- function(r){
-  tidyproject::check_if_tidyproject()
-  if(r$type %in% ""execute""){
-    table_files <- ctl_table_files(r)
-    files <- file.path(r$run_dir, ""NM_run1"", table_files)
-  }
-  if(r$type %in% ""vpc""){
-    print(""TBD"")
-    files <- character()
-  }
-  return(files)
-}
-
 
 ctl_table_files <- function(ctl){
   UseMethod(""ctl_table_files"") 
@@ -248,32 +194,6 @@ ctl_out_files.default <- function(ctl_file){ ## will get vector of $TABLE file n
   out.files
 }
 
-input_files <- function(run_in,run_type,ctl_name){
-  r <- list()
-  r$ctl <- ctl_name
-  if(run_type %in% ""execute""){
-    r$data_name <- data_name(ctl_name)
-    r$data_loc <- file.path(run_in,r$data_name)
-  }
-  return(r)
-}
-
-output_files <- function(run_in,run_type,run_dir,ctl_name){
-  r <- list()
-  if(run_type %in% ""execute""){
-    extn <- tools::file_ext(ctl_name)
-    r$lst <- paste0(get_stub_name(ctl_name),"".lst"")
-    r$psn.mod <- file.path(run_dir,""NM_run1"",""psn.mod"")
-    r$psn.lst <- file.path(run_dir,""NM_run1"",""psn.lst"")
-    r$psn.ext <- file.path(run_dir,""NM_run1"",""psn.ext"")
-    r$psn.cov <- file.path(run_dir,""NM_run1"",""psn.cov"")
-    r$psn.cor <- file.path(run_dir,""NM_run1"",""psn.cor"")
-    r$psn.xml <- file.path(run_dir,""NM_run1"",""psn.xml"")
-    r$ctl_out_files <- file.path(run_in,ctl_out_files(ctl_name))
-  }
-  return(r)
-}
-
 #' write csv for NONMEM control files
 #' @param ... arguments for write.csv
 #' @param na character. Default changed to ""."".
@@ -410,69 +330,7 @@ output_table.default <- function(r, ...){
 data_ignore_char <- function(r, data){
   UseMethod(""data_ignore_char"")
 }
-#' @export
-data_ignore_char.default <- function(r, data){
-  dol_data <- ctl_list(r)$DATA
-  dol_data <- dol_data[!dol_data %in% """"]
-  dol_data <- rem_comment(dol_data)
-  dol_data <- unlist(strsplit(dol_data, split = ""\\s""))
-  
-  ignore_present <- any(grepl("".*IGNORE\\s*=\\s*\\("",dol_data))
-  accept_present <- any(grepl("".*ACCEPT\\s*=\\s*\\("",dol_data))
-  
-  type <- NA
-  if(ignore_present & accept_present) stop(""cannot identify ignore columns"")
-  if(ignore_present) type <- ""IGNORE""
-  if(accept_present) type <- ""ACCEPT""
-  no_filter <- is.na(type)
-  
-  ## get nonmem names and input names
-  ## read in the data - need only header though
-  if(missing(data)) data <- input_data(r, filter = FALSE, silent = TRUE)
-  
-  r_data_names <- names(data)
-  ## now get nonmem names
-  dollar_input <- ctl_list(r)$INPUT
-  nonmem_data_names <- gsub(""\\$\\w+"", """", dollar_input)
-  nonmem_data_names <- unlist(strsplit(nonmem_data_names, split = ""\\s""))
-  nonmem_data_names <- nonmem_data_names[!nonmem_data_names %in% """"]
-  nonmem_data_names <- gsub(""\\w+=(\\w+)"", ""\\1"", nonmem_data_names)
-  #if(length(r_data_names) != length(nonmem_data_names))
-  #  stop(""length of items in $INPUT doesn't match dataset"")
-  name_chart <- data.frame(r_data_names, nonmem_data_names, stringsAsFactors = FALSE)
-  name_chart <- name_chart[name_chart$r_data_names != name_chart$nonmem_data_names,]
-  
-  if(!no_filter){
-    filter_statements <- paste0("".*"",type,""\\s*=\\s*\\((\\S[^\\)]+)\\)*.*"")
-    dol_data <- dol_data[grepl(filter_statements, dol_data)]
-    filter_statements <- gsub(filter_statements,""\\1"",dol_data)
-    filter_statements <- unlist(strsplit(filter_statements,"",""))
-    filter_statements <- gsub(""\\.EQ\\."",""=="",filter_statements)
-    filter_statements <- gsub(""\\.NE\\."",""!="",filter_statements)
-    filter_statements <- gsub(""\\.EQN\\."",""=="",filter_statements)
-    filter_statements <- gsub(""\\.NEN\\."",""!="",filter_statements)
-    filter_statements <- gsub(""\\./E\\."",""!="",filter_statements)
-    filter_statements <- gsub(""\\.GT\\."","">"",filter_statements)
-    filter_statements <- gsub(""\\.LT\\."",""<"",filter_statements)
-    filter_statements <- gsub(""\\.GE\\."","">="",filter_statements)
-    filter_statements <- gsub(""\\.LE\\."",""<="",filter_statements)
-    
-    ## substitute names from 
-    for(i in seq_len(nrow(name_chart))){
-      nonmem_data_name <- paste0(""\\b"", name_chart$nonmem_data_names[i], ""\\b"")
-      r_data_name <- name_chart$r_data_names[i]
-      filter_statements <- gsub(nonmem_data_name,
-                                r_data_name,
-                                filter_statements)
-    }
-    
-    filter_statements <- paste(filter_statements, collapse= "" | "")
-    if(""ACCEPT"" %in% type) filter_statements <- paste0(""!("",filter_statements,"")"")
-  } else {
-    filter_statements <- ""FALSE""
-  }
-  filter_statements
-}
+
 
 #' Get filter statement
 #' 

---FILE: R/nm_gettersetters.R---
@@ -22,7 +22,7 @@ NULL
 #'
 #' m0 <- m0 %>% ctl_name(""run{run_id}.mod"")
 #' ctl_name(m0)
-#' ## warning: this has make the run identifier in old xpose4 ""_m0"" not ""m0""! ## deleteme
+#' ## warning: this makes the run identifier in old xpose4 ""_m0"" not ""m0""! ## deleteme
 #'
 #' m0 <- m0 %>% ctl_path(""Models/run_{run_id}.mod"")
 #' ctl_path(m0)

---FILE: R/sim_reestExtra.R---
@@ -244,47 +244,6 @@ bind_covariate_results <- function(dsc, nm_col = ""m"", parameters = ""new""){
     dplyr::arrange(.data$p_chisq)
 }
 
-covariates_define_old <- function(dcov, cov, continuous){
-  
-  if(missing(cov)) return(tibble::tibble())
-  if(length(continuous) > 1) stop(""continous can only be TRUE/FALSE"")
-  dcov_new <- tibble::tibble(cov, continuous)
-  if(!missing(dcov)) dcov_new <- dplyr::bind_rows(dcov, dcov_new)
-  return(dcov_new)
-  
-}
-
-#' @export
-covariates_define <- function(d, continuous, categorical, log_transform_plot = c()){
-
-  if(!inherits(d, ""grouped_df""))
-    stop(""d must be data.frame grouped_by ID using dplyr::group_by()"")
-  
-  by <- attributes(d)$vars
-  
-  if(missing(continuous) & missing(categorical)) 
-    return(tibble::tibble())
-  
-  cov <- c(continuous, categorical)
-  continuous <- cov %in% continuous
-  
-  dcov <- tibble::tibble(cov, continuous)
-  ## gather information on these covariates
-  
-  dtemp <- d[, c(by, dcov$cov)] %>%
-    dplyr::group_by_(by) %>% 
-    dplyr::summarise_all(function(i)length(unique(i)))
-  
-  static <- sapply(dcov$cov, function(i) all(dtemp[[i]] %in% 1))
-  
-  dcov$static <- static
-  dcov$log_transform_plot <- dcov$cov %in% log_transform_plot
-  dcov$by <- by
-  
-  return(dcov)
-  
-}
-
 #' Generate tibble of relations to test
 #'
 #' @param dtest (optional) existing dtest to append (from an previous use test_relations())
@@ -346,28 +305,6 @@ test_relations <- function(dtest, param, cov, state, continuous){
   
 }
 
-identify_cov_relations <- function(r){
-  ctl <- ctl_list(r)
-  pk_block <- ctl$PK
-  
-  cov_relations <- pk_block[grepl(""^;;;\\s*\\S+-DEFINITION START"", pk_block)]
-  
-  cov_relations <- gsub(""^;;;\\s*(\\S+)-DEFINITION.*"",""\\1"",cov_relations)
-  
-  pars <- pk_block[grepl(""^\\s*\\S+\\s="", pk_block)]
-  
-  pars <- gsub(""^\\s*(\\S+)\\s=.*"",""\\1"",pars)
-  
-  #d <- get_data(r)
-  d <- input_data(r)
-  
-  dcomb <- expand.grid(param = pars, cov=names(d))
-  possible_cov_relations <- paste0(dcomb$param,dcomb$cov)
-  
-  dcomb[possible_cov_relations %in% cov_relations, ]
-  
-}
-
 ## given param and cov
 
 #' @export

---FILE: man/ctl_fix_eta.Rd---
@@ -1,18 +0,0 @@
-% Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/ctl_handling.R
-\name{ctl_fix_eta}
-\alias{ctl_fix_eta}
-\title{fix etas}
-\usage{
-ctl_fix_eta(ctl, param, to)
-}
-\arguments{
-\item{ctl}{object coercible into ctl_list}
-
-\item{param}{character, name of paramater}
-
-\item{to}{optional character/numeric, number to fix to}
-}
-\description{
-fix etas
-}

---FILE: man/ctl_param_set.Rd---
@@ -1,18 +0,0 @@
-% Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/ctl_handling.R
-\name{ctl_param_set}
-\alias{ctl_param_set}
-\title{set parameter value}
-\usage{
-ctl_param_set(ctl, param, to)
-}
-\arguments{
-\item{ctl}{object coercible into ctl_list}
-
-\item{param}{character, name of paramater}
-
-\item{to}{character/numeric, number to fix to}
-}
-\description{
-set parameter value
-}

---FILE: man/ctl_path.Rd---
@@ -28,7 +28,7 @@ ctl_name(m0)
 
 m0 <- m0 \%>\% ctl_name(""run{run_id}.mod"")
 ctl_name(m0)
-## warning: this has make the run identifier in old xpose4 ""_m0"" not ""m0""! ## deleteme
+## warning: this makes the run identifier in old xpose4 ""_m0"" not ""m0""! ## deleteme
 
 m0 <- m0 \%>\% ctl_path(""Models/run_{run_id}.mod"")
 ctl_path(m0)

---FILE: man/ctl_unfix_eta.Rd---
@@ -1,16 +0,0 @@
-% Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/ctl_handling.R
-\name{ctl_unfix_eta}
-\alias{ctl_unfix_eta}
-\title{unfix etas}
-\usage{
-ctl_unfix_eta(ctl, param)
-}
-\arguments{
-\item{ctl}{object coercible into ctl_list}
-
-\item{param}{character, name of paramater}
-}
-\description{
-unfix etas
-}

---FILE: man/extra_files.Rd---
@@ -1,20 +0,0 @@
-% Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/nm.R
-\name{extra_files}
-\alias{extra_files}
-\title{List files to be cleaned up}
-\usage{
-extra_files(r)
-}
-\arguments{
-\item{r}{object class nm}
-}
-\description{
-List files to be cleaned up
-}
-\examples{
-\dontrun{
-mod1 \%>\% extra_files
-mod1 \%>\% extra_files \%>\% cleanup
-}
-}

---FILE: man/get_data.Rd---
@@ -1,18 +0,0 @@
-% Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/ctl_handling.R
-\name{get_data}
-\alias{get_data}
-\title{get data set}
-\usage{
-get_data(r, filter = FALSE, ...)
-}
-\arguments{
-\item{r}{object coercible into ctl_character}
-
-\item{filter}{logical (default = FALSE). Should NONMEM ignore filter be applied}
-
-\item{...}{additional arguments for read.csv}
-}
-\description{
-get data set
-}

---FILE: man/interactive_mode.Rd---
@@ -1,14 +0,0 @@
-% Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/nm.R
-\name{interactive_mode}
-\alias{interactive_mode}
-\title{Should run() work in interactive mode}
-\usage{
-interactive_mode(value)
-}
-\arguments{
-\item{value}{logical. TRUE = use interactive mode. FALSE = use non-interactive mode}
-}
-\description{
-Should run() work in interactive mode
-}

---FILE: man/ls_tempfiles.Rd---
@@ -16,12 +16,20 @@ ls_tempfiles(
 \arguments{
 \item{object}{nm object or path to project (default = ""."")}
 
-\item{output_loc}{character either ""run_dir"" or ""base}
+\item{output_loc}{character either ""run_dir"" (default) for psn runs or ""base"" for nmfe runs}
 
 \item{run_files}{optional character with NM_run* file paths}
 
 \item{include_grid_files}{logical (default = TRUE) should slurm files be included}
+
+\item{ctl_extension}{character. Extension of control file (default = ""mod"")}
+
+\item{remove_psn_exports}{logical (default = FALSE). should psn exports be considered temporary}
 }
 \description{
 list all tempfiles (normally for deletion)
 }
+\details{
+Having \code{remove_psn_exposure = TRUE} will break pirana and xpose capability
+  as these software use exported files
+}

---FILE: man/ls_tempfiles_old.Rd---
@@ -1,25 +0,0 @@
-% Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R
-\name{ls_tempfiles_old}
-\alias{ls_tempfiles_old}
-\title{get all temp files}
-\usage{
-ls_tempfiles_old(
-  object = ""."",
-  output_loc = c(""run_dir"", ""base""),
-  run_files = NA_character_,
-  include_grid_files = TRUE
-)
-}
-\arguments{
-\item{object}{nm object or path to project (default = ""."")}
-
-\item{output_loc}{character either ""run_dir"" or ""base}
-
-\item{run_files}{optional character with NM_run* file paths}
-
-\item{include_grid_files}{logical (default = TRUE) should slurm files be included}
-}
-\description{
-list all tempfiles (normally for deletion)
-}

---FILE: man/non_interactive_mode.Rd---
@@ -1,11 +0,0 @@
-% Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/nm.R
-\name{non_interactive_mode}
-\alias{non_interactive_mode}
-\title{Should run() work in non interactive mode}
-\usage{
-non_interactive_mode()
-}
-\description{
-Depreciated
-}

---FILE: man/update_dollar_input.Rd---
@@ -1,16 +0,0 @@
-% Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMproject.R
-\name{update_dollar_input}
-\alias{update_dollar_input}
-\title{update dollar inpute in NONMEM control stream}
-\usage{
-update_dollar_input(ctl, ...)
-}
-\arguments{
-\item{ctl}{object coercible into ctl_lst}
-
-\item{...}{arguments to be passed to dollar_input}
-}
-\description{
-Generic function
-}"
tsahota,NMproject,94abafd07a87b02624d0fe28de62be168d6dab1b,tarj sahota,t.sahota0@gmail.com,2021-03-06T16:33:43Z,tarj sahota,t.sahota0@gmail.com,2021-03-06T16:33:43Z,fixed tests,tests/testthat/legacy_tests/test-cov.R;tests/testthat/legacy_tests/test-ctl_manip.R;tests/testthat/legacy_tests/test-nm.R;tests/testthat/legacy_tests/test-run_post.R;tests/testthat/legacy_tests/test-status.R;tests/testthat/test-basic.R,False,True,True,False,11,13,24,"---FILE: tests/testthat/legacy_tests/test-run_post.R---
@@ -17,25 +17,25 @@ test_that(""run and post"",{
     cleanup(proj_name)
   })
 
-  testfilesloc <- file.path(currentwd,""testfiles"")
+  testfilesloc <- file.path(currentwd, ""testfiles"")
   setwd(proj_name)
 
   file.copy(file.path(testfilesloc,"".""),""."",recursive = TRUE)
   file.rename(""cache"", "".cache"")
   
+  overwrite_behaviour(""skip"")
+  
   ## end boiler plate
   ############################
   
   #m1 <- nm(""qpsn -m -c auto -t 60 -- execute run1.mod -dir=1"")
   
   ## dataset procesing
-  
+  browser()
   m1 <- nm(run_id = ""m1"") %>%
     based_on(""staging/Models/run1.mod"") %>%
     cmd(""execute {ctl_name} -dir={run_dir}"")
 
-  stopifnot(in_cache(m1))  ## no point in continue if cache broken
-  
   m1 <- m1 %>% run_nm()
   
   m2 <- m1 %>% child(run_id = ""m2"") %>%
@@ -90,12 +90,11 @@ test_that(""run and post"",{
   itheta1 <- init_theta(m1)
   
   expect_true(!identical(itheta0, itheta1))
-  expect_false(in_cache(m1))
   
   ## last thing to do: clean up run
-  expect_true(all(file.exists(psn_exported_files(m1)[[1]])))
+  expect_true(all(file.exists(NMproject:::psn_exported_files(m1)[[1]])))
   wipe_run(m1)
-  expect_true(all(!file.exists(psn_exported_files(m1)[[1]])))
+  expect_true(all(!file.exists(NMproject:::psn_exported_files(m1)[[1]])))
 
 
 })

---FILE: tests/testthat/test-basic.R---
@@ -19,8 +19,8 @@ test_that(""Project has basic functionality"",{
   })
 
   setwd(proj_name)
-  
-  set_nm_opts()
+
+  NMproject:::set_nm_opts()
   
   cmd_test <- system_nm(""echo test"", intern = TRUE)
   
@@ -29,9 +29,8 @@ test_that(""Project has basic functionality"",{
   options(code_library_path=c(system.file(""extdata/CodeLibrary"",package=""NMproject"")))
   expect_true(length(getOption(""code_library_path""))>0)
   
-  #browser()
-  setup_nm_demo(overwrite = TRUE)
-  expect_true(file.exists(""DerivedData/THEOPP.csv""))
+  setup_nm_demo()
+  expect_true(file.exists(""SourceData/THEOPP.csv""))
 
 })
 
@@ -47,7 +46,7 @@ test_that(""set up"",{
 
   setwd(proj_name)
 
-  set_nm_opts()
+  NMproject:::set_nm_opts()
 
   tmp <- system_nm(""echo test"",intern=TRUE, wait=TRUE)
   expect_true(length(tmp)>0 & ""character"" %in% class(tmp))"
tsahota,NMproject,476f2ba81caea36678ea2e75e040a99f38f42c1c,tarj,tarjinder.z.sahota@gsk.com,2021-03-03T16:24:37Z,tarj,tarjinder.z.sahota@gsk.com,2021-03-03T16:24:37Z,"covariance_result -> covariance_plot, bug fix wait_finish, run_all_scripts + copy demo funs",DESCRIPTION;NAMESPACE;R/NMprojectExtra.R;R/developer_funs.R;R/nm.R;R/sim_reestExtra.R;inst/extdata/CodeLibrary/Scripts/covariance_result.R;inst/extdata/examples/theopp/Scripts/basic_boot.Rmd;inst/extdata/examples/theopp/Scripts/basic_gof.Rmd;inst/extdata/examples/theopp/Scripts/basic_ppc.Rmd;inst/extdata/examples/theopp/Scripts/basic_vpc.Rmd;inst/extdata/examples/theopp/Scripts/s02_model_log.Rmd;inst/extdata/examples/theopp/Scripts/s03_cov_demo_prep.R;inst/extdata/examples/theopp/Scripts/s04_covariate_modelling.Rmd;inst/extdata/examples/theopp/Scripts/starter_ewf.R;inst/extdata/examples/theopp/SourceData/Readme.txt;inst/extdata/examples/theopp/localpackage/DESCRIPTION;inst/extdata/examples/theopp/localpackage/NAMESPACE;inst/extdata/examples/theopp/localpackage/R/AUC.R;inst/extdata/examples/theopp/localpackage/R/localpackage.R;inst/extdata/examples/theopp/localpackage/man/localpackage.Rd;inst/rmarkdown/templates/basic_boot/skeleton/skeleton.Rmd;inst/rmarkdown/templates/basic_boot/template.yaml;inst/rmarkdown/templates/basic_gof/skeleton/skeleton.Rmd;inst/rmarkdown/templates/basic_gof/template.yaml;inst/rmarkdown/templates/basic_ppc/skeleton/skeleton.Rmd;inst/rmarkdown/templates/basic_ppc/template.yaml;inst/rmarkdown/templates/basic_vpc/skeleton/skeleton.Rmd;inst/rmarkdown/templates/basic_vpc/template.yaml;man/copy_demo_to_demo.Rd;man/copy_demo_to_templates.Rd;man/copy_demo_to_test.Rd;man/covariance_plot.Rd;man/wait_finish.Rd,True,True,True,False,392,244,636,"---FILE: DESCRIPTION---
@@ -47,6 +47,7 @@ Collate:
     'NMprojectExtra.R'
     'NMprojectExtraDB.R'
     'NMprojectExtraTest.R'
+    'developer_funs.R'
     'dollar_input.R'
     'insert_addin.R'
     'load_sse.R'

---FILE: NAMESPACE---
@@ -221,7 +221,7 @@ export(cores)
 export(cov_cov_plot)
 export(cov_forest_data)
 export(cov_forest_plot)
-export(covariance_result)
+export(covariance_plot)
 export(covariate_step_tibble)
 export(covariates_define)
 export(ctl_character)
@@ -347,11 +347,13 @@ export(results_dir)
 export(rr)
 export(rr2)
 export(run)
+export(run_all_scripts)
 export(run_dir)
 export(run_dir_path)
 export(run_id)
 export(run_in)
 export(run_nm)
+export(run_nm_batch)
 export(set_simple_field)
 export(setup_nm_demo)
 export(sge_parallel_execute)

---FILE: R/NMprojectExtra.R---
@@ -1915,19 +1915,40 @@ is_successful <- function(r, initial_timeout=NA, na = FALSE) {
 }
 
 
+#' wait for runs to finish
+#' 
+#' blocks subsequent r execution until run(s) are finished
+#' 
+#' @param r nm object
+#' @param timeout numeric seconds to wait before timeout
 #' @export
 wait_finish <- function(r, timeout=NA, force = FALSE){
   UseMethod(""wait_finish"")
 }
 #' @export
-wait_finish.nm_generic <- function(r, timeout=NA, force = FALSE){
-  if(!executed(r) & !force) stop(""run "", unique_id(r), "" not executed. will not wait.\nuse force=TRUE to override"")
+wait_finish.nm_list <- function(r, timeout=NA, force = FALSE){
+  r_orig <- r
+  r <- r[!is_finished(r)]
+  #r <- r[]
+  
+  #if(!force) {
+  #  if(!executed(r)) warning(""run "", unique_id(r), ""not executed, will not wait, use force=TRUE to override"") 
+  #}
   if(is.na(timeout)) wait_for(all(is_finished(r))) else
     wait_for(all(is_finished(r)), timeout = timeout)
-  invisible(r)
+  invisible(r_orig)
 }
+
 #' @export
-wait_finish.nm_list <- wait_finish.nm_generic
+wait_finish.nm_generic <- function(r, timeout=NA, force = FALSE){
+  wait_finish.nm_list(as_nm_list(r), timeout = timeout, force = force)
+}
+
+# wait_finish.nm_list <- function(r, timeout=NA, force = FALSE){
+#   for(ri in r){
+#     wait_finish(ri, timeout = timeout, force = force)
+#   }
+# }
 
 
 #' Show lst file
@@ -5250,12 +5271,12 @@ cov_forest_data <- function(m, covariate_scenarios){
     #   levs <- signif(levs, 2)
     #   lev_text <- paste0(cov,""_"",c(""low5"",""mid"",""upp95""),""_"",levs)
     # }
-    
+
     levs <- dd_first[[cov]]
     if(!""text"" %in% names(covariate_scenarios)){
       lev_text <- paste0(cov, ""_"", levs) 
     } else {
-      if(is.na(dcov_sc$text)) lev_text <- paste0(cov, ""_"", levs) else
+      if(""text"" %in% names(dcov_sc)) lev_text <- paste0(cov, ""_"", levs) else
         lev_text <- dcov_sc$text
     }
 
@@ -6021,7 +6042,9 @@ decision <- function(inputs = c(),
     pause = wait_input(!!decision_inputs_exp)
   )
   
-  outdated <- drake::outdated(drake::drake_config(drpl))
+  drconfig <- drake::drake_config(drpl)
+  
+  outdated <- drake::outdated(drconfig)
 
   ## if up-to-date and pause/outcome is TRUE  
   previous_outcome <- try(drake::readd(""pause""), silent = TRUE)
@@ -6132,7 +6155,7 @@ nm_boot <- function(m, replicates, dboot_rds = ""dboots_big.RDS""){
 #' 
 #' @export
 
-covariance_result <- function(r,trans=TRUE){
+covariance_plot <- function(r,trans=TRUE){
   
   dc <- nm_output_path(r, extn = ""cor"") %>%
     nm_read_table(header = TRUE, skip=1)

---FILE: R/developer_funs.R---
@@ -0,0 +1,95 @@
+#' Copy diagnostic funs to templates
+#' 
+#' Internal function (non exported)
+#'   Use within a demo directory (e.g. after \code{run_all_scripts())})
+
+copy_demo_to_templates <- function(){
+
+  script_files <- dir(scripts_dir(), ""basic_"", full.names = TRUE)
+  
+  template_folder <- tools::file_path_sans_ext(basename(script_files))
+  
+  skeleton_loc <- system.file(""rmarkdown"", ""templates"", template_folder, ""skeleton"", package = ""NMproject"")
+
+  unlink(skeleton_loc, recursive = TRUE, force = TRUE)
+  for(path in skeleton_loc){
+    dir.create(path, recursive = TRUE, showWarnings = FALSE)
+  }
+
+  ## copy script files into template
+  res <- file.copy(script_files, file.path(skeleton_loc, ""skeleton.Rmd""),
+                   overwrite = TRUE)
+  
+  names(res) <- basename(script_files)
+  res
+  
+}
+
+#' Copy demo source files to package
+#' 
+#' Internal function (non exported)
+#'   Use within a demo directory
+
+copy_demo_to_demo <- function(demo = ""theopp""){
+  
+  ## 3 things to handle
+  ##  easy directories - directories that can be copied one to one
+  ##  script directories - only want source scripts (no htmls etc.) transferred
+  ##  staging models - this needs to go to the Models directory in example
+
+   
+  ## non script directories can be copied as is
+  easy_directories <- c(""localpackage"",
+                        ""SourceData"")
+  
+  models_dir <- ""staging/Models""
+  
+  script_files <- dir(scripts_dir())
+  
+  script_files <- script_files[grepl(""\\.R|r(md)?$"", script_files) |
+                                 grepl(""(R|r)eadme"", script_files)]
+  
+  script_files <- file.path(scripts_dir(), script_files)
+  script_files <- relative_path(script_files,
+                                rprojroot::find_root(has_file("".Rprofile"")))
+  
+  destination <- system.file(""extdata"", ""examples"", demo, package = ""NMproject"")
+  unlink(destination, recursive = TRUE, force = TRUE)
+  dir.create(destination, recursive = TRUE, showWarnings = FALSE)
+  
+  ####
+  ## easy directories
+  
+  res1 <- file.copy(easy_directories, destination, recursive = TRUE, overwrite = TRUE)
+  names(res1) <- easy_directories
+  
+  ####
+  ## script directories
+
+  destination_files <- file.path(destination, script_files)
+  
+  dir.create(file.path(destination, ""Scripts""), recursive = TRUE, showWarnings = FALSE)
+  res2 <- file.copy(script_files, destination_files, overwrite = TRUE)
+  names(res2) <- script_files
+  
+  ####
+  ## staging/Models
+  dir.create(file.path(destination, ""Models""), recursive = TRUE, showWarnings = FALSE)
+  res3 <- file.copy(""staging/Models"", destination, recursive = TRUE, overwrite = TRUE)
+  names(res3) <- ""staging/Models""
+  
+  c(res1, res2, res3)
+}
+
+#' Copy demo source files + relevant NM outputs to package testfiles
+#' 
+#' Internal function (non exported)
+#'   Use within a demo directory
+
+copy_demo_to_test <- function(){
+  
+  ## copy staging as is (i.e. to staging)
+  ## 
+  
+  browser()
+}
\ No newline at end of file

---FILE: R/nm.R---
@@ -344,6 +344,28 @@ setup_nm_demo <- function(demo_name=""theopp"",
 
 }
 
+#' @export
+run_all_scripts <- function(){
+  #browser()
+  script_files <- dir(scripts_dir(), ""s[0-9]+_.*?\\.R(md)?$"", full.names = TRUE)
+  
+  dplan <- tibble::tibble(script_files) %>%
+    dplyr::mutate(rmd = grepl(""\\.Rmd"", .data$script_files))
+  
+  dplan <- dplan %>%
+    dplyr::mutate(
+      cmd = ifelse(rmd, 
+                   paste0(""rmarkdown::render(\"""",script_files,""\"")""),
+                   paste0(""source(\"""",script_files,""\"")""))
+    )
+  
+  exprs <- rlang::parse_exprs(dplan$cmd)
+  
+  res <- lapply(exprs, rlang::eval_tidy)
+  
+}
+
+
 #' Get NONMEM output tables
 #'
 #' This combines $TABLE output with the input data, allowing text columns to be retained for plotting/summaries.

---FILE: R/sim_reestExtra.R---
@@ -39,17 +39,18 @@ by_row_df <- function(.data, .f, .apply_fun=lapply, ...) {
   d
 }
 
+#' @export
 run_nm_batch <- function(m, threads = 10, ...){
   runs_remaining <- seq_along(m)
   while(length(runs_remaining) > 0){
     n_to_take <- min(threads, length(runs_remaining))
     runs_to_run <- runs_remaining[seq_len(n_to_take)]
-    sub_m <- lapply(runs_to_run, function(x) m[[x]])
-    run_nm(sub_m, ...)
+    m_sub <- m[runs_to_run]
+    run_nm(m_sub, ...)
     runs_remaining <- setdiff(runs_remaining, runs_to_run)
-    do.call(wait_for_finished, sub_m)
+    if(length(runs_remaining) > 0) wait_finish(m_sub)
   }
-  Sys.sleep(10) ## this shouldn't be needed, soemthing weird going on with wait_for_finished?
+  m
 }
 
 #' Prepare forward covariate step

---FILE: inst/extdata/CodeLibrary/Scripts/covariance_result.R---
@@ -1,84 +0,0 @@
-## Author: klgk669
-## First created: 2018-03-20
-## Description: Display $COV results
-## Keywords: 
-
-########################################
-## load packages and source functions here
-
-library(NMproject)
-library(ggplot2)
-source(""Scripts/read.table.nm.R"")
-
-
-########################################
-## main script here
-
-covariance_result <- function(r,trans=TRUE){
-  dc <- read.table.nm(r$output$psn.cor,header = TRUE,skip=1)
-  
-  names(dc)[1] <- ""Var1""
-  dc$Var1 <- names(dc)[-1]
-  
-  n_ests <- nrow(dc)/length(unique(dc$Var1))
-  
-  dc$EST.NO <- rep(1:n_ests,each=length(unique(dc$Var1)))
-  dc <- dc %>% dplyr::filter(EST.NO == max(EST.NO))
-  dc$EST.NO <- NULL
-  
-  dc <- dc %>% tidyr::gather(key = ""Var2"", value=""value"",-Var1)
-  
-  dc$Var1 <- factor(dc$Var1)
-  dc$Var2 <- factor(dc$Var2)
-  
-  if(trans){
-    dp <- r$param_info
-    current_levels <- levels(dc$Var1)
- 
-  dl <- data.frame(cl = current_levels)
-    dl$ORD <- 1:nrow(dl)
-    dp <- dp[,c(""Name"",""Parameter"")]
-    names(dp)[2] <- ""cl""
-    dl <- merge(dp,dl,all = TRUE)
-    dl$new_names <- dl$cl
-    dl$new_names[!is.na(dl$Name)] <- paste0(dl$Name[!is.na(dl$Name)],"" ("",
-                                            dl$cl[!is.na(dl$Name)],"")"")
-    levels(dc$Var1) <- dl$new_names
-    levels(dc$Var2) <- dl$new_names
-    
-  }
-  
-  dc <- dc %>% dplyr::filter(!value %in% 0)
-  dc <- dc %>% dplyr::filter(as.numeric(Var1) > as.numeric(Var2)) ## lower corner
-  
-  p <- ggplot(dc, aes(x= Var1, y= Var2, fill = value)) + theme_bw() +
-    geom_tile() + 
-    scale_fill_gradient2(low = ""blue"", high = ""red"", mid = ""white"", 
-                         midpoint = 0, limit = c(-1,1), space = ""Lab"", 
-                         name=""Correlation"") +
-    geom_text(aes(label = round(value,2))) +
-    theme(axis.text.x  = element_text(angle=90,vjust=0))
-  
-  file_name <- paste0(""Results/covariance_plot_"",basename(r$ctl),"".pdf"")
-  pdf(file_name,width = 7,height=5)
-  print(p)
-  dev.off()
-  
-  return(file_name)
-  
-}
-
-
-cov_matrix_nm <- function(r){
-  source(""Scripts/read.table.nm.R"")
-  dc <- read.table.nm(r$output$psn.cov,header = TRUE,skip=1)
-  par_names <- names(dc)[-1]
-  dc <- dc[,-1]
-  
-  nvars <- ncol(dc)
-  dc <- dc[(nrow(dc)-nvars+1):nrow(dc),]
-  
-  dc <- as.matrix(dc)
-  row.names(dc) <- par_names
-  dc
-}

---FILE: inst/extdata/examples/theopp/Scripts/basic_boot.Rmd---
@@ -26,7 +26,7 @@ params:
 <!--   4. use nm_render() to run on other model objects -->
 
 
-```{r setup, include=F}
+```{r setup2, include=F}
 ## DO NOT MODIFY THIS BLOCK (unless you know what you're doing)
 library(rprojroot)
 library(knitr)
@@ -38,13 +38,12 @@ if(!is.null(knitr::opts_knit$get('rmarkdown.pandoc.to'))){
 }
 ```
 
-```{r}
+```{r lib_load}
 library(NMproject)
 library(dplyr)
-library(ggplot2)
 ```
 
-## completion summary
+## model object
 
 ```{r wait_for_run_finish}
 #wait_finish(.m)
@@ -58,21 +57,11 @@ m_parent <- parent_run(m_finished[1])
 
 ```
 
-```{r}
-
-m_finished_summary <- m_finished %>% summary_wide()
-
-m_finished_summary %>%
-  ggplot(aes(x = ofv)) + theme_bw() +
-  geom_histogram()
-
-```
-
-## original parent result for context
+## parent results for context
 
 This can be made better later
 
-```{r}
+```{r rr}
 
 m_parent %>% rr()
 
@@ -81,45 +70,29 @@ m_parent %>% rr()
 
 ## results
 
-```{r}
+```{r boot_basic_summary}
 
 m_finished %>%
   coef() %>%
   bind_rows() %>%
   group_by(parameter) %>%
   summarise(low=quantile(FINAL,probs=0.025),
             med=median(FINAL),
-            upp=quantile(FINAL,probs=0.975),
-            mean = mean(FINAL),
-            se = sd(FINAL),
-            rse = 100*sd(FINAL)/mean(FINAL))
-
-```
-
-### stability plot with worst replicate (by ofv)
-
-```{r}
-
-try({
-  m_finished_summary %>%
-    arrange(desc(ofv)) %>%
-    {.$m[1]} %>%
-    plot_iter()
-})
+            upp=quantile(FINAL,probs=0.975))
 
 ```
 
 ## Appendix
 
 ### original control file
 
-```{r}
+```{r txt}
 m_parent %>% text() %>% dplyr::first()
 ```
 
-### original control file diff
+### control file diff
 
-```{r}
+```{r diff}
 m_parent %>% nm_diff()
 ```
 

---FILE: inst/extdata/examples/theopp/Scripts/basic_gof.Rmd---
@@ -24,7 +24,7 @@ date: ""`r Sys.time()`""
 <!--   4. use nm_render() to run on other model objects -->
 
 
-```{r setup, include=F}
+```{r setup2, include=F}
 ## DO NOT MODIFY THIS BLOCK (unless you know what you're doing)
 library(rprojroot)
 library(knitr)
@@ -36,7 +36,7 @@ if(!is.null(knitr::opts_knit$get('rmarkdown.pandoc.to'))){
 }
 ```
 
-```{r echo=FALSE,message=FALSE}
+```{r lib_load, echo=FALSE,message=FALSE}
 ## LOAD PACKAGES HERE
 
 library(dplyr)
@@ -55,19 +55,26 @@ wait_finish(.m)
 
 ## convergence
 
-```{r}
+```{r plot_iter}
 plot_iter(.m)
 ```
 
 ## outputs
 
-```{r}
+```{r rr}
 rr(.m)
 ```
 
 ## Diagnostics
 
-```{r}
+```{r cov_plot}
+
+covariance_plot(.m)
+
+```
+
+
+```{r ggplot}
 
 ## simple ggplot example
 
@@ -82,7 +89,7 @@ library(ggplot2)
 
 ```
 
-```{r, warning=FALSE}
+```{r xpose_plot, warning=FALSE}
 
 ## simple xpose example
 
@@ -98,13 +105,13 @@ dv_vs_pred(xpdb)
 
 ### control file
 
-```{r}
+```{r txt}
 .m %>% text() %>% dplyr::first()
 ```
 
 ### control file diff
 
-```{r}
+```{r diff}
 .m %>% nm_diff()
 ```
 

---FILE: inst/extdata/examples/theopp/Scripts/basic_ppc.Rmd---
@@ -24,7 +24,7 @@ date: ""`r Sys.time()`""
 <!--   4. use nm_render() to run on other model objects -->
 
 
-```{r setup, include=F}
+```{r setup2, include=F}
 ## DO NOT MODIFY THIS BLOCK (unless you know what you're doing)
 library(rprojroot)
 library(knitr)
@@ -36,7 +36,7 @@ if(!is.null(knitr::opts_knit$get('rmarkdown.pandoc.to'))){
 }
 ```
 
-```{r echo=FALSE,message=FALSE}
+```{r lib_load, echo=FALSE,message=FALSE}
 ## LOAD PACKAGES HERE
 
 library(dplyr)
@@ -53,7 +53,7 @@ wait_finish(.m)
 .m
 ```
 
-```{r}
+```{r fun_def}
 
 idEXPstat <- function(d, ...){ ## example statistic function
   ## arg = nonmem dataset data.frame
@@ -85,7 +85,7 @@ EXPstat <- function(d, ...){ ## example statistic function
 
 ## plot profile of this subset
 
-```{r}
+```{r plot_profile}
 
 d <- .m %>%
   input_data(filter = TRUE)
@@ -97,7 +97,7 @@ d %>% mutate(id_period = paste(ID, TIME)) %>%
 ```
 
 
-```{r}
+```{r ppc_plot_basic}
 
 ppc_data0 <- .m %>% ppc_data(EXPstat)
 
@@ -115,7 +115,7 @@ ppc_data0 %>%
 
 ```
 
-```{r}
+```{r ppc_plot_strat}
 
 addWT_c <- . %>% mutate(
   WT_c = Hmisc::cut2(WT, g = 2)
@@ -148,7 +148,7 @@ ppc_data0 %>%
 
 ```
 
-```{r}
+```{r ppc_plot_ind}
 
 ppc_data0 <- .m %>% ppc_data(idEXPstat)
 

---FILE: inst/extdata/examples/theopp/Scripts/basic_vpc.Rmd---
@@ -24,7 +24,7 @@ date: ""`r Sys.time()`""
 <!--   4. use nm_render() to run on other model objects -->
 
 
-```{r setup, include=F}
+```{r setup2, include=F}
 ## DO NOT MODIFY THIS BLOCK (unless you know what you're doing)
 library(rprojroot)
 library(knitr)
@@ -36,7 +36,7 @@ if(!is.null(knitr::opts_knit$get('rmarkdown.pandoc.to'))){
 }
 ```
 
-```{r echo=FALSE,message=FALSE}
+```{r lib_load, echo=FALSE,message=FALSE}
 ## LOAD PACKAGES HERE
 
 library(dplyr)
@@ -55,7 +55,7 @@ wait_finish(.m)
 
 ## VPC
 
-```{r}
+```{r vpc_data}
 
 library(vpc)
 
@@ -89,7 +89,7 @@ sim$DV <- sim$DV_OUT  ## needed because output_table puts DV in DV_OUT
 ```
 
 
-```{r}
+```{r vpc_basic}
 
 vpc(
   sim = sim,
@@ -101,7 +101,7 @@ vpc(
 
 ## prediction corrected
 
-```{r}
+```{r pred_corr}
 
 vpc(
   sim = sim,
@@ -115,7 +115,7 @@ vpc(
 
 ## stratified by bodyweight
 
-```{r}
+```{r bwt_strat}
 
 sim$WT_c = Hmisc::cut2(sim$WT, g = 2)
 obs$WT_c = Hmisc::cut2(obs$WT, g = 2)
@@ -133,7 +133,7 @@ vpc(
 
 ### control file
 
-```{r}
+```{r txt}
 .m %>% text() %>% dplyr::first()
 ```
 

---FILE: inst/extdata/examples/theopp/Scripts/s02_model_log.Rmd---
@@ -91,30 +91,24 @@ kable(rr(c(m2, m2WT)))
 
 ```
 
-### example bootstrap
-
 ```{r}
 m1_boot <- m1 %>% 
-  make_boot_datasets(samples = 10, overwrite = TRUE)
+  make_boot_datasets(samples = 5, overwrite = TRUE)
 
 m1_boot$m <- m1_boot$m %>% run_nm()
+wait_finish(m1_boot$m)
 
 m1_boot$m %>% nm_list_render(""Scripts/basic_boot.Rmd"")
 
-```
-
-### example bootstrap cross-validation
-
-```{r}
-
 m1_xv <- m1_boot %>% 
   make_xv_datasets() %>%
   mutate(m_xv = m_xv %>%
            update_parameters(m1_boot$m) %>%
            dollar(""EST"",
                   ""$EST METHOD=IMP INTER EONLY= 1 MAPITER=0 ISAMPLE = 2000 NITER = 10 RANMETHOD=3S2 NOABORT PRINT=1 NSIG=3 SIGL=9""))
 
-m1_xv$m_xv %>% run_nm()
+m1_xv$m_xv <- m1_xv$m_xv %>% run_nm()
+wait_finish(m1_xv$m_xv)
 
 m1_xv$m_xv %>% 
   subset(status(.) %in% ""finished"") %>% 
@@ -123,3 +117,4 @@ m1_xv$m_xv %>%
 
 ```
 
+

---FILE: inst/extdata/examples/theopp/Scripts/s03_cov_demo_prep.R---
@@ -1,4 +1,6 @@
 ## Copied from staging/Scripts/s03_cov_demo_prep.R
+##  (2021-03-02 13:53:56) by tarjinde
+## Copied from staging/Scripts/s03_cov_demo_prep.R
 ##  (2020-12-12 14:44:54) by tarjinde
 ## Copied from staging/Scripts/prep_cov_test.R
 ##  (2020-04-22 19:27:40) by klgk669

---FILE: inst/extdata/examples/theopp/Scripts/s04_covariate_modelling.Rmd---
@@ -36,10 +36,10 @@ load_localpackage()
 
 ```{r message=FALSE, results='hide'}
 
-c1 <- new_nm(run_id = ""c1"",
-             based_on = ""staging/Models/run1.mod"",
-             data_path = ""DerivedData/THEOPcov1.csv"") %>%
-  cmd(""execute {ctl_name} -dir={run_dir}"") %>%
+m1 <- readRDS(""Results/m1.RDS"")
+
+c1 <- m1 %>% child(""c1"") %>%
+  data_path(""DerivedData/THEOPcov1.csv"") %>%
   fill_input() %>%
   run_nm()
 
@@ -53,7 +53,7 @@ c1 %>% saveRDS(""Results/base_model_pk.RDS"")
 ```{r}
 dtest <- test_relations(param = c(""KA"", ""K"", ""V""),
                         cov = c(""LIN1"", ""LIN2"", ""LIN3"", ""RND1"", ""RND2"", ""RND3""), 
-                        state = c(""linear"", ""power""), 
+                        state = c(""power""), 
                         continuous = TRUE) %>%
   test_relations(param = c(""KA"", ""K"", ""V""),
                  cov = ""BN1"",
@@ -74,7 +74,9 @@ dsc1 <- c1 %>% covariate_step_tibble(
   direction = ""forward""
 )
 
-dsc1$m <- dsc1$m %>% run_nm()
+dsc1$m <- dsc1$m %>% run_nm_batch(threads = 1)
+
+wait_finish(dsc1$m)
 
 dsc1 <- dsc1 %>% bind_covariate_results()
 
@@ -107,7 +109,11 @@ dsc2 <- c1_f1 %>% covariate_step_tibble(
   direction = ""forward""
 )
 
-dsc2$m <- dsc2$m %>% run_nm()
+dsc2$m <- dsc2$m %>% run_nm_batch(threads = 1)
+
+#dsc2$m <- dsc2$m %>% run_nm()
+
+wait_finish(dsc2$m)
 
 dsc2 <- dsc2 %>% bind_covariate_results()
 
@@ -121,7 +127,7 @@ dsc1$m[1:3] %>% nm_render(""Scripts/basic_gof.Rmd"")
 
 c1_f2 <- dsc2$m[1]
 
-stopifnot(run_id(c1_f2) == ""c1_f2_KA_LIN1_power"")
+stopifnot(run_id(c1_f2) == ""c1_f2_V_LIN2_power"")
 
 ```
 
@@ -138,7 +144,9 @@ dsc3 <- c1_f2 %>% covariate_step_tibble(
   direction = ""backward""
 )
 
-dsc3$m <- dsc3$m %>% run_nm()
+dsc3$m <- dsc3$m %>% run_nm_batch(threads = 1)
+
+wait_finish(dsc3$m)
 
 dsc3 <- dsc3 %>% bind_covariate_results()
 ```
@@ -147,7 +155,6 @@ dsc3 <- dsc3 %>% bind_covariate_results()
 
 kable(dsc3 %>% select(-m, -location))
 
-
 ```
 
 Both covariates still significant. End of covariate testing
@@ -167,7 +174,22 @@ saveRDS(final_model, ""Results/final_model_pk.RDS"")
 
 ```{r}
 
-dplot <- final_model %>% cov_forest_data
+cov_scenarios <- final_model %>% 
+  input_data() %>% 
+  select(ID, LIN1, LIN2) %>%
+  unique() %>%
+  tidyr::gather(key = ""cov"", value = ""value"", LIN1:LIN2) %>%
+  group_by(cov) %>%
+  summarise(low = quantile(value, probs = 0.05),
+            mid = quantile(value, probs = 0.50),
+            upp = quantile(value, probs = 0.95)) %>%
+  tidyr::gather(key = ""type"", value = ""value"", low:upp) %>%
+  mutate(text = paste(cov, type, sep = ""_""))
+
+
+dplot <- final_model %>% 
+  cov_forest_data(cov_scenarios)
+
 dplot %>% cov_forest_plot()
 
 ```
@@ -185,7 +207,7 @@ final_model %>% param_cov_diag(param = ""KA"", cov = ""LIN1"", categorical = FALSE)
 ```{r message=FALSE, results='hide'}
 
 final_model_sim <- final_model %>% child(""m1s"") %>%
-  update_parameters(m1) %>%
+  update_parameters(final_model) %>%
   convert_to_simulation(subpr = 20) %>%
   run_nm()
 
@@ -195,7 +217,7 @@ final_model_sim <- final_model %>% child(""m1s"") %>%
 
 ```{r}
 
-EXPstat <- function(d){ ## example statistic function
+EXPstat <- function(d, ...){ ## example statistic function
   ## arg = nonmem dataset data.frame 
   ## return data.frame with statistic column
 
@@ -224,7 +246,7 @@ EXPstat <- function(d){ ## example statistic function
 Basic whisker plot - with 2 factors
 
 ```{r}
-dppc <- d$m %>% ppc_data(EXPstat)
+dppc <- final_model_sim %>% ppc_data(EXPstat)
 dppc %>% ppc_whisker_plot(type, LIN1_bin, LIN3_bin)
 ```
 
@@ -248,7 +270,7 @@ pre_proc <- function(d){
   d
 }
 
-dppc <- d$m %>% ppc_data(
+dppc <- final_model_sim %>% ppc_data(
   EXPstat, pre_proc = pre_proc
 )
 

---FILE: inst/extdata/examples/theopp/Scripts/starter_ewf.R---
@@ -1,4 +1,6 @@
 ## Copied from staging/Scripts/starter_ewf.R
+##  (2021-03-02 13:53:56) by tarjinde
+## Copied from staging/Scripts/starter_ewf.R
 ##  (2020-04-22 19:23:42) by klgk669
 #  set up .libPaths() to find the PoC version of the ewfutils library
 .libPaths( c( ""/opt/scp/services/ewfscp/software/ewfutils-2.0-poc/libraries/R"", .libPaths()) )

---FILE: inst/extdata/examples/theopp/SourceData/Readme.txt---
@@ -0,0 +1 @@
+This directory is for unmodified source datasets.  Data in this directory should not be modified.

---FILE: inst/extdata/examples/theopp/localpackage/DESCRIPTION---
@@ -0,0 +1,13 @@
+Package: localpackage
+Title: An optional package for storing functions specific to this analysis
+Version: 0.0.0.9000
+Authors@R: person(""First"", ""Last"", email = ""first.last@example.com"", role = c(""aut"", ""cre""))
+Description:
+  If you have functions, you can store them in the R directory.
+  They can then be loaded with devtools::load_all(""localpackage"")
+  Roxygen can be used to 
+Depends: R (>= 3.4.1)
+License: What license is it under?
+Encoding: UTF-8
+LazyData: true
+RoxygenNote: 7.1.0

---FILE: inst/extdata/examples/theopp/localpackage/NAMESPACE---
@@ -0,0 +1,2 @@
+# Generated by roxygen2: do not edit by hand
+

---FILE: inst/extdata/examples/theopp/localpackage/R/AUC.R---
@@ -1,4 +1,6 @@
 ## Copied from staging/localpackage/R/AUC.R
+##  (2021-03-02 13:53:56) by tarjinde
+## Copied from staging/localpackage/R/AUC.R
 ##  (2020-04-03 18:18:14) by klgk669
 ## Copied from /home/klgk669/poppk_20180926_pk-eff-ae-interim2/Scripts/AUC.R
 ##  (2019-01-23 14:32:02) by klgk669

---FILE: inst/extdata/examples/theopp/localpackage/R/localpackage.R---
@@ -0,0 +1,14 @@
+#' Local package
+#' 
+#' This is a package local to only this project
+#' 
+#' @name localpackage
+#' @examples 
+#' \dontrun{
+#' 
+#' ## load functions with:
+#' load_localpackage()
+#' 
+#' }
+
+NULL

---FILE: inst/extdata/examples/theopp/localpackage/man/localpackage.Rd---
@@ -0,0 +1,16 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/localpackage.R
+\name{localpackage}
+\alias{localpackage}
+\title{Local package}
+\description{
+This is a package local to only this project
+}
+\examples{
+\dontrun{
+
+## load functions with:
+load_localpackage()
+
+}
+}

---FILE: inst/rmarkdown/templates/basic_boot/skeleton/skeleton.Rmd---
@@ -26,7 +26,7 @@ params:
 <!--   4. use nm_render() to run on other model objects -->
 
 
-```{r setup, include=F}
+```{r setup2, include=F}
 ## DO NOT MODIFY THIS BLOCK (unless you know what you're doing)
 library(rprojroot)
 library(knitr)
@@ -38,13 +38,12 @@ if(!is.null(knitr::opts_knit$get('rmarkdown.pandoc.to'))){
 }
 ```
 
-```{r}
+```{r lib_load}
 library(NMproject)
 library(dplyr)
-library(ggplot2)
 ```
 
-## completion summary
+## model object
 
 ```{r wait_for_run_finish}
 #wait_finish(.m)
@@ -58,21 +57,11 @@ m_parent <- parent_run(m_finished[1])
 
 ```
 
-```{r}
-
-m_finished_summary <- m_finished %>% summary_wide()
-
-m_finished_summary %>%
-  ggplot(aes(x = ofv)) + theme_bw() +
-  geom_histogram()
-
-```
-
-## original parent result for context
+## parent results for context
 
 This can be made better later
 
-```{r}
+```{r rr}
 
 m_parent %>% rr()
 
@@ -81,45 +70,29 @@ m_parent %>% rr()
 
 ## results
 
-```{r}
+```{r boot_basic_summary}
 
 m_finished %>%
   coef() %>%
   bind_rows() %>%
   group_by(parameter) %>%
   summarise(low=quantile(FINAL,probs=0.025),
             med=median(FINAL),
-            upp=quantile(FINAL,probs=0.975),
-            mean = mean(FINAL),
-            se = sd(FINAL),
-            rse = 100*sd(FINAL)/mean(FINAL))
-
-```
-
-### stability plot with worst replicate (by ofv)
-
-```{r}
-
-try({
-  m_finished_summary %>%
-    arrange(desc(ofv)) %>%
-    {.$m[1]} %>%
-    plot_iter()
-})
+            upp=quantile(FINAL,probs=0.975))
 
 ```
 
 ## Appendix
 
 ### original control file
 
-```{r}
+```{r txt}
 m_parent %>% text() %>% dplyr::first()
 ```
 
-### original control file diff
+### control file diff
 
-```{r}
+```{r diff}
 m_parent %>% nm_diff()
 ```
 

---FILE: inst/rmarkdown/templates/basic_gof/skeleton/skeleton.Rmd---
@@ -24,7 +24,7 @@ date: ""`r Sys.time()`""
 <!--   4. use nm_render() to run on other model objects -->
 
 
-```{r setup, include=F}
+```{r setup2, include=F}
 ## DO NOT MODIFY THIS BLOCK (unless you know what you're doing)
 library(rprojroot)
 library(knitr)
@@ -36,31 +36,45 @@ if(!is.null(knitr::opts_knit$get('rmarkdown.pandoc.to'))){
 }
 ```
 
-```{r}
-library(NMproject)
+```{r lib_load, echo=FALSE,message=FALSE}
+## LOAD PACKAGES HERE
+
+library(dplyr)
+library(ggplot2)
+
+load_localpackage()
+
 ```
 
 ## model object
 
 ```{r wait_for_run_finish}
 wait_finish(.m)
+.m
 ```
 
 ## convergence
 
-```{r}
+```{r plot_iter}
 plot_iter(.m)
 ```
 
 ## outputs
 
-```{r}
+```{r rr}
 rr(.m)
 ```
 
 ## Diagnostics
 
-```{r}
+```{r cov_plot}
+
+covariance_plot(.m)
+
+```
+
+
+```{r ggplot}
 
 ## simple ggplot example
 
@@ -75,7 +89,7 @@ library(ggplot2)
 
 ```
 
-```{r, warning=FALSE}
+```{r xpose_plot, warning=FALSE}
 
 ## simple xpose example
 
@@ -91,13 +105,13 @@ dv_vs_pred(xpdb)
 
 ### control file
 
-```{r}
+```{r txt}
 .m %>% text() %>% dplyr::first()
 ```
 
 ### control file diff
 
-```{r}
+```{r diff}
 .m %>% nm_diff()
 ```
 

---FILE: inst/rmarkdown/templates/basic_ppc/skeleton/skeleton.Rmd---
@@ -24,7 +24,7 @@ date: ""`r Sys.time()`""
 <!--   4. use nm_render() to run on other model objects -->
 
 
-```{r setup, include=F}
+```{r setup2, include=F}
 ## DO NOT MODIFY THIS BLOCK (unless you know what you're doing)
 library(rprojroot)
 library(knitr)
@@ -36,7 +36,7 @@ if(!is.null(knitr::opts_knit$get('rmarkdown.pandoc.to'))){
 }
 ```
 
-```{r echo=FALSE,message=FALSE}
+```{r lib_load, echo=FALSE,message=FALSE}
 ## LOAD PACKAGES HERE
 
 library(dplyr)
@@ -53,7 +53,7 @@ wait_finish(.m)
 .m
 ```
 
-```{r}
+```{r fun_def}
 
 idEXPstat <- function(d, ...){ ## example statistic function
   ## arg = nonmem dataset data.frame
@@ -85,7 +85,7 @@ EXPstat <- function(d, ...){ ## example statistic function
 
 ## plot profile of this subset
 
-```{r}
+```{r plot_profile}
 
 d <- .m %>%
   input_data(filter = TRUE)
@@ -97,7 +97,7 @@ d %>% mutate(id_period = paste(ID, TIME)) %>%
 ```
 
 
-```{r}
+```{r ppc_plot_basic}
 
 ppc_data0 <- .m %>% ppc_data(EXPstat)
 
@@ -115,7 +115,7 @@ ppc_data0 %>%
 
 ```
 
-```{r}
+```{r ppc_plot_strat}
 
 addWT_c <- . %>% mutate(
   WT_c = Hmisc::cut2(WT, g = 2)
@@ -148,7 +148,7 @@ ppc_data0 %>%
 
 ```
 
-```{r}
+```{r ppc_plot_ind}
 
 ppc_data0 <- .m %>% ppc_data(idEXPstat)
 

---FILE: inst/rmarkdown/templates/basic_vpc/skeleton/skeleton.Rmd---
@@ -24,7 +24,7 @@ date: ""`r Sys.time()`""
 <!--   4. use nm_render() to run on other model objects -->
 
 
-```{r setup, include=F}
+```{r setup2, include=F}
 ## DO NOT MODIFY THIS BLOCK (unless you know what you're doing)
 library(rprojroot)
 library(knitr)
@@ -36,7 +36,7 @@ if(!is.null(knitr::opts_knit$get('rmarkdown.pandoc.to'))){
 }
 ```
 
-```{r echo=FALSE,message=FALSE}
+```{r lib_load, echo=FALSE,message=FALSE}
 ## LOAD PACKAGES HERE
 
 library(dplyr)
@@ -55,7 +55,7 @@ wait_finish(.m)
 
 ## VPC
 
-```{r}
+```{r vpc_data}
 
 library(vpc)
 
@@ -89,7 +89,7 @@ sim$DV <- sim$DV_OUT  ## needed because output_table puts DV in DV_OUT
 ```
 
 
-```{r}
+```{r vpc_basic}
 
 vpc(
   sim = sim,
@@ -101,7 +101,7 @@ vpc(
 
 ## prediction corrected
 
-```{r}
+```{r pred_corr}
 
 vpc(
   sim = sim,
@@ -115,7 +115,7 @@ vpc(
 
 ## stratified by bodyweight
 
-```{r}
+```{r bwt_strat}
 
 sim$WT_c = Hmisc::cut2(sim$WT, g = 2)
 obs$WT_c = Hmisc::cut2(obs$WT, g = 2)
@@ -133,7 +133,7 @@ vpc(
 
 ### control file
 
-```{r}
+```{r txt}
 .m %>% text() %>% dplyr::first()
 ```
 

---FILE: man/copy_demo_to_demo.Rd---
@@ -0,0 +1,12 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/developer_funs.R
+\name{copy_demo_to_demo}
+\alias{copy_demo_to_demo}
+\title{Copy demo source files to package}
+\usage{
+copy_demo_to_demo(demo = ""theopp"")
+}
+\description{
+Internal function (non exported)
+  Use within a demo directory
+}

---FILE: man/copy_demo_to_templates.Rd---
@@ -0,0 +1,12 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/developer_funs.R
+\name{copy_demo_to_templates}
+\alias{copy_demo_to_templates}
+\title{Copy diagnostic funs to templates}
+\usage{
+copy_demo_to_templates()
+}
+\description{
+Internal function (non exported)
+  Use within a demo directory (e.g. after \code{run_all_scripts())})
+}

---FILE: man/copy_demo_to_test.Rd---
@@ -0,0 +1,12 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/developer_funs.R
+\name{copy_demo_to_test}
+\alias{copy_demo_to_test}
+\title{Copy demo source files + relevant NM outputs to package testfiles}
+\usage{
+copy_demo_to_test()
+}
+\description{
+Internal function (non exported)
+  Use within a demo directory
+}

---FILE: man/covariance_plot.Rd---
@@ -1,10 +1,10 @@
 % Generated by roxygen2: do not edit by hand
 % Please edit documentation in R/NMprojectExtra.R
-\name{covariance_result}
-\alias{covariance_result}
+\name{covariance_plot}
+\alias{covariance_plot}
 \title{Plot covariance matrix}
 \usage{
-covariance_result(r, trans = TRUE)
+covariance_plot(r, trans = TRUE)
 }
 \arguments{
 \item{r}{nm object}

---FILE: man/wait_finish.Rd---
@@ -0,0 +1,16 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/NMprojectExtra.R
+\name{wait_finish}
+\alias{wait_finish}
+\title{wait for runs to finish}
+\usage{
+wait_finish(r, timeout = NA, force = FALSE)
+}
+\arguments{
+\item{r}{nm object}
+
+\item{timeout}{numeric seconds to wait before timeout}
+}
+\description{
+blocks subsequent r execution until run(s) are finished
+}"
tsahota,NMproject,e0a2865db2f1283790b6fd998fc87fb204507ab6,tarj,tarjinder.z.sahota@gsk.com,2021-02-28T22:32:07Z,tarj,tarjinder.z.sahota@gsk.com,2021-02-28T22:32:07Z,bug fix nm_list_render + improved bootstrap template,R/NMprojectExtra.R;inst/extdata/examples/theopp/Scripts/basic_boot.Rmd;inst/extdata/examples/theopp/Scripts/s02_model_log.Rmd;inst/rmarkdown/templates/nm_boot/skeleton/skeleton.Rmd,True,True,True,False,71,15,86,"---FILE: R/NMprojectExtra.R---
@@ -4413,7 +4413,7 @@ nm_render.nm_generic <- function(m,
   } else {
     rmarkdown::render(input = input,
                       output_file = output_file,
-                      output_dir = results_dir(m),
+                      output_dir = output_dir,
                       params = args,
                       envir = new.env(),
                       ...)
@@ -4467,22 +4467,24 @@ nm_list_render <- function(m,
   output_dir <- parent_results_dir(m[1])
   output_path <- file.path(output_dir, output_file)
   
+  m_parent <- as_nm_generic(parent_run(m[1]))
+  
   ## if force is TRUE skip caching and run
   if(!force){
     ## if output_path doesn't exist skip caching and run
     ##if(file.exists(output_path)){
     ## pull existing checksum info
-    render_cache_disk <- lapply(render_cache_paths(m, input), readRDS)
+    render_cache_disk <- lapply(render_cache_paths(m_parent, input), readRDS)
     if(length(render_cache_disk) > 0){
       ## get current checksum
-      current_checksums <- render_checksums(m, input)
+      current_checksums <- render_checksums(m_parent, input)
       ## determine matches
       matches <- sapply(render_cache_disk, function(i) {
         identical(i$checksums, current_checksums)
       })
       if(any(matches)){
-        message(""nm_render cache found, skipping... use nm_render(force = TRUE) to override"")
-        m <- m %>% result_files(output_file)
+        message(""nm_list_render cache found, skipping... use nm_list_render(force = TRUE) to override"")
+        #m <- m_parent %>% result_files(output_file)
         return(invisible(m))    ## if up to date, skip
       }
     } 
@@ -4511,7 +4513,7 @@ nm_list_render <- function(m,
   ## use as_nm_generic incase m is redefined in rmd
   #m <- m %>% result_files(output_file)
   
-  as_nm_generic(parent_run(m[1])) %>% save_render_cache(input)
+  m_parent %>% save_render_cache(input)
   
   invisible(m)
 }

---FILE: inst/extdata/examples/theopp/Scripts/basic_boot.Rmd---
@@ -41,9 +41,10 @@ if(!is.null(knitr::opts_knit$get('rmarkdown.pandoc.to'))){
 ```{r}
 library(NMproject)
 library(dplyr)
+library(ggplot2)
 ```
 
-## model object
+## completion summary
 
 ```{r wait_for_run_finish}
 #wait_finish(.m)
@@ -57,7 +58,17 @@ m_parent <- parent_run(m_finished[1])
 
 ```
 
-## parent results for context
+```{r}
+
+m_finished_summary <- m_finished %>% summary_wide()
+
+m_finished_summary %>%
+  ggplot(aes(x = ofv)) + theme_bw() +
+  geom_histogram()
+
+```
+
+## original parent result for context
 
 This can be made better later
 
@@ -78,7 +89,23 @@ m_finished %>%
   group_by(parameter) %>%
   summarise(low=quantile(FINAL,probs=0.025),
             med=median(FINAL),
-            upp=quantile(FINAL,probs=0.975))
+            upp=quantile(FINAL,probs=0.975),
+            mean = mean(FINAL),
+            se = sd(FINAL),
+            rse = 100*sd(FINAL)/mean(FINAL))
+
+```
+
+### stability plot with worst replicate (by ofv)
+
+```{r}
+
+try({
+  m_finished_summary %>%
+    arrange(desc(ofv)) %>%
+    {.$m[1]} %>%
+    plot_iter()
+})
 
 ```
 
@@ -90,7 +117,7 @@ m_finished %>%
 m_parent %>% text() %>% dplyr::first()
 ```
 
-### control file diff
+### original control file diff
 
 ```{r}
 m_parent %>% nm_diff()

---FILE: inst/extdata/examples/theopp/Scripts/s02_model_log.Rmd---
@@ -103,7 +103,7 @@ m1_boot$m %>% nm_list_render(""Scripts/basic_boot.Rmd"")
 
 ```
 
-### example cross-validation
+### example bootstrap cross-validation
 
 ```{r}
 

---FILE: inst/rmarkdown/templates/nm_boot/skeleton/skeleton.Rmd---
@@ -41,9 +41,10 @@ if(!is.null(knitr::opts_knit$get('rmarkdown.pandoc.to'))){
 ```{r}
 library(NMproject)
 library(dplyr)
+library(ggplot2)
 ```
 
-## model object
+## completion summary
 
 ```{r wait_for_run_finish}
 #wait_finish(.m)
@@ -57,7 +58,17 @@ m_parent <- parent_run(m_finished[1])
 
 ```
 
-## parent results for context
+```{r}
+
+m_finished_summary <- m_finished %>% summary_wide()
+
+m_finished_summary %>%
+  ggplot(aes(x = ofv)) + theme_bw() +
+  geom_histogram()
+
+```
+
+## original parent result for context
 
 This can be made better later
 
@@ -78,7 +89,23 @@ m_finished %>%
   group_by(parameter) %>%
   summarise(low=quantile(FINAL,probs=0.025),
             med=median(FINAL),
-            upp=quantile(FINAL,probs=0.975))
+            upp=quantile(FINAL,probs=0.975),
+            mean = mean(FINAL),
+            se = sd(FINAL),
+            rse = 100*sd(FINAL)/mean(FINAL))
+
+```
+
+### stability plot with worst replicate (by ofv)
+
+```{r}
+
+try({
+  m_finished_summary %>%
+    arrange(desc(ofv)) %>%
+    {.$m[1]} %>%
+    plot_iter()
+})
 
 ```
 
@@ -90,7 +117,7 @@ m_finished %>%
 m_parent %>% text() %>% dplyr::first()
 ```
 
-### control file diff
+### original control file diff
 
 ```{r}
 m_parent %>% nm_diff()"
tsahota,NMproject,fea06a92e944cd4547edb1ae3720aa1a4fad9eb2,tarj,tarjinder.z.sahota@gsk.com,2021-02-28T16:08:49Z,tarj,tarjinder.z.sahota@gsk.com,2021-02-28T16:08:49Z,bug fix in summary (due to old nmcoef class),NAMESPACE;R/ctl_handling.R;R/run_record.R,False,True,True,False,6,5,11,"---FILE: NAMESPACE---
@@ -3,9 +3,9 @@
 S3method(""%ns>%"",nm_generic)
 S3method(""%ns>%"",nm_list)
 S3method(""["",nm_list)
+S3method(AIC,data.frame)
 S3method(AIC,nm_generic)
 S3method(AIC,nm_list)
-S3method(AIC,nmcoef)
 S3method(BIC,nm_generic)
 S3method(BIC,nm_list)
 S3method(add_cov,nm_generic)
@@ -104,11 +104,11 @@ S3method(nmsave_table,nm_generic)
 S3method(nmsave_table,nm_list)
 S3method(nobs,nm_generic)
 S3method(nobs,nm_list)
+S3method(ofv,data.frame)
 S3method(ofv,default)
 S3method(ofv,list)
 S3method(ofv,nm_generic)
 S3method(ofv,nm_list)
-S3method(ofv,nmcoef)
 S3method(output_table,default)
 S3method(output_table,nm_generic)
 S3method(output_table,nm_list)

---FILE: R/ctl_handling.R---
@@ -736,8 +736,9 @@ ofv.default <- function(r){
 }
 
 #' @export
-ofv.nmcoef <- function(r){
-  if(is_empty_nmcoef(r)) return(NA)
+ofv.data.frame <- function(r){
+  #if(is_empty_nmcoef(r)) return(NA)
+  if(nrow(r) == 0) return(NA)
   r$FINAL[r$parameter %in% ""OBJ""]
 }
 

---FILE: R/run_record.R---
@@ -120,7 +120,7 @@ stats::coef
 stats::AIC
 
 #' @export
-AIC.nmcoef <- function(object, ..., k = 2){
+AIC.data.frame <- function(object, ..., k = 2){
   if(is_single_na(object)) return(NA)
   params <- object
   params <- params[grepl(""THETA|OMEGA|SIGMA"", params$type), ]"
tsahota,NMproject,01deea222b6e59c9cf12221f98bdd10876fd7c40,tarj,tarjinder.z.sahota@gsk.com,2021-02-28T15:32:20Z,tarj,tarjinder.z.sahota@gsk.com,2021-02-28T15:32:20Z,bug fix,inst/extdata/examples/theopp/Scripts/basic_boot.Rmd;inst/rmarkdown/templates/nm_boot/skeleton/skeleton.Rmd;inst/rmarkdown/templates/nm_boot/template.yaml,True,False,True,False,3,3,6,"---FILE: inst/extdata/examples/theopp/Scripts/basic_boot.Rmd---
@@ -1,5 +1,5 @@
 ---
-title: ""`r paste0(ctl_path(params$m[1]), ': GOF')`""
+title: ""`r paste0(ctl_path(params$m[1]), ': bootstrap')`""
 author: ""`r Sys.info()['user']`""
 date: ""`r Sys.time()`""
 output:

---FILE: inst/rmarkdown/templates/nm_boot/skeleton/skeleton.Rmd---
@@ -1,5 +1,5 @@
 ---
-title: ""`r paste0(ctl_path(params$m[1]), ': Bootstrap')`""
+title: ""`r paste0(ctl_path(params$m[1]), ': bootstrap')`""
 author: ""`r Sys.info()['user']`""
 date: ""`r Sys.time()`""
 output:

---FILE: inst/rmarkdown/templates/nm_boot/template.yaml---
@@ -1 +1 @@
-name: vpc diagnostic
+name: bootstrap results"
tsahota,NMproject,9c1178b21868b902888a40de3fef6f9908e90cd9,tarj,tarjinder.z.sahota@gsk.com,2021-02-27T16:49:05Z,tarj,tarjinder.z.sahota@gsk.com,2021-02-27T16:49:05Z,template/example cleanup. improved bootstrap. bug fix cmd in new_nm(),R/NMprojectExtra.R;inst/extdata/examples/theopp/Models/run1.mod;inst/extdata/examples/theopp/Scripts/s02_model_log.Rmd;inst/extdata/examples/theopp/Scripts/s04_covariate_modelling.Rmd;inst/extdata/examples/theopp/Scripts/s05_bootstrap.Rmd;inst/rmarkdown/templates/nm_log/skeleton/skeleton.Rmd;man/make_boot_datasets.Rd,True,True,True,False,20,39,59,"---FILE: R/NMprojectExtra.R---
@@ -116,7 +116,7 @@ new_nm <- function(run_id = NA_character_, based_on, data_path, cmd = ""execute {
   m <- nm(run_id = run_id)
   if(!missing(based_on)) m <- m %>% based_on(based_on)
   if(!missing(data_path)) m <- m %>% data_path(data_path)
-  if(!missing(cmd)) m <- m %>% cmd(cmd)
+  m <- m %>% cmd(cmd)
   m
   
 }
@@ -6185,21 +6185,21 @@ boot_to_csv <- function(d,
 #' 
 #' preparation step before creating nm models
 #' 
-#' @param bootsplits rsplits dataset from \code{rsample::bootstrap()}
-#' @param index index for subsetting
 #' @param m nm object
+#' @param index index for subsetting
 #' @param data_folder folder to store datasets
 #' @param overwrite overwrite or not
 #' @param ... arguments passed to fill_input
 #' 
 #' @export
-make_boot_datasets <- function(bootsplits,
+make_boot_datasets <- function(m,
                                index = 1:10,
-                               m,
                                data_folder = ""DerivedData/bootstrap_datasets"", 
                                overwrite = FALSE,
                                ...){
   
+  bootsplits <- readRDS(paste0(""DerivedData/bootsplit_"", basename(data_path(m)), "".RData""))
+  
   dboots <- bootsplits[index,] # datasets created
   dboots$run_id <- 1:nrow(dboots)
   

---FILE: inst/extdata/examples/theopp/Models/run1.mod---
@@ -87,10 +87,10 @@ $EST METHOD=IMP INTER EONLY= 1 MAPITER=0 ISAMPLE = 2000 NITER = 10 RANMETHOD=3S2
 $COV PRINT=E UNCONDITIONAL SIGL=10
 
 $TABLE ID TIME IPRED IWRES IRES CWRES NPDE
-FILE=sdtab1 NOPRINT ONEHEADER FORMAT=tF13.4
+FILE=sdtab1 NOPRINT ONEHEADER
 $TABLE ID ETAS(1:LAST); individual parameters
-FILE=patab1 NOPRINT ONEHEADER FORMAT=tF13.4
+FILE=patab1 NOPRINT ONEHEADER
 $TABLE ID ; continuous covariates
-FILE=cotab1 NOPRINT ONEHEADER FORMAT=tF13.4
+FILE=cotab1 NOPRINT ONEHEADER
 $TABLE ID ; categorical covariates
-FILE=catab1 NOPRINT ONEHEADER FORMAT=tF13.4
+FILE=catab1 NOPRINT ONEHEADER

---FILE: inst/extdata/examples/theopp/Scripts/s02_model_log.Rmd---
@@ -39,9 +39,7 @@ m1 <- new_nm(run_id = ""m1"",
              based_on = ""staging/Models/run1.mod"",
              data_path = ""DerivedData/data.csv"") %>%
   cmd(""execute {ctl_name} -dir={run_dir}"") %>%
-  fill_input(rename = c(""DATE"" = ""DAT0"")) %>%
-  ## the default format is not compatible with new xpose
-  gsub_ctl("" FORMAT=tF13.4"", """") %>%
+  fill_input(rename = c(""DAT0"" = ""DATE"")) %>%
   run_nm()
   
 ```

---FILE: inst/extdata/examples/theopp/Scripts/s04_covariate_modelling.Rmd---
@@ -40,9 +40,7 @@ c1 <- new_nm(run_id = ""c1"",
              based_on = ""staging/Models/run1.mod"",
              data_path = ""DerivedData/THEOPcov1.csv"") %>%
   cmd(""execute {ctl_name} -dir={run_dir}"") %>%
-  fill_input(rename = c(""DATE"" = ""DAT0"")) %>%
-  ## the default format is not compatible with new xpose
-  gsub_ctl("" FORMAT=tF13.4"", """") %>%
+  fill_input() %>%
   run_nm()
 
 c1 %>% nm_render(""Scripts/basic_gof.Rmd"")

---FILE: inst/extdata/examples/theopp/Scripts/s05_bootstrap.Rmd---
@@ -41,28 +41,16 @@ load_localpackage()
 
 ```{r}
 
-m1 <- new_nm(run_id = ""m1"",
-             based_on = ""staging/Models/ADVAN2.mod"",
-             data_path = ""DerivedData/data.csv"",
-             cmd = ""execute {ctl_name} -dir={run_dir}"") %>%
-  fill_input() %>%
-  init_theta(init = c(1, -2.5, -0.5)) %>%
-  init_sigma(init = 0.1) %>%
-  run_nm()
-  
-```
-
-
-```{r}
-
-splits <- readRDS(""DerivedData/bootsplit_data.csv.RData"")
+m1 <- readRDS(""Results/m1.RDS"")
 
-dm1_boot <- splits %>% make_boot_datasets(index = 1:10,
-                                          m = m1, 
-                                          overwrite = TRUE)
+dm1_boot <- m1 %>% make_boot_datasets(index = 1:10,
+                                      overwrite = TRUE)
 
 dm1_boot$m <- dm1_boot$m %>% run_nm()
 
+## TODO: make a bootstrap report, that accepts a vector of models
+## nm_list_render
+
 ## 95% CI on all param
 dres <- dm1_boot$m %>%
   subset(status(.) %in% ""finished"") %>%

---FILE: inst/rmarkdown/templates/nm_log/skeleton/skeleton.Rmd---
@@ -45,7 +45,7 @@ m1 <- new_nm(run_id = ""m1"",
              based_on = ""staging/Models/runm1.mod"",
              data_path = ""DerivedData/THEOPP.csv"",
              cmd = ""execute {ctl_name} -dir={run_dir}"") %>%
-  fill_input(rename = c(""DATE"" = ""DAT0"")) %>%
+  fill_input() %>%
   run_nm()
   
 ```

---FILE: man/make_boot_datasets.Rd---
@@ -5,21 +5,18 @@
 \title{add/write bootstrap datasets}
 \usage{
 make_boot_datasets(
-  bootsplits,
-  index = 1:10,
   m,
+  index = 1:10,
   data_folder = ""DerivedData/bootstrap_datasets"",
   overwrite = FALSE,
   ...
 )
 }
 \arguments{
-\item{bootsplits}{rsplits dataset from \code{rsample::bootstrap()}}
+\item{m}{nm object}
 
 \item{index}{index for subsetting}
 
-\item{m}{nm object}
-
 \item{data_folder}{folder to store datasets}
 
 \item{overwrite}{overwrite or not}"
tsahota,NMproject,a566ace23ae475b8277f58dc06e2acc19651a126,tarj,tarjinder.z.sahota@gsk.com,2021-02-27T01:31:19Z,tarj,tarjinder.z.sahota@gsk.com,2021-02-27T01:32:16Z,made patch applying less strict,R/manual_edit.R,False,True,True,False,1,1,2,"---FILE: R/manual_edit.R---
@@ -164,7 +164,7 @@ apply_manual_edit.nm_generic <- function(m, patch_name){
   patch_path_tmp <- paste0(patch_path, "".tmp"")
   writeLines(patch_text, patch_path_tmp)
   
-  patch_cmd <- paste(""git apply"", patch_path_tmp)
+  patch_cmd <- paste(""git apply"", patch_path_tmp, ""-C1 --inaccurate-eof"")
 
   if(!git_cmd_available) stop(""need git available from system() for this to work"")  
   res <- system(patch_cmd, intern = TRUE)  ## win = no need to use system_nm, no file sync issues"
tsahota,NMproject,b4715cb288b2284d1856e6dbf45def0549f5399b,tarj,tarjinder.z.sahota@gsk.com,2021-02-27T01:08:21Z,tarj,tarjinder.z.sahota@gsk.com,2021-02-27T01:08:21Z,"bug fix force, prompt in write_ctl",R/NMprojectExtra.R;R/manual_edit.R;man/write_ctl.Rd,False,True,True,False,12,12,24,"---FILE: R/NMprojectExtra.R---
@@ -569,15 +569,15 @@ new_ctl_extra <- function(m, ctl, dir = getOption(""models.dir"")){
 #' Normally used by other functions
 #' 
 #' @param m nm object
-#' @param prompt logical (default = TRUE), should prompt if overwriting?
+#' @param force logical (default = FALSE), force write, don't ask (ignore behaviour)
 #' 
 #' @export
-write_ctl <- function(m, prompt = TRUE){
+write_ctl <- function(m, force = FALSE){
   UseMethod(""write_ctl"")
 }
 
 #' @export
-write_ctl.nm_generic <- function(m, prompt = TRUE){
+write_ctl.nm_generic <- function(m, force = FALSE){
 
   ctl_name <- ctl_path(m)
   ctl_ob <- ctl_contents(m) %>% ctl_character()
@@ -586,7 +586,7 @@ write_ctl.nm_generic <- function(m, prompt = TRUE){
   if(!file.exists(dir_name)) 
     dir.create(dir_name, showWarnings = FALSE, recursive = TRUE)
   
-  if(file.exists(ctl_name)){
+  if(file.exists(ctl_name) & !force){
     behaviour <- overwrite_behaviour()
     old_contents <- readLines(ctl_name)
     new_contents <- ctl_ob
@@ -595,7 +595,7 @@ write_ctl.nm_generic <- function(m, prompt = TRUE){
     if(overwrite_required){
       if(""stop"" %in% behaviour)
         stop(""stopping because overwrite required: change behaviour in overwrite_behaviour()"")
-      if(""ask"" %in% behaviour & prompt)
+      if(""ask"" %in% behaviour)
         prompt_overwrite(ctl_name, new_path_contents = ctl_ob)
       if(""skip"" %in% behaviour)
         return(invisible(m))
@@ -1414,7 +1414,7 @@ result_file.nm_list <- Vectorize_nm_list(result_file.nm_generic)
 #' @export
 nm_tran.nm_generic <- function(x){
   xtmp <- x %>% run_in(file.path(run_in(x), ""temp""))
-  xtmp %>% write_ctl(prompt = FALSE)
+  xtmp %>% write_ctl(force = TRUE)
   nm_tran.default(ctl_path(xtmp))
   invisible(x)
 }
@@ -1908,7 +1908,7 @@ show_ctl <- function(r) {
 #' @export
 show_ctl.nm_generic <- function(r) {
   rtmp <- r %>% run_in(file.path(run_in(r), ""temp""))
-  r %>% write_ctl(prompt = FALSE)
+  r %>% write_ctl(force = TRUE)
   file.show(ctl_path(r))
 }
 #' @export
@@ -4098,7 +4098,7 @@ nm_output.nm_list <- nm_output.nm_generic
 run_checksums <- function(m){  ## only works on single m
   ## information determinative to whether run should be rerun
   mtmp <- m %>% run_in(file.path(run_in(m), ""temp""))
-  mtmp %>% write_ctl(prompt = FALSE)
+  mtmp %>% write_ctl(force = TRUE)
   files <- c(ctl_path(mtmp), data_path(mtmp))
   
   checksums <- tools::md5sum(files)

---FILE: R/manual_edit.R---
@@ -92,7 +92,7 @@ start_manual_edit_unix <- function(m, combine_patch = NA_character_){
   ## this isn't used - delete
   
   temp_ctl_path <- file.path(run_in(m), paste0(""manual_"", ctl_name(m)))
-  mnew <- m %>% ctl_path(temp_ctl_path) %>% write_ctl(prompt = FALSE)
+  mnew <- m %>% ctl_path(temp_ctl_path) %>% write_ctl(force = TRUE)
 
   ## soft unstage all first, then add only the file
   if(!git_cmd_available) stop(""need git available from system() for this to work"")
@@ -155,7 +155,7 @@ apply_manual_edit.nm_generic <- function(m, patch_name){
   patch_text <- readLines(patch_path)
   
   temp_ctl_path <- file.path(run_in(m), paste0(""manual_"", ctl_name(m)))
-  mnew <- m %>% ctl_path(temp_ctl_path) %>% write_ctl(prompt = FALSE)
+  mnew <- m %>% ctl_path(temp_ctl_path) %>% write_ctl(force = TRUE)
   
   ## edit and save temporary patch
   patch_text <- gsub(""(a/).*?manual_\\S+"", paste0(""\\1"", temp_ctl_path), patch_text, perl = TRUE)

---FILE: man/write_ctl.Rd---
@@ -4,12 +4,12 @@
 \alias{write_ctl}
 \title{Write control file to disk}
 \usage{
-write_ctl(m, prompt = TRUE)
+write_ctl(m, force = FALSE)
 }
 \arguments{
 \item{m}{nm object}
 
-\item{prompt}{logical (default = TRUE), should prompt if overwriting?}
+\item{force}{logical (default = FALSE), force write, don't ask (ignore behaviour)}
 }
 \description{
 Normally used by other functions"
tsahota,NMproject,24bcb5bce7d22cae570197bb1e01fca6c53c0463,tarj,tarjinder.z.sahota@gsk.com,2021-02-26T19:08:36Z,tarj,tarjinder.z.sahota@gsk.com,2021-02-26T19:54:16Z,bug fix with bind rows of coef objects,R/NMprojectExtra.R;R/nm.R,False,True,True,False,10,4,14,"---FILE: R/NMprojectExtra.R---
@@ -1056,7 +1056,7 @@ coef.nm_generic <- function(object,trans=TRUE,...){
   if(!is_finished(object)) {
     #warning(unique_id(object),"" not finished, returning empty data.frame"")
     d <- data.frame()
-    class(d) <- append(class(d), ""nmcoef"")
+    #class(d) <- append(class(d), ""nmcoef"")
     return(invisible(d))
   }
   
@@ -1066,15 +1066,15 @@ coef.nm_generic <- function(object,trans=TRUE,...){
   d <- coef_ext0(ext_file_path)
   if(nrow(d) == 0) {
     d <- data.frame()
-    class(d) <- append(class(d), ""nmcoef"")
+    #class(d) <- append(class(d), ""nmcoef"")
     return(d)
   }
   
   d$run_name <- gsub(""execute\\."", ""\\1"", unique_id(object))
   if(!unique(d$is_final)) d$run_name <- paste0(d$run_name,""*"")
   d$is_final <- NULL
   if(!trans) {
-    class(d) <- append(class(d), ""nmcoef"")
+    #class(d) <- append(class(d), ""nmcoef"")
     return(d)
   }
   
@@ -1186,7 +1186,7 @@ coef.nm_generic <- function(object,trans=TRUE,...){
   d$transSEunit <- NULL
   d$parameter <- d$name
   d$name <- NULL
-  class(d) <- append(class(d), ""nmcoef"")
+  #class(d) <- append(class(d), ""nmcoef"")
   d
 }
 

---FILE: R/nm.R---
@@ -85,6 +85,12 @@ cond_num <- function(r){
 #' @export
 cond_num.default <- function(r){
   if(is_single_na(r)) return(as.numeric(NA))
+  if(is.data.frame(r)){
+    dc <- r
+    ans <- as.numeric(dc$FINAL[dc$parameter %in% ""CONDNUM""])
+    if(length(ans) == 0) ans <- as.numeric(NA)
+    return(ans)
+  }
   stop(""don't know how to get cond_num of this"")
 }
 "
tsahota,NMproject,93b72f58b9d3691b1053511997246c144c93f6f1,tarj,tarjinder.z.sahota@gsk.com,2021-02-26T19:08:36Z,tarj,tarjinder.z.sahota@gsk.com,2021-02-26T19:08:36Z,bug fix with bind rows of coef objects,R/NMprojectExtra.R,False,True,True,False,4,4,8,"---FILE: R/NMprojectExtra.R---
@@ -1056,7 +1056,7 @@ coef.nm_generic <- function(object,trans=TRUE,...){
   if(!is_finished(object)) {
     #warning(unique_id(object),"" not finished, returning empty data.frame"")
     d <- data.frame()
-    class(d) <- append(class(d), ""nmcoef"")
+    #class(d) <- append(class(d), ""nmcoef"")
     return(invisible(d))
   }
   
@@ -1066,15 +1066,15 @@ coef.nm_generic <- function(object,trans=TRUE,...){
   d <- coef_ext0(ext_file_path)
   if(nrow(d) == 0) {
     d <- data.frame()
-    class(d) <- append(class(d), ""nmcoef"")
+    #class(d) <- append(class(d), ""nmcoef"")
     return(d)
   }
   
   d$run_name <- gsub(""execute\\."", ""\\1"", unique_id(object))
   if(!unique(d$is_final)) d$run_name <- paste0(d$run_name,""*"")
   d$is_final <- NULL
   if(!trans) {
-    class(d) <- append(class(d), ""nmcoef"")
+    #class(d) <- append(class(d), ""nmcoef"")
     return(d)
   }
   
@@ -1186,7 +1186,7 @@ coef.nm_generic <- function(object,trans=TRUE,...){
   d$transSEunit <- NULL
   d$parameter <- d$name
   d$name <- NULL
-  class(d) <- append(class(d), ""nmcoef"")
+  #class(d) <- append(class(d), ""nmcoef"")
   d
 }
 "
tsahota,NMproject,8436e22f664460de4840e75c35dffb84ec3c1d78,tarj,tarjinder.z.sahota@gsk.com,2021-02-26T18:55:59Z,tarj,tarjinder.z.sahota@gsk.com,2021-02-26T19:07:56Z,bug fix with mutate,NAMESPACE;R/utilsExtra.R;man/add_boot_datasets.Rd;man/boot_to_csv.Rd,False,True,True,False,67,4,71,"---FILE: NAMESPACE---
@@ -186,6 +186,7 @@ export(.overwrite_behaviour)
 export(AIC)
 export(BIC)
 export(NONMEM_version)
+export(add_boot_datasets)
 export(add_cov)
 export(add_mixed_param)
 export(advan)
@@ -195,6 +196,7 @@ export(as_nm_generic)
 export(as_nm_list)
 export(based_on)
 export(bind_covariate_results)
+export(boot_to_csv)
 export(by_row)
 export(by_row_df)
 export(cache_current)

---FILE: R/utilsExtra.R---
@@ -121,7 +121,7 @@ as_nm_list.nm_list <- function(m){
 as_nm_list.list <- function(m){
   if(is_nm_list(m)){
     class(m) <- c(""nm_list"", ""list"")
-    names(m) <- unique_id(m)#paste0(run_id0(m),"":"",type(m),"":"",run_in(m))
+    names(m) <- unique_id(m)
     return(m)
   } else {
     stop(""list not coercible to nm_list"")
@@ -169,21 +169,29 @@ c.nm_list <- function(...){
 #' @export
 c.nm_generic <- function(...){
   basic_list <- list(...)
-  as_nm_list(basic_list)
+  class(basic_list) <- c(""nm_list"", ""list"")
+  #as_nm_list(basic_list)
+  basic_list
 }
 
 #' @export
 '[.nm_list' <- function(x, i, j, ...) {
   class(x) <- ""list""
   val <- NextMethod()
-  as_nm_list(val)
+  class(val) <- c(""nm_list"", ""list"")
+  #val <- as_nm_list(val)
+  val
 }
 
+
+
 #' @export
 unique.nm_list <- function(x, incomparables = FALSE, ...) {
   class(x) <- ""list""
   val <- NextMethod()
-  as_nm_list(val)
+  class(val) <- c(""nm_list"", ""list"")
+  #val <- as_nm_list(val)
+  val
 }
 
 ## experimental - goes against dplyr, maybe delete if not useful

---FILE: man/add_boot_datasets.Rd---
@@ -0,0 +1,25 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/NMprojectExtra.R
+\name{add_boot_datasets}
+\alias{add_boot_datasets}
+\title{add/write bootstrap datasets}
+\usage{
+add_boot_datasets(
+  dboots,
+  d,
+  folder = ""DerivedData/bootstrap_datasets"",
+  overwrite = FALSE
+)
+}
+\arguments{
+\item{dboots}{rsplits dataset with run_id column}
+
+\item{d}{dataset to merge}
+
+\item{folder}{folder to store datasets}
+
+\item{overwrite}{overwrite or not}
+}
+\description{
+preparation step before creating nm models
+}

---FILE: man/boot_to_csv.Rd---
@@ -0,0 +1,28 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/NMprojectExtra.R
+\name{boot_to_csv}
+\alias{boot_to_csv}
+\title{save bootstrap datasets to disk}
+\usage{
+boot_to_csv(
+  d,
+  rsplit,
+  data_name,
+  folder = ""DerivedData/bootstrap_datasets"",
+  overwrite = FALSE
+)
+}
+\arguments{
+\item{d}{dataset to merge}
+
+\item{rsplit}{splits object from rsample}
+
+\item{data_name}{name of dataset}
+
+\item{folder}{path to bootstrap datasets}
+
+\item{overwrite}{should datasets be overwritten}
+}
+\description{
+intended to be used in a mutate statement from rsample::bootstrap output
+}"
tsahota,NMproject,fdf89b5d5ba5737544fcb87adbae38e809930758,tarj,tarjinder.z.sahota@gsk.com,2021-02-25T19:42:41Z,tarj,tarjinder.z.sahota@gsk.com,2021-02-25T19:42:41Z,shiny_nm dygraphs bug fix,NAMESPACE;R/NMprojectExtra.R;R/plot_iter.R,False,True,True,False,4,0,4,"---FILE: NAMESPACE---
@@ -119,6 +119,8 @@ S3method(parent_run,nm_generic)
 S3method(parent_run,nm_list)
 S3method(perturb_inits,nm_generic)
 S3method(perturb_inits,nm_list)
+S3method(plot_iter_data,default)
+S3method(plot_iter_data,nm_list)
 S3method(print,nm_ctl_text)
 S3method(print,nm_generic)
 S3method(print,nm_list)

---FILE: R/NMprojectExtra.R---
@@ -3434,6 +3434,7 @@ read_ext.nm_list <- function(r,trans=FALSE){
   exts
 }
 
+#' @export
 plot_iter_data.nm_list <- function(r, trans = TRUE, skip = 0, yvar = ""OBJ""){
   if(length(r) > 1) stop(""currently can't do multiple plots at the same time"", call. = FALSE)
   plot_iter_data(as_nm_generic(r), trans = trans, skip = skip, yvar = yvar)

---FILE: R/plot_iter.R---
@@ -10,6 +10,7 @@ plot_iter_data <- function(r,trans=TRUE,skip=0,yvar=""OBJ""){
   UseMethod(""plot_iter_data"")
 }
 
+#' @export
 plot_iter_data.default <- function(r,trans=TRUE,skip=0,yvar=""OBJ""){
 
   if(!requireNamespace(""reshape2"", quietly = TRUE))"
tsahota,NMproject,a3ba39b1116b6102f403fb5f76b50f1c7e63e0d8,tarj,tarjinder.z.sahota@gsk.com,2021-02-25T19:09:20Z,tarj,tarjinder.z.sahota@gsk.com,2021-02-25T19:09:20Z,improved template + covariate bug fixes,R/NMprojectExtra.R;R/sim_reestExtra.R;inst/rmarkdown/templates/nm_log/skeleton/skeleton.Rmd,True,True,True,False,17,11,28,"---FILE: R/NMprojectExtra.R---
@@ -1414,7 +1414,7 @@ result_file.nm_list <- Vectorize_nm_list(result_file.nm_generic)
 #' @export
 nm_tran.nm_generic <- function(x){
   xtmp <- x %>% run_in(file.path(run_in(x), ""temp""))
-  write_ctl(xtmp)
+  xtmp %>% write_ctl(prompt = FALSE)
   nm_tran.default(ctl_path(xtmp))
   invisible(x)
 }
@@ -3503,7 +3503,7 @@ init_theta.nm_generic <- function(m, replace, ...){
     if(length(mutate_args) > 0){
       current_init <- init_theta(m)
       replace <- current_init %>% dplyr::mutate(!!!mutate_args)
-      replace <- replace %>% mutate_if(is.numeric, ~signif(., 5))
+      replace <- replace %>% dplyr::mutate_if(is.numeric, ~signif(., 5))
     } else {
       d <- d[!is.na(d$parameter), ]
       d$value <- NULL
@@ -3556,7 +3556,7 @@ init_omega.nm_generic <- function(m, replace, ...){
     if(length(mutate_args) > 0){
       current_init <- init_omega(m)
       replace <- current_init %>% mutate_cond(!is.na(name), !!!mutate_args)
-      replace <- replace %>% mutate_if(is.numeric, ~signif(., 5))
+      replace <- replace %>% dplyr::mutate_if(is.numeric, ~signif(., 5))
     } else {
       d$value <- NULL
       d$comment <- NULL
@@ -3611,7 +3611,7 @@ init_sigma.nm_generic <- function(m, replace, ...){
     if(length(mutate_args) > 0){
       current_init <- init_sigma(m)
       replace <- current_init %>% mutate_cond(!is.na(name), !!!mutate_args)
-      replace <- replace %>% mutate_if(is.numeric, ~signif(., 5))
+      replace <- replace %>% dplyr::mutate_if(is.numeric, ~signif(., 5))
     } else {
       d$value <- NULL
       d$comment <- NULL
@@ -4639,8 +4639,14 @@ summary.nm_list <- function(object, ref_model = NA, parameters = c(""none"", ""new""
       pars_to_add <- tibble::as_tibble(t(rri$m))
       names(pars_to_add) <- rri$parameter
 
-      dplyr::bind_cols(d, pars_to_add) %>%
-        ## nm_lists screw up in dplyr...
+      dplyr::bind_cols(d, pars_to_add) #%>%
+        # mutate(m = nm_list2list(m),
+        #        parent = nm_list2list(parent))
+    })
+    
+    ## nm_lists screw up in dplyr...
+    ds <- lapply(ds, function(x) {
+      x %>% 
         mutate(m = nm_list2list(m),
                parent = nm_list2list(parent))
     })

---FILE: R/sim_reestExtra.R---
@@ -137,7 +137,7 @@ covariate_step_tibble <- function(base, run_id, run_in = getOption(""models.dir"")
   }
   
   ## check no covariates are in dataset and have no missing values
-  dinput <- input_data(base)
+  dinput <- tibble::tibble(input_data(base))
   test_covs <- unique(dtest$cov)
   if(any(!test_covs %in% names(dinput))){
     stop(""cannot find covariates:\n "",

---FILE: inst/rmarkdown/templates/nm_log/skeleton/skeleton.Rmd---
@@ -29,10 +29,10 @@ load_localpackage()
 
 ```{r}
 
-m1 <- nm(run_id = ""m1"") %>%
-  based_on(""staging/Models/runm1.mod"") %>%
-  data_path(""DerivedData/THEOPP.csv"") %>%
-  cmd(""qpsn -c auto -t 59 -- execute {ctl_name} -dir={run_dir}"") %>%
+m1 <- new_nm(run_id = ""m1"",
+             based_on = ""staging/Models/runm1.mod"",
+             data_path = ""DerivedData/THEOPP.csv"",
+             cmd = ""execute {ctl_name} -dir={run_dir}"") %>%
   fill_input(rename = c(""DATE"" = ""DAT0"")) %>%
   run_nm()
   "
tsahota,NMproject,07c25663ad9dde59965d534dbf5b5987675c1b9c,tarj,tarjinder.z.sahota@gsk.com,2021-02-25T15:27:52Z,tarj,tarjinder.z.sahota@gsk.com,2021-02-25T15:27:52Z,bug fixes,R/NMprojectExtra.R;R/manual_edit.R;inst/extdata/overwrite_behaviour/server.R,False,True,True,False,21,5,26,"---FILE: R/NMprojectExtra.R---
@@ -1654,7 +1654,7 @@ prompt_overwrite <- function(paths, new_path_contents = c()){
     new_contents <- new_path_contents
     attributes(new_contents) <- NULL
     if(!identical(new_contents, old_contents)){
-      diff_val <- diffobj::diffChr(new_contents, old_contents, format = ""raw"") 
+      diff_val <- diffobj::diffChr(old_contents, new_contents, format = ""raw"") 
       if(length(as.character(diff_val)) <= 30) ## diff limit
         msg <- paste(msg, ""\n"", paste(diff_val, collapse = ""\n""))
     } else {
@@ -2526,7 +2526,19 @@ nm_diff <- function(m, ref_m, format = ""raw""){
       as_nm_generic(m)[[""ctl_orig""]]
     ))
   } else {
-    old_ctl <- as.character(ctl_character(ctl_contents(as_nm_generic(ref_m)))) 
+    if(inherits(ref_m, ""nm_list"") | inherits(ref_m, ""nm_generic"")){
+      old_ctl <- as.character(ctl_character(ctl_contents(as_nm_generic(ref_m)))) 
+    } else {
+      if(is.character(ref_m)){
+        if(length(ref_m) > 1) old_ctl <- ref_m
+        if(length(ref_m) == 0) stop(""ref_m should not be length 0"")
+        if(length(ref_m) == 1) 
+          if(file.exists(ref_m)) 
+            old_ctl <- readLines(ref_m) 
+      } else {
+        stop(""don't know how to handle ref_m"")
+      }
+    }
   }
   new_ctl <- as.character(ctl_character(ctl_contents(as_nm_generic(m))))
   #""ansi256""

---FILE: R/manual_edit.R---
@@ -93,7 +93,7 @@ start_manual_edit_unix <- function(m, combine_patch = NA_character_){
   
   temp_ctl_path <- file.path(run_in(m), paste0(""manual_"", ctl_name(m)))
 
-  mnew <- m %>% ctl_path(temp_ctl_path) %>% write_ctl()
+  mnew <- m %>% ctl_path(temp_ctl_path) %>% write_ctl(prompt = FALSE)
 
   ## soft unstage all first, then add only the file
   if(!git_cmd_available) stop(""need git available from system() for this to work"")
@@ -153,7 +153,7 @@ apply_manual_edit.nm_generic <- function(m, patch_name){
   patch_text <- readLines(patch_path)
   
   temp_ctl_path <- file.path(run_in(m), paste0(""manual_"", ctl_name(m)))
-  mnew <- m %>% ctl_path(temp_ctl_path) %>% write_ctl()
+  mnew <- m %>% ctl_path(temp_ctl_path) %>% write_ctl(prompt = FALSE)
   
   ## edit and save temporary patch
   patch_text <- gsub(""(a/).*?manual_\\S+"", paste0(""\\1"", temp_ctl_path), patch_text, perl = TRUE)

---FILE: inst/extdata/overwrite_behaviour/server.R---
@@ -4,6 +4,9 @@ library(miniUI)
 .currentwd <- get("".currentwd"", envir = NMproject:::.sso_env)
 setwd(.currentwd)
 
+current_selection <- match(NMproject::overwrite_behaviour(),
+                           NMproject::.overwrite_behaviour$txt)
+
 server <- function(input, output, session) {
   
   output$behaviour_table <- DT::renderDataTable(
@@ -17,7 +20,8 @@ server <- function(input, output, session) {
                    searching=FALSE,
                    filtering=FALSE,
                    ordering=FALSE),
-    selection = ""single"")
+    #selection = ""single"",
+    selection = list(mode = 'single', selected = current_selection))
   
   txt_value <- eventReactive(input$behaviour_table_rows_selected,{
     NMproject::.overwrite_behaviour$txt[input$behaviour_table_rows_selected]"
tsahota,NMproject,c715cde1180e88e5dabcc76b896485f5d596f6ec,tarj,tarjinder.z.sahota@gsk.com,2021-02-09T23:46:31Z,tarj,tarjinder.z.sahota@gsk.com,2021-02-09T23:46:31Z,single make patch app,NAMESPACE;R/NMprojectExtra.R;R/manual_edit.R;inst/rstudio/addins.dcf;man/job_stats.Rd,False,True,True,False,61,11,72,"---FILE: NAMESPACE---
@@ -257,6 +257,7 @@ export(is_finished)
 export(is_nm_generic)
 export(is_nm_list)
 export(job_info)
+export(job_stats)
 export(kill_job)
 export(load_sse)
 export(ls_output)

---FILE: R/NMprojectExtra.R---
@@ -1394,8 +1394,9 @@ result_file.nm_list <- Vectorize_nm_list(result_file.nm_generic)
 
 #' @export
 nm_tran.nm_generic <- function(x){
-  write_ctl(x)
-  nm_tran.default(ctl_path(x))
+  xtmp <- x %>% run_in(file.path(run_in(x), ""temp""))
+  write_ctl(xtmp)
+  nm_tran.default(ctl_path(xtmp))
   invisible(x)
 }
 #' @export
@@ -1818,6 +1819,7 @@ show_ctl <- function(r) {
 
 #' @export
 show_ctl.nm_generic <- function(r) {
+  rtmp <- r %>% run_in(file.path(run_in(r), ""temp""))
   r %>% write_ctl()
   file.show(ctl_path(r))
 }
@@ -3909,8 +3911,9 @@ nm_output.nm_list <- nm_output.nm_generic
 
 run_checksums <- function(m){  ## only works on single m
   ## information determinative to whether run should be rerun
-  m %>% write_ctl()
-  files <- c(ctl_path(m), data_path(m))
+  mtmp <- m %>% run_in(file.path(run_in(m), ""temp""))
+  mtmp %>% write_ctl()
+  files <- c(ctl_path(mtmp), data_path(mtmp))
   
   checksums <- tools::md5sum(files)
   names(checksums) <- c(""ctl"", ""data"")
@@ -5912,6 +5915,30 @@ covariance_result <- function(r,trans=TRUE){
   
 }
 
+#' get job stats
+#' @export
+job_stats <- function(m){
+  
+  if(!requireNamespace(""pmxTools""))
+    stop(""install pmxTools"", call. = FALSE)
+  
+  d <- m %>% nm_row()
+  
+  d <- d %>% ungroup() %>%
+    mutate(xml_path = nm_output_path(m, ""xml""),
+           xml = purrr::map(xml_path, pmxTools::read_nm))
+  
+  d %>% mutate(starttime = purrr::map_chr(xml, ~.x$start_datetime),
+               stoptime = purrr::map_chr(xml, ~.x$stop_datetime),
+               starttime = lubridate::ymd_hms(starttime),
+               stoptime = lubridate::ymd_hms(stoptime),
+               Rtime = difftime(stoptime, starttime, units = ""mins""), 
+               launchtime = m %>% run_dir(full_path = TRUE) %>% file.path(""command.txt"") %>% file.info() %>% .$mtime %>% lubridate::ymd_hms(),
+               Qtime = difftime(starttime, launchtime, units = ""mins""),
+               Ttime = difftime(stoptime, launchtime, units = ""mins""))
+  
+}
+
 ## TODO: no_rerun()
 ##  stops instead of rerunning.
 ##  traceability check

---FILE: R/manual_edit.R---
@@ -358,6 +358,22 @@ are changed.  It is recommended to use dollar() for custom edits of downstream (
   
 }
 
+make_patch_app <- function(){
+
+  ctx <- rstudioapi::getActiveDocumentContext()
+  selected_text <- ctx$selection[[1]]$text
+  
+  ## see if last function is apply_manual_edit
+  
+  ## get last function used in piping
+  full_expr <- parse(text = selected_text)
+  last_fun_name <- as.character(full_expr[[1]][[3]][[1]])
+  
+  if(last_fun_name == ""apply_manual_edit"") modify_patch_app() else
+    new_patch_app()
+    
+}
+
 
 view_patch_app <- function(){
 

---FILE: inst/rstudio/addins.dcf---
@@ -1,11 +1,6 @@
-Name: new_manual_edit
+Name: manual_edit
 Description: create patch to apply with apply_manual_edit()
-Binding: new_patch_app
-Interactive: true
-
-Name: modify_manual_edit
-Description: modify the last manual edit
-Binding: modify_patch_app
+Binding: make_patch_app
 Interactive: true
 
 Name: view patch

---FILE: man/job_stats.Rd---
@@ -0,0 +1,11 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/NMprojectExtra.R
+\name{job_stats}
+\alias{job_stats}
+\title{get job stats}
+\usage{
+job_stats(m)
+}
+\description{
+get job stats
+}"
tsahota,NMproject,e0f8c77027929e8c4603c0c1811d5b868d9cb862,tarj,tarjinder.z.sahota@gsk.com,2021-02-09T18:48:24Z,tarj,tarjinder.z.sahota@gsk.com,2021-02-09T18:48:24Z,bug fix summary template update,R/NMprojectExtra.R;inst/extdata/examples/theopp/Scripts/s02_model_log.Rmd;inst/extdata/examples/theopp/Scripts/s02_model_log.nb.html;inst/extdata/examples/theopp/Scripts/s04_covariate_modelling.Rmd;inst/extdata/examples/theopp/Scripts/s04_covariate_modelling.nb.html,True,True,True,False,39,3982,4021,"---FILE: R/NMprojectExtra.R---
@@ -4318,6 +4318,11 @@ new_notebook_template <- function(script_name, overwrite = FALSE, open_file = TR
 }
 
 
+nm_list2list <- function(m){
+  class(m) <- ""list""
+  m
+}
+
 
 #' @export
 summary.nm_list <- function(object, ref_model = NA, parameters = c(""none"", ""new"", ""all""), keep_m = FALSE, ...){
@@ -4340,10 +4345,23 @@ summary.nm_list <- function(object, ref_model = NA, parameters = c(""none"", ""new""
     nrow(coef)
   }
 
+  # browser()
+  # 
+  # f <- function(x) {
+  #   ans <- list(x)
+  #   return(ans)
+  #   parent_run(x)
+  # }
+  # 
+  # tmp <- d %>% dplyr::group_by(.data$parent_run_id, .data$parent_run_in) %>%
+  #   dplyr::mutate(
+  #     parent = list(parent_run(.data$m[[1]]))
+  #   )
+  
   d <- d %>% dplyr::group_by(.data$parent_run_id, .data$parent_run_in) %>%
     dplyr::mutate(
-      parent = parent_run(.data$m[1]),
-      parent_coef_obs = coef(.data$parent[1]),
+      parent = list(parent_run(.data$m[[1]])),
+      parent_coef_obs = coef.nm_list(.data$parent[1]),
       n_params = sapply(.data$coef_obs, n_parameters_fun),
       parent_n_params = n_parameters_fun(.data$parent_coef_obs[[1]])
       ) %>%
@@ -4366,10 +4384,13 @@ summary.nm_list <- function(object, ref_model = NA, parameters = c(""none"", ""new""
       )
   d$coef_obs <- NULL
   d$parent_coef_obs <- NULL
+  d$parent <- as_nm_list(d$parent)
 
   parameters <- match.arg(parameters)
   if(parameters != ""none""){
     ## for each row, compute rr(d$m[i]) and rr(d$parent[i])
+    ## remove nm_list classes - they screw up in dplyr
+
     ds <- split(d, seq_len(nrow(d)))
 
     ds <- lapply(ds, function(d){
@@ -4430,9 +4451,12 @@ summary.nm_list <- function(object, ref_model = NA, parameters = c(""none"", ""new""
       pars_to_add <- tibble::as_tibble(t(rri$m))
       names(pars_to_add) <- rri$parameter
 
-      dplyr::bind_cols(d, pars_to_add)
+      dplyr::bind_cols(d, pars_to_add) %>%
+        ## nm_lists screw up in dplyr...
+        mutate(m = nm_list2list(m),
+               parent = nm_list2list(parent))
     })
-
+    
     d <- suppressWarnings(dplyr::bind_rows(ds))
     d$m <- as_nm_list(d$m)
     d$parent <- as_nm_list(d$parent)

---FILE: inst/extdata/examples/theopp/Scripts/s02_model_log.Rmd---
@@ -23,10 +23,6 @@ opts_chunk$set(message = TRUE)
 ## LOAD PACKAGES HERE
 
 library(NMproject)
-# 
-# 
-# 
-# 
 library(future)
 future::plan(""future::multiprocess"", workers = 2)
 library(dplyr)
@@ -39,9 +35,9 @@ load_localpackage()
 
 ```{r}
 
-m1 <- nm(run_id = ""m1"") %>%
-  based_on(""staging/Models/run1.mod"") %>%
-  data_path(""DerivedData/data.csv"") %>%
+m1 <- new_nm(run_id = ""m1"",
+             based_on = ""staging/Models/run1.mod"",
+             data_path = ""DerivedData/data.csv"") %>%
   cmd(""execute {ctl_name} -dir={run_dir}"") %>%
   fill_input(rename = c(""DATE"" = ""DAT0"")) %>%
   ## the default format is not compatible with new xpose
@@ -84,14 +80,15 @@ m2WT <- m2 %>% child(""m2WT"") %>%
   add_cov(param = ""CL"", cov = ""WT"", state = ""linear"") %>%
   run_nm()
 
-```
+c(m2, m2WT) %>% nm_render(""Scripts/basic_gof.Rmd"")
 
-```{r}
+```
 
-wait_finish(c(m2, m2WT)) 
+Body weight not signficant.  K parameterisation better than CL in terms of OFV
 
-#kable(summary_long(c(m2, m2WT), parameters = ""all""))
+```{r}
 
+kable(summary_long(c(m2, m2WT), parameters = ""all""))
 kable(rr(c(m2, m2WT)))
 
 ```

---FILE: inst/extdata/examples/theopp/Scripts/s04_covariate_modelling.Rmd---
@@ -36,9 +36,9 @@ load_localpackage()
 
 ```{r message=FALSE, results='hide'}
 
-c1 <- nm(run_id = ""c1"") %>%
-  based_on(""staging/Models/run1.mod"") %>%
-  data_path(""DerivedData/THEOPcov1.csv"") %>%
+c1 <- new_nm(run_id = ""c1"",
+             based_on = ""staging/Models/run1.mod"",
+             data_path = ""DerivedData/THEOPcov1.csv"") %>%
   cmd(""execute {ctl_name} -dir={run_dir}"") %>%
   fill_input(rename = c(""DATE"" = ""DAT0"")) %>%
   ## the default format is not compatible with new xpose"
tsahota,NMproject,a873e5e580476e9904071048ccd0e521c4b03e5d,tarj,tarjinder.z.sahota@gsk.com,2021-02-07T17:28:19Z,tarj,tarjinder.z.sahota@gsk.com,2021-02-07T17:28:19Z,recode of manual edit patch to use git instead of patch,NAMESPACE;R/NMprojectExtra.R;R/manual_edit.R;R/utils.R;inst/extdata/manual_patch/server.R;inst/rstudio/addins.dcf;man/apply_manual_edit.Rd;man/dollar.Rd;man/git_cmd_available.Rd,False,True,True,False,145,68,213,"---FILE: NAMESPACE---
@@ -12,6 +12,8 @@ S3method(add_cov,nm_generic)
 S3method(add_cov,nm_list)
 S3method(advan,nm_generic)
 S3method(advan,nm_list)
+S3method(apply_manual_edit,nm_generic)
+S3method(apply_manual_edit,nm_list)
 S3method(as_nm_generic,nm_generic)
 S3method(as_nm_generic,nm_list)
 S3method(as_nm_list,default)
@@ -179,7 +181,7 @@ export(add_cov)
 export(add_mixed_param)
 export(advan)
 export(append_nonmem_var)
-export(apply_patch)
+export(apply_manual_edit)
 export(as_nm_generic)
 export(as_nm_list)
 export(based_on)

---FILE: R/NMprojectExtra.R---
@@ -709,7 +709,7 @@ set_target_text <- function(m, text){
 
 #' @importFrom graphics text
 #' @export
-text.nm_generic <- function(x, text, append = FALSE, after = character(), ...){
+text.nm_generic <- function(x, text, append = FALSE, after = character(), add_dollar_text = FALSE, ...){
   m <- x
   current_text <- get_target_text(m)
   if(missing(text)) return(current_text)
@@ -735,7 +735,7 @@ text.nm_generic <- function(x, text, append = FALSE, after = character(), ...){
   if(is.na(target(m))) {
     #stop(""not developed yet"")
   } else {
-    text <- setup_dollar(text, paste0(""$"",target(m)), add_dollar_text = FALSE) 
+    text <- setup_dollar(text, paste0(""$"",target(m)), add_dollar_text = add_dollar_text) 
   }
   m <- m %>% set_target_text(text)
   m
@@ -1830,8 +1830,8 @@ show_ctl.nm_list <- show_ctl.nm_generic
 #' @param dollar character.  Subroutine to target
 #' @param ... arguments to be passed to text()
 #' @export
-dollar <- function(m, dollar, ...) {
-  m %>% target(dollar) %>% text(...)
+dollar <- function(m, dollar, ..., add_dollar_text = TRUE) {
+  m %>% target(dollar) %>% text(..., add_dollar_text = add_dollar_text)
 }
 
 ## pipe for string functions

---FILE: R/manual_edit.R---
@@ -11,9 +11,7 @@ start_manual_edit <- function(m, name){
 #' @export
 manual_edit <- function(m, description){
   
-  if(.Platform$OS.type == ""unix"") 
-    stop(""manual_edit() is for non-unix systems.  Use manual_patch() instead"",
-         call. = FALSE)
+  .Deprecated(""manual_edit() is old. Use the make manual edit patch addin instead"")
   
   m %>% start_manual_edit()
   message(
@@ -70,17 +68,17 @@ manual_patch <- function(m){
   
   message(""copy-paste the following into your script to apply:\n
   [nm_object] %>%
-  apply_patch(\"""", res$patch_name,""\"")
+  apply_manual_edit(\"""", res$patch_name,""\"")
 
 (dont forget to comment your code)"")
   
 }
 
 #' @export
 start_manual_edit_unix <- function(m, combine_patch = NA_character_){
-  if(.Platform$OS.type != ""unix"") 
-    stop(""patching functionality only implemented for linux/unix systems\n consider manual_edit() instead"",
-         call. = FALSE)
+  # if(.Platform$OS.type != ""unix"") 
+  #   stop(""patching functionality only implemented for linux/unix systems\n consider manual_edit() instead"",
+  #        call. = FALSE)
   
   if(is_nm_list(m) & length(m) > 1)
     stop(""m cannot refer to multiple runs"", call. = FALSE)
@@ -92,20 +90,24 @@ start_manual_edit_unix <- function(m, combine_patch = NA_character_){
   dir.create(dirname(patch_path), showWarnings = FALSE, recursive = TRUE)
   
   ## this isn't used - delete
-  old_file_path <- file.path(run_in(m), paste0(ctl_name(m), "".old""))
   
-  old_ctl_path <- ctl_path(m)
-  new_ctl_path <- file.path(run_in(m), paste0(""manual_"", ctl_name(m)))
+  temp_ctl_path <- file.path(run_in(m), paste0(""manual_"", ctl_name(m)))
 
-  m %>% write_ctl()
-  mnew <- m
-  mnew <- mnew %>% ctl_path(new_ctl_path) %>% write_ctl()
-  if(!is.na(combine_patch)) mnew <- mnew %>% apply_patch(combine_patch)
+  mnew <- m %>% ctl_path(temp_ctl_path) %>% write_ctl()
+
+  ## soft unstage all first, then add only the file
+  if(!git_cmd_available) stop(""need git available from system() for this to work"")
+
+  system(""git reset"", intern = TRUE) ## for some reason git2r::reset() doesn't reset
+  git2r::add(path = ctl_path(mnew))
+  git2r::commit(message = paste(""before manual change: "", ctl_path(mnew)))
+  
+  if(!is.na(combine_patch)) m <- m %>% apply_manual_edit(combine_patch)
   
   edit_file(ctl_path(mnew)) ## edit new one
   
   res <- list()
-  res$new_ctl_path <- new_ctl_path
+  res$new_ctl_path <- temp_ctl_path
   res$patch_name <- patch_name
   res$patch_path <- patch_path
   
@@ -114,8 +116,10 @@ start_manual_edit_unix <- function(m, combine_patch = NA_character_){
 
 #' @export
 diff_manual_edit <- function(m, res){
-  diff_cmd <- paste(""diff -u"", ctl_path(m), res$new_ctl_path, "">"", res$patch_path)
-  system(diff_cmd)
+  git2r::add(path = res$new_ctl_path)
+  git2r::diff(git2r::repository(), index = TRUE, as_char = TRUE, filename = res$patch_path)
+  ## remove last commit and file 
+  system(""git reset HEAD^1"") ## for some reason git2r::reset() doesn't reset
   unlink(res$new_ctl_path)
 }
 
@@ -126,66 +130,103 @@ view_patch <- function(patch_name){
   file.show(patch_path)
 }
 
+#' apply a manual edit
+#' 
+#' Best used with ""make manual edit patch"" addin.
+#' 
+#' @param m nm object
+#' @param patch_name character name of patch
+#' 
+#' @export
+apply_manual_edit <- function(m, patch_name){
+  UseMethod(""apply_manual_edit"")
+}
+
 #' @export
-apply_patch <- function(m, patch_name){
+apply_manual_edit.nm_generic <- function(m, patch_name){
   
   patch_path <- file.path(getOption(""models.dir""), 
                           ""patches"", 
                           patch_name)
   
-  #write_ctl(m) 
+  patch_text <- readLines(patch_path)
   
-  ctl_paths <- ctl_path(m)
+  temp_ctl_path <- file.path(run_in(m), paste0(""manual_"", ctl_name(m)))
+  mnew <- m %>% ctl_path(temp_ctl_path) %>% write_ctl()
   
-  patch_cmd <- paste(""patch -i"", patch_path, ctl_paths)
-  patch_cmd <- paste(patch_cmd, collapse = "" ; "")
+  ## edit and save temporary patch
+  patch_text <- gsub(""(a/).*?manual_\\S+"", paste0(""\\1"", temp_ctl_path), patch_text, perl = TRUE)
+  patch_text <- gsub(""(b/).*?manual_\\S+"", paste0(""\\1"", temp_ctl_path), patch_text, perl = TRUE)
   
-  ## for some reason no ""patch"" on AZ rstudio server :(
-  ## use system_nm instead
-
-  ## 1.save the file via ssh  
-  ## remove from orig and rej files in system_nm instead of R
-  ##  because sometimes delay
-  ## also get modified file via the command (to avoid file sync issue)
-  
-  patch_cmd <- paste0(
-    ## save the file via ssh  
-    paste0(""echo "", 
-           shQuote(gsub(""\\$"", ""\\\\$"", paste(text(as_nm_generic(m)), collapse = ""\n""))),
-           "" > "", ctl_paths), "";"",
-    ## remove orig and rej files
-    paste0(""rm -f "", paste0(ctl_paths, "".orig"")), "";"",
-    paste0(""rm -f "", paste0(ctl_paths, "".rej"")), "";"",
-#    paste0(""ls "", paste0(ctl_paths), ""*;""),
-#    paste0(""md5sum "", paste0(ctl_paths), "";""),
-    patch_cmd, "";"",
-#    paste0(""rm -f "", paste0(ctl_paths, "".orig"")), "";"",
-#    paste0(""rm -f "", paste0(ctl_paths, "".rej"")), "";"",
-#    paste0(""ls "", paste0(ctl_paths), ""*;""),
-#    paste0(""md5sum "", paste0(ctl_paths), "";""),
-    ""echo patched file below ;"",
-    paste0(""cat "", ctl_paths)
-  )
-  
-  out <- system_nm(patch_cmd, dir = getwd(), intern = TRUE)
-  
-  out_file <- out[seq_along(out) > match(""patched file below"" , out)]
-  preamble <- out[seq_along(out) < match(""patched file below"" , out)]
-  cat(preamble, sep = ""\n"")
+  patch_path_tmp <- paste0(patch_path, "".tmp"")
+  writeLines(patch_text, patch_path_tmp)
+  
+  patch_cmd <- paste(""git apply"", patch_path_tmp)
 
-  was_nm_list <- inherits(m, ""nm_list"")
+  if(!git_cmd_available) stop(""need git available from system() for this to work"")  
+  system(patch_cmd)  ## win = no need to use system_nm, no file sync issues
   
-  m <- as_nm_generic(m) %>% 
-    ctl_contents_simple(out_file)
+  out_file <- readLines(temp_ctl_path)
   
-  if(was_nm_list) m <- as_nm_list(m)
+  if(0){  ## delete this if working in AZ
+    ctl_paths <- ctl_path(m)
+    patch_cmd <- paste(""patch -i"", patch_path, ctl_paths)
+    patch_cmd <- paste(patch_cmd, collapse = "" ; "")
+    
+    ## for some reason no ""patch"" on AZ rstudio server :(
+    ## use system_nm instead
+    
+    ## 1.save the file via ssh  
+    ## remove from orig and rej files in system_nm instead of R
+    ##  because sometimes delay
+    ## also get modified file via the command (to avoid file sync issue)
+    
+    patch_cmd <- paste0(
+      ## save the file via ssh  
+      paste0(""echo "", 
+             shQuote(gsub(""\\$"", ""\\\\$"", paste(text(as_nm_generic(m)), collapse = ""\n""))),
+             "" > "", ctl_paths), "";"",
+      ## remove orig and rej files
+      paste0(""rm -f "", paste0(ctl_paths, "".orig"")), "";"",
+      paste0(""rm -f "", paste0(ctl_paths, "".rej"")), "";"",
+      #    paste0(""ls "", paste0(ctl_paths), ""*;""),
+      #    paste0(""md5sum "", paste0(ctl_paths), "";""),
+      patch_cmd, "";"",
+      #    paste0(""rm -f "", paste0(ctl_paths, "".orig"")), "";"",
+      #    paste0(""rm -f "", paste0(ctl_paths, "".rej"")), "";"",
+      #    paste0(""ls "", paste0(ctl_paths), ""*;""),
+      #    paste0(""md5sum "", paste0(ctl_paths), "";""),
+      ""echo patched file below ;"",
+      paste0(""cat "", ctl_paths)
+    )
+    
+    out <- system_nm(patch_cmd, dir = getwd(), intern = TRUE)
+    
+    out_file <- out[seq_along(out) > match(""patched file below"" , out)]
+    preamble <- out[seq_along(out) < match(""patched file below"" , out)]
+    cat(preamble, sep = ""\n"")
+    
+    was_nm_list <- inherits(m, ""nm_list"")
+    
+    m <- as_nm_generic(m) %>% 
+      ctl_contents_simple(out_file)
+    
+    if(was_nm_list) m <- as_nm_list(m)
+    
+    
+  }
   
-  #print(m %>% dollar(""SIGMA""))
+
+  m <- m %>% ctl_contents_simple(out_file)
   
   invisible(m)
   
 }
 
+#' @export
+apply_manual_edit.nm_list <- Vectorize_nm_list(apply_manual_edit.nm_generic, SIMPLIFY = FALSE)
+
+
 manual_patch_app <- function() {
   
   ## have base object

---FILE: R/utils.R---
@@ -1,3 +1,5 @@
+is_single_na <- function(x) if(length(x) == 1) is.na(x) else FALSE
 
+#' check if git is available on command line
 
-is_single_na <- function(x) if(length(x) == 1) is.na(x) else FALSE
+git_cmd_available <- Sys.which(""git"") != """"

---FILE: inst/extdata/manual_patch/server.R---
@@ -65,7 +65,7 @@ server <- function(input, output, session) {
       final_text <- 
         paste0(""copy-paste the following into your script to apply:\n
   [nm_object] %>%
-  apply_patch(\"""", res()$patch_name,""\"")"")
+  apply_manual_edit(\"""", res()$patch_name,""\"")"")
       message(final_text)
     }
     stopApp()

---FILE: inst/rstudio/addins.dcf---
@@ -1,5 +1,5 @@
 Name: make manual edit patch
-Description: create patch to apply with apply_patch()
+Description: create patch to apply with apply_manual_edit()
 Binding: manual_patch_app
 Interactive: true
 

---FILE: man/apply_manual_edit.Rd---
@@ -0,0 +1,16 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/manual_edit.R
+\name{apply_manual_edit}
+\alias{apply_manual_edit}
+\title{apply a manual edit}
+\usage{
+apply_manual_edit(m, patch_name)
+}
+\arguments{
+\item{m}{nm object}
+
+\item{patch_name}{character name of patch}
+}
+\description{
+Best used with ""make manual edit patch"" addin.
+}

---FILE: man/dollar.Rd---
@@ -4,7 +4,7 @@
 \alias{dollar}
 \title{Get/set existing subroutine}
 \usage{
-dollar(m, dollar, ...)
+dollar(m, dollar, ..., add_dollar_text = TRUE)
 }
 \arguments{
 \item{m}{nm object}

---FILE: man/git_cmd_available.Rd---
@@ -0,0 +1,16 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/utils.R
+\docType{data}
+\name{git_cmd_available}
+\alias{git_cmd_available}
+\title{check if git is available on command line}
+\format{
+An object of class \code{logical} of length 1.
+}
+\usage{
+git_cmd_available
+}
+\description{
+check if git is available on command line
+}
+\keyword{datasets}"
tsahota,NMproject,e83452eaf8738292d37f6c3e8643524ca7b71513,tarj,tarjinder.z.sahota@gsk.com,2021-02-06T23:17:28Z,tarj,tarjinder.z.sahota@gsk.com,2021-02-06T23:17:28Z,packagename fix + add code_library path if doesn't exist,R/NMproject.R;inst/extdata/examples/testthat/Scripts/basic_gof.Rmd;inst/extdata/examples/testthat/Scripts/empty_test_setup.R;inst/extdata/examples/testthat/Scripts/nm.log2.R;inst/extdata/examples/testthat/Scripts/nm.log2.Rmd;inst/extdata/examples/testthat/Scripts/testthat_setup.R;inst/rmarkdown/templates/nm_general/skeleton/skeleton.Rmd;inst/rmarkdown/templates/nm_log/skeleton/skeleton.Rmd;inst/rmarkdown/templates/post_proc/skeleton/skeleton.Rmd,True,True,True,False,11,8,19,"---FILE: R/NMproject.R---
@@ -107,6 +107,9 @@ set_nm_opts <- function(){
   
   if(is.null(getOption(""nmtran_exe_path""))) options(nmtran_exe_path=get_nm_tran_path())
   
+  if(is.null(getOption(""code_library_path""))) 
+    options(code_library_path=system.file(""extdata"", ""CodeLibrary"", package = ""NMproject""))
+  
 }
 
 get_nm_tran_path <- function(name = ""default""){

---FILE: inst/extdata/examples/testthat/Scripts/basic_gof.Rmd---
@@ -27,7 +27,7 @@ if(!interactive()) m <- params$m
 ```
 
 ```{r echo=FALSE,message=FALSE}
-library(NMprojectAZ)
+library(NMproject)
 devtools::load_all(""~/NMproject"")
 ```
 

---FILE: inst/extdata/examples/testthat/Scripts/empty_test_setup.R---
@@ -16,7 +16,7 @@
 
 library(future)
 future::plan(""future::multiprocess"", workers = 2)
-library(NMprojectAZ)
+library(NMproject)
 library(dplyr)
 devtools::load_all(""~/NMproject/"")
 load_localpackage()

---FILE: inst/extdata/examples/testthat/Scripts/nm.log2.R---
@@ -14,7 +14,7 @@
 
 library(future)
 future::plan(""future::multiprocess"", workers = 2)
-library(NMprojectAZ)
+library(NMproject)
 library(dplyr)
 devtools::load_all(""~/NMproject/"")
 load_localpackage()

---FILE: inst/extdata/examples/testthat/Scripts/nm.log2.Rmd---
@@ -17,7 +17,7 @@ opts_chunk$set(echo = TRUE)
 ```{r echo=FALSE,message=FALSE}
 library(future)
 future::plan(""future::multiprocess"", workers = 2)
-library(NMprojectAZ)
+library(NMproject)
 library(dplyr)
 devtools::load_all(""~/NMproject/"")
 load_localpackage()

---FILE: inst/extdata/examples/testthat/Scripts/testthat_setup.R---
@@ -8,7 +8,7 @@
 
 library(future)
 future::plan(""future::multiprocess"", workers = 2)
-library(NMprojectAZ)
+library(NMproject)
 library(dplyr)
 devtools::load_all(""~/NMproject/"")
 load_localpackage()

---FILE: inst/rmarkdown/templates/nm_general/skeleton/skeleton.Rmd---
@@ -18,7 +18,7 @@ opts_chunk$set(message = TRUE)
 
 ```{r echo=FALSE,message=FALSE}
 ## LOAD PACKAGES HERE
-library(NMprojectAZ)
+library(NMproject)
 library(future)
 future::plan(""future::multiprocess"", workers = 2)
 

---FILE: inst/rmarkdown/templates/nm_log/skeleton/skeleton.Rmd---
@@ -18,7 +18,7 @@ opts_chunk$set(message = TRUE)
 
 ```{r echo=FALSE,message=FALSE}
 ## LOAD PACKAGES HERE
-library(NMprojectAZ)
+library(NMproject)
 library(future)
 future::plan(""future::multiprocess"", workers = 2)
 

---FILE: inst/rmarkdown/templates/post_proc/skeleton/skeleton.Rmd---
@@ -37,7 +37,7 @@ if(!is.null(knitr::opts_knit$get('rmarkdown.pandoc.to'))){
 ```
 
 ```{r}
-library(NMprojectAZ)
+library(NMproject)
 ```
 
 ## model object"
tsahota,NMproject,41d66882de658bdba9c21da183e8f0b7acf5d4d5,tarj,tarjinder.z.sahota@gsk.com,2021-01-03T18:11:51Z,tarj,tarjinder.z.sahota@gsk.com,2021-01-03T18:11:51Z,bug fix new run caching,R/run_nm.R,False,True,True,False,2,2,4,"---FILE: R/run_nm.R---
@@ -54,8 +54,8 @@ run_nm.nm_generic <- function(m, wait=getOption(""wait""),
   if(!force){
     ## pull existing checksum info
     #run_cache_disk <- lapply(run_cache_paths(m), readRDS)
-    run_cache_disk <- readRDS(run_cache_paths(m))
-    if(length(run_cache_disk) > 0){
+    if(length(run_cache_paths(m)) > 0){
+      run_cache_disk <- readRDS(run_cache_paths(m))
       ## get current checksum
       current_checksums <- run_checksums(m)
       ## determine matches"
tsahota,NMproject,5d04d0b6953047006b1cba8791da460d8584c1cc,klgk669,klgk669@rstudio-ha00.scp.astrazeneca.net,2020-08-25T15:31:50Z,klgk669,klgk669@rstudio-ha00.scp.astrazeneca.net,2020-08-25T15:31:50Z,BLOCK(N) (without space) bug fix. COV names defined as COV_par1_par2. Two field omega comment convention changed from name;unit to name;trans,R/NMprojectExtra.R,False,True,True,False,25,2,27,"---FILE: R/NMprojectExtra.R---
@@ -2841,6 +2841,8 @@ raw_init_random <- function(m, replace, dollar = ""OMEGA""){
     d$x_nc <- gsub(""\\s*\\)"",""\\)"",d$x_nc, perl = TRUE)
     d$x_nc <- gsub_in_brackets(""\\s+"", "","", d$x_nc)  
     d$x_nc <- gsub_out_brackets("","", "" "", d$x_nc)  
+    ## subsequent code needs OMEGA BLOCK (n) format
+    d$x_nc <- gsub(""BLOCK\\("", ""BLOCK ("",d$x_nc)
     
     x_nc <- d$x_nc
     x_nc <- paste(x_nc, collapse = "" \n "")
@@ -2883,7 +2885,7 @@ raw_init_random <- function(m, replace, dollar = ""OMEGA""){
     
     ##########################
     ## label parameters
-    
+
     d$block <- NA
     get_block_size <- FALSE
     current_block_size <- 1
@@ -3000,14 +3002,35 @@ raw_init_random <- function(m, replace, dollar = ""OMEGA""){
     d$name <- trimws(d$name)
     
     d$unit <- NA
-    d$unit[d$comment_nfields %in% 2] <- gsub(two_field_regex, ""\\2"", d$comment[d$comment_nfields %in% 2])
+    #d$unit[d$comment_nfields %in% 2] <- gsub(two_field_regex, ""\\2"", d$comment[d$comment_nfields %in% 2])
     d$unit[d$comment_nfields %in% 3] <- gsub(three_field_regex, ""\\2"", d$comment[d$comment_nfields %in% 3])
     d$unit <- trimws(d$unit)
     
     d$trans <- NA
+    d$trans[d$comment_nfields %in% 2] <- gsub(two_field_regex, ""\\2"", d$comment[d$comment_nfields %in% 2])
     d$trans[d$comment_nfields %in% 3] <- gsub(three_field_regex, ""\\3"", d$comment[d$comment_nfields %in% 3])
     d$trans <- trimws(d$trans)
     
+    ## modify name, unit and trans for off diagonals
+    off_diagonal <- (d$omega1 != d$omega2) %in% TRUE
+    if(any(off_diagonal)){
+      d$unit[off_diagonal] <- NA
+      d$trans[off_diagonal] <- NA
+      
+      off_diagonal_names <- sapply(which(off_diagonal), function(i){
+        omega1 <- d$omega1[i]
+        omega2 <- d$omega2[i]
+        name1 <- d$name[d$omega1 %in% omega1 & d$omega2 %in% omega1]
+        name2 <- d$name[d$omega1 %in% omega2 & d$omega2 %in% omega2]
+        
+        name1 <- gsub(""IIV_"", """", name1)
+        name2 <- gsub(""IIV_"", """", name2)
+        new_name <- paste0(""COV_"",name1,""_"",name2)
+        new_name
+      })
+      d$name[off_diagonal] <- off_diagonal_names  
+    }
+    
     d$comment_nfields <- NULL
     
     PK_etas <- m %>% target(PK_PRED) %>% grab_variables(""\\bETA\\([0-9+]\\)"")"
tsahota,NMproject,5f3c7773ca29290f43eb3f8462641cc3cfd0259e,klgk669,klgk669@rstudio-ha00.scp.astrazeneca.net,2020-08-25T15:30:35Z,klgk669,klgk669@rstudio-ha00.scp.astrazeneca.net,2020-08-25T15:30:35Z,test fix,tests/testthat/test-cov.R,False,True,True,False,2,2,4,"---FILE: tests/testthat/test-cov.R---
@@ -75,7 +75,7 @@ test_that(""covariate modelling"",{
   ## take a winner
   m0_f1 <- d_f1$m[1]
   
-  d_f2 <- m0_f1 %>% covariate_step_setup(run_id = ""m0_f2"",
+  d_f2 <- m0_f1 %>% covariate_step_tibble(run_id = ""m0_f2"",
                                          run_in = ""Models/m0_cov"",
                                          dtest = dtest,
                                          direction = ""forward"")
@@ -86,7 +86,7 @@ test_that(""covariate modelling"",{
   ## take a winner
   m0_f2 <- d_f2$m[2]
   
-  d_b1 <- m0_f2 %>% covariate_step_setup(run_id = ""m0_b1"",
+  d_b1 <- m0_f2 %>% covariate_step_tibble(run_id = ""m0_b1"",
                                          run_in = ""Models/m0_cov"",
                                          dtest = dtest,
                                          direction = ""backward"")"
tsahota,NMproject,424682072794d9c704dca478ba8bfa415c298d5c,klgk669,klgk669@rstudio-ha00.scp.astrazeneca.net,2020-08-24T15:39:57Z,klgk669,klgk669@rstudio-ha00.scp.astrazeneca.net,2020-08-24T15:39:57Z,manual patch can integrate patches,R/NMprojectExtra.R;R/manual_edit.R;inst/extdata/manual_patch/server.R;inst/extdata/manual_patch/ui.R,False,True,True,False,121,15,136,"---FILE: R/NMprojectExtra.R---
@@ -623,16 +623,28 @@ set_target_text <- function(m, text){
 
 #' @importFrom graphics text
 #' @export
-text.nm_generic <- function(x, text, append = FALSE, ...){
+text.nm_generic <- function(x, text, append = FALSE, after = character(), ...){
   m <- x
   current_text <- get_target_text(m)
   if(missing(text)) return(current_text)
   
   text <- paste(text, collapse = ""\n"")
   text <- strsplit(text, split = ""\n"")[[1]]
-  #text <- trimws(text)
+  text <- trimws(text)
   
-  if(append) text <- c(current_text,text)
+  if(length(after)) append <- TRUE
+  if(append) {
+    if(!length(after)) text <- c(current_text,text)
+    
+    if(length(after)){
+      matches <- grep(after, current_text)
+      if(!length(matches)) stop(""cannot find 'after'"")
+      matches <- matches[1]
+      text <- append(current_text, text, after = matches)
+    }
+    
+  }
+    
   
   if(is.na(target(m))) {
     #stop(""not developed yet"")
@@ -1798,7 +1810,7 @@ dollar <- function(m, dollar, ...) {
 #' @export
 n_thetas <- function(m){
   param_info <- param_info(m)
-  nrow(param_info[grepl(""THETA"", param_info$parameter)])
+  nrow(param_info[grepl(""THETA"", param_info$parameter),])
 }
 
 grab_variables0 <- function(text, pattern){
@@ -2389,7 +2401,8 @@ remove_parameter <- function(m, name){
 #' @export
 add_mixed_param <- function(m, name, 
                             init = 1, unit ="""", trans = c(""LOG""),
-                            position = NA_integer_){
+                            position = NA_integer_,
+                            after = character()){
   
   trans <- match.arg(trans)
   
@@ -2416,7 +2429,7 @@ add_mixed_param <- function(m, name,
       text(""TV_NEWPARAM_=EXP(THETA(_N_PARAM_))
 MU__MU_PARAM_=LOG(TV_NEWPARAM_)
 _NEWPARAM_ = EXP(MU__MU_PARAM_+ETA(_MU_PARAM_))
-"", append = TRUE) %>%
+"", append = TRUE, after = after) %>%
       target(""THETA"") %>%
       text(paste(signif(log(init),2), ""      ; TV_NEWPARAM_ ; _UNIT_PARAM_ ; "",
                  trans), append = TRUE) %>%
@@ -4075,6 +4088,76 @@ nm_render.nm_generic <- function(m,
 #' @export
 nm_render.nm_list <- Vectorize_nm_list(nm_render.nm_generic, SIMPLIFY = FALSE, invisible = TRUE)
 
+#' @export
+nm_list_render <- function(m, 
+                           input, 
+                           name,
+                           output_file = NA,
+                           args = list(),
+                           force = FALSE,
+                           async = FALSE,
+                           ...){
+  if(is.na(output_file))
+    output_file <- paste0(
+      basename(tools::file_path_sans_ext(input)),
+      ""."", name, "".nb.html""
+    )
+  
+  if(""m"" %in% names(args))
+    stop(""can't have m in arg.  m is reserved for model object"")
+  
+  args <- c(args, list(m = as_nm_list(m)))
+  
+  output_dir <- ""Results""
+  output_path <- file.path(output_dir, output_file)
+  
+  ## if force is TRUE skip caching and run
+  if(!force){
+    ## if output_path doesn't exist skip caching and run
+    # render_cache_disk <- lapply(render_cache_paths(m, input), readRDS)
+    # if(length(render_cache_disk) > 0){
+    #   ## get current checksum
+    #   current_checksums <- render_checksums(m, input)
+    #   ## determine matches
+    #   matches <- sapply(render_cache_disk, function(i) {
+    #     identical(i$checksums, current_checksums)
+    #   })
+    #   if(any(matches)){
+    #     message(""nm_render cache found, skipping... use nm_render(force = TRUE) to override"")
+    #     ## pick highest available version
+    #     m <- m %>% result_files(output_file)
+    #     return(invisible(m))    ## if up to date, skip
+    #   }
+    # } 
+  }
+  
+  if(async){
+    f0 <- future::future({
+      rmarkdown::render(input = input,
+                        output_file = output_file,
+                        output_dir = output_dir,
+                        params = args,
+                        envir = new.env(),
+                        ...)
+      
+    })
+  } else {
+    rmarkdown::render(input = input,
+                      output_file = output_file,
+                      output_dir = output_dir,
+                      params = args,
+                      envir = new.env(),
+                      ...)
+  }
+  
+  ## use as_nm_generic incase m is redefined in rmd
+  
+  #m <- m %>% save_render_cache(input)
+  
+  invisible(m)
+}
+  
+
 #' Create new R notebook
 #' @param script_name character
 #' @param overwrite logical. Whether to overwrite existing file (default = FALSE)
@@ -5339,7 +5422,7 @@ data_ignore_char.nm_generic <- function(r, data){
   
   dol_data <- unlist(strsplit(dol_data, split = ""[,;]""))
   
-  if(missing(data)) data <- input_data(r, filter = FALSE, silent = TRUE)
+  if(missing(data)) data <- input_data(r, filter = FALSE)
   
   r_data_names <- names(data)
   ## now get nonmem names
@@ -5702,3 +5785,4 @@ covariance_result <- function(r,trans=TRUE){
 
 ################
 
+

---FILE: R/manual_edit.R---
@@ -77,7 +77,7 @@ manual_patch <- function(m){
 }
 
 #' @export
-start_manual_edit_unix <- function(m){
+start_manual_edit_unix <- function(m, combine_patch = NA_character_){
   if(.Platform$OS.type != ""unix"") 
     stop(""patching functionality only implemented for linux/unix systems\n consider manual_edit() instead"",
          call. = FALSE)
@@ -91,13 +91,16 @@ start_manual_edit_unix <- function(m){
   patch_path <- file.path(getOption(""models.dir""), ""patches"", patch_name)
   dir.create(dirname(patch_path), showWarnings = FALSE, recursive = TRUE)
   
+  ## this isn't used - delete
   old_file_path <- file.path(run_in(m), paste0(ctl_name(m), "".old""))
   
   old_ctl_path <- ctl_path(m)
   new_ctl_path <- file.path(run_in(m), paste0(""manual_"", ctl_name(m)))
-  
+
   m %>% write_ctl()
-  mnew <- m %>% ctl_path(new_ctl_path) %>% write_ctl()
+  mnew <- m
+  mnew <- mnew %>% ctl_path(new_ctl_path) %>% write_ctl()
+  if(!is.na(combine_patch)) mnew <- mnew %>% apply_patch(combine_patch)
   
   edit_file(ctl_path(mnew)) ## edit new one
   
@@ -185,6 +188,10 @@ apply_patch <- function(m, patch_name){
 
 manual_patch_app <- function() {
   
+  ## have base object
+  
+  ## include a patch to modify
+  
   shiny_dir <- system.file(""extdata/manual_patch"",package=""NMproject"")
   .sso_env$.currentwd <- getwd()  # see zzz.R for .sso_env
   on.exit({

---FILE: inst/extdata/manual_patch/server.R---
@@ -7,11 +7,25 @@ setwd(.currentwd)
 server <- function(input, output, session) {
   
   m <- eventReactive(input$go, {
-    eval(parse(text = input$model_object))
+    
+    object <- eval(parse(text = input$model_object))
+    
+    patch_name <- input$patch_name
+    ## clean up
+    patch_name <- gsub(""\"""", """", patch_name)
+
+    if(patch_name %in% """") patch_name <- NA_character_
+        
+    ## apply patch
+    reslist <- list()
+    reslist$m <- object
+    reslist$patch_name <- patch_name
+    reslist
   })
-  
+
   res <- eventReactive(input$go, {
-    start_manual_edit_unix(m())
+    ## TODO: apply patch if one exists
+    start_manual_edit_unix(m()$m, combine_patch = m()$patch_name)
   })
   
   # ctx <- eventReactive(input$go, {
@@ -47,7 +61,7 @@ server <- function(input, output, session) {
       # if(normalizePath(res()$new_ctl_path) == normalizePath(ctx()$path)){
       #   rstudioapi::documentClose(ctx(), save = TRUE)
       # }
-      diff_manual_edit(m(), res())
+      diff_manual_edit(m()$m, res())
       final_text <- 
         paste0(""copy-paste the following into your script to apply:\n
   [nm_object] %>%

---FILE: inst/extdata/manual_patch/ui.R---
@@ -11,7 +11,8 @@ selected_text <- ctx$selection[[1]]$text
 ui <- miniPage(
   gadgetTitleBar(""Manual Edit""),
   miniContentPanel(
-    textInput(""model_object"", ""model object"", value = selected_text),
+    textInput(""model_object"", ""base model object"", value = selected_text),
+    textInput(""patch_name"", ""(optional) patch to replace""),
     actionButton(""go"", ""start edit""),
     br(),
     textOutput(""out_text""),"
tsahota,NMproject,319876704273c665970d69fc1c99c7aea71a4e09,klgk669,klgk669@rstudio-ha00.scp.astrazeneca.net,2020-08-21T11:44:03Z,klgk669,klgk669@rstudio-ha00.scp.astrazeneca.net,2020-08-21T11:44:03Z,remove_cov bug fix,R/NMprojectExtra.R,False,True,True,False,8,8,16,"---FILE: R/NMprojectExtra.R---
@@ -4573,8 +4573,8 @@ remove_cov.nm_generic <- function(ctl, param, cov, state = 2, continuous = TRUE,
   }
 
   matched_theta <- grep(paste0(""\\$THETA\\s.*;.*"",tvparam, cov), ctl$THETA)
-  if(length(matched_theta) == 0)
-    stop(""can't find $THETA entry to remove- did you add with add_cov()?"")
+  #if(length(matched_theta) == 0)
+  #  stop(""can't find $THETA entry to remove- did you add with add_cov()?"")
 
   ctl$THETA <- ctl$THETA[setdiff(seq_along(ctl$THETA), matched_theta)]
 
@@ -4593,8 +4593,8 @@ remove_cov.nm_list <- Vectorize_nm_list(remove_cov.nm_generic, SIMPLIFY = FALSE)
 #' @examples 
 #' \dontrun{
 #' 
-#' dcov <- get_data(m1, filter = TRUE)
-#' dcov <- dcov[!duplicated(dcov$NMSEQSID), ]
+#' dcov <- input_data(m1, filter = TRUE)
+#' dcov <- dcov[!duplicated(dcov$ID), ]
 #' covariate_scenarios <- bind_rows(
 #'   tibble(cov = ""HEALTHGP"", value = c(0, 1)),
 #'   tibble(cov = ""HEPATIC"", value = unique(dcov$HEPATIC[dcov$HEPATIC > -99])),
@@ -4663,13 +4663,13 @@ cov_forest_data <- function(m, covariate_scenarios){
     potential_pars <- pars[potential_pars]
     
     matches <- unlist(lapply(potential_pars, function(potential_par){
-      grep(paste0(potential_par, ""COV = .*"", par_cov), PK_text_R)
+      grep(paste0(potential_par, ""COV\\s*=\\s*.*"", par_cov), PK_text_R)
     }))
     
     if(length(matches) != 1) stop(""can't get param value for "", par_cov, call. = FALSE)
     
     PK_matched_row <- PK_text_R[matches]
-    par <- gsub(""^(.*)COV .*$"", ""\\1"", PK_matched_row)
+    par <- gsub(""^(.*)COV\\s*.*$"", ""\\1"", PK_matched_row)
     
     #par <- sapply(pars, function(par) grepl(paste0(""^"", par), par_cov))
     #par <- pars[par]
@@ -4694,7 +4694,7 @@ cov_forest_data <- function(m, covariate_scenarios){
     
     
     ## redefine data covariates with 
-    ##browser()
+    ## browser()
     dcov_sc <- covariate_scenarios[covariate_scenarios$cov %in% cov, ]
     if(nrow(dcov_sc) == 0)
       stop(""couldn't find covariate "", cov, "" in covariate scenarios"")
@@ -4800,7 +4800,7 @@ cov_forest_plot <- function(d){
     ggplot2::geom_vline(xintercept = 1, color='black', linetype='dashed') +
     ggplot2::facet_grid(par~., scales = ""free_y"", space = ""free"") +
     ggplot2::scale_y_discrete("""") +
-    ggplot2::scale_x_continuous(""effect size \n (bars: 95% CI)"", breaks = seq(floor(min(d$low)), ceiling(max(d$upp)), 0.1))
+    ggplot2::scale_x_continuous(""effect size \n"", breaks = seq(floor(min(d$low)), ceiling(max(d$upp)), 0.1))
 }
 
 "
tsahota,NMproject,4c5d744b3b649767f05bef6f7326957067df36e2,klgk669,klgk669@rstudio-ha00.scp.astrazeneca.net,2020-06-17T08:06:01Z,klgk669,klgk669@rstudio-ha00.scp.astrazeneca.net,2020-06-17T08:06:01Z,bug fixes,R/NMprojectExtra.R;man/summary_wide.Rd,False,True,True,False,13,5,18,"---FILE: R/NMprojectExtra.R---
@@ -4244,9 +4244,9 @@ summary.nm_generic <- function(object, ref_model = NA, parameters = c(""none"", ""n
 #' }
 
 #' @export
-summary_wide <- function(..., parameters = c(""none"", ""new"", ""all""), m = TRUE){
+summary_wide <- function(..., parameters = c(""none"", ""new"", ""all""), m = TRUE, trans = TRUE){
   parameters <- match.arg(parameters)
-  d <- summary(..., parameters = parameters)
+  d <- summary(..., parameters = parameters, trans = trans)
   if(m) d$m <- c(...)
   d
 }
@@ -4859,7 +4859,7 @@ param_cov_diag <- function(r, param, cov, ..., categorical = FALSE, plot_tv = TR
 
   pk_block <- ctl[[pk_dollar]]
 
-  pk_block <- nonmem_code_to_r(pk_block)
+  pk_block <- nonmem_code_to_r(pk_block, eta_to_0 = FALSE)
 
   pk_block_param <- parse(text = c(pk_block, param))
   pk_block_tvparam <- parse(text = c(pk_block,tvparam))
@@ -5603,7 +5603,14 @@ nm_boot <- function(m, replicates, dboot_rds = ""dboots_big.RDS""){
 ## TODO: nm_render use drake instead
 ##  it will work better probably (evaluate this)
 
-## TODO: decision give message if ""esc"" is hit
+## TODO: bug in auto_decision being treated as manual
+## TODO: decision stopping even selected y in a script
+##         maybe drake doesn't work with environments?
+
+## TODO: ignore split between getter and setter
+## TODO: ignore -> fill_ignore (name conflict with drake)
+## TODO: fill_ignore() should eliminate all ignores
+
 
 
 ###############

---FILE: man/summary_wide.Rd---
@@ -7,7 +7,8 @@ summary_wide <- function(..., parameters = c(""none"", ""new"", ""all"")){
   UseMethod(""summary_wide"")
 }}
 \usage{
-summary_wide(..., parameters = c(""none"", ""new"", ""all""), m = TRUE)
+summary_wide(..., parameters = c(""none"", ""new"", ""all""), m = TRUE,
+  trans = TRUE)
 }
 \description{
 #' @export"
tsahota,NMproject,b9be6455f87de554d7a1a110300c96bf8e1e74cd,klgk669,klgk669@rstudio-ha00.scp.astrazeneca.net,2020-06-12T18:59:26Z,klgk669,klgk669@rstudio-ha00.scp.astrazeneca.net,2020-06-12T18:59:26Z,patch bug fix handling file sync delays,R/manual_edit.R;tests/testthat/test-basic.R,False,True,True,False,44,8,52,"---FILE: R/manual_edit.R---
@@ -126,22 +126,58 @@ view_patch <- function(patch_name){
 #' @export
 apply_patch <- function(m, patch_name){
   
-  patch_path <- file.path(getOption(""models.dir""), ""patches"", patch_name)  
+  patch_path <- file.path(getOption(""models.dir""), 
+                          ""patches"", 
+                          patch_name)
   
-  write_ctl(m)
+  #write_ctl(m) 
   
   ctl_paths <- ctl_path(m)
   
-  unlink(paste0(ctl_paths, "".rej""))
   patch_cmd <- paste(""patch -i"", patch_path, ctl_paths)
   patch_cmd <- paste(patch_cmd, collapse = "" ; "")
-  unlink(paste0(ctl_paths, "".rej""))
   
   ## for some reason no ""patch"" on AZ rstudio server :(
   ## use system_nm instead
-  system_nm(patch_cmd, dir = getwd())
-  
-  m <- m %>% ctl_contents(ctl_path(m), update_ctl = FALSE)
+
+  ## 1.save the file via ssh  
+  ## remove from orig and rej files in system_nm instead of R
+  ##  because sometimes delay
+  ## also get modified file via the command (to avoid file sync issue)
+  
+  patch_cmd <- paste0(
+    ## save the file via ssh  
+    paste0(""echo "", 
+           shQuote(gsub(""\\$"", ""\\\\$"", paste(text(as_nm_generic(m)), collapse = ""\n""))),
+           "" > "", ctl_paths), "";"",
+    ## remove orig and rej files
+    paste0(""rm -f "", paste0(ctl_paths, "".orig"")), "";"",
+    paste0(""rm -f "", paste0(ctl_paths, "".rej"")), "";"",
+#    paste0(""ls "", paste0(ctl_paths), ""*;""),
+#    paste0(""md5sum "", paste0(ctl_paths), "";""),
+    patch_cmd, "";"",
+#    paste0(""rm -f "", paste0(ctl_paths, "".orig"")), "";"",
+#    paste0(""rm -f "", paste0(ctl_paths, "".rej"")), "";"",
+#    paste0(""ls "", paste0(ctl_paths), ""*;""),
+#    paste0(""md5sum "", paste0(ctl_paths), "";""),
+    ""echo patched file below ;"",
+    paste0(""cat "", ctl_paths)
+  )
+  
+  out <- system_nm(patch_cmd, dir = getwd(), intern = TRUE)
+  
+  out_file <- out[seq_along(out) > match(""patched file below"" , out)]
+  preamble <- out[seq_along(out) < match(""patched file below"" , out)]
+  cat(preamble, sep = ""\n"")
+
+  was_nm_list <- inherits(m, ""nm_list"")
+  
+  m <- as_nm_generic(m) %>% 
+    ctl_contents_simple(out_file)
+  
+  if(was_nm_list) m <- as_nm_list(m)
+  
+  #print(m %>% dollar(""SIGMA""))
   
   invisible(m)
   

---FILE: tests/testthat/test-basic.R---
@@ -29,7 +29,7 @@ test_that(""Project has basic functionality"",{
   options(code_library_path=c(system.file(""extdata/CodeLibrary"",package=""NMproject"")))
   expect_true(length(getOption(""code_library_path""))>0)
   
-
+  #browser()
   setup_nm_demo(overwrite = TRUE)
   expect_true(file.exists(""DerivedData/THEOPP.csv""))
 "
tsahota,NMproject,7008c596f8681f4991fc3997e323a7a13d538cf1,klgk669,klgk669@rstudio-ha00.scp.astrazeneca.net,2020-06-08T15:27:32Z,klgk669,klgk669@rstudio-ha00.scp.astrazeneca.net,2020-06-08T15:28:08Z,nm_render and decision bug fixes,R/NMprojectExtra.R,False,True,True,False,22,9,31,"---FILE: R/NMprojectExtra.R---
@@ -4034,7 +4034,7 @@ nm_render.nm_generic <- function(m,
   if(is.na(output_file))
     output_file <- paste0(
       basename(tools::file_path_sans_ext(input)),
-      ""."",run_dir(m),"".html""
+      ""."",run_dir(m),"".nb.html""
     )
   
   if(""m"" %in% names(args))
@@ -5483,7 +5483,7 @@ decision <- function(inputs = c(),
     cat(""decision outcome:\n"", outcome)
     ans <- readline(""Is this decision correct? [y]es/[n]o/[c]heck:\n"")
     if(ans %in% """"){
-      stop(""blank detected (if in R Notebooks, make sure no blank line between decision() and end of chunk"")
+      stop(""blank detected (if in R Notebooks, make sure decision() is at end of chunk with no blank line in between)"")
     }
     if(nchar(ans) > 1){
       stop(""give single character response"", call. = FALSE)
@@ -5492,7 +5492,7 @@ decision <- function(inputs = c(),
       stop(error_msg, call. =  FALSE)
     }
     if(ans %in% ""c""){
-      message(""check inputs and files with outcome, then re-execute"")
+      return(FALSE)
     }
     if(ans %in% ""y""){
       return(TRUE)
@@ -5517,14 +5517,27 @@ decision <- function(inputs = c(),
   )
   
   outdated <- drake::outdated(drake::drake_config(drpl))
-  if(!length(outdated)){
+
+  ## if up-to-date and pause/outcome is TRUE  
+  previous_outcome <- try(drake::readd(""pause""), silent = TRUE)
+  if(inherits(previous_outcome, ""try-error"")) previous_outcome <- FALSE
+  
+  if(!length(outdated) & previous_outcome){
     message(""decision inputs haven't changed, trusting that decision is still correct"")
+    suppressMessages({
+      drake::make(drpl)
+    })  
+  } else {
+    suppressMessages({
+      drake::clean(""pause"")
+      drake::make(drpl, force = TRUE)
+    })
+    current_outcome <- try(drake::readd(""pause""), silent = TRUE)
+    if(inherits(current_outcome, ""try-error"")) current_outcome <- FALSE
+    
+    if(!current_outcome) ## if outcome = FALSE, then ""[c]heck"". ([n]o makes error)
+      message(""make decision again (check inputs and files), then re-execute"")
   }
-  
-  suppressMessages({
-    drake::make(drpl)
-  })  
-  
 }
 
 #' Write bootstrap dataset"
tsahota,NMproject,3bcd17097faacb30bb4f0b78a057be83fcaa1471,klgk669,klgk669@rstudio-ha00.scp.astrazeneca.net,2020-06-08T15:25:39Z,klgk669,klgk669@rstudio-ha00.scp.astrazeneca.net,2020-06-08T15:25:39Z,bug fix apply_patch,R/manual_edit.R,False,True,True,False,1,1,2,"---FILE: R/manual_edit.R---
@@ -132,9 +132,9 @@ apply_patch <- function(m, patch_name){
   
   ctl_paths <- ctl_path(m)
   
+  unlink(paste0(ctl_paths, "".rej""))
   patch_cmd <- paste(""patch -i"", patch_path, ctl_paths)
   patch_cmd <- paste(patch_cmd, collapse = "" ; "")
-  
   unlink(paste0(ctl_paths, "".rej""))
   
   ## for some reason no ""patch"" on AZ rstudio server :("
tsahota,NMproject,da9d48a6b18362d6697751173b9f6e449c585b7b,klgk669,klgk669@rstudio-ha01.scp.astrazeneca.net,2020-06-08T09:01:57Z,klgk669,klgk669@rstudio-ha01.scp.astrazeneca.net,2020-06-08T09:01:57Z,remove patch rejections,R/manual_edit.R,False,True,True,False,2,0,2,"---FILE: R/manual_edit.R---
@@ -135,6 +135,8 @@ apply_patch <- function(m, patch_name){
   patch_cmd <- paste(""patch -i"", patch_path, ctl_paths)
   patch_cmd <- paste(patch_cmd, collapse = "" ; "")
   
+  unlink(paste0(ctl_paths, "".rej""))
+  
   ## for some reason no ""patch"" on AZ rstudio server :(
   ## use system_nm instead
   system_nm(patch_cmd, dir = getwd())"
tsahota,NMproject,af60a82f9dbed2f5817c51dd58884d2a380a8ab1,klgk669,klgk669@rstudio-ha01.scp.astrazeneca.net,2020-06-05T08:03:10Z,klgk669,klgk669@rstudio-ha01.scp.astrazeneca.net,2020-06-05T08:03:10Z,nm_boot + bug fix,NAMESPACE;R/NMprojectExtra.R;man/nm_boot.Rd;man/summary_wide.Rd,False,True,True,False,23,11,34,"---FILE: NAMESPACE---
@@ -248,14 +248,14 @@ export(ls_output)
 export(ls_tempfiles)
 export(lst_path)
 export(make_OCC_every_dose)
-export(make_boot_df)
 export(manual_edit)
 export(manual_patch)
 export(n_thetas)
 export(new_function_template)
 export(new_notebook_template)
 export(new_script)
 export(nm)
+export(nm_boot)
 export(nm_diff)
 export(nm_list_gather)
 export(nm_output)

---FILE: R/NMprojectExtra.R---
@@ -4061,8 +4061,7 @@ nm_render.nm_generic <- function(m,
         if(any(matches)){
           message(""nm_render cache found, skipping... use nm_render(force = TRUE) to override"")
           ## pick highest available version
-          # ## update object and return
-          # m <- m %>% result_files(...)
+          m <- m %>% result_files(output_file)
           return(invisible(m))    ## if up to date, skip
         }
       } 
@@ -4269,9 +4268,11 @@ summary.nm_generic <- function(object, ref_model = NA, parameters = c(""none"", ""n
 #' }
 
 #' @export
-summary_wide <- function(..., parameters = c(""none"", ""new"", ""all"")){
+summary_wide <- function(..., parameters = c(""none"", ""new"", ""all""), m = TRUE){
   parameters <- match.arg(parameters)
-  summary(..., parameters = parameters)
+  d <- summary(..., parameters = parameters)
+  if(m) d$m <- c(...)
+  d
 }
 
 #' @export
@@ -5525,7 +5526,11 @@ decision <- function(values = c(),
 #' @param replicates numeric vector of bootstrap replicate numbers
 #' @param dboot_rds path to bootstrap RDS file
 #' @export
-make_boot_df <- function(m, replicates, dboot_rds){
+nm_boot <- function(m, replicates, dboot_rds = ""dboots_big.RDS""){
+  
+  dboot_rds <- file.path(
+    tools::file_path_sans_ext(data_path(m)), dboot_rds
+  )
   
   if(!requireNamespace(""rsample""))
     stop(""install rsample"", call. = FALSE)
@@ -5584,7 +5589,14 @@ make_boot_df <- function(m, replicates, dboot_rds){
     drake::make(drpl)    
   }))
   
-  return(tibble::tibble(data_path = csv_names))
+  dboot <- tibble::tibble(data_path = csv_names, rep = replicates)
+  dboot <- dboot %>%
+    dplyr::mutate(
+      m = m %>% child(.data$rep) %>%
+        data_path(.data$data_path)
+    )
+  
+  return(dboot$m)  ## only return the nm_list
   
 }
 

---FILE: man/nm_boot.Rd---
@@ -1,10 +1,10 @@
 % Generated by roxygen2: do not edit by hand
 % Please edit documentation in R/NMprojectExtra.R
-\name{make_boot_df}
-\alias{make_boot_df}
+\name{nm_boot}
+\alias{nm_boot}
 \title{Write bootstrap dataset}
 \usage{
-make_boot_df(m, replicates, dboot_rds)
+nm_boot(m, replicates, dboot_rds = ""dboots_big.RDS"")
 }
 \arguments{
 \item{m}{nm object}

---FILE: man/summary_wide.Rd---
@@ -7,7 +7,7 @@ summary_wide <- function(..., parameters = c(""none"", ""new"", ""all"")){
   UseMethod(""summary_wide"")
 }}
 \usage{
-summary_wide(..., parameters = c(""none"", ""new"", ""all""))
+summary_wide(..., parameters = c(""none"", ""new"", ""all""), m = TRUE)
 }
 \description{
 #' @export"
tsahota,NMproject,a99929e7f1b4c74185fdc314fca0741452641a02,klgk669,klgk669@rstudio-ha01.scp.astrazeneca.net,2020-05-18T15:42:45Z,klgk669,klgk669@rstudio-ha01.scp.astrazeneca.net,2020-05-18T15:42:45Z,decision bug fix,R/NMprojectExtra.R,False,True,True,False,3,1,4,"---FILE: R/NMprojectExtra.R---
@@ -5501,9 +5501,11 @@ decision <- function(values = c(),
     inputs <- c(inputs, tools::md5sum(files))
   }
 
+  decision_inputs_exp <- rlang::parse_expr(""decision_inputs"")
+  ## that was just to avoid CRAN error with using decision_inputs below
   drpl <- drake::drake_plan(
     decision_inputs = inputs,
-    pause = wait_input(.data$decision_inputs)
+    pause = wait_input(!!decision_inputs_exp)
   )
   
   outdated <- drake::outdated(drake::drake_config(drpl))"
tsahota,NMproject,564277e6309b0769341a43eaa1830843dc86a371,klgk669,klgk669@rstudio-ha01.scp.astrazeneca.net,2020-05-18T13:59:06Z,klgk669,klgk669@rstudio-ha01.scp.astrazeneca.net,2020-05-18T13:59:06Z,addin typo fix,inst/rstudio/addins.dcf,False,False,False,False,1,1,2,"---FILE: inst/rstudio/addins.dcf---
@@ -20,5 +20,5 @@ Interactive: true
 
 Name: test if run_nm will skip
 Description: if TRUE, run_nm will skip
-Binding: in_cach_app
+Binding: in_cache_app
 Interactive: true"
tsahota,NMproject,74799d9912e0397cb33288950699dd1c57632e90,klgk669,klgk669@rstudio-ha01.scp.astrazeneca.net,2020-05-18T12:32:48Z,klgk669,klgk669@rstudio-ha01.scp.astrazeneca.net,2020-05-18T12:32:48Z,doc fix and removed ppc_plots,NAMESPACE;R/NMproject.R;R/NMprojectExtra.R;R/sim_reestExtra.R;man/nm_tran.Rd;man/ppc.Rd;man/shiny_nm.Rd;man/write_derived_data.Rd,False,True,True,False,93,67,160,"---FILE: NAMESPACE---
@@ -291,7 +291,6 @@ export(plot_iter_dygraph)
 export(plot_iter_ggplot)
 export(ppc_data)
 export(ppc_histogram_plot)
-export(ppc_plots)
 export(ppc_whisker_plot)
 export(print_ctl)
 export(prior_ctl)

---FILE: R/NMproject.R---
@@ -189,9 +189,13 @@ from_models <- function(x, models_dir=getOption(""models.dir"")) {
 
 #' Run NMTRAN step only
 #'
-#' Requires \code{options(""path/to/nmtran"")} to be set up.
+#' Runs initial part of NONMEM where control file and dataset checks are performed.
+#' Stops before running NONMEM.  Useful especially on grid infrastructures where 
+#' it may take a while for NONMEM to start return ctl/dataset errors
 #'
-#' @param x character. file name of NONMEM control stream
+#' @param x nm object
+#' @details
+#' Requires \code{options(""nmtran_exe_path"")} to be set.
 #' @export
 nm_tran <- function(x) UseMethod(""nm_tran"")
 

---FILE: R/NMprojectExtra.R---
@@ -4950,6 +4950,7 @@ convert_to_simulation.nm_list <- Vectorize_nm_list(convert_to_simulation.nm_gene
 
 ## TODO: get Renvironment_info to skip unparseable scripts
 
+#' @name ppc
 #' @export
 ppc_whisker_plot <- function(d, group, var1, var2, statistic = ""statistic""){
   requireNamespace(""ggplot2"")
@@ -4972,6 +4973,7 @@ ppc_whisker_plot <- function(d, group, var1, var2, statistic = ""statistic""){
   p
 }
 
+#' @name ppc
 #' @export
 ppc_histogram_plot <- function(d, var1, var2, statistic = ""statistic""){
   requireNamespace(""ggplot2"")
@@ -4993,14 +4995,6 @@ ppc_histogram_plot <- function(d, var1, var2, statistic = ""statistic""){
 
 }
 
-#' @export
-ppc_plots <- function(r, .f, ..., statistic = ""statistic""){
-  dppc <- r %>% ppc_data(.f, statistic = statistic)
-  p1 <- dppc %>% ppc_whisker_plot(..., statistic = statistic)
-  p2 <- dppc %>% ppc_histogram_plot(..., statistic = statistic)
-  list(p1, p2)
-}
-
 #' @export
 #cov_cov_plot <- function(d,
 #                         cov1, cov2,
@@ -5084,17 +5078,24 @@ cov_cov_plot <- function(d,
 
 #' Write derived data file.
 #'
+#' will write to (DerivedData) directory
+#' 
 #' @param d data.frame. Data frame to be saved
-#' @param name name of file (without extension)
-#' @param ...  additional arguments to be passed dto write.csv
+#' @param name name of file (without extension). If not a path, will save to
+#'  DerivedData directory
+#' @param ...  additional arguments to be passed to write.csv
 #' @export
 
 write_derived_data <- function(d, name, ...){
 
   name <- tools::file_path_sans_ext(name)
-
-  RDS_name <- file.path(""DerivedData"",paste0(name,"".RDS""))
-  csv_name <- file.path(""DerivedData"",paste0(name,"".csv""))
+  if(dirname(name) %in% "".""){
+    RDS_name <- file.path(""DerivedData"",paste0(name,"".RDS""))
+    csv_name <- file.path(""DerivedData"",paste0(name,"".csv""))
+  } else {  ## directory is specified
+      RDS_name <- paste0(name,"".RDS"")
+      csv_name <- paste0(name,"".csv"")
+  }
 
   d <- as.data.frame(d)
   if(!inherits(d, ""data.frame"")) stop(""d needs to be a data.frame or coercible into one"")
@@ -5117,7 +5118,6 @@ write_derived_data <- function(d, name, ...){
 
 read_derived_data <- function(name, na = ""."", silent = FALSE, ...){
 
-  ## TODO: expand to other types of argument
   if(length(name) != 1) stop(""name should have length 1"", call. = FALSE)
 
   load_file <- NA
@@ -5249,15 +5249,19 @@ make_OCC_every_dose <- function(dose_trigger, new_OCC_trigger){
 }
 
 #' Shiny view of NMproject
-#'
-#' @param m either nm_list object, or data.frame or list contain nm_lists
+#' 
+#' Interactively monitor NONMEM runs.  This interface is intentionally limited to monitoring
+#'  activities only.  Running and post processing should be scripted
+#' 
+#' @param m either nm_list object, or data.frame or list or environment contain nm_lists
 #' @param envir if missing, the environment to search
 #' @examples
 #' \dontrun{
 #'
-#' m1 %>% nm_shiny()
-#' d$m %>% nm_shiny()
-#' d %>% nm_shiny()
+#' shiny_nm()        ## use all objects in global workspace
+#' shiny_nm(m1)      ## only m1
+#' shiny_nm(d$m)     ## only d$m
+#' shiny_nm(d)       ## all nm_lists in d (data.frame/list/environment)
 #'
 #' }
 #' @export

---FILE: R/sim_reestExtra.R---
@@ -303,34 +303,36 @@ psn_style_scm <- function(base, run_in, dtest,
 #' @examples 
 #' \dontrun{
 #' 
-#' idEXPstat <- function(d, ...){ ## example statistic function
-#'
-#' d %>% group_by(ID, ...) %>% filter(is.na(AMT)) %>%
-#'  summarise(
-#'    AUC = AUC(time = TIME, conc = DV),
-#'    CMAX = max(DV, na.rm = TRUE),
-#'    TMAX = TIME[which.max(DV)]
-#'  ) %>%
-#'  tidyr::gather(key = ""exposure"", value = ""statistic"", AUC:TMAX) %>%
-#'  ungroup()
+#' idEXPstat <- function(d, ...){ ## example individual statistic function
+#'  ## arg = nonmem dataset data.frame
+#'  ## return data.frame with statistic column
+#'   d %>% group_by(ID, ...) %>% filter(is.na(AMT)) %>%
+#'     summarise(
+#'       AUC = AUC(time = TIME, conc = DV),
+#'       CMAX = max(DV, na.rm = TRUE),
+#'       TMAX = TIME[which.max(DV)]
+#'     ) %>%
+#'     tidyr::gather(key = ""exposure"", value = ""statistic"", AUC:TMAX) %>%
+#'     ungroup()
 #'}
 #'
-#'EXPstat <- function(d, ...){ ## example statistic function
+#'EXPstat <- function(d, ...){ ## example summary statistic function
 #'  ## arg = nonmem dataset data.frame
 #'  ## return data.frame with statistic column
 #'  d %>% idEXPstat(...) %>%  ## reuse idEXPstat for individual stats
 #'    ## summarise over study and any other variables (...)
 #'    group_by(exposure, ...) %>%
 #'    summarise(
-#'    median = median(statistic, na.rm = TRUE),
-#'    cv = 100*sd(statistic, na.rm = TRUE)/mean(statistic, na.rm = TRUE)
-#'  ) %>%
-#'  tidyr::gather(key = ""type"", value = ""statistic"", median:cv)
+#'      median = median(statistic, na.rm = TRUE),
+#'      cv = 100*sd(statistic, na.rm = TRUE)/mean(statistic, na.rm = TRUE)
+#'    ) %>%
+#'    tidyr::gather(key = ""type"", value = ""statistic"", median:cv)
 #'}
 #' 
 #' m1s %>% ppc_data(EXPstat)
 #' 
 #' }
+#' @rdname ppc
 #' @export
 
 ppc_data <- function(r,  FUN, ..., pre_proc = identity, max_mod_no = NA, DV = ""DV"", statistic = ""statistic""){

---FILE: man/nm_tran.Rd---
@@ -7,8 +7,13 @@
 nm_tran(x)
 }
 \arguments{
-\item{x}{character. file name of NONMEM control stream}
+\item{x}{nm object}
 }
 \description{
-Requires \code{options(""path/to/nmtran"")} to be set up.
+Runs initial part of NONMEM where control file and dataset checks are performed.
+Stops before running NONMEM.  Useful especially on grid infrastructures where 
+it may take a while for NONMEM to start return ctl/dataset errors
+}
+\details{
+Requires \code{options(""nmtran_exe_path"")} to be set.
 }

---FILE: man/ppc.Rd---
@@ -1,13 +1,24 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/sim_reestExtra.R
-\name{ppc_data}
+% Please edit documentation in R/NMprojectExtra.R, R/sim_reestExtra.R
+\name{ppc}
+\alias{ppc}
+\alias{ppc_whisker_plot}
+\alias{ppc}
+\alias{ppc_histogram_plot}
 \alias{ppc_data}
 \title{process data from PPC for plotting}
 \usage{
+ppc_whisker_plot(d, group, var1, var2, statistic = ""statistic"")
+
+ppc_histogram_plot(d, var1, var2, statistic = ""statistic"")
+
 ppc_data(r, FUN, ..., pre_proc = identity, max_mod_no = NA, DV = ""DV"",
   statistic = ""statistic"")
 }
 \arguments{
+\item{statistic}{character (default = ""statistic"") name of statistic column
+returned by FUN}
+
 \item{r}{nm object}
 
 \item{FUN}{statistic function with NONMEM dataset as arg and
@@ -19,9 +30,6 @@ returns data.frame with a column ""statistic""}
 
 \item{DV}{character (default = ""DV"")}
 
-\item{statistic}{character (default = ""statistic"") name of statistic column
-returned by FUN}
-
 \item{max_mod_mo}{integer. Maximum model number to read (set low for debugging)}
 }
 \description{
@@ -30,29 +38,30 @@ process data from PPC for plotting
 \examples{
 \dontrun{
 
-idEXPstat <- function(d, ...){ ## example statistic function
-
-d \%>\% group_by(ID, ...) \%>\% filter(is.na(AMT)) \%>\%
- summarise(
-   AUC = AUC(time = TIME, conc = DV),
-   CMAX = max(DV, na.rm = TRUE),
-   TMAX = TIME[which.max(DV)]
- ) \%>\%
- tidyr::gather(key = ""exposure"", value = ""statistic"", AUC:TMAX) \%>\%
- ungroup()
+idEXPstat <- function(d, ...){ ## example individual statistic function
+ ## arg = nonmem dataset data.frame
+ ## return data.frame with statistic column
+  d \%>\% group_by(ID, ...) \%>\% filter(is.na(AMT)) \%>\%
+    summarise(
+      AUC = AUC(time = TIME, conc = DV),
+      CMAX = max(DV, na.rm = TRUE),
+      TMAX = TIME[which.max(DV)]
+    ) \%>\%
+    tidyr::gather(key = ""exposure"", value = ""statistic"", AUC:TMAX) \%>\%
+    ungroup()
 }
 
-EXPstat <- function(d, ...){ ## example statistic function
+EXPstat <- function(d, ...){ ## example summary statistic function
  ## arg = nonmem dataset data.frame
  ## return data.frame with statistic column
  d \%>\% idEXPstat(...) \%>\%  ## reuse idEXPstat for individual stats
    ## summarise over study and any other variables (...)
    group_by(exposure, ...) \%>\%
    summarise(
-   median = median(statistic, na.rm = TRUE),
-   cv = 100*sd(statistic, na.rm = TRUE)/mean(statistic, na.rm = TRUE)
- ) \%>\%
- tidyr::gather(key = ""type"", value = ""statistic"", median:cv)
+     median = median(statistic, na.rm = TRUE),
+     cv = 100*sd(statistic, na.rm = TRUE)/mean(statistic, na.rm = TRUE)
+   ) \%>\%
+   tidyr::gather(key = ""type"", value = ""statistic"", median:cv)
 }
 
 m1s \%>\% ppc_data(EXPstat)

---FILE: man/shiny_nm.Rd---
@@ -7,19 +7,21 @@
 shiny_nm(m, envir = .GlobalEnv)
 }
 \arguments{
-\item{m}{either nm_list object, or data.frame or list contain nm_lists}
+\item{m}{either nm_list object, or data.frame or list or environment contain nm_lists}
 
 \item{envir}{if missing, the environment to search}
 }
 \description{
-Shiny view of NMproject
+Interactively monitor NONMEM runs.  This interface is intentionally limited to monitoring
+ activities only.  Running and post processing should be scripted
 }
 \examples{
 \dontrun{
 
-m1 \%>\% nm_shiny()
-d$m \%>\% nm_shiny()
-d \%>\% nm_shiny()
+shiny_nm()        ## use all objects in global workspace
+shiny_nm(m1)      ## only m1
+shiny_nm(d$m)     ## only d$m
+shiny_nm(d)       ## all nm_lists in d (data.frame/list/environment)
 
 }
 }

---FILE: man/write_derived_data.Rd---
@@ -9,10 +9,11 @@ write_derived_data(d, name, ...)
 \arguments{
 \item{d}{data.frame. Data frame to be saved}
 
-\item{name}{name of file (without extension)}
+\item{name}{name of file (without extension). If not a path, will save to
+DerivedData directory}
 
-\item{...}{additional arguments to be passed dto write.csv}
+\item{...}{additional arguments to be passed to write.csv}
 }
 \description{
-Write derived data file.
+will write to (DerivedData) directory
 }"
tsahota,NMproject,c3a3ae91b537cd0040485026d1fb8c6d4e690ad1,klgk669,klgk669@rstudio-ha00.scp.astrazeneca.net,2020-05-16T20:46:40Z,klgk669,klgk669@rstudio-ha00.scp.astrazeneca.net,2020-05-16T20:46:40Z,cran check fix,R/NMprojectExtra.R;R/nm_gettersetters.R;man/subroutine.Rd;tests/testthat/test-nm.R,False,True,True,False,27,17,44,"---FILE: R/NMprojectExtra.R---
@@ -1926,7 +1926,7 @@ default_trans <- function(advan){
 
 #' Subroutine
 #' 
-#' This is currently experimental. Set/modify subroutine of an nm object
+#' This is currently experimental. Modify subroutine of an nm object
 #' 
 #' @param m nm object
 #' @param advan character. desired ADVAN
@@ -1935,7 +1935,8 @@ default_trans <- function(advan){
 #' 
 #' @details
 #'  Can only switch between subroutines listed in \code{available_advans}
-#'  TODO: modify parameter initial estimates based on conversion
+#'
+#' @seealso \code{\link{advan}}, \code{\link{advan}}
 #' 
 #' @examples
 #' \dontrun{
@@ -1945,6 +1946,13 @@ default_trans <- function(advan){
 #' 
 #' m <- m %>% subroutine(ADVAN = 2, TRANS = 2)
 #' 
+#' ds <- .available_advans %>%
+#'   filter(oral) %>%
+#'   mutate(
+#'       m = m1 %>% child(run_id = label) %>%
+#'         subroutine(advan = advan, trans = trans)
+#'   )
+#' 
 #' }
 #' @export
 

---FILE: R/nm_gettersetters.R---
@@ -58,13 +58,14 @@ run_dir.nm_list <- run_dir.nm_generic
 #' @export
 cmd <- function(m, text) {
   if(missing(text)) custom_1d_field(m, ""cmd"") else {
-    if(any(grepl(""\\-clean\\="", text))) {
-      clean_number <- gsub("".*\\-clean\\=([0-9]+).*"", ""\\1"", text)
+    clean_text <- text[grepl(""\\-clean\\="", text)]
+    if(length(clean_text)) {
+      clean_number <- gsub("".*\\-clean\\=([0-9]+).*"", ""\\1"", clean_text)
       clean_number <- as.numeric(clean_number)
       if(clean_number > 2)
         warning(""use of -clean flag more than 2 is not recommended with NMproject.
 NMproject uses files in the NM_run directories instead of files copied back to main directory.
-see ?ls_tempfiles for post run clean up"")
+see ?ls_tempfiles for post run clean up options"")
     }
     custom_1d_field(m, ""cmd"", text, glue = TRUE)
   }

---FILE: man/subroutine.Rd---
@@ -16,11 +16,10 @@ subroutine(m, advan = NA, trans = 1, recursive = TRUE)
 \item{recursive}{logical (default = TRUE). Internal argument, do not modify}
 }
 \description{
-This is currently experimental. Set/modify subroutine of an nm object
+This is currently experimental. Modify subroutine of an nm object
 }
 \details{
 Can only switch between subroutines listed in \code{available_advans}
- TODO: modify parameter initial estimates based on conversion
 }
 \examples{
 \dontrun{
@@ -30,5 +29,15 @@ trans(m)  ## 1
 
 m <- m \%>\% subroutine(ADVAN = 2, TRANS = 2)
 
+ds <- .available_advans \%>\%
+  filter(oral) \%>\%
+  mutate(
+      m = m1 \%>\% child(run_id = label) \%>\%
+        subroutine(advan = advan, trans = trans)
+  )
+
+}
 }
+\seealso{
+\code{\link{advan}}, \code{\link{advan}}
 }

---FILE: tests/testthat/test-nm.R---
@@ -150,23 +150,15 @@ test_that(""nm object basic use"",{
   ## log_CL = log_K + log_V
   ## tol = 0.01 for numerical precision
   expect_true(abs(log_CL - log_K - log_V) < 0.01)
-  
-  ds <- available_advans %>%
+
+  ds <- .available_advans %>%
     dplyr::filter(advan %in% c(2,4)) %>%
     dplyr::mutate(
       m = m1 %>% child(run_id = label) %>%
         subroutine(advan = advan, trans = trans)
     )
   
   expect_true(inherits(ds, ""data.frame""))
-  
-  dollar_subs <- ds$m[-1] %>% dollar(""SUB"") %>% unlist()
-  names(dollar_subs) <- NULL
-  
-  expect_true(all.equal(
-    dollar_subs,
-    paste0(""$SUB ADVAN"", ds$advan[-1], "" TRANS"", ds$trans[-1])
-  ))
 
   ## use of stringr pipe
   mdummy <- m1 %ns>% stringr::str_replace(""THETA"", ""DUMMY"")"
tsahota,NMproject,b3990fd823acbd9ffbfc2121c55010fd33d8c1e3,klgk669,klgk669@rstudio-ha00.scp.astrazeneca.net,2020-05-15T18:12:16Z,klgk669,klgk669@rstudio-ha00.scp.astrazeneca.net,2020-05-15T18:12:16Z,indent fix,R/NMprojectExtra.R,False,True,True,False,3,3,6,"---FILE: R/NMprojectExtra.R---
@@ -2373,9 +2373,9 @@ add_mixed_param <- function(m, name,
   if(trans == ""LOG""){
     m <- m %>% target(PK_PRED) %>%
       text(""TV_NEWPARAM_=EXP(THETA(_N_PARAM_))
-            MU__MU_PARAM_=LOG(TV_NEWPARAM_)
-            _NEWPARAM_ = EXP(MU__MU_PARAM_+ETA(_MU_PARAM_))
-          "", append = TRUE) %>%
+MU__MU_PARAM_=LOG(TV_NEWPARAM_)
+_NEWPARAM_ = EXP(MU__MU_PARAM_+ETA(_MU_PARAM_))
+"", append = TRUE) %>%
       target(""THETA"") %>%
       text(paste(signif(log(init),2), ""      ; TV_NEWPARAM_ ; _UNIT_PARAM_ ; "",
                  trans), append = TRUE) %>%"
tsahota,NMproject,6dc553ab7d91bfd28811c4621e857199550ffb43,klgk669,klgk669@rstudio-ha01.scp.astrazeneca.net,2020-05-14T15:00:10Z,klgk669,klgk669@rstudio-ha01.scp.astrazeneca.net,2020-05-14T15:00:10Z,bug fix,NAMESPACE;R/NMprojectExtra.R;R/manual_edit.R;inst/rmarkdown/templates/nm_general/skeleton/skeleton.Rmd;inst/rmarkdown/templates/nm_log/skeleton/skeleton.Rmd;inst/rmarkdown/templates/post_proc/skeleton/skeleton.Rmd;man/subroutine.Rd,True,True,True,False,11,13,24,"---FILE: NAMESPACE---
@@ -166,6 +166,7 @@ S3method(wipe_run,nm_list)
 S3method(write_ctl,nm_generic)
 S3method(write_ctl,nm_list)
 export(""%ns>%"")
+export()
 export(AIC)
 export(BIC)
 export(NONMEM_version)
@@ -217,6 +218,7 @@ export(data_name)
 export(data_path)
 export(decision)
 export(delete_dollar)
+export(diff_manual_edit)
 export(dollar)
 export(environment_info)
 export(exclude_rows)

---FILE: R/NMprojectExtra.R---
@@ -547,6 +547,7 @@ target.nm_generic <- function(m, dollar, lines){
   #if(!missing(dollar) & !missing(lines)){
   #  stop(""can't have both 'dollar' and 'lines' arguments"")
   #}
+  dollar <- toupper(dollar)
   
   dollar_text <- gsub(""\\$"","""",dollar)
   m <- m %>% custom_1d_field(field = ""target"", replace = dollar_text)
@@ -1859,6 +1860,12 @@ available_advans <- dplyr::mutate(available_advans,
                                   label = ifelse(is.na(trans), paste0(""a"",advan), paste0(""a"",advan,""t"",trans)))
 available_advans <- dplyr::ungroup(available_advans)
 
+#' @export
+dp
+
+#' @export
+available_advans
+
 default_trans <- function(advan){
   sapply(advan, function(advan){
     default_trans_vec <- available_advans$trans[available_advans$advan %in% advan]

---FILE: R/manual_edit.R---
@@ -109,6 +109,7 @@ start_manual_edit_unix <- function(m){
   res
 }
 
+#' @export
 diff_manual_edit <- function(m, res){
   diff_cmd <- paste(""diff -u"", ctl_path(m), res$new_ctl_path, "">"", res$patch_path)
   system(diff_cmd)

---FILE: inst/rmarkdown/templates/nm_general/skeleton/skeleton.Rmd---
@@ -19,10 +19,6 @@ opts_chunk$set(message = TRUE)
 ```{r echo=FALSE,message=FALSE}
 ## LOAD PACKAGES HERE
 library(NMprojectAZ)
-devtools::load_all(""~/tidyproject/"")
-devtools::load_all(""~/NMproject/"")
-devtools::load_all(""~/tidyprojectAZ/"")
-devtools::load_all(""~/NMprojectAZ/"")
 library(future)
 future::plan(""future::multiprocess"", workers = 2)
 

---FILE: inst/rmarkdown/templates/nm_log/skeleton/skeleton.Rmd---
@@ -19,10 +19,6 @@ opts_chunk$set(message = TRUE)
 ```{r echo=FALSE,message=FALSE}
 ## LOAD PACKAGES HERE
 library(NMprojectAZ)
-devtools::load_all(""~/tidyproject/"")
-devtools::load_all(""~/NMproject/"")
-devtools::load_all(""~/tidyprojectAZ/"")
-devtools::load_all(""~/NMprojectAZ/"")
 library(future)
 future::plan(""future::multiprocess"", workers = 2)
 

---FILE: inst/rmarkdown/templates/post_proc/skeleton/skeleton.Rmd---
@@ -38,10 +38,6 @@ if(!is.null(knitr::opts_knit$get('rmarkdown.pandoc.to'))){
 
 ```{r}
 library(NMprojectAZ)
-devtools::load_all(""~/tidyproject"")
-devtools::load_all(""~/NMproject"")
-devtools::load_all(""~/tidyprojectAZ"")
-devtools::load_all(""~/NMprojectAZ"")
 ```
 
 ## model object

---FILE: man/subroutine.Rd---
@@ -4,7 +4,7 @@
 \alias{subroutine}
 \title{Subroutine}
 \usage{
-subroutine(m, advan = NA, trans = NA, recursive = TRUE)
+subroutine(m, advan = NA, trans = 1, recursive = TRUE)
 }
 \arguments{
 \item{m}{nm object}"
tsahota,NMproject,366cf1bc36889c3c2e431cd3c5b633821c7d3963,klgk669,klgk669@rstudio-ha01.scp.astrazeneca.net,2020-05-10T11:17:50Z,klgk669,klgk669@rstudio-ha01.scp.astrazeneca.net,2020-05-10T11:17:50Z,bug fix advan3 trans4. added advan 11 and 12. decision clean up,R/NMprojectExtra.R,False,True,True,False,41,20,61,"---FILE: R/NMprojectExtra.R---
@@ -1796,7 +1796,7 @@ dp <- rbind(
   data.frame(advan = 3,trans = 4,
              base_name = c(""R20"",""R23"",""V2"",""V3""),
              relation = c(""R20*V2"", ""R23*V2"", NA , NA),
-             nm_name = c(""CL"",""Q"",""V2"",""V3"")),
+             nm_name = c(""CL"",""Q"",""V1"",""V2"")),
   ## skip advan 3 trans 5/6
   data.frame(advan = 4,trans = 1,
              base_name = c(""R12"",""R20"",""R23"",""R32"",""V2""),
@@ -1810,30 +1810,49 @@ dp <- rbind(
              base_name = c(""R12"",""R20"",""R23"",""V2"",""V3""),
              relation = c(NA, ""R20*V2"", ""R23*V2"", NA , NA),               
              nm_name = c(""KA"",""CL"",""Q"",""V2"",""V3"")),
+  ## add advan 11
+  data.frame(advan = 11,trans = 1,
+             base_name = c(""R20"",""R23"",""R32"",""R24"",""R42"",""V2""),
+             relation = NA,
+             nm_name = c(""K"",""K12"",""K21"",""K13"",""K31"",""V"")),
+  data.frame(advan = 11,trans = 4,
+             base_name = c(""R20"",""R23"",""V2"",""V3"",""R24"",""V4""),
+             relation = c(""R20*V2"", ""R23*V2"", NA , NA, ""R24*V2"", NA),
+             nm_name = c(""CL"",""Q2"",""V1"",""V2"",""Q3"",""V3"")),
+  ## add advan 12
+  data.frame(advan = 12,trans = 1,
+             base_name = c(""R12"",""R20"",""R23"",""R32"",""R24"",""R42"",""V2""),
+             relation = NA,
+             nm_name = c(""KA"",""K"",""K23"",""K32"",""K24"",""K42"",""V2"")),
+  data.frame(advan = 12,trans = 4,
+             base_name = c(""R12"",""R20"",""R23"",""V2"",""V3"",""R24"",""V4""),
+             relation = c(NA,""R20*V2"", ""R23*V2"", NA , NA, ""R24*V2"", NA),
+             nm_name = c(""KA"",""CL"",""Q3"",""V2"",""V3"",""Q4"",""V4"")),
+  ## non closed form advans
   data.frame(advan = 5,trans = NA,
-             base_name = c(""R12"",""R20"",""R23"",""R32"",""V2"",""...""),
+             base_name = c(""RXY"",""VX""),
              relation = NA,
-             nm_name = c(""K12"",""K20"",""K23"",""K32"",""V2"",""..."")),
+             nm_name = c(""KXY"",""VX"")),
   data.frame(advan = 6,trans = NA,
-             base_name = c(""R12"",""R20"",""R23"",""R32"",""V2"",""...""),
+             base_name = c(""RXY"",""VX""),
              relation = NA,
-             nm_name = c(""K12"",""K20"",""K23"",""K32"",""V2"",""..."")),
+             nm_name = c(""KXY"",""VX"")),
   data.frame(advan = 7,trans = NA,
-             base_name = c(""R12"",""R20"",""R23"",""R32"",""V2"",""...""),
+             base_name = c(""RXY"",""VX""),
              relation = NA,
-             nm_name = c(""K12"",""K20"",""K23"",""K32"",""V2"",""..."")),
+             nm_name = c(""KXY"",""VX"")),
   data.frame(advan = 8,trans = NA,
-             base_name = c(""R12"",""R20"",""R23"",""R32"",""V2"",""...""),
+             base_name = c(""RXY"",""VX""),
              relation = NA,
-             nm_name = c(""K12"",""K20"",""K23"",""K32"",""V2"",""..."")),
+             nm_name = c(""KXY"",""VX"")),
   data.frame(advan = 9,trans = NA,
-             base_name = c(""R12"",""R20"",""R23"",""R32"",""V2"",""...""),
+             base_name = c(""RXY"",""VX""),
              relation = NA,
-             nm_name = c(""K12"",""K20"",""K23"",""K32"",""V2"",""..."")),
+             nm_name = c(""KXY"",""VX"")),
   data.frame(advan = 13,trans = NA,
-             base_name = c(""R12"",""R20"",""R23"",""R32"",""V2"",""...""),
+             base_name = c(""RXY"",""VX""),
              relation = NA,
-             nm_name = c(""K12"",""K20"",""K23"",""K32"",""V2"",""...""))
+             nm_name = c(""KXY"",""VX""))
 )
 dp <- tibble::as_tibble(dp)
 
@@ -5242,13 +5261,13 @@ decision <- function(values = c(),
   error_msg <- ""decision needs revisiting""
 
   if(!auto_decision){
-    stop(""auto-decision failed: "", error_msg, call. =  FALSE)
+    stop(""auto-decision failed - "", error_msg, call. =  FALSE)
   }
     
   wait_input <- function(inputs){
-    inputs
-    cat(""---manual decision check---\n"")
-    cat(""decision: "", outcome)
+    inputs  ## create inputs dependency
+    cat(crayon::underline(""manual decision check\n""))
+    cat(""decision outcome:\n"", outcome)
     ans <- readline(""Is this decision correct? [y/n/esc]:\n"")
     if(ans %in% """"){
       stop(""blank detected (if in R Notebooks, make sure no blank line between decision() and end of chunk"")
@@ -5270,9 +5289,11 @@ decision <- function(values = c(),
     inputs <- c(inputs, tools::md5sum(files))
   }
 
-  drpl <- drake::drake_plan(decision_inputs = inputs,
-                            pause = wait_input(decision_inputs))
-
+  drpl <- drake::drake_plan(
+    decision_inputs = inputs,
+    pause = wait_input(decision_inputs)
+  )
+  
   outdated <- drake::outdated(drake::drake_config(drpl))
   if(!length(outdated)){
     message(""decision inputs haven't changed, trusting that decision is still correct"")"
tsahota,NMproject,c6af2e11877c3ea9e89792155ce7dc6a3ae5b03c,klgk669,klgk669@rstudio-ha01.scp.astrazeneca.net,2020-05-06T16:07:19Z,klgk669,klgk669@rstudio-ha01.scp.astrazeneca.net,2020-05-06T16:07:19Z,bug fix,R/NMprojectExtra.R,False,True,True,False,2,2,4,"---FILE: R/NMprojectExtra.R---
@@ -5036,11 +5036,11 @@ make_OCC_every_dose <- function(dose_trigger, new_OCC_trigger){
 #' @export
 shiny_nm <- function(m, envir = .GlobalEnv){
   if(missing(m)) {
-    m <- nm_list_gather(envir = envir)
+    m <- nm_list_gather(envir)
   } else {
     if(is_nm_generic(m)) m <- as_nm_list(m)
     if(!is_nm_list(m)){
-      m <- nm_list_gather(envir = m)
+      m <- nm_list_gather(m)
       if(!is_nm_list(m))
         stop(""couldn't find any nm_list objects in m"")
     }"
tsahota,NMproject,f32f101259bafd1419587e06f472d4a0bc764356,klgk669,klgk669@rstudio-ha00.scp.astrazeneca.net,2020-05-04T11:37:52Z,klgk669,klgk669@rstudio-ha00.scp.astrazeneca.net,2020-05-04T11:37:52Z,prior_ctl in tests. push/pull theta/omega/sigma. bug fixes,NAMESPACE;R/NMprojectExtra.R;R/nm_gettersetters.R;inst/extdata/examples/testthat/Scripts/empty_test_setup.R;inst/extdata/examples/testthat/Scripts/nm.log2.R;inst/extdata/examples/testthat/Scripts/nm.log2.Rmd;inst/extdata/examples/testthat/Scripts/testthat_setup.R;inst/rmarkdown/templates/nm_log/skeleton/skeleton.Rmd;man/nm_diff.Rd;man/push_init_theta.Rd;tests/testthat/test-cov.R;tests/testthat/test-ctl_manip.R;tests/testthat/test-nm.R;tests/testthat/test-run_post.R;tests/testthat/test-status.R,True,True,True,False,208,72,280,"---FILE: NAMESPACE---
@@ -291,6 +291,12 @@ export(ppc_whisker_plot)
 export(print_ctl)
 export(prior_ctl)
 export(psn_style_scm)
+export(pull_init_omega)
+export(pull_init_sigma)
+export(pull_init_theta)
+export(push_init_omega)
+export(push_init_sigma)
+export(push_init_theta)
 export(raw_init_theta)
 export(read_derived_data)
 export(remove_cov)

---FILE: R/NMprojectExtra.R---
@@ -56,13 +56,6 @@ To use the alpha interface, install NMproject 0.3.2"",
     m <- replace_tag(m, field)
   }
   
-  # ## if ctl file already exists, bring it into object
-  # ctl_path <- ctl_path(m)
-  # if(file.exists(ctl_path)){
-  #   m <- m %>% ctl_contents(ctl_path)
-  # }
-  
-  ## leave space to track output files (do in run_nm)
   m
 }
 
@@ -143,16 +136,30 @@ child.nm_generic <- function(m, run_id = NA_character_, type = ""execute"", silent
   m <- m %>% parent_run_id(run_id(m))
   m <- m %>% parent_run_in(run_in(m))
   m <- m %>% parent_ctl_name(ctl_name(m))
+  
+  ## if missing increment run_id
+  if(is.na(run_id)) {
+    if(!is.na(run_id(m))){
+      run_id <- increment_run_id(run_id(m))
+      message(""child run_id automatically set to: "", run_id)
+    }
+  }
   if(!is.na(run_id)) m <- m %>% run_id(run_id)
+  
+  m <- m %>% ctl_contents(ctl_contents(m), 
+                          update_numbering = TRUE,
+                          update_dollar_data = FALSE)
   if(!type %in% ""execute"") m <- m %>% type(type)
   m[[""ctl_orig""]] <- m[[""ctl_contents""]]  ## reset ctl_orig
   
   ## check for file conficts
-  file_conflicts <- intersect(psn_exported_files(mparent), psn_exported_files(m))
-  if(length(file_conflicts) > 0){
-    if(!silent) warning(""Child file(s) currently in conflict with parent:\n"",
-                        paste(paste0("" "",file_conflicts),collapse=""\n""),
-                        ""\nYou will overwrite parent object outputs if you run now"", call. = FALSE)
+  if(!is_single_na(m[[""ctl_contents""]])){
+    file_conflicts <- intersect(psn_exported_files(mparent), psn_exported_files(m))
+    if(length(file_conflicts) > 0){
+      if(!silent) warning(""Child file(s) currently in conflict with parent:\n"",
+                          paste(paste0("" "",file_conflicts),collapse=""\n""),
+                          ""\nYou will overwrite parent object outputs if you run now"", call. = FALSE)
+    }
   }
   
   ## warn if ctl_name or run_dir aren't glueable
@@ -169,6 +176,22 @@ child.nm_generic <- function(m, run_id = NA_character_, type = ""execute"", silent
 #' @export
 child.nm_list <- Vectorize_nm_list(child.nm_generic, SIMPLIFY = FALSE)
 
+increment_run_id <- function(run_id){
+  if(length(run_id) != 1) stop(""run_id must be of length 1"")
+  stop_msg <- paste0(""cannot automatically increment "", run_id, "", specify run_id argument explicitly"")
+  
+  # number at end
+  run_id_regex <- ""^(\\w*?)([0-9]+)$"" 
+  if(!grepl(run_id_regex, run_id)) stop(stop_msg)
+  
+  prefix_part <- gsub(""^(\\w*?)([0-9]+)$"", ""\\1"", run_id)
+  numeric_part <- gsub(""^(\\w*?)([0-9]+)$"", ""\\2"", run_id)
+  numeric_part <- as.numeric(numeric_part)
+  
+  paste0(prefix_part, numeric_part + 1)
+}
+
+
 #' Determine if runs are expected to have overlapping output files (from PsN)
 #' 
 #' @param m nm_list object
@@ -234,24 +257,24 @@ printable_nm_generic <- function(x){
       if(length(x[[field]]) > 1)
         x[[field]] <- paste0(""...[collapsed - view with "", field, ""()]..."")
   }
-  ## remove all raw fields from output
-  #remove_fields <- c(""glue_fields"")
-  #for(field in remove_fields) x[[field]] <- NULL
-  
-  ##put glue fields to end
-  xglue_list <- x[[""glue_fields""]]
-  
-  for(j in seq_along(pretty_empty_fields)){
-    pretty_empty_field <- pretty_empty_fields[j]
-    pretty_empty_f <- pretty_empty_fill_f[j]
-    if(is_single_na(xglue_list[[pretty_empty_field]])){
-      xglue_list[[pretty_empty_field]] <- 
-        paste0(""...[NA - fill with "", pretty_empty_f,""()]..."")
-    }
-  }
-  
-  x[[""glue_fields""]] <- NULL
-  x[[""glue_fields""]] <- xglue_list
+  # remove all raw fields from output
+  remove_fields <- c(""glue_fields"")
+  for(field in remove_fields) x[[field]] <- NULL
+  
+  # ##put glue fields to end
+  # xglue_list <- x[[""glue_fields""]]
+  # 
+  # for(j in seq_along(pretty_empty_fields)){
+  #   pretty_empty_field <- pretty_empty_fields[j]
+  #   pretty_empty_f <- pretty_empty_fill_f[j]
+  #   if(is_single_na(xglue_list[[pretty_empty_field]])){
+  #     xglue_list[[pretty_empty_field]] <- 
+  #       paste0(""...[NA - fill with "", pretty_empty_f,""()]..."")
+  #   }
+  # }
+  # 
+  # x[[""glue_fields""]] <- NULL
+  # x[[""glue_fields""]] <- xglue_list 
   
   x
 }
@@ -267,7 +290,7 @@ print.nm_generic <- function(x, ...){
   str_ob <- gsub(""(.*?)\""\\.{3}\\[(collapsed.*)\\].*"", 
                  paste0(""\\1"",crayon::green(""\\2"")), str_ob)
   cat(str_ob, sep = ""\n"")
-  return(invisible(x))
+  #return(invisible(x))
   #utils::str(x, ...)
 }
 
@@ -285,7 +308,7 @@ print.nm_list <- function(x, ...){
   str_ob <- gsub(""(.*?)\""\\.{3}\\[(collapsed.*)\\].*"", 
                  paste0(""\\1"",crayon::green(""\\2"")), str_ob)
   cat(str_ob, sep = ""\n"")
-  return(invisible(x))
+  #return(invisible(x))
   #utils::str(x, ...)
 }
 
@@ -496,7 +519,7 @@ update_dollar.nm_generic <- function(ctl,..., which_dollar = 1, append = FALSE){
   m <- ctl
   ctl <- ctl_contents(m)
   ctl_new <- update_dollar(ctl, ..., which_dollar = which_dollar, append = append)
-  m <- m %>% ctl_contents(ctl_new)
+  m <- m %>% ctl_contents_simple(ctl_new)
   m
 }
 #' @export
@@ -587,7 +610,7 @@ set_target_text <- function(m, text){
   if(!is.na(target)) {
     #if(append) text <- c(ctl[[target]],"""",text)
     ctl[[target]] <- setup_dollar(text, paste0(""$"",target), add_dollar_text = FALSE)
-    m <- m %>% ctl_contents(ctl, update_dollar_data = FALSE)
+    m <- m %>% ctl_contents_simple(ctl)
   } else {
     #if(append) text <- c(ctl_character(ctl),"""",text)
     text <- ctl_list2(text)
@@ -680,17 +703,11 @@ data_path.nm_generic <- function(m, text){
     }
   }
   m <- m %>% custom_1d_field(field = ""data_path"", replace = text, glue = TRUE)
-  
+
   if(!is.na(data_path(m))){
-    ## update ctl contents
-    m <- m %>% fill_dollar_data(text)
-    # old_target <- m %>% target()
-    # m <- m %>% target(""$DATA"")
-    # 
-    # data_name <- relative_path(text, run_in(m))
-    # m <- m %>% gsub_ctl(""^(\\s*\\$DATA\\s+)\\S+(.*)$"",paste0(""\\1"",data_name,""\\2""))
-    # 
-    # m <- m %>% target(old_target)
+    ## update ctl contents (if it exists)
+    if(!is_single_na(ctl_contents(m)))
+      m <- m %>% fill_dollar_data(text)
   }
   
   m
@@ -817,7 +834,7 @@ ignore.nm_generic <- function(ctl, ignore_char){
   }
   ctl <- ctl_contents(m)
   ctl <- update_ignore.default(ctl, ignore_char)
-  m <- m %>% ctl_contents(ctl)
+  m <- m %>% ctl_contents_simple(ctl)
   m
 }
 #' @export
@@ -849,7 +866,7 @@ delete_dollar.nm_generic <- function(m, dollar){
   ctl <- m %>% ctl_contents()
   dollar_text <- gsub(""\\$"","""",dollar)
   ctl[[dollar_text]] <- NULL
-  m <- m %>% ctl_contents(ctl)
+  m <- m %>% ctl_contents_simple(ctl)
   m
 }
 #' @export
@@ -886,7 +903,7 @@ insert_dollar.nm_generic <- function(m, dollar, text, after_dollar = NA){
   attributes(ctl) <- save_attributes
   names(ctl) <- save_names
   
-  m <- m %>% ctl_contents(ctl)
+  m <- m %>% ctl_contents_simple(ctl)
   m
 }
 #' @export
@@ -1246,7 +1263,7 @@ update_parameters.nm_generic <- function(ctl, from){
   ctl_lines <- update_parameters0(ctl_lines, coef_from, type = ""OMEGA"")
   ctl_lines <- update_parameters0(ctl_lines, coef_from, type = ""SIGMA"")
   
-  m <- m %>% ctl_contents(ctl_lines)
+  m <- m %>% ctl_contents_simple(ctl_lines)
   m
 }
 #' @export
@@ -2105,7 +2122,7 @@ subroutine.nm_list <- Vectorize_nm_list(subroutine.nm_generic, SIMPLIFY = FALSE)
 #' \dontrun{
 #' 
 #' m1 <- nm(run_id = ""m1"") %>%
-#'   ctl_contents(""staging/Models/run1.mod"")
+#'   prior_ctl(""staging/Models/run1.mod"")
 #' 
 #' m2 <- m1 %>% child(run_id = ""m2"") %>%
 #'   subroutine(advan = 2, trans = 2)
@@ -3047,6 +3064,67 @@ init_sigma <- function(m, replace){
   }
 }
 
+#' get/set parameter values
+#' 
+#' @param m nm object
+#' @param replace optional argument to replace
+#' 
+#' @examples
+#' \dontrun{
+#' 
+#' m1 %>% pull_init_theta() %>%
+#'   mutate_cond(
+#'     name %in% ""CL"",
+#'     init = 30
+#'   ) %>%
+#'   push_init_theta()
+#' 
+#' } 
+#' 
+#' @name push_init_theta
+#' @export
+pull_init_theta <- function(m){
+  init <- init_theta(m)
+  attr(init, ""object"") <-  m
+  init
+}
+
+#' @rdname push_init_theta
+#' @export
+push_init_theta <- function(replace, m) {
+  if(missing(m)) m <- attr(replace, ""object"")
+  init_theta(m, replace)
+}
+
+#' @rdname push_init_theta
+#' @export
+pull_init_omega <- function(m){
+  init <- init_omega(m)
+  attr(init, ""object"") <-  m
+  init
+}
+#' @rdname push_init_theta
+#' @export
+push_init_omega <- function(replace, m) {
+  if(missing(m)) m <- attr(replace, ""object"")
+  init_omega(m, replace)
+}
+
+
+#' @rdname push_init_theta
+#' @export
+pull_init_sigma <- function(m){
+  init <- init_sigma(m)
+  attr(init, ""object"") <-  m
+  init
+}
+#' @rdname push_init_theta
+#' @export
+push_init_sigma <- function(replace, m) {
+  if(missing(m)) m <- attr(replace, ""object"")
+  init_sigma(m, replace)
+}
+
 update_variable_in_text_numbers <- function(m, before_number, after_number){
   
   before_regex <- paste0(""\\b"", before_number)
@@ -4160,7 +4238,7 @@ add_cov.nm_generic <- function(ctl, param, cov, state = 2, continuous = TRUE,
     ctl$THETA <- c(ctl$THETA,theta_lines)
   }
 
-  m <- m %>% ctl_contents(ctl)
+  m <- m %>% ctl_contents_simple(ctl)
 
 }
 
@@ -4296,7 +4374,7 @@ remove_cov.nm_generic <- function(ctl, param, cov, state = 2, continuous = TRUE,
 
   ctl$THETA <- ctl$THETA[setdiff(seq_along(ctl$THETA), matched_theta)]
 
-  m <- m %>% ctl_contents(ctl)
+  m <- m %>% ctl_contents_simple(ctl)
 }
 
 #' @export

---FILE: R/nm_gettersetters.R---
@@ -146,10 +146,11 @@ run_id.nm_generic <- function(m, text, ...){
   
   ## Do all glueing first.
   for(field in names(m$glue_fields)){
-    m <- replace_tags(m, field)
+    m <- replace_tag(m, field)
   }
   
-  if(""ctl_contents"" %in% names(m)) m <- m %>% ctl_contents(m[[""ctl_contents""]]) ## update ctl_contents object
+  ## why was this here?
+  #if(""ctl_contents"" %in% names(m)) m <- m %>% ctl_contents(m[[""ctl_contents""]]) ## update ctl_contents object
   m
 }
 #' @export
@@ -206,12 +207,11 @@ ctl_contents.nm_generic <- function(m, ctl_ob, update_numbering = TRUE, update_d
   
   #if(inherits(try(ctl_list2(ctl_ob)), ""try-error"")) browser()
   
-  ## is ctl_ob in staging?
-  
-  from_staging <- FALSE
-  if(inherits(ctl_ob, ""character""))
-    if(length(ctl_ob) == 1)
-      if(grepl(paste0(""staging"", .Platform$file.sep), ctl_ob)) from_staging <- TRUE
+  ## if NA just set field as NA
+  if(is_single_na(ctl_ob)) {
+    m[[""ctl_contents""]] <- NA_character_
+    return(m)
+  }
   
   ctl <- ctl_list2(ctl_ob)
   
@@ -233,7 +233,6 @@ ctl_contents.nm_generic <- function(m, ctl_ob, update_numbering = TRUE, update_d
     ## NOTE: this assumes run is from same run_in(m) directory
     data_name <- gsub(""^ *\\$DATA\\s*([^ ]+).*$"",""\\1"",ctl$DATA)[1]
     data_path <- normalizePath(file.path(run_in(m), data_name), mustWork = FALSE)
-    #data_path <- normalizePath(file.path(dirname(ctl_ob), data_name), mustWork = FALSE)
     
     if(file.exists(data_path)){
       ## issue - run_in might not exist
@@ -247,15 +246,23 @@ ctl_contents.nm_generic <- function(m, ctl_ob, update_numbering = TRUE, update_d
       
       data_path <- relative_path(data_path, getwd())
       m[[""data_path""]] <- data_path
-      #if(update_dollar_data) m <- m %>% fill_dollar_data(data_path)
     }
   }
   
+  if(!is.na(data_path) & update_dollar_data)
+    m <- m %>% fill_dollar_data(data_path)
+  
   m
 }
 #' @export
 ctl_contents.nm_list <- Vectorize_nm_list(ctl_contents.nm_generic, SIMPLIFY = FALSE, replace_arg = ""ctl_ob"", pre_glue = TRUE)
 
+## minimal version of ctl_contents (just sets ctl_contents without mods)
+## for internal package use
+ctl_contents_simple <- function(m, ctl_ob, ...){
+  ctl_contents(m, ctl_ob, update_numbering = FALSE, update_dollar_data = FALSE, ...)
+}
+
 #' Add a prior ctl file contents to object
 #'
 #' @param m nm object

---FILE: inst/extdata/examples/testthat/Scripts/empty_test_setup.R---
@@ -59,7 +59,7 @@ if(level == 1) {
 ds <- tibble(run_id = 1:6)  ## runs 1 to 6 to be run single core
 
 ds$m <- nm(run_id = ds$run_id) %>%
-  ctl_contents(""staging/Models/run{run_id}.mod"") %>%
+  prior_ctl(""staging/Models/run{run_id}.mod"") %>%
   #data_path(""DerivedData/THEOPP.csv"") %>%
   cmd(""qpsn -t 100 -r 1000 -- execute run{run_id}.mod -dir={run_dir}"")
 

---FILE: inst/extdata/examples/testthat/Scripts/nm.log2.R---
@@ -59,7 +59,7 @@ if(level == 1) {
 ds <- tibble(run_id = 1:6)  ## runs 1 to 6 to be run single core
 
 ds$m <- nm(run_id = ds$run_id) %>%
-  ctl_contents(""staging/Models/run{run_id}.mod"") %>%
+  prior_ctl(""staging/Models/run{run_id}.mod"") %>%
   #data_path(""DerivedData/THEOPP.csv"") %>%
   cmd(""qpsn -t 59 -r 1000 -- execute run{run_id}.mod -dir={run_dir}"")
 

---FILE: inst/extdata/examples/testthat/Scripts/nm.log2.Rmd---
@@ -33,7 +33,7 @@ These are all single core
 ds <- tibble(run_id = 1:6)  ## runs 1 to 6 to be run single core
 
 ds$m <- nm2(run_id = ds$run_id) %>%
-  ctl_contents(""staging/Models/run{run_id}.mod"") %>%
+  prior_ctl(""staging/Models/run{run_id}.mod"") %>%
   cmd(""qpsn -t 100 -r 1000 -- execute run{run_id}.mod -dir={run_dir}"")
 
 #nm_tran(ds$m)

---FILE: inst/extdata/examples/testthat/Scripts/testthat_setup.R---
@@ -17,7 +17,7 @@ load_localpackage()
 ## main script here
 
 m1 <- nm(run_id = ""m1"") %>%
-  ctl_contents(""staging/Models/run1.mod"") %>%
+  prior_ctl(""staging/Models/run1.mod"") %>%
   cmd(""execute {ctl_name} -dir={run_dir}"") %>%
   run_nm()
 

---FILE: inst/rmarkdown/templates/nm_log/skeleton/skeleton.Rmd---
@@ -34,7 +34,7 @@ load_localpackage()
 ```{r}
 
 m1 <- nm(run_id = ""m1"") %>%
-  ctl_contents(""staging/Models/runm1.mod"") %>%
+  prior_ctl(""staging/Models/runm1.mod"") %>%
   data_path(""DerivedData/THEOPP.csv"") %>%
   cmd(""qpsn -c auto -t 59 -- execute {ctl_name} -dir={run_dir}"") %>%
   fill_input(rename = c(""DATE"" = ""DAT0"")) %>%

---FILE: man/nm_diff.Rd---
@@ -26,7 +26,7 @@ NMproject's control file manipulation functions (e.g. subroutine())
 \dontrun{
 
 m1 <- nm(run_id = ""m1"") \%>\%
-  ctl_contents(""staging/Models/run1.mod"")
+  prior_ctl(""staging/Models/run1.mod"")
 
 m2 <- m1 \%>\% child(run_id = ""m2"") \%>\%
   subroutine(advan = 2, trans = 2)

---FILE: man/push_init_theta.Rd---
@@ -0,0 +1,45 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/NMprojectExtra.R
+\name{push_init_theta}
+\alias{push_init_theta}
+\alias{pull_init_theta}
+\alias{push_init_theta}
+\alias{pull_init_omega}
+\alias{push_init_omega}
+\alias{pull_init_sigma}
+\alias{push_init_sigma}
+\title{get/set parameter values}
+\usage{
+pull_init_theta(m)
+
+push_init_theta(replace, m)
+
+pull_init_omega(m)
+
+push_init_omega(replace, m)
+
+pull_init_sigma(m)
+
+push_init_sigma(replace, m)
+}
+\arguments{
+\item{m}{nm object}
+
+\item{replace}{optional argument to replace}
+}
+\description{
+get/set parameter values
+}
+\examples{
+\dontrun{
+
+m1 \%>\% pull_init_theta() \%>\%
+  mutate_cond(
+    name \%in\% ""CL"",
+    init = 30
+  ) \%>\%
+  push_init_theta()
+
+} 
+
+}

---FILE: tests/testthat/test-cov.R---
@@ -26,7 +26,7 @@ test_that(""covariate modelling"",{
   ############################
   
   m1 <- nm(run_id = ""m1"") %>%
-    ctl_contents(""staging/Models/run1.mod"") %>%
+    prior_ctl(""staging/Models/run1.mod"") %>%
     cmd(""execute {ctl_name} -dir={run_dir}"") %>%
     run_nm()
   

---FILE: tests/testthat/test-ctl_manip.R---
@@ -30,7 +30,7 @@ test_that(""ctl manipulation"",{
   ## dataset procesing
   
   m1 <- nm(run_id = ""m1"") %>%
-    ctl_contents(""staging/Models/run1.mod"") %>%
+    prior_ctl(""staging/Models/run1.mod"") %>%
     cmd(""execute {ctl_name} -dir={run_dir}"") %>%
     run_nm()
   

---FILE: tests/testthat/test-nm.R---
@@ -43,7 +43,7 @@ test_that(""nm object basic use"",{
   expect_output(print(m1))
   
   m1 <- m1 %>% cmd(""qpsn -t 100 -c auto -- execute {ctl_name} -dir={run_dir}"")
-  m1 <- m1 %>% ctl_contents(""staging/Models/run1.mod"")
+  m1 <- m1 %>% prior_ctl(""staging/Models/run1.mod"")
   
   expect_identical(ctl_path(m1), ""Models/runmod1.mod"")
   ## file doesn't exist yet

---FILE: tests/testthat/test-run_post.R---
@@ -30,7 +30,7 @@ test_that(""run and post"",{
   ## dataset procesing
   
   m1 <- nm(run_id = ""m1"") %>%
-    ctl_contents(""staging/Models/run1.mod"") %>%
+    prior_ctl(""staging/Models/run1.mod"") %>%
     cmd(""execute {ctl_name} -dir={run_dir}"") %>%
     run_nm()
   

---FILE: tests/testthat/test-status.R---
@@ -28,7 +28,7 @@ test_that(""status"",{
   ds <- tibble::tibble(run_id = ""m1"")
   
   ds$m <- nm(run_id = ds$run_id) %>%
-    ctl_contents(""staging/Models/run1.mod"") %>%
+    prior_ctl(""staging/Models/run1.mod"") %>%
     cmd(""execute {ctl_name} -dir={run_dir}"")
   
   expect_message(ds$m <- ds$m %>% run_nm())"
tsahota,NMproject,60f0b08e63e5e1dd6bb3258061ceb1dd705a557c,klgk669,klgk669@rstudio-ha00.scp.astrazeneca.net,2020-04-28T22:18:14Z,klgk669,klgk669@rstudio-ha00.scp.astrazeneca.net,2020-04-28T22:18:14Z,bug fix nm_render,R/NMprojectExtra.R;man/nm_render.Rd,False,True,True,False,10,15,25,"---FILE: R/NMprojectExtra.R---
@@ -3597,12 +3597,7 @@ nmsave_multiplot.nm_list <- Vectorize_nm_list(nmsave_multiplot.nm_generic, SIMPL
 #' @export
 nm_render <- function(m, 
                       input, 
-                      output_file = 
-                        paste0(
-                          tools::file_path_sans_ext(input),
-                          ""."",run_dir(m),
-                          "".html""
-                        ),
+                      output_file = NA,
                       args = list(),
                       force = FALSE,
                       async = FALSE,
@@ -3613,17 +3608,18 @@ nm_render <- function(m,
 #' @export
 nm_render.nm_generic <- function(m, 
                                  input, 
-                                 output_file = 
-                                   paste0(
-                                     tools::file_path_sans_ext(input),
-                                     ""."",run_dir(m),
-                                     "".html""
-                                   ),
+                                 output_file = NA,
                                  args = list(),
                                  force = FALSE,
                                  async = FALSE,
                                  ...){
   
+  if(is.na(output_file))
+    output_file <- paste0(
+      basename(tools::file_path_sans_ext(input)),
+      ""."",run_dir(m),"".html""
+    )
+  
   if(""m"" %in% names(args))
     stop(""can't have m in arg.  m is reserved for model object"")
   

---FILE: man/nm_render.Rd---
@@ -4,9 +4,8 @@
 \alias{nm_render}
 \title{render function for nm objects}
 \usage{
-nm_render(m, input, output_file = paste0(tools::file_path_sans_ext(input),
-  ""."", run_dir(m), "".html""), args = list(), force = FALSE, async = FALSE,
-  ...)
+nm_render(m, input, output_file = NA, args = list(), force = FALSE,
+  async = FALSE, ...)
 }
 \arguments{
 \item{m}{nm object}"
tsahota,NMproject,743f74b234f913997cf269bcb96213e25d06da91,klgk669,klgk669@rstudio-ha00.scp.astrazeneca.net,2020-04-26T18:58:58Z,klgk669,klgk669@rstudio-ha00.scp.astrazeneca.net,2020-04-26T18:58:58Z,bug fix,R/NMprojectExtra.R,False,True,True,False,2,0,2,"---FILE: R/NMprojectExtra.R---
@@ -1462,6 +1462,8 @@ ls_tempfiles.default <- function(object = ""."", output_loc = c(""run_dir"", ""base"")
   if(output_loc == ""run_dir"")
     temp_files <- c(temp_files, all_base_tables, all_base_psn_files)
   
+  if(length(temp_files) == 0) return(character())
+  
   temp_files <- tidyproject::relative_path(temp_files, getwd())
   
   return(temp_files)"
tsahota,NMproject,98a1ba567027df9b00889681daf284b4d3e06dcd,klgk669,klgk669@rstudio-ha01.scp.astrazeneca.net,2020-04-13T09:56:13Z,klgk669,klgk669@rstudio-ha01.scp.astrazeneca.net,2020-04-13T09:56:13Z,cran test fix,R/nm.R,False,True,True,False,1,1,2,"---FILE: R/nm.R---
@@ -1791,7 +1791,7 @@ cov_forest_data <- function(m, covariate_scenarios){
     if(nrow(dcov_sc) == 0)
       stop(""couldn't find covariate "", cov, "" in covariate scenarios"")
     
-    dcov_sc_simple <- tibble(dcov_sc$value)
+    dcov_sc_simple <- tibble::tibble(dcov_sc$value)
     names(dcov_sc_simple) <- cov
     
     dd_first[[cov]] <- NULL"
tsahota,NMproject,617d912838e0745f8b3dc1aaa9d936955fd4a985,kpfn434,kpfn434@rstudio-ha01.scp.astrazeneca.net,2020-04-10T12:09:12Z,klgk669,klgk669@seskscpn084.prim.scp,2020-04-11T17:31:29Z,merged data_ignore_char fixes,R/NMprojectExtra.R;R/ctl_handling.R;R/nm.R;R/sim_reestExtra.R;R/utilsExtra.R;inst/extdata/examples/testthat/DerivedData/THEOPP.csv;inst/extdata/examples/testthat/Models/run1.mod;inst/extdata/examples/testthat/Models/run2.mod;inst/extdata/examples/testthat/Models/run3.mod;inst/extdata/examples/testthat/Models/run4.mod;inst/extdata/examples/testthat/Models/run5.mod;inst/extdata/examples/testthat/Models/run6.mod;inst/extdata/examples/testthat/Models/run7.mod;inst/extdata/examples/testthat/Models/run8.mod;inst/extdata/examples/testthat/Scripts/basic_gof.Rmd;inst/extdata/examples/testthat/Scripts/empty_test_setup.R;inst/extdata/examples/testthat/Scripts/nm.log2.R;inst/extdata/examples/testthat/Scripts/nm.log2.Rmd;inst/extdata/examples/testthat/Scripts/package_count.R;inst/extdata/examples/testthat/Scripts/theopp-demo.R;inst/extdata/examples/testthat/localpackage/R/gof_ggplot.R;inst/extdata/examples/testthat/localpackage/R/gof_ggplot2.R;inst/extdata/examples/testthat/localpackage/R/gof_xpose.R;man/data_filter_char.Rd;man/data_ignore_char.Rd;man/input_data.Rd;man/read_derived_data.Rd,True,True,True,False,1964,59,2023,"---FILE: R/NMprojectExtra.R---
@@ -815,6 +815,14 @@ fill_input.nm_generic <- function(m, ...){
 #' @export
 fill_input.nm_list <- Vectorize_nm_list(fill_input.nm_generic, SIMPLIFY = FALSE)
 
+
+#' Read in input dataset
+#' 
+#' @param m nm object
+#' @param filter logical (default = FALSE). should NONMEM ignore statement be applied
+#' @param na character. passed to read.csv
+#' @param ... additional arguments passed to either read_derived_data or read.csv
+#' 
 #' @export
 input_data <- function(m, filter = FALSE, na = ""."", ...){
   UseMethod(""input_data"")
@@ -825,13 +833,13 @@ input_data.nm_generic <- function(m, filter = FALSE, na = ""."", ...){
   if(is.na(file_name)) return(tibble::tibble())
   
   if(normalizePath(dirname(file_name), mustWork = FALSE) == normalizePath(""DerivedData"", mustWork = FALSE)){
-    d <- read_derived_data(basename(get_stub_name(file_name)),...)
+    d <- read_derived_data(basename(tools::file_path_sans_ext(file_name)),...)
   } else {
     d <- utils::read.csv(file_name, na = na, ...)
   }
   
   if(filter) {
-    data_filter <- parse(text = data_filter_char(m))
+    data_filter <- parse(text = data_filter_char(m, data = d))
     d <- subset(d, eval(data_filter))
   }
   d
@@ -857,13 +865,13 @@ input_data.default <- function(m, filter = FALSE, na = ""."", ...){   ## old get_d
   if(!grepl(""[a-zA-Z0-9]"",basename(file_name))) stop(""$DATA doesn't look like it refers to a file. Is this correct?"")
   
   if(normalizePath(dirname(file_name), mustWork = FALSE) == normalizePath(""DerivedData"")){
-    d <- read_derived_data(basename(get_stub_name(file_name)),...)
+    d <- read_derived_data(basename(tools::file_path_sans_ext(file_name)),...)
   } else {
     d <- utils::read.csv(file_name, ...)
   }
   
   if(filter) {
-    data_filter <- parse(text = data_filter_char(m))
+    data_filter <- parse(text = data_filter_char(m, data = d))
     d <- subset(d, eval(data_filter))
   }
   d
@@ -1293,7 +1301,7 @@ update_parameters.nm_generic <- function(ctl, from){
   
   coef_from <- coef(from, trans=FALSE)
   ctl_lines <- update_parameters0(ctl_lines, coef_from, type = ""THETA"")
-  warning(""bug in updating IOV model parameters - unresolved"")
+  message(""bug in updating IOV model parameters - unresolved"")
   ctl_lines <- update_parameters0(ctl_lines, coef_from, type = ""OMEGA"")
   ctl_lines <- update_parameters0(ctl_lines, coef_from, type = ""SIGMA"")
   
@@ -4727,10 +4735,11 @@ write_derived_data <- function(d, name, ...){
 #'
 #' @param name name of file (without extension)
 #' @param na character to be passed to read.csv
+#' @param silent logical (default = TRUE). should messages be suppressed
 #' @param ...  additional arguments to be passed to read.csv
 #' @export
 
-read_derived_data <- function(name, na = ""."", ...){
+read_derived_data <- function(name, na = ""."", silent = FALSE, ...){
 
   ## TODO: expand to other types of argument
   if(length(name) != 1) stop(""name should have length 1"", call. = FALSE)
@@ -4755,11 +4764,11 @@ read_derived_data <- function(name, na = ""."", ...){
   if(is.na(load_file)) stop(""debug"") ## unneccesary with stop()s
 
   if(identical(load_file, ""RDS"")){
-    message(""loading: "", name)
+    if(!silent) message(""loading: "", name)
     d <- readRDS(file = name)
   }
   if(identical(load_file, ""csv"")){
-    message(""loading: "", name)
+    if(!silent) message(""loading: "", name)
     d <- utils::read.csv(name, na = na, ...)
   }
   return(d)
@@ -4917,6 +4926,70 @@ get_nm_lists <- function(envir = .GlobalEnv){
 
 }
 
+## generic already defined
+## internal function
+data_ignore_char.nm_generic <- function(r, data){
+  dol_data <- r %>% dollar(""$DATA"")
+  dol_data <- dol_data[!dol_data %in% """"]
+  dol_data <- rem_comment(dol_data)
+  dol_data <- unlist(strsplit(dol_data, split = ""\\s""))
+  
+  ignore_present <- any(grepl("".*IGNORE\\s*=\\s*\\("",dol_data))
+  accept_present <- any(grepl("".*ACCEPT\\s*=\\s*\\("",dol_data))
+  
+  type <- NA
+  if(ignore_present & accept_present) stop(""cannot identify ignore columns"")
+  if(ignore_present) type <- ""IGNORE""
+  if(accept_present) type <- ""ACCEPT""
+  no_filter <- is.na(type)
+  
+  if(missing(data)) data <- input_data(r, filter = FALSE, silent = TRUE)
+  
+  r_data_names <- names(data)
+  ## now get nonmem names
+  dollar_input <- r %>% dollar(""INPUT"")
+  nonmem_data_names <- gsub(""\\$\\w+"", """", dollar_input)
+  nonmem_data_names <- unlist(strsplit(nonmem_data_names, split = ""\\s""))
+  nonmem_data_names <- nonmem_data_names[!nonmem_data_names %in% """"]
+  nonmem_data_names <- gsub(""\\w+=(\\w+)"", ""\\1"", nonmem_data_names)
+  #if(length(r_data_names) != length(nonmem_data_names))
+  #  stop(""length of items in $INPUT doesn't match dataset"")
+  name_chart <- data.frame(r_data_names, nonmem_data_names, stringsAsFactors = FALSE)
+  name_chart <- name_chart[name_chart$r_data_names != name_chart$nonmem_data_names,]
+  
+  if(!no_filter){
+    filter_statements <- paste0("".*"",type,""\\s*=\\s*\\((\\S[^\\)]+)\\)*.*"")
+    dol_data <- dol_data[grepl(filter_statements, dol_data)]
+    filter_statements <- gsub(filter_statements,""\\1"",dol_data)
+    filter_statements <- unlist(strsplit(filter_statements,"",""))
+    filter_statements <- gsub(""\\.EQ\\."",""=="",filter_statements)
+    filter_statements <- gsub(""\\.NE\\."",""!="",filter_statements)
+    filter_statements <- gsub(""\\.EQN\\."",""=="",filter_statements)
+    filter_statements <- gsub(""\\.NEN\\."",""!="",filter_statements)
+    filter_statements <- gsub(""\\./E\\."",""!="",filter_statements)
+    filter_statements <- gsub(""\\.GT\\."","">"",filter_statements)
+    filter_statements <- gsub(""\\.LT\\."",""<"",filter_statements)
+    filter_statements <- gsub(""\\.GE\\."","">="",filter_statements)
+    filter_statements <- gsub(""\\.LE\\."",""<="",filter_statements)
+    
+    ## substitute names from 
+    for(i in seq_len(nrow(name_chart))){
+      nonmem_data_name <- paste0(""\\b"", name_chart$nonmem_data_names[i], ""\\b"")
+      r_data_name <- name_chart$r_data_names[i]
+      filter_statements <- gsub(nonmem_data_name,
+                                r_data_name,
+                                filter_statements)
+    }
+    
+    filter_statements <- paste(filter_statements, collapse= "" | "")
+    if(""ACCEPT"" %in% type) filter_statements <- paste0(""!("",filter_statements,"")"")
+  } else {
+    filter_statements <- ""FALSE""
+  }
+  filter_statements
+  
+}
+data_ignore_char.nm_list <- Vectorize_nm_list(data_ignore_char.nm_generic, SIMPLIFY = TRUE)
 
 
 ###############

---FILE: R/ctl_handling.R---
@@ -1181,7 +1181,7 @@ get_data <- function(r, filter = FALSE, ...){
   }
 
   if(filter) {
-    data_filter <- parse(text = data_filter_char(r))
+    data_filter <- parse(text = data_filter_char(r, data = d))
     d <- subset(d, eval(data_filter))
   }
   d

---FILE: R/nm.R---
@@ -444,7 +444,7 @@ nm_output <- function(r,dorig,...){
 }
 
 nm_output.default <- function(r,dorig,...){
-  
+
   # if(requireNamespace(""xpose4"")) {
   #   xpdb <- xpose4::xpose.data(run_id(r), directory=paste0(run_in(r),""/""))
   #   d <- xpdb@Data
@@ -468,7 +468,7 @@ nm_output.default <- function(r,dorig,...){
     d <- d[,!duplicated(names(d))]
   }
   
-  if(missing(dorig)) dorig <- get_data(r,...)
+  if(missing(dorig)) dorig <- get_data(r, ...)
   
   filter_statements <- data_filter_char(r)
   if(identical(filter_statements, ""TRUE"")){
@@ -552,12 +552,13 @@ output_table.default <- function(r, ...){
 
 #' Get ignore statement
 #' @param r object coercible into ctl_list
+#' @param data data.frame (default = missing) optional input dataset from r
 #' @export
-data_ignore_char <- function(r){
+data_ignore_char <- function(r, data){
   UseMethod(""data_ignore_char"")
 }
 #' @export
-data_ignore_char.default <- function(r){
+data_ignore_char.default <- function(r, data){
   dol_data <- ctl_list(r)$DATA
   dol_data <- dol_data[!dol_data %in% """"]
   dol_data <- rem_comment(dol_data)
@@ -572,6 +573,22 @@ data_ignore_char.default <- function(r){
   if(accept_present) type <- ""ACCEPT""
   no_filter <- is.na(type)
   
+  ## get nonmem names and input names
+  ## read in the data - need only header though
+  if(missing(data)) data <- input_data(r, filter = FALSE, silent = TRUE)
+  
+  r_data_names <- names(data)
+  ## now get nonmem names
+  dollar_input <- ctl_list(r)$INPUT
+  nonmem_data_names <- gsub(""\\$\\w+"", """", dollar_input)
+  nonmem_data_names <- unlist(strsplit(nonmem_data_names, split = ""\\s""))
+  nonmem_data_names <- nonmem_data_names[!nonmem_data_names %in% """"]
+  nonmem_data_names <- gsub(""\\w+=(\\w+)"", ""\\1"", nonmem_data_names)
+  #if(length(r_data_names) != length(nonmem_data_names))
+  #  stop(""length of items in $INPUT doesn't match dataset"")
+  name_chart <- data.frame(r_data_names, nonmem_data_names, stringsAsFactors = FALSE)
+  name_chart <- name_chart[name_chart$r_data_names != name_chart$nonmem_data_names,]
+  
   if(!no_filter){
     filter_statements <- paste0("".*"",type,""\\s*=\\s*\\((\\S[^\\)]+)\\)*.*"")
     dol_data <- dol_data[grepl(filter_statements, dol_data)]
@@ -586,6 +603,16 @@ data_ignore_char.default <- function(r){
     filter_statements <- gsub(""\\.LT\\."",""<"",filter_statements)
     filter_statements <- gsub(""\\.GE\\."","">="",filter_statements)
     filter_statements <- gsub(""\\.LE\\."",""<="",filter_statements)
+    
+    ## substitute names from 
+    for(i in seq_len(nrow(name_chart))){
+      nonmem_data_name <- paste0(""\\b"", name_chart$nonmem_data_names[i], ""\\b"")
+      r_data_name <- name_chart$r_data_names[i]
+      filter_statements <- gsub(nonmem_data_name,
+                                r_data_name,
+                                filter_statements)
+    }
+    
     filter_statements <- paste(filter_statements, collapse= "" | "")
     if(""ACCEPT"" %in% type) filter_statements <- paste0(""!("",filter_statements,"")"")
   } else {
@@ -599,9 +626,10 @@ data_ignore_char.default <- function(r){
 #' Opposite of data_ignore_char 
 #' 
 #' @param r object coercible into ctl_list
+#' @param ... arguments passed to data_ignore_char
 #' @export
-data_filter_char <- function(r){
-  ignore_char <- data_ignore_char(r)
+data_filter_char <- function(r, ...){
+  ignore_char <- data_ignore_char(r, ...)
   if(ignore_char == ""FALSE"") return(""TRUE"")
   ignored <- !grepl(""^!\\((.*)\\)"", ignore_char)
   accepted <- !ignored

---FILE: R/sim_reestExtra.R---
@@ -164,7 +164,7 @@ covariate_step_setup <- function(base, run_id, run_in = getOption(""models.dir""),
   }
   
   ## check no covariates are in dataset and have no missing values
-  dinput <- NMproject::input_data(base)
+  dinput <- input_data(base)
   test_covs <- unique(dtest$cov)
   if(any(!test_covs %in% names(dinput))){
     stop(""cannot find covariates:\n "",

---FILE: R/utilsExtra.R---
@@ -191,46 +191,6 @@ mutate_cond <- function(.data, condition, ..., envir = parent.frame()) {
   .data
 }
 
-## generic already defined
-## internal function
-data_ignore_char.nm_generic <- function(r){
-  dol_data <- r %>% target(""$DATA"") %>% text
-  dol_data <- dol_data[!dol_data %in% """"]
-  dol_data <- rem_comment(dol_data)
-  
-  ignore_present <- any(grepl("".*IGNORE\\s*=\\s*\\("",dol_data))
-  accept_present <- any(grepl("".*ACCEPT\\s*=\\s*\\("",dol_data))
-  
-  type <- NA
-  if(ignore_present & accept_present) stop(""cannot identify ignore columns"")
-  if(ignore_present) type <- ""IGNORE""
-  if(accept_present) type <- ""ACCEPT""
-  no_filter <- is.na(type)
-  
-  if(!no_filter){
-    filter_statements <- paste0("".*"",type,""\\s*=\\s*\\((\\S[^\\)]+)\\)*.*"")
-    dol_data <- dol_data[grepl(filter_statements, dol_data)]
-    filter_statements <- gsub(filter_statements,""\\1"",dol_data)
-    filter_statements <- unlist(strsplit(filter_statements,"",""))
-    filter_statements <- gsub(""\\.EQ\\."",""=="",filter_statements)
-    filter_statements <- gsub(""\\.NE\\."",""!="",filter_statements)
-    filter_statements <- gsub(""\\.EQN\\."",""=="",filter_statements)
-    filter_statements <- gsub(""\\.NEN\\."",""!="",filter_statements)
-    filter_statements <- gsub(""\\./E\\."",""!="",filter_statements)
-    filter_statements <- gsub(""\\.GT\\."","">"",filter_statements)
-    filter_statements <- gsub(""\\.LT\\."",""<"",filter_statements)
-    filter_statements <- gsub(""\\.GE\\."","">="",filter_statements)
-    filter_statements <- gsub(""\\.LE\\."",""<="",filter_statements)
-    filter_statements <- paste(filter_statements, collapse= "" | "")
-    if(""ACCEPT"" %in% type) filter_statements <- paste0(""!("",filter_statements,"")"")
-  } else {
-    filter_statements <- ""FALSE""
-  }
-  filter_statements
-}
-data_ignore_char.nm_list <- Vectorize_nm_list(data_ignore_char.nm_generic, SIMPLIFY = TRUE)
-
-
 gsub_in_brackets <- function(pattern, replacement, x){
   x <- gsub(""\\("", ""~("", x)
   x <- gsub(""\\)"", "")~"", x)

---FILE: inst/extdata/examples/testthat/DerivedData/THEOPP.csv---
@@ -0,0 +1,145 @@
+ID,AMT,TIME,DV,WT
+1,4.02,0,.,79.6
+1,.,0,0.74,.
+1,.,0.25,2.84,.
+1,.,0.57,6.57,.
+1,.,1.12,10.5,.
+1,.,2.02,9.66,.
+1,.,3.82,8.58,.
+1,.,5.1,8.36,.
+1,.,7.03,7.47,.
+1,.,9.05,6.89,.
+1,.,12.12,5.94,.
+1,.,24.37,3.28,.
+2,4.4,0,.,72.4
+2,.,0,0,.
+2,.,0.27,1.72,.
+2,.,0.52,7.91,.
+2,.,1,8.31,.
+2,.,1.92,8.33,.
+2,.,3.5,6.85,.
+2,.,5.02,6.08,.
+2,.,7.03,5.4,.
+2,.,9,4.55,.
+2,.,12,3.01,.
+2,.,24.3,0.9,.
+3,4.53,0,.,70.5
+3,.,0,0,.
+3,.,0.27,4.4,.
+3,.,0.58,6.9,.
+3,.,1.02,8.2,.
+3,.,2.02,7.8,.
+3,.,3.62,7.5,.
+3,.,5.08,6.2,.
+3,.,7.07,5.3,.
+3,.,9,4.9,.
+3,.,12.15,3.7,.
+3,.,24.17,1.05,.
+4,4.4,0,.,72.7
+4,.,0,0,.
+4,.,0.35,1.89,.
+4,.,0.6,4.6,.
+4,.,1.07,8.6,.
+4,.,2.13,8.38,.
+4,.,3.5,7.54,.
+4,.,5.02,6.88,.
+4,.,7.02,5.78,.
+4,.,9.02,5.33,.
+4,.,11.98,4.19,.
+4,.,24.65,1.15,.
+5,5.86,0,.,54.6
+5,.,0,0,.
+5,.,0.3,2.02,.
+5,.,0.52,5.63,.
+5,.,1,11.4,.
+5,.,2.02,9.33,.
+5,.,3.5,8.74,.
+5,.,5.02,7.56,.
+5,.,7.02,7.09,.
+5,.,9.1,5.9,.
+5,.,12,4.37,.
+5,.,24.35,1.57,.
+6,4,0,.,80
+6,.,0,0,.
+6,.,0.27,1.29,.
+6,.,0.58,3.08,.
+6,.,1.15,6.44,.
+6,.,2.03,6.32,.
+6,.,3.57,5.53,.
+6,.,5,4.94,.
+6,.,7,4.02,.
+6,.,9.22,3.46,.
+6,.,12.1,2.78,.
+6,.,23.85,0.92,.
+7,4.95,0,.,64.6
+7,.,0,0.15,.
+7,.,0.25,0.85,.
+7,.,0.5,2.35,.
+7,.,1.02,5.02,.
+7,.,2.02,6.58,.
+7,.,3.48,7.09,.
+7,.,5,6.66,.
+7,.,6.98,5.25,.
+7,.,9,4.39,.
+7,.,12.05,3.53,.
+7,.,24.22,1.15,.
+8,4.53,0,.,70.5
+8,.,0,0,.
+8,.,0.25,3.05,.
+8,.,0.52,3.05,.
+8,.,0.98,7.31,.
+8,.,2.02,7.56,.
+8,.,3.53,6.59,.
+8,.,5.05,5.88,.
+8,.,7.15,4.73,.
+8,.,9.07,4.57,.
+8,.,12.1,3,.
+8,.,24.12,1.25,.
+9,3.1,0,.,86.4
+9,.,0,0,.
+9,.,0.3,7.37,.
+9,.,0.63,9.03,.
+9,.,1.05,7.14,.
+9,.,2.02,6.33,.
+9,.,3.53,5.66,.
+9,.,5.02,5.67,.
+9,.,7.17,4.24,.
+9,.,8.8,4.11,.
+9,.,11.6,3.16,.
+9,.,24.43,1.12,.
+10,5.5,0,.,58.2
+10,.,0,0.24,.
+10,.,0.37,2.89,.
+10,.,0.77,5.22,.
+10,.,1.02,6.41,.
+10,.,2.05,7.83,.
+10,.,3.55,10.21,.
+10,.,5.05,9.18,.
+10,.,7.08,8.02,.
+10,.,9.38,7.14,.
+10,.,12.1,5.68,.
+10,.,23.7,2.42,.
+11,4.92,0,.,65
+11,.,0,0,.
+11,.,0.25,4.86,.
+11,.,0.5,7.24,.
+11,.,0.98,8,.
+11,.,1.98,6.81,.
+11,.,3.6,5.87,.
+11,.,5.02,5.22,.
+11,.,7.03,4.45,.
+11,.,9.03,3.62,.
+11,.,12.12,2.69,.
+11,.,24.08,0.86,.
+12,5.3,0,.,60.5
+12,.,0,0,.
+12,.,0.25,1.25,.
+12,.,0.5,3.96,.
+12,.,1,7.82,.
+12,.,2,9.72,.
+12,.,3.52,9.75,.
+12,.,5.07,8.57,.
+12,.,7.07,6.59,.
+12,.,9.03,6.11,.
+12,.,12.05,4.57,.
+12,.,24.15,1.17,.

---FILE: inst/extdata/examples/testthat/Models/run1.mod---
@@ -0,0 +1,96 @@
+;; 1. Based on:
+;; 2. Description: 1CMT+oral
+;; x1. Author: klgk669
+
+$PROBLEM THEOPP example
+
+;; 4. Date: 01.01.2011
+;; 5. Version: 1
+;; 6. Label:
+;; Basic model
+;; 7. Structural model:
+;; One compartment model
+;; 8. Covariate model:
+;; No covariates
+;; 9. Inter-individual variability:
+;; CL and V1.
+;; 10. Inter-occasion variability:
+;; No IOV
+;; 11. Residual variability:
+;; Additive + Proportional
+;; 12. Estimation:
+;; IMP
+
+$INPUT ID AMT TIME DV WT
+$DATA ../DerivedData/THEOPP.csv IGNORE=@
+$SUB ADVAN2
+
+$PK
+
+TVKA=EXP(THETA(1))
+MU_1=LOG(TVKA)
+KA = EXP(MU_1+ETA(1))
+
+TVK=EXP(THETA(2))
+MU_2=LOG(TVK)
+K = EXP(MU_2+ETA(2))
+
+TVV=EXP(THETA(3))
+MU_3=LOG(TVV)
+V = EXP(MU_3+ETA(3))
+
+CL = K*V
+
+S2 = V
+
+$ERROR
+
+IPRED=F
+W=SQRT(THETA(4)**2+THETA(5)**2*IPRED*IPRED)  ; proportional + additive error
+IRES=DV-IPRED
+IWRES=IRES/W
+Y=IPRED+W*EPS(1)
+
+
+$THETA
+1             	; KA ; h-1 ; LOG
+-2.5            ; K  ; h-1 ; LOG
+-0.5          	; V  ; L ; LOG
+0.1           	; add error
+0.1           	; prop error
+
+$OMEGA
+0.1			; IIV_KA ; LOG
+0.1			; IIV_K ; LOG
+0.1			; IIV_V ; LOG
+
+
+$SIGMA
+1 FIX
+
+; Parameter estimation - FOCE
+$EST METHOD=1 INTER NOABORT MAXEVAL=9999 PRINT=1 NSIG=3 SIGL=9
+
+; Parameter estimation - IMP
+;$EST METHOD=IMP ISAMPLE=300 NITER=300 RANMETHOD=3S2P
+;CTYPE=3 CITER=10 CALPHA=0.05 CINTERVAL=3
+;PRINT=1 NOABORT INTERACTION GRD=DDDSS
+
+; Parameer estimation - SAEM
+;$EST METHOD=SAEM ISAMPLE=2 NBURN=1000 NITER=500 RANMETHOD=3S2P
+;CTYPE=3 CITER=10 CALPHA=0.05 CINTERVAL=10
+;PRINT=1 NOABORT INTERACTION GRD=DDDSS
+
+; Objective function and covariance evaluation
+;$EST METHOD=IMP INTER EONLY= 1 MAPITER=0 ISAMPLE = 2000 NITER = 10 RANMETHOD=3S2P NOABORT PRINT=1 NSIG=3 SIGL=9 GRD=DDDSS
+
+$COV PRINT=E UNCONDITIONAL SIGL=10
+
+$TABLE ID TIME IPRED IWRES IRES CWRES NPDE
+FILE=sdtab1 NOPRINT ONEHEADER FORMAT=tF13.4
+$TABLE ID ETAS(1:LAST); individual parameters
+FILE=patab1 NOPRINT ONEHEADER FORMAT=tF13.4
+$TABLE ID ; continuous covariates
+FILE=cotab1 NOPRINT ONEHEADER FORMAT=tF13.4
+$TABLE ID ; categorical covariates
+FILE=catab1 NOPRINT ONEHEADER FORMAT=tF13.4

---FILE: inst/extdata/examples/testthat/Models/run2.mod---
@@ -0,0 +1,96 @@
+;; 1. Based on: 1
+;; 2. Description: 1CMT+oral
+;; x1. Author: klgk669
+
+$PROBLEM THEOPP example
+
+;; 4. Date: 01.01.2011
+;; 5. Version: 1
+;; 6. Label:
+;; Basic model
+;; 7. Structural model:
+;; One compartment model
+;; 8. Covariate model:
+;; No covariates
+;; 9. Inter-individual variability:
+;; CL and V1.
+;; 10. Inter-occasion variability:
+;; No IOV
+;; 11. Residual variability:
+;; Additive + Proportional
+;; 12. Estimation:
+;; IMP
+
+$INPUT ID AMT TIME DV WT
+$DATA ../DerivedData/THEOPP.csv IGNORE=@
+$SUB ADVAN2
+
+$PK
+
+TVKA=EXP(THETA(1))
+MU_1=LOG(TVKA)
+KA = EXP(MU_1+ETA(1))
+
+TVK=EXP(THETA(2))
+MU_2=LOG(TVK)
+K = EXP(MU_2+ETA(2))
+
+TVV=EXP(THETA(3))
+MU_3=LOG(TVV)
+V = EXP(MU_3+ETA(3))
+
+CL = K*V
+
+S2 = V
+
+$ERROR
+
+IPRED=F
+W=SQRT(THETA(4)**2+THETA(5)**2*IPRED*IPRED)  ; proportional + additive error
+IRES=DV-IPRED
+IWRES=IRES/W
+Y=IPRED+W*EPS(1)
+
+
+$THETA
+1             	; KA ; h-1 ; LOG
+-2.5            ; K  ; h-1 ; LOG
+-0.5          	; V  ; L ; LOG
+0.1           	; add error
+0.1           	; prop error
+
+$OMEGA
+0.1			; IIV_KA ; LOG
+0.1			; IIV_K ; LOG
+0.1			; IIV_V ; LOG
+
+
+$SIGMA
+1 FIX
+
+; Parameter estimation - FOCE
+;$EST METHOD=1 INTER NOABORT MAXEVAL=9999 PRINT=1 NSIG=3 SIGL=9
+
+; Parameter estimation - IMP
+$EST METHOD=IMP ISAMPLE=300 NITER=300 RANMETHOD=3S2P
+CTYPE=3 CITER=10 CALPHA=0.05 CINTERVAL=3
+PRINT=1 NOABORT INTERACTION GRD=DDDSS
+
+; Parameer estimation - SAEM
+;$EST METHOD=SAEM ISAMPLE=2 NBURN=1000 NITER=500 RANMETHOD=3S2P
+;CTYPE=3 CITER=10 CALPHA=0.05 CINTERVAL=10
+;PRINT=1 NOABORT INTERACTION GRD=DDDSS
+
+; Objective function and covariance evaluation
+$EST METHOD=IMP INTER EONLY= 1 MAPITER=0 ISAMPLE = 2000 NITER = 10 RANMETHOD=3S2P NOABORT PRINT=1 NSIG=3 SIGL=9 GRD=DDDSS
+
+$COV PRINT=E UNCONDITIONAL SIGL=10
+
+$TABLE ID TIME IPRED IWRES IRES CWRES NPDE
+FILE=sdtab2 NOPRINT ONEHEADER FORMAT=tF13.4
+$TABLE ID ETAS(1:LAST); individual parameters
+FILE=patab2 NOPRINT ONEHEADER FORMAT=tF13.4
+$TABLE ID ; continuous covariates
+FILE=cotab2 NOPRINT ONEHEADER FORMAT=tF13.4
+$TABLE ID ; categorical covariates
+FILE=catab2 NOPRINT ONEHEADER FORMAT=tF13.4

---FILE: inst/extdata/examples/testthat/Models/run3.mod---
@@ -0,0 +1,96 @@
+;; 1. Based on: 2
+;; 2. Description: 1CMT+oral
+;; x1. Author: klgk669
+
+$PROBLEM THEOPP example
+
+;; 4. Date: 01.01.2011
+;; 5. Version: 1
+;; 6. Label:
+;; Basic model
+;; 7. Structural model:
+;; One compartment model
+;; 8. Covariate model:
+;; No covariates
+;; 9. Inter-individual variability:
+;; CL and V1.
+;; 10. Inter-occasion variability:
+;; No IOV
+;; 11. Residual variability:
+;; Additive + Proportional
+;; 12. Estimation:
+;; IMP
+
+$INPUT ID AMT TIME DV WT
+$DATA ../DerivedData/THEOPP.csv IGNORE=@ 
+$SUB ADVAN2
+
+$PK
+
+TVKA=EXP(THETA(1))
+MU_1=LOG(TVKA)
+KA = EXP(MU_1+ETA(1))
+
+TVK=EXP(THETA(2))
+MU_2=LOG(TVK)
+K = EXP(MU_2+ETA(2))
+
+TVV=EXP(THETA(3))
+MU_3=LOG(TVV)
+V = EXP(MU_3+ETA(3))
+
+CL = K*V
+
+S2 = V
+
+$ERROR 
+
+IPRED=F
+W=SQRT(THETA(4)**2+THETA(5)**2*IPRED*IPRED)  ; proportional + additive error
+IRES=DV-IPRED
+IWRES=IRES/W
+Y=IPRED+W*EPS(1)
+
+
+$THETA
+1             	; KA ; h-1 ; LOG
+-2.5            ; K  ; h-1 ; LOG
+-0.5          	; V  ; L ; LOG
+0.1           	; add error
+0.1           	; prop error
+
+$OMEGA
+0.1			; IIV_KA ; LOG
+0.1			; IIV_K ; LOG
+0.1			; IIV_V ; LOG
+
+
+$SIGMA
+1 FIX
+
+; Parameter estimation - FOCE
+;$EST METHOD=1 INTER NOABORT MAXEVAL=9999 PRINT=1 NSIG=3 SIGL=9
+
+; Parameter estimation - IMP
+;$EST METHOD=IMP ISAMPLE=300 NITER=300 RANMETHOD=3S2P
+;CTYPE=3 CITER=10 CALPHA=0.05 CINTERVAL=3
+;PRINT=1 NOABORT INTERACTION GRD=DDDSS
+
+; Parameer estimation - SAEM
+$EST METHOD=SAEM ISAMPLE=2 NBURN=1000 NITER=500 RANMETHOD=3S2P
+CTYPE=3 CITER=10 CALPHA=0.05 CINTERVAL=10
+PRINT=1 NOABORT INTERACTION GRD=DDDSS
+
+; Objective function and covariance evaluation
+$EST METHOD=IMP INTER EONLY= 1 MAPITER=0 ISAMPLE = 2000 NITER = 10 RANMETHOD=3S2P NOABORT PRINT=1 NSIG=3 SIGL=9 GRD=DDDSS
+
+$COV PRINT=E UNCONDITIONAL SIGL=10
+
+$TABLE ID TIME IPRED IWRES IRES CWRES NPDE
+FILE=sdtab3 NOPRINT ONEHEADER FORMAT=tF13.4
+$TABLE ID ETAS(1:LAST); individual parameters
+FILE=patab3 NOPRINT ONEHEADER FORMAT=tF13.4
+$TABLE ID ; continuous covariates
+FILE=cotab3 NOPRINT ONEHEADER FORMAT=tF13.4
+$TABLE ID ; categorical covariates
+FILE=catab3 NOPRINT ONEHEADER FORMAT=tF13.4

---FILE: inst/extdata/examples/testthat/Models/run4.mod---
@@ -0,0 +1,103 @@
+;; 1. Based on: /home/klgk669/test13/Models/run3.mod
+;; 2. Description: Differential equation use
+;; x1. Author: klgk669
+
+$PROBLEM THEOPP example
+
+;; 4. Date: 01.01.2011
+;; 5. Version: 1
+;; 6. Label:
+;; Basic model
+;; 7. Structural model:
+;; One compartment model
+;; 8. Covariate model:
+;; No covariates
+;; 9. Inter-individual variability:
+;; CL and V1.
+;; 10. Inter-occasion variability:
+;; No IOV
+;; 11. Residual variability:
+;; Additive + Proportional
+;; 12. Estimation:
+;; IMP
+
+$INPUT ID AMT TIME DV WT
+$DATA ../DerivedData/THEOPP.csv IGNORE=@ 
+$SUB ADVAN13 TOL=12
+$MODEL 
+       COMP = (DEPOT)
+       COMP = (CENTRAL)
+
+$PK
+
+TVKA=EXP(THETA(1))
+MU_1=LOG(TVKA)
+KA = EXP(MU_1+ETA(1))
+
+TVK=EXP(THETA(2))
+MU_2=LOG(TVK)
+K = EXP(MU_2+ETA(2))
+
+TVV=EXP(THETA(3))
+MU_3=LOG(TVV)
+V = EXP(MU_3+ETA(3))
+
+CL = K*V
+
+S2 = V
+
+$DES
+
+DADT(1) = -KA*A(1)
+DADT(2) =  KA*A(1) - K*A(2)
+
+$ERROR 
+
+IPRED=F
+W=SQRT(THETA(4)**2+THETA(5)**2*IPRED*IPRED)  ; proportional + additive error
+IRES=DV-IPRED
+IWRES=IRES/W
+Y=IPRED+W*EPS(1)
+
+
+$THETA
+1             	; KA ; h-1 ; LOG
+-2.5            ; K  ; h-1 ; LOG
+-0.5          	; V  ; L ; LOG
+0.1           	; add error
+0.1           	; prop error
+
+$OMEGA
+0.1			; IIV_KA ; LOG
+0.1			; IIV_K ; LOG
+0.1			; IIV_V ; LOG
+
+$SIGMA
+1 FIX
+
+; Parameter estimation - FOCE
+;$EST METHOD=1 INTER NOABORT MAXEVAL=9999 PRINT=1 NSIG=3 SIGL=9
+
+; Parameter estimation - IMP
+$EST METHOD=IMP ISAMPLE=300 NITER=300 RANMETHOD=3S2P 
+CTYPE=3 CITER=10 CALPHA=0.05 CINTERVAL=3
+PRINT=1 NOABORT INTERACTION GRD=DDDSS
+
+; Parameer estimation - SAEM
+;$EST METHOD=SAEM ISAMPLE=2 NBURN=1000 NITER=500 RANMETHOD=3S2P
+;CTYPE=3 CITER=10 CALPHA=0.05 CINTERVAL=10
+;PRINT=1 NOABORT INTERACTION GRD=DDDSS
+
+; Objective function and covariance evaluation
+$EST METHOD=IMP INTER EONLY= 1 MAPITER=0 ISAMPLE = 2000 NITER = 10 RANMETHOD=3S2P NOABORT PRINT=1 NSIG=3 SIGL=9 GRD=DDDSS
+
+$COV MATRIX=R PRINT=E UNCONDITIONAL SIGL=10
+
+$TABLE ID TIME IPRED IWRES IRES CWRES NPDE
+FILE=sdtab4 NOPRINT ONEHEADER FORMAT=tF13.4
+$TABLE ID ETAS(1:LAST); individual parameters
+FILE=patab4 NOPRINT ONEHEADER FORMAT=tF13.4
+$TABLE ID ; continuous covariates
+FILE=cotab4 NOPRINT ONEHEADER FORMAT=tF13.4
+$TABLE ID ; categorical covariates
+FILE=catab4 NOPRINT ONEHEADER FORMAT=tF13.4

---FILE: inst/extdata/examples/testthat/Models/run5.mod---
@@ -0,0 +1,96 @@
+;; 1. Based on: 2
+;; 2. Description: 1CMT+oral
+;; x1. Author: klgk669
+
+$PROBLEM THEOPP example
+
+;; 4. Date: 01.01.2011
+;; 5. Version: 1
+;; 6. Label:
+;; Basic model
+;; 7. Structural model:
+;; One compartment model
+;; 8. Covariate model:
+;; No covariates
+;; 9. Inter-individual variability:
+;; CL and V1.
+;; 10. Inter-occasion variability:
+;; No IOV
+;; 11. Residual variability:
+;; Additive + Proportional
+;; 12. Estimation:
+;; IMP
+
+$INPUT ID AMT TIME DV WT
+$DATA ../DerivedData/THEOPPlarge.csv IGNORE=@ 
+$SUB ADVAN2
+
+$PK
+
+TVKA=EXP(THETA(1))
+MU_1=LOG(TVKA)
+KA = EXP(MU_1+ETA(1))
+
+TVK=EXP(THETA(2))
+MU_2=LOG(TVK)
+K = EXP(MU_2+ETA(2))
+
+TVV=EXP(THETA(3))
+MU_3=LOG(TVV)
+V = EXP(MU_3+ETA(3))
+
+CL = K*V
+
+S2 = V
+
+$ERROR 
+
+IPRED=F
+W=SQRT(THETA(4)**2+THETA(5)**2*IPRED*IPRED)  ; proportional + additive error
+IRES=DV-IPRED
+IWRES=IRES/W
+Y=IPRED+W*EPS(1)
+
+
+$THETA
+1             	; KA ; h-1 ; LOG
+-2.5            ; K  ; h-1 ; LOG
+-0.5          	; V  ; L ; LOG
+0.1           	; add error
+0.1           	; prop error
+
+$OMEGA
+0.1			; IIV_KA ; LOG
+0.1			; IIV_K ; LOG
+0.1			; IIV_V ; LOG
+
+
+$SIGMA
+1 FIX
+
+; Parameter estimation - FOCE
+;$EST METHOD=1 INTER NOABORT MAXEVAL=9999 PRINT=1 NSIG=3 SIGL=9
+
+; Parameter estimation - IMP
+$EST METHOD=IMP ISAMPLE=300 NITER=300 RANMETHOD=3S2P
+CTYPE=3 CITER=10 CALPHA=0.05 CINTERVAL=3
+PRINT=1 NOABORT INTERACTION GRD=DDDSS
+
+; Parameer estimation - SAEM
+;$EST METHOD=SAEM ISAMPLE=2 NBURN=1000 NITER=500 RANMETHOD=3S2P
+;CTYPE=3 CITER=10 CALPHA=0.05 CINTERVAL=10
+;PRINT=1 NOABORT INTERACTION GRD=DDDSS
+
+; Objective function and covariance evaluation
+$EST METHOD=IMP INTER EONLY= 1 MAPITER=0 ISAMPLE = 2000 NITER = 10 RANMETHOD=3S2P NOABORT PRINT=1 NSIG=3 SIGL=9 GRD=DDDSS
+
+$COV PRINT=E UNCONDITIONAL SIGL=10
+
+$TABLE ID TIME IPRED IWRES IRES CWRES NPDE
+FILE=sdtab5 NOPRINT ONEHEADER FORMAT=tF13.4
+$TABLE ID ETAS(1:LAST); individual parameters
+FILE=patab5 NOPRINT ONEHEADER FORMAT=tF13.4
+$TABLE ID ; continuous covariates
+FILE=cotab5 NOPRINT ONEHEADER FORMAT=tF13.4
+$TABLE ID ; categorical covariates
+FILE=catab5 NOPRINT ONEHEADER FORMAT=tF13.4

---FILE: inst/extdata/examples/testthat/Models/run6.mod---
@@ -0,0 +1,96 @@
+;; 1. Based on: 5
+;; 2. Description: 1CMT+oral
+;; x1. Author: klgk669
+
+$PROBLEM THEOPP example
+
+;; 4. Date: 01.01.2011
+;; 5. Version: 1
+;; 6. Label:
+;; Basic model
+;; 7. Structural model:
+;; One compartment model
+;; 8. Covariate model:
+;; No covariates
+;; 9. Inter-individual variability:
+;; CL and V1.
+;; 10. Inter-occasion variability:
+;; No IOV
+;; 11. Residual variability:
+;; Additive + Proportional
+;; 12. Estimation:
+;; IMP
+
+$INPUT ID AMT TIME DV WT
+$DATA ../DerivedData/THEOPPlarge.csv IGNORE=@ 
+$SUB ADVAN2
+
+$PK
+
+TVKA=EXP(THETA(1))
+MU_1=LOG(TVKA)
+KA = EXP(MU_1+ETA(1))
+
+TVK=EXP(THETA(2))
+MU_2=LOG(TVK)
+K = EXP(MU_2+ETA(2))
+
+TVV=EXP(THETA(3))
+MU_3=LOG(TVV)
+V = EXP(MU_3+ETA(3))
+
+CL = K*V
+
+S2 = V
+
+$ERROR 
+
+IPRED=F
+W=SQRT(THETA(4)**2+THETA(5)**2*IPRED*IPRED)  ; proportional + additive error
+IRES=DV-IPRED
+IWRES=IRES/W
+Y=IPRED+W*EPS(1)
+
+
+$THETA
+1             	; KA ; h-1 ; LOG
+-2.5            ; K  ; h-1 ; LOG
+-0.5          	; V  ; L ; LOG
+0.1           	; add error
+0.1           	; prop error
+
+$OMEGA
+0.1			; IIV_KA ; LOG
+0.1			; IIV_K ; LOG
+0.1			; IIV_V ; LOG
+
+
+$SIGMA
+1 FIX
+
+; Parameter estimation - FOCE
+;$EST METHOD=1 INTER NOABORT MAXEVAL=9999 PRINT=1 NSIG=3 SIGL=9
+
+; Parameter estimation - IMP
+$EST METHOD=IMP ISAMPLE=300 NITER=300 RANMETHOD=3S2P
+CTYPE=3 CITER=10 CALPHA=0.05 CINTERVAL=3
+PRINT=1 NOABORT INTERACTION GRD=DDDSS
+
+; Parameer estimation - SAEM
+;$EST METHOD=SAEM ISAMPLE=2 NBURN=1000 NITER=500 RANMETHOD=3S2P
+;CTYPE=3 CITER=10 CALPHA=0.05 CINTERVAL=10
+;PRINT=1 NOABORT INTERACTION GRD=DDDSS
+
+; Objective function and covariance evaluation
+$EST METHOD=IMP INTER EONLY= 1 MAPITER=0 ISAMPLE = 2000 NITER = 10 RANMETHOD=3S2P NOABORT PRINT=1 NSIG=3 SIGL=9 GRD=DDDSS
+
+$COV PRINT=E UNCONDITIONAL SIGL=10
+
+$TABLE ID TIME IPRED IWRES IRES CWRES NPDE
+FILE=sdtab6 NOPRINT ONEHEADER FORMAT=tF13.4
+$TABLE ID ETAS(1:LAST); individual parameters
+FILE=patab6 NOPRINT ONEHEADER FORMAT=tF13.4
+$TABLE ID ; continuous covariates
+FILE=cotab6 NOPRINT ONEHEADER FORMAT=tF13.4
+$TABLE ID ; categorical covariates
+FILE=catab6 NOPRINT ONEHEADER FORMAT=tF13.4

---FILE: inst/extdata/examples/testthat/Models/run7.mod---
@@ -0,0 +1,115 @@
+;; 1. Based on: 5
+;; 2. Description: 1CMT+oral
+;; x1. Author: klgk669
+
+$PROBLEM THEOPP example
+
+;; 4. Date: 01.01.2011
+;; 5. Version: 1
+;; 6. Label:
+;; Basic model
+;; 7. Structural model:
+;; One compartment model
+;; 8. Covariate model:
+;; No covariates
+;; 9. Inter-individual variability:
+;; CL and V1.
+;; 10. Inter-occasion variability:
+;; No IOV
+;; 11. Residual variability:
+;; Additive + Proportional
+;; 12. Estimation:
+;; IMP
+
+$INPUT ID AMT TIME DV WT EVID TYPE
+$DATA ../DerivedData/THEOPPPKPD.csv IGNORE=@ IGNORE=(TYPE.GT.2)
+$SUB ADVAN2
+
+$PK
+
+TVKA=EXP(THETA(1))
+MU_1=LOG(TVKA)
+KA = EXP(MU_1+ETA(1))
+
+TVK=EXP(THETA(2))
+MU_2=LOG(TVK)
+K = EXP(MU_2+ETA(2))
+
+TVV=EXP(THETA(3))
+MU_3=LOG(TVV)
+V = EXP(MU_3+ETA(3))
+
+CL = K*V
+
+S2 = V
+
+TVEMAX=EXP(THETA(4))
+MU_4=LOG(TVEMAX)
+EMAX = EXP(MU_4+ETA(4))
+
+TVEC50=EXP(THETA(5))
+MU_5=LOG(TVEC50)
+EC50 = EXP(MU_5+ETA(5))
+
+
+$ERROR 
+
+IF(TYPE.EQ.1) THEN
+IPRED=F
+ENDIF
+
+IF(TYPE.EQ.2) THEN
+IPRED=F*EMAX/(F+EC50)
+ENDIF
+
+W=SQRT(THETA(6)**2+THETA(7)**2*IPRED*IPRED)  ; proportional + additive error
+IRES=DV-IPRED
+IWRES=IRES/W
+Y=IPRED+W*EPS(1)
+
+
+$THETA
+1             	; KA ; h-1 ; LOG
+-2.5            ; K  ; h-1 ; LOG
+-0.5          	; V  ; L ; LOG
+0.1            ; EMAX  ;  ; LOG
+0.1          	; EC50  ; ng/ml ; LOG
+0.1           	; add error
+0.1           	; prop error
+
+$OMEGA
+0.1			; IIV_KA ; LOG
+0.1			; IIV_K ; LOG
+0.1			; IIV_V ; LOG
+0.1			; IIV_EMAX ; LOG
+0.1			; IIV_EC50 ; LOG
+
+$SIGMA
+1 FIX
+
+; Parameter estimation - FOCE
+;$EST METHOD=1 INTER NOABORT MAXEVAL=9999 PRINT=1 NSIG=3 SIGL=9
+
+; Parameter estimation - IMP
+$EST METHOD=IMP ISAMPLE=300 NITER=300 RANMETHOD=3S2P
+CTYPE=3 CITER=10 CALPHA=0.05 CINTERVAL=3
+PRINT=1 NOABORT INTERACTION GRD=DDDDDSS
+
+; Parameer estimation - SAEM
+;$EST METHOD=SAEM ISAMPLE=2 NBURN=1000 NITER=500 RANMETHOD=3S2P
+;CTYPE=3 CITER=10 CALPHA=0.05 CINTERVAL=10
+;PRINT=1 NOABORT INTERACTION GRD=DDDDDSS
+
+; Objective function and covariance evaluation
+$EST METHOD=IMP INTER EONLY= 1 MAPITER=0 ISAMPLE = 2000 NITER = 10 RANMETHOD=3S2P NOABORT PRINT=1 NSIG=3 SIGL=9 GRD=DDDDDSS
+
+$COV PRINT=E UNCONDITIONAL SIGL=10
+
+$TABLE ID TIME IPRED IWRES IRES CWRES NPDE
+FILE=sdtab7 NOPRINT ONEHEADER FORMAT=tF13.4
+$TABLE ID ETAS(1:LAST); individual parameters
+FILE=patab7 NOPRINT ONEHEADER FORMAT=tF13.4
+$TABLE ID ; continuous covariates
+FILE=cotab7 NOPRINT ONEHEADER FORMAT=tF13.4
+$TABLE ID ; categorical covariates
+FILE=catab7 NOPRINT ONEHEADER FORMAT=tF13.4

---FILE: inst/extdata/examples/testthat/Models/run8.mod---
@@ -0,0 +1,117 @@
+;; 1. Based on: 7
+;; 2. Description: 1CMT+oral
+;; x1. Author: klgk669
+
+$PROBLEM THEOPP example
+
+;; 4. Date: 01.01.2011
+;; 5. Version: 1
+;; 6. Label:
+;; Basic model
+;; 7. Structural model:
+;; One compartment model
+;; 8. Covariate model:
+;; No covariates
+;; 9. Inter-individual variability:
+;; CL and V1.
+;; 10. Inter-occasion variability:
+;; No IOV
+;; 11. Residual variability:
+;; Additive + Proportional
+;; 12. Estimation:
+;; IMP
+
+$INPUT ID AMT TIME DV WT EVID TYPE
+$DATA ../DerivedData/THEOPPPKPD.csv IGNORE=@ IGNORE=(TYPE.EQ.2)
+$SUB ADVAN2
+
+$PK
+
+TVKA=EXP(THETA(1))
+MU_1=LOG(TVKA)
+KA = EXP(MU_1+ETA(1))
+
+TVK=EXP(THETA(2))
+MU_2=LOG(TVK)
+K = EXP(MU_2+ETA(2))
+
+TVV=EXP(THETA(3))
+MU_3=LOG(TVV)
+V = EXP(MU_3+ETA(3))
+
+CL = K*V
+
+S2 = V
+
+TVINT=EXP(THETA(4))
+MU_4=LOG(TVINT)
+INT = EXP(MU_4+ETA(4))
+
+TVSLOP=EXP(THETA(5))
+MU_5=LOG(TVSLOP)
+SLOP = EXP(MU_5+ETA(5))
+
+
+$ERROR 
+
+IPRED=F
+W=SQRT(THETA(6)**2+THETA(7)**2*IPRED*IPRED)  ; proportional + additive error
+IRES=DV-IPRED
+IWRES=IRES/W
+
+IF(TYPE.EQ.1) THEN
+Y=IPRED+W*EPS(1)
+ENDIF
+
+PROB = 1/(1+EXP(INT+SLOP*F))
+
+IF(TYPE.EQ.2) THEN
+F_FLAG=1
+Y = PROB*DV + (1-DV)*(1-PROB)
+ENDIF
+
+$THETA
+1             	; KA ; h-1 ; LOG
+-2.5            ; K  ; h-1 ; LOG
+-0.5          	; V  ; L ; LOG
+-4            ; INT  ;  ; LOG
+0 FIX          	; SLOP  ;  ; LOG
+0.1           	; add error
+0.1           	; prop error
+
+$OMEGA
+0.1			; IIV_KA ; LOG
+0.1			; IIV_K ; LOG
+0.1			; IIV_V ; LOG
+0.1 FIX			; IIV_INT ; LOG
+0 FIX			; IIV_SLOP ; LOG
+
+$SIGMA
+1 FIX
+
+; Parameter estimation - FOCE
+;$EST METHOD=1 INTER NOABORT MAXEVAL=9999 PRINT=1 NSIG=3 SIGL=9 LAPLACIAN
+
+; Parameter estimation - IMP
+$EST METHOD=IMP ISAMPLE=300 NITER=300 RANMETHOD=3S2P
+CTYPE=3 CITER=10 CALPHA=0.05 CINTERVAL=3
+PRINT=1 NOABORT INTERACTION GRD=DDDDDSS LAPLACIAN
+
+; Parameer estimation - SAEM
+;$EST METHOD=SAEM ISAMPLE=2 NBURN=1000 NITER=500 RANMETHOD=3S2P
+;CTYPE=3 CITER=10 CALPHA=0.05 CINTERVAL=10
+;PRINT=1 NOABORT INTERACTION GRD=DDDDDSS LAPLACIAN
+
+; Objective function and covariance evaluation
+$EST METHOD=IMP INTER EONLY= 1 MAPITER=0 ISAMPLE = 2000 NITER = 10 RANMETHOD=3S2P NOABORT PRINT=1 NSIG=3 SIGL=9 GRD=DDDDDSS LAPLACIAN
+
+$COV PRINT=E UNCONDITIONAL SIGL=10
+
+$TABLE ID TIME IPRED IWRES IRES CWRES NPDE
+FILE=sdtab8 NOPRINT ONEHEADER FORMAT=tF13.4
+$TABLE ID ETAS(1:LAST); individual parameters
+FILE=patab8 NOPRINT ONEHEADER FORMAT=tF13.4
+$TABLE ID ; continuous covariates
+FILE=cotab8 NOPRINT ONEHEADER FORMAT=tF13.4
+$TABLE ID ; categorical covariates
+FILE=catab8 NOPRINT ONEHEADER FORMAT=tF13.4

---FILE: inst/extdata/examples/testthat/Scripts/basic_gof.Rmd---
@@ -0,0 +1,70 @@
+---
+output:
+  html_notebook: default
+params:
+  m: NA
+title: ""`r paste0(ctl_path(params$m), ': GOF')`""
+author: ""`r Sys.info()['user']`""
+date: ""`r Sys.time()`""
+---
+
+```{r setup, include=F}
+## DO NOT MODIFY THIS BLOCK (unless you know what you're doing)
+library(rprojroot)
+library(knitr)
+opts_knit$set(root.dir=find_root(has_file("".Rprofile"")))
+opts_chunk$set(echo = FALSE)
+opts_chunk$set(message = FALSE)
+if(!is.null(knitr::opts_knit$get('rmarkdown.pandoc.to'))){
+  .m <- params$m  
+}
+```
+
+```{r echo=FALSE,message=FALSE}
+## IF RUNNING INTERACTIVELY
+##  set m to be your object
+if(!interactive()) m <- params$m
+```
+
+```{r echo=FALSE,message=FALSE}
+library(NMprojectAZ)
+devtools::load_all(""~/NMproject"")
+```
+
+## run details
+
+```{r echo=FALSE}
+m
+```
+
+## convergence
+
+```{r echo=FALSE}
+plot_iter(m)
+```
+
+## outputs
+
+```{r echo=FALSE}
+rr(m)
+```
+
+```{r echo=FALSE}
+summary(m) %>%
+  select(run_id, status, ofv:cond_num)
+```
+
+## Diagnostics
+
+```{r echo=FALSE}
+m %>% gof_ggplot2()
+```
+
+## Appendix
+
+### Control file
+
+```{r echo=FALSE, message=FALSE}
+m %>% text() %>% .[[1]]
+```
+

---FILE: inst/extdata/examples/testthat/Scripts/empty_test_setup.R---
@@ -0,0 +1,140 @@
+## Copied from staging/Scripts/empty_test_setup.R
+##  (2020-02-27 13:26:18) by klgk669
+## Copied from staging/Scripts/nm.log2.R
+##  (2020-02-05 17:07:24) by klgk669
+## Copied from staging/Scripts/nm.log2.R
+##  (2020-01-07 19:55:27) by klgk669
+## Copied from staging/Scripts/nm.log2.R
+##  (2019-12-30 21:25:32) by klgk669
+## Author: klgk669
+## First created: 2019-12-10
+## Description: Model development script
+## Keywords:
+
+########################################
+## load packages and source functions here
+
+library(future)
+future::plan(""future::multiprocess"", workers = 2)
+library(NMprojectAZ)
+library(dplyr)
+devtools::load_all(""~/NMproject/"")
+load_localpackage()
+
+#module_cmd(""module load psn"")
+#module_cmd(""module load psn/4.8.1-foss-2017a"")
+#module_cmd(""module load psn/4.4.8-foss-2017a-gfortran-5.2-b1"")
+module_cmd(""module load psn/4.9.0-foss-2017a-gfortran-5.2-test"")
+
+#module_cmd(""module use /opt/scp/unsupported/PSN_NONMEM/opt/scp/modules/all; module load psn/4.9.0-foss-2017a-gfortran-5.2"")
+
+
+## resolution information
+
+level <- 1  ## NOTE Uncomment this if running directly
+#if(!exists(""level"")) stop(""need 'level' to be defined (either 1 or 2)"", call. = FALSE)
+
+if(level == 2) {
+  rerun_base <- TRUE
+  rep_test_n <- 100
+  core_by <- 1
+  do_bootstrap <- TRUE
+}
+
+if(level == 1) {
+  rerun_base <- FALSE
+  rep_test_n <- 10
+  core_by <- 3
+  do_bootstrap <- FALSE
+}
+
+########################################
+## main script here
+
+## setup_nm_demo(""testfiles"")
+
+## single core tests
+## control streams for runs 1 to 6 are in staging area
+
+ds <- tibble(run_id = 1:6)  ## runs 1 to 6 to be run single core
+
+ds$m <- nm(run_id = ds$run_id) %>%
+  ctl(""staging/Models/run{run_id}.mod"") %>%
+  #data_path(""DerivedData/THEOPP.csv"") %>%
+  cmd(""qpsn -t 100 -r 1000 -- execute run{run_id}.mod -dir={run_dir}"")
+
+#nm_tran(ds$m)
+
+m1default <- ds$m[1] %>% child(""1default"") %>%
+  run_in(""Models/moduletest"") #%>%
+#run_nm()
+
+
+m1new %<-% {
+  m1default %>% child(run_id = ""1new"") %>%
+    run_in(""Models/moduletestb1"") #%>%
+  #run_nm()
+}
+
+## direct psn test
+m1psn %<-% {
+  m1new %>% child(run_id = ""1psn"") %>%
+    cmd(""execute run{run_id}.mod -dir={run_id}"") %>%
+    run_in(""Models/moduletest"") #%>%
+  #run_nm()
+}
+
+## qnmfe test
+m1qnmfe <- {
+  ds$m[1] %>% child(run_id = ""1qnmfe"") %>%
+    run_in(file.path(run_in(.), ""qnmfe"")) %>%
+    cmd(""qnmfe -t 100 run{run_id}.mod run{run_id}.lst"") %>%
+    output_location(""run{run_id}.lst"") #%>%
+  #run_nm(force = TRUE)
+}
+
+####################################
+## repeat run6 100s of times
+
+d6 <- tibble(rep = 1:rep_test_n)
+d6$run_id <- paste0(""6_"", d6$rep)
+
+d6$m <- ds$m[6] %>% child(run_id = d6$run_id) %>%
+  run_in(""Models/reptest"") %>%
+  cmd(""qpsn -c auto -t 3000 -r 1000 -- execute run{run_id}.mod -dir={run_dir}"")
+
+#nm_tran(d6$m[1:2])
+
+# d6 %<-% {
+#   d6 %>% mutate(m = m %>% run_nm() %>%
+#                   wait_finish(timeout = 120*60) ## 120 mins
+#   )
+# }
+
+m1boot <- {
+  ds$m[1] %>% child(run_id = ""m1boot"", type = ""bootstrap"") %>%
+    cmd(""qpsn -c 5 -t 1000 -r 1000 -- bootstrap run{run_id}.mod -samples=50 -threads=25 -dir={run_dir}"")
+}
+
+
+####### summary test
+
+runs <- c(ds$m,
+          m1psn,
+          m1qnmfe,
+          d6$m[1],
+          m1boot)
+
+runs %>% write_ctl()
+
+## write commands
+paste(""cd"", run_in(runs), "";"", cmd(runs)) %>%
+  cat(file = ""run_commands.txt"", sep = ""\n"")
+
+proj_name <- basename(getwd())
+
+system_nm(
+  paste0(""cd .. ; tar -czvf "", proj_name, "".tar.gz "", proj_name, ""/""),
+  dir = getwd()
+)
+

---FILE: inst/extdata/examples/testthat/Scripts/nm.log2.R---
@@ -0,0 +1,232 @@
+## Copied from staging/Scripts/nm.log2.R
+##  (2020-02-05 17:07:24) by klgk669
+## Copied from staging/Scripts/nm.log2.R
+##  (2020-01-07 19:55:27) by klgk669
+## Copied from staging/Scripts/nm.log2.R
+##  (2019-12-30 21:25:32) by klgk669
+## Author: klgk669
+## First created: 2019-12-10
+## Description: Model development script
+## Keywords:
+
+########################################
+## load packages and source functions here
+
+library(future)
+future::plan(""future::multiprocess"", workers = 2)
+library(NMprojectAZ)
+library(dplyr)
+devtools::load_all(""~/NMproject/"")
+load_localpackage()
+
+if(!exists(""module_load_cmd"")){
+  module_load_cmd <- ""module load psn""
+}
+
+if(!exists(""level"")){
+  level <- 1
+}
+
+module_cmd(module_load_cmd)
+#module_cmd(""module load psn"")
+#module_cmd(""module load psn/4.8.1-foss-2017a"")
+#module_cmd(""module load psn/4.4.8-foss-2017a-gfortran-5.2-b1"")
+#module_cmd(""module load psn/4.9.0-foss-2017a-gfortran-5.2-test"")
+
+## resolution information
+if(level == 2) {
+  rerun_base <- TRUE
+  rep_test_n <- 100
+  core_by <- 1
+  do_bootstrap <- TRUE
+}
+
+if(level == 1) {
+  rerun_base <- FALSE
+  rep_test_n <- 10
+  core_by <- 3
+  do_bootstrap <- FALSE
+}
+
+########################################
+## main script here
+
+## setup_nm_demo(""testfiles"")
+
+## single core tests
+## control streams for runs 1 to 6 are in staging area
+
+ds <- tibble(run_id = 1:6)  ## runs 1 to 6 to be run single core
+
+ds$m <- nm(run_id = ds$run_id) %>%
+  ctl(""staging/Models/run{run_id}.mod"") %>%
+  #data_path(""DerivedData/THEOPP.csv"") %>%
+  cmd(""qpsn -t 59 -r 1000 -- execute run{run_id}.mod -dir={run_dir}"")
+
+#nm_tran(ds$m)
+
+# ds$m <- ds$m %>% run_nm()
+# ds$m <- ds$m %>% update_parameters()
+# ds$m <- ds$m %>% run_nm()
+
+if(rerun_base){
+  ds %<-% {
+    ds %>% mutate(
+      m = m %>% run_nm() %>%
+        update_parameters() %>%
+        run_nm() %>%
+        wait_finish(timeout = 20*60) ## wait max of 20 mins
+    )
+  }
+} else {
+  ds %<-% {
+    ds %>% mutate(
+      m = m %>% run_nm() %>%
+        wait_finish(timeout = 20*60) ## wait max of 20 mins
+    )
+  }
+}
+
+summary(ds$m) %>%
+  select(run_id, status, ofv:cond_num)
+
+## gof plot of first run
+pl <- ds$m[1] %>% gof_ggplot2()
+
+pl2 <- plot_job_run_times_nm(ds$m)
+pl2[6]
+
+ds$m <- ds$m %>%
+  nmsave_plot(gof_ggplot2(.), plot_name = ""gof_{run_id}.pdf"") %>%
+  nmsave_plot(gof_ggplot2(.), plot_name = ""gof_{run_id}.png"")
+
+ds$m[1] <- ds$m[1] %>%
+  nmsave_plot(pl2[6], plot_name = ""run_times_1:6.png"")
+
+ds$m[1] <- ds$m[1] %>%
+  nmsave_plot(pl2[[6]], plot_name = ""run_times_1:6.png"")
+
+
+# module_cmd(""module load psn"")
+# m1default <- ds$m[1] %>% child(""1default"") %>%
+#   run_in(""Models/moduletest"") %>%
+#   run_nm()
+#
+#
+# m1new %<-% {
+#   m1default %>% child(run_id = ""1new"") %>%
+#     run_in(""Models/moduletestb1"") %>%
+#     run_nm()
+# }
+#
+# ## direct psn test
+# m1psn %<-% {
+#   m1new %>% child(run_id = ""1psn"") %>%
+#     cmd(""execute run{run_id}.mod -dir={run_id}"") %>%
+#     run_nm()
+# }
+#
+# ## qnmfe test
+# m1qnmfe %<-% {
+#   m1new %>% child(run_id = ""1qnmfe"") %>%
+#     run_in(file.path(run_in(.), ""qnmfe"")) %>%
+#     cmd(""qnmfe -t 100 run{run_id}.mod run{run_id}.lst"") %>%
+#     output_location(""run{run_id}.lst"") %>%
+#     run_nm()
+# }
+#
+# ## nmfe test in own directory
+# m1nmfe %<-% {
+#   m1new %>% child(run_id = ""1nmfe"") %>%
+#     run_in(file.path(run_in(.), ""nmfe"")) %>%
+#     cmd(""nmfe73 run{run_id}.mod run{run_id}.lst"") %>%
+#     output_location(""run{run_id}.lst"") %>%
+#     run_nm()
+# }
+
+####################################
+## repeat run6 100s of times
+
+d6 <- tibble(rep = 1:rep_test_n)
+d6$run_id <- paste0(""6_"", d6$rep)
+
+d6$m <- ds$m[6] %>% child(run_id = d6$run_id) %>%
+  run_in(""Models/reptest"") %>%
+  cmd(""qpsn -c auto -t 59 -r 1000 -- execute run{run_id}.mod -dir={run_dir}"")
+
+#nm_tran(d6$m[1:2])
+
+d6 %<-% {
+  d6 %>% mutate(m = m %>% run_nm() %>%
+                  wait_finish(timeout = 120*60) ## 120 mins
+  )
+}
+
+####### summary test
+
+s6 <- summary(d6$m)
+
+status_table(d6$m)
+
+s6 %>% select(run_id, status, ofv:cond_num) %>% head(10)
+
+p62 <- plot_job_run_times_nm(d6$m)
+p62[[6]]
+
+d6$m[1] %>%
+  nmsave_table(status_table(d6$m), ""d6_run_status.csv"") %>%
+  nmsave_plot(p62[[6]], ""d6_run_times.png"")
+
+
+####################################
+## repeat run6 with different numbers of cores
+
+dc %<-% {
+  tibble(cores = seq(1,36, by = core_by)) %>%
+    mutate(m = ds$m[6] %>% child(run_id = cores) %>%
+             cmd(""qpsn -c {run_id} -t 1000 -r 1000 -- execute run{run_id}.mod -dir={run_dir}"") %>%
+             run_in(""Models/coretest"") %>%
+             run_nm() %>%
+             wait_finish(timeout = 120*60) ## 2 hour
+    )
+}
+
+sc <- summary(dc$m)
+
+status_table(dc$m)
+
+sc %>% select(run_id, status, ofv:cond_num) %>% head(5)
+
+pl <- plot_job_run_times(jobs = job_info(dc$m),
+                         run_in = run_in(dc$m))
+
+
+## print pl[[6]]
+
+dc$m[1] %>%
+  nmsave_table(status_table(dc$m), ""dc_run_status.csv"") %>%
+  nmsave_plot(pl[[6]], ""dc_run_times.png"")
+
+
+###################################
+
+## run a bootstrap
+
+if(do_bootstrap){
+  m1boot %<-% {
+    ds$m[1] %>% child(run_id = ""m1boot"", type = ""bootstrap"") %>%
+      cmd(""qpsn -c 5 -t 1000 -r 1000 -- bootstrap run{run_id}.mod -samples=50 -threads=25 -dir={run_dir}"") %>%
+      run_nm() %>%
+      wait_finish(timeout = 120*60) ## 2 hour
+  }
+
+  status_table(m1boot)
+}
+
+
+##########################################################
+
+
+#system(""ls Models/psn-* | xargs grep -l -E '(Not restarting this model)|(Fatal error)|(No nonmem execution)'"",
+#       intern = TRUE)
+

---FILE: inst/extdata/examples/testthat/Scripts/nm.log2.Rmd---
@@ -0,0 +1,152 @@
+---
+title: ""NONMEM/PsN/qpsn/R testing""
+output:
+  pdf_document: default
+  html_notebook: default
+---
+
+```{r setup, include=F}
+## DO NOT MODIFY THIS BLOCK (unless you know what you're doing)
+library(rprojroot)
+library(knitr)
+opts_chunk$set(echo=F)
+opts_knit$set(root.dir=find_root(has_file("".Rprofile"")))
+opts_chunk$set(echo = TRUE)
+```
+
+```{r echo=FALSE,message=FALSE}
+library(future)
+future::plan(""future::multiprocess"", workers = 2)
+library(NMprojectAZ)
+library(dplyr)
+devtools::load_all(""~/NMproject/"")
+load_localpackage()
+module_cmd(""module load psn/4.4.8-foss-2017a-gfortran-5.2-b1"")
+```
+
+
+## First set of 6 runs
+
+These are all single core
+
+```{r}
+ds <- tibble(run_id = 1:6)  ## runs 1 to 6 to be run single core
+
+ds$m <- nm2(run_id = ds$run_id) %>%
+  ctl(""staging/Models/run{run_id}.mod"") %>%
+  cmd(""qpsn -t 100 -r 1000 -- execute run{run_id}.mod -dir={run_dir}"")
+
+#nm_tran(ds$m)
+
+# ds$m <- ds$m %>% run_nm()
+# ds$m <- ds$m %>% update_parameters()
+# ds$m <- ds$m %>% run_nm()
+
+ds %<-% {
+  ds %>% mutate(m = m %>% run_nm() %>%
+                  update_parameters() %>%
+                  run_nm() %>%
+                  wait_finish(timeout = 20*60)) ## wait max of 20 mins
+}
+
+summary(ds$m) %>% 
+  select(run_id, status, ofv:cond_num)
+
+## gof plot of first run
+pl <- ds$m[1] %>% gof_ggplot2()
+pl
+
+pl2 <- plot_job_run_times_nm(ds$m)
+pl2[[6]]
+
+ds$m[1] <- ds$m[1] %>% 
+  nmsave_plot(pl, plot_name = ""gof_{run_id}.pdf"") %>%
+  nmsave_plot(pl, plot_name = ""gof_{run_id}.png"")
+
+ds$m <- ds$m %>% 
+  nmsave_plot(pl2[[6]], plot_name = ""run_times_1:6.png"")
+
+```
+
+## repeat run6 100s of times
+
+```{r}
+
+d6 <- tibble(rep = 1:100) ## 500
+d6$run_id <- paste0(""6_"", d6$rep)
+
+d6$m <- ds$m[6] %>% child(run_id = d6$run_id) %>%
+  run_in(""Models/reptest"") %>%
+  cmd(""qpsn -c auto -t 3000 -r 1000 -- execute run{run_id}.mod -dir={run_dir}"")
+
+#nm_tran(d6$m[1:2])
+
+d6 %<-% {
+  d6 %>% mutate(m = m %>% run_nm() %>%
+                    wait_finish(timeout = 120*60)) ## 120 mins
+}
+
+####### summary test
+
+s6 <- summary(d6$m) 
+
+status_table(d6$m)
+
+s6 %>% select(run_id, status, ofv:cond_num) %>% head(10)
+
+p62 <- plot_job_run_times_nm(d6$m)
+p62[[6]]
+
+d6$m %>%
+  nmsave_table(status_table(d6$m), ""d6_run_status.csv"") %>%
+  nmsave_plot(p62[[6]], ""d6_run_times.png"")
+
+```
+
+## repeat run6 with different numbers of cores
+
+```{r}
+
+dc %<-% {
+  tibble(cores = 1:36) %>%
+    mutate(m = ds$m[6] %>% child(run_id = cores) %>%
+             cmd(""qpsn -c {run_id} -t 1000 -r 1000 -- execute run{run_id}.mod -dir={run_dir}"") %>%
+             run_in(""Models/coretest"") %>%
+             run_nm() %>%
+             wait_finish(timeout = 60*60)) ## 1 hour
+}
+
+sc <- summary(dc$m) 
+
+status_table(dc$m)
+
+sc %>% select(run_id, status, ofv:cond_num) %>% head(5)
+
+pl <- plot_job_run_times(jobs = job_info(dc$m),
+                         run_in = run_in(dc$m))
+## print pl[[6]]
+
+dc$m %>%
+  nmsave_table(status_table(dc$m), ""dc_run_status.csv"") %>%
+  nmsave_plot(pl[[6]], ""dc_run_times.png"")
+
+pl[[6]]
+
+```
+
+## run a bootstrap
+
+```{r}
+m1boot %<-% {
+  ds$m[1] %>% child(run_id = ""m1boot"", type = ""bootstrap"") %>%
+  cmd(""qpsn -c 5 -t 1000 -r 1000 -- bootstrap run{run_id}.mod -samples=100 -threads=20 -dir={run_dir}"") %>%
+  run_nm() %>%
+  wait_finish()
+}
+
+status_table(m1boot)
+
+```
+
+
+

---FILE: inst/extdata/examples/testthat/Scripts/package_count.R---
@@ -0,0 +1,44 @@
+script_dirs1 <- tidyproject::ls_script_dirs(""/projects/qcp/QCP_MODELING/"", depth = 3)
+script_dirs2 <- tidyproject::ls_script_dirs(""/projects/qcp/QCP_MODELING/"", depth = 4)
+
+script_dirs <- c(script_dirs1, script_dirs2)
+
+scripts <- tidyproject::ls_scripts(script_dirs)
+
+try_readLines <- function(...){
+  text <- try(readLines(...), silent = TRUE)
+  if(inherits(text, ""try-error"")) return(character())
+  text
+}
+
+text <- suppressWarnings(parallel::mclapply(scripts, try_readLines, mc.cores = 10))
+
+pkgs <- parallel::mclapply(text, function(text){
+  #lapply(text, function(text){
+  text <- try(parse(text = text), silent = TRUE)
+  if(inherits(text, ""try-error"")) return(NA)
+  ans <- unique(unlist(lapply(text, tidyproject:::recursive_lib_find)))
+  ans
+#})
+}, mc.cores = 10)
+
+
+pkgs_with_dep <- parallel::mclapply(text, function(text){
+  #lapply(text, function(text){
+  text <- try(parse(text = text), silent = TRUE)
+  if(inherits(text, ""try-error"")) return(NA)
+  ans <- unique(unlist(lapply(text, tidyproject:::recursive_lib_find)))
+  c(ans, gtools::getDependencies(ans))
+#})
+}, mc.cores = 10)
+
+tab <- table(unlist(pkgs))
+tab <- sort(tab, decreasing = TRUE)
+d <- dplyr::tibble(name = names(tab), count = tab)
+write.csv(d, file = ""~/QCP_MODELLING_package_use.csv"", quote = FALSE, row.names = FALSE)
+
+tab <- table(unlist(pkgs_with_dep))
+tab <- sort(tab, decreasing = TRUE)
+d <- dplyr::tibble(name = names(tab), count = tab)
+write.csv(d, file = ""~/QCP_MODELLING_package_use_with_dep.csv"", quote = FALSE, row.names = FALSE)
+

---FILE: inst/extdata/examples/testthat/Scripts/theopp-demo.R---
@@ -0,0 +1,45 @@
+## Description: Example log of NONMEM runs
+## Run interactively: TRUE
+## Key words: script, template
+
+########################################
+## load packages and source functions here
+
+library(NMproject)
+source(""Scripts/gof_xpose.R"")
+
+########################################
+## main script here
+
+interactive_mode(TRUE)
+
+## Initial model
+m1 <- nm(""execute run1.mod -dir=1 -nmfe_options='-prdefault'"")
+## NOTE: run NMTRAN only with nm_tran(m1)
+run(m1)
+## NOTE: track run with shiny_nm()
+gof_xpose(m1)
+
+## Same model for demo purposes
+## NOTE: create new control with copy_control(""run1.mod"",""run2.mod"")
+m2 <- nm(""execute run2.mod -dir=2 -nmfe_options='-prdefault'"")
+run(m2)
+gof_xpose(m2)
+
+## Bootstrap
+m1boot <- nm(""bootstrap run1.mod -samples=10 -dir=1boot -nmfe_options='-prdefault'"")
+run(m1boot)
+
+## VPC
+m1vpc <- nm(""vpc run1.mod -samples=50 -dir=1vpc -nmfe_options='-prdefault'"")
+run(m1vpc)
+
+## SSE
+m1sse <- nm(""sse run1.mod -samples=5 -dir=1sse -nmfe_options='-prdefault'"")
+run(m1sse)
+
+## SCM
+m1scm <- nm(""scm run1.mod -config_file=run1.scm -dir=1scm -nmfe_options='-prdefault'"")
+run(m1scm)
+
+

---FILE: inst/extdata/examples/testthat/localpackage/R/gof_ggplot.R---
@@ -0,0 +1,59 @@
+## Description: Function template: ggplot GOF
+## Instructions: source() this file, then run.
+## Author: 
+## Depends on: 
+## Key words: function, template
+
+gof_ggplot <- function(r){
+  
+  ## assumes existance of ""plots"" directory in main working directory (plots.dir)
+  
+  ## assumes the existance of an sdtab $TABLE file e.g.
+  ##   $TABLE ID TIME IPRED IWRES IRES CWRES NPDE
+  ##   FILE=sdtab[run.no] NOPRINT ONEHEADER FORMAT=tF13.4
+  
+  #if(NMproject::is_finished(r)) stop(""run not yet finished"")
+  d <- NMproject::output_table(r)
+  
+  library(ggplot2)
+  
+  pl <- list()
+  p <- ggplot(d,aes_string(x=""PRED"",y=""DV"")) + theme_bw() +
+    geom_abline(slope=1)+
+    geom_point()
+  pl[[length(pl)+1]] <- p
+  pl[[length(pl)+1]] <- p + scale_x_log10() + scale_y_log10()
+  
+  p <- ggplot(d,aes_string(x=""IPRED"",y=""DV"")) + theme_bw() +
+    geom_abline(slope=1)+
+    geom_point()
+  pl[[length(pl)+1]] <- p
+  pl[[length(pl)+1]] <- p + scale_x_log10() + scale_y_log10()
+  
+  maxCWRES <- max(abs(d$CWRES),na.rm=TRUE)
+  p <- ggplot(d,aes_string(x=""PRED"",y=""CWRES"")) + theme_bw() +
+    geom_hline(yintercept=0)+
+    geom_point() + scale_y_continuous(limits=c(-1.05*maxCWRES,1.05*maxCWRES))
+  pl[[length(pl)+1]] <- p
+  
+  p <- ggplot(d,aes_string(x=""TIME"",y=""CWRES"")) + theme_bw() +
+    geom_hline(yintercept=0)+
+    geom_point() + scale_y_continuous(limits=c(-1.05*maxCWRES,1.05*maxCWRES))
+  pl[[length(pl)+1]] <- p
+  
+  maxNPDE <- max(abs(d$NPDE),na.rm=TRUE)
+  p <- ggplot(d,aes_string(x=""PRED"",y=""NPDE"")) + theme_bw() +
+    geom_hline(yintercept=0)+
+    geom_point() + scale_y_continuous(limits=c(-1.05*maxNPDE,1.05*maxNPDE))
+  pl[[length(pl)+1]] <- p
+  
+  p <- ggplot(d,aes_string(x=""TIME"",y=""NPDE"")) + theme_bw() +
+    geom_hline(yintercept=0)+
+    geom_point() + scale_y_continuous(limits=c(-1.05*maxNPDE,1.05*maxNPDE))
+  pl[[length(pl)+1]] <- p
+  
+  pdf(file.path(""Results"",paste(""gof.ggplot.run."",r$run_id,"".pdf"",sep="""")))
+  print(pl)
+  dev.off()
+  
+}

---FILE: inst/extdata/examples/testthat/localpackage/R/gof_ggplot2.R---
@@ -0,0 +1,75 @@
+## Copied from staging/localpackage/R/gof_ggplot2.R
+##  (2019-12-30 21:25:28) by klgk669
+## Author: klgk669
+## First created: 2019-12-28
+## Description: 
+## Keywords: 
+
+########################################
+## load packages and source functions here
+
+library(NMproject)
+
+########################################
+## main script here
+
+##' @export
+gof_ggplot2 <- Vectorize_nm_list(function(m){
+  wait_finish(m)
+  # d <- output_table(m) ## read in combined output 
+  
+  ###############
+  ## include plotting code here
+  
+  ## assumes existance of ""plots"" directory in main working directory (plots.dir)
+  
+  ## assumes the existance of an sdtab $TABLE file e.g.
+  ##   $TABLE ID TIME IPRED IWRES IRES CWRES NPDE
+  ##   FILE=sdtab[run.no] NOPRINT ONEHEADER FORMAT=tF13.4
+  
+  d <- NMproject::output_table(m)
+  
+  library(ggplot2)
+  
+  pl <- list()
+  p <- ggplot(d,aes_string(x=""PRED"",y=""DV"")) + theme_bw() +
+    geom_abline(slope=1)+
+    geom_point()
+  pl[[length(pl)+1]] <- p
+  pl[[length(pl)+1]] <- p + scale_x_log10() + scale_y_log10()
+  
+  p <- ggplot(d,aes_string(x=""IPRED"",y=""DV"")) + theme_bw() +
+    geom_abline(slope=1)+
+    geom_point()
+  pl[[length(pl)+1]] <- p
+  pl[[length(pl)+1]] <- p + scale_x_log10() + scale_y_log10()
+  
+  maxCWRES <- max(abs(d$CWRES),na.rm=TRUE)
+  p <- ggplot(d,aes_string(x=""PRED"",y=""CWRES"")) + theme_bw() +
+    geom_hline(yintercept=0)+
+    geom_point() + scale_y_continuous(limits=c(-1.05*maxCWRES,1.05*maxCWRES))
+  pl[[length(pl)+1]] <- p
+  
+  p <- ggplot(d,aes_string(x=""TIME"",y=""CWRES"")) + theme_bw() +
+    geom_hline(yintercept=0)+
+    geom_point() + scale_y_continuous(limits=c(-1.05*maxCWRES,1.05*maxCWRES))
+  pl[[length(pl)+1]] <- p
+  
+  maxNPDE <- max(abs(d$NPDE),na.rm=TRUE)
+  p <- ggplot(d,aes_string(x=""PRED"",y=""NPDE"")) + theme_bw() +
+    geom_hline(yintercept=0)+
+    geom_point() + scale_y_continuous(limits=c(-1.05*maxNPDE,1.05*maxNPDE))
+  pl[[length(pl)+1]] <- p
+  
+  p <- ggplot(d,aes_string(x=""TIME"",y=""NPDE"")) + theme_bw() +
+    geom_hline(yintercept=0)+
+    geom_point() + scale_y_continuous(limits=c(-1.05*maxNPDE,1.05*maxNPDE))
+  pl[[length(pl)+1]] <- p
+  
+  plg <- gridExtra::marrangeGrob(pl[-c(2,4)], ncol = 2, nrow = 3)
+  
+  ###############
+  ## return plotting object here
+  return(plg)
+  
+}, SIMPLIFY = FALSE)

---FILE: inst/extdata/examples/testthat/localpackage/R/gof_xpose.R---
@@ -0,0 +1,41 @@
+## Description: Function template: Xpose GOF
+## Instructions: source() this file, then run.
+## Run interactively: FALSE
+## Key words: function, template
+## E.g. for sdtab37, run with gof1(37)
+
+gof_xpose <- function(r,...){
+  
+  do <- output_table(r)
+  
+  run.no <- r$run_id
+  directory <- r$run_in
+  
+  ## assumes existance of ""plots"" directory in main working directory (plots.dir)
+  
+  ## assumes the existance of an sdtab $TABLE file e.g.
+  ##   $TABLE ID TIME IPRED IWRES IRES CWRES NPDE
+  ##   FILE=sdtab[run.no] NOPRINT ONEHEADER FORMAT=tF13.4
+  
+  library(xpose4)
+  
+  xpdb <- xpose.data(run.no,directory=paste0(directory,""/""),...)
+  
+  ### Make any changes to xpdb, e.g. to change the independent variable
+  ## change.xvardef(xpdb,var=""idv"") <- ""TRLD""
+  
+  pdf(file.path(""Results"",paste(""gof.xpose.run."",run.no,"".xpose.basic.pdf"",sep="""")))
+  
+  ## Delete/Modify the following as needed
+  print(dv.vs.pred(xpdb,smooth=NULL,type=""p"",main=NULL, logy=F,logx=F,
+                   ylb=""Plasma concentration (units)""))
+  print(dv.vs.ipred(xpdb,smooth=NULL,type=""p"",main=NULL, logy=F,logx=F,
+                    ylb=""Plasma concentration (units)""))
+  print(cwres.vs.pred(xpdb,smooth=NULL,type=""p"",main=NULL))
+  print(cwres.vs.idv(xpdb,smooth=NULL,type=""p"",main=NULL,xlb=""Time (units)""))
+  print(ind.plots(xpdb,layout=c(2,2),ylb=""Plasma concentration (units)"",
+                  xlb=""Time (units)""))
+  
+  dev.off()
+  
+}

---FILE: man/data_filter_char.Rd---
@@ -4,10 +4,12 @@
 \alias{data_filter_char}
 \title{Get filter statement}
 \usage{
-data_filter_char(r)
+data_filter_char(r, ...)
 }
 \arguments{
 \item{r}{object coercible into ctl_list}
+
+\item{...}{arguments passed to data_ignore_char}
 }
 \description{
 Opposite of data_ignore_char

---FILE: man/data_ignore_char.Rd---
@@ -4,10 +4,12 @@
 \alias{data_ignore_char}
 \title{Get ignore statement}
 \usage{
-data_ignore_char(r)
+data_ignore_char(r, data)
 }
 \arguments{
 \item{r}{object coercible into ctl_list}
+
+\item{data}{data.frame (default = missing) optional input dataset from r}
 }
 \description{
 Get ignore statement

---FILE: man/input_data.Rd---
@@ -0,0 +1,20 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/NMprojectExtra.R
+\name{input_data}
+\alias{input_data}
+\title{Read in input dataset}
+\usage{
+input_data(m, filter = FALSE, na = ""."", ...)
+}
+\arguments{
+\item{m}{nm object}
+
+\item{filter}{logical (default = FALSE). should NONMEM ignore statement be applied}
+
+\item{na}{character. passed to read.csv}
+
+\item{...}{additional arguments passed to either read_derived_data or read.csv}
+}
+\description{
+Read in input dataset
+}

---FILE: man/read_derived_data.Rd---
@@ -4,13 +4,15 @@
 \alias{read_derived_data}
 \title{Read derived data}
 \usage{
-read_derived_data(name, na = ""."", ...)
+read_derived_data(name, na = ""."", silent = FALSE, ...)
 }
 \arguments{
 \item{name}{name of file (without extension)}
 
 \item{na}{character to be passed to read.csv}
 
+\item{silent}{logical (default = TRUE). should messages be suppressed}
+
 \item{...}{additional arguments to be passed to read.csv}
 }
 \description{"
tsahota,NMproject,4eb815134ecdc90dea47fbb97ded493d11533d44,kpfn434,kpfn434@rstudio-ha01.scp.astrazeneca.net,2020-04-10T12:07:50Z,kpfn434,kpfn434@rstudio-ha01.scp.astrazeneca.net,2020-04-10T12:08:43Z,split cov_forest_data and cov_forest_plot and bug fix,NAMESPACE;R/nm.R;man/cov_forest_data.Rd;man/cov_forest_plot.Rd,False,True,True,False,42,19,61,"---FILE: NAMESPACE---
@@ -60,6 +60,7 @@ export(coef)
 export(commit_file)
 export(cond_num)
 export(copy_control)
+export(cov_forest_data)
 export(cov_forest_plot)
 export(ctl)
 export(ctl_character)

---FILE: R/nm.R---
@@ -1652,11 +1652,12 @@ exclude_rows <- function(d, dexcl, exclude_col = ""EXCL""){
   d
 }
 
-#' produce covariate forest plots
+#' produce dataset for covariate forest plotting
 #'
 #' @param m nm object
+#' @param id_col character (default = ""ID""). name of column
 #' @export
-cov_forest_plot <- function(m){
+cov_forest_data <- function(m, id_col = ""ID""){
   if(!is_finished(m)) stop(""run not finished yet"")#wait_for_finish(m)
   # d <- nm_output(m) ## read in combined output 
   
@@ -1673,15 +1674,15 @@ cov_forest_plot <- function(m){
   dpar$lower <- dpar$FINAL - 1.96*dpar$SE
   dpar$upper <- dpar$FINAL + 1.96*dpar$SE
   
-  PK_text <- ctl(m)$PK
+  PK_text <- ctl_list(m)$PK
   PK_text_R <- nonmem_code_to_r(PK_text)
-  
+
   par_covs <- PK_text[grepl("";;; .*-DEFINITION START"", PK_text)]
   par_covs <- gsub("";;; (.*)-.*"", ""\\1"", par_covs)
   
   pars <- PK_text[grepl("";;; .*-RELATION START"", PK_text)]
   pars <- gsub("";;; (.*)-.*"", ""\\1"", pars)
-  
+
   dd <- get_data(m, filter = TRUE)
   
   ## to be used later in evaluation of R expressions  
@@ -1709,18 +1710,18 @@ cov_forest_plot <- function(m){
     theta_lines <- c(theta_lines, par_cov)
     exprs <- parse(text = theta_lines)
     
+    #if(""ID"" %in% names(dd)) {
+      dd <- dd[!duplicated(dd[[id_col]]), ]
+    #}
+    
     cov_col <- dd[[cov]]
-    cov_col <- stats::na.omit(cov_col)
+    cov_col[is.na(cov_col)] <- 0 #stats::na.omit(cov_col)
     
     categorical <- TRUE
     if(length(unique(dd[[cov]])) > 10) categorical <- FALSE  ## too many levels = FALSE
     
     if(!all(stats::na.omit(floor(dd[[cov]]) == dd[[cov]]))) categorical <- FALSE  ## not round = FALSE
     
-    if(""ID"" %in% names(dd)) {
-      dd <- dd[!duplicated(dd$ID), ]
-    }
-    
     if(categorical) {
       levs <- unique(cov_col) 
       lev_text <- paste0(cov,""_"",levs)
@@ -1767,7 +1768,16 @@ cov_forest_plot <- function(m){
   })
   
   d <- dplyr::bind_rows(d)
-  
+  d
+
+}
+
+#' plotting covariate forest plots
+#'
+#' @param d data.frame from cov_forest_data
+#' @export
+
+cov_forest_plot <- function(d){
   ggplot2::ggplot(d, ggplot2::aes_string(x = ""mid"", y = ""lev_text"")) + ggplot2::theme_bw() +
     ggplot2::geom_rect(ggplot2::aes(ymin = -Inf, ymax = Inf, xmin = 1-0.2, xmax = 1+0.2), colour = ""grey90"") +
     ggplot2::geom_point() +
@@ -1776,8 +1786,4 @@ cov_forest_plot <- function(m){
     ggplot2::facet_grid(par~., scales = ""free_y"", space = ""free"") +
     ggplot2::scale_y_discrete("""") +
     ggplot2::scale_x_continuous(""effect size"", breaks = seq(floor(min(d$low)), ceiling(max(d$upp)), 0.1))
-  
-  ###############
-  ## return plotting object here
-  
 }

---FILE: man/cov_forest_data.Rd---
@@ -0,0 +1,16 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/nm.R
+\name{cov_forest_data}
+\alias{cov_forest_data}
+\title{produce dataset for covariate forest plotting}
+\usage{
+cov_forest_data(m, id_col = ""ID"")
+}
+\arguments{
+\item{m}{nm object}
+
+\item{id_col}{character (default = ""ID""). name of column}
+}
+\description{
+produce dataset for covariate forest plotting
+}

---FILE: man/cov_forest_plot.Rd---
@@ -2,13 +2,13 @@
 % Please edit documentation in R/nm.R
 \name{cov_forest_plot}
 \alias{cov_forest_plot}
-\title{produce covariate forest plots}
+\title{plotting covariate forest plots}
 \usage{
-cov_forest_plot(m)
+cov_forest_plot(d)
 }
 \arguments{
-\item{m}{nm object}
+\item{d}{data.frame from cov_forest_data}
 }
 \description{
-produce covariate forest plots
+plotting covariate forest plots
 }"
tsahota,NMproject,c2d86a0bbcf4ae9779d3b996bfe0f41a9c74188d,klgk669,klgk669@rstudio-ha00.scp.astrazeneca.net,2020-04-10T10:25:49Z,klgk669,klgk669@rstudio-ha00.scp.astrazeneca.net,2020-04-10T10:25:49Z,bug fix,R/NMprojectExtra.R,False,True,True,False,4,2,6,"---FILE: R/NMprojectExtra.R---
@@ -3579,8 +3579,10 @@ parent_run.nm_generic <- function(m, n = 1L){
     run_in(parent_run_in(m)) %>% 
     version(""[0-9]+"")
 
-  pattern <- unique_id(hack_m)
-  pattern <- paste0(gsub(.Platform$file.sep, "";-;"", pattern), ""\\.md5"")
+  pattern <- hack_m %>%
+    unique_run_cache_path() %>%
+    basename()
+  pattern <- paste0(""^"",pattern,""$"")
   
   ## sort by most recent
 "
tsahota,NMproject,7669081a1d516c5a30deeab8eaef9a54bc613137,klgk669,klgk669@rstudio-ha01.scp.astrazeneca.net,2020-04-10T08:13:46Z,klgk669,klgk669@rstudio-ha01.scp.astrazeneca.net,2020-04-10T08:13:46Z,dollar_data -> dollar_input name fix,DESCRIPTION;NAMESPACE;R/NMproject.R;R/NMprojectExtra.R;R/dollar_input.R;inst/extdata/CodeLibrary/R/dollar_input.R;man/update_dollar_input.Rd,False,True,True,False,7,8,15,"---FILE: DESCRIPTION---
@@ -43,7 +43,7 @@ Collate:
     'NMprojectExtra.R'
     'NMprojectExtraDB.R'
     'NMprojectExtraTest.R'
-    'dollar_data.R'
+    'dollar_input.R'
     'insert_addin.R'
     'load_sse.R'
     'manual_edit.R'

---FILE: NAMESPACE---
@@ -225,7 +225,6 @@ export(data_name)
 export(data_path)
 export(delete_dollar)
 export(dollar)
-export(dollar_data)
 export(environment_info)
 export(exclude_rows)
 export(executed)

---FILE: R/NMproject.R---
@@ -339,14 +339,14 @@ update_dollar_data <- function(ctl_name,new_data_name){
 #'
 #' Generic function
 #' @param ctl object coercible into ctl_lst
-#' @param ... arguments to be passed to dollar_data
+#' @param ... arguments to be passed to dollar_input
 #' @export
 
 update_dollar_input <- function(ctl, ...){
   if(is_single_na(ctl)) return(NA)
   ctl <- ctl_list(ctl)
   d <- suppressMessages(get_data(ctl))
-  replace_with <- suppressMessages(dollar_data(d, ...))
+  replace_with <- suppressMessages(dollar_input(d, ...))
   ctl$INPUT <- c(""$INPUT"", replace_with, """")
   ctl
 }

---FILE: R/NMprojectExtra.R---
@@ -806,7 +806,7 @@ fill_input <- function(m, ...){
 fill_input.nm_generic <- function(m, ...){
   ctl <- ctl(m)
   d <- suppressMessages(input_data(m))
-  replace_with <- c(""$INPUT"", suppressMessages(dollar_data(d, ...)))
+  replace_with <- c(""$INPUT"", suppressMessages(dollar_input(d, ...)))
   old_target <- m %>% target()
   m <- m %>% target(""INPUT"") %>% text(replace_with) %>%
     target(old_target)

---FILE: R/dollar_input.R---
@@ -1,5 +1,5 @@
 
-dollar_data <- function(d,keep,rename){
+dollar_input <- function(d,keep,rename){
   keep0 <- sapply(d,is_a_number)
   if(missing(keep)){
     message(""Excluding all non-numeric items"")

---FILE: inst/extdata/CodeLibrary/R/dollar_input.R---
@@ -3,7 +3,7 @@
 ## Run interactively: FALSE
 ## Key words: function
 
-dollar_data <- function(d,keep,rename){
+dollar_input <- function(d,keep,rename){
   keep0 <- sapply(d,class) %in% c(""integer"",""numeric"")
   if(missing(keep)){
     message(""Excluding all non-numeric items"")

---FILE: man/update_dollar_input.Rd---
@@ -9,7 +9,7 @@ update_dollar_input(ctl, ...)
 \arguments{
 \item{ctl}{object coercible into ctl_lst}
 
-\item{...}{arguments to be passed to dollar_data}
+\item{...}{arguments to be passed to dollar_input}
 }
 \description{
 Generic function"
tsahota,NMproject,799518e169004995db2dd50a9d07d22a8ce4d482,klgk669,klgk669@rstudio-ha00.scp.astrazeneca.net,2020-04-08T11:48:13Z,klgk669,klgk669@rstudio-ha00.scp.astrazeneca.net,2020-04-08T11:48:13Z,doc fix,NAMESPACE,False,False,False,False,1,0,1,"---FILE: NAMESPACE---
@@ -60,6 +60,7 @@ export(coef)
 export(commit_file)
 export(cond_num)
 export(copy_control)
+export(cov_forest_plot)
 export(ctl)
 export(ctl_character)
 export(ctl_fix_eta)"
tsahota,NMproject,58a1a688596a7ecdf19c859206c9e7c61e769b5c,klgk669,klgk669@rstudio-ha00.scp.astrazeneca.net,2020-04-06T13:10:37Z,klgk669,klgk669@rstudio-ha00.scp.astrazeneca.net,2020-04-06T13:10:37Z,bug fix nm_ouput for old interface,R/NMprojectExtra.R;R/nm.R,False,True,True,False,3,7,10,"---FILE: R/NMprojectExtra.R---
@@ -3406,10 +3406,7 @@ nm_output.nm_generic <- function(r,dorig,...){
   
   if(nrow(d) == 0){
     ctl_out_files <- ctl_table_paths(as_nm_generic(r))
-    #ctl_out_files <- ctl_table_files(as_nm_generic(r))
-    #ctl_out_files <- file.path(run_in(r), ctl_out_files)
-    #requireNamespace(""vpc"")
-    
+
     d <- lapply(ctl_out_files, function(out_file){
       d <- nm_read_table(out_file, skip = 1, header = TRUE)
     })

---FILE: R/nm.R---
@@ -452,9 +452,8 @@ nm_output.default <- function(r,dorig,...){
   d <- data.frame()
   
   if(nrow(d) == 0){
-    ctl_out_files <- r$output$ctl_out_files
-    ctl_out_files <- ctl_out_files[grepl(""tab"", ctl_out_files)]
-    
+    ctl_out_files <- file.path(run_in(r), ctl_table_files(r))
+    #ctl_out_files <- ctl_out_files[grepl(""tab"", ctl_out_files)]
     
     d <- lapply(ctl_out_files, function(out_file){
       d <- nm_read_table(out_file, skip = 1, header = TRUE)"
tsahota,NMproject,867bb32cb6c8edc4ecf954cf0c6d8ea521563be6,klgk669,klgk669@rstudio-ha00.scp.astrazeneca.net,2020-04-06T13:10:06Z,klgk669,klgk669@rstudio-ha00.scp.astrazeneca.net,2020-04-06T13:10:06Z,ignore bug fix when multiple statements on single line,R/nm.R,False,True,True,False,1,0,1,"---FILE: R/nm.R---
@@ -564,6 +564,7 @@ data_ignore_char.default <- function(r){
   dol_data <- ctl_list(r)$DATA
   dol_data <- dol_data[!dol_data %in% """"]
   dol_data <- rem_comment(dol_data)
+  dol_data <- unlist(strsplit(dol_data, split = ""\\s""))
   
   ignore_present <- any(grepl("".*IGNORE\\s*=\\s*\\("",dol_data))
   accept_present <- any(grepl("".*ACCEPT\\s*=\\s*\\("",dol_data))"
tsahota,NMproject,b8303c4f0ea65f3b876124de3d7b44d7e67ad16d,kpfn434,kpfn434@seskscpn084.prim.scp,2020-04-06T12:50:07Z,kpfn434,kpfn434@seskscpn084.prim.scp,2020-04-06T12:50:07Z,nm_output fix and ignore multi line fix,R/nm.R,False,True,True,False,3,2,5,"---FILE: R/nm.R---
@@ -1400,8 +1400,8 @@ nm_output <- function(r,dorig,...){
   d <- data.frame()
   
   if(nrow(d) == 0){
-    ctl_out_files <- r$output$ctl_out_files
-    ctl_out_files <- ctl_out_files[grepl(""tab"", ctl_out_files)]
+    ctl_out_files <- file.path(run_in(r), ctl_table_files(r))
+    #ctl_out_files <- ctl_out_files[grepl(""tab"", ctl_out_files)]
     
     
     d <- lapply(ctl_out_files, function(out_file){
@@ -1502,6 +1502,7 @@ data_ignore_char <- function(r){
   dol_data <- ctl_list(r)$DATA
   dol_data <- dol_data[!dol_data %in% """"]
   dol_data <- rem_comment(dol_data)
+  dol_data <- unlist(strsplit(dol_data, split = ""\\s""))
   
   ignore_present <- any(grepl("".*IGNORE\\s*=\\s*\\("",dol_data))
   accept_present <- any(grepl("".*ACCEPT\\s*=\\s*\\("",dol_data))"
tsahota,NMproject,54f03ea4f6fed79b96c513e9b886cf6f3b0f1df1,klgk669,klgk669@rstudio-ha01.scp.astrazeneca.net,2020-04-05T12:01:12Z,klgk669,klgk669@rstudio-ha01.scp.astrazeneca.net,2020-04-05T12:01:12Z,bug fix nm_output,R/nm.R,False,True,True,False,21,22,43,"---FILE: R/nm.R---
@@ -1393,17 +1393,19 @@ setup_nm_demo <- function(demo_name=""theopp"",
 #' @export
 nm_output <- function(r,dorig,...){
   
-  if(requireNamespace(""xpose4"")) {
-    xpdb <- xpose4::xpose.data(r$run_id,directory=paste0(r$run_in,""/""))
-    d <- xpdb@Data
-  } else d <- data.frame()
+  #if(requireNamespace(""xpose4"")) {
+  #  xpdb <- xpose4::xpose.data(run_id(r), directory=paste0(run_in(r),""/""))
+  #  d <- xpdb@Data
+  #} else 
+  d <- data.frame()
   
   if(nrow(d) == 0){
     ctl_out_files <- r$output$ctl_out_files
     ctl_out_files <- ctl_out_files[grepl(""tab"", ctl_out_files)]
     
+    
     d <- lapply(ctl_out_files, function(out_file){
-      d <- utils::read.table(out_file, skip = 1, header = TRUE)
+      d <- nm_read_table(out_file, skip = 1, header = TRUE)
     })
     
     d <- do.call(cbind,d)
@@ -1420,19 +1422,12 @@ nm_output <- function(r,dorig,...){
     dorig[is.na(dorig)] <- 0
     dORD <- which(with(dorig,eval(expre)))    
   }
-  #if(length(filter_statements) > 0){
-
-  #if(""IGNORE"" %in% type) dORD <- which(with(dorig,eval(expre)))
-  #if(""ACCEPT"" %in% type) dORD <- which(!with(dorig,eval(expre)))
   
   if(nrow(d) %% length(dORD) != 0) {
     stop(""something wrong... when R reads in original dataset
-and applies filter "",filter_statements,"",
-there's "",length(dORD),""rows, but NONMEM output has "", nrow(d), "" rows"")
+         and applies filter "",filter_statements,"",
+         there's "",length(dORD),""rows, but NONMEM output has "", nrow(d), "" rows"")
   }    
-  #} else {
-  #  dORD <- seq_len(nrow(dorig))
-  #}
   
   ctl_contents <- ctl_character(r)
   sim_ctl <- any(grepl(""^\\s*\\$SIM"",rem_comment(ctl_contents)))
@@ -1441,7 +1436,7 @@ there's "",length(dORD),""rows, but NONMEM output has "", nrow(d), "" rows"")
   
   if(""PRKEY"" %in% names(d)) stop(""name conflict with PRKEY in xpose table. aborting..."")
   if(""PRKEY"" %in% names(dorig)) stop(""name conflict with PRKEY in original data. aborting..."")
-
+  
   d$PRKEY <- dORD
   dorig$PRKEY <- 1:nrow(dorig)
   if(sim_ctl){
@@ -1450,27 +1445,31 @@ there's "",length(dORD),""rows, but NONMEM output has "", nrow(d), "" rows"")
     d$SIM <- rep(1:nreps,each=length(dORD))
     message(""Adding column: SIM"")
   }
-
+  
   d$INNONMEM <- TRUE
-
+  
   ## want a DV_OUT columsn
   if(""DV_OUT"" %in% names(d)) warning(""name conflict with DV_OUT in xpose table. replacing..."")
   d$DV_OUT <- d$DV
   d$DV <- NULL
   d <- d[,c(setdiff(names(d),names(dorig)[!names(dorig) %in% c(""PRKEY"")]))]
   #dorig <- dorig[,names(dorig)[!names(dorig) %in% c(""DV"")]]
-
+  
+  d$.tempORD <- 1:nrow(d) ## to preserve order
   d2 <- merge(dorig, d, all.x = TRUE, by = ""PRKEY"")
-
+  d2 <- d2[order(d2$.tempORD), ]
+  d2$.tempORD <- NULL
+  
   d2$INNONMEM <- d2$INNONMEM %in% TRUE
   if(nreps > 1) d2$SIM[is.na(d2$SIM)] <- 0
-
+  
   ## row number check
   if(nrow(d2) != nrow(d)*(nreps-1)/nreps + nrow(dorig)) stop(""merge went wrong. debug"")
-
+  
   message(""Adding column: PRKEY"")
-
+  
   return(d2)
+  
 }
 
 process_output <- function(r, ...){"
tsahota,NMproject,9bfd23300318440e501d341f020f6c139032d8fe,klgk669,klgk669@rstudio-ha01.scp.astrazeneca.net,2020-03-15T09:37:13Z,klgk669,klgk669@rstudio-ha01.scp.astrazeneca.net,2020-03-15T09:37:13Z,bug fix trans,R/NMprojectExtra.R,False,True,True,False,12,3,15,"---FILE: R/NMprojectExtra.R---
@@ -2195,10 +2195,19 @@ trans.nm_generic <- function(m, text){
   old_target <- target(m)
   m <- m %>% target(""SUB"") 
   
-  if(grepl(""TRANS"", text(m))){ ## TRANS already exists
+  if(any(grepl(""TRANS"", text(m)))){ ## TRANS already exists
     m <- m %>% gsub_ctl(""TRANS\\s?\\=?\\s?[0-9]+"", paste0(""TRANS"", text))
   } else { ## append
-    m <- m %>% text(paste(text(m), paste0(""TRANS"", text)))
+    
+    new_text <- text(m)
+    blanks <- grepl(""^\\s*$"", new_text)
+    
+    new_text[max(which(!blanks))] <- 
+      paste0(new_text[max(which(!blanks))], "" TRANS"", text)
+    
+    new_text <- gsub(""\\s+"", "" "", new_text)
+    
+    m <- m %>% text(new_text)
   }
   
   ## if not 
@@ -3966,7 +3975,7 @@ remove_cov.nm_list <- Vectorize_nm_list(remove_cov.nm_generic, SIMPLIFY = FALSE)
 
 #' @export
 cov_forest_plot <- function(m){
-  if(!is_finished(m)) wait_for_finished(m)
+  if(!is_finished(m)) wait_finish(m)
   # d <- nm_output(m) ## read in combined output 
   
   ## assume m is nm_list"
tsahota,NMproject,1052b3897b82dd6ad1a7d6533e95f83d61b20bd5,klgk669,klgk669@rstudio-ha01.scp.astrazeneca.net,2020-03-14T14:53:54Z,klgk669,klgk669@rstudio-ha01.scp.astrazeneca.net,2020-03-14T14:53:54Z,added patch functionality (unix),DESCRIPTION;NAMESPACE;R/NMprojectExtra.R;R/manual_edit.R;man/manual_edit.Rd,False,True,True,False,127,68,195,"---FILE: DESCRIPTION---
@@ -46,6 +46,7 @@ Collate:
     'dollar_data.R'
     'insert_addin.R'
     'load_sse.R'
+    'manual_edit.R'
     'nm_data.R'
     'plot_iter.R'
     'read.table.nm.R'

---FILE: NAMESPACE---
@@ -203,6 +203,7 @@ export(add_cov)
 export(add_mixed_param)
 export(advan)
 export(append_nonmem_var)
+export(apply_patch)
 export(as_nm_generic)
 export(as_nm_list)
 export(bind_covariate_results)
@@ -228,6 +229,7 @@ export(copy_control)
 export(cov_cov_plot)
 export(cov_forest_plot)
 export(covariates_define)
+export(create_patch)
 export(ctl)
 export(ctl_character)
 export(ctl_fix_eta)
@@ -368,6 +370,7 @@ export(update_ignore)
 export(update_parameters)
 export(update_sizes)
 export(version)
+export(view_patch)
 export(wait_default)
 export(wait_finish)
 export(wait_for_finished)

---FILE: R/NMprojectExtra.R---
@@ -620,29 +620,6 @@ delete_ctl.nm_generic <- function(m){
 }
 delete_ctl.nm_list <- Vectorize_nm_list(delete_ctl.nm_generic, SIMPLIFY = FALSE, invisible = TRUE)
 
-start_manual_edit <- function(m, name){
-  m %>% write_ctl()            ## update file
-  edit_file(ctl_path(m))
-  invisible(m)
-}
-
-#' Perform manual edit of control file
-#' 
-#' @param m nm object
-#' @param description character. Description of edit for documentation purposes
-#' @export
-manual_edit <- function(m, description){
-  m %>% start_manual_edit()
-  message(
-    ""---Manual edit---
-    Instructions:
-    1) edit control file
-    2) save & close
-    Press ENTER when done..."")
-  readline()
-  m %>% stop_manual_edit()
-}
-
 #' @include ctl_handling.R
 #' @export
 update_dollar.nm_generic <- function(ctl,..., which_dollar = 1, append = FALSE){
@@ -656,28 +633,6 @@ update_dollar.nm_generic <- function(ctl,..., which_dollar = 1, append = FALSE){
 #' @export
 update_dollar.nm_list <- Vectorize_nm_list(update_dollar.nm_generic, SIMPLIFY = FALSE)
 
-stop_manual_edit <- function(m){
-  old_m <- m
-  #old_target <- target(m)
-  m <- m %>% ctl(ctl_path(m), update_ctl = FALSE)  ## update object
-  
-  old_ctl <- as.character(ctl_character(ctl(as_nm_generic(old_m))))
-  new_ctl <- as.character(ctl_character(ctl(as_nm_generic(m))))
-  
-  if(requireNamespace(""diffobj"", quietly = TRUE)){
-    dff <- diffobj::diffChr(new_ctl, old_ctl, format = ""ansi256"")
-    #dff <- diffobj::diffChr(new_ctl, old_ctl, format = ""html"")
-    
-    ## TODO: store patch in object for later retrieval
-    ## learn how git2r calls libgit - maybe something useful there
-
-    message(""--- file diff: new_ctl and old_ctl colours show additions/deletions---"")
-    print(dff)
-    #m <- m %>% target(old_target)
-  }
-  
-  invisible(m)
-}
   
 #' Target part of control object for further modification
 #' 
@@ -1474,28 +1429,6 @@ run_nm.nm_generic <- function(r, overwrite=getOption(""run_overwrite""),delete_dir
     }
   }
   
-  # if(!force){
-  #   unique_md5_file <- unique_md5_file(r)
-  #   if(file.exists(unique_md5_file)){
-  #     ## assume file.exists
-  #     checksuminfo_disk <- readRDS(file = unique_md5_file)
-  #     
-  #     current_md5 <- execution_info(m)
-  #     matched_run <- identical(checksuminfo_disk$md5, current_md5)
-  #     
-  #     ## if any matches, this job has been run before
-  #     if(matched_run){
-  #       message(""ctl file, data and cmd unchanged from last run, skipping run... use force = TRUE to override"")
-  #       max_match <- max(which(matches))
-  #       r <- r %>% job_info(checksuminfo_disk[[max_match]]$job_info)
-  #       r <- r %>% version(max_match + 1)
-  #       return(invisible(r))  ## if up to date, skip
-  #     }
-  #   }    
-  # }
-
-  
-  
   ## TODO: kill exisitng run
   
   ## clean output files just in case
@@ -4572,6 +4505,8 @@ make_OCC_every_dose <- function(dose_trigger, sample_trigger){
 
 
 
+
+
 ###############
 
 ## mrgsolve method extension

---FILE: R/manual_edit.R---
@@ -0,0 +1,120 @@
+start_manual_edit <- function(m, name){
+  m %>% write_ctl()            ## update file
+  edit_file(ctl_path(m))
+  invisible(m)
+}
+
+#' Perform manual edit of control file
+#' 
+#' @param m nm object
+#' @param description character. Description of edit for documentation purposes
+#' @export
+manual_edit <- function(m, description){
+  m %>% start_manual_edit()
+  message(
+    ""---Manual edit---
+    Instructions:
+    1) edit control file
+    2) save & close
+    Press ENTER when done..."")
+  readline()
+  m %>% stop_manual_edit()
+}
+
+stop_manual_edit <- function(m){
+  old_m <- m
+  #old_target <- target(m)
+  m <- m %>% ctl(ctl_path(m), update_ctl = FALSE)  ## update object
+  
+  old_ctl <- as.character(ctl_character(ctl(as_nm_generic(old_m))))
+  new_ctl <- as.character(ctl_character(ctl(as_nm_generic(m))))
+  
+  if(requireNamespace(""diffobj"", quietly = TRUE)){
+    dff <- diffobj::diffChr(new_ctl, old_ctl, format = ""ansi256"")
+    #dff <- diffobj::diffChr(new_ctl, old_ctl, format = ""html"")
+    
+    ## TODO: store patch in object for later retrieval
+    ## learn how git2r calls libgit - maybe something useful there
+    
+    message(""--- file diff: new_ctl and old_ctl colours show additions/deletions---"")
+    print(dff)
+    #m <- m %>% target(old_target)
+  }
+  
+  invisible(m)
+}
+
+#' @export
+create_patch <- function(m){
+  
+  if(.Platform$OS.type != ""unix"") 
+    stop(""patching functionality only implemented for linux/unix systems\n consider manual_edit() instead"",
+         call. = FALSE)
+  
+  time_stamp <- format(Sys.time(), ""%Y-%m-%d-%H-%M-%S"")
+  
+  patch_name <- paste0(""patch-"", Sys.info()[""user""], ""-"", time_stamp)
+  patch_path <- file.path(getOption(""models.dir""), ""patches"", patch_name)
+  dir.create(dirname(patch_path), showWarnings = FALSE, recursive = TRUE)
+  
+  old_file_path <- file.path(run_in(m), paste0(ctl_name(m), "".old""))
+  
+  old_ctl_path <- ctl_path(m)
+  new_ctl_path <- file.path(run_in(m), paste0(""manual_"", ctl_name(m)))
+  
+  m %>% write_ctl()
+  mnew <- m %>% ctl_path(new_ctl_path) %>% write_ctl()
+  
+  edit_file(ctl_path(mnew)) ## edit new one
+  
+  message(
+    ""---Manual edit---
+    Instructions:
+    1) edit control file
+    2) save & close
+    Press ENTER when done..."")
+  readline()
+  
+  ## now diff ctl_path(m) and old_file_path
+  
+  diff_cmd <- paste(""diff -u"", ctl_path(m), new_ctl_path, "">"", patch_path)
+  
+  system(diff_cmd)
+  
+  unlink(new_ctl_path)
+  
+  message(""patch created:\n "", patch_path, ""\n"")
+  
+  message(""copy-paste the following into your script to apply:\n
+  [nm_object] %>%
+  apply_patch(\"""", patch_name,""\"")"")
+  
+}
+
+#' @export
+view_patch <- function(patch_name){
+  patch_path <- file.path(getOption(""models.dir""), ""patches"", patch_name)  
+  file.show(patch_path)
+}
+
+#' @export
+apply_patch <- function(m, patch_name){
+  
+  patch_path <- file.path(getOption(""models.dir""), ""patches"", patch_name)  
+  
+  write_ctl(m)
+  
+  ctl_paths <- ctl_path(m)
+  
+  patch_cmd <- paste(""patch -i"", patch_path, ctl_paths)
+  patch_cmd <- paste(patch_cmd, collapse = "" ; "")
+  
+  ## for some reason no ""patch"" on AZ rstudio server :(
+  ## use system_nm instead
+  system_nm(patch_cmd, dir = getwd())
+  
+  m <- m %>% ctl(ctl_path(m), update_ctl = FALSE)
+  
+  invisible(m)
+  
+}

---FILE: man/manual_edit.Rd---
@@ -1,5 +1,5 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/NMprojectExtra.R
+% Please edit documentation in R/manual_edit.R
 \name{manual_edit}
 \alias{manual_edit}
 \title{Perform manual edit of control file}"
tsahota,NMproject,cb13292543c6cf2ff90323a1790593fd55869a24,klgk669,klgk669@rstudio-ha00.scp.astrazeneca.net,2019-06-19T14:13:36Z,klgk669,klgk669@rstudio-ha00.scp.astrazeneca.net,2019-06-19T14:13:36Z,"coef, AIC, BIC changes and CRAN fix",NAMESPACE;R/ctl_handling.R;R/run_record.R;man/reexports.Rd,False,True,True,False,54,4,58,"---FILE: NAMESPACE---
@@ -1,7 +1,7 @@
 # Generated by roxygen2: do not edit by hand
 
-S3method(AIC,default)
 S3method(AIC,list)
+S3method(AIC,logical)
 S3method(AIC,nm)
 S3method(AIC,nmcoef)
 S3method(BIC,list)
@@ -11,6 +11,12 @@ S3method(cond_num,default)
 S3method(cond_num,list)
 S3method(cond_num,nm)
 S3method(cond_num,nmcoef)
+S3method(ctl_list,character)
+S3method(ctl_list,ctl_character)
+S3method(ctl_list,ctl_list)
+S3method(ctl_list,nmexecute)
+S3method(ctl_path,nm_generic)
+S3method(ctl_path,nm_list)
 S3method(data_name,default)
 S3method(nm_tran,default)
 S3method(nm_tran,nm)
@@ -48,6 +54,7 @@ export(change_seed)
 export(change_to_sim)
 export(check_session)
 export(clean_run)
+export(coef)
 export(commit_file)
 export(cond_num)
 export(copy_control)
@@ -137,4 +144,5 @@ export(write_ctl)
 export(write_derived_data)
 importFrom(stats,AIC)
 importFrom(stats,BIC)
+importFrom(stats,coef)
 importFrom(stats,nobs)

---FILE: R/ctl_handling.R---
@@ -81,7 +81,44 @@ print_ctl <- function(r) {
 #' @param r either class nmexecute, character, ctl_list, ctl_character
 #' @return object of class ctl_list
 #' @export
+
 ctl_list <- function(r){
+  UseMethod(""ctl_list"")
+}
+
+#' @export
+ctl_list.ctl_character <- function(r){
+    ctl <- ctl_nm2r(r)
+    attr(ctl, ""file_name"") <- attributes(r)$file_name
+    ctl
+}
+
+#' @export
+ctl_list.nmexecute <- function(r){
+  ctl <- ctl_character(r)
+  file_name <- attributes(ctl)$file_name
+  ctl <- ctl_nm2r(ctl)
+  attr(ctl, ""file_name"") <- file_name
+  return(ctl)  
+}
+
+#' @export
+ctl_list.ctl_list <- function(r){
+  r
+}
+
+#' @export
+ctl_list.character <- function(r){
+  if(length(r) == 1){
+    ctl <- ctl_character(r)
+    file_name <- attributes(ctl)$file_name
+    ctl <- ctl_nm2r(ctl)
+    attr(ctl, ""file_name"") <- file_name
+    return(ctl)
+  } else stop(""cannot coerce to ctl_list"")
+}
+
+ctl_list_old <- function(r){
   if(inherits(r, ""ctl_character"")) {
     ctl <- ctl_nm2r(r)
     attr(ctl, ""file_name"") <- attributes(r)$file_name

---FILE: R/run_record.R---
@@ -219,6 +219,10 @@ coef_nm <- function(object,trans,...){
   d
 }
 
+#' @importFrom stats coef
+#' @export
+stats::coef
+
 #' @export
 coef.nm <- function(object,...){
   
@@ -425,9 +429,8 @@ run_table <- function(db_name = ""runs.sqlite""){
 stats::AIC
 
 #' @export
-AIC.default <- function(object, ..., k = 2){
+AIC.logical <- function(object, ..., k = 2){
   if(is_single_na(object)) return(NA)
-  stats::AIC(object, ..., k = 2)
 }
 
 #' @export

---FILE: man/reexports.Rd---
@@ -3,6 +3,8 @@
 \docType{import}
 \name{reexports}
 \alias{reexports}
+\alias{coef}
+\alias{reexports}
 \alias{AIC}
 \alias{reexports}
 \alias{nobs}
@@ -15,6 +17,6 @@ These objects are imported from other packages. Follow the links
 below to see their documentation.
 
 \describe{
-  \item{stats}{\code{\link[stats]{AIC}}, \code{\link[stats]{nobs}}, \code{\link[stats]{BIC}}}
+  \item{stats}{\code{\link[stats]{coef}}, \code{\link[stats]{AIC}}, \code{\link[stats]{nobs}}, \code{\link[stats]{BIC}}}
 }}
 "
tsahota,NMproject,1e20b1a0e2c1d7c67253c19868813faf7be0baf5,klgk669,klgk669@rstudio-ha01.scp.astrazeneca.net,2019-05-31T14:01:26Z,klgk669,klgk669@rstudio-ha01.scp.astrazeneca.net,2019-05-31T14:01:26Z,bug fix,R/ctl_handling.R;R/nm.R;inst/extdata/TODO.R,False,True,True,False,12,11,23,"---FILE: R/ctl_handling.R---
@@ -5,10 +5,13 @@ rem_comment <- function(s,char="";"") gsub(paste0(""^([^"",char,""]*)"",char,""*.*$""),""
 get_comment <- function(s,char="";"") gsub(paste0(""^[^"",char,""]*"",char,""*(.*)$""),""\\1"",s)
 
 setup_dollar <- function(x,type){
-  if(grepl(""THETA|OMEGA|SIGMA|PK|PRED|ERROR|DES"", type)){
-    x <- c(type, x)
-  } else {
-    x[1] <- paste(type,x[1]) 
+  ## if $TYPE isn't in x, add it
+  if(!grepl(paste0(""\\s*\\"",type),x[1])){
+    if(grepl(""THETA|OMEGA|SIGMA|PK|PRED|ERROR|DES"", type)){
+      x <- c(type, x)
+    } else {
+      x[1] <- paste(type,x[1]) 
+    }
   }
   names(x) <- NULL
   class(x) <- paste0(""nm."",tolower(gsub(""^\\$"","""",type)))
@@ -970,6 +973,8 @@ write_ctl <- function(ctl, dest, dir = getOption(""models.dir"")){
     attr(ctl, ""file_name"") <- ctl_name
   }
   
+  if(!file.exists(dirname(ctl_name)))
+    dir.create(dirname(ctl_name), showWarnings = FALSE, recursive = TRUE)
   writeLines(ctl, ctl_name)
   suppressMessages(tidyproject::setup_file(ctl_name))
   message(""written: "", ctl_name)

---FILE: R/nm.R---
@@ -1573,8 +1573,8 @@ update_ignore <- function(ctl, ignore_char){
   if(ignore_present){
     ## remove any row that matches exactly
     ctl$DATA <- ctl$DATA[!grepl(""^(\\s*)IGNORE\\s*=\\s*\\(*\\S[^\\)]+\\)*(\\s*)$"",ctl$DATA)]
-    ## remove only IGNORE statement if other things are on the line.
-    ctl$DATA <- gsub(""(.*)IGNORE\\s*=\\s*\\(*\\S[^\\)]+\\)*(.*)"",
+    ## remove only bracketed IGNORE statement if other things are on the line.
+    ctl$DATA <- gsub(""(.*)IGNORE\\s*=\\s*\\(+\\S[^\\)]+\\)+(.*)"",
          ""\\1\\2"", ctl$DATA)
   }
   

---FILE: inst/extdata/TODO.R---
@@ -314,8 +314,6 @@ call_fun_on_nm_data_frame <- function(x, fun){
 ##    VPCs/outputs are dependent on run results.
 ##    Plan behaviour
 
-## TODO: create a project_library(TRUE/FALSE) flag option
-
 ## TODO: an easy way to copy-modify this code:
 ##  -- add ons
 
@@ -334,19 +332,17 @@ e14 <- nm(""e14"", type = ""execute"", based_on = ""ADVAN13.mod"") ## code library
 ##   e.g. dsc$ofv <- ofv(dsc$m)
 ##        run_nm(dsc$m, batches = 10)  ## works like run_batch_list
 
-## TODO: import_code()
+## TODO: import_code()  - (import instead of ""copy"")
 ##     Scripts  - import_script_file()
 ##       ""~/script.R"" - no change
 ##       ""../scripts.R"" - no change
 ##       ""script.R"" - [code_library]/Scripts/script.R
-##       ""script.R"" - [code_library]/Scripts/script.R
 ##       will add R comment to top
 
 ##     Models   - import_model_file()
 ##       ""~/runTTE.mod"" - no change
 ##       ""../runTTE.mod"" - no change
 ##       ""runTTE.mod"" - [code_library]/Models/script.R
-##       ""runTTE.mod"" - [code_library]/Models/script.R
 
 ##     Projects  - import_project
 ##       ""~/PROJ1"" - no change"
tsahota,NMproject,6603170db338d485d7f618c30efb649f41e66a5f,klgk669,klgk669@rstudio-ha00.scp.astrazeneca.net,2019-04-16T14:32:00Z,klgk669,klgk669@rstudio-ha00.scp.astrazeneca.net,2019-04-16T14:32:00Z,write_ctl bug fix. added model_file_name,NAMESPACE;R/ctl_handling.R;man/model_file_name.Rd,False,True,True,False,47,12,59,"---FILE: NAMESPACE---
@@ -46,6 +46,7 @@ export(job_info)
 export(load_sse)
 export(load_top_level_models)
 export(manual_edit)
+export(model_file_name)
 export(new_ctl)
 export(new_script)
 export(nm)

---FILE: R/ctl_handling.R---
@@ -913,25 +913,28 @@ ofv <- Vectorize_nm(ofv, vectorize.args = ""r"")
 #' @export
 
 write_ctl <- function(ctl, run_id, dir = getOption(""models.dir"")){
-
+  
   if(!any(c(""ctl_list"", ""ctl_character"", ""character"", ""nmexecute"") %in% class(ctl)))
     stop(""ctl needs to be class nmexecute, character, ctl_character, or ctl_list"")
-
-  if(missing(run_id)) run_id <- get_run_id(attributes(ctl)$file_name)
-
-  if(inherits(run_id, ""nmexecute"")) run_id <- run_id$run_id
-
+  
   ctl <- ctl_character(ctl)
-
-  ctl_name <- search_ctl_name(run_id, models_dir = dir)
-
-  attr(ctl, ""file_name"") <- ctl_name
-
+  ctl_name <- attr(ctl, ""file_name"")
+  
+  if(!missing(run_id)){
+    if(inherits(run_id, ""nmexecute"")) {
+      run_id <- run_id$run_id
+    } else {
+      file_name <- attributes(ctl)$file_name
+    }
+    ctl_name <- model_file_name(run_id, dir = dir)
+    attr(ctl, ""file_name"") <- ctl_name
+  }
+  
   writeLines(ctl, ctl_name)
   tidyproject::setup_file(ctl_name)
   message(""written: "", ctl_name)
   invisible(ctl)
-
+  
 }
 
 update_table_numbers <- function(ctl, run_id){
@@ -976,6 +979,19 @@ new_ctl <- function(r, run_id, based_on){
   ctl
 }
 
+#' Generate model file name
+#' 
+#' @param run_id run identifier
+#' @param dir directory to work in
+#' @param mustWork same as normalizePath argument
+#' 
+#' @export
+model_file_name <- function(run_id, dir = getOption(""models.dir""), mustWork = FALSE){
+  path <- file.path(dir, 
+                    paste0(getOption(""model_file_stub""),run_id,""."",getOption(""model_file_extn"")))
+  normalizePath(path, mustWork = mustWork)
+}
+
 
 #' make new control file based on previous
 #'

---FILE: man/model_file_name.Rd---
@@ -0,0 +1,18 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/ctl_handling.R
+\name{model_file_name}
+\alias{model_file_name}
+\title{Generate model file name}
+\usage{
+model_file_name(run_id, dir = getOption(""models.dir""), mustWork = FALSE)
+}
+\arguments{
+\item{run_id}{run identifier}
+
+\item{dir}{directory to work in}
+
+\item{mustWork}{same as normalizePath argument}
+}
+\description{
+Generate model file name
+}"
tsahota,NMproject,28c61b632af624ad0d385438f13b655d9365b6ca,klgk669,klgk669@rstudio-prod01.scp.astrazeneca.net,2019-03-14T10:26:21Z,klgk669,klgk669@rstudio-prod01.scp.astrazeneca.net,2019-03-14T10:26:21Z,bug fix,R/NMproject.R,False,True,True,False,3,2,5,"---FILE: R/NMproject.R---
@@ -545,13 +545,14 @@ write_derived_data <- function(d, name, ...){
 read_derived_data <- function(name, na = ""."", ...){
 
   ## TODO: expand to other types of argument
+  if(length(name) != 1) stop(""name should have length 1"", call. = FALSE)
 
   if(file.exists(name)){
-    if(grep(""\\.RData"", name)) {
+    if(grepl(""\\.RData"", name)) {
       message(""loading: "", name)
       load(file = name)
     }
-    if(grep(""\\.csv"", name)) {
+    if(grepl(""\\.csv"", name)) {
       message(""loading: "", name)
       d <- utils::read.csv(name, na = na, ...)
     }"
tsahota,NMproject,6103938bbf0c8ca8ddcb9667b8ae01b94191a0d7,klgk669,klgk669@rstudio-prod01.scp.astrazeneca.net,2019-02-14T14:38:51Z,klgk669,klgk669@rstudio-prod01.scp.astrazeneca.net,2019-02-14T14:39:31Z,vectorise and fix cond_num + run to use lists,R/nm.R;man/run.Rd,False,True,True,False,54,44,98,"---FILE: R/nm.R---
@@ -214,6 +214,40 @@ nm(\""bootstrap run1.mod -threads=4\"",psn_command=\""bootstrap\"")""
   return(r)
 }
 
+Vectorize_nm <- function (FUN, vectorize.args = arg.names, SIMPLIFY = TRUE, USE.NAMES = TRUE) 
+{
+  arg.names <- as.list(formals(FUN))
+  arg.names[[""...""]] <- NULL
+  arg.names <- names(arg.names)
+  vectorize.args <- as.character(vectorize.args)
+  if (!length(vectorize.args)) 
+    return(FUN)
+  if (!all(vectorize.args %in% arg.names)) 
+    stop(""must specify names of formal arguments for 'vectorize'"")
+  collisions <- arg.names %in% c(""FUN"", ""SIMPLIFY"", ""USE.NAMES"", 
+                                 ""vectorize.args"")
+  if (any(collisions)) 
+    stop(sQuote(""FUN""), "" may not have argument(s) named "", 
+         paste(sQuote(arg.names[collisions]), collapse = "", ""))
+  FUNV <- function() {
+    args <- lapply(as.list(match.call())[-1L], eval, parent.frame())
+    ###############################
+    ## MODIFIED CODE FOR NMPROJECT
+    args <- lapply(args, function(arg){
+      if(inherits(arg, ""nm"")) return(list(arg)) else return(arg)
+    })
+    ################################
+    names <- if (is.null(names(args))) 
+      character(length(args))
+    else names(args)
+    dovec <- names %in% vectorize.args
+    do.call(""mapply"", c(FUN = FUN, args[dovec], MoreArgs = list(args[!dovec]), 
+                        SIMPLIFY = SIMPLIFY, USE.NAMES = USE.NAMES))
+  }
+  formals(FUNV) <- formals(FUN)
+  FUNV
+}
+
 nmdb_match_entry <- function(r,db=NULL){
   match_info <- nmdb_match_info(r,db=db)
   if(r$type %in% ""execute"") {
@@ -304,6 +338,7 @@ get_char_field <- function(db_name=""runs.sqlite"",entry,field){
 #' @export
 job_info <- function(r){
   if(is.null(r$db_name)) return(NA)
+  if(""job_info"" %in% names(r)) return(r$job_info)
   matched_entry <- nmdb_match_entry(r)
   get_char_field(r$db_name,matched_entry,""job_info"")
 }
@@ -545,7 +580,7 @@ get_run_id <- function(ctl_name){
 
 
 #' Run NONMEM
-#' @param ... objects of class nm
+#' @param r objects of class nm/or list of objects class nm
 #' @param overwrite logical. Should run directory be overwritten (default=FALSE)
 #' @param delete_dir logical. NA (default - directory will be deleted if no dependencies exists)
 #' TRUE or FALSE. Should run_dir be deleted.
@@ -563,19 +598,20 @@ get_run_id <- function(ctl_name){
 #' Otherwise returns nothing.
 #'
 #' @export
-run <- function(...,overwrite=getOption(""run_overwrite""),delete_dir=c(NA,TRUE,FALSE),wait=getOption(""wait""),
+run <- function(r,overwrite=getOption(""run_overwrite""),delete_dir=c(NA,TRUE,FALSE),wait=getOption(""wait""),
                 update_db=TRUE,ignore.stdout = TRUE, ignore.stderr = TRUE,
                 initial_timeout=NA, quiet = getOption(""quiet_run""),intern=getOption(""intern"")){
   UseMethod(""run"")
 }
 
 #' @export
-run.nm <- function(...,overwrite=getOption(""run_overwrite""),delete_dir=c(NA,TRUE,FALSE),wait=getOption(""wait""),
+run.nm <- function(r,overwrite=getOption(""run_overwrite""),delete_dir=c(NA,TRUE,FALSE),wait=getOption(""wait""),
                    update_db=TRUE,ignore.stdout = TRUE, ignore.stderr = TRUE,
                    initial_timeout=NA, quiet = getOption(""quiet_run""),intern=getOption(""intern"")){
   tidyproject::check_if_tidyproject()
   #if(!quiet & !wait) stop(""quiet=FALSE requires wait=TRUE"")
-  rl <- list(...)
+  rl <- r
+  if(inherits(rl, ""nm"")) rl <- list(rl)
   #rl <- rl[sapply(rl, inherits, what = ""nm"")]
   rl <- rl[!sapply(rl, is.null)] ## remove nulls
   rl <- lapply(rl,function(r){
@@ -607,9 +643,12 @@ run.nm <- function(...,overwrite=getOption(""run_overwrite""),delete_dir=c(NA,TRUE
       update_char_field(r$db_name,matched_entry,job_info=job_info)
     }
     r$job_info <- job_info
+    r
   })
-  if(wait) wait_for_finished(...,initial_timeout=initial_timeout)
-  if(length(rl)==1) return(invisible(rl[[1]])) else return(invisible())
+  if(wait) wait_for_finished(rl,initial_timeout=initial_timeout)
+  #job_infos <- sapply(rl, function(r) r$job_info)
+  #return(invisible(job_infos))
+  if(length(rl)==1) return(invisible(rl[[1]])) else return(invisible(rl))
 }
 
 #' Run run.nm method
@@ -868,39 +907,7 @@ is_status_finished <- function(status_ob){
   finished
 }
 
-Vectorize_nm <- function (FUN, vectorize.args = arg.names, SIMPLIFY = TRUE, USE.NAMES = TRUE) 
-{
-  arg.names <- as.list(formals(FUN))
-  arg.names[[""...""]] <- NULL
-  arg.names <- names(arg.names)
-  vectorize.args <- as.character(vectorize.args)
-  if (!length(vectorize.args)) 
-    return(FUN)
-  if (!all(vectorize.args %in% arg.names)) 
-    stop(""must specify names of formal arguments for 'vectorize'"")
-  collisions <- arg.names %in% c(""FUN"", ""SIMPLIFY"", ""USE.NAMES"", 
-                                 ""vectorize.args"")
-  if (any(collisions)) 
-    stop(sQuote(""FUN""), "" may not have argument(s) named "", 
-         paste(sQuote(arg.names[collisions]), collapse = "", ""))
-  FUNV <- function() {
-    args <- lapply(as.list(match.call())[-1L], eval, parent.frame())
-    ###############################
-    ## MODIFIED CODE FOR NMPROJECT
-    args <- lapply(args, function(arg){
-      if(inherits(arg, ""nm"")) return(list(arg)) else return(arg)
-    })
-    ################################
-    names <- if (is.null(names(args))) 
-      character(length(args))
-    else names(args)
-    dovec <- names %in% vectorize.args
-    do.call(""mapply"", c(FUN = FUN, args[dovec], MoreArgs = list(args[!dovec]), 
-                        SIMPLIFY = SIMPLIFY, USE.NAMES = USE.NAMES))
-  }
-  formals(FUNV) <- formals(FUN)
-  FUNV
-}
+
 
 #' tests if job is finished
 #'
@@ -920,10 +927,13 @@ is_finished <- Vectorize_nm(is_finished, vectorize.args = ""r"")
 #' @export
 
 cond_num <- function(r){
-  if(is.null(r)) return(NA)
+  if(length(r) == 1){
+    if(is.na(r)) return(as.numeric(NA))
+    if(is.null(r)) return(as.numeric(NA))
+  }
   dc <- try(coef_nm(r, trans = FALSE), silent = TRUE)
-  if(inherits(dc, ""try-error"")) return(NA)
-  dc$FINAL[dc$Parameter %in% ""CONDNUM""]
+  if(inherits(dc, ""try-error"")) return(as.numeric(NA))
+  as.numeric(dc$FINAL[dc$Parameter %in% ""CONDNUM""])
 }
 cond_num <- Vectorize_nm(cond_num, vectorize.args = ""r"")
 

---FILE: man/run.Rd---
@@ -4,13 +4,13 @@
 \alias{run}
 \title{Run NONMEM}
 \usage{
-run(..., overwrite = getOption(""run_overwrite""), delete_dir = c(NA, TRUE,
+run(r, overwrite = getOption(""run_overwrite""), delete_dir = c(NA, TRUE,
   FALSE), wait = getOption(""wait""), update_db = TRUE,
   ignore.stdout = TRUE, ignore.stderr = TRUE, initial_timeout = NA,
   quiet = getOption(""quiet_run""), intern = getOption(""intern""))
 }
 \arguments{
-\item{...}{objects of class nm}
+\item{r}{objects of class nm/or list of objects class nm}
 
 \item{overwrite}{logical. Should run directory be overwritten (default=FALSE)}
 "
tsahota,NMproject,adbf0cb8a5260e34bd40344c793992112557a2e7,klgk669,klgk669@rstudio-prod01.scp.astrazeneca.net,2019-02-12T12:55:47Z,klgk669,klgk669@rstudio-prod01.scp.astrazeneca.net,2019-02-12T12:55:47Z,added collate to fix build error,DESCRIPTION,False,False,False,False,13,1,14,"---FILE: DESCRIPTION---
@@ -25,4 +25,16 @@ Suggests:
     testthat,
     ggplot2,
     xpose4
-    
+Collate: 
+    'NMproject.R'
+    'nm.R'
+    'ctl_handling.R'
+    'dollar_data.R'
+    'insert_addin.R'
+    'load_sse.R'
+    'plot_iter.R'
+    'read.table.nm.R'
+    'read_ext.R'
+    'run_record.R'
+    'status.R'
+    'zzz.R'"
tsahota,NMproject,cf95f7d70ab171ce9b1d70771af50d0d0cb5c516,klgk669,klgk669@rstudio-prod01.scp.astrazeneca.net,2018-10-25T20:01:38Z,klgk669,klgk669@rstudio-prod01.scp.astrazeneca.net,2018-10-25T20:01:38Z,bug fix,R/NMproject.R;inst/extdata/TODO.R,False,True,True,False,14,4,18,"---FILE: R/NMproject.R---
@@ -196,6 +196,7 @@ copy_control <- function(from,to,overwrite=FALSE,alt_paths,from_base=FALSE){
   writeLines(ctl,to)
   if(!requireNamespace(""git2r"", quietly = TRUE))
     warning(""git2r is recommended for this function. Please install it."")
+  git2r::repository
   tidyproject::setup_file(to)
 }
 
@@ -263,8 +264,10 @@ nm_tran.default <- function(x){
   data_path <- file.path(dirname(x),data_name(x))
   file.copy(data_path,tempdir0) ## copy dataset
   dataset.name <- basename(data_path)
-  update_dollar_data(file.path(tempdir0,basename(x)),dataset.name) %>% 
-    write_ctl(file.path(tempdir0,basename(x)))
+  suppressMessages({
+    update_dollar_data(file.path(tempdir0,basename(x)),dataset.name) %>% 
+      write_ctl(file.path(tempdir0,basename(x)))
+  })
   system_nm(paste(nm_tran_command,""<"",basename(x)),dir=tempdir0,wait=TRUE) ## run nmtran in tempdir0
 }
 

---FILE: inst/extdata/TODO.R---
@@ -24,15 +24,19 @@ future({ ## asynchronous events
 ##     - require_processed(r) - will process if needed
 
 ## TODO: register_output(r, ""Results/file.pdf"")
-##     - adds 
+##     - adds file to $output tracker
 
 ## TODO: new convention run_ids start with letter
 
 ## TODO: Better database access
+##       For read, use type, run_id, run_in
 
 ## TODO: Store SHA's to all inputs - check before running.
 ##   then eliminate interactive/non-interactive options
-## TODO: Principle: ctrl + alt + b functions like ""make"".
+## TODO: Principle: ctrl + alt + b/source works like ""make"".
+##    Need dependency graphs.
+##    VPCs/outputs are dependent on run results.
+##    Plan behaviour
 
 ## TODO: an easy way to copy-modify this code:
 ##  -- add ons
@@ -51,3 +55,6 @@ e14 <- nm(""e14"", type = ""execute"", based_on = ""ADVAN13.mod"") ## code library
 ## TODO: make functions work on lists of nm objects
 ##   e.g. dsc$ofv <- ofv(dsc$m)
 ##        run_nm(dsc$m, batches = 10)  ## works like run_batch_list
+
+## TODO: import_code()
+##       
\ No newline at end of file"
tsahota,NMproject,ef432fe4bdc0eb599c6ec5095cf62fc8fbd166f1,klgk669,klgk669@rstudio-prod01.scp.astrazeneca.net,2018-10-25T16:32:33Z,klgk669,klgk669@rstudio-prod01.scp.astrazeneca.net,2018-10-25T16:32:33Z,bug fix,R/NMproject.R,False,True,True,False,2,1,3,"---FILE: R/NMproject.R---
@@ -263,7 +263,8 @@ nm_tran.default <- function(x){
   data_path <- file.path(dirname(x),data_name(x))
   file.copy(data_path,tempdir0) ## copy dataset
   dataset.name <- basename(data_path)
-  update_dollar_data(file.path(tempdir0,basename(x)),dataset.name)
+  update_dollar_data(file.path(tempdir0,basename(x)),dataset.name) %>% 
+    write_ctl(file.path(tempdir0,basename(x)))
   system_nm(paste(nm_tran_command,""<"",basename(x)),dir=tempdir0,wait=TRUE) ## run nmtran in tempdir0
 }
 "
tsahota,NMproject,560d59859e2094bf9c27625cb6b8ff48af01f03b,klgk669,klgk669@rstudio-prod01.scp.astrazeneca.net,2018-10-18T16:42:45Z,klgk669,klgk669@rstudio-prod01.scp.astrazeneca.net,2018-10-18T16:42:45Z,bug fix in tests,tests/testthat/test-plot_iter.R,False,True,True,False,3,3,6,"---FILE: tests/testthat/test-plot_iter.R---
@@ -54,7 +54,7 @@ test_that(""db & plot_iter works"",{
   data_name <- get_data_name(m1)
   expect_true(file.exists(from_models(data_name)))
 
-  build_run({
+  build_ctl({
     suppressWarnings({
       ctl <- m1 %>% update_parameters() %>% new_ctl(""4"") %>% write_ctl %>%
         update_dollar_input(rename = c(""WT"" = ""BWT"")) %>%
@@ -75,7 +75,7 @@ test_that(""db & plot_iter works"",{
   expect_true(any(grep(""THEOPP"", as.character(ctl))))
 
 
-  build_run({
+  build_ctl({
     suppressWarnings({
       ctl <- m1 %>% update_parameters() %>% new_ctl(""4"") %>% write_ctl %>%
         update_dollar_input() %>%
@@ -91,7 +91,7 @@ test_that(""db & plot_iter works"",{
 
   expect_true(!any(grepl(""KWT-DEFINITION START"", ctl_character(ctl_orig))))
 
-  build_run({
+  build_ctl({
     ctl <- m1 %>% change_to_sim %>% change_seed(98765)
   })
 "
tsahota,NMproject,89aaae4dec577ce1e053f82aa882d17ee0271cfe,klgk669,klgk669@rstudio-prod01.scp.astrazeneca.net,2018-10-18T16:33:28Z,klgk669,klgk669@rstudio-prod01.scp.astrazeneca.net,2018-10-18T16:33:28Z,bug fix,R/ctl_handling.R,False,True,True,False,5,1,6,"---FILE: R/ctl_handling.R---
@@ -5,7 +5,11 @@ rem_comment <- function(s,char="";"") gsub(paste0(""^([^"",char,""]*)"",char,""*.*$""),""
 get_comment <- function(s,char="";"") gsub(paste0(""^[^"",char,""]*"",char,""*(.*)$""),""\\1"",s)
 
 setup_dollar <- function(x,type){
-  x[1] <- paste(type,x[1])
+  if(grepl(""THETA|OMEGA|SIGMA|PK|PRED|ERROR|DES"", type)){
+    x <- c(type, x)
+  } else {
+    x[1] <- paste(type,x[1]) 
+  }
   names(x) <- NULL
   class(x) <- paste0(""nm."",tolower(gsub(""^\\$"","""",type)))
   x"
tsahota,NMproject,f30a31bf9c2238c5a86b3b770a7c07a08e82eeee,klgk669,klgk669@rstudio-dev01.scp.astrazeneca.net,2018-09-14T17:28:45Z,klgk669,klgk669@rstudio-dev01.scp.astrazeneca.net,2018-09-14T17:28:45Z,CRAN check fix,NAMESPACE;R/load_sse.R;man/load_sse.Rd,False,True,True,False,24,5,29,"---FILE: NAMESPACE---
@@ -35,6 +35,7 @@ export(gsub_ctl)
 export(interactive_mode)
 export(is_finished)
 export(job_info)
+export(load_sse)
 export(load_top_level_models)
 export(manual_edit)
 export(new_ctl)

---FILE: R/load_sse.R---
@@ -1,6 +1,6 @@
 #' Load SSE data
 #'
-#' Function to load simulation data from PsN SSE
+#' Experimental function to load simulation data from PsN SSE
 #' This facilitates extracting data needed for postprocessing of simulations
 #' poptentially helpfor after simulation with uncertainty (e.g. obtained through PsN bootstrap or impance sampling)
 #'
@@ -12,8 +12,6 @@
 load_sse <- function(x, parr=F, nodes=1) {
 # Load SSE data -----------------------------------------------------------
 ## create list of paths for the tables
-  if(!requirenamespace(""data.table"")) stop(""install data.table"")
-  if(!requirenamespace(""dplyr"")) stop(""install dplyr"")  
   # If you're not using NMprojects, you can skip this part
   dir <- ""/m1"" # Path to simulated data
   full_dir <- paste(x$run_dir, dir, sep = """")
@@ -36,7 +34,7 @@ load_sse <- function(x, parr=F, nodes=1) {
   
   # Read in dataframes and d0 dataprocessing
   process1 <- function(data_path){
-    d <- data.table::fread(data_path, skip = 1, header = T)
+    d <- utils::read.csv(data_path, skip = 1, header = T)
     # If you are working with large dataframes, you may be required to implement dataprocessing steps, depending on your capacity, check/set memory.limit()
     save(d, file = paste0(data_path,""processed.RData""))
   }
@@ -62,6 +60,6 @@ load_sse <- function(x, parr=F, nodes=1) {
   print(""Only data from simulation step will be loaded, you may adapt this function to load data from estimation step, or to do both."")
   
   # rbind dataframes
-  d <- dplyr::bind_rows(d)  ## dplyr function
+  d <- do.call(rbind, d)
   
 }

---FILE: man/load_sse.Rd---
@@ -0,0 +1,20 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/load_sse.R
+\name{load_sse}
+\alias{load_sse}
+\title{Load SSE data}
+\usage{
+load_sse(x, parr = F, nodes = 1)
+}
+\arguments{
+\item{x}{object class nm}
+
+\item{parr}{logical. include description here#'}
+
+\item{nodes}{include description here}
+}
+\description{
+Function to load simulation data from PsN SSE
+This facilitates extracting data needed for postprocessing of simulations
+poptentially helpfor after simulation with uncertainty (e.g. obtained through PsN bootstrap or impance sampling)
+}"
tsahota,NMproject,ff94ff631aab5bcc740fee7ba45b3f1d25b50fe9,klgk669,klgk669@rstudio-dev01.scp.astrazeneca.net,2018-09-14T17:28:31Z,klgk669,klgk669@rstudio-dev01.scp.astrazeneca.net,2018-09-14T17:28:31Z,doc fix for process_ppc,man/process_ppc.Rd,False,False,False,False,3,3,6,"---FILE: man/process_ppc.Rd---
@@ -11,9 +11,9 @@ process_ppc(d, stat_fun, sim_col = ""SIM"", ...)
 
 \item{stat_fun}{function to compute statistic.
 Requirements:
-First argument = data frame upon which to compute statistic
-Function must compute statistic on DV
-Function must return a data frame}
+1) First argument = data frame upon which to compute statistic.
+2) Function must compute statistic on DV.
+3) Function must return a data frame.}
 
 \item{sim_col}{character (default = ""SIM""). name of subproblem number column}
 "
tsahota,NMproject,2a0120211320ee6c13ea52bb29a86a855744dbf7,klgk669,klgk669@rstudio-dev01.scp.astrazeneca.net,2018-09-11T11:41:25Z,klgk669,klgk669@rstudio-dev01.scp.astrazeneca.net,2018-09-11T11:41:25Z,doc fix,R/NMproject.R,False,True,True,False,3,3,6,"---FILE: R/NMproject.R---
@@ -648,9 +648,9 @@ snapshot <- function(message = ""created automatic snapshot"", session = TRUE, db_
 #' @param d data.frame (normally output of nm_output())
 #' @param stat_fun function to compute statistic.
 #'   Requirements:
-#'   First argument = data frame upon which to compute statistic
-#'   Function must compute statistic on DV
-#'   Function must return a data frame
+#'   1) First argument = data frame upon which to compute statistic.
+#'   2) Function must compute statistic on DV.
+#'   3) Function must return a data frame.
 #' @param sim_col character (default = ""SIM""). name of subproblem number column 
 #' @param ... additional arguments to be passed to stat_fun
 #' "
tsahota,NMproject,3097e76d2857e12be9be75e6fe814c8abbdafbfb,klgk669,klgk669@rstudio-dev01.scp.astrazeneca.net,2018-09-11T11:37:47Z,klgk669,klgk669@rstudio-dev01.scp.astrazeneca.net,2018-09-11T11:37:47Z,bug fix,R/NMproject.R;man/process_ppc.Rd,False,True,True,False,19,9,28,"---FILE: R/NMproject.R---
@@ -647,8 +647,10 @@ snapshot <- function(message = ""created automatic snapshot"", session = TRUE, db_
 #' 
 #' @param d data.frame (normally output of nm_output())
 #' @param stat_fun function to compute statistic.
-#'   First argument = data.frame for dataset
-#'   Function must use DV column
+#'   Requirements:
+#'   First argument = data frame upon which to compute statistic
+#'   Function must compute statistic on DV
+#'   Function must return a data frame
 #' @param sim_col character (default = ""SIM""). name of subproblem number column 
 #' @param ... additional arguments to be passed to stat_fun
 #' 
@@ -666,21 +668,27 @@ snapshot <- function(message = ""created automatic snapshot"", session = TRUE, db_
 
 process_ppc <- function (d, stat_fun, sim_col = ""SIM"", ...) 
 {
-  if (!sim_col %in% names(d)) 
-    stop(""Need sim_col column in dataset"")
-  dobs <- stat_fun(d[d$SIM %in% 1, ], ...)
+  if (!sim_col %in% names(d)) stop(""Need sim_col column in dataset"")
+  if(!1 %in% d[[sim_col]]) stop(""sim_col does not contain a 1 in dataset"")
+
+  dobs <- stat_fun(d[d[[sim_col]] %in% 1, ], ...)
+  if(!inherits(dobs, ""data.frame"")) stop(""output of stat_fun should be a data.frame"")
+  dobs <- as.data.frame(dobs)
   dobs$SIM <- NA
+  
   stat_fun_sim <- stat_fun
   stat_fun_sim_body <- body(stat_fun_sim)
-  stat_fun_sim_body <- NMproject:::replace_DV_with_DV_OUT(stat_fun_sim_body)
+  stat_fun_sim_body <- replace_DV_with_DV_OUT(stat_fun_sim_body)
   body(stat_fun_sim) <- stat_fun_sim_body
+  
   dsim <- by(d, d[[sim_col]], function(d) {
     sim <- unique(d[[sim_col]])
     d <- stat_fun_sim(d, ...)
     d$SIM <- sim
     d
   })
-  if(inherits(dsim[[1]], ""data.frame"")) dsim <- do.call(rbind, as.data.frame(dsim))
+  dsim <- do.call(rbind, as.data.frame(dsim))
+  
   list(obs = dobs, sim = dsim)
 }
 

---FILE: man/process_ppc.Rd---
@@ -10,8 +10,10 @@ process_ppc(d, stat_fun, sim_col = ""SIM"", ...)
 \item{d}{data.frame (normally output of nm_output())}
 
 \item{stat_fun}{function to compute statistic.
-First argument = data.frame for dataset
-Function must use DV column}
+Requirements:
+First argument = data frame upon which to compute statistic
+Function must compute statistic on DV
+Function must return a data frame}
 
 \item{sim_col}{character (default = ""SIM""). name of subproblem number column}
 "
tsahota,NMproject,4552ea4152c81347b74087379e0beb6c34e11604,klgk669,klgk669@rstudio-dev01.scp.astrazeneca.net,2018-09-11T11:21:04Z,klgk669,klgk669@rstudio-dev01.scp.astrazeneca.net,2018-09-11T11:21:04Z,bug fix,R/NMproject.R,False,True,True,False,14,8,22,"---FILE: R/NMproject.R---
@@ -664,22 +664,28 @@ snapshot <- function(message = ""created automatic snapshot"", session = TRUE, db_
 #' ## then plot dppc$obs and dppc$sim
 #' }
 
-process_ppc <- function(d, stat_fun, sim_col = ""SIM"", ...){
-  if(!sim_col %in% names(d)) stop(""Need sim_col column in dataset"")
-  dobs <- stat_fun(d, ...)
-  
+process_ppc <- function (d, stat_fun, sim_col = ""SIM"", ...) 
+{
+  if (!sim_col %in% names(d)) 
+    stop(""Need sim_col column in dataset"")
+  dobs <- stat_fun(d[d$SIM %in% 1, ], ...)
+  dobs$SIM <- NA
   stat_fun_sim <- stat_fun
   stat_fun_sim_body <- body(stat_fun_sim)
-  stat_fun_sim_body <- replace_DV_with_DV_OUT(stat_fun_sim_body)
+  stat_fun_sim_body <- NMproject:::replace_DV_with_DV_OUT(stat_fun_sim_body)
   body(stat_fun_sim) <- stat_fun_sim_body
-  
-  dsim <- by(d, d[[sim_col]], function(d){
-    stat_fun_sim(d, ...)
+  dsim <- by(d, d[[sim_col]], function(d) {
+    sim <- unique(d[[sim_col]])
+    d <- stat_fun_sim(d, ...)
+    d$SIM <- sim
+    d
   })
+  if(inherits(dsim[[1]], ""data.frame"")) dsim <- do.call(rbind, as.data.frame(dsim))
   list(obs = dobs, sim = dsim)
 }
 
 
+
 replace_DV_with_DV_OUT <- function(x){
   if(identical(x, quote(DV))){
     x <- quote(DV_OUT) "
tsahota,NMproject,1470a3458c6f57c63f92777a9109f18d70c52f5c,klgk669,klgk669@rstudio-dev01.scp.astrazeneca.net,2018-09-02T23:46:33Z,klgk669,klgk669@rstudio-dev01.scp.astrazeneca.net,2018-09-02T23:46:33Z,bug fix in tests,tests/testthat/test-basic.R;tests/testthat/test-status.R,False,True,True,False,3,1,4,"---FILE: tests/testthat/test-basic.R---
@@ -57,10 +57,12 @@ test_that(""Project has basic functionality"",{
   expect_true(file.exists(""DerivedData/THEOPP.csv""))
   expect_true(file.exists(file.path(getOption(""scripts.dir""),""theopp-demo.R"")))
 
+  opts <- options()
   interactive_mode(TRUE)
   expect_true(!getOption(""run_overwrite""))
   interactive_mode(FALSE)
   expect_true(getOption(""run_overwrite""))
+  options(opts)
 
 })
 

---FILE: tests/testthat/test-status.R---
@@ -26,7 +26,7 @@ test_that(""status"",{
 
   m1 <- nm(""qpsn -m -c auto -t 3000 -- execute run1.mod -dir=1"")
 
-  expect_error(run(m1)) ## already run
+  expect_error(run(m1)) ## already run so this should fail
   expect_output(print(m1),""List of"") ## does object print using str
 
   wait_default(FALSE)"
tsahota,NMproject,9181fbce91ec5036da47a4caa7954e8c45950027,klgk669,klgk669@rstudio-dev01.scp.astrazeneca.net,2018-09-02T23:35:22Z,klgk669,klgk669@rstudio-dev01.scp.astrazeneca.net,2018-09-02T23:35:22Z,bug fix,R/ctl_handling.R,False,True,True,False,2,2,4,"---FILE: R/ctl_handling.R---
@@ -378,7 +378,7 @@ gsub_ctl <- function(ctl, ...){
 #' @export
 
 change_to_sim <- function(ctl_lines,subpr=1,seed=1){
-  ctl_lines <- ctl_nm2r(ctl_lines)
+  ctl_lines <- ctl_list(ctl_lines)
   ctl_lines$EST <- paste0("";"",ctl_lines$EST)
   ctl_lines$COV <- paste0("";"",ctl_lines$COV)
   if(""SIM"" %in% names(ctl_lines)){
@@ -388,7 +388,7 @@ change_to_sim <- function(ctl_lines,subpr=1,seed=1){
   } else {
     ## insert before $TABLE, after $ERROR/$PRED
     pred_error_pos <- which(grepl(""ERROR|PRED"",names(ctl_lines)))
-    if(pred_error_pos > 1) stop(""multiple $ERROR/$PREDs detected - is this right?"")
+    if(length(pred_error_pos) > 1) stop(""multiple $ERROR/$PREDs detected - should only have one or the other?"")
     ctl_lines <- append(ctl_lines,list(SIM=NA),pred_error_pos)
     ctl_lines$SIM <- paste0(""$SIM ("",seed,"") ONLYSIM SUBPR="",subpr)
   }"
tsahota,NMproject,bb6a357f6f899c980bcf2554f9af4eb5d4c49f11,klgk669,klgk669@rstudio-dev01.scp.astrazeneca.net,2018-09-02T23:34:28Z,klgk669,klgk669@rstudio-dev01.scp.astrazeneca.net,2018-09-02T23:34:28Z,bug fix - allows nm_output to work without xpose4,R/nm.R,False,True,True,False,1,1,2,"---FILE: R/nm.R---
@@ -1097,7 +1097,7 @@ nm_output <- function(r,dorig,...){
   if(requireNamespace(""xpose4"")) {
     xpdb <- xpose4::xpose.data(r$run_id,directory=paste0(r$run_in,""/""))
     d <- xpdb@Data
-  }
+  } else d <- data.frame()
   
   if(nrow(d) == 0){
     ctl_out_files <- r$output$ctl_out_files"
tsahota,NMproject,5ec9df04142706e63bba7fb7730897c3ba2ea984,klgk669,klgk669@rstudio-dev01.scp.astrazeneca.net,2018-09-02T12:23:24Z,klgk669,klgk669@rstudio-dev01.scp.astrazeneca.net,2018-09-02T12:23:24Z,bug fix,R/NMproject.R,False,True,True,False,1,1,2,"---FILE: R/NMproject.R---
@@ -494,7 +494,7 @@ build_modfile <- function(code_section){
 manual_steps() detected, skipping code segment to prevent partial building of modfile,
 run line by line and follow instructions in manual_step() to build modfile"")
   } else {
-    eval(code_section, envir = parent.frame(n=2))
+    eval(code_section, envir = parent.frame(n=1))
   }
   return(invisible())
 }"
tsahota,NMproject,88b621d9b0a680de6c2cbf121167c406db03ea39,klgk669,klgk669@rstudio-dev01.scp.astrazeneca.net,2018-08-30T09:09:26Z,klgk669,klgk669@rstudio-dev01.scp.astrazeneca.net,2018-08-30T09:09:26Z,bug fix,R/ctl_handling.R,False,True,True,False,6,1,7,"---FILE: R/ctl_handling.R---
@@ -681,7 +681,12 @@ change_seed <- function(ctl,new_seed){
 #' @export
 get_data <- function(r, filter = FALSE, ...){
   ## doesn't rely on data base or r object contents
-  file_name <- file.path(r$run_in,get_data_name(ctl_character(r)))
+  if(inherits(r, ""nm"")) {
+    file_name <- file.path(r$run_in,get_data_name(ctl_character(r)))
+  } else {
+    from <- dirname(attr(r, ""file_name""))
+    file_name <- file.path(from, get_data_name(ctl_character(r)))
+  }
   if(!grepl(""[a-zA-Z0-9]"",basename(file_name))) stop(""$DATA doesn't look like it refers to a file. Is this correct?"")
 
   if(normalizePath(dirname(file_name), mustWork = FALSE) == normalizePath(""DerivedData"")){"
tsahota,NMproject,36273630f1aa153202408249b5d6d5c716418777,klgk669,klgk669@rstudio-dev01.scp.astrazeneca.net,2018-08-29T23:46:13Z,klgk669,klgk669@rstudio-dev01.scp.astrazeneca.net,2018-08-29T23:46:13Z,bug fix,R/ctl_handling.R,False,True,True,False,1,1,2,"---FILE: R/ctl_handling.R---
@@ -681,7 +681,7 @@ change_seed <- function(ctl,new_seed){
 #' @export
 get_data <- function(r, filter = FALSE, ...){
   ## doesn't rely on data base or r object contents
-  file_name <- from_models(get_data_name(ctl_character(r)))
+  file_name <- file.path(r$run_in,get_data_name(ctl_character(r)))
   if(!grepl(""[a-zA-Z0-9]"",basename(file_name))) stop(""$DATA doesn't look like it refers to a file. Is this correct?"")
 
   if(normalizePath(dirname(file_name), mustWork = FALSE) == normalizePath(""DerivedData"")){"
tsahota,NMproject,7d9dea275acf29c5083f2025daad6b98a3373b31,klgk669,klgk669@rstudio-dev01.scp.astrazeneca.net,2018-08-29T22:37:43Z,klgk669,klgk669@rstudio-dev01.scp.astrazeneca.net,2018-08-29T22:37:43Z,bug fix,R/NMproject.R;R/ctl_handling.R;R/dollar_data.R;R/nm.R;man/read_derived_data.Rd,False,True,True,False,49,18,67,"---FILE: R/NMproject.R---
@@ -532,12 +532,25 @@ write_derived_data <- function(d, name, ...){
 #' Read derived data
 #'
 #' @param name name of file (without extension)
-#' @param ...  additional arguments to be passed dto write.csv
+#' @param na character to be passed to read.csv
+#' @param ...  additional arguments to be passed to read.csv
 #' @export
 
-read_derived_data <- function(name, ...){
+read_derived_data <- function(name, na = ""."", ...){
 
   ## TODO: expand to other types of argument
+  
+  if(file.exists(name)){
+    if(grep(""\\.RData"", name)) {
+      message(""loading: "", name)
+      load(file = name)
+    }
+    if(grep(""\\.csv"", name)) {
+      message(""loading: "", name)
+      d <- utils::read.csv(name, na = na, ...)
+    }
+    return(d)
+  }
 
   if(grepl(""\\."", name)) stop(""name should be extensionless"")
 
@@ -549,7 +562,7 @@ read_derived_data <- function(name, ...){
     load(file = RData_name)
   } else {
     if(!file.exists(csv_name)) stop(""looking for "", csv_name, "" but it doesn't exist. stopping..."")
-    d <- utils::read.csv(csv_name, ...)
+    d <- utils::read.csv(csv_name, na = na, ...)
   }
   return(d)
 }

---FILE: R/ctl_handling.R---
@@ -554,7 +554,11 @@ param_cov_text <- function(param,cov,state,data,theta_n_start,continuous = TRUE,
     ## get data
     data_temp <- tapply(data[[cov]], data$ID, stats::median, na.rm = TRUE)
     value <- signif(stats::median(data_temp, na.rm = TRUE), 3)
-    par_cov_text <- gsub(""median"", value , par_cov_text)
+    if(value>0){
+      par_cov_text <- gsub(""median"", value , par_cov_text) 
+    } else {
+      par_cov_text <- gsub(""-\\s*median"", paste0(""+ "", -value) , par_cov_text)
+    }
   }
 
   ## renumber thetas
@@ -668,9 +672,9 @@ get_data <- function(r, filter = FALSE, ...){
   if(!grepl(""[a-zA-Z0-9]"",basename(file_name))) stop(""$DATA doesn't look like it refers to a file. Is this correct?"")
 
   if(normalizePath(dirname(file_name), mustWork = FALSE) == normalizePath(""DerivedData"")){
-    d <- read_derived_data(basename(get_stub_name(file_name)))
+    d <- read_derived_data(basename(get_stub_name(file_name)),...)
   } else {
-    d <- utils::read.csv(file_name, na = ""."", ...)
+    d <- utils::read.csv(file_name, ...)
   }
   
   if(filter) {

---FILE: R/dollar_data.R---
@@ -61,10 +61,13 @@ dollar_data <- function(d,keep,rename){
 is_a_number <- function(x){
   if(inherits(x, ""integer"")) return(TRUE)
   if(inherits(x, ""numeric"")) return(TRUE)
-  
-  n_nas <- length(which(is.na(x)))
-  n_numeric_nas <- suppressWarnings(length(which(is.na(as.numeric(x)))))
-  
-  identical(n_nas, n_numeric_nas)
-  
+  suppressWarnings({
+    if(inherits(x, ""factor"")) x_numeric <- as.numeric(levels(x))[x] else
+      if(inherits(x, ""logical"")) x_numeric <- as.numeric(as.character(x)) else
+        if(inherits(x, ""character"")) x_numeric <- as.numeric(x) else
+          stop(""unknown class - needs development"")
+  })
+  nas_x_numeric <- length(which(is.na(x_numeric)))
+  nas_x <- length(which(is.na(x)))
+  return(nas_x_numeric == nas_x)
 }

---FILE: R/nm.R---
@@ -1114,11 +1114,17 @@ nm_output <- function(r,dorig,...){
   if(missing(dorig)) dorig <- get_data(r,...)
   
   filter_statements <- data_filter_char(r)
+  if(identical(filter_statements, ""TRUE"")){
+    dORD <- seq_len(nrow(dorig))
+  } else {
+    expre <- parse(text=filter_statements)
+    dORD <- which(with(dorig,eval(expre)))    
+  }
   #if(length(filter_statements) > 0){
-  expre <- parse(text=filter_statements)
-  dORD <- which(with(dorig,eval(expre)))
+
   #if(""IGNORE"" %in% type) dORD <- which(with(dorig,eval(expre)))
   #if(""ACCEPT"" %in% type) dORD <- which(!with(dorig,eval(expre)))
+  
   if(nrow(d) %% length(dORD) != 0) {
     stop(""something wrong... when R reads in original dataset
 and applies filter "",filter_statements,"",
@@ -1128,17 +1134,21 @@ there's "",length(dORD),""rows, but NONMEM output has "", nrow(d), "" rows"")
   #  dORD <- seq_len(nrow(dorig))
   #}
   
+  ctl_contents <- ctl_character(r)
+  sim_ctl <- any(grepl(""^\\s*\\$SIM"",rem_comment(ctl_contents)))
+  
   nreps <- nrow(d) / length(dORD)
   
   if(""PRKEY"" %in% names(d)) stop(""name conflict with PRKEY in xpose table. aborting..."")
   if(""PRKEY"" %in% names(dorig)) stop(""name conflict with PRKEY in original data. aborting..."")
 
   d$PRKEY <- dORD
   dorig$PRKEY <- 1:nrow(dorig)
-  if(nreps > 1){
+  if(sim_ctl){
     if(""SIM"" %in% names(d)) stop(""name conflict with SIM in xpose table. aborting..."")
     if(""SIM"" %in% names(dorig)) stop(""name conflict with SIM in original data. aborting..."")
     d$SIM <- rep(1:nreps,each=length(dORD))
+    message(""Adding column: SIM"")
   }
 
   d$INNONMEM <- TRUE
@@ -1159,7 +1169,6 @@ there's "",length(dORD),""rows, but NONMEM output has "", nrow(d), "" rows"")
   if(nrow(d2) != nrow(d)*(nreps-1)/nreps + nrow(dorig)) stop(""merge went wrong. debug"")
 
   message(""Adding column: PRKEY"")
-  if(nreps > 1) message(""Adding column: SIM"")
 
   return(d2)
 }

---FILE: man/read_derived_data.Rd---
@@ -4,12 +4,14 @@
 \alias{read_derived_data}
 \title{Read derived data}
 \usage{
-read_derived_data(name, ...)
+read_derived_data(name, na = ""."", ...)
 }
 \arguments{
 \item{name}{name of file (without extension)}
 
-\item{...}{additional arguments to be passed dto write.csv}
+\item{na}{character to be passed to read.csv}
+
+\item{...}{additional arguments to be passed to read.csv}
 }
 \description{
 Read derived data"
tsahota,NMproject,32ddaaeca4339fe19d0e5a02e0fb1ada73c13a4f,klgk669,klgk669@rstudio-dev01.scp.astrazeneca.net,2018-08-24T20:55:52Z,klgk669,klgk669@rstudio-dev01.scp.astrazeneca.net,2018-08-24T20:55:52Z,bug fix,R/nm.R,False,True,True,False,1,1,2,"---FILE: R/nm.R---
@@ -1182,7 +1182,7 @@ data_ignore_char <- function(r){
   no_filter <- is.na(type)
   
   if(!no_filter){
-    filter_statements <- paste0("".*"",type,""\\s*=\\s*\\(*(\\S[^\\)]+)\\)*.*"")
+    filter_statements <- paste0("".*"",type,""\\s*=\\s*\\((\\S[^\\)]+)\\)*.*"")
     dol_data <- dol_data[grepl(filter_statements, dol_data)]
     filter_statements <- gsub(filter_statements,""\\1"",dol_data)
     filter_statements <- unlist(strsplit(filter_statements,"",""))"
tsahota,NMproject,3c64b1eb1bb38d696628350ba19d3006e71d9f5f,klgk669,klgk669@rstudio-dev01.scp.astrazeneca.net,2018-08-14T22:08:45Z,klgk669,klgk669@rstudio-dev01.scp.astrazeneca.net,2018-08-14T22:08:45Z,test fix,tests/testthat/test-basic.R;tests/testthat/test-plot_iter.R,False,True,True,False,2,2,4,"---FILE: tests/testthat/test-basic.R---
@@ -46,7 +46,7 @@ test_that(""Project has basic functionality"",{
   expect_true(length(dn)==1)
   expect_true(class(dn)==""character"")
 
-  update_dollar_data(""Models/run1.mod"",""new.data.csv"")
+  update_dollar_data(""Models/run1.mod"",""new.data.csv"") %>% write_ctl(""1"")
 
   dn <- data_name(""Models/run1.mod"")
   expect_true(dn==""new.data.csv"")

---FILE: tests/testthat/test-plot_iter.R---
@@ -32,7 +32,7 @@ test_that(""db & plot_iter works"",{
 
   m2 <- nm(""qpsn -m -c auto -t 3000 -- execute run2.mod -dir=2"")
 
-  ctl <- readLines(m2$ctl)
+  ctl <- ctl_character(m2)
   expect_true(inherits(ctl_character(ctl_list(m2)),""ctl_character""))
   expect_true(inherits(ctl_character(ctl_list(m2$ctl)),""ctl_character""))
   expect_true(inherits(ctl_character(ctl_list(ctl)),""ctl_character""))"
tsahota,NMproject,7a2da94881a20bdb201c9a8206aa8669a7e9969f,klgk669,klgk669@rstudio-dev01.scp.astrazeneca.net,2018-08-14T22:08:25Z,klgk669,klgk669@rstudio-dev01.scp.astrazeneca.net,2018-08-14T22:08:25Z,"update_dollar_data improved interoperability,  manual_step doesn't give error any more",R/NMproject.R;man/manual_step.Rd;man/update_dollar_data.Rd,False,True,True,False,16,10,26,"---FILE: R/NMproject.R---
@@ -299,13 +299,13 @@ get_data_name <- function(ctl){
 #' update dollar data (name of dataset) in NONMEM control stream
 #'
 #' Generic function
-#' @param ctl_name character. Name of control stream
+#' @param ctl_name object coercible to ctl_character
 #' @param new_data_name character. Name of new dataset
 #' @export
 update_dollar_data <- function(ctl_name,new_data_name){
-  ctl <- readLines(ctl_name,warn = FALSE)
+  ctl <- ctl_character(ctl_name)
   ctl <- gsub(""^(\\s*\\$DATA\\s*)[^ ]+(.*)$"",paste0(""\\1"",new_data_name,""\\2""),ctl)
-  writeLines(ctl,ctl_name)
+  ctl
 }
 
 #' update dollar inpute in NONMEM control stream
@@ -317,7 +317,7 @@ update_dollar_data <- function(ctl_name,new_data_name){
 
 update_dollar_input <- function(ctl, ...){
   ctl <- ctl_list(ctl)
-  d <- get_data(ctl)
+  d <- suppressMessages(get_data(ctl))
   replace_with <- suppressMessages(dollar_data(d, ...))
   ctl$INPUT <- c(""$INPUT"", replace_with, """")
   ctl
@@ -428,14 +428,18 @@ omega_matrix <- function(r){
 #' Document manual step
 #'
 #' @param comment character. Description of change
+#' @param open object coercible into ctl file name
 #' @return error with comment name
 #' @export
-manual_step <- function(comment){
-  stop(""This is a manual analysis step.
-It should only reside in a manual() code segment.
-You should not be trying to execute this directly. See ?manual for help."")
+manual_step <- function(comment, open){
+  if(!missing(open)){
+    ctl(open)
+    message(""opened for manual edit: "", search_ctl_name(open))
+  }
+  message(""perform manual edit: "", comment)
 }
 
+
 #' Document manual steps for traceability
 #'
 #' This function will not execute to prevent accidental partial execution 

---FILE: man/manual_step.Rd---
@@ -4,10 +4,12 @@
 \alias{manual_step}
 \title{Document manual step}
 \usage{
-manual_step(comment)
+manual_step(comment, open)
 }
 \arguments{
 \item{comment}{character. Description of change}
+
+\item{open}{object coercible into ctl file name}
 }
 \value{
 error with comment name

---FILE: man/update_dollar_data.Rd---
@@ -7,7 +7,7 @@
 update_dollar_data(ctl_name, new_data_name)
 }
 \arguments{
-\item{ctl_name}{character. Name of control stream}
+\item{ctl_name}{object coercible to ctl_character}
 
 \item{new_data_name}{character. Name of new dataset}
 }"
tsahota,NMproject,cf79351bfb0aeaea5f366ab3523710c18201acc5,klgk669,klgk669@rstudio-dev01.scp.astrazeneca.net,2018-08-08T22:47:50Z,klgk669,klgk669@rstudio-dev01.scp.astrazeneca.net,2018-08-08T22:47:50Z,bug fix,R/ctl_handling.R,False,True,True,False,2,0,2,"---FILE: R/ctl_handling.R---
@@ -439,6 +439,8 @@ add_cov <- function(ctl, param, cov, state, continuous = TRUE, data, time_varyin
                 ctl$PK[-1])
 
     tv_definition_row <- which(grepl(paste0(""^\\s*"",tvparam,""\\s*=""), rem_comment(ctl$PK)))
+    dont_count <- which(grepl(paste0(""^\\s*"",tvparam,""\\s*=.*"",tvparam), rem_comment(ctl$PK)))
+    tv_definition_row <- setdiff(tv_definition_row, dont_count)
     if(length(tv_definition_row) > 1) stop(""can't find unique TV parameter definition in $PK"")
     if(length(tv_definition_row) == 0) stop(""can't find TV parameter definition in $PK"")
 "
tsahota,NMproject,992106dced51ce227b1e4f44af67cb409093b74d,klgk669,klgk669@rstudio-dev01.scp.astrazeneca.net,2018-08-07T13:11:54Z,klgk669,klgk669@rstudio-dev01.scp.astrazeneca.net,2018-08-07T13:11:54Z,added error message to manual if no manual_step() is used,R/NMproject.R,False,True,True,False,3,1,4,"---FILE: R/NMproject.R---
@@ -467,10 +467,12 @@ manual_step <- function(comment){
 #' }
 #' @export
 manual <- function(code_section){
+  code_section <- deparse(substitute(code_section))
+  if(!any(grepl(""manual_step"", code_section))) stop(""code_section should contain one or more uses of manual_step().  See ?manual for example"")
   opt <- options()
   on.exit(options(opt))
   options(show.error.messages=FALSE) 
-  message(""Manual code section - stopping execution.\nTo redo, run any code line by line and redo manual steps in description"")
+  message(""---Manual code section - stopping execution to prevent partial overwriting---\nTo redo this segment, run any code lines line by line and redo manual_step()s manually"")
   stop()
 }
 "
tsahota,NMproject,8f427231df1619fe4e007d9ed53ed04b554c1255,klgk669,klgk669@rd.astrazeneca.net@rstudio-dev01.scp.astrazeneca.net,2018-08-06T22:59:03Z,klgk669,klgk669@rd.astrazeneca.net@rstudio-dev01.scp.astrazeneca.net,2018-08-06T22:59:03Z,small bug fix,R/NMproject.R;man/load_top_level_models.Rd,False,True,True,False,4,2,6,"---FILE: R/NMproject.R---
@@ -518,7 +518,8 @@ load_models <- function (x){
 #'
 #' Will rerun all '<- nm()' definitions
 #' Only remakes top level definitions.
-#' Programmatic use of nm() (e.g. in a for loop) will generally not work. Sorry!
+#' Programmatic use of nm() (e.g. in a for loop or using paste with other objects) will generally not work.
+#' Sorry!
 #' 
 #' @param script_name path to script file
 #' @export

---FILE: man/load_top_level_models.Rd---
@@ -12,5 +12,6 @@ load_top_level_models(script_name)
 \description{
 Will rerun all '<- nm()' definitions
 Only remakes top level definitions.
-Programmatic use of nm() (e.g. in a for loop) will generally not work. Sorry!
+Programmatic use of nm() (e.g. in a for loop or using paste with other objects) will generally not work.
+Sorry!
 }"
tsahota,NMproject,35dd7fbe478aa41bf294d0447a39d5ccec7fba4b,klgk669,klgk669@rd.astrazeneca.net@rstudio-dev01.scp.astrazeneca.net,2018-08-06T19:05:58Z,klgk669,klgk669@rd.astrazeneca.net@rstudio-dev01.scp.astrazeneca.net,2018-08-06T19:05:58Z,cran check fix,R/nm.R;man/nm_output.Rd;man/update_parameters.Rd,False,True,True,False,26,20,46,"---FILE: R/nm.R---
@@ -1084,21 +1084,29 @@ setup_nm_demo <- function(file_stub = paste0(getOption(""model_file_stub""),1),
 #' This combines $TABLE output with the input data, allowing text columns to be retained for plotting/summaries.
 #'
 #' @param r data.frame.  object of class nm_execute
-#' @param read_fun function (default = read.csv). Function to read in original NONMEM data
-#' @param dorig data.frame. optional NONMEM input dataset. if missing, will read in using read_fun
-#' @param ... additional arguments to pass on to read_fun
+#' @param dorig data.frame. optional NONMEM input dataset.
+#' @param ... additional arguments to pass on to read.csv
 #' @export
-nm_output <- function(r,read_fun=utils::read.csv,dorig,...){
-
-  if(!requireNamespace(""xpose4"")) stop(""require xpose4 to be installed"")
-  xpdb <- xpose4::xpose.data(r$run_id,directory=paste0(r$run_in,""/""))
-  d <- xpdb@Data
-
-  if(missing(dorig)){
-    data_loc <- file.path(r$run_in,r$input$data_name)
-    if(!""na"" %in% names(list)) dorig <- read_fun(data_loc,na=""."",...) else
-      dorig <- read_fun(data_loc,...)
+nm_output <- function(r,dorig,...){
+  
+  if(requireNamespace(""xpose4"")) {
+    xpdb <- xpose4::xpose.data(r$run_id,directory=paste0(r$run_in,""/""))
+    d <- xpdb@Data
   }
+  
+  if(nrow(d) == 0){
+    ctl_out_files <- r$output$ctl_out_files
+    ctl_out_files <- ctl_out_files[grepl(""tab"", ctl_out_files)]
+    
+    d <- lapply(ctl_out_files, function(out_file){
+      d <- utils::read.table(out_file, skip = 1, header = TRUE)
+    })
+    
+    d <- do.call(cbind,d)
+    d <- d[,!duplicated(names(d))]
+  }
+
+  if(missing(dorig)) dorig <- get_data(r,...)
 
   ctl_content <- readLines(r$ctl,warn = FALSE)
   dol_data <- ctl_nm2r(ctl_content)$DATA

---FILE: man/nm_output.Rd---
@@ -4,16 +4,14 @@
 \alias{nm_output}
 \title{Get NONMEM output tables}
 \usage{
-nm_output(r, read_fun = utils::read.csv, dorig, ...)
+nm_output(r, dorig, ...)
 }
 \arguments{
 \item{r}{data.frame.  object of class nm_execute}
 
-\item{read_fun}{function (default = read.csv). Function to read in original NONMEM data}
+\item{dorig}{data.frame. optional NONMEM input dataset.}
 
-\item{dorig}{data.frame. optional NONMEM input dataset. if missing, will read in using read_fun}
-
-\item{...}{additional arguments to pass on to read_fun}
+\item{...}{additional arguments to pass on to read.csv}
 }
 \description{
 This combines $TABLE output with the input data, allowing text columns to be retained for plotting/summaries.

---FILE: man/update_parameters.Rd---
@@ -4,10 +4,10 @@
 \alias{update_parameters}
 \title{update parameters from a control stream}
 \usage{
-update_parameters(ctl_lines, from)
+update_parameters(ctl, from)
 }
 \arguments{
-\item{ctl_lines}{character vector. ctl file read into R}
+\item{ctl}{object coercible into ctl_list}
 
 \item{from}{class nm. object from which to extract results}
 }"
tsahota,NMproject,937674419ac981df2121f25764253540bb7938bf,klgk669,klgk669@rd.astrazeneca.net@rstudio-dev01.scp.astrazeneca.net,2018-08-05T11:52:50Z,klgk669,klgk669@rd.astrazeneca.net@rstudio-dev01.scp.astrazeneca.net,2018-08-05T11:52:50Z,bug fix documention for lst -> out name change,NAMESPACE;man/out.Rd,False,False,False,False,4,4,8,"---FILE: NAMESPACE---
@@ -30,7 +30,6 @@ export(get_data_name)
 export(interactive_mode)
 export(is_finished)
 export(job_info)
-export(lst)
 export(manual_step)
 export(new_ctl)
 export(new_script)
@@ -39,6 +38,7 @@ export(nm_output)
 export(nm_tran)
 export(non_interactive_mode)
 export(omega_matrix)
+export(out)
 export(overwrite_default)
 export(param_info)
 export(plot_iter)

---FILE: man/out.Rd---
@@ -1,10 +1,10 @@
 % Generated by roxygen2: do not edit by hand
 % Please edit documentation in R/nm.R
-\name{lst}
-\alias{lst}
+\name{out}
+\alias{out}
 \title{Show lst file}
 \usage{
-lst(r)
+out(r)
 }
 \arguments{
 \item{r}{object of class nm}"
tsahota,NMproject,0630610971006fb37f1c2630223293efb86c3bdf,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2018-08-03T15:47:57Z,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2018-08-03T15:47:57Z,relaxed error to warning if multiple $data rows found,R/NMproject.R,False,True,True,False,4,1,5,"---FILE: R/NMproject.R---
@@ -289,7 +289,10 @@ data_name.default <- function(x){
     ctl <- readLines(x,warn = FALSE)
     data.row <- grep(""^ *\\$DATA"",ctl)
     if(length(data.row)<1) stop(""can't identify data row"")
-    if(length(data.row)>1) stop(""multiple data rows found"")
+    if(length(data.row)>1) {
+      warning(""multiple data rows found. Using first"")
+      data.row <- data.row[1]
+    }
     ctl <- paste(ctl[data.row:length(ctl)],collapse = "" "")
     data_name <- gsub(""^ *\\$DATA\\s*([^ ]+).*$"",""\\1"",ctl)
     data_name"
tsahota,NMproject,22e36030c95a73fec4939a49da9389dfa3d43066,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2018-07-30T15:38:26Z,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2018-07-30T15:38:26Z,bug fix - shouldn't take commented rows,R/nm.R,False,True,True,False,1,0,1,"---FILE: R/nm.R---
@@ -1103,6 +1103,7 @@ nm_output <- function(r,read_fun=utils::read.csv,dorig,...){
   ctl_content <- readLines(r$ctl,warn = FALSE)
   dol_data <- ctl_nm2r(ctl_content)$DATA
   dol_data <- dol_data[!dol_data %in% """"]
+  dol_data <- rem_comment(dol_data)
 
   ignore_present <- any(grepl("".+IGNORE\\s*=\\s*\\S\\S"",dol_data))
   accept_present <- any(grepl("".+ACCEPT\\s*=\\s*\\S\\S"",dol_data))"
tsahota,NMproject,01308abf30f6b0b29b156d00be66eb151e6e8e53,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2018-07-30T15:37:51Z,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2018-07-30T15:37:51Z,bug fix - stop treating sigma like a matrix,R/run_record.R,False,True,True,False,10,0,10,"---FILE: R/run_record.R---
@@ -52,9 +52,19 @@ ext2coef <- function(extout,file_name){
   is.omega <- grepl(""OMEGA.([0-9]+\\.)+"",d$Parameter)
   is.off.diag.omega <- is.omega & !is.diag.omega
   d <- d[!(is.off.diag.omega & d$FINAL == 0), ] ## get rid of off diag 0s
+  is.diag.sigma <- grepl(""SIGMA.([0-9]+\\.)\\1"",d$Parameter)
+  is.sigma <- grepl(""SIGMA.([0-9]+\\.)+"",d$Parameter)
+  is.off.diag.sigma <- is.sigma & !is.diag.sigma
+  d <- d[!(is.off.diag.sigma & d$FINAL == 0), ] ## get rid of off diag 0s
+
+
   is.diag.omega <- grepl(""OMEGA.([0-9]+\\.)\\1"",d$Parameter) ## redefine
   is.omega <- grepl(""OMEGA.([0-9]+\\.)+"",d$Parameter) ## redefine
   is.off.diag.omega <- is.omega & !is.diag.omega  ## redefine
+  is.diag.sigma <- grepl(""SIGMA.([0-9]+\\.)\\1"",d$Parameter) ## redefine
+  is.sigma <- grepl(""SIGMA.([0-9]+\\.)+"",d$Parameter) ## redefine
+  is.off.diag.sigma <- is.sigma & !is.diag.sigma ## redefine
+
   ## sort so that THETAs first, then diagonal OMEGAs, then off diag, then SIGMA, then OBJ
 
   par.char <- as.character(d$Parameter)"
tsahota,NMproject,2ecbd87efd98268447fcf845e5d978296d71af9f,Tarjinder Sahota,klgk669@semldxcalvin.seml.astrazeneca.net,2018-07-05T18:21:28Z,Tarjinder Sahota,klgk669@semldxcalvin.seml.astrazeneca.net,2018-07-05T18:21:28Z,bug fix nm_output,R/nm.R,False,True,True,False,1,0,1,"---FILE: R/nm.R---
@@ -1115,6 +1115,7 @@ nm_output <- function(r,read_fun=utils::read.csv,dorig,...){
 
   if(!no_filter){
     filter_statements <- paste0("".*"",type,""\\s*=\\s*\\(*(\\S[^\\)]+)\\)*.*"")
+    dol_data <- dol_data[grepl(filter_statements, dol_data)]
     filter_statements <- gsub(filter_statements,""\\1"",dol_data)
     filter_statements <- unlist(strsplit(filter_statements,"",""))
     filter_statements <- gsub(""\\.EQ\\."",""=="",filter_statements)"
tsahota,NMproject,8e37a919a6891db970f9f60529f325270441141c,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2018-03-23T21:50:43Z,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2018-03-23T21:50:43Z,bug fix for simulations,R/nm.R,False,True,True,False,4,4,8,"---FILE: R/nm.R---
@@ -1134,7 +1134,7 @@ nm_output <- function(r,read_fun=utils::read.csv,dorig,...){
   } else {
     dORD <- seq_len(nrow(dorig))
   }
-  
+
   nreps <- nrow(d) / length(dORD)
 
   if(""PRKEY"" %in% names(d)) stop(""name conflict with PRKEY in xpose table. aborting..."")
@@ -1150,20 +1150,20 @@ nm_output <- function(r,read_fun=utils::read.csv,dorig,...){
 
   d$INNONMEM <- TRUE
 
-  d <- d[,c(setdiff(names(d),names(dorig)),""PRKEY"")]
+  d <- d[,c(setdiff(names(d),c(names(dorig),""DV"")),""PRKEY"")]
   #dorig <- dorig[,c(setdiff(names(dorig),names(d)),""PRKEY"")]
 
   d2 <- merge(dorig,d,all.x = TRUE)
 
   d2$INNONMEM <- d2$INNONMEM %in% TRUE
   if(nreps > 1) d2$SIM[is.na(d2$SIM)] <- 0
-  
+
   ## row number check
   if(nrow(d2) != nrow(d)*(nreps-1)/nreps + nrow(dorig)) stop(""merge went wrong. debug"")
 
   message(""Adding column: PRKEY"")
   if(nreps > 1) message(""Adding column: SIM"")
-  
+
   return(d2)
 }
 "
tsahota,NMproject,2f652e5e2bc585c84fe0a641472fd676214420d2,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2018-03-23T21:14:12Z,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2018-03-23T21:14:12Z,bug fix,R/ctl_handling.R,False,True,True,False,1,1,2,"---FILE: R/ctl_handling.R---
@@ -287,7 +287,7 @@ change_to_sim <- function(ctl_lines,subpr=1,seed=1){
   ctl_lines$COV <- paste0("";"",ctl_lines$COV)
   if(""SIM"" %in% names(ctl_lines)){
     ctl_lines$SIM <- gsub(""^\\s*;+(.*)"",""\\1"",ctl_lines$SIM)
-    ctl_lines$SIM <- gsub(""(SUBPR[^=]\\s*=\\s*)[0-9]+"",paste0(""\\1"",subpr),ctl_lines$SIM)
+    ctl_lines$SIM <- gsub(""(SUBPR[^=]*\\s*=\\s*)[0-9]+"",paste0(""\\1"",subpr),ctl_lines$SIM)
     ctl_lines$SIM <- gsub(""(\\$SIM[^\\s]*\\s*\\()[0-9]+(\\))"",paste0(""\\1"",seed,""\\2""),ctl_lines$SIM)
   } else {
     ## insert before $TABLE, after $ERROR/$PRED"
tsahota,NMproject,9ffc46635777109fe9e2cc93d1323a8ca4577c94,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2018-03-22T15:40:58Z,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2018-03-22T16:06:37Z,bug fix,R/ctl_handling.R,False,True,True,False,13,3,16,"---FILE: R/ctl_handling.R---
@@ -211,15 +211,25 @@ update_parameters0 <- function(ctl,coef_from,type = c(""THETA"",""OMEGA"",""SIGMA"")){
   }
 
   contents1 <- paste0(paste0(contents,collapse = ""\n""),""\n"")
+  contents1 <- gsub(""\\$THETA"",""$THETA&"",contents1)
+  contents1 <- gsub(""(\\$OMEGA BLOCK\\s*\\([0-9]+\\))"",""\\1&"",contents1)
+  contents1 <- gsub(""(\\$OMEGA)( [^B])"",""\\1&\\2"",contents1)
+  contents1 <- gsub(""(\\$SIGMA BLOCK\\s*\\([0-9]+\\))"",""\\1&"",contents1)
+  contents1 <- gsub(""(\\$SIGMA)( [^B])"",""\\1&\\2"",contents1)
+
   contents1 <- gsub("",\\s*"","","",contents1)
-  contents1 <- gsub(""([-\\.0-9])[ \\t]+([-\\.0-9])"",""\\1&\\2"",contents1)
+  contents2 <- gsub(""([-\\.0-9])[ \\t]+([-\\.0-9])"",""\\1&\\2"",contents1)
+  while(!identical(contents2,contents1)){
+    contents1 <- contents2
+    contents2 <- gsub(""([-\\.0-9])[ \\t]+([-\\.0-9])"",""\\1&\\2"",contents1)
+  }
 
   contents1 <- strsplit(contents1,""(?<=\\n)"",perl = TRUE)[[1]]
   contents1 <- gsub(""\\n"",""_"",contents1)
 
   contents1 <- unlist(strsplit(contents1,""(?<=&)"",perl = TRUE))
 
-  matched_replacements <- grepl(""^(\\s*&?\\s*_?\\s*)-?\\.?[0-9]+\\.?[0-9]*(\\s*(FIX)?&?\\s*_?\\s*)$"",contents1) |
+  matched_replacements <- grepl(""^(\\s*&?\\s*_?\\s*)-?\\.?[0-9]+\\.?[0-9]*E*-*\\+*[0-9]*(\\s*(FIX)?&?\\s*_?\\s*)$"",contents1) |
     grepl("".*SAME.*"",contents1) |
     grepl(""(^\\s*&?\\s*_?\\s*\\(.*,).*(\\)\\s*(FIX)?&?\\s*_?\\s*)$"",contents1) |
     grepl(""(^\\s*&?\\s*_?\\s*\\(.*,).*(,.*\\)\\s*(FIX)?&?\\s*_?\\s*)$"",contents1)
@@ -229,7 +239,7 @@ update_parameters0 <- function(ctl,coef_from,type = c(""THETA"",""OMEGA"",""SIGMA"")){
 
   for (j in seq_along(which(matched_replacements))){
     i <- which(matched_replacements)[j]
-    contents1[i] <- gsub(""^(\\s*&?\\s*_?\\s*)-?\\.?[0-9]+\\.?[0-9]*(\\s*(FIX)?&?\\s*_?\\s*)$"",
+    contents1[i] <- gsub(""^(\\s*&?\\s*_?\\s*)-?\\.?[0-9]+\\.?[0-9]*E*-*\\+*[0-9]*(\\s*(FIX)?&?\\s*_?\\s*)$"",
                          paste0(""\\1"",signif(final_params$FINAL[j],5),""\\2""),contents1[i])
     contents1[i] <- gsub(""(^\\s*&?\\s*_?\\s*\\(.*,).*(\\)\\s*(FIX)?&?\\s*_?\\s*)$"",
                          paste0(""\\1"",signif(final_params$FINAL[j],5),""\\2""),contents1[i])"
tsahota,NMproject,096dfede22c6e51f44f9e5568a19368105255b65,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2018-03-19T19:40:53Z,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2018-03-19T19:40:53Z,bug fix,R/NMproject.R,False,True,True,False,17,11,28,"---FILE: R/NMproject.R---
@@ -379,22 +379,28 @@ get_PMX_code_library <- function(local_path,
 #' @export
 omega_matrix <- function(r){
   dc <- coef(r,trans=FALSE)
-  dc <- filter(dc,Type %in% c(""OMEGAVAR"",""OMEGACOV""))
-  dc <- select(dc,Parameter,FINAL)
-  dc$ROW <- gsub(""OMEGA\\.([0-9]+)\\..*"",""\\1"",dc$Parameter) %>% as.numeric
-  dc$COL <- gsub(""OMEGA\\.[0-9]+\\.([0-9]+).*"",""\\1"",dc$Parameter) %>% as.numeric
-  dc <- arrange(dc,ROW,COL)
+  dc <- dc[dc$Type %in% c(""OMEGAVAR"",""OMEGACOV""),]
+  dc <- dc[,c(""Parameter"",""FINAL"")]
+  dc$ROW <- as.numeric(gsub(""OMEGA\\.([0-9]+)\\..*"",""\\1"",dc$Parameter))
+  dc$COL <- as.numeric(gsub(""OMEGA\\.[0-9]+\\.([0-9]+).*"",""\\1"",dc$Parameter))
+  dc <- dc[order(dc$ROW,dc$COL),]
   max_size <- max(c(dc$ROW,dc$COL))
-  dc <- ungroup(dc) %>% select(FINAL,ROW,COL)
-  dc_mirror <- dc %>% mutate(COLOLD = COL, ROWOLD = ROW,
-                             COL = ROWOLD, ROW = COLOLD) %>%
-    select(ROW,COL,FINAL)
-  dc <- rbind(dc,dc_mirror) %>% unique
+  dc <- dc[,c(""FINAL"",""ROW"",""COL"")]
+  dc_mirror <- dc
+  dc_mirror$COLOLD <- dc_mirror$COL
+  dc_mirror$ROWOLD <- dc_mirror$ROW
+  dc_mirror$COL <- dc_mirror$ROWOLD
+  dc_mirror$ROW <- dc_mirror$COLOLD
+  dc_mirror$COLOLD <- NULL
+  dc_mirror$ROWOLD <- NULL
+
+  dc <- rbind(dc,dc_mirror)
+  dc <- unique(dc)
 
   d_all <- expand.grid(ROW=1:max_size,COL=1:max_size)
   d_all <- merge(dc,d_all,all=TRUE)
   d_all$FINAL[is.na(d_all$FINAL)] <- 0
-  d_all <- arrange(d_all,ROW,COL)
+  d_all <- d_all[order(d_all$ROW,d_all$COL), ]
 
   matrix(d_all$FINAL,nrow=max_size)
 }"
tsahota,NMproject,b8a55428ec455e90d73cee13433fd499771d1867,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2018-03-18T22:33:38Z,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2018-03-18T22:33:38Z,bug fix nm_output prioritised output over original data - change,R/nm.R,False,True,True,False,2,1,3,"---FILE: R/nm.R---
@@ -1110,7 +1110,8 @@ nm_output <- function(r,read_fun=utils::read.csv,dorig,...){
 
   d$INNONMEM <- TRUE
 
-  dorig <- dorig[,c(setdiff(names(dorig),names(d)),""PRKEY"")]
+  d <- d[,c(setdiff(names(d),names(dorig)),""PRKEY"")]
+  #dorig <- dorig[,c(setdiff(names(dorig),names(d)),""PRKEY"")]
 
   d2 <- merge(dorig,d,all.x = TRUE)
 "
tsahota,NMproject,6ade8311919a6775b9e646667c7b19ee9c0f27d2,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2018-03-18T22:33:12Z,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2018-03-18T22:33:12Z,bug fix off diagonals were not displaying,R/run_record.R,False,True,True,False,1,1,2,"---FILE: R/run_record.R---
@@ -36,7 +36,7 @@ ext2coef <- function(extout,file_name){
   is.diag.omega <- grepl(""OMEGA.([0-9]+\\.)\\1"",d$Parameter)
   is.omega <- grepl(""OMEGA.([0-9]+\\.)+"",d$Parameter)
   is.off.diag.omega <- is.omega & !is.diag.omega
-  d <- d[!(is.off.diag.omega), ] ## get rid of off diag 0s
+  d <- d[!(is.off.diag.omega & d$FINAL == 0), ] ## get rid of off diag 0s
   is.diag.omega <- grepl(""OMEGA.([0-9]+\\.)\\1"",d$Parameter) ## redefine
   is.omega <- grepl(""OMEGA.([0-9]+\\.)+"",d$Parameter) ## redefine
   is.off.diag.omega <- is.omega & !is.diag.omega  ## redefine"
tsahota,NMproject,acc112225f0f577a7ffb02fcc6c38289ba3378d1,Tarjinder Sahota,klgk669@semldxcalvin.seml.astrazeneca.net,2018-01-05T18:59:12Z,Tarjinder Sahota,klgk669@semldxcalvin.seml.astrazeneca.net,2018-01-05T18:59:12Z,better error message,R/nm.R,False,True,True,False,4,2,6,"---FILE: R/nm.R---
@@ -61,10 +61,12 @@ nm <- function(cmd,psn_command,
     matched_psn_commands <- unlist(sapply(getOption(""psn.commands""),
                                           function(i) gsub2(paste0(""^.*("",i,"")\\b\\s.+$""),""\\1"",cmd)))
     matched_psn_commands <- as.character(matched_psn_commands)
+    error_msg <- ""\nRerun with psn_command argument\n e.g. for a bootstrap you can do:
+nm(\""bootstrap run1.mod -threads=4\"",psn_command=\""bootstrap\"")""
     if(length(matched_psn_commands)==0)
-      stop(""couldn't infer psn command type.\nRerun with psn_command argument"",call. = FALSE)
+      stop(paste0(""couldn't infer psn command type."",error_msg),call. = FALSE)
     if(length(matched_psn_commands)>1)
-      stop(""couldn't infer unique psn command type.\nRerun with psn_command argument"",call. = FALSE)
+      stop(paste0(""couldn't infer unique psn command type."",error_msg),call. = FALSE)
     message(paste(""inferring run type :"",matched_psn_commands))
     r$type <- matched_psn_commands
   }"
tsahota,NMproject,454af3771c7d4117876def85aac2c8d5120b4dbb,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-12-08T01:22:37Z,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-12-08T01:22:37Z,bug fix multiple line IGNORE statements,R/nm.R,False,True,True,False,2,2,4,"---FILE: R/nm.R---
@@ -1080,7 +1080,7 @@ nm_output <- function(r,read_fun=utils::read.csv,dorig,...){
   if(!no_filter){
     filter_statements <- paste0("".*"",type,""\\s*=\\s*\\(*(\\S[^\\)]+)\\)*.*"")
     filter_statements <- gsub(filter_statements,""\\1"",dol_data)
-    filter_statements <- strsplit(filter_statements,"","")[[1]]
+    filter_statements <- unlist(strsplit(filter_statements,"",""))
     filter_statements <- gsub(""\\.EQ\\."",""=="",filter_statements)
     filter_statements <- gsub(""\\.NE\\."",""!="",filter_statements)
     filter_statements <- gsub(""\\.EQN\\."",""=="",filter_statements)
@@ -1090,7 +1090,7 @@ nm_output <- function(r,read_fun=utils::read.csv,dorig,...){
     filter_statements <- gsub(""\\.LT\\."",""<"",filter_statements)
     filter_statements <- gsub(""\\.GE\\."","">="",filter_statements)
     filter_statements <- gsub(""\\.LE\\."",""<="",filter_statements)
-    filter_statements <- paste(filter_statements, collapse= "" & "")
+    filter_statements <- paste(filter_statements, collapse= "" | "")
 
     expre <- parse(text=filter_statements)
     if(""IGNORE"" %in% type) dORD <- which(!with(dorig,eval(expre)))"
tsahota,NMproject,7bfbdfca8769333cb18dafc7e7c242dd7ffc9905,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-11-23T19:41:43Z,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-11-23T19:41:43Z,better error message,R/nm.R,False,True,True,False,14,4,18,"---FILE: R/nm.R---
@@ -391,8 +391,17 @@ nmdb_add_entry <- function(r,entry=NULL,silent=FALSE,...){
   },
   error=function(e){
     if(DBI::dbIsValid(my_db)) DBI::dbDisconnect(my_db)
-    if(new_db_flag) unlink(r$db_name,force = TRUE)
-    stop(e)
+    if(new_db_flag) {
+      unlink(r$db_name,force = TRUE)
+      error_msg <- e
+    } else {
+      error_msg <- paste0(e,""\n"",r$db_name,"" may be corrupted.
+This may be due to a backwards incompatible change in NMproject.
+Consider rebuilding. Instructions to rebuild:
+1. Delete the file: "",normalizePath(r$db_name,mustWork = FALSE),""
+2. Rebuild database by running nm() statements again"")
+    }
+    stop(error_msg)
   })
 }
 
@@ -409,8 +418,9 @@ nmdb_get <- function(db_name=""runs.sqlite"",readable=FALSE){
     if(DBI::dbIsValid(my_db)) DBI::dbDisconnect(my_db)
     stop(paste0(e,""\n"",db_name,"" may be corrupted.
 This may be due to a backwards incompatible change in NMproject.
-Consider deleting and rebuilding "",normalizePath(db_name,mustWork = FALSE),""
-Rebuild by running nm() statements again""),call. = FALSE)
+Consider rebuilding. Instructions to rebuild:
+1. Delete the file: "",normalizePath(db_name,mustWork = FALSE),""
+2. Rebuild database by running nm() statements again""),call. = FALSE)
   })
 }
 "
tsahota,NMproject,f0a1a3fb94681f686c700a1102b164512baa8fe9,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-11-23T19:09:49Z,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-11-23T19:09:49Z,bug fix,R/nm.R,False,True,True,False,4,3,7,"---FILE: R/nm.R---
@@ -807,9 +807,10 @@ run_status <- function(r,db,entry,initial_timeout=NA){
 is_status_finished <- function(status_ob){
 
   finished <- FALSE
-  if(status_ob$status %in% c(""error"",""finished"")) {
-    finished <- TRUE
-  }
+  #if(""status"" %in% names(status_ob))
+  #  if(status_ob$status %in% c(""error"",""finished"")) {
+  #    finished <- TRUE
+  #  }
   if(""sub_run_status"" %in% names(status_ob)) {
     sub_finished <- status_ob$sub_run_status %in% c(""finished"",""error"")
     finished <- length(sub_finished)>0 & all(sub_finished)"
tsahota,NMproject,61f352ee78c8ce7a98af07a981efaf40a8d9a73f,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-11-22T08:00:55Z,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-11-22T08:00:55Z,bug fix,R/nm.R,False,True,True,False,2,0,2,"---FILE: R/nm.R---
@@ -1100,6 +1100,8 @@ nm_output <- function(r,read_fun=utils::read.csv,dorig,...){
   dorig <- dorig[,c(setdiff(names(dorig),names(d)),""PRKEY"")]
 
   d2 <- merge(dorig,d,all.x = TRUE)
+
+  d2$INNONMEM <- d2$INNONMEM %in% TRUE
   if(nrow(d2) != nrow(dorig)) stop(""merge went wrong. debug"")
 
   return(d2)"
tsahota,NMproject,9d2fffa3a6663cc0f6bfdcbdd904a2d3f89b555c,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-11-09T13:11:13Z,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-11-09T13:11:13Z,fixed test,tests/testthat/test-status.R,False,True,True,False,3,2,5,"---FILE: tests/testthat/test-status.R---
@@ -35,9 +35,10 @@ test_that(""status"",{
   expect_error(run(m2)) ## already run
   expect_output(print(m2),""List of"") ## does object print using str
 
-  expect_false(.sso_env$wait)
+  wait_default(FALSE)
+  expect_false(getOption(""wait""))
   wait_default(TRUE)
-  expect_true(.sso_env$wait)
+  expect_true(getOption(""wait""))
 
   expect_error(wait_for_finished(m2),NA)
 "
tsahota,NMproject,063187b671fb338e3d71cefa73210cbd409a34c3,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-11-09T12:03:04Z,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-11-09T12:03:04Z,bug fix get_char_field,R/nm.R,False,True,True,False,2,2,4,"---FILE: R/nm.R---
@@ -213,8 +213,8 @@ update_char_field <- function(db_name=""runs.sqlite"",entry,...){
   DBI::dbDisconnect(my_db)
 }
 
-get_char_field <- function(entry,field){
-  my_db <- DBI::dbConnect(RSQLite::SQLite(), ""runs.sqlite"")
+get_char_field <- function(db_name=""runs.sqlite"",entry,field){
+  my_db <- DBI::dbConnect(RSQLite::SQLite(), db_name)
   d <- DBI::dbGetQuery(my_db, paste('SELECT * FROM runs WHERE entry ==',entry))
   DBI::dbDisconnect(my_db)
   d[d$entry %in% entry,][[field]]"
tsahota,NMproject,edf15297babd2bc2e0c4c7d807c06cb103cc7a60,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-11-06T13:19:07Z,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-11-06T13:19:07Z,bug fix,R/nm.R,False,True,True,False,3,3,6,"---FILE: R/nm.R---
@@ -957,8 +957,8 @@ nm_output <- function(r,read_fun=utils::read.csv,dorig,...){
   dol_data <- ctl_nm2r(ctl_content)$DATA
   dol_data <- dol_data[!dol_data %in% """"]
 
-  ignore_present <- grepl("".+IGNORE\\s*=\\s*\\S\\S"",dol_data)
-  accept_present <- grepl("".+ACCEPT\\s*=\\s*\\S\\S"",dol_data)
+  ignore_present <- any(grepl("".+IGNORE\\s*=\\s*\\S\\S"",dol_data))
+  accept_present <- any(grepl("".+ACCEPT\\s*=\\s*\\S\\S"",dol_data))
 
   type <- NA
   if(ignore_present & accept_present) stop(""cannot identify ignore columns"")
@@ -996,7 +996,7 @@ nm_output <- function(r,read_fun=utils::read.csv,dorig,...){
   dorig$PRKEY <- 1:nrow(dorig)
 
   d$INNONMEM <- TRUE
-  
+
   dorig <- dorig[,c(setdiff(names(dorig),names(d)),""PRKEY"")]
 
   d2 <- merge(dorig,d,all.x = TRUE)"
tsahota,NMproject,3c30a06b0f5aed015143741bd1099c0c8614484c,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-11-06T11:20:43Z,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-11-06T11:20:43Z,bug fix,R/nm.R,False,True,True,False,29,21,50,"---FILE: R/nm.R---
@@ -964,25 +964,30 @@ nm_output <- function(r,read_fun=utils::read.csv,dorig,...){
   if(ignore_present & accept_present) stop(""cannot identify ignore columns"")
   if(ignore_present) type <- ""IGNORE""
   if(accept_present) type <- ""ACCEPT""
-
-  filter_statements <- gsub(paste0("".*"",type,""\\s*=\\s*\\(*(\\S[^\\)]+)\\)*.*""),""\\1"",dol_data)
-  filter_statements <- strsplit(filter_statements,"","")[[1]]
-  filter_statements <- gsub(""\\.EQ\\."",""=="",filter_statements)
-  filter_statements <- gsub(""\\.NE\\."",""!="",filter_statements)
-  filter_statements <- gsub(""\\.EQN\\."",""=="",filter_statements)
-  filter_statements <- gsub(""\\.NEN\\."",""!="",filter_statements)
-  filter_statements <- gsub(""\\./E\\."",""!="",filter_statements)
-  filter_statements <- gsub(""\\.GT\\."","">"",filter_statements)
-  filter_statements <- gsub(""\\.LT\\."",""<"",filter_statements)
-  filter_statements <- gsub(""\\.GE\\."","">="",filter_statements)
-  filter_statements <- gsub(""\\.LE\\."",""<="",filter_statements)
-  filter_statements <- paste(filter_statements, collapse= "" & "")
-
-  expre <- parse(text=filter_statements)
-  if(""IGNORE"" %in% type) dORD <- which(!with(dorig,eval(expre)))
-  if(""ACCEPT"" %in% type) dORD <- which(with(dorig,eval(expre)))
-
-  if(length(dORD) != nrow(d)) stop(""something wrong with IGNORE/ACCEPT. debug"")
+  no_filter <- is.na(type)
+
+  if(!no_filter){
+    filter_statements <- paste0("".*"",type,""\\s*=\\s*\\(*(\\S[^\\)]+)\\)*.*"")
+    filter_statements <- gsub(filter_statements,""\\1"",dol_data)
+    filter_statements <- strsplit(filter_statements,"","")[[1]]
+    filter_statements <- gsub(""\\.EQ\\."",""=="",filter_statements)
+    filter_statements <- gsub(""\\.NE\\."",""!="",filter_statements)
+    filter_statements <- gsub(""\\.EQN\\."",""=="",filter_statements)
+    filter_statements <- gsub(""\\.NEN\\."",""!="",filter_statements)
+    filter_statements <- gsub(""\\./E\\."",""!="",filter_statements)
+    filter_statements <- gsub(""\\.GT\\."","">"",filter_statements)
+    filter_statements <- gsub(""\\.LT\\."",""<"",filter_statements)
+    filter_statements <- gsub(""\\.GE\\."","">="",filter_statements)
+    filter_statements <- gsub(""\\.LE\\."",""<="",filter_statements)
+    filter_statements <- paste(filter_statements, collapse= "" & "")
+
+    expre <- parse(text=filter_statements)
+    if(""IGNORE"" %in% type) dORD <- which(!with(dorig,eval(expre)))
+    if(""ACCEPT"" %in% type) dORD <- which(with(dorig,eval(expre)))
+    if(length(dORD) != nrow(d)) stop(""something wrong with IGNORE/ACCEPT. debug"")
+  } else {
+    dORD <- seq_len(nrow(dorig))
+  }
 
   if(""PRKEY"" %in% names(d)) stop(""name conflict with PRKEY in xpose table. aborting..."")
   if(""PRKEY"" %in% names(dorig)) stop(""name conflict with PRKEY in original data. aborting..."")
@@ -991,9 +996,12 @@ nm_output <- function(r,read_fun=utils::read.csv,dorig,...){
   dorig$PRKEY <- 1:nrow(dorig)
 
   d$INNONMEM <- TRUE
+  
+  dorig <- dorig[,c(setdiff(names(dorig),names(d)),""PRKEY"")]
 
-  d <- merge(dorig[,c(setdiff(names(dorig),names(d)),""PRKEY"")],d,all.x=TRUE)
+  d2 <- merge(dorig,d,all.x = TRUE)
+  if(nrow(d2) != nrow(dorig)) stop(""merge went wrong. debug"")
 
-  return(d)
+  return(d2)
 }
 "
tsahota,NMproject,b3488afc464cdbb2799b39a9838ef59b1d410617,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-10-29T11:52:54Z,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-10-29T11:52:54Z,added more informative error message if ext file doesn't exist,R/read_ext.R,False,True,True,False,4,3,7,"---FILE: R/read_ext.R---
@@ -1,13 +1,14 @@
 read_ext0 <- function(ext.file){
   ## Raw function to read in and format an ext.file.
+  if(!file.exists(ext.file)) stop(""ext file for run does not exist yet"",call. = FALSE)
   s <- scan(ext.file,what=""character"",sep=""\n"",quiet = TRUE)
   tab.rows <- grep(""TABLE"",s)
   cut.points <- c(tab.rows,length(s)+1)
-  
+
   headings <- s[tab.rows]
   headings <- gsub(""^TABLE NO.\\s+[0-9]+:\\s"","""",headings)
   headings <- gsub("": Goal.*"","""",headings)
-  
+
   dlist <- lapply(seq_along(tab.rows),function(i){
     if((cut.points[i] + 1)>(cut.points[i + 1] - 1)) return(data.frame())
     d <- s[(cut.points[i]+1):(cut.points[i+1]-1)]
@@ -35,7 +36,7 @@ read_ext0 <- function(ext.file){
 read_ext <- function(r,trans=FALSE){
   d <- read_ext0(r$output$psn.ext)
   if(!trans) return(d)
-  
+
   p_info <- param_info(r$output$psn.mod)
   ## combine d with p
   for(i in seq_len(nrow(p_info))){"
tsahota,NMproject,d37433afbdcdeb843df50f403a47c76c038e7149,Tarjinder Sahota,klgk669@semldxcalvin.seml.astrazeneca.net,2017-10-20T17:03:06Z,Tarjinder Sahota,klgk669@semldxcalvin.seml.astrazeneca.net,2017-10-20T17:03:06Z,made run conflict error easier to read,R/nm.R,False,True,True,False,22,10,32,"---FILE: R/nm.R---
@@ -113,26 +113,31 @@ nm <- function(cmd,psn_command,
     match_info$entry[match_info$overlap_outputs &
                        !(match_info$entry %in% matched_entry)]
 
+  overlapped_output_files <-
+    match_info$overlap_outputs_char[match_info$overlap_outputs &
+                                      !(match_info$entry %in% matched_entry)]
+
   overlapped_run_dir_entries <-
     match_info$entry[match_info$match_run_dir & match_info$match_run_in &
                        !(match_info$entry %in% matched_entry)]
 
-  overlapped_output_entries <- unique(c(overlapped_output_entries,
-                                        overlapped_run_dir_entries))
+  if(length(overlapped_run_dir_entries)>0)
+    stop(""\nThis run has the same run_dir as entry: "",overlapped_run_dir_entries,
+         ""\nFix command and try again"",call. = FALSE)
 
   if(length(overlapped_output_entries)>0){
-    print(utils::str(r$output))
-    stop(""Outputs overlap with entries: "",
-         paste(overlapped_output_entries,collapse="",""),
-         ""\nView runs with: show_runs()"",
-         ""\nDelete old runs with: delete_nm(entry)"",call. = FALSE)
+    stop(""\nThe following outputs would overwrite those from entry "",overlapped_output_entries,
+         "":\n    "",overlapped_output_files,
+         ""\nFix control stream and try again"",
+         ""\n--View runs with: show_runs()"",
+         ""\n--Delete old runs with: delete_nm(entry)"",call. = FALSE)
   }
 
   if(length(matched_entry)==0) {
     nmdb_add_entry(r)
   } else if(length(matched_entry)==1) {
     delete_nm(matched_entry)
-    message(""Overwriting database entry: "",matched_entry)
+    message(""Rewriting database entry: "",matched_entry)
     nmdb_add_entry(r,matched_entry,silent=TRUE)
   } else stop(""Matched more than one database entry. Debug"")
   union_write("".gitignore"",getOption(""nmproj_gitignore""))
@@ -214,11 +219,12 @@ nmdb_match_info <- function(r,db=NULL){
                       match_run_in=logical(),
                       match_run_dir=logical(),
                       match_ctl = logical(),
-                      overlap_outputs=logical()))
+                      overlap_outputs=logical(),
+                      overlap_outputs_char=character()))
 
   if(is.null(db)) d <- nmdb_get() else d <- db
 
-  dproposal <- nmdb_make_db_row(r)
+  #dproposal <- nmdb_make_db_row(r)
 
   ans <- list()
   ans$entry <- d$entry
@@ -233,7 +239,13 @@ nmdb_match_info <- function(r,db=NULL){
   overlap_outputs <- sapply(strsplit(d$output_files,"",""),function(out_filesi){
     length(intersect(out_filesi,unlist(r$output)))>0
   })
+
+  overlap_outputs_char <- sapply(strsplit(d$output_files,"",""),function(out_filesi){
+    paste(intersect(out_filesi,unlist(r$output)),collapse = "", "")
+  })
+
   ans$overlap_outputs <- as.logical(overlap_outputs)
+  ans$overlap_outputs_char <- overlap_outputs_char
 
   ans <- as.data.frame(ans)
   return(ans)"
tsahota,NMproject,429fb869c2f51b8e42df3e41e6e990bc6e7c9e15,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-10-04T11:48:28Z,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-10-04T11:48:28Z,nm() bug fix in ctl inference,R/nm.R,False,True,True,False,1,1,2,"---FILE: R/nm.R---
@@ -65,7 +65,7 @@ nm <- function(cmd,psn_command,
   }
 
   if(is.null(r$ctl)){
-    subcmd <- gsub(paste0(""^.*("",r$type,"".*)$""),""\\1"",cmd)
+    subcmd <- gsub(paste0(""^.*(\\s|^)("",r$type,"".+)$""),""\\2"",cmd)
     matched_ctl <- gsub2(paste0(""^.*("",getOption(""model_file_stub""),""\\S+"",getOption(""model_file_extn""),"")\\s*.*$""),""\\1"",subcmd)
     message(paste(""inferring ctl file :"",matched_ctl))
     r$ctl <- file.path(r$run_in,matched_ctl)"
tsahota,NMproject,ce5642dc8cf5de5defd50a2f4c1f4fab3e2154da,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-09-26T15:00:15Z,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-09-26T15:00:15Z,bug fix,R/nm.R,False,True,True,False,1,1,2,"---FILE: R/nm.R---
@@ -66,7 +66,7 @@ nm <- function(cmd,psn_command,
 
   if(is.null(r$ctl)){
     subcmd <- gsub(paste0(""^.*("",r$type,"".*)$""),""\\1"",cmd)
-    matched_ctl <- gsub2(paste0(""^.*("",getOption(""model_file_stub""),""\\S+)\\s*.*$""),""\\1"",cmd)
+    matched_ctl <- gsub2(paste0(""^.*("",getOption(""model_file_stub""),""\\S+"",getOption(""model_file_extn""),"")\\s*.*$""),""\\1"",subcmd)
     message(paste(""inferring ctl file :"",matched_ctl))
     r$ctl <- file.path(r$run_in,matched_ctl)
   }"
tsahota,NMproject,8432d92c20d0387c16bed305522740208539ecda,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-09-25T21:39:57Z,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-09-25T21:39:57Z,bug fix,R/nm.R,False,True,True,False,5,3,8,"---FILE: R/nm.R---
@@ -109,7 +109,6 @@ nm <- function(cmd,psn_command,
   matched_entry <- match_info$entry[match_info$match_type &
                                       match_info$match_run_in &
                                       match_info$match_ctl]
-
   overlapped_output_entries <-
     match_info$entry[match_info$overlap_outputs &
                        !(match_info$entry %in% matched_entry)]
@@ -121,11 +120,13 @@ nm <- function(cmd,psn_command,
   overlapped_output_entries <- unique(c(overlapped_output_entries,
                                         overlapped_run_dir_entries))
 
-  if(length(overlapped_output_entries)>0)
+  if(length(overlapped_output_entries)>0){
+    print(str(r$output))
     stop(""Outputs overlap with entries: "",
          paste(overlapped_output_entries,collapse="",""),
          ""\nView runs with: show_runs()"",
-         ""\nDelete old runs with: delete_nm(entry)"",call. = FALSE)
+         ""\nDelete old runs with: delete_nm(entry)"",call. = FALSE)    
+  }
 
   if(length(matched_entry)==0) {
     nmdb_add_entry(r)
@@ -899,6 +900,7 @@ nm_output <- function(r,read_fun=read.csv,...){
 
   ctl_content <- readLines(r$ctl)
   dol_data <- ctl_nm2r(ctl_content)$DATA
+  dol_data <- dol_data[!dol_data %in% """"]
 
   # dol_data <- ""dsfslfdkj IGNORE=@ IGNORE=HI.GT.3""
   # dol_data <- ""dsfslfdkj IGNORE=@ IGNORE=(HI.GT.3)"""
tsahota,NMproject,1baa783e408a8b804209e04bd827511de425e0ba,Tarjinder Sahota,klgk669@semldxcalvin.seml.astrazeneca.net,2017-09-25T16:38:37Z,Tarjinder Sahota,klgk669@semldxcalvin.seml.astrazeneca.net,2017-09-25T16:38:37Z,bug fix on extensionless control files,R/nm.R,False,True,True,False,6,3,9,"---FILE: R/nm.R---
@@ -397,9 +397,12 @@ gsub2 <- function(pattern,replacement,x,...){
   gsub(pattern,replacement,x,...)
 }
 
+get_stub_name <- function(file_name) gsub(""(.*)\\..*"",""\\1"",file_name)
+
 get_run_id <- function(ctl_name){
-  match <- paste0(""^.*"",getOption(""model_file_stub""),""(.*)\\..*$"")
-  ans <- gsub2(match,""\\1"",ctl_name)
+  stub_name <- get_stub_name(ctl_name)
+  match <- paste0(""^.*"",getOption(""model_file_stub""),""(.*).*$"")
+  ans <- gsub2(match,""\\1"",stub_name)
   if(length(ans)==0) ans <- NA
   ans
 }
@@ -817,7 +820,7 @@ output_files <- function(run_in,run_type,run_dir,ctl_name){
   r <- list()
   if(run_type %in% ""execute""){
     extn <- tools::file_ext(ctl_name)
-    r$lst <- gsub(""^(.*\\.).*$"",""\\1lst"",ctl_name)
+    r$lst <- paste0(get_stub_name(ctl_name),"".lst"")
     r$psn.mod <- file.path(run_dir,""NM_run1"",""psn.mod"")
     r$psn.lst <- file.path(run_dir,""NM_run1"",""psn.lst"")
     r$psn.ext <- file.path(run_dir,""NM_run1"",""psn.ext"")"
tsahota,NMproject,983982aa3456d735d8bf433901e76bc04fdc5018,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-09-13T21:12:16Z,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-09-13T21:12:16Z,added error message,R/run_record.R,False,True,True,False,1,0,1,"---FILE: R/run_record.R---
@@ -17,6 +17,7 @@ ext2coef <- function(extout,file_name){
 
   d <- reshape2::melt(data = d, variable.name = ""Parameter"",
                       measure.vars = par.names)
+  if(!""Parameter"" %in% names(d)) stop(""melt has failed - could be due to reshape being loaded. reshape can interfere with reshape2"")
   d <- reshape2::dcast(data = d,
                        stats::as.formula(paste(paste(names(d)[!names(d) %in% c(""TYPE"",""value"")],collapse="" + ""),
                                                ""~ TYPE"")),"
tsahota,NMproject,f9fe5db3b6eb4f26ea15fe27beae85affee3b7a2,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-08-30T21:06:35Z,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-08-30T21:06:35Z,bug fix coef if $COV isn't present,R/run_record.R,False,True,True,False,29,23,52,"---FILE: R/run_record.R---
@@ -1,30 +1,30 @@
 ext2coef <- function(extout,file_name){
   ## raw function to generate parameter table from ext.file.
-  
+
   if(!requireNamespace(""reshape2"", quietly = TRUE))
     stop(""reshape2 needed for this function to work. Please install it."",
          call. = FALSE)
-  
+
   d <- extout
-  
+
   d <- d[d$TYPE %in% c(""FINAL"",""SE""),]
   d <- d[d$EST.NO %in% max(d$EST.NO), ]
-  
+
   d <- d[,c(names(d)[grepl(""THETA|SIGMA|OMEGA"",names(d))],
             c(""OBJ"",""EST.NAME"",""EST.NO"",""EVALUATION"",""TYPE""))]
-  
+
   par.names <- names(d)[match(""THETA1"",names(d)):match(""OBJ"",names(d))]
-  
+
   d <- reshape2::melt(data = d, variable.name = ""Parameter"",
                       measure.vars = par.names)
-  d <- reshape2::dcast(data = d, 
+  d <- reshape2::dcast(data = d,
                        stats::as.formula(paste(paste(names(d)[!names(d) %in% c(""TYPE"",""value"")],collapse="" + ""),
                                                ""~ TYPE"")),
                        value.var = ""value"")
-  
+
   d <- d[order(d$EST.NO,decreasing = TRUE),]
   d$file <- file_name
-  
+
   is.diag.omega <- grepl(""OMEGA.([0-9]+\\.)\\1"",d$Parameter)
   is.omega <- grepl(""OMEGA.([0-9]+\\.)+"",d$Parameter)
   is.off.diag.omega <- is.omega & !is.diag.omega
@@ -33,14 +33,14 @@ ext2coef <- function(extout,file_name){
   is.omega <- grepl(""OMEGA.([0-9]+\\.)+"",d$Parameter) ## redefine
   is.off.diag.omega <- is.omega & !is.diag.omega  ## redefine
   ## sort so that THETAs first, then diagonal OMEGAs, then off diag, then SIGMA, then OBJ
-  
+
   par.char <- as.character(d$Parameter)
   par.order <- c(sort(par.char[grepl(""THETA"",par.char)]),
                  sort(par.char[is.diag.omega]),
                  sort(par.char[is.off.diag.omega]),
                  sort(par.char[grepl(""SIGMA"",par.char)]),
                  ""OBJ"")
-  
+
   if(!identical(sort(par.order),sort(as.character(d$Parameter)))) stop(""Bug in code. Debug."")
   d$Parameter <- factor(d$Parameter,levels=par.order)
   d$Type <- NA
@@ -53,6 +53,12 @@ ext2coef <- function(extout,file_name){
   d <- d[order(d$Type),]
   d$Unit <- NA
   d$SEUnit <- NA
+  if(!""SE"" %in% names(d)) {
+    namesd <- names(d)
+    d$SE <- NA
+    final_pos <- grep(""FINAL"",namesd)
+    d <- d[,c(namesd[1:final_pos],""SE"",namesd[(final_pos+1):length(namesd)])]
+  }
   d
 }
 
@@ -72,21 +78,21 @@ coef_ext0 <- function(ext.file){
 #' @export
 
 coef_nm <- function(object,trans,...){
-  
+
   d <- coef_ext0(object$output$psn.ext)
   d$file <- object$ctl
   if(!trans) return(d)
-  
+
   p <- object$param_info
-  
+
   p$Parameter <- paste0(""THETA"",p$N)
   ## TODO: read parameter names from $OMEGA
   ## either $OMEGA in same way as $THETA (but without units in comments)
   ## or $OMEGA BLOCK
-  
+
   d0 <- d[,names(d)[!names(d) %in% ""Unit""]]
   d1 <- p[,c(""Name"",""Parameter"",""Unit"",""trans"")]
-  
+
   d <- merge(d0,d1,all.x = TRUE,by=""Parameter"")
   d$Name[is.na(d$Name)] <- as.character(d$Parameter)[is.na(d$Name)]
   d$Name <- factor(d$Name,levels=d$Name)
@@ -157,7 +163,7 @@ coef_nm <- function(object,trans,...){
   #   }
   #
   # }
-  
+
   ## get names back to what they should be
   d$FINAL <- d$FINAL.TRANS
   d$FINAL.TRANS <- NULL
@@ -170,12 +176,12 @@ coef_nm <- function(object,trans,...){
   d$Parameter <- d$Name
   d$Name <- NULL
   d
-  
+
 }
 
 #' @export
 coef.nm <- function(object,...){
-  
+
   trans_arg <- list(...)$trans
   if(is.null(trans_arg)) {
     trans <- TRUE
@@ -197,11 +203,11 @@ run_record0 <- function(..., coef.func = coef_ext0){
   d$Estimate[d$Parameter!=""OBJ""] <- paste0(signif(d$FINAL[d$Parameter!=""OBJ""],3),"" ("",signif(d$SE[d$Parameter!=""OBJ""],3),d$SEUnit[d$Parameter!=""OBJ""],"")"")
   d$Estimate[d$Parameter==""OBJ""] <- round(d$FINAL[d$Parameter==""OBJ""],3)
   d <- d[,names(d)[!names(d) %in% c(""SE"",""FINAL"")]]
-  d <- reshape2::dcast(data = d, 
+  d <- reshape2::dcast(data = d,
                        stats::as.formula(paste(paste(names(d)[!names(d) %in% c(""file"",""Estimate"")],collapse="" + ""),
                                                ""~ file"")),
                        value.var = ""Estimate"")
-  
+
   d <- d[order(d$Type,d$Parameter),]
   d$SEUnit <- NULL
   d
@@ -217,7 +223,7 @@ run_record0 <- function(..., coef.func = coef_ext0){
 run_record <- function(...,trans=TRUE){
   a <- list(...)
   classes <- sapply(a,function(a) inherits(a,""nm""))
-  
+
   if(any(classes)){
     coef.func <- coef_nm
     formals(coef.func)$trans <- trans
@@ -226,7 +232,7 @@ run_record <- function(...,trans=TRUE){
   }
   run_record.tmp <- function(...) run_record0(...,coef.func=coef.func)
   do.call(run_record.tmp,a)
-  
+
 }
 
 run_summary <- function(r){"
tsahota,NMproject,f99d6441a3ed93b9d281d49ea2eb8fcacb67ccbb,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-08-24T15:19:15Z,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-08-24T15:20:03Z,made db error message more informative,R/nm.R,False,True,True,False,1,1,2,"---FILE: R/nm.R---
@@ -326,7 +326,7 @@ nmdb_get <- function(readable=FALSE){
   },
   error=function(e) {
     if(DBI::dbIsValid(my_db)) DBI::dbDisconnect(my_db)
-    stop(e)
+    stop(paste(e,""\nruns.sqlite may be corrupted.\nConsider deleting and rebuilding""),call. = FALSE)
   })
 }
 "
tsahota,NMproject,e53d5e92c43719015e17a51c60f50e2d6fcc5183,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-07-06T15:46:14Z,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-07-06T15:46:14Z,bug fixes,R/ctl_handling.R;inst/extdata/shiny/server.R;tests/testthat/test-nm.R,False,True,True,False,39,41,80,"---FILE: R/ctl_handling.R---
@@ -17,22 +17,22 @@ setup_dollar <- function(x,type){
 #' @return object of class r.ctl
 #' @export
 ctl_nm2r <- function(ls){
-  
+
   ls0 <- ls
   dol <- grep(""^\\s*\\$"",ls)
   dol <- which(is_dollar_line(ls))
   dol[1] <- 1
-  
+
   ## get type info for each dol
-  
+
   dol.type <- function(ls){
     sc <- paste(ls,collapse = "" "")
     type <- gsub(""^[^\\$]*\\$([\\S]+).*$"",""\\1"",sc, perl = TRUE)
     type <- getOption(""available_nm_types"")[grep(substr(type,1,3),getOption(""available_nm_types""))]
     if(length(type)==0) type <- NA
     type
   }
-  
+
   ls2 <- list()
   start <- dol[1]
   finish <- dol[2]-1
@@ -60,12 +60,12 @@ ctl_nm2r <- function(ls){
     ls2[[i]] <- tmp
   }
   ls <- ls2
-  
+
   x <- sapply(ls,function(s)class(s))
-  
+
   ## find consecutive statements and combine them
   ## can use a for loop
-  
+
   for(i in rev(seq_along(x))){
     if(i==1) break
     if(x[i]==x[i-1]) {
@@ -91,6 +91,7 @@ ctl_r2nm <- function(x) unlist(x,use.names = FALSE)
 #' @export
 theta_nm2r <- function(x){
   x <- rem_dollars(x)
+  x <- gsub(""FIX"","""",x) ## ignore FIX for now
   x <- x[!grepl(""^\\s*$"",x)]
   x <- gsub(""\\t"","" "",x)
   x <- x[!grepl(""^\\s*;.*"",x)]
@@ -101,7 +102,7 @@ theta_nm2r <- function(x){
   x <- gsub(""\\("",""\\(~"",x)
   x <- strsplit(x,""\\(|\\)"")[[1]]
   x <- x[!grepl(""^\\s*$"",x)]
-  
+
   x <- lapply(x,function(x){
     if(substr(x,1,1)!=""~""){
       x <- strsplit(x,""[ ,]"")[[1]]
@@ -125,12 +126,12 @@ theta_nm2r <- function(x){
   x$N <- 1:nrow(x)
   class(x) <- c(class(x),""r.theta"")
   comments <- get_comment(x0,"";"")
-  
+
   if(length(comments) > max(x$N)) {
     warning(""More comments than THETAs found. Something wrong"")
     comments <- rep("""",max(x$N))
   }
-  
+
   tmp <- strsplit(comments,"";"")
   x$Name <- sapply(tmp,""["",1)
   x$Name <- rem_trailing_spaces(x$Name)

---FILE: inst/extdata/shiny/server.R---
@@ -14,7 +14,7 @@ get_plot_bootstrapjs_div <- function(plot_object_list) {
   #### local_function
   get_col_div <- function(plot_object_list, index, css_class = 'col-xs-12 col-sm-4')  {
     col_div <- div(class = css_class)
-    
+
     if(length(plot_object_list) >= index) {
       plotname <- paste(""plot"", index, sep="""")
       plot_output_object <- dygraphOutput(plotname)
@@ -25,7 +25,7 @@ get_plot_bootstrapjs_div <- function(plot_object_list) {
   #
   get_plot_div <- function(plot_object_list) {
     result_div <- div(class = 'container-fluid')
-    
+
     suppressWarnings(for(i in seq(1,length(plot_object_list),3)) {
       row_div <- div(class = 'row')
       row_div <- tagAppendChild(row_div, get_col_div(plot_object_list, i))
@@ -37,7 +37,7 @@ get_plot_bootstrapjs_div <- function(plot_object_list) {
   }
   ####
   plot_output_list_div <- get_plot_div(plot_object_list)
-  
+
   return(plot_output_list_div)
 }
 
@@ -52,13 +52,13 @@ function(input, output, session) {
                  searching=TRUE,
                  filtering=TRUE,
                  ordering=TRUE))
-  
+
   objects <- eventReactive(input$run_table_rows_selected,{
     orig.dir <- getwd();  setwd(.currentwd) ; on.exit(setwd(orig.dir))
     row <- input$run_table_rows_selected
     lapply(new_table()$entry[row],extract_nm)
   })
-  
+
   output$runs_selected_info <- renderTable({
     if(length(input$run_table_rows_selected)==0) return(data.frame())
     new_table()[input$run_table_rows_selected,c(""entry"",""type"",""ctl"")]
@@ -67,7 +67,7 @@ function(input, output, session) {
     if(length(input$run_table_rows_selected)==0) return(data.frame())
     new_table()[input$run_table_rows_selected,c(""entry"",""type"",""ctl"")]
   })
-  
+
   observe({
     output$selected_runs <- renderText({
       pretext <- ""Select run(s):""
@@ -76,7 +76,7 @@ function(input, output, session) {
       paste(pretext,paste(entries,collapse = "",""))
     })
   })
-  
+
   observeEvent(input$go_to_monitor, {
     if(length(input$run_table_rows_selected)==0)
       return(showModal(modalDialog(
@@ -85,7 +85,7 @@ function(input, output, session) {
       )))
     updateNavbarPage(session, ""mainPanel"", selected = ""monitor"")
   })
-  
+
   observeEvent(input$go_to_results, {
     if(length(input$run_table_rows_selected)==0)
       return(showModal(modalDialog(
@@ -94,15 +94,15 @@ function(input, output, session) {
       )))
     updateNavbarPage(session, ""mainPanel"", selected = ""results"")
   })
-  
+
   observeEvent(input$back_to_db, {
     updateNavbarPage(session, ""mainPanel"", selected = ""database"")
   })
-  
+
   observeEvent(input$back_to_db2, {
     updateNavbarPage(session, ""mainPanel"", selected = ""database"")
   })
-  
+
   observeEvent(input$run_job, {
     if(length(input$run_table_rows_selected)==0)
       return(showModal(modalDialog(
@@ -124,18 +124,18 @@ function(input, output, session) {
       }
     })
   })
-  
+
   ## run monitor
-  
+
   output$monitor_select_warning <- renderText({
     if(length(input$run_table_rows_selected)>1) return(""Warning: will only monitor first"")
     if(length(input$run_table_rows_selected)==0) return(""Warning: no runs selected"")
   })
-  
+
   output$results_select_warning <- renderText({
     if(length(input$run_table_rows_selected)==0) return(""Warning: no runs selected"")
   })
-  
+
   status_ob <- eventReactive(
     list(input$refresh_status,
          input$run_table_rows_selected,
@@ -144,11 +144,11 @@ function(input, output, session) {
            object <- objects()[[1]]
            status(object)$status
          })
-  
+
   output$status <- renderText({
     status_ob()
   })
-  
+
   tail_ob <- reactivePoll(1000, session,
                           # This function returns the time that log_file was last modified
                           checkFunc = function(){
@@ -165,21 +165,22 @@ function(input, output, session) {
                             tail_lst(object)
                           }
   )
-  
+
   output$tail_lst <- renderUI({
     tail_ob <- tail_ob()
     tail_ob <- do.call(paste,c(as.list(tail_ob),sep='<br/>'))
     HTML(tail_ob)
   })
-  
+
   plot_iter_ob <- eventReactive(
     list(input$refresh_plot,
          input$run_table_rows_selected),{
            orig.dir <- getwd();  setwd(.currentwd) ; on.exit(setwd(orig.dir))
            object <- objects()[[1]]
            if(is.null(object$output$psn.ext)) return(dygraph(data.frame(x=0,y=0)))
            if(!file.exists(object$output$psn.ext)) return(dygraph(data.frame(x=0,y=0)))
-           d <- plot_iter_data(object,trans = input$trans, skip = 0)
+           d <- try(plot_iter_data(object,trans = input$trans, skip = 0),silent=TRUE)
+           if(inherits(d,""try-error"")) return(dygraph(data.frame(x=0,y=0)))
            p <- list()
            for(i in seq_along(unique(d$variable))){
              var_name <- unique(d$variable)[i]
@@ -191,16 +192,11 @@ function(input, output, session) {
            p
          }
   )
-  
+
   output$distPlot <- renderUI({
     get_plot_bootstrapjs_div(plot_iter_ob())
-    #plot_output_list <- lapply(seq_along(plot_iter_ob()), function(i){
-    #  plotname <- paste(""plot"", i, sep="""")
-    #  dygraphOutput(plotname)
-    #})
-    #do.call(tagList, plot_output_list)
   })
-  
+
   observe(
     for (i in 1:50) {
       local({
@@ -212,7 +208,7 @@ function(input, output, session) {
       })
     }
   )
-  
+
   ## run record
   run_record_ob <- eventReactive(
     list(input$refresh_run_record,
@@ -223,13 +219,13 @@ function(input, output, session) {
                       data.frame()
                     })
          })
-  
+
   output$run_record <- DT::renderDataTable({
     run_record_ob()
   },rownames = FALSE,options = list(paging=FALSE,
                                     searching=FALSE,
                                     filtering=FALSE,
                                     ordering=TRUE))
-  
+
 }
 

---FILE: tests/testthat/test-nm.R---
@@ -1,7 +1,7 @@
+require(tidyproject)
 context(""nm function works"")
 
 proj_name <- ""test_nmproject""
-require(tidyproject)
 
 cleanup <- function(proj_name){
   if(file.exists(proj_name)) unlink(proj_name,recursive = TRUE,force = TRUE)
@@ -60,3 +60,4 @@ test_that(""nm function works"",{
   expect_true(identical(as.numeric(m5$run_id),1))
 
 })
+"
tsahota,NMproject,c5170c3fe8214c75544c508d77b59271503c58c8,Tarj Sahota,t.sahota0@gmail.com,2017-06-20T00:26:18Z,Tarj Sahota,t.sahota0@gmail.com,2017-06-20T00:26:18Z,nm example bug fixes,R/ctl_handling.R;R/nm.R;R/read_ext.R;R/run_record.R;inst/extdata/shiny/server.R,False,True,True,False,64,42,106,"---FILE: R/ctl_handling.R---
@@ -17,22 +17,22 @@ setup_dollar <- function(x,type){
 #' @return object of class r.ctl
 #' @export
 ctl_nm2r <- function(ls){
-
+  
   ls0 <- ls
   dol <- grep(""^\\s*\\$"",ls)
   dol <- which(is_dollar_line(ls))
   dol[1] <- 1
-
+  
   ## get type info for each dol
-
+  
   dol.type <- function(ls){
     sc <- paste(ls,collapse = "" "")
     type <- gsub(""^[^\\$]*\\$([\\S]+).*$"",""\\1"",sc, perl = TRUE)
     type <- getOption(""available_nm_types"")[grep(substr(type,1,3),getOption(""available_nm_types""))]
     if(length(type)==0) type <- NA
     type
   }
-
+  
   ls2 <- list()
   start <- dol[1]
   finish <- dol[2]-1
@@ -60,12 +60,12 @@ ctl_nm2r <- function(ls){
     ls2[[i]] <- tmp
   }
   ls <- ls2
-
+  
   x <- sapply(ls,function(s)class(s))
-
+  
   ## find consecutive statements and combine them
   ## can use a for loop
-
+  
   for(i in rev(seq_along(x))){
     if(i==1) break
     if(x[i]==x[i-1]) {
@@ -93,14 +93,15 @@ theta_nm2r <- function(x){
   x <- rem_dollars(x)
   x <- x[!grepl(""^\\s*$"",x)]
   x <- gsub(""\\t"","" "",x)
+  x <- x[!grepl(""^\\s*;.*"",x)]
   x0 <- x
   x <- rem_comment(x,"";"")
   x <- paste(x,collapse = "" "")
   x <- gsub(""\\(\\s*\\S*(\\s*)\\S*(\\s\\)S*\\s)\\)"",""\\(~"",x)
   x <- gsub(""\\("",""\\(~"",x)
   x <- strsplit(x,""\\(|\\)"")[[1]]
   x <- x[!grepl(""^\\s*$"",x)]
-
+  
   x <- lapply(x,function(x){
     if(substr(x,1,1)!=""~""){
       x <- strsplit(x,""[ ,]"")[[1]]
@@ -124,12 +125,12 @@ theta_nm2r <- function(x){
   x$N <- 1:nrow(x)
   class(x) <- c(class(x),""r.theta"")
   comments <- get_comment(x0,"";"")
-
+  
   if(length(comments) > max(x$N)) {
     warning(""More comments than THETAs found. Something wrong"")
     comments <- rep("""",max(x$N))
   }
-
+  
   tmp <- strsplit(comments,"";"")
   x$Name <- sapply(tmp,""["",1)
   x$Name <- rem_trailing_spaces(x$Name)
@@ -179,6 +180,7 @@ theta_r2nm <- function(x){
 param_info <- function(ctl_name){
   ctl <- readLines(ctl_name)
   ctl <- ctl_nm2r(ctl)
-  theta_nm2r(ctl$THETA)
+  if(""THETA"" %in% names(ctl)) return(theta_nm2r(ctl$THETA)) else
+    return(data.frame())
 }
 

---FILE: R/nm.R---
@@ -255,6 +255,7 @@ nmdb_make_db_row <- function(r,add_cols=list()){
       d$run_status <- ""not run""
   status_ob <- list()
   status_ob$status <- d$run_status
+  if(d$run_status %in% ""dir exists"") status_ob$seen_at <- Sys.time()
   d$run_status_ob <- I(list(serialize(status_ob,NULL)))
   name_order <- names(d)
   if(length(add_cols)>0){
@@ -528,14 +529,31 @@ run_status <- function(r,db,entry,initial_timeout=NA){
   execution_dirs <- unique(execution_dirs)
   
   if(length(execution_dirs) == 0) {
-    if(status_ob_prev$status %in% c(""dir exists"")) {
+    if(status_ob_prev$status %in% c(""error"")) {
       return(status_ob_prev)
-    } else {
-      status_ob$status <- ""dir exists""
-      update_object_field(matched_entry,run_status_ob=status_ob)
-      update_char_field(matched_entry,run_status=status_ob$status)
-      return(status_ob)
     }
+    if(status_ob_prev$status %in% c(""dir exists"")) {
+      test_timeout <- FALSE
+      if(!is.na(initial_timeout)){
+        timediff <- difftime(Sys.time(),status_ob_prev$seen_at,units = ""secs"")
+        if(timediff > initial_timeout)
+          test_timeout <- TRUE
+      }
+      if(test_timeout) {
+        status_ob <- status_ob_prev
+        status_ob$status <- ""error""
+        update_object_field(matched_entry,run_status_ob=status_ob)
+        update_char_field(matched_entry,run_status=status_ob$status)
+        return(status_ob)
+      } else {
+        return(status_ob_prev)
+      } 
+    }
+    status_ob$status <- ""dir exists""
+    status_ob$seen_at <- Sys.time()
+    update_object_field(matched_entry,run_status_ob=status_ob)
+    update_char_field(matched_entry,run_status=status_ob$status)
+    return(status_ob)
   }
   
   lst_names <- file.path(execution_dirs,""psn.lst"")

---FILE: R/read_ext.R---
@@ -3,11 +3,11 @@ read_ext0 <- function(ext.file){
   s <- scan(ext.file,what=""character"",sep=""\n"",quiet = TRUE)
   tab.rows <- grep(""TABLE"",s)
   cut.points <- c(tab.rows,length(s)+1)
-
+  
   headings <- s[tab.rows]
   headings <- gsub(""^TABLE NO.\\s+[0-9]+:\\s"","""",headings)
   headings <- gsub("": Goal.*"","""",headings)
-
+  
   dlist <- lapply(seq_along(tab.rows),function(i){
     if((cut.points[i] + 1)>(cut.points[i + 1] - 1)) return(data.frame())
     d <- s[(cut.points[i]+1):(cut.points[i+1]-1)]
@@ -16,7 +16,9 @@ read_ext0 <- function(ext.file){
     d <- utils::read.table(tmp,header=TRUE)
     d$EST.NO <- i
     d$EST.NAME <- headings[i]
-    names(d)[names(d)%in%""SAEMOBJ""] <- ""OBJ""
+    match_obj <- grepl(""OBJ$"",names(d))
+    if(length(which(match_obj))>1) stop(""more than one OBJ column. debug"")
+    names(d)[match_obj] <- ""OBJ""
     d$OBJ <- as.numeric(as.character(d$OBJ))
     d$TYPE <- NA
     d$TYPE[d$ITERATION>=0] <- ""ITER""
@@ -33,12 +35,12 @@ read_ext0 <- function(ext.file){
 read_ext <- function(r,trans=FALSE){
   d <- read_ext0(r$output$psn.ext)
   if(!trans) return(d)
-
+  
   p_info <- param_info(r$output$psn.mod)
   ## combine d with p
   for(i in seq_len(nrow(p_info))){
     pi <- p_info[i,]
-    names(d)[names(d) %in% pi$Parameter] <- pi$Name
+    names(d)[names(d) %in% pi$Parameter & !is.na(pi$Name)] <- pi$Name
     if(pi$trans %in% c(""LOG"",""LOGODDS"")){
       d[,pi$Name][d$ITERATION>-1000000000] <- exp(d[,pi$Name][d$ITERATION>-1000000000])
     } else if (pi$trans %in% ""LOGIT"") {

---FILE: R/run_record.R---
@@ -4,27 +4,27 @@ ext2coef <- function(extout,file_name){
   if(!requireNamespace(""reshape2"", quietly = TRUE))
     stop(""reshape2 needed for this function to work. Please install it."",
          call. = FALSE)
-
+  
   d <- extout
-
+  
   d <- d[d$TYPE %in% c(""FINAL"",""SE""),]
   d <- d[d$EST.NO %in% max(d$EST.NO), ]
-
+  
   d <- d[,c(names(d)[grepl(""THETA|SIGMA|OMEGA"",names(d))],
             c(""OBJ"",""EST.NAME"",""EST.NO"",""EVALUATION"",""TYPE""))]
-
+  
   par.names <- names(d)[match(""THETA1"",names(d)):match(""OBJ"",names(d))]
   
   d <- reshape2::melt(data = d, variable.name = ""Parameter"",
                       measure.vars = par.names)
   d <- reshape2::dcast(data = d, 
                        stats::as.formula(paste(paste(names(d)[!names(d) %in% c(""TYPE"",""value"")],collapse="" + ""),
-                                        ""~ TYPE"")),
+                                               ""~ TYPE"")),
                        value.var = ""value"")
   
   d <- d[order(d$EST.NO,decreasing = TRUE),]
   d$file <- file_name
-
+  
   is.diag.omega <- grepl(""OMEGA.([0-9]+\\.)\\1"",d$Parameter)
   is.omega <- grepl(""OMEGA.([0-9]+\\.)+"",d$Parameter)
   is.off.diag.omega <- is.omega & !is.diag.omega
@@ -33,14 +33,14 @@ ext2coef <- function(extout,file_name){
   is.omega <- grepl(""OMEGA.([0-9]+\\.)+"",d$Parameter) ## redefine
   is.off.diag.omega <- is.omega & !is.diag.omega  ## redefine
   ## sort so that THETAs first, then diagonal OMEGAs, then off diag, then SIGMA, then OBJ
-
+  
   par.char <- as.character(d$Parameter)
   par.order <- c(sort(par.char[grepl(""THETA"",par.char)]),
                  sort(par.char[is.diag.omega]),
                  sort(par.char[is.off.diag.omega]),
                  sort(par.char[grepl(""SIGMA"",par.char)]),
                  ""OBJ"")
-
+  
   if(!identical(sort(par.order),sort(as.character(d$Parameter)))) stop(""Bug in code. Debug."")
   d$Parameter <- factor(d$Parameter,levels=par.order)
   d$Type <- NA
@@ -72,21 +72,21 @@ coef_ext0 <- function(ext.file){
 #' @export
 
 coef_nm <- function(object,trans,...){
-
+  
   d <- coef_ext0(object$output$psn.ext)
   d$file <- object$ctl
   if(!trans) return(d)
-
+  
   p <- object$param_info
-
+  
   p$Parameter <- paste0(""THETA"",p$N)
   ## TODO: read parameter names from $OMEGA
   ## either $OMEGA in same way as $THETA (but without units in comments)
   ## or $OMEGA BLOCK
-
+  
   d0 <- d[,names(d)[!names(d) %in% ""Unit""]]
   d1 <- p[,c(""Name"",""Parameter"",""Unit"",""trans"")]
-
+  
   d <- merge(d0,d1,all.x = TRUE,by=""Parameter"")
   d$Name[is.na(d$Name)] <- as.character(d$Parameter)[is.na(d$Name)]
   d$Name <- factor(d$Name,levels=d$Name)
@@ -157,7 +157,7 @@ coef_nm <- function(object,trans,...){
   #   }
   #
   # }
-
+  
   ## get names back to what they should be
   d$FINAL <- d$FINAL.TRANS
   d$FINAL.TRANS <- NULL
@@ -170,12 +170,12 @@ coef_nm <- function(object,trans,...){
   d$Parameter <- d$Name
   d$Name <- NULL
   d
-
+  
 }
 
 #' @export
 coef.nm <- function(object,...){
-
+  
   trans_arg <- list(...)$trans
   if(is.null(trans_arg)) {
     trans <- TRUE
@@ -199,7 +199,7 @@ run_record0 <- function(..., coef.func = coef_ext0){
   d <- d[,names(d)[!names(d) %in% c(""SE"",""FINAL"")]]
   d <- reshape2::dcast(data = d, 
                        stats::as.formula(paste(paste(names(d)[!names(d) %in% c(""file"",""Estimate"")],collapse="" + ""),
-                                        ""~ file"")),
+                                               ""~ file"")),
                        value.var = ""Estimate"")
   
   d <- d[order(d$Type,d$Parameter),]
@@ -217,7 +217,7 @@ run_record0 <- function(..., coef.func = coef_ext0){
 run_record <- function(...,trans=TRUE){
   a <- list(...)
   classes <- sapply(a,function(a) inherits(a,""nm""))
-
+  
   if(any(classes)){
     coef.func <- coef_nm
     formals(coef.func)$trans <- trans
@@ -226,7 +226,7 @@ run_record <- function(...,trans=TRUE){
   }
   run_record.tmp <- function(...) run_record0(...,coef.func=coef.func)
   do.call(run_record.tmp,a)
-
+  
 }
 
 run_summary <- function(r){

---FILE: inst/extdata/shiny/server.R---
@@ -142,7 +142,7 @@ function(input, output, session) {
          plot_iter_ob),{
            orig.dir <- getwd();  setwd(.currentwd) ; on.exit(setwd(orig.dir))
            object <- objects()[[1]]
-           status(object)
+           status(object)$status
          })
   
   output$status <- renderText({"
tsahota,NMproject,cfabfd6d49d3f532af458aeab1ba59384d0bf600,Tarj Sahota,t.sahota0@gmail.com,2017-06-18T11:24:02Z,Tarj Sahota,t.sahota0@gmail.com,2017-06-18T11:34:18Z,bug fixes,R/nm.R,False,True,True,False,47,47,94,"---FILE: R/nm.R---
@@ -17,11 +17,11 @@ nm <- function(cmd,psn_command,
   tidyproject::check_if_tidyproject()
   r <- list()
   class(r) <- ""nm""
-
+  
   if(is.null(run_in)) run_in <- "".""
   r$run_in <- run_in
   r$cmd <- cmd
-
+  
   if(!missing(shell_script_name)){
     if(!file.exists(file.path(r$run_in,shell_script_name)))
       stop(""cannot find shell script in "",r$run_in,"" directory"",call. = FALSE)
@@ -44,14 +44,14 @@ nm <- function(cmd,psn_command,
   }
   ## cmd is now set
   cmd <- paste(cmd,collapse = "" "")
-
+  
   if(!missing(psn_command)) r$type <- psn_command
   if(!missing(ctl_name)) {
     if(any(!file.exists(file.path(r$run_in,ctl_name))))
       stop(paste(ctl_name,collapse = "",""),"" do(es) not exist"",call. = FALSE)
     r$ctl <- file.path(r$run_in,ctl_name)
   }
-
+  
   if(is.null(r$type)){
     matched_psn_commands <- unlist(sapply(getOption(""psn.commands""),
                                           function(i) gsub2(paste0(""^.*("",i,"")\\b\\s.+$""),""\\1"",cmd)))
@@ -63,14 +63,14 @@ nm <- function(cmd,psn_command,
     message(paste(""inferring run type :"",matched_psn_commands))
     r$type <- matched_psn_commands
   }
-
+  
   if(is.null(r$ctl)){
     subcmd <- gsub(paste0(""^.*("",r$type,"".*)$""),""\\1"",cmd)
     matched_ctl <- gsub2(paste0(""^.*("",getOption(""model_file_stub""),""\\S+)\\s*.*$""),""\\1"",cmd)
     message(paste(""inferring ctl file :"",matched_ctl))
     r$ctl <- file.path(r$run_in,matched_ctl)
   }
-
+  
   if(missing(run_dir)){
     matched_run_dir <-
       gsub2(paste0(""^.*-dir[a-z]*=\\s*(\\S*)\\s*.*$""),""\\1"",cmd)
@@ -81,52 +81,52 @@ nm <- function(cmd,psn_command,
     message(paste(""inferring run directory :"",matched_run_dir))
     r$run_dir <- file.path(r$run_in,matched_run_dir)
   } else r$run_dir <- run_dir
-
+  
   if(missing(run_id)){
     matched_run_id <- get_run_id(r$ctl[1])
     if(length(matched_run_id)==0)
       stop(""couldn't infer run id type.\nRerun with run_id argument"",call. = FALSE)
     r$run_id <- matched_run_id
   } else r$run_id <- run_id
-
+  
   if(!file.exists(r$ctl)) stop(paste(""cannot find model file:"",r$ctl),call. = FALSE)
   ## class for execute runs
   class(r) <- c(paste0(""nm"",r$type),class(r))
-
+  
   r$input <- input_files(run_type = r$type,ctl_name = r$ctl)
   r$output <- output_files(run_in = r$run_in,
                            run_type = r$type,
                            run_dir = r$run_dir,
                            ctl_name = r$ctl)
-
+  
   if(r$type %in% ""execute"") r$param_info <- param_info(r$ctl)
-
+  
   r$description <- tidyproject::get_script_field(r$ctl,""Description"")
-
+  
   ####
-
+  
   match_info <- nmdb_match_info(r)
   matched_entry <- match_info$entry[match_info$match_type &
                                       match_info$match_run_in &
                                       match_info$match_ctl]
-
+  
   overlapped_output_entries <-
     match_info$entry[match_info$overlap_outputs &
                        !(match_info$entry %in% matched_entry)]
-
+  
   overlapped_run_dir_entries <-
     match_info$entry[match_info$match_run_dir & match_info$match_run_in &
                        !(match_info$entry %in% matched_entry)]
-
+  
   overlapped_output_entries <- unique(c(overlapped_output_entries,
                                         overlapped_run_dir_entries))
-
+  
   if(length(overlapped_output_entries)>0)
     stop(""Outputs overlap with entries: "",
          paste(overlapped_output_entries,collapse="",""),
          ""\nView runs with: show_runs()"",
          ""\nDelete old runs with: delete_nm(entry)"",call. = FALSE)
-
+  
   if(length(matched_entry)==0) {
     nmdb_add_entry(r)
   } else if(length(matched_entry)==1) {
@@ -135,11 +135,13 @@ nm <- function(cmd,psn_command,
     nmdb_add_entry(r,matched_entry,silent=TRUE)
   } else stop(""Matched more than one database entry. Debug"")
   union_write("".gitignore"",getOption(""nmproj_gitignore""))
+  ## last step: update run_status in db
+  run_status(r)
   return(r)
 }
 
 nmdb_match_entry <- function(r,db=NULL){
-
+  
   match_info <- nmdb_match_info(r,db=db)
   matched_entry <- match_info$entry[match_info$match_type &
                                       match_info$match_run_in &
@@ -295,13 +297,13 @@ nmdb_add_entry <- function(r,entry=NULL,silent=FALSE,...){
       DBI::dbWriteTable(my_db, ""runs"", dempty)
     }
     d <- DBI::dbGetQuery(my_db, 'SELECT * FROM runs')
-
+    
     if(nrow(d)==0) new_entry <- 1 else
       if(!is.null(entry)) new_entry <- entry else
         new_entry <- max(d$entry) + 1
-
+    
     dnew <- cbind(data.frame(entry=new_entry),dnew)
-
+    
     if(!silent) message(""Creating database entry: "",new_entry)
     DBI::dbWriteTable(my_db, ""runs"", dnew, append=TRUE)
     DBI::dbDisconnect(my_db)
@@ -384,13 +386,13 @@ get_run_id <- function(ctl_name){
 #' @param update_db logical (default=FALSE). Should run_status be updated
 #' @export
 run <- function(...,overwrite=.sso_env$run_overwrite,delete_dir=c(NA,TRUE,FALSE),wait=.sso_env$wait,
-                   update_db=TRUE){
+                update_db=TRUE){
   UseMethod(""run"")
 }
 
 #' @export
 run.nm <- function(...,overwrite=.sso_env$run_overwrite,delete_dir=c(NA,TRUE,FALSE),wait=.sso_env$wait,
-                update_db=TRUE){
+                   update_db=TRUE){
   tidyproject::check_if_tidyproject()
   rl <- list(...)
   lapply(rl,function(r){
@@ -416,25 +418,25 @@ run.nm <- function(...,overwrite=.sso_env$run_overwrite,delete_dir=c(NA,TRUE,FAL
 wait_for_finished <- function(...){
   rl <- list(...)
   message(""Waiting for jobs:\n"",paste(sapply(rl,function(i)paste0("" "",i$type,"":"",i$ctl)),collapse = ""\n""))
-
+  
   i <- 0
   while(length(rl)>0){
     j <- (i %% length(rl))+1
     r <- rl[[j]]
     ######################################
     ## apply finishing test(s) here
-
+    
     finished <- nm_steps_finished(r)
     last_update <- last_modified(r)
-
+    
     if(finished){ ## check again in 5 seconds
       if(r$type != ""execute"") Sys.sleep(5) else Sys.sleep(1)
       finished2 <- nm_steps_finished(r)
       last_update2 <- last_modified(r)
       ## if it is still finished and last_update is still the same then finish
       finished <- finished2 & identical(last_update,last_update2)
     }
-
+    
     ######################################
     if(finished){
       rl[[j]] <- NULL
@@ -446,7 +448,7 @@ wait_for_finished <- function(...){
   invisible()
 }
 
-run_status <- function(r){ # for db
+run_status <- function(r){
   ## logic:
   ## if file.mtime(r$run_dir) ==  same use status_prev
   ## if file.mtime(r$run_dir) !=  same
@@ -466,9 +468,6 @@ run_status <- function(r){ # for db
   
   run_dir_time <- file.mtime(r$run_dir)
   
-  if(identical(run_dir_time,run_dir_time_prev))
-    return(status_prev)
-  
   #####
   ## assume directory exists and there is something new
   ## get sub run info
@@ -479,7 +478,6 @@ run_status <- function(r){ # for db
                                 full.names = TRUE))
   execution_dirs <- unique(execution_dirs)
   
-  update_object_field(matched_entry,run_dir_mtime=file.mtime(r$run_dir))
   if(length(execution_dirs) == 0) return(""dir exists"")
   
   lst_names <- file.path(execution_dirs,""psn.lst"")
@@ -496,8 +494,11 @@ run_status <- function(r){ # for db
   sub_run_status_prev <- get_object_field(matched_entry,""sub_run_status"")
   #sub_run_status_prev <- unserialize(db$sub_run_status[db$entry %in% matched_entry][[1]])
   sub_run_status_prev <- sub_run_status_prev[sub_run_name_order]
-
+  
   ## go through lst_mtimes, and check if there needs to be an update
+  name_checked_before <- lst_names %in% names(sub_run_mtime_prev)
+  #mtime_updated <- !lst_mtimes %in% sub_run_mtime_prev[]
+  
   recheck_lst <- sapply(seq_along(lst_mtimes),function(i){
     if(!lst_names[i] %in% names(sub_run_mtime_prev)) return(TRUE)
     if(lst_mtimes[i]!=sub_run_mtime_prev[lst_names[i]]) return(TRUE)
@@ -508,13 +509,12 @@ run_status <- function(r){ # for db
   if(!any(recheck_lst)) return(status_prev)
   
   ## can assume some lst_mtimes need checking
-  
   lst_status <- rep(NA,length=length(recheck_lst))
   names(lst_status) <- lst_names
   
   for(i in seq_along(lst_mtimes)){
     lst_name <- lst_names[i]
-    if(!recheck_lst[i]) lst_status[i] <- sub_run_mtime_prev[lst_name] else
+    if(!recheck_lst[i]) lst_status[i] <- sub_run_status_prev[lst_name] else
     {
       print(paste(""checking"",lst_name))
       ## can assume lst_name needs checking now
@@ -537,9 +537,9 @@ run_status <- function(r){ # for db
   
   ## lst_status & lst_mtimes are up to date.
   update_object_field(matched_entry,
-                        sub_run_mtimes=lst_mtimes,
-                        sub_run_status=lst_status,
-                        run_dir_mtime=file.mtime(r$run_dir))
+                      sub_run_mtimes=lst_mtimes,
+                      sub_run_status=lst_status,
+                      run_dir_mtime=file.mtime(r$run_dir))
   
   running <- length(which(lst_status %in% ""running""))
   finished <- length(which(lst_status %in% ""finished""))
@@ -558,7 +558,7 @@ nm_steps_finished <- function(r){ # for waiting
                                 full.names = TRUE))
   execution_dirs <- unique(execution_dirs)
   lst_names <- file.path(execution_dirs,""psn.lst"")
-
+  
   if(length(execution_dirs) > 0){
     ## check these all exist
     finished <- sapply(lst_names,function(lst_name){
@@ -646,19 +646,19 @@ clean_run <- function(r,delete_dir=c(NA,TRUE,FALSE)){
 ctl_out_files <- function(ctl_file){ ## will get vector of $TABLE file names from control file.
   if(!file.exists(ctl_file)) stop(paste(ctl_file, ""doesn't exist""))
   dir0 <- dir(dirname(ctl_file))
-
+  
   s0 <- readLines(ctl_file)
   s <- grep(""FILE *= *[A-Za-z0-9_\\-\\.]+"",s0,value=TRUE)
   table.files <- gsub("".*FILE *= *([A-Za-z0-9_\\-\\.]+) *.*$"",""\\1"",s)
   #table.files <- dir0[dir0%in%table.files]
-
+  
   stub <- basename(ctl_file)
   stub <- gsub(""(.+)\\.\\w+$"",""\\1"",stub)
-
+  
   out.files <- dir0[grepl(paste(stub,""\\."",sep=""""),dir0)]
   out.files <- out.files[!grepl(""scm"",out.files)]
   out.files <- out.files[!out.files%in%basename(ctl_file)]
-
+  
   out.files <- c(table.files,out.files)
   out.files
 }
@@ -716,17 +716,17 @@ setup_nm_demo <- function(file_stub = paste0(getOption(""model_file_stub""),1),
                           exclude=NULL){
   tidyproject::check_if_tidyproject()
   examples_dir <- system.file(""extdata"",""examples"",demo_name,package = ""NMproject"")
-
+  
   files_to_copy <- dir(examples_dir,all.files = TRUE,recursive = TRUE)
   dest_names <- files_to_copy
   dest_names <- gsub(""^Models/"",paste0(getOption(""models.dir""),""/""),dest_names)
   dest_names <- gsub(""^Scripts/"",paste0(getOption(""scripts.dir""),""/""),dest_names)
   dest_names <- gsub(""run1\\."",paste0(file_stub,"".""),dest_names)
-
+  
   already_there <- file.exists(dest_names)
   if(any(already_there) & !overwrite)
     stop(""File(s) already exist:\n"",paste(paste0(""  "",dest_names[already_there]),collapse=""\n""),""\nRename or rerun with overwrite=TRUE"",call. = FALSE)
-
+  
   for(i in seq_along(files_to_copy)){
     if(is.null(exclude)) do_copy <- TRUE else {
       if(grepl(paste0(""\\."",exclude,""$""),files_to_copy[i]))"
tsahota,NMproject,dba5940b9d3b570ce2ed2ede94d12585b7c1452c,Tarj Sahota,t.sahota0@gmail.com,2017-06-17T15:55:29Z,Tarj Sahota,t.sahota0@gmail.com,2017-06-17T15:55:29Z,bug fix on tranformation for burn ins,R/read_ext.R,False,True,True,False,2,2,4,"---FILE: R/read_ext.R---
@@ -39,9 +39,9 @@ read_ext <- function(r,trans=FALSE){
     pi <- p_info[i,]
     names(d)[names(d) %in% pi$Parameter] <- pi$Name
     if(pi$trans %in% c(""LOG"",""LOGODDS"")){
-      d[,pi$Name][d$ITERATION>=0] <- exp(d[,pi$Name][d$ITERATION>=0])
+      d[,pi$Name][d$ITERATION>-1000000000] <- exp(d[,pi$Name][d$ITERATION>-1000000000])
     } else if (pi$trans %in% ""LOGIT"") {
-      d[,pi$Name][d$ITERATION>=0] <- stats::plogis(d[,pi$Name][d$ITERATION>=0])
+      d[,pi$Name][d$ITERATION>-1000000000] <- stats::plogis(d[,pi$Name][d$ITERATION>-1000000000])
     }
   }
   d"
tsahota,NMproject,d29b2c99f397a3715777e93297905fbe28f3ca7d,Tarj Sahota,t.sahota0@gmail.com,2017-06-12T10:33:25Z,Tarj Sahota,t.sahota0@gmail.com,2017-06-12T10:33:25Z,added error handling for psn.ext,inst/extdata/shiny/server.R,False,True,True,False,2,0,2,"---FILE: inst/extdata/shiny/server.R---
@@ -170,6 +170,8 @@ function(input, output, session) {
          input$run_table_rows_selected),{
            orig.dir <- getwd();  setwd(.currentwd) ; on.exit(setwd(orig.dir))
            object <- objects()[[1]]
+           if(is.null(object$output$psn.ext)) return(dygraph(data.frame(x=0,y=0)))
+           if(!file.exists(object$output$psn.ext)) return(dygraph(data.frame(x=0,y=0)))
            d <- plot_iter_data(object,trans = input$trans, skip = 0)
            p <- list()
            for(i in seq_along(unique(d$variable))){"
tsahota,NMproject,c500c8ed89600afde00ab0db739458fae4253819,Tarj Sahota,t.sahota0@gmail.com,2017-06-12T01:13:46Z,Tarj Sahota,t.sahota0@gmail.com,2017-06-12T01:13:46Z,bug fix,R/NMproject.R,False,True,True,False,1,1,2,"---FILE: R/NMproject.R---
@@ -179,7 +179,7 @@ copy_control <- function(from,to,overwrite=FALSE,alt_paths){
     run_id_from <- run_id(from_path) else
       run_id_from <- basename(from_path)
 
-  ctl <- gsub(paste0(""(FILE\\s*=\\s*.*)"",run_id_from,""\\b""),paste0(""\\1"",run_id),ctl)
+  ctl <- gsub(paste0(""(FILE\\s*=\\s*\\S*)"",run_id_from,""\\b""),paste0(""\\1"",run_id),ctl)
 
   if(is_project_file)
     ctl <- gsub(""^(\\s*;;\\s*[0-9]*\\.\\s*Based on:).*"",paste(""\\1"",run_id_from),ctl) else"
tsahota,NMproject,15a29d8180c5eb00d054a841e5deb783e83b6df9,Tarj Sahota,Tarj Sahota,2017-06-06T19:15:56Z,Tarj Sahota,Tarj Sahota,2017-06-06T19:15:56Z,non-rstudio fail bug fix,R/NMproject.R,False,True,True,False,2,4,6,"---FILE: R/NMproject.R---
@@ -85,10 +85,8 @@ set_nm_opts <- function(){
         Sys.unsetenv(names(stdout_unit_vars)[i])
       }
       on.exit({
-        print(as.list(Sys.getenv()))
-        print(""deleted vars"")
-        print(as.list(stdout_unit_vars))
-        do.call(Sys.setenv,as.list(stdout_unit_vars))
+        if(length(stdout_unit_vars)>0)
+          do.call(Sys.setenv,as.list(stdout_unit_vars))
       })
       args <- list(...)
       if(!""wait"" %in% names(args)) wait <- FALSE else wait <- args$wait"
tsahota,NMproject,909489b40306834fec1fce53b3c2368d493c86e0,Tarj Sahota,Tarj Sahota,2017-06-06T11:26:09Z,Tarj Sahota,Tarj Sahota,2017-06-06T11:26:09Z,bug fix,R/nm.R,False,True,True,False,1,1,2,"---FILE: R/nm.R---
@@ -505,7 +505,7 @@ ctl_out_files <- function(ctl_file){ ## will get vector of $TABLE file names fro
   s0 <- readLines(ctl_file)
   s <- grep(""FILE *= *[A-Za-z0-9_\\-\\.]+"",s0,value=TRUE)
   table.files <- gsub("".*FILE *= *([A-Za-z0-9_\\-\\.]+) *.*$"",""\\1"",s)
-  table.files <- dir0[dir0%in%table.files]
+  #table.files <- dir0[dir0%in%table.files]
 
   stub <- basename(ctl_file)
   stub <- gsub(""(.+)\\.\\w+$"",""\\1"",stub)"
tsahota,NMproject,bb4f6c14ebc9b7e00a0598f251ba7abfbd8936f4,Tarj Sahota,Tarj Sahota,2017-06-06T10:40:49Z,Tarj Sahota,Tarj Sahota,2017-06-06T10:40:49Z,fixed windows nm_tran and run execution,R/NMproject.R;R/nm.R,False,True,True,False,9,3,12,"---FILE: R/NMproject.R---
@@ -79,10 +79,16 @@ set_nm_opts <- function(){
   })
   if(is.null(getOption(""system_nm""))) options(system_nm=function(cmd,...) {
     if(.Platform$OS.type == ""windows""){
+      local_env_vars <- Sys.getenv()
+      stdout_unit_vars <- local_env_vars[grepl(""STDOUT_UNIT|STDERR_UNIT"",names(local_env_vars))]
+      for(i in seq_along(stdout_unit_vars)){
+        Sys.unsetenv(names(stdout_unit_vars)[i])
+      }
+      on.exit(do.call(Sys.setenv,as.list(stdout_unit_vars)))
       args <- list(...)
       if(!""wait"" %in% names(args)) wait <- FALSE else wait <- args$wait
       if(wait==FALSE){
-        shell(paste(""START CMD /C \""\"""",cmd),...)        
+        shell(paste(""START CMD /C"",cmd),...)        
       } else {
         shell(cmd,...)        
       }

---FILE: R/nm.R---
@@ -358,13 +358,13 @@ wait_for_finished <- function(...){
     last_update <- last_modified(r)
 
     if(finished){ ## check again in 5 seconds
-      Sys.sleep(5)
+      if(r$type != ""execute"") Sys.sleep(5) else Sys.sleep(1)
       finished2 <- nm_steps_finished(r)
       last_update2 <- last_modified(r)
       ## if it is still finished and last_update is still the same then finish
       finished <- finished2 & identical(last_update,last_update2)
     }
-
+    
     ######################################
     if(finished){
       rl[[j]] <- NULL"
tsahota,NMproject,ecc0fcc1d3c77a85672fb56f9c1b744c1c13143e,Tarj Sahota,Tarj Sahota,2017-06-04T22:48:20Z,Tarj Sahota,Tarj Sahota,2017-06-04T22:48:20Z,bug fix,tests/testthat/test-basic.R,False,True,True,False,2,2,4,"---FILE: tests/testthat/test-basic.R---
@@ -72,9 +72,9 @@ test_that(""set up"",{
   set_nm_opts()
   expect_true(getOption(""model_file_stub"")==""run"")
 
-  tmp <- system_cmd(""ls"",intern=TRUE)
+  tmp <- system_cmd(""echo test"",intern=TRUE, wait=TRUE)
   expect_true(length(tmp)>0 & ""character"" %in% class(tmp))
-  tmp <- system_nm(""ls"",intern=TRUE)
+  tmp <- system_nm(""echo test"",intern=TRUE, wait=TRUE)
   expect_true(length(tmp)>0 & ""character"" %in% class(tmp))
 
   old.opt <- getOption(""nmtran_exe_path"")"
tsahota,NMproject,e624e63ebfdf61315970ffda6986bee6236b27c2,Tarj Sahota,Tarj Sahota,2017-06-04T22:37:09Z,Tarj Sahota,Tarj Sahota,2017-06-04T22:37:09Z,bug fixes,R/nm.R;inst/extdata/examples/aztheopp/Scripts/gof1.R;inst/extdata/examples/theopp/Scripts/gof1.R,False,True,True,False,4,4,8,"---FILE: R/nm.R---
@@ -302,7 +302,7 @@ print.nm <- function(x,...) utils::str(x)
 #' @param r object of class nm
 #' @export
 ctl <- function(r) {
-  file.edit(r$ctl)
+  utils::file.edit(r$ctl)
 }
 
 gsub2 <- function(pattern,replacement,x,...){
@@ -554,7 +554,7 @@ output_files <- function(run_in,run_type,run_dir,ctl_name){
 write.csv.nm <- function(...,na=""."",
                          row.names=FALSE,
                          quote=FALSE){
-  write.csv(...,na=na,row.names=row.names,quote=quote)
+  utils::write.csv(...,na=na,row.names=row.names,quote=quote)
 }
 
 #' Setup demo files

---FILE: inst/extdata/examples/aztheopp/Scripts/gof1.R---
@@ -14,7 +14,7 @@ gof1 <- function(run.no,model.dir=getOption(""models.dir"")){
   ##   $TABLE ID TIME IPRED IWRES IRES CWRES NPDE
   ##   FILE=sdtab[run.no] NOPRINT ONEHEADER FORMAT=tF13.4
   
-  library(xpose4,lib.loc = ""/home/kbtr119/R/x86_64-unknown-linux-gnu-library/3.1/"")
+  library(xpose4)
   
   xpdb <- xpose.data(run.no,directory=paste0(model.dir,""/""))
   

---FILE: inst/extdata/examples/theopp/Scripts/gof1.R---
@@ -14,7 +14,7 @@ gof1 <- function(run.no,model.dir=getOption(""models.dir"")){
   ##   $TABLE ID TIME IPRED IWRES IRES CWRES NPDE
   ##   FILE=sdtab[run.no] NOPRINT ONEHEADER FORMAT=tF13.4
   
-  library(xpose4,lib.loc = ""/home/kbtr119/R/x86_64-unknown-linux-gnu-library/3.1/"")
+  library(xpose4)
   
   xpdb <- xpose.data(run.no,directory=paste0(model.dir,""/""))
   "
tsahota,NMproject,c8a4628d873625f64fff6c68eee806a93dc84fb0,Tarjinder Sahota,klgk669@semldxcalvin.seml.astrazeneca.net,2017-06-02T14:08:10Z,Tarjinder Sahota,klgk669@semldxcalvin.seml.astrazeneca.net,2017-06-02T14:08:10Z,bug fix,R/nm.R,False,True,True,False,2,2,4,"---FILE: R/nm.R---
@@ -432,9 +432,9 @@ last_modified <- function(r){
   d <- file.info(directory)
   if(nrow(d)==0) return("""")
   d <- data.frame(file=rownames(d),mtime=d$mtime)
-  if(nrow(d)==0) return(NA)
+  if(nrow(d)==0) return(as.character(NA))
   d <- d[d$mtime %in% max(d$mtime), ]
-  unique(d$mtime)
+  as.character(unique(d$mtime))
 }
 
 #' Should run() wait for job to finish"
tsahota,NMproject,42f98184769e8f42cd80daa9701918493e7d4e75,Tarjinder Sahota,klgk669@semldxcalvin.seml.astrazeneca.net,2017-05-30T16:46:22Z,Tarjinder Sahota,klgk669@semldxcalvin.seml.astrazeneca.net,2017-05-30T16:46:22Z,bug fix,R/nm.R;R/zzz.R,False,True,True,False,6,1,7,"---FILE: R/nm.R---
@@ -380,7 +380,7 @@ nm_steps_finished <- function(r){
       if(inherits(lst,""try-error"")) return(FALSE)
       lst <- lst[max(1,(length(lst)-5)):length(lst)]
       stopped <- any(grepl(""Stop Time:"",lst))
-      psn_error <- file.exists(file.path(basename(lst_name),""psn_nonmem_error_messages.txt""))
+      psn_error <- file.exists(file.path(dirname(lst_name),""psn_nonmem_error_messages.txt""))
       return(stopped | psn_error)
     })
     finished <- all(finished)

---FILE: R/zzz.R---
@@ -1,4 +1,9 @@
 .onLoad <- function(libname, pkgname){
+  if(!requireNamespace(""tidyproject"",quietly = TRUE))
+    stop(""tidyproject needed for this function to work. Please install it."",
+         call. = FALSE)
+  x <- lapply(""tidyproject"",library,character.only = TRUE)
+  #library(tidyproject,character.only = TRUE)
   set_nm_opts()
 }
 "
tsahota,NMproject,526eedc6d41216251a58c52a5b91b51f94ef2193,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-05-30T16:33:57Z,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-05-30T16:33:57Z,bug fix,R/ctl_handling.R,False,True,True,False,1,1,2,"---FILE: R/ctl_handling.R---
@@ -91,7 +91,7 @@ ctl_r2nm <- function(x) unlist(x,use.names = FALSE)
 #' @export
 theta_nm2r <- function(x){
   x <- rem_dollars(x)
-  x <- x[!x %in% """"]
+  x <- x[!grepl(""^\\s*$"",x)]
   x <- gsub(""\\t"","" "",x)
   x0 <- x
   x <- rem_comment(x,"";"")"
tsahota,NMproject,3991c9979a33760129f0ecea85ab8174f23c192c,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-05-30T16:18:46Z,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-05-30T16:18:46Z,fixed rem_dollars,R/ctl_handling.R,False,True,True,False,1,1,2,"---FILE: R/ctl_handling.R---
@@ -1,6 +1,6 @@
 is_dollar_line <- function(l) grepl(""^\\s*;*\\s*\\$"",l)
 is_nm_comment_line <- function(l) grepl(""^\\s*;"",l)
-rem_dollars <- function(s) gsub(""\\$\\S*"","""",s)
+rem_dollars <- function(s) gsub(""\\s*\\$\\S*\\s*"","""",s)
 rem_comment <- function(s,char="";"") gsub(paste0(""^([^"",char,""]*)"",char,""*.*$""),""\\1"",s)
 get_comment <- function(s,char="";"") gsub(paste0(""^[^"",char,""]*"",char,""*(.*)$""),""\\1"",s)
 "
tsahota,NMproject,0aa119de19a6c9f354e57dbfc77333329678887d,Tarj Sahota,t.sahota0@gmail.com,2017-05-23T22:17:09Z,GitHub,noreply@github.com,2017-05-23T22:17:09Z,"used ""issues"" trick for screencaps",README.md,False,False,False,False,2,2,4,"---FILE: README.md---
@@ -21,8 +21,8 @@ Script based NONMEM execution on tidyprojects with shiny interface
   * Table of runs
   * Real time run tracking
   * Run comparison
-
-<img src=https://github.com/tsahota/NMproject/blob/master/images/db.png width=24.6% /><img src=https://github.com/tsahota/NMproject/blob/master/images/monitor.png width=24.5% /><img src=https://github.com/tsahota/NMproject/blob/master/images/results.png width=24.5% />
+  
+<img src=https://cloud.githubusercontent.com/assets/18026277/26378627/40cd453a-400d-11e7-8547-cb508647f986.png width=24.6% /><img src=https://cloud.githubusercontent.com/assets/18026277/26378716/af0a755e-400d-11e7-98da-2855d84908fd.png width=24.5% /><img src=https://cloud.githubusercontent.com/assets/18026277/26378737/c75222d8-400d-11e7-8e5c-b5b800fe0b60.png width=24.5% />
 
 History: NMproject was previously an AstraZeneca project.  It is being reimplemented here as a community version to be compatible with a variety of architectures (standalone NONMEM and a variety of grid submission systems)
  "
tsahota,NMproject,b09c3a3967ab41ead635bea501d806590eac9355,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-05-21T01:39:16Z,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-05-21T01:39:16Z,bug fix theta_nm2r,R/ctl_handling.R,False,True,True,False,1,0,1,"---FILE: R/ctl_handling.R---
@@ -92,6 +92,7 @@ ctl_r2nm <- function(x) unlist(x,use.names = FALSE)
 theta_nm2r <- function(x){
   x <- rem_dollars(x)
   x <- x[!x %in% """"]
+  x <- gsub(""\\t"","" "",x)
   x0 <- x
   x <- rem_comment(x,"";"")
   x <- paste(x,collapse = "" "")"
tsahota,NMproject,7c771317751e181ef56a2545f7d0d0b46fbef716,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-05-16T13:12:16Z,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-05-16T13:12:16Z,text fix,inst/extdata/shiny/ui.R,False,True,True,False,1,1,2,"---FILE: inst/extdata/shiny/ui.R---
@@ -20,7 +20,7 @@ fluidPage(
                                        actionButton(""refresh_db"",""refresh""),
                                        p(em(""Click rows to select run(s)""))),
                                 column(6,actionButton(""go_to_monitor"",""View selected run in monitor tab""),
-                                       actionButton(""go_to_results"",""View selected run(s) in monitor tab""))),
+                                       actionButton(""go_to_results"",""View selected run(s) in results tab""))),
                               fluidRow(DT::dataTableOutput(""run_table""))),
                      tabPanel(title = ""monitor"",
                               value = ""monitor"","
tsahota,NMproject,5c147a2a61c376c811bc83da07f86a3a8af30e10,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-05-15T04:22:58Z,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-05-15T04:22:58Z,fixed environment,R/NMproject.R;R/zzz.R;inst/extdata/shiny/server.R;inst/extdata/shiny/ui.R,False,True,True,False,9,1,10,"---FILE: R/NMproject.R---
@@ -259,7 +259,9 @@ update_dollar_data <- function(ctl_name,new_data_name){
 #' @export
 shiny_nm <- function(){
   shiny_dir <- system.file(""extdata/shiny"",package=""NMproject"")
-  assign("".currentwd"",value = getwd(),envir = as.environment(""package:NMproject""))
+  .sso_env$.currentwd <- getwd()  # see zzz.R for .sso_env
+  on.exit(.sso_env$.currentwd <- NULL, add = TRUE)
+#  assign("".currentwd"",value = getwd(),envir = asNamespace(""NMproject""))
   shiny::runApp(shiny_dir,launch.browser = TRUE)
 }
 

---FILE: R/zzz.R---
@@ -1,3 +1,5 @@
 .onLoad <- function(libname, pkgname){
   set_nm_opts()
 }
+
+.sso_env <- new.env(parent=emptyenv())

---FILE: inst/extdata/shiny/server.R---
@@ -1,6 +1,8 @@
 library(shiny)
 library(plotly)
 
+.currentwd <- get("".currentwd"", envir = NMproject:::.sso_env)
+
 gen_run_table <- function(){
   orig.dir <- getwd();  setwd(.currentwd) ; on.exit(setwd(orig.dir))
   run_table()

---FILE: inst/extdata/shiny/ui.R---
@@ -1,6 +1,8 @@
 library(shiny)
 library(plotly)
 
+.currentwd <- get("".currentwd"", envir = NMproject:::.sso_env)
+
 navbarPageWithText <- function(..., text) {
   navbar <- navbarPage(...)
   textEl <- tags$p(class = ""navbar-text"", text)"
tsahota,NMproject,700d7023c892969aed39a5bfe61d9d2581247d73,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-05-15T00:13:57Z,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-05-15T00:13:57Z,fixed error added test,R/nm.R;inst/extdata/shiny/server.R;inst/extdata/shiny/ui.R;tests/testthat/test-status.R,False,True,True,False,6,5,11,"---FILE: R/nm.R---
@@ -315,9 +315,7 @@ run <- function(...,overwrite=FALSE,delete_dir=c(NA,TRUE,FALSE)){
   lapply(rl,function(r){
     ## if directory exists, and if it's definately a directory stop
     if(file.exists(r$run_dir) & !overwrite)if(file.info(r$run_dir)$isdir %in% TRUE) stop(""run already exists. To rerun select overwrite=TRUE"")
-    if(!is.null(getOption(""kill_run""))){
-      getOption(""kill_run"")(r)
-    }
+    if(!is.null(getOption(""kill_run""))) getOption(""kill_run"")(r)
     clean_run(r,delete_dir=delete_dir[1])
     system_nm(cmd = r$cmd,dir = r$run_in)
   })

---FILE: inst/extdata/shiny/server.R---
@@ -27,11 +27,11 @@ function(input, output, session) {
   })
 
   output$runs_selected_info <- renderTable({
-    if(length(input$run_table_rows_selected)==0) return(data.frame(entry=numeric(),type=character(),ct=character()))
+    if(length(input$run_table_rows_selected)==0) return(data.frame())
     new_table()[input$run_table_rows_selected,c(""entry"",""type"",""ctl"")]
   })
   output$runs_selected_info2 <- renderTable({
-    if(length(input$run_table_rows_selected)==0) return(data.frame(entry=numeric(),type=character(),ct=character()))
+    if(length(input$run_table_rows_selected)==0) return(data.frame())
     new_table()[input$run_table_rows_selected,c(""entry"",""type"",""ctl"")]
   })
 

---FILE: inst/extdata/shiny/ui.R---
@@ -1,4 +1,5 @@
 library(shiny)
+library(plotly)
 
 navbarPageWithText <- function(..., text) {
   navbar <- navbarPage(...)

---FILE: tests/testthat/test-status.R---
@@ -32,6 +32,8 @@ test_that(""status"",{
 
   m2 <- nm(""qpsn -m -c auto -t 3000 -- execute run2.mod -dir=2"")
 
+  expect_error(run(m2)) ## already run
+
   st <- status(m2)
   expect_true(inherits(st,""data.frame""))
   expect_true(any(st$RESULT))"
tsahota,NMproject,8a348f8f866051aba6b0558391a303b3b74ebdef,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-05-13T16:38:33Z,Tarjinder Sahota,klgk669@semldxcalvin.seml.astrazeneca.net,2017-05-13T17:26:38Z,fixed error handling,R/nm.R,False,True,True,False,1,1,2,"---FILE: R/nm.R---
@@ -285,7 +285,7 @@ extract_nm <- function(entry){
   },
   error=function(e){
     if(DBI::dbIsValid(my_db)) DBI::dbDisconnect(my_db)
-    e
+    stop(e)
   })
 }
 "
tsahota,NMproject,146eff8221722594aec5c45be752974786fa57cd,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-05-13T16:38:33Z,Tarjinder Sahota,klgk669@semldxzilker.seml.astrazeneca.net,2017-05-13T16:38:33Z,fixed error handling,R/nm.R,False,True,True,False,1,1,2,"---FILE: R/nm.R---
@@ -285,7 +285,7 @@ extract_nm <- function(entry){
   },
   error=function(e){
     if(DBI::dbIsValid(my_db)) DBI::dbDisconnect(my_db)
-    e
+    stop(e)
   })
 }
 "
tsahota,NMproject,5dea5fb0fedac84c007636123de6cc4fa6e40bab,Tarjinder Sahota,klgk669@semldxcalvin.seml.astrazeneca.net,2017-05-12T13:20:59Z,Tarjinder Sahota,klgk669@semldxcalvin.seml.astrazeneca.net,2017-05-12T13:20:59Z,removed error shiny  messages & passed cran checks,NAMESPACE;R/NMproject.R;R/nm.R;R/status.R;inst/extdata/shiny/.runs.sqlite3;inst/extdata/shiny/server.R;inst/extdata/shiny/ui.R;man/extract_nm.Rd;man/shiny_nm.Rd,False,True,True,False,84,32,116,"---FILE: NAMESPACE---
@@ -5,7 +5,9 @@ S3method(data_name,default)
 S3method(nm_tran,default)
 S3method(nm_tran,nm)
 S3method(print,nm)
+S3method(status,nm)
 S3method(status,nmexecute)
+S3method(status,nmscm)
 export(check_session)
 export(clean_run)
 export(coef_nm)
@@ -14,14 +16,15 @@ export(ctl_nm2r)
 export(ctl_r2nm)
 export(data_name)
 export(delete_run)
+export(extract_nm)
 export(nm)
 export(nm_tran)
-export(nmdb_extract)
 export(param_info)
 export(plot_iter)
 export(run)
 export(run_record)
 export(run_table)
+export(shiny_nm)
 export(shiny_run_monitor)
 export(shiny_run_table)
 export(show_runs)

---FILE: R/NMproject.R---
@@ -276,11 +276,11 @@ shiny_run_table <- function(){
   shiny::runApp(shiny_dir,launch.browser = TRUE)
 }
 
+#' Shiny view of NMproject
 #' @export
-shiny_nm <- function(x){
+shiny_nm <- function(){
   shiny_dir <- system.file(""extdata/shiny"",package=""NMproject"")
   assign("".currentwd"",value = getwd(),envir = as.environment(""package:NMproject""))
-  assign("".object"",value = x,envir = as.environment(""package:NMproject""))
   shiny::runApp(shiny_dir,launch.browser = TRUE)
 }
 

---FILE: R/nm.R---
@@ -220,7 +220,9 @@ nmdb_printable_db <- function(d){
     paste(basename(char_vec),collapse="" "")
   })
   d$ctl <- NULL
-  d$outputs_present <- signif(d$outputs_present,2)
+  ## include if statements for columns no in the db
+  if(""outputs_present"" %in% names(d))
+    d$outputs_present <- signif(d$outputs_present,2)
   for(i in names(d)) d[,i] <- as.character(d[,i]) ## convert everything to characters
   names(d) <- gsub(""_"","" "",names(d))
   d
@@ -281,7 +283,7 @@ show_runs <- function(...) nmdb_get(readable = TRUE,...)
 #' @param entry numeric. Database ID of nm object
 #' @export
 
-nmdb_extract <- function(entry){
+extract_nm <- function(entry){
   my_db <- DBI::dbConnect(RSQLite::SQLite(), "".runs.sqlite3"")
   tryCatch({
     d <- DBI::dbGetQuery(my_db, 'SELECT * FROM runs')

---FILE: R/status.R---
@@ -17,9 +17,9 @@ run_type <- function(run.dir){  ## internal function: get type of run from direc
 }
 
 
-status_execute <- function(run_dir,sub.dir=""NM_run1""){
+status_execute <- function(ctl_name,run_in,run_dir,sub.dir=""NM_run1""){
 
-  r <- data.frame(RUN=as.integer(basename(run_dir)),TYPE=run_type(run_dir),TEST=c(
+  r <- data.frame(RUN=ctl_name,DIR=run_in,TYPE=""execute"",TEST=c(
     ""dir created"",
     ""*.ext file exists"",
     ""*.ext file written to"",
@@ -59,9 +59,9 @@ status_execute <- function(run_dir,sub.dir=""NM_run1""){
   r
 }
 
-status_scm <- function(run_dir){
+status_scm <- function(ctl_name,run_in,run_dir){
 
-  r <- data.frame(RUN=as.integer(basename(run_dir)),TYPE=run_type(run_dir),TEST=c(
+  r <- data.frame(RUN=ctl_name,DIR=run_in,TYPE=""scm"",TEST=c(
     ""dir created"",
     ""data_preprocessing_dir created"",
     ""base_modelfit_dir1 created"",
@@ -90,6 +90,31 @@ status_scm <- function(run_dir){
   r
 }
 
+status_unknown <- function(ctl_name,run_in,run_dir){
+
+  r <- data.frame(RUN=ctl_name,DIR=run_in,TYPE=run_type(run_dir),TEST=c(
+    ""dir created""
+    ),
+  RESULT=NA,COMMENT=NA)
+
+  r$RESULT[r$TEST %in% ""dir created""] <- file.exists(run_dir)
+  r$COMMENT[r$TEST %in% ""dir created""] <- NA
+
+  r
+}
+
+
 #' @export
-status.nmexecute <- function(x) status_execute(x$run_dir)
+status.nmexecute <- function(x) status_execute(ctl_name=basename(x$ctl),
+                                               run_in = x$run_in,
+                                               run_dir=x$run_dir)
 
+#' @export
+status.nmscm <- function(x) status_scm(ctl_name=basename(x$ctl),
+                                       run_in = x$run_in,
+                                       run_dir=x$run_dir)
+
+#' @export
+status.nm <- function(x) status_unknown(ctl_name=basename(x$ctl),
+                                        run_in = x$run_in,
+                                        run_dir=x$run_dir)

---FILE: inst/extdata/shiny/server.R---
@@ -12,35 +12,45 @@ function(input, output, session) {
   new_table <- eventReactive(input$refresh_db,gen_run_table(),ignoreNULL = FALSE)
   output$run_table <- DT::renderDataTable({
     new_table()
-  },selection = ""single"", server = FALSE,
-  options = list(paging=FALSE,
-                 searching=FALSE,
-                 filtering=FALSE,
-                 ordering=FALSE))
-
-  object <- eventReactive(
-    list(input$run_table_rows_selected,
-         input$refresh_status,
-         input$refresh_plot),{
+  },selection = ""single"", server = FALSE, rownames = FALSE,
+  options = list(paging=TRUE,
+                 searching=TRUE,
+                 filtering=TRUE,
+                 ordering=TRUE))
+
+  object <- eventReactive(input$run_table_rows_selected,{
     orig.dir <- getwd();  setwd(.currentwd) ; on.exit(setwd(orig.dir))
     row <- input$run_table_rows_selected
-    print(""refreshing object from db"")
-    nmdb_extract(new_table()$entry[row])
+    extract_nm(new_table()$entry[row])
   })
 
   observeEvent(input$run_table_rows_selected, {
-    updateTabsetPanel(session, ""mainPanel"", selected = ""run monitor"")
+    updateNavbarPage(session, ""mainPanel"", selected = ""run monitor"")
   })
 
   ## run monitor
-  output$status <- renderTable({
+
+  status_ob <- eventReactive(
+    list(input$refresh_status,
+         input$run_table_rows_selected),{
     orig.dir <- getwd();  setwd(.currentwd) ; on.exit(setwd(orig.dir))
     status(object())
   })
 
-  output$distPlot <- renderPlot({
+  output$status <- renderTable({
+    status_ob()
+  })
+
+  plot_iter_ob <- eventReactive(
+    list(input$refresh_plot,
+         input$run_table_rows_selected),{
     orig.dir <- getwd();  setwd(.currentwd) ; on.exit(setwd(orig.dir))
-    plot_iter(object(),trans = input$trans, skip = input$skip)
+    if(file.exists(object()$output$psn.ext))
+      plot_iter(object(),trans = input$trans, skip = input$skip)
+  })
+
+  output$distPlot <- renderPlot({
+    plot_iter_ob()
   })
 }
 

---FILE: inst/extdata/shiny/ui.R---
@@ -1,22 +1,22 @@
 library(shiny)
 
 fluidPage(
-  tabsetPanel(id=""mainPanel"",
+  navbarPage(""NMproject"",id=""mainPanel"",
     tabPanel(""run database"",
              actionButton(""refresh_db"",""refresh""),
              br(),br(),
              DT::dataTableOutput(""run_table"")),
     tabPanel(""run monitor"",   # Application title
              hr(),
              h3(""status""),
-             actionButton(""refresh_status"",""update table""),
+             actionButton(""refresh_status"",""refresh""),
              br(),br(),
              tableOutput(""status""),
              hr(),
              h3(""trace""),
              numericInput(""skip"",""skip"",value=0,min=0,max=1000,step=1),
              checkboxInput(""trans"",""transform parameters"",TRUE),
-             actionButton(""refresh_plot"",""update plot""),
+             actionButton(""refresh_plot"",""refresh""),
              br(),br(),
              plotOutput(""distPlot""))
   )

---FILE: man/extract_nm.Rd---
@@ -1,10 +1,10 @@
 % Generated by roxygen2: do not edit by hand
 % Please edit documentation in R/nm.R
-\name{nmdb_extract}
-\alias{nmdb_extract}
+\name{extract_nm}
+\alias{extract_nm}
 \title{Extract nm object from data.base}
 \usage{
-nmdb_extract(entry)
+extract_nm(entry)
 }
 \arguments{
 \item{entry}{numeric. Database ID of nm object}

---FILE: man/shiny_nm.Rd---
@@ -0,0 +1,12 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/NMproject.R
+\name{shiny_nm}
+\alias{shiny_nm}
+\title{Shiny view of NMproject}
+\usage{
+shiny_nm()
+}
+\description{
+Shiny view of NMproject
+}
+"
tsahota,NMproject,102a74000e730f1c4cb914545bb543d9e976a39d,Tarjinder Sahota,klgk669@semldxcalvin.seml.astrazeneca.net,2017-05-11T18:47:40Z,Tarjinder Sahota,klgk669@semldxcalvin.seml.astrazeneca.net,2017-05-11T18:47:40Z,fixed plot_iter order and added trans to shiny,R/plot_iter.R;inst/extdata/RunMonitor/server.R;inst/extdata/RunMonitor/ui.R;inst/extdata/RunTable/server.R;inst/extdata/RunTable/ui.R,False,True,True,False,12,10,22,"---FILE: R/plot_iter.R---
@@ -46,6 +46,7 @@ plot_iter <- function(r,trans=TRUE,skip=0,yvar=""OBJ""){
 
   d <- tidyr::gather_(data = d,key = ""variable"",value = ""value"",
                       gather_cols = par.names)
+  d$variable <- factor(d$variable,levels=unique(d$variable))
 
   p <- ggplot2::ggplot(d,ggplot2::aes_string(x=""ITERATION"",y=""value""))
   p <- p + ggplot2::geom_line(ggplot2::aes_string(colour=""TYPE""))

---FILE: inst/extdata/RunMonitor/server.R---
@@ -1,12 +1,12 @@
 library(shiny)
 
-shinyServer(function(input, output, session) {
+function(input, output, session) {
   session$onSessionEnded(function() stopApp())
   #autoInvalidate <- reactiveTimer(20000, session)
   output$distPlot <- renderPlot({
     orig.dir <- getwd();  setwd(.currentwd) ; on.exit(setwd(orig.dir))
     #autoInvalidate()
-    plot_iter(.object)
+    plot_iter(.object,trans = input$trans)
   })
-})
+}
 

---FILE: inst/extdata/RunMonitor/ui.R---
@@ -1,6 +1,7 @@
 library(shiny)
 
-shinyUI(fluidPage(
+fluidPage(
   titlePanel(""Run Monitor""),   # Application title
+  checkboxInput(""trans"",""Transform parameters"",TRUE),
   plotOutput(""distPlot"")
-))
+)

---FILE: inst/extdata/RunTable/server.R---
@@ -1,12 +1,12 @@
 library(shiny)
 
-shinyServer(function(input, output, session) {
+function(input, output, session) {
   session$onSessionEnded(function() stopApp())
   #autoInvalidate <- reactiveTimer(20000, session)
   output$run_table <- shiny::renderTable({
     orig.dir <- getwd();  setwd(.currentwd) ; on.exit(setwd(orig.dir))
   #  autoInvalidate()
     run_table()
   })
-})
+}
 

---FILE: inst/extdata/RunTable/ui.R---
@@ -1,6 +1,6 @@
 library(shiny)
 
-shinyUI(fluidPage(
-  titlePanel(""Run Table""),   # Application title
+fluidPage(
+  titlePanel(""Run database""),   # Application title
   tableOutput(""run_table"")
-))
+)"
tsahota,NMproject,8fd4908b9b3d880193812fde0a4e5883c7bed60b,Tarjinder Sahota,klgk669@semldxcalvin.seml.astrazeneca.net,2017-05-09T20:03:18Z,Tarjinder Sahota,klgk669@semldxcalvin.seml.astrazeneca.net,2017-05-09T20:03:18Z,cran check fix,NAMESPACE;R/run_record.R;man/coef_nm.Rd;man/run_record.Rd,False,True,True,False,23,18,41,"---FILE: NAMESPACE---
@@ -22,7 +22,7 @@ export(nmdb_extract)
 export(param_info)
 export(plot_iter)
 export(run)
-export(run_record0)
+export(run_record)
 export(show_runs)
 export(status)
 export(system_cmd)

---FILE: R/run_record.R---
@@ -55,24 +55,25 @@ coef_ext0 <- function(ext.file){
 #'
 #' Produces data.frame of parameter values
 #' @param object object of class nmexecute
-#' @param ... trans argument (default = TRUE). logical.  Should parameters be transformed
+#' @param trans logical. Default = TRUE. Should parameters be transformed
+#' @param ... additional arguments to carry to coef
 #' @return a \code{data.frame} of parameter values
 #' @export
 
 coef_nm <- function(object,trans,...){
   d <- coef_ext0(object$output$psn.ext)
   if(!trans) return(d)
-  
+
   p <- object$param_info
-  
+
   p$Parameter <- paste0(""THETA"",p$N)
   ## TODO: read parameter names from $OMEGA
   ## either $OMEGA in same way as $THETA (but without units in comments)
   ## or $OMEGA BLOCK
-  
+
   d0 <- d[,names(d)[!names(d) %in% ""Unit""]]
   d1 <- p[,c(""Name"",""Parameter"",""Unit"",""trans"")]
-  
+
   d <- merge(d0,d1,all.x = TRUE,by=""Parameter"")
   d$Name[is.na(d$Name)] <- as.character(d$Parameter)[is.na(d$Name)]
   d$Name <- factor(d$Name,levels=d$Name)
@@ -128,22 +129,22 @@ coef_nm <- function(object,trans,...){
       names.c <- c(omx[i],omy[i],as.character(d$Parameter[d$trans %in% ""COV""][i]))
       names.c <- d$Parameter[d$Parameter %in% names.c] ## reorder
       names.c2 <- gsub(""\\.([0-9]+)\\.([0-9]+)\\."",""(\\1,\\2)"",names.c)
-      
+
       ## same order as names.c - important
       vcov <- dc[match(names.c2,dc$NAME),as.character(names.c)]
       rownames(vcov) <- names(vcov)
       vcov <- as.matrix(vcov)
-      
+
       pmean <- d$FINAL[match(names.c,d$Parameter)]  ## may as well recompute FINALs
       names(pmean) <- d$Name[match(names.c,d$Parameter)]
-      
+
       formula.i <- paste0(names.c[3],""/(sqrt("",names.c[1],"")*sqrt("",names.c[2],""))"")
       #tmp <- car::deltaMethod(pmean,formula.i,vcov.=vcov)
       #d$SE.TRANS[d$trans %in% ""COV""][i] <- tmp$SE
     }
-    
+
   }
-  
+
   ## get names back to what they should be
   d$FINAL <- d$FINAL.TRANS
   d$FINAL.TRANS <- NULL
@@ -156,7 +157,7 @@ coef_nm <- function(object,trans,...){
   d$Parameter <- d$Name
   d$Name <- NULL
   d
-  
+
 }
 
 
@@ -193,13 +194,14 @@ run_record0 <- function(..., coef.func = coef_ext0){
 #' Run record
 #'
 #' @param ... objects of class nmexecute
-#' @param coef.func function to generate coefficients
-#' @export run_record0
+#' @param trans logical (default=TRUE).
+#'  If possible TRUE means transformation will be attempted
+#' @export
 
 run_record <- function(...,trans=TRUE){
   a <- list(...)
   classes <- sapply(a,function(a) inherits(a,""nm""))
-  
+
   if(any(classes)){
     coef.func <- coef_nm
     formals(coef.func)$trans <- trans
@@ -208,6 +210,6 @@ run_record <- function(...,trans=TRUE){
   }
   run_record.tmp <- function(...) run_record0(...,coef.func=coef.func)
   do.call(run_record.tmp,a)
-  
+
 }
 

---FILE: man/coef_nm.Rd---
@@ -9,7 +9,9 @@ coef_nm(object, trans, ...)
 \arguments{
 \item{object}{object of class nmexecute}
 
-\item{...}{trans argument (default = TRUE). logical.  Should parameters be transformed}
+\item{trans}{logical. Default = TRUE. Should parameters be transformed}
+
+\item{...}{additional arguments to carry to coef}
 }
 \value{
 a \code{data.frame} of parameter values

---FILE: man/run_record.Rd---
@@ -9,7 +9,8 @@ run_record(..., trans = TRUE)
 \arguments{
 \item{...}{objects of class nmexecute}
 
-\item{coef.func}{function to generate coefficients}
+\item{trans}{logical (default=TRUE).
+If possible TRUE means transformation will be attempted}
 }
 \description{
 Run record"
tsahota,NMproject,e3126ab2c5d6d810fa3ef93ab1a091a398bd2310,Tarjinder Sahota,klgk669@semldxcalvin.seml.astrazeneca.net,2017-05-09T19:17:06Z,Tarjinder Sahota,klgk669@semldxcalvin.seml.astrazeneca.net,2017-05-09T19:17:06Z,fixed bug added test,R/nm.R;tests/testthat/test-plot_iter.R,False,True,True,False,10,3,13,"---FILE: R/nm.R---
@@ -110,7 +110,8 @@ nm <- function(cmd,psn_command,
   class(r) <- c(paste0(""nm"",r$type),class(r))
 
   r$input <- input_files(run_type = r$type,ctl_name = r$ctl)
-  r$output <- output_files(run_type = r$type,
+  r$output <- output_files(run_in = r$run_in,
+                           run_type = r$type,
                            run_dir = r$run_dir,
                            ctl_name = r$ctl)
 
@@ -382,7 +383,7 @@ input_files <- function(run_type,ctl_name){
   return(r)
 }
 
-output_files <- function(run_type,run_dir,ctl_name){
+output_files <- function(run_in,run_type,run_dir,ctl_name){
   r <- list()
   if(run_type %in% ""execute""){
     extn <- tools::file_ext(ctl_name)
@@ -394,7 +395,7 @@ output_files <- function(run_type,run_dir,ctl_name){
     r$psn.cov <- file.path(run_dir,""NM_run1"",""psn.cov"")
     r$psn.cor <- file.path(run_dir,""NM_run1"",""psn.cor"")
     r$psn.xml <- file.path(run_dir,""NM_run1"",""psn.xml"")
-    r$ctl_out_files <- file.path(run_dir,ctl_out_files(ctl_name))
+    r$ctl_out_files <- file.path(run_in,ctl_out_files(ctl_name))
   }
   return(r)
 }

---FILE: tests/testthat/test-plot_iter.R---
@@ -52,6 +52,12 @@ test_that(""db & plot_iter works"",{
 
   expect_error(nm(""qpsn -m -c auto -t 3000 -- execute run3.mod -dir=4""))
 
+  copy_control(""run2.mod"",""run5.mod"")
+  ctl <- readLines(""Models/run5.mod"")
+  ctl <- gsub(""sdtab5"",""sdtab2"",ctl) ## create an output conflict
+  write(ctl,""Models/run5.mod"")
+  expect_error(nm(""qpsn -m -c auto -t 3000 -- execute run5.mod -dir=5""))
+
   p <- plot_iter(m2,trans = FALSE)
   expect_true(inherits(p,""ggplot""))
 "
tsahota,NMproject,6e8dda5ae0905e526e1c967ab0f6a4847f835c3b,Tarjinder Sahota,klgk669@semldxcalvin.seml.astrazeneca.net,2017-05-07T11:18:52Z,Tarjinder Sahota,klgk669@semldxcalvin.seml.astrazeneca.net,2017-05-07T11:18:52Z,fixed cran checks,DESCRIPTION;NAMESPACE;R/ctl_handling.R;R/nm.R;R/plot_iter.R;R/run_record.R;R/status.R;man/coef.nm.Rd;man/plot_iter.Rd;man/rem_trailing_spaces.Rd;man/run_record0.Rd;man/run_type.Rd;tests/testthat/test-nm.R,False,True,True,False,67,88,155,"---FILE: DESCRIPTION---
@@ -16,5 +16,6 @@ RoxygenNote: 5.0.1
 Suggests:
     testthat,
     ggplot2,
-    tidyr
+    tidyr,
+    car
 

---FILE: NAMESPACE---
@@ -7,7 +7,6 @@ S3method(nm_tran,nm)
 S3method(print,nm)
 S3method(status,nmexecute)
 export(clean_run)
-export(coef_ext0)
 export(copy_control)
 export(ctl_nm2r)
 export(ctl_r2nm)

---FILE: R/ctl_handling.R---
@@ -104,13 +104,13 @@ theta_nm2r <- function(x){
     if(substr(x,1,1)!=""~""){
       x <- strsplit(x,""[ ,]"")[[1]]
       x <- x[!x %in% c("""",""FIX"")]
-      x <- as.numeric(x)
+      x <- suppressWarnings(as.numeric(x))
       x <- data.frame(lower=NA,init=x,upper=NA)
     } else {
       x <- gsub(""~"","""",x)
       x <- strsplit(x,""[ ,]"")[[1]]
       x <- x[!x %in% c("""",""FIX"")]
-      x <- as.numeric(x)
+      x <- suppressWarnings(as.numeric(x))
       #x <- as.data.frame(t(x))
       if(length(x)==1) x <- data.frame(lower=NA,init=x,upper=NA) else
         if(length(x)==2) x <- data.frame(lower=x[1],init=x[2],upper=NA) else
@@ -141,7 +141,6 @@ theta_nm2r <- function(x){
   x
 }
 
-#' remove trailing spaces
 rem_trailing_spaces <- function(x){
   x <- gsub(""\\s(?!\\S)"","""",x,perl = TRUE)
   x <- gsub(""^\\s*"","""",x,perl = TRUE)

---FILE: R/nm.R---
@@ -116,6 +116,7 @@ nm <- function(cmd,psn_command,
       r$lst <- paste0(r$ctl,"".lst"")
     r$psn.lst <- file.path(r$run_dir,""NM_run1"",""psn.lst"")
     r$psn.ext <- file.path(r$run_dir,""NM_run1"",""psn.ext"")
+    r$psn.cov <- file.path(r$run_dir,""NM_run1"",""psn.cov"")
     r$psn.mod <- file.path(r$run_dir,""NM_run1"",""psn.mod"")
     r$param_info <- param_info(r$ctl)
   }

---FILE: R/plot_iter.R---
@@ -1,7 +1,14 @@
-plot_iter0 <- function(ext.file,p_info=NULL,skip=0,yvar=""OBJ""){
+#' Plot iterations vs parameters/OBJ
+#'
+#' @param r object of class nmexecute
+#' @param trans logical. should parameter transformations be performed
+#' @param skip numeric (default 0). how many iterations to skip when plotting
+#' @param yvar character (default = ""OBJ""). Name of variable/parameter to display
+#' @export
+plot_iter <- function(r,trans=TRUE,skip=0,yvar=""OBJ""){
 
-  d <- read_ext(ext.file = ext.file,p_info = p_info)
-  print(paste(""last.modified"",file.info(ext.file)$mtime))
+  d <- read_ext(r=r,trans=trans)
+  print(paste(""last.modified"",file.info(r$psn.ext)$mtime))
 
   d <- d[d$TYPE %in% c(""ITER"",""BURN""), ]
   d$EST.NAME2 <- paste(""$EST"",d$EST.NO,"":"",d$EST.NAME,sep="" "")
@@ -50,20 +57,3 @@ plot_iter0 <- function(ext.file,p_info=NULL,skip=0,yvar=""OBJ""){
   p
 }
 
-#' Plot iterations vs parameters/OBJ
-#'
-#' @param x object of class nm.execute
-#' @export
-
-plot_iter <- function(nm_obj,trans=TRUE,...){
-
-  if(!trans) return(plot_iter0(ext.file = nm_obj$psn.ext,...))
-
-  plot_iter0(ext.file = nm_obj$psn.ext,
-             p_info=param_info(nm_obj$ctl),
-             ...)
-
-}
-
-
-

---FILE: R/run_record.R---
@@ -1,4 +1,4 @@
-ext2coef <- function(extout){
+ext2coef <- function(extout,file_name){
   ## raw function to generate parameter table from ext.file.
   d <- extout
 
@@ -8,10 +8,11 @@ ext2coef <- function(extout){
   d <- d[,c(names(d)[grepl(""THETA|SIGMA|OMEGA"",names(d))],
             c(""OBJ"",""EST.NAME"",""EST.NO"",""EVALUATION"",""TYPE""))]
 
-  d <- tidyr::gather(d,Parameter,value,THETA1:OBJ)
-  d <- tidyr::spread(d,TYPE,value)
-  d <- dplyr::arrange(d,desc(EST.NO))
-  d$file <- ext.file
+  d <- tidyr::gather_(d,""Parameter"",""value"",
+                      names(d)[match(""THETA1"",names(d)):match(""OBJ"",names(d))])
+  d <- tidyr::spread_(d,""TYPE"",""value"")
+  d <- d[order(d$EST.NO,decreasing = TRUE),]
+  d$file <- file_name
 
   is.diag.omega <- grepl(""OMEGA.([0-9]+\\.)\\1"",d$Parameter)
   is.omega <- grepl(""OMEGA.([0-9]+\\.)+"",d$Parameter)
@@ -38,27 +39,26 @@ ext2coef <- function(extout){
   d$Type[grepl(""SIGMA"",par.char)] <- ""SIGMA""
   d$Type[grepl(""OBJ"",par.char)] <- ""OBJ""
   d$Type <- factor(d$Type,levels=c(""THETA"",""OMEGAVAR"",""OMEGACOV"",""SIGMA"",""OBJ""))
-  d <- dplyr::arrange(d,Type)
+  d <- d[order(d$Type),]
   d$Unit <- NA
   d$SEUnit <- NA
   d
 }
 
-#' Gets parameters values
-#'
-#' Produces data.frame of parameter values
-#' @param ext.file string of ext file
-#' @param p_info parameter info object
-#' @return a \code{data.frame} of parameter values
-#' @export coef_ext0
-
 coef_ext0 <- function(ext.file){
   ## raw function to generate parameter table from ext.file.
   extout <- read_ext0(ext.file = ext.file)
-  ext2coef(extout)
+  ext2coef(extout,file_name=ext.file)
 }
 
+#' Gets parameters values
+#'
+#' Produces data.frame of parameter values
+#' @param object object of class nmexecute
+#' @param ... trans argument (default = TRUE). logical.  Should parameters be transformed
+#' @return a \code{data.frame} of parameter values
 #' @export
+
 coef.nm <- function(object,...){
 
   trans_arg <- list(...)$trans
@@ -77,7 +77,11 @@ coef.nm <- function(object,...){
   ## TODO: read parameter names from $OMEGA
   ## either $OMEGA in same way as $THETA (but without units in comments)
   ## or $OMEGA BLOCK
-  d <- merge(dplyr::select(d,-Unit),dplyr::select(p,Name,Parameter,Unit,trans),all.x = TRUE,by=""Parameter"")
+
+  d0 <- d[,names(d)[!names(d) %in% ""Unit""]]
+  d1 <- p[,c(""Name"",""Parameter"",""Unit"",""trans"")]
+
+  d <- merge(d0,d1,all.x = TRUE,by=""Parameter"")
   d$Name[is.na(d$Name)] <- as.character(d$Parameter)[is.na(d$Name)]
   d$Name <- factor(d$Name,levels=d$Name)
   d$transUnit <- d$Unit
@@ -94,11 +98,12 @@ coef.nm <- function(object,...){
   d$transSEUnit[d$trans %in% c(""LOG"",""LOGODDS"")] <- ""%""
   ## LOGIT
   if(""LOGIT"" %in% d$trans){
-    delt <- plyr::ldply(which(d$trans %in% ""LOGIT""),function(i){
+    delt <- lapply(which(d$trans %in% ""LOGIT""),function(i){
       par <- c(logit=d$FINAL[i])
       separ <- c(logit=d$SE[i])
       car::deltaMethod(par,""1/(1+exp(-logit))"",vcov.=separ^2)
     })
+    delt <- do.call(rbind,delt)
     d$FINAL.TRANS[d$trans %in% ""LOGIT""] <- 100*delt$Estimate
     d$SE.TRANS[d$trans %in% ""LOGIT""] <- 100*delt$SE
     d$transUnit[d$trans %in% ""LOGIT""] <- ""%""
@@ -124,7 +129,7 @@ coef.nm <- function(object,...){
     ## know SE(COV[X,Y]) and SE[SDX^2] and SE[SDY^2]
     ## Need covariance matrix between these though - from .cov file.
     ## SQRT(VAR(COV[X,Y]/(SD[X]*SD[Y])))
-    cov.file <- from_models(file.path(run.dir,sub.dir,""psn.cov""))
+    cov.file <- object$psn.cov
     dc <- read.table(cov.file,skip=1,header = TRUE)
     for(i in seq_along(which(d$trans %in% ""COV""))){
       ## loop through each COV variable and generate absolute SE
@@ -164,19 +169,23 @@ coef.nm <- function(object,...){
 
 #' Run record
 #'
+#' @param ... objects of class nmexecute
+#' @param coef.func function to generate coefficients
 #' @export run_record0
-run_record0 <- function(..., coef.func = coef_ext0){
+run_record0 <- function(..., coef.func = c(coef_ext0,coef.nm)){
+  coef.func <- match.arg(coef.func)
   d <- lapply(list(...),coef.func)
   d <- do.call(rbind,d)
   d$Unit[is.na(d$Unit)] <- """"
   d$SEUnit[is.na(d$SEUnit)] <- """"
   if(""trans"" %in% d$trans) d$trans[is.na(d$trans)] <- """"   ## optional item
-  d <- dplyr::select(d,-EVALUATION, -EST.NO,-EST.NAME)
+  d <- d[,names(d)[!names(d) %in% c(""EVALUATION"", ""EST.NO"",""EST.NAME"")]]
   d$Estimate <- NA
   d$Estimate[d$Parameter!=""OBJ""] <- paste0(signif(d$FINAL[d$Parameter!=""OBJ""],3),"" ("",signif(d$SE[d$Parameter!=""OBJ""],3),d$SEUnit[d$Parameter!=""OBJ""],"")"")
   d$Estimate[d$Parameter==""OBJ""] <- round(d$FINAL[d$Parameter==""OBJ""],3)
-  d <- tidyr::spread(dplyr::select(d,-SE,-FINAL),file,Estimate)
-  d <- dplyr::arrange(d,Type,Parameter)
+  d <- d[,names(d)[!names(d) %in% c(""SE"",""FINAL"")]]
+  d <- tidyr::spread_(d,""file"",""Estimate"")
+  d <- d[order(d$Type,d$Parameter),]
   d$SEUnit <- NULL
   d
 }

---FILE: R/status.R---
@@ -6,7 +6,6 @@
 #' @export
 status <- function(x) UseMethod(""status"",x)
 
-#' get type of run
 run_type <- function(run.dir){  ## internal function: get type of run from directory
   if(!file.exists(file.path(run.dir,""command.txt""))) {
     warning(""can't find command.txt, assuming run is type \""execute\"""")
@@ -60,7 +59,7 @@ status_execute <- function(run_dir,sub.dir=""NM_run1""){
   r
 }
 
-status_scm <- function(x){
+status_scm <- function(run_dir){
 
   r <- data.frame(RUN=as.integer(basename(run_dir)),TYPE=run_type(run_dir),TEST=c(
     ""dir created"",
@@ -92,5 +91,5 @@ status_scm <- function(x){
 }
 
 #' @export
-status.nmexecute <- function(r) status_execute(r$run_dir)
+status.nmexecute <- function(x) status_execute(x$run_dir)
 

---FILE: man/coef.nm.Rd---
@@ -1,15 +1,15 @@
 % Generated by roxygen2: do not edit by hand
 % Please edit documentation in R/run_record.R
-\name{coef_ext0}
-\alias{coef_ext0}
+\name{coef.nm}
+\alias{coef.nm}
 \title{Gets parameters values}
 \usage{
-coef_ext0(ext.file)
+\method{coef}{nm}(object, ...)
 }
 \arguments{
-\item{ext.file}{string of ext file}
+\item{object}{object of class nmexecute}
 
-\item{p_info}{parameter info object}
+\item{...}{trans argument (default = TRUE). logical.  Should parameters be transformed}
 }
 \value{
 a \code{data.frame} of parameter values

---FILE: man/plot_iter.Rd---
@@ -4,10 +4,16 @@
 \alias{plot_iter}
 \title{Plot iterations vs parameters/OBJ}
 \usage{
-plot_iter(nm_obj, trans = TRUE, ...)
+plot_iter(r, trans = TRUE, skip = 0, yvar = ""OBJ"")
 }
 \arguments{
-\item{x}{object of class nm.execute}
+\item{r}{object of class nmexecute}
+
+\item{trans}{logical. should parameter transformations be performed}
+
+\item{skip}{numeric (default 0). how many iterations to skip when plotting}
+
+\item{yvar}{character (default = ""OBJ""). Name of variable/parameter to display}
 }
 \description{
 Plot iterations vs parameters/OBJ

---FILE: man/rem_trailing_spaces.Rd---
@@ -1,12 +0,0 @@
-% Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/ctl_handling.R
-\name{rem_trailing_spaces}
-\alias{rem_trailing_spaces}
-\title{remove trailing spaces}
-\usage{
-rem_trailing_spaces(x)
-}
-\description{
-remove trailing spaces
-}
-

---FILE: man/run_record0.Rd---
@@ -4,7 +4,12 @@
 \alias{run_record0}
 \title{Run record}
 \usage{
-run_record0(..., coef.func = coef_ext0)
+run_record0(..., coef.func = c(coef_ext0, coef.nm))
+}
+\arguments{
+\item{...}{objects of class nmexecute}
+
+\item{coef.func}{function to generate coefficients}
 }
 \description{
 Run record

---FILE: man/run_type.Rd---
@@ -1,12 +0,0 @@
-% Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/status.R
-\name{run_type}
-\alias{run_type}
-\title{get type of run}
-\usage{
-run_type(run.dir)
-}
-\description{
-get type of run
-}
-

---FILE: tests/testthat/test-nm.R---
@@ -28,14 +28,12 @@ test_that(""nm function works"",{
   expect_true(is.character(m1$run_id))
   expect_true(is.character(m1$run_dir))
   expect_true(identical(as.numeric(m1$run_id),1))
-  expect_true(identical(as.numeric(m1$run_dir),1))
 
   m2 <- nm(""qsubmissionscript -opt1 -opt2 -- execute run1.mod -dir=1"")
   expect_true(m2$type==""execute"")
   expect_true(is.character(m2$run_id))
   expect_true(is.character(m2$run_dir))
   expect_true(identical(as.numeric(m2$run_id),1))
-  expect_true(identical(as.numeric(m2$run_dir),1))
 
   write(c(""## Description: klm"",
           ""execute run1.mod -dir=1""),
@@ -46,14 +44,12 @@ test_that(""nm function works"",{
   expect_true(is.character(m3$run_id))
   expect_true(is.character(m3$run_dir))
   expect_true(identical(as.numeric(m3$run_id),1))
-  expect_true(identical(as.numeric(m3$run_dir),1))
 
   m4 <- nm(""qsubmissionscript -opt1 -opt2 shell=run1.sh"")
   expect_true(m4$type==""execute"")
   expect_true(is.character(m4$run_id))
   expect_true(is.character(m4$run_dir))
   expect_true(identical(as.numeric(m4$run_id),1))
-  expect_true(identical(as.numeric(m4$run_dir),1))
 
   expect_error(nm(""qsubmissionscript -opt1 -opt2 run2.sh""))
 
@@ -62,7 +58,5 @@ test_that(""nm function works"",{
   expect_true(is.character(m5$run_id))
   expect_true(is.character(m5$run_dir))
   expect_true(identical(as.numeric(m5$run_id),1))
-  expect_true(identical(as.numeric(m5$run_dir),1))
-
 
 })"
tsahota,NMproject,152f42d89dedbe89bb26456b8bd26e6b6d54c146,Tarjinder Sahota,klgk669@semldxcalvin.seml.astrazeneca.net,2017-03-24T01:33:16Z,Tarjinder Sahota,klgk669@semldxcalvin.seml.astrazeneca.net,2017-03-24T01:33:16Z,bug fix,NAMESPACE;R/NMproject.R;R/nm.R,False,True,True,False,14,20,34,"---FILE: NAMESPACE---
@@ -1,6 +1,7 @@
 # Generated by roxygen2: do not edit by hand
 
 S3method(data_name,default)
+S3method(nm_tran,default)
 export(clean_run)
 export(copy_control)
 export(data_name)

---FILE: R/NMproject.R---
@@ -201,6 +201,7 @@ is_nm_file_name <- function(x,error_if_false=FALSE){
 #' @export
 nm_tran <- function(x) UseMethod(""nm_tran"")
 
+#' @export
 nm_tran.default <- function(x){
   if(is.null(getOption(""path.nm_tran""))) {
     message(""Path to nmtran not set. To set add the following command:"")

---FILE: R/nm.R---
@@ -70,13 +70,14 @@ nm <- function(cmd,psn_command,
       stop(""couldn't infer psn command type.\nRerun with psn_command argument"")
     if(length(matched_psn_commands)>1)
       stop(""couldn't infer unique psn command type.\nRerun with psn_command argument"")
+    message(paste(""inferring run type :"",matched_psn_commands))
     r$type <- matched_psn_commands
-    message(paste(""inferring run type :"",r$type))
   }
 
   if(is.null(r$ctl)){
     subcmd <- gsub(paste0(""^.*("",r$type,"".*)$""),""\\1"",cmd)
     matched_ctl <- gsub2(paste0(""^.*("",getOption(""model_file_stub""),""\\S+)\\s*.*$""),""\\1"",cmd)
+    message(paste(""inferring ctl file :"",matched_ctl))
     r$ctl <- matched_ctl
   }
 
@@ -87,7 +88,7 @@ nm <- function(cmd,psn_command,
       stop(""couldn't infer run directory type.\nRerun with run_dir argument"")
     if(length(matched_run_dir)>1)
       stop(""couldn't infer unique run directory type.\nRerun with run_dir argument"")
-    message(paste(""inferring run directory :"",r$run_dir))
+    message(paste(""inferring run directory :"",matched_run_dir))
     r$run_dir <- matched_run_dir
   }
 
@@ -117,7 +118,7 @@ nm <- function(cmd,psn_command,
 print.nm <- function(x,...) str(x)
 
 ctl_name <- function(run_id)
-  paste0(getOption(""model_file_stub""),run_id,getOption(""model_file_extn""))
+  paste0(getOption(""model_file_stub""),run_id,""."",getOption(""model_file_extn""))
 
 gsub2 <- function(pattern,replacement,x,...){
   match <- grepl(pattern,x,...)
@@ -130,20 +131,6 @@ get_run_id <- function(ctl_name){
   gsub2(match,""\\1"",ctl_name)
 }
 
-
-
-# data_name0 <- function(ctl){
-#   s <- ctl
-#   if(length(ctl)==1) {
-#     if(file.exists(ctl)) s <- readLines(ctl) else stop(""can't process argument"")
-#   }
-#   data.row <- grep(""^ *\\$DATA"",s)
-#   if(length(data.row)<1) stop(""can't identify data row"")
-#   if(length(data.row)>1) stop(""multiple data rows found"")
-#   s <- paste(s[data.row:length(s)],collapse = "" "")
-#   gsub(""^ *\\$DATA\\s*([^ ]+).*$"",""\\1"",s)
-# }
-
 #' Load nm object into memory from script
 #'
 # nm_load <- function(script){
@@ -167,16 +154,21 @@ run <- function(...,overwrite=FALSE){
   rl <- list(...)
   lapply(rl,function(r){
     ## if directory exists, and if it's definately a directory stop
-    if(file.exists(r$dir) & !overwrite)if(file.info(r$dir)$isdir %in% TRUE) stop(""run already exists. To rerun select overwrite=TRUE"")
-    if(!is.null(get(""kill_run""))){
-      get(""kill_run"")(r)
+    if(file.exists(r$run_dir) & !overwrite)if(file.info(r$run_dir)$isdir %in% TRUE) stop(""run already exists. To rerun select overwrite=TRUE"")
+    if(!is.null(getOption(""kill_run""))){
+      getOption(""kill_run"")(r)
     }
     clean_run(r$run_id)
     system_nm(r$cmd)
   })
   invisible()
 }
 
+#' @export
+nm_tran.nm <- function(x){
+  nm_tran.default(from_models(x$ctl))
+}
+
 #' clean_run files
 #'
 #' @param run_id character or numeric. run identifier"
