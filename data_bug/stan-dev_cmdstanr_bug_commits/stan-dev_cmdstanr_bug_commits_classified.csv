repo_owner,repo_name,commit_hash,author,author_email,date,committer_name,committer_email,committer_date,message,filenames,touches_rmd,touches_r,touches_r_or_rmd,is_merge,added,deleted,changed,diff,_touch_r,_touch_rmd,bug_category,category_score
stan-dev,cmdstanr,0fb8cb4853511b3143db9c038fc267ad9fed2f07,Aki Vehtari,Aki.Vehtari@aalto.fi,2025-11-10T09:38:13Z,Aki Vehtari,Aki.Vehtari@aalto.fi,2025-11-10T09:38:13Z,fix optimize doc Jacobian description,R/model.R,False,True,True,False,13,9,22,"---FILE: R/model.R---
@@ -1447,14 +1447,18 @@ CmdStanModel$set(""public"", name = ""sample_mpi"", value = sample_mpi)
 #' @family CmdStanModel methods
 #'
 #' @description The `$optimize()` method of a [`CmdStanModel`] object runs
-#'   Stan's optimizer to obtain a (penalized) maximum likelihood estimate (MLE)
-#'   or a maximum a posteriori estimate (MAP), depending on the value of the
-#'   `jacobian` argument. For models with constrained parameters, when the
-#'   Jacobian adjustment is *not* applied, the point estimate corresponds to a
-#'   penalized MLE, and when the Jacobian adjustment is applied the point
-#'   estimate corresponds to the MAP (posterior mode) of the model we would fit
-#'   if we were instead doing MCMC sampling. The Jacobian adjustment has no
-#'   affect if the model has only unconstrained parameters. See the
+#'   Stan's optimizer to find a posterior mode. If the Jacobian adjustment
+#'   is not included (the default), the optimization returns parameter
+#'   values that correspond to a mode of the target in the constrained
+#'   space (if such mode exists). Thus this option is useful for any
+#'   optimization where we want to find the mode in the original
+#'   constrained parameter space. If the Jacobian adjustment is included,
+#'   the optimization returns parameter values that correspond to a mode
+#'   in the unconstrained space. This is useful, for example, if we want
+#'   to make a distributional approximation of the posterior at the mode
+#'   (see, Laplace sampling, as then Jacobian adjustment needs to be
+#'   included for correct results. If the model has only unconstrained
+#'   parameters, there is no effect from including the Jacobian. See the
 #'   [CmdStan User's Guide](https://mc-stan.org/docs/cmdstan-guide/index.html)
 #'   for more details.
 #'
@@ -2372,4 +2376,4 @@ resolve_exe_path <- function(
     exe <- self_exe_file
   }
   exe
-}
\ No newline at end of file
+}",True,False,Implementation / Logic,6
stan-dev,cmdstanr,1f63b8979a08aca943c736fc5eff105a97b8ca98,Brock,keb266@cornell.edu,2025-08-08T10:52:06Z,GitHub,noreply@github.com,2025-08-08T10:52:06Z,fix typo,.github/workflows/R-CMD-check.yaml,False,False,False,False,1,1,2,"---FILE: .github/workflows/R-CMD-check.yaml---
@@ -36,7 +36,7 @@ jobs:
       GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
       NOT_CRAN: true
       CMDSTANR_OPENCL_TESTS: ${{ matrix.config.opencl }}
-      PKG_SYSREQS_DB_UPDATE_TIMEOUT: 30
+      PKG_SYSREQS_DB_UPDATE_TIMEOUT: 30s
 
     steps:
       - name: cmdstan env vars",False,False,Data / Input Handling,3
stan-dev,cmdstanr,bafae1f9a0bcca729d8e6e59ece9d490504e7c76,Brock,kbrock@ab.mpg.de,2025-06-06T11:49:55Z,Brock,kbrock@ab.mpg.de,2025-06-06T11:49:55Z,fix read_cmdstan_csv tilde issue,DESCRIPTION;R/csv.R;tests/testthat/test-csv.R,False,True,True,False,10,1,11,"---FILE: DESCRIPTION---
@@ -48,6 +48,7 @@ Imports:
     rlang (>= 0.4.7)
 Suggests:
     bayesplot,
+    fs,
     ggplot2,
     knitr (>= 1.37),
     loo (>= 2.0.0),

---FILE: R/csv.R---
@@ -254,7 +254,7 @@ read_cmdstan_csv <- function(files,
         ""\""""
       )
     } else {
-      fread_cmd <- paste0(""grep -v '^#' --color=never '"", output_file, ""'"")
+      fread_cmd <- paste0(""grep -v '^#' --color=never '"", path.expand(output_file), ""'"")
     }
     if (length(sampler_diagnostics) > 0) {
       post_warmup_sd_id <- length(post_warmup_sampler_diagnostics) + 1

---FILE: tests/testthat/test-csv.R---
@@ -888,3 +888,11 @@ test_that(""read_cmdstan_csv works if no variables are specified"", {
     read_cmdstan_csv(fit_bernoulli_thin_1$output_files(), variables = """", sampler_diagnostics = """")
   )
 })
+
+test_that(""read_cmdstan_csv() works with tilde expansion"", {
+  skip_if(os_is_windows())
+  full_path <- test_path(""resources"", ""csv"", ""model1-1-warmup.csv"")
+  expect_no_error(read_cmdstan_csv(full_path))
+  tildified_path <- file.path(""~"", fs::path_rel(full_path, ""~""))
+  expect_no_error(read_cmdstan_csv(tildified_path))
+})",True,False,Dependency / Package,6
stan-dev,cmdstanr,dde1164dd2be9103b113db4a0d6d7b58b9ae1f56,Brock,kbrock@ab.mpg.de,2025-05-02T09:02:03Z,Brock,kbrock@ab.mpg.de,2025-05-02T09:02:03Z,fix test/code mismatch and add docs,R/cpp_opts.R;tests/testthat/test-opencl.R,False,True,True,False,17,7,24,"---FILE: R/cpp_opts.R---
@@ -2,6 +2,7 @@
 
 # running and parsing exe info --------------------------------
 # run <model> info command
+#' @example `.cmdstan/bin`
 run_info_cli <- function(exe_file) {
   withr::with_path(
     c(
@@ -76,6 +77,7 @@ model_compile_info <- function(exe_file, version) {
 }
 
 # convert to compile flags --------------------
+# from list(flag1=TRUE, flag2=FALSE) to ""FLAG1=TRUE\nFLAG2=FALSE""
 cpp_options_to_compile_flags <- function(cpp_options) {
   if (length(cpp_options) == 0) {
     return(NULL)
@@ -94,7 +96,8 @@ cpp_options_to_compile_flags <- function(cpp_options) {
 
 
 # check options overall for validity ---------------------------------
-
+# takes list of options as input and returns list of options
+# returns list with names standardized to lowercase
 validate_cpp_options <- function(cpp_options) {
   if (is.null(cpp_options) || length(cpp_options) == 0) return(list())
 
@@ -129,7 +132,9 @@ validate_cpp_options <- function(cpp_options) {
 }
 
 # check specific options for validity ---------------------------------
-
+# no type checking for opencl_ids
+# cpp_options must be a list
+# opencl_ids returned unchanged
 assert_valid_opencl <- function(opencl_ids, cpp_options) {
   if (is.null(cpp_options[[""stan_opencl""]])
       && !is.null(opencl_ids)) {
@@ -140,6 +145,7 @@ assert_valid_opencl <- function(opencl_ids, cpp_options) {
   invisible(opencl_ids)
 }
 
+# cpp_options must be a list
 assert_valid_threads <- function(threads, cpp_options, multiple_chains = FALSE) {
   threads_arg <- if (multiple_chains) ""threads_per_chain"" else ""threads""
   checkmate::assert_integerish(threads, .var.name = threads_arg,
@@ -164,7 +170,11 @@ assert_valid_threads <- function(threads, cpp_options, multiple_chains = FALSE)
   invisible(threads)
 }
 
-# compare exe info and cpp options to one another
+# For two functions below
+# both styles are lists which should have flag names in lower case as names of the list
+# cpp_options style means is NULL or empty string
+# exe_info style means off is FALSE
+
 exe_info_style_cpp_options <- function(cpp_options) {
   if(is.null(cpp_options)) cpp_options <- list()
   names(cpp_options) <- tolower(names(cpp_options))

---FILE: tests/testthat/test-opencl.R---
@@ -8,24 +8,24 @@ test_that(""all methods error when opencl_ids is used with non OpenCL model"", {
   mod <- cmdstan_model(stan_file = stan_file)
   expect_error(
     mod$sample(data = testing_data(""bernoulli""), opencl_ids = c(0, 0), chains = 1),
-    ""'opencl_ids' is set but the model was not compiled with for use with OpenCL."",
+    ""'opencl_ids' is set but the model was not compiled for use with OpenCL."",
     fixed = TRUE
   )
   expect_error(
     mod$optimize(data = testing_data(""bernoulli""), opencl_ids = c(0, 0)),
-    ""'opencl_ids' is set but the model was not compiled with for use with OpenCL."",
+    ""'opencl_ids' is set but the model was not compiled for use with OpenCL."",
     fixed = TRUE
   )
   expect_error(
     mod$variational(data = testing_data(""bernoulli""), opencl_ids = c(0, 0)),
-    ""'opencl_ids' is set but the model was not compiled with for use with OpenCL."",
+    ""'opencl_ids' is set but the model was not compiled for use with OpenCL."",
     fixed = TRUE
   )
   stan_file_gq <- testing_stan_file(""bernoulli_ppc"")
   mod_gq <- cmdstan_model(stan_file = stan_file_gq)
   expect_error(
     mod_gq$generate_quantities(fitted_params = fit, data = testing_data(""bernoulli""), opencl_ids = c(0, 0)),
-    ""'opencl_ids' is set but the model was not compiled with for use with OpenCL."",
+    ""'opencl_ids' is set but the model was not compiled for use with OpenCL."",
     fixed = TRUE
   )
 })",True,False,Implementation / Logic,6
stan-dev,cmdstanr,d174ce11b083dfb849c3bc3c41d2f722b736247e,Brock,kbrock@ab.mpg.de,2025-04-30T11:20:50Z,Brock,kbrock@ab.mpg.de,2025-04-30T11:21:32Z,Fix windows issue,tests/testthat/test-model-compile-user_header.R,False,True,True,False,87,22,109,"---FILE: tests/testthat/test-model-compile-user_header.R---
@@ -2,11 +2,13 @@ skip_if(os_is_macos())
 
 file_that_exists <- ""placeholder_exists""
 file_that_doesnt_exist <- ""placeholder_doesnt_exist""
-file.create(file_that_exists)
-withr::defer(
-  if (file.exists(file_that_exists)) file.remove(file_that_exists),
-  teardown_env()
-)
+withr::local_file(file_that_exists)
+
+w_path <- function(f) {
+  x <- sapply(f, function(fi) wsl_safe_path(absolute_path(fi)))
+  names(x) <- NULL
+  x
+}
 
 make_local_orig <- cmdstan_make_local()
 cmdstan_make_local(cpp_options = list(""PRECOMPILED_HEADERS"" = ""false""))
@@ -34,8 +36,7 @@ namespace bernoulli_external_model_namespace
 }""
 
 test_that(""cmdstan_model works with user_header with mock"", {
-  tmpfile <- tempfile(fileext = "".hpp"")
-  cat(hpp, file = tmpfile, sep = ""\n"")
+  tmpfile <- withr::local_tempfile(lines = hpp, fileext = "".hpp"")
 
   with_mocked_cli(
     compile_ret = list(status = 0),
@@ -138,12 +139,76 @@ test_that(""cmdstan_model works with user_header with mock"", {
   )
 })
 
-test_that(""user_header precedence order is correct"", {
+test_that(""wsl path conversion is done as expected"", {
+  tmp_file <- withr::local_tempfile(lines = hpp, fileext = "".hpp"")
+ # Case 1: arg
+  with_mocked_cli(
+    compile_ret = list(status = 1),
+    info_ret = list(),
+    code = {
+      mod <- cmdstan_model(
+        stan_file = testing_stan_file(""bernoulli_external""),
+        user_header = tmp_file,
+        dry_run = TRUE
+      )
+    }
+  )
 
-  tmp_files <- sapply(1:3, function(n) wsl_safe_path(absolute_path(tempfile(fileext = "".hpp""))))
-  sapply(tmp_files, function(filename) cat(hpp, file = filename, sep = ""\n""))
-  withr::defer(lapply(tmp_files, function(filename) file.remove(filename)))
+  # USER_HEADER is converted
+  # user_header is NULL
+  expect_equal(mod$cpp_options()[['USER_HEADER']],  w_path(tmp_file))
+  expect_true(is.null(mod$cpp_options()[['user_header']]))
 
+  # Case 2: cpp opt USER_HEADER
+  with_mocked_cli(
+    compile_ret = list(status = 1),
+    info_ret = list(),
+    code = {
+      mod <- cmdstan_model(
+        stan_file = testing_stan_file(""bernoulli_external""),
+        cpp_options = list(
+          USER_HEADER = tmp_file
+        ),
+        dry_run = TRUE
+      )
+    }
+  )
+
+  # USER_HEADER is converted
+  # user_header is unconverted
+  expect_equal(mod$cpp_options()[['USER_HEADER']],  w_path(tmp_file))
+  expect_true(is.null(mod$cpp_options()[['user_header']]))
+
+  # Case # 3: only user_header opt
+  with_mocked_cli(
+    compile_ret = list(status = 1),
+    info_ret = list(),
+    code = {
+      mod <- cmdstan_model(
+        stan_file = testing_stan_file(""bernoulli_external""),
+        cpp_options = list(
+          user_header = tmp_file
+        ),
+        dry_run = TRUE
+      )
+    }
+  )
+
+
+  # In  other cases, in the *output* USER_HEADER is windows style user_header is not.
+  # In this case, USER_HEADER is null.
+  expect_true(is.null(mod$cpp_options()[['USER_HEADER']]))
+  expect_equal(mod$cpp_options()[['user_header']],  w_path(tmp_file))
+})
+
+test_that(""user_header precedence order is correct"", {
+  tmp_files <- sapply(1:3, function(n) withr::local_tempfile(
+    lines = hpp,
+    fileext = "".hpp"",
+    .local_envir = parent.frame(3)
+  ))
+
+  # Case # 1: all 3 specified
   with_mocked_cli(
     compile_ret = list(status = 1),
     info_ret = list(),
@@ -159,20 +224,20 @@ test_that(""user_header precedence order is correct"", {
       )
     }, ""User header specified both"")
   )
-  
   # In this case:
   # cpp_options[['USER_HEADER']] == tmp_files[1] <- actually used
   # cpp_options[['user_header']] == tmp_files[3] <- ignored
   # tmp_files[2] is not stored
   expect_equal(
-    which(mod$cpp_options()[['USER_HEADER']] == tmp_files),
+    match(!!(mod$cpp_options()[['USER_HEADER']]), w_path(tmp_files)),
     1
   )
   expect_equal(
-    which(mod$cpp_options()[['user_header']] == tmp_files),
+    match(!!(mod$cpp_options()[['user_header']]), tmp_files),
     3
   )
 
+  # Case # 2: Both opts, but no arg
   with_mocked_cli(
     compile_ret = list(status = 1),
     info_ret = list(),
@@ -188,18 +253,19 @@ test_that(""user_header precedence order is correct"", {
     }, ""User header specified both"")
   )
   # In this case:
-  # cpp_options[['USER_HEADER']] == tmp_files[2] <- actually used
-  # cpp_options[['user_header']] == tmp_files[3] <- ignored
+  # cpp_options[['USER_HEADER']] == tmp_files[2]
+  # cpp_options[['user_header']] == tmp_files[3]
   # tmp_files[2] is not stored
   expect_equal(
-    which(mod$cpp_options()[[""USER_HEADER""]] == tmp_files),
+    match(!!(mod$cpp_options()[['USER_HEADER']]), w_path(tmp_files)),
     2
   )
   expect_equal(
-    which(mod$cpp_options()[[""user_header""]] == tmp_files),
+    match(!!(mod$cpp_options()[['user_header']]), tmp_files),
     3
   )
 
+  # Case # 3: Both opts, other order
   with_mocked_cli(
     compile_ret = list(status = 1),
     info_ret = list(),
@@ -214,14 +280,13 @@ test_that(""user_header precedence order is correct"", {
       )
     }, ""User header specified both"")
   )
-  # Same as above
+  # Same as Case #2
   expect_equal(
-    which(mod$cpp_options()[[""USER_HEADER""]] == tmp_files),
+    match(!!(mod$cpp_options()[['USER_HEADER']]), w_path(tmp_files)),
     2
   )
   expect_equal(
-    which(mod$cpp_options()[[""user_header""]] == tmp_files),
+    match(!!(mod$cpp_options()[['user_header']]), tmp_files),
     3
   )
-
 })
\ No newline at end of file",True,False,Implementation / Logic,6
stan-dev,cmdstanr,a193ec5d05f8fc970c761f29a0e4f0a5a74a9a7b,Brock,kbrock@ab.mpg.de,2025-04-28T10:23:22Z,Brock,kbrock@ab.mpg.de,2025-04-30T11:21:32Z,Add user_header regression tests,tests/testthat/test-model-compile-user_header.R,False,True,True,False,227,0,227,"---FILE: tests/testthat/test-model-compile-user_header.R---
@@ -0,0 +1,227 @@
+
+file_that_exists <- ""placeholder_exists""
+file_that_doesnt_exist <- ""placeholder_doesnt_exist""
+file.create(file_that_exists)
+withr::defer(
+  if (file.exists(file_that_exists)) file.remove(file_that_exists),
+  teardown_env()
+)
+
+make_local_orig <- cmdstan_make_local()
+cmdstan_make_local(cpp_options = list(""PRECOMPILED_HEADERS"" = ""false""))
+
+withr::defer(
+  cmdstan_make_local(cpp_options = make_local_orig, append = FALSE)
+)
+
+hpp <- ""
+#include <stan/math.hpp>
+#include <boost/math/tools/promotion.hpp>
+#include <ostream>
+
+namespace bernoulli_external_model_namespace
+{
+    template <typename T0__,
+          stan::require_all_t<stan::is_stan_scalar<T0__>>* = nullptr>
+    inline typename boost::math::tools::promote_args<T0__>::type make_odds(
+      const T0__ & theta,
+      std::ostream *pstream__
+    )
+    {
+        return theta / (1 - theta);
+    }
+}""
+
+test_that(""cmdstan_model works with user_header with mock"", {
+  skip_if(os_is_macos())
+  tmpfile <- tempfile(fileext = "".hpp"")
+  cat(hpp, file = tmpfile, sep = ""\n"")
+
+  with_mocked_cli(
+    compile_ret = list(status = 0),
+    info_ret = list(),
+    code = expect_mock_compile(
+      mod <- cmdstan_model(
+        stan_file = testing_stan_file(""bernoulli_external""),
+        exe_file = file_that_exists,
+        user_header = tmpfile
+      )
+    )
+  )
+
+  with_mocked_cli(
+    compile_ret = list(status = 0),
+    info_ret = list(),
+    code = expect_mock_compile({
+      mod_2 <- cmdstan_model(
+        stan_file = testing_stan_file(""bernoulli_external""),
+        exe_file = file_that_doesnt_exist,
+        cpp_options = list(USER_HEADER = tmpfile),
+        stanc_options = list(""allow-undefined"")
+      )
+    })
+  )
+
+  # Check recompilation upon changing header
+  file.create(file_that_exists)
+  with_mocked_cli(
+    compile_ret = list(status = 0),
+    info_ret = list(),
+    code = expect_no_mock_compile({
+      mod$compile(quiet = TRUE, user_header = tmpfile)
+    })
+  )
+
+  Sys.setFileTime(tmpfile, Sys.time() + 1) # touch file to trigger recompile
+  with_mocked_cli(
+    compile_ret = list(status = 0),
+    info_ret = list(),
+    code = expect_mock_compile({
+      mod$compile(quiet = TRUE, user_header = tmpfile)
+    })
+  )
+
+  # mock does not automatically update file mtime
+  Sys.setFileTime(mod$exe_file(), Sys.time() + 1) # touch file to trigger recompile
+
+  # Alternative spec of user header
+  with_mocked_cli(
+    compile_ret = list(status = 0),
+    info_ret = list(),
+    code = expect_no_mock_compile({
+      mod$compile(
+        quiet = TRUE,
+        cpp_options = list(user_header = tmpfile),
+        dry_run = TRUE
+      )
+    })
+  )
+
+  # Error/warning messages
+  with_mocked_cli(
+    compile_ret = list(status = 1),
+    info_ret = list(),
+    code = expect_error(
+      cmdstan_model(
+        stan_file = testing_stan_file(""bernoulli_external""),
+        cpp_options = list(USER_HEADER = ""non_existent.hpp""),
+        stanc_options = list(""allow-undefined"")
+      ),
+      ""header file '[^']*' does not exist""
+    )
+  )
+
+  with_mocked_cli(
+    compile_ret = list(status = 1),
+    info_ret = list(),
+    code = expect_warning(
+      cmdstan_model(
+        stan_file = testing_stan_file(""bernoulli_external""),
+        cpp_options = list(USER_HEADER = tmpfile, user_header = tmpfile),
+        dry_run = TRUE
+      ),
+      ""User header specified both""
+    )
+  )
+  with_mocked_cli(
+    compile_ret = list(status = 1),
+    info_ret = list(),
+    code = expect_warning(
+      cmdstan_model(
+        stan_file = testing_stan_file(""bernoulli_external""),
+        user_header = tmpfile,
+        cpp_options = list(USER_HEADER = tmpfile),
+        dry_run = TRUE
+      ),
+      ""User header specified both""
+    )
+  )
+})
+
+test_that(""user_header precedence order is correct"", {
+
+  tmp_files <- sapply(1:3, function(n) tempfile(fileext = "".hpp""))
+  sapply(tmp_files, function(filename) cat(hpp, file = filename, sep = ""\n""))
+  withr::defer(lapply(tmp_files, function(filename) file.remove(filename)))
+
+  with_mocked_cli(
+    compile_ret = list(status = 1),
+    info_ret = list(),
+    code = expect_warning({
+      mod <- cmdstan_model(
+        stan_file = testing_stan_file(""bernoulli_external""),
+        user_header = tmp_files[1],
+        cpp_options = list(
+          USER_HEADER = tmp_files[2],
+          user_header = tmp_files[3]
+        ),
+        dry_run = TRUE
+      )
+    }, ""User header specified both"")
+  )
+  
+  # In this case:
+  # cpp_options[['USER_HEADER']] == tmp_files[1] <- actually used
+  # cpp_options[['user_header']] == tmp_files[3] <- ignored
+  # tmp_files[2] is not stored
+  expect_equal(
+    which(mod$cpp_options()[['USER_HEADER']] == tmp_files),
+    1
+  )
+  expect_equal(
+    which(mod$cpp_options()[['user_header']] == tmp_files),
+    3
+  )
+
+  with_mocked_cli(
+    compile_ret = list(status = 1),
+    info_ret = list(),
+    code = expect_warning({
+      mod <- cmdstan_model(
+        stan_file = testing_stan_file(""bernoulli_external""),
+        cpp_options = list(
+          USER_HEADER = tmp_files[2],
+          user_header = tmp_files[3]
+        ),
+        dry_run = TRUE
+      )
+    }, ""User header specified both"")
+  )
+  # In this case:
+  # cpp_options[['USER_HEADER']] == tmp_files[2] <- actually used
+  # cpp_options[['user_header']] == tmp_files[3] <- ignored
+  # tmp_files[2] is not stored
+  expect_equal(
+    which(mod$cpp_options()[[""USER_HEADER""]] == tmp_files),
+    2
+  )
+  expect_equal(
+    which(mod$cpp_options()[[""user_header""]] == tmp_files),
+    3
+  )
+
+  with_mocked_cli(
+    compile_ret = list(status = 1),
+    info_ret = list(),
+    code = expect_warning({
+      mod <- cmdstan_model(
+        stan_file = testing_stan_file(""bernoulli_external""),
+        cpp_options = list(
+          user_header = tmp_files[3],
+          USER_HEADER = tmp_files[2]
+        ),
+        dry_run = TRUE
+      )
+    }, ""User header specified both"")
+  )
+  # Same as above
+  expect_equal(
+    which(mod$cpp_options()[[""USER_HEADER""]] == tmp_files),
+    2
+  )
+  expect_equal(
+    which(mod$cpp_options()[[""user_header""]] == tmp_files),
+    3
+  )
+
+})
\ No newline at end of file",True,False,Implementation / Logic,6
stan-dev,cmdstanr,8929623ca9bd2906f6f5cbfcee4312d39d1460e4,Brock,kbrock@ab.mpg.de,2025-04-15T10:49:54Z,Brock,kbrock@ab.mpg.de,2025-04-15T11:49:06Z,fix failure,R/model.R,False,True,True,False,7,1,8,"---FILE: R/model.R---
@@ -234,7 +234,7 @@ CmdStanModel <- R6::R6Class(
     precompile_stanc_options_ = NULL,
     precompile_include_paths_ = NULL,
     variables_ = NULL,
-    cmdstan_version_ = cmdstan_version()
+    cmdstan_version_ = NULL
   ),
   public = list(
     functions = NULL,
@@ -272,6 +272,12 @@ CmdStanModel <- R6::R6Class(
       if (!is.null(stan_file) && compile) {
         self$compile(...)
       }
+
+      # for now, set this based on current version
+      # at initialize so its never null
+      # in the future, will be set only if/when we have a binary
+      # as the version the model was compiled with
+      private$cmdstan_version_ <- cmdstan_version()
       if (length(self$exe_file()) > 0 && file.exists(self$exe_file())) {
         cpp_options <- model_compile_info(self$exe_file(), self$cmdstan_version())
         for (cpp_option_name in names(cpp_options)) {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,b5da12f358d0889274caaf265eac835276b7f828,Brock,kbrock@ab.mpg.de,2025-04-14T16:10:15Z,Brock,kbrock@ab.mpg.de,2025-04-15T08:48:55Z,Workaround for https://github.com/r-lib/pak/issues/755,.github/workflows/R-CMD-check.yaml,False,False,False,False,1,0,1,"---FILE: .github/workflows/R-CMD-check.yaml---
@@ -36,6 +36,7 @@ jobs:
       GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
       NOT_CRAN: true
       CMDSTANR_OPENCL_TESTS: ${{ matrix.config.opencl }}
+      PKG_SYSREQS_DB_UPDATE_TIMEOUT: 30
 
     steps:
       - name: cmdstan env vars",False,False,Data / Input Handling,3
stan-dev,cmdstanr,c75bd1364a0b9ae28ac8cf91413280769342ad02,dependabot[bot],49699333+dependabot[bot]@users.noreply.github.com,2025-03-24T20:05:43Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2025-03-26T01:33:37Z,"Bump r-lib/actions from 2.11.2 to 2.11.3

Bumps [r-lib/actions](https://github.com/r-lib/actions) from 2.11.2 to 2.11.3.
- [Release notes](https://github.com/r-lib/actions/releases)
- [Changelog](https://github.com/r-lib/actions/blob/v2-branch/NEWS.md)
- [Commits](https://github.com/r-lib/actions/compare/v2.11.2...v2.11.3)

---
updated-dependencies:
- dependency-name: r-lib/actions
  dependency-type: direct:production
  update-type: version-update:semver-patch
...

Signed-off-by: dependabot[bot] <support@github.com>",.github/workflows/R-CMD-check-wsl.yaml;.github/workflows/R-CMD-check.yaml;.github/workflows/Test-coverage.yaml;.github/workflows/cmdstan-tarball-check.yaml,False,False,False,False,13,13,26,"---FILE: .github/workflows/R-CMD-check-wsl.yaml---
@@ -38,10 +38,10 @@ jobs:
 
       - uses: actions/checkout@v4
 
-      - uses: r-lib/actions/setup-r@v2.11.2
-      - uses: r-lib/actions/setup-pandoc@v2.11.2
+      - uses: r-lib/actions/setup-r@v2.11.3
+      - uses: r-lib/actions/setup-pandoc@v2.11.3
 
-      - uses: r-lib/actions/setup-r-dependencies@v2.11.2
+      - uses: r-lib/actions/setup-r-dependencies@v2.11.3
         with:
           extra-packages: any::rcmdcheck, local::.
 
@@ -71,7 +71,7 @@ jobs:
           sessioninfo::session_info(pkgs, include_base = TRUE)
         shell: Rscript {0}
 
-      - uses: r-lib/actions/check-r-package@v2.11.2
+      - uses: r-lib/actions/check-r-package@v2.11.3
         env:
           _R_CHECK_CRAN_INCOMING_: false
 

---FILE: .github/workflows/R-CMD-check.yaml---
@@ -50,14 +50,14 @@ jobs:
 
       - uses: actions/checkout@v4
 
-      - uses: r-lib/actions/setup-r@v2.11.2
+      - uses: r-lib/actions/setup-r@v2.11.3
         with:
           r-version: ${{ matrix.config.r }}
           rtools-version: ${{ matrix.config.rtools }}
 
-      - uses: r-lib/actions/setup-pandoc@v2.11.2
+      - uses: r-lib/actions/setup-pandoc@v2.11.3
 
-      - uses: r-lib/actions/setup-r-dependencies@v2.11.2
+      - uses: r-lib/actions/setup-r-dependencies@v2.11.3
         with:
           cache: ""always""
           extra-packages: any::rcmdcheck, local::.
@@ -90,7 +90,7 @@ jobs:
           sessioninfo::session_info(pkgs, include_base = TRUE)
         shell: Rscript {0}
 
-      - uses: r-lib/actions/check-r-package@v2.11.2
+      - uses: r-lib/actions/check-r-package@v2.11.3
         env:
           _R_CHECK_CRAN_INCOMING_: false
 

---FILE: .github/workflows/Test-coverage.yaml---
@@ -42,10 +42,10 @@ jobs:
         if: ""!startsWith(github.ref, 'refs/tags/') && github.ref != 'refs/heads/master'""
       - uses: actions/checkout@v4
 
-      - uses: r-lib/actions/setup-r@v2.11.2
-      - uses: r-lib/actions/setup-pandoc@v2.11.2
+      - uses: r-lib/actions/setup-r@v2.11.3
+      - uses: r-lib/actions/setup-pandoc@v2.11.3
 
-      - uses: r-lib/actions/setup-r-dependencies@v2.11.2
+      - uses: r-lib/actions/setup-r-dependencies@v2.11.3
         with:
           extra-packages: any::rcmdcheck, local::., any::covr, any::gridExtra
 

---FILE: .github/workflows/cmdstan-tarball-check.yaml---
@@ -40,12 +40,12 @@ jobs:
           sudo apt-get install -y libcurl4-openssl-dev || true
           sudo apt-get install -y openmpi-bin openmpi-common libopenmpi-dev || true
 
-      - uses: r-lib/actions/setup-r@v2.11.2
+      - uses: r-lib/actions/setup-r@v2.11.3
         with:
           r-version: ${{ matrix.config.r }}
           rtools-version: ${{ matrix.config.rtools }}
 
-      - uses: r-lib/actions/setup-pandoc@v2.11.2
+      - uses: r-lib/actions/setup-pandoc@v2.11.3
 
       - name: Query dependencies
         run: |",False,False,Rendering / Conversion,3
stan-dev,cmdstanr,7a0f2ec0f72a8532e4dc63a3e764b2d57d253037,dependabot[bot],49699333+dependabot[bot]@users.noreply.github.com,2025-03-24T20:05:43Z,GitHub,noreply@github.com,2025-03-24T20:05:43Z,"Bump r-lib/actions from 2.11.2 to 2.11.3

Bumps [r-lib/actions](https://github.com/r-lib/actions) from 2.11.2 to 2.11.3.
- [Release notes](https://github.com/r-lib/actions/releases)
- [Changelog](https://github.com/r-lib/actions/blob/v2-branch/NEWS.md)
- [Commits](https://github.com/r-lib/actions/compare/v2.11.2...v2.11.3)

---
updated-dependencies:
- dependency-name: r-lib/actions
  dependency-type: direct:production
  update-type: version-update:semver-patch
...

Signed-off-by: dependabot[bot] <support@github.com>",.github/workflows/R-CMD-check-wsl.yaml;.github/workflows/R-CMD-check.yaml;.github/workflows/Test-coverage.yaml;.github/workflows/cmdstan-tarball-check.yaml,False,False,False,False,13,13,26,"---FILE: .github/workflows/R-CMD-check-wsl.yaml---
@@ -38,10 +38,10 @@ jobs:
 
       - uses: actions/checkout@v4
 
-      - uses: r-lib/actions/setup-r@v2.11.2
-      - uses: r-lib/actions/setup-pandoc@v2.11.2
+      - uses: r-lib/actions/setup-r@v2.11.3
+      - uses: r-lib/actions/setup-pandoc@v2.11.3
 
-      - uses: r-lib/actions/setup-r-dependencies@v2.11.2
+      - uses: r-lib/actions/setup-r-dependencies@v2.11.3
         with:
           extra-packages: any::rcmdcheck, local::.
 
@@ -71,7 +71,7 @@ jobs:
           sessioninfo::session_info(pkgs, include_base = TRUE)
         shell: Rscript {0}
 
-      - uses: r-lib/actions/check-r-package@v2.11.2
+      - uses: r-lib/actions/check-r-package@v2.11.3
         env:
           _R_CHECK_CRAN_INCOMING_: false
 

---FILE: .github/workflows/R-CMD-check.yaml---
@@ -50,14 +50,14 @@ jobs:
 
       - uses: actions/checkout@v4
 
-      - uses: r-lib/actions/setup-r@v2.11.2
+      - uses: r-lib/actions/setup-r@v2.11.3
         with:
           r-version: ${{ matrix.config.r }}
           rtools-version: ${{ matrix.config.rtools }}
 
-      - uses: r-lib/actions/setup-pandoc@v2.11.2
+      - uses: r-lib/actions/setup-pandoc@v2.11.3
 
-      - uses: r-lib/actions/setup-r-dependencies@v2.11.2
+      - uses: r-lib/actions/setup-r-dependencies@v2.11.3
         with:
           cache: ""always""
           extra-packages: any::rcmdcheck, local::.
@@ -90,7 +90,7 @@ jobs:
           sessioninfo::session_info(pkgs, include_base = TRUE)
         shell: Rscript {0}
 
-      - uses: r-lib/actions/check-r-package@v2.11.2
+      - uses: r-lib/actions/check-r-package@v2.11.3
         env:
           _R_CHECK_CRAN_INCOMING_: false
 

---FILE: .github/workflows/Test-coverage.yaml---
@@ -42,10 +42,10 @@ jobs:
         if: ""!startsWith(github.ref, 'refs/tags/') && github.ref != 'refs/heads/master'""
       - uses: actions/checkout@v4
 
-      - uses: r-lib/actions/setup-r@v2.11.2
-      - uses: r-lib/actions/setup-pandoc@v2.11.2
+      - uses: r-lib/actions/setup-r@v2.11.3
+      - uses: r-lib/actions/setup-pandoc@v2.11.3
 
-      - uses: r-lib/actions/setup-r-dependencies@v2.11.2
+      - uses: r-lib/actions/setup-r-dependencies@v2.11.3
         with:
           extra-packages: any::rcmdcheck, local::., any::covr, any::gridExtra
 

---FILE: .github/workflows/cmdstan-tarball-check.yaml---
@@ -40,12 +40,12 @@ jobs:
           sudo apt-get install -y libcurl4-openssl-dev || true
           sudo apt-get install -y openmpi-bin openmpi-common libopenmpi-dev || true
 
-      - uses: r-lib/actions/setup-r@v2.11.2
+      - uses: r-lib/actions/setup-r@v2.11.3
         with:
           r-version: ${{ matrix.config.r }}
           rtools-version: ${{ matrix.config.rtools }}
 
-      - uses: r-lib/actions/setup-pandoc@v2.11.2
+      - uses: r-lib/actions/setup-pandoc@v2.11.3
 
       - name: Query dependencies
         run: |",False,False,Rendering / Conversion,3
stan-dev,cmdstanr,7adfbbc54e47930b856b8e22c0595e8176b19078,dependabot[bot],49699333+dependabot[bot]@users.noreply.github.com,2025-02-24T18:59:06Z,GitHub,noreply@github.com,2025-02-24T18:59:06Z,"Bump r-lib/actions from 2.11.1 to 2.11.2

Bumps [r-lib/actions](https://github.com/r-lib/actions) from 2.11.1 to 2.11.2.
- [Release notes](https://github.com/r-lib/actions/releases)
- [Changelog](https://github.com/r-lib/actions/blob/v2-branch/NEWS.md)
- [Commits](https://github.com/r-lib/actions/compare/v2.11.1...v2.11.2)

---
updated-dependencies:
- dependency-name: r-lib/actions
  dependency-type: direct:production
  update-type: version-update:semver-patch
...

Signed-off-by: dependabot[bot] <support@github.com>",.github/workflows/R-CMD-check-wsl.yaml;.github/workflows/R-CMD-check.yaml;.github/workflows/Test-coverage.yaml;.github/workflows/cmdstan-tarball-check.yaml,False,False,False,False,13,13,26,"---FILE: .github/workflows/R-CMD-check-wsl.yaml---
@@ -38,10 +38,10 @@ jobs:
 
       - uses: actions/checkout@v4
 
-      - uses: r-lib/actions/setup-r@v2.11.1
-      - uses: r-lib/actions/setup-pandoc@v2.11.1
+      - uses: r-lib/actions/setup-r@v2.11.2
+      - uses: r-lib/actions/setup-pandoc@v2.11.2
 
-      - uses: r-lib/actions/setup-r-dependencies@v2.11.1
+      - uses: r-lib/actions/setup-r-dependencies@v2.11.2
         with:
           extra-packages: any::rcmdcheck, local::.
 
@@ -71,7 +71,7 @@ jobs:
           sessioninfo::session_info(pkgs, include_base = TRUE)
         shell: Rscript {0}
 
-      - uses: r-lib/actions/check-r-package@v2.11.1
+      - uses: r-lib/actions/check-r-package@v2.11.2
         env:
           _R_CHECK_CRAN_INCOMING_: false
 

---FILE: .github/workflows/R-CMD-check.yaml---
@@ -50,14 +50,14 @@ jobs:
 
       - uses: actions/checkout@v4
 
-      - uses: r-lib/actions/setup-r@v2.11.1
+      - uses: r-lib/actions/setup-r@v2.11.2
         with:
           r-version: ${{ matrix.config.r }}
           rtools-version: ${{ matrix.config.rtools }}
 
-      - uses: r-lib/actions/setup-pandoc@v2.11.1
+      - uses: r-lib/actions/setup-pandoc@v2.11.2
 
-      - uses: r-lib/actions/setup-r-dependencies@v2.11.1
+      - uses: r-lib/actions/setup-r-dependencies@v2.11.2
         with:
           cache: ""always""
           extra-packages: any::rcmdcheck, local::.
@@ -90,7 +90,7 @@ jobs:
           sessioninfo::session_info(pkgs, include_base = TRUE)
         shell: Rscript {0}
 
-      - uses: r-lib/actions/check-r-package@v2.11.1
+      - uses: r-lib/actions/check-r-package@v2.11.2
         env:
           _R_CHECK_CRAN_INCOMING_: false
 

---FILE: .github/workflows/Test-coverage.yaml---
@@ -42,10 +42,10 @@ jobs:
         if: ""!startsWith(github.ref, 'refs/tags/') && github.ref != 'refs/heads/master'""
       - uses: actions/checkout@v4
 
-      - uses: r-lib/actions/setup-r@v2.11.1
-      - uses: r-lib/actions/setup-pandoc@v2.11.1
+      - uses: r-lib/actions/setup-r@v2.11.2
+      - uses: r-lib/actions/setup-pandoc@v2.11.2
 
-      - uses: r-lib/actions/setup-r-dependencies@v2.11.1
+      - uses: r-lib/actions/setup-r-dependencies@v2.11.2
         with:
           extra-packages: any::rcmdcheck, local::., any::covr, any::gridExtra
 

---FILE: .github/workflows/cmdstan-tarball-check.yaml---
@@ -40,12 +40,12 @@ jobs:
           sudo apt-get install -y libcurl4-openssl-dev || true
           sudo apt-get install -y openmpi-bin openmpi-common libopenmpi-dev || true
 
-      - uses: r-lib/actions/setup-r@v2.11.1
+      - uses: r-lib/actions/setup-r@v2.11.2
         with:
           r-version: ${{ matrix.config.r }}
           rtools-version: ${{ matrix.config.rtools }}
 
-      - uses: r-lib/actions/setup-pandoc@v2.11.1
+      - uses: r-lib/actions/setup-pandoc@v2.11.2
 
       - name: Query dependencies
         run: |",False,False,Rendering / Conversion,3
stan-dev,cmdstanr,4e056be9ba0a56192980e8df46a2f6c79982256f,jgabry,jgabry@gmail.com,2025-02-14T17:39:20Z,jgabry,jgabry@gmail.com,2025-02-14T17:39:20Z,"Fix Unit Tests badge in README

[ci skip]",README.md,False,False,False,False,1,1,2,"---FILE: README.md---
@@ -2,7 +2,7 @@
 
 <!-- badges: start -->
 [![CRAN status](https://www.r-pkg.org/badges/version/cmdstanr)](https://CRAN.R-project.org/package=cmdstanr)
-[![Unit tests](https://github.com/stan-dev/cmdstanr/workflows/Unit%20tests/badge.svg)](https://github.com/stan-dev/cmdstanr/actions?workflow=Unit-tests)
+[![Unit tests](https://github.com/stan-dev/cmdstanr/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/stan-dev/cmdstanr/actions/workflows/R-CMD-check.yaml)
 [![Codecov test coverage](https://codecov.io/gh/stan-dev/cmdstanr/branch/master/graph/badge.svg)](https://app.codecov.io/gh/stan-dev/cmdstanr?branch=master)
 <!-- badges: end -->
 ",False,False,Documentation / Formatting,7
stan-dev,cmdstanr,75bc1c71ef96cbb33ce38c4bafe02c8ecaa0d5cf,jgabry,jgabry@gmail.com,2025-02-12T19:29:42Z,jgabry,jgabry@gmail.com,2025-02-12T19:29:42Z,fix R cmd check warning,DESCRIPTION;R/fit.R;man/CmdStanMLE.Rd,False,True,True,False,3,3,6,"---FILE: DESCRIPTION---
@@ -32,7 +32,7 @@ URL: https://mc-stan.org/cmdstanr/, https://discourse.mc-stan.org
 BugReports: https://github.com/stan-dev/cmdstanr/issues
 Encoding: UTF-8
 LazyData: true
-RoxygenNote: 7.3.1
+RoxygenNote: 7.3.2
 Roxygen: list(markdown = TRUE, r6 = FALSE)
 SystemRequirements: CmdStan (https://mc-stan.org/users/interfaces/cmdstan)
 Depends:

---FILE: R/fit.R---
@@ -1822,7 +1822,7 @@ CmdStanMCMC$set(""public"", name = ""num_chains"", value = num_chains)
 #'  |**Method**|**Description**|
 #'  |:----------|:---------------|
 #'  [`draws()`][fit-method-draws]  |  Return the point estimate as a 1-row [`draws_matrix`][posterior::draws_matrix]. |
-#'  [`$mode()`][fit-method-mode]  |  Return the point estimate as a numeric vector. |
+#'  [`$mle()`][fit-method-mle]  |  Return the point estimate as a numeric vector. |
 #'  [`$lp()`][fit-method-lp]  |  Return the total log probability density (`target`). |
 #'  [`$init()`][fit-method-init]  |  Return user-specified initial values. |
 #'  [`$metadata()`][fit-method-metadata] | Return a list of metadata gathered from the CmdStan CSV files. |

---FILE: man/CmdStanMLE.Rd---
@@ -18,7 +18,7 @@ all of which have their own (linked) documentation pages.
 \subsection{Extract contents of fitted model object}{\tabular{ll}{
    \strong{Method} \tab \strong{Description} \cr
    \code{\link[=fit-method-draws]{draws()}} \tab Return the point estimate as a 1-row \code{\link[posterior:draws_matrix]{draws_matrix}}. \cr
-   \code{\link[=fit-method-mode]{$mode()}} \tab Return the point estimate as a numeric vector. \cr
+   \code{\link[=fit-method-mle]{$mle()}} \tab Return the point estimate as a numeric vector. \cr
    \code{\link[=fit-method-lp]{$lp()}} \tab Return the total log probability density (\code{target}). \cr
    \code{\link[=fit-method-init]{$init()}} \tab Return user-specified initial values. \cr
    \code{\link[=fit-method-metadata]{$metadata()}} \tab Return a list of metadata gathered from the CmdStan CSV files. \cr",True,False,Dependency / Package,7
stan-dev,cmdstanr,0436f37cb5b51f7b72c0ff3e8ea49453e811211f,Aki Vehtari,Aki.Vehtari@aalto.fi,2025-01-14T18:05:58Z,Aki Vehtari,Aki.Vehtari@aalto.fi,2025-01-14T18:05:58Z,fix translation of log liks before exponentiation,R/fit.R,False,True,True,False,2,1,3,"---FILE: R/fit.R---
@@ -1543,7 +1543,8 @@ loo <- function(variables = ""log_lik"", r_eff = TRUE, moment_match = FALSE, ...)
   if (is.logical(r_eff)) {
     if (isTRUE(r_eff)) {
       r_eff_cores <- list(...)[[""cores""]] %||% getOption(""mc.cores"", 1)
-      r_eff <- loo::relative_eff(exp(LLarray + max(-LLarray)), cores = r_eff_cores)
+      r_eff <- loo::relative_eff(exp(sweep(LLarray, 3, apply(LLarray, 3, max), FUN = ""-"")),
+                                 cores = r_eff_cores)
     } else {
       r_eff <- NULL
     }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,fe07ccd8b4a6bf5a786eb5bf75ea03bc9cb61962,Andrew Johnson,andrew.johnson@arjohnsonau.com,2025-01-05T03:30:24Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2025-01-05T03:30:28Z,Fix test failures,tests/testthat/test-install.R,False,True,True,False,6,6,12,"---FILE: tests/testthat/test-install.R---
@@ -26,13 +26,13 @@ test_that(""install_cmdstan() successfully installs cmdstan"", {
 
 test_that(""install_cmdstan() errors if installation already exists"", {
   install_dir <- cmdstan_default_install_path()
-  dir <- file.path(install_dir, ""cmdstan-2.23.0"")
+  dir <- file.path(install_dir, ""cmdstan-2.35.0"")
   if (!dir.exists(dir)) {
     dir.create(dir, recursive = TRUE)
   }
   expect_warning(
     install_cmdstan(dir = install_dir, overwrite = FALSE,
-                    version = ""2.23.0"", wsl = FALSE),
+                    version = ""2.35.0"", wsl = FALSE),
     ""An installation already exists"",
     fixed = TRUE
   )
@@ -74,13 +74,13 @@ test_that(""install_cmdstan() errors if it times out"", {
 
 test_that(""install_cmdstan() errors if invalid version or URL"", {
   expect_error(
-    install_cmdstan(version = ""2.23.2"", wsl = os_is_wsl()),
-    ""Download of CmdStan failed with error: cannot open URL 'https://github.com/stan-dev/cmdstan/releases/download/v2.23.2/cmdstan-2.23.2.tar.gz'\nPlease check if the supplied version number is valid.""
+    install_cmdstan(version = ""2.35.5"", wsl = os_is_wsl()),
+    ""Download of CmdStan failed with error: cannot open URL 'https://github.com/stan-dev/cmdstan/releases/download/v2.35.5/cmdstan-2.35.5.tar.gz'\nPlease check if the supplied version number is valid.""
   )
   expect_error(
-    install_cmdstan(release_url = ""https://github.com/stan-dev/cmdstan/releases/download/v2.23.2/cmdstan-2.23.2.tar.gz"",
+    install_cmdstan(release_url = ""https://github.com/stan-dev/cmdstan/releases/download/v2.35.5/cmdstan-2.35.5.tar.gz"",
                     wsl = os_is_wsl()),
-    ""Download of CmdStan failed with error: cannot open URL 'https://github.com/stan-dev/cmdstan/releases/download/v2.23.2/cmdstan-2.23.2.tar.gz'\nPlease check if the supplied release URL is valid.""
+    ""Download of CmdStan failed with error: cannot open URL 'https://github.com/stan-dev/cmdstan/releases/download/v2.35.5/cmdstan-2.35.5.tar.gz'\nPlease check if the supplied release URL is valid.""
   )
   expect_error(
     install_cmdstan(release_url = ""https://github.com/stan-dev/cmdstan/releases/tag/v2.24.0"", wsl = os_is_wsl()),",True,False,Implementation / Logic,6
stan-dev,cmdstanr,cb9540731832ad2af9be8caed438860b1feec245,Andrew Johnson,andrew.johnson@arjohnsonau.com,2025-01-04T14:37:21Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2025-01-05T03:30:28Z,Fixes for blank version,R/install.R;R/utils.R,False,True,True,False,4,2,6,"---FILE: R/install.R---
@@ -866,7 +866,8 @@ rtools4x_toolchain_path <- function() {
   if (arch_is_aarch64()) {
     toolchain <- ""aarch64-w64-mingw32.static.posix""
   } else {
-    if (rtools4x_version() < ""44"" || Sys.getenv(""CMDSTANR_USE_MSYS_TOOLCHAIN"") != """" || cmdstan_version() < ""2.35.0"") {
+    if (rtools4x_version() < ""44"" || Sys.getenv(""CMDSTANR_USE_MSYS_TOOLCHAIN"") != """" ||
+        isTRUE(cmdstan_version(error_on_NA=FALSE) < ""2.35.0"")) {
       toolchain <- ifelse(is_ucrt_toolchain(), ""ucrt64"", ""mingw64"")
     } else {
       toolchain <- ""x86_64-w64-mingw32.static.posix""

---FILE: R/utils.R---
@@ -96,7 +96,8 @@ arch_is_aarch64 <- function() {
 make_cmd <- function() {
   if (Sys.getenv(""MAKE"") != """") {
     Sys.getenv(""MAKE"")
-  } else if (os_is_windows() && !os_is_wsl() && (rtools4x_version() < ""44"" || Sys.getenv(""CMDSTANR_USE_MSYS_TOOLCHAIN"") != """" || cmdstan_version() < ""2.35.0"")) {
+  } else if (os_is_windows() && !os_is_wsl() &&
+        (rtools4x_version() < ""44"" || Sys.getenv(""CMDSTANR_USE_MSYS_TOOLCHAIN"") != """" || isTRUE(cmdstan_version(error_on_NA=FALSE) < ""2.35.0""))) {
     ""mingw32-make.exe""
   } else {
     ""make""",True,False,Environment / Configuration,3
stan-dev,cmdstanr,62fd754519c2abe00a05dc1779e615c89db58dcc,Andrew Johnson,andrew.johnson@arjohnsonau.com,2025-01-04T14:28:34Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2025-01-05T03:30:28Z,"Fix test url, add version checking to utils",R/install.R;R/utils.R;tests/testthat/test-install.R,False,True,True,False,3,3,6,"---FILE: R/install.R---
@@ -866,7 +866,7 @@ rtools4x_toolchain_path <- function() {
   if (arch_is_aarch64()) {
     toolchain <- ""aarch64-w64-mingw32.static.posix""
   } else {
-    if (rtools4x_version() < ""44"" || Sys.getenv(""CMDSTANR_USE_MSYS_TOOLCHAIN"") != """") {
+    if (rtools4x_version() < ""44"" || Sys.getenv(""CMDSTANR_USE_MSYS_TOOLCHAIN"") != """" || cmdstan_version() < ""2.35.0"") {
       toolchain <- ifelse(is_ucrt_toolchain(), ""ucrt64"", ""mingw64"")
     } else {
       toolchain <- ""x86_64-w64-mingw32.static.posix""

---FILE: R/utils.R---
@@ -96,7 +96,7 @@ arch_is_aarch64 <- function() {
 make_cmd <- function() {
   if (Sys.getenv(""MAKE"") != """") {
     Sys.getenv(""MAKE"")
-  } else if (os_is_windows() && !os_is_wsl() && (rtools4x_version() < ""44"" || Sys.getenv(""CMDSTANR_USE_MSYS_TOOLCHAIN"") != """")) {
+  } else if (os_is_windows() && !os_is_wsl() && (rtools4x_version() < ""44"" || Sys.getenv(""CMDSTANR_USE_MSYS_TOOLCHAIN"") != """" || cmdstan_version() < ""2.35.0"")) {
     ""mingw32-make.exe""
   } else {
     ""make""

---FILE: tests/testthat/test-install.R---
@@ -98,7 +98,7 @@ test_that(""install_cmdstan() works with version and release_url"", {
   expect_message(
     expect_output(
       install_cmdstan(dir = dir, overwrite = TRUE, cores = 4,
-                      release_url = ""https://github.com/stan-dev/cmdstan/releases/download/v2.33.0/cmdstan-2.35.0.tar.gz"",
+                      release_url = ""https://github.com/stan-dev/cmdstan/releases/download/v2.35.0/cmdstan-2.35.0.tar.gz"",
                       wsl = os_is_wsl()),
       ""Compiling, linking C++ code"",
       fixed = TRUE",True,False,Environment / Configuration,3
stan-dev,cmdstanr,f7d3958f52ab82cbdc629da202cac1d9043ab2f5,Andrew Johnson,andrew.johnson@arjohnsonau.com,2025-01-04T09:02:10Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2025-01-04T16:42:32Z,Test macos fix,.github/workflows/R-CMD-check.yaml,False,False,False,False,1,1,2,"---FILE: .github/workflows/R-CMD-check.yaml---
@@ -79,7 +79,7 @@ jobs:
         run: |
           brew install pocl
           # Set LDLIBS_OPENCL environment variable
-          echo ""LDLIBS_OPENCL='-L/opt/homebrew/opt/opencl-icd-loader/lib -lOpenCL'"" >> $GITHUB_ENV
+          echo ""LDLIBS_OPENCL=\""-L'/opt/homebrew/opt/opencl-icd-loader/lib' -lOpenCL\"""" >> $GITHUB_ENV
         shell: bash
 
       - name: Install cmdstan",False,False,Data / Input Handling,3
stan-dev,cmdstanr,4fecc969016c59a19213bca367bf9fd86af858c3,Andrew Johnson,andrew.johnson@arjohnsonau.com,2025-01-04T08:49:31Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2025-01-04T16:42:32Z,"Add opencl to CI, test fixes",.github/workflows/R-CMD-check.yaml;tests/testthat/test-opencl.R,False,True,True,False,32,14,46,"---FILE: .github/workflows/R-CMD-check.yaml---
@@ -7,7 +7,7 @@ name: Unit tests
 'on':
   push:
     branches:
-      - master
+      - opencl-ci
   pull_request:
     branches:
       - master
@@ -23,18 +23,19 @@ jobs:
       fail-fast: false
       matrix:
         config:
-          - {os: macOS-latest, r: 'devel', rtools: ''}
-          - {os: macOS-latest, r: 'release', rtools: ''}
+          - {os: macOS-latest, r: 'devel', rtools: 'true', opencl: true}
+          - {os: macOS-latest, r: 'release', rtools: 'true', opencl: true}
           - {os: windows-latest, r: 'devel', rtools: '44'}
           - {os: windows-latest, r: 'release', rtools: '44'}
           - {os: windows-latest, r: 'oldrel', rtools: '43'}
-          - {os: ubuntu-latest, r: 'devel', rtools: ''}
-          - {os: ubuntu-latest, r: 'release', rtools: ''}
-          - {os: ubuntu-latest, r: 'oldrel', rtools: ''}
+          - {os: ubuntu-latest, r: 'devel', rtools: '', opencl: true}
+          - {os: ubuntu-latest, r: 'release', rtools: '', opencl: true}
+          - {os: ubuntu-latest, r: 'oldrel', rtools: '', opencl: true}
     env:
       R_REMOTES_NO_ERRORS_FROM_WARNINGS: true
       GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
       NOT_CRAN: true
+      CMDSTANR_OPENCL_TESTS: ${{ matrix.config.opencl }}
 
     steps:
       - name: cmdstan env vars
@@ -64,8 +65,23 @@ jobs:
 
       - uses: r-lib/actions/setup-r-dependencies@v2.11.1
         with:
+          cache: ""always""
           extra-packages: any::rcmdcheck, local::.
 
+      - name: Install POCL on Ubuntu Runners
+        if: ${{ matrix.config.os == 'ubuntu-latest' }}
+        run: |
+          sudo apt-get update && sudo apt-get install -y ocl-icd-opencl-dev pocl-opencl-icd
+        shell: bash
+
+      - name: Install POCL on MacOS Runners
+        if: ${{ matrix.config.os == 'macOS-latest' }}
+        run: |
+          brew install pocl
+          # Set LDLIBS_OPENCL environment variable
+          echo ""LDLIBS_OPENCL='-L/opt/homebrew/opt/opencl-icd-loader/lib -lOpenCL'"" >> $GITHUB_ENV
+        shell: bash
+
       - name: Install cmdstan
         run: |
           cmdstanr::check_cmdstan_toolchain(fix = TRUE)

---FILE: tests/testthat/test-opencl.R---
@@ -33,7 +33,8 @@ test_that(""all methods error when opencl_ids is used with non OpenCL model"", {
 test_that(""all methods error on invalid opencl_ids"", {
   skip_if_not(Sys.getenv(""CMDSTANR_OPENCL_TESTS"") %in% c(""1"", ""true""))
   stan_file <- testing_stan_file(""bernoulli"")
-  mod <- cmdstan_model(stan_file = stan_file, cpp_options = list(stan_opencl = TRUE))
+  mod <- cmdstan_model(stan_file = stan_file, cpp_options = list(stan_opencl = TRUE),
+                       force_recompile = TRUE)
   utils::capture.output(
     expect_warning(
       mod$sample(data = testing_data(""bernoulli""), opencl_ids = c(1000, 1000), chains = 1),
@@ -74,33 +75,34 @@ test_that(""all methods run with valid opencl_ids"", {
     fit <- mod$sample(data = testing_data(""bernoulli""), opencl_ids = c(0, 0), chains = 1)
   )
   expect_false(is.null(fit$metadata()$opencl_platform_name))
-  expect_false(is.null(fit$metadata()$opencl_ids_name))
+  expect_false(is.null(fit$metadata()$opencl_device_name))
 
   stan_file_gq <- testing_stan_file(""bernoulli_ppc"")
-  mod_gq <- cmdstan_model(stan_file = stan_file_gq, cpp_options = list(stan_opencl = TRUE))
+  mod_gq <- cmdstan_model(stan_file = stan_file_gq, cpp_options = list(stan_opencl = TRUE),
+                          force_recompile = TRUE)
   expect_gq_output(
     fit <- mod_gq$generate_quantities(fitted_params = fit, data = testing_data(""bernoulli""), opencl_ids = c(0, 0)),
   )
   expect_false(is.null(fit$metadata()$opencl_platform_name))
-  expect_false(is.null(fit$metadata()$opencl_ids_name))
+  expect_false(is.null(fit$metadata()$opencl_device_name))
 
   expect_sample_output(
     fit <- mod$sample(data = testing_data(""bernoulli""), opencl_ids = c(0, 0))
   )
   expect_false(is.null(fit$metadata()$opencl_platform_name))
-  expect_false(is.null(fit$metadata()$opencl_ids_name))
+  expect_false(is.null(fit$metadata()$opencl_device_name))
 
   expect_optim_output(
     fit <- mod$optimize(data = testing_data(""bernoulli""), opencl_ids = c(0, 0))
   )
   expect_false(is.null(fit$metadata()$opencl_platform_name))
-  expect_false(is.null(fit$metadata()$opencl_ids_name))
+  expect_false(is.null(fit$metadata()$opencl_device_name))
 
   expect_vb_output(
     fit <- mod$variational(data = testing_data(""bernoulli""), opencl_ids = c(0, 0))
   )
   expect_false(is.null(fit$metadata()$opencl_platform_name))
-  expect_false(is.null(fit$metadata()$opencl_ids_name))
+  expect_false(is.null(fit$metadata()$opencl_device_name))
 })
 
 test_that(""error for runtime selection of OpenCL devices if version less than 2.26"", {
@@ -111,7 +113,7 @@ test_that(""error for runtime selection of OpenCL devices if version less than 2.
   mod <- cmdstan_model(stan_file = stan_file, cpp_options = list(stan_opencl = TRUE),
                        force_recompile = TRUE)
   expect_error(
-    mod$sample(data = data_list, chains = 1, refresh = 0, opencl_ids = c(1,1)),
+    mod$sample(data = testing_data(""bernoulli""), chains = 1, refresh = 0, opencl_ids = c(1,1)),
     ""Runtime selection of OpenCL devices is only supported with CmdStan version 2.26 or newer"",
     fixed = TRUE
   )",True,False,Implementation / Logic,6
stan-dev,cmdstanr,6baf35316bc7fe0804229b669f482debe989b6a1,dependabot[bot],49699333+dependabot[bot]@users.noreply.github.com,2024-11-25T19:26:40Z,GitHub,noreply@github.com,2024-11-25T19:26:40Z,"Bump r-lib/actions from 2.11.0 to 2.11.1

Bumps [r-lib/actions](https://github.com/r-lib/actions) from 2.11.0 to 2.11.1.
- [Release notes](https://github.com/r-lib/actions/releases)
- [Changelog](https://github.com/r-lib/actions/blob/v2-branch/NEWS.md)
- [Commits](https://github.com/r-lib/actions/compare/v2.11.0...v2.11.1)

---
updated-dependencies:
- dependency-name: r-lib/actions
  dependency-type: direct:production
  update-type: version-update:semver-patch
...

Signed-off-by: dependabot[bot] <support@github.com>",.github/workflows/R-CMD-check-wsl.yaml;.github/workflows/R-CMD-check.yaml;.github/workflows/Test-coverage.yaml;.github/workflows/cmdstan-tarball-check.yaml,False,False,False,False,13,13,26,"---FILE: .github/workflows/R-CMD-check-wsl.yaml---
@@ -37,10 +37,10 @@ jobs:
 
       - uses: actions/checkout@v4
 
-      - uses: r-lib/actions/setup-r@v2.11.0
-      - uses: r-lib/actions/setup-pandoc@v2.11.0
+      - uses: r-lib/actions/setup-r@v2.11.1
+      - uses: r-lib/actions/setup-pandoc@v2.11.1
 
-      - uses: r-lib/actions/setup-r-dependencies@v2.11.0
+      - uses: r-lib/actions/setup-r-dependencies@v2.11.1
         with:
           extra-packages: any::rcmdcheck, local::.
 
@@ -71,7 +71,7 @@ jobs:
           sessioninfo::session_info(pkgs, include_base = TRUE)
         shell: Rscript {0}
 
-      - uses: r-lib/actions/check-r-package@v2.11.0
+      - uses: r-lib/actions/check-r-package@v2.11.1
         env:
           _R_CHECK_CRAN_INCOMING_: false
 

---FILE: .github/workflows/R-CMD-check.yaml---
@@ -55,14 +55,14 @@ jobs:
 
       - uses: actions/checkout@v4
 
-      - uses: r-lib/actions/setup-r@v2.11.0
+      - uses: r-lib/actions/setup-r@v2.11.1
         with:
           r-version: ${{ matrix.config.r }}
           rtools-version: ${{ matrix.config.rtools }}
 
-      - uses: r-lib/actions/setup-pandoc@v2.11.0
+      - uses: r-lib/actions/setup-pandoc@v2.11.1
 
-      - uses: r-lib/actions/setup-r-dependencies@v2.11.0
+      - uses: r-lib/actions/setup-r-dependencies@v2.11.1
         with:
           extra-packages: any::rcmdcheck, local::.
 
@@ -79,7 +79,7 @@ jobs:
           sessioninfo::session_info(pkgs, include_base = TRUE)
         shell: Rscript {0}
 
-      - uses: r-lib/actions/check-r-package@v2.11.0
+      - uses: r-lib/actions/check-r-package@v2.11.1
         env:
           _R_CHECK_CRAN_INCOMING_: false
 

---FILE: .github/workflows/Test-coverage.yaml---
@@ -42,10 +42,10 @@ jobs:
         if: ""!startsWith(github.ref, 'refs/tags/') && github.ref != 'refs/heads/master'""
       - uses: actions/checkout@v4
 
-      - uses: r-lib/actions/setup-r@v2.11.0
-      - uses: r-lib/actions/setup-pandoc@v2.11.0
+      - uses: r-lib/actions/setup-r@v2.11.1
+      - uses: r-lib/actions/setup-pandoc@v2.11.1
 
-      - uses: r-lib/actions/setup-r-dependencies@v2.11.0
+      - uses: r-lib/actions/setup-r-dependencies@v2.11.1
         with:
           extra-packages: any::rcmdcheck, local::., any::covr, any::gridExtra
 

---FILE: .github/workflows/cmdstan-tarball-check.yaml---
@@ -40,12 +40,12 @@ jobs:
           sudo apt-get install -y libcurl4-openssl-dev || true
           sudo apt-get install -y openmpi-bin openmpi-common libopenmpi-dev || true
 
-      - uses: r-lib/actions/setup-r@v2.11.0
+      - uses: r-lib/actions/setup-r@v2.11.1
         with:
           r-version: ${{ matrix.config.r }}
           rtools-version: ${{ matrix.config.rtools }}
 
-      - uses: r-lib/actions/setup-pandoc@v2.11.0
+      - uses: r-lib/actions/setup-pandoc@v2.11.1
 
       - name: Query dependencies
         run: |",False,False,Rendering / Conversion,3
stan-dev,cmdstanr,3c840ef31013dd6e9672dc38fa06105abd17cdd1,jgabry,jgabry@gmail.com,2024-11-14T20:07:26Z,jgabry,jgabry@gmail.com,2024-11-14T20:07:26Z,"Fix use of untar

fixes #1029",R/install.R,False,True,True,False,1,2,3,"---FILE: R/install.R---
@@ -203,8 +203,7 @@ install_cmdstan <- function(dir = NULL,
   } else {
     untar_rc <- utils::untar(
       dest_file,
-      exdir = dir_cmdstan,
-      extras = ""--strip-components 1""
+      exdir = dir
     )
     if (untar_rc != 0) {
       stop(""Problem extracting tarball. Exited with return code: "", untar_rc, call. = FALSE)",True,False,Implementation / Logic,6
stan-dev,cmdstanr,38a33efb94f7f49da54624d45f2b1251deec22da,jgabry,jgabry@gmail.com,2024-11-13T19:56:27Z,jgabry,jgabry@gmail.com,2024-11-13T19:56:27Z,"Informative error message for sampler_diagnostics() with fixed_param

closes #1032",R/fit.R;tests/testthat/test-fit-mcmc.R,False,True,True,False,16,0,16,"---FILE: R/fit.R---
@@ -1616,6 +1616,9 @@ CmdStanMCMC$set(""public"", name = ""loo"", value = loo)
 #' }
 #'
 sampler_diagnostics <- function(inc_warmup = FALSE, format = getOption(""cmdstanr_draws_format"", ""draws_array"")) {
+  if (isTRUE(private$metadata_$algorithm == ""fixed_param"")) {
+    stop(""There are no sampler diagnostics when fixed_param = TRUE."", call. = FALSE)
+  }
   if (is.null(private$sampler_diagnostics_) &&
       !length(self$output_files(include_failed = FALSE))) {
     stop(""No chains finished successfully. Unable to retrieve the sampler diagnostics."", call. = FALSE)

---FILE: tests/testthat/test-fit-mcmc.R---
@@ -19,6 +19,12 @@ fit_mcmc_3 <- testing_fit(""logistic"", method = ""sample"",
                           iter_sampling = 0,
                           save_warmup = 1,
                           refresh = 0, metric = ""dense_e"")
+fit_mcmc_fixed_param <- testing_fit(""logistic"", method = ""sample"",
+                                    seed = 1234, chains = 1,
+                                    iter_warmup = 100,
+                                    iter_sampling = 0,
+                                    save_warmup = 1,
+                                    refresh = 0, fixed_param = TRUE)
 PARAM_NAMES <- c(""alpha"", ""beta[1]"", ""beta[2]"", ""beta[3]"")
 
 test_that(""draws() stops for unkown variables"", {
@@ -399,3 +405,10 @@ test_that(""metadata()$time has chains rowss"", {
   expect_equal(nrow(fit_mcmc_2$metadata()$time), fit_mcmc_2$num_chains())
   expect_equal(nrow(fit_mcmc_3$metadata()$time), fit_mcmc_3$num_chains())
 })
+
+test_that(""sampler_diagnostics() throws informative error when fixed_param=TRUE"", {
+  expect_error(
+    fit_mcmc_fixed_param$sampler_diagnostics(),
+    ""There are no sampler diagnostics when fixed_param = TRUE""
+  )
+})",True,False,Implementation / Logic,6
stan-dev,cmdstanr,987ad40a32cbb2ff02ca3763f07935494e65370c,dependabot[bot],49699333+dependabot[bot]@users.noreply.github.com,2024-08-12T18:31:37Z,GitHub,noreply@github.com,2024-08-12T18:31:37Z,"Bump r-lib/actions from 2.10.0 to 2.10.1

Bumps [r-lib/actions](https://github.com/r-lib/actions) from 2.10.0 to 2.10.1.
- [Release notes](https://github.com/r-lib/actions/releases)
- [Changelog](https://github.com/r-lib/actions/blob/v2-branch/NEWS.md)
- [Commits](https://github.com/r-lib/actions/compare/v2.10.0...v2.10.1)

---
updated-dependencies:
- dependency-name: r-lib/actions
  dependency-type: direct:production
  update-type: version-update:semver-patch
...

Signed-off-by: dependabot[bot] <support@github.com>",.github/workflows/R-CMD-check-wsl.yaml;.github/workflows/R-CMD-check.yaml;.github/workflows/Test-coverage.yaml;.github/workflows/cmdstan-tarball-check.yaml,False,False,False,False,13,13,26,"---FILE: .github/workflows/R-CMD-check-wsl.yaml---
@@ -37,10 +37,10 @@ jobs:
 
       - uses: actions/checkout@v4
 
-      - uses: r-lib/actions/setup-r@v2.10.0
-      - uses: r-lib/actions/setup-pandoc@v2.10.0
+      - uses: r-lib/actions/setup-r@v2.10.1
+      - uses: r-lib/actions/setup-pandoc@v2.10.1
 
-      - uses: r-lib/actions/setup-r-dependencies@v2.10.0
+      - uses: r-lib/actions/setup-r-dependencies@v2.10.1
         with:
           extra-packages: any::rcmdcheck, local::.
 
@@ -71,7 +71,7 @@ jobs:
           sessioninfo::session_info(pkgs, include_base = TRUE)
         shell: Rscript {0}
 
-      - uses: r-lib/actions/check-r-package@v2.10.0
+      - uses: r-lib/actions/check-r-package@v2.10.1
         env:
           _R_CHECK_CRAN_INCOMING_: false
 

---FILE: .github/workflows/R-CMD-check.yaml---
@@ -55,14 +55,14 @@ jobs:
 
       - uses: actions/checkout@v4
 
-      - uses: r-lib/actions/setup-r@v2.10.0
+      - uses: r-lib/actions/setup-r@v2.10.1
         with:
           r-version: ${{ matrix.config.r }}
           rtools-version: ${{ matrix.config.rtools }}
 
-      - uses: r-lib/actions/setup-pandoc@v2.10.0
+      - uses: r-lib/actions/setup-pandoc@v2.10.1
 
-      - uses: r-lib/actions/setup-r-dependencies@v2.10.0
+      - uses: r-lib/actions/setup-r-dependencies@v2.10.1
         with:
           extra-packages: any::rcmdcheck, local::.
 
@@ -79,7 +79,7 @@ jobs:
           sessioninfo::session_info(pkgs, include_base = TRUE)
         shell: Rscript {0}
 
-      - uses: r-lib/actions/check-r-package@v2.10.0
+      - uses: r-lib/actions/check-r-package@v2.10.1
         env:
           _R_CHECK_CRAN_INCOMING_: false
 

---FILE: .github/workflows/Test-coverage.yaml---
@@ -42,10 +42,10 @@ jobs:
         if: ""!startsWith(github.ref, 'refs/tags/') && github.ref != 'refs/heads/master'""
       - uses: actions/checkout@v4
 
-      - uses: r-lib/actions/setup-r@v2.10.0
-      - uses: r-lib/actions/setup-pandoc@v2.10.0
+      - uses: r-lib/actions/setup-r@v2.10.1
+      - uses: r-lib/actions/setup-pandoc@v2.10.1
 
-      - uses: r-lib/actions/setup-r-dependencies@v2.10.0
+      - uses: r-lib/actions/setup-r-dependencies@v2.10.1
         with:
           extra-packages: any::rcmdcheck, local::., any::covr, any::gridExtra
 

---FILE: .github/workflows/cmdstan-tarball-check.yaml---
@@ -40,12 +40,12 @@ jobs:
           sudo apt-get install -y libcurl4-openssl-dev || true
           sudo apt-get install -y openmpi-bin openmpi-common libopenmpi-dev || true
 
-      - uses: r-lib/actions/setup-r@v2.10.0
+      - uses: r-lib/actions/setup-r@v2.10.1
         with:
           r-version: ${{ matrix.config.r }}
           rtools-version: ${{ matrix.config.rtools }}
 
-      - uses: r-lib/actions/setup-pandoc@v2.10.0
+      - uses: r-lib/actions/setup-pandoc@v2.10.1
 
       - name: Query dependencies
         run: |",False,False,Rendering / Conversion,3
stan-dev,cmdstanr,b65e8680732cfa079be118d0c397ed339db661da,jgabry,jgabry@gmail.com,2024-07-30T20:32:42Z,jgabry,jgabry@gmail.com,2024-07-30T20:32:42Z,"improve stability of r_eff calculation for loo

see https://github.com/stan-dev/loo/issues/272",R/fit.R,False,True,True,False,4,4,8,"---FILE: R/fit.R---
@@ -574,9 +574,9 @@ unconstrain_draws <- function(files = NULL, draws = NULL,
   } else {
     draws <- self$draws(inc_warmup = inc_warmup)
   }
-  
+
   draws <- maybe_convert_draws_format(draws, ""draws_matrix"")
-  
+
   chains <- posterior::nchains(draws)
 
   model_par_names <- self$metadata()$stan_variables[self$metadata()$stan_variables != ""lp__""]
@@ -595,7 +595,7 @@ unconstrain_draws <- function(files = NULL, draws = NULL,
   uncon_names <- private$model_methods_env_$unconstrained_param_names(private$model_methods_env_$model_ptr_, FALSE, FALSE)
   names(unconstrained) <- repair_variable_names(uncon_names)
   unconstrained$.nchains <- chains
-  
+
   do.call(function(...) { create_draws_format(format, ...) }, unconstrained)
 }
 CmdStanFit$set(""public"", name = ""unconstrain_draws"", value = unconstrain_draws)
@@ -1539,7 +1539,7 @@ loo <- function(variables = ""log_lik"", r_eff = TRUE, moment_match = FALSE, ...)
   if (is.logical(r_eff)) {
     if (isTRUE(r_eff)) {
       r_eff_cores <- list(...)[[""cores""]] %||% getOption(""mc.cores"", 1)
-      r_eff <- loo::relative_eff(exp(LLarray), cores = r_eff_cores)
+      r_eff <- loo::relative_eff(exp(LLarray + max(-LLarray)), cores = r_eff_cores)
     } else {
       r_eff <- NULL
     }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,9878dda9cf4252fc4afa8a89aef66e231ce4dc18,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-06-20T19:02:39Z,GitHub,noreply@github.com,2024-06-20T19:02:39Z,"Fix compilation failures for Stan models with `#include` statements (#1000)

* Fix quoting differences for standalone hpp

* Stray logging",R/model.R,False,True,True,False,14,6,20,"---FILE: R/model.R---
@@ -650,10 +650,11 @@ compile <- function(quiet = TRUE,
   if (stancflags_local != """") {
     stancflags_combined <- c(stancflags_combined, stancflags_local)
   }
-  stancflags_standalone <- c(""--standalone-functions"", stancflags_val, stancflags_combined)
+  stanc_inc_paths <- include_paths_stanc3_args(include_paths, standalone_call = TRUE)
+  stancflags_standalone <- c(""--standalone-functions"", stanc_inc_paths, stancflags_combined)
   self$functions$hpp_code <- get_standalone_hpp(temp_stan_file, stancflags_standalone)
   private$model_methods_env_ <- new.env()
-  private$model_methods_env_$hpp_code_ <- get_standalone_hpp(temp_stan_file, c(stancflags_val, stancflags_combined))
+  private$model_methods_env_$hpp_code_ <- get_standalone_hpp(temp_stan_file, c(stanc_inc_paths, stancflags_combined))
   self$functions$external <- !is.null(user_header)
   self$functions$existing_exe <- FALSE
 
@@ -2337,20 +2338,27 @@ cpp_options_to_compile_flags <- function(cpp_options) {
   cpp_built_options
 }
 
-include_paths_stanc3_args <- function(include_paths = NULL) {
+include_paths_stanc3_args <- function(include_paths = NULL, standalone_call = FALSE) {
   stancflags <- NULL
   if (!is.null(include_paths)) {
     assert_dir_exists(include_paths, access = ""r"")
     include_paths <- sapply(absolute_path(include_paths), wsl_safe_path)
-    paths_w_space <- grep("" "", include_paths)
-    include_paths[paths_w_space] <- paste0(""'"", include_paths[paths_w_space], ""'"")
+    # Calling stanc3 directly through processx::run does not need quoting
+    if (!isTRUE(standalone_call)) {
+      paths_w_space <- grep("" "", include_paths)
+      include_paths[paths_w_space] <- paste0(""'"", include_paths[paths_w_space], ""'"")
+    }
     include_paths <- paste0(include_paths, collapse = "","")
     if (cmdstan_version() >= ""2.24"") {
       include_paths_flag <- ""--include-paths=""
     } else {
       include_paths_flag <- ""--include_paths=""
     }
-    stancflags <- paste0(stancflags, include_paths_flag, include_paths)
+    if (isTRUE(standalone_call)) {
+      stancflags <- c(stancflags, ""--include-paths"", include_paths)
+    } else {
+      stancflags <- paste0(stancflags, include_paths_flag, include_paths)
+    }
   }
   stancflags
 }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,a45d4f7d686aa6b57ce25f342a71eea79507f01c,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-06-15T15:22:33Z,GitHub,noreply@github.com,2024-06-15T15:22:33Z,Fix factor arg handling (#999),R/data.R;tests/testthat/test-data.R,False,True,True,False,14,10,24,"---FILE: R/data.R---
@@ -186,18 +186,19 @@ process_data <- function(data, model_variables = NULL) {
         # generating a decimal point in write_stan_json
         if (data_variables[[var_name]]$type == ""int""
             && !is.integer(data[[var_name]])) {
-          if (!isTRUE(all(is_wholenumber(data[[var_name]])))) {
-            # Don't warn for NULL/NA, as different warnings are used for those
-            if (!isTRUE(any(is.na(data[[var_name]])))) {
-              warning(""A non-integer value was supplied for '"", var_name, ""'!"",
-                      "" It will be truncated to an integer."", call. = FALSE)
+          if (!is.factor(data[[var_name]])) {
+            if (!isTRUE(all(is_wholenumber(data[[var_name]])))) {
+              # Don't warn for NULL/NA, as different warnings are used for those
+              if (!isTRUE(any(is.na(data[[var_name]])))) {
+                warning(""A non-integer value was supplied for '"", var_name, ""'!"",
+                        "" It will be truncated to an integer."", call. = FALSE)
+              }
+            } else {
+              # Round before setting mode to integer to avoid floating point errors
+              data[[var_name]] <- round(data[[var_name]])
             }
-            mode(data[[var_name]]) <- ""integer""
-          } else {
-            # Round before setting mode to integer to avoid floating point errors
-            data[[var_name]] <- round(data[[var_name]])
-            mode(data[[var_name]]) <- ""integer""
           }
+          mode(data[[var_name]]) <- ""integer""
         }
       }
     }

---FILE: tests/testthat/test-data.R---
@@ -383,6 +383,9 @@ test_that(""process_data warns on int coercion"", {
   expect_no_warning(
     process_data(list(a = c(1, 2, 3)), model_variables = mod$variables())
   )
+  expect_no_warning(
+    process_data(list(a = factor(c(""a"", ""b"", ""c""))), model_variables = mod$variables())
+  )
 })
 
 test_that(""Floating-point differences do not cause truncation towards 0"", {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,722d1969cf5549e54f98fa423b5f5c2b405f4943,Steve Bronder,sbronder@flatironinstitute.org,2024-06-08T17:28:57Z,GitHub,noreply@github.com,2024-06-08T17:28:57Z,"Fixes 975 by only removing leftmost array dimension if equal to 1 (#993)

* Fixes 975 by only removing leftmost array dimension if equal to 1

* Update tests, fix windows error

---------

Co-authored-by: Andrew Johnson <andrew.johnson@arjohnsonau.com>",R/args.R;tests/testthat/test-model-init.R,False,True,True,False,52,5,57,"---FILE: R/args.R---
@@ -1063,6 +1063,24 @@ process_init.default <- function(init, ...) {
   return(init)
 }
 
+#' Remove the leftmost dimension if equal to 1
+#' @noRd
+#' @param x An array like object
+.remove_leftmost_dim <- function(x) {
+  dims <- dim(x)
+  if (length(dims) == 1) {
+    return(drop(x))
+  } else if (dims[1] == 1) {
+    new_dims <- dims[-1]
+    # Create a call to subset the array, maintaining all remaining dimensions
+    subset_expr <- as.call(c(as.name(""[""), list(x), 1, rep(TRUE, length(new_dims)), drop = FALSE))
+    new_x <- eval(subset_expr)
+    return(array(new_x, dim = new_dims))
+  } else {
+    return(x)
+  }
+}
+
 #' Write initial values to files if provided as posterior `draws` object
 #' @noRd
 #' @param init A type that inherits the `posterior::draws` class.
@@ -1097,9 +1115,13 @@ process_init.draws <- function(init, num_procs, model_variables = NULL,
   draws_rvar <- posterior::subset_draws(draws_rvar, variable = variable_names)
   inits = lapply(1:num_procs, function(draw_iter) {
     init_i = lapply(variable_names, function(var_name) {
-      x = drop(posterior::draws_of(drop(
-        posterior::subset_draws(draws_rvar[[var_name]], draw=draw_iter))))
-      return(x)
+      x = .remove_leftmost_dim(posterior::draws_of(
+        posterior::subset_draws(draws_rvar[[var_name]], draw=draw_iter)))
+      if (model_variables$parameters[[var_name]]$dimensions == 0) {
+        return(as.double(x))
+      } else {
+        return(x)
+      }
     })
     bad_names = unlist(lapply(variable_names, function(var_name) {
       x = drop(posterior::draws_of(drop(
@@ -1295,13 +1317,13 @@ process_init_approx <- function(init, num_procs, model_variables = NULL,
   # Calculate unique draws based on 'lw' using base R functions
   unique_draws = length(unique(draws_df$lw))
   if (num_procs > unique_draws) {
-    if (inherits(init, "" CmdStanPathfinder "")) {
+    if (inherits(init, ""CmdStanPathfinder"")) {
       algo_name = "" Pathfinder ""
       extra_msg = "" Try running Pathfinder with psis_resample=FALSE.""
     } else if (inherits(init, ""CmdStanVB"")) {
       algo_name = "" CmdStanVB ""
       extra_msg = """"
-    } else if (inherits(init, "" CmdStanLaplace "")) {
+    } else if (inherits(init, ""CmdStanLaplace"")) {
       algo_name = "" CmdStanLaplace ""
       extra_msg = """"
     } else {

---FILE: tests/testthat/test-model-init.R---
@@ -310,3 +310,28 @@ test_that(""Initial values for single-element containers treated correctly"", {
     )
   )
 })
+
+test_that(""Pathfinder inits do not drop dimensions"", {
+  modcode <- ""
+  data {
+    int N;
+    vector[N] y;
+  }
+
+  parameters {
+    matrix[N, 1] mu;
+    matrix[1, N] mu_2;
+    vector<lower=0>[N] sigma;
+  }
+
+  model {
+    target += normal_lupdf(y | mu[:, 1], sigma);
+    target += normal_lupdf(y | mu_2[1], sigma);
+  }
+  ""
+  mod <- cmdstan_model(write_stan_file(modcode), force_recompile = TRUE)
+  data <- list(N = 100, y = rnorm(100))
+  pf <- mod$pathfinder(data = data, psis_resample = FALSE)
+  expect_no_error(fit <- mod$sample(data = data, init = pf, chains = 1,
+                                    iter_warmup = 100, iter_sampling = 100))
+})
\ No newline at end of file",True,False,Implementation / Logic,6
stan-dev,cmdstanr,4927783c2e3713b7effc9009e88ad5eddc9aca7c,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-06-06T18:40:43Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-06-06T18:40:43Z,Fix short path portability,R/install.R;R/model.R;R/run.R;R/utils.R,False,True,True,False,15,7,22,"---FILE: R/install.R---
@@ -454,7 +454,7 @@ build_cmdstan <- function(dir,
     run_cmd <- make_cmd()
   }
   withr::with_envvar(
-    c(""HOME"" = utils::shortPathName(Sys.getenv(""HOME""))),
+    c(""HOME"" = short_path(Sys.getenv(""HOME""))),
     withr::with_path(
       c(
         toolchain_PATH_env_var(),
@@ -479,7 +479,7 @@ clean_cmdstan <- function(dir = cmdstan_path(),
                           cores = getOption(""mc.cores"", 2),
                           quiet = FALSE) {
   withr::with_envvar(
-    c(""HOME"" = utils::shortPathName(Sys.getenv(""HOME""))),
+    c(""HOME"" = short_path(Sys.getenv(""HOME""))),
     withr::with_path(
       c(
         toolchain_PATH_env_var(),
@@ -501,7 +501,7 @@ clean_cmdstan <- function(dir = cmdstan_path(),
 
 build_example <- function(dir, cores, quiet, timeout) {
   withr::with_envvar(
-    c(""HOME"" = utils::shortPathName(Sys.getenv(""HOME""))),
+    c(""HOME"" = short_path(Sys.getenv(""HOME""))),
     withr::with_path(
       c(
         toolchain_PATH_env_var(),

---FILE: R/model.R---
@@ -664,9 +664,9 @@ compile <- function(quiet = TRUE,
     if (compile_standalone) {
       expose_stan_functions(self$functions, !quiet)
     }
-  
+
     withr::with_envvar(
-      c(""HOME"" = utils::shortPathName(Sys.getenv(""HOME""))),
+      c(""HOME"" = short_path(Sys.getenv(""HOME""))),
       withr::with_path(
         c(
           toolchain_PATH_env_var(),

---FILE: R/run.R---
@@ -411,7 +411,7 @@ check_target_exe <- function(exe) {
   exe_path <- file.path(cmdstan_path(), exe)
   if (!file.exists(exe_path)) {
     withr::with_envvar(
-      c(""HOME"" = utils::shortPathName(Sys.getenv(""HOME""))),
+      c(""HOME"" = short_path(Sys.getenv(""HOME""))),
       withr::with_path(
         c(
           toolchain_PATH_env_var(),

---FILE: R/utils.R---
@@ -107,6 +107,14 @@ stanc_cmd <- function() {
 
 # paths and extensions ----------------------------------------------------
 
+short_path <- function(path) {
+  if (os_is_windows()) {
+    utils::shortPathName(path)
+  } else {
+    path
+  }
+}
+
 # Replace `\\` with `/` in a vector of paths
 # Needed for windows if CmdStan version is < 2.21:
 # https://github.com/stan-dev/cmdstanr/issues/1#issuecomment-539118598
@@ -693,7 +701,7 @@ assert_file_exists <- checkmate::makeAssertionFunction(check_file_exists)
 get_cmdstan_flags <- function(flag_name) {
   cmdstan_path <- cmdstanr::cmdstan_path()
   withr::with_envvar(
-    c(""HOME"" = utils::shortPathName(Sys.getenv(""HOME""))),
+    c(""HOME"" = short_path(Sys.getenv(""HOME""))),
     flags <- wsl_compatible_run(
       command = ""make"",
       args = c(""-s"", paste0(""print-"", flag_name)),",True,False,Environment / Configuration,4
stan-dev,cmdstanr,995e36fa151ece2799fac069ede51691e86c3545,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-06-06T18:12:37Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-06-06T18:12:37Z,Fix Onedrive PATH issues,R/install.R;R/model.R;R/path.R;R/run.R;R/utils.R,False,True,True,False,124,107,231,"---FILE: R/install.R---
@@ -453,63 +453,72 @@ build_cmdstan <- function(dir,
   } else {
     run_cmd <- make_cmd()
   }
-  withr::with_path(
-    c(
-      toolchain_PATH_env_var(),
-      tbb_path(dir = dir)
-    ),
-    wsl_compatible_run(
-      command = run_cmd,
-      args = c(translation_args, paste0(""-j"", cores), ""build""),
-      wd = dir,
-      echo_cmd = is_verbose_mode(),
-      echo = !quiet || is_verbose_mode(),
-      spinner = quiet,
-      error_on_status = FALSE,
-      stderr_callback = function(x, p) { if (quiet) message(x) },
-      timeout = timeout
+  withr::with_envvar(
+    c(""HOME"" = utils::shortPathName(Sys.getenv(""HOME""))),
+    withr::with_path(
+      c(
+        toolchain_PATH_env_var(),
+        tbb_path(dir = dir)
+      ),
+      wsl_compatible_run(
+        command = run_cmd,
+        args = c(translation_args, paste0(""-j"", cores), ""build""),
+        wd = dir,
+        echo_cmd = is_verbose_mode(),
+        echo = !quiet || is_verbose_mode(),
+        spinner = quiet,
+        error_on_status = FALSE,
+        stderr_callback = function(x, p) { if (quiet) message(x) },
+        timeout = timeout
+      )
     )
   )
 }
 
 clean_cmdstan <- function(dir = cmdstan_path(),
                           cores = getOption(""mc.cores"", 2),
                           quiet = FALSE) {
-  withr::with_path(
-    c(
-      toolchain_PATH_env_var(),
-      tbb_path(dir = dir)
-    ),
-    wsl_compatible_run(
-      command = make_cmd(),
-      args = ""clean-all"",
-      wd = dir,
-      echo_cmd = is_verbose_mode(),
-      echo = !quiet || is_verbose_mode(),
-      spinner = quiet,
-      error_on_status = FALSE,
-      stderr_callback = function(x, p) { if (quiet) message(x) }
+  withr::with_envvar(
+    c(""HOME"" = utils::shortPathName(Sys.getenv(""HOME""))),
+    withr::with_path(
+      c(
+        toolchain_PATH_env_var(),
+        tbb_path(dir = dir)
+      ),
+      wsl_compatible_run(
+        command = make_cmd(),
+        args = ""clean-all"",
+        wd = dir,
+        echo_cmd = is_verbose_mode(),
+        echo = !quiet || is_verbose_mode(),
+        spinner = quiet,
+        error_on_status = FALSE,
+        stderr_callback = function(x, p) { if (quiet) message(x) }
+      )
     )
   )
 }
 
 build_example <- function(dir, cores, quiet, timeout) {
-  withr::with_path(
-    c(
-      toolchain_PATH_env_var(),
-      tbb_path(dir = dir)
-    ),
-    wsl_compatible_run(
-      command = make_cmd(),
-      args = c(paste0(""-j"", cores),
-                cmdstan_ext(file.path(""examples"", ""bernoulli"", ""bernoulli""))),
-      wd = dir,
-      echo_cmd = is_verbose_mode(),
-      echo = !quiet || is_verbose_mode(),
-      spinner = quiet,
-      error_on_status = FALSE,
-      stderr_callback = function(x, p) { if (quiet) message(x) },
-      timeout = timeout
+  withr::with_envvar(
+    c(""HOME"" = utils::shortPathName(Sys.getenv(""HOME""))),
+    withr::with_path(
+      c(
+        toolchain_PATH_env_var(),
+        tbb_path(dir = dir)
+      ),
+      wsl_compatible_run(
+        command = make_cmd(),
+        args = c(paste0(""-j"", cores),
+                  cmdstan_ext(file.path(""examples"", ""bernoulli"", ""bernoulli""))),
+        wd = dir,
+        echo_cmd = is_verbose_mode(),
+        echo = !quiet || is_verbose_mode(),
+        spinner = quiet,
+        error_on_status = FALSE,
+        stderr_callback = function(x, p) { if (quiet) message(x) },
+        timeout = timeout
+      )
     )
   )
 }

---FILE: R/model.R---
@@ -664,54 +664,57 @@ compile <- function(quiet = TRUE,
     if (compile_standalone) {
       expose_stan_functions(self$functions, !quiet)
     }
-
-    withr::with_path(
-      c(
-        toolchain_PATH_env_var(),
-        tbb_path()
-      ),
-      run_log <- wsl_compatible_run(
-        command = make_cmd(),
-        args = c(wsl_safe_path(repair_path(tmp_exe)),
-                cpp_options_to_compile_flags(cpp_options),
-                stancflags_val),
-        wd = cmdstan_path(),
-        echo = !quiet || is_verbose_mode(),
-        echo_cmd = is_verbose_mode(),
-        spinner = quiet && rlang::is_interactive() && !identical(Sys.getenv(""IN_PKGDOWN""), ""true""),
-        stderr_callback = function(x, p) {
-          if (!startsWith(x, paste0(make_cmd(), "": *** No rule to make target""))) {
-            message(x)
-          }
-          if (grepl(""PCH file"", x) || grepl(""precompiled header"", x) || grepl("".hpp.gch"", x) ) {
-            warning(
-              ""CmdStan's precompiled header (PCH) files may need to be rebuilt.\n"",
-              ""If your model failed to compile please run rebuild_cmdstan().\n"",
-              ""If the issue persists please open a bug report."",
-              call. = FALSE
-            )
-          }
-          if (grepl(""No space left on device"", x) || grepl(""error in backend: IO failure on output stream"", x)) {
-            warning(
-              ""The C++ compiler ran out of disk space and was unable to build the executables for your model!\n"",
-              ""See the above error for more details."",
-              call. = FALSE
-            )
-          }
-          if (os_is_macos()) {
-            if (R.version$arch == ""aarch64""
-                && grepl(""but the current translation unit is being compiled for target"", x)) {
+  
+    withr::with_envvar(
+      c(""HOME"" = utils::shortPathName(Sys.getenv(""HOME""))),
+      withr::with_path(
+        c(
+          toolchain_PATH_env_var(),
+          tbb_path()
+        ),
+        run_log <- wsl_compatible_run(
+          command = make_cmd(),
+          args = c(wsl_safe_path(repair_path(tmp_exe)),
+                  cpp_options_to_compile_flags(cpp_options),
+                  stancflags_val),
+          wd = cmdstan_path(),
+          echo = !quiet || is_verbose_mode(),
+          echo_cmd = is_verbose_mode(),
+          spinner = quiet && rlang::is_interactive() && !identical(Sys.getenv(""IN_PKGDOWN""), ""true""),
+          stderr_callback = function(x, p) {
+            if (!startsWith(x, paste0(make_cmd(), "": *** No rule to make target""))) {
+              message(x)
+            }
+            if (grepl(""PCH file"", x) || grepl(""precompiled header"", x) || grepl("".hpp.gch"", x) ) {
               warning(
-                ""The C++ compiler has errored due to incompatibility between the x86 and "",
-                ""Apple Silicon architectures.\n"",
-                ""If you are running R inside an IDE (RStudio, VSCode, ...), "",
-                ""make sure the IDE is a native Apple Silicon app.\n"",
+                ""CmdStan's precompiled header (PCH) files may need to be rebuilt.\n"",
+                ""If your model failed to compile please run rebuild_cmdstan().\n"",
+                ""If the issue persists please open a bug report."",
                 call. = FALSE
               )
             }
-          }
-        },
-        error_on_status = FALSE
+            if (grepl(""No space left on device"", x) || grepl(""error in backend: IO failure on output stream"", x)) {
+              warning(
+                ""The C++ compiler ran out of disk space and was unable to build the executables for your model!\n"",
+                ""See the above error for more details."",
+                call. = FALSE
+              )
+            }
+            if (os_is_macos()) {
+              if (R.version$arch == ""aarch64""
+                  && grepl(""but the current translation unit is being compiled for target"", x)) {
+                warning(
+                  ""The C++ compiler has errored due to incompatibility between the x86 and "",
+                  ""Apple Silicon architectures.\n"",
+                  ""If you are running R inside an IDE (RStudio, VSCode, ...), "",
+                  ""make sure the IDE is a native Apple Silicon app.\n"",
+                  call. = FALSE
+                )
+              }
+            }
+          },
+          error_on_status = FALSE
+        )
       )
     )
     if (is.na(run_log$status) || run_log$status != 0) {

---FILE: R/path.R---
@@ -250,7 +250,6 @@ reset_cmdstan_version <- function() {
     if (win_home != """") {
       home <- win_home
     }
-    home <- file.path(home, ""Documents"")
   }
   home
 }

---FILE: R/run.R---
@@ -410,18 +410,21 @@ CmdStanRun <- R6::R6Class(
 check_target_exe <- function(exe) {
   exe_path <- file.path(cmdstan_path(), exe)
   if (!file.exists(exe_path)) {
-    withr::with_path(
-      c(
-        toolchain_PATH_env_var(),
-        tbb_path()
-      ),
-      run_log <- wsl_compatible_run(
-        command = make_cmd(),
-        args = exe,
-        wd = cmdstan_path(),
-        echo_cmd = TRUE,
-        echo = TRUE,
-        error_on_status = TRUE
+    withr::with_envvar(
+      c(""HOME"" = utils::shortPathName(Sys.getenv(""HOME""))),
+      withr::with_path(
+        c(
+          toolchain_PATH_env_var(),
+          tbb_path()
+        ),
+        run_log <- wsl_compatible_run(
+          command = make_cmd(),
+          args = exe,
+          wd = cmdstan_path(),
+          echo_cmd = TRUE,
+          echo = TRUE,
+          error_on_status = TRUE
+        )
       )
     )
   }

---FILE: R/utils.R---
@@ -692,11 +692,14 @@ assert_file_exists <- checkmate::makeAssertionFunction(check_file_exists)
 # Model methods & expose_functions helpers ------------------------------------------------------
 get_cmdstan_flags <- function(flag_name) {
   cmdstan_path <- cmdstanr::cmdstan_path()
-  flags <- wsl_compatible_run(
-    command = ""make"",
-    args = c(""-s"", paste0(""print-"", flag_name)),
-    wd = cmdstan_path
-  )$stdout
+  withr::with_envvar(
+    c(""HOME"" = utils::shortPathName(Sys.getenv(""HOME""))),
+    flags <- wsl_compatible_run(
+      command = ""make"",
+      args = c(""-s"", paste0(""print-"", flag_name)),
+      wd = cmdstan_path
+    )$stdout
+  )
 
   flags <- gsub(""\n"", """", flags, fixed = TRUE)
 ",True,False,Implementation / Logic,6
stan-dev,cmdstanr,fa1dff9afad1d17e018766f703906ae5880e97bf,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-06-06T11:59:49Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-06-06T11:59:49Z,"Fix Windows path change, aarch64 rtools, 2.35 seed changes",R/install.R;R/path.R;R/utils.R;tests/testthat/test-model-init.R,False,True,True,False,17,2,19,"---FILE: R/install.R---
@@ -849,7 +849,11 @@ toolchain_PATH_env_var <- function() {
 rtools4x_toolchain_path <- function() {
   toolchain <- ifelse(is_ucrt_toolchain(), ""ucrt64"", ""mingw64"")
   if (Sys.getenv(""CMDSTANR_USE_RTOOLS"") != """") {
-    toolchain <- ""x86_64-w64-mingw32.static.posix""
+    if (arch_is_aarch64()) {
+      toolchain <- ""aarch64-w64-mingw32.static.posix""
+    } else {
+      toolchain <- ""x86_64-w64-mingw32.static.posix""
+    }
   }
   repair_path(file.path(rtools4x_home_path(), toolchain, ""bin""))
 }
@@ -871,10 +875,16 @@ rtools4x_version <- function() {
 
 rtools4x_home_path <- function() {
   rtools_ver <- rtools4x_version()
+  if (arch_is_aarch64()) {
+    rtools_ver <- paste0(rtools_ver, ""_AARCH64"")
+  }
   path <- Sys.getenv(paste0(""RTOOLS"", rtools_ver, ""_HOME""))
 
   if (!nzchar(path)) {
     default_path <- repair_path(file.path(paste0(""C:/rtools"", rtools_ver)))
+    if (arch_is_aarch64()) {
+      default_path <- paste0(default_path, ""-aarch64"")
+    }
     if (dir.exists(default_path)) {
       path <- default_path
     }

---FILE: R/path.R---
@@ -250,6 +250,7 @@ reset_cmdstan_version <- function() {
     if (win_home != """") {
       home <- win_home
     }
+    home <- file.path(home, ""Documents"")
   }
   home
 }

---FILE: R/utils.R---
@@ -83,6 +83,10 @@ is_rosetta2 <- function() {
   rosetta2
 }
 
+arch_is_aarch64 <- function() {
+  isTRUE(R.version$arch == ""aarch64"")
+}
+
 # Returns the type of make command to use to compile depending on the OS
 make_cmd <- function() {
   if (os_is_windows() && !os_is_wsl() && (Sys.getenv(""CMDSTANR_USE_RTOOLS"") == """")) {

---FILE: tests/testthat/test-model-init.R---
@@ -20,7 +20,7 @@ test_that(""all fitting methods work with provided init files"", {
     mod$optimize(data = data_list, init = init_json_1, seed = 123)
   )
   expect_vb_output(
-    mod$variational(data = data_list, init = init_json_1, seed = 123)
+    mod$variational(data = data_list, init = init_json_1, seed = 1234)
   )
   expect_laplace_output(
     mod$laplace(data = data_list, init = init_json_1, seed = 123)",True,False,Environment / Configuration,4
stan-dev,cmdstanr,5fa19137f9bbddc2c5bdfe673b5ddffae8055477,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-06-05T12:30:06Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-06-05T12:30:06Z,Prepare bugfix release,NEWS.md,False,False,False,False,15,1,16,"---FILE: NEWS.md---
@@ -1,9 +1,23 @@
-# cmdstanr 0.8.0.9000
+# cmdstanr 0.8.1.9000
 
 Items for next release go here
 
 # cmdstanr 0.8.0
 
+## Minor changes
+
+* Added `CMDSTANR_USE_RTOOLS` environment variable to force stock RTools on Windows by @andrjohns in #980
+* Automatically initialise model methods when called, add `inc_warmup` argument to `$unconstrain_draws()` by @andrjohns in #985
+
+## Bugfixes
+
+* Fix errors when using pathfinder object as initial values by @avehtari in #984
+* Fix error with `$unconstrain_draws()` returning incorrect assumptions in some cases by @andrjohns in #983
+* Fix spurious errors about missing CmdStan config files by @andrjohns in #981
+* Fix linking error when exposing SUNDIALS/KINSOL functions or model methods by @andrjohns in #977
+
+# cmdstanr 0.8.0
+
 ## Major new features
 
 * Add functionality for passing `CmdStanFit` objects as initial values by @SteveBronder in #937",False,False,Documentation / Formatting,3
stan-dev,cmdstanr,1679aa7659dd7f75c6c33224cba5d4dcd50de116,Aki Vehtari,aki.vehtari@aalto.fi,2024-05-24T11:08:25Z,GitHub,noreply@github.com,2024-05-24T11:08:25Z,fix process_init_approx (#984),R/args.R,False,True,True,False,3,1,4,"---FILE: R/args.R---
@@ -1290,6 +1290,8 @@ process_init_approx <- function(init, num_procs, model_variables = NULL,
     model_variables = list(parameters = colnames(draws_df)[3:(length(colnames(draws_df)) - 3)])
   }
   draws_df$lw = draws_df$lp__ - draws_df$lp_approx__
+  # Replace NaN and Inf with -Inf
+  draws_df$lw[!is.finite(draws_df$lw)] <- -Inf
   # Calculate unique draws based on 'lw' using base R functions
   unique_draws = length(unique(draws_df$lw))
   if (num_procs > unique_draws) {
@@ -1315,7 +1317,7 @@ process_init_approx <- function(init, num_procs, model_variables = NULL,
     draws_df$weight = exp(draws_df$lw - max(draws_df$lw))
   } else {
       draws_df$weight = posterior::pareto_smooth(
-        exp(draws_df$lw - max(draws_df$lw)), tail = ""right"", return_k=FALSE)
+        exp(draws_df$lw - max(draws_df$lw)), tail = ""right"", r_eff=1, return_k=FALSE)
   }
   init_draws_df = posterior::resample_draws(draws_df, ndraws = num_procs,
                                             weights = draws_df$weight, method = ""simple_no_replace"")",True,False,Implementation / Logic,6
stan-dev,cmdstanr,f141d06ff62e9d43059983ca63b835d7c606efac,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-05-24T07:35:04Z,GitHub,noreply@github.com,2024-05-24T07:35:04Z,Fix incorrect sizing for unconstrain_draws (#983),R/fit.R;R/utils.R;inst/include/model_methods.cpp,False,True,True,False,34,5,39,"---FILE: R/fit.R---
@@ -561,6 +561,9 @@ CmdStanFit$set(""public"", name = ""unconstrain_variables"", value = unconstrain_var
 #'
 unconstrain_draws <- function(files = NULL, draws = NULL,
                               format = getOption(""cmdstanr_draws_format"", ""draws_array"")) {
+  if (!(format %in% valid_draws_formats())) {
+    stop(""Invalid draws format requested!"", call. = FALSE)
+  }
   if (!is.null(files) || !is.null(draws)) {
     if (!is.null(files) && !is.null(draws)) {
       stop(""Either a list of CSV files or a draws object can be passed, not both"",
@@ -582,6 +585,8 @@ unconstrain_draws <- function(files = NULL, draws = NULL,
     }
     draws <- maybe_convert_draws_format(private$draws_, ""draws_matrix"")
   }
+  
+  chains <- posterior::nchains(draws)
 
   model_par_names <- self$metadata()$stan_variables[self$metadata()$stan_variables != ""lp__""]
   model_variables <- self$runset$args$model_variables
@@ -598,7 +603,9 @@ unconstrain_draws <- function(files = NULL, draws = NULL,
   unconstrained <- private$model_methods_env_$unconstrain_draws(private$model_methods_env_$model_ptr_, draws)
   uncon_names <- private$model_methods_env_$unconstrained_param_names(private$model_methods_env_$model_ptr_, FALSE, FALSE)
   names(unconstrained) <- repair_variable_names(uncon_names)
-  maybe_convert_draws_format(unconstrained, format, .nchains = posterior::nchains(draws))
+  unconstrained$.nchains <- chains
+  
+  do.call(function(...) { create_draws_format(format, ...) }, unconstrained)
 }
 CmdStanFit$set(""public"", name = ""unconstrain_draws"", value = unconstrain_draws)
 

---FILE: R/utils.R---
@@ -426,6 +426,19 @@ maybe_convert_draws_format <- function(draws, format, ...) {
   )
 }
 
+create_draws_format <- function(format, ...) {
+  format <- sub(""^draws_"", """", format)
+  switch(
+    format,
+    ""array"" = posterior::draws_array(...),
+    ""df"" = posterior::draws_df(...),
+    ""data.frame"" = posterior::draws_df(...),
+    ""list"" = posterior::draws_list(...),
+    ""matrix"" = posterior::draws_matrix(...),
+    ""rvars"" = posterior::draws_rvars(...),
+    stop(""Invalid draws format."", call. = FALSE)
+  )
+}
 
 # convert draws for external packages ------------------------------------------
 

---FILE: inst/include/model_methods.cpp---
@@ -127,15 +127,24 @@ Eigen::VectorXd unconstrain_variables(SEXP ext_model_ptr, Eigen::VectorXd variab
 }
 
 // [[Rcpp::export]]
-Eigen::MatrixXd unconstrain_draws(SEXP ext_model_ptr, Eigen::MatrixXd variables) {
+Rcpp::List unconstrain_draws(SEXP ext_model_ptr, Eigen::MatrixXd variables) {
   Rcpp::XPtr<stan::model::model_base> ptr(ext_model_ptr);
-  Eigen::MatrixXd unconstrained_draws(variables.cols(), variables.rows());
+  // Need to do this for the first row to get the correct size of the unconstrained draws
+  Eigen::VectorXd unconstrained_draw1;
+  ptr->unconstrain_array(variables.row(0).transpose(), unconstrained_draw1, &Rcpp::Rcout);
+  std::vector<Eigen::VectorXd> unconstrained_draws(unconstrained_draw1.size());
+  for (auto&& unconstrained_par : unconstrained_draws) {
+    unconstrained_par.resize(variables.rows());
+  }
+  
   for (int i = 0; i < variables.rows(); i++) {
     Eigen::VectorXd unconstrained_variables;
     ptr->unconstrain_array(variables.transpose().col(i), unconstrained_variables, &Rcpp::Rcout);
-    unconstrained_draws.col(i) = unconstrained_variables;
+    for (int j = 0; j < unconstrained_variables.size(); j++) {
+      unconstrained_draws[j](i) = unconstrained_variables(j);
+    }
   }
-  return unconstrained_draws.transpose();
+  return Rcpp::wrap(unconstrained_draws);
 }
 
 // [[Rcpp::export]]",True,False,Implementation / Logic,6
stan-dev,cmdstanr,499aa233e8631aa2621ed4ea4c86569927f2f743,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-05-23T08:33:18Z,GitHub,noreply@github.com,2024-05-23T08:33:18Z,Fix spurious cmdstan config errors (#981),R/model.R;R/run.R;man/model-method-laplace.Rd;man/model-method-optimize.Rd;man/model-method-pathfinder.Rd;man/model-method-sample.Rd;man/model-method-sample_mpi.Rd;man/model-method-variational.Rd;tests/testthat/test-model-output_dir.R,False,True,True,False,35,77,112,"---FILE: R/model.R---
@@ -1167,8 +1167,8 @@ sample <- function(data = NULL,
                    show_messages = TRUE,
                    show_exceptions = TRUE,
                    diagnostics = c(""divergences"", ""treedepth"", ""ebfmi""),
-                   save_metric = if (cmdstan_version() > ""2.34.0"") { TRUE } else { NULL },
-                   save_cmdstan_config = if (cmdstan_version() > ""2.34.0"") { TRUE } else { NULL },
+                   save_metric = NULL,
+                   save_cmdstan_config = NULL,
                    # deprecated
                    cores = NULL,
                    num_cores = NULL,
@@ -1379,7 +1379,7 @@ sample_mpi <- function(data = NULL,
                        show_messages = TRUE,
                        show_exceptions = TRUE,
                        diagnostics = c(""divergences"", ""treedepth"", ""ebfmi""),
-                       save_cmdstan_config = if (cmdstan_version() > ""2.34.0"") { TRUE } else { NULL },
+                       save_cmdstan_config = NULL,
                        # deprecated
                        validate_csv = TRUE) {
 
@@ -1525,7 +1525,7 @@ optimize <- function(data = NULL,
                      history_size = NULL,
                      show_messages = TRUE,
                      show_exceptions = TRUE,
-                     save_cmdstan_config = if (cmdstan_version() > ""2.34.0"") { TRUE } else { NULL }) {
+                     save_cmdstan_config = NULL) {
   procs <- CmdStanProcs$new(
     num_procs = 1,
     show_stderr_messages = show_exceptions,
@@ -1659,7 +1659,7 @@ laplace <- function(data = NULL,
                     draws = NULL,
                     show_messages = TRUE,
                     show_exceptions = TRUE,
-                    save_cmdstan_config = if (cmdstan_version() > ""2.34.0"") { TRUE } else { NULL }) {
+                    save_cmdstan_config = NULL) {
   if (cmdstan_version() < ""2.32"") {
     stop(""This method is only available in cmdstan >= 2.32"", call. = FALSE)
   }
@@ -1815,7 +1815,7 @@ variational <- function(data = NULL,
                         draws = NULL,
                         show_messages = TRUE,
                         show_exceptions = TRUE,
-                        save_cmdstan_config = if (cmdstan_version() > ""2.34.0"") { TRUE } else { NULL }) {
+                        save_cmdstan_config = NULL) {
   procs <- CmdStanProcs$new(
     num_procs = 1,
     show_stderr_messages = show_exceptions,
@@ -1960,7 +1960,7 @@ pathfinder <- function(data = NULL,
                        calculate_lp = NULL,
                        show_messages = TRUE,
                        show_exceptions = TRUE,
-                       save_cmdstan_config = if (cmdstan_version() > ""2.34.0"") { TRUE } else { NULL }) {
+                       save_cmdstan_config = NULL) {
   procs <- CmdStanProcs$new(
     num_procs = 1,
     show_stderr_messages = show_exceptions,

---FILE: R/run.R---
@@ -26,10 +26,10 @@ CmdStanRun <- R6::R6Class(
       if (cmdstan_version() >= ""2.26.0"") {
         private$profile_files_ <- self$new_profile_files()
       }
-      if (cmdstan_version() >= ""2.34.0"" && !is.null(self$args$save_cmdstan_config) && self$args$save_cmdstan_config) {
+      if (cmdstan_version() >= ""2.34.0"" && !is.null(self$args$save_cmdstan_config) && as.logical(self$args$save_cmdstan_config)) {
         private$config_files_ <- self$new_config_files()
       }
-      if (cmdstan_version() >= ""2.34.0"" && !is.null(self$args$method_args$save_metric) && self$args$method_args$save_metric) {
+      if (cmdstan_version() >= ""2.34.0"" && !is.null(self$args$method_args$save_metric) && as.logical(self$args$method_args$save_metric)) {
         private$metric_files_ <- self$new_metric_files()
       }
       if (self$args$save_latent_dynamics) {
@@ -77,13 +77,6 @@ CmdStanRun <- R6::R6Class(
     config_files = function(include_failed = FALSE) {
       files <- private$config_files_
       files_win_path <- sapply(private$config_files_, wsl_safe_path, revert = TRUE)
-      if (!length(files) || !any(file.exists(files_win_path))) {
-        stop(
-          ""No CmdStan config files found. "",
-          ""Set 'save_cmdstan_config=TRUE' when fitting the model."",
-          call. = FALSE
-        )
-      }
       if (include_failed) {
         files
       } else {
@@ -94,13 +87,6 @@ CmdStanRun <- R6::R6Class(
     metric_files = function(include_failed = FALSE) {
       files <- private$metric_files_
       files_win_path <- sapply(private$metric_files_, wsl_safe_path, revert = TRUE)
-      if (!length(files) || !any(file.exists(files_win_path))) {
-        stop(
-          ""No metric files found. "",
-          ""Set 'save_metric=TRUE' when fitting the model."",
-          call. = FALSE
-        )
-      }
       if (include_failed) {
         files
       } else {
@@ -404,12 +390,12 @@ CmdStanRun <- R6::R6Class(
             private$profile_files_,
           if (cmdstan_version() > ""2.34.0"" &&
               !is.null(self$args$save_cmdstan_config) &&
-              self$args$save_cmdstan_config &&
+              as.logical(self$args$save_cmdstan_config) &&
               !private$config_files_saved_)
             self$config_files(include_failed = TRUE),
           if (cmdstan_version() > ""2.34.0"" &&
               !(is.null(self$args$method_args$save_metric)) &&
-              self$args$method_args$save_metric &&
+              as.logical(self$args$method_args$save_metric) &&
               !private$metric_files_saved_)
             self$metric_files(include_failed = TRUE)
         )

---FILE: man/model-method-laplace.Rd---
@@ -22,12 +22,7 @@ laplace(
   draws = NULL,
   show_messages = TRUE,
   show_exceptions = TRUE,
-  save_cmdstan_config = if (cmdstan_version() > ""2.34.0"") {
-     TRUE
- } else {
-    
-    NULL
- }
+  save_cmdstan_config = NULL
 )
 }
 \arguments{

---FILE: man/model-method-optimize.Rd---
@@ -28,12 +28,7 @@ optimize(
   history_size = NULL,
   show_messages = TRUE,
   show_exceptions = TRUE,
-  save_cmdstan_config = if (cmdstan_version() > ""2.34.0"") {
-     TRUE
- } else {
-    
-    NULL
- }
+  save_cmdstan_config = NULL
 )
 }
 \arguments{

---FILE: man/model-method-pathfinder.Rd---
@@ -33,12 +33,7 @@ pathfinder(
   calculate_lp = NULL,
   show_messages = TRUE,
   show_exceptions = TRUE,
-  save_cmdstan_config = if (cmdstan_version() > ""2.34.0"") {
-     TRUE
- } else {
-    
-    NULL
- }
+  save_cmdstan_config = NULL
 )
 }
 \arguments{

---FILE: man/model-method-sample.Rd---
@@ -37,17 +37,8 @@ sample(
   show_messages = TRUE,
   show_exceptions = TRUE,
   diagnostics = c(""divergences"", ""treedepth"", ""ebfmi""),
-  save_metric = if (cmdstan_version() > ""2.34.0"") {
-     TRUE
- } else {
-     NULL
- },
-  save_cmdstan_config = if (cmdstan_version() > ""2.34.0"") {
-     TRUE
- } else {
-    
-    NULL
- },
+  save_metric = NULL,
+  save_cmdstan_config = NULL,
   cores = NULL,
   num_cores = NULL,
   num_chains = NULL,

---FILE: man/model-method-sample_mpi.Rd---
@@ -36,12 +36,7 @@ sample_mpi(
   show_messages = TRUE,
   show_exceptions = TRUE,
   diagnostics = c(""divergences"", ""treedepth"", ""ebfmi""),
-  save_cmdstan_config = if (cmdstan_version() > ""2.34.0"") {
-     TRUE
- } else {
-    
-    NULL
- },
+  save_cmdstan_config = NULL,
   validate_csv = TRUE
 )
 }

---FILE: man/model-method-variational.Rd---
@@ -29,12 +29,7 @@ variational(
   draws = NULL,
   show_messages = TRUE,
   show_exceptions = TRUE,
-  save_cmdstan_config = if (cmdstan_version() > ""2.34.0"") {
-     TRUE
- } else {
-    
-    NULL
- }
+  save_cmdstan_config = NULL
 )
 }
 \arguments{

---FILE: tests/testthat/test-model-output_dir.R---
@@ -27,18 +27,23 @@ test_that(""all fitting methods work with output_dir"", {
       files <- list.files(method_dir)
     }
     # specifying output_dir
-    fit <- testing_fit(""bernoulli"", method = method, seed = 123,
-                        output_dir = method_dir)
+    call_args  <- list(
+      ""bernoulli"",
+      method = method,
+      seed = 123,
+      output_dir = method_dir,
+      save_cmdstan_config = TRUE
+    )
+    if (method == ""sample"") {
+      call_args$save_metric <- TRUE
+    }
+    fit <- do.call(testing_fit, call_args)
     # WSL path manipulations result in a short path which slightly differs
     # from the original tempdir(), so need to normalise both for comparison
     expect_equal(normalizePath(fit$runset$args$output_dir),
                  normalizePath(method_dir))
     files <- normalizePath(list.files(method_dir, full.names = TRUE))
-    # in 2.34.0 we also save the config files for all methods and the metric
-    # for sample
-    if (cmdstan_version() < ""2.34.0"") {
-      mult <- 1
-    } else if (method == ""sample"") {
+    if (method == ""sample"") {
       mult <- 3
       expect_equal(files[grepl(""metric"", files)],
                    normalizePath(sapply(fit$metric_files(), wsl_safe_path, revert = TRUE,
@@ -99,7 +104,10 @@ test_that(""error if output_dir is invalid"", {
 })
 
 test_that(""output_dir works with trailing /"", {
-  test_dir <- file.path(sandbox, ""trailing"")
+  test_dir <- file.path(tempdir(check = TRUE), ""output_dir"")
+  if (dir.exists(test_dir)) {
+    unlink(test_dir, recursive = TRUE)
+  }
   dir.create(test_dir)
   fit <- testing_fit(
     ""bernoulli"",
@@ -109,7 +117,5 @@ test_that(""output_dir works with trailing /"", {
   )
   expect_equal(normalizePath(fit$runset$args$output_dir),
                normalizePath(test_dir))
-  # in 2.34.0 we also save the metric and config files
-  mult <- if (cmdstan_version() >= ""2.34.0"") 3 else 1
-  expect_equal(length(list.files(test_dir)), mult * fit$num_procs())
+  expect_equal(length(list.files(test_dir)), fit$num_procs())
 })",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,827385faae61c95f8d7bdc29f758b27dad172c43,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-05-22T16:02:46Z,GitHub,noreply@github.com,2024-05-22T16:02:46Z,"Fix linking error when exposing SUNDIALS/KINSOL functions or model methods (#977)

* Fix linking error with SUNDIALS

* Add test

* Add handling for Linux systems needing -fPIC

* Update test-model-expose-functions.R",.gitignore;DESCRIPTION;R/utils.R;tests/testthat/test-model-expose-functions.R,False,True,True,False,40,5,45,"---FILE: .gitignore---
@@ -7,3 +7,4 @@
 inst/doc
 dev-helpers.R
 release-prep.R
+*.DS_Store

---FILE: DESCRIPTION---
@@ -1,6 +1,6 @@
 Package: cmdstanr
 Title: R Interface to 'CmdStan'
-Version: 0.8.0
+Version: 0.8.0.9000
 Date: 2024-05-18
 Authors@R:
     c(person(given = ""Jonah"", family = ""Gabry"", role = ""aut"",

---FILE: R/utils.R---
@@ -727,18 +727,38 @@ get_cmdstan_flags <- function(flag_name) {
   paste(flags, collapse = "" "")
 }
 
+check_sundials_fpic <- function(verbose) {
+  if (!os_is_linux()){
+    return(invisible(NULL))
+  }
+  sundials_flags <- get_cmdstan_flags(""CPPFLAGS_SUNDIALS"")
+  local_flags <- cmdstan_make_local()
+  if (any(grepl(""-fPIC"", c(sundials_flags, local_flags), fixed = TRUE))) {
+    return(invisible(NULL))
+  }
+  if (interactive()) {
+    message(""SUNDIALS needs to be compiled with -fPIC when exposing functions or "",
+            ""model methods on Linux.\n"",
+            ""Updating your make/local file to include -fPIC and rebuilding CmdStan now..."")
+  }
+  cmdstan_make_local(cpp_options = list(""CPPFLAGS_SUNDIALS += -fPIC""), append = TRUE)
+  rebuild_cmdstan(quiet = !verbose)
+  if (interactive()) {
+    message(""CmdStan has been rebuilt, continuing with model compilation..."")
+  }
+}
+
 rcpp_source_stan <- function(code, env, verbose = FALSE, ...) {
+  check_sundials_fpic(verbose)
   cxxflags <- get_cmdstan_flags(""CXXFLAGS"")
   cmdstanr_includes <- system.file(""include"", package = ""cmdstanr"", mustWork = TRUE)
   cmdstanr_includes <- paste0("" -I\"""", cmdstanr_includes,""\"""")
-  libs <- c(""LDLIBS"", ""LIBSUNDIALS"", ""TBB_TARGETS"", ""LDFLAGS_TBB"")
+  libs <- c(""LDLIBS"", ""LIBSUNDIALS"", ""TBB_TARGETS"", ""LDFLAGS_TBB"", ""SUNDIALS_TARGETS"")
   libs <- paste(sapply(libs, get_cmdstan_flags), collapse = "" "")
   if (.Platform$OS.type == ""windows"") {
     libs <- paste(libs, ""-fopenmp"")
   }
-  lib_paths <- c(""/stan/lib/stan_math/lib/tbb/"",
-                 ""/stan/lib/stan_math/lib/sundials_6.1.1/lib/"")
-  withr::with_path(paste0(cmdstan_path(), lib_paths),
+  withr::with_path(repair_path(file.path(cmdstan_path(),""stan/lib/stan_math/lib/tbb"")),
     withr::with_makevars(
       c(
         USE_CXX14 = 1,

---FILE: tests/testthat/test-model-expose-functions.R---
@@ -419,3 +419,17 @@ test_that(""Exposing functions with precompiled model gives meaningful error"", {
     fixed = TRUE
   )
 })
+
+test_that(""Functions with SUNDIALS/KINSOL methods link correctly"", {
+  modcode <- ""
+    functions {
+      vector dummy_functor(vector guess, vector theta, data array[] real tails, data array[] int x_i) {
+        return [1, 1]';
+      }
+      vector call_solver(vector guess, vector theta, data array[] real tails, data array[] int x_i) {
+        return algebra_solver_newton(dummy_functor, guess, theta, tails, x_i);
+      }
+    }""
+  mod <- cmdstan_model(write_stan_file(modcode), force_recompile=TRUE)
+  expect_no_error(mod$expose_functions())
+})",True,False,Dependency / Package,7
stan-dev,cmdstanr,12fe0f8fd35226dadf3abc50de726537dc9ea475,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-05-18T13:22:31Z,GitHub,noreply@github.com,2024-05-18T13:22:31Z,"Prepare v0.8.0 release (#974)

* Prepare for v0.8.0 release

* Cherry-pick fix for Onedrive path issues",.Rbuildignore;DESCRIPTION;NEWS.md;R/model.R;R/path.R;README.md;man/CmdStanModel.Rd,False,True,True,False,61,11,72,"---FILE: .Rbuildignore---
@@ -12,3 +12,4 @@
 ^\.github$
 ^vignettes/articles-online-only$
 ^release-prep\.R$
+^\.vscode$

---FILE: DESCRIPTION---
@@ -1,7 +1,7 @@
 Package: cmdstanr
 Title: R Interface to 'CmdStan'
-Version: 0.7.1
-Date: 2024-01-09
+Version: 0.8.0
+Date: 2024-05-18
 Authors@R:
     c(person(given = ""Jonah"", family = ""Gabry"", role = ""aut"",
              email = ""jsg2201@columbia.edu""),
@@ -36,7 +36,7 @@ RoxygenNote: 7.3.1
 Roxygen: list(markdown = TRUE, r6 = FALSE)
 SystemRequirements: CmdStan (https://mc-stan.org/users/interfaces/cmdstan)
 Depends:
-    R (>= 4.0.0)
+    R (>= 3.5.0)
 Imports:
     checkmate,
     data.table,

---FILE: NEWS.md---
@@ -1,10 +1,46 @@
-# cmdstanr 0.7.0.9000
+# cmdstanr 0.8.0.9000
 
 Items for next release go here
 
+# cmdstanr 0.8.0
+
+## Major new features
+
+* Add functionality for passing `CmdStanFit` objects as initial values by @SteveBronder in #937
+
+## Other improvements
+
+* Add compatibility with CmdStan 2.35 by @andrjohns in #972
+* Add `show_messages` and `show_exceptions` arguments to all methods for controlling output by @andrjohns in #897
+* Drop RcppEigen dependency, implement basic Eigen -> C++ interop by @andrjohns in #899
+* Add compatibility with CmdStan 2.34 by @andrjohns in #905 #910
+* Add a format argument to the `unconstrain_draws()` method to specify draws format of return by @andrjohns in #886
+* Align `cmdstanr` EBFMI diagnostic threshold with CmdStan by @andrjohns in #892
+* Add global option `cmdstanr_print_line_numbers` to add line number to model printing by @sbfnk in #967
+* Add new CmdStan arguments `save_metric` and `save_cmdstan_config` by @venpopov in #932
+* Add documentation for CmdStanR global options by @jgabry in #951
+* Add documentation for how to obtain structured output similar to `rstan::extract()` using a combination of `cmdstanr` and `posterior` by @jgabry in #955
+* Added coercion generics for CmdStanFit objects by @gowerc in #943
+* `psis_resample` and `calculate_lp` arguments added to Pathfinder method by @SteveBronder in #903
+* Documentation and tests for LOO method updated by @jgabry in #923
+* Global option `cmdstanr_warn_inits` added to disable warnings about partially specified initial values by @jgabry in #913
+* Updates to MCMC `output_dir` documentation by @jgabry in #929
+
+## Bugfixes
+
+* Fix broken link in OpenCL documentation by @eipi10 in #908
+* Fix a minor typo in the README by @jgabry in #911
+* Make exported RNG functions respect changes to R's seed by @andrjohns in #973
+* Optimisations for model methods functions by @andrjohns in #960
+* Bugfix for passing function for initial values with Pathfinder method and default `num_paths` by @andrjohns in #964
+* Continue with compilation if `compile_stanalone=TRUE` but no functions are found by @jgabry in #956
+* Update tests and CI for compatibility with MacOS ARM64 by @andrjohns in #958
+* Fix handling of `inv_metric` argument with only 1 parameter by @venpopov in #935
+* Fixes for compatibility with RTools44 by @andrjohns in #952 #959
+
 # cmdstanr 0.7.0
 
-## Major new features 
+## Major new features
 
 * New `laplace` method by @jgabry in #800
 * New `pathfinder` method by @SteveBronder in #848
@@ -47,7 +83,7 @@ Items for next release go here
 ### Major new features
 
 * New `expose_functions()` method to expose Stan functions to R by @andrjohns in #702. See `?expose_functions`.
-* New methods for accessing log_prob, grad_log_prob, hessian, un/constrain variables by @andrjohns in #701. See `?init_model_methods`. 
+* New methods for accessing log_prob, grad_log_prob, hessian, un/constrain variables by @andrjohns in #701. See `?init_model_methods`.
 
 ### Other changes
 

---FILE: R/model.R---
@@ -212,7 +212,7 @@ cmdstan_model <- function(stan_file = NULL, exe_file = NULL, compile = TRUE, ...
 #'  |**Method**|**Description**|
 #'  |:----------|:---------------|
 #'  [`$sample()`][model-method-sample] |  Run CmdStan's `""sample""` method, return [`CmdStanMCMC`] object. |
-#'  [`$sample_mpi()`][model-method-sample_mpi] |  Run CmdStan's `""sample""` method with [MPI](https://mc-stan.org/math/mpi.html), return [`CmdStanMCMC`] object. |
+#'  [`$sample_mpi()`][model-method-sample_mpi] |  Run CmdStan's `""sample""` method with [MPI](https://mc-stan.org/math/md_doxygen_2parallelism__support_2mpi__parallelism.html), return [`CmdStanMCMC`] object. |
 #'  [`$optimize()`][model-method-optimize] |  Run CmdStan's `""optimize""` method, return [`CmdStanMLE`] object. |
 #'  [`$variational()`][model-method-variational] |  Run CmdStan's `""variational""` method, return [`CmdStanVB`] object. |
 #'  [`$pathfinder()`][model-method-pathfinder] |  Run CmdStan's `""pathfinder""` method, return [`CmdStanPathfinder`] object. |

---FILE: R/path.R---
@@ -115,9 +115,9 @@ cmdstan_default_install_path <- function(old = FALSE, wsl = FALSE) {
     file.path(paste0(wsl_dir_prefix(wsl = TRUE), wsl_home_dir()), "".cmdstan"")
   } else {
     if (old) {
-      file.path(Sys.getenv(""HOME""), "".cmdstanr"")
+      file.path(.home_path(), "".cmdstanr"")
     } else {
-      file.path(Sys.getenv(""HOME""), "".cmdstan"")
+      file.path(.home_path(), "".cmdstan"")
     }
   }
 }
@@ -240,3 +240,16 @@ fake_cmdstan_version <- function(version) {
 reset_cmdstan_version <- function() {
   .cmdstanr$VERSION <- read_cmdstan_version(cmdstan_path())
 }
+
+.home_path <- function() {
+  home <- Sys.getenv(""HOME"")
+  if (os_is_windows()) {
+    userprofile <- Sys.getenv(""USERPROFILE"")
+    h_drivepath <- file.path(Sys.getenv(""HOMEDRIVE""), Sys.getenv(""HOMEPATH""))
+    win_home <- ifelse(userprofile == """", h_drivepath, userprofile)
+    if (win_home != """") {
+      home <- win_home
+    }
+  }
+  home
+}

---FILE: README.md---
@@ -27,7 +27,7 @@ releases.
 * Modularity: CmdStanR runs Stan's algorithms and lets downstream modules do the
 analysis.
 
-* Flexible [BSD-3 license](https://opensource.org/license/bsd-3-clause/).
+* Flexible [BSD-3 license](https://opensource.org/license/bsd-3-clause).
 
 
 ### Installation

---FILE: man/CmdStanModel.Rd---
@@ -44,7 +44,7 @@ methods, many of which have their own (linked) documentation pages:
 \subsection{Model fitting}{\tabular{ll}{
    \strong{Method} \tab \strong{Description} \cr
    \code{\link[=model-method-sample]{$sample()}} \tab Run CmdStan's \code{""sample""} method, return \code{\link{CmdStanMCMC}} object. \cr
-   \code{\link[=model-method-sample_mpi]{$sample_mpi()}} \tab Run CmdStan's \code{""sample""} method with \href{https://mc-stan.org/math/mpi.html}{MPI}, return \code{\link{CmdStanMCMC}} object. \cr
+   \code{\link[=model-method-sample_mpi]{$sample_mpi()}} \tab Run CmdStan's \code{""sample""} method with \href{https://mc-stan.org/math/md_doxygen_2parallelism__support_2mpi__parallelism.html}{MPI}, return \code{\link{CmdStanMCMC}} object. \cr
    \code{\link[=model-method-optimize]{$optimize()}} \tab Run CmdStan's \code{""optimize""} method, return \code{\link{CmdStanMLE}} object. \cr
    \code{\link[=model-method-variational]{$variational()}} \tab Run CmdStan's \code{""variational""} method, return \code{\link{CmdStanVB}} object. \cr
    \code{\link[=model-method-pathfinder]{$pathfinder()}} \tab Run CmdStan's \code{""pathfinder""} method, return \code{\link{CmdStanPathfinder}} object. \cr",True,False,Environment / Configuration,7
stan-dev,cmdstanr,b271b7ba8e9d2ceade85bdc6d2f1b6bc8c4fe4ed,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-05-18T07:47:21Z,GitHub,noreply@github.com,2024-05-18T07:47:21Z,"Make exported RNG functions respect changes to R's seed (#973)

* Make exported RNG functions respect changes to R's seed

* Simpler seed setting

* Seed set location

* Fix test",R/utils.R;tests/testthat/test-model-expose-functions.R,False,True,True,False,20,16,36,"---FILE: R/utils.R---
@@ -887,12 +887,16 @@ prep_fun_cpp <- function(fun_start, fun_end, model_lines) {
   }
   fun_body <- gsub(""// [[stan::function]]"", ""// [[Rcpp::export]]\n"", fun_body, fixed = TRUE)
   fun_body <- gsub(""std::ostream\\*\\s*pstream__\\s*=\\s*nullptr"", """", fun_body)
-  if (cmdstan_version() < ""2.35.0"") {
-    fun_body <- gsub(""boost::ecuyer1988&\\s*base_rng__"", ""SEXP base_rng_ptr"", fun_body)
-  } else {
-    fun_body <- gsub(""stan::rng_t&\\s*base_rng__"", ""SEXP base_rng_ptr"", fun_body)
+  if (grepl(""(stan::rng_t|boost::ecuyer1988)"", fun_body)) {
+    if (cmdstan_version() < ""2.35.0"") {
+      fun_body <- gsub(""boost::ecuyer1988&\\s*base_rng__"", ""SEXP base_rng_ptr, SEXP seed"", fun_body)
+    } else {
+      fun_body <- gsub(""stan::rng_t&\\s*base_rng__"", ""SEXP base_rng_ptr, SEXP seed"", fun_body)
+    }
+    rng_seed <- ""Rcpp::XPtr<stan::rng_t> base_rng(base_rng_ptr);base_rng->seed(Rcpp::as<int>(seed));""
+    fun_body <- gsub(""return"", paste(rng_seed, ""return""), fun_body)
+    fun_body <- gsub(""base_rng__,"", ""*(base_rng.get()),"", fun_body, fixed = TRUE)
   }
-  fun_body <- gsub(""base_rng__,"", ""*(Rcpp::XPtr<stan::rng_t>(base_rng_ptr).get()),"", fun_body, fixed = TRUE)
   fun_body <- gsub(""pstream__"", ""&Rcpp::Rcout"", fun_body, fixed = TRUE)
   fun_body <- paste(fun_body, collapse = ""\n"")
   gsub(pattern = "",\\s*)"", replacement = "")"", fun_body)
@@ -953,6 +957,9 @@ compile_functions <- function(env, verbose = FALSE, global = FALSE) {
     fundef <- get(fun, envir = fun_env)
     funargs <- formals(fundef)
     funargs$base_rng_ptr <- env$rng_ptr
+    # To allow for exported RNG functions to respect the R 'set.seed()' call,
+    # we need to derive a seed deterministically from the current RNG state
+    funargs$seed <- quote(sample.int(.Machine$integer.max, 1))
     formals(fundef) <- funargs
     assign(fun, fundef, envir = fun_env)
   }

---FILE: tests/testthat/test-model-expose-functions.R---
@@ -346,19 +346,16 @@ test_that(""rng functions can be exposed"", {
   mod <- cmdstan_model(model, force_recompile = TRUE)
   fit <- mod$sample(data = data_list)
 
-  set.seed(10)
   fit$expose_functions(verbose = TRUE)
+  set.seed(10)
+  res1_1 <- fit$functions$wrap_normal_rng(5,10)
+  res2_1 <- fit$functions$wrap_normal_rng(5,10)
+  set.seed(10)
+  res1_2 <- fit$functions$wrap_normal_rng(5,10)
+  res2_2 <- fit$functions$wrap_normal_rng(5,10)
 
-  expect_equal(
-    fit$functions$wrap_normal_rng(5,10),
-    # Stan RNG changed in 2.35
-    ifelse(cmdstan_version() < ""2.35.0"",-4.529876423, 0.02974925)
-  )
-
-  expect_equal(
-    fit$functions$wrap_normal_rng(5,10),
-    ifelse(cmdstan_version() < ""2.35.0"", 8.12959026, 10.3881349)
-  )
+  expect_equal(res1_1, res1_2)
+  expect_equal(res2_1, res2_2)
 })
 
 test_that(""Overloaded functions give meaningful errors"", {",True,False,Reproducibility / Versioning,4
stan-dev,cmdstanr,c218b0d9b360d4d735b5317c832d87f68e092cd0,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-05-17T13:21:22Z,GitHub,noreply@github.com,2024-05-17T13:21:22Z,"Test and fix issues with 2.35 RC (#972)

* Try updating R actions to fix win failures

* Format true/false to 1/0 in csv read

* Add handling for new RNG type

* Changes to RNG handling

* Profile name ordering

* Revert RC install in workflow prior to merge

* Fix RNG compatibility with <2.35",.github/workflows/R-CMD-check-wsl.yaml;.github/workflows/R-CMD-check.yaml;.github/workflows/Test-coverage.yaml;.github/workflows/cmdstan-tarball-check.yaml;R/csv.R;R/utils.R;inst/include/base_rng.cpp;inst/include/model_methods.cpp;inst/include/rcpp_tuple_interop.hpp;inst/include/stan_rng.hpp;tests/testthat/test-model-compile.R;tests/testthat/test-model-expose-functions.R;tests/testthat/test-profiling.R,False,True,True,False,76,32,108,"---FILE: .github/workflows/R-CMD-check-wsl.yaml---
@@ -37,10 +37,10 @@ jobs:
 
       - uses: actions/checkout@v4
 
-      - uses: r-lib/actions/setup-r@v2.8.7
-      - uses: r-lib/actions/setup-pandoc@v2.8.7
+      - uses: r-lib/actions/setup-r@v2.9.0
+      - uses: r-lib/actions/setup-pandoc@v2.9.0
 
-      - uses: r-lib/actions/setup-r-dependencies@v2.8.7
+      - uses: r-lib/actions/setup-r-dependencies@v2.9.0
         with:
           extra-packages: any::rcmdcheck, local::.
 
@@ -71,7 +71,7 @@ jobs:
           sessioninfo::session_info(pkgs, include_base = TRUE)
         shell: Rscript {0}
 
-      - uses: r-lib/actions/check-r-package@v2.8.7
+      - uses: r-lib/actions/check-r-package@v2.9.0
         env:
           _R_CHECK_CRAN_INCOMING_: false
 

---FILE: .github/workflows/R-CMD-check.yaml---
@@ -25,7 +25,7 @@ jobs:
         config:
           - {os: macOS-latest, r: 'devel', rtools: ''}
           - {os: macOS-latest, r: 'release', rtools: ''}
-          #- {os: windows-latest, r: 'devel', rtools: '44'}
+          - {os: windows-latest, r: 'devel', rtools: '44'}
           - {os: windows-latest, r: 'release', rtools: '44'}
           - {os: windows-latest, r: 'oldrel', rtools: '43'}
           - {os: ubuntu-latest, r: 'devel', rtools: ''}
@@ -49,14 +49,14 @@ jobs:
 
       - uses: actions/checkout@v4
 
-      - uses: r-lib/actions/setup-r@v2.8.7
+      - uses: r-lib/actions/setup-r@v2.9.0
         with:
           r-version: ${{ matrix.config.r }}
           rtools-version: ${{ matrix.config.rtools }}
 
-      - uses: r-lib/actions/setup-pandoc@v2.8.7
+      - uses: r-lib/actions/setup-pandoc@v2.9.0
 
-      - uses: r-lib/actions/setup-r-dependencies@v2.8.7
+      - uses: r-lib/actions/setup-r-dependencies@v2.9.0
         with:
           extra-packages: any::rcmdcheck, local::.
 
@@ -73,7 +73,7 @@ jobs:
           sessioninfo::session_info(pkgs, include_base = TRUE)
         shell: Rscript {0}
 
-      - uses: r-lib/actions/check-r-package@v2.8.7
+      - uses: r-lib/actions/check-r-package@v2.9.0
         env:
           _R_CHECK_CRAN_INCOMING_: false
 

---FILE: .github/workflows/Test-coverage.yaml---
@@ -42,10 +42,10 @@ jobs:
         if: ""!startsWith(github.ref, 'refs/tags/') && github.ref != 'refs/heads/master'""
       - uses: actions/checkout@v4
 
-      - uses: r-lib/actions/setup-r@v2.8.7
-      - uses: r-lib/actions/setup-pandoc@v2.8.7
+      - uses: r-lib/actions/setup-r@v2.9.0
+      - uses: r-lib/actions/setup-pandoc@v2.9.0
 
-      - uses: r-lib/actions/setup-r-dependencies@v2.8.7
+      - uses: r-lib/actions/setup-r-dependencies@v2.9.0
         with:
           extra-packages: any::rcmdcheck, local::., any::covr, any::gridExtra
 

---FILE: .github/workflows/cmdstan-tarball-check.yaml---
@@ -40,12 +40,12 @@ jobs:
           sudo apt-get install -y libcurl4-openssl-dev || true
           sudo apt-get install -y openmpi-bin openmpi-common libopenmpi-dev || true
 
-      - uses: r-lib/actions/setup-r@v2.8.7
+      - uses: r-lib/actions/setup-r@v2.9.0
         with:
           r-version: ${{ matrix.config.r }}
           rtools-version: ${{ matrix.config.rtools }}
 
-      - uses: r-lib/actions/setup-pandoc@v2.8.7
+      - uses: r-lib/actions/setup-pandoc@v2.9.0
 
       - name: Query dependencies
         run: |

---FILE: R/csv.R---
@@ -840,6 +840,14 @@ read_csv_metadata <- function(csv_file) {
     csv_file_info$fitted_params <- wsl_safe_path(csv_file_info$fitted_params,
                                                   revert = TRUE)
   }
+  csv_file_info <- lapply(csv_file_info, function(item) {
+    if (is.character(item) && length(item) == 1) {
+      if (item %in% c(""true"", ""false"")) {
+        item <- as.integer(as.logical(item))
+      }
+    }
+    item
+  })
   csv_file_info
 }
 

---FILE: R/utils.R---
@@ -727,7 +727,7 @@ get_cmdstan_flags <- function(flag_name) {
   paste(flags, collapse = "" "")
 }
 
-rcpp_source_stan <- function(code, env, verbose = FALSE) {
+rcpp_source_stan <- function(code, env, verbose = FALSE, ...) {
   cxxflags <- get_cmdstan_flags(""CXXFLAGS"")
   cmdstanr_includes <- system.file(""include"", package = ""cmdstanr"", mustWork = TRUE)
   cmdstanr_includes <- paste0("" -I\"""", cmdstanr_includes,""\"""")
@@ -746,7 +746,7 @@ rcpp_source_stan <- function(code, env, verbose = FALSE) {
         PKG_CXXFLAGS = paste0(cxxflags, cmdstanr_includes, collapse = "" ""),
         PKG_LIBS = libs
       ),
-      Rcpp::sourceCpp(code = code, env = env, verbose = verbose)
+      Rcpp::sourceCpp(code = code, env = env, verbose = verbose, ...)
     )
   )
   invisible(NULL)
@@ -887,8 +887,12 @@ prep_fun_cpp <- function(fun_start, fun_end, model_lines) {
   }
   fun_body <- gsub(""// [[stan::function]]"", ""// [[Rcpp::export]]\n"", fun_body, fixed = TRUE)
   fun_body <- gsub(""std::ostream\\*\\s*pstream__\\s*=\\s*nullptr"", """", fun_body)
-  fun_body <- gsub(""boost::ecuyer1988&\\s*base_rng__"", ""SEXP base_rng_ptr"", fun_body)
-  fun_body <- gsub(""base_rng__,"", ""*(Rcpp::XPtr<boost::ecuyer1988>(base_rng_ptr).get()),"", fun_body, fixed = TRUE)
+  if (cmdstan_version() < ""2.35.0"") {
+    fun_body <- gsub(""boost::ecuyer1988&\\s*base_rng__"", ""SEXP base_rng_ptr"", fun_body)
+  } else {
+    fun_body <- gsub(""stan::rng_t&\\s*base_rng__"", ""SEXP base_rng_ptr"", fun_body)
+  }
+  fun_body <- gsub(""base_rng__,"", ""*(Rcpp::XPtr<stan::rng_t>(base_rng_ptr).get()),"", fun_body, fixed = TRUE)
   fun_body <- gsub(""pstream__"", ""&Rcpp::Rcout"", fun_body, fixed = TRUE)
   fun_body <- paste(fun_body, collapse = ""\n"")
   gsub(pattern = "",\\s*)"", replacement = "")"", fun_body)
@@ -921,6 +925,7 @@ compile_functions <- function(env, verbose = FALSE, global = FALSE) {
     env$hpp_code[1:(funs[1] - 1)],
     ""#include <rcpp_tuple_interop.hpp>"",
     ""#include <rcpp_eigen_interop.hpp>"",
+    ""#include <stan_rng.hpp>"",
     stan_funs),
   collapse = ""\n"")
   if (global) {
@@ -935,7 +940,7 @@ compile_functions <- function(env, verbose = FALSE, global = FALSE) {
   if (length(rng_funs) > 0) {
     rng_cpp <- system.file(""include"", ""base_rng.cpp"", package = ""cmdstanr"", mustWork = TRUE)
     rcpp_source_stan(paste0(readLines(rng_cpp), collapse=""\n""), env, verbose)
-    env$rng_ptr <- env$base_rng(seed=0)
+    env$rng_ptr <- env$base_rng(seed=1)
   }
 
   # For all RNG functions, pass the initialised Boost RNG by default

---FILE: inst/include/base_rng.cpp---
@@ -1,8 +1,8 @@
 #include <Rcpp.h>
-#include <boost/random/additive_combine.hpp>
+#include <stan_rng.hpp>
 
 // [[Rcpp::export]]
-SEXP base_rng(boost::uint32_t seed = 0) {
-  Rcpp::XPtr<boost::ecuyer1988> rng_ptr(new boost::ecuyer1988(seed));
+SEXP base_rng(boost::uint32_t seed = 1) {
+  Rcpp::XPtr<stan::rng_t> rng_ptr(new stan::rng_t(seed));
   return rng_ptr;
 }

---FILE: inst/include/model_methods.cpp---
@@ -3,13 +3,13 @@
 #include <stan/model/model_base.hpp>
 #include <stan/model/log_prob_grad.hpp>
 #include <stan/model/log_prob_propto.hpp>
-#include <boost/random/additive_combine.hpp>
 #ifdef CMDSTAN_JSON
 #include <cmdstan/io/json/json_data.hpp>
 #else
 #include <stan/io/json/json_data.hpp>
 #include <stan/io/empty_var_context.hpp>
 #endif
+#include <stan_rng.hpp>
 
 std::shared_ptr<stan::io::var_context> var_context(std::string file_path) {
   if (file_path == """") {
@@ -36,7 +36,7 @@ Rcpp::List model_ptr(std::string data_path, boost::uint32_t seed) {
   Rcpp::XPtr<stan::model::model_base> ptr(
     &new_model(*var_context(data_path), seed, &Rcpp::Rcout)
   );
-  Rcpp::XPtr<boost::ecuyer1988> base_rng(new boost::ecuyer1988(seed));
+  Rcpp::XPtr<stan::rng_t> base_rng(new stan::rng_t(seed));
   return Rcpp::List::create(
     Rcpp::Named(""model_ptr"") = ptr,
     Rcpp::Named(""base_rng"") = base_rng
@@ -144,7 +144,7 @@ std::vector<double> constrain_variables(SEXP ext_model_ptr, SEXP base_rng,
                                     bool return_trans_pars,
                                     bool return_gen_quants) {
   Rcpp::XPtr<stan::model::model_base> ptr(ext_model_ptr);
-  Rcpp::XPtr<boost::ecuyer1988> rng(base_rng);
+  Rcpp::XPtr<stan::rng_t> rng(base_rng);
   std::vector<int> params_i;
   std::vector<double> vars;
 

---FILE: inst/include/rcpp_tuple_interop.hpp---
@@ -1,3 +1,6 @@
+#ifndef CMDSTANR_RCPP_TUPLE_INTEROP_HPP
+#define CMDSTANR_RCPP_TUPLE_INTEROP_HPP
+
 #include <stan/math/prim/functor/apply.hpp>
 #include <Rcpp.h>
 
@@ -38,3 +41,5 @@ namespace Rcpp {
     }, x);
   }
 }
+
+#endif

---FILE: inst/include/stan_rng.hpp---
@@ -0,0 +1,17 @@
+#ifndef CMDSTANR_STAN_RNG_HPP
+#define CMDSTANR_STAN_RNG_HPP
+
+#include <boost/random/additive_combine.hpp>
+#include <stan/version.hpp>
+
+// A consistent rng_t is defined from 2.35 onwards
+// so add a fallback for older versions
+#if STAN_MAJOR == 2 && STAN_MINOR >= 35
+#include <stan/services/util/create_rng.hpp>
+#else
+namespace stan {
+  using rng_t = boost::ecuyer1988;
+}
+#endif
+
+#endif

---FILE: tests/testthat/test-model-compile.R---
@@ -3,7 +3,7 @@ context(""model-compile"")
 set_cmdstan_path()
 stan_program <- cmdstan_example_file()
 mod <- cmdstan_model(stan_file = stan_program, compile = FALSE)
-
+cmdstan_make_local(cpp_options = list(""PRECOMPILED_HEADERS""=""false""))
 
 test_that(""object initialized correctly"", {
   expect_equal(mod$stan_file(), stan_program)
@@ -130,6 +130,9 @@ test_that(""name in STANCFLAGS is set correctly"", {
 test_that(""switching threads on and off works without rebuild"", {
   main_path_o <- file.path(cmdstan_path(), ""src"", ""cmdstan"", ""main.o"")
   main_path_threads_o <- file.path(cmdstan_path(), ""src"", ""cmdstan"", ""main_threads.o"")
+  backup <- cmdstan_make_local()
+  no_threads <- grep(""STAN_THREADS"", backup, invert = TRUE, value = TRUE)
+  cmdstan_make_local(cpp_options = list(no_threads), append = FALSE)
   if (file.exists(main_path_threads_o)) {
     file.remove(main_path_threads_o)
   }
@@ -155,6 +158,7 @@ test_that(""switching threads on and off works without rebuild"", {
   expect_equal(before_mtime, after_mtime)
 
   expect_warning(mod$compile(threads = TRUE, dry_run = TRUE), ""deprecated"")
+  cmdstan_make_local(cpp_options = backup, append = FALSE)
 })
 
 test_that(""multiple cpp_options work"", {
@@ -483,19 +487,19 @@ test_that(""include_paths_stanc3_args() works"", {
 
 test_that(""cpp_options work with settings in make/local"", {
   backup <- cmdstan_make_local()
+  no_threads <- grep(""STAN_THREADS"", backup, invert = TRUE, value = TRUE)
+  cmdstan_make_local(cpp_options = list(no_threads), append = FALSE)
 
   if (length(mod$exe_file()) > 0 && file.exists(mod$exe_file())) {
     file.remove(mod$exe_file())
   }
 
-  cmdstan_make_local(cpp_options = list(), append = TRUE)
   rebuild_cmdstan()
   mod <- cmdstan_model(stan_file = stan_program)
   expect_null(mod$cpp_options()$STAN_THREADS)
 
   file.remove(mod$exe_file())
 
-  cmdstan_make_local(cpp_options = backup, append = FALSE)
   cmdstan_make_local(cpp_options = list(stan_threads = TRUE), append = TRUE)
 
   file <- file.path(cmdstan_path(), ""examples"", ""bernoulli"", ""bernoulli.stan"")

---FILE: tests/testthat/test-model-expose-functions.R---
@@ -351,12 +351,13 @@ test_that(""rng functions can be exposed"", {
 
   expect_equal(
     fit$functions$wrap_normal_rng(5,10),
-    -4.5298764235381225873
+    # Stan RNG changed in 2.35
+    ifelse(cmdstan_version() < ""2.35.0"",-4.529876423, 0.02974925)
   )
 
   expect_equal(
     fit$functions$wrap_normal_rng(5,10),
-    8.1295902610102039887
+    ifelse(cmdstan_version() < ""2.35.0"", 8.12959026, 10.3881349)
   )
 })
 

---FILE: tests/testthat/test-profiling.R---
@@ -12,7 +12,9 @@ test_that(""profiling works if profiling data is present"", {
   profiles <- fit$profiles()
   expect_equal(length(profiles), 4)
   expect_equal(dim(profiles[[1]]), c(3,9))
-  expect_equal(profiles[[1]][,""name""], c(""glm"", ""priors"", ""udf""))
+  for (name in profiles[[1]][,""name""]) {
+    expect_true(name %in% c(""udf"", ""priors"", ""glm""))
+  }
 
   file.remove(fit$profile_files())
   expect_error(
@@ -24,7 +26,9 @@ test_that(""profiling works if profiling data is present"", {
   profiles_no_csv <- fit$profiles()
   expect_equal(length(profiles_no_csv), 4)
   expect_equal(dim(profiles_no_csv[[1]]), c(3,9))
-  expect_equal(profiles_no_csv[[1]][,""name""], c(""glm"", ""priors"", ""udf""))
+  for (name in profiles_no_csv[[1]][,""name""]) {
+    expect_true(name %in% c(""udf"", ""priors"", ""glm""))
+  }
 })
 
 test_that(""profiling errors if no profiling files are present"", {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,0c2179e75bdfed0fa60af9aa6480fc587f8a1548,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-05-07T17:15:34Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-05-07T17:15:34Z,Add default num_paths to fix init error,R/model.R;man/model-method-pathfinder.Rd;tests/testthat/test-model-pathfinder.R,False,True,True,False,7,2,9,"---FILE: R/model.R---
@@ -1939,7 +1939,7 @@ pathfinder <- function(data = NULL,
                        history_size = NULL,
                        single_path_draws = NULL,
                        draws = NULL,
-                       num_paths = NULL,
+                       num_paths = 4,
                        max_lbfgs_iters = NULL,
                        num_elbo_draws = NULL,
                        save_single_paths = NULL,

---FILE: man/model-method-pathfinder.Rd---
@@ -25,7 +25,7 @@ pathfinder(
   history_size = NULL,
   single_path_draws = NULL,
   draws = NULL,
-  num_paths = NULL,
+  num_paths = 4,
   max_lbfgs_iters = NULL,
   num_elbo_draws = NULL,
   save_single_paths = NULL,

---FILE: tests/testthat/test-model-pathfinder.R---
@@ -124,6 +124,11 @@ test_that(""pathfinder() method works with init file"", {
   expect_pathfinder_output(mod$pathfinder(data = data_file_r, init = init_file))
 })
 
+test_that(""pathfinder() method works with init function and default paths"", {
+  init_function <- function() { list(theta = 0.5) }
+  expect_pathfinder_output(mod$pathfinder(data = data_file_r, init = init_function))
+})
+
 test_that(""pathfinder() method runs when all arguments specified"", {
   expect_pathfinder_output(fit <- do.call(mod$pathfinder, ok_arg_values))
   expect_is(fit, ""CmdStanPathfinder"")",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,bf397e426b3fdfd07b9a28f946d4e0ce8a2f3f11,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-05-05T14:29:08Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-05-05T14:29:08Z,"Add handling for variable order, fix chains return in draws",R/fit.R;R/model.R;R/utils.R,False,True,True,False,15,10,25,"---FILE: R/fit.R---
@@ -518,7 +518,7 @@ unconstrain_variables <- function(variables) {
          "" not provided!"", call. = FALSE)
   }
 
-  variables_vector <- unlist(variables, recursive = TRUE, use.names = FALSE)
+  variables_vector <- unlist(variables[model_par_names], recursive = TRUE)
   private$model_methods_env_$unconstrain_variables(private$model_methods_env_$model_ptr_, variables_vector)
 }
 CmdStanFit$set(""public"", name = ""unconstrain_variables"", value = unconstrain_variables)
@@ -598,7 +598,7 @@ unconstrain_draws <- function(files = NULL, draws = NULL,
   unconstrained <- private$model_methods_env_$unconstrain_draws(private$model_methods_env_$model_ptr_, draws)
   uncon_names <- private$model_methods_env_$unconstrained_param_names(private$model_methods_env_$model_ptr_, FALSE, FALSE)
   names(unconstrained) <- repair_variable_names(uncon_names)
-  maybe_convert_draws_format(unconstrained, format)
+  maybe_convert_draws_format(unconstrained, format, .nchains = posterior::nchains(draws))
 }
 CmdStanFit$set(""public"", name = ""unconstrain_draws"", value = unconstrain_draws)
 

---FILE: R/model.R---
@@ -465,10 +465,10 @@ compile <- function(quiet = TRUE,
                     stanc_options = list(),
                     force_recompile = getOption(""cmdstanr_force_recompile"", default = FALSE),
                     compile_model_methods = FALSE,
-                    compile_hessian_method = FALSE,
                     compile_standalone = FALSE,
                     dry_run = FALSE,
                     #deprecated
+                    compile_hessian_method = FALSE,
                     threads = FALSE) {
 
   if (length(self$stan_file()) == 0) {
@@ -505,6 +505,11 @@ compile <- function(quiet = TRUE,
     cpp_options[[""stan_threads""]] <- TRUE
   }
 
+  # temporary deprecation warnings
+  if (isTRUE(compile_hessian_method)) {
+    warning(""'compile_hessian_method' is deprecated. The hessian method is compiled with all models."")
+  }
+
   if (length(self$exe_file()) == 0) {
     if (is.null(dir)) {
       exe_base <- self$stan_file()

---FILE: R/utils.R---
@@ -409,19 +409,19 @@ valid_draws_formats <- function() {
     ""draws_rvars"", ""rvars"")
 }
 
-maybe_convert_draws_format <- function(draws, format) {
+maybe_convert_draws_format <- function(draws, format, ...) {
   if (is.null(draws)) {
     return(draws)
   }
   format <- sub(""^draws_"", """", format)
   switch(
     format,
-    ""array"" = posterior::as_draws_array(draws),
-    ""df"" = posterior::as_draws_df(draws),
-    ""data.frame"" = posterior::as_draws_df(draws),
-    ""list"" = posterior::as_draws_list(draws),
-    ""matrix"" = posterior::as_draws_matrix(draws),
-    ""rvars"" = posterior::as_draws_rvars(draws),
+    ""array"" = posterior::as_draws_array(draws, ...),
+    ""df"" = posterior::as_draws_df(draws, ...),
+    ""data.frame"" = posterior::as_draws_df(draws, ...),
+    ""list"" = posterior::as_draws_list(draws, ...),
+    ""matrix"" = posterior::as_draws_matrix(draws, ...),
+    ""rvars"" = posterior::as_draws_rvars(draws, ...),
     stop(""Invalid draws format."", call. = FALSE)
   )
 }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,63a1768e49427563afe1b630e3501a2c554f9229,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-05-04T16:18:50Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-05-04T16:18:50Z,ifelse fix,R/model.R,False,True,True,False,7,7,14,"---FILE: R/model.R---
@@ -1149,8 +1149,8 @@ sample <- function(data = NULL,
                    show_messages = TRUE,
                    show_exceptions = TRUE,
                    diagnostics = c(""divergences"", ""treedepth"", ""ebfmi""),
-                   save_metric = ifelse(cmdstan_version() > ""2.34.0"", TRUE, NULL),
-                   save_cmdstan_config = ifelse(cmdstan_version() > ""2.34.0"", TRUE, NULL),
+                   save_metric = if (cmdstan_version() > ""2.34.0"") { TRUE } else { NULL },
+                   save_cmdstan_config = if (cmdstan_version() > ""2.34.0"") { TRUE } else { NULL },
                    # deprecated
                    cores = NULL,
                    num_cores = NULL,
@@ -1361,7 +1361,7 @@ sample_mpi <- function(data = NULL,
                        show_messages = TRUE,
                        show_exceptions = TRUE,
                        diagnostics = c(""divergences"", ""treedepth"", ""ebfmi""),
-                       save_cmdstan_config = ifelse(cmdstan_version() > ""2.34.0"", TRUE, NULL),
+                       save_cmdstan_config = if (cmdstan_version() > ""2.34.0"") { TRUE } else { NULL },
                        # deprecated
                        validate_csv = TRUE) {
 
@@ -1507,7 +1507,7 @@ optimize <- function(data = NULL,
                      history_size = NULL,
                      show_messages = TRUE,
                      show_exceptions = TRUE,
-                     save_cmdstan_config = ifelse(cmdstan_version() > ""2.34.0"", TRUE, NULL)) {
+                     save_cmdstan_config = if (cmdstan_version() > ""2.34.0"") { TRUE } else { NULL }) {
   procs <- CmdStanProcs$new(
     num_procs = 1,
     show_stderr_messages = show_exceptions,
@@ -1641,7 +1641,7 @@ laplace <- function(data = NULL,
                     draws = NULL,
                     show_messages = TRUE,
                     show_exceptions = TRUE,
-                    save_cmdstan_config = ifelse(cmdstan_version() > ""2.34.0"", TRUE, NULL)) {
+                    save_cmdstan_config = if (cmdstan_version() > ""2.34.0"") { TRUE } else { NULL }) {
   if (cmdstan_version() < ""2.32"") {
     stop(""This method is only available in cmdstan >= 2.32"", call. = FALSE)
   }
@@ -1797,7 +1797,7 @@ variational <- function(data = NULL,
                         draws = NULL,
                         show_messages = TRUE,
                         show_exceptions = TRUE,
-                        save_cmdstan_config = ifelse(cmdstan_version() > ""2.34.0"", TRUE, NULL)) {
+                        save_cmdstan_config = if (cmdstan_version() > ""2.34.0"") { TRUE } else { NULL }) {
   procs <- CmdStanProcs$new(
     num_procs = 1,
     show_stderr_messages = show_exceptions,
@@ -1942,7 +1942,7 @@ pathfinder <- function(data = NULL,
                        calculate_lp = NULL,
                        show_messages = TRUE,
                        show_exceptions = TRUE,
-                       save_cmdstan_config = ifelse(cmdstan_version() > ""2.34.0"", TRUE, NULL)) {
+                       save_cmdstan_config = if (cmdstan_version() > ""2.34.0"") { TRUE } else { NULL }) {
   procs <- CmdStanProcs$new(
     num_procs = 1,
     show_stderr_messages = show_exceptions,",True,False,Implementation / Logic,6
stan-dev,cmdstanr,ef9e718055580d2265fe426fc5ffb048194fd68c,Steve Bronder,sbronder@flatironinstitute.org,2024-05-03T22:09:46Z,Steve Bronder,sbronder@flatironinstitute.org,2024-05-03T22:09:46Z,remove things to try to fix stringi cli error,.github/workflows/R-CMD-check.yaml,False,False,False,False,0,2,2,"---FILE: .github/workflows/R-CMD-check.yaml---
@@ -58,9 +58,7 @@ jobs:
 
       - uses: r-lib/actions/setup-r-dependencies@v2.8.7
         with:
-          cache-version: 2
           extra-packages: any::rcmdcheck, local::.
-          upgrade: ""TRUE""
 
       - name: Install cmdstan
         run: |",False,False,Data / Input Handling,3
stan-dev,cmdstanr,25d0a741600a90ca445eaebd9b557869e8a468a3,Steve Bronder,sbronder@flatironinstitute.org,2024-05-03T20:25:08Z,Steve Bronder,sbronder@flatironinstitute.org,2024-05-03T20:25:08Z,update for stringi temporary fix,.github/workflows/R-CMD-check.yaml;.github/workflows/Test-coverage.yaml;.github/workflows/cmdstan-tarball-check.yaml,False,False,False,False,8,2,10,"---FILE: .github/workflows/R-CMD-check.yaml---
@@ -59,6 +59,12 @@ jobs:
       - uses: r-lib/actions/setup-r-dependencies@v2.8.7
         with:
           extra-packages: any::rcmdcheck, local::.
+      # Workaround for windows stringi fail to install bug
+      # See https://github.com/r-lib/actions/issues/516
+      - name: stringi workaround on Linux
+        if: runner.os == 'Windows'
+        run: install.packages(""stringi"", repos = ""https://cran.rstudio.com"")
+        shell: Rscript {0}
 
       - name: Install cmdstan
         run: |

---FILE: .github/workflows/Test-coverage.yaml---
@@ -63,6 +63,6 @@ jobs:
       - name: Test coverage (Windows)
         if: runner.os == 'Windows'
         run: |
-          options(covr.gcov = 'C:/rtools43/mingw64/bin/gcov.exe');
+          options(covr.gcov = 'C:/rtools44/mingw64/bin/gcov.exe');
           covr::codecov(type = ""tests"", function_exclusions = ""sample_mpi"")
         shell: Rscript {0}

---FILE: .github/workflows/cmdstan-tarball-check.yaml---
@@ -23,7 +23,7 @@ jobs:
       matrix:
         config:
           - {os: macOS-latest, r: 'release', rtools: ''}
-          - {os: windows-latest, r: 'release', rtools: '43'}
+          - {os: windows-latest, r: 'release', rtools: '44'}
           - {os: ubuntu-20.04, r: 'release', rtools: ''}
     env:
       R_REMOTES_NO_ERRORS_FROM_WARNINGS: true",False,False,Dependency / Package,4
stan-dev,cmdstanr,6c6715806791a18749210a4500b9222abf53ee54,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-04-29T11:45:39Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-04-29T11:45:39Z,Older cmdstan versions error under macos arm64,tests/testthat/test-install.R,False,True,True,False,3,3,6,"---FILE: tests/testthat/test-install.R---
@@ -98,7 +98,7 @@ test_that(""install_cmdstan() works with version and release_url"", {
   expect_message(
     expect_output(
       install_cmdstan(dir = dir, overwrite = TRUE, cores = 4,
-                      release_url = ""https://github.com/stan-dev/cmdstan/releases/download/v2.26.1/cmdstan-2.26.1.tar.gz"",
+                      release_url = ""https://github.com/stan-dev/cmdstan/releases/download/v2.33.0/cmdstan-2.33.0.tar.gz"",
                       wsl = os_is_wsl()),
       ""Compiling, linking C++ code"",
       fixed = TRUE
@@ -110,7 +110,7 @@ test_that(""install_cmdstan() works with version and release_url"", {
     expect_message(
       expect_output(
         install_cmdstan(dir = dir, overwrite = TRUE, cores = 4,
-                        version = ""2.27.0"",
+                        version = ""2.33.0"",
                         # the URL is intentionally invalid to test that the version has higher priority
                         release_url = ""https://github.com/stan-dev/cmdstan/releases/download/v2.27.3/cmdstan-2.27.3.tar.gz"",
                         wsl = os_is_wsl()),
@@ -123,7 +123,7 @@ test_that(""install_cmdstan() works with version and release_url"", {
     ""version and release_url shouldn't both be specified"",
     fixed = TRUE
   )
-  expect_true(dir.exists(file.path(dir, ""cmdstan-2.27.0"")))
+  expect_true(dir.exists(file.path(dir, ""cmdstan-2.33.0"")))
   set_cmdstan_path(cmdstan_default_path())
 })
 ",True,False,Implementation / Logic,3
stan-dev,cmdstanr,b3ae8c6208fa671ae49f5f0140e49b2e39c90561,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-04-29T11:38:21Z,GitHub,noreply@github.com,2024-04-29T11:38:21Z,Fix rtools44 version alignment,R/install.R,False,True,True,False,1,1,2,"---FILE: R/install.R---
@@ -855,7 +855,7 @@ rtools4x_version <- function() {
     rtools_ver <- ""40""
   } else if (R.version$minor < ""3.0"") {
     rtools_ver <- ""42""
-  } else if (R.version$minor < ""5.0"") {
+  } else if (R.version$minor < ""4.0"") {
     rtools_ver <- ""43""
   } else {
     rtools_ver <- ""44""",True,False,Reproducibility / Versioning,4
stan-dev,cmdstanr,b5d5ff140863aa7ba9200061bfcc7be616ef7bd8,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-04-29T10:14:32Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-04-29T10:14:32Z,Try r-lib actions to resolve install/cache issues,.github/workflows/R-CMD-check.yaml,False,False,False,False,7,38,45,"---FILE: .github/workflows/R-CMD-check.yaml---
@@ -23,14 +23,14 @@ jobs:
       fail-fast: false
       matrix:
         config:
-          - {os: macOS-13, r: 'devel', rtools: ''}
-          - {os: macOS-13, r: 'release', rtools: ''}
+          - {os: macOS-latest, r: 'devel', rtools: ''}
+          - {os: macOS-latest, r: 'release', rtools: ''}
           - {os: windows-latest, r: 'devel', rtools: '44'}
           - {os: windows-latest, r: 'release', rtools: '44'}
           - {os: windows-latest, r: 'oldrel', rtools: '43'}
-          - {os: ubuntu-20.04, r: 'devel', rtools: ''}
-          - {os: ubuntu-20.04, r: 'release', rtools: ''}
-          - {os: ubuntu-20.04, r: 'oldrel', rtools: ''}
+          - {os: ubuntu-latest, r: 'devel', rtools: ''}
+          - {os: ubuntu-latest, r: 'release', rtools: ''}
+          - {os: ubuntu-latest, r: 'oldrel', rtools: ''}
     env:
       R_REMOTES_NO_ERRORS_FROM_WARNINGS: true
       GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
@@ -49,42 +49,13 @@ jobs:
 
       - uses: actions/checkout@v4
 
-      - name: Install system dependencies
-        if: runner.os == 'Linux'
-        run: |
-          sudo apt-get update
-          sudo apt-get install -y libcurl4-openssl-dev || true
-          sudo apt-get install -y openmpi-bin openmpi-common libopenmpi-dev || true
-
       - uses: r-lib/actions/setup-r@v2.8.7
         with:
           r-version: ${{ matrix.config.r }}
           rtools-version: ${{ matrix.config.rtools }}
       - uses: r-lib/actions/setup-pandoc@v2.8.7
 
-      - name: Query dependencies
-        run: |
-          install.packages('remotes')
-          saveRDS(remotes::dev_package_deps(dependencies = TRUE), "".github/depends.Rds"", version = 2)
-          writeLines(sprintf(""R-%i.%i"", getRversion()$major, getRversion()$minor), "".github/R-version"")
-        shell: Rscript {0}
-
-      - name: Cache R packages
-        if: runner.os != 'Windows'
-        uses: actions/cache@v4
-        with:
-          path: ${{ env.R_LIBS_USER }}
-          key: ${{ runner.os }}-${{ hashFiles('.github/R-version') }}-1-${{ hashFiles('.github/depends.Rds') }}
-          restore-keys: ${{ runner.os }}-${{ hashFiles('.github/R-version') }}-1-
-
-      - name: Install dependencies
-        run: |
-          Sys.setenv(""MAKEFLAGS""=""-j2"")
-          remotes::install_deps(dependencies = TRUE)
-          remotes::install_cran(""rcmdcheck"")
-          remotes::install_local(path = ""."")
-          install.packages(""curl"")
-        shell: Rscript {0}
+      - uses: r-lib/actions/setup-r-dependencies@2.8.7
 
       - name: Install cmdstan
         run: |
@@ -99,11 +70,9 @@ jobs:
           sessioninfo::session_info(pkgs, include_base = TRUE)
         shell: Rscript {0}
 
-      - name: Check
+      - uses: r-lib/actions/check-r-package@2.8.7
         env:
           _R_CHECK_CRAN_INCOMING_: false
-        run: rcmdcheck::rcmdcheck(args = c(""--no-manual"", ""--as-cran""), error_on = ""warning"", check_dir = ""check"")
-        shell: Rscript {0}
 
       - name: Show testthat output
         if: always()",False,False,Dependency / Package,4
stan-dev,cmdstanr,d887070c449c52b5d69d30eb96f38c216c33686c,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-04-29T09:55:11Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-04-29T09:55:11Z,"Fix actions rtools ver, macos runner arch temporary workaround",.github/workflows/R-CMD-check.yaml,False,False,False,False,5,5,10,"---FILE: .github/workflows/R-CMD-check.yaml---
@@ -23,11 +23,11 @@ jobs:
       fail-fast: false
       matrix:
         config:
-          - {os: macOS-latest, r: 'devel', rtools: ''}
-          - {os: macOS-latest, r: 'release', rtools: ''}
-          - {os: windows-latest, r: 'devel', rtools: ''}
-          - {os: windows-latest, r: 'release', rtools: ''}
-          - {os: windows-latest, r: 'oldrel', rtools: '42'}
+          - {os: macOS-13, r: 'devel', rtools: ''}
+          - {os: macOS-13, r: 'release', rtools: ''}
+          - {os: windows-latest, r: 'devel', rtools: '44'}
+          - {os: windows-latest, r: 'release', rtools: '44'}
+          - {os: windows-latest, r: 'oldrel', rtools: '43'}
           - {os: ubuntu-20.04, r: 'devel', rtools: ''}
           - {os: ubuntu-20.04, r: 'release', rtools: ''}
           - {os: ubuntu-20.04, r: 'oldrel', rtools: ''}",False,False,Data / Input Handling,3
stan-dev,cmdstanr,9783101545bce50d16469e9cd311c1d817ba911f,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-04-29T09:38:53Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-04-29T09:38:53Z,Fix rtools44 version alignment,R/install.R,False,True,True,False,1,1,2,"---FILE: R/install.R---
@@ -855,7 +855,7 @@ rtools4x_version <- function() {
     rtools_ver <- ""40""
   } else if (R.version$minor < ""3.0"") {
     rtools_ver <- ""42""
-  } else if (R.version$minor < ""5.0"") {
+  } else if (R.version$minor < ""4.0"") {
     rtools_ver <- ""43""
   } else {
     rtools_ver <- ""44""",True,False,Reproducibility / Versioning,4
stan-dev,cmdstanr,9584746eb581954f6603cd57e41c31339edb9417,jgabry,jgabry@gmail.com,2024-04-22T22:22:48Z,jgabry,jgabry@gmail.com,2024-04-22T22:22:48Z,"Warning but no error if `compile_standalone` but no functions found

closes #947",R/utils.R;tests/testthat/test-model-expose-functions.R,False,True,True,False,31,0,31,"---FILE: R/utils.R---
@@ -979,6 +979,11 @@ expose_stan_functions <- function(function_env, global = FALSE, verbose = FALSE)
     stop(""Exporting standalone functions with external C++ is not available before CmdStan 2.32"",
          call. = FALSE)
   }
+  if (!is.null(function_env$hpp_code) &&
+      !any(grepl(""[[stan::function]]"", function_env$hpp_code, fixed = TRUE))) {
+    warning(""No standalone functions found to compile and expose to R!"", call. = FALSE)
+    return(invisible(NULL))
+  }
   require_suggested_package(""Rcpp"")
   if (function_env$compiled) {
     if (!global) {

---FILE: tests/testthat/test-model-expose-functions.R---
@@ -314,6 +314,32 @@ test_that(""Functions can be compiled with model"", {
   )
 })
 
+test_that(""compile_standalone warns but doesn't error if no functions"", {
+  stan_no_funs_block <- write_stan_file(""
+    parameters {
+      real x;
+    }
+    model {
+      x ~ std_normal();
+    }
+  "")
+  expect_warning(
+    mod1 <- cmdstan_model(stan_no_funs_block, compile = TRUE, compile_standalone = TRUE, force_recompile = TRUE),
+    ""No standalone functions found to compile and expose to R""
+  )
+  checkmate::expect_r6(mod1, ""CmdStanModel"")
+
+  stan_empty_funs_block <- write_stan_file(""
+   functions {
+   }
+  "")
+  expect_warning(
+    mod2 <- cmdstan_model(stan_empty_funs_block, compile = TRUE, compile_standalone = TRUE, force_recompile = TRUE),
+    ""No standalone functions found to compile and expose to R""
+  )
+  checkmate::expect_r6(mod2, ""CmdStanModel"")
+})
+
 test_that(""rng functions can be exposed"", {
   skip_if(os_is_wsl())
   function_decl <- ""functions { real wrap_normal_rng(real mu, real sigma) { return normal_rng(mu, sigma); } }""",True,False,Implementation / Logic,6
stan-dev,cmdstanr,0dbe050f24a6ca93d2012ef9879ab4127bf41e20,jgabry,jgabry@gmail.com,2024-04-22T21:22:15Z,jgabry,jgabry@gmail.com,2024-04-22T21:22:15Z,"Document the `draws_of` trick to emulate `rstan::extract()`

https://github.com/stan-dev/cmdstanr/issues/183

Closes #632 and closes #183",vignettes/cmdstanr.Rmd;vignettes/posterior.Rmd,True,False,True,False,30,1,31,"---FILE: vignettes/cmdstanr.Rmd---
@@ -258,6 +258,11 @@ In general, converting to a different draws format in this way will be slower
 than just setting the appropriate format initially in the call to the `$draws()`
 method, but in most cases the speed difference will be minor.
 
+The vignette 
+[Working with Posteriors](https://mc-stan.org/cmdstanr/articles/posterior.html) 
+has more details on posterior draws, including how to reproduce the structured
+output RStan users are accustomed to getting from `rstan::extract()`.
+
 #### Plotting draws
 
 Plotting posterior distributions is as easy as passing the object returned by

---FILE: vignettes/posterior.Rmd---
@@ -121,6 +121,30 @@ To convert an existing draws object to a different format use the
 `posterior::as_draws_*()` functions.
 
 To manipulate the `draws` objects use the various methods described in the
-posterior package [vignettes](https://mc-stan.org/posterior/articles/index.html)
+**posterior** package [vignettes](https://mc-stan.org/posterior/articles/index.html)
 and [documentation](https://mc-stan.org/posterior/reference/index.html).
 
+### Structured draws similar to `rstan::extract()`
+
+The **posterior** package's `rvar` format provides a multidimensional,
+sample-based representation of random variables. See
+https://mc-stan.org/posterior/articles/rvar.html for details. 
+In addition to being useful in its own right, this format also allows CmdStanR
+users to obtain draws in a similar format to `rstan::extract()`.
+
+Suppose we have a parameter `matrix[2,3] x`. The `rvar` format lets you 
+interact with `x` as if it's a `2 x 3` matrix and automatically applies operations
+over the many posterior draws of `x`. To instead directly access the draws of `x`
+while maintaining the structure of the matrix use `posterior::draws_of()`. 
+For example: 
+
+```{r structured-draws, eval = FALSE}
+draws <- posterior::as_draws_rvars(fit$draws())
+x_rvar <- draws$x
+x_array <- posterior::draws_of(draws$x)
+```
+
+The object `x_rvar` will be an `rvar` that can be used like a `2 x 3` matrix,
+with the draws handled behind the scenes. The object `x_array` will be a 
+`4000 x 2 x 3` array (assuming `4000` posterior draws), which is the same as it
+would be after being extracted from the list returned by `rstan::extract()`.",False,True,Implementation / Logic,6
stan-dev,cmdstanr,a2c4a23716bd6cf2fa606bd73c45a39e9574cb8f,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-04-20T15:44:19Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-04-20T15:44:19Z,Fix file detection and testing under WSL,R/run.R;tests/testthat/test-model-output_dir.R,False,True,True,False,14,6,20,"---FILE: R/run.R---
@@ -76,7 +76,8 @@ CmdStanRun <- R6::R6Class(
     },
     config_files = function(include_failed = FALSE) {
       files <- private$config_files_
-      if (!length(files) || !any(file.exists(files))) {
+      files_win_path <- sapply(private$config_files_, wsl_safe_path, revert = TRUE)
+      if (!length(files) || !any(file.exists(files_win_path))) {
         stop(
           ""No CmdStan config files found. "",
           ""Set 'save_cmdstan_config=TRUE' when fitting the model."",
@@ -92,7 +93,8 @@ CmdStanRun <- R6::R6Class(
     },
     metric_files = function(include_failed = FALSE) {
       files <- private$metric_files_
-      if (!length(files) || !any(file.exists(files))) {
+      files_win_path <- sapply(private$metric_files_, wsl_safe_path, revert = TRUE)
+      if (!length(files) || !any(file.exists(files_win_path))) {
         stop(
           ""No metric files found. "",
           ""Set 'save_metric=TRUE' when fitting the model."",

---FILE: tests/testthat/test-model-output_dir.R---
@@ -33,18 +33,24 @@ test_that(""all fitting methods work with output_dir"", {
     # from the original tempdir(), so need to normalise both for comparison
     expect_equal(normalizePath(fit$runset$args$output_dir),
                  normalizePath(method_dir))
-    files <- list.files(method_dir, full.names = TRUE)
+    files <- normalizePath(list.files(method_dir, full.names = TRUE))
     # in 2.34.0 we also save the config files for all methods and the metric
     # for sample
     if (cmdstan_version() < ""2.34.0"") {
       mult <- 1
     } else if (method == ""sample"") {
       mult <- 3
-      expect_equal(repair_path(files[grepl(""metric"", files)]), fit$metric_files())
-      expect_equal(repair_path(files[grepl(""config"", files)]), fit$config_files())
+      expect_equal(files[grepl(""metric"", files)],
+                   normalizePath(sapply(fit$metric_files(), wsl_safe_path, revert = TRUE,
+                                        USE.NAMES = FALSE)))
+      expect_equal(files[grepl(""config"", files)],
+                   normalizePath(sapply(fit$config_files(), wsl_safe_path, revert = TRUE,
+                                        USE.NAMES = FALSE)))
     } else {
       mult <- 2
-      expect_equal(repair_path(files[grepl(""config"", files)]), fit$config_files())
+      expect_equal(files[grepl(""config"", files)],
+                   normalizePath(sapply(fit$config_files(), wsl_safe_path, revert = TRUE,
+                                        USE.NAMES = FALSE)))
     }
     expect_equal(length(list.files(method_dir)), mult * fit$num_procs())
 ",True,False,Implementation / Logic,6
stan-dev,cmdstanr,2647de60df592384b328c803f5ea10a75bba272e,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-04-18T19:00:11Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-04-18T19:00:11Z,Fix WSL rtools mismatch,.github/workflows/R-CMD-check-wsl.yaml,False,False,False,False,0,3,3,"---FILE: .github/workflows/R-CMD-check-wsl.yaml---
@@ -38,9 +38,6 @@ jobs:
       - uses: actions/checkout@v4
 
       - uses: r-lib/actions/setup-r@v2.8.7
-        with:
-          r-version: 'release'
-          rtools-version: '42'
       - uses: r-lib/actions/setup-pandoc@v2.8.7
 
       - name: Query dependencies",False,False,Rendering / Conversion,3
stan-dev,cmdstanr,4dff908b0b9fd5ce202a0258adc4d366f15060b9,jgabry,jgabry@gmail.com,2024-04-17T20:23:48Z,jgabry,jgabry@gmail.com,2024-04-17T20:23:48Z,fix bad doc link,R/options.R;man/cmdstanr_global_options.Rd,False,True,True,False,2,2,4,"---FILE: R/options.R---
@@ -13,7 +13,7 @@
 #'
 #' * `cmdstanr_force_recompile`: Should the default be to recompile models
 #' even if there were no Stan code changes since last compiled?  See
-#' [compile][fit-method-compile] for more details. The default is `FALSE`.
+#' [compile][model-method-compile] for more details. The default is `FALSE`.
 #'
 #' * `cmdstanr_max_rows`: The maximum number of rows of output to print when
 #' using the [`$print()`][fit-method-summary] method. The default is 10.

---FILE: man/cmdstanr_global_options.Rd---
@@ -14,7 +14,7 @@ draws? The default depends on the model fitting method. See
 \link[=fit-method-draws]{draws} for more details.
 \item \code{cmdstanr_force_recompile}: Should the default be to recompile models
 even if there were no Stan code changes since last compiled?  See
-\link[=fit-method-compile]{compile} for more details. The default is \code{FALSE}.
+\link[=model-method-compile]{compile} for more details. The default is \code{FALSE}.
 \item \code{cmdstanr_max_rows}: The maximum number of rows of output to print when
 using the \code{\link[=fit-method-summary]{$print()}} method. The default is 10.
 \item \code{cmdstanr_no_ver_check}: Should the check for a more recent version of",True,False,Documentation / Formatting,7
stan-dev,cmdstanr,1a07f461361fc938dd805051119d30698e5be73e,jgabry,jgabry@gmail.com,2024-04-17T18:21:10Z,jgabry,jgabry@gmail.com,2024-04-17T18:21:10Z,"Update error message when using rvar draws format

closes #582",R/utils.R,False,True,True,False,3,2,5,"---FILE: R/utils.R---
@@ -396,8 +396,9 @@ assert_valid_draws_format <- function(format) {
     }
     if (format %in% c(""rvars"", ""draws_rvars"")) {
       stop(
-        ""\nWe are fixing a bug in fit$draws(format = 'draws_rvars')."",
-        ""\nFor now please use posterior::as_draws_rvars(fit$draws()) instead.""
+        ""\nTo use the rvar format please convert after extracting the draws, "",
+        ""e.g., posterior::as_draws_rvars(fit$draws())."",
+        call. = FALSE
       )
     }
   }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,67f029a7910330d52c3a2b2f5d6d72da9e4ccbbf,jgabry,jgabry@gmail.com,2024-04-15T20:22:58Z,jgabry,jgabry@gmail.com,2024-04-15T20:22:58Z,try to fix r cmd check warning about s3 methods,R/args.R,False,True,True,False,21,12,33,"---FILE: R/args.R---
@@ -1027,15 +1027,15 @@ validate_exe_file <- function(exe_file) {
 
 #' Generic for processing inits
 #' @noRd
-process_init <- function(...) {
+process_init <- function(init, ...) {
   UseMethod(""process_init"")
 }
 
 #' Default method
 #' @noRd
 #' @export
-process_init.default <- function(x, ...) {
-  return(x)
+process_init.default <- function(init, ...) {
+  return(init)
 }
 
 #' Write initial values to files if provided as posterior `draws` object
@@ -1050,7 +1050,8 @@ process_init.default <- function(x, ...) {
 #' @return A character vector of file paths.
 #' @export
 process_init.draws <- function(init, num_procs, model_variables = NULL,
-                               warn_partial = getOption(""cmdstanr_warn_inits"", TRUE)) {
+                               warn_partial = getOption(""cmdstanr_warn_inits"", TRUE),
+                               ...) {
   if (!is.null(model_variables)) {
     variable_names = names(model_variables$parameters)
   } else {
@@ -1111,7 +1112,8 @@ process_init.draws <- function(init, num_procs, model_variables = NULL,
 #' @return A character vector of file paths.
 #' @export
 process_init.list <- function(init, num_procs, model_variables = NULL,
-                              warn_partial = getOption(""cmdstanr_warn_inits"", TRUE)) {
+                              warn_partial = getOption(""cmdstanr_warn_inits"", TRUE),
+                              ...) {
   if (!all(sapply(init, function(x) is.list(x) && !is.data.frame(x)))) {
     stop(""If 'init' is a list it must be a list of lists."", call. = FALSE)
   }
@@ -1185,7 +1187,8 @@ process_init.list <- function(init, num_procs, model_variables = NULL,
 #' @return A character vector of file paths.
 #' @export
 process_init.function <- function(init, num_procs, model_variables = NULL,
-                                  warn_partial = getOption(""cmdstanr_warn_inits"", TRUE)) {
+                                  warn_partial = getOption(""cmdstanr_warn_inits"", TRUE),
+                                  ...) {
   args <- formals(init)
   if (is.null(args)) {
     fn_test <- init()
@@ -1227,7 +1230,8 @@ validate_fit_init = function(init, model_variables) {
 #' @return A character vector of file paths.
 #' @export
 process_init.CmdStanMCMC <- function(init, num_procs, model_variables = NULL,
-                                     warn_partial = getOption(""cmdstanr_warn_inits"", TRUE)) {
+                                     warn_partial = getOption(""cmdstanr_warn_inits"", TRUE),
+                                     ...) {
   validate_fit_init(init, model_variables)
   draws_df = init$draws(format = ""df"")
   if (is.null(model_variables)) {
@@ -1252,7 +1256,8 @@ process_init.CmdStanMCMC <- function(init, num_procs, model_variables = NULL,
 #' @return A character vector of file paths.
 #' @importFrom stats aggregate
 process_init_approx <- function(init, num_procs, model_variables = NULL,
-                                warn_partial = getOption(""cmdstanr_warn_inits"", TRUE)) {
+                                warn_partial = getOption(""cmdstanr_warn_inits"", TRUE),
+                                ...) {
   validate_fit_init(init, model_variables)
   # Convert from data.table to data.frame
   draws_df = init$draws(format = ""df"")
@@ -1301,7 +1306,8 @@ process_init_approx <- function(init, num_procs, model_variables = NULL,
 #' @return A character vector of file paths.
 #' @export
 process_init.CmdStanPathfinder <- function(init, num_procs, model_variables = NULL,
-                                           warn_partial = getOption(""cmdstanr_warn_inits"", TRUE)) {
+                                           warn_partial = getOption(""cmdstanr_warn_inits"", TRUE),
+                                           ...) {
   process_init_approx(init, num_procs, model_variables, warn_partial)
 }
 
@@ -1317,7 +1323,8 @@ process_init.CmdStanPathfinder <- function(init, num_procs, model_variables = NU
 #' @return A character vector of file paths.
 #' @export
 process_init.CmdStanVB <- function(init, num_procs, model_variables = NULL,
-                                   warn_partial = getOption(""cmdstanr_warn_inits"", TRUE)) {
+                                   warn_partial = getOption(""cmdstanr_warn_inits"", TRUE),
+                                   ...) {
   process_init_approx(init, num_procs, model_variables, warn_partial)
 }
 
@@ -1333,7 +1340,8 @@ process_init.CmdStanVB <- function(init, num_procs, model_variables = NULL,
 #' @return A character vector of file paths.
 #' @export
 process_init.CmdStanLaplace <- function(init, num_procs, model_variables = NULL,
-                                        warn_partial = getOption(""cmdstanr_warn_inits"", TRUE)) {
+                                        warn_partial = getOption(""cmdstanr_warn_inits"", TRUE),
+                                        ...) {
   process_init_approx(init, num_procs, model_variables, warn_partial)
 }
 
@@ -1350,7 +1358,8 @@ process_init.CmdStanLaplace <- function(init, num_procs, model_variables = NULL,
 #' @return A character vector of file paths.
 #' @export
 process_init.CmdStanMLE <- function(init, num_procs, model_variables = NULL,
-                                    warn_partial = getOption(""cmdstanr_warn_inits"", TRUE)) {
+                                    warn_partial = getOption(""cmdstanr_warn_inits"", TRUE),
+                                    ...) {
   # Convert from data.table to data.frame
   validate_fit_init(init, model_variables)
   draws_df = init$draws(format = ""df"")",True,False,Implementation / Logic,6
stan-dev,cmdstanr,1197ad48a6a3500e7b8f1a736c12baa16dfe9e10,Steve Bronder,sbronder@flatironinstitute.org,2024-04-04T22:49:47Z,Steve Bronder,sbronder@flatironinstitute.org,2024-04-04T22:49:47Z,fix init test,tests/testthat/test-fit-init.R,False,True,True,False,6,4,10,"---FILE: tests/testthat/test-fit-init.R---
@@ -51,12 +51,14 @@ test_that(""Subsets of parameters are allowed"", {
 
 
 test_that(""Pathfinder method works as init"", {
-  utils::capture.output(fit_path_init <- mod_params$pathfinder(seed=1234,
+  utils::capture.output(fit_path_init <- mod_logistic$pathfinder(seed=1234, data = data_list_logistic,
                                                                refresh = 0, num_paths = 4))
-  expect_no_error(test_inits(mod_params, fit_path_init))
-  utils::capture.output(fit_path_init <- mod_params$pathfinder(seed=1234,
+  expect_no_error(test_inits(mod_logistic, fit_path_init,
+    data_list_logistic))
+  utils::capture.output(fit_path_init <- mod_logistic$pathfinder(seed=1234, data = data_list_logistic,
                                                                refresh = 0, num_paths = 1))
-  expect_no_error(test_inits(mod_params, fit_path_init))
+  expect_no_error(test_inits(mod_logistic, fit_path_init,
+    data_list_logistic))
 })
 
 test_that(""Laplace method works as init"", {",True,False,Implementation / Logic,3
stan-dev,cmdstanr,099a35265858a2aa6d92e7dd102d22c0eaf4a1ca,Aki Vehtari,Aki.Vehtari@aalto.fi,2024-03-28T17:13:35Z,Aki Vehtari,Aki.Vehtari@aalto.fi,2024-03-28T17:13:35Z,fix pareto_smooth call with explicit argument,R/args.R,False,True,True,False,1,1,2,"---FILE: R/args.R---
@@ -1241,7 +1241,7 @@ process_init_approx <- function(init, num_procs, model_variables = NULL,
     draws_df$pareto_weight = exp(draws_df$lw - max(draws_df$lw))
   } else {
     draws_df$pareto_weight = posterior::pareto_smooth(
-      exp(draws_df$lw - max(draws_df$lw)), tail = ""right"")[[""x""]]
+      exp(draws_df$lw - max(draws_df$lw)), tail = ""right"", return_k=FALSE)
   }
   init_draws_df = posterior::resample_draws(draws_df, ndraws = num_procs,
                                             weights = draws_df$pareto_weight, method = ""simple_no_replace"")",True,False,Implementation / Logic,6
stan-dev,cmdstanr,9a6aebcd0a422cb5ae86966880f9c70b4aa76616,dependabot[bot],49699333+dependabot[bot]@users.noreply.github.com,2024-03-25T18:22:13Z,GitHub,noreply@github.com,2024-03-25T18:22:13Z,"Bump r-lib/actions from 2.8.2 to 2.8.4

Bumps [r-lib/actions](https://github.com/r-lib/actions) from 2.8.2 to 2.8.4.
- [Release notes](https://github.com/r-lib/actions/releases)
- [Commits](https://github.com/r-lib/actions/compare/v2.8.2...v2.8.4)

---
updated-dependencies:
- dependency-name: r-lib/actions
  dependency-type: direct:production
  update-type: version-update:semver-patch
...

Signed-off-by: dependabot[bot] <support@github.com>",.github/workflows/R-CMD-check-wsl.yaml;.github/workflows/R-CMD-check.yaml;.github/workflows/Test-coverage.yaml;.github/workflows/cmdstan-tarball-check.yaml,False,False,False,False,10,10,20,"---FILE: .github/workflows/R-CMD-check-wsl.yaml---
@@ -37,11 +37,11 @@ jobs:
 
       - uses: actions/checkout@v4
 
-      - uses: r-lib/actions/setup-r@v2.8.2
+      - uses: r-lib/actions/setup-r@v2.8.4
         with:
           r-version: 'release'
           rtools-version: '42'
-      - uses: r-lib/actions/setup-pandoc@v2.8.2
+      - uses: r-lib/actions/setup-pandoc@v2.8.4
 
       - name: Query dependencies
         run: |

---FILE: .github/workflows/R-CMD-check.yaml---
@@ -57,11 +57,11 @@ jobs:
           sudo apt-get install -y libcurl4-openssl-dev || true
           sudo apt-get install -y openmpi-bin openmpi-common libopenmpi-dev || true
 
-      - uses: r-lib/actions/setup-r@v2.8.2
+      - uses: r-lib/actions/setup-r@v2.8.4
         with:
           r-version: ${{ matrix.config.r }}
           rtools-version: ${{ matrix.config.rtools }}
-      - uses: r-lib/actions/setup-pandoc@v2.8.2
+      - uses: r-lib/actions/setup-pandoc@v2.8.4
 
       - name: Query dependencies
         run: |

---FILE: .github/workflows/Test-coverage.yaml---
@@ -34,8 +34,8 @@ jobs:
         if: ""!startsWith(github.ref, 'refs/tags/') && github.ref != 'refs/heads/master'""
       - uses: actions/checkout@v4
 
-      - uses: r-lib/actions/setup-r@v2.8.2
-      - uses: r-lib/actions/setup-pandoc@v2.8.2
+      - uses: r-lib/actions/setup-r@v2.8.4
+      - uses: r-lib/actions/setup-pandoc@v2.8.4
 
       - name: Install Ubuntu dependencies
         run: |
@@ -85,12 +85,12 @@ jobs:
     steps:
       - uses: actions/checkout@v4
 
-      - uses: r-lib/actions/setup-r@v2.8.2
+      - uses: r-lib/actions/setup-r@v2.8.4
         with:
           r-version: 'release'
           rtools-version: '42'
 
-      - uses: r-lib/actions/setup-pandoc@v2.8.2
+      - uses: r-lib/actions/setup-pandoc@v2.8.4
 
       - name: Query dependencies
         run: |

---FILE: .github/workflows/cmdstan-tarball-check.yaml---
@@ -40,12 +40,12 @@ jobs:
           sudo apt-get install -y libcurl4-openssl-dev || true
           sudo apt-get install -y openmpi-bin openmpi-common libopenmpi-dev || true
 
-      - uses: r-lib/actions/setup-r@v2.8.2
+      - uses: r-lib/actions/setup-r@v2.8.4
         with:
           r-version: ${{ matrix.config.r }}
           rtools-version: ${{ matrix.config.rtools }}
 
-      - uses: r-lib/actions/setup-pandoc@v2.8.2
+      - uses: r-lib/actions/setup-pandoc@v2.8.4
 
       - name: Query dependencies
         run: |",False,False,Rendering / Conversion,3
stan-dev,cmdstanr,695dba60aae1b0f56586262eb39ef8f778816b5f,Ven Popov,vencislav.popov@gmail.com,2024-03-21T13:13:42Z,Ven Popov,vencislav.popov@gmail.com,2024-03-21T13:13:42Z,fix check for adapt_engaged,R/args.R,False,True,True,False,4,3,7,"---FILE: R/args.R---
@@ -286,9 +286,6 @@ SampleArgs <- R6::R6Class(
       if (is.logical(self$save_metric)) {
         self$save_metric <- as.integer(self$save_metric)
       }
-      if (!self$adapt_engaged & !is.null(self$save_metric)) {
-        self$save_metric <- 0
-      }
       invisible(self)
     },
     validate = function(num_procs) {
@@ -817,6 +814,10 @@ validate_sample_args <- function(self, num_procs) {
                                len = 1,
                                null.ok = TRUE)
 
+  if (is.null(self$adapt_engaged) || (!self$adapt_engaged && !is.null(self$save_metric))) {
+    self$save_metric <- 0
+  }
+
   invisible(TRUE)
 }
 ",True,False,Implementation / Logic,6
stan-dev,cmdstanr,daa111d9c4f664dc0de966a254b719eb26c2baac,Ven Popov,vencislav.popov@gmail.com,2024-03-19T15:20:15Z,Ven Popov,vencislav.popov@gmail.com,2024-03-19T15:20:15Z,fix empty matrix inv_metric with 1 parameter,R/args.R;R/fit.R;tests/testthat/test-model-sample-metric.R,False,True,True,False,42,4,46,"---FILE: R/args.R---
@@ -254,7 +254,7 @@ SampleArgs <- R6::R6Class(
             fileext = "".json""
           )
         for (i in seq_along(inv_metric_paths)) {
-          if (length(inv_metric[[i]] == 1) && metric == ""diag_e"") {
+          if (length(inv_metric[[i]]) == 1 && metric == ""diag_e"") {
             inv_metric[[i]] <- array(inv_metric[[i]], dim = c(1))
           }
           write_stan_json(list(inv_metric = inv_metric[[i]]), inv_metric_paths[i])

---FILE: R/fit.R---
@@ -1742,9 +1742,9 @@ inv_metric <- function(matrix = TRUE) {
   out <- private$inv_metric_
   if (matrix && !is.matrix(out[[1]])) {
     # convert each vector to a diagonal matrix
-    out <- lapply(out, diag)
+    out <- lapply(out, function(x) diag(x, nrow = length(x)))
   } else if (length(out[[1]]) == 1) {
-    # convert each scalar to a 1x1 matrix
+    # convert each scalar to an array with dimension 1
     out <- lapply(out, array, dim = c(1))
   }
   out

---FILE: tests/testthat/test-model-sample-metric.R---
@@ -4,6 +4,9 @@ set_cmdstan_path()
 mod <- testing_model(""bernoulli"")
 data_list <- testing_data(""bernoulli"")
 
+mod2 <- testing_model(""logistic"")
+data_list2 <- testing_data(""logistic"")
+
 
 test_that(""sample() method works with provided inv_metrics"", {
   inv_metric_vector <- array(1, dim = c(1))
@@ -54,7 +57,7 @@ test_that(""sample() method works with provided inv_metrics"", {
 })
 
 
-test_that(""sample() method works with inv_metrics extracted from previous fit"", {
+test_that(""sample() method works with inv_metrics extracted from previous fit with 1 parameter"", {
   expect_sample_output(fit_r <- mod$sample(data = data_list,
                                            chains = 2,
                                            seed = 123))
@@ -89,6 +92,41 @@ test_that(""sample() method works with inv_metrics extracted from previous fit"",
                                            seed = 123)))
 })
 
+test_that(""sample() method works with inv_metrics extracted from previous fit with > 1 parameter"", {
+  expect_sample_output(fit_r <- mod2$sample(data = data_list2,
+                                            chains = 2,
+                                            seed = 123))
+  inv_metric_vector <- fit_r$inv_metric(matrix = FALSE)
+  inv_metric_matrix <- fit_r$inv_metric()
+
+  expect_equal(length(inv_metric_vector[[1]]), 4)
+  expect_equal(dim(inv_metric_matrix[[1]]), c(4, 4))
+
+  expect_silent(expect_sample_output(fit_r <- mod2$sample(data = data_list2,
+                                                         chains = 1,
+                                                         metric = ""diag_e"",
+                                                         inv_metric = inv_metric_vector[[1]],
+                                                         seed = 123)))
+
+  expect_silent(expect_sample_output(fit_r <- mod2$sample(data = data_list2,
+                                                         chains = 1,
+                                                         metric = ""dense_e"",
+                                                         inv_metric = inv_metric_matrix[[1]],
+                                                         seed = 123)))
+
+  expect_silent(expect_sample_output(fit_r <- mod2$sample(data = data_list2,
+                                                         chains = 2,
+                                                         metric = ""diag_e"",
+                                                         inv_metric = inv_metric_vector,
+                                                         seed = 123)))
+
+  expect_silent(expect_sample_output(fit_r <- mod2$sample(data = data_list2,
+                                                         chains = 2,
+                                                         metric = ""dense_e"",
+                                                         inv_metric = inv_metric_matrix,
+                                                         seed = 123)))
+})
+
 
 test_that(""sample() method works with lists of inv_metrics"", {
   inv_metric_vector <- array(1, dim = c(1))",True,False,Implementation / Logic,6
stan-dev,cmdstanr,69135f4d0f3e70484946794e57456727f71f2106,Ven Popov,vencislav.popov@gmail.com,2024-03-19T14:48:35Z,Ven Popov,vencislav.popov@gmail.com,2024-03-19T14:48:35Z,fix case with matrix=FALSE and 1 parameter,R/args.R;R/fit.R,False,True,True,False,6,0,6,"---FILE: R/args.R---
@@ -254,6 +254,9 @@ SampleArgs <- R6::R6Class(
             fileext = "".json""
           )
         for (i in seq_along(inv_metric_paths)) {
+          if (length(inv_metric[[i]] == 1) && metric == ""diag_e"") {
+            inv_metric[[i]] <- array(inv_metric[[i]], dim = c(1))
+          }
           write_stan_json(list(inv_metric = inv_metric[[i]]), inv_metric_paths[i])
         }
 

---FILE: R/fit.R---
@@ -1743,6 +1743,9 @@ inv_metric <- function(matrix = TRUE) {
   if (matrix && !is.matrix(out[[1]])) {
     # convert each vector to a diagonal matrix
     out <- lapply(out, diag)
+  } else if (length(out[[1]]) == 1) {
+    # convert each scalar to a 1x1 matrix
+    out <- lapply(out, array, dim = c(1))
   }
   out
 }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,ce557ad8ac68ad57f040040964248de83afcb6c0,Ven Popov,vencislav.popov@gmail.com,2024-03-19T14:26:55Z,Ven Popov,vencislav.popov@gmail.com,2024-03-19T14:26:55Z,add tests showing failure of inv_metric for 1 parameter,tests/testthat/test-model-sample-metric.R,False,True,True,False,36,0,36,"---FILE: tests/testthat/test-model-sample-metric.R---
@@ -54,6 +54,42 @@ test_that(""sample() method works with provided inv_metrics"", {
 })
 
 
+test_that(""sample() method works with inv_metrics extracted from previous fit"", {
+  expect_sample_output(fit_r <- mod$sample(data = data_list,
+                                           chains = 2,
+                                           seed = 123))
+  inv_metric_vector <- fit_r$inv_metric(matrix = FALSE)
+  inv_metric_matrix <- fit_r$inv_metric()
+
+  expect_equal(dim(inv_metric_vector[[1]]), 1)
+  expect_equal(dim(inv_metric_matrix[[1]]), c(1, 1))
+
+  expect_silent(expect_sample_output(fit_r <- mod$sample(data = data_list,
+                                           chains = 1,
+                                           metric = ""diag_e"",
+                                           inv_metric = inv_metric_vector[[1]],
+                                           seed = 123)))
+
+  expect_silent(expect_sample_output(fit_r <- mod$sample(data = data_list,
+                                           chains = 1,
+                                           metric = ""dense_e"",
+                                           inv_metric = inv_metric_matrix[[1]],
+                                           seed = 123)))
+
+  expect_silent(expect_sample_output(fit_r <- mod$sample(data = data_list,
+                                           chains = 2,
+                                           metric = ""diag_e"",
+                                           inv_metric = inv_metric_vector,
+                                           seed = 123)))
+
+  expect_silent(expect_sample_output(fit_r <- mod$sample(data = data_list,
+                                           chains = 2,
+                                           metric = ""dense_e"",
+                                           inv_metric = inv_metric_matrix,
+                                           seed = 123)))
+})
+
+
 test_that(""sample() method works with lists of inv_metrics"", {
   inv_metric_vector <- array(1, dim = c(1))
   inv_metric_vector_json <- test_path(""resources"", ""metric"", ""bernoulli.inv_metric.diag_e.json"")",True,False,Implementation / Logic,3
stan-dev,cmdstanr,513d09e1aa7dd0c1847e4ef0ba98e30003169295,Ven Popov,vencislav.popov@gmail.com,2024-03-17T10:41:47Z,Ven Popov,vencislav.popov@gmail.com,2024-03-17T10:41:47Z,fix failing test when adapt_engaged=FALSE,R/args.R,False,True,True,False,3,0,3,"---FILE: R/args.R---
@@ -286,6 +286,9 @@ SampleArgs <- R6::R6Class(
       if (is.logical(self$save_metric)) {
         self$save_metric <- as.integer(self$save_metric)
       }
+      if (!self$adapt_engaged & !is.null(self$save_metric)) {
+        self$save_metric <- 0
+      }
       invisible(self)
     },
     validate = function(num_procs) {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,c6df0afd748296f5c4a5c9517c209fac0d586cb1,Ven Popov,vencislav.popov@gmail.com,2024-03-17T10:39:00Z,Ven Popov,vencislav.popov@gmail.com,2024-03-17T10:39:15Z,"add test showing failed run with adapt_engaged=FALSE

- turns out cmdstan gives an error if adapt_engaged=FALSE and save_metric=TRUE",tests/testthat/test-model-sample.R,False,True,True,False,6,0,6,"---FILE: tests/testthat/test-model-sample.R---
@@ -212,6 +212,12 @@ test_that(""sample() method runs when fixed_param = TRUE"", {
   expect_equal(fit_500_w$metadata()$algorithm, ""fixed_param"")
 })
 
+test_that(""sample() method runs when adapt_engaged = FALSE"", {
+  expect_sample_output(fit <- mod$sample(data = data_list, chains = 1, adapt_engaged = FALSE), 1)
+  draws <- try(fit$draws(), silent = TRUE)
+  expect_false(inherits(draws, ""try-error""))
+})
+
 test_that(""chain_ids work with sample()"", {
   mod$compile()
   expect_sample_output(fit12 <- mod$sample(data = data_list, chains = 2, chain_ids = c(10,12)))",True,False,Rendering / Conversion,3
stan-dev,cmdstanr,63a29c51596407b298b5f1ec8a81ba2e3adc0ec7,jgabry,jgabry@gmail.com,2024-01-25T20:48:52Z,jgabry,jgabry@gmail.com,2024-01-25T20:48:52Z,fix typo in readme,README.md,False,False,False,False,1,1,2,"---FILE: README.md---
@@ -37,7 +37,7 @@ analysis.
 You can install the latest beta release of the **cmdstanr** R package with
 
 ```r
-# we recommend running this is a fresh R session or restarting your current session
+# we recommend running this in a fresh R session or restarting your current session
 install.packages(""cmdstanr"", repos = c(""https://mc-stan.org/r-packages/"", getOption(""repos"")))
 ```
 This does not install the vignettes, which take a long time to build, but they are always available",False,False,Documentation / Formatting,7
stan-dev,cmdstanr,da5b4f6b614598eab7821cea9bef5e57696171e1,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-01-24T07:57:39Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-01-24T07:57:39Z,Fix tests with v2.34.1,tests/testthat/test-model-optimize.R,False,True,True,False,6,8,14,"---FILE: tests/testthat/test-model-optimize.R---
@@ -117,9 +117,9 @@ test_that(""optimize() works with (L-)BFGS tolerances specified"", {
       # using values that aren't the defaults
       init_alpha = 0.002,
       tol_obj = 2e-11,
-      tol_rel_obj = 10001,
+      tol_rel_obj = 1000,
       tol_grad = 5e-07,
-      tol_rel_grad = 10000001,
+      tol_rel_grad = 1000000,
       tol_param = 5e-07,
       history_size = 6,
       seed = 123
@@ -128,12 +128,10 @@ test_that(""optimize() works with (L-)BFGS tolerances specified"", {
   metadata <- fit$metadata()
   expect_equal(metadata$init_alpha, 0.002)
   expect_equal(metadata$tol_obj, 2e-11)
-  expect_equal(metadata$tol_rel_obj, 10001)
-  # https://github.com/stan-dev/cmdstan/issues/1242
-  # expect_equal(metadata$tol_grad, 5e-07)
-  expect_equal(metadata$tol_rel_grad, 10000001)
-  # https://github.com/stan-dev/cmdstan/issues/1242
-  # expect_equal(metadata$tol_param, 5e-07)
+  expect_equal(metadata$tol_rel_obj, 1000)
+  expect_equal(metadata$tol_grad, 5e-07)
+  expect_equal(metadata$tol_rel_grad, 1000000)
+  expect_equal(metadata$tol_param, 5e-07)
   expect_equal(metadata$history_size, 6)
 })
 ",True,False,Implementation / Logic,3
stan-dev,cmdstanr,03b5cbbfa23c1819fbe9a5270f9a5c151c595e84,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-01-21T22:07:26Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-01-21T22:07:26Z,Fix reading on WSL,R/utils.R,False,True,True,False,1,1,2,"---FILE: R/utils.R---
@@ -811,7 +811,7 @@ get_standalone_hpp <- function(stan_file, stancflags) {
       ),
       wsl_compatible_run(
         command = stanc_cmd(),
-        args = c(paste0(""--o="", hpp_path), stancflags, stan_file),
+        args = c(paste0(""--o="", wsl_safe_path(hpp_path)), stancflags, wsl_safe_path(stan_file)),
         wd = cmdstan_path(),
         error_on_status = FALSE
       )",True,False,Implementation / Logic,3
stan-dev,cmdstanr,65cc7801c74d075f8448c8903b292e7179a9613f,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-01-21T20:35:38Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-01-21T20:35:38Z,More fixes,R/model.R;tests/testthat/test-install.R;tests/testthat/test-model-compile.R,False,True,True,False,3,12,15,"---FILE: R/model.R---
@@ -716,7 +716,8 @@ compile <- function(quiet = TRUE,
       )
     }
 
-    writeLines(private$model_methods_env_$hpp_code_, private$hpp_file_)
+    writeLines(private$model_methods_env_$hpp_code_,
+               con = wsl_safe_path(private$hpp_file_, revert = TRUE))
   } # End - if(!dry_run)
 
   private$exe_file_ <- exe

---FILE: tests/testthat/test-install.R---
@@ -16,7 +16,7 @@ test_that(""install_cmdstan() successfully installs cmdstan"", {
       install_cmdstan(dir = dir, cores = 2, quiet = FALSE, overwrite = TRUE,
                       release_url = cmdstan_test_tarball_url,
                       wsl = os_is_wsl()),
-      ""Compiling, linking C++ code"",
+      ""Compiling C++ code"",
       fixed = TRUE
     ),
     ""CmdStan path set"",

---FILE: tests/testthat/test-model-compile.R---
@@ -174,15 +174,6 @@ test_that(""compile errors are shown"", {
   )
 })
 
-test_that(""compile suggests using format to fix old syntax"", {
-  stan_file <- testing_stan_file(""old_array_syntax"")
-  expect_error(
-    cmdstan_model(stan_file),
-    ""To fix deprecated or removed syntax please see ?cmdstanr::format for an example."",
-    fixed = TRUE
-  )
-})
-
 test_that(""dir arg works for cmdstan_model and $compile()"", {
   tmp_dir <- tempdir()
   tmp_dir_2 <- tempdir()
@@ -858,4 +849,3 @@ test_that(""STANCFLAGS included from make/local"", {
   expect_output(print(out), out_w_flags)
   cmdstan_make_local(cpp_options = make_local_old, append = FALSE)
 })
-",True,False,Implementation / Logic,6
stan-dev,cmdstanr,006a7f273bc5b65519372c96a6b7745cf67b2eee,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-01-21T14:58:45Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-01-21T14:58:45Z,Fix test failures under cmdstan 2.34,R/model.R;tests/testthat/test-model-compile.R;tests/testthat/test-model-laplace.R;tests/testthat/test-model-optimize.R,False,True,True,False,9,13,22,"---FILE: R/model.R---
@@ -715,6 +715,8 @@ compile <- function(quiet = TRUE,
         error_on_status = FALSE
       )
     }
+
+    writeLines(private$model_methods_env_$hpp_code_, private$hpp_file_)
   } # End - if(!dry_run)
 
   private$exe_file_ <- exe

---FILE: tests/testthat/test-model-compile.R---
@@ -689,16 +689,6 @@ test_that(""format() works"", {
     fixed = TRUE
   )
 
-  expect_output(
-    mod_1$format(canonicalize = TRUE),
-    ""target += normal_lpdf(y | 0, 1);"",
-    fixed = TRUE
-  )
-  expect_output(
-    mod_1$format(canonicalize = list(""deprecations"")),
-    ""target += normal_lpdf(y | 0, 1);"",
-    fixed = TRUE
-  )
   expect_error(
     mod_1$format(),
     ""Syntax error found! See the message above for more information."",

---FILE: tests/testthat/test-model-laplace.R---
@@ -54,7 +54,9 @@ test_that(""laplace() runs when all arguments specified validly"", {
   expect_equal(fit1$metadata()$draws, as.integer(ok_arg_values$draws))
   expect_equal(fit1$mode()$metadata()$jacobian, as.integer(ok_arg_values$jacobian))
   expect_equal(fit1$mode()$metadata()$init_alpha, ok_arg_values$opt_args$init_alpha)
-  expect_equal(fit1$mode()$metadata()$tol_obj, ok_arg_values$opt_args$tol_obj, tolerance = 0)
+  
+  # https://github.com/stan-dev/cmdstan/issues/1242
+  #expect_equal(fit1$mode()$metadata()$tol_obj, ok_arg_values$opt_args$tol_obj, tolerance = 0)
 
   # leaving all at default (except 'data')
   expect_laplace_output(fit2 <- mod$laplace(data = data_list, seed = 123))

---FILE: tests/testthat/test-model-optimize.R---
@@ -129,9 +129,11 @@ test_that(""optimize() works with (L-)BFGS tolerances specified"", {
   expect_equal(metadata$init_alpha, 0.002)
   expect_equal(metadata$tol_obj, 2e-11)
   expect_equal(metadata$tol_rel_obj, 10001)
-  expect_equal(metadata$tol_grad, 5e-07)
+  # https://github.com/stan-dev/cmdstan/issues/1242
+  # expect_equal(metadata$tol_grad, 5e-07)
   expect_equal(metadata$tol_rel_grad, 10000001)
-  expect_equal(metadata$tol_param, 5e-07)
+  # https://github.com/stan-dev/cmdstan/issues/1242
+  # expect_equal(metadata$tol_param, 5e-07)
   expect_equal(metadata$history_size, 6)
 })
 ",True,False,Rendering / Conversion,3
stan-dev,cmdstanr,b33dd0294f459b303d9d9776ce2da62e2a4c73f1,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-01-14T20:11:56Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-01-14T20:11:56Z,Fix handling of 1-row matrices,inst/include/rcpp_eigen_interop.hpp,False,False,False,False,1,1,2,"---FILE: inst/include/rcpp_eigen_interop.hpp---
@@ -46,7 +46,7 @@ namespace Rcpp {
     SEXP eigen_wrap(const T& x) {
       const static int RTYPE = Rcpp::traits::r_sexptype_traits<stan::scalar_type_t<T>>::rtype;
       Rcpp::Vector<RTYPE> vec_rtn(Rcpp::wrap(stan::math::to_array_1d(x)));
-      if (x.cols() > 1) {
+      if (!stan::is_eigen_col_vector<T>::value) {
         vec_rtn.attr(""dim"") = Rcpp::Dimension(x.rows(), x.cols());
       }
       return vec_rtn;",False,False,Dependency / Package,3
stan-dev,cmdstanr,2c8b1bfcf6cb33c9974721018f966b3be6f52081,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-01-14T18:57:03Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2024-01-14T18:57:03Z,Fix test failures,R/utils.R;inst/include/rcpp_eigen_interop.hpp,False,True,True,False,28,14,42,"---FILE: R/utils.R---
@@ -928,7 +928,7 @@ compile_functions <- function(env, verbose = FALSE, global = FALSE) {
   mod_stan_funs <- paste(c(
     env$hpp_code[1:(funs[1] - 1)],
     ""#include <rcpp_tuple_interop.hpp>"",
-    ""#include <rcpp_eigen_interop.h>"",
+    ""#include <rcpp_eigen_interop.hpp>"",
     stan_funs),
   collapse = ""\n"")
   if (global) {

---FILE: inst/include/rcpp_eigen_interop.hpp---
@@ -8,20 +8,33 @@ namespace Rcpp {
   namespace traits {
     template <typename T, int R, int C>
     class Exporter<Eigen::Matrix<T, R, C>> {
-      private:
-        Rcpp::NumericVector vec_x;
-      public:
-        Exporter(SEXP x) : vec_x(x) { }
-        Eigen::Matrix<T, R, C> get() {
-          if (R == 1) {
-            return Eigen::Map<Eigen::RowVectorXd>(vec_x.begin(), vec_x.size());
-          } else if (C == 1) {
-            return Eigen::Map<Eigen::VectorXd>(vec_x.begin(), vec_x.size());
-          } else {
-            Rcpp::Dimension vec_dims(vec_x.attr(""dim""));
-            return Eigen::Map<Eigen::Matrix<T, R, C>>(vec_x.begin(), vec_dims[0], vec_dims[1]);
+    private:
+        SEXP object;
+    public:
+      Exporter(SEXP x) : object(x){}
+      ~Exporter(){}
+
+      Eigen::Matrix<T, R, C> get() {
+        if (R == 1) {
+          Eigen::Matrix<T, 1, C> result(::Rf_length(object));
+          ::Rcpp::internal::export_indexing<Eigen::Matrix<T, 1, C>, T>(object, result);
+          return result ;
+        } else if (C == 1) {
+          Eigen::Matrix<T, R, 1> result(::Rf_length(object));
+          ::Rcpp::internal::export_indexing<Eigen::Matrix<T, R, 1>, T>(object, result);
+          return result ;
+        } else {
+          Shield<SEXP> dims( ::Rf_getAttrib( object, R_DimSymbol ) );
+          if( Rf_isNull(dims) || ::Rf_length(dims) != 2 ){
+              throw ::Rcpp::not_a_matrix();
           }
+          int* dims_ = INTEGER(dims);
+          Eigen::Matrix<T, R, C> result(dims_[0],dims_[1]);
+          T* result_data = result.data();
+          ::Rcpp::internal::export_indexing<T*, T>( object, result_data);
+          return result ;
         }
+      }
     };
   } // traits
 
@@ -30,7 +43,8 @@ namespace Rcpp {
   namespace RcppEigen {
     template <typename T>
     SEXP eigen_wrap(const T& x) {
-      Rcpp::NumericVector vec_rtn(Rcpp::wrap(stan::math::to_array_1d(x)));
+      const static int RTYPE = ::Rcpp::traits::r_sexptype_traits<stan::scalar_type_t<T>>::rtype;
+      Rcpp::Vector<RTYPE> vec_rtn(Rcpp::wrap(stan::math::to_array_1d(x)));
       if (x.cols() > 1) {
         vec_rtn.attr(""dim"") = Rcpp::Dimension(x.rows(), x.cols());
       }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,6310b5ec237c578a1e4e70f55cf7c0a1d2f6d040,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-12-18T06:10:08Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-12-18T06:10:08Z,Fix R3.x compatibility,R/fit.R,False,True,True,False,2,2,4,"---FILE: R/fit.R---
@@ -597,10 +597,10 @@ unconstrain_draws <- function(files = NULL, draws = NULL, format = ""draws_df"") {
   skeleton <- self$variable_skeleton(transformed_parameters = FALSE,
                                      generated_quantities = FALSE)
   par_columns <- !(names(draws) %in% c("".chain"", "".iteration"", "".draw""))
-  unconstrained <- apply(draws, 1, function(draw) {
+  unconstrained <- lapply(asplit(draws, 1), function(draw) {
     par_list <- utils::relist(as.numeric(draw[par_columns]), skeleton)
     self$unconstrain_variables(variables = par_list)
-  }, simplify = FALSE)
+  })
 
   unconstrained <- do.call(rbind.data.frame, unconstrained)
   uncon_names <- private$model_methods_env_$unconstrained_param_names(private$model_methods_env_$model_ptr_, FALSE, FALSE)",True,False,Implementation / Logic,6
stan-dev,cmdstanr,65e8cac5c50e35921d801a56cc2678cafa8e0709,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-12-18T04:13:11Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-12-18T04:13:11Z,Fix loo test,R/fit.R,False,True,True,False,1,1,2,"---FILE: R/fit.R---
@@ -1545,7 +1545,7 @@ loo <- function(variables = ""log_lik"", r_eff = TRUE, moment_match = FALSE, ...)
       loo = loo_result,
       post_draws = function(x, ...) { x$draws(format = ""draws_matrix"") },
       log_lik_i = log_lik_i,
-      unconstrain_pars = function(x, pars, ...) { do.call(rbind, lapply(x$unconstrain_draws(), function(chain) { do.call(rbind, chain) })) },
+      unconstrain_pars = function(x, pars, ...) { x$unconstrain_draws(format = ""draws_matrix"") },
       log_prob_upars = function(x, upars, ...) { apply(upars, 1, x$log_prob) },
       log_lik_i_upars = log_lik_i_upars,
       ...",True,False,Implementation / Logic,3
stan-dev,cmdstanr,9769e8c1b20e6b22be1b1bea37ce83f4a90c3823,jgabry,jgabry@gmail.com,2023-12-13T18:03:06Z,jgabry,jgabry@gmail.com,2023-12-13T18:03:06Z,fix failing test,R/fit.R;man/fit-method-hessian.Rd;tests/testthat/test-model-methods.R,False,True,True,False,3,3,6,"---FILE: R/fit.R---
@@ -457,7 +457,7 @@ CmdStanFit$set(""public"", name = ""grad_log_prob"", value = grad_log_prob)
 #'   [unconstrain_variables()], [unconstrain_draws()], [variable_skeleton()],
 #'   [hessian()]
 #'
-hessian <- function(unconstrained_variables, jacobian = TRUE, jacobian_adjustment = TRUE) {
+hessian <- function(unconstrained_variables, jacobian = TRUE, jacobian_adjustment = NULL) {
   if (!is.null(jacobian_adjustment)) {
     warning(""'jacobian_adjustment' is deprecated. Please use 'jacobian' instead."", call. = FALSE)
     jacobian <- jacobian_adjustment

---FILE: man/fit-method-hessian.Rd---
@@ -6,7 +6,7 @@
 \title{Calculate the log-probability , the gradient w.r.t. each input, and the hessian
 for a given vector of unconstrained parameters}
 \usage{
-hessian(unconstrained_variables, jacobian = TRUE, jacobian_adjustment = TRUE)
+hessian(unconstrained_variables, jacobian = TRUE, jacobian_adjustment = NULL)
 }
 \arguments{
 \item{unconstrained_variables}{(numeric) A vector of unconstrained parameters.}

---FILE: tests/testthat/test-model-methods.R---
@@ -3,7 +3,7 @@ context(""model-methods"")
 set_cmdstan_path()
 mod <- cmdstan_model(testing_stan_file(""bernoulli_log_lik""), force_recompile = TRUE)
 data_list <- testing_data(""bernoulli"")
-fit <- mod$sample(data = data_list, chains = 1)
+fit <- mod$sample(data = data_list, chains = 1, refresh = 0)
 
 test_that(""Methods error if not compiled"", {
   skip_if(os_is_wsl())",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,b9f27280ac41ab909819c6e3c757f24bbe7e9e5f,jgabry,jgabry@gmail.com,2023-12-13T16:57:08Z,jgabry,jgabry@gmail.com,2023-12-13T16:57:08Z,try to fix a few R cmd check notes,DESCRIPTION;R/model.R;README.md;man/cmdstan_model.Rd,False,True,True,False,4,3,7,"---FILE: DESCRIPTION---
@@ -45,6 +45,7 @@ Imports:
     rlang (>= 0.4.7)
 Suggests:
     bayesplot,
+    ggplot2,
     knitr (>= 1.37),
     loo (>= 2.0.0),
     rmarkdown,

---FILE: R/model.R---
@@ -1,6 +1,6 @@
 #' Create a new CmdStanModel object
 #'
-#' @description \if{html}{\figure{logo.png}{options: width=""25px""}}
+#' @description \if{html}{\figure{logo.png}{options: width=25}}
 #'   Create a new [`CmdStanModel`] object from a file containing a Stan program
 #'   or from an existing Stan executable. The [`CmdStanModel`] object stores the
 #'   path to a Stan program and compiled executable (once created), and provides

---FILE: README.md---
@@ -27,7 +27,7 @@ releases.
 * Modularity: CmdStanR runs Stan's algorithms and lets downstream modules do the
 analysis.
 
-* Flexible [BSD-3 license](https://opensource.org/licenses/BSD-3-Clause).
+* Flexible [BSD-3 license](https://opensource.org/license/bsd-3-clause/).
 
 
 ### Installation

---FILE: man/cmdstan_model.Rd---
@@ -31,7 +31,7 @@ more. See \code{\link[=model-method-compile]{$compile()}} for details.}
 A \code{\link{CmdStanModel}} object.
 }
 \description{
-\if{html}{\figure{logo.png}{options: width=""25px""}}
+\if{html}{\figure{logo.png}{options: width=25}}
 Create a new \code{\link{CmdStanModel}} object from a file containing a Stan program
 or from an existing Stan executable. The \code{\link{CmdStanModel}} object stores the
 path to a Stan program and compiled executable (once created), and provides",True,False,Dependency / Package,7
stan-dev,cmdstanr,df893bbdc7d4450be80a4e763a115418bd0c27e3,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-11-29T10:07:35Z,GitHub,noreply@github.com,2023-11-29T10:07:35Z,Fix recursive test in WSL,tests/testthat/test-utils.R,False,True,True,False,2,2,4,"---FILE: tests/testthat/test-utils.R---
@@ -252,8 +252,8 @@ test_that(""as_mcmc.list() works"", {
 test_that(""get_cmdstan_flags() can be used recursively in `make`"", {
   mkfile <- normalizePath(test_path(""testdata"", ""Makefile""))
   nonrecursive_flags <- get_cmdstan_flags(""STANCFLAGS"")
-  stdo <- wsl_compatible_run(
-    command = ""make"", args = sprintf(""--file=%s"", mkfile), wd = cmdstan_path()
+  stdo <- processx::run(
+    command = ""make"", args = sprintf(""--file=%s"", mkfile)
   )$stdout
   recursive_flags <- readLines(textConnection(stdo))
   expect_equal(nonrecursive_flags, recursive_flags)",True,False,Implementation / Logic,3
stan-dev,cmdstanr,6df43d40fd58438db0928fb28aad3e600deef9e6,Carl A. B. Pearson,carl.pearson@lshtm.ac.uk,2023-11-23T13:57:50Z,Carl A. B. Pearson,carl.pearson@lshtm.ac.uk,2023-11-23T13:57:50Z,possibly the temporary file causes make error?,tests/testthat/test-utils.R;tests/testthat/testdata/Makefile,False,True,True,False,8,8,16,"---FILE: tests/testthat/test-utils.R---
@@ -250,14 +250,11 @@ test_that(""as_mcmc.list() works"", {
 })
 
 test_that(""get_cmdstan_flags() can be used recursively in `make`"", {
-  tmp <- withr::local_tempfile()
-  writeLines(
-    ""test:\n\t@Rscript --vanilla -e 'cat(cmdstanr:::get_cmdstan_flags(\""STANCFLAGS\""))'"",
-    tmp
-  )
+  mkfile <- normalizePath(test_path(""testdata"", ""Makefile""))
   nonrecursive_flags <- get_cmdstan_flags(""STANCFLAGS"")
-  recursive_flags <- readLines(textConnection(wsl_compatible_run(
-    command = ""make"", args = c(""-f"", tmp), wd = cmdstan_path()
-  )$stdout))
+  stdo <- wsl_compatible_run(
+    command = ""make"", args = sprintf(""--file=%s"", mkfile), wd = cmdstan_path()
+  )$stdout
+  recursive_flags <- readLines(textConnection(stdo))
   expect_equal(nonrecursive_flags, recursive_flags)
 })

---FILE: tests/testthat/testdata/Makefile---
@@ -0,0 +1,3 @@
+
+test:
+	@$(R_HOME)/bin/Rscript --vanilla -e 'cat(cmdstanr:::get_cmdstan_flags(""STANCFLAGS""))'",True,False,Environment / Configuration,3
stan-dev,cmdstanr,e8490655d5fc0f2021812526758c0541297459aa,Carl A. B. Pearson,carl.pearson@lshtm.ac.uk,2023-11-23T10:39:23Z,Carl A. B. Pearson,carl.pearson@lshtm.ac.uk,2023-11-23T10:39:23Z,fix? CI sandboxing issue by explicitly specifying working directory for processx,tests/testthat/test-utils.R,False,True,True,False,1,1,2,"---FILE: tests/testthat/test-utils.R---
@@ -257,7 +257,7 @@ test_that(""get_cmdstan_flags() can be used recursively in `make`"", {
   )
   nonrecursive_flags <- get_cmdstan_flags(""STANCFLAGS"")
   recursive_flags <- readLines(textConnection(wsl_compatible_run(
-    command = ""make"", args = c(""-f"", tmp)
+    command = ""make"", args = c(""-f"", tmp), wd = cmdstan_path()
   )$stdout))
   expect_equal(nonrecursive_flags, recursive_flags)
 })",True,False,Implementation / Logic,3
stan-dev,cmdstanr,57eb00eaf82dad2af8ab6e10ac7280b9f49e9a93,Carl A. B. Pearson,carl.pearson@lshtm.ac.uk,2023-11-21T10:57:28Z,Carl A. B. Pearson,carl.pearson@lshtm.ac.uk,2023-11-21T10:57:28Z,"fix: #770, get_cmdstan_flags('STANCFLAGS') in recursive make extraneous output",R/utils.R,False,True,True,False,1,1,2,"---FILE: R/utils.R---
@@ -678,7 +678,7 @@ get_cmdstan_flags <- function(flag_name) {
   cmdstan_path <- cmdstanr::cmdstan_path()
   flags <- wsl_compatible_run(
     command = ""make"",
-    args = c(paste0(""print-"", flag_name)),
+    args = c(""--no-print-directory"", paste0(""print-"", flag_name)),
     wd = cmdstan_path
   )$stdout
 ",True,False,Implementation / Logic,3
stan-dev,cmdstanr,3103deb5f7f9ea5aeef42e767353fb3bb39638ce,jgabry,jgabry@gmail.com,2023-11-08T20:07:12Z,jgabry,jgabry@gmail.com,2023-11-08T20:07:12Z,temporary fix for pkgdown rendering issue in posterior.Rmd vignette,docs/articles/posterior.html;vignettes/posterior.Rmd,True,False,True,False,118,109,227,"---FILE: docs/articles/posterior.html---
@@ -147,44 +147,53 @@ <h2 id=""summary-statistics"">Summary statistics<a class=""anchor"" aria-label=""anch
 <code>$summary()</code> and <code>$print()</code>.</p>
 <div class=""sourceCode"" id=""cb1""><pre class=""downlit sourceCode r"">
 <code class=""sourceCode R""><span><span class=""va"">fit</span> <span class=""op"">&lt;-</span> <span class=""fu"">cmdstanr</span><span class=""fu"">::</span><span class=""fu""><a href=""../reference/cmdstanr_example.html"">cmdstanr_example</a></span><span class=""op"">(</span><span class=""st"">""schools""</span>, method <span class=""op"">=</span> <span class=""st"">""sample""</span><span class=""op"">)</span></span></code></pre></div>
-<pre><code>Warning: 129 of 4000 (3.0%) transitions ended with a divergence.
+<pre><code>Warning: 191 of 4000 (5.0%) transitions ended with a divergence.
 See https://mc-stan.org/misc/warnings for details.</code></pre>
 <div class=""sourceCode"" id=""cb3""><pre class=""downlit sourceCode r"">
 <code class=""sourceCode R""><span><span class=""va"">fit</span><span class=""op"">$</span><span class=""fu"">summary</span><span class=""op"">(</span><span class=""op"">)</span></span></code></pre></div>
-<pre><code>[38;5;246m# A tibble: 11  10[39m
-   variable   mean median    sd   mad      q5   q95  rhat ess_bulk ess_tail
-   [3m[38;5;246m&lt;chr&gt;[39m[23m     [3m[38;5;246m&lt;dbl&gt;[39m[23m  [3m[38;5;246m&lt;dbl&gt;[39m[23m [3m[38;5;246m&lt;dbl&gt;[39m[23m [3m[38;5;246m&lt;dbl&gt;[39m[23m   [3m[38;5;246m&lt;dbl&gt;[39m[23m [3m[38;5;246m&lt;dbl&gt;[39m[23m [3m[38;5;246m&lt;dbl&gt;[39m[23m    [3m[38;5;246m&lt;dbl&gt;[39m[23m    [3m[38;5;246m&lt;dbl&gt;[39m[23m
-[38;5;250m 1[39m lp__     -[31m57[39m[31m.[39m[31m8[39m  -[31m58[39m[31m.[39m[31m2[39m   5.49  5.70 -[31m66[39m[31m.[39m[31m4[39m   -[31m48[39m[31m.[39m[31m3[39m  1.02     167.     73.4
-[38;5;250m 2[39m mu         6.41   6.52  4.26  3.98  -[31m0[39m[31m.[39m[31m818[39m  13.3  1.00     879.   [4m1[24m035. 
-[38;5;250m 3[39m tau        5.25   4.42  3.65  3.35   1.05   12.3  1.02     165.     74.2
-[38;5;250m 4[39m theta[1]   9.31   8.49  7.20  5.99  -[31m0[39m[31m.[39m[31m848[39m  22.7  1.00    [4m1[24m019.   [4m1[24m427. 
-[38;5;250m 5[39m theta[2]   6.79   6.59  5.67  5.19  -[31m2[39m[31m.[39m[31m48[39m   16.0  1.00    [4m1[24m144.   [4m1[24m560. 
-[38;5;250m 6[39m theta[3]   5.26   5.83  6.76  5.56  -[31m6[39m[31m.[39m[31m39[39m   15.5  1.00    [4m1[24m331.   [4m1[24m585. 
-[38;5;250m 7[39m theta[4]   6.50   6.53  5.87  5.41  -[31m3[39m[31m.[39m[31m19[39m   16.4  1.00    [4m1[24m180.   [4m1[24m550. 
-[38;5;250m 8[39m theta[5]   4.65   5.06  5.63  5.08  -[31m5[39m[31m.[39m[31m11[39m   13.6  1.01    [4m1[24m173.   [4m1[24m709. 
-[38;5;250m 9[39m theta[6]   5.45   5.88  5.82  5.38  -[31m4[39m[31m.[39m[31m57[39m   14.4  1.00    [4m1[24m435.   [4m1[24m879. 
-[38;5;250m10[39m theta[7]   9.10   8.57  6.15  5.73  -[31m0[39m[31m.[39m[31m198[39m  19.7  1.00     857.    987. 
-[38;5;250m11[39m theta[8]   7.07   6.89  6.47  5.57  -[31m3[39m[31m.[39m[31m26[39m   17.8  1.01    [4m1[24m358.   [4m1[24m753. </code></pre>
+<pre><code>   variable       mean     median       sd      mad          q5       q95
+1      lp__ -57.917364 -58.126700 5.227350 5.348035 -66.0514450 -47.99920
+2        mu   6.421661   6.560445 3.994261 3.728717  -0.1207198  13.16044
+3       tau   5.211890   4.447485 3.457118 3.180740   1.0590100  12.09968
+4  theta[1]   9.159825   8.066620 6.731183 5.516199   0.1858543  21.43202
+5  theta[2]   6.750832   6.740980 5.320603 4.835678  -1.7502315  15.66325
+6  theta[3]   5.564623   5.963075 6.485297 5.310451  -5.2589090  15.65180
+7  theta[4]   6.506969   6.552735 5.753473 4.933870  -2.8831600  15.96813
+8  theta[5]   4.602639   4.969540 5.596007 4.792030  -5.1313190  13.08000
+9  theta[6]   5.451744   5.604770 5.781909 4.976021  -4.4380795  14.88214
+10 theta[7]   9.105948   8.421645 6.077003 5.363817   0.4464001  20.13298
+11 theta[8]   6.904986   6.666570 6.591653 5.244594  -3.4154830  18.00026
+       rhat   ess_bulk   ess_tail
+1  1.037320   87.01265   18.13542
+2  1.019548  741.86144 1129.22230
+3  1.041517   74.40670   16.64168
+4  1.012043  615.84853 1757.06290
+5  1.008696 1279.50483 2218.60618
+6  1.002604 1345.71326 1786.80529
+7  1.010044 1291.76655 1900.28317
+8  1.008882 1209.92612 1848.18547
+9  1.034876 1464.53969 1882.25434
+10 1.008780  554.66658 1685.21958
+11 1.034006 1102.79917 1784.94313</code></pre>
 <p>By default all variables are summaries with the follow functions:</p>
 <div class=""sourceCode"" id=""cb5""><pre class=""downlit sourceCode r"">
 <code class=""sourceCode R""><span><span class=""fu"">posterior</span><span class=""fu"">::</span><span class=""fu""><a href=""https://mc-stan.org/posterior/reference/draws_summary.html"" class=""external-link"">default_summary_measures</a></span><span class=""op"">(</span><span class=""op"">)</span></span></code></pre></div>
 <pre><code>[1] ""mean""      ""median""    ""sd""        ""mad""       ""quantile2""</code></pre>
 <p>To change the variables summarized, we use the variables argument</p>
 <div class=""sourceCode"" id=""cb7""><pre class=""downlit sourceCode r"">
 <code class=""sourceCode R""><span><span class=""va"">fit</span><span class=""op"">$</span><span class=""fu"">summary</span><span class=""op"">(</span>variables <span class=""op"">=</span> <span class=""fu""><a href=""https://rdrr.io/r/base/c.html"" class=""external-link"">c</a></span><span class=""op"">(</span><span class=""st"">""mu""</span>, <span class=""st"">""tau""</span><span class=""op"">)</span><span class=""op"">)</span></span></code></pre></div>
-<pre><code>[38;5;246m# A tibble: 2  10[39m
-  variable  mean median    sd   mad     q5   q95  rhat ess_bulk ess_tail
-  [3m[38;5;246m&lt;chr&gt;[39m[23m    [3m[38;5;246m&lt;dbl&gt;[39m[23m  [3m[38;5;246m&lt;dbl&gt;[39m[23m [3m[38;5;246m&lt;dbl&gt;[39m[23m [3m[38;5;246m&lt;dbl&gt;[39m[23m  [3m[38;5;246m&lt;dbl&gt;[39m[23m [3m[38;5;246m&lt;dbl&gt;[39m[23m [3m[38;5;246m&lt;dbl&gt;[39m[23m    [3m[38;5;246m&lt;dbl&gt;[39m[23m    [3m[38;5;246m&lt;dbl&gt;[39m[23m
-[38;5;250m1[39m mu        6.41   6.52  4.26  3.98 -[31m0[39m[31m.[39m[31m818[39m  13.3  1.00     879.   [4m1[24m035. 
-[38;5;250m2[39m tau       5.25   4.42  3.65  3.35  1.05   12.3  1.02     165.     74.2</code></pre>
+<pre><code>  variable     mean   median       sd      mad         q5      q95     rhat
+1       mu 6.421661 6.560445 3.994261 3.728717 -0.1207198 13.16044 1.019548
+2      tau 5.211890 4.447485 3.457118 3.180740  1.0590100 12.09968 1.041517
+  ess_bulk   ess_tail
+1 741.8614 1129.22230
+2  74.4067   16.64168</code></pre>
 <p>We can additionally change which functions are used</p>
 <div class=""sourceCode"" id=""cb9""><pre class=""downlit sourceCode r"">
 <code class=""sourceCode R""><span><span class=""va"">fit</span><span class=""op"">$</span><span class=""fu"">summary</span><span class=""op"">(</span>variables <span class=""op"">=</span> <span class=""fu""><a href=""https://rdrr.io/r/base/c.html"" class=""external-link"">c</a></span><span class=""op"">(</span><span class=""st"">""mu""</span>, <span class=""st"">""tau""</span><span class=""op"">)</span>, <span class=""va"">mean</span>, <span class=""va"">sd</span><span class=""op"">)</span></span></code></pre></div>
-<pre><code>[38;5;246m# A tibble: 2  3[39m
-  variable  mean    sd
-  [3m[38;5;246m&lt;chr&gt;[39m[23m    [3m[38;5;246m&lt;dbl&gt;[39m[23m [3m[38;5;246m&lt;dbl&gt;[39m[23m
-[38;5;250m1[39m mu        6.41  4.26
-[38;5;250m2[39m tau       5.25  3.65</code></pre>
+<pre><code>  variable     mean       sd
+1       mu 6.421661 3.994261
+2      tau 5.211890 3.457118</code></pre>
 <p>To summarize all variables with non-default functions, it is
 necessary to set explicitly set the variables argument, either to
 <code>NULL</code> or the full vector of variable names.</p>
@@ -194,24 +203,23 @@ <h2 id=""summary-statistics"">Summary statistics<a class=""anchor"" aria-label=""anch
  [7] ""theta[4]"" ""theta[5]"" ""theta[6]"" ""theta[7]"" ""theta[8]""</code></pre>
 <div class=""sourceCode"" id=""cb13""><pre class=""downlit sourceCode r"">
 <code class=""sourceCode R""><span><span class=""va"">fit</span><span class=""op"">$</span><span class=""fu"">summary</span><span class=""op"">(</span>variables <span class=""op"">=</span> <span class=""cn"">NULL</span>, <span class=""st"">""mean""</span>, <span class=""st"">""median""</span><span class=""op"">)</span></span></code></pre></div>
-<pre><code>[38;5;246m# A tibble: 11  3[39m
-   variable   mean median
-   [3m[38;5;246m&lt;chr&gt;[39m[23m     [3m[38;5;246m&lt;dbl&gt;[39m[23m  [3m[38;5;246m&lt;dbl&gt;[39m[23m
-[38;5;250m 1[39m lp__     -[31m57[39m[31m.[39m[31m8[39m  -[31m58[39m[31m.[39m[31m2[39m 
-[38;5;250m 2[39m mu         6.41   6.52
-[38;5;250m 3[39m tau        5.25   4.42
-[38;5;250m 4[39m theta[1]   9.31   8.49
-[38;5;250m 5[39m theta[2]   6.79   6.59
-[38;5;250m 6[39m theta[3]   5.26   5.83
-[38;5;250m 7[39m theta[4]   6.50   6.53
-[38;5;250m 8[39m theta[5]   4.65   5.06
-[38;5;250m 9[39m theta[6]   5.45   5.88
-[38;5;250m10[39m theta[7]   9.10   8.57
-[38;5;250m11[39m theta[8]   7.07   6.89</code></pre>
+<pre><code>   variable       mean     median
+1      lp__ -57.917364 -58.126700
+2        mu   6.421661   6.560445
+3       tau   5.211890   4.447485
+4  theta[1]   9.159825   8.066620
+5  theta[2]   6.750832   6.740980
+6  theta[3]   5.564623   5.963075
+7  theta[4]   6.506969   6.552735
+8  theta[5]   4.602639   4.969540
+9  theta[6]   5.451744   5.604770
+10 theta[7]   9.105948   8.421645
+11 theta[8]   6.904986   6.666570</code></pre>
 <p>Summary functions can be specified by character string, function, or
-using a formula (or anything else supported by [rlang::as_function]). If
-these arguments are named, those names will be used in the tibble
-output. If the summary results are named they will take precedence.</p>
+using a formula (or anything else supported by
+<code><a href=""https://rlang.r-lib.org/reference/as_function.html"" class=""external-link"">rlang::as_function()</a></code>). If these arguments are named, those
+names will be used in the tibble output. If the summary results are
+named they will take precedence.</p>
 <div class=""sourceCode"" id=""cb15""><pre class=""downlit sourceCode r"">
 <code class=""sourceCode R""><span><span class=""va"">my_sd</span> <span class=""op"">&lt;-</span> <span class=""kw"">function</span><span class=""op"">(</span><span class=""va"">x</span><span class=""op"">)</span> <span class=""fu""><a href=""https://rdrr.io/r/base/c.html"" class=""external-link"">c</a></span><span class=""op"">(</span>My_SD <span class=""op"">=</span> <span class=""fu"">sd</span><span class=""op"">(</span><span class=""va"">x</span><span class=""op"">)</span><span class=""op"">)</span></span>
 <span><span class=""va"">fit</span><span class=""op"">$</span><span class=""fu"">summary</span><span class=""op"">(</span></span>
@@ -222,69 +230,59 @@ <h2 id=""summary-statistics"">Summary statistics<a class=""anchor"" aria-label=""anch
 <span>  <span class=""op"">~</span><span class=""fu""><a href=""https://rdrr.io/r/stats/quantile.html"" class=""external-link"">quantile</a></span><span class=""op"">(</span><span class=""va"">.x</span>, probs <span class=""op"">=</span> <span class=""fu""><a href=""https://rdrr.io/r/base/c.html"" class=""external-link"">c</a></span><span class=""op"">(</span><span class=""fl"">0.1</span>, <span class=""fl"">0.9</span><span class=""op"">)</span><span class=""op"">)</span>,</span>
 <span>  Minimum <span class=""op"">=</span> <span class=""kw"">function</span><span class=""op"">(</span><span class=""va"">x</span><span class=""op"">)</span> <span class=""fu""><a href=""https://rdrr.io/r/base/Extremes.html"" class=""external-link"">min</a></span><span class=""op"">(</span><span class=""va"">x</span><span class=""op"">)</span></span>
 <span><span class=""op"">)</span>        </span></code></pre></div>
-<pre><code>[38;5;246m# A tibble: 2  7[39m
-  variable  MEAN median My_SD `10%` `90%` Minimum
-  [3m[38;5;246m&lt;chr&gt;[39m[23m    [3m[38;5;246m&lt;dbl&gt;[39m[23m  [3m[38;5;246m&lt;dbl&gt;[39m[23m [3m[38;5;246m&lt;dbl&gt;[39m[23m [3m[38;5;246m&lt;dbl&gt;[39m[23m [3m[38;5;246m&lt;dbl&gt;[39m[23m   [3m[38;5;246m&lt;dbl&gt;[39m[23m
-[38;5;250m1[39m mu        6.41   6.52  4.26 0.940  11.5 -[31m10[39m[31m.[39m[31m7[39m  
-[38;5;250m2[39m tau       5.25   4.42  3.65 1.47   10.3   0.516</code></pre>
+<pre><code>  variable     MEAN   median    My_SD      10%      90%    Minimum
+1       mu 6.421661 6.560445 3.994261 1.488318 11.54665 -15.442700
+2      tau 5.211890 4.447485 3.457118 1.488050 10.02499   0.822982</code></pre>
 <p>Arguments to all summary functions can also be specified with
 <code>.args</code>.</p>
 <div class=""sourceCode"" id=""cb17""><pre class=""downlit sourceCode r"">
 <code class=""sourceCode R""><span><span class=""va"">fit</span><span class=""op"">$</span><span class=""fu"">summary</span><span class=""op"">(</span><span class=""fu""><a href=""https://rdrr.io/r/base/c.html"" class=""external-link"">c</a></span><span class=""op"">(</span><span class=""st"">""mu""</span>, <span class=""st"">""tau""</span><span class=""op"">)</span>, <span class=""va"">quantile</span>, .args <span class=""op"">=</span> <span class=""fu""><a href=""https://rdrr.io/r/base/list.html"" class=""external-link"">list</a></span><span class=""op"">(</span>probs <span class=""op"">=</span> <span class=""fu""><a href=""https://rdrr.io/r/base/c.html"" class=""external-link"">c</a></span><span class=""op"">(</span><span class=""fl"">0.025</span>, <span class=""fl"">.05</span>, <span class=""fl"">.95</span>, <span class=""fl"">.975</span><span class=""op"">)</span><span class=""op"">)</span><span class=""op"">)</span></span></code></pre></div>
-<pre><code>[38;5;246m# A tibble: 2  5[39m
-  variable `2.5%`   `5%` `95%` `97.5%`
-  [3m[38;5;246m&lt;chr&gt;[39m[23m     [3m[38;5;246m&lt;dbl&gt;[39m[23m  [3m[38;5;246m&lt;dbl&gt;[39m[23m [3m[38;5;246m&lt;dbl&gt;[39m[23m   [3m[38;5;246m&lt;dbl&gt;[39m[23m
-[38;5;250m1[39m mu       -[31m2[39m[31m.[39m[31m32[39m  -[31m0[39m[31m.[39m[31m818[39m  13.3    14.5
-[38;5;250m2[39m tau       0.760  1.05   12.3    14.2</code></pre>
+<pre><code>  variable      2.5%         5%      95%    97.5%
+1       mu -1.441798 -0.1207198 13.16044 14.63687
+2      tau  0.822982  1.0590100 12.09968 13.78430</code></pre>
 <p>The summary functions are applied to the array of sample values, with
 dimension <code>iter_sampling</code>x<code>chains</code>.</p>
 <div class=""sourceCode"" id=""cb19""><pre class=""downlit sourceCode r"">
 <code class=""sourceCode R""><span><span class=""va"">fit</span><span class=""op"">$</span><span class=""fu"">summary</span><span class=""op"">(</span>variables <span class=""op"">=</span> <span class=""cn"">NULL</span>, <span class=""va"">dim</span>, <span class=""va"">colMeans</span><span class=""op"">)</span></span></code></pre></div>
-<pre><code>[38;5;246m# A tibble: 11  7[39m
-   variable dim.1 dim.2    `1`    `2`    `3`    `4`
-   [3m[38;5;246m&lt;chr&gt;[39m[23m    [3m[38;5;246m&lt;dbl&gt;[39m[23m [3m[38;5;246m&lt;dbl&gt;[39m[23m  [3m[38;5;246m&lt;dbl&gt;[39m[23m  [3m[38;5;246m&lt;dbl&gt;[39m[23m  [3m[38;5;246m&lt;dbl&gt;[39m[23m  [3m[38;5;246m&lt;dbl&gt;[39m[23m
-[38;5;250m 1[39m lp__      [4m1[24m000     4 -[31m57[39m[31m.[39m[31m8[39m  -[31m57[39m[31m.[39m[31m9[39m  -[31m59[39m[31m.[39m[31m0[39m  -[31m56[39m[31m.[39m[31m7[39m 
-[38;5;250m 2[39m mu        [4m1[24m000     4   6.61   6.42   6.48   6.11
-[38;5;250m 3[39m tau       [4m1[24m000     4   4.94   5.36   5.89   4.83
-[38;5;250m 4[39m theta[1]  [4m1[24m000     4   9.42   9.27   9.92   8.65
-[38;5;250m 5[39m theta[2]  [4m1[24m000     4   7.07   6.65   6.95   6.47
-[38;5;250m 6[39m theta[3]  [4m1[24m000     4   5.54   5.17   5.47   4.86
-[38;5;250m 7[39m theta[4]  [4m1[24m000     4   6.57   6.50   6.67   6.28
-[38;5;250m 8[39m theta[5]  [4m1[24m000     4   4.87   4.55   4.50   4.67
-[38;5;250m 9[39m theta[6]  [4m1[24m000     4   5.64   5.56   5.43   5.18
-[38;5;250m10[39m theta[7]  [4m1[24m000     4   8.97   9.29   9.63   8.50
-[38;5;250m11[39m theta[8]  [4m1[24m000     4   7.00   7.16   7.37   6.73</code></pre>
+<pre><code>   variable dim.1 dim.2          1          2          3          4
+1      lp__  1000     4 -59.408601 -58.175641 -58.144473 -55.940741
+2        mu  1000     4   6.689529   6.327474   6.548562   6.121077
+3       tau  1000     4   6.015816   5.271415   5.222288   4.338039
+4  theta[1]  1000     4  10.309827   9.010128   9.089769   8.229576
+5  theta[2]  1000     4   6.940841   6.642238   6.917915   6.502333
+6  theta[3]  1000     4   5.378242   5.517793   5.881470   5.480988
+7  theta[4]  1000     4   6.732677   6.458448   6.658988   6.177763
+8  theta[5]  1000     4   4.460429   4.316417   4.822090   4.811620
+9  theta[6]  1000     4   5.567601   5.449356   5.743810   5.046207
+10 theta[7]  1000     4   9.872239   9.168575   9.143428   8.239549
+11 theta[8]  1000     4   6.985384   6.844136   7.146715   6.643711</code></pre>
 <p>For this reason users may have unexpected results if they use
 <code><a href=""https://rdrr.io/r/stats/cor.html"" class=""external-link"">stats::var()</a></code> directly, as it will return a covariance
 matrix. An alternative is the <code><a href=""https://pkg.mitchelloharawild.com/distributional/reference/variance.html"" class=""external-link"">distributional::variance()</a></code>
 function, which can also be accessed via
 <code><a href=""https://pkg.mitchelloharawild.com/distributional/reference/variance.html"" class=""external-link"">posterior::variance()</a></code>.</p>
 <div class=""sourceCode"" id=""cb21""><pre class=""downlit sourceCode r"">
 <code class=""sourceCode R""><span><span class=""va"">fit</span><span class=""op"">$</span><span class=""fu"">summary</span><span class=""op"">(</span><span class=""fu""><a href=""https://rdrr.io/r/base/c.html"" class=""external-link"">c</a></span><span class=""op"">(</span><span class=""st"">""mu""</span>, <span class=""st"">""tau""</span><span class=""op"">)</span>, <span class=""fu"">posterior</span><span class=""fu"">::</span><span class=""va""><a href=""https://pkg.mitchelloharawild.com/distributional/reference/variance.html"" class=""external-link"">variance</a></span>, <span class=""op"">~</span><span class=""fu"">var</span><span class=""op"">(</span><span class=""fu""><a href=""https://rdrr.io/r/base/vector.html"" class=""external-link"">as.vector</a></span><span class=""op"">(</span><span class=""va"">.x</span><span class=""op"">)</span><span class=""op"">)</span><span class=""op"">)</span></span></code></pre></div>
-<pre><code>[38;5;246m# A tibble: 2  3[39m
-  variable `posterior::variance` `~var(as.vector(.x))`
-  [3m[38;5;246m&lt;chr&gt;[39m[23m                    [3m[38;5;246m&lt;dbl&gt;[39m[23m                 [3m[38;5;246m&lt;dbl&gt;[39m[23m
-[38;5;250m1[39m mu                        18.2                  18.2
-[38;5;250m2[39m tau                       13.3                  13.3</code></pre>
+<pre><code>  variable posterior::variance ~var(as.vector(.x))
+1       mu            15.95412            15.95412
+2      tau            11.95166            11.95166</code></pre>
 <p>Summary functions need not be numeric, but these wont work with
 <code>$print()</code>.</p>
 <div class=""sourceCode"" id=""cb23""><pre class=""downlit sourceCode r"">
 <code class=""sourceCode R""><span><span class=""va"">strict_pos</span> <span class=""op"">&lt;-</span> <span class=""kw"">function</span><span class=""op"">(</span><span class=""va"">x</span><span class=""op"">)</span> <span class=""kw"">if</span> <span class=""op"">(</span><span class=""fu""><a href=""https://rdrr.io/r/base/all.html"" class=""external-link"">all</a></span><span class=""op"">(</span><span class=""va"">x</span> <span class=""op"">&gt;</span> <span class=""fl"">0</span><span class=""op"">)</span><span class=""op"">)</span> <span class=""st"">""yes""</span> <span class=""kw"">else</span> <span class=""st"">""no""</span></span>
 <span><span class=""va"">fit</span><span class=""op"">$</span><span class=""fu"">summary</span><span class=""op"">(</span>variables <span class=""op"">=</span> <span class=""cn"">NULL</span>, <span class=""st"">""Strictly Positive""</span> <span class=""op"">=</span> <span class=""va"">strict_pos</span><span class=""op"">)</span></span></code></pre></div>
-<pre><code>[38;5;246m# A tibble: 11  2[39m
-   variable `Strictly Positive`
-   [3m[38;5;246m&lt;chr&gt;[39m[23m    [3m[38;5;246m&lt;chr&gt;[39m[23m              
-[38;5;250m 1[39m lp__     no                 
-[38;5;250m 2[39m mu       no                 
-[38;5;250m 3[39m tau      yes                
-[38;5;250m 4[39m theta[1] no                 
-[38;5;250m 5[39m theta[2] no                 
-[38;5;250m 6[39m theta[3] no                 
-[38;5;250m 7[39m theta[4] no                 
-[38;5;250m 8[39m theta[5] no                 
-[38;5;250m 9[39m theta[6] no                 
-[38;5;250m10[39m theta[7] no                 
-[38;5;250m11[39m theta[8] no                 </code></pre>
+<pre><code>   variable Strictly Positive
+1      lp__                no
+2        mu                no
+3       tau               yes
+4  theta[1]                no
+5  theta[2]                no
+6  theta[3]                no
+7  theta[4]                no
+8  theta[5]                no
+9  theta[6]                no
+10 theta[7]                no
+11 theta[8]                no</code></pre>
 <div class=""sourceCode"" id=""cb25""><pre class=""downlit sourceCode r"">
 <code class=""sourceCode R""><span><span class=""co""># fit$print(variables = NULL, ""Strictly Positive"" = strict_pos)</span></span></code></pre></div>
 <p>For more information, see <code><a href=""https://mc-stan.org/posterior/reference/draws_summary.html"" class=""external-link"">posterior::summarise_draws()</a></code>,
@@ -304,7 +302,7 @@ <h2 id=""extracting-posterior-drawssamples"">Extracting posterior draws/samples<a
 <span><span class=""co""># iterations x chains x variables</span></span>
 <span><span class=""va"">draws_arr</span> <span class=""op"">&lt;-</span> <span class=""va"">fit</span><span class=""op"">$</span><span class=""fu"">draws</span><span class=""op"">(</span><span class=""op"">)</span> <span class=""co""># or format=""array""</span></span>
 <span><span class=""fu""><a href=""https://rdrr.io/r/utils/str.html"" class=""external-link"">str</a></span><span class=""op"">(</span><span class=""va"">draws_arr</span><span class=""op"">)</span></span></code></pre></div>
-<pre><code> 'draws_array' num [1:1000, 1:4, 1:11] -60.1 -61.2 -56.1 -57.3 -60.4 ...
+<pre><code> 'draws_array' num [1:1000, 1:4, 1:11] -57.1 -58.5 -56 -57.2 -58.5 ...
  - attr(*, ""dimnames"")=List of 3
   ..$ iteration: chr [1:1000] ""1"" ""2"" ""3"" ""4"" ...
   ..$ chain    : chr [1:4] ""1"" ""2"" ""3"" ""4""
@@ -314,34 +312,34 @@ <h2 id=""extracting-posterior-drawssamples"">Extracting posterior draws/samples<a
 <span><span class=""va"">draws_df</span> <span class=""op"">&lt;-</span> <span class=""va"">fit</span><span class=""op"">$</span><span class=""fu"">draws</span><span class=""op"">(</span>format <span class=""op"">=</span> <span class=""st"">""df""</span><span class=""op"">)</span></span>
 <span><span class=""fu""><a href=""https://rdrr.io/r/utils/str.html"" class=""external-link"">str</a></span><span class=""op"">(</span><span class=""va"">draws_df</span><span class=""op"">)</span></span></code></pre></div>
 <pre><code>draws_df [4,000  14] (S3: draws_df/draws/tbl_df/tbl/data.frame)
- $ lp__      : num [1:4000] -60.1 -61.2 -56.1 -57.3 -60.4 ...
- $ mu        : num [1:4000] 2.61848 0.7849 8.10256 6.57364 -0.00287 ...
- $ tau       : num [1:4000] 5.08 7.18 4.03 3.89 7.07 ...
- $ theta[1]  : num [1:4000] 10.98 9.64 5.26 11.34 13.75 ...
- $ theta[2]  : num [1:4000] -2.54 -3.89 10.58 2.63 10.17 ...
- $ theta[3]  : num [1:4000] -4.73 -3.78 7.2 4.05 4.26 ...
- $ theta[4]  : num [1:4000] 5.14 10.67 7.18 4.7 2.94 ...
- $ theta[5]  : num [1:4000] -5.56 1.63 1.64 3.55 3.04 ...
- $ theta[6]  : num [1:4000] 1.153 3.155 12.283 -2.088 -0.133 ...
- $ theta[7]  : num [1:4000] 4.064 0.872 10.52 5.397 7.21 ...
- $ theta[8]  : num [1:4000] 8.65 -5.18 9.86 5.43 1.18 ...
+ $ lp__      : num [1:4000] -57.1 -58.5 -56 -57.2 -58.5 ...
+ $ mu        : num [1:4000] 9.17 4.62 11.15 5.67 5.37 ...
+ $ tau       : num [1:4000] 2.8 4.94 2.62 5.14 7.06 ...
+ $ theta[1]  : num [1:4000] 17.589 0.16 18.328 0.237 1.688 ...
+ $ theta[2]  : num [1:4000] 8.55 10.22 8.37 9.18 9.6 ...
+ $ theta[3]  : num [1:4000] 10.75 6.36 10.37 9.1 8.14 ...
+ $ theta[4]  : num [1:4000] 10.85 3.4 12.92 6.16 6.3 ...
+ $ theta[5]  : num [1:4000] 11 2.25 11.42 2.25 2.76 ...
+ $ theta[6]  : num [1:4000] 9.55 8.19 9.94 6.84 4.9 ...
+ $ theta[7]  : num [1:4000] 6.58 14.62 9.12 6.07 5.08 ...
+ $ theta[8]  : num [1:4000] 11.31 6.14 10.26 4.92 7.66 ...
  $ .chain    : int [1:4000] 1 1 1 1 1 1 1 1 1 1 ...
  $ .iteration: int [1:4000] 1 2 3 4 5 6 7 8 9 10 ...
  $ .draw     : int [1:4000] 1 2 3 4 5 6 7 8 9 10 ...</code></pre>
 <div class=""sourceCode"" id=""cb30""><pre class=""downlit sourceCode r"">
 <code class=""sourceCode R""><span><span class=""fu""><a href=""https://rdrr.io/r/base/print.html"" class=""external-link"">print</a></span><span class=""op"">(</span><span class=""va"">draws_df</span><span class=""op"">)</span></span></code></pre></div>
 <pre><code># A draws_df: 1000 iterations, 4 chains, and 11 variables
-   lp__      mu tau theta[1] theta[2] theta[3] theta[4] theta[5]
-1   -60  2.6185 5.1     11.0     -2.5     -4.7      5.1    -5.56
-2   -61  0.7849 7.2      9.6     -3.9     -3.8     10.7     1.63
-3   -56  8.1026 4.0      5.3     10.6      7.2      7.2     1.64
-4   -57  6.5736 3.9     11.3      2.6      4.1      4.7     3.55
-5   -60 -0.0029 7.1     13.7     10.2      4.3      2.9     3.04
-6   -59  3.7000 4.5     10.2      7.6     -2.3      1.2     2.20
-7   -62  5.0756 8.0     11.3     10.9      5.1     14.6     0.37
-8   -63 14.5222 6.3     19.5     16.0      8.3      2.0    18.21
-9   -58 11.0878 4.0     16.8     12.8     10.8      7.9     3.32
-10  -56 10.4559 4.2      9.6     15.2     12.4      8.2    10.41
+   lp__    mu tau theta[1] theta[2] theta[3] theta[4] theta[5]
+1   -57  9.17 2.8    17.59      8.5    10.75     10.8     11.0
+2   -58  4.62 4.9     0.16     10.2     6.36      3.4      2.3
+3   -56 11.15 2.6    18.33      8.4    10.37     12.9     11.4
+4   -57  5.67 5.1     0.24      9.2     9.10      6.2      2.3
+5   -59  5.37 7.1     1.69      9.6     8.14      6.3      2.8
+6   -59  0.64 4.4     6.20      6.6     0.44      4.1      2.4
+7   -53  7.85 3.0     6.58      6.7     8.34      7.4      6.7
+8   -54  8.05 3.9     7.66      6.5     4.54      7.1      8.3
+9   -54  6.80 3.3     7.75      8.5     1.37      6.6      9.4
+10  -59  5.09 5.8     0.40      9.4    -1.92     13.0      2.4
 # ... with 3990 more draws, and 3 more variables
 # ... hidden reserved variables {'.chain', '.iteration', '.draw'}</code></pre>
 <p>To convert an existing draws object to a different format use the

---FILE: vignettes/posterior.Rmd---
@@ -15,6 +15,14 @@ vignette: >
 ```{r child=""children/_settings-knitr.Rmd""}
 ```
 
+```{r include=FALSE}
+# Needed temporarily to avoiding weird rendering of posterior's tibbles
+# in pkgdown sites
+print.tbl_df <- function(x, ...) {
+  print.data.frame(x)
+}
+```
+
 ## Summary statistics
 
 We can easily customize the summary statistics reported by `$summary()` and `$print()`.
@@ -45,7 +53,10 @@ fit$metadata()$model_params
 fit$summary(variables = NULL, ""mean"", ""median"")
 ```
 
-Summary functions can be specified by character string, function, or using a formula (or anything else supported by [rlang::as_function]). If these arguments are named, those names will be used in the tibble output. If the summary results are named they will take precedence.
+Summary functions can be specified by character string, function, or using a
+formula (or anything else supported by `rlang::as_function()`). If these
+arguments are named, those names will be used in the tibble output. If the
+summary results are named they will take precedence.
 ```{r}
 my_sd <- function(x) c(My_SD = sd(x))
 fit$summary(",False,True,Documentation / Formatting,7
stan-dev,cmdstanr,094d797b1ff8d32e839beeb6fd6bb6a86789932b,Steve Bronder,sbronder@flatironinstitute.org,2023-11-03T19:18:49Z,Steve Bronder,sbronder@flatironinstitute.org,2023-11-03T19:18:49Z,fix test error,R/csv.R,False,True,True,False,1,1,2,"---FILE: R/csv.R---
@@ -287,7 +287,7 @@ read_cmdstan_csv <- function(files,
       suppressWarnings(
         draws[[draws_list_id]] <- data.table::fread(
           cmd = fread_cmd,
-          select = metadata$variables,
+          select = variables,
           data.table = FALSE
         )
       )",True,False,Data / Input Handling,3
stan-dev,cmdstanr,204f217a8130c8b378259ad9a53a8b9feb5c5926,Steve Bronder,sbronder@flatironinstitute.org,2023-11-03T17:11:49Z,Steve Bronder,sbronder@flatironinstitute.org,2023-11-03T17:11:49Z,Fix bug which returned -1 draws,R/csv.R,False,True,True,False,4,3,7,"---FILE: R/csv.R---
@@ -281,12 +281,13 @@ read_cmdstan_csv <- function(files,
       draws_list_id <- length(draws) + 1
       warmup_draws_list_id <- length(warmup_draws) + 1
       if (metadata$method == ""pathfinder"") {
-        variables = union(metadata$sampler_diagnostics, metadata$variables)
+        metadata$variables = union(metadata$sampler_diagnostics, metadata$variables)
+        variables = union(metadata$sampler_diagnostics, variables)
       }
       suppressWarnings(
         draws[[draws_list_id]] <- data.table::fread(
           cmd = fread_cmd,
-          select = variables,
+          select = metadata$variables,
           data.table = FALSE
         )
       )
@@ -456,7 +457,7 @@ read_cmdstan_csv <- function(files,
     if (length(draws) == 0) {
       pathfinder_draws <- NULL
     } else {
-      pathfinder_draws <- do.call(as_draws_format, list(draws[[1]][-1, colnames(draws[[1]]), drop = FALSE]))
+      pathfinder_draws <- do.call(as_draws_format, list(draws[[1]][, colnames(draws[[1]]), drop = FALSE]))
       posterior::variables(pathfinder_draws) <- repaired_variables
     }
     list(",True,False,Implementation / Logic,6
stan-dev,cmdstanr,3cab26a091b35111c79e5998e5c3cf0a858beb39,jgabry,jgabry@gmail.com,2023-11-01T18:37:20Z,jgabry,jgabry@gmail.com,2023-11-01T18:37:20Z,fix doc issues in review comments,R/model.R;man/CmdStanModel.Rd;man/cmdstan_model.Rd;man/cmdstanr-package.Rd;man/model-method-laplace.Rd;man/model-method-optimize.Rd;man/model-method-pathfinder.Rd;man/model-method-sample.Rd;man/model-method-variational.Rd,False,True,True,False,116,110,226,"---FILE: R/model.R---
@@ -99,13 +99,15 @@
 #' fit_laplace <- mod$laplace(data = my_data_file, mode = fit_optim, draws = 2000)
 #' fit_laplace$summary()
 #'
-#' # Run 'variational' method to approximate the posterior (default is meanfield ADVI)
+#' # Run 'variational' method to use ADVI to approximate posterior
 #' fit_vb <- mod$variational(data = stan_data, seed = 123)
 #' fit_vb$summary()
-#'
-#' # Plot approximate posterior using bayesplot
 #' mcmc_hist(fit_vb$draws(""theta""))
 #'
+#' # Run 'pathfinder' method, a new alternative to the variational method
+#' fit_pf <- mod$pathfinder(data = stan_data, seed = 123)
+#' fit_pf$summary()
+#' mcmc_hist(fit_pf$draws(""theta""))
 #'
 #' # Specifying initial values as a function
 #' fit_mcmc_w_init_fun <- mod$sample(
@@ -1427,8 +1429,8 @@ CmdStanModel$set(""public"", name = ""sample_mpi"", value = sample_mpi)
 #' @description The `$optimize()` method of a [`CmdStanModel`] object runs
 #'   Stan's optimizer to obtain a (penalized) maximum likelihood estimate or a
 #'   maximum a posteriori estimate (if `jacobian=TRUE`). See the
-#'   [Maximum Likelihood Estimation](https://mc-stan.org/docs/cmdstan-guide/maximum-likelihood-estimation.html)
-#'   section of the CmdStan User's Guide for more details.
+#'   [CmdStan User's Guide](https://mc-stan.org/docs/cmdstan-guide/index.html)
+#'   for more details.
 #'
 #'   Any argument left as `NULL` will default to the default value used by the
 #'   installed version of CmdStan. See the [CmdStan Users
@@ -1551,13 +1553,11 @@ CmdStanModel$set(""public"", name = ""optimize"", value = optimize)
 #'   likelihood estimate (MLE), the sample provides an estimate of the standard
 #'   error of the likelihood. Whether the mode is the MAP or MLE depends on
 #'   the value of the `jacobian` argument when running optimization. See the
-#'   [Laplace Sampling](https://mc-stan.org/docs/cmdstan-guide/laplace-sampling.html)
-#'   section of the CmdStan User's Guide for more details.
+#'   [CmdStan Users Guide](https://mc-stan.org/docs/cmdstan-guide/)
+#'   for more details.
 #'
 #'   Any argument left as `NULL` will default to the default value used by the
-#'   installed version of CmdStan. See the
-#'   [CmdStan Users Guide](https://mc-stan.org/docs/cmdstan-guide/)
-#'   for more details on the default arguments.
+#'   installed version of CmdStan.
 #'
 #' @template model-common-args
 #' @inheritParams model-method-optimize
@@ -1708,21 +1708,17 @@ CmdStanModel$set(""public"", name = ""laplace"", value = laplace)
 #' @family CmdStanModel methods
 #'
 #' @description The `$variational()` method of a [`CmdStanModel`] object runs
-#'   Stan's variational Bayes (ADVI) algorithms.
-#'
-#'   Any argument left as `NULL` will default to the default value used by the
-#'   installed version of CmdStan. See the
+#'   Stan's Automatic Differentiation Variational Inference (ADVI) algorithms.
+#'   The approximation is a Gaussian in the unconstrained variable space. Stan
+#'   implements two ADVI algorithms: the `algorithm=""meanfield""` option uses a
+#'   fully factorized Gaussian for the approximation; the `algorithm=""fullrank""`
+#'   option uses a Gaussian with a full-rank covariance matrix for the
+#'   approximation. See the
 #'   [CmdStan Users Guide](https://mc-stan.org/docs/cmdstan-guide/)
 #'   for more details.
 #'
-#' @details CmdStan can fit a variational approximation to the posterior. The
-#'   approximation is a Gaussian in the unconstrained variable space. Stan
-#'   implements two variational algorithms. The `algorithm=""meanfield""` option
-#'   uses a fully factorized Gaussian for the approximation. The
-#'   `algorithm=""fullrank""` option uses a Gaussian with a full-rank covariance
-#'   matrix for the approximation.
-#'
-#'   -- [*CmdStan Interface User's Guide*](https://github.com/stan-dev/cmdstan/releases/latest)
+#'   Any argument left as `NULL` will default to the default value used by the
+#'   installed version of CmdStan.
 #'
 #' @template model-common-args
 #' @param threads (positive integer) If the model was
@@ -1830,27 +1826,25 @@ CmdStanModel$set(""public"", name = ""variational"", value = variational)
 #' @family CmdStanModel methods
 #'
 #' @description The `$pathfinder()` method of a [`CmdStanModel`] object runs
-#'   Stan's Pathfinder algorithms.
-#'
-#'   Any argument left as `NULL` will default to the default value used by the
-#'   installed version of CmdStan. See the
+#'   Stan's Pathfinder algorithms. Pathfinder is a variational method for
+#'   approximately sampling from differentiable log densities. Starting from a
+#'   random initialization, Pathfinder locates normal approximations to the
+#'   target density along a quasi-Newton optimization path, with local
+#'   covariance estimated using the negative inverse Hessian estimates produced
+#'   by the L-BFGS optimizer. Pathfinder returns draws from the Gaussian
+#'   approximation with the lowest estimated Kullback-Leibler (KL) divergence to
+#'   the true posterior. See the
 #'   [CmdStan Users Guide](https://mc-stan.org/docs/cmdstan-guide/)
 #'   for more details.
 #'
-#' @details CmdStan can fit a variational approximation to the posterior. The
-#'   approximation is a Gaussian in the unconstrained variable space. Stan
-#'   implements two variational algorithms. The `algorithm=""meanfield""` option
-#'   uses a fully factorized Gaussian for the approximation. The
-#'   `algorithm=""fullrank""` option uses a Gaussian with a full-rank covariance
-#'   matrix for the approximation.
-#'
-#'   -- [*CmdStan Interface User's Guide*](https://github.com/stan-dev/cmdstan/releases/latest)
+#'   Any argument left as `NULL` will default to the default value used by the
+#'   installed version of CmdStan
 #'
 #' @template model-common-args
 #' @param num_threads (positive integer) If the model was
 #'   [compiled][model-method-compile] with threading support, the number of
 #'   threads to use in parallelized sections (e.g., for multi-path pathfinder
-#'   as well as `reduce_sum`)
+#'   as well as `reduce_sum`).
 #' @param init_alpha (positive real) The initial step size parameter.
 #' @param tol_obj (positive real) Convergence tolerance on changes in objective function value.
 #' @param tol_rel_obj (positive real) Convergence tolerance on relative changes in objective function value.
@@ -1859,15 +1853,19 @@ CmdStanModel$set(""public"", name = ""variational"", value = variational)
 #' @param tol_param (positive real) Convergence tolerance on changes in parameter value.
 #' @param history_size (positive integer) The size of the history used when
 #'   approximating the Hessian.
-#' @param single_path_draws (positive integer) Number of draws a single pathfinder should return. The number of draws
-#'   PSIS sampling samples from will be equal to `single_path_draws * num_paths`
-#' @param draws (positive integer) Number of draws to return after performing pareto smooted importance sampling (PSIS).
-#'   This must be smaller than `single_path_draws * num_paths`
-#' @param num_paths (positive integer) Number of single pathfinders to run
-#' @param max_lbfgs_iters (positive integer) The maximum number of iterations for LBFGS
-#' @param num_elbo_draws (positive integer) Number of draws to make when calculating the ELBO of
-#'   the approximation at each iteration of LBFGS
-#' @param save_single_paths (logical) Whether to save the results of single pathfinder runs in multi-pathfinder
+#' @param single_path_draws (positive integer) Number of draws a single
+#'   pathfinder should return. The number of draws PSIS sampling samples from
+#'   will be equal to `single_path_draws * num_paths`.
+#' @param draws (positive integer) Number of draws to return after performing
+#'   pareto smooted importance sampling (PSIS). This must be smaller than
+#'   `single_path_draws * num_paths`.
+#' @param num_paths (positive integer) Number of single pathfinders to run.
+#' @param max_lbfgs_iters (positive integer) The maximum number of iterations
+#'   for LBFGS.
+#' @param num_elbo_draws (positive integer) Number of draws to make when
+#'   calculating the ELBO of the approximation at each iteration of LBFGS.
+#' @param save_single_paths (logical) Whether to save the results of single
+#'   pathfinder runs in multi-pathfinder.
 #' @return A [`CmdStanPathfinder`] object.
 #'
 #' @template seealso-docs

---FILE: man/CmdStanModel.Rd---
@@ -118,13 +118,15 @@ fit_optim <- mod$optimize(data = my_data_file, jacobian = TRUE)
 fit_laplace <- mod$laplace(data = my_data_file, mode = fit_optim, draws = 2000)
 fit_laplace$summary()
 
-# Run 'variational' method to approximate the posterior (default is meanfield ADVI)
+# Run 'variational' method to use ADVI to approximate posterior
 fit_vb <- mod$variational(data = stan_data, seed = 123)
 fit_vb$summary()
-
-# Plot approximate posterior using bayesplot
 mcmc_hist(fit_vb$draws(""theta""))
 
+# Run 'pathfinder' method, a new alternative to the variational method
+fit_pf <- mod$pathfinder(data = stan_data, seed = 123)
+fit_pf$summary()
+mcmc_hist(fit_pf$draws(""theta""))
 
 # Specifying initial values as a function
 fit_mcmc_w_init_fun <- mod$sample(

---FILE: man/cmdstan_model.Rd---
@@ -104,13 +104,15 @@ fit_optim <- mod$optimize(data = my_data_file, jacobian = TRUE)
 fit_laplace <- mod$laplace(data = my_data_file, mode = fit_optim, draws = 2000)
 fit_laplace$summary()
 
-# Run 'variational' method to approximate the posterior (default is meanfield ADVI)
+# Run 'variational' method to use ADVI to approximate posterior
 fit_vb <- mod$variational(data = stan_data, seed = 123)
 fit_vb$summary()
-
-# Plot approximate posterior using bayesplot
 mcmc_hist(fit_vb$draws(""theta""))
 
+# Run 'pathfinder' method, a new alternative to the variational method
+fit_pf <- mod$pathfinder(data = stan_data, seed = 123)
+fit_pf$summary()
+mcmc_hist(fit_pf$draws(""theta""))
 
 # Specifying initial values as a function
 fit_mcmc_w_init_fun <- mod$sample(

---FILE: man/cmdstanr-package.Rd---
@@ -129,13 +129,15 @@ fit_optim <- mod$optimize(data = my_data_file, jacobian = TRUE)
 fit_laplace <- mod$laplace(data = my_data_file, mode = fit_optim, draws = 2000)
 fit_laplace$summary()
 
-# Run 'variational' method to approximate the posterior (default is meanfield ADVI)
+# Run 'variational' method to use ADVI to approximate posterior
 fit_vb <- mod$variational(data = stan_data, seed = 123)
 fit_vb$summary()
-
-# Plot approximate posterior using bayesplot
 mcmc_hist(fit_vb$draws(""theta""))
 
+# Run 'pathfinder' method, a new alternative to the variational method
+fit_pf <- mod$pathfinder(data = stan_data, seed = 123)
+fit_pf$summary()
+mcmc_hist(fit_pf$draws(""theta""))
 
 # Specifying initial values as a function
 fit_mcmc_w_init_fun <- mod$sample(

---FILE: man/model-method-laplace.Rd---
@@ -151,13 +151,11 @@ deviation of the posterior distribution. If the mode is a maximum
 likelihood estimate (MLE), the sample provides an estimate of the standard
 error of the likelihood. Whether the mode is the MAP or MLE depends on
 the value of the \code{jacobian} argument when running optimization. See the
-\href{https://mc-stan.org/docs/cmdstan-guide/laplace-sampling.html}{Laplace Sampling}
-section of the CmdStan User's Guide for more details.
+\href{https://mc-stan.org/docs/cmdstan-guide/}{CmdStan Users Guide}
+for more details.
 
 Any argument left as \code{NULL} will default to the default value used by the
-installed version of CmdStan. See the
-\href{https://mc-stan.org/docs/cmdstan-guide/}{CmdStan Users Guide}
-for more details on the default arguments.
+installed version of CmdStan.
 }
 \examples{
 \dontrun{

---FILE: man/model-method-optimize.Rd---
@@ -166,8 +166,8 @@ A \code{\link{CmdStanMLE}} object.
 The \verb{$optimize()} method of a \code{\link{CmdStanModel}} object runs
 Stan's optimizer to obtain a (penalized) maximum likelihood estimate or a
 maximum a posteriori estimate (if \code{jacobian=TRUE}). See the
-\href{https://mc-stan.org/docs/cmdstan-guide/maximum-likelihood-estimation.html}{Maximum Likelihood Estimation}
-section of the CmdStan User's Guide for more details.
+\href{https://mc-stan.org/docs/cmdstan-guide/index.html}{CmdStan User's Guide}
+for more details.
 
 Any argument left as \code{NULL} will default to the default value used by the
 installed version of CmdStan. See the \href{https://mc-stan.org/docs/cmdstan-guide/}{CmdStan Users Guide} for more details on the
@@ -239,13 +239,15 @@ fit_optim <- mod$optimize(data = my_data_file, jacobian = TRUE)
 fit_laplace <- mod$laplace(data = my_data_file, mode = fit_optim, draws = 2000)
 fit_laplace$summary()
 
-# Run 'variational' method to approximate the posterior (default is meanfield ADVI)
+# Run 'variational' method to use ADVI to approximate posterior
 fit_vb <- mod$variational(data = stan_data, seed = 123)
 fit_vb$summary()
-
-# Plot approximate posterior using bayesplot
 mcmc_hist(fit_vb$draws(""theta""))
 
+# Run 'pathfinder' method, a new alternative to the variational method
+fit_pf <- mod$pathfinder(data = stan_data, seed = 123)
+fit_pf$summary()
+mcmc_hist(fit_pf$draws(""theta""))
 
 # Specifying initial values as a function
 fit_mcmc_w_init_fun <- mod$sample(

---FILE: man/model-method-pathfinder.Rd---
@@ -128,7 +128,7 @@ argument to have an effect.}
 \item{num_threads}{(positive integer) If the model was
 \link[=model-method-compile]{compiled} with threading support, the number of
 threads to use in parallelized sections (e.g., for multi-path pathfinder
-as well as \code{reduce_sum})}
+as well as \code{reduce_sum}).}
 
 \item{init_alpha}{(positive real) The initial step size parameter.}
 
@@ -145,42 +145,43 @@ as well as \code{reduce_sum})}
 \item{history_size}{(positive integer) The size of the history used when
 approximating the Hessian.}
 
-\item{single_path_draws}{(positive integer) Number of draws a single pathfinder should return. The number of draws
-PSIS sampling samples from will be equal to \code{single_path_draws * num_paths}}
+\item{single_path_draws}{(positive integer) Number of draws a single
+pathfinder should return. The number of draws PSIS sampling samples from
+will be equal to \code{single_path_draws * num_paths}.}
 
-\item{draws}{(positive integer) Number of draws to return after performing pareto smooted importance sampling (PSIS).
-This must be smaller than \code{single_path_draws * num_paths}}
+\item{draws}{(positive integer) Number of draws to return after performing
+pareto smooted importance sampling (PSIS). This must be smaller than
+\code{single_path_draws * num_paths}.}
 
-\item{num_paths}{(positive integer) Number of single pathfinders to run}
+\item{num_paths}{(positive integer) Number of single pathfinders to run.}
 
-\item{max_lbfgs_iters}{(positive integer) The maximum number of iterations for LBFGS}
+\item{max_lbfgs_iters}{(positive integer) The maximum number of iterations
+for LBFGS.}
 
-\item{num_elbo_draws}{(positive integer) Number of draws to make when calculating the ELBO of
-the approximation at each iteration of LBFGS}
+\item{num_elbo_draws}{(positive integer) Number of draws to make when
+calculating the ELBO of the approximation at each iteration of LBFGS.}
 
-\item{save_single_paths}{(logical) Whether to save the results of single pathfinder runs in multi-pathfinder}
+\item{save_single_paths}{(logical) Whether to save the results of single
+pathfinder runs in multi-pathfinder.}
 }
 \value{
 A \code{\link{CmdStanPathfinder}} object.
 }
 \description{
 The \verb{$pathfinder()} method of a \code{\link{CmdStanModel}} object runs
-Stan's Pathfinder algorithms.
-
-Any argument left as \code{NULL} will default to the default value used by the
-installed version of CmdStan. See the
+Stan's Pathfinder algorithms. Pathfinder is a variational method for
+approximately sampling from differentiable log densities. Starting from a
+random initialization, Pathfinder locates normal approximations to the
+target density along a quasi-Newton optimization path, with local
+covariance estimated using the negative inverse Hessian estimates produced
+by the L-BFGS optimizer. Pathfinder returns draws from the Gaussian
+approximation with the lowest estimated Kullback-Leibler (KL) divergence to
+the true posterior. See the
 \href{https://mc-stan.org/docs/cmdstan-guide/}{CmdStan Users Guide}
 for more details.
-}
-\details{
-CmdStan can fit a variational approximation to the posterior. The
-approximation is a Gaussian in the unconstrained variable space. Stan
-implements two variational algorithms. The \code{algorithm=""meanfield""} option
-uses a fully factorized Gaussian for the approximation. The
-\code{algorithm=""fullrank""} option uses a Gaussian with a full-rank covariance
-matrix for the approximation.
-
--- \href{https://github.com/stan-dev/cmdstan/releases/latest}{\emph{CmdStan Interface User's Guide}}
+
+Any argument left as \code{NULL} will default to the default value used by the
+installed version of CmdStan
 }
 \examples{
 \dontrun{
@@ -246,13 +247,15 @@ fit_optim <- mod$optimize(data = my_data_file, jacobian = TRUE)
 fit_laplace <- mod$laplace(data = my_data_file, mode = fit_optim, draws = 2000)
 fit_laplace$summary()
 
-# Run 'variational' method to approximate the posterior (default is meanfield ADVI)
+# Run 'variational' method to use ADVI to approximate posterior
 fit_vb <- mod$variational(data = stan_data, seed = 123)
 fit_vb$summary()
-
-# Plot approximate posterior using bayesplot
 mcmc_hist(fit_vb$draws(""theta""))
 
+# Run 'pathfinder' method, a new alternative to the variational method
+fit_pf <- mod$pathfinder(data = stan_data, seed = 123)
+fit_pf$summary()
+mcmc_hist(fit_pf$draws(""theta""))
 
 # Specifying initial values as a function
 fit_mcmc_w_init_fun <- mod$sample(

---FILE: man/model-method-sample.Rd---
@@ -348,13 +348,15 @@ fit_optim <- mod$optimize(data = my_data_file, jacobian = TRUE)
 fit_laplace <- mod$laplace(data = my_data_file, mode = fit_optim, draws = 2000)
 fit_laplace$summary()
 
-# Run 'variational' method to approximate the posterior (default is meanfield ADVI)
+# Run 'variational' method to use ADVI to approximate posterior
 fit_vb <- mod$variational(data = stan_data, seed = 123)
 fit_vb$summary()
-
-# Plot approximate posterior using bayesplot
 mcmc_hist(fit_vb$draws(""theta""))
 
+# Run 'pathfinder' method, a new alternative to the variational method
+fit_pf <- mod$pathfinder(data = stan_data, seed = 123)
+fit_pf$summary()
+mcmc_hist(fit_pf$draws(""theta""))
 
 # Specifying initial values as a function
 fit_mcmc_w_init_fun <- mod$sample(

---FILE: man/model-method-variational.Rd---
@@ -163,22 +163,17 @@ A \code{\link{CmdStanVB}} object.
 }
 \description{
 The \verb{$variational()} method of a \code{\link{CmdStanModel}} object runs
-Stan's variational Bayes (ADVI) algorithms.
-
-Any argument left as \code{NULL} will default to the default value used by the
-installed version of CmdStan. See the
+Stan's Automatic Differentiation Variational Inference (ADVI) algorithms.
+The approximation is a Gaussian in the unconstrained variable space. Stan
+implements two ADVI algorithms: the \code{algorithm=""meanfield""} option uses a
+fully factorized Gaussian for the approximation; the \code{algorithm=""fullrank""}
+option uses a Gaussian with a full-rank covariance matrix for the
+approximation. See the
 \href{https://mc-stan.org/docs/cmdstan-guide/}{CmdStan Users Guide}
 for more details.
-}
-\details{
-CmdStan can fit a variational approximation to the posterior. The
-approximation is a Gaussian in the unconstrained variable space. Stan
-implements two variational algorithms. The \code{algorithm=""meanfield""} option
-uses a fully factorized Gaussian for the approximation. The
-\code{algorithm=""fullrank""} option uses a Gaussian with a full-rank covariance
-matrix for the approximation.
-
--- \href{https://github.com/stan-dev/cmdstan/releases/latest}{\emph{CmdStan Interface User's Guide}}
+
+Any argument left as \code{NULL} will default to the default value used by the
+installed version of CmdStan.
 }
 \examples{
 \dontrun{
@@ -244,13 +239,15 @@ fit_optim <- mod$optimize(data = my_data_file, jacobian = TRUE)
 fit_laplace <- mod$laplace(data = my_data_file, mode = fit_optim, draws = 2000)
 fit_laplace$summary()
 
-# Run 'variational' method to approximate the posterior (default is meanfield ADVI)
+# Run 'variational' method to use ADVI to approximate posterior
 fit_vb <- mod$variational(data = stan_data, seed = 123)
 fit_vb$summary()
-
-# Plot approximate posterior using bayesplot
 mcmc_hist(fit_vb$draws(""theta""))
 
+# Run 'pathfinder' method, a new alternative to the variational method
+fit_pf <- mod$pathfinder(data = stan_data, seed = 123)
+fit_pf$summary()
+mcmc_hist(fit_pf$draws(""theta""))
 
 # Specifying initial values as a function
 fit_mcmc_w_init_fun <- mod$sample(",True,False,Rendering / Conversion,3
stan-dev,cmdstanr,55fea89340fce30a93ac24031876e12199e3245f,dependabot[bot],49699333+dependabot[bot]@users.noreply.github.com,2023-10-30T18:22:07Z,GitHub,noreply@github.com,2023-10-30T18:22:07Z,"Bump r-lib/actions from 2.6.4 to 2.6.5

Bumps [r-lib/actions](https://github.com/r-lib/actions) from 2.6.4 to 2.6.5.
- [Release notes](https://github.com/r-lib/actions/releases)
- [Commits](https://github.com/r-lib/actions/compare/v2.6.4...v2.6.5)

---
updated-dependencies:
- dependency-name: r-lib/actions
  dependency-type: direct:production
  update-type: version-update:semver-patch
...

Signed-off-by: dependabot[bot] <support@github.com>",.github/workflows/R-CMD-check-wsl.yaml;.github/workflows/R-CMD-check.yaml;.github/workflows/Test-coverage.yaml;.github/workflows/cmdstan-tarball-check.yaml,False,False,False,False,10,10,20,"---FILE: .github/workflows/R-CMD-check-wsl.yaml---
@@ -37,11 +37,11 @@ jobs:
 
       - uses: actions/checkout@v4
 
-      - uses: r-lib/actions/setup-r@v2.6.4
+      - uses: r-lib/actions/setup-r@v2.6.5
         with:
           r-version: 'release'
           rtools-version: '42'
-      - uses: r-lib/actions/setup-pandoc@v2.6.4
+      - uses: r-lib/actions/setup-pandoc@v2.6.5
 
       - name: Query dependencies
         run: |

---FILE: .github/workflows/R-CMD-check.yaml---
@@ -57,11 +57,11 @@ jobs:
           sudo apt-get install -y libcurl4-openssl-dev || true
           sudo apt-get install -y openmpi-bin openmpi-common libopenmpi-dev || true
 
-      - uses: r-lib/actions/setup-r@v2.6.4
+      - uses: r-lib/actions/setup-r@v2.6.5
         with:
           r-version: ${{ matrix.config.r }}
           rtools-version: ${{ matrix.config.rtools }}
-      - uses: r-lib/actions/setup-pandoc@v2.6.4
+      - uses: r-lib/actions/setup-pandoc@v2.6.5
 
       - name: Query dependencies
         run: |

---FILE: .github/workflows/Test-coverage.yaml---
@@ -34,8 +34,8 @@ jobs:
         if: ""!startsWith(github.ref, 'refs/tags/') && github.ref != 'refs/heads/master'""
       - uses: actions/checkout@v4
 
-      - uses: r-lib/actions/setup-r@v2.6.4
-      - uses: r-lib/actions/setup-pandoc@v2.6.4
+      - uses: r-lib/actions/setup-r@v2.6.5
+      - uses: r-lib/actions/setup-pandoc@v2.6.5
 
       - name: Install Ubuntu dependencies
         run: |
@@ -85,12 +85,12 @@ jobs:
     steps:
       - uses: actions/checkout@v4
 
-      - uses: r-lib/actions/setup-r@v2.6.4
+      - uses: r-lib/actions/setup-r@v2.6.5
         with:
           r-version: 'release'
           rtools-version: '42'
 
-      - uses: r-lib/actions/setup-pandoc@v2.6.4
+      - uses: r-lib/actions/setup-pandoc@v2.6.5
 
       - name: Query dependencies
         run: |

---FILE: .github/workflows/cmdstan-tarball-check.yaml---
@@ -40,12 +40,12 @@ jobs:
           sudo apt-get install -y libcurl4-openssl-dev || true
           sudo apt-get install -y openmpi-bin openmpi-common libopenmpi-dev || true
 
-      - uses: r-lib/actions/setup-r@v2.6.4
+      - uses: r-lib/actions/setup-r@v2.6.5
         with:
           r-version: ${{ matrix.config.r }}
           rtools-version: ${{ matrix.config.rtools }}
 
-      - uses: r-lib/actions/setup-pandoc@v2.6.4
+      - uses: r-lib/actions/setup-pandoc@v2.6.5
 
       - name: Query dependencies
         run: |",False,False,Rendering / Conversion,3
stan-dev,cmdstanr,0526f11d657647bc0599c830464b3a55344f882e,Steve Bronder,sbronder@flatironinstitute.org,2023-10-05T15:06:40Z,Steve Bronder,sbronder@flatironinstitute.org,2023-10-05T15:06:40Z,update error message var names,R/args.R;R/model.R;man/model-method-pathfinder.Rd,False,True,True,False,10,5,15,"---FILE: R/args.R---
@@ -939,15 +939,18 @@ validate_pathfinder_args <- function(self) {
   if (!is.null(self$max_lbfgs_iters)) {
     self$iter <- as.integer(self$max_lbfgs_iters)
   }
-  checkmate::assert_integerish(self$num_paths, lower = 1, null.ok = TRUE, len = 1)
+  checkmate::assert_integerish(self$num_paths, lower = 1, null.ok = TRUE,
+                               len = 1)
   if (!is.null(self$num_paths)) {
     self$num_paths <- as.integer(self$num_paths)
   }
-  checkmate::assert_integerish(self$num_draws, lower = 1, null.ok = TRUE, len = 1)
+  checkmate::assert_integerish(self$num_draws, lower = 1, null.ok = TRUE,
+                               len = 1, .var.name = ""single_path_draws"")
   if (!is.null(self$num_draws)) {
     self$num_draws <- as.integer(self$num_draws)
   }
-  checkmate::assert_integerish(self$num_psis_draws, lower = 1, null.ok = TRUE, len = 1)
+  checkmate::assert_integerish(self$num_psis_draws, lower = 1, null.ok = TRUE,
+                               len = 1, .var.name = ""draws"")
   if (!is.null(self$num_psis_draws)) {
     self$num_psis_draws <- as.integer(self$num_psis_draws)
   }

---FILE: R/model.R---
@@ -1861,7 +1861,8 @@ CmdStanModel$set(""public"", name = ""variational"", value = variational)
 #'   approximating the Hessian.
 #' @param single_path_draws (positive integer) Number of draws a single pathfinder should return. The number of draws
 #'   PSIS sampling samples from will be equal to `single_path_draws * num_paths`
-#' @param draws (positive integer) Number of draws to return after performing pareto smooted importance sampling (PSIS)
+#' @param draws (positive integer) Number of draws to return after performing pareto smooted importance sampling (PSIS).
+#'   This must be smaller than `single_path_draws * num_paths`
 #' @param num_paths (positive integer) Number of single pathfinders to run
 #' @param max_lbfgs_iters (positive integer) The maximum number of iterations for LBFGS
 #' @param num_elbo_draws (positive integer) Number of draws to make when calculating the ELBO of

---FILE: man/model-method-pathfinder.Rd---
@@ -148,7 +148,8 @@ approximating the Hessian.}
 \item{single_path_draws}{(positive integer) Number of draws a single pathfinder should return. The number of draws
 PSIS sampling samples from will be equal to \code{single_path_draws * num_paths}}
 
-\item{draws}{(positive integer) Number of draws to return after performing pareto smooted importance sampling (PSIS)}
+\item{draws}{(positive integer) Number of draws to return after performing pareto smooted importance sampling (PSIS).
+This must be smaller than \code{single_path_draws * num_paths}}
 
 \item{num_paths}{(positive integer) Number of single pathfinders to run}
 ",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,7070020b1de2869964187d228b1e8c29bb2c2f66,Steve Bronder,sbronder@flatironinstitute.org,2023-09-25T19:33:05Z,Steve Bronder,sbronder@flatironinstitute.org,2023-09-25T19:33:05Z,Fix argument names to line up with cmdstanpy args,R/args.R;R/fit.R;R/model.R;tests/testthat/test-model-pathfinder.R;tests/testthat/testthat-problems.rds,False,True,True,False,79,68,147,"---FILE: R/args.R---
@@ -514,31 +514,33 @@ PathfinderArgs <- R6::R6Class(
                             tol_rel_grad = NULL,
                             tol_param = NULL,
                             history_size = NULL,
-                            num_psis_draws = NULL,
+                            num_draws = NULL,
                             num_paths = NULL,
                             max_lbfgs_iters = NULL,
-                            num_draws = NULL) {
+                            num_elbo_draws = NULL,
+                            save_single_paths = NULL) {
         self$init_alpha <- init_alpha
         self$tol_obj <- tol_obj
         self$tol_rel_obj <- tol_rel_obj
         self$tol_grad <- tol_grad
         self$tol_rel_grad <- tol_rel_grad
         self$tol_param <- tol_param
         self$history_size <- history_size
-        self$num_psis_draws <- num_psis_draws
+        self$num_draws <- num_draws
         self$num_paths <- num_paths
         self$max_lbfgs_iters <- max_lbfgs_iters
-        self$num_draws <- num_draws
+        self$num_elbo_draws <- num_elbo_draws
+        self$save_single_paths <- save_single_paths
       invisible(self)
     },
 
     validate = function(num_procs) {
       validate_pathfinder_args(self)
     },
 
-    # Compose arguments to CmdStan command for variational-specific
+    # Compose arguments to CmdStan command for pathfinder-specific
     # non-default arguments. Works the same way as compose for sampler args,
-    # but `idx` is ignored (no multiple chains for optimize or variational)
+    # but `idx` (multiple pathfinders are handled in cmdstan)
     compose = function(idx = NULL, args = NULL) {
       .make_arg <- function(arg_name) {
         compose_arg(self, arg_name, idx = NULL)
@@ -552,10 +554,11 @@ PathfinderArgs <- R6::R6Class(
           .make_arg(""tol_rel_grad""),
           .make_arg(""tol_param""),
           .make_arg(""history_size""),
-          .make_arg(""num_psis_draws""),
+          .make_arg(""num_draws""),
           .make_arg(""num_paths""),
           .make_arg(""max_lbfgs_iters""),
-          .make_arg(""num_draws"")
+          .make_arg(""num_elbo_draws""),
+          .make_arg(""save_single_paths"")
         )
       new_args <- do.call(c, new_args)
       c(args, new_args)
@@ -867,14 +870,22 @@ validate_pathfinder_args <- function(self) {
   if (!is.null(self$num_paths)) {
     self$num_paths <- as.integer(self$num_paths)
   }
-  checkmate::assert_integerish(self$num_psis_draws, lower = 1, null.ok = TRUE, len = 1)
-  if (!is.null(self$num_psis_draws)) {
-    self$num_psis_draws <- as.integer(self$num_psis_draws)
-  }
   checkmate::assert_integerish(self$num_draws, lower = 1, null.ok = TRUE, len = 1)
   if (!is.null(self$num_draws)) {
     self$num_draws <- as.integer(self$num_draws)
   }
+  checkmate::assert_integerish(self$num_elbo_draws, lower = 1, null.ok = TRUE, len = 1)
+  if (!is.null(self$num_elbo_draws)) {
+    self$num_elbo_draws <- as.integer(self$num_elbo_draws)
+  }
+  if (!is.null(self$save_single_paths) && is.logical(self$save_single_paths)) {
+    self$save_single_paths = as.integer(self$save_single_paths)
+  }
+  checkmate::assert_integerish(self$save_single_paths, null.ok = TRUE,
+                               lower = 0, upper = 1, len = 1)
+  if (!is.null(self$save_single_paths)) {
+    self$save_single_paths <- 0
+  }
 
 
   # check args only available for lbfgs and bfgs

---FILE: R/fit.R---
@@ -1959,7 +1959,7 @@ CmdStanVB$set(""public"", name = ""lp_approx"", value = lp_approx)
 #'  |:----------|:---------------|
 #'  [`$draws()`][fit-method-draws]  |  Return approximate posterior draws as a [`draws_matrix`][posterior::draws_matrix]. |
 #'  [`$lp()`][fit-method-lp]  |  Return the total log probability density (`target`) computed in the model block of the Stan program. |
-#'  [`$lp_approx()`][fit-method-lp]  |  Return the log density of the variational approximation to the posterior. |
+#'  [`$lp_approx()`][fit-method-lp]  |  Return the log density of the approximation to the posterior. |
 #'  [`$init()`][fit-method-init] |  Return user-specified initial values. |
 #'  [`$metadata()`][fit-method-metadata] | Return a list of metadata gathered from the CmdStan CSV files. |
 #'  [`$code()`][fit-method-code] | Return Stan code as a character vector. |

---FILE: R/model.R---
@@ -1677,29 +1677,25 @@ CmdStanModel$set(""public"", name = ""variational"", value = variational)
 #'   -- [*CmdStan Interface User's Guide*](https://github.com/stan-dev/cmdstan/releases/latest)
 #'
 #' @template model-common-args
-#' @param threads (positive integer) If the model was
+#' @param num_threads (positive integer) If the model was
 #'   [compiled][model-method-compile] with threading support, the number of
-#'   threads to use in parallelized sections (e.g., when using the Stan
-#'   functions `reduce_sum()` or `map_rect()`).
-#' @param algorithm (string) The algorithm. Either `""meanfield""` or
-#'   `""fullrank""`.
-#' @param iter (positive integer) The _maximum_ number of iterations.
-#' @param grad_samples (positive integer) The number of samples for Monte Carlo
-#'   estimate of gradients.
-#' @param elbo_samples (positive integer) The number of samples for Monte Carlo
-#'   estimate of ELBO (objective function).
-#' @param eta (positive real) The step size weighting parameter for adaptive
-#'   step size sequence.
-#' @param adapt_engaged (logical) Do warmup adaptation?
-#' @param adapt_iter (positive integer) The _maximum_ number of adaptation
-#'   iterations.
-#' @param tol_rel_obj (positive real) Convergence tolerance on the relative norm
-#'   of the objective.
-#' @param eval_elbo (positive integer) Evaluate ELBO every Nth iteration.
-#' @param output_samples (positive integer) Number of approximate posterior
-#'   samples to draw and save.
-#'
-#' @return A [`CmdStanVB`] object.
+#'   threads to use in parallelized sections (e.g., for multi-path pathfinder
+#'   as well as `reduce_sum`)
+#' @param init_alpha (positive real) The initial step size parameter.
+#' @param tol_obj (positive real) Convergence tolerance on changes in objective function value.
+#' @param tol_rel_obj (positive real) Convergence tolerance on relative changes in objective function value.
+#' @param tol_grad (positive real) Convergence tolerance on the norm of the gradient.
+#' @param tol_rel_grad (positive real) Convergence tolerance on the relative norm of the gradient.
+#' @param tol_param (positive real) Convergence tolerance on changes in parameter value.
+#' @param history_size (positive integer) The size of the history used when
+#'   approximating the Hessian.
+#' @param num_draws (positive integer) Number of draws to return after performing pareto smooted importance sampling (PSIS)
+#' @param num_paths (positive integer) Number of single pathfinders to run
+#' @param max_lbfgs_iters (positive integer) The maximum number of iterations for LBFGS
+#' @param num_elbo_draws (positive integer) Number of draws to make when calculating the ELBO of
+#'   the approximation at each iteration of LBFGS
+#' @param save_single_paths (logical) Whether to save the results of single pathfinder runs in multi-pathfinder
+#' @return A [`CmdStanPathfinder`] object.
 #'
 #' @template seealso-docs
 #' @inherit cmdstan_model examples
@@ -1712,7 +1708,6 @@ pathfinder <- function(data = NULL,
                         output_dir = NULL,
                         output_basename = NULL,
                         sig_figs = NULL,
-                        threads = NULL,
                         opencl_ids = NULL,
                         num_threads = NULL,
                        init_alpha = NULL,
@@ -1722,14 +1717,15 @@ pathfinder <- function(data = NULL,
                        tol_rel_grad = NULL,
                        tol_param = NULL,
                        history_size = NULL,
-                       num_psis_draws = NULL,
+                       num_draws = NULL,
                        num_paths = NULL,
                        max_lbfgs_iters = NULL,
-                       num_draws = NULL) {
+                       num_elbo_draws = NULL,
+                       save_single_paths = NULL) {
   procs <- CmdStanProcs$new(
     num_procs = 1,
     show_stdout_messages = (is.null(refresh) || refresh != 0),
-    threads_per_proc = assert_valid_threads(threads, self$cpp_options())
+    threads_per_proc = assert_valid_threads(num_threads, self$cpp_options())
   )
   model_variables <- NULL
   if (is_variables_method_supported(self)) {
@@ -1743,10 +1739,11 @@ pathfinder <- function(data = NULL,
    tol_rel_grad =    tol_rel_grad,
    tol_param =    tol_param,
    history_size =    history_size,
-   num_psis_draws =    num_psis_draws,
+   num_draws =    num_draws,
    num_paths =    num_paths,
    max_lbfgs_iters =    max_lbfgs_iters,
-    num_draws = num_draws)
+    num_elbo_draws = num_elbo_draws,
+   save_single_paths = save_single_paths)
   args <- CmdStanArgs$new(
     method_args = pathfinder_args,
     stan_file = self$stan_file(),

---FILE: tests/testthat/test-model-pathfinder.R---
@@ -25,10 +25,11 @@ ok_arg_values <- list(
   tol_rel_grad = 1e-12,
   tol_param = 1e-12,
   history_size = 5,
-  num_psis_draws = 100,
+  num_elbo_draws = 10,
+  num_draws = 100,
   num_paths = 4,
   max_lbfgs_iters = 100,
-  num_draws = 100)
+  save_single_paths = FALSE)
 
 # using any one of these should cause sample() to error
 bad_arg_values <- list(
@@ -38,16 +39,17 @@ bad_arg_values <- list(
   init = ""maybe :P"",
   seed = -80,
   init_alpha = ""cat.jpeg"",
+  init_alpha = -3,
   tol_obj = -1,
-  tol_rel_obj = -1,
-  tol_grad = -1,
-  tol_rel_grad = -1,
-  tol_param = -1,
-  history_size = -2,
-  num_psis_draws = ""no thanks"",
+  tol_rel_obj = -4,
+  tol_grad = -5,
+  tol_rel_grad = -9,
+  tol_param = -2,
+  history_size = -6,
+  num_elbo_draws = -8,
+  num_draws = ""no thanks"",
   num_paths = -1,
-  max_lbfgs_iters = ""idk :/"",
-  num_draws = -1
+  max_lbfgs_iters = ""idk :/""
 )
 
 bad_arg_values_2 <- list(
@@ -56,35 +58,36 @@ bad_arg_values_2 <- list(
   refresh = -1,
   init = ""maybe :P"",
   seed = -80,
-  init_alpha = -1,
+  init_alpha = -3,
   tol_obj = -1,
-  tol_rel_obj = -1,
-  tol_grad = -1,
-  tol_rel_grad = -1,
-  tol_param = -1,
-  history_size = -2,
-  num_psis_draws = ""no thanks"",
+  tol_rel_obj = -4,
+  tol_grad = -5,
+  tol_rel_grad = -9,
+  tol_param = -2,
+  history_size = -6,
+  num_elbo_draws = -8,
+  num_draws = ""no thanks"",
   num_paths = -1,
   max_lbfgs_iters = ""idk :/"",
-  num_draws = -1
+  save_single_paths = ""Mby""
 )
 
 bad_arg_values_3 <- list(
   data = matrix(1:10),
   output_dir = 8,
   init = ""maybe :P"",
   seed = -80,
-  init_alpha = -1,
+  init_alpha = -3,
   tol_obj = -1,
-  tol_rel_obj = -1,
-  tol_grad = -1,
-  tol_rel_grad = -1,
-  tol_param = -1,
-  history_size = -2,
-  num_psis_draws = ""no thanks"",
+  tol_rel_obj = -4,
+  tol_grad = -5,
+  tol_rel_grad = -9,
+  tol_param = -2,
+  history_size = -6,
+  num_elbo_draws = -8,
+  num_draws = ""no thanks"",
   num_paths = ""NO!"",
-  max_lbfgs_iters = ""idk :/"",
-  num_draws = -1
+  max_lbfgs_iters = ""idk :/""
 )
 expect_pathfinder_output <- function(object, num_chains = NULL) {
   expect_output(object, regexp = ""Finished in (.*) seconds."")",True,False,File I/O and Export,6
stan-dev,cmdstanr,50616d0d070913c2112ac12b5b3f2a312f41107e,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-09-25T15:37:54Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-09-25T15:37:54Z,Fix dim check,R/args.R,False,True,True,False,1,1,2,"---FILE: R/args.R---
@@ -829,7 +829,7 @@ process_init_list <- function(init, num_procs, model_variables = NULL) {
       for (par_name in parameter_names[is_parameter_value_supplied]) {
         # Make sure that initial values for single-element containers don't get
         # unboxed when writing to JSON
-        if (model_variables$parameters[[par_name]]$dimensions == 1 && is.null(attr(init[[i]][[par_name]], ""dim""))) {
+        if (model_variables$parameters[[par_name]]$dimensions == 1 && length(init[[i]][[par_name]]) == 1) {
           init[[i]][[par_name]] <- array(init[[i]][[par_name]], dim = 1)
         }
       }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,1a0a97d75847cb12e8a0fe098a78ad4d8422b59e,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-09-25T09:08:04Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-09-25T09:08:04Z,Fix non-WSL asserts,R/utils.R,False,True,True,False,3,3,6,"---FILE: R/utils.R---
@@ -596,7 +596,7 @@ wsl_tempdir <- function() {
 # network path as legitimate, and will always error. To avoid this we create a
 # new checking functions with WSL handling, and then pass these to
 # checkmate::makeAssertionFunction to replicate the existing assertion functionality
-check_dir_exists <- function(dir, access = NULL) {
+check_dir_exists <- function(dir, access = """") {
   if (os_is_wsl()) {
     if (!checkmate::qtest(dir, ""S+"")) {
       return(""No directory provided."")
@@ -612,7 +612,7 @@ check_dir_exists <- function(dir, access = NULL) {
   }
 }
 
-check_file_exists <- function(files, access = NULL, ...) {
+check_file_exists <- function(files, access = """", ...) {
   if (os_is_wsl()) {
     if (!checkmate::qtest(files, ""S+"")) {
       return(""No file provided."")
@@ -628,7 +628,7 @@ check_file_exists <- function(files, access = NULL, ...) {
   }
 }
 
-.wsl_check_exists <- function(path, is_dir = TRUE, access = NULL) {
+.wsl_check_exists <- function(path, is_dir = TRUE, access = """") {
   path_check <- processx::run(
     command = ""wsl"",
     args = c(""ls"", ""-la"", wsl_safe_path(path)),",True,False,Implementation / Logic,6
stan-dev,cmdstanr,c190c5d473c976f0d4726ca5f42a262903f42f52,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-09-25T09:01:52Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-09-25T09:01:52Z,Fix handling of single-length inits for containers,R/args.R;tests/testthat/test-model-init.R,False,True,True,False,29,0,29,"---FILE: R/args.R---
@@ -826,6 +826,13 @@ process_init_list <- function(init, num_procs, model_variables = NULL) {
       if (!all(is_parameter_value_supplied)) {
         missing_parameter_values[[i]] <- parameter_names[!is_parameter_value_supplied]
       }
+      for (par_name in parameter_names[is_parameter_value_supplied]) {
+        # Make sure that initial values for single-element containers don't get
+        # unboxed when writing to JSON
+        if (model_variables$parameters[[par_name]]$dimensions == 1 && is.null(attr(init[[i]][[par_name]], ""dim""))) {
+          init[[i]][[par_name]] <- array(init[[i]][[par_name]], dim = 1)
+        }
+      }
     }
     if (length(missing_parameter_values) > 0) {
       warning_message <- c(

---FILE: tests/testthat/test-model-init.R---
@@ -262,3 +262,25 @@ test_that(""print message if not all parameters are initialized"", {
     fixed = TRUE
   )
 })
+
+test_that(""Initial values for single-element containers treated correctly"", {
+  modcode <- ""
+  data {
+    real y_mean;
+  }
+  parameters {
+    vector[1] y;
+  }
+  model {
+    y_mean ~ normal(y[1], 1);
+  }
+  ""
+  mod <- cmdstan_model(write_stan_file(modcode), force_recompile = TRUE)
+  expect_no_error(
+    fit <- mod$sample(
+      data = list(y_mean = 0),
+      init = list(list(y = c(0))),
+      chains = 1
+    )
+  )
+})",True,False,Implementation / Logic,6
stan-dev,cmdstanr,8707a0424e14956d3743acaf979c3a1db3dcaeb3,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-09-12T17:31:13Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-09-12T17:31:13Z,More test fixes,tests/testthat/test-fit-mle.R;tests/testthat/test-model-compile.R,False,True,True,False,9,16,25,"---FILE: tests/testthat/test-fit-mle.R---
@@ -53,7 +53,7 @@ test_that(""time is reported after optimization"", {
 
 test_that(""no error when checking estimates after failure"", {
   fit <- cmdstanr_example(""schools"", method = ""optimize"", seed = 123) # optim lways fails for this
-  expect_silent(fit$summary(include_failed = TRUE)) # no error
+  expect_error(fit$summary(), ""Fitting failed. Unable to retrieve the draws."")
 })
 
 test_that(""draws() works for different formats"", {

---FILE: tests/testthat/test-model-compile.R---
@@ -278,7 +278,7 @@ test_that(""compile() works with pedantic=TRUE"", {
   }
   "")
   expect_message(
-    mod_pedantic_warn <- cmdstan_model(stan_file, pedantic = TRUE),
+    mod_pedantic_warn <- cmdstan_model(stan_file, pedantic = TRUE, force_recompile = TRUE),
     ""The parameter x was declared but was not used"",
     fixed = TRUE
   )
@@ -387,13 +387,10 @@ test_that(""check_syntax() works with pedantic=TRUE"", {
     fixed = TRUE
   )
 
-  expect_output(
-    expect_message(
-      mod_pedantic_warn$check_syntax(pedantic = TRUE),
-      ""The parameter x was declared but was not used"",
-      fixed = TRUE
-    ),
-    regexp = NA
+  expect_message(
+    mod_pedantic_warn$check_syntax(pedantic = TRUE),
+    ""The parameter x was declared but was not used"",
+    fixed = TRUE
   )
 })
 
@@ -706,13 +703,9 @@ test_that(""format() works"", {
     ""target += normal_lpdf(y | 0, 1);"",
     fixed = TRUE
   )
-  expect_output(
-    expect_message(
-      mod_1$format(canonicalize = list(""includes"")),
-      ""is deprecated"",
-      fixed = TRUE
-    ),
-    ""target += normal_log(y, 0, 1);"",
+  expect_error(
+    mod_1$format(),
+    ""Syntax error found! See the message above for more information."",
     fixed = TRUE
   )
 ",True,False,Implementation / Logic,6
stan-dev,cmdstanr,66a3b58e64a9523bf68de05b7c73cb4421a62cfd,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-09-12T15:46:47Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-09-12T15:46:47Z,Additional test fixes,tests/testthat/test-fit-mle.R;tests/testthat/test-model-compile.R,False,True,True,False,8,12,20,"---FILE: tests/testthat/test-fit-mle.R---
@@ -53,7 +53,7 @@ test_that(""time is reported after optimization"", {
 
 test_that(""no error when checking estimates after failure"", {
   fit <- cmdstanr_example(""schools"", method = ""optimize"", seed = 123) # optim lways fails for this
-  expect_silent(fit$summary()) # no error
+  expect_silent(fit$summary(include_failed = TRUE)) # no error
 })
 
 test_that(""draws() works for different formats"", {

---FILE: tests/testthat/test-model-compile.R---
@@ -424,14 +424,14 @@ test_that(""check_syntax() works with pedantic=TRUE"", {
   ""
   stan_file <- write_stan_file(model_code)
   mod_dep_warning <- cmdstan_model(stan_file, compile = FALSE)
-  expect_message(
+  expect_error(
     mod_dep_warning$compile(),
-    ""deprecated in the Stan language"",
+    ""An error occured during compilation! See the message above for more information."",
     fixed = TRUE
   )
-  expect_message(
+  expect_error(
     mod_dep_warning$check_syntax(),
-    ""deprecated in the Stan language"",
+    ""Syntax error found! See the message above for more information."",
     fixed = TRUE
   )
 })
@@ -690,13 +690,9 @@ test_that(""format() works"", {
   stan_file_tmp <- write_stan_file(code)
   mod_1 <- cmdstan_model(stan_file_tmp, compile = FALSE)
 
-  expect_output(
-    expect_message(
-      mod_1$format(),
-      ""is deprecated"",
-      fixed = TRUE
-    ),
-    ""target += normal_log(y, 0, 1);"",
+  expect_error(
+    mod_1$format(),
+    ""Syntax error found! See the message above for more information."",
     fixed = TRUE
   )
 ",True,False,Rendering / Conversion,3
stan-dev,cmdstanr,b3025976057708e9885e8b05321ddb35f841e665,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-09-11T10:58:25Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-09-11T10:58:25Z,Fix exposing functions under 2.33+,R/utils.R;tests/testthat/test-model-expose-functions.R,False,True,True,False,19,3,22,"---FILE: R/utils.R---
@@ -816,7 +816,20 @@ get_standalone_hpp <- function(stan_file, stancflags) {
 
 get_function_name <- function(fun_start, fun_end, model_lines) {
   fun_string <- paste(model_lines[(fun_start+1):fun_end], collapse = "" "")
-  fun_name <- gsub(""auto "", """", fun_string, fixed = TRUE)
+  types <- c(
+    ""auto"",
+    ""int"",
+    ""double"",
+    ""Eigen::Matrix<(.*)>"",
+    ""std::vector<(.*)>""
+  )
+  pattern <- paste0(
+    # Only match if the type occurs at start of string
+    ""^(\\s*)?("",
+    paste0(types, collapse=""|""),
+    # Only match if type followed by a function name and opening bracket
+    "")\\s*(?=\\w*\\()"")
+  fun_name <- gsub(pattern, """", fun_string, perl = TRUE)
   sub(""\\(.*"", """", fun_name, perl = TRUE)
 }
 
@@ -864,7 +877,9 @@ get_plain_rtn <- function(fun_start, fun_end, model_lines) {
 #     that instantiates an RNG
 prep_fun_cpp <- function(fun_start, fun_end, model_lines) {
   fun_body <- paste(model_lines[fun_start:fun_end], collapse = "" "")
-  fun_body <- gsub(""auto"", get_plain_rtn(fun_start, fun_end, model_lines), fun_body)
+  if (cmdstan_version() < ""2.33"") {
+    fun_body <- gsub(""auto"", get_plain_rtn(fun_start, fun_end, model_lines), fun_body)
+  }
   fun_body <- gsub(""// [[stan::function]]"", ""// [[Rcpp::export]]\n"", fun_body, fixed = TRUE)
   fun_body <- gsub(""std::ostream\\*\\s*pstream__\\s*=\\s*nullptr"", """", fun_body)
   fun_body <- gsub(""boost::ecuyer1988&\\s*base_rng__"", ""SEXP base_rng_ptr"", fun_body)

---FILE: tests/testthat/test-model-expose-functions.R---
@@ -192,7 +192,8 @@ test_that(""Exposing functions with precompiled model gives meaningful error"", {
     parameters { real x; }
     model { x ~ std_normal(); }
   "")
-  mod1 <- cmdstan_model(stan_file, compile_standalone = TRUE)
+  mod1 <- cmdstan_model(stan_file, compile_standalone = TRUE,
+                        force_recompile = TRUE)
   expect_equal(7.5, mod1$functions$a_plus_b(5, 2.5))
 
   mod2 <- cmdstan_model(stan_file)",True,False,Implementation / Logic,3
stan-dev,cmdstanr,0b2c3be70788f85fff3ccdfc47d2ddf50aeac9d5,jgabry,jgabry@gmail.com,2023-09-06T22:14:59Z,jgabry,jgabry@gmail.com,2023-09-06T22:14:59Z,also fix deprecations vignette,vignettes/deprecations.Rmd,True,False,True,False,3,15,18,"---FILE: vignettes/deprecations.Rmd---
@@ -46,7 +46,7 @@ data {
   int<lower=1> k;
   int<lower=0> n;
   matrix[n, k] X;
-  int y[n];
+  array[n] int y;
 }
 parameters {
   vector[k] beta;
@@ -64,22 +64,10 @@ mod <- cmdstan_model(stan_file)
 ```
 
 
-The first warning is about using the deprecated array syntax
-
-```
-int y[n];
-```
-
-which should be replaced with the new syntax using the `array` keyword:
-
-```
-array[n] int y;
-```
-
-The second warning is about using the deprecated commenting symbol `#`,
+The first warning is about using the deprecated commenting symbol `#`,
 which should be replaced by `//`.
 
-The last warning is about the use of the deprecated `_log` suffix for
+The second warning is about the use of the deprecated `_log` suffix for
 probability density and mass functions. In this case the `_log` suffix should be
 replaced with `_lpdf`. For probability mass functions the suffix `_lpmf` is
 used.",False,True,Documentation / Formatting,4
stan-dev,cmdstanr,b7ca3cfb85c5978531012fecfb5df4aef9848e7e,Steve Bronder,sbronder@flatironinstitute.org,2023-08-30T22:02:18Z,Steve Bronder,sbronder@flatironinstitute.org,2023-08-30T22:02:18Z,fix lp_approx__ thing,R/args.R;R/csv.R;R/model.R;tests/testthat/test-model-pathfinder.R,False,True,True,False,59,71,130,"---FILE: R/args.R---
@@ -514,28 +514,23 @@ PathfinderArgs <- R6::R6Class(
                             tol_rel_grad = NULL,
                             tol_param = NULL,
                             history_size = NULL,
-                            algorithm = NULL,
-                            iter = NULL,
-                            save_iterations = NULL,
-                            num_elbo_draws = NULL,
-                            num_draws = NULL,
-                            num_eval_attempts = NULL,
-                            psis_draws = NULL, num_paths = NULL) {
+                            num_psis_draws = NULL,
+                            num_paths = NULL,
+                            save_single_paths = NULL,
+                            max_lbfgs_iters = NULL,
+                            num_draws = NULL) {
         self$init_alpha <- init_alpha
         self$tol_obj <- tol_obj
         self$tol_rel_obj <- tol_rel_obj
         self$tol_grad <- tol_grad
         self$tol_rel_grad <- tol_rel_grad
         self$tol_param <- tol_param
         self$history_size <- history_size
-        self$algorithm <- algorithm
-        self$iter <- iter
-        self$save_iterations <- save_iterations
-        self$num_elbo_draws <- num_elbo_draws
-        self$num_eval_attempts <- num_eval_attempts
-        self$num_draws <- num_draws
-        self$psis_draws <- psis_draws
+        self$num_psis_draws <- num_psis_draws
         self$num_paths <- num_paths
+        self$save_single_paths <- save_single_paths
+        self$max_lbfgs_iters <- max_lbfgs_iters
+        self$num_draws <- num_draws
       invisible(self)
     },
 
@@ -550,43 +545,21 @@ PathfinderArgs <- R6::R6Class(
       .make_arg <- function(arg_name) {
         compose_arg(self, arg_name, idx = NULL)
       }
-      if (self$algorithm == ""single"") {
         new_args <- list(
           ""method=pathfinder"",
-          .make_arg(""num_eval_attempts""),
           .make_arg(""init_alpha""),
           .make_arg(""tol_obj""),
           .make_arg(""tol_rel_obj""),
           .make_arg(""tol_grad""),
           .make_arg(""tol_rel_grad""),
           .make_arg(""tol_param""),
           .make_arg(""history_size""),
-          .make_arg(""iter""),
-          .make_arg(""save_iterations""),
-          .make_arg(""num_elbo_draws""),
-          .make_arg(""num_draws"")
-        )
-      # default of multi
-      } else {#if (self$algorithm == ""multi"") {
-        new_args <- list(
-          ""method=pathfinder"",
-          .make_arg(""num_eval_attempts""),
-          ""algorithm=multi"",
-          .make_arg(""psis_draws""),
+          .make_arg(""num_psis_draws""),
           .make_arg(""num_paths""),
-          .make_arg(""init_alpha""),
-          .make_arg(""tol_obj""),
-          .make_arg(""tol_rel_obj""),
-          .make_arg(""tol_grad""),
-          .make_arg(""tol_rel_grad""),
-          .make_arg(""tol_param""),
-          .make_arg(""history_size""),
-          .make_arg(""iter""),
-          .make_arg(""save_iterations""),
-          .make_arg(""num_elbo_draws""),
+          .make_arg(""save_single_paths""),
+          .make_arg(""max_lbfgs_iters""),
           .make_arg(""num_draws"")
         )
-      }
       new_args <- do.call(c, new_args)
       c(args, new_args)
     }

---FILE: R/csv.R---
@@ -279,6 +279,9 @@ read_cmdstan_csv <- function(files,
     if (length(variables) > 0) {
       draws_list_id <- length(draws) + 1
       warmup_draws_list_id <- length(warmup_draws) + 1
+      if (metadata$method == ""pathfinder"") {
+        variables = union(metadata$sampler_diagnostics, metadata$variables)
+      }
       suppressWarnings(
         draws[[draws_list_id]] <- data.table::fread(
           cmd = fread_cmd,
@@ -613,7 +616,6 @@ read_csv_metadata <- function(csv_file) {
   warmup_time <- 0
   sampling_time <- 0
   total_time <- 0
-  #browser()
   if (os_is_windows()) {
     grep_path_repaired <- withr::with_path(
       c(

---FILE: R/model.R---
@@ -1625,7 +1625,7 @@ variational <- function(data = NULL,
 CmdStanModel$set(""public"", name = ""variational"", value = variational)
 
 
-#' Run Stan's variational approximation algorithms
+#' Run Stan's Pathfinder Variational Inference Algorithm
 #'
 #' @name model-method-pathfinder
 #' @aliases pathfinder
@@ -1687,21 +1687,18 @@ pathfinder <- function(data = NULL,
                         threads = NULL,
                         opencl_ids = NULL,
                         num_threads = NULL,
-                        init_alpha = NULL,
-                        tol_obj = NULL,
-                        tol_rel_obj = NULL,
-                        tol_grad = NULL,
-                        tol_rel_grad = NULL,
-                        tol_param = NULL,
-                        history_size = NULL,
-                        algorithm = NULL,
-                        iter = NULL,
-                        save_iterations = NULL,
-                        num_elbo_draws = NULL,
-                        num_draws = NULL,
-                        num_eval_attempts = NULL,
-                        psis_draws = NULL,
-                        num_paths = NULL) {
+                       init_alpha = NULL,
+                       tol_obj = NULL,
+                       tol_rel_obj = NULL,
+                       tol_grad = NULL,
+                       tol_rel_grad = NULL,
+                       tol_param = NULL,
+                       history_size = NULL,
+                       num_psis_draws = NULL,
+                       num_paths = NULL,
+                       save_single_paths = NULL,
+                       max_lbfgs_iters = NULL,
+                       num_draws = NULL) {
   procs <- CmdStanProcs$new(
     num_procs = 1,
     show_stdout_messages = (is.null(refresh) || refresh != 0),
@@ -1712,21 +1709,18 @@ pathfinder <- function(data = NULL,
     model_variables <- self$variables()
   }
   pathfinder_args <- PathfinderArgs$new(
-    init_alpha = init_alpha,
-    tol_obj = tol_obj,
-    tol_rel_obj = tol_rel_obj,
-    tol_grad = tol_grad,
-    tol_rel_grad = tol_rel_grad,
-    tol_param = tol_param,
-    history_size = history_size,
-    algorithm = algorithm,
-    iter = iter,
-    save_iterations = save_iterations,
-    num_elbo_draws = num_elbo_draws,
-    num_draws = num_draws,
-    num_eval_attempts = num_eval_attempts,
-    psis_draws = psis_draws,
-    num_paths = num_paths)
+   init_alpha =   init_alpha,
+   tol_obj =    tol_obj,
+   tol_rel_obj =    tol_rel_obj,
+   tol_grad =    tol_grad,
+   tol_rel_grad =    tol_rel_grad,
+   tol_param =    tol_param,
+   history_size =    history_size,
+   num_psis_draws =    num_psis_draws,
+   num_paths =    num_paths,
+   save_single_paths =    save_single_paths,
+   max_lbfgs_iters =    max_lbfgs_iters,
+    num_draws = num_draws)
   args <- CmdStanArgs$new(
     method_args = pathfinder_args,
     stan_file = self$stan_file(),

---FILE: tests/testthat/test-model-pathfinder.R---
@@ -0,0 +1,19 @@
+context(""model-sample"")
+
+set_cmdstan_path()
+stan_program <- testing_stan_file(""bernoulli"")
+mod <- testing_model(""bernoulli"")
+stan_program_fp <- testing_stan_file(""bernoulli_fp"")
+mod_fp <- testing_model(""bernoulli_fp"")
+
+# valid ways to supply data
+data_list <- testing_data(""bernoulli"")
+data_file_r <- test_path(""resources"", ""data"", ""bernoulli.data.R"")
+data_file_json <- test_path(""resources"", ""data"", ""bernoulli.data.json"")
+
+test_that(""Pathfinder Runs"", {
+  fit <- mod$pathfinder(data=data_list, seed=1234, refresh = 1, sig_figs = 15, tol_obj = 0, tol_rel_grad = 0)
+  fit$summary()
+  fit_samp = mod$sample(data = data_list)
+  fit_samp$summary()
+})",True,False,Implementation / Logic,6
stan-dev,cmdstanr,444a5e4e7b5e104c3c7f8bc7ff53833246bc9f71,jgabry,jgabry@gmail.com,2023-08-28T20:36:27Z,jgabry,jgabry@gmail.com,2023-08-28T20:36:27Z,minor vignette fix,docs/articles/cmdstanr.html;vignettes/cmdstanr.Rmd,True,False,True,False,81,80,161,"---FILE: docs/articles/cmdstanr.html---
@@ -26,7 +26,7 @@
 <![endif]-->
 </head>
 <body data-spy=""scroll"" data-target=""#toc"">
-    
+
 
     <div class=""container template-article"">
       <header><div class=""navbar navbar-default navbar-fixed-top"" role=""navigation"">
@@ -49,7 +49,7 @@
 <li>
   <a href=""../index.html"">
     <span class=""fa fa-home fa-lg""></span>
-     
+
   </a>
 </li>
 <li>
@@ -64,7 +64,7 @@
 <li class=""dropdown"">
   <a href=""#"" class=""dropdown-toggle"" data-toggle=""dropdown"" role=""button"" data-bs-toggle=""dropdown"" aria-expanded=""false"">
     Other Packages
-     
+
     <span class=""caret""></span>
   </a>
   <ul class=""dropdown-menu"" role=""menu"">
@@ -102,19 +102,19 @@
 <li>
   <a href=""https://twitter.com/mcmc_stan"" class=""external-link"">
     <span class=""fa fa-twitter""></span>
-     
+
   </a>
 </li>
 <li>
   <a href=""https://github.com/stan-dev/cmdstanr"" class=""external-link"">
     <span class=""fa fa-github""></span>
-     
+
   </a>
 </li>
 <li>
   <a href=""https://discourse.mc-stan.org/"" class=""external-link"">
     <span class=""fa fa-users""></span>
-     
+
   </a>
 </li>
       </ul>
@@ -125,38 +125,39 @@
 </div>
 <!--/.navbar -->
 
-      
+
 
       </header><div class=""row"">
   <div class=""col-md-9 contents"">
     <div class=""page-header toc-ignore"">
       <h1 data-toc-skip>Getting started with CmdStanR</h1>
                         <h4 data-toc-skip class=""author"">Jonah Gabry and
 Rok enovar</h4>
-            
-      
+
+
       <small class=""dont-index"">Source: <a href=""https://github.com/stan-dev/cmdstanr/blob/HEAD/vignettes/cmdstanr.Rmd"" class=""external-link""><code>vignettes/cmdstanr.Rmd</code></a></small>
       <div class=""hidden name""><code>cmdstanr.Rmd</code></div>
 
     </div>
 
-    
-    
+
+
 <div class=""section level2"">
 <h2 id=""introduction"">Introduction<a class=""anchor"" aria-label=""anchor"" href=""#introduction""></a>
 </h2>
 <p>CmdStanR (Command Stan R) is a lightweight interface to <a href=""https://mc-stan.org/"" class=""external-link"">Stan</a> for R users that provides an
 alternative to the traditional <a href=""https://mc-stan.org/rstan/"" class=""external-link"">RStan</a> interface. See the <a href=""#comparison-with-rstan""><em>Comparison with RStan</em></a> section
 later in this vignette for more details on how the two interfaces
 differ.</p>
-<p><strong>CmdStanR is not on CRAN yet</strong>, but the beta release
-can be installed by running the following command in R.</p>
+<p>Using CmdStanR requires installing the <strong>cmdstanr</strong> R
+package and also CmdStan, the command line interface to Stan. First we
+install the R package by running the following command in R.</p>
 <div class=""sourceCode"" id=""cb1""><pre class=""downlit sourceCode r"">
 <code class=""sourceCode R""><span><span class=""co""># we recommend running this is a fresh R session or restarting your current session</span></span>
 <span><span class=""fu""><a href=""https://rdrr.io/r/utils/install.packages.html"" class=""external-link"">install.packages</a></span><span class=""op"">(</span><span class=""st"">""cmdstanr""</span>, repos <span class=""op"">=</span> <span class=""fu""><a href=""https://rdrr.io/r/base/c.html"" class=""external-link"">c</a></span><span class=""op"">(</span><span class=""st"">""https://mc-stan.org/r-packages/""</span>, <span class=""fu""><a href=""https://rdrr.io/r/base/options.html"" class=""external-link"">getOption</a></span><span class=""op"">(</span><span class=""st"">""repos""</span><span class=""op"">)</span><span class=""op"">)</span><span class=""op"">)</span></span></code></pre></div>
-<p>CmdStanR (the <strong>cmdstanr</strong> R package) can now be loaded
-like any other R package. Well also load the <strong>bayesplot</strong>
-and <strong>posterior</strong> packages to use later in examples.</p>
+<p>We can now load the package like any other R package. Well also load
+the <strong>bayesplot</strong> and <strong>posterior</strong> packages
+to use later in examples.</p>
 <div class=""sourceCode"" id=""cb2""><pre class=""downlit sourceCode r"">
 <code class=""sourceCode R""><span><span class=""kw""><a href=""https://rdrr.io/r/base/library.html"" class=""external-link"">library</a></span><span class=""op"">(</span><span class=""va""><a href=""https://mc-stan.org/cmdstanr/"">cmdstanr</a></span><span class=""op"">)</span></span>
 <span><span class=""kw""><a href=""https://rdrr.io/r/base/library.html"" class=""external-link"">library</a></span><span class=""op"">(</span><span class=""va""><a href=""https://mc-stan.org/posterior/"" class=""external-link"">posterior</a></span><span class=""op"">)</span></span>
@@ -276,30 +277,30 @@ <h2 id=""running-mcmc"">Running MCMC<a class=""anchor"" aria-label=""anchor"" href=""#r
 <span><span class=""op"">)</span></span></code></pre></div>
 <pre><code>Running MCMC with 4 parallel chains...
 
-Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup) 
-Chain 1 Iteration:  500 / 2000 [ 25%]  (Warmup) 
-Chain 1 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
-Chain 1 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
-Chain 1 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
-Chain 1 Iteration: 2000 / 2000 [100%]  (Sampling) 
-Chain 2 Iteration:    1 / 2000 [  0%]  (Warmup) 
-Chain 2 Iteration:  500 / 2000 [ 25%]  (Warmup) 
-Chain 2 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
-Chain 2 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
-Chain 2 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
-Chain 2 Iteration: 2000 / 2000 [100%]  (Sampling) 
-Chain 3 Iteration:    1 / 2000 [  0%]  (Warmup) 
-Chain 3 Iteration:  500 / 2000 [ 25%]  (Warmup) 
-Chain 3 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
-Chain 3 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
-Chain 3 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
-Chain 3 Iteration: 2000 / 2000 [100%]  (Sampling) 
-Chain 4 Iteration:    1 / 2000 [  0%]  (Warmup) 
-Chain 4 Iteration:  500 / 2000 [ 25%]  (Warmup) 
-Chain 4 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
-Chain 4 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
-Chain 4 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
-Chain 4 Iteration: 2000 / 2000 [100%]  (Sampling) 
+Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup)
+Chain 1 Iteration:  500 / 2000 [ 25%]  (Warmup)
+Chain 1 Iteration: 1000 / 2000 [ 50%]  (Warmup)
+Chain 1 Iteration: 1001 / 2000 [ 50%]  (Sampling)
+Chain 1 Iteration: 1500 / 2000 [ 75%]  (Sampling)
+Chain 1 Iteration: 2000 / 2000 [100%]  (Sampling)
+Chain 2 Iteration:    1 / 2000 [  0%]  (Warmup)
+Chain 2 Iteration:  500 / 2000 [ 25%]  (Warmup)
+Chain 2 Iteration: 1000 / 2000 [ 50%]  (Warmup)
+Chain 2 Iteration: 1001 / 2000 [ 50%]  (Sampling)
+Chain 2 Iteration: 1500 / 2000 [ 75%]  (Sampling)
+Chain 2 Iteration: 2000 / 2000 [100%]  (Sampling)
+Chain 3 Iteration:    1 / 2000 [  0%]  (Warmup)
+Chain 3 Iteration:  500 / 2000 [ 25%]  (Warmup)
+Chain 3 Iteration: 1000 / 2000 [ 50%]  (Warmup)
+Chain 3 Iteration: 1001 / 2000 [ 50%]  (Sampling)
+Chain 3 Iteration: 1500 / 2000 [ 75%]  (Sampling)
+Chain 3 Iteration: 2000 / 2000 [100%]  (Sampling)
+Chain 4 Iteration:    1 / 2000 [  0%]  (Warmup)
+Chain 4 Iteration:  500 / 2000 [ 25%]  (Warmup)
+Chain 4 Iteration: 1000 / 2000 [ 50%]  (Warmup)
+Chain 4 Iteration: 1001 / 2000 [ 50%]  (Sampling)
+Chain 4 Iteration: 1500 / 2000 [ 75%]  (Sampling)
+Chain 4 Iteration: 2000 / 2000 [100%]  (Sampling)
 Chain 1 finished in 0.0 seconds.
 Chain 2 finished in 0.0 seconds.
 Chain 3 finished in 0.0 seconds.
@@ -495,29 +496,29 @@ <h4 id=""sampler-diagnostic-warnings-and-summaries"">Sampler diagnostic warnings a
 suffers from divergences.</p>
 <div class=""sourceCode"" id=""cb38""><pre class=""downlit sourceCode r"">
 <code class=""sourceCode R""><span><span class=""va"">fit_with_warning</span> <span class=""op"">&lt;-</span> <span class=""fu""><a href=""../reference/cmdstanr_example.html"">cmdstanr_example</a></span><span class=""op"">(</span><span class=""st"">""schools""</span><span class=""op"">)</span></span></code></pre></div>
-<pre><code>Warning: 52 of 4000 (1.0%) transitions ended with a divergence.
+<pre><code>Warning: 67 of 4000 (2.0%) transitions ended with a divergence.
 See https://mc-stan.org/misc/warnings for details.</code></pre>
 <p>After fitting there is a warning about divergences. We can also
 regenerate this warning message later using
 <code>fit$diagnostic_summary()</code>.</p>
 <div class=""sourceCode"" id=""cb40""><pre class=""downlit sourceCode r"">
 <code class=""sourceCode R""><span><span class=""va"">diagnostics</span> <span class=""op"">&lt;-</span> <span class=""va"">fit_with_warning</span><span class=""op"">$</span><span class=""fu"">diagnostic_summary</span><span class=""op"">(</span><span class=""op"">)</span></span></code></pre></div>
-<pre><code>Warning: 52 of 4000 (1.0%) transitions ended with a divergence.
+<pre><code>Warning: 67 of 4000 (2.0%) transitions ended with a divergence.
 See https://mc-stan.org/misc/warnings for details.</code></pre>
 <div class=""sourceCode"" id=""cb42""><pre class=""downlit sourceCode r"">
 <code class=""sourceCode R""><span><span class=""fu""><a href=""https://rdrr.io/r/base/print.html"" class=""external-link"">print</a></span><span class=""op"">(</span><span class=""va"">diagnostics</span><span class=""op"">)</span></span></code></pre></div>
 <pre><code>$num_divergent
-[1]  3 40  2  7
+[1]  6 35 24  2
 
 $num_max_treedepth
 [1] 0 0 0 0
 
 $ebfmi
-[1] 0.34 0.28 0.32 0.33</code></pre>
+[1] 0.30 0.33 0.24 0.35</code></pre>
 <div class=""sourceCode"" id=""cb44""><pre class=""downlit sourceCode r"">
 <code class=""sourceCode R""><span><span class=""co""># number of divergences reported in warning is the sum of the per chain values</span></span>
 <span><span class=""fu""><a href=""https://rdrr.io/r/base/sum.html"" class=""external-link"">sum</a></span><span class=""op"">(</span><span class=""va"">diagnostics</span><span class=""op"">$</span><span class=""va"">num_divergent</span><span class=""op"">)</span></span></code></pre></div>
-<pre><code>[1] 52</code></pre>
+<pre><code>[1] 67</code></pre>
 </div>
 <div class=""section level4"">
 <h4 id=""cmdstans-diagnose-utility"">CmdStans diagnose utility<a class=""anchor"" aria-label=""anchor"" href=""#cmdstans-diagnose-utility""></a>
@@ -557,12 +558,12 @@ <h3 id=""optimization"">Optimization<a class=""anchor"" aria-label=""anchor"" href=""#o
 <a href=""https://mc-stan.org/cmdstanr/reference/model-method-optimize.html""><code>$optimize()</code></a>.</p>
 <div class=""sourceCode"" id=""cb47""><pre class=""downlit sourceCode r"">
 <code class=""sourceCode R""><span><span class=""va"">fit_mle</span> <span class=""op"">&lt;-</span> <span class=""va"">mod</span><span class=""op"">$</span><span class=""fu"">optimize</span><span class=""op"">(</span>data <span class=""op"">=</span> <span class=""va"">data_list</span>, seed <span class=""op"">=</span> <span class=""fl"">123</span><span class=""op"">)</span></span></code></pre></div>
-<pre><code>Initial log joint probability = -9.51104 
-    Iter      log prob        ||dx||      ||grad||       alpha      alpha0  # evals  Notes  
-       6      -5.00402   0.000103557   2.55661e-07           1           1        9    
-Optimization terminated normally:  
-  Convergence detected: relative gradient magnitude is below tolerance 
-Finished in  0.1 seconds.</code></pre>
+<pre><code>Initial log joint probability = -9.51104
+    Iter      log prob        ||dx||      ||grad||       alpha      alpha0  # evals  Notes
+       6      -5.00402   0.000103557   2.55661e-07           1           1        9
+Optimization terminated normally:
+  Convergence detected: relative gradient magnitude is below tolerance
+Finished in  0.2 seconds.</code></pre>
 <div class=""sourceCode"" id=""cb49""><pre class=""downlit sourceCode r"">
 <code class=""sourceCode R""><span><span class=""va"">fit_mle</span><span class=""op"">$</span><span class=""fu"">print</span><span class=""op"">(</span><span class=""op"">)</span> <span class=""co""># includes lp__ (log prob calculated by Stan program)</span></span></code></pre></div>
 <pre><code> variable estimate
@@ -587,28 +588,28 @@ <h3 id=""variational-bayes"">Variational Bayes<a class=""anchor"" aria-label=""anchor
 method.</p>
 <div class=""sourceCode"" id=""cb54""><pre class=""downlit sourceCode r"">
 <code class=""sourceCode R""><span><span class=""va"">fit_vb</span> <span class=""op"">&lt;-</span> <span class=""va"">mod</span><span class=""op"">$</span><span class=""fu"">variational</span><span class=""op"">(</span>data <span class=""op"">=</span> <span class=""va"">data_list</span>, seed <span class=""op"">=</span> <span class=""fl"">123</span>, output_samples <span class=""op"">=</span> <span class=""fl"">4000</span><span class=""op"">)</span></span></code></pre></div>
-<pre><code>------------------------------------------------------------ 
-EXPERIMENTAL ALGORITHM: 
-  This procedure has not been thoroughly tested and may be unstable 
-  or buggy. The interface is subject to change. 
------------------------------------------------------------- 
-Gradient evaluation took 5e-06 seconds 
-1000 transitions using 10 leapfrog steps per transition would take 0.05 seconds. 
-Adjust your expectations accordingly! 
-Begin eta adaptation. 
-Iteration:   1 / 250 [  0%]  (Adaptation) 
-Iteration:  50 / 250 [ 20%]  (Adaptation) 
-Iteration: 100 / 250 [ 40%]  (Adaptation) 
-Iteration: 150 / 250 [ 60%]  (Adaptation) 
-Iteration: 200 / 250 [ 80%]  (Adaptation) 
-Success! Found best value [eta = 1] earlier than expected. 
-Begin stochastic gradient ascent. 
-  iter             ELBO   delta_ELBO_mean   delta_ELBO_med   notes  
-   100           -6.262             1.000            1.000 
-   200           -6.263             0.500            1.000 
-   300           -6.307             0.336            0.007   MEDIAN ELBO CONVERGED 
-Drawing a sample of size 4000 from the approximate posterior...  
-COMPLETED. 
+<pre><code>------------------------------------------------------------
+EXPERIMENTAL ALGORITHM:
+  This procedure has not been thoroughly tested and may be unstable
+  or buggy. The interface is subject to change.
+------------------------------------------------------------
+Gradient evaluation took 6e-06 seconds
+1000 transitions using 10 leapfrog steps per transition would take 0.06 seconds.
+Adjust your expectations accordingly!
+Begin eta adaptation.
+Iteration:   1 / 250 [  0%]  (Adaptation)
+Iteration:  50 / 250 [ 20%]  (Adaptation)
+Iteration: 100 / 250 [ 40%]  (Adaptation)
+Iteration: 150 / 250 [ 60%]  (Adaptation)
+Iteration: 200 / 250 [ 80%]  (Adaptation)
+Success! Found best value [eta = 1] earlier than expected.
+Begin stochastic gradient ascent.
+  iter             ELBO   delta_ELBO_mean   delta_ELBO_med   notes
+   100           -6.262             1.000            1.000
+   200           -6.263             0.500            1.000
+   300           -6.307             0.336            0.007   MEDIAN ELBO CONVERGED
+Drawing a sample of size 4000 from the approximate posterior...
+COMPLETED.
 Finished in  0.1 seconds.</code></pre>
 <div class=""sourceCode"" id=""cb56""><pre class=""downlit sourceCode r"">
 <code class=""sourceCode R""><span><span class=""va"">fit_vb</span><span class=""op"">$</span><span class=""fu"">print</span><span class=""op"">(</span><span class=""st"">""theta""</span><span class=""op"">)</span></span></code></pre></div>
@@ -780,10 +781,10 @@ <h2 id=""additional-resources"">Additional resources<a class=""anchor"" aria-label=""
       </footer>
 </div>
 
-  
 
 
-  
+
+
 
   </body>
 </html>

---FILE: vignettes/cmdstanr.Rmd---
@@ -24,17 +24,17 @@ traditional [RStan](https://mc-stan.org/rstan/) interface. See the [*Comparison
 with RStan*](#comparison-with-rstan) section later in this vignette for more
 details on how the two interfaces differ.
 
-**CmdStanR is not on CRAN yet**, but the beta release can be installed by
-running the following command in R.
+Using CmdStanR requires installing the **cmdstanr** R package and also
+CmdStan, the command line interface to Stan. First we install the R package 
+by running the following command in R.
 
 ```{r install, eval=FALSE}
 # we recommend running this is a fresh R session or restarting your current session
 install.packages(""cmdstanr"", repos = c(""https://mc-stan.org/r-packages/"", getOption(""repos"")))
 ```
 
-CmdStanR (the **cmdstanr** R package) can now be loaded like any other R
-package. We'll also load the **bayesplot** and **posterior** packages to use
-later in examples.
+We can now load the package like any other R package. We'll also load the
+**bayesplot** and **posterior** packages to use later in examples.
 
 ```{r library, message=FALSE}
 library(cmdstanr)",False,True,Implementation / Logic,6
stan-dev,cmdstanr,6cae03aa1a9344a9a2a8c35acdc5bfbe0f7b9056,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-08-23T08:06:42Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-08-23T08:06:42Z,Fix variable skeleton with containers,R/utils.R;tests/testthat/test-model-methods.R,False,True,True,False,38,1,39,"---FILE: R/utils.R---
@@ -780,7 +780,11 @@ create_skeleton <- function(param_metadata, model_variables,
                        names(model_variables$generated_quantities))
   }
   lapply(param_metadata[target_params], function(par_dims) {
-    array(0, dim = ifelse(length(par_dims) == 0, 1, par_dims))
+    if ((length(par_dims) == 0)) {
+      array(0, dim = 1)
+    } else {
+      array(0, dim = par_dims)
+    }
   })
 }
 

---FILE: tests/testthat/test-model-methods.R---
@@ -277,3 +277,36 @@ test_that(""Model methods can be initialised for models with no data"", {
   expect_no_error(fit <- mod$sample())
   expect_equal(fit$log_prob(5), -12.5)
 })
+
+test_that(""Variable skeleton returns correct dimensions for matrices"", {
+  skip_if(os_is_wsl())
+
+  stan_file <- write_stan_file(""
+  data {
+    int N;
+    int K;
+  }
+  parameters {
+    real x_real;
+    matrix[N,K] x_mat;
+    vector[K] x_vec;
+    row_vector[K] x_rowvec;
+  }
+  model {
+    x_real ~ std_normal();
+  }"")
+  mod <- cmdstan_model(stan_file, compile_model_methods = TRUE,
+                      force_recompile = TRUE)
+  fit <- mod$sample(data = list(N = 4, K = 3), chains = 1,
+                    iter_warmup = 1, iter_sampling = 1)
+
+  target_skeleton <- list(
+    x_real = array(0, dim = 1),
+    x_mat = array(0, dim = c(4, 3)),
+    x_vec = array(0, dim = c(3)),
+    x_rowvec = array(0, dim = c(3))
+  )
+
+  expect_equal(fit$variable_skeleton(),
+                target_skeleton)
+})",True,False,Implementation / Logic,6
stan-dev,cmdstanr,804267a9ddbe477fca0c4c8d8b3b8c58debb46f7,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-08-23T07:19:14Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-08-23T07:19:14Z,Fix handling of exposing functions with pre-compiled Stan model,R/model.R;R/utils.R,False,True,True,False,6,0,6,"---FILE: R/model.R---
@@ -519,6 +519,7 @@ compile <- function(quiet = TRUE,
     private$precompile_cpp_options_ <- NULL
     private$precompile_stanc_options_ <- NULL
     private$precompile_include_paths_ <- NULL
+    self$functions$existing_exe <- TRUE
     self$exe_file(exe)
     return(invisible(self))
   } else {
@@ -586,6 +587,7 @@ compile <- function(quiet = TRUE,
   stancflags_standalone <- c(""--standalone-functions"", stancflags_val, stancflags_combined)
   self$functions$hpp_code <- get_standalone_hpp(temp_stan_file, stancflags_standalone)
   self$functions$external <- !is.null(user_header)
+  self$functions$existing_exe <- FALSE
   if (compile_standalone) {
     expose_stan_functions(self$functions, !quiet)
   }

---FILE: R/utils.R---
@@ -914,6 +914,10 @@ expose_stan_functions <- function(function_env, global = FALSE, verbose = FALSE)
           ""WSL CmdStan and will not be compiled"",
           call. = FALSE)
   }
+  if (function_env$existing_exe) {
+    stop(""Exporting standalone functions is not possible with a pre-compiled Stan model!"",
+          call. = FALSE)
+  }
   if (function_env$external && cmdstan_version() < ""2.32"") {
     stop(""Exporting standalone functions with external C++ is not available before CmdStan 2.32"",
          call. = FALSE)",True,False,Implementation / Logic,6
stan-dev,cmdstanr,c6be00dfaddcdf5b22d3850a9781732e04ee8edf,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-08-23T07:09:04Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-08-23T07:09:04Z,Fix test failures,R/fit.R;R/utils.R,False,True,True,False,4,4,8,"---FILE: R/fit.R---
@@ -31,7 +31,7 @@ CmdStanFit <- R6::R6Class(
       }
 
       if (!is.null(private$model_methods_env_$model_ptr)) {
-        initialize_model_pointer(private$model_methods_env_, self$data_file())
+        initialize_model_pointer(private$model_methods_env_, self$data_file(), 0)
       }
       # Need to update the output directory path to one that can be accessed
       # from Windows, for the post-processing of results
@@ -352,7 +352,7 @@ init_model_methods <- function(seed = 0, verbose = FALSE, hessian = FALSE) {
   if (is.null(private$model_methods_env_$model_ptr)) {
     expose_model_methods(private$model_methods_env_, verbose, hessian)
   }
-  initialize_model_pointer(private$model_methods_env_, self$data_file())
+  initialize_model_pointer(private$model_methods_env_, self$data_file(), seed)
   invisible(NULL)
 }
 CmdStanFit$set(""public"", name = ""init_model_methods"", value = init_model_methods)

---FILE: R/utils.R---
@@ -759,8 +759,8 @@ expose_model_methods <- function(env, verbose = FALSE, hessian = FALSE) {
   invisible(NULL)
 }
 
-initialize_model_pointer <- function(env, datafile_path) {
-  env$model_ptr_ <- env$model_ptr(ifelse(is.null(datafile_path), """", datafile_path))
+initialize_model_pointer <- function(env, datafile_path, seed = 0) {
+  env$model_ptr_ <- env$model_ptr(ifelse(is.null(datafile_path), """", datafile_path), seed)
   env$num_upars_ <- env$get_num_upars(env$model_ptr_)
   env$param_metadata_ <- env$get_param_metadata(env$model_ptr_)
   invisible(NULL)",True,False,Implementation / Logic,6
stan-dev,cmdstanr,b555aa6c16a0c0ae061dded62a1d23d622c0759c,jgabry,jgabry@gmail.com,2023-08-16T00:40:07Z,jgabry,jgabry@gmail.com,2023-08-16T00:40:07Z,fix r cmd check issue,R/example.R;fit-temp.rds;man/cmdstanr_example.Rd,False,True,True,False,2,4,6,"---FILE: R/example.R---
@@ -19,8 +19,7 @@
 #'   the individual methods for details.
 #' @param quiet (logical) If `TRUE` (the default) then fitting the model is
 #'   wrapped in [utils::capture.output()].
-#' @param force_recompile Passed to the [model-method-compile][$compile()]
-#'   method.
+#' @param force_recompile Passed to the [$compile()][model-method-compile] method.
 #'
 #' @return
 #' The fitted model object returned by the selected `method`.

---FILE: man/cmdstanr_example.Rd---
@@ -39,8 +39,7 @@ the individual methods for details.}
 \item{quiet}{(logical) If \code{TRUE} (the default) then fitting the model is
 wrapped in \code{\link[utils:capture.output]{utils::capture.output()}}.}
 
-\item{force_recompile}{Passed to the \link[=$compile]{model-method-compile}
-method.}
+\item{force_recompile}{Passed to the \link[=model-method-compile]{$compile()} method.}
 }
 \value{
 The fitted model object returned by the selected \code{method}.",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,a291503ab51d0ef49c329beb5f45a56d04174101,jgabry,jgabry@gmail.com,2023-08-15T20:26:42Z,jgabry,jgabry@gmail.com,2023-08-15T20:26:42Z,"fix errors in doc for new methods

Fixes https://github.com/stan-dev/cmdstanr/issues/822",R/example.R;R/fit.R;man/cmdstanr_example.Rd;man/fit-method-constrain_variables.Rd;man/fit-method-grad_log_prob.Rd;man/fit-method-hessian.Rd;man/fit-method-init_model_methods.Rd;man/fit-method-log_prob.Rd;man/fit-method-unconstrain_draws.Rd;man/fit-method-unconstrain_variables.Rd;man/fit-method-variable_skeleton.Rd,False,True,True,False,26,19,45,"---FILE: R/example.R---
@@ -19,6 +19,8 @@
 #'   the individual methods for details.
 #' @param quiet (logical) If `TRUE` (the default) then fitting the model is
 #'   wrapped in [utils::capture.output()].
+#' @param force_recompile Passed to the [model-method-compile][$compile()]
+#'   method.
 #'
 #' @return
 #' The fitted model object returned by the selected `method`.
@@ -51,7 +53,8 @@ cmdstanr_example <-
   function(example = c(""logistic"", ""schools"", ""schools_ncp""),
            method = c(""sample"", ""optimize"", ""variational"", ""diagnose""),
            ...,
-           quiet = TRUE) {
+           quiet = TRUE,
+           force_recompile = getOption(""cmdstanr_force_recompile"", default = FALSE)) {
 
     example <- match.arg(example)
     method <- match.arg(method)
@@ -63,7 +66,7 @@ cmdstanr_example <-
     if (!file.exists(tmp)) {
       file.copy(system.file(example_program, package = ""cmdstanr""), tmp)
     }
-    mod <- cmdstan_model(tmp)
+    mod <- cmdstan_model(tmp, force_recompile = force_recompile)
     data_file <- system.file(example_data, package = ""cmdstanr"")
 
     if (quiet) {

---FILE: R/fit.R---
@@ -324,7 +324,7 @@ CmdStanFit$set(""public"", name = ""init"", value = init)
 #'
 #' @examples
 #' \dontrun{
-#' fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"")
+#' fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"", force_recompile = TRUE)
 #' fit_mcmc$init_model_methods()
 #' }
 #' @seealso [log_prob()], [grad_log_prob()], [constrain_variables()],
@@ -370,7 +370,7 @@ CmdStanFit$set(""public"", name = ""init_model_methods"", value = init_model_methods
 #'
 #' @examples
 #' \dontrun{
-#' fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"")
+#' fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"", force_recompile = TRUE)
 #' fit_mcmc$init_model_methods()
 #' fit_mcmc$log_prob(unconstrained_variables = c(0.5, 1.2, 1.1, 2.2))
 #' }
@@ -408,7 +408,7 @@ CmdStanFit$set(""public"", name = ""log_prob"", value = log_prob)
 #'
 #' @examples
 #' \dontrun{
-#' fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"")
+#' fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"", force_recompile = TRUE)
 #' fit_mcmc$init_model_methods()
 #' fit_mcmc$grad_log_prob(unconstrained_variables = c(0.5, 1.2, 1.1, 2.2))
 #' }
@@ -446,7 +446,7 @@ CmdStanFit$set(""public"", name = ""grad_log_prob"", value = grad_log_prob)
 #'
 #' @examples
 #' \dontrun{
-#' # fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"")
+#' fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"", force_recompile = TRUE)
 #' # fit_mcmc$init_model_methods(hessian = TRUE)
 #' # fit_mcmc$hessian(unconstrained_variables = c(0.5, 1.2, 1.1, 2.2))
 #' }
@@ -481,7 +481,7 @@ CmdStanFit$set(""public"", name = ""hessian"", value = hessian)
 #'
 #' @examples
 #' \dontrun{
-#' fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"")
+#' fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"", force_recompile = TRUE)
 #' fit_mcmc$init_model_methods()
 #' fit_mcmc$unconstrain_variables(list(alpha = 0.5, beta = c(0.7, 1.1, 0.2)))
 #' }
@@ -539,7 +539,7 @@ CmdStanFit$set(""public"", name = ""unconstrain_variables"", value = unconstrain_var
 #'
 #' @examples
 #' \dontrun{
-#' fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"")
+#' fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"", force_recompile = TRUE)
 #' fit_mcmc$init_model_methods()
 #'
 #' # Unconstrain all internal draws
@@ -618,7 +618,7 @@ CmdStanFit$set(""public"", name = ""unconstrain_draws"", value = unconstrain_draws)
 #'
 #' @examples
 #' \dontrun{
-#' fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"")
+#' fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"", force_recompile = TRUE)
 #' fit_mcmc$init_model_methods()
 #' fit_mcmc$variable_skeleton()
 #' }
@@ -656,7 +656,7 @@ CmdStanFit$set(""public"", name = ""variable_skeleton"", value = variable_skeleton)
 #'
 #' @examples
 #' \dontrun{
-#' fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"")
+#' fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"", force_recompile = TRUE)
 #' fit_mcmc$init_model_methods()
 #' fit_mcmc$constrain_variables(unconstrained_variables = c(0.5, 1.2, 1.1, 2.2))
 #' }

---FILE: man/cmdstanr_example.Rd---
@@ -9,7 +9,8 @@ cmdstanr_example(
   example = c(""logistic"", ""schools"", ""schools_ncp""),
   method = c(""sample"", ""optimize"", ""variational"", ""diagnose""),
   ...,
-  quiet = TRUE
+  quiet = TRUE,
+  force_recompile = getOption(""cmdstanr_force_recompile"", default = FALSE)
 )
 
 print_example_program(example = c(""logistic"", ""schools"", ""schools_ncp""))
@@ -37,6 +38,9 @@ the individual methods for details.}
 
 \item{quiet}{(logical) If \code{TRUE} (the default) then fitting the model is
 wrapped in \code{\link[utils:capture.output]{utils::capture.output()}}.}
+
+\item{force_recompile}{Passed to the \link[=$compile]{model-method-compile}
+method.}
 }
 \value{
 The fitted model object returned by the selected \code{method}.

---FILE: man/fit-method-constrain_variables.Rd---
@@ -27,7 +27,7 @@ to the constrained scale.
 }
 \examples{
 \dontrun{
-fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"")
+fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"", force_recompile = TRUE)
 fit_mcmc$init_model_methods()
 fit_mcmc$constrain_variables(unconstrained_variables = c(0.5, 1.2, 1.1, 2.2))
 }

---FILE: man/fit-method-grad_log_prob.Rd---
@@ -21,7 +21,7 @@ model's \code{log_prob} function and its derivative.
 }
 \examples{
 \dontrun{
-fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"")
+fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"", force_recompile = TRUE)
 fit_mcmc$init_model_methods()
 fit_mcmc$grad_log_prob(unconstrained_variables = c(0.5, 1.2, 1.1, 2.2))
 }

---FILE: man/fit-method-hessian.Rd---
@@ -21,7 +21,7 @@ The \verb{$hessian()} method provides access to the Stan model's
 }
 \examples{
 \dontrun{
-# fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"")
+fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"", force_recompile = TRUE)
 # fit_mcmc$init_model_methods(hessian = TRUE)
 # fit_mcmc$hessian(unconstrained_variables = c(0.5, 1.2, 1.1, 2.2))
 }

---FILE: man/fit-method-init_model_methods.Rd---
@@ -28,7 +28,7 @@ these can be ignored so long as they are warnings and not errors.
 }
 \examples{
 \dontrun{
-fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"")
+fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"", force_recompile = TRUE)
 fit_mcmc$init_model_methods()
 }
 }

---FILE: man/fit-method-log_prob.Rd---
@@ -19,7 +19,7 @@ The \verb{$log_prob()} method provides access to the Stan model's \code{log_prob
 }
 \examples{
 \dontrun{
-fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"")
+fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"", force_recompile = TRUE)
 fit_mcmc$init_model_methods()
 fit_mcmc$log_prob(unconstrained_variables = c(0.5, 1.2, 1.1, 2.2))
 }

---FILE: man/fit-method-unconstrain_draws.Rd---
@@ -23,7 +23,7 @@ character vector of paths to CSV files can be passed.
 }
 \examples{
 \dontrun{
-fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"")
+fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"", force_recompile = TRUE)
 fit_mcmc$init_model_methods()
 
 # Unconstrain all internal draws

---FILE: man/fit-method-unconstrain_variables.Rd---
@@ -17,7 +17,7 @@ parameters to the unconstrained scale.
 }
 \examples{
 \dontrun{
-fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"")
+fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"", force_recompile = TRUE)
 fit_mcmc$init_model_methods()
 fit_mcmc$unconstrain_variables(list(alpha = 0.5, beta = c(0.7, 1.1, 0.2)))
 }

---FILE: man/fit-method-variable_skeleton.Rd---
@@ -21,7 +21,7 @@ parameter values to a named list.
 }
 \examples{
 \dontrun{
-fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"")
+fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"", force_recompile = TRUE)
 fit_mcmc$init_model_methods()
 fit_mcmc$variable_skeleton()
 }",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,0d8be0893cee2994dc0c2a4818f90ef89808e3b8,Martin Modrk,modrak.mar@gmail.com,2023-08-15T17:44:20Z,Martin Modrk,modrak.mar@gmail.com,2023-08-15T17:44:20Z,Another attempt at fixing WSL failures,R/model.R;tests/testthat/test-model-compile.R,False,True,True,False,11,3,14,"---FILE: R/model.R---
@@ -511,19 +511,28 @@ compile <- function(quiet = TRUE,
   if (isTRUE(cpp_options$stan_opencl)) {
     stanc_options[[""use-opencl""]] <- TRUE
   }
+
   # Note that unlike cpp_options[""USER_HEADER""], the user_header variable is deliberately
   # not transformed with wsl_safe_path() as that breaks the check below on WSLv1
   if (!is.null(user_header)) {
+    if(!is.null(cpp_options[[""USER_HEADER""]]) || !is.null(cpp_options[[""user_header""]])) {
+      warning(""User header specified both via user_header argument and via cpp_options arguments"")
+    }
+
     cpp_options[[""USER_HEADER""]] <- wsl_safe_path(absolute_path(user_header))
     stanc_options[[""allow-undefined""]] <- TRUE
     private$using_user_header_ <- TRUE
   }
-  if (!is.null(cpp_options[[""USER_HEADER""]])) {
+  else if (!is.null(cpp_options[[""USER_HEADER""]])) {
+    if(!is.null(cpp_options[[""user_header""]])) {
+      warning('User header specified both via cpp_options[[""USER_HEADER""]] and cpp_options[[""user_header""]]')
+    }
+
     user_header <- cpp_options[[""USER_HEADER""]]
     cpp_options[[""USER_HEADER""]] <- wsl_safe_path(absolute_path(cpp_options[[""USER_HEADER""]]))
     private$using_user_header_ <- TRUE
   }
-  if (!is.null(cpp_options[[""user_header""]])) {
+  else if (!is.null(cpp_options[[""user_header""]])) {
     user_header <- cpp_options[[""user_header""]]
     cpp_options[[""user_header""]] <- wsl_safe_path(absolute_path(cpp_options[[""user_header""]]))
     private$using_user_header_ <- TRUE

---FILE: tests/testthat/test-model-compile.R---
@@ -615,7 +615,6 @@ test_that(""cmdstan_model works with user_header"", {
       }
   }""
   cat(hpp, file = tmpfile, sep = ""\n"")
-  warning(paste0(""tmpfile test: "", tmpfile))
   mod <- cmdstan_model(
     stan_file = testing_stan_file(""bernoulli_external""),
     user_header = tmpfile",True,False,Implementation / Logic,6
stan-dev,cmdstanr,e3f7f7b97a62b96ab35fc1978f43062a266fbeef,Martin Modrk,modrak.mar@gmail.com,2023-08-15T13:17:02Z,Martin Modrk,modrak.mar@gmail.com,2023-08-15T13:17:02Z,Fixed problem when not using user_header,R/model.R,False,True,True,False,1,1,2,"---FILE: R/model.R---
@@ -526,8 +526,8 @@ compile <- function(quiet = TRUE,
     private$using_user_header_ <- TRUE
   }
 
-  user_header <- absolute_path(user_header) # As mentioned above, just absolute, not wsl_safe_path()
   if(!is.null(user_header)) {
+    user_header <- absolute_path(user_header) # As mentioned above, just absolute, not wsl_safe_path()
     if(!file.exists(user_header)) {
       stop(paste0(""User header file '"", user_header, ""' does not exist""))
     }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,2a642f47e9a9a3baa00660c230d77f59cd1840e2,Martin Modrk,modrak.mar@gmail.com,2023-08-15T12:47:36Z,Martin Modrk,modrak.mar@gmail.com,2023-08-15T12:47:36Z,Hopefully resolving the WSLv1 failures,R/model.R;R/utils.R;tests/testthat/test-model-compile.R,False,True,True,False,11,9,20,"---FILE: R/model.R---
@@ -508,32 +508,35 @@ compile <- function(quiet = TRUE,
   if (isTRUE(cpp_options$stan_opencl)) {
     stanc_options[[""use-opencl""]] <- TRUE
   }
+  # Note that unlike cpp_options[""USER_HEADER""], the user_header variable is deliberately
+  # not transformed with wsl_safe_path() as that breaks the check below on WSLv1
   if (!is.null(user_header)) {
-    user_header <- wsl_safe_path(absolute_path(user_header))
-    cpp_options[[""USER_HEADER""]] <- user_header
+    cpp_options[[""USER_HEADER""]] <- wsl_safe_path(absolute_path(user_header))
     stanc_options[[""allow-undefined""]] <- TRUE
     private$using_user_header_ <- TRUE
   }
   if (!is.null(cpp_options[[""USER_HEADER""]])) {
+    user_header <- cpp_options[[""USER_HEADER""]]
     cpp_options[[""USER_HEADER""]] <- wsl_safe_path(absolute_path(cpp_options[[""USER_HEADER""]]))
     private$using_user_header_ <- TRUE
-    user_header <- cpp_options[[""USER_HEADER""]]
   }
   if (!is.null(cpp_options[[""user_header""]])) {
+    user_header <- cpp_options[[""user_header""]]
     cpp_options[[""user_header""]] <- wsl_safe_path(absolute_path(cpp_options[[""user_header""]]))
     private$using_user_header_ <- TRUE
-    user_header <- cpp_options[[""user_header""]]
-  }
-  if (is.null(stanc_options[[""name""]])) {
-    stanc_options[[""name""]] <- paste0(self$model_name(), ""_model"")
   }
 
+  user_header <- absolute_path(user_header) # As mentioned above, just absolute, not wsl_safe_path()
   if(!is.null(user_header)) {
     if(!file.exists(user_header)) {
       stop(paste0(""User header file '"", user_header, ""' does not exist""))
     }
   }
 
+  if (is.null(stanc_options[[""name""]])) {
+    stanc_options[[""name""]] <- paste0(self$model_name(), ""_model"")
+  }
+
   # compile if:
   # - the user forced compilation,
   # - the executable does not exist

---FILE: R/utils.R---
@@ -491,7 +491,7 @@ wsl_safe_path <- function(path = NULL, revert = FALSE) {
     if (os_is_wsl() && !isTRUE(path_already_safe) && !is.na(path)) {
       base_file <- basename(path)
       path <- dirname(path)
-      abs_path <- repair_path(path)
+      abs_path <- repair_path(utils::shortPathName(path))
       drive_letter <- tolower(strtrim(abs_path, 1))
       path <- gsub(paste0(drive_letter, "":""),
                   paste0(""/mnt/"", drive_letter),

---FILE: tests/testthat/test-model-compile.R---
@@ -615,7 +615,6 @@ test_that(""cmdstan_model works with user_header"", {
       }
   }""
   cat(hpp, file = tmpfile, sep = ""\n"")
-  warning(paste0(""tmpfile test: "", tmpfile))
   mod <- cmdstan_model(
     stan_file = testing_stan_file(""bernoulli_external""),
     user_header = tmpfile",True,False,Implementation / Logic,6
stan-dev,cmdstanr,8c51b53a78fd8ec7f65fb17753c015b71d74619c,Martin Modrk,modrak.mar@gmail.com,2023-08-14T16:05:30Z,Martin Modrk,modrak.mar@gmail.com,2023-08-14T16:05:30Z,More debuggin WSL failure,R/model.R;R/utils.R,False,True,True,False,4,5,9,"---FILE: R/model.R---
@@ -509,21 +509,20 @@ compile <- function(quiet = TRUE,
     stanc_options[[""use-opencl""]] <- TRUE
   }
   if (!is.null(user_header)) {
-    #user_header <- wsl_safe_path(absolute_path(user_header))
-    user_header <- user_header
+    user_header <- wsl_safe_path(absolute_path(user_header))
     cpp_options[[""USER_HEADER""]] <- user_header
     stanc_options[[""allow-undefined""]] <- TRUE
     private$using_user_header_ <- TRUE
   }
   if (!is.null(cpp_options[[""USER_HEADER""]])) {
     cpp_options[[""USER_HEADER""]] <- wsl_safe_path(absolute_path(cpp_options[[""USER_HEADER""]]))
     private$using_user_header_ <- TRUE
-    #user_header <- cpp_options[[""USER_HEADER""]]
+    user_header <- cpp_options[[""USER_HEADER""]]
   }
   if (!is.null(cpp_options[[""user_header""]])) {
     cpp_options[[""user_header""]] <- wsl_safe_path(absolute_path(cpp_options[[""user_header""]]))
     private$using_user_header_ <- TRUE
-    #user_header <- cpp_options[[""user_header""]]
+    user_header <- cpp_options[[""user_header""]]
   }
   if (is.null(stanc_options[[""name""]])) {
     stanc_options[[""name""]] <- paste0(self$model_name(), ""_model"")

---FILE: R/utils.R---
@@ -491,7 +491,7 @@ wsl_safe_path <- function(path = NULL, revert = FALSE) {
     if (os_is_wsl() && !isTRUE(path_already_safe) && !is.na(path)) {
       base_file <- basename(path)
       path <- dirname(path)
-      abs_path <- repair_path(utils::shortPathName(path))
+      abs_path <- repair_path(path)
       drive_letter <- tolower(strtrim(abs_path, 1))
       path <- gsub(paste0(drive_letter, "":""),
                   paste0(""/mnt/"", drive_letter),",True,False,Implementation / Logic,6
stan-dev,cmdstanr,0b784072db5ba93eed994bcf12242a33bffd3e7b,Martin Modrk,modrak.mar@gmail.com,2023-08-14T13:47:16Z,Martin Modrk,modrak.mar@gmail.com,2023-08-14T13:47:16Z,Debugging WSL failure,R/model.R;tests/testthat/test-model-compile.R,False,True,True,False,5,3,8,"---FILE: R/model.R---
@@ -509,20 +509,21 @@ compile <- function(quiet = TRUE,
     stanc_options[[""use-opencl""]] <- TRUE
   }
   if (!is.null(user_header)) {
-    user_header <- wsl_safe_path(absolute_path(user_header))
+    #user_header <- wsl_safe_path(absolute_path(user_header))
+    user_header <- user_header
     cpp_options[[""USER_HEADER""]] <- user_header
     stanc_options[[""allow-undefined""]] <- TRUE
     private$using_user_header_ <- TRUE
   }
   if (!is.null(cpp_options[[""USER_HEADER""]])) {
     cpp_options[[""USER_HEADER""]] <- wsl_safe_path(absolute_path(cpp_options[[""USER_HEADER""]]))
     private$using_user_header_ <- TRUE
-    user_header <- cpp_options[[""USER_HEADER""]]
+    #user_header <- cpp_options[[""USER_HEADER""]]
   }
   if (!is.null(cpp_options[[""user_header""]])) {
     cpp_options[[""user_header""]] <- wsl_safe_path(absolute_path(cpp_options[[""user_header""]]))
     private$using_user_header_ <- TRUE
-    user_header <- cpp_options[[""user_header""]]
+    #user_header <- cpp_options[[""user_header""]]
   }
   if (is.null(stanc_options[[""name""]])) {
     stanc_options[[""name""]] <- paste0(self$model_name(), ""_model"")

---FILE: tests/testthat/test-model-compile.R---
@@ -615,6 +615,7 @@ test_that(""cmdstan_model works with user_header"", {
       }
   }""
   cat(hpp, file = tmpfile, sep = ""\n"")
+  warning(paste0(""tmpfile test: "", tmpfile))
   mod <- cmdstan_model(
     stan_file = testing_stan_file(""bernoulli_external""),
     user_header = tmpfile",True,False,Implementation / Logic,6
stan-dev,cmdstanr,ebc7d7badc36da026a3f92ccff9975fc3b9360bc,Martin Modrk,modrak.mar@gmail.com,2023-08-11T12:46:55Z,Martin Modrk,modrak.mar@gmail.com,2023-08-11T12:46:55Z,Another attempt to fix WSL failuers,R/model.R,False,True,True,False,1,1,2,"---FILE: R/model.R---
@@ -509,7 +509,7 @@ compile <- function(quiet = TRUE,
     stanc_options[[""use-opencl""]] <- TRUE
   }
   if (!is.null(user_header)) {
-    user_header <- wsl_safe_path(user_header)
+    user_header <- wsl_safe_path(absolute_path(user_header))
     cpp_options[[""USER_HEADER""]] <- user_header
     stanc_options[[""allow-undefined""]] <- TRUE
     private$using_user_header_ <- TRUE",True,False,Implementation / Logic,6
stan-dev,cmdstanr,ffa8524e3d20acacb291c0844422fb664fef7240,Martin Modrk,modrak.mar@gmail.com,2023-08-11T08:08:04Z,Martin Modrk,modrak.mar@gmail.com,2023-08-11T08:08:04Z,Fixed WSL path handling for header existence check,R/model.R;tests/testthat/test-model-compile.R,False,True,True,False,3,2,5,"---FILE: R/model.R---
@@ -509,7 +509,8 @@ compile <- function(quiet = TRUE,
     stanc_options[[""use-opencl""]] <- TRUE
   }
   if (!is.null(user_header)) {
-    cpp_options[[""USER_HEADER""]] <- wsl_safe_path(user_header)
+    user_header <- wsl_safe_path(user_header)
+    cpp_options[[""USER_HEADER""]] <- user_header
     stanc_options[[""allow-undefined""]] <- TRUE
     private$using_user_header_ <- TRUE
   }

---FILE: tests/testthat/test-model-compile.R---
@@ -595,7 +595,7 @@ test_that(""cmdstan_model errors with no args "", {
 })
 
 test_that(""cmdstan_model works with user_header"", {
-  skip_if(os_is_macos() | (os_is_windows() && !os_is_wsl()))
+  skip_if(os_is_macos())
   tmpfile <- tempfile(fileext = "".hpp"")
   hpp <-
   """,True,False,Implementation / Logic,6
stan-dev,cmdstanr,3c3a333f34b049b8019b1429ca0302d4ce1608d1,jgabry,jgabry@gmail.com,2023-08-03T19:47:17Z,jgabry,jgabry@gmail.com,2023-08-03T19:47:17Z,fix failing test,tests/testthat/test-model-variational.R,False,True,True,False,2,2,4,"---FILE: tests/testthat/test-model-variational.R---
@@ -19,7 +19,7 @@ ok_arg_values <- list(
   adapt_iter = 51,
   tol_rel_obj = 0.011,
   eval_elbo = 101,
-  output_samples = 10,
+  draws = 10,
   save_latent_dynamics = FALSE
 )
 
@@ -38,7 +38,7 @@ bad_arg_values <- list(
   adapt_iter = -10,
   tol_rel_obj = -0.5,
   eval_elbo = -10,
-  output_samples = -10,
+  draws = -10,
   save_latent_dynamics = ""NOT_LOGICAL""
 )
 ",True,False,Implementation / Logic,3
stan-dev,cmdstanr,c9d8fc2947d7cc46714ab02b9d7e854213916948,jgabry,jgabry@gmail.com,2023-08-03T00:31:28Z,jgabry,jgabry@gmail.com,2023-08-03T00:31:28Z,fix vignette error,vignettes/cmdstanr.Rmd,True,False,True,False,31,11,42,"---FILE: vignettes/cmdstanr.Rmd---
@@ -355,7 +355,11 @@ variables. To include the Jacobian adjustment and obtain a maximum a posteriori
 section of the CmdStan User's Guide for more details. 
 
 ```{r optimize-map}
-fit_map <- mod$optimize(data = data_list, jacobian = TRUE, seed = 123)
+fit_map <- mod$optimize(
+  data = data_list, 
+  jacobian = TRUE, 
+  seed = 123
+)
 ```
 
 ### Laplace Approximation
@@ -375,7 +379,13 @@ Here we pass in the `fit_map` object from above as the `mode` argument. If
 from the normal approximation.
 
 ```{r laplace}
-fit_laplace <- mod$laplace(mode = fit_map, draws = 4000, data = data_list, seed = 123)
+fit_laplace <- mod$laplace(
+    mode = fit_map,
+    draws = 4000,
+    data = data_list,
+    seed = 123,
+    refresh = 1000
+  )
 fit_laplace$summary(""theta"")
 mcmc_hist(fit_laplace$draws(""theta""), binwidth = 0.025)
 ```
@@ -387,22 +397,32 @@ We can run Stan's experimental variational Bayes algorithm (ADVI) using the
 method.
 
 ```{r variational}
-fit_vb <- mod$variational(data = data_list, draws = 4000, seed = 123)
+fit_vb <- mod$variational(
+  data = data_list, 
+  draws = 4000, 
+  seed = 123
+)
 fit_vb$summary(""theta"")
 ```
 
 Let's extract the draws, make the same plot we made after MCMC and Laplace
 approximation, and compare them all. In this simple example the distributions
 are quite similar, but this will not always be the case.
 
-```{r plot-compare, message = FALSE, fig.width = 8, fig.cap=""Comparing draws from the different algorithms""}
-bayesplot_grid(
-  mcmc_hist(fit$draws(""theta""), binwidth = 0.025),
-  mcmc_hist(fit_laplace$draws(""theta""), binwidth = 0.025),
-  mcmc_hist(fit_vb$draws(""theta""), binwidth = 0.025), 
-  xlim = c(0, 1), 
-  subtitles = c(""MCMC"", ""Laplace"", ""Variational"")
-)
+```{r plot-compare-vb, message = FALSE}
+mcmc_hist(fit_vb$draws(""theta""), binwidth = 0.025) + 
+  ggplot2::labs(subtitle = ""Approximate posterior from variational"") + 
+  ggplot2::xlim(0, 1)
+```
+```{r plot-compare-laplace, message = FALSE}
+mcmc_hist(fit_laplace$draws(""theta""), binwidth = 0.025) + 
+  ggplot2::labs(subtitle = ""Approximate posterior from Laplace"") + 
+  ggplot2::xlim(0, 1)
+```
+```{r plot-compare-mcmc, message = FALSE}
+mcmc_hist(fit$draws(""theta""), binwidth = 0.025) + 
+  ggplot2::labs(subtitle = ""Posterior from MCMC"") + 
+  ggplot2::xlim(0, 1)
 ```
 
 For more details on the `$optimize()`, `$laplace()`  and `$variational()`",False,True,Implementation / Logic,6
stan-dev,cmdstanr,513444cf9136bb9792da89efb52690c383384bd5,jgabry,jgabry@gmail.com,2023-07-31T19:47:50Z,jgabry,jgabry@gmail.com,2023-07-31T19:47:50Z,fix r cmd check warning,R/csv.R;man/read_cmdstan_csv.Rd,False,True,True,False,2,2,4,"---FILE: R/csv.R---
@@ -27,7 +27,7 @@
 #'   and memory for models with many parameters.
 #'
 #' @return
-#' `as_cmdstan_fit()` returns a [CmdStanMCMC], [CmdStanMLE], [CmdStanLaplace ]or
+#' `as_cmdstan_fit()` returns a [CmdStanMCMC], [CmdStanMLE], [CmdStanLaplace] or
 #' [CmdStanVB] object. Some methods typically defined for those objects will not
 #' work (e.g. `save_data_file()`) but the important methods like `$summary()`,
 #' `$draws()`, `$sampler_diagnostics()` and others will work fine.

---FILE: man/read_cmdstan_csv.Rd---
@@ -49,7 +49,7 @@ diagnostic checks be performed after reading in the files? The default is
 and treedepth.}
 }
 \value{
-\code{as_cmdstan_fit()} returns a \link{CmdStanMCMC}, \link{CmdStanMLE}, \link{CmdStanLaplace }or
+\code{as_cmdstan_fit()} returns a \link{CmdStanMCMC}, \link{CmdStanMLE}, \link{CmdStanLaplace} or
 \link{CmdStanVB} object. Some methods typically defined for those objects will not
 work (e.g. \code{save_data_file()}) but the important methods like \verb{$summary()},
 \verb{$draws()}, \verb{$sampler_diagnostics()} and others will work fine.",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,e229fc43ba772c77f9279a94b8f74e75ebf915d0,jgabry,jgabry@gmail.com,2023-07-31T16:54:21Z,jgabry,jgabry@gmail.com,2023-07-31T16:54:21Z,fix doc,NAMESPACE;R/csv.R;R/fit.R;man/as_draws.CmdStanMCMC.Rd;man/model-method-optimize.Rd;man/read_cmdstan_csv.Rd,False,True,True,False,8,4,12,"---FILE: NAMESPACE---
@@ -1,6 +1,7 @@
 # Generated by roxygen2: do not edit by hand
 
 S3method(as_draws,CmdStanGQ)
+S3method(as_draws,CmdStanLaplace)
 S3method(as_draws,CmdStanMCMC)
 S3method(as_draws,CmdStanMLE)
 S3method(as_draws,CmdStanVB)

---FILE: R/csv.R---
@@ -27,7 +27,7 @@
 #'   and memory for models with many parameters.
 #'
 #' @return
-#' `as_cmdstan_fit()` returns a [CmdStanMCMC], [CmdStanMLE], or
+#' `as_cmdstan_fit()` returns a [CmdStanMCMC], [CmdStanMLE], [CmdStanLaplace ]or
 #' [CmdStanVB] object. Some methods typically defined for those objects will not
 #' work (e.g. `save_data_file()`) but the important methods like `$summary()`,
 #' `$draws()`, `$sampler_diagnostics()` and others will work fine.

---FILE: R/fit.R---
@@ -2272,7 +2272,7 @@ as_draws.CmdStanMLE <- function(x, ...) {
   x$draws(...)
 }
 
-#' @rdname as_draws.CmdStanLaplace
+#' @rdname as_draws.CmdStanMCMC
 #' @export
 as_draws.CmdStanLaplace <- function(x, ...) {
   x$draws(...)

---FILE: man/as_draws.CmdStanMCMC.Rd---
@@ -4,6 +4,7 @@
 \alias{as_draws.CmdStanMCMC}
 \alias{as_draws}
 \alias{as_draws.CmdStanMLE}
+\alias{as_draws.CmdStanLaplace}
 \alias{as_draws.CmdStanVB}
 \alias{as_draws.CmdStanGQ}
 \title{Create a \code{draws} object from a CmdStanR fitted model object}
@@ -12,6 +13,8 @@
 
 \method{as_draws}{CmdStanMLE}(x, ...)
 
+\method{as_draws}{CmdStanLaplace}(x, ...)
+
 \method{as_draws}{CmdStanVB}(x, ...)
 
 \method{as_draws}{CmdStanGQ}(x, ...)

---FILE: man/model-method-optimize.Rd---
@@ -134,7 +134,7 @@ the CmdStan User's Guide. The default values can also be obtained by
 running \code{cmdstanr_example(method=""optimize"")$metadata()}.}
 
 \item{jacobian}{(logical) Whether or not to use the Jacobian adjustment for
-constrained variables. By default this is \code{FALSE}, meaning optimization
+constrained variables. For historical reasons, the default is \code{FALSE}, meaning optimization
 yields the (regularized) maximum likelihood estimate. Setting it to \code{TRUE}
 yields the maximum a posteriori estimate. See the
 \href{https://mc-stan.org/docs/cmdstan-guide/maximum-likelihood-estimation.html}{Maximum Likelihood Estimation}

---FILE: man/read_cmdstan_csv.Rd---
@@ -49,7 +49,7 @@ diagnostic checks be performed after reading in the files? The default is
 and treedepth.}
 }
 \value{
-\code{as_cmdstan_fit()} returns a \link{CmdStanMCMC}, \link{CmdStanMLE}, or
+\code{as_cmdstan_fit()} returns a \link{CmdStanMCMC}, \link{CmdStanMLE}, \link{CmdStanLaplace }or
 \link{CmdStanVB} object. Some methods typically defined for those objects will not
 work (e.g. \code{save_data_file()}) but the important methods like \verb{$summary()},
 \verb{$draws()}, \verb{$sampler_diagnostics()} and others will work fine.",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,badc4a0f8233d828ea4ac56ecf66dc5e56c88398,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-07-30T21:43:40Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-07-30T21:43:40Z,Fix init_model_methods for models with no data,R/utils.R;inst/include/model_methods.cpp;tests/testthat/test-model-methods.R,False,True,True,False,15,1,16,"---FILE: R/utils.R---
@@ -759,7 +759,8 @@ expose_model_methods <- function(env, verbose = FALSE, hessian = FALSE) {
 }
 
 initialize_model_pointer <- function(env, data, seed = 0) {
-  ptr_and_rng <- env$model_ptr(data, seed)
+  datafile_path <- ifelse(is.null(data), """", data)
+  ptr_and_rng <- env$model_ptr(datafile_path, seed)
   env$model_ptr_ <- ptr_and_rng$model_ptr
   env$model_rng_ <- ptr_and_rng$base_rng
   env$num_upars_ <- env$get_num_upars(env$model_ptr_)

---FILE: inst/include/model_methods.cpp---
@@ -6,9 +6,15 @@
 #include <cmdstan/io/json/json_data.hpp>
 #else
 #include <stan/io/json/json_data.hpp>
+#include <stan/io/empty_var_context.hpp>
 #endif
 
 std::shared_ptr<stan::io::var_context> var_context(std::string file_path) {
+  if (file_path == """") {
+    stan::io::empty_var_context empty_context;
+    return std::make_shared<stan::io::empty_var_context>(empty_context);
+  }
+
   std::fstream stream(file_path.c_str(), std::fstream::in);
 #ifdef CMDSTAN_JSON
 using json_data_t = cmdstan::json::json_data;

---FILE: tests/testthat/test-model-methods.R---
@@ -268,3 +268,10 @@ test_that(""unconstrain_draws returns correct values"", {
   unconstrained_draws <- fit$unconstrain_draws(draws = fit$draws())[[1]]
   expect_equal(as.numeric(x_draws), exp(as.numeric(unconstrained_draws)))
 })
+
+test_that(""Model methods can be initialised for models with no data"", {
+  stan_file <- write_stan_file(""parameters { real x; } model { x ~ std_normal(); }"")
+  mod <- cmdstan_model(stan_file, compile_model_methods = TRUE, force_recompile = TRUE)
+  expect_no_error(fit <- mod$sample())
+  expect_equal(fit$log_prob(5), -12.5)
+})",True,False,Implementation / Logic,6
stan-dev,cmdstanr,3558eda7dd25997211b30de9f3a81a8825c6502c,jgabry,jgabry@gmail.com,2023-07-30T17:48:13Z,jgabry,jgabry@gmail.com,2023-07-30T17:48:13Z,fix link to optimize method doc,R/model.R;man/model-method-laplace.Rd,False,True,True,False,4,4,8,"---FILE: R/model.R---
@@ -1488,14 +1488,14 @@ CmdStanModel$set(""public"", name = ""optimize"", value = optimize)
 #'   of the following:
 #'   * A [`CmdStanMLE`] object from a previous run of [`$optimize()`][model-method-optimize].
 #'   * The path to a CmdStan CSV file from running optimization.
-#'   * `NULL`, in which case [$optimize()][fit-method-optimize] will be run
+#'   * `NULL`, in which case [$optimize()][model-method-optimize] will be run
 #'   with `jacobian=jacobian` (see the `jacobian` argument below).
 #'
 #'   In all cases the total time reported by [`$time()`][fit-method-time] will be
 #'   the time of the Laplace sampling step only and does not include the time
 #'   taken to run the `$optimize()` method.
 #' @param opt_args (named list) A named list of optional arguments to pass to
-#'   [$optimize()][fit-method-optimize] if `mode=NULL`.
+#'   [$optimize()][model-method-optimize] if `mode=NULL`.
 #' @param draws (positive integer) The number of draws to take.
 #' @param jacobian (logical) Whether or not to enable the Jacobian adjustment
 #'   for constrained parameters. The default is `TRUE`. See the

---FILE: man/model-method-laplace.Rd---
@@ -118,7 +118,7 @@ of the following:
 \itemize{
 \item A \code{\link{CmdStanMLE}} object from a previous run of \code{\link[=model-method-optimize]{$optimize()}}.
 \item The path to a CmdStan CSV file from running optimization.
-\item \code{NULL}, in which case \link[=fit-method-optimize]{$optimize()} will be run
+\item \code{NULL}, in which case \link[=model-method-optimize]{$optimize()} will be run
 with \code{jacobian=jacobian} (see the \code{jacobian} argument below).
 }
 
@@ -127,7 +127,7 @@ the time of the Laplace sampling step only and does not include the time
 taken to run the \verb{$optimize()} method.}
 
 \item{opt_args}{(named list) A named list of optional arguments to pass to
-\link[=fit-method-optimize]{$optimize()} if \code{mode=NULL}.}
+\link[=model-method-optimize]{$optimize()} if \code{mode=NULL}.}
 
 \item{jacobian}{(logical) Whether or not to enable the Jacobian adjustment
 for constrained parameters. The default is \code{TRUE}. See the",True,False,Documentation / Formatting,7
stan-dev,cmdstanr,c998ace3f9745859a061ec8fef4f87a66bb28f2b,jgabry,jgabry@gmail.com,2023-07-29T19:57:17Z,jgabry,jgabry@gmail.com,2023-07-29T19:57:17Z,fix test,tests/testthat/test-model-optimize.R,False,True,True,False,1,1,2,"---FILE: tests/testthat/test-model-optimize.R---
@@ -150,5 +150,5 @@ test_that(""optimize() recognizes new jacobian argument"", {
   expect_equal(fit$metadata()$jacobian, 0)
 
   fit2 <- mod$optimize(data = data_list, jacobian = TRUE)
-  expect_equal(fit$metadata()$jacobian, 1)
+  expect_equal(fit2$metadata()$jacobian, 1)
 })",True,False,Implementation / Logic,6
stan-dev,cmdstanr,407db8c5350a958a0e4027783ad066977d9b45c6,jgabry,jgabry@gmail.com,2023-07-27T23:31:52Z,jgabry,jgabry@gmail.com,2023-07-27T23:31:52Z,fix web page that didn't update,docs/reference/Rplot001.png;docs/reference/Rplot002.png;docs/reference/cmdstanr-package-1.png;docs/reference/cmdstanr-package-2.png;docs/reference/cmdstanr-package.html,False,False,False,False,8,11,19,"---FILE: docs/reference/cmdstanr-package.html---
@@ -133,13 +133,10 @@ <h3 id=""different-ways-of-interfacing-with-stan-s-c-"">Different ways of interfac
 <div class=""section"">
 <h3 id=""advantages-of-rstan"">Advantages of RStan<a class=""anchor"" aria-label=""anchor"" href=""#advantages-of-rstan""></a></h3>
 
-<ul><li><p>Advanced features. We are working on making these available outside of
-RStan but currently they are only available to R users via RStan:</p><ul><li><p><code><a href=""https://mc-stan.org/rstan/reference/stanfit-method-logprob.html"" class=""external-link"">rstan::log_prob()</a></code></p></li>
-<li><p><code><a href=""https://mc-stan.org/rstan/reference/stanfit-method-logprob.html"" class=""external-link"">rstan::grad_log_prob()</a></code></p></li>
-<li><p><code><a href=""https://mc-stan.org/rstan/reference/expose_stan_functions.html"" class=""external-link"">rstan::expose_stan_functions()</a></code></p></li>
-</ul></li>
-<li><p>Allows other developers to distribute R packages with <em>pre-compiled</em>
+<ul><li><p>Allows other developers to distribute R packages with <em>pre-compiled</em>
 Stan programs (like <strong>rstanarm</strong>) on CRAN.</p></li>
+<li><p>Avoids use of R6 classes, which may result in more familiar syntax for
+many R users.</p></li>
 </ul></div>
 
 <div class=""section"">
@@ -151,7 +148,6 @@ <h3 id=""advantages-of-cmdstanr"">Advantages of CmdStanR<a class=""anchor"" aria-lab
 <strong>StanHeaders</strong>. With CmdStanR the latest improvements in Stan will be
 available from R immediately after updating CmdStan using
 <code><a href=""install_cmdstan.html"">cmdstanr::install_cmdstan()</a></code>.</p></li>
-<li><p>Fewer installation issues (e.g., no need to mess with Makevars files).</p></li>
 <li><p>Running Stan via external processes results in fewer unexpected
 crashes, especially in RStudio.</p></li>
 <li><p>Less memory overhead.</p></li>
@@ -199,6 +195,7 @@ <h2>Examples</h2>
 <span class=""r-in""><span><span class=""co""># here using the example model that comes with CmdStan</span></span></span>
 <span class=""r-in""><span><span class=""va"">file</span> <span class=""op"">&lt;-</span> <span class=""fu""><a href=""https://rdrr.io/r/base/file.path.html"" class=""external-link"">file.path</a></span><span class=""op"">(</span><span class=""fu""><a href=""set_cmdstan_path.html"">cmdstan_path</a></span><span class=""op"">(</span><span class=""op"">)</span>, <span class=""st"">""examples/bernoulli/bernoulli.stan""</span><span class=""op"">)</span></span></span>
 <span class=""r-in""><span><span class=""va"">mod</span> <span class=""op"">&lt;-</span> <span class=""fu""><a href=""cmdstan_model.html"">cmdstan_model</a></span><span class=""op"">(</span><span class=""va"">file</span><span class=""op"">)</span></span></span>
+<span class=""r-msg co""><span class=""r-pr"">#&gt;</span> Model executable is up to date!</span>
 <span class=""r-in""><span><span class=""va"">mod</span><span class=""op"">$</span><span class=""fu"">print</span><span class=""op"">(</span><span class=""op"">)</span></span></span>
 <span class=""r-out co""><span class=""r-pr"">#&gt;</span> data {</span>
 <span class=""r-out co""><span class=""r-pr"">#&gt;</span>   int&lt;lower=0&gt; N;</span>
@@ -334,7 +331,7 @@ <h2>Examples</h2>
 <span class=""r-in""><span></span></span>
 <span class=""r-in""><span><span class=""co""># Call CmdStan's diagnose and stansummary utilities</span></span></span>
 <span class=""r-in""><span><span class=""va"">fit_mcmc</span><span class=""op"">$</span><span class=""fu"">cmdstan_diagnose</span><span class=""op"">(</span><span class=""op"">)</span></span></span>
-<span class=""r-out co""><span class=""r-pr"">#&gt;</span> Processing csv files: /var/folders/s0/zfzm55px2nd2v__zlw5xfj2h0000gn/T/RtmpFBtN6X/bernoulli-202307251435-1-2078cc.csv, /var/folders/s0/zfzm55px2nd2v__zlw5xfj2h0000gn/T/RtmpFBtN6X/bernoulli-202307251435-2-2078cc.csv</span>
+<span class=""r-out co""><span class=""r-pr"">#&gt;</span> Processing csv files: /var/folders/s0/zfzm55px2nd2v__zlw5xfj2h0000gn/T/Rtmp9Z3PNu/bernoulli-202307271729-1-67e85d.csv, /var/folders/s0/zfzm55px2nd2v__zlw5xfj2h0000gn/T/Rtmp9Z3PNu/bernoulli-202307271729-2-67e85d.csv</span>
 <span class=""r-out co""><span class=""r-pr"">#&gt;</span> </span>
 <span class=""r-out co""><span class=""r-pr"">#&gt;</span> Checking sampler transitions treedepth.</span>
 <span class=""r-out co""><span class=""r-pr"">#&gt;</span> Treedepth satisfactory for all transitions.</span>
@@ -406,8 +403,8 @@ <h2>Examples</h2>
 <span class=""r-out co""><span class=""r-pr"">#&gt;</span>   This procedure has not been thoroughly tested and may be unstable </span>
 <span class=""r-out co""><span class=""r-pr"">#&gt;</span>   or buggy. The interface is subject to change. </span>
 <span class=""r-out co""><span class=""r-pr"">#&gt;</span> ------------------------------------------------------------ </span>
-<span class=""r-out co""><span class=""r-pr"">#&gt;</span> Gradient evaluation took 6e-06 seconds </span>
-<span class=""r-out co""><span class=""r-pr"">#&gt;</span> 1000 transitions using 10 leapfrog steps per transition would take 0.06 seconds. </span>
+<span class=""r-out co""><span class=""r-pr"">#&gt;</span> Gradient evaluation took 5e-06 seconds </span>
+<span class=""r-out co""><span class=""r-pr"">#&gt;</span> 1000 transitions using 10 leapfrog steps per transition would take 0.05 seconds. </span>
 <span class=""r-out co""><span class=""r-pr"">#&gt;</span> Adjust your expectations accordingly! </span>
 <span class=""r-out co""><span class=""r-pr"">#&gt;</span> Begin eta adaptation. </span>
 <span class=""r-out co""><span class=""r-pr"">#&gt;</span> Iteration:   1 / 250 [  0%]  (Adaptation) </span>
@@ -505,7 +502,7 @@ <h2>Examples</h2>
 <span class=""r-out co""><span class=""r-pr"">#&gt;</span> </span>
 <span class=""r-out co""><span class=""r-pr"">#&gt;</span> Both chains finished successfully.</span>
 <span class=""r-out co""><span class=""r-pr"">#&gt;</span> Mean chain execution time: 0.0 seconds.</span>
-<span class=""r-out co""><span class=""r-pr"">#&gt;</span> Total execution time: 0.4 seconds.</span>
+<span class=""r-out co""><span class=""r-pr"">#&gt;</span> Total execution time: 0.3 seconds.</span>
 <span class=""r-out co""><span class=""r-pr"">#&gt;</span> </span>
 <span class=""r-in""><span><span class=""va"">fit_optim_w_init_list</span> <span class=""op"">&lt;-</span> <span class=""va"">mod</span><span class=""op"">$</span><span class=""fu"">optimize</span><span class=""op"">(</span></span></span>
 <span class=""r-in""><span>  data <span class=""op"">=</span> <span class=""va"">stan_data</span>,</span></span>",False,False,Dependency / Package,1
stan-dev,cmdstanr,b5a33bfb588afb885a565126419f228247487c39,jgabry,jgabry@gmail.com,2023-07-27T18:25:25Z,jgabry,jgabry@gmail.com,2023-07-27T18:25:25Z,"Store return codes instead of always querying exit status

fixes #780",R/fit.R;fit-temp.rds;tests/testthat/test-fit-shared.R,False,True,True,False,7,4,11,"---FILE: R/fit.R---
@@ -14,6 +14,8 @@ CmdStanFit <- R6::R6Class(
       checkmate::assert_r6(runset, classes = ""CmdStanRun"")
       self$runset <- runset
 
+      private$return_codes_ <- self$runset$procs$return_codes()
+
       private$model_methods_env_ <- new.env()
       if (!is.null(runset$model_methods_env())) {
         for (n in ls(runset$model_methods_env(), all.names = TRUE)) {
@@ -33,8 +35,7 @@ CmdStanFit <- R6::R6Class(
       }
       # Need to update the output directory path to one that can be accessed
       # from Windows, for the post-processing of results
-      self$runset$args$output_dir <- wsl_safe_path(self$runset$args$output_dir,
-                                                    revert = TRUE)
+      self$runset$args$output_dir <- wsl_safe_path(self$runset$args$output_dir, revert = TRUE)
       invisible(self)
     },
     num_procs = function() {
@@ -91,7 +92,8 @@ CmdStanFit <- R6::R6Class(
     metadata_ = NULL,
     init_ = NULL,
     profiles_ = NULL,
-    model_methods_env_ = NULL
+    model_methods_env_ = NULL,
+    return_codes_ = NULL
   )
 )
 
@@ -1129,7 +1131,7 @@ CmdStanFit$set(""public"", name = ""metadata"", value = metadata)
 #' }
 #'
 return_codes <- function() {
-  self$runset$procs$return_codes()
+  private$return_codes_
 }
 CmdStanFit$set(""public"", name = ""return_codes"", value = return_codes)
 

---FILE: tests/testthat/test-fit-shared.R---
@@ -164,6 +164,7 @@ test_that(""save_object() method works"", {
     fit$save_object(temp_rds_file)
     fit2 <- readRDS(temp_rds_file)
     expect_identical(fit2$summary(), fit$summary())
+    expect_identical(fit2$return_codes(), fit$return_codes())
   }
 
   # check after garbage collection too",True,False,Data / Input Handling,6
stan-dev,cmdstanr,0af482832c6e1f6898e78bb4cffa4107a9bc90c0,jgabry,jgabry@gmail.com,2023-07-26T01:08:16Z,jgabry,jgabry@gmail.com,2023-07-26T01:08:16Z,"temporary work around pkgdown formatting issue with posterior draws_summary

the hack of using print.data.frame in chunks with echo=FALSE
is used because the pillar formatting of posterior draws_summary objects
isn't playing nicely with pkgdown::build_articles().",vignettes/children/comparison-with-rstan.md;vignettes/cmdstanr.Rmd;vignettes/posterior.Rmd,True,False,True,False,107,22,129,"---FILE: vignettes/children/comparison-with-rstan.md---
@@ -22,8 +22,6 @@ package and new CRAN releases of both **rstan** and **StanHeaders**. With
 CmdStanR the latest improvements in Stan will be available from R immediately
 after updating CmdStan using `cmdstanr::install_cmdstan()`.
 
-* Fewer installation issues (e.g., no need to mess with Makevars files).
-
 * Running Stan via external processes results in fewer unexpected crashes,
 especially in RStudio.
 

---FILE: vignettes/cmdstanr.Rmd---
@@ -18,11 +18,11 @@ vignette: >
 
 ## Introduction
 
-CmdStanR is a lightweight interface to [Stan](https://mc-stan.org/) for R users
-(see [CmdStanPy](https://github.com/stan-dev/cmdstanpy) for Python) that
-provides an alternative to the traditional [RStan](https://mc-stan.org/rstan/)
-interface. See the [*Comparison with RStan*](#comparison-with-rstan) section
-later in this vignette for more details on how the two interfaces differ.
+CmdStanR (Command Stan R) is a lightweight interface to
+[Stan](https://mc-stan.org/) for R users that provides an alternative to the
+traditional [RStan](https://mc-stan.org/rstan/) interface. See the [*Comparison
+with RStan*](#comparison-with-rstan) section later in this vignette for more
+details on how the two interfaces differ.
 
 **CmdStanR is not on CRAN yet**, but the beta release can be installed by
 running the following command in R.
@@ -38,7 +38,6 @@ later in examples.
 
 ```{r library, message=FALSE}
 library(cmdstanr)
-check_cmdstan_toolchain(fix = TRUE, quiet = TRUE)
 library(posterior)
 library(bayesplot)
 color_scheme_set(""brightblue"")
@@ -188,7 +187,7 @@ first argument specifies the variables to summarize and any arguments
 after that are passed on to `posterior::summarise_draws()` to specify
 which summaries to compute, whether to use multiple cores, etc.
 
-```{r summary}
+```{r summary, eval=FALSE}
 fit$summary()
 fit$summary(variables = c(""theta"", ""lp__""), ""mean"", ""sd"")
 
@@ -203,6 +202,24 @@ fit$summary(
 )
 ```
 
+```{r, echo=FALSE}
+# NOTE: the hack of using print.data.frame in chunks with echo=FALSE 
+# is used because the pillar formatting of posterior draws_summary objects
+# isn't playing nicely with pkgdown::build_articles(). 
+options(digits = 2)
+print.data.frame(fit$summary())
+
+print.data.frame(fit$summary(variables = c(""theta"", ""lp__""), ""mean"", ""sd""))
+
+print.data.frame(fit$summary(""theta"", pr_lt_half = ~ mean(. <= 0.5)))
+
+print.data.frame(fit$summary(
+  variables = NULL,
+  posterior::default_summary_measures(),
+  extra_quantiles = ~posterior::quantile2(., probs = c(.0275, .975))
+))
+```
+
 #### CmdStan's stansummary utility
 
 CmdStan itself provides a `stansummary` utility that can be called using the
@@ -334,11 +351,20 @@ the `$sample()` method demonstrated above.
 
 We can find the (penalized) maximum likelihood estimate (MLE) using [`$optimize()`](https://mc-stan.org/cmdstanr/reference/model-method-optimize.html).
 
-```{r optimize}
+```{r optimize, eval=FALSE}
 fit_mle <- mod$optimize(data = data_list, seed = 123)
 fit_mle$summary() # includes lp__ (log prob calculated by Stan program)
 fit_mle$mle(""theta"")
 ```
+```{r, echo=FALSE}
+# NOTE: the hack of using print.data.frame in chunks with echo=FALSE 
+# is used because the pillar formatting of posterior draws_summary objects
+# isn't playing nicely with pkgdown::build_articles(). 
+options(digits = 2)
+fit_mle <- mod$optimize(data = data_list, seed = 123)
+print.data.frame(fit_mle$summary()) # includes lp__ (log prob calculated by Stan program)
+fit_mle$mle(""theta"")
+```
 
 Here's a plot comparing the penalized MLE to the posterior distribution of
 `theta`.
@@ -354,10 +380,18 @@ We can run Stan's experimental variational Bayes algorithm (ADVI) using the
 [`$variational()`](https://mc-stan.org/cmdstanr/reference/model-method-variational.html)
 method.
 
-```{r variational}
+```{r variational, eval=FALSE}
 fit_vb <- mod$variational(data = data_list, seed = 123, output_samples = 4000)
 fit_vb$summary(""theta"")
 ```
+```{r, echo=FALSE}
+# NOTE: the hack of using print.data.frame in chunks with echo=FALSE 
+# is used because the pillar formatting of posterior draws_summary objects
+# isn't playing nicely with pkgdown::build_articles(). 
+options(digits = 2)
+fit_vb <- mod$variational(data = data_list, seed = 123, output_samples = 4000)
+print.data.frame(fit_vb$summary(""theta""))
+```
 
 The `$draws()` method can be used to access the approximate posterior draws.
 Let's extract the draws, make the same plot we made after MCMC, and compare the

---FILE: vignettes/posterior.Rmd---
@@ -15,38 +15,62 @@ vignette: >
 ```{r child=""children/_settings-knitr.Rmd""}
 ```
 
+<!-- 
+NOTE: the hack below of using print.data.frame in chunks with echo=FALSE 
+is used because the pillar formatting of posterior draws_summary objects
+isn't playing nicely with pkgdown::build_articles(). When that is fixed
+using options(digits=2) won't be necessary anymore.
+-->
+```{r, include=FALSE}
+options(digits=2)
+```
+
 ## Summary
 
 We can easily customise the summary statistics reported by `$summary()` and `$print()`.
 
-```{r}
+```{r eval=FALSE}
 fit <- cmdstanr::cmdstanr_example(""schools"", method = ""sample"")
 fit$summary()
 ```
+```{r echo=FALSE}
+fit <- cmdstanr::cmdstanr_example(""schools"", method = ""sample"")
+print.data.frame(fit$summary())
+```
 
 By default all variables are summaries with the follow functions:
 ```{r}
 posterior::default_summary_measures()
 ```
 
 To change the variables summarised, we use the variables argument
-```{r}
+```{r eval=FALSE}
 fit$summary(variables = c(""mu"", ""tau""))
 ```
+```{r echo=FALSE}
+print.data.frame(fit$summary(variables = c(""mu"", ""tau"")))
+```
 
 We can additionally change which functions are used
-```{r}
+```{r eval=FALSE}
 fit$summary(variables = c(""mu"", ""tau""), mean, sd)
 ```
+```{r echo=FALSE}
+print.data.frame(fit$summary(variables = c(""mu"", ""tau""), mean, sd))
+```
 
 To summarise all variables with non-default functions, it is necessary to set explicitly set the variables argument, either to `NULL` or the full vector of variable names.
-```{r}
+```{r eval=FALSE}
 fit$metadata()$model_params
 fit$summary(variables = NULL, ""mean"", ""median"")
 ```
+```{r echo=FALSE}
+fit$metadata()$model_params
+print.data.frame(fit$summary(variables = NULL, ""mean"", ""median""))
+```
 
 Summary functions can be specified by character string, function, or using a formula (or anything else supported by [rlang::as_function]). If these arguments are named, those names will be used in the tibble output. If the summary results are named they will take precedence.
-```{r}
+```{r eval=FALSE}
 my_sd <- function(x) c(My_SD = sd(x))
 fit$summary(
   c(""mu"", ""tau""), 
@@ -57,28 +81,57 @@ fit$summary(
   Minimum = function(x) min(x)
 )        
 ```
+```{r echo=FALSE}
+my_sd <- function(x) c(My_SD = sd(x))
+print.data.frame(fit$summary(
+  c(""mu"", ""tau""), 
+  MEAN = mean, 
+  ""median"",
+  my_sd,
+  ~quantile(.x, probs = c(0.1, 0.9)),
+  Minimum = function(x) min(x)
+))
+```
+
 
 Arguments to all summary functions can also be specified with `.args`. 
-```{r}
+```{r eval=FALSE}
 fit$summary(c(""mu"", ""tau""), quantile, .args = list(probs = c(0.025, .05, .95, .975)))
 ```
+```{r echo=FALSE}
+print.data.frame(fit$summary(c(""mu"", ""tau""), quantile, .args = list(probs = c(0.025, .05, .95, .975))))
+```
 
 The summary functions are applied to the array of sample values, with dimension `iter_sampling`x`chains`.
-```{r}
+```{r eval=FALSE}
 fit$summary(variables = NULL, dim, colMeans)
 ```
+```{r echo=FALSE}
+print.data.frame(fit$summary(variables = NULL, dim, colMeans))
+```
 
-For this reason users may have unexpected results if they use [stats::var()] directly, as it will return a covariance matrix. An alternative is the [distributional::variance] function.
-```{r}
-fit$summary(c(""mu"", ""tau""), distributional::variance, ~var(as.vector(.x)))
+
+For this reason users may have unexpected results if they use `stats::var()` directly, as it will return a covariance matrix. An alternative is the `distributional::variance()` function, 
+which can also be accessed via `posterior::variance()`.
+```{r eval=FALSE}
+fit$summary(c(""mu"", ""tau""), posterior::variance, ~var(as.vector(.x)))
 ```
+```{r echo=FALSE}
+print.data.frame(fit$summary(c(""mu"", ""tau""), posterior::variance, ~var(as.vector(.x))))
+```
+
 
 Summary functions need not be numeric, but these won't work with `$print()`.
 
-```{r}
+```{r eval=FALSE}
 strict_pos <- function(x) if (all(x > 0)) ""yes"" else ""no""
 fit$summary(variables = NULL, ""Strictly Positive"" = strict_pos)
 # fit$print(variables = NULL, ""Strictly Positive"" = strict_pos)
 ```
+```{r echo=FALSE}
+strict_pos <- function(x) if (all(x > 0)) ""yes"" else ""no""
+print.data.frame(fit$summary(variables = NULL, ""Strictly Positive"" = strict_pos))
+# fit$print(variables = NULL, ""Strictly Positive"" = strict_pos)
+```
 
 For more information, see `posterior::summarise_draws()`, which is called by `$summary()`.",False,True,Documentation / Formatting,7
stan-dev,cmdstanr,3303838e3651ad479494eb6fc923e5a7f294f6b7,jgabry,jgabry@gmail.com,2023-07-25T21:19:35Z,jgabry,jgabry@gmail.com,2023-07-25T21:19:35Z,"minor vignette fixes

* now need to use underscore in file name for including the knitr settings (to avoid it being treated as its own vignette)
* fix array syntax in a few cases",vignettes/articles-online-only/opencl-files/bernoulli_logit_glm.stan;vignettes/articles-online-only/opencl.Rmd;vignettes/children/_settings-knitr.Rmd;vignettes/children/comparison-with-rstan.md;vignettes/cmdstanr-internals.Rmd;vignettes/cmdstanr.Rmd;vignettes/deprecations.Rmd;vignettes/posterior.Rmd;vignettes/profiling.Rmd,True,False,True,False,12,16,28,"---FILE: vignettes/articles-online-only/opencl-files/bernoulli_logit_glm.stan---
@@ -2,7 +2,7 @@ data {
   int<lower=1> k;
   int<lower=0> n;
   matrix[n, k] X;
-  int y[n];
+  array[n] int y;
 }
 parameters {
   vector[k] beta;

---FILE: vignettes/articles-online-only/opencl.Rmd---
@@ -13,7 +13,7 @@ vignette: >
   %\VignetteEncoding{UTF-8}
 ---
 
-```{r child=""../children/settings-knitr.Rmd""}
+```{r child=""../children/_settings-knitr.Rmd""}
 ```
 
 ## Introduction

---FILE: vignettes/children/comparison-with-rstan.md---
@@ -9,15 +9,11 @@ results to output files.
 
 ### Advantages of RStan
 
-* Advanced features. We are working on making these available outside of RStan
-but currently they are only available to R users via RStan:
-  - `rstan::log_prob()`
-  - `rstan::grad_log_prob()`
-  - `rstan::expose_stan_functions()`
-
 * Allows other developers to distribute R packages with
 _pre-compiled_ Stan programs (like **rstanarm**) on CRAN.
 
+* Avoids use of R6 classes, which may result in more familiar syntax for many R users. 
+
 ### Advantages of CmdStanR
 
 * Compatible with latest versions of Stan. Keeping up with Stan releases is

---FILE: vignettes/cmdstanr-internals.Rmd---
@@ -13,7 +13,7 @@ vignette: >
   %\VignetteEncoding{UTF-8}
 ---
 
-```{r child=""children/settings-knitr.Rmd""}
+```{r child=""children/_settings-knitr.Rmd""}
 ```
 
 ## Introduction
@@ -127,7 +127,7 @@ is missing a lower bound and a prior for a parameter.
 stan_file_pedantic <- write_stan_file(""
 data {
   int N;
-  int y[N];
+  array[N] int y;
 }
 parameters {
   // should have <lower=0> but omitting to demonstrate pedantic mode
@@ -461,7 +461,7 @@ the save file.
 rm(fit); gc()
 
 fit <- readRDS(temp_rds_file)
-fit$summary()
+fit$print()
 ```
 
 ## Developing using CmdStanR

---FILE: vignettes/cmdstanr.Rmd---
@@ -13,7 +13,7 @@ vignette: >
   %\VignetteEncoding{UTF-8}
 ---
 
-```{r child=""children/settings-knitr.Rmd""}
+```{r child=""children/_settings-knitr.Rmd""}
 ```
 
 ## Introduction

---FILE: vignettes/deprecations.Rmd---
@@ -13,7 +13,7 @@ vignette: >
   %\VignetteEncoding{UTF-8}
 ---
 
-```{r child=""children/settings-knitr.Rmd""}
+```{r child=""children/_settings-knitr.Rmd""}
 ```
 
 ## Introduction

---FILE: vignettes/posterior.Rmd---
@@ -12,7 +12,7 @@ vignette: >
   %\VignetteEncoding{UTF-8}
 ---
 
-```{r child=""children/settings-knitr.Rmd""}
+```{r child=""children/_settings-knitr.Rmd""}
 ```
 
 ## Summary
@@ -81,4 +81,4 @@ fit$summary(variables = NULL, ""Strictly Positive"" = strict_pos)
 # fit$print(variables = NULL, ""Strictly Positive"" = strict_pos)
 ```
 
-For more information, see [posterior::summarise_draws()], which is called by `$summary()`.
+For more information, see `posterior::summarise_draws()`, which is called by `$summary()`.

---FILE: vignettes/profiling.Rmd---
@@ -13,7 +13,7 @@ vignette: >
   %\VignetteEncoding{UTF-8}
 ---
 
-```{r child=""children/settings-knitr.Rmd""}
+```{r child=""children/_settings-knitr.Rmd""}
 ```
 
 ## Introduction",False,True,Implementation / Logic,6
stan-dev,cmdstanr,f7d72611d21aa18581deb73c0b37fb7fff21b05d,jgabry,jgabry@gmail.com,2023-07-25T20:32:31Z,jgabry,jgabry@gmail.com,2023-07-25T20:32:31Z,avoid pkgdown error about missing topics,R/csv.R;R/example.R;R/utils.R;_pkgdown.yml;man/read_sample_csv.Rd;man/stan_threads.Rd;man/write_stan_tempfile.Rd,False,True,True,False,8,3,11,"---FILE: R/csv.R---
@@ -422,7 +422,7 @@ read_cmdstan_csv <- function(files,
 #' Read CmdStan CSV files from sampling into \R
 #'
 #' Deprecated. Use [read_cmdstan_csv()] instead.
-#'
+#' @keywords internal
 #' @export
 #' @param files,variables,sampler_diagnostics Deprecated. Use
 #'   [read_cmdstan_csv()] instead.

---FILE: R/example.R---
@@ -188,7 +188,7 @@ write_stan_file <- function(code,
 #' Write Stan code to a temporary file
 #'
 #' This function is deprecated. Please use [write_stan_file()] instead.
-#'
+#' @keywords internal
 #' @export
 #' @inheritParams write_stan_file
 write_stan_tempfile <- function(code, dir = tempdir()) {

---FILE: R/utils.R---
@@ -235,7 +235,7 @@ generate_file_names <-
 #' Set or get the number of threads used to execute Stan models
 #'
 #' DEPRECATED. Please use the `threads_per_chain` argument when fitting the model.
-#'
+#' @keywords internal
 #' @name stan_threads
 NULL
 

---FILE: _pkgdown.yml---
@@ -111,6 +111,8 @@ reference:
       - write_stan_json
       - write_stan_file
       - draws_to_csv
+      - as.mcmc.list
+      - as_draws.CmdStanMCMC
   - title: ""Using CmdStanR with knitr and R Markdown""
     contents:
       - register_knitr_engine

---FILE: man/read_sample_csv.Rd---
@@ -13,3 +13,4 @@ read_sample_csv(files, variables = NULL, sampler_diagnostics = NULL)
 \description{
 Deprecated. Use \code{\link[=read_cmdstan_csv]{read_cmdstan_csv()}} instead.
 }
+\keyword{internal}

---FILE: man/stan_threads.Rd---
@@ -19,3 +19,4 @@ The value of the environment variable \code{STAN_NUM_THREADS}.
 \description{
 DEPRECATED. Please use the \code{threads_per_chain} argument when fitting the model.
 }
+\keyword{internal}

---FILE: man/write_stan_tempfile.Rd---
@@ -20,3 +20,4 @@ is used.}
 \description{
 This function is deprecated. Please use \code{\link[=write_stan_file]{write_stan_file()}} instead.
 }
+\keyword{internal}",True,False,Documentation / Formatting,7
stan-dev,cmdstanr,18dfd3cd204952c3366698c1f16260863e900ab2,jgabry,jgabry@gmail.com,2023-07-25T20:27:39Z,jgabry,jgabry@gmail.com,2023-07-25T20:27:39Z,minor doc fixes,R/fit.R;man/fit-method-constrain_variables.Rd;man/fit-method-grad_log_prob.Rd;man/fit-method-hessian.Rd;man/fit-method-unconstrain_variables.Rd,False,True,True,False,36,34,70,"---FILE: R/fit.R---
@@ -396,10 +396,10 @@ CmdStanFit$set(""public"", name = ""log_prob"", value = log_prob)
 #' @description The `$grad_log_prob()` method provides access to the
 #' Stan model's `log_prob` function and its derivative
 #'
-#' @param unconstrained_variables (numeric) A vector of unconstrained parameters to be passed
-#' to `grad_log_prob`
-#' @param jacobian_adjustment (bool) Whether to include the log-density adjustments from
-#' un/constraining variables
+#' @param unconstrained_variables (numeric) A vector of unconstrained parameters
+#'   to be passed to `grad_log_prob`.
+#' @param jacobian_adjustment (bool) Whether to include the log-density
+#'   adjustments from un/constraining variables.
 #'
 #' @examples
 #' \dontrun{
@@ -434,16 +434,16 @@ CmdStanFit$set(""public"", name = ""grad_log_prob"", value = grad_log_prob)
 #' @description The `$hessian()` method provides access to the
 #' Stan model's `log_prob`, its derivative, and its hessian
 #'
-#' @param unconstrained_variables (numeric) A vector of unconstrained parameters to be passed
-#' to `hessian`
-#' @param jacobian_adjustment (bool) Whether to include the log-density adjustments from
-#' un/constraining variables
+#' @param unconstrained_variables (numeric) A vector of unconstrained parameters
+#'   to be passed to `hessian`.
+#' @param jacobian_adjustment (bool) Whether to include the log-density
+#'   adjustments from un/constraining variables.
 #'
 #' @examples
 #' \dontrun{
-#' fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"")
-#' fit_mcmc$init_model_methods(hessian = TRUE)
-#' fit_mcmc$hessian(unconstrained_variables = c(0.5, 1.2, 1.1, 2.2))
+#' # fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"")
+#' # fit_mcmc$init_model_methods(hessian = TRUE)
+#' # fit_mcmc$hessian(unconstrained_variables = c(0.5, 1.2, 1.1, 2.2))
 #' }
 #'
 #' @seealso [log_prob()], [grad_log_prob()], [constrain_variables()],
@@ -471,8 +471,8 @@ CmdStanFit$set(""public"", name = ""hessian"", value = hessian)
 #' @description The `$unconstrain_variables()` method transforms input parameters to
 #' the unconstrained scale
 #'
-#' @param variables (list) A list of parameter values to transform, in the same format as
-#' provided to the `init` argument of the `$sample()` method
+#' @param variables (list) A list of parameter values to transform, in the same
+#'   format as provided to the `init` argument of the `$sample()` method.
 #'
 #' @examples
 #' \dontrun{
@@ -641,11 +641,12 @@ CmdStanFit$set(""public"", name = ""variable_skeleton"", value = variable_skeleton)
 #' @description The `$constrain_variables()` method transforms input parameters to
 #' the constrained scale
 #'
-#' @param unconstrained_variables (numeric) A vector of unconstrained parameters to constrain
-#' @param transformed_parameters (boolean) Whether to return transformed parameters
-#'  implied by newly-constrained parameters (defaults to TRUE)
+#' @param unconstrained_variables (numeric) A vector of unconstrained parameters
+#'   to constrain.
+#' @param transformed_parameters (boolean) Whether to return transformed
+#'   parameters implied by newly-constrained parameters (defaults to TRUE).
 #' @param generated_quantities (boolean) Whether to return generated quantities
-#'  implied by newly-constrained parameters (defaults to TRUE)
+#'   implied by newly-constrained parameters (defaults to TRUE).
 #'
 #' @examples
 #' \dontrun{

---FILE: man/fit-method-constrain_variables.Rd---
@@ -12,13 +12,14 @@ constrain_variables(
 )
 }
 \arguments{
-\item{unconstrained_variables}{(numeric) A vector of unconstrained parameters to constrain}
+\item{unconstrained_variables}{(numeric) A vector of unconstrained parameters
+to constrain.}
 
-\item{transformed_parameters}{(boolean) Whether to return transformed parameters
-implied by newly-constrained parameters (defaults to TRUE)}
+\item{transformed_parameters}{(boolean) Whether to return transformed
+parameters implied by newly-constrained parameters (defaults to TRUE).}
 
 \item{generated_quantities}{(boolean) Whether to return generated quantities
-implied by newly-constrained parameters (defaults to TRUE)}
+implied by newly-constrained parameters (defaults to TRUE).}
 }
 \description{
 The \verb{$constrain_variables()} method transforms input parameters to

---FILE: man/fit-method-grad_log_prob.Rd---
@@ -9,11 +9,11 @@ given vector of unconstrained parameters}
 grad_log_prob(unconstrained_variables, jacobian_adjustment = TRUE)
 }
 \arguments{
-\item{unconstrained_variables}{(numeric) A vector of unconstrained parameters to be passed
-to \code{grad_log_prob}}
+\item{unconstrained_variables}{(numeric) A vector of unconstrained parameters
+to be passed to \code{grad_log_prob}.}
 
-\item{jacobian_adjustment}{(bool) Whether to include the log-density adjustments from
-un/constraining variables}
+\item{jacobian_adjustment}{(bool) Whether to include the log-density
+adjustments from un/constraining variables.}
 }
 \description{
 The \verb{$grad_log_prob()} method provides access to the

---FILE: man/fit-method-hessian.Rd---
@@ -9,21 +9,21 @@ for a given vector of unconstrained parameters}
 hessian(unconstrained_variables, jacobian_adjustment = TRUE)
 }
 \arguments{
-\item{unconstrained_variables}{(numeric) A vector of unconstrained parameters to be passed
-to \code{hessian}}
+\item{unconstrained_variables}{(numeric) A vector of unconstrained parameters
+to be passed to \code{hessian}.}
 
-\item{jacobian_adjustment}{(bool) Whether to include the log-density adjustments from
-un/constraining variables}
+\item{jacobian_adjustment}{(bool) Whether to include the log-density
+adjustments from un/constraining variables.}
 }
 \description{
 The \verb{$hessian()} method provides access to the
 Stan model's \code{log_prob}, its derivative, and its hessian
 }
 \examples{
 \dontrun{
-fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"")
-fit_mcmc$init_model_methods(hessian = TRUE)
-fit_mcmc$hessian(unconstrained_variables = c(0.5, 1.2, 1.1, 2.2))
+# fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"")
+# fit_mcmc$init_model_methods(hessian = TRUE)
+# fit_mcmc$hessian(unconstrained_variables = c(0.5, 1.2, 1.1, 2.2))
 }
 
 }

---FILE: man/fit-method-unconstrain_variables.Rd---
@@ -8,8 +8,8 @@
 unconstrain_variables(variables)
 }
 \arguments{
-\item{variables}{(list) A list of parameter values to transform, in the same format as
-provided to the \code{init} argument of the \verb{$sample()} method}
+\item{variables}{(list) A list of parameter values to transform, in the same
+format as provided to the \code{init} argument of the \verb{$sample()} method.}
 }
 \description{
 The \verb{$unconstrain_variables()} method transforms input parameters to",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,23ea8303c090490e03313feb66ff80037244624f,dependabot[bot],49699333+dependabot[bot]@users.noreply.github.com,2023-07-17T18:21:45Z,GitHub,noreply@github.com,2023-07-17T18:21:45Z,"Bump r-lib/actions from 2.6.3 to 2.6.4

Bumps [r-lib/actions](https://github.com/r-lib/actions) from 2.6.3 to 2.6.4.
- [Release notes](https://github.com/r-lib/actions/releases)
- [Commits](https://github.com/r-lib/actions/compare/v2.6.3...v2.6.4)

---
updated-dependencies:
- dependency-name: r-lib/actions
  dependency-type: direct:production
  update-type: version-update:semver-patch
...

Signed-off-by: dependabot[bot] <support@github.com>",.github/workflows/R-CMD-check-wsl.yaml;.github/workflows/R-CMD-check.yaml;.github/workflows/Test-coverage.yaml;.github/workflows/cmdstan-tarball-check.yaml,False,False,False,False,10,10,20,"---FILE: .github/workflows/R-CMD-check-wsl.yaml---
@@ -37,11 +37,11 @@ jobs:
 
       - uses: actions/checkout@v3
 
-      - uses: r-lib/actions/setup-r@v2.6.3
+      - uses: r-lib/actions/setup-r@v2.6.4
         with:
           r-version: 'release'
           rtools-version: '42'
-      - uses: r-lib/actions/setup-pandoc@v2.6.3
+      - uses: r-lib/actions/setup-pandoc@v2.6.4
 
       - name: Query dependencies
         run: |

---FILE: .github/workflows/R-CMD-check.yaml---
@@ -56,11 +56,11 @@ jobs:
           sudo apt-get install -y libcurl4-openssl-dev || true
           sudo apt-get install -y openmpi-bin openmpi-common libopenmpi-dev || true
 
-      - uses: r-lib/actions/setup-r@v2.6.3
+      - uses: r-lib/actions/setup-r@v2.6.4
         with:
           r-version: ${{ matrix.config.r }}
           rtools-version: ${{ matrix.config.rtools }}
-      - uses: r-lib/actions/setup-pandoc@v2.6.3
+      - uses: r-lib/actions/setup-pandoc@v2.6.4
 
       - name: Query dependencies
         run: |

---FILE: .github/workflows/Test-coverage.yaml---
@@ -34,8 +34,8 @@ jobs:
         if: ""!startsWith(github.ref, 'refs/tags/') && github.ref != 'refs/heads/master'""
       - uses: actions/checkout@v3
 
-      - uses: r-lib/actions/setup-r@v2.6.3
-      - uses: r-lib/actions/setup-pandoc@v2.6.3
+      - uses: r-lib/actions/setup-r@v2.6.4
+      - uses: r-lib/actions/setup-pandoc@v2.6.4
 
       - name: Install Ubuntu dependencies
         run: |
@@ -85,12 +85,12 @@ jobs:
     steps:
       - uses: actions/checkout@v3
 
-      - uses: r-lib/actions/setup-r@v2.6.3
+      - uses: r-lib/actions/setup-r@v2.6.4
         with:
           r-version: 'release'
           rtools-version: '42'
 
-      - uses: r-lib/actions/setup-pandoc@v2.6.3
+      - uses: r-lib/actions/setup-pandoc@v2.6.4
 
       - name: Query dependencies
         run: |

---FILE: .github/workflows/cmdstan-tarball-check.yaml---
@@ -40,12 +40,12 @@ jobs:
           sudo apt-get install -y libcurl4-openssl-dev || true
           sudo apt-get install -y openmpi-bin openmpi-common libopenmpi-dev || true
 
-      - uses: r-lib/actions/setup-r@v2.6.3
+      - uses: r-lib/actions/setup-r@v2.6.4
         with:
           r-version: ${{ matrix.config.r }}
           rtools-version: ${{ matrix.config.rtools }}
 
-      - uses: r-lib/actions/setup-pandoc@v2.6.3
+      - uses: r-lib/actions/setup-pandoc@v2.6.4
 
       - name: Query dependencies
         run: |",False,False,Rendering / Conversion,3
stan-dev,cmdstanr,3238f2bfcff62496fb20d9cfce53d3755595bfee,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-06-24T18:01:27Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-06-24T18:01:27Z,Temporarily skip CI failures,tests/testthat/helper-custom-expectations.R,False,True,True,False,1,1,2,"---FILE: tests/testthat/helper-custom-expectations.R---
@@ -41,7 +41,7 @@ expect_gq_output <- function(object, num_chains = NULL) {
 expect_interactive_message <- function(object, regexp = NULL) {
   # Non-interactive message suppression failing under Windows CI,
   # temporarily skip message check only on Windows
-  if (os_is_windows()) {
+  if (os_is_windows() && !os_is_wsl()) {
     return(object)
   }
   if (interactive()) {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,404ad1e84e32d23fb57813dc8b7ba6f86e80dc9c,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-06-24T18:00:29Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-06-24T18:00:29Z,Temporarily skip CI failures,tests/testthat/helper-custom-expectations.R;tests/testthat/test-json.R,False,True,True,False,12,2,14,"---FILE: tests/testthat/helper-custom-expectations.R---
@@ -39,6 +39,11 @@ expect_gq_output <- function(object, num_chains = NULL) {
 }
 
 expect_interactive_message <- function(object, regexp = NULL) {
+  # Non-interactive message suppression failing under Windows CI,
+  # temporarily skip message check only on Windows
+  if (os_is_windows()) {
+    return(object)
+  }
   if (interactive()) {
     expect_message(object = object, regexp = regexp)
   } else {

---FILE: tests/testthat/test-json.R---
@@ -50,8 +50,13 @@ test_that(""JSON output for data frame and matrix is correct"", {
   json_output_mat <- readLines(temp_file_df)
   json_output_df <- readLines(temp_file_mat)
   expect_identical(json_output_df, json_output_mat)
-  expect_known_output(cat(json_output_df, sep = ""\n""),
-                      file = test_path(""answers"", ""json-df-matrix.json""))
+
+  # Floating-point error introduced in jsonlite 1.8.5
+  # https://github.com/jeroen/jsonlite/issues/420
+  if (packageVersion(""jsonlite"") != ""1.8.5"") {
+    expect_known_output(cat(json_output_df, sep = ""\n""),
+                        file = test_path(""answers"", ""json-df-matrix.json""))
+  }
 })
 
 test_that(""JSON output for list of vectors is correct"", {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,11df82876e590c4ed3e91757853a03b65e7484e5,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-06-23T20:36:41Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-06-23T20:36:41Z,Suppress windows error for now,tests/testthat/test-knitr.R,False,True,True,False,3,1,4,"---FILE: tests/testthat/test-knitr.R---
@@ -22,7 +22,9 @@ test_that(""eng_cmdstan works"", {
     cache = TRUE,
     cache.path = tempdir()
   ))
-  expect_interactive_message(eng_cmdstan(opts), ""Compiling Stan program"")
+  if (!os_is_windows()) {
+    expect_interactive_message(eng_cmdstan(opts), ""Compiling Stan program"")
+  }
   opts$eval <- FALSE
   expect_silent(eng_cmdstan(opts))
 })",True,False,Implementation / Logic,3
stan-dev,cmdstanr,eee6b9678c6f004f7407d3338fb02ccf7016ae38,Adrian Lison,adrian.lison@bsse.ethz.ch,2023-06-22T11:22:25Z,Adrian Lison,adrian.lison@bsse.ethz.ch,2023-06-22T11:22:25Z,Fix bug in check_syntax and format with include_paths on compiled model,R/model.R,False,True,True,False,3,3,6,"---FILE: R/model.R---
@@ -784,8 +784,8 @@ check_syntax <- function(pedantic = FALSE,
   if (length(stanc_options) == 0 && !is.null(private$precompile_stanc_options_)) {
     stanc_options <- private$precompile_stanc_options_
   }
-  if (is.null(include_paths) && !is.null(private$precompile_include_paths_)) {
-    include_paths <- private$precompile_include_paths_
+  if (is.null(include_paths) && !is.null(self$include_paths())) {
+    include_paths <- self$include_paths()
   }
 
   temp_hpp_file <- tempfile(pattern = ""model-"", fileext = "".hpp"")
@@ -922,7 +922,7 @@ format <- function(overwrite_file = FALSE,
     lower = 1, len = 1, null.ok = TRUE
   )
   stanc_options <- private$precompile_stanc_options_
-  stancflags_val <- include_paths_stanc3_args(private$precompile_include_paths_)
+  stancflags_val <- include_paths_stanc3_args(self$include_paths())
   stanc_options[""auto-format""] <- TRUE
   if (!is.null(max_line_length)) {
     stanc_options[""max-line-length""] <- max_line_length",True,False,Implementation / Logic,6
stan-dev,cmdstanr,b189bc8c5f8fecd062a668e22e01416e356c035a,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-05-30T09:25:35Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-05-30T09:25:35Z,Fix functor name,R/utils.R,False,True,True,False,1,1,2,"---FILE: R/utils.R---
@@ -823,7 +823,7 @@ get_plain_rtn <- function(fun_start, fun_end, model_lines) {
   struct_name <- paste0(""struct "", fun_name, ""_functor"")
 
   if (any(grepl(struct_name, model_lines))) {
-    struct_start <- grep(paste0(""struct "", fun_props$name, ""_functor""), model_lines)
+    struct_start <- grep(struct_name, model_lines)
     struct_op_start <- grep(""operator()"", model_lines[-(1:struct_start)])[1] + struct_start
     rtn_type <- paste0(model_lines[struct_start:struct_op_start], collapse = "" "")
     rm_operator <- gsub(""operator().*"", """", rtn_type)",True,False,Implementation / Logic,3
stan-dev,cmdstanr,19b1b2cc696fdbda2f83ee15871fb210c14de2bf,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-05-27T14:39:47Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-05-27T14:39:47Z,Fix expose_functions under 2.32,DESCRIPTION;R/model.R;R/utils.R;tests/testthat/test-model-expose-functions.R,False,True,True,False,73,63,136,"---FILE: DESCRIPTION---
@@ -48,6 +48,5 @@ Suggests:
     rmarkdown,
     testthat (>= 2.1.0),
     Rcpp,
-    RcppEigen,
-    decor
+    RcppEigen
 VignetteBuilder: knitr

---FILE: R/model.R---
@@ -657,7 +657,7 @@ compile <- function(quiet = TRUE,
   private$precompile_stanc_options_ <- NULL
   private$precompile_include_paths_ <- NULL
   private$model_methods_env_ <- new.env()
-  private$model_methods_env_$hpp_code_ <- readLines(private$hpp_file_, warn = FALSE)
+  suppressWarnings(private$model_methods_env_$hpp_code_ <- readLines(private$hpp_file_, warn = FALSE))
   if (compile_model_methods) {
     expose_model_methods(env = private$model_methods_env_,
                           verbose = !quiet,

---FILE: R/utils.R---
@@ -797,41 +797,67 @@ get_standalone_hpp <- function(stan_file, stancflags) {
     name <- strip_ext(basename(stan_file))
     path <- dirname(stan_file)
     hpp_path <- file.path(path, paste0(name, "".hpp""))
-    hpp <- readLines(hpp_path, warn = FALSE)
+    hpp <- suppressWarnings(readLines(hpp_path, warn = FALSE))
     unlink(hpp_path)
     hpp
   } else {
     invisible(NULL)
   }
 }
 
+get_function_name <- function(fun_start, fun_end, model_lines) {
+  fun_string <- paste(model_lines[(fun_start+1):fun_end], collapse = "" "")
+  fun_name <- gsub(""auto "", """", fun_string, fixed = TRUE)
+  sub(""\\(.*"", """", fun_name, perl = TRUE)
+}
+
 # Construct the plain return type for a standalone function by
 # looking up the return type of the functor declaration and replacing
 # the template types (i.e., T0__) with double
-get_plain_rtn <- function(fun_body, model_lines) {
-  fun_string <- paste(fun_body[-1], collapse = ""\n"")
-  fun_props <- decor::parse_cpp_function(fun_string)
-
-  struct_start <- grep(paste0(""struct "", fun_props$name, ""_functor""), model_lines)
-  struct_op_start <- grep(""operator()"", model_lines[-(1:struct_start)])[1] + struct_start
-  rtn_type <- paste0(model_lines[struct_start:struct_op_start], collapse = "" "")
-
-  rm_operator <- gsub(""operator().*"", """", rtn_type)
-  rm_prev <- gsub("".*\\{"", """", rm_operator)
+get_plain_rtn <- function(fun_start, fun_end, model_lines) {
+  fun_name <- get_function_name(fun_start, fun_end, model_lines)
+
+  # Depending on the version of stanc3, the standalone functions
+  # with a plain return type can either be wrapped in a struct as a functor,
+  # or as a separate forward declaration
+  struct_name <- paste0(""struct "", fun_name, ""_functor"")
+
+  if (any(grepl(struct_name, model_lines))) {
+    struct_start <- grep(paste0(""struct "", fun_props$name, ""_functor""), model_lines)
+    struct_op_start <- grep(""operator()"", model_lines[-(1:struct_start)])[1] + struct_start
+    rtn_type <- paste0(model_lines[struct_start:struct_op_start], collapse = "" "")
+    rm_operator <- gsub(""operator().*"", """", rtn_type)
+    rm_prev <- gsub("".*\\{"", """", rm_operator)
+  } else {
+    # Find first declaration of function (will be the forward declaration)
+    first_decl <- grep(paste0(fun_name,""\\(""), model_lines)[1]
+
+    # The return type will be between the function name and the semicolon terminating
+    # the previous line
+    last_scolon <- grep("";"", model_lines[1:first_decl])
+    last_scolon <- ifelse(last_scolon[length(last_scolon)] == first_decl,
+                          last_scolon[length(last_scolon) - 1],
+                          last_scolon[length(last_scolon)])
+    rtn_type_full <- paste0(model_lines[last_scolon:first_decl], collapse = "" "")
+    rm_fun_name <- gsub(paste0(fun_name, "".*""), """", rtn_type_full)
+    rm_prev <- gsub("".*;"", """", rm_fun_name)
+  }
   rm_template <- gsub(""template <typename(.*?)> "", """", rm_prev)
   gsub(""T([0-9])*__"", ""double"", rm_template)
 }
 
+
 # Prepare the c++ code for a standalone function so that it can be exported to R:
 # - Replace the auto return type with the plain type
 # - Add Rcpp::export attribute
 # - Remove the pstream__ argument and pass Rcpp::Rcout by default
 # - Replace the boost::ecuyer1988& base_rng__ argument with an integer seed argument
 #     that instantiates an RNG
-prep_fun_cpp <- function(fun_body, model_lines) {
-  fun_body <- gsub(""auto"", get_plain_rtn(fun_body, model_lines), fun_body)
-  fun_body <- gsub(""// [[stan::function]]"", ""// [[Rcpp::export]]"", fun_body, fixed = TRUE)
-  fun_body <- gsub(""std::ostream* pstream__ = nullptr"", """", fun_body, fixed = TRUE)
+prep_fun_cpp <- function(fun_start, fun_end, model_lines) {
+  fun_body <- paste(model_lines[fun_start:fun_end], collapse = "" "")
+  fun_body <- gsub(""auto"", get_plain_rtn(fun_start, fun_end, model_lines), fun_body)
+  fun_body <- gsub(""// [[stan::function]]"", ""// [[Rcpp::export]]\n"", fun_body, fixed = TRUE)
+  fun_body <- gsub(""std::ostream\\*\\s*pstream__\\s*=\\s*nullptr"", """", fun_body)
   fun_body <- gsub(""boost::ecuyer1988& base_rng__"", ""size_t seed = 0"", fun_body, fixed = TRUE)
   fun_body <- gsub(""base_rng__,"", ""*(new boost::ecuyer1988(seed)),"", fun_body, fixed = TRUE)
   fun_body <- gsub(""pstream__"", ""&Rcpp::Rcout"", fun_body, fixed = TRUE)
@@ -844,12 +870,13 @@ compile_functions <- function(env, verbose = FALSE, global = FALSE) {
   funs <- c(funs, length(env$hpp_code))
 
   stan_funs <- sapply(seq_len(length(funs) - 1), function(ind) {
-    fun_body <- env$hpp_code[funs[ind]:(funs[ind + 1] - 1)]
-    prep_fun_cpp(fun_body, env$hpp_code)
+    fun_end <- funs[ind + 1]
+    fun_end <- ifelse(env$hpp_code[fun_end] == ""}"", fun_end, fun_end - 1)
+    prep_fun_cpp(funs[ind], fun_end, env$hpp_code)
   })
 
-  env$fun_names <- sapply(stan_funs, function(fun) {
-    decor::parse_cpp_function(fun, is_attribute = TRUE)$name
+  env$fun_names <- sapply(seq_len(length(funs) - 1), function(ind) {
+    get_function_name(funs[ind], funs[ind + 1], env$hpp_code)
   })
 
   dups <- env$fun_names[duplicated(env$fun_names)]
@@ -888,7 +915,6 @@ expose_functions <- function(function_env, global = FALSE, verbose = FALSE) {
   }
   require_suggested_package(""Rcpp"")
   require_suggested_package(""RcppEigen"")
-  require_suggested_package(""decor"")
   if (function_env$compiled) {
     if (!global) {
       message(""Functions already compiled, nothing to do!"")

---FILE: tests/testthat/test-model-expose-functions.R---
@@ -2,42 +2,38 @@ context(""model-expose-functions"")
 
 set_cmdstan_path()
 
-if (cmdstan_version() < ""2.32.0"") {
-  function_decl <- ""
-  functions {
-    int rtn_int(int x) { return x; }
-    real rtn_real(real x) { return x; }
-    vector rtn_vec(vector x) { return x; }
-    row_vector rtn_rowvec(row_vector x) { return x; }
-    matrix rtn_matrix(matrix x) { return x; }
-
-    array[] int rtn_int_array(array[] int x) { return x; }
-    array[] real rtn_real_array(array[] real x) { return x; }
-    array[] vector rtn_vec_array(array[] vector x) { return x; }
-    array[] row_vector rtn_rowvec_array(array[] row_vector x) { return x; }
-    array[] matrix rtn_matrix_array(array[] matrix x) { return x; }
-  }""
-  stan_prog <- paste(function_decl,
-                    paste(readLines(testing_stan_file(""bernoulli"")),
-                          collapse = ""\n""),
-                    collapse = ""\n"")
-  model <- write_stan_file(stan_prog)
-  data_list <- testing_data(""bernoulli"")
-  mod <- cmdstan_model(model, force_recompile = TRUE)
-  fit <- mod$sample(data = data_list)
-}
+function_decl <- ""
+functions {
+  int rtn_int(int x) { return x; }
+  real rtn_real(real x) { return x; }
+  vector rtn_vec(vector x) { return x; }
+  row_vector rtn_rowvec(row_vector x) { return x; }
+  matrix rtn_matrix(matrix x) { return x; }
+
+  array[] int rtn_int_array(array[] int x) { return x; }
+  array[] real rtn_real_array(array[] real x) { return x; }
+  array[] vector rtn_vec_array(array[] vector x) { return x; }
+  array[] row_vector rtn_rowvec_array(array[] row_vector x) { return x; }
+  array[] matrix rtn_matrix_array(array[] matrix x) { return x; }
+}""
+stan_prog <- paste(function_decl,
+                  paste(readLines(testing_stan_file(""bernoulli"")),
+                        collapse = ""\n""),
+                  collapse = ""\n"")
+model <- write_stan_file(stan_prog)
+data_list <- testing_data(""bernoulli"")
+mod <- cmdstan_model(model, force_recompile = TRUE)
+fit <- mod$sample(data = data_list)
 
 
 test_that(""Functions can be exposed in model object"", {
   skip_if(os_is_wsl())
-  skip_if(cmdstan_version() >= ""2.32.0"")
   expect_no_error(mod$expose_functions(verbose = TRUE))
 })
 
 
 test_that(""Functions handle types correctly"", {
   skip_if(os_is_wsl())
-  skip_if(cmdstan_version() >= ""2.32.0"")
 
   expect_equal(mod$functions$rtn_int(10), 10)
   expect_equal(mod$functions$rtn_real(1.67), 1.67)
@@ -63,7 +59,6 @@ test_that(""Functions handle types correctly"", {
 
 test_that(""Functions can be exposed in fit object"", {
   skip_if(os_is_wsl())
-  skip_if(cmdstan_version() >= ""2.32.0"")
   fit$expose_functions(verbose = TRUE)
 
   expect_equal(
@@ -74,7 +69,6 @@ test_that(""Functions can be exposed in fit object"", {
 
 test_that(""Compiled functions can be copied to global environment"", {
   skip_if(os_is_wsl())
-  skip_if(cmdstan_version() >= ""2.32.0"")
   expect_message(
     fit$expose_functions(global = TRUE),
     ""Functions already compiled, copying to global environment"",
@@ -90,7 +84,6 @@ test_that(""Compiled functions can be copied to global environment"", {
 
 test_that(""Functions can be compiled with model"", {
   skip_if(os_is_wsl())
-  skip_if(cmdstan_version() >= ""2.32.0"")
   mod <- cmdstan_model(model, force_recompile = TRUE, compile_standalone = TRUE)
   fit <- mod$sample(data = data_list)
 
@@ -119,7 +112,6 @@ test_that(""Functions can be compiled with model"", {
 
 test_that(""rng functions can be exposed"", {
   skip_if(os_is_wsl())
-  skip_if(cmdstan_version() >= ""2.32.0"")
   function_decl <- ""functions { real normal_rng(real mu) { return normal_rng(mu, 1); } }""
   stan_prog <- paste(function_decl,
                      paste(readLines(testing_stan_file(""bernoulli"")),
@@ -140,7 +132,6 @@ test_that(""rng functions can be exposed"", {
 
 test_that(""Overloaded functions give meaningful errors"", {
   skip_if(os_is_wsl())
-  skip_if(cmdstan_version() >= ""2.32.0"")
 
   funcode <- ""
   functions {
@@ -159,16 +150,8 @@ test_that(""Overloaded functions give meaningful errors"", {
 
 test_that(""Exposing external functions errors before v2.32"", {
   skip_if(os_is_wsl())
-  skip_if(cmdstan_version() >= ""2.32.0"")
 
-  if (getRversion() < '3.5.0') {
-    dir <- tempdir()
-  } else {
-    dir <- tempdir(check = TRUE)
-  }
-  install_cmdstan(dir = dir, cores = 2, quiet = FALSE,
-                  overwrite = TRUE, version = ""2.31.0"",
-                  wsl = os_is_wsl())
+  fake_cmdstan_version(""2.26.0"")
 
   tmpfile <- tempfile(fileext = "".hpp"")
   hpp <-
@@ -189,4 +172,6 @@ test_that(""Exposing external functions errors before v2.32"", {
   },
   ""Exporting standalone functions with external C++ is not available before CmdStan 2.32"",
   fixed = TRUE)
+
+  reset_cmdstan_version()
 })",True,False,Dependency / Package,6
stan-dev,cmdstanr,3a52d69635f09ed5693f5ed0bbdbc6ddde94f347,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2023-05-13T16:06:39Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2023-05-13T16:06:39Z,one more hpp reading fix,R/utils.R,False,True,True,False,1,1,2,"---FILE: R/utils.R---
@@ -797,7 +797,7 @@ get_standalone_hpp <- function(stan_file, stancflags) {
     name <- strip_ext(basename(stan_file))
     path <- dirname(stan_file)
     hpp_path <- file.path(path, paste0(name, "".hpp""))
-    hpp <- readLines(hpp_path)
+    hpp <- readLines(hpp_path, warn = FALSE)
     unlink(hpp_path)
     hpp
   } else {",True,False,Implementation / Logic,3
stan-dev,cmdstanr,8d500e64804a580ae65cee66107dabd5082d221f,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2023-05-13T15:38:52Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2023-05-13T15:38:52Z,fix hpp last line warning,R/model.R,False,True,True,False,1,1,2,"---FILE: R/model.R---
@@ -657,7 +657,7 @@ compile <- function(quiet = TRUE,
   private$precompile_stanc_options_ <- NULL
   private$precompile_include_paths_ <- NULL
   private$model_methods_env_ <- new.env()
-  private$model_methods_env_$hpp_code_ <- readLines(private$hpp_file_)
+  private$model_methods_env_$hpp_code_ <- readLines(private$hpp_file_, warn = FALSE)
   if (compile_model_methods) {
     expose_model_methods(env = private$model_methods_env_,
                           verbose = !quiet,",True,False,Implementation / Logic,6
stan-dev,cmdstanr,384add234c6c9ad87adaa2263186c0cee4cdfa6c,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-04-06T06:19:54Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-04-06T06:19:54Z,"Add stanc M1 make patch, suppress boost warnings",R/install.R,False,True,True,False,21,0,21,"---FILE: R/install.R---
@@ -205,6 +205,18 @@ install_cmdstan <- function(dir = NULL,
       append = TRUE
     )
   }
+
+  # Building fails on Apple silicon with < v2.31 due to a makefiles setting
+  # for stanc3, so manually implement the patch if needed from:
+  # https://github.com/stan-dev/cmdstan/pull/1127
+  if (os_is_macos() && R.version$arch == ""aarch64"") {
+    stanc_makefile <- readLines(file.path(dir_cmdstan, ""make"", ""stanc""))
+    stanc_makefile <- gsub(""\\bxattr -d com.apple.quarantine bin/stanc"",
+                            ""-xattr -d com.apple.quarantine bin/stanc"",
+                            stanc_makefile)
+    writeLines(stanc_makefile, con = file.path(dir_cmdstan, ""make"", ""stanc""))
+  }
+
   if ((is_rtools42_toolchain() || is_rtools43_toolchain()) && !wsl) {
     cmdstan_make_local(
       dir = dir_cmdstan,
@@ -216,6 +228,15 @@ install_cmdstan <- function(dir = NULL,
     )
   }
 
+  # Suppress noisy warnings from Boost
+  cmdstan_make_local(
+    dir = dir_cmdstan,
+    cpp_options = list(
+      ""CXXFLAGS += -Wno-deprecated-declarations""
+    ),
+    append = TRUE
+  )
+
   message(""* Building CmdStan binaries..."")
   build_log <- build_cmdstan(dir_cmdstan, cores, quiet, timeout)
   if (!build_status_ok(build_log, quiet = quiet)) {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,94f6395a0c83c6d13abe480e0d6ff28ab088d08c,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-04-05T08:00:42Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-04-05T08:00:42Z,Fix Rtools42 minor version,R/utils.R,False,True,True,False,1,1,2,"---FILE: R/utils.R---
@@ -55,7 +55,7 @@ is_rtools43_toolchain <- function() {
 }
 
 is_rtools42_toolchain <- function() {
-  os_is_windows() && R.version$major == ""4"" && R.version$minor == ""2.0""
+  os_is_windows() && R.version$major == ""4"" && R.version$minor >= ""2.0"" && R.version$minor < ""3.0""
 }
 
 is_rtools40_toolchain <- function() {",True,False,Reproducibility / Versioning,4
stan-dev,cmdstanr,552901464700f03fe9817ec6b07861888f2b96f1,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-03-23T18:29:05Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-03-23T18:29:05Z,Fix test failure,tests/testthat/test-model-expose-functions.R,False,True,True,False,0,1,1,"---FILE: tests/testthat/test-model-expose-functions.R---
@@ -157,7 +157,6 @@ test_that(""Exposing external functions errors before v2.32"", {
   install_cmdstan(dir = dir, cores = 2, quiet = FALSE,
                   overwrite = TRUE, version = ""2.31.0"",
                   wsl = os_is_wsl())
-  set_cmdstan_path(dir)
 
   tmpfile <- tempfile(fileext = "".hpp"")
   hpp <-",True,False,Implementation / Logic,3
stan-dev,cmdstanr,c112f37f0dbc4c1c2f56e9701fb1c6b297ba6f57,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-03-23T16:55:05Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-03-23T16:55:05Z,Use fixed version in test,tests/testthat/test-model-expose-functions.R,False,True,True,False,10,0,10,"---FILE: tests/testthat/test-model-expose-functions.R---
@@ -149,6 +149,16 @@ test_that(""Overloaded functions give meaningful errors"", {
 })
 
 test_that(""Exposing external functions errors before v2.32"", {
+  if (getRversion() < '3.5.0') {
+    dir <- tempdir()
+  } else {
+    dir <- tempdir(check = TRUE)
+  }
+  install_cmdstan(dir = dir, cores = 2, quiet = FALSE,
+                  overwrite = TRUE, version = ""2.31.0"",
+                  wsl = os_is_wsl())
+  set_cmdstan_path(dir)
+
   tmpfile <- tempfile(fileext = "".hpp"")
   hpp <-
   """,True,False,Implementation / Logic,3
stan-dev,cmdstanr,50f48f80d02bc2fe14bef39b1bfdd0bf7cfcf237,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-03-23T12:38:06Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-03-23T12:38:06Z,Fix threads,R/run.R;man/model-method-sample.Rd;man/model-method-sample_mpi.Rd,False,True,True,False,22,16,38,"---FILE: R/run.R---
@@ -361,16 +361,18 @@ check_target_exe <- function(exe) {
       start_msg <- paste0(""Running MCMC with "", procs$num_procs(), "" chains, at most "", procs$parallel_procs(), "" in parallel"")
     }
   }
-  if (procs$show_stdout_messages()) {
-    if (is.null(procs$threads_per_proc())) {
+  if (is.null(procs$threads_per_proc())) {
+    if (procs$show_stdout_messages()) {
       cat(paste0(start_msg, ""...\n\n""))
-    } else {
+    }
+  } else {
+    if (procs$show_stdout_messages()) {
       cat(paste0(start_msg, "", with "", procs$threads_per_proc(), "" thread(s) per chain...\n\n""))
-      Sys.setenv(""STAN_NUM_THREADS"" = as.integer(procs$threads_per_proc()))
-      # Windows environment variables have to be explicitly exported to WSL
-      if (os_is_wsl()) {
-        Sys.setenv(""WSLENV""=""STAN_NUM_THREADS/u"")
-      }
+    }
+    Sys.setenv(""STAN_NUM_THREADS"" = as.integer(procs$threads_per_proc()))
+    # Windows environment variables have to be explicitly exported to WSL
+    if (os_is_wsl()) {
+      Sys.setenv(""WSLENV""=""STAN_NUM_THREADS/u"")
     }
   }
   start_time <- Sys.time()
@@ -426,16 +428,18 @@ CmdStanRun$set(""private"", name = ""run_sample_"", value = .run_sample)
       start_msg <- paste0(""Running standalone generated quantities after "", procs$num_procs(), "" MCMC chains, "", procs$parallel_procs(), "" chains at a time "")
     }
   }
-  if (procs$show_stdout_messages()) {
-    if (is.null(procs$threads_per_proc())) {
+  if (is.null(procs$threads_per_proc())) {
+    if (procs$show_stdout_messages()) {
       cat(paste0(start_msg, ""...\n\n""))
-    } else {
+    }
+  } else {
+    if (procs$show_stdout_messages()) {
       cat(paste0(start_msg, "", with "", procs$threads_per_proc(), "" thread(s) per chain...\n\n""))
-      Sys.setenv(""STAN_NUM_THREADS"" = as.integer(procs$threads_per_proc()))
-      # Windows environment variables have to be explicitly exported to WSL
-      if (os_is_wsl()) {
-        Sys.setenv(""WSLENV""=""STAN_NUM_THREADS/u"")
-      }
+    }
+    Sys.setenv(""STAN_NUM_THREADS"" = as.integer(procs$threads_per_proc()))
+    # Windows environment variables have to be explicitly exported to WSL
+    if (os_is_wsl()) {
+      Sys.setenv(""WSLENV""=""STAN_NUM_THREADS/u"")
     }
   }
   start_time <- Sys.time()

---FILE: man/model-method-sample.Rd---
@@ -35,6 +35,7 @@ sample(
   window = NULL,
   fixed_param = FALSE,
   show_messages = TRUE,
+  show_errors = TRUE,
   diagnostics = c(""divergences"", ""treedepth"", ""ebfmi""),
   cores = NULL,
   num_cores = NULL,

---FILE: man/model-method-sample_mpi.Rd---
@@ -34,6 +34,7 @@ sample_mpi(
   fixed_param = FALSE,
   sig_figs = NULL,
   show_messages = TRUE,
+  show_errors = TRUE,
   diagnostics = c(""divergences"", ""treedepth"", ""ebfmi""),
   validate_csv = TRUE
 )",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,9f58cfc589e8cf57b2265a6e0a4c2ba64ef17b89,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-03-23T12:20:28Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-03-23T12:20:28Z,Align handling of messages and errors,R/model.R;R/run.R,False,True,True,False,43,21,64,"---FILE: R/model.R---
@@ -1054,6 +1054,7 @@ sample <- function(data = NULL,
                    window = NULL,
                    fixed_param = FALSE,
                    show_messages = TRUE,
+                   show_errors = TRUE,
                    diagnostics = c(""divergences"", ""treedepth"", ""ebfmi""),
                    # deprecated
                    cores = NULL,
@@ -1123,7 +1124,8 @@ sample <- function(data = NULL,
     num_procs = checkmate::assert_integerish(chains, lower = 1, len = 1),
     parallel_procs = checkmate::assert_integerish(parallel_chains, lower = 1, null.ok = TRUE),
     threads_per_proc = assert_valid_threads(threads_per_chain, self$cpp_options(), multiple_chains = TRUE),
-    show_stderr_messages = show_messages
+    show_stderr_messages = show_errors,
+    show_stdout_messages = show_messages
   )
   model_variables <- NULL
   if (is_variables_method_supported(self)) {
@@ -1260,6 +1262,7 @@ sample_mpi <- function(data = NULL,
                        fixed_param = FALSE,
                        sig_figs = NULL,
                        show_messages = TRUE,
+                       show_errors = TRUE,
                        diagnostics = c(""divergences"", ""treedepth"", ""ebfmi""),
                        # deprecated
                        validate_csv = TRUE) {
@@ -1282,7 +1285,8 @@ sample_mpi <- function(data = NULL,
   procs <- CmdStanMCMCProcs$new(
     num_procs = checkmate::assert_integerish(chains, lower = 1, len = 1),
     parallel_procs = 1,
-    show_stderr_messages = show_messages
+    show_stderr_messages = show_errors,
+    show_stdout_messages = show_messages
   )
   model_variables <- NULL
   if (is_variables_method_supported(self)) {

---FILE: R/run.R---
@@ -361,14 +361,16 @@ check_target_exe <- function(exe) {
       start_msg <- paste0(""Running MCMC with "", procs$num_procs(), "" chains, at most "", procs$parallel_procs(), "" in parallel"")
     }
   }
-  if (is.null(procs$threads_per_proc())) {
-    cat(paste0(start_msg, ""...\n\n""))
-  } else {
-    cat(paste0(start_msg, "", with "", procs$threads_per_proc(), "" thread(s) per chain...\n\n""))
-    Sys.setenv(""STAN_NUM_THREADS"" = as.integer(procs$threads_per_proc()))
-    # Windows environment variables have to be explicitly exported to WSL
-    if (os_is_wsl()) {
-      Sys.setenv(""WSLENV""=""STAN_NUM_THREADS/u"")
+  if (procs$show_stdout_messages()) {
+    if (is.null(procs$threads_per_proc())) {
+      cat(paste0(start_msg, ""...\n\n""))
+    } else {
+      cat(paste0(start_msg, "", with "", procs$threads_per_proc(), "" thread(s) per chain...\n\n""))
+      Sys.setenv(""STAN_NUM_THREADS"" = as.integer(procs$threads_per_proc()))
+      # Windows environment variables have to be explicitly exported to WSL
+      if (os_is_wsl()) {
+        Sys.setenv(""WSLENV""=""STAN_NUM_THREADS/u"")
+      }
     }
   }
   start_time <- Sys.time()
@@ -424,14 +426,16 @@ CmdStanRun$set(""private"", name = ""run_sample_"", value = .run_sample)
       start_msg <- paste0(""Running standalone generated quantities after "", procs$num_procs(), "" MCMC chains, "", procs$parallel_procs(), "" chains at a time "")
     }
   }
-  if (is.null(procs$threads_per_proc())) {
-    cat(paste0(start_msg, ""...\n\n""))
-  } else {
-    cat(paste0(start_msg, "", with "", procs$threads_per_proc(), "" thread(s) per chain...\n\n""))
-    Sys.setenv(""STAN_NUM_THREADS"" = as.integer(procs$threads_per_proc()))
-    # Windows environment variables have to be explicitly exported to WSL
-    if (os_is_wsl()) {
-      Sys.setenv(""WSLENV""=""STAN_NUM_THREADS/u"")
+  if (procs$show_stdout_messages()) {
+    if (is.null(procs$threads_per_proc())) {
+      cat(paste0(start_msg, ""...\n\n""))
+    } else {
+      cat(paste0(start_msg, "", with "", procs$threads_per_proc(), "" thread(s) per chain...\n\n""))
+      Sys.setenv(""STAN_NUM_THREADS"" = as.integer(procs$threads_per_proc()))
+      # Windows environment variables have to be explicitly exported to WSL
+      if (os_is_wsl()) {
+        Sys.setenv(""WSLENV""=""STAN_NUM_THREADS/u"")
+      }
     }
   }
   start_time <- Sys.time()
@@ -612,6 +616,12 @@ CmdStanProcs <- R6::R6Class(
       private$show_stdout_messages_ <- show_stdout_messages
       invisible(self)
     },
+    show_stdout_messages = function () {
+      private$show_stdout_messages_
+    },
+    show_stderr_messages = function () {
+      private$show_stderr_messages_
+    },
     num_procs = function() {
       private$num_procs_
     },
@@ -927,7 +937,7 @@ CmdStanMCMCProcs <- R6::R6Class(
               || grepl(""stancflags"", line, fixed = TRUE)) {
             ignore_line <- TRUE
           }
-          if ((state > 1.5 && state < 5 && !ignore_line) || is_verbose_mode()) {
+          if ((state > 1.5 && state < 5 && !ignore_line && private$show_stdout_messages_) || is_verbose_mode()) {
             if (state == 2) {
               message(""Chain "", id, "" "", line)
             } else {
@@ -939,7 +949,9 @@ CmdStanMCMCProcs <- R6::R6Class(
             if (state == 1) {
               state <- 2;
             }
-            message(""Chain "", id, "" "", line)
+            if (private$show_stderr_messages_) {
+              message(""Chain "", id, "" "", line)
+            }
           }
           private$proc_state_[[id]] <- next_state
         } else {
@@ -951,6 +963,9 @@ CmdStanMCMCProcs <- R6::R6Class(
       invisible(self)
     },
     report_time = function(id = NULL) {
+      if (!private$show_stdout_messages_) {
+        return(invisible(NULL))
+      }
       if (!is.null(id)) {
         if (self$proc_state(id) == 7) {
           warning(""Chain "", id, "" finished unexpectedly!\n"", immediate. = TRUE, call. = FALSE)
@@ -1030,7 +1045,7 @@ CmdStanGQProcs <- R6::R6Class(
         if (nzchar(line)) {
           if (self$proc_state(id) == 1 && grepl(""refresh = "", line, perl = TRUE)) {
             self$set_proc_state(id, new_state = 1.5)
-          } else if (self$proc_state(id) >= 2) {
+          } else if (self$proc_state(id) >= 2 && private$show_stdout_messages_) {
             cat(""Chain"", id, line, ""\n"")
           }
         } else {
@@ -1044,6 +1059,9 @@ CmdStanGQProcs <- R6::R6Class(
       invisible(self)
     },
     report_time = function(id = NULL) {
+      if (!private$show_stdout_messages_) {
+        return(invisible(NULL))
+      }
       if (!is.null(id)) {
         if (self$proc_state(id) == 7) {
           warning(""Chain "", id, "" finished unexpectedly!\n"", immediate. = TRUE, call. = FALSE)",True,False,Implementation / Logic,6
stan-dev,cmdstanr,2a6d2c9f5445339ba07d70db437cb51b6f2b4bcf,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-03-23T11:04:30Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-03-23T11:04:30Z,Align error returns with existing,R/install.R;tests/testthat/test-install.R,False,True,True,False,19,21,40,"---FILE: R/install.R---
@@ -155,14 +155,15 @@ install_cmdstan <- function(dir = NULL,
     return(invisible(NULL))
   }
   tar_downloaded <- download_with_retries(download_url, dest_file, quiet = quiet)
-  if (!tar_downloaded) {
+  if (inherits(tar_downloaded, ""try-error"")) {
+    error_msg <- paste(""Download of CmdStan failed with error:"",
+                        attr(tar_downloaded, ""condition"")$message)
     if (!is.null(version)) {
-      stop(""Download of CmdStan failed. Please check if the supplied version number is valid."", call. = FALSE)
+      error_msg <- paste0(error_msg, ""\nPlease check if the supplied version number is valid."")
+    } else if (!is.null(release_url)) {
+      error_msg <- paste0(error_msg, ""\nPlease check if the supplied release URL is valid."")
     }
-    if (!is.null(release_url)) {
-      stop(""Download of CmdStan failed. Please check if the supplied release URL is valid."", call. = FALSE)
-    }
-    stop(""Download of CmdStan failed. Please try again."", call. = FALSE)
+    stop(error_msg, call. = FALSE)
   }
   message(""* Download complete"")
   message(""* Unpacking archive..."")
@@ -364,13 +365,17 @@ latest_released_version <- function(quiet=TRUE) {
   dest_file <- tempfile(pattern = ""releases-"", fileext = "".json"")
   download_url <- ""https://api.github.com/repos/stan-dev/cmdstan/releases/latest""
   release_list_downloaded <- download_with_retries(download_url, dest_file, quiet = quiet)
+  if (inherits(release_list_downloaded, ""try-error"")) {
+    stop(""GitHub download of release list failed with error: "",
+        attr(release_list_downloaded, ""condition"")$message,
+        call. = FALSE)
+  }
   release <- jsonlite::read_json(dest_file)
   sub(""v"", """", release$tag_name)
 }
 
 try_download <- function(download_url, destination_file,
-                          quiet = TRUE,
-                          stop_on_error = TRUE) {
+                          quiet = TRUE) {
   download_status <- try(
     suppressWarnings(
       utils::download.file(url = download_url,
@@ -380,11 +385,6 @@ try_download <- function(download_url, destination_file,
     ),
     silent = TRUE
   )
-  if (inherits(download_status, ""try-error"") && isTRUE(stop_on_error)) {
-    stop(""Download failed with error message: "",
-         attr(download_status, ""condition"")$message,
-         call. = FALSE)
-  }
   download_status
 }
 
@@ -395,16 +395,14 @@ download_with_retries <- function(download_url,
                                   pause_sec = 5,
                                   quiet = TRUE) {
     download_rc <- try_download(download_url, destination_file,
-                                quiet = quiet, stop_on_error = FALSE)
+                                quiet = quiet)
     num_retries <- 0
     while (num_retries < retries && inherits(download_rc, ""try-error"")) {
       Sys.sleep(pause_sec)
       num_retries <- num_retries + 1
-      download_rc <- try_download(download_url, destination_file,
-                                  quiet = quiet,
-                                  stop_on_error = (num_retries == (retries)))
+      download_rc <- try_download(download_url, destination_file, quiet = quiet)
     }
-    TRUE
+    download_rc
 }
 
 build_cmdstan <- function(dir,

---FILE: tests/testthat/test-install.R---
@@ -75,12 +75,12 @@ test_that(""install_cmdstan() errors if it times out"", {
 test_that(""install_cmdstan() errors if invalid version or URL"", {
   expect_error(
     install_cmdstan(version = ""2.23.2"", wsl = os_is_wsl()),
-    ""Download of CmdStan failed. Please check if the supplied version number is valid.""
+    ""Download of CmdStan failed with error: cannot open URL 'https://github.com/stan-dev/cmdstan/releases/download/v2.23.2/cmdstan-2.23.2.tar.gz'\nPlease check if the supplied version number is valid.""
   )
   expect_error(
     install_cmdstan(release_url = ""https://github.com/stan-dev/cmdstan/releases/download/v2.23.2/cmdstan-2.23.2.tar.gz"",
                     wsl = os_is_wsl()),
-    ""Download of CmdStan failed. Please check if the supplied release URL is valid.""
+    ""Download of CmdStan failed with error: cannot open URL 'https://github.com/stan-dev/cmdstan/releases/download/v2.23.2/cmdstan-2.23.2.tar.gz'\nPlease check if the supplied release URL is valid.""
   )
   expect_error(
     install_cmdstan(release_url = ""https://github.com/stan-dev/cmdstan/releases/tag/v2.24.0"", wsl = os_is_wsl()),
@@ -241,6 +241,6 @@ test_that(""Download failures return error message"", {
       c(""http_proxy""=""invalid"",""https_proxy""=""invalid""),
       install_cmdstan(dir = dir, overwrite = TRUE)
     )},
-    ""Download failed with error message: cannot open URL 'https://api.github.com/repos/stan-dev/cmdstan/releases/latest'"")
+    ""GitHub download of release list failed with error: cannot open URL 'https://api.github.com/repos/stan-dev/cmdstan/releases/latest'"")
 })
 ",True,False,Implementation / Logic,6
stan-dev,cmdstanr,a6deba59a409891d21b9c26e4a71045f904f0bad,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-03-23T08:51:56Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-03-23T08:51:56Z,Fix retries typo,R/install.R,False,True,True,False,1,1,2,"---FILE: R/install.R---
@@ -396,7 +396,7 @@ download_with_retries <- function(download_url,
                                   quiet = TRUE) {
     download_rc <- try_download(download_url, destination_file,
                                 quiet = quiet, stop_on_error = FALSE)
-    num_retries <- 1
+    num_retries <- 0
     while (num_retries < retries && inherits(download_rc, ""try-error"")) {
       Sys.sleep(pause_sec)
       num_retries <- num_retries + 1",True,False,Data / Input Handling,3
stan-dev,cmdstanr,d01169c7f419bf848d7e603f410a8d5b2e577120,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-03-23T08:44:19Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-03-23T08:44:19Z,Add verbosity to download output and errors,R/install.R;tests/testthat/test-install.R,False,True,True,False,80,28,108,"---FILE: R/install.R---
@@ -141,7 +141,7 @@ install_cmdstan <- function(dir = NULL,
     dir_cmdstan <- file.path(dir, cmdstan_ver)
     dest_file <- file.path(dir, tar_gz_file)
   } else {
-    ver <- latest_released_version()
+    ver <- latest_released_version(quiet = quiet)
     message(""* Latest CmdStan release is v"", ver)
     cmdstan_ver <- paste0(""cmdstan-"", ver, cmdstan_arch_suffix(ver))
     tar_gz_file <- paste0(cmdstan_ver, "".tar.gz"")
@@ -154,7 +154,7 @@ install_cmdstan <- function(dir = NULL,
   if (!check_install_dir(dir_cmdstan, overwrite)) {
     return(invisible(NULL))
   }
-  tar_downloaded <- download_with_retries(download_url, dest_file)
+  tar_downloaded <- download_with_retries(download_url, dest_file, quiet = quiet)
   if (!tar_downloaded) {
     if (!is.null(version)) {
       stop(""Download of CmdStan failed. Please check if the supplied version number is valid."", call. = FALSE)
@@ -360,45 +360,51 @@ github_download_url <- function(version_number) {
 }
 
 # get version number of latest release
-latest_released_version <- function() {
+latest_released_version <- function(quiet=TRUE) {
   dest_file <- tempfile(pattern = ""releases-"", fileext = "".json"")
   download_url <- ""https://api.github.com/repos/stan-dev/cmdstan/releases/latest""
-  release_list_downloaded <- download_with_retries(download_url, dest_file)
-  if (!release_list_downloaded) {
-    stop(""GitHub download of release list failed."", call. = FALSE)
-  }
+  release_list_downloaded <- download_with_retries(download_url, dest_file, quiet = quiet)
   release <- jsonlite::read_json(dest_file)
   sub(""v"", """", release$tag_name)
 }
 
+try_download <- function(download_url, destination_file,
+                          quiet = TRUE,
+                          stop_on_error = TRUE) {
+  download_status <- try(
+    suppressWarnings(
+      utils::download.file(url = download_url,
+                           destfile = destination_file,
+                           quiet = quiet,
+                           headers = github_auth_token())
+    ),
+    silent = TRUE
+  )
+  if (inherits(download_status, ""try-error"") && isTRUE(stop_on_error)) {
+    stop(""Download failed with error message: "",
+         attr(download_status, ""condition"")$message,
+         call. = FALSE)
+  }
+  download_status
+}
+
 # download with retries and pauses
 download_with_retries <- function(download_url,
                                   destination_file,
                                   retries = 5,
                                   pause_sec = 5,
                                   quiet = TRUE) {
-
-    download_rc <- 1
-    while (retries > 0 && download_rc != 0) {
-      try(
-        suppressWarnings(
-          download_rc <- utils::download.file(url = download_url,
-                                            destfile = destination_file,
-                                            quiet = quiet,
-                                            headers = github_auth_token())
-        ),
-        silent = TRUE
-      )
-      if (download_rc != 0) {
-        Sys.sleep(pause_sec)
-      }
-      retries <- retries - 1
-    }
-    if (download_rc == 0) {
-      TRUE
-    } else {
-      FALSE
+    download_rc <- try_download(download_url, destination_file,
+                                quiet = quiet, stop_on_error = FALSE)
+    num_retries <- 1
+    while (num_retries < retries && inherits(download_rc, ""try-error"")) {
+      Sys.sleep(pause_sec)
+      num_retries <- num_retries + 1
+      download_rc <- try_download(download_url, destination_file,
+                                  quiet = quiet,
+                                  stop_on_error = (num_retries == (retries)))
     }
+    TRUE
 }
 
 build_cmdstan <- function(dir,

---FILE: tests/testthat/test-install.R---
@@ -198,3 +198,49 @@ test_that(""github_download_url constructs correct url"", {
   )
 })
 
+test_that(""Downloads respect quiet argument"", {
+  if (getRversion() < '3.5.0') {
+    dir <- tempdir()
+  } else {
+    dir <- tempdir(check = TRUE)
+  }
+  version <- latest_released_version()
+
+  ver_msg <- ""trying URL 'https://api.github.com/repos/stan-dev/cmdstan/releases/latest'""
+  download_msg <- paste0(""trying URL 'https://github.com/stan-dev/cmdstan/releases/download/v"",
+                         version, ""/cmdstan-"", version, "".tar.gz'"")
+
+  # expect_message has trouble capturing the messages from download.file
+  # so handle manually
+  install_normal <- suppressWarnings(
+    capture.output(install_cmdstan(dir = dir, overwrite = TRUE, quiet = FALSE),
+                   type = ""message"")
+  )
+  install_quiet <- suppressWarnings(
+    capture.output(install_cmdstan(dir = dir, overwrite = TRUE, quiet = TRUE),
+                   type = ""message"")
+  )
+
+  expect_true(any(grepl(ver_msg, install_normal, fixed = TRUE)))
+  expect_true(any(grepl(download_msg, install_normal, fixed = TRUE)))
+
+  expect_false(any(grepl(ver_msg, install_quiet, fixed = TRUE)))
+  expect_false(any(grepl(download_msg, install_quiet, fixed = TRUE)))
+})
+
+test_that(""Download failures return error message"", {
+  if (getRversion() < '3.5.0') {
+    dir <- tempdir()
+  } else {
+    dir <- tempdir(check = TRUE)
+  }
+
+  expect_error({
+    # Use an invalid proxy address to force a download failure
+    withr::with_envvar(
+      c(""http_proxy""=""invalid"",""https_proxy""=""invalid""),
+      install_cmdstan(dir = dir, overwrite = TRUE)
+    )},
+    ""Download failed with error message: cannot open URL 'https://api.github.com/repos/stan-dev/cmdstan/releases/latest'"")
+})
+",True,False,Implementation / Logic,6
stan-dev,cmdstanr,a8fbf0d1145c8ab5ef4313faf3355ae3679bf97c,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-03-22T17:38:12Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-03-22T17:38:12Z,Fix typo,R/utils.R;tests/testthat/test-model-expose-functions.R,False,True,True,False,4,3,7,"---FILE: R/utils.R---
@@ -851,7 +851,7 @@ compile_functions <- function(env, verbose = FALSE, global = FALSE) {
   dups <- env$fun_names[duplicated(env$fun_names)]
 
   if (length(dups) > 0) {
-    stop(""Overloaded functions are currently not able to exposed to R!"",
+    stop(""Overloaded functions are currently not able to be exposed to R!"",
           "" The following overloaded functions were found: "",
           paste(dups, collapse="", ""),
           call. = FALSE)

---FILE: tests/testthat/test-model-expose-functions.R---
@@ -131,6 +131,8 @@ test_that(""rng functions can be exposed"", {
 })
 
 test_that(""Overloaded functions give meaningful errors"", {
+  skip_if(os_is_wsl())
+
   funcode <- ""
   functions {
     real fun1(real x) { return x; }
@@ -143,6 +145,5 @@ test_that(""Overloaded functions give meaningful errors"", {
 
   funmod <- cmdstan_model(write_stan_file(funcode), force_recompile = TRUE)
   expect_error(funmod$expose_functions(),
-               ""Overloaded functions are currently not able to exposed to R! The following overloaded functions were found: fun1, fun3"")
-
+               ""Overloaded functions are currently not able to be exposed to R! The following overloaded functions were found: fun1, fun3"")
 })",True,False,Implementation / Logic,6
stan-dev,cmdstanr,52e22f59e34bcfc0b42014ee704bf134fdf5836c,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-03-22T13:31:16Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2023-03-22T13:31:16Z,Fix exposing functions with int return,R/utils.R;tests/testthat/test-model-expose-functions.R,False,True,True,False,49,22,71,"---FILE: R/utils.R---
@@ -805,17 +805,17 @@ get_standalone_hpp <- function(stan_file, stancflags) {
 # looking up the return type of the functor declaration and replacing
 # the template types (i.e., T0__) with double
 get_plain_rtn <- function(fun_body, model_lines) {
-  fun_props <- decor::parse_cpp_function(paste(fun_body[-1], collapse = ""\n""))
+  fun_string <- paste(fun_body[-1], collapse = ""\n"")
+  fun_props <- decor::parse_cpp_function(fun_string)
+
   struct_start <- grep(paste0(""struct "", fun_props$name, ""_functor""), model_lines)
   struct_op_start <- grep(""operator()"", model_lines[-(1:struct_start)])[1] + struct_start
+  rtn_type <- paste0(model_lines[struct_start:struct_op_start], collapse = "" "")
 
-  struct_rtn <- grep(""nullptr>"", model_lines[struct_start:struct_op_start], fixed = TRUE) + struct_start
-
-  rtn_type <- paste0(model_lines[struct_rtn:struct_op_start], collapse = "" "")
-  rm_trailing_nullptr <- gsub("".*nullptr>[^,]"", """", rtn_type)
   rm_operator <- gsub(""operator().*"", """", rtn_type)
-  repl_dbl <- gsub(""T[0-9*]__"", ""double"", rm_operator)
-  gsub(""(^\\s|\\s$)"", """", repl_dbl)
+  rm_prev <- gsub("".*\\{"", """", rm_operator)
+  rm_template <- gsub(""template <typename(.*?)> "", """", rm_prev)
+  gsub(""T([0-9])*__"", ""double"", rm_template)
 }
 
 # Prepare the c++ code for a standalone function so that it can be exported to R:

---FILE: tests/testthat/test-model-expose-functions.R---
@@ -2,7 +2,20 @@ context(""model-expose-functions"")
 
 set_cmdstan_path()
 
-function_decl <- ""functions { vector retvec(vector x) { return x; } }""
+function_decl <- ""
+functions {
+  int rtn_int(int x) { return x; }
+  real rtn_real(real x) { return x; }
+  vector rtn_vec(vector x) { return x; }
+  row_vector rtn_rowvec(row_vector x) { return x; }
+  matrix rtn_matrix(matrix x) { return x; }
+
+  array[] int rtn_int_array(array[] int x) { return x; }
+  array[] real rtn_real_array(array[] real x) { return x; }
+  array[] vector rtn_vec_array(array[] vector x) { return x; }
+  array[] row_vector rtn_rowvec_array(array[] row_vector x) { return x; }
+  array[] matrix rtn_matrix_array(array[] matrix x) { return x; }
+}""
 stan_prog <- paste(function_decl,
                    paste(readLines(testing_stan_file(""bernoulli"")),
                          collapse = ""\n""),
@@ -15,27 +28,41 @@ fit <- mod$sample(data = data_list)
 
 test_that(""Functions can be exposed in model object"", {
   skip_if(os_is_wsl())
-  mod$expose_functions(verbose = TRUE)
+  expect_no_error(mod$expose_functions(verbose = TRUE))
+})
 
-  expect_equal(
-    mod$functions$retvec(c(1,2,3,4)),
-    c(1,2,3,4)
-  )
 
-  mod$expose_functions(global = TRUE, verbose = TRUE)
+test_that(""Functions handle types correctly"", {
+  skip_if(os_is_wsl())
 
-  expect_equal(
-    retvec(c(1,2,3,4)),
-    c(1,2,3,4)
-  )
+  expect_equal(mod$functions$rtn_int(10), 10)
+  expect_equal(mod$functions$rtn_real(1.67), 1.67)
+
+  vec <- c(1.2,234,0.3,-0.4)
+  rowvec <- t(vec)
+  matrix <- matrix(c(2.11, -6.35, 4.87, -0.9871), nrow = 2, ncol = 2)
+
+  expect_equal(mod$functions$rtn_vec(vec), vec)
+  expect_equal(mod$functions$rtn_rowvec(vec), t(vec))
+  expect_equal(mod$functions$rtn_matrix(matrix), matrix)
+  expect_equal(mod$functions$rtn_int_array(1:5), 1:5)
+  expect_equal(mod$functions$rtn_real_array(vec), vec)
+
+  vec_array <- list(vec, vec * 2, vec + 0.1)
+  rowvec_array <- list(rowvec, rowvec * 2, rowvec + 0.1)
+  matrix_array <- list(matrix, matrix * 2, matrix + 0.1)
+
+  expect_equal(mod$functions$rtn_vec_array(vec_array), vec_array)
+  expect_equal(mod$functions$rtn_rowvec_array(rowvec_array), rowvec_array)
+  expect_equal(mod$functions$rtn_matrix_array(matrix_array), matrix_array)
 })
 
 test_that(""Functions can be exposed in fit object"", {
   skip_if(os_is_wsl())
   fit$expose_functions(verbose = TRUE)
 
   expect_equal(
-    fit$functions$retvec(c(1,2,3,4)),
+    fit$functions$rtn_vec(c(1,2,3,4)),
     c(1,2,3,4)
   )
 })
@@ -49,7 +76,7 @@ test_that(""Compiled functions can be copied to global environment"", {
   )
 
   expect_equal(
-    retvec(c(1,2,3,4)),
+    rtn_vec(c(1,2,3,4)),
     c(1,2,3,4)
   )
 })
@@ -67,7 +94,7 @@ test_that(""Functions can be compiled with model"", {
   )
 
   expect_equal(
-    fit$functions$retvec(c(1,2,3,4)),
+    fit$functions$rtn_vec(c(1,2,3,4)),
     c(1,2,3,4)
   )
 
@@ -78,7 +105,7 @@ test_that(""Functions can be compiled with model"", {
   )
 
   expect_equal(
-    retvec(c(1,2,3,4)),
+    rtn_vec(c(1,2,3,4)),
     c(1,2,3,4)
   )
 })",True,False,Implementation / Logic,3
stan-dev,cmdstanr,2b54e4c8eecb780577d6f6746da15fc6b6716985,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-12-02T11:10:22Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-12-02T11:10:22Z,Fix unconstraining variables with zero-length containers,R/fit.R;tests/testthat/test-model-methods.R,False,True,True,False,35,3,38,"---FILE: R/fit.R---
@@ -306,7 +306,7 @@ CmdStanFit$set(""public"", name = ""init"", value = init)
 #' @name fit-method-init_model_methods
 #' @aliases init_model_methods
 #' @description The `$init_model_methods()` compiles and initializes the
-#' `log_prob`, `grad_log_prob`, `constrain_pars`, and `unconstrain_pars` functions.
+#' `log_prob`, `grad_log_prob`, `constrain_variables`, and `unconstrain_variables` functions.
 #'
 #' @param seed (integer) The random seed to use when initializing the model.
 #' @param verbose (boolean) Whether to show verbose logging during compilation.
@@ -465,7 +465,7 @@ unconstrain_variables <- function(variables) {
     stop(""The method has not been compiled, please call `init_model_methods()` first"",
         call. = FALSE)
   }
-  model_par_names <- names(self$runset$args$model_variables$parameters)
+  model_par_names <- self$metadata()$stan_variables[self$metadata()$stan_variables != ""lp__""]
   prov_par_names <- names(variables)
 
   model_pars_not_prov <- which(!(model_par_names %in% prov_par_names))
@@ -477,7 +477,17 @@ unconstrain_variables <- function(variables) {
   # Ignore extraneous parameters
   model_pars_only <- variables[model_par_names]
 
-  stan_pars <- process_init_list(list(variables), num_procs = 1, self$runset$args$model_variables)
+  model_variables <- self$runset$args$model_variables
+
+  # If zero-length parameters are present, they will be listed in model_variables
+  # but not in metadata()$variables
+  nonzero_length_params <- names(model_variables$parameters) %in% model_par_names
+
+  # Remove zero-length parameters from model_variables, otherwise process_init_list
+  # warns about missing inputs
+  model_variables$parameters <- model_variables$parameters[nonzero_length_params]
+
+  stan_pars <- process_init_list(list(variables), num_procs = 1, model_variables)
   private$model_methods_env_$unconstrain_variables(private$model_methods_env_$model_ptr_, stan_pars)
 }
 CmdStanFit$set(""public"", name = ""unconstrain_variables"", value = unconstrain_variables)

---FILE: tests/testthat/test-model-methods.R---
@@ -179,3 +179,25 @@ test_that(""Methods can be compiled with model"", {
   unconstrained_variables <- fit$unconstrain_variables(cpars)
   expect_equal(unconstrained_variables, c(0.6))
 })
+
+test_that(""unconstrain_variables correctly handles zero-length containers"", {
+  skip_if(os_is_wsl())
+  model_code <- ""
+  data {
+    int N;
+  }
+  parameters {
+    vector[N] y;
+    real x;
+  }
+  model {
+    x ~ std_normal();
+    y ~ std_normal();
+  }
+  ""
+  mod <- cmdstan_model(write_stan_file(model_code),
+                       compile_model_methods = TRUE)
+  fit <- mod$sample(data = list(N = 0), chains = 1)
+  unconstrained <- fit$unconstrain_variables(variables = list(x = 5))
+  expect_equal(unconstrained, 5)
+})",True,False,Implementation / Logic,6
stan-dev,cmdstanr,82cc37b53416a9d53b68abd43fa9d9c75b035bb1,jgabry,jgabry@gmail.com,2022-11-18T00:10:52Z,jgabry,jgabry@gmail.com,2022-11-18T00:10:52Z,"fix error in example usage of model$format

fixes #721",R/model.R;man/model-method-format.Rd,False,True,True,False,2,2,4,"---FILE: R/model.R---
@@ -885,7 +885,7 @@ CmdStanModel$set(""public"", name = ""check_syntax"", value = check_syntax)
 #' }
 #' model {
 #'   target +=
-#'  poisson_log(y | lambda);
+#'  poisson_lpmf(y | lambda);
 #' }
 #' "")
 #' mod <- cmdstan_model(file, compile = FALSE)

---FILE: man/model-method-format.Rd---
@@ -56,7 +56,7 @@ parameters {
 }
 model {
   target +=
- poisson_log(y | lambda);
+ poisson_log_lpmf(y | lambda);
 }
 "")
 mod <- cmdstan_model(file, compile = FALSE)",True,False,Documentation / Formatting,7
stan-dev,cmdstanr,baeb93ec3be9eb36dbe106eba6fa0213a1e6522f,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-11-07T07:35:31Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-11-07T07:35:31Z,Fix empty STANCFLAGS handling,R/model.R,False,True,True,False,6,4,10,"---FILE: R/model.R---
@@ -575,15 +575,17 @@ compile <- function(quiet = TRUE,
       stanc_built_options <- c(stanc_built_options, paste0(""--"", option_name, ""="", ""'"", stanc_options[[i]], ""'""))
     }
   }
-
+  stancflags_combined <- stanc_built_options
   stancflags_local <- get_cmdstan_flags(""STANCFLAGS"")
-
-  stancflags_standalone <- c(""--standalone-functions"", stancflags_val, stanc_built_options, stancflags_local)
+  if (stancflags_local != """") {
+    stancflags_combined <- c(stancflags_combined, stancflags_local)
+  }
+  stancflags_standalone <- c(""--standalone-functions"", stancflags_val, stancflags_combined)
   self$functions$hpp_code <- get_standalone_hpp(temp_stan_file, stancflags_standalone)
   if (compile_standalone) {
     expose_functions(self$functions, !quiet)
   }
-  stancflags_val <- paste0(""STANCFLAGS += "", stancflags_val, paste0("" "", c(stanc_built_options, stancflags_local), collapse = "" ""))
+  stancflags_val <- paste0(""STANCFLAGS += "", stancflags_val, paste0("" "", stancflags_combined, collapse = "" ""))
   withr::with_path(
     c(
       toolchain_PATH_env_var(),",True,False,Rendering / Conversion,3
stan-dev,cmdstanr,9d74a4cf54b76b2dfae54544fa027659d52147ee,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-11-06T17:36:14Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-11-06T17:36:14Z,Incorrect diagnostics handlings,R/csv.R,False,True,True,False,3,16,19,"---FILE: R/csv.R---
@@ -127,26 +127,13 @@ read_cmdstan_csv <- function(files,
   # If the CSV files are stored in the WSL filesystem then it is significantly
   # faster (~4x) to first copy them (via WSL) to a Windows tempdir before reading
   if (os_is_wsl()) {
-    if (any(grepl(""^//wsl"", files))) {
-      wsl_files <- files
-    }
-    if (any(grepl(""^//wsl"", sampler_diagnostics))) {
-      wsl_files <- c(wsl_files, sampler_diagnostics)
-    }
-
-    wsl_files <- sapply(wsl_files, wsl_safe_path)
+    wsl_files <- sapply(files, wsl_safe_path)
     temp_storage <- tempdir(check = TRUE)
     csv_copy <- processx::run(
-      ""wsl"",
-      c(""cp"", wsl_files, wsl_safe_path(temp_storage))
+      ""wsl"", c(""cp"", wsl_files, wsl_safe_path(temp_storage))
     )
 
-    if (any(grepl(""^//wsl"", files))) {
-      files <- file.path(temp_storage, basename(files))
-    }
-    if (any(grepl(""^//wsl"", sampler_diagnostics))) {
-      sampler_diagnostics <- file.path(temp_storage, basename(sampler_diagnostics))
-    }
+    files <- file.path(temp_storage, basename(files))
   }
   format <- assert_valid_draws_format(format)
   assert_file_exists(files, access = ""r"", extension = ""csv"")",True,False,Implementation / Logic,3
stan-dev,cmdstanr,82776e14b36f4fe74eae20bbc3a926bf4e5fafe5,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-11-05T21:20:33Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-11-05T21:20:33Z,fix NOTE,R/utils.R,False,True,True,False,3,1,4,"---FILE: R/utils.R---
@@ -870,8 +870,10 @@ expose_functions <- function(function_env, global = FALSE, verbose = FALSE) {
     } else {
       message(""Functions already compiled, copying to global environment"")
       # Create reference to global environment, avoids NOTE about assigning to global
+      pos <- 1
+      envir <- as.environment(pos)
       lapply(function_env$fun_names, function(fun_name) {
-        assign(fun_name, get(fun_name, function_env), as.environment(1))
+        assign(fun_name, get(fun_name, function_env), envir)
       })
     }
   } else {",True,False,Implementation / Logic,3
stan-dev,cmdstanr,6d0105bfec158c96b64fc757aa8e954daab90409,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-11-05T19:30:06Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-11-05T19:30:06Z,Fix expose-functions tests,R/utils.R;tests/testthat/test-model-expose-functions.R,False,True,True,False,2,4,6,"---FILE: R/utils.R---
@@ -870,10 +870,8 @@ expose_functions <- function(function_env, global = FALSE, verbose = FALSE) {
     } else {
       message(""Functions already compiled, copying to global environment"")
       # Create reference to global environment, avoids NOTE about assigning to global
-      pos <- 1
-      envir = as.environment(pos)
       lapply(function_env$fun_names, function(fun_name) {
-        assign(fun_name, get(fun_name, function_env), envir)
+        assign(fun_name, get(fun_name, function_env), as.environment(1))
       })
     }
   } else {

---FILE: tests/testthat/test-model-expose-functions.R---
@@ -18,7 +18,7 @@ test_that(""Functions can be exposed in model object"", {
   mod$expose_functions(verbose = TRUE)
 
   expect_equal(
-    fit$functions$retvec(c(1,2,3,4)),
+    mod$functions$retvec(c(1,2,3,4)),
     c(1,2,3,4)
   )
 ",True,False,Implementation / Logic,3
stan-dev,cmdstanr,52ce9a163ac7cb1d7089488b81d84e2151d1bede,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-10-25T12:44:48Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-10-25T12:44:48Z,Test fix windows oldrel,R/path.R;R/utils.R,False,True,True,False,6,2,8,"---FILE: R/path.R---
@@ -146,7 +146,7 @@ cmdstan_default_path <- function(old = FALSE, dir = NULL) {
     installs_path <- cmdstan_default_install_path(old)
   }
   wsl_installed <- wsl_installed()
-  if (!wsl_installed) {
+  if (!isTRUE(wsl_installed)) {
     wsl_installs_path <- NULL
     wsl_path_exists <- FALSE
   } else {

---FILE: R/utils.R---
@@ -541,7 +541,11 @@ wsl_installed <- function() {
       p$kill()
       FALSE
     } else {
-      p$get_exit_status() == 0
+      status <- p$get_exit_status()
+      if (is.null(status)) {
+        FALSE
+      }
+      status == 0
     }
   }
 }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,8560a8e318cf3afd3a3a424e7b503e2e7d0f52bd,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-10-25T12:16:06Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-10-25T12:16:06Z,Fix path onload,R/utils.R,False,True,True,False,2,2,4,"---FILE: R/utils.R---
@@ -613,7 +613,7 @@ check_file_exists <- function(files, access = NULL, ...) {
 }
 
 .wsl_check_exists <- function(path, is_dir = TRUE, access = NULL) {
-  if (!os_is_wsl()) {
+  if (!wsl_installed()) {
     return(FALSE)
   }
   path_check <- processx::run(
@@ -879,4 +879,4 @@ expose_functions <- function(function_env, global = FALSE, verbose = FALSE) {
     compile_functions(function_env, verbose, global)
   }
   invisible(NULL)
-}
\ No newline at end of file
+}",True,False,Implementation / Logic,6
stan-dev,cmdstanr,710ba4cf96f5bcbbee838fdf96d7d4ba6333f616,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-10-25T11:15:39Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-10-25T11:15:39Z,Fix typo,R/install.R;R/utils.R,False,True,True,False,3,3,6,"---FILE: R/install.R---
@@ -93,10 +93,10 @@ install_cmdstan <- function(dir = NULL,
               call. = FALSE)
       wsl <- FALSE
     } else {
-      .cmdstanr$WSL <- true
+      .cmdstanr$WSL <- TRUE
     }
   } else {
-    .cmdstanr$WSL <- false
+    .cmdstanr$WSL <- FALSE
   }
   if (check_toolchain) {
     check_cmdstan_toolchain(fix = FALSE, quiet = quiet)

---FILE: R/utils.R---
@@ -534,7 +534,7 @@ wsl_installed <- function() {
   if (!os_is_windows()) {
     FALSE
   } else {
-    message(""here"")
+    # Call can hang indefinitely on Github actions, so explicitly kill
     p <- processx::process$new(""wsl"", ""uname"")
     Sys.sleep(5)
     if (p$is_alive()) {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,c26693ed521840ce28f74b476c3ac24b53b825ca,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-10-25T05:54:37Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-10-25T05:54:37Z,Fix wsl path lookup,R/path.R;R/utils.R,False,True,True,False,9,13,22,"---FILE: R/path.R---
@@ -111,7 +111,7 @@ stop_no_path <- function() {
 #' @export
 cmdstan_default_install_path <- function(old = FALSE, wsl = FALSE) {
   if (wsl) {
-    file.path(paste0(wsl_dir_prefix(), home_dir()), "".cmdstan"")
+    file.path(paste0(wsl_dir_prefix(wsl = TRUE), wsl_home_dir()), "".cmdstan"")
   } else {
     if (old) {
       file.path(Sys.getenv(""HOME""), "".cmdstanr"")

---FILE: R/utils.R---
@@ -549,20 +549,16 @@ wsl_distro_name <- function() {
   gsub(""\n"", """", name, fixed = TRUE)
 }
 
-home_dir <- function() {
-  if (os_is_wsl()) {
-    dir <- processx::run(
-          command = ""wsl"",
-          args = c(""echo"", ""$HOME"")
-    )$stdout
-    gsub(""\n"", """", dir, fixed = TRUE)
-  } else {
-    Sys.getenv(""HOME"")
-  }
+wsl_home_dir <- function() {
+  dir <- processx::run(
+        command = ""wsl"",
+        args = c(""echo"", ""$HOME"")
+  )$stdout
+  gsub(""\n"", """", dir, fixed = TRUE)
 }
 
-wsl_dir_prefix <- function() {
-  if (os_is_wsl()) {
+wsl_dir_prefix <- function(wsl = FALSE) {
+  if (os_is_wsl() || wsl) {
     paste0(""//wsl$/"", wsl_distro_name())
   } else {
     """"",True,False,Environment / Configuration,4
stan-dev,cmdstanr,e4d7dd9710de4e22e4bd111c906c3da8c1aa5694,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-10-25T05:23:35Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-10-25T05:23:35Z,Fix wsl install path handling,R/install.R;R/path.R,False,True,True,False,10,8,18,"---FILE: R/install.R---
@@ -108,7 +108,7 @@ install_cmdstan <- function(dir = NULL,
     }
   }
   if (is.null(dir)) {
-    dir <- cmdstan_default_install_path()
+    dir <- cmdstan_default_install_path(wsl = wsl)
     if (!dir.exists(dir)) {
       dir.create(dir, recursive = TRUE)
     }

---FILE: R/path.R---
@@ -109,11 +109,15 @@ stop_no_path <- function() {
 #'   one (.cmdstan)? Defaults to `FALSE` and may be removed in a future release.
 #' @return The installation path.
 #' @export
-cmdstan_default_install_path <- function(old = FALSE) {
-  if (old) {
-    file.path(Sys.getenv(""HOME""), "".cmdstanr"")
+cmdstan_default_install_path <- function(old = FALSE, wsl = FALSE) {
+  if (wsl) {
+    file.path(paste0(wsl_dir_prefix(), home_dir()), "".cmdstan"")
   } else {
-    file.path(Sys.getenv(""HOME""), "".cmdstan"")
+    if (old) {
+      file.path(Sys.getenv(""HOME""), "".cmdstanr"")
+    } else {
+      file.path(Sys.getenv(""HOME""), "".cmdstan"")
+    }
   }
 }
 
@@ -144,9 +148,7 @@ cmdstan_default_path <- function(old = FALSE, dir = NULL) {
   if (!wsl_installed) {
     wsl_installs_path <- NULL
   } else {
-    Sys.setenv(""CMDSTANR_USE_WSL"" = 1)
-    wsl_installs_path <- cmdstan_default_install_path(old)
-    Sys.unsetenv(""CMDSTANR_USE_WSL"")
+    wsl_installs_path <- cmdstan_default_install_path(old, wsl = TRUE)
   }
   if (dir.exists(installs_path) || !is.null(wsl_installs_path)) {
     latest_cmdstan <- ifelse(dir.exists(installs_path),",True,False,Implementation / Logic,6
stan-dev,cmdstanr,a96d4c2ef3c417dc7ea281b3c7cee11de0dd5671,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-10-24T14:39:22Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-10-24T14:39:22Z,Fix install errors,.github/workflows/R-CMD-check-wsl.yaml;tests/testthat/test-install.R,False,True,True,False,3,2,5,"---FILE: .github/workflows/R-CMD-check-wsl.yaml---
@@ -74,6 +74,7 @@ jobs:
 
       - name: Install cmdstan
         run: |
+          cmdstanr::check_cmdstan_toolchain(fix = TRUE)
           cmdstanr::install_cmdstan(cores = 2, wsl = TRUE, overwrite = TRUE)
         shell: Rscript {0}
 

---FILE: tests/testthat/test-install.R---
@@ -28,11 +28,11 @@ test_that(""install_cmdstan() errors if installation already exists"", {
   install_dir <- cmdstan_default_install_path()
   dir <- file.path(install_dir, ""cmdstan-2.23.0"")
   if (!dir.exists(dir)) {
-    dir.create(dir)
+    dir.create(dir, recursive = TRUE)
   }
   expect_warning(
     install_cmdstan(dir = install_dir, overwrite = FALSE,
-                    version = ""2.23.0"", wsl = os_is_wsl()),
+                    version = ""2.23.0"", wsl = FALSE),
     ""An installation already exists"",
     fixed = TRUE
   )",True,False,Implementation / Logic,6
stan-dev,cmdstanr,bcc3eae86b9323d2a15be1b188eb2b76d0a5cd22,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-10-10T07:52:17Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-10-10T07:52:17Z,Fix test failures,.DS_Store;R/model.R;R/utils.R;man/model-method-compile.Rd,False,True,True,False,33,23,56,"---FILE: R/model.R---
@@ -388,6 +388,7 @@ CmdStanModel <- R6::R6Class(
 #'   (`log_prob()`, `grad_log_prob()`, `constrain_pars()`, `unconstrain_pars()`)
 #' @param compile_hessian_method (logical) Should the (experimental) `hessian()` method be
 #'   be compiled with the model methods?
+#' @param compile_standalone (logical) Should functions in the Stan model be compiled for used in R?
 #' @param threads Deprecated and will be removed in a future release. Please
 #'   turn on threading via `cpp_options = list(stan_threads = TRUE)` instead.
 #'

---FILE: R/utils.R---
@@ -616,30 +616,36 @@ create_skeleton <- function(model_variables) {
 }
 
 get_standalone_hpp <- function(stan_file, stancflags) {
-  withr::with_path(
-    c(
-      toolchain_PATH_env_var(),
-      tbb_path()
+  tryCatch(
+    withr::with_path(
+      c(
+        toolchain_PATH_env_var(),
+        tbb_path()
+      ),
+      wsl_compatible_run(
+        command = stanc_cmd(),
+        args = c(stan_file,
+                stancflags),
+        wd = cmdstan_path()
+      )
     ),
-    wsl_compatible_run(
-      command = stanc_cmd(),
-      args = c(stan_file,
-              stancflags),
-      wd = cmdstan_path()
-    )
+    error = function(e) { NULL },
+    finally = function() {
+      name <- strip_ext(basename(stan_file))
+      path <- dirname(stan_file)
+      hpp_path <- file.path(path, paste0(name, "".hpp""))
+      hpp <- readLines(hpp_path)
+      unlink(hpp_path)
+      hpp
+    }
   )
 
-  name <- strip_ext(basename(stan_file))
-  path <- dirname(stan_file)
-  hpp_path <- file.path(path, paste0(name, "".hpp""))
-  hpp <- readLines(hpp_path)
-  unlink(hpp_path)
-  hpp
+    invisible(NULL)
 }
 
-#' Construct the plain return type for a standalone function by
-#' looking up the return type of the functor declaration and replacing
-#' the template types (i.e., T0__) with double
+# Construct the plain return type for a standalone function by
+# looking up the return type of the functor declaration and replacing
+# the template types (i.e., T0__) with double
 get_plain_rtn <- function(fun_body, model_lines) {
   fun_props <- decor::parse_cpp_function(paste(fun_body[-1], collapse = ""\n""))
   struct_start <- grep(paste0(""struct "", fun_props$name, ""_functor""), model_lines)
@@ -654,10 +660,10 @@ get_plain_rtn <- function(fun_body, model_lines) {
   gsub(""(^\\s|\\s$)"", """", repl_dbl)
 }
 
-#' Prepare the c++ code for a standalone function so that it can be exported to R:
-#' - Replace the auto return type with the plain type
-#' - Add Rcpp::export attribute
-#' - Remove the pstream__ argument and pass Rcpp::Rcout by default
+# Prepare the c++ code for a standalone function so that it can be exported to R:
+# - Replace the auto return type with the plain type
+# - Add Rcpp::export attribute
+# - Remove the pstream__ argument and pass Rcpp::Rcout by default
 prep_fun_cpp <- function(fun_body, model_lines) {
   fun_body <- gsub(""auto"", get_plain_rtn(fun_body, model_lines), fun_body)
   fun_body <- gsub(""// [[stan::function]]"", ""// [[Rcpp::export]]"", fun_body, fixed = TRUE)

---FILE: man/model-method-compile.Rd---
@@ -16,6 +16,7 @@ compile(
   force_recompile = getOption(""cmdstanr_force_recompile"", default = FALSE),
   compile_model_methods = FALSE,
   compile_hessian_method = FALSE,
+  compile_standalone = FALSE,
   threads = FALSE
 )
 }
@@ -64,6 +65,8 @@ via a global \code{cmdstanr_force_recompile} option.}
 \item{compile_hessian_method}{(logical) Should the (experimental) \code{hessian()} method be
 be compiled with the model methods?}
 
+\item{compile_standalone}{(logical) Should functions in the Stan model be compiled for used in R?}
+
 \item{threads}{Deprecated and will be removed in a future release. Please
 turn on threading via \code{cpp_options = list(stan_threads = TRUE)} instead.}
 }",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,e76f6330748d25273774fa137b682f010e975b0c,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-10-05T21:38:30Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-10-05T21:38:30Z,Fix DLL lookup on window,R/fit.R;R/utils.R;man/cmdstanr-package.Rd;man/fit-method-hessian.Rd;man/fit-method-init_model_methods.Rd,False,True,True,False,102,13,115,"---FILE: R/fit.R---
@@ -286,6 +286,7 @@ CmdStanFit$set(""public"", name = ""init"", value = init)
 #'
 #' @param seed (integer) The random seed to use when initializing the model.
 #' @param verbose (boolean) Whether to show verbose logging during compilation.
+#' @param hessian (boolean) Whether to expose the (experimental) hessian method.
 #'
 #' @examples
 #' \dontrun{

---FILE: R/utils.R---
@@ -528,6 +528,20 @@ get_cmdstan_flags <- function(flag_name) {
     replacement = """", x = flags, fixed = TRUE
   )
 
+  if (flag_name %in% c(""LDLIBS"", ""LDFLAGS_TBB"")) {
+    # shQuote -L paths and rpaths
+    # The LDLIBS flags change paths to /c/ instead of C:/, need to revert to
+    # format consistent with path on windows
+    if (.Platform$OS.type == ""windows"") {
+      flags <- gsub(""(-L|-rpath),/([a-zA-Z])/"", ""\\1,\\2:/"", flags, perl = TRUE)
+    }
+    flags <- gsub(cmdstan_path, """", flags, ignore.case = TRUE)
+    flags <- gsub(""(-L,|-rpath,)/stan/lib/stan_math/lib/tbb"",
+                  paste0(""\\1"", shQuote(paste0(cmdstan_path, ""/stan/lib/stan_math/lib/tbb""))),
+                  flags)
+    return(flags)
+  }
+
   # shQuote include paths
   flags <- gsub(""-I "", ""-I"", flags, fixed = TRUE)
   flags <- strsplit(flags, "" "", fixed = TRUE)[[1]]
@@ -544,7 +558,6 @@ get_cmdstan_flags <- function(flag_name) {
 }
 
 expose_model_methods <- function(hpp_code, env, verbose = FALSE, hessian = FALSE) {
-
   code <- c(hpp_code,
             readLines(system.file(""include"", ""model_methods.cpp"",
                                   package = ""cmdstanr"", mustWork = TRUE)))
@@ -560,15 +573,21 @@ expose_model_methods <- function(hpp_code, env, verbose = FALSE, hessian = FALSE
   cxxflags <- get_cmdstan_flags(""CXXFLAGS"")
   libs <- c(""LDLIBS"", ""LIBSUNDIALS"", ""TBB_TARGETS"", ""LDFLAGS_TBB"")
   libs <- paste(sapply(libs, get_cmdstan_flags), collapse = """")
-
-  compiled <- withr::with_makevars(
-    c(
-      USE_CXX14 = 1,
-      PKG_CPPFLAGS = ifelse(cmdstan_version() <= ""2.30.1"", ""-DCMDSTAN_JSON"", """"),
-      PKG_CXXFLAGS = paste(cxxflags, ""-ftemplate-backtrace-limit=0""),
-      PKG_LIBS = libs
-    ),
-    Rcpp::sourceCpp(code = code, env = env, verbose = verbose)
+  if (.Platform$OS.type == ""windows"") {
+    libs <- paste(libs, ""-fopenmp"")
+  }
+  lib_paths <- c(""/stan/lib/stan_math/lib/tbb/"",
+                 ""/stan/lib/stan_math/lib/sundials_6.1.1/lib/"")
+  withr::with_path(paste0(cmdstan_path(), lib_paths),
+    withr::with_makevars(
+      c(
+        USE_CXX14 = 1,
+        PKG_CPPFLAGS = ifelse(cmdstan_version() <= ""2.30.1"", ""-DCMDSTAN_JSON"", """"),
+        PKG_CXXFLAGS = cxxflags,
+        PKG_LIBS = libs
+      ),
+      Rcpp::sourceCpp(code = code, env = env, verbose = verbose)
+    )
   )
   return(env)
 }

---FILE: man/cmdstanr-package.Rd---
@@ -20,6 +20,49 @@ CmdStanR (\pkg{cmdstanr} package) is an interface to Stan
 necessary objects and functions to compile a Stan program and run Stan's
 algorithms from \R via CmdStan, the shell interface to Stan
 (\href{https://mc-stan.org/users/interfaces/cmdstan}{mc-stan.org/users/interfaces/cmdstan}).
+
+\subsection{Different ways of interfacing with Stans C++}{
+
+The RStan interface (\href{https://mc-stan.org/rstan/}{\strong{rstan}} package) is
+an in-memory interface to Stan and relies on R packages like \strong{Rcpp}
+and \strong{inline} to call C++ code from R. On the other hand, the CmdStanR
+interface does not directly call any C++ code from R, instead relying on
+the CmdStan interface behind the scenes for compilation, running
+algorithms, and writing results to output files.
+}
+
+\subsection{Advantages of RStan}{
+\itemize{
+\item Advanced features. We are working on making these available outside
+of RStan but currently they are only available to R users via RStan:
+\itemize{
+\item \code{rstan::log_prob()}
+\item \code{rstan::grad_log_prob()}
+\item \code{rstan::expose_stan_functions()}
+}
+\item Allows other developers to distribute R packages with \emph{pre-compiled}
+Stan programs (like \strong{rstanarm}) on CRAN.
+}
+}
+
+\subsection{Advantages of CmdStanR}{
+\itemize{
+\item Compatible with latest versions of Stan. Keeping up with Stan
+releases is complicated for RStan, often requiring non-trivial
+changes to the \strong{rstan} package and new CRAN releases of both
+\strong{rstan} and \strong{StanHeaders}. With CmdStanR the latest improvements
+in Stan will be available from R immediately after updating CmdStan
+using \code{cmdstanr::install_cmdstan()}.
+\item Fewer installation issues (e.g., no need to mess with Makevars
+files).
+\item Running Stan via external processes results in fewer unexpected
+crashes, especially in RStudio.
+\item Less memory overhead.
+\item More permissive license. RStan uses the GPL-3 license while the
+license for CmdStanR is BSD-3, which is a bit more permissive and is
+the same license used for CmdStan and the Stan C++ source code.
+}
+}
 }
 \section{Getting started}{
  CmdStanR requires a working version of CmdStan. If

---FILE: man/fit-method-hessian.Rd---
@@ -0,0 +1,25 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/fit.R
+\name{fit-method-hessian}
+\alias{fit-method-hessian}
+\alias{hessian}
+\title{Calculate the log-probability , the gradient w.r.t. each input, and the hessian
+for a given vector of unconstrained parameters}
+\usage{
+hessian(upars)
+}
+\arguments{
+\item{upars}{(numeric) A vector of unconstrained parameters to be passed
+to \code{hessian}}
+}
+\description{
+The \verb{$hessian()} method provides access to the
+Stan model's \code{log_prob}, its derivative, and its hessian
+}
+\examples{
+\dontrun{
+fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"")
+fit_mcmc$hessian(upars = c(0.5, 1.2, 1.1, 2.2, 1.1))
+}
+
+}

---FILE: man/fit-method-init_model_methods.Rd---
@@ -4,15 +4,16 @@
 \alias{fit-method-init_model_methods}
 \alias{init_model_methods}
 \title{Compile additional methods for accessing the model log-probability function
-and parameter constraining and unconstraining. This requires that the \code{Rcpp}
-and \code{RcppEigen} packages are installed.}
+and parameter constraining and unconstraining. This requires the \code{Rcpp} package.}
 \usage{
-init_model_methods(seed = 0, verbose = FALSE)
+init_model_methods(seed = 0, verbose = FALSE, hessian = FALSE)
 }
 \arguments{
 \item{seed}{(integer) The random seed to use when initializing the model.}
 
 \item{verbose}{(boolean) Whether to show verbose logging during compilation.}
+
+\item{hessian}{(boolean) Whether to expose the (experimental) hessian method.}
 }
 \description{
 The \verb{$init_model_methods()} compiles and initializes the",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,ec4f583b195c4b6ac14acb0671352f31c012ec39,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-10-05T20:12:04Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-10-05T20:12:04Z,"Add hessian method, fix spaces in includes",DESCRIPTION;R/fit.R;R/utils.R;inst/include/hessian.cpp;inst/include/model_methods.cpp;tests/testthat/test-model-methods.R,False,True,True,False,123,32,155,"---FILE: DESCRIPTION---
@@ -47,5 +47,6 @@ Suggests:
     rlang (>= 0.4.7),
     rmarkdown,
     testthat (>= 2.1.0),
-    Rcpp
+    Rcpp,
+    RcppEigen
 VignetteBuilder: knitr

---FILE: R/fit.R---
@@ -293,19 +293,21 @@ CmdStanFit$set(""public"", name = ""init"", value = init)
 #' fit_mcmc$init_model_methods()
 #' }
 #'
-init_model_methods <- function(seed = 0, verbose = FALSE) {
-  if (!requireNamespace(""Rcpp"", quietly = TRUE)) {
-    stop(
-      ""Package \""Rcpp\"" must be installed to use this function."",
-      call. = FALSE
-    )
-  }
+init_model_methods <- function(seed = 0, verbose = FALSE, hessian = FALSE) {
+  require_suggested_package(""Rcpp"")
+  require_suggested_package(""RcppEigen"")
   if (length(self$runset$hpp_code()) == 0) {
     stop(""Model methods cannot be used with a pre-compiled Stan executable, "",
           ""the model must be compiled again"", call. = FALSE)
   }
+  if (hessian) {
+    message(""The hessian method relies on higher-order autodiff "",
+            ""which is still experimental. Please report any compilation "",
+            ""errors that you encounter"",
+            call. = FALSE)
+  }
   message(""Compiling additional model methods..."")
-  private$model_method_env_ <- expose_model_methods(self$runset$hpp_code(), new.env(), verbose)
+  private$model_method_env_ <- expose_model_methods(self$runset$hpp_code(), new.env(), verbose, hessian)
   ptr_and_rng <- private$model_method_env_$model_ptr(self$data_file(), seed)
   private$model_ptr_ <- ptr_and_rng$model_ptr
   private$model_rng_ <- ptr_and_rng$base_rng
@@ -375,6 +377,36 @@ grad_log_prob <- function(upars, jacobian_adjustment = TRUE) {
 }
 CmdStanFit$set(""public"", name = ""grad_log_prob"", value = grad_log_prob)
 
+#' Calculate the log-probability , the gradient w.r.t. each input, and the hessian
+#' for a given vector of unconstrained parameters
+#'
+#' @name fit-method-hessian
+#' @aliases hessian
+#' @description The `$hessian()` method provides access to the
+#' Stan model's `log_prob`, its derivative, and its hessian
+#'
+#' @param upars (numeric) A vector of unconstrained parameters to be passed
+#' to `hessian`
+#'
+#' @examples
+#' \dontrun{
+#' fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"")
+#' fit_mcmc$hessian(upars = c(0.5, 1.2, 1.1, 2.2, 1.1))
+#' }
+#'
+hessian <- function(upars) {
+  if (is.null(private$model_method_env_)) {
+    stop(""The method has not been compiled, please call `init_model_methods()` first"",
+        call. = FALSE)
+  }
+  if (length(upars) != private$num_upars_) {
+    stop(""Model has "", private$num_upars_, "" unconstrained parameter(s), but "",
+          length(upars), "" were provided!"", call. = FALSE)
+  }
+  private$model_method_env_$hessian(private$model_ptr_, upars)
+}
+CmdStanFit$set(""public"", name = ""hessian"", value = hessian)
+
 #' Transform a set of parameter values to the unconstrained scale
 #'
 #' @name fit-method-unconstrain_pars

---FILE: R/utils.R---
@@ -520,30 +520,42 @@ get_cmdstan_flags <- function(flag_name) {
     args = c(paste0(""print-"", flag_name)),
     wd = cmdstan_path
   )$stdout
+
+  flags <- gsub(""\n"", """", flags, fixed = TRUE)
+
   flags <- gsub(
     pattern = paste0(flag_name, "" =""),
     replacement = """", x = flags, fixed = TRUE
   )
-  flags <- gsub(
-    pattern = "" stan/"", replacement = paste0("" "", cmdstan_path, ""/stan/""),
-    x = flags, fixed = TRUE
-  )
-  flags <- gsub(
-    pattern = ""-I lib/"", replacement = paste0(""-I "", cmdstan_path, ""/lib/""),
-    x = flags, fixed = TRUE
-  )
-  flags <- gsub(
-    pattern = ""-I src"", replacement = paste0(""-I "", cmdstan_path, ""/src""),
-    x = flags, fixed = TRUE
-  )
-  gsub(""\n"", """", flags)
+
+  # shQuote include paths
+  flags <- gsub(""-I "", ""-I"", flags, fixed = TRUE)
+  flags <- strsplit(flags, "" "", fixed = TRUE)[[1]]
+  include_flags <- grep(""^-I"", flags)
+  flags <- gsub(""^-I"", paste0(cmdstan_path, ""/""), flags)
+  flags[include_flags] <- paste0(""-I"", shQuote(flags[include_flags]))
+  flags <- paste(flags, collapse = "" "")
+
+  # shQuote Remaining "" stan/"" paths
+  flags <- strsplit(flags, split = "" "", fixed = TRUE)[[1]]
+  oth_stan_flags <- grep(""^stan/"", flags)
+  flags[oth_stan_flags] <- shQuote(paste0(cmdstan_path, ""/"", flags[oth_stan_flags]))
+  paste(flags, collapse = "" "")
 }
 
-expose_model_methods <- function(hpp_code, env, verbose) {
-  code <- paste(c(hpp_code,
-                  readLines(system.file(""include"", ""model_methods.cpp"",
-                                        package = ""cmdstanr"", mustWork = TRUE))),
-                collapse = ""\n"")
+expose_model_methods <- function(hpp_code, env, verbose = FALSE, hessian = FALSE) {
+
+  code <- c(hpp_code,
+            readLines(system.file(""include"", ""model_methods.cpp"",
+                                  package = ""cmdstanr"", mustWork = TRUE)))
+
+  if (hessian) {
+    code <- c(code,
+            readLines(system.file(""include"", ""hessian.cpp"",
+                                  package = ""cmdstanr"", mustWork = TRUE)))
+  }
+
+  code <- paste(code, collapse = ""\n"")
 
   cxxflags <- get_cmdstan_flags(""CXXFLAGS"")
   libs <- c(""LDLIBS"", ""LIBSUNDIALS"", ""TBB_TARGETS"", ""LDFLAGS_TBB"")
@@ -553,7 +565,7 @@ expose_model_methods <- function(hpp_code, env, verbose) {
     c(
       USE_CXX14 = 1,
       PKG_CPPFLAGS = ifelse(cmdstan_version() <= ""2.30.1"", ""-DCMDSTAN_JSON"", """"),
-      PKG_CXXFLAGS = cxxflags,
+      PKG_CXXFLAGS = paste(cxxflags, ""-ftemplate-backtrace-limit=0""),
       PKG_LIBS = libs
     ),
     Rcpp::sourceCpp(code = code, env = env, verbose = verbose)

---FILE: inst/include/hessian.cpp---
@@ -0,0 +1,19 @@
+#include <RcppEigen.h>
+
+// [[Rcpp::depends(RcppEigen)]]
+
+// [[Rcpp::export]]
+Rcpp::List hessian(SEXP ext_model_ptr, Eigen::VectorXd& upars) {
+  Rcpp::XPtr<stan_model> ptr(ext_model_ptr);
+
+  double log_prob;
+  Eigen::VectorXd grad;
+  Eigen::MatrixXd hessian;
+
+  stan::model::hessian(*ptr.get(), upars, log_prob, grad, hessian);
+
+  return Rcpp::List::create(
+    Rcpp::Named(""log_prob"") = log_prob,
+    Rcpp::Named(""grad_log_prob"") = grad,
+    Rcpp::Named(""hessian"") = hessian);
+}

---FILE: inst/include/model_methods.cpp---
@@ -1,6 +1,7 @@
 #include <Rcpp.h>
 #include <stan/model/log_prob_grad.hpp>
 #include <stan/model/log_prob_propto.hpp>
+#include <stan/model/hessian.hpp>
 #include <boost/random/additive_combine.hpp>
 #ifdef CMDSTAN_JSON
 #include <cmdstan/io/json/json_data.hpp>

---FILE: tests/testthat/test-model-methods.R---
@@ -16,6 +16,11 @@ test_that(""Methods error if not compiled"", {
     ""The method has not been compiled, please call `init_model_methods()` first"",
     fixed = TRUE
   )
+  expect_error(
+    fit$hessian(NULL),
+    ""The method has not been compiled, please call `init_model_methods()` first"",
+    fixed = TRUE
+  )
   expect_error(
     fit$unconstrain_pars(NULL),
     ""The method has not been compiled, please call `init_model_methods()` first"",
@@ -28,15 +33,29 @@ test_that(""Methods error if not compiled"", {
   )
 })
 
-fit$init_model_methods()
+test_that(""User warned about higher-order autodiff with hessian"", {
+  expect_message(
+    fit$init_model_methods(hessian = TRUE, verbose = TRUE),
+    ""The hessian method relies on higher-order autodiff which is still experimental. Please report any compilation errors that you encounter"",
+    fixed = TRUE
+    )
+})
 
 test_that(""Methods return correct values"", {
-  expect_equal(fit$log_prob(upars=c(0.1)), -8.6327599208828509347)
+  lp <- fit$log_prob(upars=c(0.1))
+  expect_equal(lp, -8.6327599208828509347)
 
   grad_lp <- -3.2997502497472801508
-  attr(grad_lp, ""log_prob"") <- -8.6327599208828509347
+  attr(grad_lp, ""log_prob"") <- lp
   expect_equal(fit$grad_log_prob(upars=c(0.1)), grad_lp)
 
+  hessian <- list(
+    log_prob = lp,
+    grad_log_prob = -3.2997502497472801508,
+    hessian = as.matrix(-2.9925124823147033482, nrow=1, ncol=1)
+  )
+  expect_equal(fit$hessian(upars=c(0.1)), hessian)
+
   cpars <- fit$constrain_pars(c(0.1))
   expect_equal(cpars, list(theta = 0.52497918747894001257))
 
@@ -55,6 +74,11 @@ test_that(""methods error for incorrect inputs"", {
     ""Model has 1 unconstrained parameter(s), but 2 were provided!"",
     fixed = TRUE
   )
+  expect_error(
+    fit$hessian(c(1,2)),
+    ""Model has 1 unconstrained parameter(s), but 2 were provided!"",
+    fixed = TRUE
+  )
   expect_error(
     fit$unconstrain_pars(list(theta = 0.5, dummy = 5)),
     ""Provided parameter(s): dummy not present in model!"",
@@ -69,7 +93,9 @@ test_that(""methods error for incorrect inputs"", {
   logistic_mod <- cmdstan_model(testing_stan_file(""logistic""), force_recompile = TRUE)
   logistic_data_list <- testing_data(""logistic"")
   logistic_fit <- logistic_mod$sample(data = logistic_data_list, chains = 1)
-  logistic_fit$init_model_methods()
+  # Init without Hessian, as bernoulli_logit_glm currently not fully fvar<var>
+  # compatible
+  logistic_fit$init_model_methods(verbose = TRUE)
 
   expect_error(
     logistic_fit$unconstrain_pars(list(alpha = 0.5)),",True,False,Dependency / Package,6
stan-dev,cmdstanr,fa45817e0dbce36fbd1e22a237b00fd02fb4d867,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-10-05T15:01:21Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-10-05T15:01:21Z,Fix notes,DESCRIPTION;R/fit.R;R/utils.R,False,True,True,False,3,3,6,"---FILE: DESCRIPTION---
@@ -15,7 +15,7 @@ Authors@R:
            email = ""will.landau@gmail.com"", comment = c(ORCID = ""0000-0003-1878-3253"")),
       person(given = ""Jacob"", family = ""Socolar"", role = ""ctb""),
       person(given = ""Andrew"", family = ""Johnson"", role = ""ctb"",
-            comment = c(ORCID = ""0000-0001-7000-8065 "")))
+            comment = c(ORCID = ""0000-0001-7000-8065"")))
 Description: A lightweight interface to 'Stan' <https://mc-stan.org>.
     The 'CmdStanR' interface is an alternative to 'RStan' that calls the command
     line interface for compilation and running algorithms instead of interfacing

---FILE: R/fit.R---
@@ -438,7 +438,7 @@ constrain_pars <- function(upars) {
   }
   cpars <- private$model_method_env_$constrain_pars(private$model_ptr_, private$model_rng_, upars)
   skeleton <- create_skeleton(self$runset$args$model_variables)
-  relist(cpars, skeleton)
+  utils::relist(cpars, skeleton)
 }
 CmdStanFit$set(""public"", name = ""constrain_pars"", value = constrain_pars)
 

---FILE: R/utils.R---
@@ -568,5 +568,5 @@ create_skeleton <- function(model_variables) {
     dims <- ifelse(dims == 0, 1, dims)
     array(0, dim = dims)
   })
-  setNames(skeleton, names(model_pars))
+  stats::setNames(skeleton, names(model_pars))
 }",True,False,Dependency / Package,6
stan-dev,cmdstanr,23eaa09b571aaa393867579fe2eeeca1de3023da,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-10-04T15:15:19Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-10-04T15:15:19Z,"Doc added, basic error-checking",DESCRIPTION;R/args.R;R/fit.R;R/utils.R;inst/include/model_methods.cpp,False,True,True,False,192,25,217,"---FILE: DESCRIPTION---
@@ -47,6 +47,5 @@ Suggests:
     rlang (>= 0.4.7),
     rmarkdown,
     testthat (>= 2.1.0),
-    Rcpp,
-    RcppEigen
+    Rcpp
 VignetteBuilder: knitr

---FILE: R/args.R---
@@ -54,6 +54,7 @@ CmdStanArgs <- R6::R6Class(
       self$method <- self$method_args$method
       self$save_latent_dynamics <- save_latent_dynamics
       self$using_tempdir <- is.null(output_dir)
+      self$model_variables <- model_variables
       if (getRversion() < ""3.5.0"") {
         self$output_dir <- output_dir %||% tempdir()
       } else {

---FILE: R/fit.R---
@@ -66,7 +66,8 @@ CmdStanFit <- R6::R6Class(
     profiles_ = NULL,
     model_method_env_ = NULL,
     model_ptr_ = NULL,
-    model_rng_ = NULL
+    model_rng_ = NULL,
+    num_upars_ = NULL
   )
 )
 
@@ -275,33 +276,162 @@ init <- function() {
 }
 CmdStanFit$set(""public"", name = ""init"", value = init)
 
+#' Compile additional methods for accessing the model log-probability function
+#' and parameter constraining and unconstraining. This requires that the `Rcpp`
+#' and `RcppEigen` packages are installed.
+#'
+#' @name fit-method-init_model_methods
+#' @aliases init_model_methods
+#' @description The `$init_model_methods()` compiles and initializes the
+#' `log_prob`, `grad_log_prob`, `constrain_pars`, and `unconstrain_pars` functions.
+#'
+#' @param seed (integer) The random seed to use when initializing the model.
+#' @param verbose (boolean) Whether to show verbose logging during compilation.
+#'
+#' @examples
+#' \dontrun{
+#' fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"")
+#' fit_mcmc$init_model_methods()
+#' }
+#'
 init_model_methods <- function(seed = 0, verbose = FALSE) {
+  if (!requireNamespace(""Rcpp"", quietly = TRUE)) {
+    stop(
+      ""Package \""Rcpp\"" must be installed to use this function."",
+      call. = FALSE
+    )
+  }
   private$model_method_env_ <- expose_model_methods(self$runset$hpp_file(), new.env(), verbose)
-  ptr_and_rng <- model_ptr(self$data_file(), seed)
+  ptr_and_rng <- private$model_method_env_$model_ptr(self$data_file(), seed)
   private$model_ptr_ <- ptr_and_rng[[1]]
   private$model_rng_ <- ptr_and_rng[[2]]
+  private$num_upars_ <- private$model_method_env_$get_num_upars(private$model_ptr_)
   invisible(NULL)
 }
 CmdStanFit$set(""public"", name = ""init_model_methods"", value = init_model_methods)
 
-log_prob <- function(upars) {
-  private$model_method_env_$log_prob(private$model_ptr_, upars)
+#' Calculate the log-probability given a provided vector of unconstrained parameters.
+#'
+#' @name fit-method-log_prob
+#' @aliases log_prob
+#' @description The `$log_prob()` method provides access to the Stan model's `log_prob` function
+#'
+#' @param upars (numeric) A vector of unconstrained parameters to be passed to `log_prob`
+#' @param jacobian_adjustment (bool) Whether to include the log-density adjustments from
+#' un/constraining variables
+#'
+#' @examples
+#' \dontrun{
+#' fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"")
+#' fit_mcmc$log_prob(upars = c(0.5, 1.2, 1.1, 2.2, 1.1))
+#' }
+#'
+log_prob <- function(upars, jacobian_adjustment = TRUE) {
+  if (is.null(private$model_method_env_)) {
+    stop(""The method has not been compiled, please call `init_model_methods` first"",
+        call. = FALSE)
+  }
+  if (length(upars) != private$num_upars_) {
+    stop(""Model has "", private$num_upars_, "" unconstrained parameter(s), but "",
+          length(upars), "" were provided!"", call. = FALSE)
+  }
+  private$model_method_env_$log_prob(private$model_ptr_, upars, jacobian_adjustment)
 }
 CmdStanFit$set(""public"", name = ""log_prob"", value = log_prob)
 
-grad_log_prob <- function(upars) {
-  private$model_method_env_$grad_log_prob(private$model_ptr_, upars)
+#' Calculate the log-probability and the gradient w.r.t. each input for a
+#' given vector of unconstrained parameters
+#'
+#' @name fit-method-grad_log_prob
+#' @aliases grad_log_prob
+#' @description The `$grad_log_prob()` method provides access to the
+#' Stan model's `log_prob` function and its derivative
+#'
+#' @param upars (numeric) A vector of unconstrained parameters to be passed
+#' to `grad_log_prob`
+#' @param jacobian_adjustment (bool) Whether to include the log-density adjustments from
+#' un/constraining variables
+#'
+#' @examples
+#' \dontrun{
+#' fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"")
+#' fit_mcmc$grad_log_prob(upars = c(0.5, 1.2, 1.1, 2.2, 1.1))
+#' }
+#'
+grad_log_prob <- function(upars, jacobian_adjustment = TRUE) {
+  if (is.null(private$model_method_env_)) {
+    stop(""The method has not been compiled, please call `init_model_methods` first"",
+        call. = FALSE)
+  }
+  if (length(upars) != private$num_upars_) {
+    stop(""Model has "", private$num_upars_, "" unconstrained parameter(s), but "",
+          length(upars), "" were provided!"", call. = FALSE)
+  }
+  private$model_method_env_$grad_log_prob(private$model_ptr_, upars, jacobian_adjustment)
 }
 CmdStanFit$set(""public"", name = ""grad_log_prob"", value = grad_log_prob)
 
+#' Transform a set of parameter values to the unconstrained scale
+#'
+#' @name fit-method-unconstrain_pars
+#' @aliases unconstrain_pars
+#' @description The `$unconstrain_pars()` method transforms input parameters to
+#' the unconstrained scale
+#'
+#' @param pars (list) A list of parameter values to transform, in the same format as
+#' provided to the `init` argument of the `$sample()` method
+#'
+#' @examples
+#' \dontrun{
+#' fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"")
+#' fit_mcmc$unconstrain_pars(list(alpha = 0.5, beta = c(0.7, 1.1, 0.2)))
+#' }
+#'
 unconstrain_pars <- function(pars) {
-  init_file <- tempfile(fileext = "".json"")
-  write_stan_json(pars, file = init_file)
-  private$model_method_env_$unconstrain_pars(private$model_ptr_, init_file)
+  if (is.null(private$model_method_env_)) {
+    stop(""The method has not been compiled, please call `init_model_methods` first"",
+        call. = FALSE)
+  }
+  model_par_names <- names(self$runset$args$model_variables$parameters)
+  prov_par_names <- names(pars)
+
+  prov_pars_not_in_model <- which(!(prov_par_names %in% model_par_names))
+  if (length(prov_pars_not_in_model) > 0) {
+    stop(""Provided parameters: "", paste(prov_par_names[prov_pars_not_in_model], collapse = "",""),
+         "" not present in model!"", call. = FALSE)
+  }
+
+  model_pars_not_prov <- which(!(model_par_names %in% prov_par_names))
+  if (length(model_pars_not_prov) > 0) {
+    stop(""Model parameters: "", paste(model_par_names[model_pars_not_prov], collapse = "",""),
+         "" provided!"", call. = FALSE)
+  }
+
+  stan_pars <- process_init_list(list(pars), num_procs = 1, self$runset$args$model_variables)
+  private$model_method_env_$unconstrain_pars(private$model_ptr_, stan_pars)
 }
 CmdStanFit$set(""public"", name = ""unconstrain_pars"", value = unconstrain_pars)
 
+#' Transform a set of unconstrained parameter values to the constrained scale
+#'
+#' @name fit-method-constrain_pars
+#' @aliases constrain_pars
+#' @description The `$constrain_pars()` method transforms input parameters to
+#' the constrained scale
+#'
+#' @param upars (numeric) A vector of unconstrained parameters to constrain
+#'
+#' @examples
+#' \dontrun{
+#' fit_mcmc <- cmdstanr_example(""logistic"", method = ""sample"")
+#' fit_mcmc$constrain_pars(upars = c(0.5, 1.2, 1.1, 2.2, 1.1))
+#' }
+#'
 constrain_pars <- function(upars) {
+  if (length(upars) != private$num_upars_) {
+    stop(""Model has "", private$num_upars_, "" unconstrained parameter(s), but "",
+          length(upars), "" were provided!"", call. = FALSE)
+  }
   private$model_method_env_$constrain_pars(private$model_ptr_, private$model_rng_, upars)
 }
 CmdStanFit$set(""public"", name = ""constrain_pars"", value = constrain_pars)

---FILE: R/utils.R---
@@ -545,10 +545,14 @@ expose_model_methods <- function(hpp_path, env, verbose) {
                                         package = ""cmdstanr"", mustWork = TRUE))),
                 collapse = ""\n"")
 
+  cxxflags <- get_cmdstan_flags(""CXXFLAGS"")
+  libs <- c(""LDLIBS"", ""LIBSUNDIALS"", ""TBB_TARGETS"", ""LDFLAGS_TBB"")
+  libs <- paste(sapply(libs, get_cmdstan_flags), collapse = """")
+
   compiled <- withr::with_makevars(
     c(
       USE_CXX14 = 1,
-      PKG_CPPFLAGS = """",
+      PKG_CPPFLAGS = ifelse(cmdstan_version() <= ""2.30.1"", ""-DCMDSTAN_JSON"", """"),
       PKG_CXXFLAGS = cxxflags,
       PKG_LIBS = libs
     ),

---FILE: inst/include/model_methods.cpp---
@@ -1,13 +1,28 @@
-#include <RcppEigen.h>
-#include <cmdstan/command.hpp>
+#include <Rcpp.h>
+#include <stan/model/log_prob_grad.hpp>
+#include <stan/model/log_prob_propto.hpp>
 #include <boost/random/additive_combine.hpp>
+#ifdef CMDSTAN_JSON
+#include <cmdstan/io/json/json_data.hpp>
+#else
+#include <stan/io/json/json_data.hpp>
+#endif
 
-// [[Rcpp::depends(RcppEigen)]]
+std::shared_ptr<stan::io::var_context> var_context(std::string file_path) {
+  std::fstream stream(file_path.c_str(), std::fstream::in);
+#ifdef CMDSTAN_JSON
+using json_data_t = cmdstan::json::json_data;
+#else
+using json_data_t = stan::json::json_data;
+#endif
+  json_data_t data_context(stream);
+  return std::make_shared<json_data_t>(data_context);
+}
 
 // [[Rcpp::export]]
 Rcpp::List model_ptr(std::string data_path, boost::uint32_t seed) {
   Rcpp::XPtr<stan_model> ptr(
-    new stan_model(*cmdstan::get_var_context(data_path), seed, &Rcpp::Rcout)
+    new stan_model(*var_context(data_path), seed, &Rcpp::Rcout)
   );
   Rcpp::XPtr<boost::ecuyer1988> base_rng(new boost::ecuyer1988(seed));
   return Rcpp::List::create(
@@ -17,31 +32,49 @@ Rcpp::List model_ptr(std::string data_path, boost::uint32_t seed) {
 }
 
 // [[Rcpp::export]]
-double log_prob(SEXP ext_model_ptr, Eigen::VectorXd upars) {
+double log_prob(SEXP ext_model_ptr, std::vector<double> upars,
+                bool jac_adjust) {
   Rcpp::XPtr<stan::model::model_base> ptr(ext_model_ptr);
-  return ptr->log_prob<false, true>(upars, &Rcpp::Rcout);
+  std::vector<int> params_i;
+  if (jac_adjust) {
+    return stan::model::log_prob_propto<true>(*ptr.get(), upars, params_i, &Rcpp::Rcout);
+  } else {
+    return stan::model::log_prob_propto<false>(*ptr.get(), upars, params_i, &Rcpp::Rcout);
+  }
 }
 
 // [[Rcpp::export]]
-Rcpp::NumericVector grad_log_prob(SEXP ext_model_ptr, Eigen::VectorXd upars) {
+Rcpp::NumericVector grad_log_prob(SEXP ext_model_ptr, std::vector<double> upars,
+                                  bool jac_adjust) {
   Rcpp::XPtr<stan::model::model_base> ptr(ext_model_ptr);
-  Eigen::VectorXd gradients;
+  std::vector<double> gradients;
+  std::vector<int> params_i;
 
-  double lp = stan::model::log_prob_grad<false, true>(
-    *ptr.get(), upars, gradients);
+  double lp;
+  if (jac_adjust) {
+    lp = stan::model::log_prob_grad<true, true>(
+      *ptr.get(), upars, params_i, gradients);
+  } else {
+  lp = stan::model::log_prob_grad<true, false>(
+      *ptr.get(), upars, params_i, gradients);
+  }
   Rcpp::NumericVector grad_rtn = Rcpp::wrap(gradients);
   grad_rtn.attr(""log_prob"") = lp;
   return grad_rtn;
 }
 
+// [[Rcpp::export]]
+size_t get_num_upars(SEXP ext_model_ptr) {
+  Rcpp::XPtr<stan::model::model_base> ptr(ext_model_ptr);
+  return ptr->num_params_r();
+}
+
 // [[Rcpp::export]]
 std::vector<double> unconstrain_pars(SEXP ext_model_ptr, std::string init_path) {
   Rcpp::XPtr<stan::model::model_base> ptr(ext_model_ptr);
-  std::shared_ptr<stan::io::var_context> init_context
-    = cmdstan::get_var_context(init_path);
   std::vector<int> params_i;
   std::vector<double> vars;
-  ptr->transform_inits(*init_context.get(), params_i, vars, &Rcpp::Rcout);
+  ptr->transform_inits(*var_context(init_path), params_i, vars, &Rcpp::Rcout);
   return vars;
 }
 ",True,False,Dependency / Package,6
stan-dev,cmdstanr,8f8df1d09c4ee9db791a0f586878d192e60bb844,dependabot[bot],49699333+dependabot[bot]@users.noreply.github.com,2022-09-05T18:43:32Z,GitHub,noreply@github.com,2022-09-05T18:43:32Z,"Bump r-lib/actions from 2.2.6 to 2.2.8

Bumps [r-lib/actions](https://github.com/r-lib/actions) from 2.2.6 to 2.2.8.
- [Release notes](https://github.com/r-lib/actions/releases)
- [Commits](https://github.com/r-lib/actions/compare/v2.2.6...v2.2.8)

---
updated-dependencies:
- dependency-name: r-lib/actions
  dependency-type: direct:production
  update-type: version-update:semver-patch
...

Signed-off-by: dependabot[bot] <support@github.com>",.github/workflows/R-CMD-check-wsl.yaml;.github/workflows/R-CMD-check.yaml;.github/workflows/Test-coverage.yaml;.github/workflows/cmdstan-tarball-check.yaml,False,False,False,False,10,10,20,"---FILE: .github/workflows/R-CMD-check-wsl.yaml---
@@ -37,11 +37,11 @@ jobs:
 
       - uses: actions/checkout@v3
 
-      - uses: r-lib/actions/setup-r@v2.2.6
+      - uses: r-lib/actions/setup-r@v2.2.8
         with:
           r-version: 'release'
           rtools-version: '42'
-      - uses: r-lib/actions/setup-pandoc@v2.2.6
+      - uses: r-lib/actions/setup-pandoc@v2.2.8
 
       - name: Query dependencies
         run: |

---FILE: .github/workflows/R-CMD-check.yaml---
@@ -56,11 +56,11 @@ jobs:
           sudo apt-get install -y libcurl4-openssl-dev || true
           sudo apt-get install -y openmpi-bin openmpi-common libopenmpi-dev || true
 
-      - uses: r-lib/actions/setup-r@v2.2.6
+      - uses: r-lib/actions/setup-r@v2.2.8
         with:
           r-version: ${{ matrix.config.r }}
           rtools-version: ${{ matrix.config.rtools }}
-      - uses: r-lib/actions/setup-pandoc@v2.2.6
+      - uses: r-lib/actions/setup-pandoc@v2.2.8
 
       - name: Query dependencies
         run: |

---FILE: .github/workflows/Test-coverage.yaml---
@@ -34,8 +34,8 @@ jobs:
         if: ""!startsWith(github.ref, 'refs/tags/') && github.ref != 'refs/heads/master'""
       - uses: actions/checkout@v3
 
-      - uses: r-lib/actions/setup-r@v2.2.6
-      - uses: r-lib/actions/setup-pandoc@v2.2.6
+      - uses: r-lib/actions/setup-r@v2.2.8
+      - uses: r-lib/actions/setup-pandoc@v2.2.8
 
       - name: Install Ubuntu dependencies
         run: |
@@ -85,12 +85,12 @@ jobs:
     steps:
       - uses: actions/checkout@v3
 
-      - uses: r-lib/actions/setup-r@v2.2.6
+      - uses: r-lib/actions/setup-r@v2.2.8
         with:
           r-version: 'release'
           rtools-version: '42'
 
-      - uses: r-lib/actions/setup-pandoc@v2.2.6
+      - uses: r-lib/actions/setup-pandoc@v2.2.8
 
       - name: Query dependencies
         run: |

---FILE: .github/workflows/cmdstan-tarball-check.yaml---
@@ -40,12 +40,12 @@ jobs:
           sudo apt-get install -y libcurl4-openssl-dev || true
           sudo apt-get install -y openmpi-bin openmpi-common libopenmpi-dev || true
 
-      - uses: r-lib/actions/setup-r@v2.2.6
+      - uses: r-lib/actions/setup-r@v2.2.8
         with:
           r-version: ${{ matrix.config.r }}
           rtools-version: ${{ matrix.config.rtools }}
 
-      - uses: r-lib/actions/setup-pandoc@v2.2.6
+      - uses: r-lib/actions/setup-pandoc@v2.2.8
 
       - name: Query dependencies
         run: |",False,False,Rendering / Conversion,3
stan-dev,cmdstanr,a2ef3b9a7fa10ad3b207799f3ad8916eb727ce83,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-08-26T17:09:20Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-08-26T17:09:20Z,Path check error,.github/workflows/Test-coverage.yaml;R/utils.R,False,True,True,False,1,6,7,"---FILE: .github/workflows/Test-coverage.yaml---
@@ -59,7 +59,7 @@ jobs:
       - name: Install dependencies
         run: |
           install.packages(c(""remotes"", ""curl""), dependencies = TRUE)
-          remotes::install_local(path = ""."")
+          remotes::install_local(path = ""."", INSTALL_opts = ""--no-test-load"")
           remotes::install_deps(dependencies = TRUE)
           remotes::install_cran(""covr"")
           remotes::install_cran(""gridExtra"")

---FILE: R/utils.R---
@@ -636,11 +636,6 @@ check_file_exists <- function(files, access = NULL, ...) {
   wsl_user <- gsub(""\n"", """", wsl_user, fixed = TRUE)
 
   path_metadata <- grep(wsl_user, path_metadata, value = TRUE)
-  if (is_dir) {
-    if (any(substr(path_metadata, 1, 1) != ""d"")) {
-      return(paste0(""Provided path: "", path, "" is not a directory!""))
-    }
-  }
 
   if (!is.null(access)) {
     path_permissions <- strsplit(path_metadata, "" "", fixed = TRUE)[[1]][1]",True,False,Implementation / Logic,6
stan-dev,cmdstanr,f3ec3cce9011d729fbd4594450efc951e7117b13,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-08-26T13:46:37Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-08-26T13:46:37Z,Fix access permissions check under root,R/utils.R,False,True,True,False,9,3,12,"---FILE: R/utils.R---
@@ -627,16 +627,22 @@ check_file_exists <- function(files, access = NULL, ...) {
 
   path_metadata <- strsplit(path_check$stdout, split = ""\n"",
                             fixed = TRUE)[[1]]
-  path_metadata <- grep(""total"", path_metadata, invert = TRUE, value = TRUE)
-  path_metadata <- grep(""root"", path_metadata, invert = TRUE, value = TRUE)[1]
+
+  wsl_user <- processx::run(
+    command = ""wsl"",
+    args = c(""echo"", ""$USER""),
+    error_on_status = FALSE
+  )$stdout
+  wsl_user <- gsub(""\n"", """", wsl_user, fixed = TRUE)
+
+  path_metadata <- grep(wsl_user, path_metadata, invert = TRUE, value = TRUE)
   if (is_dir && substr(path_metadata, 1, 1) != ""d"") {
     return(paste0(""Provided path: "", path, "" is not a directory!""))
   }
 
   if (!is.null(access)) {
     path_permissions <- strsplit(path_metadata, "" "", fixed = TRUE)[[1]][1]
     if (!grepl(access, path_permissions)) {
-      message(path_permissions)
       name <- ifelse(is_dir, ""directory"", ""file"")
       return(paste0(""Specified "", name, "": "", path,
                     "" does not have access permission "", access))",True,False,Implementation / Logic,6
stan-dev,cmdstanr,277c4d8445a0b414f1d0f6b7b1c02c267b4c7cda,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-08-25T08:29:27Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-08-25T08:29:27Z,Fix non-windows path settings,R/path.R,False,True,True,False,9,8,17,"---FILE: R/path.R---
@@ -148,10 +148,10 @@ cmdstan_default_path <- function(old = FALSE, dir = NULL) {
     wsl_installs_path <- cmdstan_default_install_path(old)
     Sys.unsetenv(""CMDSTANR_USE_WSL"")
   }
-  if (dir.exists(installs_path) || dir.exists(wsl_installs_path)) {
+  if (dir.exists(installs_path) || !is.null(wsl_installs_path)) {
     latest_cmdstan <- ifelse(dir.exists(installs_path),
                              .latest_cmdstan_installed(installs_path), """")
-    latest_wsl_cmdstan <- ifelse(dir.exists(wsl_installs_path),
+    latest_wsl_cmdstan <- ifelse(!is.null(wsl_installs_path),
                                  .latest_cmdstan_installed(wsl_installs_path), """")
     if (latest_wsl_cmdstan >= latest_cmdstan) {
       return(file.path(wsl_installs_path, latest_wsl_cmdstan))
@@ -172,14 +172,15 @@ cmdstan_default_path <- function(old = FALSE, dir = NULL) {
     file.rename(old_path, new_path)
     cmdstan_installs <- list.dirs(path = installs_path, recursive = FALSE, full.names = FALSE)
   }
+  latest_cmdstan <- """"
   if (length(cmdstan_installs) > 0) {
     cmdstan_installs <- grep(""^cmdstan-"", cmdstan_installs, value = TRUE)
-    latest_cmdstan <- sort(cmdstan_installs, decreasing = TRUE)[1]
-  }
-  if (is_release_candidate(latest_cmdstan)) {
-    non_rc_path <- strsplit(latest_cmdstan, ""-rc"")[[1]][1]
-    if (dir.exists(file.path(installs_path, non_rc_path))) {
-      latest_cmdstan <- non_rc_path
+    latest_cmdstan <- sort(cmdstan_installs, decreasing = TRUE)
+    if (is_release_candidate(latest_cmdstan)) {
+      non_rc_path <- strsplit(latest_cmdstan, ""-rc"")[[1]][1]
+      if (dir.exists(file.path(installs_path, non_rc_path))) {
+        latest_cmdstan <- non_rc_path
+      }
     }
   }
   latest_cmdstan",True,False,Implementation / Logic,6
stan-dev,cmdstanr,c6dc3591ee78ae3ee73c628c17baae44cb08ad3e,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-08-25T06:15:15Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-08-25T06:15:30Z,Resolve path issues,R/args.R;R/csv.R;R/fit.R;R/install.R;R/model.R;R/utils.R;tests/testthat/test-install.R;tests/testthat/test-model-output_dir.R;tests/testthat/test-path.R,False,True,True,False,49,30,79,"---FILE: R/args.R---
@@ -53,7 +53,9 @@ CmdStanArgs <- R6::R6Class(
       self$save_latent_dynamics <- save_latent_dynamics
       self$using_tempdir <- is.null(output_dir)
       if (os_is_wsl()) {
-        self$output_dir <- file.path(wsl_dir_prefix(), wsl_tempdir())
+        self$output_dir <- ifelse(is.null(output_dir),
+                                  file.path(wsl_dir_prefix(), wsl_tempdir()),
+                                  wsl_safe_path(output_dir))
       } else {
         if (getRversion() < ""3.5.0"") {
           self$output_dir <- output_dir %||% tempdir()
@@ -543,7 +545,7 @@ validate_cmdstan_args <- function(self) {
     self$refresh <- as.integer(self$refresh)
   }
   if (!is.null(self$data_file)) {
-    checkmate::assert_file_exists(self$data_file, access = ""r"")
+    assert_file_exists(self$data_file, access = ""r"")
   }
   num_procs <- length(self$proc_ids)
   validate_init(self$init, num_procs)
@@ -893,7 +895,7 @@ validate_init <- function(init, num_procs) {
            ""length 1 or number of chains."",
            call. = FALSE)
     }
-    checkmate::assert_file_exists(init, access = ""r"")
+    assert_file_exists(init, access = ""r"")
   }
 
   invisible(TRUE)
@@ -981,7 +983,7 @@ validate_metric_file <- function(metric_file, num_procs) {
     return(invisible(TRUE))
   }
 
-  checkmate::assert_file_exists(metric_file, access = ""r"")
+  assert_file_exists(metric_file, access = ""r"")
 
   if (length(metric_file) != 1 && length(metric_file) != num_procs) {
     stop(length(metric_file), "" metric(s) provided. Must provide "",

---FILE: R/csv.R---
@@ -237,7 +237,7 @@ read_cmdstan_csv <- function(files,
       fread_cmd <- paste0(
         grep_path_quotes,
         "" -v \""^#\"" --color=never \"""",
-        output_file,
+        wsl_safe_path(output_file, revert = TRUE),
         ""\""""
       )
     } else {
@@ -579,7 +579,7 @@ read_csv_metadata <- function(csv_file) {
     fread_cmd <- paste0(
       grep_path_quotes,
       "" \""^[#a-zA-Z]\"" --color=never \"""",
-      csv_file,
+      wsl_safe_path(csv_file, revert = TRUE),
       ""\""""
     )
   } else {

---FILE: R/fit.R---
@@ -12,6 +12,8 @@ CmdStanFit <- R6::R6Class(
     initialize = function(runset) {
       checkmate::assert_r6(runset, classes = ""CmdStanRun"")
       self$runset <- runset
+      self$runset$args$output_dir <- wsl_safe_path(self$runset$args$output_dir,
+                                                    revert = TRUE)
       invisible(self)
     },
     num_procs = function() {

---FILE: R/install.R---
@@ -114,7 +114,7 @@ install_cmdstan <- function(dir = NULL,
     }
   } else {
     dir <- repair_path(dir)
-    checkmate::assert_directory_exists(dir, access = ""rwx"")
+    assert_dir_exists(dir, access = ""rwx"")
   }
   if (!is.null(version)) {
     if (!is.null(release_url)) {
@@ -168,6 +168,7 @@ install_cmdstan <- function(dir = NULL,
   if (os_is_wsl()) {
     wsl_tar_gz_file <- gsub(paste0(""//wsl$/"", wsl_distro_name()), """",
                             dest_file, fixed = TRUE)
+    wsl_tar_gz_file <- wsl_safe_path(wsl_tar_gz_file)
     untar_rc <- processx::run(
       command = ""wsl"",
       args = c(""tar"", ""-xf"", wsl_tar_gz_file, ""-C"",

---FILE: R/model.R---
@@ -225,7 +225,7 @@ CmdStanModel <- R6::R6Class(
       args <- list(...)
       private$dir_ <- args$dir
       if (!is.null(stan_file)) {
-        checkmate::assert_file_exists(stan_file, access = ""r"", extension = ""stan"")
+        assert_file_exists(stan_file, access = ""r"", extension = ""stan"")
         checkmate::assert_flag(compile)
         private$stan_file_ <- absolute_path(stan_file)
         private$stan_code_ <- readLines(stan_file)
@@ -246,7 +246,7 @@ CmdStanModel <- R6::R6Class(
         ext <- if (os_is_windows() && !os_is_wsl()) ""exe"" else """"
         private$exe_file_ <- repair_path(absolute_path(exe_file))
         if (is.null(stan_file)) {
-          checkmate::assert_file_exists(private$exe_file_, access = ""r"", extension = ext)
+          assert_file_exists(private$exe_file_, access = ""r"", extension = ext)
           private$model_name_ <- sub("" "", ""_"", strip_ext(basename(private$exe_file_)))
         }
       }
@@ -313,7 +313,7 @@ CmdStanModel <- R6::R6Class(
       if (is.null(dir)) {
         dir <- dirname(private$stan_file_)
       }
-      checkmate::assert_directory_exists(dir, access = ""r"")
+      assert_dir_exists(dir, access = ""r"")
       new_hpp_loc <- file.path(dir, paste0(strip_ext(basename(private$stan_file_)), "".hpp""))
       file.copy(self$hpp_file(), new_hpp_loc, overwrite = TRUE)
       file.remove(self$hpp_file())
@@ -455,7 +455,7 @@ compile <- function(quiet = TRUE,
   }
   if (!is.null(dir)) {
     dir <- repair_path(dir)
-    checkmate::assert_directory_exists(dir, access = ""rw"")
+    assert_dir_exists(dir, access = ""rw"")
     if (length(self$exe_file()) != 0) {
       private$exe_file_ <- file.path(dir, basename(self$exe_file()))
     }
@@ -608,6 +608,12 @@ compile <- function(quiet = TRUE,
     file.remove(exe)
   }
   file.copy(tmp_exe, exe, overwrite = TRUE)
+  if (os_is_wsl()) {
+    res <- processx::run(
+      command = ""wsl"",
+      args = c(""chmod"", ""+x"", wsl_safe_path(exe))
+    )
+  }
   private$exe_file_ <- exe
   private$cpp_options_ <- cpp_options
   private$precompile_cpp_options_ <- NULL
@@ -1766,7 +1772,7 @@ cpp_options_to_compile_flags <- function(cpp_options) {
 include_paths_stanc3_args <- function(include_paths = NULL) {
   stancflags <- NULL
   if (!is.null(include_paths)) {
-    checkmate::assert_directory_exists(include_paths, access = ""r"")
+    assert_dir_exists(include_paths, access = ""r"")
     include_paths <- sapply(absolute_path(include_paths), wsl_safe_path)
     paths_w_space <- grep("" "", include_paths)
     include_paths[paths_w_space] <- paste0(""'"", include_paths[paths_w_space], ""'"")

---FILE: R/utils.R---
@@ -168,7 +168,7 @@ copy_temp_files <-
            timestamp = TRUE,
            random = TRUE,
            ext = "".csv"") {
-    checkmate::assert_directory_exists(new_dir, access = ""w"")
+    assert_dir_exists(new_dir, access = ""w"")
     destinations <- generate_file_names(
       basename = new_basename,
       ext = ext,
@@ -579,7 +579,12 @@ check_dir_exists <- function(dir, access = NULL) {
     if (!checkmate::qtest(dir, ""S+"")) {
       return(""No directory provided."")
     }
-    .wsl_check_exists(dir, is_dir = TRUE, access = access)
+    checks <- sapply(dir, .wsl_check_exists, is_dir = TRUE, access = access)
+    if (any(as.character(checks) != ""TRUE"")) {
+      grep(""TRUE"", checks, value = TRUE, invert = TRUE)[1]
+    } else {
+      TRUE
+    }
   } else {
     checkmate::checkDirectoryExists(dir, access = access)
   }
@@ -609,17 +614,17 @@ check_file_exists <- function(files, access = NULL, ...) {
   )
 
   if (path_check$status != 0) {
+    path <- gsub(""^./"", """", path)
     err <- ifelse(is_dir,
-                  paste0(""Directory '"", path, ""' does not exist.""),
+                  paste0(""Directory '"", path, ""' does not exist""),
                   paste0(""File does not exist: '"", path, ""'""))
     return(err)
   }
 
   path_metadata <- strsplit(path_check$stdout, split = ""\n"",
                             fixed = TRUE)[[1]]
   path_metadata <- grep(""total"", path_metadata, invert = TRUE, value = TRUE)
-  path_metadata <- grep(""root"", path_metadata, invert = TRUE, value = TRUE)
-
+  path_metadata <- grep(""root"", path_metadata, invert = TRUE, value = TRUE)[1]
   if (is_dir && substr(path_metadata, 1, 1) != ""d"") {
     return(paste0(""Provided path: "", path, "" is not a directory!""))
   }

---FILE: tests/testthat/test-install.R---
@@ -1,7 +1,5 @@
 context(""install"")
 
-wsl_prefix <- ifelse(os_is_wsl(), ""wsl-"", """")
-
 cmdstan_test_tarball_url <- Sys.getenv(""CMDSTAN_TEST_TARBALL_URL"")
 if (!nzchar(cmdstan_test_tarball_url)) {
   cmdstan_test_tarball_url <- NULL
@@ -28,7 +26,7 @@ test_that(""install_cmdstan() successfully installs cmdstan"", {
 
 test_that(""install_cmdstan() errors if installation already exists"", {
   install_dir <- cmdstan_default_install_path()
-  dir <- file.path(install_dir, paste0(wsl_prefix, ""cmdstan-2.23.0""))
+  dir <- file.path(install_dir, ""cmdstan-2.23.0"")
   if (!dir.exists(dir)) {
     dir.create(dir)
   }
@@ -47,7 +45,7 @@ test_that(""install_cmdstan() errors if it times out"", {
     dir <- tempdir(check = TRUE)
   }
   ver <- latest_released_version()
-  dir_exists <- dir.exists(file.path(dir, paste0(wsl_prefix, ""cmdstan-"",ver)))
+  dir_exists <- dir.exists(file.path(dir, paste0(""cmdstan-"",ver)))
   # with quiet=TRUE
   expect_warning(
     expect_message(
@@ -59,7 +57,7 @@ test_that(""install_cmdstan() errors if it times out"", {
     ""increasing the value of the 'timeout' argument and running again with 'quiet=FALSE'"",
     fixed = TRUE
   )
-  dir_exists <- dir.exists(file.path(dir, paste0(wsl_prefix,""cmdstan-"",ver)))
+  dir_exists <- dir.exists(file.path(dir, paste0(""cmdstan-"",ver)))
   # with quiet=FALSE
   expect_warning(
     expect_message(
@@ -125,7 +123,7 @@ test_that(""install_cmdstan() works with version and release_url"", {
     ""version and release_url shouldn't both be specified"",
     fixed = TRUE
   )
-  expect_true(dir.exists(file.path(dir, paste0(wsl_prefix, ""cmdstan-2.27.0""))))
+  expect_true(dir.exists(file.path(dir, ""cmdstan-2.27.0"")))
   set_cmdstan_path(cmdstan_default_path())
 })
 
@@ -199,3 +197,4 @@ test_that(""github_download_url constructs correct url"", {
     ""https://github.com/stan-dev/cmdstan/releases/download/vFOO/cmdstan-FOO.tar.gz""
   )
 })
+

---FILE: tests/testthat/test-model-output_dir.R---
@@ -17,14 +17,16 @@ test_that(""all fitting methods work with output_dir"", {
       dir.create(method_dir)
     }
 
-    # no output_dir means should use tempdir
-    fit <- testing_fit(""bernoulli"", method = method, seed = 123)
-    expect_equal(fit$runset$args$output_dir, absolute_path(tempdir()))
-
+    if (!os_is_wsl()) {
+      # no output_dir means should use tempdir
+      fit <- testing_fit(""bernoulli"", method = method, seed = 123)
+      expect_equal(fit$runset$args$output_dir, absolute_path(tempdir()))
+    }
     # specifying output_dir
     fit <- testing_fit(""bernoulli"", method = method, seed = 123,
                         output_dir = method_dir)
-    expect_equal(fit$runset$args$output_dir, absolute_path(method_dir))
+    expect_equal(normalizePath(fit$runset$args$output_dir),
+                 normalizePath(method_dir))
     expect_equal(length(list.files(method_dir)), fit$num_procs())
 
 
@@ -80,6 +82,7 @@ test_that(""output_dir works with trailing /"", {
     seed = 123,
     output_dir = paste0(test_dir,""/"")
   )
-  expect_equal(fit$runset$args$output_dir, absolute_path(test_dir))
+  expect_equal(normalizePath(fit$runset$args$output_dir),
+               normalizePath(test_dir))
   expect_equal(length(list.files(test_dir)), fit$num_procs())
 })

---FILE: tests/testthat/test-path.R---
@@ -10,7 +10,8 @@ unset_cmdstan_path()
 test_that(""Setting path works and confirms with message"", {
   expect_message(
     set_cmdstan_path(PATH),
-    paste(""CmdStan path set to:"", PATH)
+    paste(""CmdStan path set to:"", PATH),
+    fixed = TRUE
   )
   expect_equal(.cmdstanr$PATH, PATH)
 })",True,False,Implementation / Logic,6
stan-dev,cmdstanr,f5b89db461ef6a5a5921df0472a14de9302009f4,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-08-25T02:35:25Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-08-25T02:35:25Z,Fix file validation,R/args.R;R/csv.R;R/utils.R;tests/testthat/testthat-problems.rds,False,True,True,False,66,17,83,"---FILE: R/args.R---
@@ -524,20 +524,7 @@ DiagnoseArgs <- R6::R6Class(
 #' @return `TRUE` invisibly unless an error is thrown.
 validate_cmdstan_args <- function(self) {
   validate_exe_file(self$exe_file)
-
-  if (os_is_wsl()) {
-    dir_check <- processx::run(
-      command = ""wsl"",
-      args = c(""cd"", wsl_safe_path(self$output_dir)),
-      error_on_status = TRUE
-    )
-    if (dir_check$status == 1) {
-      stop(""Output directory: "", self$output_dir, "" does not exist!"",
-           call. = FALSE)
-    }
-  } else {
-    checkmate::assert_directory_exists(self$output_dir, access = ""rw"")
-  }
+  assert_dir_exists(self$output_dir, access = ""rw"")
 
   # at least 1 run id (chain id)
   checkmate::assert_integerish(self$proc_ids,
@@ -709,7 +696,7 @@ validate_optimize_args <- function(self) {
 #' @return `TRUE` invisibly unless an error is thrown.
 validate_generate_quantities_args <- function(self) {
   if (!is.null(self$fitted_params)) {
-    checkmate::assert_file_exists(self$fitted_params, access = ""r"")
+    assert_file_exists(self$fitted_params, access = ""r"")
   }
 
   invisible(TRUE)

---FILE: R/csv.R---
@@ -125,7 +125,7 @@ read_cmdstan_csv <- function(files,
                              sampler_diagnostics = NULL,
                              format = getOption(""cmdstanr_draws_format"", NULL)) {
   format <- assert_valid_draws_format(format)
-  #checkmate::assert_file_exists(files, access = ""r"", extension = ""csv"")
+  assert_file_exists(files, access = ""r"", extension = ""csv"")
   metadata <- NULL
   warmup_draws <- list()
   draws <- list()
@@ -556,7 +556,7 @@ for (method in unavailable_methods_CmdStanFit_CSV) {
 #'   mass matrix (or its diagonal depending on the metric).
 #'
 read_csv_metadata <- function(csv_file) {
-  #checkmate::assert_file_exists(csv_file, access = ""r"", extension = ""csv"")
+  assert_file_exists(csv_file, access = ""r"", extension = ""csv"")
   inv_metric_next <- FALSE
   csv_file_info <- list()
   csv_file_info$inv_metric <- NULL

---FILE: R/utils.R---
@@ -573,3 +573,65 @@ wsl_tempdir <- function() {
                         args = c(""mktemp"", ""-d""))$stdout
   gsub(""\n"", """", dir, fixed = TRUE)
 }
+
+check_dir_exists <- function(dir, access = NULL) {
+  if (os_is_wsl()) {
+    if (!checkmate::qtest(dir, ""S+"")) {
+      return(""No directory provided."")
+    }
+    .wsl_check_exists(dir, is_dir = TRUE, access = access)
+  } else {
+    checkmate::checkDirectoryExists(dir, access = access)
+  }
+}
+
+check_file_exists <- function(files, access = NULL, ...) {
+  if (os_is_wsl()) {
+    if (!checkmate::qtest(files, ""S+"")) {
+      return(""No file provided."")
+    }
+    checks <- sapply(files, .wsl_check_exists, is_dir = FALSE, access = access)
+    if (any(as.character(checks) != ""TRUE"")) {
+      grep(""TRUE"", checks, value = TRUE, invert = TRUE)[1]
+    } else {
+      TRUE
+    }
+  } else {
+    checkmate::checkFileExists(files, access = access, ...)
+  }
+}
+
+.wsl_check_exists <- function(path, is_dir = TRUE, access = NULL) {
+  path_check <- processx::run(
+    command = ""wsl"",
+    args = c(""ls"", ""-la"", wsl_safe_path(path)),
+    error_on_status = FALSE
+  )
+
+  if (path_check$status != 0) {
+    err <- ifelse(is_dir,
+                  paste0(""Directory '"", path, ""' does not exist.""),
+                  paste0(""File does not exist: '"", path, ""'""))
+    return(err)
+  }
+
+  path_metadata <- strsplit(path_check$stdout, split = ""\n"",
+                            fixed = TRUE)[[1]]
+  path_metadata <- grep(""total"", path_metadata, invert = TRUE, value = TRUE)
+  path_metadata <- grep(""root"", path_metadata, invert = TRUE, value = TRUE)
+
+  if (is_dir && substr(path_metadata, 1, 1) != ""d"") {
+    return(paste0(""Provided path: "", path, "" is not a directory!""))
+  }
+
+  if (!is.null(access)) {
+    path_permissions <- strsplit(path_metadata, "" "", fixed = TRUE)[[1]][1]
+    if (!grepl(access, path_permissions)) {
+      return(paste0(""Specified "", "": "", path, "" does not have access permission ""))
+    }
+  }
+  TRUE
+}
+
+assert_dir_exists <- checkmate::makeAssertionFunction(check_dir_exists)
+assert_file_exists <- checkmate::makeAssertionFunction(check_file_exists)",True,False,File I/O and Export,6
stan-dev,cmdstanr,fb2b6876e3b984ee43577892587603185c8e90d2,dependabot[bot],49699333+dependabot[bot]@users.noreply.github.com,2022-08-22T18:31:30Z,GitHub,noreply@github.com,2022-08-22T18:31:30Z,"Bump r-lib/actions from 2.2.5 to 2.2.6

Bumps [r-lib/actions](https://github.com/r-lib/actions) from 2.2.5 to 2.2.6.
- [Release notes](https://github.com/r-lib/actions/releases)
- [Commits](https://github.com/r-lib/actions/compare/v2.2.5...v2.2.6)

---
updated-dependencies:
- dependency-name: r-lib/actions
  dependency-type: direct:production
  update-type: version-update:semver-patch
...

Signed-off-by: dependabot[bot] <support@github.com>",.github/workflows/R-CMD-check-wsl.yaml;.github/workflows/R-CMD-check.yaml;.github/workflows/Test-coverage.yaml;.github/workflows/cmdstan-tarball-check.yaml,False,False,False,False,10,10,20,"---FILE: .github/workflows/R-CMD-check-wsl.yaml---
@@ -37,11 +37,11 @@ jobs:
 
       - uses: actions/checkout@v3
 
-      - uses: r-lib/actions/setup-r@v2.2.5
+      - uses: r-lib/actions/setup-r@v2.2.6
         with:
           r-version: 'release'
           rtools-version: '42'
-      - uses: r-lib/actions/setup-pandoc@v2.2.5
+      - uses: r-lib/actions/setup-pandoc@v2.2.6
 
       - name: Query dependencies
         run: |

---FILE: .github/workflows/R-CMD-check.yaml---
@@ -56,11 +56,11 @@ jobs:
           sudo apt-get install -y libcurl4-openssl-dev || true
           sudo apt-get install -y openmpi-bin openmpi-common libopenmpi-dev || true
 
-      - uses: r-lib/actions/setup-r@v2.2.5
+      - uses: r-lib/actions/setup-r@v2.2.6
         with:
           r-version: ${{ matrix.config.r }}
           rtools-version: ${{ matrix.config.rtools }}
-      - uses: r-lib/actions/setup-pandoc@v2.2.5
+      - uses: r-lib/actions/setup-pandoc@v2.2.6
 
       - name: Query dependencies
         run: |

---FILE: .github/workflows/Test-coverage.yaml---
@@ -34,8 +34,8 @@ jobs:
         if: ""!startsWith(github.ref, 'refs/tags/') && github.ref != 'refs/heads/master'""
       - uses: actions/checkout@v3
 
-      - uses: r-lib/actions/setup-r@v2.2.5
-      - uses: r-lib/actions/setup-pandoc@v2.2.5
+      - uses: r-lib/actions/setup-r@v2.2.6
+      - uses: r-lib/actions/setup-pandoc@v2.2.6
 
       - name: Install Ubuntu dependencies
         run: |
@@ -85,12 +85,12 @@ jobs:
     steps:
       - uses: actions/checkout@v3
 
-      - uses: r-lib/actions/setup-r@v2.2.5
+      - uses: r-lib/actions/setup-r@v2.2.6
         with:
           r-version: 'release'
           rtools-version: '42'
 
-      - uses: r-lib/actions/setup-pandoc@v2.2.5
+      - uses: r-lib/actions/setup-pandoc@v2.2.6
 
       - name: Query dependencies
         run: |

---FILE: .github/workflows/cmdstan-tarball-check.yaml---
@@ -40,12 +40,12 @@ jobs:
           sudo apt-get install -y libcurl4-openssl-dev || true
           sudo apt-get install -y openmpi-bin openmpi-common libopenmpi-dev || true
 
-      - uses: r-lib/actions/setup-r@v2.2.5
+      - uses: r-lib/actions/setup-r@v2.2.6
         with:
           r-version: ${{ matrix.config.r }}
           rtools-version: ${{ matrix.config.rtools }}
 
-      - uses: r-lib/actions/setup-pandoc@v2.2.5
+      - uses: r-lib/actions/setup-pandoc@v2.2.6
 
       - name: Query dependencies
         run: |",False,False,Rendering / Conversion,3
stan-dev,cmdstanr,ed8ce4f1d4413a09163a64cb5c10f01afb609006,dependabot[bot],49699333+dependabot[bot]@users.noreply.github.com,2022-08-08T18:19:48Z,GitHub,noreply@github.com,2022-08-08T18:19:48Z,"Bump r-lib/actions from 2.2.4 to 2.2.5

Bumps [r-lib/actions](https://github.com/r-lib/actions) from 2.2.4 to 2.2.5.
- [Release notes](https://github.com/r-lib/actions/releases)
- [Commits](https://github.com/r-lib/actions/compare/v2.2.4...v2.2.5)

---
updated-dependencies:
- dependency-name: r-lib/actions
  dependency-type: direct:production
  update-type: version-update:semver-patch
...

Signed-off-by: dependabot[bot] <support@github.com>",.github/workflows/R-CMD-check-wsl.yaml;.github/workflows/R-CMD-check.yaml;.github/workflows/Test-coverage.yaml;.github/workflows/cmdstan-tarball-check.yaml,False,False,False,False,10,10,20,"---FILE: .github/workflows/R-CMD-check-wsl.yaml---
@@ -37,11 +37,11 @@ jobs:
 
       - uses: actions/checkout@v3
 
-      - uses: r-lib/actions/setup-r@v2.2.4
+      - uses: r-lib/actions/setup-r@v2.2.5
         with:
           r-version: 'release'
           rtools-version: '42'
-      - uses: r-lib/actions/setup-pandoc@v2.2.4
+      - uses: r-lib/actions/setup-pandoc@v2.2.5
 
       - name: Query dependencies
         run: |

---FILE: .github/workflows/R-CMD-check.yaml---
@@ -56,11 +56,11 @@ jobs:
           sudo apt-get install -y libcurl4-openssl-dev || true
           sudo apt-get install -y openmpi-bin openmpi-common libopenmpi-dev || true
 
-      - uses: r-lib/actions/setup-r@v2.2.4
+      - uses: r-lib/actions/setup-r@v2.2.5
         with:
           r-version: ${{ matrix.config.r }}
           rtools-version: ${{ matrix.config.rtools }}
-      - uses: r-lib/actions/setup-pandoc@v2.2.4
+      - uses: r-lib/actions/setup-pandoc@v2.2.5
 
       - name: Query dependencies
         run: |

---FILE: .github/workflows/Test-coverage.yaml---
@@ -34,8 +34,8 @@ jobs:
         if: ""!startsWith(github.ref, 'refs/tags/') && github.ref != 'refs/heads/master'""
       - uses: actions/checkout@v3
 
-      - uses: r-lib/actions/setup-r@v2.2.4
-      - uses: r-lib/actions/setup-pandoc@v2.2.4
+      - uses: r-lib/actions/setup-r@v2.2.5
+      - uses: r-lib/actions/setup-pandoc@v2.2.5
 
       - name: Install Ubuntu dependencies
         run: |
@@ -85,12 +85,12 @@ jobs:
     steps:
       - uses: actions/checkout@v3
 
-      - uses: r-lib/actions/setup-r@v2.2.4
+      - uses: r-lib/actions/setup-r@v2.2.5
         with:
           r-version: 'release'
           rtools-version: '42'
 
-      - uses: r-lib/actions/setup-pandoc@v2.2.4
+      - uses: r-lib/actions/setup-pandoc@v2.2.5
 
       - name: Query dependencies
         run: |

---FILE: .github/workflows/cmdstan-tarball-check.yaml---
@@ -40,12 +40,12 @@ jobs:
           sudo apt-get install -y libcurl4-openssl-dev || true
           sudo apt-get install -y openmpi-bin openmpi-common libopenmpi-dev || true
 
-      - uses: r-lib/actions/setup-r@v2.2.4
+      - uses: r-lib/actions/setup-r@v2.2.5
         with:
           r-version: ${{ matrix.config.r }}
           rtools-version: ${{ matrix.config.rtools }}
 
-      - uses: r-lib/actions/setup-pandoc@v2.2.4
+      - uses: r-lib/actions/setup-pandoc@v2.2.5
 
       - name: Query dependencies
         run: |",False,False,Rendering / Conversion,3
stan-dev,cmdstanr,71e0b2055733929257b68cb46bddc9b16725d953,dependabot[bot],49699333+dependabot[bot]@users.noreply.github.com,2022-08-01T19:04:06Z,GitHub,noreply@github.com,2022-08-01T19:04:06Z,"Bump r-lib/actions from 2.2.3 to 2.2.4

Bumps [r-lib/actions](https://github.com/r-lib/actions) from 2.2.3 to 2.2.4.
- [Release notes](https://github.com/r-lib/actions/releases)
- [Commits](https://github.com/r-lib/actions/compare/v2.2.3...v2.2.4)

---
updated-dependencies:
- dependency-name: r-lib/actions
  dependency-type: direct:production
  update-type: version-update:semver-patch
...

Signed-off-by: dependabot[bot] <support@github.com>",.github/workflows/R-CMD-check-wsl.yaml;.github/workflows/R-CMD-check.yaml;.github/workflows/Test-coverage.yaml;.github/workflows/cmdstan-tarball-check.yaml,False,False,False,False,10,10,20,"---FILE: .github/workflows/R-CMD-check-wsl.yaml---
@@ -37,11 +37,11 @@ jobs:
 
       - uses: actions/checkout@v3
 
-      - uses: r-lib/actions/setup-r@v2.2.3
+      - uses: r-lib/actions/setup-r@v2.2.4
         with:
           r-version: 'release'
           rtools-version: '42'
-      - uses: r-lib/actions/setup-pandoc@v1
+      - uses: r-lib/actions/setup-pandoc@v2.2.4
 
       - name: Query dependencies
         run: |

---FILE: .github/workflows/R-CMD-check.yaml---
@@ -56,11 +56,11 @@ jobs:
           sudo apt-get install -y libcurl4-openssl-dev || true
           sudo apt-get install -y openmpi-bin openmpi-common libopenmpi-dev || true
 
-      - uses: r-lib/actions/setup-r@v2.2.3
+      - uses: r-lib/actions/setup-r@v2.2.4
         with:
           r-version: ${{ matrix.config.r }}
           rtools-version: ${{ matrix.config.rtools }}
-      - uses: r-lib/actions/setup-pandoc@v1
+      - uses: r-lib/actions/setup-pandoc@v2.2.4
 
       - name: Query dependencies
         run: |

---FILE: .github/workflows/Test-coverage.yaml---
@@ -34,8 +34,8 @@ jobs:
         if: ""!startsWith(github.ref, 'refs/tags/') && github.ref != 'refs/heads/master'""
       - uses: actions/checkout@v3
 
-      - uses: r-lib/actions/setup-r@v2
-      - uses: r-lib/actions/setup-pandoc@v1
+      - uses: r-lib/actions/setup-r@v2.2.4
+      - uses: r-lib/actions/setup-pandoc@v2.2.4
 
       - name: Install Ubuntu dependencies
         run: |
@@ -85,12 +85,12 @@ jobs:
     steps:
       - uses: actions/checkout@v3
 
-      - uses: r-lib/actions/setup-r@v2.2.3
+      - uses: r-lib/actions/setup-r@v2.2.4
         with:
           r-version: 'release'
           rtools-version: '42'
 
-      - uses: r-lib/actions/setup-pandoc@v1
+      - uses: r-lib/actions/setup-pandoc@v2.2.4
 
       - name: Query dependencies
         run: |

---FILE: .github/workflows/cmdstan-tarball-check.yaml---
@@ -40,12 +40,12 @@ jobs:
           sudo apt-get install -y libcurl4-openssl-dev || true
           sudo apt-get install -y openmpi-bin openmpi-common libopenmpi-dev || true
 
-      - uses: r-lib/actions/setup-r@v2.2.3
+      - uses: r-lib/actions/setup-r@v2.2.4
         with:
           r-version: ${{ matrix.config.r }}
           rtools-version: ${{ matrix.config.rtools }}
 
-      - uses: r-lib/actions/setup-pandoc@v1
+      - uses: r-lib/actions/setup-pandoc@v2.2.4
 
       - name: Query dependencies
         run: |",False,False,Rendering / Conversion,3
stan-dev,cmdstanr,c87879ad32b7acae136214ffca1bc0bad8433240,Malte Kyhos,mkyhos@protonmail.com,2022-07-28T22:58:25Z,Malte Kyhos,mkyhos@protonmail.com,2022-07-28T22:58:25Z,Initial fix,R/model.R;tests/testthat/test-model-variables.R,False,True,True,False,44,1,45,"---FILE: R/model.R---
@@ -653,7 +653,17 @@ variables <- function() {
   }
   assert_stan_file_exists(self$stan_file())
   if (is.null(private$variables_) && file.exists(self$stan_file())) {
-    private$variables_ <- model_variables(self$stan_file(), self$include_paths(), allow_undefined = private$using_user_header_)
+    private$variables_ <- model_variables(
+      stan_file = self$stan_file(),
+      include_paths = {
+        if (length(self$exe_file()) > 0 && file.exists(self$exe_file())) {
+          self$include_paths()
+        } else {
+          private$precompile_include_paths_
+        }
+      },
+      allow_undefined = private$using_user_header_
+    )
   }
   private$variables_
 }

---FILE: tests/testthat/test-model-variables.R---
@@ -108,3 +108,36 @@ test_that(""$variables() errors on no stan_file"", {
     fixed = TRUE
   )
 })
+
+test_that(""$variables() works with #includes, both pre and post compilation."", {
+  
+  data_code <- ""
+    data {
+      int N;
+    }
+  ""
+  model_code <- ""
+    #include data.stan
+    parameters {
+      vector[N] y;
+    }
+    model {
+      y ~ std_normal();
+    }
+  ""
+
+  model_file <- write_stan_file(code = model_code)
+  data_file <- write_stan_file(code = data_code, basename = ""data.stan"")
+
+  mod <- cmdstan_model(
+    stan_file = model_file,
+    include_paths = dirname(data_file),
+    compile = FALSE
+  )
+
+  vars_pre <- mod$variables()
+  mod$compile()
+  vars_post <- mod$variables()
+
+  expect_equal(vars_pre, vars_post)
+})",True,False,Implementation / Logic,6
stan-dev,cmdstanr,b2bc04e12b66bf41a3b6945b65665ff4fe406560,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-07-16T20:23:15Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-07-16T20:23:15Z,Fix short-path handling,.github/workflows/R-CMD-check.yaml;R/utils.R,False,True,True,False,4,1,5,"---FILE: .github/workflows/R-CMD-check.yaml---
@@ -7,7 +7,7 @@ name: Unit tests
 'on':
   push:
     branches:
-      - wsl-support
+      - master
   pull_request:
     branches:
       - master

---FILE: R/utils.R---
@@ -169,12 +169,15 @@ wsl_safe_path <- function(path = NULL, revert = FALSE) {
   } else {
     path_already_safe <- grepl(""^/mnt/"", path)
     if (os_is_wsl() && !isTRUE(path_already_safe) && !is.na(path)) {
+      base_file <- basename(path)
+      path <- dirname(path)
       abs_path <- repair_path(utils::shortPathName(path))
       drive_letter <- tolower(strtrim(abs_path, 1))
       path <- gsub(paste0(drive_letter, "":""),
                   paste0(""/mnt/"", drive_letter),
                   abs_path,
                   ignore.case = TRUE)
+      path <- paste0(path, ""/"", base_file)
     }
   }
   path",True,False,Implementation / Logic,6
stan-dev,cmdstanr,c652398a4839053211426e9def336009addbe2be,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-07-16T14:39:58Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-07-16T14:39:58Z,Fix getting exe info,R/model.R,False,True,True,False,1,1,2,"---FILE: R/model.R---
@@ -1814,7 +1814,7 @@ model_compile_info <- function(exe_file) {
         tbb_path()
       ),
       ret <- wsl_compatible_run(
-        command = exe_file,
+        command = wsl_path_compat(exe_file),
         args = ""info"",
         error_on_status = FALSE
       )",True,False,Implementation / Logic,3
stan-dev,cmdstanr,d9ebb71f3b8ddc436039ed5c2f9c2c7f2fa8aa55,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-07-16T14:25:13Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-07-16T14:25:13Z,Test wsl gzip fix,.github/workflows/R-CMD-check-wsl.yaml,False,False,False,False,4,3,7,"---FILE: .github/workflows/R-CMD-check-wsl.yaml---
@@ -63,11 +63,12 @@ jobs:
             distribution: Ubuntu-22.04
             use-cache: 'true'
             set-as-default: 'true'
-      - name: WSL gzip version fix
+      - name: Install WSL Dependencies
         run: |
+          # Bugfix for current gzip under WSLv1:
+          # https://github.com/microsoft/WSL/issues/8219#issuecomment-1110508016
+          echo -en '\x10' | sudo dd of=/usr/bin/gzip count=1 bs=1 conv=notrunc seek=$((0x189))
           sudo apt-get update
-          sudo apt-get install -y gzip=1.10-4ubuntu1
-          sudo apt-mark hold gzip
           sudo apt-get install -y build-essential libopenmpi-dev
         shell: wsl-bash {0}
 ",False,False,Data / Input Handling,3
stan-dev,cmdstanr,a3a1c887e1236f76c42f7fdf1d7c50fc78c38e49,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-07-16T13:54:39Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-07-16T13:54:39Z,Test wsl gzip fix,.github/workflows/R-CMD-check-wsl.yaml,False,False,False,False,5,3,8,"---FILE: .github/workflows/R-CMD-check-wsl.yaml---
@@ -63,9 +63,11 @@ jobs:
             distribution: Ubuntu-22.04
             use-cache: 'true'
             set-as-default: 'true'
-            additional-packages: |
-              build-essential
-              libopenmpi-dev
+      - name: WSL gzip version fix
+        run: |
+          sudo apt-get install -y gzip=1.10-4ubuntu1
+          sudo apt-mark hold gzip
+          sudo apt-get install -y build-essential libopenmpi-dev
 
       - name: Install cmdstan
         run: |",False,False,Data / Input Handling,3
stan-dev,cmdstanr,02ff40cb88daac84959286a5e692721ed34b6756,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-07-15T18:20:35Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-07-15T18:20:35Z,Second pass of fixes,R/args.R;tests/testthat/test-install.R;tests/testthat/test-model-sample.R,False,True,True,False,20,15,35,"---FILE: R/args.R---
@@ -1019,14 +1019,15 @@ available_metrics <- function() {
 #' @param idx Chain id (only applicable for MCMC).
 compose_arg <- function(self, arg_name, cmdstan_arg_name = NULL, idx = NULL) {
   val <- self[[arg_name]]
-  if (os_is_wsl() && (arg_name %in% c(""fitted_params"", ""metric_file""))) {
-    val <- sapply(val, wsl_path_compat)
-  }
   cmdstan_arg_name <- cmdstan_arg_name %||% arg_name
 
   if (is.null(val)) {
     return(NULL)
   }
+
+  if (os_is_wsl() && (arg_name %in% c(""fitted_params"", ""metric_file""))) {
+    val <- sapply(val, wsl_path_compat)
+  }
   if (!is.null(idx) && length(val) >= idx) {
     val <- val[idx]
   }

---FILE: tests/testthat/test-install.R---
@@ -1,5 +1,7 @@
 context(""install"")
 
+wsl_prefix <- ifelse(os_is_wsl(), ""wsl-"", """")
+
 cmdstan_test_tarball_url <- Sys.getenv(""CMDSTAN_TEST_TARBALL_URL"")
 if (!nzchar(cmdstan_test_tarball_url)) {
   cmdstan_test_tarball_url <- NULL
@@ -25,13 +27,13 @@ test_that(""install_cmdstan() successfully installs cmdstan"", {
 
 test_that(""install_cmdstan() errors if installation already exists"", {
   install_dir <- cmdstan_default_install_path()
-  dir <- file.path(install_dir, ""cmdstan-2.23.0"")
+  dir <- file.path(install_dir, paste0(wsl_prefix, ""cmdstan-2.23.0""))
   if (!dir.exists(dir)) {
     dir.create(dir)
   }
   expect_warning(
     install_cmdstan(dir = install_dir, overwrite = FALSE,
-                    version = ""2.23.0""),
+                    version = ""2.23.0"", wsl = os_is_wsl()),
     ""An installation already exists"",
     fixed = TRUE
   )
@@ -44,19 +46,19 @@ test_that(""install_cmdstan() errors if it times out"", {
     dir <- tempdir(check = TRUE)
   }
   ver <- latest_released_version()
-  dir_exists <- dir.exists(file.path(dir, paste0(""cmdstan-"",ver)))
+  dir_exists <- dir.exists(file.path(dir, paste0(wsl_prefix, ""cmdstan-"",ver)))
   # with quiet=TRUE
   expect_warning(
     expect_message(
       install_cmdstan(dir = dir, timeout = 1, quiet = TRUE, overwrite = dir_exists,
-                      release_url = cmdstan_test_tarball_url),
+                      release_url = cmdstan_test_tarball_url, wsl = os_is_wsl()),
       if (dir_exists) ""* Removing the existing installation"" else ""* * Installing CmdStan from https://github.com"",
       fixed = TRUE
     ),
     ""increasing the value of the 'timeout' argument and running again with 'quiet=FALSE'"",
     fixed = TRUE
   )
-  dir_exists <- dir.exists(file.path(dir, paste0(""cmdstan-"",ver)))
+  dir_exists <- dir.exists(file.path(dir, paste0(wsl_prefix,""cmdstan-"",ver)))
   # with quiet=FALSE
   expect_warning(
     expect_message(
@@ -72,15 +74,16 @@ test_that(""install_cmdstan() errors if it times out"", {
 
 test_that(""install_cmdstan() errors if invalid version or URL"", {
   expect_error(
-    install_cmdstan(version = ""2.23.2""),
+    install_cmdstan(version = ""2.23.2"", wsl = os_is_wsl()),
     ""Download of CmdStan failed. Please check if the supplied version number is valid.""
   )
   expect_error(
-    install_cmdstan(release_url = ""https://github.com/stan-dev/cmdstan/releases/download/v2.23.2/cmdstan-2.23.2.tar.gz""),
+    install_cmdstan(release_url = ""https://github.com/stan-dev/cmdstan/releases/download/v2.23.2/cmdstan-2.23.2.tar.gz"",
+                    wsl = os_is_wsl()),
     ""Download of CmdStan failed. Please check if the supplied release URL is valid.""
   )
   expect_error(
-    install_cmdstan(release_url = ""https://github.com/stan-dev/cmdstan/releases/tag/v2.24.0""),
+    install_cmdstan(release_url = ""https://github.com/stan-dev/cmdstan/releases/tag/v2.24.0"", wsl = os_is_wsl()),
     ""cmdstanr supports installing from .tar.gz archives only""
   )
 })
@@ -95,7 +98,8 @@ test_that(""install_cmdstan() works with version and release_url"", {
   expect_message(
     expect_output(
       install_cmdstan(dir = dir, overwrite = TRUE, cores = 4,
-                      release_url = ""https://github.com/stan-dev/cmdstan/releases/download/v2.26.1/cmdstan-2.26.1.tar.gz""),
+                      release_url = ""https://github.com/stan-dev/cmdstan/releases/download/v2.26.1/cmdstan-2.26.1.tar.gz"",
+                      wsl = os_is_wsl()),
       ""Compiling, linking C++ code"",
       fixed = TRUE
     ),

---FILE: tests/testthat/test-model-sample.R---
@@ -246,7 +246,7 @@ test_that(""print statements in transformed data work"", {
   }'
   ))
 
-  out <- capture.output(fit <- mod$sample(iter_warmup = 1, iter_sampling = 1, chains = 1))
+  out <- capture.output(fit <- mod$sample(iter_warmup = 1, iter_sampling = 3, chains = 1))
   expect_true(any(grepl(""*N = 2*"", out)))
 })
 
@@ -276,7 +276,7 @@ test_that(""seed works for multi chain sampling"", {
   f <- write_stan_file(m, basename = ""rngs.stan"")
   mod <- cmdstan_model(f)
   utils::capture.output(
-    fit_sample <- mod$sample(chains = 2, iter_sampling = 1, iter_warmup = 100, seed = 2)
+    fit_sample <- mod$sample(chains = 2, iter_sampling = 3, iter_warmup = 100, seed = 2)
   )
   chain_tdata_1 <- posterior::subset_draws(fit_sample$draws(""tdata""), chain = 1)
   chain_tdata_2 <- posterior::subset_draws(fit_sample$draws(""tdata""), chain = 2)
@@ -286,7 +286,7 @@ test_that(""seed works for multi chain sampling"", {
   expect_false(all(chain_tdata_1 == chain_tdata_2))
 
   utils::capture.output(
-    fit_sample <- mod$sample(chains = 2, iter_sampling = 1, iter_warmup = 100,
+    fit_sample <- mod$sample(chains = 2, iter_sampling = 3, iter_warmup = 100,
                              seed = c(1, 2))
   )
   chain_tdata_1 <- posterior::subset_draws(fit_sample$draws(""tdata""), chain = 1)",True,False,Implementation / Logic,6
stan-dev,cmdstanr,26e78e34dddfe2f162d4fcc68f00dcc7af63c1dc,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-07-15T16:33:47Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-07-15T16:33:47Z,First pass of fixes,.github/workflows/R-CMD-check-wsl.yaml;R/args.R;R/model.R;R/run.R;R/utils.R;tests/testthat/test-model-compile.R;tests/testthat/test-path.R,False,True,True,False,30,5,35,"---FILE: .github/workflows/R-CMD-check-wsl.yaml---
@@ -67,7 +67,7 @@ jobs:
 
       - name: Install cmdstan
         run: |
-          cmdstanr::install_cmdstan(cores = 2, wsl = TRUE)
+          cmdstanr::install_cmdstan(cores = 2, wsl = TRUE, overwrite = TRUE)
         shell: Rscript {0}
 
       - name: Session info

---FILE: R/args.R---
@@ -138,7 +138,7 @@ CmdStanArgs <- R6::R6Class(
       }
 
       if (!is.null(self$init)) {
-        args$init <- paste0(""init="", self$init[idx])
+        args$init <- paste0(""init="", wsl_path_compat(self$init[idx]))
       }
 
       if (!is.null(self$data_file)) {
@@ -1019,6 +1019,9 @@ available_metrics <- function() {
 #' @param idx Chain id (only applicable for MCMC).
 compose_arg <- function(self, arg_name, cmdstan_arg_name = NULL, idx = NULL) {
   val <- self[[arg_name]]
+  if (os_is_wsl() && (arg_name %in% c(""fitted_params"", ""metric_file""))) {
+    val <- sapply(val, wsl_path_compat)
+  }
   cmdstan_arg_name <- cmdstan_arg_name %||% arg_name
 
   if (is.null(val)) {

---FILE: R/model.R---
@@ -1761,6 +1761,7 @@ include_paths_stanc3_args <- function(include_paths = NULL) {
   if (!is.null(include_paths)) {
     checkmate::assert_directory_exists(include_paths, access = ""r"")
     include_paths <- absolute_path(include_paths)
+    include_paths <- sapply(include_paths, wsl_path_compat)
     paths_w_space <- grep("" "", include_paths)
     include_paths[paths_w_space] <- paste0(""'"", include_paths[paths_w_space], ""'"")
     include_paths <- paste0(include_paths, collapse = "","")

---FILE: R/run.R---
@@ -353,6 +353,10 @@ check_target_exe <- function(exe) {
   } else {
     cat(paste0(start_msg, "", with "", procs$threads_per_proc(), "" thread(s) per chain...\n\n""))
     Sys.setenv(""STAN_NUM_THREADS"" = as.integer(procs$threads_per_proc()))
+    # Windows environment variables have to be explicitly exported to WSL
+    if (os_is_wsl()) {
+      Sys.setenv(""WSLENV""=""STAN_NUM_THREADS/u"")
+    }
   }
   start_time <- Sys.time()
   chains <- procs$proc_ids()
@@ -412,6 +416,10 @@ CmdStanRun$set(""private"", name = ""run_sample_"", value = .run_sample)
   } else {
     cat(paste0(start_msg, "", with "", procs$threads_per_proc(), "" thread(s) per chain...\n\n""))
     Sys.setenv(""STAN_NUM_THREADS"" = as.integer(procs$threads_per_proc()))
+    # Windows environment variables have to be explicitly exported to WSL
+    if (os_is_wsl()) {
+      Sys.setenv(""WSLENV""=""STAN_NUM_THREADS/u"")
+    }
   }
   start_time <- Sys.time()
   chains <- procs$proc_ids()
@@ -454,6 +462,10 @@ CmdStanRun$set(""private"", name = ""run_generate_quantities_"", value = .run_genera
   procs <- self$procs
   if (!is.null(procs$threads_per_proc())) {
     Sys.setenv(""STAN_NUM_THREADS"" = as.integer(procs$threads_per_proc()))
+    # Windows environment variables have to be explicitly exported to WSL
+    if (os_is_wsl()) {
+      Sys.setenv(""WSLENV""=""STAN_NUM_THREADS/u"")
+    }
   }
   start_time <- Sys.time()
   id <- 1
@@ -501,6 +513,10 @@ CmdStanRun$set(""private"", name = ""run_variational_"", value = .run_other)
   procs <- self$procs
   if (!is.null(procs$threads_per_proc())) {
     Sys.setenv(""STAN_NUM_THREADS"" = as.integer(procs$threads_per_proc()))
+    # Windows environment variables have to be explicitly exported to WSL
+    if (os_is_wsl()) {
+      Sys.setenv(""WSLENV""=""STAN_NUM_THREADS/u"")
+    }
   }
   stdout_file <- tempfile()
   stderr_file <- tempfile()

---FILE: R/utils.R---
@@ -47,6 +47,8 @@ os_is_wsl <- function() {
       grepl(""wsl-cmdstan"", cmdstan_path())
   }, error = function(e) {
       FALSE
+  }, warning = function(e) {
+      FALSE
   })
   os_is_windows() && (wsl_in_path || Sys.getenv(""CMDSTANR_USE_WSL"") == 1)
 }
@@ -153,6 +155,9 @@ absolute_path <- Vectorize(.absolute_path, USE.NAMES = FALSE)
 # to Windows mount point (/mnt/drive-letter) within the WSL install:
 # e.g., C:/Users/... -> /mnt/c/Users/...
 wsl_path_compat <- function(path) {
+  if (!is.character(path)) {
+    path
+  }
   path_already_safe <- grepl(""/mnt/"", path)
   if (os_is_wsl() && !isTRUE(path_already_safe) && !is.na(path)) {
     abs_path <- repair_path(path)

---FILE: tests/testthat/test-model-compile.R---
@@ -73,7 +73,7 @@ test_that(""compile() method works with spaces in path"", {
   expect_interactive_message(mod_spaces$compile(), ""Compiling Stan program..."")
   file.remove(stan_model_with_spaces)
   file.remove(exe)
-  file.remove(dir_with_spaces)
+  unlink(dir_with_spaces, recursive = TRUE)
 })
 
 test_that(""compile() method overwrites binaries"", {
@@ -581,7 +581,7 @@ test_that(""cmdstan_model errors with no args "", {
 })
 
 test_that(""cmdstan_model works with user_header"", {
-  skip_if(os_is_macos() | os_is_windows()) 
+  skip_if(os_is_macos() | os_is_windows())
   tmpfile <- tempfile(fileext = "".hpp"")
   hpp <-
   ""

---FILE: tests/testthat/test-path.R---
@@ -90,7 +90,7 @@ test_that(""Warning message is thrown if can't detect version number"", {
 })
 
 test_that(""cmdstan_ext() works"", {
-  if (os_is_windows()) {
+  if (os_is_windows() && !os_is_wsl()) {
     expect_identical(cmdstan_ext(), "".exe"")
     expect_identical(cmdstan_ext(""path""), ""path.exe"")
   } else {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,afa95cc6f788e69697fcc3c3ebfb7eb5563d903a,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-07-15T12:48:48Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-07-15T12:48:48Z,Fix syntax checking failure,.github/workflows/R-CMD-check-wsl.yaml;R/install.R;R/model.R;man/install_cmdstan.Rd,False,True,True,False,10,5,15,"---FILE: .github/workflows/R-CMD-check-wsl.yaml---
@@ -2,7 +2,7 @@
 # Github Actions workflow to check CmdStanR
 # yamllint disable rule:line-length
 
-name: Unit tests
+name: Unit tests - WSL Backend
 
 'on':
   push:
@@ -63,8 +63,7 @@ jobs:
             distribution: Ubuntu-22.04
             use-cache: 'true'
             set-as-default: 'true'
-            additional-packages: |
-              build-essential
+            additional-packages: build-essential
 
       - name: Install cmdstan
         run: |

---FILE: R/install.R---
@@ -57,6 +57,8 @@
 #' @param check_toolchain (logical) Should `install_cmdstan()` attempt to check
 #'   that the required toolchain is installed and properly configured. The
 #'   default is `TRUE`.
+#' @param wsl (logical) Should CmdStan be installed and run through the Windows
+#'  Subsystem for Linux (WSL). The default is `FALSE`.
 #'
 #' @examples
 #' \dontrun{

---FILE: R/model.R---
@@ -761,7 +761,7 @@ check_syntax <- function(pedantic = FALSE,
     ),
     run_log <- wsl_compatible_run(
       command = stanc_cmd(),
-      args = c(self$stan_file(), stanc_built_options, stancflags_val),
+      args = c(wsl_path_compat(self$stan_file()), stanc_built_options, stancflags_val),
       wd = cmdstan_path(),
       echo = is_verbose_mode(),
       echo_cmd = is_verbose_mode(),

---FILE: man/install_cmdstan.Rd---
@@ -16,7 +16,8 @@ install_cmdstan(
   version = NULL,
   release_url = NULL,
   cpp_options = list(),
-  check_toolchain = TRUE
+  check_toolchain = TRUE,
+  wsl = FALSE
 )
 
 rebuild_cmdstan(
@@ -73,6 +74,9 @@ the use of clang for compilation.}
 that the required toolchain is installed and properly configured. The
 default is \code{TRUE}.}
 
+\item{wsl}{(logical) Should CmdStan be installed and run through the Windows
+Subsystem for Linux (WSL). The default is \code{FALSE}.}
+
 \item{append}{(logical) For \code{cmdstan_make_local()}, should the listed
 makefile flags be appended to the end of the existing \code{make/local} file?
 The default is \code{TRUE}. If \code{FALSE} the file is overwritten.}",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,7348384704a47222eed9f2a0b3cf430ed3285e37,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-07-15T08:31:30Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-07-15T08:31:30Z,Fix compatibility with non-wsl,R/install.R;R/model.R;R/run.R;R/utils.R,False,True,True,False,58,35,93,"---FILE: R/install.R---
@@ -178,7 +178,7 @@ install_cmdstan <- function(dir = NULL,
       append = TRUE
     )
   }
-  if (is_rtools42_toolchain() && !isTRUE(wsl)) {
+  if (is_rtools42_toolchain() && !os_is_wsl()) {
     cmdstan_make_local(
       dir = dir_cmdstan,
       cpp_options = list(
@@ -211,6 +211,10 @@ install_cmdstan <- function(dir = NULL,
       ""\nrebuild_cmdstan(cores = ...)""
     )
   }
+
+  if (isTRUE(wsl)) {
+    Sys.unsetenv(""CMDSTANR_USE_WSL"")
+  }
 }
 
 
@@ -409,15 +413,15 @@ build_cmdstan <- function(dir,
 clean_cmdstan <- function(dir = cmdstan_path(),
                           cores = getOption(""mc.cores"", 2),
                           quiet = FALSE) {
-  translation_args <- ifelse(os_is_wsl(), ""make"", NULL)
   withr::with_path(
     c(
       toolchain_PATH_env_var(),
       tbb_path(dir = dir)
     ),
     processx::run(
       make_cmd(),
-      args = c(translation_args, ""clean-all""),
+      args = wsl_args(command = ""make"",
+                      args = ""clean_all""),
       wd = dir,
       echo_cmd = is_verbose_mode(),
       echo = !quiet || is_verbose_mode(),
@@ -429,16 +433,18 @@ clean_cmdstan <- function(dir = cmdstan_path(),
 }
 
 build_example <- function(dir, cores, quiet, timeout) {
-  translation_args <- ifelse(os_is_wsl(), ""make"", NULL)
   withr::with_path(
     c(
       toolchain_PATH_env_var(),
       tbb_path(dir = dir)
     ),
     processx::run(
       make_cmd(),
-      args = c(translation_args, paste0(""-j"", cores),
-                cmdstan_ext(file.path(""examples"", ""bernoulli"", ""bernoulli""))),
+      args = wsl_args(command = ""make"",
+                      args = c(paste0(""-j"", cores),
+                              cmdstan_ext(file.path(""examples"",
+                                                    ""bernoulli"",
+                                                    ""bernoulli"")))),
       wd = dir,
       echo_cmd = is_verbose_mode(),
       echo = !quiet || is_verbose_mode(),
@@ -548,7 +554,6 @@ check_wsl_toolchain <- function() {
          ""\n"", ""Arch: pacman -Sy base-devel"",
          call. = FALSE)
   }
-
 }
 
 check_rtools4x_windows_toolchain <- function(fix = FALSE, quiet = FALSE) {

---FILE: R/model.R---
@@ -554,11 +554,10 @@ compile <- function(quiet = TRUE,
     ),
     run_log <- processx::run(
       command = make_cmd(),
-      args = c(
-              ifelse(os_is_wsl(), ""make"", """"),
-              tmp_exe,
-              cpp_options_to_compile_flags(cpp_options),
-              stancflags_val),
+      args = wsl_args(command = ""make"",
+                      args = c(tmp_exe,
+                                cpp_options_to_compile_flags(cpp_options),
+                                stancflags_val)),
       wd = cmdstan_path(),
       echo = !quiet || is_verbose_mode(),
       echo_cmd = is_verbose_mode(),
@@ -655,10 +654,7 @@ variables <- function() {
   }
   assert_stan_file_exists(self$stan_file())
   if (is.null(private$variables_) && file.exists(self$stan_file())) {
-    private$variables_ <- model_variables(
-      self$stan_file(),
-      self$include_paths(),
-      allow_undefined = private$using_user_header_)
+    private$variables_ <- model_variables(self$stan_file(), self$include_paths(), allow_undefined = private$using_user_header_)
   }
   private$variables_
 }
@@ -766,8 +762,9 @@ check_syntax <- function(pedantic = FALSE,
     ),
     run_log <- processx::run(
       command = stanc_cmd(),
-      args = c(ifelse(os_is_wsl(), ""bin/stanc"", """"),
-              self$stan_file(), stanc_built_options, stancflags_val),
+      args = wsl_args(command = ""bin/stanc"",
+                      args = c(self$stan_file(), stanc_built_options,
+                      stancflags_val)),
       wd = cmdstan_path(),
       echo = is_verbose_mode(),
       echo_cmd = is_verbose_mode(),
@@ -909,8 +906,8 @@ format <- function(overwrite_file = FALSE,
     ),
     run_log <- processx::run(
       command = stanc_cmd(),
-      args = c(ifelse(os_is_wsl(), ""bin/stanc"", """"),
-                self$stan_file(), stanc_built_options, stancflags_val),
+      args = wsl_args(command = ""bin/stanc"",
+                      args = c(self$stan_file(), stanc_built_options, stancflags_val)),
       wd = cmdstan_path(),
       echo = is_verbose_mode(),
       echo_cmd = is_verbose_mode(),
@@ -1790,8 +1787,11 @@ model_variables <- function(stan_file, include_paths = NULL, allow_undefined = F
   stan_file <- stan_file
   run_log <- processx::run(
     command = stanc_cmd(),
-    args = c(ifelse(os_is_wsl(), ""bin/stanc"", """"),
-              stan_file, ""--info"", include_paths_stanc3_args(include_paths), allow_undefined_arg),
+    args = wsl_args(
+      command = ""bin/stanc"",
+      args = c(stan_file, ""--info"", include_paths_stanc3_args(include_paths),
+                allow_undefined_arg)
+    ),
     wd = cmdstan_path(),
     echo = FALSE,
     echo_cmd = FALSE,
@@ -1819,8 +1819,9 @@ model_compile_info <- function(exe_file) {
         tbb_path()
       ),
       ret <- processx::run(
-        command = ifelse(os_is_wsl(), ""wsl"", exe_file),
-        args = c(ifelse(os_is_wsl(), exe_file, NULL),""info""),
+        command = wsl_command(exe_file),
+        args = wsl_args(command = exe_file,
+                        args = ""info""),
         error_on_status = FALSE
       )
     )

---FILE: R/run.R---
@@ -232,9 +232,11 @@ CmdStanRun <- R6::R6Class(
           tbb_path()
         ),
         run_log <- processx::run(
-          command = ifelse(os_is_wsl(), ""wsl"", target_exe),
-          args = c(ifelse(os_is_wsl(), target_exe, NULL),
-                    self$output_files(include_failed = FALSE), flags),
+          command = wsl_command(target_exe),
+          args = wsl_args(
+            command = target_exe,
+            args = c(self$output_files(include_failed = FALSE), flags)
+          ),
           wd = cmdstan_path(),
           echo = TRUE,
           echo_cmd = is_verbose_mode(),
@@ -303,7 +305,7 @@ check_target_exe <- function(exe) {
       ),
       run_log <- processx::run(
         command = make_cmd(),
-        args = ifelse(os_is_wsl(), ""make"", exe),
+        args = wsl_args(command = ""make"", args = exe),
         wd = cmdstan_path(),
         echo_cmd = TRUE,
         echo = TRUE,
@@ -509,9 +511,11 @@ CmdStanRun$set(""private"", name = ""run_variational_"", value = .run_other)
       tbb_path()
     ),
     ret <- processx::run(
-      command = ifelse(os_is_wsl(), ""wsl"", self$command()),
-      args = c(ifelse(os_is_wsl(), self$command(), NULL),
-                self$command_args()[[1]]),
+      command = wsl_command(self$command()),
+      args = wsl_args(
+        command = self$command(),
+        args = self$command_args()[[1]]
+      ),
       wd = dirname(self$exe_file()),
       stderr = stderr_file,
       stdout = stdout_file,
@@ -626,8 +630,11 @@ CmdStanProcs <- R6::R6Class(
           tbb_path()
         ),
         private$processes_[[id]] <- processx::process$new(
-          command = ifelse(os_is_wsl(), ""wsl"", command),
-          args = c(ifelse(os_is_wsl(), paste0(""./"", command), NULL), args),
+          command = wsl_command(command),
+          args = wsl_args(
+            command = paste0(""./"", command),
+            args = args
+          ),
           wd = wd,
           stdout = ""|"",
           stderr = ""|"",

---FILE: R/utils.R---
@@ -156,7 +156,7 @@ absolute_path <- Vectorize(.absolute_path, USE.NAMES = FALSE)
 # When providing the model path to WSL, it needs to be in reference to the
 # to Windows mount point (/mnt/drive-letter) within the WSL install:
 # e.g., C:/Users/... -> /mnt/c/Users/...
-.wsl_path_compat <- function(path) {
+wsl_path_compat <- function(path) {
   path_already_safe <- grepl(""^/mnt/"", path)
   if (os_is_wsl() && !isTRUE(path_already_safe) && !is.na(path)) {
     path <- normalizePath(path)
@@ -171,7 +171,17 @@ absolute_path <- Vectorize(.absolute_path, USE.NAMES = FALSE)
   path
 }
 
-wsl_path_compat <- Vectorize(.wsl_path_compat, USE.NAMES = FALSE)
+wsl_args <- function(command, args) {
+  if (os_is_wsl()) {
+    c(command, args)
+  } else {
+    args
+  }
+}
+
+wsl_command <- function(command) {
+  ifelse(os_is_wsl(), ""wsl"", command)
+}
 
 # read, write, and copy files --------------------------------------------
 ",True,False,Implementation / Logic,6
stan-dev,cmdstanr,d631a4e1f2a31c6612c431ccf4fd45085c2194c0,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-07-15T03:38:10Z,Andrew Johnson,andrew.johnson@arjohnsonau.com,2022-07-15T03:38:10Z,Fix path ending for install/build,R/install.R;R/utils.R,False,True,True,False,5,3,8,"---FILE: R/install.R---
@@ -446,7 +446,9 @@ build_example <- function(dir, cores, quiet, timeout, wsl = FALSE) {
     ),
     processx::run(
       run_cmd,
-      args = c(translation_args, paste0(""-j"", cores), cmdstan_ext(file.path(""examples"", ""bernoulli"", ""bernoulli""))),
+      args = c(translation_args, paste0(""-j"", cores),
+                cmdstan_ext(file.path(""examples"", ""bernoulli"", ""bernoulli""),
+                            wsl)),
       wd = dir,
       echo_cmd = is_verbose_mode(),
       echo = !quiet || is_verbose_mode(),

---FILE: R/utils.R---
@@ -109,8 +109,8 @@ repair_path <- function(path) {
 #' @param path If not `NULL` then a path to add the extension to.
 #' @return If `path` is `NULL` then `"".exe""` on Windows and `""""` otherwise. If
 #'   `path` is not `NULL` then `.exe` is added as the extension on Windows.
-cmdstan_ext <- function(path = NULL) {
-  ext <- if (os_is_windows()) "".exe"" else """"
+cmdstan_ext <- function(path = NULL, wsl = FALSE) {
+  ext <- if (os_is_windows() && !isTRUE(wsl)) "".exe"" else """"
   if (is.null(path)) {
     return(ext)
   }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,02d4dea6d984addec7e3b6ddcf8ebcd0d7d30134,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-07-10T09:10:35Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-07-10T09:10:35Z,syntax fix,R/model.R,False,True,True,False,1,1,2,"---FILE: R/model.R---
@@ -586,7 +586,7 @@ compile <- function(quiet = TRUE,
             warning(
               ""The C++ compiler has errored due to incompatibility between the x86 and "",
               ""Apple Silicon architectures.\n"",
-              ""If you are running R inside an IDE (RStudio, VSCode, ...), ""
+              ""If you are running R inside an IDE (RStudio, VSCode, ...), "",
               ""make sure the IDE is a native Apple Silicon app.\n"",
               call. = FALSE
             )",True,False,Implementation / Logic,6
stan-dev,cmdstanr,d4a0dda00fc308d7b54b28ba1e82a63059e0c25b,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-07-10T08:55:06Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-07-10T08:55:06Z,catch the x86 and aarch64 error and output a better warning,R/model.R,False,True,True,False,12,0,12,"---FILE: R/model.R---
@@ -580,6 +580,18 @@ compile <- function(quiet = TRUE,
             call. = FALSE
           )
         }
+        if (os_is_macos()) {
+          if (R.version$arch == ""aarch64"" 
+              && grepl(""but the current translation unit is being compiled for target"", x)) {
+            warning(
+              ""The C++ compiler has errored due to incompatibility between the x86 and "",
+              ""Apple Silicon architectures.\n"",
+              ""If you are running R inside an IDE (RStudio, VSCode, ...), ""
+              ""make sure the IDE is a native Apple Silicon app.\n"",
+              call. = FALSE
+            )
+          }
+        }
       },
       error_on_status = FALSE
     )",True,False,Implementation / Logic,6
stan-dev,cmdstanr,63775ae75e096f1a3deaa11dd7d4c7b91dadf8e1,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-07-09T14:28:45Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-07-09T14:28:45Z,attempt at fixing the win11 issue,R/install.R,False,True,True,False,3,0,3,"---FILE: R/install.R---
@@ -247,6 +247,9 @@ cmdstan_make_local <- function(dir = cmdstan_path(),
         }
       }
     }
+    if (file.exists(make_local_path)) {
+      file.create(make_local_path)
+    }
     write(built_flags, file = make_local_path, append = append)
   }
   if (file.exists(make_local_path)) {",True,False,Environment / Configuration,3
stan-dev,cmdstanr,ca0eec1e14a438758467095cc24d975f7202999c,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-07-09T14:05:54Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-07-09T14:05:54Z,fix fit$time() for the case where chains fail,R/run.R,False,True,True,False,5,4,9,"---FILE: R/run.R---
@@ -253,11 +253,12 @@ CmdStanRun <- R6::R6Class(
 
         time <- list(total = self$procs$total_time(), chains = chain_time)
       } else {
+        chain_ids <- names(self$procs$is_finished())
         chain_time <- data.frame(
-          chain_id = self$procs$proc_ids()[self$procs$is_finished()],
-          warmup = self$procs$proc_section_time(""warmup"")[self$procs$is_finished()],
-          sampling = self$procs$proc_section_time(""sampling"")[self$procs$is_finished()],
-          total = self$procs$proc_total_time()[self$procs$is_finished()]
+          chain_id = as.vector(self$procs$proc_ids()),
+          warmup = as.vector(self$procs$proc_section_time(""warmup"")),
+          sampling = as.vector(self$procs$proc_section_time(""sampling"")),
+          total = as.vector(self$procs$proc_total_time()[chain_ids])
         )
         time <- list(total = self$procs$total_time(), chains = chain_time)
       }",True,False,Implementation / Logic,3
stan-dev,cmdstanr,f21d3731b2a8f7479140b7318aac0d5a19ccd0d4,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-07-08T08:47:04Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-07-08T08:47:04Z,more CI fixes,.github/workflows/R-CMD-check.yaml;.github/workflows/Test-coverage.yaml;.github/workflows/cmdstan-tarball-check.yaml,False,False,False,False,19,54,73,"---FILE: .github/workflows/R-CMD-check.yaml---
@@ -23,14 +23,14 @@ jobs:
       fail-fast: false
       matrix:
         config:
-          - {os: macOS-latest, r: 'devel'}
-          - {os: macOS-latest, r: 'release'}
-          - {os: windows-latest, r: 'devel'}
-          - {os: windows-latest, r: 'release'}
-          - {os: windows-latest, r: 'oldrel'}
-          - {os: ubuntu-20.04, r: 'devel'}
-          - {os: ubuntu-20.04, r: 'release'}
-          - {os: ubuntu-20.04, r: 'oldrel'}
+          - {os: macOS-latest, r: 'devel', rtools: ''}
+          - {os: macOS-latest, r: 'release', rtools: ''}
+          - {os: windows-latest, r: 'devel', rtools: '42'}
+          - {os: windows-latest, r: 'release', rtools: '42'}
+          - {os: windows-latest, r: 'oldrel', rtools: '40'}
+          - {os: ubuntu-20.04, r: 'devel', rtools: ''}
+          - {os: ubuntu-20.04, r: 'release', rtools: ''}
+          - {os: ubuntu-20.04, r: 'oldrel', rtools: ''}
     env:
       R_REMOTES_NO_ERRORS_FROM_WARNINGS: true
       GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
@@ -56,17 +56,10 @@ jobs:
           sudo apt-get install -y libcurl4-openssl-dev || true
           sudo apt-get install -y openmpi-bin openmpi-common libopenmpi-dev || true
 
-      - uses: r-lib/actions/setup-r@v2
+      - uses: r-lib/actions/setup-r@v2.2.3
         with:
           r-version: ${{ matrix.config.r }}
-      - name: Install Rtools42
-        if: runner.os == 'Windows'
-        run: |
-          $source = 'https://cran.r-project.org/bin/windows/Rtools/rtools42/files/rtools42-5253-5107.exe'
-          $destination = '../rtools42.exe'
-          Invoke-WebRequest -Uri $source -OutFile $destination
-          Start-Process -FilePath ../rtools42.exe -ArgumentList /VERYSILENT -NoNewWindow -Wait
-        shell: powershell
+          rtools-version: ${{ matrix.config.rtools }}
       - uses: r-lib/actions/setup-pandoc@v1
 
       - name: Query dependencies
@@ -94,7 +87,6 @@ jobs:
 
       - name: Install cmdstan
         run: |
-          print(list.files(""C:/rtools42""))
           cmdstanr::check_cmdstan_toolchain(fix = TRUE)
           cmdstanr::install_cmdstan(cores = 2)
         shell: Rscript {0}

---FILE: .github/workflows/Test-coverage.yaml---
@@ -85,17 +85,10 @@ jobs:
     steps:
       - uses: actions/checkout@v3
 
-      - uses: r-lib/actions/setup-r@v2
+      - uses: r-lib/actions/setup-r@v2.2.3
         with:
           r-version: 'release'
-      - name: Install Rtools42
-        if: runner.os == 'Windows'
-        run: |
-          $source = 'https://cran.r-project.org/bin/windows/Rtools/rtools42/files/rtools42-5253-5107.exe'
-          $destination = '../rtools42.exe'
-          Invoke-WebRequest -Uri $source -OutFile $destination
-          Start-Process -FilePath ../rtools42.exe -ArgumentList /VERYSILENT -NoNewWindow -Wait
-        shell: powershell
+          rtools-version: '42'
 
       - uses: r-lib/actions/setup-pandoc@v1
 

---FILE: .github/workflows/cmdstan-tarball-check.yaml---
@@ -22,9 +22,9 @@ jobs:
       fail-fast: false
       matrix:
         config:
-          - {os: macOS-latest, r: 'release'}
-          - {os: windows-latest, r: 'release'}
-          - {os: ubuntu-20.04, r: 'release'}
+          - {os: macOS-latest, r: 'release', rtools: ''}
+          - {os: windows-latest, r: 'release', rtools: '42'}
+          - {os: ubuntu-20.04, r: 'release', rtools: ''}
     env:
       R_REMOTES_NO_ERRORS_FROM_WARNINGS: true
       GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
@@ -33,38 +33,18 @@ jobs:
 
     steps:
       - uses: actions/checkout@v3
-
-      - name: Set path for RTools 4.0
-        if: runner.os == 'Windows'
-        run: echo ""C:/rtools40/usr/bin;C:/rtools40/mingw64/bin"" | Out-File -Append -FilePath $env:GITHUB_PATH -Encoding utf8
-
-      - name: Install mingw32-make and check toolchain path
-        if: runner.os == 'Windows'
-        run: |
-          pacman -Syu mingw-w64-x86_64-make --noconfirm
-          g++ --version
-          Get-Command g++ | Select-Object -ExpandProperty Definition
-          mingw32-make --version
-          Get-Command mingw32-make | Select-Object -ExpandProperty Definition
-        shell: powershell
-
       - name: Install system dependencies
         if: runner.os == 'Linux'
         run: |
           sudo apt-get update
           sudo apt-get install -y libcurl4-openssl-dev || true
           sudo apt-get install -y openmpi-bin openmpi-common libopenmpi-dev || true
-      - uses: r-lib/actions/setup-r@v1
+
+      - uses: r-lib/actions/setup-r@v2.2.3
         with:
           r-version: ${{ matrix.config.r }}
-      - name: Install Rtools42
-        if: runner.os == 'Windows'
-        run: |
-          $source = 'https://cran.r-project.org/bin/windows/Rtools/rtools42/files/rtools42-5253-5107.exe'
-          $destination = '../rtools42.exe'
-          Invoke-WebRequest -Uri $source -OutFile $destination
-          Start-Process -FilePath ../rtools42.exe -ArgumentList /VERYSILENT -NoNewWindow -Wait
-        shell: powershell
+          rtools-version: ${{ matrix.config.rtools }}
+
       - uses: r-lib/actions/setup-pandoc@v1
 
       - name: Query dependencies",False,False,Rendering / Conversion,3
stan-dev,cmdstanr,414843bcfa6e2c186ae9fb3ce6e11e0d7aeb04fe,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-07-08T06:04:26Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-07-08T06:04:26Z,fix test for cmdstan 2.30.0,tests/testthat/test-model-compile.R,False,True,True,False,2,1,3,"---FILE: tests/testthat/test-model-compile.R---
@@ -590,7 +590,8 @@ test_that(""cmdstan_model works with user_header"", {
 
   namespace bernoulli_external_model_namespace
   {
-      template <typename T0__, stan::require_stan_scalar_t<T0__>* = nullptr>
+      template <typename T0__,
+            stan::require_all_t<stan::is_stan_scalar<T0__>>* = nullptr>
       inline typename boost::math::tools::promote_args<T0__>::type make_odds(const T0__ &
                                                                                  theta,
                                                                              std::ostream *pstream__)",True,False,Rendering / Conversion,3
stan-dev,cmdstanr,6d414856a40d95d2d56ac5e249a96f973c713248,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-07-07T19:06:27Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-07-07T19:06:27Z,fix unit tests,tests/testthat/test-example.R,False,True,True,False,5,4,9,"---FILE: tests/testthat/test-example.R---
@@ -48,13 +48,14 @@ test_that(""write_stan_file writes Stan file correctly"", {
 
 test_that(""write_stan_file writes to specified directory and filename"", {
   dir <- file.path(test_path(), ""answers"")
-  expect_equal(dirname(f1 <- write_stan_file(stan_program, dir = dir, basename = ""pasta"")), dir)
+  expect_equal(dirname(f1 <- write_stan_file(stan_program, dir = dir, basename = ""pasta"")),
+               absolute_path(dir))
   expect_equal(f2 <- write_stan_file(stan_program, dir = dir, basename = ""fruit.stan""),
-               file.path(dir, ""fruit.stan""))
+               absolute_path(file.path(dir, ""fruit.stan"")))
   expect_equal(f3 <- write_stan_file(stan_program, dir = dir, basename = ""vegetable""),
-               file.path(dir, ""vegetable.stan"")) # should add .stan extension if missing
+               absolute_path(file.path(dir, ""vegetable.stan""))) # should add .stan extension if missing
   expect_equal(f4 <- write_stan_file(stan_program, dir = tempdir(), basename = ""test""),
-               file.path(tempdir(), ""test.stan""))
+               absolute_path(file.path(tempdir(), ""test.stan"")))
 
   try(file.remove(f1, f2, f3, f4), silent = TRUE)
 })",True,False,File I/O and Export,3
stan-dev,cmdstanr,7cb38ecdece71cd70155d97d30585afe7bf5ed93,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-07-07T10:22:19Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-07-07T10:22:19Z,fix,R/example.R,False,True,True,False,1,0,1,"---FILE: R/example.R---
@@ -148,6 +148,7 @@ write_stan_file <- function(code,
                             basename = NULL,
                             force_overwrite = FALSE,
                             hash_salt = """") {
+  dir <- absolute_path(dir)
   if (!dir.exists(dir)) {
     dir.create(dir, recursive = TRUE)
   }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,adb1752b0b40036755c3657a766ce893e09d5f75,Wes Hinsley,w.hinsley@imperial.ac.uk,2022-06-29T09:53:47Z,Wes Hinsley,w.hinsley@imperial.ac.uk,2022-06-29T09:53:47Z,Fix quoting on grep (works for me),R/csv.R,False,True,True,False,4,4,8,"---FILE: R/csv.R---
@@ -236,9 +236,9 @@ read_cmdstan_csv <- function(files,
       grep_path_quotes <- paste0('""', grep_path_repaired, '""')
       fread_cmd <- paste0(
         grep_path_quotes,
-        "" -v '^#' --color=never '"",
+        "" -v \""^#\"" --color=never \"""",
         output_file,
-        ""'""
+        ""\""""
       )
     } else {
       fread_cmd <- paste0(""grep -v '^#' --color=never '"", output_file, ""'"")
@@ -578,9 +578,9 @@ read_csv_metadata <- function(csv_file) {
     grep_path_quotes <- paste0('""', grep_path_repaired, '""')
     fread_cmd <- paste0(
       grep_path_quotes,
-      "" '^[#a-zA-Z]' --color=never '"",
+      "" \""^[#a-zA-Z]\"" --color=never \"""",
       csv_file,
-      ""'""
+      ""\""""
     )
   } else {
     fread_cmd <- paste0(""grep '^[#a-zA-Z]' --color=never '"", csv_file, ""'"")",True,False,Documentation / Formatting,3
stan-dev,cmdstanr,9fe50a3ae21d224b86de1d00dcc81aa507a556a6,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-06-13T07:17:25Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-06-13T07:17:25Z,fix sloppy copy & paste,R/csv.R,False,True,True,False,1,1,2,"---FILE: R/csv.R---
@@ -236,7 +236,7 @@ read_cmdstan_csv <- function(files,
       grep_path_quotes <- paste0('""', grep_path_repaired, '""')
       fread_cmd <- paste0(
         grep_path_quotes,
-        "" '^[#a-zA-Z]' --color=never '"",
+        "" -v '^#' --color=never '"",
         output_file,
         ""'""
       )",True,False,Documentation / Formatting,3
stan-dev,cmdstanr,79374bcb715bbda9bf01c625731ec05a1c906e8b,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-06-12T19:00:08Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-06-12T19:00:08Z,a couple of windows fixes,tests/testthat/test-model-compile.R,False,True,True,False,3,2,5,"---FILE: tests/testthat/test-model-compile.R---
@@ -105,7 +105,8 @@ test_that(""compilation works with include_paths"", {
 
   expect_interactive_message(
     mod_w_include <- cmdstan_model(stan_file = stan_program_w_include, quiet = TRUE,
-                                   include_paths = test_path(""resources"", ""stan"")),
+                                   include_paths = test_path(""resources"", ""stan""),
+                                   force_recompile = TRUE),
     ""Compiling Stan program""
   )
   expect_equal(
@@ -580,7 +581,7 @@ test_that(""cmdstan_model errors with no args "", {
 })
 
 test_that(""cmdstan_model works with user_header"", {
-  skip_if(os_is_macos())
+  skip_if(os_is_macos() | os_is_windows()) 
   tmpfile <- tempfile(fileext = "".hpp"")
   hpp <-
   """,True,False,Rendering / Conversion,3
stan-dev,cmdstanr,0cf7b42feb9a9322312f6840b44dc29219789d41,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-06-12T13:00:12Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-06-12T13:00:12Z,syntax fix,R/csv.R,False,True,True,False,1,1,2,"---FILE: R/csv.R---
@@ -237,7 +237,7 @@ read_cmdstan_csv <- function(files,
       fread_cmd <- paste0(
         grep_path_quotes,
         "" '^[#a-zA-Z]' --color=never '"",
-        csv_file,
+        output_file,
         ""'""
       )
     } else {",True,False,Implementation / Logic,3
stan-dev,cmdstanr,3c81083a1eac7c1055e4d9c183f21c0b9f938e04,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-06-12T09:52:53Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-06-12T09:52:53Z,fix grep on Windows,R/csv.R,False,True,True,False,26,4,30,"---FILE: R/csv.R---
@@ -227,8 +227,19 @@ read_cmdstan_csv <- function(files,
   num_post_warmup_draws <- ceiling(metadata$iter_sampling / metadata$thin)
   for (output_file in files) {
     if (os_is_windows()) {
-      grep_path <- paste0('""', repair_path(Sys.which(""grep.exe"")), '""')
-      fread_cmd <- paste0(grep_path, "" -v '^#' --color=never '"", output_file, ""'"")
+      grep_path_repaired <- withr::with_path(
+        c(
+          toolchain_PATH_env_var()
+        ),
+        repair_path(Sys.which(""grep.exe""))
+      )
+      grep_path_quotes <- paste0('""', grep_path_repaired, '""')
+      fread_cmd <- paste0(
+        grep_path_quotes,
+        "" '^[#a-zA-Z]' --color=never '"",
+        csv_file,
+        ""'""
+      )
     } else {
       fread_cmd <- paste0(""grep -v '^#' --color=never '"", output_file, ""'"")
     }
@@ -558,8 +569,19 @@ read_csv_metadata <- function(csv_file) {
   sampling_time <- 0
   total_time <- 0
   if (os_is_windows()) {
-    grep_path <- paste0('""', repair_path(Sys.which(""grep.exe"")), '""')
-    fread_cmd <- paste0(grep_path, "" '^[#a-zA-Z]' --color=never '"", csv_file, ""'"")
+    grep_path_repaired <- withr::with_path(
+      c(
+        toolchain_PATH_env_var()
+      ),
+      repair_path(Sys.which(""grep.exe""))
+    )
+    grep_path_quotes <- paste0('""', grep_path_repaired, '""')
+    fread_cmd <- paste0(
+      grep_path_quotes,
+      "" '^[#a-zA-Z]' --color=never '"",
+      csv_file,
+      ""'""
+    )
   } else {
     fread_cmd <- paste0(""grep '^[#a-zA-Z]' --color=never '"", csv_file, ""'"")
   }",True,False,Documentation / Formatting,3
stan-dev,cmdstanr,eec8e2c627016c545f170d9a0206c09d94c32269,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-06-12T09:33:05Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-06-12T09:33:05Z,fix windows R install,.github/workflows/R-CMD-check.yaml;.github/workflows/Test-coverage.yaml;.github/workflows/cmdstan-tarball-check.yaml,False,False,False,False,3,3,6,"---FILE: .github/workflows/R-CMD-check.yaml---
@@ -62,7 +62,7 @@ jobs:
       - name: Install Rtools42
         if: runner.os == 'Windows'
         run: |
-          $source = 'https://cran.r-project.org/bin/windows/Rtools/rtools42/files/rtools42-5168-5107.exe'
+          $source = 'https://cran.r-project.org/bin/windows/Rtools/rtools42/files/rtools42-5253-5107.exe'
           $destination = '../rtools42.exe'
           Invoke-WebRequest -Uri $source -OutFile $destination
           Start-Process -FilePath ../rtools42.exe -ArgumentList /VERYSILENT -NoNewWindow -Wait

---FILE: .github/workflows/Test-coverage.yaml---
@@ -91,7 +91,7 @@ jobs:
       - name: Install Rtools42
         if: runner.os == 'Windows'
         run: |
-          $source = 'https://cran.r-project.org/bin/windows/Rtools/rtools42/files/rtools42-5168-5107.exe'
+          $source = 'https://cran.r-project.org/bin/windows/Rtools/rtools42/files/rtools42-5253-5107.exe'
           $destination = '../rtools42.exe'
           Invoke-WebRequest -Uri $source -OutFile $destination
           Start-Process -FilePath ../rtools42.exe -ArgumentList /VERYSILENT -NoNewWindow -Wait

---FILE: .github/workflows/cmdstan-tarball-check.yaml---
@@ -60,7 +60,7 @@ jobs:
       - name: Install Rtools42
         if: runner.os == 'Windows'
         run: |
-          $source = 'https://cran.r-project.org/bin/windows/Rtools/rtools42/files/rtools42-5168-5107.exe'
+          $source = 'https://cran.r-project.org/bin/windows/Rtools/rtools42/files/rtools42-5253-5107.exe'
           $destination = '../rtools42.exe'
           Invoke-WebRequest -Uri $source -OutFile $destination
           Start-Process -FilePath ../rtools42.exe -ArgumentList /VERYSILENT -NoNewWindow -Wait",False,False,Data / Input Handling,3
stan-dev,cmdstanr,83277fc93a6b4fe7ba333a81e386e2789d967d25,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-06-12T09:29:07Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-06-12T09:29:07Z,fix error msg,tests/testthat/test-install.R,False,True,True,False,2,2,4,"---FILE: tests/testthat/test-install.R---
@@ -127,8 +127,8 @@ test_that(""toolchain checks on Unix work"", {
   path_backup <- Sys.getenv(""PATH"")
   Sys.setenv(""PATH"" = """")
   if (os_is_macos()) {
-    err_msg_cpp <- ""A suitable C++ compiler was not found. Please install the command line tools for Mac with 'xcode-select --install' or install Xcode from the app store. Then restart R and run cmdstanr::check_cmdstan_toolchain()..""
-    err_msg_make <- ""The 'make' tool was not found. Please install the command line tools for Mac with 'xcode-select --install' or install Xcode from the app store. Then restart R and run cmdstanr::check_cmdstan_toolchain()..""
+    err_msg_cpp <- ""A suitable C++ compiler was not found. Please install the command line tools for Mac with 'xcode-select --install' or install Xcode from the app store. Then restart R and run cmdstanr::check_cmdstan_toolchain().""
+    err_msg_make <- ""The 'make' tool was not found. Please install the command line tools for Mac with 'xcode-select --install' or install Xcode from the app store. Then restart R and run cmdstanr::check_cmdstan_toolchain().""
   } else {
     err_msg_cpp <- ""A C++ compiler was not found. Please install the 'clang++' or 'g++' compiler, restart R, and run cmdstanr::check_cmdstan_toolchain().""
     err_msg_make <- ""The 'make' tool was not found. Please install 'make', restart R, and then run cmdstanr::check_cmdstan_toolchain().""",True,False,Environment / Configuration,3
stan-dev,cmdstanr,b6caca57103902c33cf8a7fd895583e61cabae59,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-06-12T09:28:00Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-06-12T09:28:00Z,fix ebfmi calc,R/utils.R,False,True,True,False,10,2,12,"---FILE: R/utils.R---
@@ -308,9 +308,17 @@ ebfmi <- function(post_warmup_sampler_diagnostics) {
 
 check_ebfmi <- function(post_warmup_sampler_diagnostics, threshold = 0.2) {
   efbmi_per_chain <- ebfmi(post_warmup_sampler_diagnostics)
-  if (any(efbmi_per_chain < threshold)) {
+  nan_efbmi_count <- sum(is.nan(efbmi_per_chain))
+  efbmi_below_threshold <- sum(efbmi_per_chain < threshold)
+  if (nan_efbmi_count > 0) {
     message(
-      ""Warning: "", sum(efbmi_per_chain < threshold), "" of "", length(efbmi_per_chain),
+      ""Warning: "", nan_efbmi_count, "" of "", length(efbmi_per_chain),
+      "" chains have a NaN E-BFMI.\n"",
+      ""See https://mc-stan.org/misc/warnings for details.\n""
+    )
+  } else if (efbmi_below_threshold > 0) {
+    message(
+      ""Warning: "", efbmi_below_threshold, "" of "", length(efbmi_per_chain),
       "" chains had an E-BFMI less than "", threshold, "".\n"",
       ""See https://mc-stan.org/misc/warnings for details.\n""
     )",True,False,Implementation / Logic,6
stan-dev,cmdstanr,bd02b57ffca044bcd9578f2f3d1b3a8e7e32624f,William Lai,44103957+williamlai2@users.noreply.github.com,2022-06-09T11:54:59Z,GitHub,noreply@github.com,2022-06-09T11:54:59Z,"Update install.R

Relates to #649 
Consistency as some were `cmdstanr::check_cmdstan_toolchain(fix = TRUE)` while others were just `check_cmdstan_toolchain(fix = TRUE)`.",R/install.R,False,True,True,False,5,5,10,"---FILE: R/install.R---
@@ -527,7 +527,7 @@ check_rtools4x_windows_toolchain <- function(fix = FALSE, quiet = FALSE) {
     if (!fix) {
       stop(
         ""\n"", rtools_version, "" installation found but the toolchain was not installed."",
-        ""\nRun check_cmdstan_toolchain(fix = TRUE) to fix the issue."",
+        ""\nRun cmdstanr::check_cmdstan_toolchain(fix = TRUE) to fix the issue."",
         call. = FALSE
       )
     } else {
@@ -615,13 +615,13 @@ check_unix_make <- function() {
         ""The 'make' tool was not found. "",
         ""Please install the command line tools for Mac with 'xcode-select --install' "",
         ""or install Xcode from the app store. "",
-        ""Then restart R and run check_cmdstan_toolchain()."",
+        ""Then restart R and run cmdstanr::check_cmdstan_toolchain()."",
         call. = FALSE
       )
     } else {
       stop(
         ""The 'make' tool was not found. "",
-        ""Please install 'make', restart R, and then run check_cmdstan_toolchain()."",
+        ""Please install 'make', restart R, and then run cmdstanr::check_cmdstan_toolchain()."",
         call. = FALSE
       )
     }
@@ -638,14 +638,14 @@ check_unix_cpp_compiler <- function() {
         ""A suitable C++ compiler was not found. "",
         ""Please install the command line tools for Mac with 'xcode-select --install' "",
         ""or install Xcode from the app store. "",
-        ""Then restart R and run check_cmdstan_toolchain()."",
+        ""Then restart R and run cmdstanr::check_cmdstan_toolchain()."",
         call. = FALSE
       )
     } else {
       stop(
         ""A C++ compiler was not found. "",
         ""Please install the 'clang++' or 'g++' compiler, restart R, "",
-        ""and run check_cmdstan_toolchain()."",
+        ""and run cmdstanr::check_cmdstan_toolchain()."",
         call. = FALSE
       )
     }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,72619e9445a44c8a4bcd086189759a6c1b63c5ee,jgabry,jgabry@gmail.com,2022-05-04T20:11:47Z,jgabry,jgabry@gmail.com,2022-05-04T20:11:47Z,"ignore other directories in .cmdstan

fixes #650",R/path.R,False,True,True,False,1,0,1,"---FILE: R/path.R---
@@ -145,6 +145,7 @@ cmdstan_default_path <- function(old = FALSE, dir = NULL) {
       cmdstan_installs <- list.dirs(path = installs_path, recursive = FALSE, full.names = FALSE)
     }
     if (length(cmdstan_installs) > 0) {
+      cmdstan_installs <- grep(""^cmdstan-"", cmdstan_installs, value = TRUE)
       latest_cmdstan <- sort(cmdstan_installs, decreasing = TRUE)[1]
       if (is_release_candidate(latest_cmdstan)) {
         non_rc_path <- strsplit(latest_cmdstan, ""-rc"")[[1]][1]",True,False,Implementation / Logic,6
stan-dev,cmdstanr,0efc7e22aaaae3e62b768e323e697a5b5af8f94b,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-23T10:55:13Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-23T10:55:13Z,fix version,NEWS.md,False,False,False,False,1,1,2,"---FILE: NEWS.md---
@@ -1,4 +1,4 @@
-# cmdstanr 0.5.1
+# cmdstanr 0.5.2
 
 * Refactored toolchain install and checks for R 4.x on Windows and added support
 for Rtools42.",False,False,Documentation / Formatting,3
stan-dev,cmdstanr,370b5bf7eab9ff0589ae66fc24234bb6aadf7fae,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-23T09:50:32Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-23T09:50:32Z,fix GHA - test coverage,.github/workflows/Test-coverage.yaml,False,False,False,False,8,8,16,"---FILE: .github/workflows/Test-coverage.yaml---
@@ -35,14 +35,6 @@ jobs:
       - uses: actions/checkout@v2
 
       - uses: r-lib/actions/setup-r@v2
-      - name: Install Rtools42
-        if: runner.os == 'Windows'
-        run: |
-          $source = 'https://cran.r-project.org/bin/windows/Rtools/rtools42/files/rtools42-5168-5107.exe'
-          $destination = './rtools42.exe'
-          Invoke-WebRequest -Uri $source -OutFile $destination
-          Start-Process -FilePath ./rtools42.exe -ArgumentList /VERYSILENT -NoNewWindow -Wait
-        shell: powershell
       - uses: r-lib/actions/setup-pandoc@v1
 
       - name: Install Ubuntu dependencies
@@ -96,6 +88,14 @@ jobs:
       - uses: r-lib/actions/setup-r@v2
         with:
           r-version: 'release'
+      - name: Install Rtools42
+        if: runner.os == 'Windows'
+        run: |
+          $source = 'https://cran.r-project.org/bin/windows/Rtools/rtools42/files/rtools42-5168-5107.exe'
+          $destination = './rtools42.exe'
+          Invoke-WebRequest -Uri $source -OutFile $destination
+          Start-Process -FilePath ./rtools42.exe -ArgumentList /VERYSILENT -NoNewWindow -Wait
+        shell: powershell
 
       - uses: r-lib/actions/setup-pandoc@v1
 ",False,False,Rendering / Conversion,3
stan-dev,cmdstanr,f88487951f58a1f34343ebeb90b5c878b75e4c36,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-23T09:35:47Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-23T09:35:47Z,fix,R/install.R,False,True,True,False,1,1,2,"---FILE: R/install.R---
@@ -685,7 +685,7 @@ is_toolchain_installed <- function(app, path) {
         ),
         repair_path(dirname(Sys.which(app)))
       )
-      if (app_path != rtools4x_toolchain_path) {
+      if (app_path != rtools4x_toolchain_path()) {
         return(FALSE)
       }
       return(TRUE)",True,False,Implementation / Logic,3
stan-dev,cmdstanr,7545c440559bad0aeb2b77664407cbe3f75e9522,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-23T09:24:08Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-23T09:24:08Z,fix,R/install.R,False,True,True,False,7,1,8,"---FILE: R/install.R---
@@ -679,7 +679,13 @@ is_toolchain_installed <- function(app, path) {
           echo = is_verbose_mode()
         )
       )
-      if (Sys.which(app) != rtools4x_toolchain_path) {
+      app_path <- withr::with_path(
+        c(
+          toolchain_PATH_env_var()
+        ),
+        repair_path(dirname(Sys.which(app)))
+      )
+      if (app_path != rtools4x_toolchain_path) {
         return(FALSE)
       }
       return(TRUE)",True,False,Implementation / Logic,3
stan-dev,cmdstanr,ff203b30bbc0155fbfec504850d7434d90e6bd3d,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-23T09:05:42Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-23T09:05:42Z,fix GHA,.github/workflows/Test-coverage.yaml;.github/workflows/cmdstan-tarball-check.yaml,False,False,False,False,2,0,2,"---FILE: .github/workflows/Test-coverage.yaml---
@@ -75,6 +75,7 @@ jobs:
 
       - name: Install cmdstan
         run: |
+          cmdstanr::check_cmdstan_toolchain(fix = TRUE)
           cmdstanr::install_cmdstan(cores = 2)
         shell: Rscript {0}
 

---FILE: .github/workflows/cmdstan-tarball-check.yaml---
@@ -87,6 +87,7 @@ jobs:
           remotes::install_deps(dependencies = TRUE)
           remotes::install_cran(""rcmdcheck"")
           remotes::install_local(path = ""."")
+          cmdstanr::check_cmdstan_toolchain(fix = TRUE)
           if (Sys.getenv(""CMDSTAN_TEST_TARBALL_URL"") == ""latest"") {
             cmdstanr::install_cmdstan(cores = 2, overwrite = TRUE)
           } else {",False,False,Data / Input Handling,3
stan-dev,cmdstanr,4aca30e60fa4a39da94fd89d59408a5d893e22de,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-23T08:56:38Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-23T08:56:38Z,fix GHA,.github/workflows/R-CMD-check.yaml;.github/workflows/Test-coverage.yaml;.github/workflows/cmdstan-tarball-check.yaml,False,False,False,False,24,2,26,"---FILE: .github/workflows/R-CMD-check.yaml---
@@ -59,7 +59,14 @@ jobs:
       - uses: r-lib/actions/setup-r@v2
         with:
           r-version: ${{ matrix.config.r }}
-
+      - name: Install Rtools42
+        if: runner.os == 'Windows'
+        run: |
+          $source = 'https://cran.r-project.org/bin/windows/Rtools/rtools42/files/rtools42-5168-5107.exe'
+          $destination = './rtools42.exe'
+          Invoke-WebRequest -Uri $source -OutFile $destination
+          Start-Process -FilePath ./rtools42.exe -ArgumentList /VERYSILENT -NoNewWindow -Wait
+        shell: powershell
       - uses: r-lib/actions/setup-pandoc@v1
 
       - name: Query dependencies

---FILE: .github/workflows/Test-coverage.yaml---
@@ -35,6 +35,14 @@ jobs:
       - uses: actions/checkout@v2
 
       - uses: r-lib/actions/setup-r@v2
+      - name: Install Rtools42
+        if: runner.os == 'Windows'
+        run: |
+          $source = 'https://cran.r-project.org/bin/windows/Rtools/rtools42/files/rtools42-5168-5107.exe'
+          $destination = './rtools42.exe'
+          Invoke-WebRequest -Uri $source -OutFile $destination
+          Start-Process -FilePath ./rtools42.exe -ArgumentList /VERYSILENT -NoNewWindow -Wait
+        shell: powershell
       - uses: r-lib/actions/setup-pandoc@v1
 
       - name: Install Ubuntu dependencies

---FILE: .github/workflows/cmdstan-tarball-check.yaml---
@@ -57,7 +57,14 @@ jobs:
       - uses: r-lib/actions/setup-r@v1
         with:
           r-version: ${{ matrix.config.r }}
-
+      - name: Install Rtools42
+        if: runner.os == 'Windows'
+        run: |
+          $source = 'https://cran.r-project.org/bin/windows/Rtools/rtools42/files/rtools42-5168-5107.exe'
+          $destination = './rtools42.exe'
+          Invoke-WebRequest -Uri $source -OutFile $destination
+          Start-Process -FilePath ./rtools42.exe -ArgumentList /VERYSILENT -NoNewWindow -Wait
+        shell: powershell
       - uses: r-lib/actions/setup-pandoc@v1
 
       - name: Query dependencies",False,False,Rendering / Conversion,3
stan-dev,cmdstanr,e54c109bcbc7dae6d7a2068678a24be5db542e4b,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-23T08:53:13Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-23T08:53:13Z,fix,R/install.R,False,True,True,False,2,4,6,"---FILE: R/install.R---
@@ -485,8 +485,7 @@ install_toolchain <- function(quiet = FALSE) {
   }
   withr::with_path(
     c(
-      toolchain_PATH_env_var(),
-      tbb_path()
+      toolchain_PATH_env_var()
     ),
     processx::run(
       ""pacman"",
@@ -669,8 +668,7 @@ is_toolchain_installed <- function(app, path) {
   res <- tryCatch({
       withr::with_path(
         c(
-          toolchain_PATH_env_var(),
-          tbb_path()
+          toolchain_PATH_env_var()
         ),
         processx::run(
           app,",True,False,Implementation / Logic,6
stan-dev,cmdstanr,e294d76bb1f1f08723327fbb57e7e75e4e075ed2,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-23T08:47:24Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-23T08:47:24Z,fix,R/install.R,False,True,True,False,1,1,2,"---FILE: R/install.R---
@@ -681,7 +681,7 @@ is_toolchain_installed <- function(app, path) {
           echo = is_verbose_mode()
         )
       )
-      if (Sys.which() != rtools4x_toolchain_path) {
+      if (Sys.which(app) != rtools4x_toolchain_path) {
         return(FALSE)
       }
       return(TRUE)",True,False,Implementation / Logic,3
stan-dev,cmdstanr,25ee0799bcdeaeef76551062690515c7fd72b393,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-23T08:31:13Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-23T08:31:13Z,fix,R/install.R,False,True,True,False,30,16,46,"---FILE: R/install.R---
@@ -483,13 +483,19 @@ install_toolchain <- function(quiet = FALSE) {
     warning(""No write permissions in the RTools folder. This might prevent installing the toolchain."",
             "" Consider changing permissions or reinstalling RTools in a different folder."", call. = FALSE)
   }
-  processx::run(
-    ""pacman"",
-    args = c(""-Sy"", install_pkgs, ""--noconfirm""),
-    wd = rtools_usr_bin,
-    error_on_status = TRUE,
-    echo_cmd = is_verbose_mode(),
-    echo = is_verbose_mode()
+  withr::with_path(
+    c(
+      toolchain_PATH_env_var(),
+      tbb_path()
+    ),
+    processx::run(
+      ""pacman"",
+      args = c(""-Sy"", install_pkgs, ""--noconfirm""),
+      wd = rtools_usr_bin,
+      error_on_status = TRUE,
+      echo_cmd = is_verbose_mode(),
+      echo = is_verbose_mode()
+    )
   )
   invisible(NULL)
 }
@@ -660,16 +666,24 @@ cmdstan_arch_suffix <- function(version = NULL) {
 }
 
 is_toolchain_installed <- function(app, path) {
-  res <- tryCatch(
-    {
-      processx::run(
-        app,
-        args = c(""--version""),
-        wd = path,
-        error_on_status = FALSE,
-        echo_cmd = is_verbose_mode(),
-        echo = is_verbose_mode()
+  res <- tryCatch({
+      withr::with_path(
+        c(
+          toolchain_PATH_env_var(),
+          tbb_path()
+        ),
+        processx::run(
+          app,
+          args = c(""--version""),
+          wd = path,
+          error_on_status = FALSE,
+          echo_cmd = is_verbose_mode(),
+          echo = is_verbose_mode()
+        )
       )
+      if (Sys.which() != rtools4x_toolchain_path) {
+        return(FALSE)
+      }
       return(TRUE)
     },
     error = function(cond) {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,0747e767df2c30004ad21f5cf482e465b04c07b2,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-18T18:23:47Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-18T18:23:47Z,fix,.github/workflows/R-CMD-check.yaml,False,False,False,False,1,1,2,"---FILE: .github/workflows/R-CMD-check.yaml---
@@ -87,7 +87,7 @@ jobs:
 
       - name: Install cmdstan
         run: |
-          print(Sys.getenv())
+          print(list.files(""C:/rtools42""))
           cmdstanr::check_cmdstan_toolchain(fix = TRUE)
           cmdstanr::install_cmdstan(cores = 2)
         shell: Rscript {0}",False,False,Data / Input Handling,3
stan-dev,cmdstanr,73dae8aead407a0a9c88c57485ad068c01ce2d1e,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-18T18:00:11Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-18T18:00:11Z,cleanup and fix home path if env var not set,.github/workflows/R-CMD-check.yaml;.github/workflows/Test-coverage.yaml;R/install.R,False,True,True,False,12,25,37,"---FILE: .github/workflows/R-CMD-check.yaml---
@@ -23,14 +23,14 @@ jobs:
       fail-fast: false
       matrix:
         config:
-          - {os: macOS-latest, r: 'devel', rtools: ''}
-          - {os: macOS-latest, r: 'release', rtools: ''}
-          - {os: windows-latest, r: 'devel', rtools: '42'}
-          - {os: windows-latest, r: 'release', rtools: '40'}
-          - {os: windows-latest, r: 'oldrel', rtools: '40'}
-          - {os: ubuntu-20.04, r: 'devel', rtools: ''}
-          - {os: ubuntu-20.04, r: 'release', rtools: ''}
-          - {os: ubuntu-20.04, r: 'oldrel', rtools: ''}
+          - {os: macOS-latest, r: 'devel'}
+          - {os: macOS-latest, r: 'release'}
+          - {os: windows-latest, r: 'devel'}
+          - {os: windows-latest, r: 'release'}
+          - {os: windows-latest, r: 'oldrel'}
+          - {os: ubuntu-20.04, r: 'devel'}
+          - {os: ubuntu-20.04, r: 'release'}
+          - {os: ubuntu-20.04, r: 'oldrel'}
     env:
       R_REMOTES_NO_ERRORS_FROM_WARNINGS: true
       GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

---FILE: .github/workflows/Test-coverage.yaml---
@@ -34,7 +34,7 @@ jobs:
         if: ""!startsWith(github.ref, 'refs/tags/') && github.ref != 'refs/heads/master'""
       - uses: actions/checkout@v2
 
-      - uses: r-lib/actions/setup-r@v1
+      - uses: r-lib/actions/setup-r@v2
       - uses: r-lib/actions/setup-pandoc@v1
 
       - name: Install Ubuntu dependencies
@@ -84,21 +84,7 @@ jobs:
     steps:
       - uses: actions/checkout@v2
 
-      - name: Set path for RTools 4.0
-        if: runner.os == 'Windows'
-        run: echo ""C:/rtools40/usr/bin;C:/rtools40/mingw64/bin"" | Out-File -Append -FilePath $env:GITHUB_PATH -Encoding utf8
-
-      - name: Install mingw32-make and check toolchain path
-        if: runner.os == 'Windows'
-        run: |
-          pacman -Syu mingw-w64-x86_64-make --noconfirm
-          g++ --version
-          Get-Command g++ | Select-Object -ExpandProperty Definition
-          mingw32-make --version
-          Get-Command mingw32-make | Select-Object -ExpandProperty Definition
-        shell: powershell
-
-      - uses: r-lib/actions/setup-r@v1
+      - uses: r-lib/actions/setup-r@v2
         with:
           r-version: 'release'
 
@@ -114,6 +100,7 @@ jobs:
         run: |
           install.packages(c(""remotes"", ""curl""), dependencies = TRUE)
           remotes::install_local(path = ""."")
+          cmdstanr::check_cmdstan_toolchain(fix = TRUE)
           cmdstanr::install_cmdstan(cores = 2, overwrite = TRUE)
           remotes::install_deps(dependencies = TRUE)
           remotes::install_cran(""covr"")

---FILE: R/install.R---
@@ -704,7 +704,7 @@ rtools4x_home_path <- function() {
   path <- NULL
   if (is_rtools42_toolchain()) {
     path <- Sys.getenv(""RTOOLS42_HOME"")
-    if (nzchar(path)) {
+    if (!nzchar(path)) {
       default_path <- repair_path(file.path(""C:/rtools42""))
       if (dir.exists(default_path)) {
         path <- default_path",True,False,Implementation / Logic,6
stan-dev,cmdstanr,54f35d6d460e218b65b47aeb87490f34f770794e,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-18T17:33:08Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-18T17:33:08Z,fix TBB path,R/install.R;R/run.R,False,True,True,False,9,5,14,"---FILE: R/install.R---
@@ -377,7 +377,7 @@ build_cmdstan <- function(dir,
   withr::with_path(
     c(
       toolchain_PATH_env_var(),
-      tbb_path()
+      tbb_path(dir = dir)
     ),
     processx::run(
       run_cmd,
@@ -399,7 +399,7 @@ clean_cmdstan <- function(dir = cmdstan_path(),
   withr::with_path(
     c(
       toolchain_PATH_env_var(),
-      tbb_path()
+      tbb_path(dir = dir)
     ),
     processx::run(
       make_cmd(),
@@ -418,7 +418,7 @@ build_example <- function(dir, cores, quiet, timeout) {
   withr::with_path(
     c(
       toolchain_PATH_env_var(),
-      tbb_path()
+      tbb_path(dir = dir)
     ),
     processx::run(
       make_cmd(),
@@ -701,6 +701,7 @@ rtools4x_toolchain_path <- function() {
 }
 
 rtools4x_home_path <- function() {
+  path <- NULL
   if (is_rtools42_toolchain()) {
     path <- Sys.getenv(""RTOOLS42_HOME"")
     if (nzchar(path)) {

---FILE: R/run.R---
@@ -1060,10 +1060,13 @@ CmdStanGQProcs <- R6::R6Class(
   )
 )
 
-tbb_path <- function() {
+tbb_path <- function(dir = NULL) {
   path_to_TBB <- NULL
   if (os_is_windows()) {
-    path_to_TBB <- file.path(cmdstan_path(), ""stan"", ""lib"", ""stan_math"", ""lib"", ""tbb"")
+    if (is.null(dir)) {
+      dir <- cmdstan_path()
+    }
+    path_to_TBB <- file.path(dir, ""stan"", ""lib"", ""stan_math"", ""lib"", ""tbb"")
   }
   path_to_TBB
 }
\ No newline at end of file",True,False,Implementation / Logic,6
stan-dev,cmdstanr,6d9c1c0f00ee0ab1e73ea69bbcbf49676e611ba3,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-18T09:00:40Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-18T09:00:40Z,syntax fix,R/install.R,False,True,True,False,1,5,6,"---FILE: R/install.R---
@@ -266,11 +266,7 @@ cmdstan_make_local <- function(dir = cmdstan_path(),
 check_cmdstan_toolchain <- function(fix = FALSE, quiet = FALSE) {
   if (os_is_windows()) {
     if (R.version$major >= ""4"") {
-      if (R.version$minor >= ""2.0"") {
-        check_rtools42_windows_toolchain(fix = fix, quiet = quiet)
-      } else {
-        check_rtools40_windows_toolchain(fix = fix, quiet = quiet)
-      }      
+      check_rtools4x_windows_toolchain(fix = fix, quiet = quiet)
     } else {
       check_rtools35_windows_toolchain(fix = fix, quiet = quiet)
     }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,b64bcbfc2e113ebf19caa7d76f08bc2f71acbd9b,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-18T08:47:06Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-18T08:47:06Z,fix tests,R/install.R;tests/testthat/test-install.R,False,True,True,False,6,23,29,"---FILE: R/install.R---
@@ -491,7 +491,8 @@ check_rtools4x_windows_toolchain <- function(fix = FALSE, quiet = FALSE) {
   # we assume that RTools 40 is not installed.
   if (!nzchar(rtools_path)) {
     stop(
-      ""\n"", rtools_version, "" was not found but is required to run CmdStan with R version 4.2+."",
+      ""\n"", rtools_version, "" was not found but is required to run CmdStan with R version "",
+      R.version$major, ""."", R.version$minor, ""."",
       ""\nPlease install "", rtools_version, "" and run check_cmdstan_toolchain()."",
       call. = FALSE
     )

---FILE: tests/testthat/test-install.R---
@@ -184,37 +184,19 @@ test_that(""toolchain checks without fixes on Windows with RTools 4.0 work"", {
   rtools40_home_backup <- Sys.getenv(""RTOOLS40_HOME"")
   Sys.setenv(""RTOOLS40_HOME"" = """")
   expect_error(
-    check_rtools40_windows_toolchain(),
-    ""\nRTools 4.0 was not found but is required to run CmdStan with R version 4.x."",
+    check_rtools4x_windows_toolchain(),
+    ""\nRtools40 was not found but is required to run CmdStan with R version"",
     fixed = TRUE
   )
 
   Sys.setenv(""RTOOLS40_HOME"" = ""C:/with spaces/"")
   expect_error(
-    check_rtools40_windows_toolchain(),
-    ""\nRTools 4.0 is installed in a path with spaces or brackets, which is not supported."",
+    check_rtools4x_windows_toolchain(),
+    ""\nRtools40 is installed in a path with spaces or brackets, which is not supported."",
     fixed = TRUE
   )
 
   Sys.setenv(""RTOOLS40_HOME"" = rtools40_home_backup)
-  path_backup <- Sys.getenv(""PATH"")
-  Sys.setenv(""PATH"" = """")
-  expect_error(
-    check_rtools40_windows_toolchain(),
-    ""\nRTools installation found but PATH was not properly set.\nRun check_cmdstan_toolchain(fix = TRUE) to fix the issue."",
-    fixed = TRUE
-  )
-
-  tmpdir <- tempdir()
-  gpp_location <- file.path(rtools40_home_backup, ""mingw64"", ""bin"", ""g++.exe"")
-  file.copy(gpp_location, file.path(tmpdir, ""g++.exe""))
-  Sys.setenv(""PATH"" = paste0(tmpdir, "";"", path_backup))
-  expect_error(
-    check_rtools40_windows_toolchain(),
-    ""\nOther C++ toolchains installed on your system conflict with RTools.\nPlease run check_cmdstan_toolchain(fix = TRUE) to fix the issue."",
-    fixed = TRUE
-  )
-  Sys.setenv(""PATH"" = path_backup)
 })
 
 test_that(""clean and rebuild works"", {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,d705074f967b15c65a73b4c5ca20c929afc8d63e,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-17T17:58:46Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-17T17:58:46Z,fix,R/install.R,False,True,True,False,12,1,13,"---FILE: R/install.R---
@@ -171,6 +171,16 @@ install_cmdstan <- function(dir = NULL,
       append = TRUE
     )
   }
+  if (is_rtools42_toolchain()) {
+    cmdstan_make_local(
+      dir = dir_cmdstan,
+      cpp_options = list(
+        ""CXXFLAGS += -Wno-nonnull"",
+        ""TBB_CXXFLAGS= -U__MSVCRT_VERSION__ -D__MSVCRT_VERSION__=0x0E00""
+      ),
+      append = TRUE
+    )
+  }
 
   message(""* Building CmdStan binaries..."")
   build_log <- build_cmdstan(dir_cmdstan, cores, quiet, timeout)
@@ -454,16 +464,17 @@ install_mingw32_make <- function(quiet = FALSE) {
     rtools_usr_bin <- file.path(Sys.getenv(""RTOOLS40_HOME""), ""usr"", ""bin"")
     rtools_version <- ""40""
     install_pkgs <- ""mingw-w64-x86_64-make""
+    if (!quiet) message(""Installing mingw32-make and writing RTools path to ~/.Renviron ..."")
   } else {
     rtools_usr_bin <- file.path(Sys.getenv(""RTOOLS42_HOME""), ""usr"", ""bin"")
     rtools_version <- ""42""
     install_pkgs <- c(""mingw-w64-ucrt-x86_64-make"", ""mingw-w64-ucrt-x86_64-gcc"")
+    if (!quiet) message(""Installing mingw32-make and g++ with RTools42."")
   }
   if (!checkmate::test_directory(rtools_usr_bin, access = ""w"")) {
     warning(""No write permissions in the RTools folder. This might prevent installing mingw32-make."",
             "" Consider changing permissions or reinstalling RTools in a different folder."", call. = FALSE)
   }
-  if (!quiet) message(""Installing mingw32-make and writing RTools path to ~/.Renviron ..."")
   processx::run(
     ""pacman"",
     args = c(""-Sy"", install_pkgs, ""--noconfirm""),",True,False,Implementation / Logic,6
stan-dev,cmdstanr,33a5b2b17e37b4dcfee80f74b53be57db4df1c25,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-17T17:42:31Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-17T17:42:31Z,fix,R/install.R;R/utils.R,False,True,True,False,12,10,22,"---FILE: R/install.R---
@@ -718,21 +718,19 @@ is_toolchain_installed <- function(app, path) {
 }
 
 rtools42_toolchain_path <- function() {
-  repair_path(file.path(rtools_path, ""ucrt64"", ""bin""))
+  repair_path(file.path(Sys.getenv(""RTOOLS42_HOME""), ""ucrt64"", ""bin""))
 }
 
 build_run_env <- function() {
   run_env <- NULL
-  if (os_is_windows()) {
-    if (R.version$major == ""4"" && R.version$minor >= ""2.0"") {
-      run_env <- c(
-        ""current"",
-        PATH = paste0(
-          rtools42_toolchain_path, "";"",
-          Sys.getenv(""PATH"")
-        )
+  if (is_rtools42_toolchain()) {
+    run_env <- c(
+      ""current"",
+      PATH = paste0(
+        rtools42_toolchain_path(), "";"",
+        Sys.getenv(""PATH"")
       )
-    }
+    )
   }
   run_env
 }
\ No newline at end of file

---FILE: R/utils.R---
@@ -45,6 +45,10 @@ os_is_macos <- function() {
   isTRUE(Sys.info()[[""sysname""]] == ""Darwin"")
 }
 
+is_rtools42_toolchain <- function() {
+  os_is_windows() && R.version$major == ""4"" && R.version$minor >= ""2.0""
+}
+
 # Check if running R in Rosetta 2 translation environment, which is an
 # Intel-to-ARM translation layer.
 is_rosetta2 <- function() {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,f1ddd4b47c6b7a968aa6091477ea324c50528fbc,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-17T16:51:21Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-17T16:51:21Z,fix,R/install.R;R/model.R;R/run.R,False,True,True,False,31,6,37,"---FILE: R/install.R---
@@ -377,7 +377,8 @@ build_cmdstan <- function(dir,
     spinner = quiet,
     error_on_status = FALSE,
     stderr_callback = function(x, p) { if (quiet) message(x) },
-    timeout = timeout
+    timeout = timeout,
+    env = build_run_env()
   )
 }
 
@@ -392,7 +393,8 @@ clean_cmdstan <- function(dir = cmdstan_path(),
     echo = !quiet || is_verbose_mode(),
     spinner = quiet,
     error_on_status = FALSE,
-    stderr_callback = function(x, p) { if (quiet) message(x) }
+    stderr_callback = function(x, p) { if (quiet) message(x) },
+    env = build_run_env()
   )
 }
 
@@ -406,7 +408,8 @@ build_example <- function(dir, cores, quiet, timeout) {
     spinner = quiet,
     error_on_status = FALSE,
     stderr_callback = function(x, p) { if (quiet) message(x) },
-    timeout = timeout
+    timeout = timeout,
+    env = build_run_env()
   )
 }
 
@@ -485,7 +488,7 @@ fix_rtools_PATH <- function() {
 check_rtools42_windows_toolchain <- function(fix = FALSE, quiet = FALSE) {
   rtools_path <- Sys.getenv(""RTOOLS42_HOME"")
   rtools_version <- ""42""
-  toolchain_path <- repair_path(file.path(rtools_path, ""ucrt64"", ""bin""))
+  toolchain_path <- rtools42_toolchain_path()
   # If RTOOLS4X_HOME is not set (the env. variable gets set on install)
   # we assume that RTools 40 is not installed.
   if (!nzchar(rtools_path)) {
@@ -712,4 +715,24 @@ is_toolchain_installed <- function(app, path) {
     }
   )
   res
+}
+
+rtools42_toolchain_path <- function() {
+  repair_path(file.path(rtools_path, ""ucrt64"", ""bin""))
+}
+
+build_run_env <- function() {
+  run_env <- NULL
+  if (os_is_windows()) {
+    if (R.version$major == ""4"" && R.version$minor >= ""2.0"") {
+      run_env <- c(
+        ""current"",
+        PATH = paste0(
+          rtools42_toolchain_path, "";"",
+          Sys.getenv(""PATH"")
+        )
+      )
+    }
+  }
+  run_env
 }
\ No newline at end of file

---FILE: R/model.R---
@@ -585,7 +585,8 @@ compile <- function(quiet = TRUE,
         )
       }
     },
-    error_on_status = FALSE
+    error_on_status = FALSE,
+    env = build_run_env()
   )
   if (is.na(run_log$status) || run_log$status != 0) {
     stop(""An error occured during compilation! See the message above for more information."",

---FILE: R/run.R---
@@ -294,7 +294,8 @@ check_target_exe <- function(exe) {
       wd = cmdstan_path(),
       echo_cmd = TRUE,
       echo = TRUE,
-      error_on_status = TRUE
+      error_on_status = TRUE,
+      env = build_run_env()
     )
   }
 }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,bf25c454870c7548dfa2a1e036d835dfb2bf9cfb,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-17T16:17:02Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-17T16:17:02Z,fix,R/install.R,False,True,True,False,1,1,2,"---FILE: R/install.R---
@@ -463,7 +463,7 @@ install_mingw32_make <- function(quiet = FALSE) {
   if (!quiet) message(""Installing mingw32-make and writing RTools path to ~/.Renviron ..."")
   processx::run(
     ""pacman"",
-    args = c(""-Syu"", install_pkgs, ""--noconfirm""),
+    args = c(""-Sy"", install_pkgs, ""--noconfirm""),
     wd = rtools_usr_bin,
     error_on_status = TRUE,
     echo_cmd = is_verbose_mode(),",True,False,Implementation / Logic,3
stan-dev,cmdstanr,2786c7bc6555c33b873561357e04d3fe11ecdb08,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-17T16:03:21Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-17T16:03:21Z,fix,R/install.R,False,True,True,False,5,1,6,"---FILE: R/install.R---
@@ -256,7 +256,11 @@ cmdstan_make_local <- function(dir = cmdstan_path(),
 check_cmdstan_toolchain <- function(fix = FALSE, quiet = FALSE) {
   if (os_is_windows()) {
     if (R.version$major >= ""4"") {
-      check_rtools4x_windows_toolchain(fix = fix, quiet = quiet)
+      if (R.version$minor >= ""2.0"") {
+        check_rtools42_windows_toolchain(fix = fix, quiet = quiet)
+      } else {
+        check_rtools40_windows_toolchain(fix = fix, quiet = quiet)
+      }      
     } else {
       check_rtools35_windows_toolchain(fix = fix, quiet = quiet)
     }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,b820b0a4ccf0309ccffe7752d8cc411561ac2ac3,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-17T15:16:52Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-17T15:16:52Z,fix,R/install.R,False,True,True,False,52,25,77,"---FILE: R/install.R---
@@ -442,8 +442,6 @@ build_status_ok <- function(process_log, quiet = FALSE) {
   TRUE
 }
 
-
-
 install_mingw32_make <- function(quiet = FALSE) {
   if (R.version$minor < ""2.0"") {
     rtools_usr_bin <- file.path(Sys.getenv(""RTOOLS40_HOME""), ""usr"", ""bin"")
@@ -480,23 +478,54 @@ fix_rtools_PATH <- function() {
   }
 }
 
-check_rtools4x_windows_toolchain <- function(fix = FALSE, quiet = FALSE) {
-  if (R.version$minor < ""2.0"") {
-    rtools_path <- Sys.getenv(""RTOOLS40_HOME"")
-    rtools_version <- ""40""
-    gpp_expected_path <- repair_path(file.path(rtools_path, ""mingw64"", ""bin""))
-    mingw32_expected_path <- repair_path(file.path(rtools_path, ""mingw64"", ""bin""))
-  } else {
-    rtools_path <- Sys.getenv(""RTOOLS42_HOME"")
-    rtools_version <- ""42""
-    gpp_expected_path <- repair_path(file.path(rtools_path, ""ucrt64"", ""bin""))
-    mingw32_expected_path <- gpp_expected_path
-  }
+check_rtools42_windows_toolchain <- function(fix = FALSE, quiet = FALSE) {
+  rtools_path <- Sys.getenv(""RTOOLS42_HOME"")
+  rtools_version <- ""42""
+  toolchain_path <- repair_path(file.path(rtools_path, ""ucrt64"", ""bin""))
   # If RTOOLS4X_HOME is not set (the env. variable gets set on install)
   # we assume that RTools 40 is not installed.
   if (!nzchar(rtools_path)) {
     stop(
-      ""\nRTools"", rtools_version, "" was not found but is required to run CmdStan with R version 4.x."",
+      ""\nRTools42 was not found but is required to run CmdStan with R version 4.2+."",
+      ""\nPlease install RTools42 and run check_cmdstan_toolchain()."",
+      call. = FALSE
+    )
+  }
+  # If RTools is installed in a path with spaces or brackets
+  # we error as this path is not valid
+  if (grepl(""\\(|)| "", rtools_path)) {
+    stop(
+      ""\nRTools42 is installed in a path with spaces or brackets, which is not supported."",
+      ""\nPlease reinstall RTools42 to a valid path, restart R, and then run check_cmdstan_toolchain()."",
+      call. = FALSE
+    )
+  }
+  if (!is_toolchain_installed(app = ""g++"", path = toolchain_path) ||
+      !is_toolchain_installed(app = ""mingw32-make"", path = toolchain_path)) {
+    if (!fix) {
+      stop(
+        ""\nRTools installation found but mingw32-make or g++ not installed."",
+        ""\nRun check_cmdstan_toolchain(fix = TRUE) to fix the issue."",
+        call. = FALSE
+      )
+    } else {
+      install_mingw32_make(quiet = quiet)
+      check_rtools42_windows_toolchain(fix = FALSE, quiet = quiet)
+      return(invisible(NULL))
+    }
+  }
+}
+
+check_rtools40_windows_toolchain <- function(fix = FALSE, quiet = FALSE) {
+  rtools_path <- Sys.getenv(""RTOOLS40_HOME"")
+  rtools_version <- ""40""
+  gpp_expected_path <- repair_path(file.path(rtools_path, ""mingw64"", ""bin""))
+  mingw32_expected_path <- repair_path(file.path(rtools_path, ""mingw64"", ""bin""))
+  # If RTOOLS40_HOME is not set (the env. variable gets set on install)
+  # we assume that RTools 40 is not installed.
+  if (!nzchar(rtools_path)) {
+    stop(
+      ""\nRTools 4.0 was not found but is required to run CmdStan with R version 4.x."",
       ""\nPlease install RTools 4.0 and run check_cmdstan_toolchain()."",
       call. = FALSE
     )
@@ -505,30 +534,28 @@ check_rtools4x_windows_toolchain <- function(fix = FALSE, quiet = FALSE) {
   # we error as this path is not valid
   if (grepl(""\\(|)| "", rtools_path)) {
     stop(
-      ""\nRTools"", rtools_version, "" is installed in a path with spaces or brackets, which is not supported."",
-      ""\nPlease reinstall RTools"", rtools_version, "" to a valid path, restart R, and then run check_cmdstan_toolchain()."",
+      ""\nRTools 4.0 is installed in a path with spaces or brackets, which is not supported."",
+      ""\nPlease reinstall RTools 4.0 to a valid path, restart R, and then run check_cmdstan_toolchain()."",
       call. = FALSE
     )
   }
-  if (!is_mingw32_make_installed(path = mingw32_expected_path)) {
+  if (!is_toolchain_installed(app = ""mingw32-make"", path = mingw32_expected_path)) {
     if (!fix) {
       stop(
         ""\nRTools installation found but mingw32-make is not installed."",
         ""\nRun check_cmdstan_toolchain(fix = TRUE) to fix the issue."",
         call. = FALSE
       )
     } else {
-      print(""install"")
       install_mingw32_make(quiet = quiet)
       fix_rtools_PATH()
-      print(""install-over"")
-      #check_rtools4x_windows_toolchain(fix = FALSE, quiet = quiet)
+      check_rtools40_windows_toolchain(fix = FALSE, quiet = quiet)
       return(invisible(NULL))
     }
   }
   mingw32_make_path <- repair_path(normalizePath(dirname(Sys.which(""mingw32-make""))))
   gpp_path <- repair_path(normalizePath(dirname(Sys.which(""g++""))))
-  # Check if the mingw32-make and g++ get picked up by default are the RTools-supplied ones
+  # Check if the mingw32-make and g++ get picked up by default and are the RTools-supplied ones
   if (mingw32_make_path != mingw32_expected_path || gpp_path != gpp_expected_path) {
     if (!fix) {
       stop(
@@ -538,7 +565,7 @@ check_rtools4x_windows_toolchain <- function(fix = FALSE, quiet = FALSE) {
       )
     } else {
       fix_rtools_PATH()
-      check_rtools4x_windows_toolchain(fix = FALSE, quiet = quiet)
+      check_rtools40_windows_toolchain(fix = FALSE, quiet = quiet)
       return(invisible(NULL))
     }
   }
@@ -663,11 +690,11 @@ cmdstan_arch_suffix <- function(version = NULL) {
   arch
 }
 
-is_mingw32_make_installed <- function(path) {
+is_toolchain_installed <- function(app, path) {
   res <- tryCatch(
     {
       processx::run(
-        ""mingw32-make"",
+        app,
         args = c(""--version""),
         wd = path,
         error_on_status = FALSE,",True,False,Implementation / Logic,6
stan-dev,cmdstanr,0bb02334644e7b651c12fcf699b6a9b27b9dca0b,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-17T14:36:45Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-17T14:36:45Z,fix,R/install.R,False,True,True,False,4,3,7,"---FILE: R/install.R---
@@ -454,7 +454,6 @@ install_mingw32_make <- function(quiet = FALSE) {
     rtools_version <- ""42""
     install_pkgs <- c(""mingw-w64-ucrt-x86_64-make"", ""mingw-w64-ucrt-x86_64-gcc"")
   }
-  
   if (!checkmate::test_directory(rtools_usr_bin, access = ""w"")) {
     warning(""No write permissions in the RTools folder. This might prevent installing mingw32-make."",
             "" Consider changing permissions or reinstalling RTools in a different folder."", call. = FALSE)
@@ -491,7 +490,7 @@ check_rtools4x_windows_toolchain <- function(fix = FALSE, quiet = FALSE) {
     rtools_path <- Sys.getenv(""RTOOLS42_HOME"")
     rtools_version <- ""42""
     gpp_expected_path <- repair_path(file.path(rtools_path, ""ucrt64"", ""bin""))
-    mingw32_expected_path <- repair_path(file.path(rtools_path, ""ucrt64"", ""bin""))
+    mingw32_expected_path <- gpp_expected_path
   }
   # If RTOOLS4X_HOME is not set (the env. variable gets set on install)
   # we assume that RTools 40 is not installed.
@@ -519,9 +518,11 @@ check_rtools4x_windows_toolchain <- function(fix = FALSE, quiet = FALSE) {
         call. = FALSE
       )
     } else {
+      print(""install"")
       install_mingw32_make(quiet = quiet)
       fix_rtools_PATH()
-      check_rtools4x_windows_toolchain(fix = FALSE, quiet = quiet)
+      print(""install-over"")
+      #check_rtools4x_windows_toolchain(fix = FALSE, quiet = quiet)
       return(invisible(NULL))
     }
   }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,e5558a90f80964b8f4a48bf60dbbe9139cfeba7c,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-17T14:29:04Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-17T14:29:04Z,fix,R/install.R,False,True,True,False,1,1,2,"---FILE: R/install.R---
@@ -452,7 +452,7 @@ install_mingw32_make <- function(quiet = FALSE) {
   } else {
     rtools_usr_bin <- file.path(Sys.getenv(""RTOOLS42_HOME""), ""usr"", ""bin"")
     rtools_version <- ""42""
-    install_pks <- c(""mingw-w64-ucrt-x86_64-make"", ""mingw-w64-ucrt-x86_64-gcc"")
+    install_pkgs <- c(""mingw-w64-ucrt-x86_64-make"", ""mingw-w64-ucrt-x86_64-gcc"")
   }
   
   if (!checkmate::test_directory(rtools_usr_bin, access = ""w"")) {",True,False,Environment / Configuration,3
stan-dev,cmdstanr,38d60aec76218b8ef6cd90b4d9c56cd6548f6da2,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-17T14:27:31Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-17T14:27:31Z,fix,R/install.R,False,True,True,False,2,1,3,"---FILE: R/install.R---
@@ -486,12 +486,13 @@ check_rtools4x_windows_toolchain <- function(fix = FALSE, quiet = FALSE) {
     rtools_path <- Sys.getenv(""RTOOLS40_HOME"")
     rtools_version <- ""40""
     gpp_expected_path <- repair_path(file.path(rtools_path, ""mingw64"", ""bin""))
+    mingw32_expected_path <- repair_path(file.path(rtools_path, ""mingw64"", ""bin""))
   } else {
     rtools_path <- Sys.getenv(""RTOOLS42_HOME"")
     rtools_version <- ""42""
     gpp_expected_path <- repair_path(file.path(rtools_path, ""ucrt64"", ""bin""))
+    mingw32_expected_path <- repair_path(file.path(rtools_path, ""ucrt64"", ""bin""))
   }
-  mingw32_expected_path <- repair_path(file.path(rtools_path, ""mingw64"", ""bin""))
   # If RTOOLS4X_HOME is not set (the env. variable gets set on install)
   # we assume that RTools 40 is not installed.
   if (!nzchar(rtools_path)) {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,f5774216bc0932b78f506b4d0c44d2361b02e29c,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-17T14:21:09Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-17T14:21:09Z,fix,R/install.R,False,True,True,False,7,5,12,"---FILE: R/install.R---
@@ -448,9 +448,11 @@ install_mingw32_make <- function(quiet = FALSE) {
   if (R.version$minor < ""2.0"") {
     rtools_usr_bin <- file.path(Sys.getenv(""RTOOLS40_HOME""), ""usr"", ""bin"")
     rtools_version <- ""40""
+    install_pkgs <- ""mingw-w64-x86_64-make""
   } else {
     rtools_usr_bin <- file.path(Sys.getenv(""RTOOLS42_HOME""), ""usr"", ""bin"")
     rtools_version <- ""42""
+    install_pks <- c(""mingw-w64-ucrt-x86_64-make"", ""mingw-w64-ucrt-x86_64-gcc"")
   }
   
   if (!checkmate::test_directory(rtools_usr_bin, access = ""w"")) {
@@ -460,12 +462,12 @@ install_mingw32_make <- function(quiet = FALSE) {
   if (!quiet) message(""Installing mingw32-make and writing RTools path to ~/.Renviron ..."")
   processx::run(
     ""pacman"",
-    args = c(""-Syu"", ""mingw-w64-x86_64-make"", ""--noconfirm""),
+    args = c(""-Syu"", install_pkgs, ""--noconfirm""),
     wd = rtools_usr_bin,
     error_on_status = TRUE,
     echo_cmd = is_verbose_mode(),
     echo = is_verbose_mode()
-  )  
+  )
   invisible(NULL)
 }
 
@@ -474,8 +476,8 @@ fix_rtools_PATH <- function() {
     write('PATH=""${RTOOLS40_HOME}\\usr\\bin;${RTOOLS40_HOME}\\mingw64\\bin;${PATH}""', file = ""~/.Renviron"", append = TRUE)
     Sys.setenv(PATH = paste0(Sys.getenv(""RTOOLS40_HOME""), ""\\usr\\bin;"", Sys.getenv(""RTOOLS40_HOME""), ""\\mingw64\\bin;"", Sys.getenv(""PATH"")))
   } else {
-    write('PATH=""${RTOOLS42_HOME}\\usr\\bin;${RTOOLS42_HOME}\\mingw64\\bin;${PATH}""', file = ""~/.Renviron"", append = TRUE)
-    Sys.setenv(PATH = paste0(Sys.getenv(""RTOOLS42_HOME""), ""\\usr\\bin;"", Sys.getenv(""RTOOLS42_HOME""), ""\\mingw64\\bin;"", Sys.getenv(""PATH"")))
+    write('PATH=""${RTOOLS42_HOME}\\usr\\bin;${RTOOLS42_HOME}\\ucrt64\\bin;${PATH}""', file = ""~/.Renviron"", append = TRUE)
+    Sys.setenv(PATH = paste0(Sys.getenv(""RTOOLS42_HOME""), ""\\usr\\bin;"", Sys.getenv(""RTOOLS42_HOME""), ""\\ucrt64\\bin;"", Sys.getenv(""PATH"")))
   }
 }
 
@@ -487,7 +489,7 @@ check_rtools4x_windows_toolchain <- function(fix = FALSE, quiet = FALSE) {
   } else {
     rtools_path <- Sys.getenv(""RTOOLS42_HOME"")
     rtools_version <- ""42""
-    gpp_expected_path <- repair_path(file.path(rtools_path, ""x86_64-w64-mingw32.static.posix"", ""bin""))
+    gpp_expected_path <- repair_path(file.path(rtools_path, ""ucrt64"", ""bin""))
   }
   mingw32_expected_path <- repair_path(file.path(rtools_path, ""mingw64"", ""bin""))
   # If RTOOLS4X_HOME is not set (the env. variable gets set on install)",True,False,Implementation / Logic,6
stan-dev,cmdstanr,1719851e1f8743a53b5ab5b3e656bc1aab9fbf33,jgabry,jgabry@gmail.com,2022-04-13T19:31:09Z,jgabry,jgabry@gmail.com,2022-04-13T19:31:09Z,fix printing after overwriting file,R/model.R;man/cmdstan_model.Rd;vignettes/deprecations.Rmd,True,True,True,False,5,3,8,"---FILE: R/model.R---
@@ -912,9 +912,11 @@ format <- function(overwrite_file = FALSE,
       }
     }
     out_file <- self$stan_file()
-    private$stan_code_ <- run_log$stdout
   }
   cat(run_log$stdout, file = out_file, sep = ""\n"")
+  if (isTRUE(overwrite_file)) {
+    private$stan_code_ <- readLines(self$stan_file())
+  }
 
   invisible(TRUE)
 }

---FILE: man/cmdstan_model.Rd---
@@ -31,7 +31,7 @@ more. See \code{\link[=model-method-compile]{$compile()}} for details.}
 A \code{\link{CmdStanModel}} object.
 }
 \description{
-\if{html}{\figure{logo.png}{options: width=""25""}}
+\if{html}{\figure{logo.png}{options: width=""25px""}}
 Create a new \code{\link{CmdStanModel}} object from a file containing a Stan program
 or from an existing Stan executable. The \code{\link{CmdStanModel}} object stores the
 path to a Stan program and compiled executable (once created), and provides

---FILE: vignettes/deprecations.Rmd---
@@ -119,7 +119,7 @@ model directly to the Stan model file. That can be enabled by setting
 `overwrite_file = TRUE`. The previous version of the file will automatically
 be backed up to a file with the `.stan.bak` suffix. If that is not desired or 
 you are using a version system and making a backup is redundant, 
-you can disable it by setting `backup = FALSE`:
+you can disable it by setting `backup = FALSE`.
 
 ```{r overwrite_file}
 mod$format(",True,True,Rendering / Conversion,6
stan-dev,cmdstanr,2608377a476fb9888039ea716a70de52aec5920c,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-04T08:56:32Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-04T08:56:32Z,fix,R/install.R,False,True,True,False,2,6,8,"---FILE: R/install.R---
@@ -522,12 +522,8 @@ check_rtools4x_windows_toolchain <- function(fix = FALSE, quiet = FALSE) {
       return(invisible(NULL))
     }
   }
-  mingw32_make_path <- normalizePath(dirname(Sys.which(""mingw32-make"")))
-  gpp_path <- normalizePath(dirname(Sys.which(""g++"")))
-  print(gpp_expected_path)
-  print(gpp_path)
-  print(mingw32_expected_path)
-  print(mingw32_make_path)
+  mingw32_make_path <- repair_path(normalizePath(dirname(Sys.which(""mingw32-make""))))
+  gpp_path <- repair_path(normalizePath(dirname(Sys.which(""g++""))))
   # Check if the mingw32-make and g++ get picked up by default are the RTools-supplied ones
   if (mingw32_make_path != mingw32_expected_path || gpp_path != gpp_expected_path) {
     if (!fix) {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,202a4134efd247a5b2f86d66aa2e9b2b6f987100,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-04T08:54:30Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-04T08:54:30Z,fix,R/install.R,False,True,True,False,5,1,6,"---FILE: R/install.R---
@@ -483,7 +483,7 @@ check_rtools4x_windows_toolchain <- function(fix = FALSE, quiet = FALSE) {
   if (R.version$minor < ""2.0"") {
     rtools_path <- Sys.getenv(""RTOOLS40_HOME"")
     rtools_version <- ""40""
-    gpp_expected_path <- mingw32_expected_path
+    gpp_expected_path <- repair_path(file.path(rtools_path, ""mingw64"", ""bin""))
   } else {
     rtools_path <- Sys.getenv(""RTOOLS42_HOME"")
     rtools_version <- ""42""
@@ -524,6 +524,10 @@ check_rtools4x_windows_toolchain <- function(fix = FALSE, quiet = FALSE) {
   }
   mingw32_make_path <- normalizePath(dirname(Sys.which(""mingw32-make"")))
   gpp_path <- normalizePath(dirname(Sys.which(""g++"")))
+  print(gpp_expected_path)
+  print(gpp_path)
+  print(mingw32_expected_path)
+  print(mingw32_make_path)
   # Check if the mingw32-make and g++ get picked up by default are the RTools-supplied ones
   if (mingw32_make_path != mingw32_expected_path || gpp_path != gpp_expected_path) {
     if (!fix) {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,2ef5dcc22ebd129740814e83def49c8a9a3358a9,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-04T07:30:59Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-04T07:30:59Z,fix,R/install.R,False,True,True,False,23,16,39,"---FILE: R/install.R---
@@ -483,10 +483,13 @@ check_rtools4x_windows_toolchain <- function(fix = FALSE, quiet = FALSE) {
   if (R.version$minor < ""2.0"") {
     rtools_path <- Sys.getenv(""RTOOLS40_HOME"")
     rtools_version <- ""40""
+    gpp_expected_path <- mingw32_expected_path
   } else {
     rtools_path <- Sys.getenv(""RTOOLS42_HOME"")
     rtools_version <- ""42""
+    gpp_expected_path <- repair_path(file.path(rtools_path, ""x86_64-w64-mingw32.static.posix"", ""bin""))
   }
+  mingw32_expected_path <- repair_path(file.path(rtools_path, ""mingw64"", ""bin""))
   # If RTOOLS4X_HOME is not set (the env. variable gets set on install)
   # we assume that RTools 40 is not installed.
   if (!nzchar(rtools_path)) {
@@ -505,8 +508,7 @@ check_rtools4x_windows_toolchain <- function(fix = FALSE, quiet = FALSE) {
       call. = FALSE
     )
   }
-  toolchain_path <- repair_path(file.path(rtools_path, ""mingw64"", ""bin""))
-  if (!is_mingw32_make_installed(path = toolchain_path)) {
+  if (!is_mingw32_make_installed(path = mingw32_expected_path)) {
     if (!fix) {
       stop(
         ""\nRTools installation found but mingw32-make is not installed."",
@@ -520,13 +522,10 @@ check_rtools4x_windows_toolchain <- function(fix = FALSE, quiet = FALSE) {
       return(invisible(NULL))
     }
   }
-  mingw32_make_path <- dirname(Sys.which(""mingw32-make""))
-  print(toolchain_path)
-  print(mingw32_make_path)
-  gpp_path <- dirname(Sys.which(""g++""))
-  print(gpp_path)
+  mingw32_make_path <- normalizePath(dirname(Sys.which(""mingw32-make"")))
+  gpp_path <- normalizePath(dirname(Sys.which(""g++"")))
   # Check if the mingw32-make and g++ get picked up by default are the RTools-supplied ones
-  if (toolchain_path != mingw32_make_path || gpp_path != toolchain_path) {
+  if (mingw32_make_path != mingw32_expected_path || gpp_path != gpp_expected_path) {
     if (!fix) {
       stop(
         ""\nOther C++ toolchains installed on your system conflict with RTools."",
@@ -661,13 +660,21 @@ cmdstan_arch_suffix <- function(version = NULL) {
 }
 
 is_mingw32_make_installed <- function(path) {
-  res <- processx::run(
-    ""mingw32-make"",
-    args = c(""--version""),
-    wd = path,
-    error_on_status = FALSE,
-    echo_cmd = is_verbose_mode(),
-    echo = is_verbose_mode()
+  res <- tryCatch(
+    {
+      processx::run(
+        ""mingw32-make"",
+        args = c(""--version""),
+        wd = path,
+        error_on_status = FALSE,
+        echo_cmd = is_verbose_mode(),
+        echo = is_verbose_mode()
+      )
+      return(TRUE)
+    },
+    error = function(cond) {
+      return(FALSE)
+    }
   )
-  res$status == 0
+  res
 }
\ No newline at end of file",True,False,Implementation / Logic,6
stan-dev,cmdstanr,efac7f27bfa44fe07d26936917ab173a705488e2,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-03T17:49:14Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-03T17:49:14Z,fix,R/install.R,False,True,True,False,1,2,3,"---FILE: R/install.R---
@@ -524,7 +524,7 @@ check_rtools4x_windows_toolchain <- function(fix = FALSE, quiet = FALSE) {
   print(toolchain_path)
   print(mingw32_make_path)
   gpp_path <- dirname(Sys.which(""g++""))
-  print(gpp_path != toolchain_path)
+  print(gpp_path)
   # Check if the mingw32-make and g++ get picked up by default are the RTools-supplied ones
   if (toolchain_path != mingw32_make_path || gpp_path != toolchain_path) {
     if (!fix) {
@@ -669,6 +669,5 @@ is_mingw32_make_installed <- function(path) {
     echo_cmd = is_verbose_mode(),
     echo = is_verbose_mode()
   )
-  print(res$status)
   res$status == 0
 }
\ No newline at end of file",True,False,Implementation / Logic,6
stan-dev,cmdstanr,9fec53b589f65c54adda479ecfcd9e1e1d8c03a5,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-03T17:44:54Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-03T17:44:54Z,fix,R/install.R,False,True,True,False,2,1,3,"---FILE: R/install.R---
@@ -521,7 +521,8 @@ check_rtools4x_windows_toolchain <- function(fix = FALSE, quiet = FALSE) {
     }
   }
   mingw32_make_path <- dirname(Sys.which(""mingw32-make""))
-  print(toolchain_path != mingw32_make_path)
+  print(toolchain_path)
+  print(mingw32_make_path)
   gpp_path <- dirname(Sys.which(""g++""))
   print(gpp_path != toolchain_path)
   # Check if the mingw32-make and g++ get picked up by default are the RTools-supplied ones",True,False,Implementation / Logic,6
stan-dev,cmdstanr,f1e81c44580530d997f1df5f1240a1e85ff95628,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-03T17:43:04Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-03T17:43:04Z,fix,R/install.R,False,True,True,False,2,2,4,"---FILE: R/install.R---
@@ -514,16 +514,16 @@ check_rtools4x_windows_toolchain <- function(fix = FALSE, quiet = FALSE) {
         call. = FALSE
       )
     } else {
-      print(""Installing"")
       install_mingw32_make(quiet = quiet)
       fix_rtools_PATH()
       check_rtools4x_windows_toolchain(fix = FALSE, quiet = quiet)
       return(invisible(NULL))
     }
   }
   mingw32_make_path <- dirname(Sys.which(""mingw32-make""))
-  print(mingw32_make_path)
+  print(toolchain_path != mingw32_make_path)
   gpp_path <- dirname(Sys.which(""g++""))
+  print(gpp_path != toolchain_path)
   # Check if the mingw32-make and g++ get picked up by default are the RTools-supplied ones
   if (toolchain_path != mingw32_make_path || gpp_path != toolchain_path) {
     if (!fix) {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,84716e88b98c793fd8610bd16d626273a577ac8c,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-03T17:07:11Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-03T17:07:11Z,fix,R/install.R,False,True,True,False,3,0,3,"---FILE: R/install.R---
@@ -514,13 +514,15 @@ check_rtools4x_windows_toolchain <- function(fix = FALSE, quiet = FALSE) {
         call. = FALSE
       )
     } else {
+      print(""Installing"")
       install_mingw32_make(quiet = quiet)
       fix_rtools_PATH()
       check_rtools4x_windows_toolchain(fix = FALSE, quiet = quiet)
       return(invisible(NULL))
     }
   }
   mingw32_make_path <- dirname(Sys.which(""mingw32-make""))
+  print(mingw32_make_path)
   gpp_path <- dirname(Sys.which(""g++""))
   # Check if the mingw32-make and g++ get picked up by default are the RTools-supplied ones
   if (toolchain_path != mingw32_make_path || gpp_path != toolchain_path) {
@@ -666,5 +668,6 @@ is_mingw32_make_installed <- function(path) {
     echo_cmd = is_verbose_mode(),
     echo = is_verbose_mode()
   )
+  print(res$status)
   res$status == 0
 }
\ No newline at end of file",True,False,Implementation / Logic,6
stan-dev,cmdstanr,8aec7e4acddcc50f3940c8ad383212783d6c1651,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-03T17:04:19Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-03T17:04:19Z,fix,R/install.R,False,True,True,False,3,1,4,"---FILE: R/install.R---
@@ -519,7 +519,9 @@ check_rtools4x_windows_toolchain <- function(fix = FALSE, quiet = FALSE) {
       check_rtools4x_windows_toolchain(fix = FALSE, quiet = quiet)
       return(invisible(NULL))
     }
-  } 
+  }
+  mingw32_make_path <- dirname(Sys.which(""mingw32-make""))
+  gpp_path <- dirname(Sys.which(""g++""))
   # Check if the mingw32-make and g++ get picked up by default are the RTools-supplied ones
   if (toolchain_path != mingw32_make_path || gpp_path != toolchain_path) {
     if (!fix) {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,7d9a4c4ece1c47d1317c7311bbf50e4a29d07d84,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-03T17:00:14Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-03T17:00:14Z,fix,R/install.R,False,True,True,False,3,3,6,"---FILE: R/install.R---
@@ -469,7 +469,7 @@ install_mingw32_make <- function(quiet = FALSE) {
   invisible(NULL)
 }
 
-fix_PATH <- function() {
+fix_rtools_PATH <- function() {
   if (R.version$minor < ""2.0"") {
     write('PATH=""${RTOOLS40_HOME}\\usr\\bin;${RTOOLS40_HOME}\\mingw64\\bin;${PATH}""', file = ""~/.Renviron"", append = TRUE)
     Sys.setenv(PATH = paste0(Sys.getenv(""RTOOLS40_HOME""), ""\\usr\\bin;"", Sys.getenv(""RTOOLS40_HOME""), ""\\mingw64\\bin;"", Sys.getenv(""PATH"")))
@@ -515,7 +515,7 @@ check_rtools4x_windows_toolchain <- function(fix = FALSE, quiet = FALSE) {
       )
     } else {
       install_mingw32_make(quiet = quiet)
-      fix_PATH()
+      fix_rtools_PATH()
       check_rtools4x_windows_toolchain(fix = FALSE, quiet = quiet)
       return(invisible(NULL))
     }
@@ -529,7 +529,7 @@ check_rtools4x_windows_toolchain <- function(fix = FALSE, quiet = FALSE) {
         call. = FALSE
       )
     } else {
-      fix_PATH()
+      fix_rtools_PATH()
       check_rtools4x_windows_toolchain(fix = FALSE, quiet = quiet)
       return(invisible(NULL))
     }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,9b861a2650eca8b3ccfad3f237fec057ce20c714,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-03T16:59:38Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-03T16:59:38Z,fix,R/install.R,False,True,True,False,10,20,30,"---FILE: R/install.R---
@@ -465,15 +465,18 @@ install_mingw32_make <- function(quiet = FALSE) {
     error_on_status = TRUE,
     echo_cmd = is_verbose_mode(),
     echo = is_verbose_mode()
-  )
+  )  
+  invisible(NULL)
+}
+
+fix_PATH <- function() {
   if (R.version$minor < ""2.0"") {
     write('PATH=""${RTOOLS40_HOME}\\usr\\bin;${RTOOLS40_HOME}\\mingw64\\bin;${PATH}""', file = ""~/.Renviron"", append = TRUE)
     Sys.setenv(PATH = paste0(Sys.getenv(""RTOOLS40_HOME""), ""\\usr\\bin;"", Sys.getenv(""RTOOLS40_HOME""), ""\\mingw64\\bin;"", Sys.getenv(""PATH"")))
   } else {
     write('PATH=""${RTOOLS42_HOME}\\usr\\bin;${RTOOLS42_HOME}\\mingw64\\bin;${PATH}""', file = ""~/.Renviron"", append = TRUE)
     Sys.setenv(PATH = paste0(Sys.getenv(""RTOOLS42_HOME""), ""\\usr\\bin;"", Sys.getenv(""RTOOLS42_HOME""), ""\\mingw64\\bin;"", Sys.getenv(""PATH"")))
-  }  
-  invisible(NULL)
+  }
 }
 
 check_rtools4x_windows_toolchain <- function(fix = FALSE, quiet = FALSE) {
@@ -512,24 +515,11 @@ check_rtools4x_windows_toolchain <- function(fix = FALSE, quiet = FALSE) {
       )
     } else {
       install_mingw32_make(quiet = quiet)
+      fix_PATH()
       check_rtools4x_windows_toolchain(fix = FALSE, quiet = quiet)
+      return(invisible(NULL))
     }
-  } else {
-    mingw32_make_path <- dirname(Sys.which(""mingw32-make""))
-    gpp_path <- dirname(Sys.which(""g++""))
-    if (!nzchar(mingw32_make_path) || !nzchar(gpp_path)) {
-      if (!fix) {
-        stop(
-          ""\nRTools installation found but PATH was not properly set."",
-          ""\nRun check_cmdstan_toolchain(fix = TRUE) to fix the issue."",
-          call. = FALSE
-        )
-      } else {      
-        check_rtools4x_windows_toolchain(fix = FALSE, quiet = quiet)
-        return(invisible(NULL))
-      }
-    }
-  }  
+  } 
   # Check if the mingw32-make and g++ get picked up by default are the RTools-supplied ones
   if (toolchain_path != mingw32_make_path || gpp_path != toolchain_path) {
     if (!fix) {
@@ -539,7 +529,7 @@ check_rtools4x_windows_toolchain <- function(fix = FALSE, quiet = FALSE) {
         call. = FALSE
       )
     } else {
-      install_mingw32_make(quiet = quiet)
+      fix_PATH()
       check_rtools4x_windows_toolchain(fix = FALSE, quiet = quiet)
       return(invisible(NULL))
     }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,0130a9058eb89b76e0bca02b839e5a5d12684266,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-03T16:55:16Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-03T16:55:16Z,fix,R/install.R,False,True,True,False,1,1,2,"---FILE: R/install.R---
@@ -506,7 +506,7 @@ check_rtools4x_windows_toolchain <- function(fix = FALSE, quiet = FALSE) {
   if (!is_mingw32_make_installed(path = toolchain_path)) {
     if (!fix) {
       stop(
-        ""\nRTools installation found but mingw32-make is missing."",
+        ""\nRTools installation found but mingw32-make is not installed."",
         ""\nRun check_cmdstan_toolchain(fix = TRUE) to fix the issue."",
         call. = FALSE
       )",True,False,Implementation / Logic,6
stan-dev,cmdstanr,4dedbcb1d7c1adc35d38ea6fd1bbcd708c60352f,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-03T16:25:57Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-03T16:25:57Z,fix,R/install.R,False,True,True,False,1,1,2,"---FILE: R/install.R---
@@ -503,7 +503,7 @@ check_rtools4x_windows_toolchain <- function(fix = FALSE, quiet = FALSE) {
     )
   }
   toolchain_path <- repair_path(file.path(rtools_path, ""mingw64"", ""bin""))
-  if (is_mingw32_make_installed(path = toolchain_path)) {
+  if (!is_mingw32_make_installed(path = toolchain_path)) {
     if (!fix) {
       stop(
         ""\nRTools installation found but mingw32-make is missing."",",True,False,Implementation / Logic,6
stan-dev,cmdstanr,981ef3646eca49190e30483fa0dc194aba7e566a,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-03T16:22:20Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-03T16:22:20Z,fix,R/install.R,False,True,True,False,1,1,2,"---FILE: R/install.R---
@@ -665,7 +665,7 @@ cmdstan_arch_suffix <- function(version = NULL) {
   arch
 }
 
-is_mingw32_make_installed(path) {
+is_mingw32_make_installed <- function(path) {
   res <- processx::run(
     ""mingw32-make"",
     args = c(""--version""),",True,False,Implementation / Logic,6
stan-dev,cmdstanr,f36eefcb26351a82cf7b5cb965bc14f25e34bce6,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-03T16:21:41Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-03T16:21:41Z,fix,R/install.R,False,True,True,False,3,2,5,"---FILE: R/install.R---
@@ -668,10 +668,11 @@ cmdstan_arch_suffix <- function(version = NULL) {
 is_mingw32_make_installed(path) {
   res <- processx::run(
     ""mingw32-make"",
-    args = c(""--versiSyu"", ""mingw-w64-x86_64-make"", ""--noconfirm""),
-    wd = rtools_usr_bin,
+    args = c(""--version""),
+    wd = path,
     error_on_status = FALSE,
     echo_cmd = is_verbose_mode(),
     echo = is_verbose_mode()
   )
+  res$status == 0
 }
\ No newline at end of file",True,False,Implementation / Logic,6
stan-dev,cmdstanr,b845a666560efab8f629d0e7a48befd524729038,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-03T16:17:58Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-03T16:17:58Z,fix,R/install.R,False,True,True,False,29,6,35,"---FILE: R/install.R---
@@ -503,21 +503,33 @@ check_rtools4x_windows_toolchain <- function(fix = FALSE, quiet = FALSE) {
     )
   }
   toolchain_path <- repair_path(file.path(rtools_path, ""mingw64"", ""bin""))
-  mingw32_make_path <- dirname(Sys.which(""mingw32-make""))
-  gpp_path <- dirname(Sys.which(""g++""))
-  if (!nzchar(mingw32_make_path) || !nzchar(gpp_path)) {
+  if (is_mingw32_make_installed(path = toolchain_path)) {
     if (!fix) {
       stop(
-        ""\nRTools installation found but PATH was not properly set."",
+        ""\nRTools installation found but mingw32-make is missing."",
         ""\nRun check_cmdstan_toolchain(fix = TRUE) to fix the issue."",
         call. = FALSE
       )
     } else {
       install_mingw32_make(quiet = quiet)
       check_rtools4x_windows_toolchain(fix = FALSE, quiet = quiet)
-      return(invisible(NULL))
     }
-  }
+  } else {
+    mingw32_make_path <- dirname(Sys.which(""mingw32-make""))
+    gpp_path <- dirname(Sys.which(""g++""))
+    if (!nzchar(mingw32_make_path) || !nzchar(gpp_path)) {
+      if (!fix) {
+        stop(
+          ""\nRTools installation found but PATH was not properly set."",
+          ""\nRun check_cmdstan_toolchain(fix = TRUE) to fix the issue."",
+          call. = FALSE
+        )
+      } else {      
+        check_rtools4x_windows_toolchain(fix = FALSE, quiet = quiet)
+        return(invisible(NULL))
+      }
+    }
+  }  
   # Check if the mingw32-make and g++ get picked up by default are the RTools-supplied ones
   if (toolchain_path != mingw32_make_path || gpp_path != toolchain_path) {
     if (!fix) {
@@ -652,3 +664,14 @@ cmdstan_arch_suffix <- function(version = NULL) {
   }
   arch
 }
+
+is_mingw32_make_installed(path) {
+  res <- processx::run(
+    ""mingw32-make"",
+    args = c(""--versiSyu"", ""mingw-w64-x86_64-make"", ""--noconfirm""),
+    wd = rtools_usr_bin,
+    error_on_status = FALSE,
+    echo_cmd = is_verbose_mode(),
+    echo = is_verbose_mode()
+  )
+}
\ No newline at end of file",True,False,Implementation / Logic,6
stan-dev,cmdstanr,c9cca07f1726632aec71ce3534a734328fd4f0a1,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-03T15:02:54Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-04-03T15:02:54Z,fix,R/install.R,False,True,True,False,2,2,4,"---FILE: R/install.R---
@@ -446,10 +446,10 @@ build_status_ok <- function(process_log, quiet = FALSE) {
 
 install_mingw32_make <- function(quiet = FALSE) {
   if (R.version$minor < ""2.0"") {
-    rtools_path <- Sys.getenv(""RTOOLS40_HOME"")
+    rtools_usr_bin <- file.path(Sys.getenv(""RTOOLS40_HOME""), ""usr"", ""bin"")
     rtools_version <- ""40""
   } else {
-    rtools_path <- Sys.getenv(""RTOOLS42_HOME"")
+    rtools_usr_bin <- file.path(Sys.getenv(""RTOOLS42_HOME""), ""usr"", ""bin"")
     rtools_version <- ""42""
   }
   ",True,False,Environment / Configuration,3
stan-dev,cmdstanr,ae2a03198ab02f162e00926d110f3d5c32fb2a7e,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-03-25T13:05:25Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-03-25T13:05:25Z,fix external cpp test,tests/testthat/test-model-compile.R,False,True,True,False,32,31,63,"---FILE: tests/testthat/test-model-compile.R---
@@ -579,37 +579,38 @@ test_that(""cmdstan_model errors with no args "", {
   )
 })
 
-# test_that(""cmdstan_model works with user_header"", {
-#   tmpfile <- tempfile(fileext = "".hpp"")
-#   hpp <-
-#   ""
-#   #include <boost/math/tools/promotion.hpp>
-#   #include <ostream>
-#
-#   namespace bernoulli_external_model_namespace
-#   {
-#       template <typename T0__>
-#       inline typename boost::math::tools::promote_args<T0__>::type make_odds(const T0__ &
-#                                                                                  theta,
-#                                                                              std::ostream *pstream__)
-#       {
-#           return theta / (1 - theta);
-#       }
-#   }""
-#   cat(hpp, file = tmpfile, sep = ""\n"")
-#   mod <- cmdstan_model(
-#     stan_file = testing_stan_file(""bernoulli_external""),
-#     user_header = tmpfile
-#   )
-#   expect_true(file.exists(mod$exe_file()))
-#   file.remove(mod$exe_file())
-#   mod_2 <- cmdstan_model(
-#     stan_file = testing_stan_file(""bernoulli_external""),
-#     cpp_options=list(USER_HEADER=tmpfile),
-#     stanc_options = list(""allow-undefined"")
-#   )
-#   expect_true(file.exists(mod_2$exe_file()))
-# })
+test_that(""cmdstan_model works with user_header"", {
+  tmpfile <- tempfile(fileext = "".hpp"")
+  hpp <-
+  ""
+  #include <stan/math.hpp>
+  #include <boost/math/tools/promotion.hpp>
+  #include <ostream>
+
+  namespace bernoulli_external_model_namespace
+  {
+      template <typename T0__, stan::require_stan_scalar_t<T0__>* = nullptr>
+      inline typename boost::math::tools::promote_args<T0__>::type make_odds(const T0__ &
+                                                                                 theta,
+                                                                             std::ostream *pstream__)
+      {
+          return theta / (1 - theta);
+      }
+  }""
+  cat(hpp, file = tmpfile, sep = ""\n"")
+  mod <- cmdstan_model(
+    stan_file = testing_stan_file(""bernoulli_external""),
+    user_header = tmpfile
+  )
+  expect_true(file.exists(mod$exe_file()))
+  file.remove(mod$exe_file())
+  mod_2 <- cmdstan_model(
+    stan_file = testing_stan_file(""bernoulli_external""),
+    cpp_options=list(USER_HEADER=tmpfile),
+    stanc_options = list(""allow-undefined"")
+  )
+  expect_true(file.exists(mod_2$exe_file()))
+})
 
 test_that(""cmdstan_model cpp_options dont captialize cxxflags "", {
   file <- file.path(cmdstan_path(), ""examples"", ""bernoulli"", ""bernoulli.stan"")",True,False,Rendering / Conversion,3
stan-dev,cmdstanr,8bc794e985d48d38a404df7887564b6a34b804e1,jgabry,jgabry@gmail.com,2022-03-18T18:20:24Z,jgabry,jgabry@gmail.com,2022-03-18T18:20:24Z,a few edits to fix some pkgdown errors,R/model.R;_pkgdown.yml;vignettes/r-markdown.Rmd,True,True,True,False,31,27,58,"---FILE: R/model.R---
@@ -1,11 +1,10 @@
 #' Create a new CmdStanModel object
 #'
-#' @description \if{html}{\figure{logo.png}{options: width=""25px""
-#'   alt=""https://mc-stan.org/about/logo/""}} Create a new [`CmdStanModel`]
-#'   object from a file containing a Stan program or from an existing Stan
-#'   executable. The [`CmdStanModel`] object stores the path to a Stan program
-#'   and compiled executable (once created), and provides methods for fitting
-#'   the model using Stan's algorithms.
+#' @description \if{html}{\figure{logo.png}{options: width=""25""}}
+#'   Create a new [`CmdStanModel`] object from a file containing a Stan program
+#'   or from an existing Stan executable. The [`CmdStanModel`] object stores the
+#'   path to a Stan program and compiled executable (once created), and provides
+#'   methods for fitting the model using Stan's algorithms.
 #'
 #'   See the `compile` and `...` arguments for control over whether and how
 #'   compilation happens.
@@ -444,7 +443,7 @@ compile <- function(quiet = TRUE,
   if (is.null(include_paths) && !is.null(private$precompile_include_paths_)) {
     include_paths <- private$precompile_include_paths_
   }
-  private$include_paths_ <- include_paths  
+  private$include_paths_ <- include_paths
   if (is.null(dir) && !is.null(private$dir_)) {
     dir <- absolute_path(private$dir_)
   } else if (!is.null(dir)) {
@@ -772,7 +771,7 @@ check_syntax <- function(pedantic = FALSE,
 }
 CmdStanModel$set(""public"", name = ""check_syntax"", value = check_syntax)
 
-#' Run stanc's auto-formatter on the model code. 
+#' Run stanc's auto-formatter on the model code.
 #'
 #' @name model-method-format
 #' @aliases format
@@ -815,7 +814,7 @@ CmdStanModel$set(""public"", name = ""check_syntax"", value = check_syntax)
 #'   real                     lambda;
 #' }
 #' model {
-#'   target += 
+#'   target +=
 #'  poisson_log(y | lambda);
 #' }
 #' "")
@@ -851,7 +850,7 @@ format <- function(overwrite_file = FALSE,
     max_line_length,
     lower = 1, len = 1, null.ok = TRUE
   )
-  stanc_options <- private$precompile_stanc_options_  
+  stanc_options <- private$precompile_stanc_options_
   stancflags_val <- include_paths_stanc3_args(private$precompile_include_paths_)
   stanc_options[""auto-format""] <- TRUE
   if (!is.null(max_line_length)) {
@@ -915,7 +914,7 @@ format <- function(overwrite_file = FALSE,
     out_file <- self$stan_file()
   }
   cat(run_log$stdout, file = out_file, sep = ""\n"")
-  
+
   invisible(TRUE)
 }
 CmdStanModel$set(""public"", name = ""format"", value = format)

---FILE: _pkgdown.yml---
@@ -101,6 +101,7 @@ reference:
       - CmdStanMLE
       - CmdStanVB
       - CmdStanGQ
+      - CmdStanDiagnose
       - starts_with(""fit-method"")
   - title: ""Other tools for working with CmdStan""
     contents:

---FILE: vignettes/r-markdown.Rmd---
@@ -29,12 +29,12 @@ Behind the scenes, the engine relies on RStan to compile the model code into an
 in-memory `stanmodel`, which is assigned to a variable with the name given by
 the `output.var` chunk option. For example:
 
-````{verbatim}
-```{stan, output.var=""model""}
+````markdown
+`r ''````{stan, output.var=""model""}
 // Stan model code
 ```
 
-```{r}
+`r ''````{r}
 rstan::sampling(model)
 ```
 ````
@@ -53,22 +53,23 @@ chunks are processed with CmdStanR, not RStan. Of course, this also means that
 the variable specified by `output.var` will no longer be a `stanmodel` object,
 but instead a `CmdStanModel` object, so the code above would look like this:
 
-````{verbatim}
-```{stan, output.var=""model""}
+````markdown
+`r ''````{stan, output.var=""model""}
 // Stan model code
 ```
 
-```{r}
+`r ''````{r}
 model$sample()
 ```
 ````
 
 ## Example
 
 ```{stan ex1, output.var=""ex1""}
-// This stan chunk results in a CmdStanModel object called ""ex1""
+// This stan chunk results in a CmdStanModel object called ""ex1"" (by setting output.var=""ex1"")
+
 parameters {
-  real y[2];
+  array[2] real y;
 }
 model {
   y[1] ~ normal(0, 1);
@@ -105,31 +106,34 @@ same document or project, the option to use both exists. When registering
 CmdStanR's knitr engine, set `override = FALSE` to register the engine as a
 `cmdstan` engine:
 
-``` r
+```r
 register_knitr_engine(override = FALSE)
 ```
 
 This will cause `stan` chunks to be processed by knitr's built-in, RStan-based
 engine and only use CmdStanR's knitr engine for `cmdstan` chunks:
 
-````{verbatim}
-```{stan, output.var=""model_obj1""}
-// Results in a stanmodel object
+````markdown
+`r ''````{stan, output.var=""model_obj1""}
+// Results in a stanmodel object from RStan
 ```
 
-```{r}
+`r ''````{r}
 rstan::sampling(model_obj1)
 ```
+````
 
-```{cmdstan, output.var=""model_obj2""}
-// Results in a CmdStanModel object
+````markdown
+`r ''````{cmdstan, output.var=""model_obj2""}
+// Results in a CmdStanModel object from CmdStanR
 ```
 
-```{r}
+`r ''````{r}
 model_obj2$sample()
 ```
 ````
 
+
 ## Running interactively
 
 When running chunks interactively in RStudio (e.g. when using ",True,True,Documentation / Formatting,7
stan-dev,cmdstanr,128e30e62f920c3b85fb3dbc4216334ac2c0cf36,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-02-21T12:32:53Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-02-21T12:32:53Z,fix spaces,tests/testthat/test-utils.R,False,True,True,False,1,1,2,"---FILE: tests/testthat/test-utils.R---
@@ -111,7 +111,7 @@ test_that(""cmdstan_make_local() works"", {
   expect_equal(cmdstan_make_local(), NULL)
   cpp_options = list(
    ""CXX"" = ""clang++"",
-   ""CXXFLAGS+=  -march=native"",
+   ""CXXFLAGS+= -march=native"",
    TEST1 = TRUE,
    ""TEST2"" = FALSE
   )",True,False,Implementation / Logic,6
stan-dev,cmdstanr,9fc8a5bde55f52fb13b0707a67a2cc87b7c7f1e3,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-02-21T11:27:27Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-02-21T11:27:27Z,fix march-native typo,R/install.R;docs/reference/install_cmdstan.html;man/install_cmdstan.Rd;tests/testthat/test-utils.R,False,True,True,False,6,6,12,"---FILE: R/install.R---
@@ -66,7 +66,7 @@
 #'
 #' cpp_options <- list(
 #'   ""CXX"" = ""clang++"",
-#'   ""CXXFLAGS+= -march-native"",
+#'   ""CXXFLAGS+= -march=native"",
 #'   PRECOMPILED_HEADERS = TRUE
 #' )
 #' # cmdstan_make_local(cpp_options = cpp_options)

---FILE: docs/reference/install_cmdstan.html---
@@ -320,7 +320,7 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 
 <span class='no'>cpp_options</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span>(
   <span class='st'>""CXX""</span> <span class='kw'>=</span> <span class='st'>""clang++""</span>,
-  <span class='st'>""CXXFLAGS+= -march-native""</span>,
+  <span class='st'>""CXXFLAGS+= -march=native""</span>,
   <span class='kw'>PRECOMPILED_HEADERS</span> <span class='kw'>=</span> <span class='fl'>TRUE</span>
 )
 <span class='co'># cmdstan_make_local(cpp_options = cpp_options)</span>

---FILE: man/install_cmdstan.Rd---
@@ -118,7 +118,7 @@ check_cmdstan_toolchain()
 
 cpp_options <- list(
   ""CXX"" = ""clang++"",
-  ""CXXFLAGS+= -march-native"",
+  ""CXXFLAGS+= -march=native"",
   PRECOMPILED_HEADERS = TRUE
 )
 # cmdstan_make_local(cpp_options = cpp_options)

---FILE: tests/testthat/test-utils.R---
@@ -111,21 +111,21 @@ test_that(""cmdstan_make_local() works"", {
   expect_equal(cmdstan_make_local(), NULL)
   cpp_options = list(
    ""CXX"" = ""clang++"",
-   ""CXXFLAGS+= -march-native"",
+   ""CXXFLAGS+=  -march=native"",
    TEST1 = TRUE,
    ""TEST2"" = FALSE
   )
   expect_equal(cmdstan_make_local(cpp_options = cpp_options),
                c(
                  ""CXX=clang++"",
-                 ""CXXFLAGS+= -march-native"",
+                 ""CXXFLAGS+= -march=native"",
                  ""TEST1=true"",
                  ""TEST2=false""
                  ))
   expect_equal(cmdstan_make_local(cpp_options = list(""TEST3"" = TRUE)),
                c(
                  ""CXX=clang++"",
-                 ""CXXFLAGS+= -march-native"",
+                 ""CXXFLAGS+= -march=native"",
                  ""TEST1=true"",
                  ""TEST2=false"",
                  ""TEST3=true""",True,False,Documentation / Formatting,7
stan-dev,cmdstanr,6e401cd5fd02833c1b8be70a6c727daf0777d1b0,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-02-20T17:11:43Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-02-20T17:11:43Z,fix syntax,R/csv.R,False,True,True,False,1,1,2,"---FILE: R/csv.R---
@@ -227,7 +227,7 @@ read_cmdstan_csv <- function(files,
   num_post_warmup_draws <- ceiling(metadata$iter_sampling / metadata$thin)
   for (output_file in files) {
     if (os_is_windows()) {
-      grep_path <- paste0('""', repair_path(Sys.which(""grep.exe""), '""')
+      grep_path <- paste0('""', repair_path(Sys.which(""grep.exe""), '""'))
       fread_cmd <- paste0(grep_path, "" -v '^#' --color=never '"", output_file, ""'"")
     } else {
       fread_cmd <- paste0(""grep -v '^#' --color=never '"", output_file, ""'"")",True,False,Documentation / Formatting,3
stan-dev,cmdstanr,251b4880e1aaafd0b0a473d0643f5ea4d3917010,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-02-19T20:06:59Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-02-19T20:06:59Z,fix for spaces,R/model.R,False,True,True,False,3,2,5,"---FILE: R/model.R---
@@ -239,9 +239,8 @@ CmdStanModel <- R6::R6Class(
         if (is.null(args$include_paths)) {
           private$precompile_include_paths_ <- dirname(stan_file)
         } else {
-          private$precompile_include_paths_ <- args$user_header
+          private$precompile_include_paths_ <- args$include_paths
         }
-        private$include_paths_ <- args$include_paths
       }
       if (!is.null(exe_file)) {
         ext <- if (os_is_windows()) ""exe"" else """"
@@ -1709,6 +1708,8 @@ include_paths_stanc3_args <- function(include_paths = NULL) {
   if (!is.null(include_paths)) {
     checkmate::assert_directory_exists(include_paths, access = ""r"")
     include_paths <- absolute_path(include_paths)
+    paths_w_space <- grep("" "", include_paths)
+    include_paths[paths_w_space] <- paste0(""'"", include_paths[paths_w_space], ""'"")
     include_paths <- paste0(include_paths, collapse = "","")
     if (cmdstan_version() >= ""2.24"") {
       include_paths_flag <- ""--include-paths=""",True,False,Implementation / Logic,6
stan-dev,cmdstanr,01e089b0ae3cb5ad0e3f4be80833dceac41113c6,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-02-19T17:50:45Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2022-02-19T18:12:24Z,fix user header handling,R/model.R;tests/testthat/test-model-compile.R,False,True,True,False,9,1,10,"---FILE: R/model.R---
@@ -233,7 +233,8 @@ CmdStanModel <- R6::R6Class(
         private$model_name_ <- sub("" "", ""_"", strip_ext(basename(private$stan_file_)))
         private$precompile_cpp_options_ <- args$cpp_options %||% list()
         private$precompile_stanc_options_ <- assert_valid_stanc_options(args$stanc_options) %||% list()
-        if (!is.null(args$user_header)) {
+        if (!is.null(args$user_header) || !is.null(args$cpp_options[[""USER_HEADER""]]) ||
+            !is.null(args$cpp_options[[""user_header""]])) {
           private$using_user_header_ <- TRUE
         }
         private$precompile_include_paths_ <- args$include_paths

---FILE: tests/testthat/test-model-compile.R---
@@ -602,6 +602,13 @@ test_that(""cmdstan_model works with user_header"", {
     user_header = tmpfile
   )
   expect_true(file.exists(mod$exe_file()))
+  file.remove(mod$exe_file())
+  mod_2 <- cmdstan_model(
+    stan_file = testing_stan_file(""bernoulli_external""),
+    cpp_options=list(USER_HEADER=tmpfile),
+    stanc_options = list(""allow-undefined"")
+  )
+  expect_true(file.exists(mod_2$exe_file()))
 })
 
 test_that(""cmdstan_model cpp_options dont captialize cxxflags "", {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,121927be4ee986359f6d54a08fba1586924acb3e,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-02-08T09:05:50Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-02-08T09:05:50Z,fix metadata$time() for chains > 1,R/csv.R;tests/testthat/test-fit-mcmc.R,False,True,True,False,9,1,10,"---FILE: R/csv.R---
@@ -179,6 +179,7 @@ read_cmdstan_csv <- function(files,
   if (length(uniq_seed) == 1) {
     metadata$seed <- uniq_seed
   }
+  metadata$time <- time
   if (metadata$method == ""diagnose"") {
     gradients <- metadata$gradients
     metadata$gradients <- NULL

---FILE: tests/testthat/test-fit-mcmc.R---
@@ -21,7 +21,6 @@ fit_mcmc_3 <- testing_fit(""logistic"", method = ""sample"",
                           refresh = 0, metric = ""dense_e"")
 PARAM_NAMES <- c(""alpha"", ""beta[1]"", ""beta[2]"", ""beta[3]"")
 
-
 test_that(""draws() stops for unkown variables"", {
   expect_error(
     draws_betas <- fit_mcmc$draws(variables = ""ABCD""),
@@ -323,3 +322,11 @@ test_that(""draws() errors if invalid format"", {
     ""The supplied draws format is not valid""
   )
 })
+
+test_that(""metadata()$time has chains rowss"", {
+  expect_equal(nrow(fit_mcmc$metadata()$time), fit_mcmc$num_chains())
+  expect_equal(nrow(fit_mcmc_0$metadata()$time), fit_mcmc_0$num_chains())
+  expect_equal(nrow(fit_mcmc_1$metadata()$time), fit_mcmc_1$num_chains())
+  expect_equal(nrow(fit_mcmc_2$metadata()$time), fit_mcmc_2$num_chains())
+  expect_equal(nrow(fit_mcmc_3$metadata()$time), fit_mcmc_3$num_chains())
+})",True,False,Implementation / Logic,6
stan-dev,cmdstanr,862ef86df50b4361f15db59f2d40773e9dc2fdd7,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-01-31T18:16:01Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2022-02-07T10:36:26Z,fix pedantic warning,tests/testthat/test-model-compile.R,False,True,True,False,8,4,12,"---FILE: tests/testthat/test-model-compile.R---
@@ -279,7 +279,8 @@ test_that(""compile() works with pedantic=TRUE"", {
   "")
   expect_message(
     mod_pedantic_warn <- cmdstan_model(stan_file, pedantic = TRUE),
-    ""The parameter x was declared but was not used in the density calculation.""
+    ""The parameter x was declared but was not used"",
+    fixed = TRUE
   )
 })
 
@@ -375,19 +376,22 @@ test_that(""check_syntax() works with pedantic=TRUE"", {
 
   expect_message(
     mod_pedantic_warn$check_syntax(pedantic = TRUE),
-    ""The parameter x was declared but was not used in the density calculation.""
+    ""The parameter x was declared but was not used"",
+    fixed = TRUE
   )
 
   # should also still work if specified via stanc_options
   expect_message(
     mod_pedantic_warn$check_syntax(stanc_options = list(""warn-pedantic"" = TRUE)),
-    ""The parameter x was declared but was not used in the density calculation.""
+    ""The parameter x was declared but was not used"",
+    fixed = TRUE
   )
 
   expect_output(
     expect_message(
       mod_pedantic_warn$check_syntax(pedantic = TRUE),
-      ""The parameter x was declared but was not used in the density calculation.""
+      ""The parameter x was declared but was not used"",
+      fixed = TRUE
     ),
     regexp = NA
   )",True,False,Implementation / Logic,6
stan-dev,cmdstanr,f60a4989799e4ee07b6f402f86502f310b084249,Rok enovar,rok.cesnovar@fri.uni-lj.si,2022-01-31T13:30:51Z,Rok enovar,rok.cesnovar@fri.uni-lj.si,2022-01-31T13:30:51Z,fix expect output,tests/testthat/test-utils.R,False,True,True,False,1,1,2,"---FILE: tests/testthat/test-utils.R---
@@ -72,7 +72,7 @@ test_that(""cmdstan_summary works if bin/stansummary deleted file"", {
     file.remove(file.path(cmdstan_path(), ""bin"", cmdstan_ext(""stansummary"")))
     fit_mcmc$cmdstan_summary()
   }
-  expect_output(delete_and_run(), ""Inference for Stan model: logistic_model\\n2 chains: each with iter"")
+  expect_output(delete_and_run(), ""Inference for Stan model: logistic_model"")
 })
 
 test_that(""cmdstan_diagnose works if bin/diagnose deleted file"", {",True,False,File I/O and Export,4
stan-dev,cmdstanr,518089a0c0f7d16d4eb60b6434539017d08a8f37,Steve Bronder,stevo15025@gmail.com,2021-12-08T22:29:31Z,Steve Bronder,stevo15025@gmail.com,2021-12-08T22:29:31Z,fix pathfinder names,R/csv.R,False,True,True,False,1,0,1,"---FILE: R/csv.R---
@@ -401,6 +401,7 @@ read_cmdstan_csv <- function(files,
       pathfinder_draws <- NULL
     } else {
       pathfinder_draws <- do.call(as_draws_format, list(draws[[1]][-1, colnames(draws[[1]]), drop = FALSE]))
+      posterior::variables(pathfinder_draws) <- repaired_variables
     }
     list(
       metadata = metadata,",True,False,Implementation / Logic,6
stan-dev,cmdstanr,434916e064b2e34428ce6ea85a28b40178ea4226,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-12-05T11:10:11Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-12-05T11:10:11Z,fix bug,R/data.R;tests/testthat/test-data.R,False,True,True,False,1,58,59,"---FILE: R/data.R---
@@ -263,7 +263,7 @@ draws_to_csv <- function(draws,
 
   } else {
     missing_sampler_diagnostics <- sampler_diagnostics_names[!(sampler_diagnostics_names %in% draws_variables)]
-    missing_sampler_diagnostics <- missing_sampler_diagnostics[!(missing_sampler_diagnostics %in% draws_variables)]
+    missing_sampler_diagnostics <- missing_sampler_diagnostics[!(missing_sampler_diagnostics %in% sampler_diagnostics_variables)]
   }
   if (length(missing_sampler_diagnostics) > 0) {
     additional_sampler_diagnostics <- list()

---FILE: tests/testthat/test-data.R---
@@ -341,7 +341,6 @@ test_that(""process_data() corrrectly casts integers and floating point numbers"",
   "")
   mod <- cmdstan_model(stan_file, compile = FALSE)
   test_file <- process_data(list(k = matrix(c(18, 18, 16, 13, 9, 6, 4, 4, 4), nrow=3, ncol=3, byrow=T)), model_variables = mod$variables())
-  print(readLines(test_file)[2:3])
   expect_match(
     ""  \""k\"": ["",
     readLines(test_file)[2],
@@ -353,59 +352,3 @@ test_that(""process_data() corrrectly casts integers and floating point numbers"",
     fixed = TRUE
   )
 })
-
-test_that(""draws_to_csv() works sampler diagnostics defined in different ways"", {
-  read_csv <- function(files) {
-    draws <- list()
-    for (f in files) {
-      if (cmdstanr:::os_is_windows()) {
-        grep_path <- repair_path(Sys.which(""grep.exe""))
-        cmd <- paste0(grep_path, "" -v '^#' --color=never '"", f, ""'"")
-      } else {
-        cmd <- paste0(""grep -v '^#' --color=never '"", f, ""'"")
-      }
-      draws_list_id <- length(draws) + 1
-      suppressWarnings(
-        draws[[draws_list_id]] <- data.table::fread(
-          cmd = cmd,
-          data.table = FALSE
-        )
-      )
-    }
-    draws <- do.call(posterior::as_draws_array, list(draws))
-    return(draws)
-  }
-  sampler_diagnostics_names <- c(
-    ""accept_stat__"", ""stepsize__"", ""treedepth__"",
-    ""n_leapfrog__"", ""divergent__"", ""energy__""
-  )
-  d <- posterior::example_draws()
-  n <- posterior::niterations(d)
-  n_chains <- posterior::nchains(d)
-  ones <- rep(1, n * n_chains)
-
-  files <- draws_to_csv(d)
-  draws_csv_1 <- read_csv(files)
-
-  expect_true(all(sampler_diagnostics_names %in% posterior::variables(draws_csv_1)))
-  expect_true(all(posterior::subset_draws(draws_csv_1, variable = sampler_diagnostics_names) == 0))
-
-  zeros <- rep(0, n * n_chains)
-  sampler_diagnostics <- posterior::draws_array(
-    accept_stat__ = zeros, stepsize__ = zeros, treedepth__ = zeros, n_leapfrog__ = zeros,
-    divergent__ = zeros, energy__ = zeros, .nchains = n_chains
-  )
-  d <- posterior::bind_draws(d, sampler_diagnostics)
-  files <- draws_to_csv(d)
-  draws_csv_2 <- read_csv(files)
-  expect_equal(draws_csv_1, draws_csv_2)
-
-  stepsize <- posterior::draws_array(
-    stepsize__ = ones,
-    .nchains = n_chains
-  )
-  d <- posterior::bind_draws(d, stepsize)
-  files <- draws_to_csv(d)
-  draws_csv_3 <- read_csv(files)
-  expect_true(all(posterior::subset_draws(draws_csv_3, variable = ""stepsize__"") == 1))
-})",True,False,Implementation / Logic,6
stan-dev,cmdstanr,765193e53a2451563b5fbb1374bee58b9542460f,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-12-04T20:56:03Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-12-04T20:56:03Z,"- expose draws_to_csv
- fix if sampler diagnostics are in draws
- add tests",NAMESPACE;R/data.R;man/draws_to_csv.Rd;tests/testthat/test-data.R,False,True,True,False,183,17,200,"---FILE: NAMESPACE---
@@ -15,6 +15,7 @@ export(cmdstan_model)
 export(cmdstan_path)
 export(cmdstan_version)
 export(cmdstanr_example)
+export(draws_to_csv)
 export(eng_cmdstan)
 export(install_cmdstan)
 export(num_threads)

---FILE: R/data.R---
@@ -204,27 +204,68 @@ any_zero_dims <- function(data) {
   any(has_zero_dims)
 }
 
-#' Write posterior draws objects to csv files
-#' @noRd
-#' @param draws A `draws_array` from posterior pkg
-#' @param sampler_diagnostics Either `NULL` or a `draws_array` of sampler diagnostics
+#' Write posterior draws objects to CSV files suitable for running standalone generated
+#' quantities with CmdStan.
+#'
+#' @export
+#' @param draws A `posterior::draws_*` object.
+#' @param sampler_diagnostics Either `NULL` or a `posterior::draws_*` object
+#'  of sampler diagnostics.
+#' @param dir (string) An optional path to the directory where the CSV files will be
+#'   written. If not set, [temporary directory][base::tempdir] is used.
+#' @param basename (string) If `dir` is specified, `basename`` is used for naming
+#' the output CSV files. If not specified, the file names are randomly generated.
+#'
 #' @return Paths to CSV files (one per chain).
 #'
+#' @details
+#' `draws_to_csv()` generates a CSV suitable for running standalone generated
+#' quantities with CmdStan. The CSV file contains a single comment `#num_samples`,
+#' which equals the number of iterations in the supplied draws object.
+#'
+#' The comment is followed by the column names. The first column is the `lp__` value,
+#' followed by sampler diagnostics and finnaly other variables of the draws object.
+#' #' If the draws object does not contain the `lp__` or sampler diagnostics variables,
+#' columns with zeros are created in order to conform with the requirements of the
+#' standalone generated quantities method of CmdStan.
+#'
+#' The column names line is finally followed by the values of the draws in the same
+#' order as the column names.
+#'
+#' @examples
+#' \dontrun{
+#' draws <- posterior::example_draws()
+#'
+#' draws_csv_files <- draws_to_csv(draws)
+#' }
+#'
 draws_to_csv <- function(draws, sampler_diagnostics = NULL) {
+  sampler_diagnostics_names <- c(
+    ""accept_stat__"", ""stepsize__"", ""treedepth__"",
+    ""n_leapfrog__"", ""divergent__"", ""energy__""
+  )
   n <- posterior::niterations(draws)
   n_chains <- posterior::nchains(draws)
+  draws_variables <- posterior::variables(draws)
+  sampler_diagnostics_variables <- posterior::variables(sampler_diagnostics)
+
+  # create dummy sampler diagnostics due to CmdStan requirement for all columns in GQ if needed
   zeros <- rep(0, n * n_chains) # filler for creating dummy sampler diagnostics and lp__ if necessary
   if (is.null(sampler_diagnostics)) {
-    # create dummy sampler diagnostics due to CmdStan requirement for all columns in GQ
-    sampler_diagnostics <- posterior::draws_array(
-      accept_stat__ = zeros,
-      stepsize__ = zeros,
-      treedepth__ = zeros,
-      n_leapfrog__ = zeros,
-      divergent__ = zeros,
-      energy__ = zeros,
-      .nchains = n_chains
-    )
+    missing_sampler_diagnostics <- sampler_diagnostics_names[!(sampler_diagnostics_names %in% draws_variables)]
+
+  } else {
+    missing_sampler_diagnostics <- sampler_diagnostics_names[!(sampler_diagnostics_names %in% draws_variables)]
+    missing_sampler_diagnostics <- missing_sampler_diagnostics[!(missing_sampler_diagnostics %in% draws_variables)]
+  }
+  if (length(missing_sampler_diagnostics) > 0) {
+    additional_sampler_diagnostics <- list()
+    for (name in missing_sampler_diagnostics) {
+      additional_sampler_diagnostics[[name]] <- zeros
+    }
+    additional_sampler_diagnostics[["".nchains""]] <- n_chains
+    additional_sampler_diagnostics <- do.call(posterior::draws_array, additional_sampler_diagnostics)
+    sampler_diagnostics <- posterior::bind_draws(sampler_diagnostics, additional_sampler_diagnostics)
   }
 
   # the columns must be in order ""lp__, sampler_diagnostics, parameters""
@@ -236,8 +277,8 @@ draws_to_csv <- function(draws, sampler_diagnostics = NULL) {
   }
   all_variables <- c(
     ""lp__"",
-    posterior::variables(sampler_diagnostics),
-    draws_variables[!(draws_variables %in% c(""lp__"", ""lp_approx__""))]
+    sampler_diagnostics_names,
+    draws_variables[!(draws_variables %in% c(""lp__"", ""lp_approx__"", sampler_diagnostics_names))]
   )
   draws <- posterior::subset_draws(
     posterior::bind_draws(draws, sampler_diagnostics, lp__, along = ""variable""),
@@ -254,8 +295,13 @@ draws_to_csv <- function(draws, sampler_diagnostics = NULL) {
       file = path,
       append = FALSE
     )
+    data <- posterior::as_draws_df(posterior::subset_draws(draws, chain = chain))
+    class(data) <- ""data.frame""
+    data$.chain <- NULL
+    data$.iteration <- NULL
+    data$.draw <- NULL
     data.table::fwrite(
-      posterior::as_draws_df(posterior::subset_draws(draws, chain = chain)),
+      data,
       sep = "","",
       file = path,
       col.names = FALSE,

---FILE: man/draws_to_csv.Rd---
@@ -0,0 +1,63 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/data.R
+\name{draws_to_csv}
+\alias{draws_to_csv}
+\title{Write posterior draws objects to CSV files suitable for running standalone generated
+quantities with CmdStan.}
+\usage{
+draws_to_csv(draws, sampler_diagnostics = NULL)
+}
+\arguments{
+\item{draws}{A \verb{posterior::draws_*} object.}
+
+\item{sampler_diagnostics}{Either \code{NULL} or a \verb{posterior::draws_*} object
+of sampler diagnostics.}
+
+\item{dir}{(string) An optional path to the directory where the CSV files will be
+written. If not set, \link[base:tempfile]{temporary directory} is used.}
+
+\item{basename}{(string) If \code{dir} is specified, `basename`` is used for naming
+the output CSV files. If not specified, the file names are randomly generated.}
+}
+\value{
+Paths to CSV files (one per chain).
+}
+\description{
+Write posterior draws objects to CSV files suitable for running standalone generated
+quantities with CmdStan.
+}
+\details{
+\code{draws_to_csv()} generates a CSV suitable for running standalone generated
+quantities with CmdStan. The CSV file contains a single comment \verb{#num_samples},
+which equals the number of iterations in the supplied draws object.
+
+The comment is followed by the column names. The first column is the \code{lp__} value,
+followed by sampler diagnostics and finnaly other variables of the draws object.
+#' If the draws object does not contain the \code{lp__} or sampler diagnostics variables,
+columns with zeros are created in order to conform with the CmdStan requirements.
+}
+\examples{
+\dontrun{
+print_example_program(""logistic"")
+fit_logistic_mcmc <- cmdstanr_example(""logistic"", chains = 2)
+fit_logistic_mcmc$summary()
+
+fit_logistic_optim <- cmdstanr_example(""logistic"", method = ""optimize"")
+fit_logistic_optim$summary()
+
+fit_logistic_vb <- cmdstanr_example(""logistic"", method = ""variational"")
+fit_logistic_vb$summary()
+
+print_example_program(""schools"")
+fit_schools_mcmc <- cmdstanr_example(""schools"")
+fit_schools_mcmc$summary()
+
+print_example_program(""schools_ncp"")
+fit_schools_ncp_mcmc <- cmdstanr_example(""schools_ncp"")
+fit_schools_ncp_mcmc$summary()
+
+# optimization fails for hierarchical model
+cmdstanr_example(""schools"", ""optimize"", quiet = FALSE)
+}
+
+}

---FILE: tests/testthat/test-data.R---
@@ -353,3 +353,59 @@ test_that(""process_data() corrrectly casts integers and floating point numbers"",
     fixed = TRUE
   )
 })
+
+test_that(""draws_to_csv() works sampler diagnostics defined in different ways"", {
+  read_csv <- function(files) {
+    draws <- list()
+    for (f in files) {
+      if (cmdstanr:::os_is_windows()) {
+        grep_path <- repair_path(Sys.which(""grep.exe""))
+        cmd <- paste0(grep_path, "" -v '^#' --color=never '"", f, ""'"")
+      } else {
+        cmd <- paste0(""grep -v '^#' --color=never '"", f, ""'"")
+      }
+      draws_list_id <- length(draws) + 1
+      suppressWarnings(
+        draws[[draws_list_id]] <- data.table::fread(
+          cmd = cmd,
+          data.table = FALSE
+        )
+      )
+    }
+    draws <- do.call(posterior::as_draws_array, list(draws))
+    return(draws)
+  }
+  sampler_diagnostics_names <- c(
+    ""accept_stat__"", ""stepsize__"", ""treedepth__"",
+    ""n_leapfrog__"", ""divergent__"", ""energy__""
+  )
+  d <- posterior::example_draws()
+  n <- posterior::niterations(d)
+  n_chains <- posterior::nchains(d)
+  ones <- rep(1, n * n_chains)
+
+  files <- draws_to_csv(d)
+  draws_csv_1 <- read_csv(files)
+
+  expect_true(all(sampler_diagnostics_names %in% posterior::variables(draws_csv_1)))
+  expect_true(all(posterior::subset_draws(draws_csv_1, variable = sampler_diagnostics_names) == 0))
+
+  zeros <- rep(0, n * n_chains)
+  sampler_diagnostics <- posterior::draws_array(
+    accept_stat__ = zeros, stepsize__ = zeros, treedepth__ = zeros, n_leapfrog__ = zeros,
+    divergent__ = zeros, energy__ = zeros, .nchains = n_chains
+  )
+  d <- posterior::bind_draws(d, sampler_diagnostics)
+  files <- draws_to_csv(d)
+  draws_csv_2 <- read_csv(files)
+  expect_equal(draws_csv_1, draws_csv_2)
+
+  stepsize <- posterior::draws_array(
+    stepsize__ = ones,
+    .nchains = n_chains
+  )
+  d <- posterior::bind_draws(d, stepsize)
+  files <- draws_to_csv(d)
+  draws_csv_3 <- read_csv(files)
+  expect_true(all(posterior::subset_draws(draws_csv_3, variable = ""stepsize__"") == 1))
+})",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,7ddd54cec703271b9af496eb6aa06e4716780258,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-11-26T18:25:55Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-11-26T18:25:55Z,alternative fix,R/model.R,False,True,True,False,3,4,7,"---FILE: R/model.R---
@@ -495,9 +495,6 @@ compile <- function(quiet = TRUE,
     self$exe_file(exe)
     return(invisible(self))
   } else {
-    if (file.exists(exe)) {
-      file.remove(exe)
-    }
     if (interactive()) {
       message(""Compiling Stan program..."")
     }
@@ -590,7 +587,9 @@ compile <- function(quiet = TRUE,
     stop(""An error occured during compilation! See the message above for more information."",
          call. = FALSE)
   }
-
+  if (file.exists(exe)) {
+    file.remove(exe)
+  }
   file.copy(tmp_exe, exe, overwrite = TRUE)
   private$exe_file_ <- exe
   private$cpp_options_ <- cpp_options",True,False,Implementation / Logic,6
stan-dev,cmdstanr,86182475d2e8e47cddea8d8eb72e52e5f8bebf9e,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-11-26T18:07:43Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-11-26T18:07:43Z,fix syntax,R/model.R,False,True,True,False,2,2,4,"---FILE: R/model.R---
@@ -495,8 +495,8 @@ compile <- function(quiet = TRUE,
     self$exe_file(exe)
     return(invisible(self))
   } else {
-    if (file.exists(self$exe_file())) {
-      file.remove(self$exe_file())
+    if (file.exists(exe)) {
+      file.remove(exe)
     }
     if (interactive()) {
       message(""Compiling Stan program..."")",True,False,Rendering / Conversion,3
stan-dev,cmdstanr,1183765ccc8381aec5f3fb873dddd647b0f01cd6,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-11-26T16:53:24Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-11-26T16:53:24Z,silly attempt at fixing this,R/model.R,False,True,True,False,3,0,3,"---FILE: R/model.R---
@@ -495,6 +495,9 @@ compile <- function(quiet = TRUE,
     self$exe_file(exe)
     return(invisible(self))
   } else {
+    if (file.exists(self$exe_file())) {
+      file.remove(self$exe_file())
+    }
     if (interactive()) {
       message(""Compiling Stan program..."")
     }",True,False,Rendering / Conversion,3
stan-dev,cmdstanr,ff9ceffdb9935c8fe8e6a777ece139f61c410afa,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-11-12T10:00:57Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-11-12T10:00:57Z,fix test,tests/testthat/test-model-sample.R,False,True,True,False,3,5,8,"---FILE: tests/testthat/test-model-sample.R---
@@ -306,12 +306,10 @@ test_that(""fixed_param is set when the model has no parameters"", {
   ""
   stan_file <- write_stan_file(code)
   m <- cmdstan_model(stan_file)
-  expect_warning(
-    capture.output(fit <- m$sample()),
-    ""Model contains no parameters. Automatically setting fixed_param = TRUE.""
+  expect_error(
+    m$sample(),
+    ""Model contains no parameters. Please use 'fixed_param = TRUE'.""
   )
-  expect_null(fit$sampler_diagnostics())
-  expect_equal(posterior::variables(fit$draws()), ""y"")
 })
 
 test_that(""sig_figs warning if version less than 2.25"", {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,31366027440161f5ab5a8e31b90328ecdeec1e43,jgabry,jgabry@gmail.com,2021-11-11T02:29:37Z,jgabry,jgabry@gmail.com,2021-11-11T02:29:37Z,fix a few R cmd check notes,DESCRIPTION;NAMESPACE;R/cmdstanr-package.R;README.md;man/cmdstanr-package.Rd;vignettes/children/comparison-with-rstan.md,False,True,True,False,6,4,10,"---FILE: DESCRIPTION---
@@ -20,7 +20,7 @@ Description: A lightweight interface to 'Stan' <https://mc-stan.org>.
     with the latest version of Stan, fewer installation errors, fewer unexpected 
     crashes in RStudio, and a more permissive license. 
 License: BSD_3_clause + file LICENSE
-URL: https://mc-stan.org/cmdstanr, https://discourse.mc-stan.org
+URL: https://mc-stan.org/cmdstanr/, https://discourse.mc-stan.org
 BugReports: https://github.com/stan-dev/cmdstanr/issues
 Encoding: UTF-8
 LazyData: true

---FILE: NAMESPACE---
@@ -28,4 +28,5 @@ export(set_num_threads)
 export(write_stan_file)
 export(write_stan_json)
 export(write_stan_tempfile)
+import(R6)
 importFrom(posterior,as_draws)

---FILE: R/cmdstanr-package.R---
@@ -28,6 +28,7 @@
 #'
 #' @template seealso-docs
 #' @inherit cmdstan_model examples
+#' @import R6
 #'
 NULL
 

---FILE: README.md---
@@ -3,7 +3,7 @@
 <!-- badges: start -->
 [![CRAN status](https://www.r-pkg.org/badges/version/cmdstanr)](https://CRAN.R-project.org/package=cmdstanr)
 [![Unit tests](https://github.com/stan-dev/cmdstanr/workflows/Unit%20tests/badge.svg)](https://github.com/stan-dev/cmdstanr/actions?workflow=Unit-tests)
-[![Codecov test coverage](https://codecov.io/gh/stan-dev/cmdstanr/branch/master/graph/badge.svg)](https://codecov.io/gh/stan-dev/cmdstanr?branch=master)
+[![Codecov test coverage](https://codecov.io/gh/stan-dev/cmdstanr/branch/master/graph/badge.svg)](https://app.codecov.io/gh/stan-dev/cmdstanr?branch=master)
 <!-- badges: end -->
 
 ### Overview 

---FILE: man/cmdstanr-package.Rd---
@@ -23,7 +23,7 @@ algorithms from \R via CmdStan, the shell interface to Stan
 
 \subsection{Different ways of interfacing with Stans C++}{
 
-The RStan interface (\href{https://mc-stan.org/rstan}{\strong{rstan}} package) is
+The RStan interface (\href{https://mc-stan.org/rstan/}{\strong{rstan}} package) is
 an in-memory interface to Stan and relies on R packages like \strong{Rcpp}
 and \strong{inline} to call C++ code from R. On the other hand, the CmdStanR
 interface does not directly call any C++ code from R, instead relying on

---FILE: vignettes/children/comparison-with-rstan.md---
@@ -1,6 +1,6 @@
 ### Different ways of interfacing with Stan's C++
 
-The RStan interface ([**rstan**](https://mc-stan.org/rstan) package) is an
+The RStan interface ([**rstan**](https://mc-stan.org/rstan/) package) is an
 in-memory interface to Stan and relies on R packages like **Rcpp** and
 **inline** to call C++ code from R. On the other hand, the CmdStanR interface
 does not directly call any C++ code from R, instead relying on the CmdStan",True,False,Dependency / Package,7
stan-dev,cmdstanr,4b286142a52be37d7919be5b146037aecc8573af,jgabry,jgabry@gmail.com,2021-11-10T22:30:14Z,jgabry,jgabry@gmail.com,2021-11-10T22:30:14Z,fix failing tests,tests/testthat/test-model-diagnose.R;tests/testthat/test-opencl.R;tests/testthat/test-path.R,False,True,True,False,3,10,13,"---FILE: tests/testthat/test-model-diagnose.R---
@@ -94,7 +94,7 @@ test_that(""diagnose() works for examples"", {
   expect_true(is.data.frame(fit_schools$gradients()))
   expect_equal(dim(fit_schools$gradients()), c(10, 5))
   expect_true(is.numeric(fit_schools$lp()))
-  expect_true(is.list(test$metadata()))
-  expect_equal(test$metadata()$test, ""gradient"")
+  expect_true(is.list(fit_schools$metadata()))
+  expect_equal(fit_schools$metadata()$test, ""gradient"")
 })
 

---FILE: tests/testthat/test-opencl.R---
@@ -104,7 +104,7 @@ test_that(""all methods run with valid opencl_ids"", {
 })
 
 test_that(""error for runtime selection of OpenCL devices if version less than 2.26"", {
-  skip_if(Sys.getenv(""CMDSTANR_OPENCL_TESTS"")!=""1"")
+  skip_if_not(Sys.getenv(""CMDSTANR_OPENCL_TESTS"") %in% c(""1"", ""true""))
   fake_cmdstan_version(""2.25.0"")
 
   stan_file <- testing_stan_file(""bernoulli"")

---FILE: tests/testthat/test-path.R---
@@ -89,13 +89,6 @@ test_that(""Warning message is thrown if can't detect version number"", {
   )
 })
 
-test_that(""cmdstan_path() sets version number if not set"", {
-  fake_cmdstan_version(NULL)
-  expect_true(is.null(cmdstan_version(error_on_NA = FALSE)))
-  cmdstan_path()
-  expect_false(is.null(cmdstan_version(error_on_NA = FALSE)))
-})
-
 test_that(""cmdstan_ext() works"", {
   if (os_is_windows()) {
     expect_identical(cmdstan_ext(), "".exe"")",True,False,Implementation / Logic,6
stan-dev,cmdstanr,dfc90bd1096fb367edb3d9ffbc53117fa070aaf6,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-11-10T18:59:47Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-11-10T18:59:47Z,switch cmdstan version to avoid windows issues,tests/testthat/test-install.R,False,True,True,False,3,3,6,"---FILE: tests/testthat/test-install.R---
@@ -95,7 +95,7 @@ test_that(""install_cmdstan() works with version and release_url"", {
   expect_message(
     expect_output(
       install_cmdstan(dir = dir, overwrite = TRUE, cores = 4,
-                      release_url = ""https://github.com/stan-dev/cmdstan/releases/download/v2.24.0/cmdstan-2.24.0.tar.gz""),
+                      release_url = ""https://github.com/stan-dev/cmdstan/releases/download/v2.25.0/cmdstan-2.25.0.tar.gz""),
       ""Compiling, linking C++ code"",
       fixed = TRUE
     ),
@@ -106,9 +106,9 @@ test_that(""install_cmdstan() works with version and release_url"", {
     expect_message(
       expect_output(
         install_cmdstan(dir = dir, overwrite = TRUE, cores = 4,
-                        version = ""2.23.0"",
+                        version = ""2.26.1"",
                         # the URL is intentionally invalid to test that the version has higher priority
-                        release_url = ""https://github.com/stan-dev/cmdstan/releases/download/v2.23.2/cmdstan-2.23.2.tar.gz""),
+                        release_url = ""https://github.com/stan-dev/cmdstan/releases/download/v2.26.3/cmdstan-2.26.3.tar.gz""),
         ""Compiling, linking C++ code"",
         fixed = TRUE
       ),",True,False,Implementation / Logic,3
stan-dev,cmdstanr,47a9b9e77243e230286adc775b5c9daba730cca3,jgabry,jgabry@gmail.com,2021-11-09T21:06:42Z,jgabry,jgabry@gmail.com,2021-11-09T21:06:42Z,try to get test to error to investigate #589,tests/testthat/test-install.R,False,True,True,False,3,0,3,"---FILE: tests/testthat/test-install.R---
@@ -26,6 +26,9 @@ test_that(""install_cmdstan() successfully installs cmdstan"", {
 
 test_that(""install_cmdstan() errors if installation already exists"", {
   skip_if_offline()
+  if (not_on_cran()) {
+    print(""foo"")
+  }
   install_dir <- cmdstan_default_install_path()
   dir <- file.path(install_dir, ""cmdstan-2.23.0"")
   if (!dir.exists(dir)) {",True,False,Implementation / Logic,3
stan-dev,cmdstanr,b718ad647025ee5da8752c4f6f764b75a45435cc,jgabry,jgabry@gmail.com,2021-11-04T20:41:12Z,jgabry,jgabry@gmail.com,2021-11-04T20:41:12Z,fixes to get tests passing,NEWS.md;R/fit.R;R/model.R;R/utils.R;man/fit-method-diagnose_sampler.Rd;tests/testthat/test-fit-mcmc.R,False,True,True,False,49,19,68,"---FILE: NEWS.md---
@@ -65,6 +65,9 @@ These are just wrappers around the `$draws()` method provided for convenience. (
 * New method `$diagnose_sampler()` that summarizes the sampler diagnostics
 (divergences, treedepth, ebfmi) and can regenerate the related warning messages. (#205)
 
+* New `diagnostics` argument for the `$sample()` method to specify which 
+diagnostics are checked after sampling. Replaces `validate_csv` argument. (#205)
+
 # cmdstanr 0.4.0
 
 ### Bug fixes

---FILE: R/fit.R---
@@ -857,13 +857,17 @@ CmdStanMCMC <- R6::R6Class(
         warning(""No chains finished successfully. Unable to retrieve the fit."",
                 call. = FALSE)
       } else {
+        # throw diagnostic warnings if user asked for them and if not fixed_param
         if (!is.null(self$runset$args$method_args$diagnostics)) {
-          diagnostics <- self$runset$method_args$diagnostics
+          diagnostics <- self$runset$args$method_args$diagnostics
           fixed_param <- runset$args$method_args$fixed_param
-          private$read_csv_(
-            variables = """",
-            sampler_diagnostics = if (!fixed_param) diagnostics else """"
-          )
+          if (!fixed_param) {
+            # convert user friendly names to actual diagnostic names (e.g. divergences --> divergent__)
+            diagnostics_to_read <- convert_diagnostic_names(diagnostics)
+          } else {
+            diagnostics_to_read <- """"
+          }
+          private$read_csv_(variables = """", sampler_diagnostics = diagnostics_to_read)
           if (!fixed_param) {
             invisible(self$diagnose_sampler(diagnostics = diagnostics, quiet = FALSE))
           }
@@ -1120,13 +1124,10 @@ CmdStanMCMC$set(""public"", name = ""sampler_diagnostics"", value = sampler_diagnost
 #'   chain use the [`$sampler_diagnostics()`][fit-method-sampler_diagnostics]
 #'   method.
 #'
-#'   This method is similar to [`$cmdstan_diagnose()`][fit-method-cmdstan_summary]
-#'   but everything is done in \R (rather than calling CmdStan utilities) and
-#'   the summaries are returned as a list (not just printed).
-#'
 #'   Currently parameter-specific diagnostics like R-hat and effective sample
 #'   size are not handled by this method. Those diagnostics are provided via the
-#'   [`$summary()`][fit-method-summary] method.
+#'   [`$summary()`][fit-method-summary] method (using
+#'   [posterior::summarize_draws()]).
 #'
 #' @param diagnostics (character vector) One or more diagnostics to check. The
 #'   currently supported diagnostics are `""divergences`, `""treedepth""`, and

---FILE: R/model.R---
@@ -1021,7 +1021,7 @@ sample_mpi <- function(data = NULL,
                        validate_csv = TRUE) {
 
   if (!is.null(validate_csv)) {
-    warning(""'validate_csv' is deprecated. Please set 'diagnostics=NULL' instead."")
+    warning(""'validate_csv' is deprecated. Please use 'diagnostics' instead."")
     if (is.logical(validate_csv)) {
       if (validate_csv) {
         diagnostics <- c(""divergences"", ""treedepth"", ""ebfmi"")

---FILE: R/utils.R---
@@ -324,6 +324,25 @@ available_diagnostics <- function() {
   c(""divergences"", ""treedepth"", ""ebfmi"")
 }
 
+# in some places we need to convert user friendly names
+# to the names used in the sampler diagnostics files:
+#   * ebfmi --> energy__
+#   * divergences --> divergent__
+#   * treedepth --> treedepth__
+convert_diagnostic_names <- function(diagnostics) {
+  diagnostic_names <- c()
+  if (""divergences"" %in% diagnostics) {
+    diagnostic_names <- c(diagnostic_names, ""divergent__"")
+  }
+  if (""treedepth"" %in% diagnostics) {
+    diagnostic_names <- c(diagnostic_names, ""treedepth__"")
+  }
+  if (""ebfmi"" %in% diagnostics) {
+    diagnostic_names <- c(diagnostic_names, ""energy__"")
+  }
+  diagnostic_names
+}
+
 # draws formatting --------------------------------------------------------
 
 as_draws_format_fun <- function(draws_format) {

---FILE: man/fit-method-diagnose_sampler.Rd---
@@ -34,13 +34,10 @@ the underlying values of the sampler diagnostics for each iteration and
 chain use the \code{\link[=fit-method-sampler_diagnostics]{$sampler_diagnostics()}}
 method.
 
-This method is similar to \code{\link[=fit-method-cmdstan_summary]{$cmdstan_diagnose()}}
-but everything is done in \R (rather than calling CmdStan utilities) and
-the summaries are returned as a list (not just printed).
-
 Currently parameter-specific diagnostics like R-hat and effective sample
 size are not handled by this method. Those diagnostics are provided via the
-\code{\link[=fit-method-summary]{$summary()}} method.
+\code{\link[=fit-method-summary]{$summary()}} method (using
+\code{\link[posterior:draws_summary]{posterior::summarize_draws()}}).
 }
 \examples{
 \dontrun{

---FILE: tests/testthat/test-fit-mcmc.R---
@@ -41,7 +41,7 @@ test_that(""draws() stops for unkown variables"", {
 test_that(""draws() works when gradually adding variables"", {
   skip_on_cran()
   fit <- testing_fit(""logistic"", method = ""sample"", refresh = 0,
-                     validate_csv = TRUE, save_warmup = TRUE)
+                     save_warmup = TRUE)
 
   draws_lp__ <- fit$draws(variables = c(""lp__""), inc_warmup = TRUE)
   sampler_diagnostics <- fit$sampler_diagnostics(inc_warmup = TRUE)
@@ -342,21 +342,31 @@ test_that(""draws() errors if invalid format"", {
 })
 
 test_that(""diagnose_sampler() works"", {
+  # will have divergences
   fit <- suppressMessages(cmdstanr_example(""schools""))
+
   expect_message(
     diagnostics <- fit$diagnose_sampler(),
     ""transitions ended with a divergence""
   )
   expect_equal(
-    diagnostics$divergences,
+    diagnostics$num_divergent,
     suppressMessages(check_divergences(fit$sampler_diagnostics()))
   )
   expect_equal(
-    diagnostics$max_treedepths,
+    diagnostics$num_max_treedepth,
     suppressMessages(check_max_treedepth(fit$sampler_diagnostics(), fit$metadata()))
   )
   expect_equal(
     diagnostics$ebfmi,
     suppressMessages(check_ebfmi(fit$sampler_diagnostics()))
   )
+
+  # ebfmi not defined if iter < 3
+  fit <- suppressWarnings(suppressMessages(cmdstanr_example(""schools"", iter_sampling = 2)))
+  expect_warning(
+    diagnostics <- fit$diagnose_sampler(),
+    ""E-BFMI not computed""
+  )
+  expect_equal(diagnostics$ebfmi, NA)
 })",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,bfb0bb56e6cbd56666126932bc780429db1a8001,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-11-02T08:32:20Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-11-02T08:32:20Z,fix issue with stan_threads=FALSE or stan_threads=something,R/model.R;tests/testthat/test-threads.R,False,True,True,False,28,9,37,"---FILE: R/model.R---
@@ -1472,7 +1472,7 @@ assert_valid_threads <- function(threads, cpp_options, multiple_chains = FALSE)
   threads_arg <- if (multiple_chains) ""threads_per_chain"" else ""threads""
   checkmate::assert_integerish(threads, .var.name = threads_arg,
                                null.ok = TRUE, lower = 1, len = 1)
-  if (is.null(cpp_options[[""stan_threads""]])) {
+  if (is.null(cpp_options[[""stan_threads""]]) || !isTRUE(cpp_options[[""stan_threads""]])) {
     if (!is.null(threads)) {
       warning(
         ""'"", threads_arg, ""' is set but the model was not compiled with "",
@@ -1482,14 +1482,12 @@ assert_valid_threads <- function(threads, cpp_options, multiple_chains = FALSE)
       )
       threads <- NULL
     }
-  } else {
-    if (is.null(threads)) {
-      stop(
-        ""The model was compiled with 'cpp_options = list(stan_threads = TRUE)' "",
-        ""but '"", threads_arg, ""' was not set!"",
-        call. = FALSE
-      )
-    }
+  } else if (isTRUE(cpp_options[[""stan_threads""]]) && is.null(threads)) {
+    stop(
+      ""The model was compiled with 'cpp_options = list(stan_threads = TRUE)' "",
+      ""but '"", threads_arg, ""' was not set!"",
+      call. = FALSE
+    )
   }
   invisible(threads)
 }

---FILE: tests/testthat/test-threads.R---
@@ -164,3 +164,24 @@ test_that(""threading works with generate_quantities()"", {
   expect_equal(f_gq$metadata()$threads_per_chain, 4)
 })
 
+test_that(""stan"", {
+  skip_on_cran()
+  mod <- cmdstan_model(stan_program, cpp_options = list(stan_threads = FALSE), force_recompile = TRUE)
+  expect_output(
+    mod$sample(data = data_file_json),
+    ""Running MCMC with 4 sequential chains"",
+    fixed = TRUE
+  )
+  mod <- cmdstan_model(stan_program, cpp_options = list(stan_threads = ""dummy string""), force_recompile = TRUE)
+  expect_output(
+    mod$sample(data = data_file_json),
+    ""Running MCMC with 4 sequential chains"",
+    fixed = TRUE
+  )
+  mod <- cmdstan_model(stan_program, cpp_options = list(stan_threads = FALSE), force_recompile = TRUE)
+  expect_warning(
+    mod$sample(data = data_file_json, threads_per_chain = 4),
+    ""'threads_per_chain' is set but the model was not compiled with 'cpp_options = list(stan_threads = TRUE)' so 'threads_per_chain' will have no effect!"",
+    fixed = TRUE
+  )
+})",True,False,Implementation / Logic,6
stan-dev,cmdstanr,07d05c23ae5fda283a0ebdccc68a64b902dee9f4,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-11-01T15:23:53Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-11-01T15:23:53Z,fix Rd file,man/model-method-compile.Rd,False,False,False,False,3,2,5,"---FILE: man/model-method-compile.Rd---
@@ -13,7 +13,7 @@ compile(
   user_header = NULL,
   cpp_options = list(),
   stanc_options = list(),
-  force_recompile = FALSE,
+  force_recompile = getOption(""cmdstanr_force_recompile"", default = FALSE),
   threads = FALSE
 )
 }
@@ -51,7 +51,8 @@ when compiling the model. See the \strong{Examples} section below as well as the
 https://mc-stan.org/docs/cmdstan-guide/stanc.html.}
 
 \item{force_recompile}{(logical) Should the model be recompiled even if was
-not modified since last compiled. The default is \code{FALSE}.}
+not modified since last compiled. The default is \code{FALSE}. Can also be set
+via a global \code{cmdstanr_force_recompile} option.}
 
 \item{threads}{Deprecated and will be removed in a future release. Please
 turn on threading via \code{cpp_options = list(stan_threads = TRUE)} instead.}",False,False,Documentation / Formatting,6
stan-dev,cmdstanr,dbc033d4c279cff6d6e6c642d54e75ec635be6b6,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-10-13T19:29:37Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-10-13T19:29:37Z,fix for model variables and a test,R/model.R;tests/testthat/resources/stan/bernoulli_external.stan;tests/testthat/test-model-compile.R,False,True,True,False,60,3,63,"---FILE: R/model.R---
@@ -204,6 +204,7 @@ CmdStanModel <- R6::R6Class(
     cpp_options_ = list(),
     stanc_options_ = list(),
     include_paths_ = NULL,
+    using_user_header_ = FALSE,
     precompile_cpp_options_ = NULL,
     precompile_stanc_options_ = NULL,
     precompile_include_paths_ = NULL,
@@ -220,6 +221,9 @@ CmdStanModel <- R6::R6Class(
         private$model_name_ <- sub("" "", ""_"", strip_ext(basename(private$stan_file_)))
         private$precompile_cpp_options_ <- args$cpp_options %||% list()
         private$precompile_stanc_options_ <- assert_valid_stanc_options(args$stanc_options) %||% list()
+        if (!is.null(args$user_header)) {
+          private$using_user_header_ <- TRUE
+        }
         private$precompile_include_paths_ <- args$include_paths
         private$include_paths_ <- args$include_paths
       }
@@ -396,6 +400,7 @@ compile <- function(quiet = TRUE,
                     dir = NULL,
                     pedantic = FALSE,
                     include_paths = NULL,
+                    user_header = NULL,
                     cpp_options = list(),
                     stanc_options = list(),
                     force_recompile = FALSE,
@@ -503,6 +508,10 @@ compile <- function(quiet = TRUE,
   if (isTRUE(cpp_options$stan_opencl)) {
     stanc_options[[""use-opencl""]] <- TRUE
   }
+  if (!is.null(user_header)) {
+    cpp_options[[""USER_HEADER""]] <- user_header
+    stanc_options[[""allow-undefined""]] <- TRUE
+  }
   if (!is.null(cpp_options[[""USER_HEADER""]])) {
     cpp_options[[""USER_HEADER""]] <- absolute_path(cpp_options[[""USER_HEADER""]])
   }
@@ -610,7 +619,7 @@ variables <- function() {
   }
   assert_stan_file_exists(self$stan_file())
   if (is.null(private$variables_) && file.exists(self$stan_file())) {
-    private$variables_ <- model_variables(self$stan_file(), self$include_paths())
+    private$variables_ <- model_variables(self$stan_file(), self$include_paths(), allow_undefined = private$using_user_header_)
   }
   private$variables_
 }
@@ -1529,11 +1538,16 @@ include_paths_stanc3_args <- function(include_paths = NULL) {
   stancflags
 }
 
-model_variables <- function(stan_file, include_paths = NULL) {
+model_variables <- function(stan_file, include_paths = NULL, allow_undefined = FALSE) {
+  if (allow_undefined) {
+    allow_undefined_arg <- ""--allow-undefined""
+  } else {
+    allow_undefined_arg <- NULL
+  }  
   out_file <- tempfile(fileext = "".json"")
   run_log <- processx::run(
     command = stanc_cmd(),
-    args = c(stan_file, ""--info"", include_paths_stanc3_args(include_paths)),
+    args = c(stan_file, ""--info"", include_paths_stanc3_args(include_paths), allow_undefined_arg),
     wd = cmdstan_path(),
     echo = FALSE,
     echo_cmd = FALSE,

---FILE: tests/testthat/resources/stan/bernoulli_external.stan---
@@ -0,0 +1,18 @@
+functions {
+  real make_odds(real theta);
+}
+data {
+  int<lower=0> N;
+  array[N] int<lower=0, upper=1> y;
+}
+parameters {
+  real<lower=0, upper=1> theta;
+}
+model {
+  theta ~ beta(1, 1);
+  y ~ bernoulli(theta);
+}
+generated quantities {
+  real odds;
+  odds = make_odds(theta);
+}

---FILE: tests/testthat/test-model-compile.R---
@@ -596,3 +596,28 @@ test_that(""cmdstan_model errors with no args "", {
     fixed = TRUE
   )
 })
+
+test_that(""cmdstan_model works with user_header"", {
+  tmpfile <- tempfile(fileext = "".hpp"")
+  hpp <-
+  ""
+  #include <boost/math/tools/promotion.hpp>
+  #include <ostream>
+
+  namespace bernoulli_external_model_namespace
+  {
+      template <typename T0__>
+      inline typename boost::math::tools::promote_args<T0__>::type make_odds(const T0__ &
+                                                                                 theta,
+                                                                             std::ostream *pstream__)
+      {
+          return theta / (1 - theta);
+      }
+  }""
+  cat(hpp, file = tmpfile, sep = ""\n"")
+  mod <- cmdstan_model(
+    stan_file = testing_stan_file(""bernoulli_external""),
+    user_header = tmpfile
+  )
+  expect_true(file.exists(mod$exe_file()))
+})",True,False,Implementation / Logic,6
stan-dev,cmdstanr,998f78b7dd3c210950464fe72f9ed2b75486dcae,jgabry,jgabry@gmail.com,2021-10-13T16:59:30Z,jgabry,jgabry@gmail.com,2021-10-13T16:59:30Z,test for code/print error if no stan file (only exe),R/model.R;tests/testthat/test-model-code-print.R,False,True,True,False,17,0,17,"---FILE: R/model.R---
@@ -257,6 +257,9 @@ CmdStanModel <- R6::R6Class(
       private$stan_code_
     },
     print = function() {
+      if (length(private$stan_code_) == 0) {
+        stop(""'$print()' cannot be used because the 'CmdStanModel' was not created with a Stan file."", call. = FALSE)
+      }
       cat(self$code(), sep = ""\n"")
       invisible(self)
     },

---FILE: tests/testthat/test-model-code-print.R---
@@ -65,6 +65,20 @@ test_that(""code() doesn't change when file changes (unless model is recreated)"",
   expect_identical(utils::capture.output(mod$print()), code_2_answer)
 })
 
+test_that(""code() and print() error if only exe and no Stan file"", {
+  mod_exe <- cmdstan_model(exe_file = mod$exe_file())
+  expect_error(
+    mod_exe$code(),
+    ""'$code()' cannot be used because the 'CmdStanModel' was not created with a Stan file."",
+    fixed = TRUE
+  )
+  expect_error(
+    mod_exe$print(),
+    ""'$print()' cannot be used because the 'CmdStanModel' was not created with a Stan file."",
+    fixed = TRUE
+  )
+})
+
 test_that(""check_syntax() errors if only exe and no Stan file"", {
   mod_exe <- cmdstan_model(exe_file = mod$exe_file())
   expect_error(",True,False,Implementation / Logic,6
stan-dev,cmdstanr,9d203f4e84e0721362534fd6547df90d8757f810,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-10-12T18:44:46Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-10-12T18:44:46Z,another test fix,tests/testthat/test-model-compile.R,False,True,True,False,1,1,2,"---FILE: tests/testthat/test-model-compile.R---
@@ -574,7 +574,7 @@ test_that(""cmdstan_model created only with exe_file errors for check_syntax, cod
   )
   expect_error(
     mod_exe$check_syntax(),
-    ""'$check_syntax()' can not be used as the 'CmdStanModel' was not created with a Stan file."",
+    ""'$check_syntax()' cannot be used because the 'CmdStanModel' was not created with a Stan file."",
     fixed = TRUE
   )
   expect_error(",True,False,Rendering / Conversion,3
stan-dev,cmdstanr,56e0dc90a79c51c22ba5f16ec8cb9bf39dcfcf80,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-10-12T18:21:21Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-10-12T18:21:21Z,test fix,tests/testthat/test-model-compile.R,False,True,True,False,1,1,2,"---FILE: tests/testthat/test-model-compile.R---
@@ -574,7 +574,7 @@ test_that(""cmdstan_model created only with exe_file errors for check_syntax, cod
   )
   expect_error(
     mod_exe$check_syntax(),
-    ""$check_syntax()' can not be used as the 'CmdStanModel' was not created with a Stan file."",
+    ""'$check_syntax()' can not be used as the 'CmdStanModel' was not created with a Stan file."",
     fixed = TRUE
   )
   expect_error(",True,False,Rendering / Conversion,3
stan-dev,cmdstanr,cfabd15576175c4ac5c62699c7091ca57d39d075,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-10-12T17:42:54Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-10-12T17:42:54Z,fix syntax,R/model.R,False,True,True,False,1,1,2,"---FILE: R/model.R---
@@ -262,7 +262,7 @@ CmdStanModel <- R6::R6Class(
     stan_file = function() {
       private$stan_file_
     },
-    has_stan_file = function {
+    has_stan_file = function() {
       length(self$stan_file()) > 0
     },
     model_name = function() {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,09272dcb65e2a0efd32fffed3eae653fc64771a6,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-10-12T16:58:18Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-10-12T16:58:18Z,add test fixes,tests/testthat/test-model-compile.R;tests/testthat/test-model-sample.R;tests/testthat/test-model-variables.R,False,True,True,False,5,5,10,"---FILE: tests/testthat/test-model-compile.R---
@@ -370,7 +370,7 @@ test_that(""check_syntax() works"", {
   mod_exe <- cmdstan_model(exe_file = mod_removed_stan_file$exe_file())
   expect_error(
     mod_exe$check_syntax(),
-    ""'$check_syntax()' can not be used as the 'CmdStanModel' was not created with a Stan file."",
+    ""'$check_syntax()' cannot be used because the 'CmdStanModel' was not created with a Stan file."",
     fixed = TRUE
   )
 
@@ -569,7 +569,7 @@ test_that(""cmdstan_model created only with exe_file errors for check_syntax, cod
   mod_exe <- cmdstan_model(exe_file = mod$exe_file())
   expect_error(
     mod_exe$code(),
-    ""The `CmdStanModel` object was not created with a Stan file. '$code()' can not be used."",
+    ""'$code()' cannot be used because the 'CmdStanModel' was not created with a Stan file."",
     fixed = TRUE
   )
   expect_error(
@@ -579,7 +579,7 @@ test_that(""cmdstan_model created only with exe_file errors for check_syntax, cod
   )
   expect_error(
     mod_exe$variables(),
-    ""The `CmdStanModel` object was not created with a Stan file. '$variables()' can not be used."",
+    ""'$variables()' cannot be used because the 'CmdStanModel' was not created with a Stan file."",
     fixed = TRUE
   )
 })

---FILE: tests/testthat/test-model-sample.R---
@@ -104,7 +104,7 @@ test_that(""code() and print() methods work"", {
   mod_exe <- cmdstan_model(exe_file = mod_removed_stan_file$exe_file())
   expect_error(
     mod_exe$check_syntax(),
-    ""'$check_syntax()' can not be used as the 'CmdStanModel' was not created with a Stan file."",
+    ""'$check_syntax()' cannot be used because the 'CmdStanModel' was not created with a Stan file."",
     fixed = TRUE
   )
 })

---FILE: tests/testthat/test-model-variables.R---
@@ -97,7 +97,7 @@ test_that(""$variables() errors on no stan_file"", {
   mod_exe <- cmdstan_model(exe_file = mod$exe_file())
   expect_error(
     mod_exe$variables(),
-    ""The `CmdStanModel` object was not created with a Stan file. '$variables()' can not be used."",
+    ""'$variables()' cannot be used because the 'CmdStanModel' was not created with a Stan file."",
     fixed = TRUE
   )
 })",True,False,Rendering / Conversion,3
stan-dev,cmdstanr,d4fc7710788f8c3a2992062baf7cbceedaa1027d,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-10-10T17:19:51Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-10-10T17:19:51Z,fix for user header path,R/model.R,False,True,True,False,6,0,6,"---FILE: R/model.R---
@@ -480,6 +480,12 @@ compile <- function(quiet = TRUE,
   if (isTRUE(cpp_options$stan_opencl)) {
     stanc_options[[""use-opencl""]] <- TRUE
   }
+  if (!is.null(cpp_options[[""USER_HEADER""]])) {
+    cpp_options[[""USER_HEADER""]] <- absolute_path(cpp_options[[""USER_HEADER""]])
+  }
+  if (!is.null(cpp_options[[""user_header""]])) {
+    cpp_options[[""user_header""]] <- absolute_path(cpp_options[[""user_header""]])
+  }
   if (is.null(stanc_options[[""name""]])) {
     stanc_options[[""name""]] <- paste0(self$model_name(), ""_model"")
   }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,2e69a96a086587135d639bda1d257f5c376358fc,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-10-09T13:06:32Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-10-09T13:06:32Z,fix extension check,R/model.R,False,True,True,False,1,1,2,"---FILE: R/model.R---
@@ -217,7 +217,7 @@ CmdStanModel <- R6::R6Class(
         private$include_paths_ <- args$include_paths
       }
       if (!is.null(exe_file)) {
-        ext <- if (os_is_windows()) "".exe"" else """"
+        ext <- if (os_is_windows()) ""exe"" else """"
         private$exe_file_ <- repair_path(absolute_path(exe_file))
         if (is.null(stan_file)) {
           checkmate::assert_file_exists(private$exe_file_, access = ""r"", extension = ext)",True,False,Implementation / Logic,6
stan-dev,cmdstanr,8c0171e61f308f68bb7818878f920f3a4c856d97,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-10-08T15:25:39Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-10-08T15:25:39Z,typo fix,tests/testthat/test-model-compile.R,False,True,True,False,1,1,2,"---FILE: tests/testthat/test-model-compile.R---
@@ -541,7 +541,7 @@ test_that(""cmdstan_model works with exe_file"", {
   default_exe_file <- mod$exe_file()
   file.remove(mod$exe_file())
 
-  tmp_exe_file <- tempfile(filext = cmdstan_ext())
+  tmp_exe_file <- tempfile(fileext = cmdstan_ext())
   mod <- cmdstan_model(
     stan_file = stan_file,
     exe_file = tmp_exe_file",True,False,Rendering / Conversion,3
stan-dev,cmdstanr,2be19b4ea3d5da9ecede854cd3172938f0e208bd,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-10-07T19:17:19Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-10-07T19:17:19Z,another test fix,tests/testthat/test-threads.R,False,True,True,False,4,4,8,"---FILE: tests/testthat/test-threads.R---
@@ -57,7 +57,7 @@ test_that(""threading works with sample()"", {
 
 test_that(""threading works with optimize()"", {
   skip_on_cran()
-  mod <- cmdstan_model(stan_program, cpp_options = list(stan_threads = TRUE))
+  mod <- cmdstan_model(stan_program, cpp_options = list(stan_threads = TRUE), force_recompile = TRUE)
 
   expect_error(
     mod$optimize(data = data_file_json),
@@ -92,7 +92,7 @@ test_that(""threading works with optimize()"", {
 
 test_that(""threading works with variational()"", {
   skip_on_cran()
-  mod <- cmdstan_model(stan_program, cpp_options = list(stan_threads = TRUE))
+  mod <- cmdstan_model(stan_program, cpp_options = list(stan_threads = TRUE), force_recompile = TRUE)
 
   expect_error(
     mod$variational(data = data_file_json),
@@ -127,8 +127,8 @@ test_that(""threading works with variational()"", {
 
 test_that(""threading works with generate_quantities()"", {
   skip_on_cran()
-  mod <- cmdstan_model(stan_program, cpp_options = list(stan_threads = TRUE))
-  mod_gq <- cmdstan_model(stan_gq_program, cpp_options = list(stan_threads = TRUE))
+  mod <- cmdstan_model(stan_program, cpp_options = list(stan_threads = TRUE), force_recompile = TRUE)
+  mod_gq <- cmdstan_model(stan_gq_program, cpp_options = list(stan_threads = TRUE), force_recompile = TRUE)
   expect_output(
     f <- mod$sample(data = data_file_json, parallel_chains = 4, threads_per_chain = 1),
     ""Running MCMC with 4 parallel chains, with 1 thread(s) per chain.."",",True,False,Implementation / Logic,3
stan-dev,cmdstanr,15f3d40101af520478af5fd818883c779c31aa1b,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-10-07T19:16:37Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-10-07T19:16:37Z,fix threads test,tests/testthat/test-threads.R,False,True,True,False,1,1,2,"---FILE: tests/testthat/test-threads.R---
@@ -23,7 +23,7 @@ test_that(""using threads_per_chain without stan_threads set in compile() warns"",
 
 test_that(""threading works with sample()"", {
   skip_on_cran()
-  mod <- cmdstan_model(stan_program, cpp_options = list(stan_threads = TRUE))
+  mod <- cmdstan_model(stan_program, cpp_options = list(stan_threads = TRUE), force_recompile = TRUE)
 
   expect_error(
     mod$sample(data = data_file_json),",True,False,Rendering / Conversion,3
stan-dev,cmdstanr,508374ee6e3ee388124ab39f1bdb1c8df93d222a,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-10-04T18:48:49Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-10-04T18:49:08Z,remove exe_suffix and fix dir issue,R/model.R,False,True,True,False,4,16,20,"---FILE: R/model.R---
@@ -416,6 +416,9 @@ compile <- function(quiet = TRUE,
   if (!is.null(dir)) {
     dir <- repair_path(dir)
     checkmate::assert_directory_exists(dir, access = ""rw"")
+    if (length(self$exe_file()) != 0) {
+      private$exe_file_ <- file.path(dir, basename(self$exe_file()))
+    }
   }
 
   # temporary deprecation warnings
@@ -425,27 +428,12 @@ compile <- function(quiet = TRUE,
   }
 
   if (length(self$exe_file()) == 0) {
-    exe_suffix <- NULL
-    if (isTRUE(cpp_options$stan_threads)) {
-      exe_suffix <- c(exe_suffix, ""threads"")
-    }
-    if (isTRUE(cpp_options$stan_mpi)) {
-      exe_suffix <- c(exe_suffix, ""mpi"")
-    }
-    if (isTRUE(cpp_options$stan_opencl)) {
-      exe_suffix <- c(exe_suffix, ""opencl"")
-    }
-    exe_suffix <- paste0(exe_suffix, collapse = ""_"")
-    if (nzchar(exe_suffix)) {
-      exe_suffix <- paste0(""_"", exe_suffix)
-    }
-
     if (is.null(dir)) {
       exe_base <- self$stan_file()
     } else {
       exe_base <- file.path(dir, basename(self$stan_file()))
     }
-    exe <- cmdstan_ext(paste0(strip_ext(exe_base), exe_suffix))
+    exe <- cmdstan_ext(strip_ext(exe_base))
     if (dir.exists(exe)) {
       stop(""There is a subfolder matching the model name in the same folder as the model! Please remove or rename the subfolder and try again."", call. = FALSE)
     }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,11f2585b5dab26fa107e833bfd37b36df30dbfeb,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-09-30T19:19:11Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-09-30T19:19:11Z,fix handling integers,R/data.R;tests/testthat/test-data.R,False,True,True,False,20,1,21,"---FILE: R/data.R---
@@ -186,7 +186,7 @@ process_data <- function(data, model_variables = NULL) {
         # generating a decimal point in write_stan_json
         if (data_variables[[var_name]]$type == ""int""
             && !is.integer(data[[var_name]])) {
-              data[[var_name]] <- as.integer(data[[var_name]])
+          mode(data[[var_name]]) <- ""integer""            
         }
       }
     }

---FILE: tests/testthat/test-data.R---
@@ -337,4 +337,23 @@ test_that(""process_data() corrrectly casts integers and floating point numbers"",
     readLines(test_file)[3],
     fixed = TRUE
   )
+
+  stan_file <- write_stan_file(""
+  data {
+    int<lower=0> k[3,3];
+  }
+  "")
+  mod <- cmdstan_model(stan_file, compile = FALSE)
+  test_file <- process_data(list(k = matrix(c(18, 18, 16, 13, 9, 6, 4, 4, 4), nrow=3, ncol=3, byrow=T)), model_variables = mod$variables())
+  print(readLines(test_file)[2:3])
+  expect_match(
+    ""  \""k\"": ["",
+    readLines(test_file)[2],
+    fixed = TRUE
+  )
+  expect_match(
+    ""    [18, 18, 16],"",
+    readLines(test_file)[3],
+    fixed = TRUE
+  )
 })",True,False,Implementation / Logic,6
stan-dev,cmdstanr,41c6319c58ae20e60937047e069b2475a886955a,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-09-25T09:51:21Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-09-25T09:51:21Z,fix test,tests/testthat/test-model-optimize.R,False,True,True,False,1,1,2,"---FILE: tests/testthat/test-model-optimize.R---
@@ -152,7 +152,7 @@ test_that(""optimize() method runs when the stan file is removed"", {
   file.copy(testing_stan_file(""bernoulli""), stan_file_tmp)
   mod_tmp <- cmdstan_model(stan_file_tmp)
   file.remove(stan_file_tmp)
-  expect_sample_output(
+  expect_optim_output(
     mod_tmp$optimize(data = data_list)
   )
 })",True,False,File I/O and Export,3
stan-dev,cmdstanr,60a833f57e767103ab4c4315269cdb4704088d48,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-09-16T17:35:38Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-09-16T17:35:38Z,fix issue,R/model.R,False,True,True,False,12,6,18,"---FILE: R/model.R---
@@ -841,7 +841,8 @@ sample <- function(data = NULL,
     output_basename = output_basename,
     sig_figs = sig_figs,
     validate_csv = validate_csv,
-    opencl_ids = assert_valid_opencl(opencl_ids, self$cpp_options())
+    opencl_ids = assert_valid_opencl(opencl_ids, self$cpp_options()),
+    model_variables = model_variables
   )
   runset <- CmdStanRun$new(args, procs)
   runset$run_cmdstan()
@@ -980,7 +981,8 @@ sample_mpi <- function(data = NULL,
     output_dir = output_dir,
     output_basename = output_basename,
     validate_csv = validate_csv,
-    sig_figs = sig_figs
+    sig_figs = sig_figs,
+    model_variables = model_variables
   )
   runset <- CmdStanRun$new(args, procs)
   runset$run_cmdstan_mpi(mpi_cmd, mpi_args)
@@ -1090,7 +1092,8 @@ optimize <- function(data = NULL,
     output_dir = output_dir,
     output_basename = output_basename,
     sig_figs = sig_figs,
-    opencl_ids = assert_valid_opencl(opencl_ids, self$cpp_options())
+    opencl_ids = assert_valid_opencl(opencl_ids, self$cpp_options()),
+    model_variables = model_variables
   )
   runset <- CmdStanRun$new(args, procs)
   runset$run_cmdstan()
@@ -1205,7 +1208,8 @@ variational <- function(data = NULL,
     output_dir = output_dir,
     output_basename = output_basename,
     sig_figs = sig_figs,
-    opencl_ids = assert_valid_opencl(opencl_ids, self$cpp_options())
+    opencl_ids = assert_valid_opencl(opencl_ids, self$cpp_options()),
+    model_variables = model_variables
   )
   runset <- CmdStanRun$new(args, procs)
   runset$run_cmdstan()
@@ -1309,7 +1313,8 @@ generate_quantities <- function(fitted_params,
     output_dir = output_dir,
     output_basename = output_basename,
     sig_figs = sig_figs,
-    opencl_ids = assert_valid_opencl(opencl_ids, self$cpp_options())
+    opencl_ids = assert_valid_opencl(opencl_ids, self$cpp_options()),
+    model_variables = model_variables
   )
   runset <- CmdStanRun$new(args, procs)
   runset$run_cmdstan()
@@ -1369,7 +1374,8 @@ diagnose_method <- function(data = NULL,
     seed = seed,
     init = init,
     output_dir = output_dir,
-    output_basename = output_basename
+    output_basename = output_basename,
+    model_variables = model_variables
   )
   runset <- CmdStanRun$new(args, procs)
   runset$run_cmdstan()",True,False,Implementation / Logic,6
stan-dev,cmdstanr,56ffaa0899f1fc6110b6c0d5c308716750a45d0d,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-09-16T17:07:52Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-09-16T17:07:52Z,fix tests,tests/testthat/test-data.R,False,True,True,False,16,9,25,"---FILE: tests/testthat/test-data.R---
@@ -18,7 +18,8 @@ test_that(""empty data list converted to NULL"", {
   }
   "")
   expect_null(process_data(list()))
-  expect_null(process_data(list(), stan_file = stan_file))
+  mod <- cmdstan_model(stan_file, compile = FALSE)
+  expect_null(process_data(list(), model_variables = mod$variables()))
 })
 
 test_that(""process_data works for inputs of length one"", {
@@ -29,19 +30,22 @@ test_that(""process_data works for inputs of length one"", {
     real val;
   }
   "")
-  expect_equal(jsonlite::read_json(process_data(data, stan_file = stan_file)), list(val = 5))
+  mod <- cmdstan_model(stan_file, compile = FALSE)
+  expect_equal(jsonlite::read_json(process_data(data, model_variables = mod$variables())), list(val = 5))
   stan_file <- write_stan_file(""
   data {
     int val;
   }
   "")
-  expect_equal(jsonlite::read_json(process_data(data, stan_file = stan_file)), list(val = 5))
+  mod <- cmdstan_model(stan_file, compile = FALSE)
+  expect_equal(jsonlite::read_json(process_data(data, model_variables = mod$variables())), list(val = 5))
   stan_file <- write_stan_file(""
   data {
     vector[1] val;
   }
   "")
-  expect_equal(jsonlite::read_json(process_data(data, stan_file = stan_file)), list(val = list(5)))
+  mod <- cmdstan_model(stan_file, compile = FALSE)
+  expect_equal(jsonlite::read_json(process_data(data, model_variables = mod$variables())), list(val = list(5)))
 })
 
 test_that(""process_fitted_params() works with basic input types"", {
@@ -283,12 +287,13 @@ test_that(""process_data() errors on missing variables"", {
     real val2;
   }
   "")
+  mod <- cmdstan_model(stan_file, compile = FALSE)
   expect_error(
-    process_data(data = list(val1 = 5), stan_file = stan_file),
+    process_data(data = list(val1 = 5), model_variables = mod$variables()),
     ""Missing input data for the following data variables: val2.""
   )
   expect_error(
-    process_data(data = list(val = 1), stan_file = stan_file),
+    process_data(data = list(val = 1), model_variables = mod$variables()),
     ""Missing input data for the following data variables: val1, val2.""
   )
   stan_file_no_data <- write_stan_file(""
@@ -297,7 +302,8 @@ test_that(""process_data() errors on missing variables"", {
     real val2 = 2;
   }
   "")
-  v <- process_data(data = list(val1 = 5), stan_file = stan_file_no_data)
+  mod <- cmdstan_model(stan_file_no_data, compile = FALSE)
+  v <- process_data(data = list(val1 = 5), model_variables = mod$variables())
   expect_type(v, ""character"")
 })
 
@@ -308,7 +314,8 @@ test_that(""process_data() corrrectly casts integers and floating point numbers"",
     real b;
   }
   "")
-  test_file <- process_data(list(a = 1, b = 2), stan_file = stan_file)
+  mod <- cmdstan_model(stan_file, compile = FALSE)
+  test_file <- process_data(list(a = 1, b = 2), model_variables = mod$variables())
   expect_match(
     ""  \""a\"": 1,"",
     readLines(test_file)[2],
@@ -319,7 +326,7 @@ test_that(""process_data() corrrectly casts integers and floating point numbers"",
     readLines(test_file)[3],
     fixed = TRUE
   )
-  test_file <- process_data(list(a = 1L, b = 1774000000), stan_file = stan_file)
+  test_file <- process_data(list(a = 1L, b = 1774000000), model_variables = mod$variables())
   expect_match(
     ""  \""a\"": 1,"",
     readLines(test_file)[2],",True,False,Implementation / Logic,6
stan-dev,cmdstanr,8a0c7faa5df041f933a5f973cb1530a4ab67ba48,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-09-14T20:19:24Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-09-14T20:19:24Z,fix process_data and process_init with included paths,R/args.R;R/data.R;R/model.R;tests/testthat/test-fit-shared.R,False,True,True,False,500,459,959,"---FILE: R/args.R---
@@ -35,7 +35,8 @@ CmdStanArgs <- R6::R6Class(
                           output_basename = NULL,
                           validate_csv = TRUE,
                           sig_figs = NULL,
-                          opencl_ids = NULL) {
+                          opencl_ids = NULL,
+                          include_paths = NULL) {
 
       self$model_name <- model_name
       self$exe_file <- exe_file
@@ -59,7 +60,7 @@ CmdStanArgs <- R6::R6Class(
       if (is.function(init)) {
         init <- process_init_function(init, length(self$proc_ids), stan_file)
       } else if (is.list(init) && !is.data.frame(init)) {
-        init <- process_init_list(init, length(self$proc_ids), stan_file)
+        init <- process_init_list(init, length(self$proc_ids), stan_file, include_paths)
       }
       self$init <- init
       self$opencl_ids <- opencl_ids
@@ -767,8 +768,9 @@ validate_exe_file <- function(exe_file) {
 #' @param init List of init lists.
 #' @param num_procs Number of CmdStan processes.
 #' @param stan_file Path to the Stan model file.
+#' @param include_paths Folders with Stan files included in the Stan model file.
 #' @return A character vector of file paths.
-process_init_list <- function(init, num_procs, stan_file = NULL) {
+process_init_list <- function(init, num_procs, stan_file = NULL, include_paths = NULL) {
   if (!all(sapply(init, function(x) is.list(x) && !is.data.frame(x)))) {
     stop(""If 'init' is a list it must be a list of lists."", call. = FALSE)
   }
@@ -782,7 +784,7 @@ process_init_list <- function(init, num_procs, stan_file = NULL) {
     stan_file <- absolute_path(stan_file)
     if (file.exists(stan_file)) {
       missing_parameter_values <- list()
-      parameter_names <- names(model_variables(stan_file)$parameters)
+      parameter_names <- names(model_variables(stan_file, include_paths)$parameters)
       for (i in seq_along(init)) {
         is_parameter_value_supplied <- parameter_names %in% names(init[[i]])
         if (!all(is_parameter_value_supplied)) {
@@ -832,8 +834,9 @@ process_init_list <- function(init, num_procs, stan_file = NULL) {
 #' @param init Function generating a single list of initial values.
 #' @param num_procs Number of CmdStan processes.
 #' @param stan_file Path to the Stan model file.
+#' @param include_paths Folders with Stan files included in the Stan model file.
 #' @return A character vector of file paths.
-process_init_function <- function(init, num_procs, stan_file = NULL) {
+process_init_function <- function(init, num_procs, stan_file = NULL, include_paths = NULL) {
   args <- formals(init)
   if (is.null(args)) {
     fn_test <- init()
@@ -849,7 +852,7 @@ process_init_function <- function(init, num_procs, stan_file = NULL) {
   if (!is.list(fn_test) || is.data.frame(fn_test)) {
     stop(""If 'init' is a function it must return a single list."")
   }
-  process_init_list(init_list, num_procs, stan_file)
+  process_init_list(init_list, num_procs, stan_file, include_paths)
 }
 
 #' Validate initial values

---FILE: R/data.R---
@@ -144,8 +144,9 @@ list_to_array <- function(x, name = NULL) {
 #'   required elements/Stan variables and to help differentiate between a
 #'   vector of length 1 and a scalar when genereting the JSON file. This
 #'   argument is ignored when a path to a data file is supplied for `data`.
+#' @param include_paths Folders with Stan files included in the Stan model file.
 #' @return Path to data file.
-process_data <- function(data, stan_file = NULL) {
+process_data <- function(data, stan_file = NULL, include_paths = NULL) {
   if (length(data) == 0) {
     data <- NULL
   }
@@ -165,7 +166,7 @@ process_data <- function(data, stan_file = NULL) {
     if (cmdstan_version() >= ""2.27.0"" && !is.null(stan_file)) {
       stan_file <- absolute_path(stan_file)
       if (file.exists(stan_file)) {
-        data_variables <- model_variables(stan_file)$data
+        data_variables <- model_variables(stan_file, include_paths)$data
         is_data_supplied <- names(data_variables) %in%  names(data)
         if (!all(is_data_supplied)) {
           missing <- names(data_variables[!is_data_supplied])

---FILE: R/model.R---
@@ -208,14 +208,17 @@ CmdStanModel <- R6::R6Class(
       private$precompile_cpp_options_ <- args$cpp_options %||% list()
       private$precompile_stanc_options_ <- assert_valid_stanc_options(args$stanc_options) %||% list()
       private$precompile_include_paths_ <- args$include_paths
+      private$include_paths_ <- args$include_paths
       private$dir_ <- args$dir
 
       if (compile) {
         self$compile(...)
       }
       invisible(self)
     },
-
+    include_paths = function() {
+      private$include_paths_
+    },
     code = function() {
       readLines(self$stan_file())
     },
@@ -372,6 +375,7 @@ compile <- function(quiet = TRUE,
   if (is.null(include_paths) && !is.null(private$precompile_include_paths_)) {
     include_paths <- private$precompile_include_paths_
   }
+  private$include_paths_ <- include_paths
   if (is.null(dir) && !is.null(private$dir_)) {
     dir <- absolute_path(private$dir_)
   } else if (!is.null(dir)) {
@@ -564,7 +568,7 @@ variables <- function() {
     stop(""$variables() is only supported for CmdStan 2.27 or newer."", call. = FALSE)
   }
   if (is.null(private$variables_)) {
-    private$variables_ <- model_variables(self$stan_file())
+    private$variables_ <- model_variables(self$stan_file(), self$include_paths())
   }
   private$variables_
 }
@@ -824,7 +828,7 @@ sample <- function(data = NULL,
     model_name = self$model_name(),
     exe_file = self$exe_file(),
     proc_ids = checkmate::assert_integerish(chain_ids, lower = 1, len = chains, unique = TRUE, null.ok = FALSE),
-    data_file = process_data(data, self$stan_file()),
+    data_file = process_data(data, self$stan_file(), self$include_paths()),
     save_latent_dynamics = save_latent_dynamics,
     seed = seed,
     init = init,
@@ -833,7 +837,8 @@ sample <- function(data = NULL,
     output_basename = output_basename,
     sig_figs = sig_figs,
     validate_csv = validate_csv,
-    opencl_ids = assert_valid_opencl(opencl_ids, self$cpp_options())
+    opencl_ids = assert_valid_opencl(opencl_ids, self$cpp_options()),
+    include_paths = self$include_paths()
   )
   runset <- CmdStanRun$new(args, procs)
   runset$run_cmdstan()
@@ -960,15 +965,16 @@ sample_mpi <- function(data = NULL,
     model_name = self$model_name(),
     exe_file = self$exe_file(),
     proc_ids = checkmate::assert_integerish(chain_ids, lower = 1, len = chains, unique = TRUE, null.ok = FALSE),
-    data_file = process_data(data, self$stan_file()),
+    data_file = process_data(data, self$stan_file(), self$include_paths()),
     save_latent_dynamics = save_latent_dynamics,
     seed = seed,
     init = init,
     refresh = refresh,
     output_dir = output_dir,
     output_basename = output_basename,
     validate_csv = validate_csv,
-    sig_figs = sig_figs
+    sig_figs = sig_figs,
+    include_paths = self$include_paths()
   )
   runset <- CmdStanRun$new(args, procs)
   runset$run_cmdstan_mpi(mpi_cmd, mpi_args)
@@ -1066,15 +1072,16 @@ optimize <- function(data = NULL,
     model_name = self$model_name(),
     exe_file = self$exe_file(),
     proc_ids = 1,
-    data_file = process_data(data, self$stan_file()),
+    data_file = process_data(data, self$stan_file(), self$include_paths()),
     save_latent_dynamics = save_latent_dynamics,
     seed = seed,
     init = init,
     refresh = refresh,
     output_dir = output_dir,
     output_basename = output_basename,
     sig_figs = sig_figs,
-    opencl_ids = assert_valid_opencl(opencl_ids, self$cpp_options())
+    opencl_ids = assert_valid_opencl(opencl_ids, self$cpp_options()),
+    include_paths = self$include_paths()
   )
   runset <- CmdStanRun$new(args, procs)
   runset$run_cmdstan()
@@ -1177,15 +1184,16 @@ variational <- function(data = NULL,
     model_name = self$model_name(),
     exe_file = self$exe_file(),
     proc_ids = 1,
-    data_file = process_data(data, self$stan_file()),
+    data_file = process_data(data, self$stan_file(), self$include_paths()),
     save_latent_dynamics = save_latent_dynamics,
     seed = seed,
     init = init,
     refresh = refresh,
     output_dir = output_dir,
     output_basename = output_basename,
     sig_figs = sig_figs,
-    opencl_ids = assert_valid_opencl(opencl_ids, self$cpp_options())
+    opencl_ids = assert_valid_opencl(opencl_ids, self$cpp_options()),
+    include_paths = self$include_paths()
   )
   runset <- CmdStanRun$new(args, procs)
   runset$run_cmdstan()
@@ -1280,12 +1288,13 @@ generate_quantities <- function(fitted_params,
     model_name = self$model_name(),
     exe_file = self$exe_file(),
     proc_ids = seq_along(fitted_params_files),
-    data_file = process_data(data, self$stan_file()),
+    data_file = process_data(data, self$stan_file(), self$include_paths()),
     seed = seed,
     output_dir = output_dir,
     output_basename = output_basename,
     sig_figs = sig_figs,
-    opencl_ids = assert_valid_opencl(opencl_ids, self$cpp_options())
+    opencl_ids = assert_valid_opencl(opencl_ids, self$cpp_options()),
+    include_paths = self$include_paths()
   )
   runset <- CmdStanRun$new(args, procs)
   runset$run_cmdstan()
@@ -1337,11 +1346,12 @@ diagnose_method <- function(data = NULL,
     model_name = self$model_name(),
     exe_file = self$exe_file(),
     proc_ids = 1,
-    data_file = process_data(data, self$stan_file()),
+    data_file = process_data(data, self$stan_file(), self$include_paths()),
     seed = seed,
     init = init,
     output_dir = output_dir,
-    output_basename = output_basename
+    output_basename = output_basename,
+    include_paths = self$include_paths()
   )
   runset <- CmdStanRun$new(args, procs)
   runset$run_cmdstan()
@@ -1442,11 +1452,11 @@ include_paths_stanc3_args <- function(include_paths = NULL) {
   stancflags
 }
 
-model_variables <- function(stan_file) {
+model_variables <- function(stan_file, include_paths = NULL) {
   out_file <- tempfile(fileext = "".json"")
   run_log <- processx::run(
     command = stanc_cmd(),
-    args = c(stan_file, ""--info""),
+    args = c(stan_file, ""--info"", include_paths_stanc3_args(include_paths)),
     wd = cmdstan_path(),
     echo = FALSE,
     echo_cmd = FALSE,

---FILE: tests/testthat/test-fit-shared.R---
@@ -3,449 +3,476 @@ context(""fitted-shared-methods"")
 if (not_on_cran()) {
   set_cmdstan_path()
 
-  fits <- list()
-  fits[[""sample""]] <- testing_fit(""logistic"", method = ""sample"",
-                                  seed = 123, save_latent_dynamics = TRUE)
-  fits[[""variational""]] <- testing_fit(""logistic"", method = ""variational"",
-                                       seed = 123, save_latent_dynamics = TRUE)
-  fits[[""optimize""]] <- testing_fit(""logistic"", method = ""optimize"", seed = 123)
-  fit_bern <- testing_fit(""bernoulli"", method = ""sample"", seed = 123)
-  fits[[""generate_quantities""]] <- testing_fit(""bernoulli_ppc"", method = ""generate_quantities"", fitted_params = fit_bern, seed = 123)
-  all_methods <- c(""sample"", ""optimize"", ""variational"", ""generate_quantities"")
+  # fits <- list()
+  # fits[[""sample""]] <- testing_fit(""logistic"", method = ""sample"",
+  #                                 seed = 123, save_latent_dynamics = TRUE)
+  # fits[[""variational""]] <- testing_fit(""logistic"", method = ""variational"",
+  #                                      seed = 123, save_latent_dynamics = TRUE)
+  # fits[[""optimize""]] <- testing_fit(""logistic"", method = ""optimize"", seed = 123)
+  # fit_bern <- testing_fit(""bernoulli"", method = ""sample"", seed = 123)
+  # fits[[""generate_quantities""]] <- testing_fit(""bernoulli_ppc"", method = ""generate_quantities"", fitted_params = fit_bern, seed = 123)
+  # all_methods <- c(""sample"", ""optimize"", ""variational"", ""generate_quantities"")
 }
 
-test_that(""*_files() methods return the right number of paths"", {
+# test_that(""*_files() methods return the right number of paths"", {
+#   skip_on_cran()
+#   for (method in all_methods) {
+#     expect_length(fits[[method]]$output_files(), fits[[method]]$num_procs())
+#     expect_length(fits[[method]]$data_file(), 1)
+#     if (method %in% c(""sample"", ""variational"")) {
+#       expect_length(fits[[method]]$latent_dynamics_files(), fits[[method]]$num_procs())
+#     }
+#   }
+# })
+
+# test_that(""saving csv output files works"", {
+#   skip_on_cran()
+
+#   for (method in all_methods) {
+#     fit <- fits[[method]]
+#     old_paths <- fit$output_files()
+#     checkmate::expect_file_exists(old_paths, extension = ""csv"")
+
+#     expect_message(
+#       paths <- fit$save_output_files(tempdir(), basename = ""testing-output""),
+#       paste(""Moved"", fit$num_procs(), ""files and set internal paths"")
+#     )
+#     checkmate::expect_file_exists(paths, extension = ""csv"")
+#     expect_true(all(file.size(paths) > 0))
+
+#     should_match <- paste0(""testing-output-"",
+#                            format(Sys.time(), ""%Y%m%d%H%M""),
+#                            ""-"",
+#                            seq_len(fit$num_procs()))
+#     for (j in seq_along(paths)) {
+#       expect_match(paths[j], should_match[j])
+#     }
+
+#     expect_false(any(file.exists(old_paths)))
+#     expect_equal(fit$output_files(), paths)
+#   }
+# })
+
+# test_that(""saving diagnostic csv output works"", {
+#   skip_on_cran()
+
+#   for (method in all_methods) {
+#     fit <- fits[[method]]
+#     if (!(method %in% c(""sample"", ""variational""))) {
+#       expect_error(
+#         fit$save_latent_dynamics_files(),
+#         ""No latent dynamics files found. Set 'save_latent_dynamics=TRUE' when fitting the model"",
+#         fixed = TRUE
+#       )
+#       next
+#     }
+
+#     old_paths <- fit$latent_dynamics_files()
+#     checkmate::expect_file_exists(old_paths, extension = ""csv"")
+
+#     expect_message(
+#       paths <- fit$save_latent_dynamics_files(tempdir(), basename = ""testing-output""),
+#       paste(""Moved"", fit$num_procs(), ""files and set internal paths"")
+#     )
+#     checkmate::expect_file_exists(paths, extension = ""csv"")
+#     expect_true(all(file.size(paths) > 0))
+
+#     should_match <- paste0(""testing-output-diagnostic-"",
+#                            format(Sys.time(), ""%Y%m%d%H%M""),
+#                            ""-"",
+#                            seq_len(fit$num_procs()))
+
+#     for (j in seq_along(paths)) {
+#       expect_match(paths[j], should_match[j])
+#     }
+
+#     expect_false(any(file.exists(old_paths)))
+#     expect_equal(fit$latent_dynamics_files(), paths)
+#   }
+# })
+
+# test_that(""saving data file works"", {
+#   skip_on_cran()
+
+#   for (method in all_methods) {
+#     fit <- fits[[method]]
+#     old_path <- fit$data_file()
+#     checkmate::expect_file_exists(old_path, extension = ""json"")
+
+#     expect_message(
+#       path <- fit$save_data_file(tempdir(), basename = NULL,
+#                                  timestamp = FALSE, random = FALSE),
+#       ""Moved data file and set internal path""
+#     )
+#     checkmate::expect_file_exists(path, extension = ""json"")
+#     expect_true(file.size(path) > 0)
+#     if(method == ""generate_quantities"") {
+#       expect_equal(basename(path), ""bernoulli_ppc.json"")
+#     } else {
+#       expect_equal(basename(path), ""logistic.json"")
+#     }
+#     expect_false(file.exists(old_path))
+#     expect_equal(fit$data_file(), path)
+#   }
+# })
+
+# test_that(""cmdstan_summary() and cmdstan_diagnose() work correctly"", {
+#   skip_on_cran()
+#   for (method in all_methods) {
+#     fit <- fits[[method]]
+#     if (method == ""optimize"") {
+#       expect_error(fit$cmdstan_summary(), ""Not available for optimize method"")
+#       expect_error(fit$cmdstan_diagnose(), ""Not available for optimize method"")
+#     } else if (method == ""generate_quantities"") {
+#       expect_error(fit$cmdstan_summary(), ""Not available for generate_quantities method"")
+#       expect_error(fit$cmdstan_diagnose(), ""Not available for generate_quantities method"")
+#     } else if (method == ""sample"") {
+#       expect_output(fit$cmdstan_summary(), ""Inference for Stan model"")
+#       expect_output(fit$cmdstan_diagnose(), ""Processing complete"")
+#     }
+#   }
+# })
+
+# test_that(""draws() method returns a 'draws' object"", {
+#   skip_on_cran()
+#   for (method in all_methods) {
+#     fit <- fits[[method]]
+#     draws <- fit$draws()
+#     if (method == ""generate_quantities"") {
+#       expect_type(draws, ""integer"")
+#     } else {
+#       expect_type(draws, ""double"")
+#     }
+#     expect_s3_class(draws, ""draws"")
+
+#     if (method != ""sample"") {
+#       expect_warning(
+#         fit$draws(inc_warmup = TRUE),
+#         ""'inc_warmup' is ignored except when used with CmdStanMCMC objects""
+#       )
+#     }
+#   }
+# })
+
+# test_that(""save_object() method works"", {
+#   skip_on_cran()
+#   for (method in all_methods) {
+#     fit <- fits[[method]]
+#     temp_rds_file <- tempfile(fileext = "".RDS"")
+#     fit$save_object(temp_rds_file)
+#     fit2 <- readRDS(temp_rds_file)
+#     expect_identical(fit2$summary(), fit$summary())
+#   }
+
+#   # check after garbage collection too
+#   temp_rds_file <- tempfile(fileext = "".RDS"")
+#   fit <- testing_fit(""logistic"", method = ""sample"", seed = 123)
+#   fit$save_object(temp_rds_file)
+#   s <- fit$summary()
+#   rm(fit); gc()
+#   fit <- readRDS(temp_rds_file)
+#   expect_identical(fit$summary(), s)
+# })
+
+# test_that(""save_object() method works with profiles"", {
+#   skip_on_cran()
+#   mod <- testing_model(""logistic_profiling"")
+#   utils::capture.output(
+#     fit <- mod$sample(data = testing_data(""logistic""), refresh = 0, seed = 123)
+#   )
+#   # check after garbage collection too
+#   temp_rds_file <- tempfile(fileext = "".RDS"")
+#   fit$save_object(temp_rds_file)
+#   s <- fit$profiles()
+#   rm(fit); gc()
+#   fit <- readRDS(temp_rds_file)
+#   expect_identical(fit$profiles(), s)
+# })
+
+# test_that(""metadata() returns list"", {
+#   for (method in all_methods) {
+#     fit <- fits[[method]]
+#     expect_type(fit$metadata(), ""list"")
+#     expect_equal(fit$metadata()$method, method)
+#   }
+# })
+
+# test_that(""init() errors if no inits specified"", {
+#   # only checking for errors, correct behavior tested in test-model-init.R
+#   for (method in all_methods) {
+#     fit <- fits[[method]]
+#     expect_error(fit$init(), ""Can't find initial values files"")
+#   }
+# })
+
+# test_that(""return_codes method works properly"", {
+#   skip_on_cran()
+#   expect_equal(fits[[""variational""]]$return_codes(), 0)
+#   expect_equal(fits[[""optimize""]]$return_codes(), 0)
+#   expect_equal(fits[[""sample""]]$return_codes(), c(0,0,0,0))
+#   expect_equal(fits[[""generate_quantities""]]$return_codes(), c(0,0,0,0))
+
+#   # non-zero
+#   non_zero <- testing_fit(""schools"", method = ""optimize"", seed = 123)
+#   expect_gt(non_zero$return_codes(), 0)
+# })
+
+# test_that(""output and latent dynamics files are cleaned up correctly"", {
+#   skip_on_cran()
+#   for (method in c(""sample"", ""variational"")) {
+#     fit <- testing_fit(""logistic"", method = method, seed = 123, save_latent_dynamics = TRUE)
+#     out_files <- fit$output_files()
+#     latent_dynamics_files <- fit$latent_dynamics_files()
+#     expect_true(all(file.exists(out_files)))
+#     expect_true(all(file.exists(latent_dynamics_files)))
+#     rm(fit)
+#     gc()
+#     expect_true(!any(file.exists(out_files)))
+#     expect_true(!any(file.exists(latent_dynamics_files)))
+
+#     fit <- testing_fit(""logistic"", method = method, seed = 123, save_latent_dynamics = TRUE)
+#     fit$save_output_files(dir = tempdir())
+#     out_files <- fit$output_files()
+#     latent_dynamics_files <- fit$latent_dynamics_files()
+#     expect_true(all(file.exists(out_files)))
+#     expect_true(all(file.exists(latent_dynamics_files)))
+#     rm(fit)
+#     gc()
+#     expect_true(all(file.exists(out_files)))
+#     expect_true(!any(file.exists(latent_dynamics_files)))
+#     file.remove(out_files)
+
+#     fit <- testing_fit(""logistic"", method = method, seed = 123, save_latent_dynamics = TRUE)
+#     fit$save_latent_dynamics_files(dir = tempdir())
+#     out_files <- fit$output_files()
+#     latent_dynamics_files <- fit$latent_dynamics_files()
+#     expect_true(all(file.exists(out_files)))
+#     expect_true(all(file.exists(latent_dynamics_files)))
+#     rm(fit)
+#     gc()
+#     expect_true(!any(file.exists(out_files)))
+#     expect_true(all(file.exists(latent_dynamics_files)))
+#     file.remove(latent_dynamics_files)
+
+#     fit <- testing_fit(""logistic"", method = method, seed = 123, save_latent_dynamics = TRUE)
+#     fit$save_output_files(dir = tempdir())
+#     fit$save_latent_dynamics_files(dir = tempdir())
+#     out_files <- fit$output_files()
+#     latent_dynamics_files <- fit$latent_dynamics_files()
+#     expect_true(all(file.exists(out_files)))
+#     expect_true(all(file.exists(latent_dynamics_files)))
+#     rm(fit)
+#     gc()
+#     expect_true(all(file.exists(out_files)))
+#     expect_true(all(file.exists(latent_dynamics_files)))
+#     file.remove(out_files)
+#     file.remove(latent_dynamics_files)
+#   }
+# })
+
+# test_that(""CmdStanArgs erorrs if idx is out of proc_ids range"", {
+#   skip_on_cran()
+#   data_file <- test_path(""resources"", ""data"", ""bernoulli.data.json"")
+#   mod <- testing_model(""bernoulli"")
+#   arg <- CmdStanArgs$new(
+#     method_args = SampleArgs$new(),
+#     model_name = ""bernoulli"",
+#     exe_file = mod$exe_file(),
+#     data_file = data_file,
+#     proc_ids = c(1,2,3,4)
+#   )
+#   expect_error(
+#     arg$compose_all_args(idx = 5),
+#     ""Index \\(5\\) exceeds number of CmdStan processes \\(4\\).""
+#   )
+# })
+
+# test_that(""no output with refresh = 0"", {
+#   skip_on_cran()
+#   mod <- testing_model(""logistic"")
+#   data_list <- testing_data(""logistic"")
+#   output <- utils::capture.output(tmp <- mod$variational(data = data_list, seed = 123))
+#   expect_gt(length(output), 1)
+#   output <- utils::capture.output(tmp <- mod$optimize(data = data_list, seed = 123))
+#   expect_gt(length(output), 1)
+#   output <- utils::capture.output(tmp <- mod$sample(data = data_list, chains = 1, seed = 123))
+#   expect_gt(length(output), 1)
+
+#   output <- utils::capture.output(tmp <- mod$variational(data = data_list, refresh = 0, seed = 123))
+#   expect_equal(length(output), 1)
+#   output <- utils::capture.output(tmp <- mod$optimize(data = data_list, refresh = 0, seed = 123))
+#   expect_equal(length(output), 1)
+#   output <- utils::capture.output(tmp <- mod$sample(data = data_list, refresh = 0, chains = 1, seed = 123))
+#   expect_equal(length(output), 3)
+# })
+
+# test_that(""sig_figs works with all methods"", {
+#   skip_on_cran()
+#   m <- ""data {
+#     int<lower=0> N;
+#     int<lower=0> K;
+#     int<lower=0,upper=1> y[N];
+#     matrix[N, K] X;
+#   }
+#   parameters {
+#     real alpha;
+#     vector[K] beta;
+#   }
+#   model {
+#     target += normal_lpdf(alpha | 0, 1);
+#     target += normal_lpdf(beta | 0, 1);
+#     target += bernoulli_logit_glm_lpmf(y | X, alpha, beta);
+#   }
+#   generated quantities {
+#     real p2 = 0.12;
+#     real p5 = 0.12345;
+#     real p9 = 0.123456789;
+#   }""
+#   mod <- cmdstan_model(write_stan_file(m))
+#   utils::capture.output(
+#     sample <- mod$sample(sig_figs = 2, refresh = 0, data = testing_data(""logistic""))
+#   )
+#   expect_equal(
+#     as.numeric(posterior::subset_draws(sample$draws(), variable = c(""p2"",""p5"", ""p9""), iteration = 1, chain = 1)),
+#     c(0.12, 0.12, 0.12)
+#   )
+#   utils::capture.output(
+#     sample <- mod$sample(sig_figs = 5, refresh = 0, data = testing_data(""logistic""))
+#   )
+#   expect_equal(
+#     as.numeric(posterior::subset_draws(sample$draws(), variable = c(""p2"",""p5"", ""p9""), iteration = 1, chain = 1)),
+#     c(0.12, 0.12345, 0.12346)
+#   )
+#   utils::capture.output(
+#     sample <- mod$sample(sig_figs = 10, refresh = 0, data = testing_data(""logistic""))
+#   )
+#   expect_equal(
+#     as.numeric(posterior::subset_draws(sample$draws(), variable = c(""p2"",""p5"", ""p9""), iteration = 1, chain = 1)),
+#     c(0.12, 0.12345, 0.123456789)
+#   )
+#   utils::capture.output(
+#     variational <- mod$variational(sig_figs = 2, refresh = 0, data = testing_data(""logistic""))
+#   )
+#   expect_equal(
+#     as.numeric(posterior::subset_draws(variational$draws(), variable = c(""p2"",""p5"", ""p9""), iteration = 1, chain = 1)),
+#     c(0.12, 0.12, 0.12)
+#   )
+#   utils::capture.output(
+#     variational <- mod$variational(sig_figs = 5, refresh = 0, data = testing_data(""logistic""))
+#   )
+#   expect_equal(
+#     as.numeric(posterior::subset_draws(variational$draws(), variable = c(""p2"",""p5"", ""p9""), iteration = 1, chain = 1)),
+#     c(0.12, 0.12345, 0.12346)
+#   )
+#   utils::capture.output(
+#     variational <- mod$variational(sig_figs = 10, refresh = 0, data = testing_data(""logistic""))
+#   )
+#   expect_equal(
+#     as.numeric(posterior::subset_draws(variational$draws(), variable = c(""p2"",""p5"", ""p9""), iteration = 1, chain = 1)),
+#     c(0.12, 0.12345, 0.123456789)
+#   )
+#   utils::capture.output(
+#     gq <- mod$generate_quantities(fitted_params = sample, sig_figs = 2, data = testing_data(""logistic""))
+#   )
+#   expect_equal(
+#     as.numeric(posterior::subset_draws(gq$draws(), variable = c(""p2"",""p5"", ""p9""), iteration = 1, chain = 1)),
+#     c(0.12, 0.12, 0.12)
+#   )
+#   utils::capture.output(
+#     gq <- mod$generate_quantities(fitted_params = sample, sig_figs = 5, data = testing_data(""logistic""))
+#   )
+#   expect_equal(
+#     as.numeric(posterior::subset_draws(gq$draws(), variable = c(""p2"",""p5"", ""p9""), iteration = 1, chain = 1)),
+#     c(0.12, 0.12345, 0.12346)
+#   )
+#   utils::capture.output(
+#     gq <- mod$generate_quantities(fitted_params = sample, sig_figs = 10, data = testing_data(""logistic""))
+#   )
+#   expect_equal(
+#     as.numeric(posterior::subset_draws(gq$draws(), variable = c(""p2"",""p5"", ""p9""), iteration = 1, chain = 1)),
+#     c(0.12, 0.12345, 0.123456789)
+#   )
+#   utils::capture.output(
+#     opt <- mod$optimize(sig_figs = 2, refresh = 0, data = testing_data(""logistic""), seed = 123)
+#   )
+#   expect_equal(
+#     as.numeric(opt$mle()[c(""p2"",""p5"", ""p9"")]),
+#     c(0.12, 0.12, 0.12)
+#   )
+#   utils::capture.output(
+#     opt <- mod$optimize(sig_figs = 5, refresh = 0, data = testing_data(""logistic""), seed = 123)
+#   )
+#   expect_equal(
+#     as.numeric(opt$mle()[c(""p2"",""p5"", ""p9"")]),
+#     c(0.12, 0.12345, 0.12346)
+#   )
+#   utils::capture.output(
+#     opt <- mod$optimize(sig_figs = 10, refresh = 0, data = testing_data(""logistic""), seed = 123)
+#   )
+#   expect_equal(
+#     as.numeric(opt$mle()[c(""p2"",""p5"", ""p9"")]),
+#     c(0.12, 0.12345, 0.123456789)
+#   )
+# })
+
+# test_that(""draws are returned for model with spaces"", {
+#   skip_on_cran()
+#   m <- ""
+#   parameters {
+#     real y;
+#   }
+#   model {
+#     y ~ std_normal();
+#   }
+#   generated quantities {
+#     real two_y = 2 * y;
+#   }
+#   ""
+#   f <- write_stan_file(m, basename = ""file with spaces"")
+#   expect_equal(basename(f), ""file with spaces.stan"")
+#   mod <- cmdstan_model(f)
+#   utils::capture.output(
+#     fit_sample <- mod$sample(seed = 123, iter_sampling = 1000, chains = 1)
+#   )
+#   expect_equal(dim(fit_sample$draws()), c(1000, 1, 3))
+#   utils::capture.output(
+#     fit <- mod$variational(seed = 123, output_samples = 1000)
+#   )
+#   expect_equal(dim(fit$draws()), c(1000, 4))
+#   utils::capture.output(
+#     fit <- mod$optimize(seed = 123)
+#   )
+#   expect_equal(length(fit$mle()), 2)
+
+#   utils::capture.output(
+#     fit <- mod$generate_quantities(fitted_params = fit_sample, seed = 123)
+#   )
+#   expect_equal(dim(fit$draws()), c(1000, 1, 1))
+# })
+
+test_that(""compilation works with include_paths"", {
   skip_on_cran()
-  for (method in all_methods) {
-    expect_length(fits[[method]]$output_files(), fits[[method]]$num_procs())
-    expect_length(fits[[method]]$data_file(), 1)
-    if (method %in% c(""sample"", ""variational"")) {
-      expect_length(fits[[method]]$latent_dynamics_files(), fits[[method]]$num_procs())
-    }
-  }
-})
-
-test_that(""saving csv output files works"", {
-  skip_on_cran()
-
-  for (method in all_methods) {
-    fit <- fits[[method]]
-    old_paths <- fit$output_files()
-    checkmate::expect_file_exists(old_paths, extension = ""csv"")
-
-    expect_message(
-      paths <- fit$save_output_files(tempdir(), basename = ""testing-output""),
-      paste(""Moved"", fit$num_procs(), ""files and set internal paths"")
-    )
-    checkmate::expect_file_exists(paths, extension = ""csv"")
-    expect_true(all(file.size(paths) > 0))
-
-    should_match <- paste0(""testing-output-"",
-                           format(Sys.time(), ""%Y%m%d%H%M""),
-                           ""-"",
-                           seq_len(fit$num_procs()))
-    for (j in seq_along(paths)) {
-      expect_match(paths[j], should_match[j])
-    }
-
-    expect_false(any(file.exists(old_paths)))
-    expect_equal(fit$output_files(), paths)
-  }
-})
-
-test_that(""saving diagnostic csv output works"", {
-  skip_on_cran()
-
-  for (method in all_methods) {
-    fit <- fits[[method]]
-    if (!(method %in% c(""sample"", ""variational""))) {
-      expect_error(
-        fit$save_latent_dynamics_files(),
-        ""No latent dynamics files found. Set 'save_latent_dynamics=TRUE' when fitting the model"",
-        fixed = TRUE
-      )
-      next
-    }
-
-    old_paths <- fit$latent_dynamics_files()
-    checkmate::expect_file_exists(old_paths, extension = ""csv"")
-
-    expect_message(
-      paths <- fit$save_latent_dynamics_files(tempdir(), basename = ""testing-output""),
-      paste(""Moved"", fit$num_procs(), ""files and set internal paths"")
-    )
-    checkmate::expect_file_exists(paths, extension = ""csv"")
-    expect_true(all(file.size(paths) > 0))
-
-    should_match <- paste0(""testing-output-diagnostic-"",
-                           format(Sys.time(), ""%Y%m%d%H%M""),
-                           ""-"",
-                           seq_len(fit$num_procs()))
-
-    for (j in seq_along(paths)) {
-      expect_match(paths[j], should_match[j])
-    }
-
-    expect_false(any(file.exists(old_paths)))
-    expect_equal(fit$latent_dynamics_files(), paths)
-  }
-})
-
-test_that(""saving data file works"", {
-  skip_on_cran()
-
-  for (method in all_methods) {
-    fit <- fits[[method]]
-    old_path <- fit$data_file()
-    checkmate::expect_file_exists(old_path, extension = ""json"")
-
-    expect_message(
-      path <- fit$save_data_file(tempdir(), basename = NULL,
-                                 timestamp = FALSE, random = FALSE),
-      ""Moved data file and set internal path""
-    )
-    checkmate::expect_file_exists(path, extension = ""json"")
-    expect_true(file.size(path) > 0)
-    if(method == ""generate_quantities"") {
-      expect_equal(basename(path), ""bernoulli_ppc.json"")
-    } else {
-      expect_equal(basename(path), ""logistic.json"")
-    }
-    expect_false(file.exists(old_path))
-    expect_equal(fit$data_file(), path)
-  }
-})
-
-test_that(""cmdstan_summary() and cmdstan_diagnose() work correctly"", {
-  skip_on_cran()
-  for (method in all_methods) {
-    fit <- fits[[method]]
-    if (method == ""optimize"") {
-      expect_error(fit$cmdstan_summary(), ""Not available for optimize method"")
-      expect_error(fit$cmdstan_diagnose(), ""Not available for optimize method"")
-    } else if (method == ""generate_quantities"") {
-      expect_error(fit$cmdstan_summary(), ""Not available for generate_quantities method"")
-      expect_error(fit$cmdstan_diagnose(), ""Not available for generate_quantities method"")
-    } else if (method == ""sample"") {
-      expect_output(fit$cmdstan_summary(), ""Inference for Stan model"")
-      expect_output(fit$cmdstan_diagnose(), ""Processing complete"")
-    }
-  }
-})
-
-test_that(""draws() method returns a 'draws' object"", {
-  skip_on_cran()
-  for (method in all_methods) {
-    fit <- fits[[method]]
-    draws <- fit$draws()
-    if (method == ""generate_quantities"") {
-      expect_type(draws, ""integer"")
-    } else {
-      expect_type(draws, ""double"")
-    }
-    expect_s3_class(draws, ""draws"")
-
-    if (method != ""sample"") {
-      expect_warning(
-        fit$draws(inc_warmup = TRUE),
-        ""'inc_warmup' is ignored except when used with CmdStanMCMC objects""
-      )
-    }
-  }
-})
-
-test_that(""save_object() method works"", {
-  skip_on_cran()
-  for (method in all_methods) {
-    fit <- fits[[method]]
-    temp_rds_file <- tempfile(fileext = "".RDS"")
-    fit$save_object(temp_rds_file)
-    fit2 <- readRDS(temp_rds_file)
-    expect_identical(fit2$summary(), fit$summary())
-  }
-
-  # check after garbage collection too
-  temp_rds_file <- tempfile(fileext = "".RDS"")
-  fit <- testing_fit(""logistic"", method = ""sample"", seed = 123)
-  fit$save_object(temp_rds_file)
-  s <- fit$summary()
-  rm(fit); gc()
-  fit <- readRDS(temp_rds_file)
-  expect_identical(fit$summary(), s)
-})
-
-test_that(""save_object() method works with profiles"", {
-  skip_on_cran()
-  mod <- testing_model(""logistic_profiling"")
-  utils::capture.output(
-    fit <- mod$sample(data = testing_data(""logistic""), refresh = 0, seed = 123)
-  )
-  # check after garbage collection too
-  temp_rds_file <- tempfile(fileext = "".RDS"")
-  fit$save_object(temp_rds_file)
-  s <- fit$profiles()
-  rm(fit); gc()
-  fit <- readRDS(temp_rds_file)
-  expect_identical(fit$profiles(), s)
-})
-
-test_that(""metadata() returns list"", {
-  for (method in all_methods) {
-    fit <- fits[[method]]
-    expect_type(fit$metadata(), ""list"")
-    expect_equal(fit$metadata()$method, method)
-  }
-})
 
-test_that(""init() errors if no inits specified"", {
-  # only checking for errors, correct behavior tested in test-model-init.R
-  for (method in all_methods) {
-    fit <- fits[[method]]
-    expect_error(fit$init(), ""Can't find initial values files"")
-  }
-})
-
-test_that(""return_codes method works properly"", {
-  skip_on_cran()
-  expect_equal(fits[[""variational""]]$return_codes(), 0)
-  expect_equal(fits[[""optimize""]]$return_codes(), 0)
-  expect_equal(fits[[""sample""]]$return_codes(), c(0,0,0,0))
-  expect_equal(fits[[""generate_quantities""]]$return_codes(), c(0,0,0,0))
-
-  # non-zero
-  non_zero <- testing_fit(""schools"", method = ""optimize"", seed = 123)
-  expect_gt(non_zero$return_codes(), 0)
-})
-
-test_that(""output and latent dynamics files are cleaned up correctly"", {
-  skip_on_cran()
-  for (method in c(""sample"", ""variational"")) {
-    fit <- testing_fit(""logistic"", method = method, seed = 123, save_latent_dynamics = TRUE)
-    out_files <- fit$output_files()
-    latent_dynamics_files <- fit$latent_dynamics_files()
-    expect_true(all(file.exists(out_files)))
-    expect_true(all(file.exists(latent_dynamics_files)))
-    rm(fit)
-    gc()
-    expect_true(!any(file.exists(out_files)))
-    expect_true(!any(file.exists(latent_dynamics_files)))
-
-    fit <- testing_fit(""logistic"", method = method, seed = 123, save_latent_dynamics = TRUE)
-    fit$save_output_files(dir = tempdir())
-    out_files <- fit$output_files()
-    latent_dynamics_files <- fit$latent_dynamics_files()
-    expect_true(all(file.exists(out_files)))
-    expect_true(all(file.exists(latent_dynamics_files)))
-    rm(fit)
-    gc()
-    expect_true(all(file.exists(out_files)))
-    expect_true(!any(file.exists(latent_dynamics_files)))
-    file.remove(out_files)
-
-    fit <- testing_fit(""logistic"", method = method, seed = 123, save_latent_dynamics = TRUE)
-    fit$save_latent_dynamics_files(dir = tempdir())
-    out_files <- fit$output_files()
-    latent_dynamics_files <- fit$latent_dynamics_files()
-    expect_true(all(file.exists(out_files)))
-    expect_true(all(file.exists(latent_dynamics_files)))
-    rm(fit)
-    gc()
-    expect_true(!any(file.exists(out_files)))
-    expect_true(all(file.exists(latent_dynamics_files)))
-    file.remove(latent_dynamics_files)
-
-    fit <- testing_fit(""logistic"", method = method, seed = 123, save_latent_dynamics = TRUE)
-    fit$save_output_files(dir = tempdir())
-    fit$save_latent_dynamics_files(dir = tempdir())
-    out_files <- fit$output_files()
-    latent_dynamics_files <- fit$latent_dynamics_files()
-    expect_true(all(file.exists(out_files)))
-    expect_true(all(file.exists(latent_dynamics_files)))
-    rm(fit)
-    gc()
-    expect_true(all(file.exists(out_files)))
-    expect_true(all(file.exists(latent_dynamics_files)))
-    file.remove(out_files)
-    file.remove(latent_dynamics_files)
+  stan_program_w_include <- testing_stan_file(""bernoulli_include"")
+  exe <- cmdstan_ext(strip_ext(stan_program_w_include))
+  if(file.exists(exe)) {
+    file.remove(exe)
   }
-})
-
-test_that(""CmdStanArgs erorrs if idx is out of proc_ids range"", {
-  skip_on_cran()
-  data_file <- test_path(""resources"", ""data"", ""bernoulli.data.json"")
-  mod <- testing_model(""bernoulli"")
-  arg <- CmdStanArgs$new(
-    method_args = SampleArgs$new(),
-    model_name = ""bernoulli"",
-    exe_file = mod$exe_file(),
-    data_file = data_file,
-    proc_ids = c(1,2,3,4)
-  )
-  expect_error(
-    arg$compose_all_args(idx = 5),
-    ""Index \\(5\\) exceeds number of CmdStan processes \\(4\\).""
-  )
-})
 
-test_that(""no output with refresh = 0"", {
-  skip_on_cran()
-  mod <- testing_model(""logistic"")
-  data_list <- testing_data(""logistic"")
-  output <- utils::capture.output(tmp <- mod$variational(data = data_list, seed = 123))
-  expect_gt(length(output), 1)
-  output <- utils::capture.output(tmp <- mod$optimize(data = data_list, seed = 123))
-  expect_gt(length(output), 1)
-  output <- utils::capture.output(tmp <- mod$sample(data = data_list, chains = 1, seed = 123))
-  expect_gt(length(output), 1)
-
-  output <- utils::capture.output(tmp <- mod$variational(data = data_list, refresh = 0, seed = 123))
-  expect_equal(length(output), 1)
-  output <- utils::capture.output(tmp <- mod$optimize(data = data_list, refresh = 0, seed = 123))
-  expect_equal(length(output), 1)
-  output <- utils::capture.output(tmp <- mod$sample(data = data_list, refresh = 0, chains = 1, seed = 123))
-  expect_equal(length(output), 3)
-})
-
-test_that(""sig_figs works with all methods"", {
-  skip_on_cran()
-  m <- ""data {
-    int<lower=0> N;
-    int<lower=0> K;
-    int<lower=0,upper=1> y[N];
-    matrix[N, K] X;
-  }
-  parameters {
-    real alpha;
-    vector[K] beta;
-  }
-  model {
-    target += normal_lpdf(alpha | 0, 1);
-    target += normal_lpdf(beta | 0, 1);
-    target += bernoulli_logit_glm_lpmf(y | X, alpha, beta);
-  }
-  generated quantities {
-    real p2 = 0.12;
-    real p5 = 0.12345;
-    real p9 = 0.123456789;
-  }""
-  mod <- cmdstan_model(write_stan_file(m))
-  utils::capture.output(
-    sample <- mod$sample(sig_figs = 2, refresh = 0, data = testing_data(""logistic""))
-  )
-  expect_equal(
-    as.numeric(posterior::subset_draws(sample$draws(), variable = c(""p2"",""p5"", ""p9""), iteration = 1, chain = 1)),
-    c(0.12, 0.12, 0.12)
-  )
-  utils::capture.output(
-    sample <- mod$sample(sig_figs = 5, refresh = 0, data = testing_data(""logistic""))
-  )
-  expect_equal(
-    as.numeric(posterior::subset_draws(sample$draws(), variable = c(""p2"",""p5"", ""p9""), iteration = 1, chain = 1)),
-    c(0.12, 0.12345, 0.12346)
-  )
-  utils::capture.output(
-    sample <- mod$sample(sig_figs = 10, refresh = 0, data = testing_data(""logistic""))
-  )
-  expect_equal(
-    as.numeric(posterior::subset_draws(sample$draws(), variable = c(""p2"",""p5"", ""p9""), iteration = 1, chain = 1)),
-    c(0.12, 0.12345, 0.123456789)
-  )
-  utils::capture.output(
-    variational <- mod$variational(sig_figs = 2, refresh = 0, data = testing_data(""logistic""))
-  )
-  expect_equal(
-    as.numeric(posterior::subset_draws(variational$draws(), variable = c(""p2"",""p5"", ""p9""), iteration = 1, chain = 1)),
-    c(0.12, 0.12, 0.12)
-  )
-  utils::capture.output(
-    variational <- mod$variational(sig_figs = 5, refresh = 0, data = testing_data(""logistic""))
-  )
-  expect_equal(
-    as.numeric(posterior::subset_draws(variational$draws(), variable = c(""p2"",""p5"", ""p9""), iteration = 1, chain = 1)),
-    c(0.12, 0.12345, 0.12346)
+  expect_interactive_message(
+    mod_w_include <- cmdstan_model(stan_file = stan_program_w_include, quiet = TRUE,
+                                   include_paths = test_path(""resources"", ""stan"")),
+    ""Compiling Stan program""
   )
-  utils::capture.output(
-    variational <- mod$variational(sig_figs = 10, refresh = 0, data = testing_data(""logistic""))
-  )
-  expect_equal(
-    as.numeric(posterior::subset_draws(variational$draws(), variable = c(""p2"",""p5"", ""p9""), iteration = 1, chain = 1)),
-    c(0.12, 0.12345, 0.123456789)
-  )
-  utils::capture.output(
-    gq <- mod$generate_quantities(fitted_params = sample, sig_figs = 2, data = testing_data(""logistic""))
-  )
-  expect_equal(
-    as.numeric(posterior::subset_draws(gq$draws(), variable = c(""p2"",""p5"", ""p9""), iteration = 1, chain = 1)),
-    c(0.12, 0.12, 0.12)
-  )
-  utils::capture.output(
-    gq <- mod$generate_quantities(fitted_params = sample, sig_figs = 5, data = testing_data(""logistic""))
-  )
-  expect_equal(
-    as.numeric(posterior::subset_draws(gq$draws(), variable = c(""p2"",""p5"", ""p9""), iteration = 1, chain = 1)),
-    c(0.12, 0.12345, 0.12346)
-  )
-  utils::capture.output(
-    gq <- mod$generate_quantities(fitted_params = sample, sig_figs = 10, data = testing_data(""logistic""))
-  )
-  expect_equal(
-    as.numeric(posterior::subset_draws(gq$draws(), variable = c(""p2"",""p5"", ""p9""), iteration = 1, chain = 1)),
-    c(0.12, 0.12345, 0.123456789)
-  )
-  utils::capture.output(
-    opt <- mod$optimize(sig_figs = 2, refresh = 0, data = testing_data(""logistic""), seed = 123)
-  )
-  expect_equal(
-    as.numeric(opt$mle()[c(""p2"",""p5"", ""p9"")]),
-    c(0.12, 0.12, 0.12)
-  )
-  utils::capture.output(
-    opt <- mod$optimize(sig_figs = 5, refresh = 0, data = testing_data(""logistic""), seed = 123)
-  )
-  expect_equal(
-    as.numeric(opt$mle()[c(""p2"",""p5"", ""p9"")]),
-    c(0.12, 0.12345, 0.12346)
-  )
-  utils::capture.output(
-    opt <- mod$optimize(sig_figs = 10, refresh = 0, data = testing_data(""logistic""), seed = 123)
-  )
-  expect_equal(
-    as.numeric(opt$mle()[c(""p2"",""p5"", ""p9"")]),
-    c(0.12, 0.12345, 0.123456789)
-  )
-})
 
-test_that(""draws are returned for model with spaces"", {
-  skip_on_cran()
-  m <- ""
-  parameters {
-    real y;
-  }
-  model {
-    y ~ std_normal();
-  }
-  generated quantities {
-    real two_y = 2 * y;
-  }
-  ""
-  f <- write_stan_file(m, basename = ""file with spaces"")
-  expect_equal(basename(f), ""file with spaces.stan"")
-  mod <- cmdstan_model(f)
-  utils::capture.output(
-    fit_sample <- mod$sample(seed = 123, iter_sampling = 1000, chains = 1)
-  )
-  expect_equal(dim(fit_sample$draws()), c(1000, 1, 3))
-  utils::capture.output(
-    fit <- mod$variational(seed = 123, output_samples = 1000)
-  )
-  expect_equal(dim(fit$draws()), c(1000, 4))
-  utils::capture.output(
-    fit <- mod$optimize(seed = 123)
-  )
-  expect_equal(length(fit$mle()), 2)
+  data_list <- list(N = 10, y = c(0,1,0,0,0,0,0,0,0,1))
 
-  utils::capture.output(
-    fit <- mod$generate_quantities(fitted_params = fit_sample, seed = 123)
+  fit <- mod_w_include$sample(
+    data = data_list,
+    seed = 123,
+    chains = 4,
+    parallel_chains = 4,
+    refresh = 500,
+    init = list(list(theta = 0.25), list(theta = 0.25), list(theta = 0.25), list(theta = 0.25))
   )
-  expect_equal(dim(fit$draws()), c(1000, 1, 1))
 })",True,False,Implementation / Logic,6
stan-dev,cmdstanr,11444094fbde7f9ea90faeb3b8aa38e486f55f4b,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-09-12T09:19:41Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-09-12T09:19:41Z,fix version check,R/data.R,False,True,True,False,1,1,2,"---FILE: R/data.R---
@@ -192,7 +192,7 @@ process_data <- function(data, stan_file = NULL) {
       }
     }
     path <- tempfile(pattern = ""standata-"", fileext = "".json"")
-    write_stan_json(data = data, file = path, always_decimal = (cmdstan_version() > ""2.26""))
+    write_stan_json(data = data, file = path, always_decimal = (cmdstan_version() > ""2.26.1""))
   } else {
     stop(""'data' should be a path or a named list."", call. = FALSE)
   }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,99f4347ce94836d947ef8af58f5f7b5dc1177942,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-09-10T09:01:28Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-09-10T09:01:28Z,fix tests,tests/testthat/test-model-sample.R,False,True,True,False,3,3,6,"---FILE: tests/testthat/test-model-sample.R---
@@ -209,13 +209,13 @@ test_that(""sample() method runs when fixed_param = TRUE"", {
 
   expect_sample_output(fit_1000 <- mod_fp$sample(fixed_param = TRUE, iter_sampling = 1000), 4)
   expect_is(fit_1000, ""CmdStanMCMC"")
-  expect_equal(dim(fit_1000$draws()), c(1000,1,10))
+  expect_equal(dim(fit_1000$draws()), c(1000,4,10))
 
   expect_sample_output(fit_500 <- mod_fp$sample(fixed_param = TRUE, iter_sampling = 500), 4)
-  expect_equal(dim(fit_500$draws()), c(500,1,10))
+  expect_equal(dim(fit_500$draws()), c(500,4,10))
 
   expect_sample_output(fit_500_w <- mod_fp$sample(fixed_param = TRUE, iter_sampling = 500, iter_warmup = 5000), 4)
-  expect_equal(dim(fit_500_w$draws()), c(500,1,10))
+  expect_equal(dim(fit_500_w$draws()), c(500,4,10))
 
   expect_equal(fit_1000$metadata()$algorithm, ""fixed_param"")
   expect_equal(fit_500$metadata()$algorithm, ""fixed_param"")",True,False,Implementation / Logic,3
stan-dev,cmdstanr,e8b29005c5ddbf585f45a89bddd985a05ab0169b,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-09-10T08:32:36Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-09-10T08:32:36Z,"fix tests, we are now allowing multiple chains with fixed_param",tests/testthat/test-model-sample.R,False,True,True,False,3,3,6,"---FILE: tests/testthat/test-model-sample.R---
@@ -207,14 +207,14 @@ test_that(""sample() method runs when fixed_param = TRUE"", {
   skip_on_cran()
   mod_fp$compile()
 
-  expect_sample_output(fit_1000 <- mod_fp$sample(fixed_param = TRUE, iter_sampling = 1000), 1)
+  expect_sample_output(fit_1000 <- mod_fp$sample(fixed_param = TRUE, iter_sampling = 1000), 4)
   expect_is(fit_1000, ""CmdStanMCMC"")
   expect_equal(dim(fit_1000$draws()), c(1000,1,10))
 
-  expect_sample_output(fit_500 <- mod_fp$sample(fixed_param = TRUE, iter_sampling = 500), 1)
+  expect_sample_output(fit_500 <- mod_fp$sample(fixed_param = TRUE, iter_sampling = 500), 4)
   expect_equal(dim(fit_500$draws()), c(500,1,10))
 
-  expect_sample_output(fit_500_w <- mod_fp$sample(fixed_param = TRUE, iter_sampling = 500, iter_warmup = 5000), 1)
+  expect_sample_output(fit_500_w <- mod_fp$sample(fixed_param = TRUE, iter_sampling = 500, iter_warmup = 5000), 4)
   expect_equal(dim(fit_500_w$draws()), c(500,1,10))
 
   expect_equal(fit_1000$metadata()$algorithm, ""fixed_param"")",True,False,Rendering / Conversion,3
stan-dev,cmdstanr,162bbc861744903d6bb53c4130de3078b3969a51,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-09-09T17:58:17Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-09-09T17:58:17Z,fix version check,R/data.R,False,True,True,False,1,1,2,"---FILE: R/data.R---
@@ -162,7 +162,7 @@ process_data <- function(data, stan_file = NULL) {
         call. = FALSE
       )
     }
-    if (cmdstan_version() > ""2.26"" && !is.null(stan_file)) {
+    if (cmdstan_version() >= ""2.27.0"" && !is.null(stan_file)) {
       stan_file <- absolute_path(stan_file)
       if (file.exists(stan_file)) {
         data_variables <- model_variables(stan_file)$data",True,False,Implementation / Logic,6
stan-dev,cmdstanr,6a70e71a02bf1fc8474c9de56cca7c282fee9dd9,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-08-23T09:25:59Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-08-23T09:25:59Z,fix test for optimize,NEWS.md;tests/testthat/test-failed-chains.R,False,True,True,False,7,18,25,"---FILE: NEWS.md---
@@ -30,10 +30,11 @@ to vector, matrix, or array depending on the dimensions of the table. (#528)
 * `install_cmdstan()` now automatically installs the Linux ARM CmdStan when
 Linux distributions running on ARM CPUs are detected. (#531)
 
-* Improved processing of named lists supplied to the `data` argument for all
-the methods: checking whether the list includes all required elements/Stan
+* Improved processing of named lists supplied to the `data` argument to JSON
+data files: checking whether the list includes all required elements/Stan
 variables; improved differentiating arrays/vectors of length 1 and scalars
-when generating JSON data files. (#538)
+when generating JSON data files; generating floating point numbers with
+decimal points to fix issue with parsing large numbers. (#538)
 
 # cmdstanr 0.4.0
 

---FILE: tests/testthat/test-failed-chains.R---
@@ -158,22 +158,10 @@ test_that(""init warnings are shown"", {
 
 test_that(""optimize error on bad data"", {
   mod <- testing_model(""bernoulli"")
-  suppressWarnings(
-    expect_message(
-      mod$optimize(data = list(a = c(1,2,3)), seed = 123),
-      ""Exception: variable does not exist""
-    )
-  )
-  expect_warning(
-    utils::capture.output(
-      fit <- mod$optimize(data = list(a = c(1,2,3)), seed = 123)
-    ),
-    ""Fitting finished unexpectedly!""
+  expect_error(
+    mod$optimize(data = list(a = c(1,2,3)), seed = 123),
+    ""Missing input data for the following data variables: N, y.""
   )
-  expect_error(fit$print(), ""Fitting failed. Unable to print."")
-  expect_error(fit$summary(), ""Fitting failed. Unable to retrieve the draws."")
-  expect_error(fit$draws(), ""Fitting failed. Unable to retrieve the draws."")
-  expect_error(fit$metadata(), ""Fitting failed. Unable to retrieve the metadata."")
 })
 
 test_that(""errors when using draws after variational fais"", {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,c47be004feb5753bd009d5816d1500a7297a2964,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-08-22T14:10:39Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-08-22T14:10:47Z,add tests and fix bug in name checks,R/data.R;tests/testthat/test-data.R,False,True,True,False,286,261,547,"---FILE: R/data.R---
@@ -165,13 +165,13 @@ process_data <- function(data, stan_file = NULL) {
         if (!all(is_data_supplied)) {
           missing <- names(data_variables[!is_data_supplied])
           stop(
-            ""Missing input data for the following data variables:"",
+            ""Missing input data for the following data variables: "",
             paste0(missing, collapse = "", ""),
             ""."",
             call. = FALSE
           )
         }          
-        for(var_name in names(data)) {
+        for(var_name in names(data_variables)) {
           if (length(data[[var_name]]) == 1 
               && data_variables[[var_name]]$dimensions == 1) {
               data[[var_name]] <- array(data[[var_name]], dim = 1)

---FILE: tests/testthat/test-data.R---
@@ -1,277 +1,302 @@
 context(""data-utils"")
 
-if (not_on_cran()) {
-  set_cmdstan_path()
-  fit <- testing_fit(""bernoulli"", method = ""sample"", seed = 123)
-  fit_vb <- testing_fit(""bernoulli"", method = ""variational"", seed = 123)
-  fit_optimize <- testing_fit(""bernoulli"", method = ""optimize"", seed = 123)
-}
+# if (not_on_cran()) {
+#   set_cmdstan_path()
+#   fit <- testing_fit(""bernoulli"", method = ""sample"", seed = 123)
+#   fit_vb <- testing_fit(""bernoulli"", method = ""variational"", seed = 123)
+#   fit_optimize <- testing_fit(""bernoulli"", method = ""optimize"", seed = 123)
+# }
 
-test_that(""empty data list converted to NULL"", {
-  skip_on_cran()
-  stan_file <- write_stan_file(""
-  parameters {
-    real y;
-  }
-  model {
-    y ~ std_normal();
-  }
-  "")
-  expect_null(process_data(list()))
-  expect_null(process_data(list(), stan_file = stan_file))
-})
+# test_that(""empty data list converted to NULL"", {
+#   skip_on_cran()
+#   stan_file <- write_stan_file(""
+#   parameters {
+#     real y;
+#   }
+#   model {
+#     y ~ std_normal();
+#   }
+#   "")
+#   expect_null(process_data(list()))
+#   expect_null(process_data(list(), stan_file = stan_file))
+# })
 
-test_that(""process_data works for inputs of length one"", {
-  skip_on_cran()
-  data <- list(val = 5)
-  stan_file <- write_stan_file(""
-  data {
-    real val;
-  }
-  "")
-  expect_equal(jsonlite::read_json(process_data(data, stan_file = stan_file)), list(val = 5))
-  stan_file <- write_stan_file(""
-  data {
-    int val;
-  }
-  "")
-  expect_equal(jsonlite::read_json(process_data(data, stan_file = stan_file)), list(val = 5))
-  stan_file <- write_stan_file(""
-  data {
-    vector[1] val;
-  }
-  "")
-  expect_equal(jsonlite::read_json(process_data(data, stan_file = stan_file)), list(val = list(5)))
-})
+# test_that(""process_data works for inputs of length one"", {
+#   skip_on_cran()
+#   data <- list(val = 5)
+#   stan_file <- write_stan_file(""
+#   data {
+#     real val;
+#   }
+#   "")
+#   expect_equal(jsonlite::read_json(process_data(data, stan_file = stan_file)), list(val = 5))
+#   stan_file <- write_stan_file(""
+#   data {
+#     int val;
+#   }
+#   "")
+#   expect_equal(jsonlite::read_json(process_data(data, stan_file = stan_file)), list(val = 5))
+#   stan_file <- write_stan_file(""
+#   data {
+#     vector[1] val;
+#   }
+#   "")
+#   expect_equal(jsonlite::read_json(process_data(data, stan_file = stan_file)), list(val = list(5)))
+# })
 
-test_that(""process_fitted_params() works with basic input types"", {
-  temp_file <- tempfile()
-  temp_files <- c(tempfile(),
-                  tempfile(),
-                  tempfile())
-  expect_equal(process_fitted_params(temp_file), temp_file)
-  expect_equal(process_fitted_params(temp_files), temp_files)
-  expect_equal(process_fitted_params(fit), fit$output_files())
-})
+# test_that(""process_fitted_params() works with basic input types"", {
+#   temp_file <- tempfile()
+#   temp_files <- c(tempfile(),
+#                   tempfile(),
+#                   tempfile())
+#   expect_equal(process_fitted_params(temp_file), temp_file)
+#   expect_equal(process_fitted_params(temp_files), temp_files)
+#   expect_equal(process_fitted_params(fit), fit$output_files())
+# })
 
-test_that(""process_fitted_params() errors with bad args"", {
-  error_msg <- ""'fitted_params' must be a list of paths to CSV files, a CmdStanMCMC/CmdStanVB object, a posterior::draws_array or a posterior::draws_matrix.""
-  expect_error(
-    process_fitted_params(5),
-    error_msg
-  )
-  expect_error(
-    process_fitted_params(NULL),
-    error_msg
-  )
-  expect_error(
-    process_fitted_params(fit_optimize),
-    error_msg
-  )
+# test_that(""process_fitted_params() errors with bad args"", {
+#   error_msg <- ""'fitted_params' must be a list of paths to CSV files, a CmdStanMCMC/CmdStanVB object, a posterior::draws_array or a posterior::draws_matrix.""
+#   expect_error(
+#     process_fitted_params(5),
+#     error_msg
+#   )
+#   expect_error(
+#     process_fitted_params(NULL),
+#     error_msg
+#   )
+#   expect_error(
+#     process_fitted_params(fit_optimize),
+#     error_msg
+#   )
 
-  fit_tmp <- testing_fit(""bernoulli"", method = ""sample"", seed = 123)
-  temp_file <- tempfile(fileext = "".rds"")
-  saveRDS(fit_tmp, file = temp_file)
-  rm(fit_tmp)
-  gc()
-  fit_tmp_null <- readRDS(temp_file)
-  expect_error(
-    process_fitted_params(fit_tmp_null),
-    ""Unable to obtain draws from the fit object.""
-  )
+#   fit_tmp <- testing_fit(""bernoulli"", method = ""sample"", seed = 123)
+#   temp_file <- tempfile(fileext = "".rds"")
+#   saveRDS(fit_tmp, file = temp_file)
+#   rm(fit_tmp)
+#   gc()
+#   fit_tmp_null <- readRDS(temp_file)
+#   expect_error(
+#     process_fitted_params(fit_tmp_null),
+#     ""Unable to obtain draws from the fit object.""
+#   )
 
-  fit_tmp <- testing_fit(""bernoulli"", method = ""variational"", seed = 123)
-  temp_file <- tempfile(fileext = "".rds"")
-  saveRDS(fit_tmp, file = temp_file)
-  rm(fit_tmp)
-  gc()
-  fit_tmp_null <- readRDS(temp_file)
-  expect_error(
-    process_fitted_params(fit_tmp_null),
-    ""Unable to obtain draws from the fit object.""
-  )
-})
+#   fit_tmp <- testing_fit(""bernoulli"", method = ""variational"", seed = 123)
+#   temp_file <- tempfile(fileext = "".rds"")
+#   saveRDS(fit_tmp, file = temp_file)
+#   rm(fit_tmp)
+#   gc()
+#   fit_tmp_null <- readRDS(temp_file)
+#   expect_error(
+#     process_fitted_params(fit_tmp_null),
+#     ""Unable to obtain draws from the fit object.""
+#   )
+# })
 
-test_that(""process_fitted_params() works if output_files in fit do not exist"", {
-  fit_ref <- testing_fit(""bernoulli"", method = ""sample"", seed = 123)
-  fit_tmp <- testing_fit(""bernoulli"", method = ""sample"", seed = 123)
-  temp_file <- tempfile(fileext = "".rds"")
-  fit_tmp$save_object(temp_file)
-  rm(fit_tmp)
-  gc()
-  fit_tmp <- readRDS(temp_file)
-  expect_false(any(file.exists(fit_tmp$output_files())))
-  new_files <- process_fitted_params(fit_tmp)
-  expect_true(all(file.exists(new_files)))
-  chain <- 1
-  for(file in new_files) {
-    if (os_is_windows()) {
-      grep_path <- repair_path(Sys.which(""grep.exe""))
-      fread_cmd <- paste0(grep_path, "" -v '^#' --color=never "", file)
-    } else {
-      fread_cmd <- paste0(""grep -v '^#' --color=never "", file)
-    }
-    suppressWarnings(
-      tmp_file_gq <- data.table::fread(
-        cmd = fread_cmd
-      )
-    )
-    tmp_file_gq <- posterior::as_draws_array(tmp_file_gq)
-    expect_equal(
-      posterior::subset_draws(fit_ref$draws(), variable = ""lp__"", chain = chain),
-      posterior::subset_draws(tmp_file_gq, variable = ""lp__"")
-    )
-    expect_equal(
-      posterior::subset_draws(fit_ref$draws(), variable = ""theta"", chain = chain),
-      posterior::subset_draws(tmp_file_gq, variable = ""theta"")
-    )
-    expect_equal(
-      posterior::subset_draws(fit_ref$sampler_diagnostics(), chain = chain),
-      posterior::subset_draws(tmp_file_gq, variable = posterior::variables(fit_ref$sampler_diagnostics()))
-    )
-    chain <- chain + 1
-  }
-})
+# test_that(""process_fitted_params() works if output_files in fit do not exist"", {
+#   fit_ref <- testing_fit(""bernoulli"", method = ""sample"", seed = 123)
+#   fit_tmp <- testing_fit(""bernoulli"", method = ""sample"", seed = 123)
+#   temp_file <- tempfile(fileext = "".rds"")
+#   fit_tmp$save_object(temp_file)
+#   rm(fit_tmp)
+#   gc()
+#   fit_tmp <- readRDS(temp_file)
+#   expect_false(any(file.exists(fit_tmp$output_files())))
+#   new_files <- process_fitted_params(fit_tmp)
+#   expect_true(all(file.exists(new_files)))
+#   chain <- 1
+#   for(file in new_files) {
+#     if (os_is_windows()) {
+#       grep_path <- repair_path(Sys.which(""grep.exe""))
+#       fread_cmd <- paste0(grep_path, "" -v '^#' --color=never "", file)
+#     } else {
+#       fread_cmd <- paste0(""grep -v '^#' --color=never "", file)
+#     }
+#     suppressWarnings(
+#       tmp_file_gq <- data.table::fread(
+#         cmd = fread_cmd
+#       )
+#     )
+#     tmp_file_gq <- posterior::as_draws_array(tmp_file_gq)
+#     expect_equal(
+#       posterior::subset_draws(fit_ref$draws(), variable = ""lp__"", chain = chain),
+#       posterior::subset_draws(tmp_file_gq, variable = ""lp__"")
+#     )
+#     expect_equal(
+#       posterior::subset_draws(fit_ref$draws(), variable = ""theta"", chain = chain),
+#       posterior::subset_draws(tmp_file_gq, variable = ""theta"")
+#     )
+#     expect_equal(
+#       posterior::subset_draws(fit_ref$sampler_diagnostics(), chain = chain),
+#       posterior::subset_draws(tmp_file_gq, variable = posterior::variables(fit_ref$sampler_diagnostics()))
+#     )
+#     chain <- chain + 1
+#   }
+# })
 
-test_that(""process_fitted_params() works with CmdStanMCMC"", {
-  fit <- testing_fit(""logistic"", method = ""sample"", seed = 123)
-  fit_params_files <- process_fitted_params(fit)
-  expect_true(all(file.exists(fit_params_files)))
-  chain <- 1
-  for(file in fit_params_files) {
-    if (os_is_windows()) {
-      grep_path <- repair_path(Sys.which(""grep.exe""))
-      fread_cmd <- paste0(grep_path, "" -v '^#' --color=never "", file)
-    } else {
-      fread_cmd <- paste0(""grep -v '^#' --color=never "", file)
-    }
-    suppressWarnings(
-      fit_params_tmp <- data.table::fread(
-        cmd = fread_cmd
-      )
-    )
-    fit_params_tmp <- posterior::as_draws_array(fit_params_tmp)
-    posterior::variables(fit_params_tmp) <- repair_variable_names(posterior::variables(fit_params_tmp))
-    expect_equal(
-      posterior::subset_draws(fit$draws(), variable = ""lp__"", chain = chain),
-      posterior::subset_draws(fit_params_tmp, variable = ""lp__"")
-    )
-    expect_equal(
-      posterior::subset_draws(fit$draws(), variable = c(""alpha"", ""beta[1]"", ""beta[2]"", ""beta[3]""), chain = chain),
-      posterior::subset_draws(fit_params_tmp, variable = c(""alpha"", ""beta[1]"", ""beta[2]"", ""beta[3]""),)
-    )
-    chain <- chain + 1
-  }
-})
+# test_that(""process_fitted_params() works with CmdStanMCMC"", {
+#   fit <- testing_fit(""logistic"", method = ""sample"", seed = 123)
+#   fit_params_files <- process_fitted_params(fit)
+#   expect_true(all(file.exists(fit_params_files)))
+#   chain <- 1
+#   for(file in fit_params_files) {
+#     if (os_is_windows()) {
+#       grep_path <- repair_path(Sys.which(""grep.exe""))
+#       fread_cmd <- paste0(grep_path, "" -v '^#' --color=never "", file)
+#     } else {
+#       fread_cmd <- paste0(""grep -v '^#' --color=never "", file)
+#     }
+#     suppressWarnings(
+#       fit_params_tmp <- data.table::fread(
+#         cmd = fread_cmd
+#       )
+#     )
+#     fit_params_tmp <- posterior::as_draws_array(fit_params_tmp)
+#     posterior::variables(fit_params_tmp) <- repair_variable_names(posterior::variables(fit_params_tmp))
+#     expect_equal(
+#       posterior::subset_draws(fit$draws(), variable = ""lp__"", chain = chain),
+#       posterior::subset_draws(fit_params_tmp, variable = ""lp__"")
+#     )
+#     expect_equal(
+#       posterior::subset_draws(fit$draws(), variable = c(""alpha"", ""beta[1]"", ""beta[2]"", ""beta[3]""), chain = chain),
+#       posterior::subset_draws(fit_params_tmp, variable = c(""alpha"", ""beta[1]"", ""beta[2]"", ""beta[3]""),)
+#     )
+#     chain <- chain + 1
+#   }
+# })
 
-test_that(""process_fitted_params() works with draws_array"", {
-  fit <- testing_fit(""logistic"", method = ""sample"", seed = 123)
-  fit_params_files <- process_fitted_params(fit$draws())
-  expect_true(all(file.exists(fit_params_files)))
-  chain <- 1
-  for(file in fit_params_files) {
-    if (os_is_windows()) {
-      grep_path <- repair_path(Sys.which(""grep.exe""))
-      fread_cmd <- paste0(grep_path, "" -v '^#' --color=never "", file)
-    } else {
-      fread_cmd <- paste0(""grep -v '^#' --color=never "", file)
-    }
-    suppressWarnings(
-      fit_params_tmp <- data.table::fread(
-        cmd = fread_cmd
-      )
-    )
-    fit_params_tmp <- posterior::as_draws_array(fit_params_tmp)
-    posterior::variables(fit_params_tmp) <- repair_variable_names(posterior::variables(fit_params_tmp))
-    expect_equal(
-      posterior::subset_draws(fit$draws(), variable = ""lp__"", chain = chain),
-      posterior::subset_draws(fit_params_tmp, variable = ""lp__"")
-    )
-    expect_equal(
-      posterior::subset_draws(fit$draws(), variable = c(""alpha"", ""beta[1]"", ""beta[2]"", ""beta[3]""), chain = chain),
-      posterior::subset_draws(fit_params_tmp, variable = c(""alpha"", ""beta[1]"", ""beta[2]"", ""beta[3]""),)
-    )
-    chain <- chain + 1
-  }
-})
+# test_that(""process_fitted_params() works with draws_array"", {
+#   fit <- testing_fit(""logistic"", method = ""sample"", seed = 123)
+#   fit_params_files <- process_fitted_params(fit$draws())
+#   expect_true(all(file.exists(fit_params_files)))
+#   chain <- 1
+#   for(file in fit_params_files) {
+#     if (os_is_windows()) {
+#       grep_path <- repair_path(Sys.which(""grep.exe""))
+#       fread_cmd <- paste0(grep_path, "" -v '^#' --color=never "", file)
+#     } else {
+#       fread_cmd <- paste0(""grep -v '^#' --color=never "", file)
+#     }
+#     suppressWarnings(
+#       fit_params_tmp <- data.table::fread(
+#         cmd = fread_cmd
+#       )
+#     )
+#     fit_params_tmp <- posterior::as_draws_array(fit_params_tmp)
+#     posterior::variables(fit_params_tmp) <- repair_variable_names(posterior::variables(fit_params_tmp))
+#     expect_equal(
+#       posterior::subset_draws(fit$draws(), variable = ""lp__"", chain = chain),
+#       posterior::subset_draws(fit_params_tmp, variable = ""lp__"")
+#     )
+#     expect_equal(
+#       posterior::subset_draws(fit$draws(), variable = c(""alpha"", ""beta[1]"", ""beta[2]"", ""beta[3]""), chain = chain),
+#       posterior::subset_draws(fit_params_tmp, variable = c(""alpha"", ""beta[1]"", ""beta[2]"", ""beta[3]""),)
+#     )
+#     chain <- chain + 1
+#   }
+# })
 
-test_that(""process_fitted_params() works with draws_array without lp__"", {
-  fit <- testing_fit(""logistic"", method = ""sample"", seed = 123)
-  fit_params_files <- process_fitted_params(posterior::subset_draws(fit$draws(), variables = c(""alpha"", ""beta[1]"", ""beta[2]"", ""beta[3]"")))
-  expect_true(all(file.exists(fit_params_files)))
-  chain <- 1
-  for(file in fit_params_files) {
-    if (os_is_windows()) {
-      grep_path <- repair_path(Sys.which(""grep.exe""))
-      fread_cmd <- paste0(grep_path, "" -v '^#' --color=never "", file)
-    } else {
-      fread_cmd <- paste0(""grep -v '^#' --color=never "", file)
-    }
-    suppressWarnings(
-      fit_params_tmp <- data.table::fread(
-        cmd = fread_cmd
-      )
-    )
-    fit_params_tmp <- posterior::as_draws_array(fit_params_tmp)
-    posterior::variables(fit_params_tmp) <- repair_variable_names(posterior::variables(fit_params_tmp))
-    expect_equal(
-      posterior::subset_draws(fit$draws(), variable = c(""alpha"", ""beta[1]"", ""beta[2]"", ""beta[3]""), chain = chain),
-      posterior::subset_draws(fit_params_tmp, variable = c(""alpha"", ""beta[1]"", ""beta[2]"", ""beta[3]""),)
-    )
-    chain <- chain + 1
-  }
-})
+# test_that(""process_fitted_params() works with draws_array without lp__"", {
+#   fit <- testing_fit(""logistic"", method = ""sample"", seed = 123)
+#   fit_params_files <- process_fitted_params(posterior::subset_draws(fit$draws(), variables = c(""alpha"", ""beta[1]"", ""beta[2]"", ""beta[3]"")))
+#   expect_true(all(file.exists(fit_params_files)))
+#   chain <- 1
+#   for(file in fit_params_files) {
+#     if (os_is_windows()) {
+#       grep_path <- repair_path(Sys.which(""grep.exe""))
+#       fread_cmd <- paste0(grep_path, "" -v '^#' --color=never "", file)
+#     } else {
+#       fread_cmd <- paste0(""grep -v '^#' --color=never "", file)
+#     }
+#     suppressWarnings(
+#       fit_params_tmp <- data.table::fread(
+#         cmd = fread_cmd
+#       )
+#     )
+#     fit_params_tmp <- posterior::as_draws_array(fit_params_tmp)
+#     posterior::variables(fit_params_tmp) <- repair_variable_names(posterior::variables(fit_params_tmp))
+#     expect_equal(
+#       posterior::subset_draws(fit$draws(), variable = c(""alpha"", ""beta[1]"", ""beta[2]"", ""beta[3]""), chain = chain),
+#       posterior::subset_draws(fit_params_tmp, variable = c(""alpha"", ""beta[1]"", ""beta[2]"", ""beta[3]""),)
+#     )
+#     chain <- chain + 1
+#   }
+# })
 
-test_that(""process_fitted_params() works with CmdStanVB"", {
-  fit <- testing_fit(""logistic"", method = ""variational"", seed = 123)
-  file <- process_fitted_params(fit)
-  expect_true(file.exists(file))
-  if (os_is_windows()) {
-    grep_path <- repair_path(Sys.which(""grep.exe""))
-    fread_cmd <- paste0(grep_path, "" -v '^#' --color=never "", file)
-  } else {
-    fread_cmd <- paste0(""grep -v '^#' --color=never "", file)
-  }
-  suppressWarnings(
-    fit_params_tmp <- data.table::fread(
-      cmd = fread_cmd
-    )
-  )
-  fit_params_tmp <- posterior::as_draws_array(fit_params_tmp)
-  posterior::variables(fit_params_tmp) <- repair_variable_names(posterior::variables(fit_params_tmp))
-  expect_equal(
-    posterior::subset_draws(posterior::as_draws_array(fit$draws()), variable = ""lp__""),
-    posterior::subset_draws(fit_params_tmp, variable = ""lp__"")
-  )
-  expect_equal(
-    posterior::subset_draws(posterior::as_draws_array(fit$draws()), variable = c(""alpha"", ""beta[1]"", ""beta[2]"", ""beta[3]"")),
-    posterior::subset_draws(fit_params_tmp, variable = c(""alpha"", ""beta[1]"", ""beta[2]"", ""beta[3]""))
-  )
-})
+# test_that(""process_fitted_params() works with CmdStanVB"", {
+#   fit <- testing_fit(""logistic"", method = ""variational"", seed = 123)
+#   file <- process_fitted_params(fit)
+#   expect_true(file.exists(file))
+#   if (os_is_windows()) {
+#     grep_path <- repair_path(Sys.which(""grep.exe""))
+#     fread_cmd <- paste0(grep_path, "" -v '^#' --color=never "", file)
+#   } else {
+#     fread_cmd <- paste0(""grep -v '^#' --color=never "", file)
+#   }
+#   suppressWarnings(
+#     fit_params_tmp <- data.table::fread(
+#       cmd = fread_cmd
+#     )
+#   )
+#   fit_params_tmp <- posterior::as_draws_array(fit_params_tmp)
+#   posterior::variables(fit_params_tmp) <- repair_variable_names(posterior::variables(fit_params_tmp))
+#   expect_equal(
+#     posterior::subset_draws(posterior::as_draws_array(fit$draws()), variable = ""lp__""),
+#     posterior::subset_draws(fit_params_tmp, variable = ""lp__"")
+#   )
+#   expect_equal(
+#     posterior::subset_draws(posterior::as_draws_array(fit$draws()), variable = c(""alpha"", ""beta[1]"", ""beta[2]"", ""beta[3]"")),
+#     posterior::subset_draws(fit_params_tmp, variable = c(""alpha"", ""beta[1]"", ""beta[2]"", ""beta[3]""))
+#   )
+# })
 
-test_that(""process_fitted_params() works with draws_matrix"", {
-  fit <- testing_fit(""logistic"", method = ""variational"", seed = 123)
-  file <- process_fitted_params(fit$draws())
-  expect_true(file.exists(file))
-  if (os_is_windows()) {
-    grep_path <- repair_path(Sys.which(""grep.exe""))
-    fread_cmd <- paste0(grep_path, "" -v '^#' --color=never "", file)
-  } else {
-    fread_cmd <- paste0(""grep -v '^#' --color=never "", file)
+# test_that(""process_fitted_params() works with draws_matrix"", {
+#   fit <- testing_fit(""logistic"", method = ""variational"", seed = 123)
+#   file <- process_fitted_params(fit$draws())
+#   expect_true(file.exists(file))
+#   if (os_is_windows()) {
+#     grep_path <- repair_path(Sys.which(""grep.exe""))
+#     fread_cmd <- paste0(grep_path, "" -v '^#' --color=never "", file)
+#   } else {
+#     fread_cmd <- paste0(""grep -v '^#' --color=never "", file)
+#   }
+#   suppressWarnings(
+#     fit_params_tmp <- data.table::fread(
+#       cmd = fread_cmd
+#     )
+#   )
+#   fit_params_tmp <- posterior::as_draws_array(fit_params_tmp)
+#   posterior::variables(fit_params_tmp) <- repair_variable_names(posterior::variables(fit_params_tmp))
+#   expect_equal(
+#     posterior::subset_draws(posterior::as_draws_array(fit$draws()), variable = ""lp__""),
+#     posterior::subset_draws(fit_params_tmp, variable = ""lp__"")
+#   )
+#   expect_equal(
+#     posterior::subset_draws(posterior::as_draws_array(fit$draws()), variable = c(""alpha"", ""beta[1]"", ""beta[2]"", ""beta[3]"")),
+#     posterior::subset_draws(fit_params_tmp, variable = c(""alpha"", ""beta[1]"", ""beta[2]"", ""beta[3]""))
+#   )
+# })
+
+test_that(""process_data() errors on missing variables"", {
+  stan_file <- write_stan_file(""
+  data {
+    real val1;
+    real val2;
   }
-  suppressWarnings(
-    fit_params_tmp <- data.table::fread(
-      cmd = fread_cmd
-    )
-  )
-  fit_params_tmp <- posterior::as_draws_array(fit_params_tmp)
-  posterior::variables(fit_params_tmp) <- repair_variable_names(posterior::variables(fit_params_tmp))
-  expect_equal(
-    posterior::subset_draws(posterior::as_draws_array(fit$draws()), variable = ""lp__""),
-    posterior::subset_draws(fit_params_tmp, variable = ""lp__"")
+  "")
+  expect_error(
+    process_data(data = list(val1 = 5), stan_file = stan_file),
+    ""Missing input data for the following data variables: val2.""
   )
-  expect_equal(
-    posterior::subset_draws(posterior::as_draws_array(fit$draws()), variable = c(""alpha"", ""beta[1]"", ""beta[2]"", ""beta[3]"")),
-    posterior::subset_draws(fit_params_tmp, variable = c(""alpha"", ""beta[1]"", ""beta[2]"", ""beta[3]""))
+  expect_error(
+    process_data(data = list(val = 1), stan_file = stan_file),
+    ""Missing input data for the following data variables: val1, val2.""
   )
+  stan_file_no_data <- write_stan_file(""
+  transformed data {
+    real val1 = 1;
+    real val2 = 2;
+  }
+  "")
+  v <- process_data(data = list(val1 = 5), stan_file = stan_file_no_data)
+  expect_type(v, ""character"")
 })",True,False,Implementation / Logic,6
stan-dev,cmdstanr,14ecdf91c6b8164dadf1b95d0656fabc1fb81e4f,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-08-22T09:19:39Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-08-22T09:52:49Z,"fix docs for process_data
add NEWS.md",NEWS.md;R/data.R,False,True,True,False,29,20,49,"---FILE: NEWS.md---
@@ -30,6 +30,11 @@ to vector, matrix, or array depending on the dimensions of the table. (#528)
 * `install_cmdstan()` now automatically installs the Linux ARM CmdStan when
 Linux distributions running on ARM CPUs are detected. (#531)
 
+* Improved processing of named lists supplied to the `data` argument for all
+the methods: checking whether the list includes all required elements/Stan
+variables; improved differentiating arrays/vectors of length 1 and scalars
+when generating JSON data files.
+
 # cmdstanr 0.4.0
 
 ### Bug fixes

---FILE: R/data.R---
@@ -133,8 +133,12 @@ list_to_array <- function(x, name = NULL) {
 #' @noRd
 #' @param data If not `NULL`, then either a path to a data file compatible with
 #'   CmdStan, or a named list of \R objects to pass to [write_stan_json()].
-#' @param stan_file If not `NULL`, then either a path to a data file compatible with
-#'   CmdStan, or a named list of \R objects to pass to [write_stan_json()].
+#' @param stan_file If not `NULL`, the path to the Stan model for which to
+#'   process the named list suppiled to the `data` argument. The Stan model
+#'   is used for checking whether the supplied named list has all the
+#'   required elements/Stan variables and to help differentiate between a
+#'   vector of length 1 and a scalar when genereting the JSON file. This
+#'   argument is ignored when a path to a data file is supplied for `data`.
 #' @return Path to data file.
 process_data <- function(data, stan_file = NULL) {
   if (length(data) == 0) {
@@ -154,26 +158,26 @@ process_data <- function(data, stan_file = NULL) {
       )
     }
     if (cmdstan_version() > ""2.26"" && !is.null(stan_file)) {
-        stan_file <- absolute_path(stan_file)
-        if (file.exists(stan_file)) {
-          data_variables <- model_variables(stan_file)$data
-          is_data_supplied <- names(data_variables) %in%  names(data)
-          if (!all(is_data_supplied)) {
-            missing <- names(data_variables[!is_data_supplied])
-            stop(
-              ""Missing input data for the following data variables:"",
-              paste0(missing, collapse = "", ""),
-              ""."",
-              call. = FALSE
-            )
-          }          
-          for(var_name in names(data)) {
-            if (length(data[[var_name]]) == 1 
-                && data_variables[[var_name]]$dimensions == 1) {
-                data[[var_name]] <- array(data[[var_name]], dim = 1)
-            }
+      stan_file <- absolute_path(stan_file)
+      if (file.exists(stan_file)) {
+        data_variables <- model_variables(stan_file)$data
+        is_data_supplied <- names(data_variables) %in%  names(data)
+        if (!all(is_data_supplied)) {
+          missing <- names(data_variables[!is_data_supplied])
+          stop(
+            ""Missing input data for the following data variables:"",
+            paste0(missing, collapse = "", ""),
+            ""."",
+            call. = FALSE
+          )
+        }          
+        for(var_name in names(data)) {
+          if (length(data[[var_name]]) == 1 
+              && data_variables[[var_name]]$dimensions == 1) {
+              data[[var_name]] <- array(data[[var_name]], dim = 1)
           }
         }
+      }
     }
     path <- tempfile(pattern = ""standata-"", fileext = "".json"")
     write_stan_json(data = data, file = path)",True,False,Documentation / Formatting,7
stan-dev,cmdstanr,bde20ac294793dbb4584b27cdd0a0b6a3f4fca56,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-08-21T09:30:57Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-08-21T09:30:57Z,fix test for windows,tests/testthat/test-example.R,False,True,True,False,2,2,4,"---FILE: tests/testthat/test-example.R---
@@ -112,10 +112,10 @@ test_that(""cmdstanr_write_stan_file_dir option works"", {
   }
   options(""cmdstanr_write_stan_file_dir"" = test_dir)
   file <- write_stan_file(stan_program)
-  expect_equal(dirname(file), test_dir)
+  expect_equal(repair_path(dirname(file)), repair_path(test_dir))
   options(""cmdstanr_write_stan_file_dir"" = NULL)
   file <- write_stan_file(stan_program)
-  expect_equal(dirname(file), base_dir)
+  expect_equal(repair_path(dirname(file)), repair_path(base_dir))
   if (!dir.exists(test_dir)) {
     file.remove(test_dir)
   }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,4079b59bdb4ed1b1296bca9a4f505e0cea218585,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-07-19T12:47:19Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-07-19T12:47:19Z,"pull ebfmi compute out, fix tests",R/utils.R;tests/testthat/test-utils.R,False,True,True,False,199,187,386,"---FILE: R/utils.R---
@@ -280,8 +280,8 @@ check_sampler_transitions_treedepth <- function(post_warmup_sampler_diagnostics,
   }
 }
 
-check_ebfmi <- function(post_warmup_sampler_diagnostics, threshold = 0.2) {
-  ebfmi <- NULL
+ebfmi <- function(post_warmup_sampler_diagnostics) {
+  efbmi_val <- NULL
   if (!is.null(post_warmup_sampler_diagnostics)) {
     if (!(""energy__"" %in% posterior::variables(post_warmup_sampler_diagnostics))) {
       warning(""E-BFMI not computed as the 'energy__' diagnostic could not be located."", call. = FALSE)
@@ -292,18 +292,23 @@ check_ebfmi <- function(post_warmup_sampler_diagnostics, threshold = 0.2) {
       if (any(is.na(energy))) {
         warning(""E-BFMI not computed because 'energy__' contains NAs."", call. = FALSE)
       } else {
-        ebfmi <- apply(energy, 2, function(x) {
+        efbmi_val <- apply(energy, 2, function(x) {
           (sum(diff(x)^2) / length(x)) / stats::var(x)
         })
-        if (!is.null(threshold) && any(ebfmi < threshold)) {
-          message(paste0(sum(ebfmi < threshold), "" of "", length(ebfmi), "" chains had energy-based Bayesian fraction "",
-          ""of missing information (E-BFMI) less than "", threshold, "", which may indicate poor exploration of the "", 
-          ""posterior.""))
-        }
       }
     }
   }
-  ebfmi
+  efbmi_val
+}
+
+check_ebfmi <- function(post_warmup_sampler_diagnostics, threshold = 0.2) {
+  efbmi_val <- ebfmi(post_warmup_sampler_diagnostics)
+  if (any(efbmi_val < threshold)) {
+    message(paste0(sum(efbmi_val < threshold), "" of "", length(efbmi_val), "" chains had energy-based Bayesian fraction "",
+    ""of missing information (E-BFMI) less than "", threshold, "", which may indicate poor exploration of the "", 
+    ""posterior.""))
+  }
+  invisible(NULL)
 }
 
 

---FILE: tests/testthat/test-utils.R---
@@ -1,181 +1,182 @@
 context(""utils"")
 
-if (not_on_cran()) {
-  set_cmdstan_path()
-  fit_mcmc <- testing_fit(""logistic"", method = ""sample"",
-                          seed = 123, chains = 2)
-}
-
-test_that(""check_divergences() works"", {
-  skip_on_cran()
-  csv_files <- c(test_path(""resources"", ""csv"", ""model1-2-no-warmup.csv""))
-  csv_output <- read_cmdstan_csv(csv_files)
-  output <- ""14 of 100 \\(14.0%\\) transitions ended with a divergence.""
-  expect_message(check_divergences(csv_output$post_warmup_sampler_diagnostics), output)
-
-  csv_files <- c(test_path(""resources"", ""csv"", ""model1-2-no-warmup.csv""),
-                 test_path(""resources"", ""csv"", ""model1-2-no-warmup.csv""))
-  csv_output <- read_cmdstan_csv(csv_files)
-  output <- ""28 of 200 \\(14.0%\\) transitions ended with a divergence.""
-  expect_message(check_divergences(csv_output$post_warmup_sampler_diagnostics), output)
-
-  csv_files <- c(test_path(""resources"", ""csv"", ""model1-2-warmup.csv""))
-  csv_output <- read_cmdstan_csv(csv_files)
-  output <- ""1 of 100 \\(1.0%\\) transitions ended with a divergence.""
-  expect_message(check_divergences(csv_output$post_warmup_sampler_diagnostics), output)
-
-
-  fit_wramup_no_samples <- testing_fit(""logistic"", method = ""sample"",
-                          seed = 123, chains = 1,
-                          iter_sampling = 0,
-                          iter_warmup = 10,
-                          save_warmup = TRUE,
-                          validate_csv = FALSE)
-  csv_output <- read_cmdstan_csv(fit_wramup_no_samples$output_files())
-  expect_message(check_divergences(csv_output$post_warmup_sampler_diagnostics), regexp = NA)
-})
-
-test_that(""check_sampler_transitions_treedepth() works"", {
-  skip_on_cran()
-  csv_files <- c(test_path(""resources"", ""csv"", ""model1-2-no-warmup.csv""))
-  csv_output <- read_cmdstan_csv(csv_files)
-  output <- ""16 of 100 \\(16.0%\\) transitions hit the maximum treedepth limit of 5 or 2\\^5-1 leapfrog steps.""
-  expect_message(
-    check_sampler_transitions_treedepth(
-      csv_output$post_warmup_sampler_diagnostics,
-      csv_output$metadata),
-    output
-  )
-
-  csv_files <- c(test_path(""resources"", ""csv"", ""model1-2-no-warmup.csv""),
-                 test_path(""resources"", ""csv"", ""model1-2-no-warmup.csv""))
-  csv_output <- read_cmdstan_csv(csv_files)
-  output <- ""32 of 200 \\(16.0%\\) transitions hit the maximum treedepth limit of 5 or 2\\^5-1 leapfrog steps.""
-  expect_message(
-    check_sampler_transitions_treedepth(
-      csv_output$post_warmup_sampler_diagnostics,
-      csv_output$metadata),
-    output
-  )
-
-  csv_files <- c(test_path(""resources"", ""csv"", ""model1-2-warmup.csv""))
-  csv_output <- read_cmdstan_csv(csv_files)
-  output <- ""1 of 100 \\(1.0%\\) transitions hit the maximum treedepth limit of 5 or 2\\^5-1 leapfrog steps.""
-  expect_message(
-    check_sampler_transitions_treedepth(
-      csv_output$post_warmup_sampler_diagnostics,
-      csv_output$metadata),
-    output
-  )
-})
-
-test_that(""cmdstan_summary works if bin/stansummary deleted file"", {
-  skip_on_cran()
-  delete_and_run <- function() {
-    file.remove(file.path(cmdstan_path(), ""bin"", cmdstan_ext(""stansummary"")))
-    fit_mcmc$cmdstan_summary()
-  }
-  expect_output(delete_and_run(), ""Inference for Stan model: logistic_model\\n2 chains: each with iter"")
-})
-
-test_that(""cmdstan_diagnose works if bin/diagnose deleted file"", {
-  skip_on_cran()
-  delete_and_run <- function() {
-    file.remove(file.path(cmdstan_path(), ""bin"", cmdstan_ext(""diagnose"")))
-    fit_mcmc$cmdstan_diagnose()
-  }
-  expect_output(delete_and_run(), ""Checking sampler transitions treedepth"")
-})
-
-test_that(""repair_path() fixes slashes"", {
-  # all slashes should be single ""/"", and no trailing slash
-  expect_equal(repair_path(""a//b\\c/""), ""a/b/c"")
-})
-
-test_that(""repair_path works with zero length path or non-string path"", {
-  expect_equal(repair_path(""""), """")
-  expect_equal(repair_path(5), 5)
-})
-
-test_that(""list_to_array works with empty list"", {
-  expect_equal(list_to_array(list()), NULL)
-})
-
-test_that(""list_to_array fails for non-numeric values"", {
-  expect_error(list_to_array(list(k = ""test""), name = ""test-list""),
-               ""All elements in list 'test-list' must be numeric!"")
-})
-
-test_that(""cmdstan_make_local() works"", {
-  exisiting_make_local <- cmdstan_make_local()
-  make_local_path <- file.path(cmdstan_path(), ""make"", ""local"")
-  if (file.exists(make_local_path)) {
-    file.remove(make_local_path)
-  }
-  expect_equal(cmdstan_make_local(), NULL)
-  cpp_options = list(
-   ""CXX"" = ""clang++"",
-   ""CXXFLAGS+= -march-native"",
-   TEST1 = TRUE,
-   ""TEST2"" = FALSE
-  )
-  expect_equal(cmdstan_make_local(cpp_options = cpp_options),
-               c(
-                 ""CXX=clang++"",
-                 ""CXXFLAGS+= -march-native"",
-                 ""TEST1=true"",
-                 ""TEST2=false""
-                 ))
-  expect_equal(cmdstan_make_local(cpp_options = list(""TEST3"" = TRUE)),
-               c(
-                 ""CXX=clang++"",
-                 ""CXXFLAGS+= -march-native"",
-                 ""TEST1=true"",
-                 ""TEST2=false"",
-                 ""TEST3=true""
-               ))
-  expect_equal(cmdstan_make_local(cpp_options = list(""TEST4"" = TRUE), append = FALSE),
-               c(""TEST4=true""))
-  cmdstan_make_local(cpp_options = as.list(exisiting_make_local), append = FALSE)
-})
-
-test_that(""matching_variables() works"", {
-  ret <- matching_variables(c(""beta""),  c(""alpha"", ""beta[1]"", ""beta[2]"", ""beta[3]""))
-  expect_equal(
-    ret$matching,
-    c(""beta[1]"", ""beta[2]"", ""beta[3]"")
-  )
-  expect_equal(length(ret$not_found), 0)
-
-  ret <- matching_variables(c(""alpha""),  c(""alpha"", ""beta[1]"", ""beta[2]"", ""beta[3]""))
-  expect_equal(
-    ret$matching,
-    c(""alpha"")
-  )
-  expect_equal(length(ret$not_found), 0)
-
-  ret <- matching_variables(c(""alpha"", ""theta""),  c(""alpha"", ""beta[1]"", ""beta[2]"", ""beta[3]""))
-  expect_equal(
-    ret$matching,
-    c(""alpha"")
-  )
-  expect_equal(
-    ret$not_found,
-    c(""theta"")
-  )
-
-  ret <- matching_variables(c(""alpha"", ""beta""),  c(""alpha"", ""beta[1]"", ""beta[2]"", ""beta[3]""))
-  expect_equal(
-    ret$matching,
-    c(""alpha"", ""beta[1]"", ""beta[2]"", ""beta[3]"")
-  )
-  expect_equal(length(ret$not_found), 0)
-})
-
-test_that(""check_ebfmi works"", {
+# if (not_on_cran()) {
+#   set_cmdstan_path()
+#   fit_mcmc <- testing_fit(""logistic"", method = ""sample"",
+#                           seed = 123, chains = 2)
+# }
+#
+# test_that(""check_divergences() works"", {
+#   skip_on_cran()
+#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-2-no-warmup.csv""))
+#   csv_output <- read_cmdstan_csv(csv_files)
+#   output <- ""14 of 100 \\(14.0%\\) transitions ended with a divergence.""
+#   expect_message(check_divergences(csv_output$post_warmup_sampler_diagnostics), output)
+#
+#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-2-no-warmup.csv""),
+#                  test_path(""resources"", ""csv"", ""model1-2-no-warmup.csv""))
+#   csv_output <- read_cmdstan_csv(csv_files)
+#   output <- ""28 of 200 \\(14.0%\\) transitions ended with a divergence.""
+#   expect_message(check_divergences(csv_output$post_warmup_sampler_diagnostics), output)
+#
+#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-2-warmup.csv""))
+#   csv_output <- read_cmdstan_csv(csv_files)
+#   output <- ""1 of 100 \\(1.0%\\) transitions ended with a divergence.""
+#   expect_message(check_divergences(csv_output$post_warmup_sampler_diagnostics), output)
+#
+#
+#   fit_wramup_no_samples <- testing_fit(""logistic"", method = ""sample"",
+#                           seed = 123, chains = 1,
+#                           iter_sampling = 0,
+#                           iter_warmup = 10,
+#                           save_warmup = TRUE,
+#                           validate_csv = FALSE)
+#   csv_output <- read_cmdstan_csv(fit_wramup_no_samples$output_files())
+#   expect_message(check_divergences(csv_output$post_warmup_sampler_diagnostics), regexp = NA)
+# })
+#
+# test_that(""check_sampler_transitions_treedepth() works"", {
+#   skip_on_cran()
+#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-2-no-warmup.csv""))
+#   csv_output <- read_cmdstan_csv(csv_files)
+#   output <- ""16 of 100 \\(16.0%\\) transitions hit the maximum treedepth limit of 5 or 2\\^5-1 leapfrog steps.""
+#   expect_message(
+#     check_sampler_transitions_treedepth(
+#       csv_output$post_warmup_sampler_diagnostics,
+#       csv_output$metadata),
+#     output
+#   )
+#
+#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-2-no-warmup.csv""),
+#                  test_path(""resources"", ""csv"", ""model1-2-no-warmup.csv""))
+#   csv_output <- read_cmdstan_csv(csv_files)
+#   output <- ""32 of 200 \\(16.0%\\) transitions hit the maximum treedepth limit of 5 or 2\\^5-1 leapfrog steps.""
+#   expect_message(
+#     check_sampler_transitions_treedepth(
+#       csv_output$post_warmup_sampler_diagnostics,
+#       csv_output$metadata),
+#     output
+#   )
+#
+#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-2-warmup.csv""))
+#   csv_output <- read_cmdstan_csv(csv_files)
+#   output <- ""1 of 100 \\(1.0%\\) transitions hit the maximum treedepth limit of 5 or 2\\^5-1 leapfrog steps.""
+#   expect_message(
+#     check_sampler_transitions_treedepth(
+#       csv_output$post_warmup_sampler_diagnostics,
+#       csv_output$metadata),
+#     output
+#   )
+# })
+#
+# test_that(""cmdstan_summary works if bin/stansummary deleted file"", {
+#   skip_on_cran()
+#   delete_and_run <- function() {
+#     file.remove(file.path(cmdstan_path(), ""bin"", cmdstan_ext(""stansummary"")))
+#     fit_mcmc$cmdstan_summary()
+#   }
+#   expect_output(delete_and_run(), ""Inference for Stan model: logistic_model\\n2 chains: each with iter"")
+# })
+#
+# test_that(""cmdstan_diagnose works if bin/diagnose deleted file"", {
+#   skip_on_cran()
+#   delete_and_run <- function() {
+#     file.remove(file.path(cmdstan_path(), ""bin"", cmdstan_ext(""diagnose"")))
+#     fit_mcmc$cmdstan_diagnose()
+#   }
+#   expect_output(delete_and_run(), ""Checking sampler transitions treedepth"")
+# })
+#
+# test_that(""repair_path() fixes slashes"", {
+#   # all slashes should be single ""/"", and no trailing slash
+#   expect_equal(repair_path(""a//b\\c/""), ""a/b/c"")
+# })
+#
+# test_that(""repair_path works with zero length path or non-string path"", {
+#   expect_equal(repair_path(""""), """")
+#   expect_equal(repair_path(5), 5)
+# })
+#
+# test_that(""list_to_array works with empty list"", {
+#   expect_equal(list_to_array(list()), NULL)
+# })
+#
+# test_that(""list_to_array fails for non-numeric values"", {
+#   expect_error(list_to_array(list(k = ""test""), name = ""test-list""),
+#                ""All elements in list 'test-list' must be numeric!"")
+# })
+#
+# test_that(""cmdstan_make_local() works"", {
+#   exisiting_make_local <- cmdstan_make_local()
+#   make_local_path <- file.path(cmdstan_path(), ""make"", ""local"")
+#   if (file.exists(make_local_path)) {
+#     file.remove(make_local_path)
+#   }
+#   expect_equal(cmdstan_make_local(), NULL)
+#   cpp_options = list(
+#    ""CXX"" = ""clang++"",
+#    ""CXXFLAGS+= -march-native"",
+#    TEST1 = TRUE,
+#    ""TEST2"" = FALSE
+#   )
+#   expect_equal(cmdstan_make_local(cpp_options = cpp_options),
+#                c(
+#                  ""CXX=clang++"",
+#                  ""CXXFLAGS+= -march-native"",
+#                  ""TEST1=true"",
+#                  ""TEST2=false""
+#                  ))
+#   expect_equal(cmdstan_make_local(cpp_options = list(""TEST3"" = TRUE)),
+#                c(
+#                  ""CXX=clang++"",
+#                  ""CXXFLAGS+= -march-native"",
+#                  ""TEST1=true"",
+#                  ""TEST2=false"",
+#                  ""TEST3=true""
+#                ))
+#   expect_equal(cmdstan_make_local(cpp_options = list(""TEST4"" = TRUE), append = FALSE),
+#                c(""TEST4=true""))
+#   cmdstan_make_local(cpp_options = as.list(exisiting_make_local), append = FALSE)
+# })
+#
+# test_that(""matching_variables() works"", {
+#   ret <- matching_variables(c(""beta""),  c(""alpha"", ""beta[1]"", ""beta[2]"", ""beta[3]""))
+#   expect_equal(
+#     ret$matching,
+#     c(""beta[1]"", ""beta[2]"", ""beta[3]"")
+#   )
+#   expect_equal(length(ret$not_found), 0)
+#
+#   ret <- matching_variables(c(""alpha""),  c(""alpha"", ""beta[1]"", ""beta[2]"", ""beta[3]""))
+#   expect_equal(
+#     ret$matching,
+#     c(""alpha"")
+#   )
+#   expect_equal(length(ret$not_found), 0)
+#
+#   ret <- matching_variables(c(""alpha"", ""theta""),  c(""alpha"", ""beta[1]"", ""beta[2]"", ""beta[3]""))
+#   expect_equal(
+#     ret$matching,
+#     c(""alpha"")
+#   )
+#   expect_equal(
+#     ret$not_found,
+#     c(""theta"")
+#   )
+#
+#   ret <- matching_variables(c(""alpha"", ""beta""),  c(""alpha"", ""beta[1]"", ""beta[2]"", ""beta[3]""))
+#   expect_equal(
+#     ret$matching,
+#     c(""alpha"", ""beta[1]"", ""beta[2]"", ""beta[3]"")
+#   )
+#   expect_equal(length(ret$not_found), 0)
+# })
+
+test_that(""check_ebfmi and computing ebfmi works"", {
   set.seed(1)
   energy_df <- data.frame(""energy__"" = rnorm(1000))
   expect_error(suppressWarnings(check_ebfmi(posterior::as_draws(energy_df))), NA)
+  expect_error(suppressWarnings(ebfmi(posterior::as_draws(energy_df))), NA)
   energy_df[1] <- 0
   for(i in 1:999){
     energy_df$energy__[i+1] <- energy_df$energy__[i] + rnorm(1, 0, 0.01)
@@ -184,12 +185,18 @@ test_that(""check_ebfmi works"", {
   expect_message(check_ebfmi(energy_df), ""fraction of missing information \\(E-BFMI\\) less than"")
   energy_vec <- energy_df$energy__
   check_val <- (sum(diff(energy_vec)^2) / length(energy_vec)) / stats::var(energy_vec)
-  expect_equal(as.numeric(check_ebfmi(energy_df)), check_val)
-  expect_equal(as.numeric(check_ebfmi(posterior::as_draws_array(energy_df))), check_val)
-  expect_equal(as.numeric(check_ebfmi(posterior::as_draws_list(energy_df))), check_val)
-  expect_equal(as.numeric(check_ebfmi(posterior::as_draws_matrix(energy_df))), check_val)
+  expect_equal(as.numeric(ebfmi(energy_df)), check_val)
+  expect_equal(as.numeric(ebfmi(posterior::as_draws_array(energy_df))), check_val)
+  expect_equal(as.numeric(ebfmi(posterior::as_draws_list(energy_df))), check_val)
+  expect_equal(as.numeric(ebfmi(posterior::as_draws_matrix(energy_df))), check_val)
   energy_df <- posterior::as_draws(data.frame(""energy__"" = 0))
-  expect_warning(check_ebfmi(energy_df), ""E-BFMI is undefined for posterior chains of length less than 3"")
+  expect_warning(check_ebfmi(energy_df), ""E-BFMI is undefined for posterior chains of length less than 3."")
+  expect_warning(ebfmi(energy_df), ""E-BFMI is undefined for posterior chains of length less than 3."")
+
+  energy_df <- posterior::as_draws(data.frame(""somethingelse"" = 0))
+  expect_warning(check_ebfmi(energy_df), ""E-BFMI not computed as the 'energy__' diagnostic could not be located."")
+  expect_warning(ebfmi(energy_df), ""E-BFMI not computed as the 'energy__' diagnostic could not be located."")
+
 })
 
 test_that(""require_suggested_package() works"", {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,849915fc5a996093c3e7cf29c637acc38cc91c46,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-07-19T10:38:43Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-07-19T10:44:21Z,fix bug,R/install.R,False,True,True,False,1,1,2,"---FILE: R/install.R---
@@ -622,7 +622,7 @@ cmdstan_arch_suffix <- function(version = NULL) {
   if (grepl(""linux"", R.version$os) && grepl(""aarch64"", R.version$arch)) {
     arch <- ""-linux-arm64""
   }  
-  if (!is.null(version) && version < ""2.26"" && !is.null(arch_suffix)) {
+  if (!is.null(version) && version < ""2.26"") {
     # pre-CmdStan 2.26, only the x85 tarball was provided
     arch <- NULL
   }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,c7cc4411f4f6d5b3c0662dee17d28e913616a21a,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-07-12T11:06:11Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-07-13T18:24:26Z,"- handle the length 1 containers in process data
- error on missing data",R/data.R;R/model.R;tests/testthat/test-data.R,False,True,True,False,64,7,71,"---FILE: R/data.R---
@@ -133,8 +133,10 @@ list_to_array <- function(x, name = NULL) {
 #' @noRd
 #' @param data If not `NULL`, then either a path to a data file compatible with
 #'   CmdStan, or a named list of \R objects to pass to [write_stan_json()].
+#' @param stan_file If not `NULL`, then either a path to a data file compatible with
+#'   CmdStan, or a named list of \R objects to pass to [write_stan_json()].
 #' @return Path to data file.
-process_data <- function(data) {
+process_data <- function(data, stan_file = NULL) {
   if (length(data) == 0) {
     data <- NULL
   }
@@ -151,6 +153,28 @@ process_data <- function(data) {
         call. = FALSE
       )
     }
+    if (cmdstan_version() > ""2.26"" && !is.null(stan_file)) {
+        stan_file <- absolute_path(stan_file)
+        if (file.exists(stan_file)) {
+          data_variables <- model_variables(stan_file)$data
+          is_data_supplied <- names(data_variables) %in%  names(data)
+          if (!all(is_data_supplied)) {
+            missing <- names(data_variables[!is_data_supplied])
+            stop(
+              ""Missing input data for the following data variables:"",
+              paste0(missing, collapse = "", ""),
+              ""."",
+              call. = FALSE
+            )
+          }          
+          for(var_name in names(data)) {
+            if (length(data[[var_name]]) == 1 
+                && data_variables[[var_name]]$dimensions == 1) {
+                data[[var_name]] <- array(data[[var_name]], dim = 1)
+            }
+          }
+        }
+    }
     path <- tempfile(pattern = ""standata-"", fileext = "".json"")
     write_stan_json(data = data, file = path)
   } else {

---FILE: R/model.R---
@@ -819,7 +819,7 @@ sample <- function(data = NULL,
     model_name = self$model_name(),
     exe_file = self$exe_file(),
     proc_ids = checkmate::assert_integerish(chain_ids, lower = 1, len = chains, unique = TRUE, null.ok = FALSE),
-    data_file = process_data(data),
+    data_file = process_data(data, self$stan_file()),
     save_latent_dynamics = save_latent_dynamics,
     seed = seed,
     init = init,
@@ -954,7 +954,7 @@ sample_mpi <- function(data = NULL,
     model_name = self$model_name(),
     exe_file = self$exe_file(),
     proc_ids = checkmate::assert_integerish(chain_ids, lower = 1, len = chains, unique = TRUE, null.ok = FALSE),
-    data_file = process_data(data),
+    data_file = process_data(data, self$stan_file()),
     save_latent_dynamics = save_latent_dynamics,
     seed = seed,
     init = init,
@@ -1059,7 +1059,7 @@ optimize <- function(data = NULL,
     model_name = self$model_name(),
     exe_file = self$exe_file(),
     proc_ids = 1,
-    data_file = process_data(data),
+    data_file = process_data(data, self$stan_file()),
     save_latent_dynamics = save_latent_dynamics,
     seed = seed,
     init = init,
@@ -1169,7 +1169,7 @@ variational <- function(data = NULL,
     model_name = self$model_name(),
     exe_file = self$exe_file(),
     proc_ids = 1,
-    data_file = process_data(data),
+    data_file = process_data(data, self$stan_file()),
     save_latent_dynamics = save_latent_dynamics,
     seed = seed,
     init = init,
@@ -1271,7 +1271,7 @@ generate_quantities <- function(fitted_params,
     model_name = self$model_name(),
     exe_file = self$exe_file(),
     proc_ids = seq_along(fitted_params_files),
-    data_file = process_data(data),
+    data_file = process_data(data, self$stan_file()),
     seed = seed,
     output_dir = output_dir,
     output_basename = output_basename,
@@ -1327,7 +1327,7 @@ diagnose_method <- function(data = NULL,
     model_name = self$model_name(),
     exe_file = self$exe_file(),
     proc_ids = 1,
-    data_file = process_data(data),
+    data_file = process_data(data, self$stan_file()),
     seed = seed,
     init = init,
     output_dir = output_dir,

---FILE: tests/testthat/test-data.R---
@@ -8,7 +8,40 @@ if (not_on_cran()) {
 }
 
 test_that(""empty data list converted to NULL"", {
+  skip_on_cran()
+  stan_file <- write_stan_file(""
+  parameters {
+    real y;
+  }
+  model {
+    y ~ std_normal();
+  }
+  "")
   expect_null(process_data(list()))
+  expect_null(process_data(list(), stan_file = stan_file))
+})
+
+test_that(""process_data works for inputs of length one"", {
+  skip_on_cran()
+  data <- list(val = 5)
+  stan_file <- write_stan_file(""
+  data {
+    real val;
+  }
+  "")
+  expect_equal(jsonlite::read_json(process_data(data, stan_file = stan_file)), list(val = 5))
+  stan_file <- write_stan_file(""
+  data {
+    int val;
+  }
+  "")
+  expect_equal(jsonlite::read_json(process_data(data, stan_file = stan_file)), list(val = 5))
+  stan_file <- write_stan_file(""
+  data {
+    vector[1] val;
+  }
+  "")
+  expect_equal(jsonlite::read_json(process_data(data, stan_file = stan_file)), list(val = list(5)))
 })
 
 test_that(""process_fitted_params() works with basic input types"", {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,7c1f8fd0403c8f6ea48862a54c3e3ac60019e7f8,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-07-11T10:40:00Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-07-11T10:40:00Z,fixes,R/model.R;tests/testthat/test-model-variables.R,False,True,True,False,15,15,30,"---FILE: R/model.R---
@@ -1444,11 +1444,9 @@ model_variables <- function(stan_file) {
     error_on_status = TRUE
   )
   variables <- jsonlite::read_json(out_file, na = ""null"")
-  if (length(variables$inputs) == 0) {
-    variables[[""data""]] <- NULL
-  } else {
-    variables[[""data""]] <- variables$inputs
-  }
+  variables$data <- variables$inputs
   variables$inputs <- NULL
+  variables$functions <- NULL
+  variables$distributions <- NULL
   variables
 }
\ No newline at end of file

---FILE: tests/testthat/test-model-variables.R---
@@ -15,15 +15,17 @@ test_that(""$variables() work correctly with example models"", {
   expect_equal(mod$variables()$data$y$dimensions, 1)
   expect_equal(mod$variables()$parameters$theta$type, ""real"")
   expect_equal(mod$variables()$parameters$theta$dimensions, 0)
-  expect_equal(mod$variables()$transformed_parameters, NULL)
-  expect_equal(mod$variables()$generated_quantities, NULL)
+  expect_equal(length(mod$variables()[[""transformed parameters""]]), 0)
+  expect_equal(length(mod$variables()[[""generated quantities""]]), 0)
+  expect_true(is.list(mod$variables()[[""transformed parameters""]]))
+  expect_true(is.list(mod$variables()[[""generated quantities""]]))
 
   mod <- testing_model(""bernoulli_log_lik"")
   expect_equal(names(mod$variables()$data), c(""N"", ""y""))
   expect_equal(names(mod$variables()$parameters), c(""theta""))
-  expect_equal(names(mod$variables()$generated_quantities), c(""log_lik""))
-  expect_equal(mod$variables()$generated_quantities$log_lik$type, ""real"")
-  expect_equal(mod$variables()$generated_quantities$log_lik$dimensions, 1)
+  expect_equal(names(mod$variables()[[""generated quantities""]]), c(""log_lik""))
+  expect_equal(mod$variables()[[""generated quantities""]]$log_lik$type, ""real"")
+  expect_equal(mod$variables()[[""generated quantities""]]$log_lik$dimensions, 1)
 
   mod <- testing_model(""logistic"")
   expect_equal(names(mod$variables()$data), c(""N"", ""K"", ""y"", ""X""))
@@ -61,15 +63,15 @@ test_that(""$variables() work correctly with example models"", {
   mod <- cmdstan_model(stan_file)
   expect_equal(names(mod$variables()$data), c(""y"", ""x""))
   expect_equal(names(mod$variables()$parameters), c(""z""))
-  expect_equal(names(mod$variables()$transformed_parameters), c(""p"", ""pp""))
+  expect_equal(names(mod$variables()[[""transformed parameters""]]), c(""p"", ""pp""))
   expect_equal(mod$variables()$data$y$type, ""int"")
   expect_equal(mod$variables()$data$y$dimensions, 8)
   expect_equal(mod$variables()$data$x$type, ""real"")
   expect_equal(mod$variables()$data$x$dimensions, 5)
   expect_equal(mod$variables()$parameters$z$type, ""real"")
   expect_equal(mod$variables()$parameters$z$dimensions, 0)
-  expect_equal(mod$variables()$transformed_parameters$p$type, ""real"")
-  expect_equal(mod$variables()$transformed_parameters$p$dimensions, 3)
-  expect_equal(mod$variables()$transformed_parameters$pp$type, ""real"")
-  expect_equal(mod$variables()$transformed_parameters$pp$dimensions, 3)
+  expect_equal(mod$variables()[[""transformed parameters""]]$p$type, ""real"")
+  expect_equal(mod$variables()[[""transformed parameters""]]$p$dimensions, 3)
+  expect_equal(mod$variables()[[""transformed parameters""]]$pp$type, ""real"")
+  expect_equal(mod$variables()[[""transformed parameters""]]$pp$dimensions, 3)
 })",True,False,Implementation / Logic,6
stan-dev,cmdstanr,19fd348c8a6b91414572469c62976cbc337782bb,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-07-09T12:42:47Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-07-09T12:42:47Z,fix sytnax,R/model.R,False,True,True,False,1,1,2,"---FILE: R/model.R---
@@ -543,7 +543,7 @@ variables <- function(block = NULL) {
       stop(
         ""Unexpected value in 'block'. Allowed values are: "",
         paste0(allowed_block, collapse = "", ""),
-        "".""
+        ""."",
         call. = FALSE
       )
     }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,e3671fdbf35d0be657b3ed5ffb44c794f8e65b6c,jgabry,jgabry@gmail.com,2021-07-02T18:20:33Z,jgabry,jgabry@gmail.com,2021-07-02T18:20:33Z,fix tests,tests/testthat/test-model-data.R,False,True,True,False,3,3,6,"---FILE: tests/testthat/test-model-data.R---
@@ -42,9 +42,9 @@ test_that(""error if data contains NA elements"", {
   data_list2$y[3] <- NA
   data_list3$X[3, 2] <- NA
 
-  expect_error(mod$sample(data = data_list1), ""Data includes NA values"")
-  expect_error(mod$sample(data = data_list2), ""Data includes NA values"")
-  expect_error(mod$sample(data = data_list3), ""Data includes NA values"")
+  expect_error(mod$sample(data = data_list1), ""Variable 'N' has NA values"")
+  expect_error(mod$sample(data = data_list2), ""Variable 'y' has NA values"")
+  expect_error(mod$sample(data = data_list3), ""Variable 'X' has NA values"")
 })
 
 test_that(""empty data list doesn't error if no data block"", {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,cd9c8d8276b3052e4a11c35a9f86bd4930d3619e,jgabry,jgabry@gmail.com,2021-07-02T03:21:37Z,jgabry,jgabry@gmail.com,2021-07-02T03:21:37Z,check for a few more errors in write_stan_json,R/data.R,False,True,True,False,13,10,23,"---FILE: R/data.R---
@@ -11,6 +11,7 @@
 #' * `logical` -> `integer` (`TRUE` -> `1`, `FALSE` -> `0`)
 #' * `data.frame` -> `matrix` (via [data.matrix()])
 #' * `list` -> `array`
+#' * `table` -> `vector`, `matrix`, or `array` (depending on dimensions of table)
 #'
 #' The `list` to `array` conversion is intended to make it easier to prepare
 #' the data for certain Stan declarations involving arrays:
@@ -52,11 +53,20 @@
 #' cat(readLines(file), sep = ""\n"")
 #'
 write_stan_json <- function(data, file) {
+  if (!is.list(data)) {
+    stop(""'data' must be a list."", call. = FALSE)
+  }
   if (!is.character(file) || !nzchar(file)) {
     stop(""The supplied filename is invalid!"", call. = FALSE)
   }
 
   data_names <- names(data)
+  if (length(data) > 0 &&
+      (length(data_names) == 0 ||
+       length(data_names) != sum(nzchar(data_names)))) {
+    stop(""All elements in 'data' list must have names."", call. = FALSE)
+
+  }
   if (anyDuplicated(data_names) != 0) {
     stop(""Duplicate names not allowed in 'data'."", call. = FALSE)
   }
@@ -67,8 +77,10 @@ write_stan_json <- function(data, file) {
           is.data.frame(var) || is.list(var))) {
       stop(""Variable '"", var_name, ""' is of invalid type."", call. = FALSE)
     }
+    if (anyNA(var)) {
+      stop(""Variable '"", var_name, ""' has NA values."", call. = FALSE)
+    }
 
-    if (is.logical(var)) {
     if (is.table(var)) {
       var <- unclass(var)
       if (length(dim(var)) == 1) {
@@ -143,9 +155,6 @@ process_data <- function(data) {
         call. = FALSE
       )
     }
-    if (any_na_elements(data)) {
-      stop(""Data includes NA values."", call. = FALSE)
-    }
     path <- tempfile(pattern = ""standata-"", fileext = "".json"")
     write_stan_json(data = data, file = path)
   } else {
@@ -160,12 +169,6 @@ any_zero_dims <- function(data) {
   any(has_zero_dims)
 }
 
-# check if any objects in the data list contain NAs
-any_na_elements <- function(data) {
-  has_na_elements <- sapply(data, anyNA)
-  any(has_na_elements)
-}
-
 #' Write posterior draws objects to csv files
 #' @noRd
 #' @param draws A `draws_array` from posterior pkg",True,False,Implementation / Logic,6
stan-dev,cmdstanr,f1447d47a605795273a7a97515c77c72117fe82d,jgabry,jgabry@gmail.com,2021-06-22T18:56:26Z,jgabry,jgabry@gmail.com,2021-06-22T18:56:26Z,"check if length(draws) == 0

fixes #525",R/csv.R;tests/testthat/test-csv.R,False,True,True,False,22,3,25,"---FILE: R/csv.R---
@@ -342,7 +342,11 @@ read_cmdstan_csv <- function(files,
       format <- ""draws_matrix""
     }
     as_draws_format <- as_draws_format_fun(format)
-    variational_draws <- do.call(as_draws_format, list(draws[[1]][-1, colnames(draws[[1]]) != ""lp__"", drop = FALSE]))
+    if (length(draws) == 0) {
+      variational_draws <- NULL
+    } else {
+      variational_draws <- do.call(as_draws_format, list(draws[[1]][-1, colnames(draws[[1]]) != ""lp__"", drop = FALSE]))
+    }
     if (!is.null(variational_draws)) {
       if (""log_p__"" %in% posterior::variables(variational_draws)) {
         variational_draws <- posterior::rename_variables(variational_draws, lp__ = ""log_p__"")
@@ -361,8 +365,12 @@ read_cmdstan_csv <- function(files,
       format <- ""draws_matrix""
     }
     as_draws_format <- as_draws_format_fun(format)
-    point_estimates <- do.call(as_draws_format, list(draws[[1]][1, , drop = FALSE]))
-    point_estimates <- posterior::subset_draws(point_estimates, variable = variables)
+    if (length(draws) == 0) {
+      point_estimates <- NULL
+    } else {
+      point_estimates <- do.call(as_draws_format, list(draws[[1]][1, , drop = FALSE]))
+      point_estimates <- posterior::subset_draws(point_estimates, variable = variables)
+    }
     if (!is.null(point_estimates)) {
       posterior::variables(point_estimates) <- repaired_variables
     }

---FILE: tests/testthat/test-csv.R---
@@ -801,3 +801,14 @@ test_that(""variable_dims() works"", {
   expect_equal(variable_dims(vars), vars_dims)
 })
 
+test_that(""read_cmdstan_csv works if no variables are specified"", {
+  expect_silent(
+    read_cmdstan_csv(fit_bernoulli_optimize$output_files(), variables = """", sampler_diagnostics = """")
+  )
+  expect_silent(
+    read_cmdstan_csv(fit_bernoulli_variational$output_files(), variables = """", sampler_diagnostics = """")
+  )
+  expect_silent(
+    read_cmdstan_csv(fit_bernoulli_thin_1$output_files(), variables = """", sampler_diagnostics = """")
+  )
+})",True,False,Implementation / Logic,6
stan-dev,cmdstanr,e44a0d05629c3527c0349b727966405e4ace5374,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-06-20T10:31:34Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-06-20T10:31:34Z,fix spaces in args,R/model.R;tests/testthat/test-model-compile.R,False,True,True,False,7,7,14,"---FILE: R/model.R---
@@ -480,7 +480,7 @@ compile <- function(quiet = TRUE,
       stanc_built_options <- c(stanc_built_options, paste0(""--"", option_name, ""="", ""'"", stanc_options[[i]], ""'""))
     }
   }
-  stancflags_val <- paste0(""STANCFLAGS += "", stancflags_val, paste0(stanc_built_options, collapse = "" ""))
+  stancflags_val <- paste0(""STANCFLAGS += "", stancflags_val, paste0("" "", stanc_built_options, collapse = "" ""))
   run_log <- processx::run(
     command = make_cmd(),
     args = c(tmp_exe,
@@ -1380,11 +1380,11 @@ include_paths_stanc3_args <- function(include_paths = NULL) {
     include_paths <- absolute_path(include_paths)
     include_paths <- paste0(include_paths, collapse = "","")
     if (cmdstan_version() >= ""2.24"") {
-      include_paths_flag <- "" --include-paths=""
+      include_paths_flag <- ""--include-paths=""
     } else {
-      include_paths_flag <- "" --include_paths=""
+      include_paths_flag <- ""--include_paths=""
     }
-    stancflags <- paste0(stancflags, include_paths_flag, include_paths, "" "")
+    stancflags <- paste0(stancflags, include_paths_flag, include_paths)
   }
   stancflags
 }
\ No newline at end of file

---FILE: tests/testthat/test-model-compile.R---
@@ -277,7 +277,7 @@ test_that(""compiling stops on hyphens in stanc_options"", {
 test_that(""compiling works with only names in list"", {
   skip_on_cran()
   stan_file <- testing_stan_file(""bernoulli"")
-  mod <- cmdstan_model(stan_file, stanc_options = list(""warn-pedantic""), force_recompile = TRUE, quiet = FALSE)
+  mod <- cmdstan_model(stan_file, stanc_options = list(""warn-pedantic""), force_recompile = TRUE)
   checkmate::expect_r6(
     mod,
     ""CmdStanModel""
@@ -469,7 +469,7 @@ test_that(""include_paths_stanc3_args() works"", {
     dir.create(path_1)
   }
   path_1 <- repair_path(path_1)
-  expect_equal(include_paths_stanc3_args(path_1), paste0("" "", ""--include-paths="", path_1, "" ""))
+  expect_equal(include_paths_stanc3_args(path_1), paste0(""--include-paths="", path_1))
   path_2 <- file.path(tempdir(), ""folder2"")
   if (!dir.exists(path_2)) {
     dir.create(path_2)
@@ -478,7 +478,7 @@ test_that(""include_paths_stanc3_args() works"", {
   expect_equal(
     include_paths_stanc3_args(c(path_1, path_2)),
     c(
-      paste0("" "", ""--include-paths="", path_1, "","", path_2, "" "")
+      paste0(""--include-paths="", path_1, "","", path_2)
     )
   )
 })",True,False,Implementation / Logic,6
stan-dev,cmdstanr,1a406ab57f6646f517ecb033b3d7d657ade99777,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-06-20T08:52:12Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-06-20T08:52:12Z,syntax fix,tests/testthat/test-model-compile.R,False,True,True,False,2,2,4,"---FILE: tests/testthat/test-model-compile.R---
@@ -468,13 +468,13 @@ test_that(""include_paths_stanc3_args() works"", {
   if (!dir.exists(path_1)) {
     dir.create(path_1)
   }
-  path1 <- repair_path(path1)
+  path_1 <- repair_path(path_1)
   expect_equal(include_paths_stanc3_args(path_1), paste0("" "", ""--include-paths="", path_1, "" ""))
   path_2 <- file.path(tempdir(), ""folder2"")
   if (!dir.exists(path_2)) {
     dir.create(path_2)
   }
-  path2 <- repair_path(path2)
+  path_2 <- repair_path(path_2)
   expect_equal(
     include_paths_stanc3_args(c(path_1, path_2)),
     c(",True,False,Rendering / Conversion,3
stan-dev,cmdstanr,12f6632028d914298dc10484b783690623778770,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-06-19T14:33:19Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-06-19T15:05:37Z,fix typos,R/install.R;R/run.R,False,True,True,False,2,2,4,"---FILE: R/install.R---
@@ -389,7 +389,7 @@ clean_cmdstan <- function(dir = cmdstan_path(),
 build_example <- function(dir, cores, quiet, timeout) {
   processx::run(
     make_cmd(),
-    args = c(paste0(""-j"", cores), cmdstan_ext(file.path(""examples"", ""berrnoulli"", ""bernoulli""))),
+    args = c(paste0(""-j"", cores), cmdstan_ext(file.path(""examples"", ""bernoulli"", ""bernoulli""))),
     wd = dir,
     echo_cmd = is_verbose_mode(),
     echo = !quiet || is_verbose_mode(),

---FILE: R/run.R---
@@ -840,7 +840,7 @@ CmdStanMCMCProcs <- R6::R6Class(
             next_state <- 3
           }
           if (state < 3 && grepl(""Elapsed Time:"", line, perl = TRUE)) {
-            state <- 5 # 5 = end of samp+ling
+            state <- 5 # 5 = end of sampling
             next_state <- 5
           }
           if (private$proc_state_[[id]] == 3 &&",True,False,Implementation / Logic,3
stan-dev,cmdstanr,8548a044ae1d257eadb4fc5e59c1c1fc78360612,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-06-19T09:59:03Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-06-19T09:59:03Z,"- add the bugfix to read remaining stderr & stdout (suggested by @martinmodrak)
- cleanup process_output, process_error_output code",R/run.R,False,True,True,False,18,20,38,"---FILE: R/run.R---
@@ -364,10 +364,8 @@ check_target_exe <- function(exe) {
       procs$poll(0)
       for (chain_id in chains) {
         if (!procs$is_queued(chain_id)) {
-          output <- procs$get_proc(chain_id)$read_output_lines()
-          procs$process_output(output, chain_id)
-          error_output <- procs$get_proc(chain_id)$read_error_lines()
-          procs$process_error_output(error_output, chain_id)
+          procs$process_output(chain_id)
+          procs$process_error_output(chain_id)
         }
       }
       procs$set_active_procs(procs$num_alive())
@@ -424,10 +422,8 @@ CmdStanRun$set(""private"", name = ""run_sample_"", value = .run_sample)
       procs$poll(0)
       for (chain_id in chains) {
         if (!procs$is_queued(chain_id)) {
-          output <- procs$get_proc(chain_id)$read_output_lines()
-          procs$process_output(output, chain_id)
-          error_output <- procs$get_proc(chain_id)$read_error_lines()
-          procs$process_error_output(error_output, chain_id)
+          procs$process_output(chain_id)
+          procs$process_error_output(chain_id)
         }
       }
       procs$set_active_procs(procs$num_alive())
@@ -460,13 +456,13 @@ CmdStanRun$set(""private"", name = ""run_generate_quantities_"", value = .run_genera
     procs$wait(0.1)
     procs$poll(0)
     if (!procs$is_queued(id)) {
-      output <- procs$get_proc(id)$read_output_lines()
-      procs$process_output(output, id)
-      error_output <- procs$get_proc(id)$read_error_lines()
-      procs$process_error_output(error_output, id)
+      procs$process_output(id)
+      procs$process_error_output(id)
     }
     procs$set_active_procs(procs$num_alive())
   }
+  procs$process_output(id)
+  procs$process_error_output(id)
   successful_fit <- FALSE
   if (self$method() == ""optimize"") {
     if (procs$proc_state(id = id) > 3) {
@@ -651,10 +647,8 @@ CmdStanProcs <- R6::R6Class(
         if (self$is_still_working(id) && !self$is_queued(id) && !self$is_alive(id)) {
           # if the process just finished make sure we process all
           # input and mark the process finished
-          output <- self$get_proc(id)$read_output_lines()
-          self$process_output(output, id)
-          error_output <- self$get_proc(id)$read_error_lines()
-          self$process_error_output(error_output, id)
+          self$process_output(id)
+          self$process_error_output(id)
           self$mark_proc_stop(id)
           self$report_time(id)
         }
@@ -723,7 +717,8 @@ CmdStanProcs <- R6::R6Class(
       (grepl(""A method must be specified!"", line, perl = TRUE)) ||
       (grepl(""is not a valid value for"", line, perl = TRUE))
     },
-    process_error_output = function(err_out, id) {
+    process_error_output = function(id) {
+      err_out <- self$get_proc(id)$read_error_lines()
       if (length(err_out)) {
         for (err_line in err_out) {
           private$proc_output_[[id]] <- c(private$proc_output_[[id]], err_line)
@@ -733,7 +728,8 @@ CmdStanProcs <- R6::R6Class(
         }
       }
     },
-    process_output = function(out, id) {
+    process_output = function(id) {
+      out <- self$get_proc(id)$read_output_lines()
       if (length(out) == 0) {
         return(NULL)
       }
@@ -809,7 +805,8 @@ CmdStanMCMCProcs <- R6::R6Class(
   classname = ""CmdStanMCMCProcs"",
   inherit = CmdStanProcs,
   public = list(
-    process_output = function(out, id) {
+    process_output = function(id) {
+      out <- self$get_proc(id)$read_output_lines()
       if (length(out) == 0) {
         return(invisible(NULL))
       }
@@ -968,7 +965,8 @@ CmdStanGQProcs <- R6::R6Class(
       }
       invisible(self)
     },
-    process_output = function(out, id) {
+    process_output = function(id) {
+      out <- self$get_proc(id)$read_output_lines()
       if (length(out) == 0) {
         return(NULL)
       }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,068d4299409077418a90869d5f0873534bdba2a4,jgabry,jgabry@gmail.com,2021-06-18T20:59:29Z,jgabry,jgabry@gmail.com,2021-06-18T20:59:29Z,fix typo,R/path.R,False,True,True,False,1,1,2,"---FILE: R/path.R---
@@ -35,7 +35,7 @@
 #'
 set_cmdstan_path <- function(path = NULL) {
   if (is.null(path)) {
-    path <- cmdstan_default_path() || cmdstan_default_path(old = TRUE)
+    path <- cmdstan_default_path() %||% cmdstan_default_path(old = TRUE)
   }
   if (dir.exists(path)) {
     path <- absolute_path(path)",True,False,Implementation / Logic,6
stan-dev,cmdstanr,881b7fdaab004f1c3cb96b6f4b1410c25329809a,jgabry,jgabry@gmail.com,2021-06-18T16:56:44Z,jgabry,jgabry@gmail.com,2021-06-18T16:56:44Z,"error if duplicate names in data

closes #515",R/data.R;tests/testthat/test-json.R,False,True,True,False,11,1,12,"---FILE: R/data.R---
@@ -56,7 +56,12 @@ write_stan_json <- function(data, file) {
     stop(""The supplied filename is invalid!"", call. = FALSE)
   }
 
-  for (var_name in names(data)) {
+  data_names <- names(data)
+  if (anyDuplicated(data_names) != 0) {
+    stop(""Duplicate names not allowed in 'data'."", call. = FALSE)
+  }
+
+  for (var_name in data_names) {
     var <- data[[var_name]]
     if (!(is.numeric(var) || is.factor(var) || is.logical(var) ||
           is.data.frame(var) || is.list(var))) {

---FILE: tests/testthat/test-json.R---
@@ -119,4 +119,9 @@ test_that(""write_stan_json() throws correct errors"", {
     write_stan_json(list(N = ""STRING""), file = ""abc.txt""),
     ""Variable 'N' is of invalid type""
   )
+
+  expect_error(
+    write_stan_json(list(x = 1, y = 2, x = 3), file = tempfile()),
+    ""Duplicate names not allowed in 'data'""
+  )
 })",True,False,Implementation / Logic,6
stan-dev,cmdstanr,5e8e2503d91a7036526429c7834f2bb12e0ffeab,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-05-25T10:25:38Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-05-25T10:25:38Z,fix testing issues,R/utils.R;tests/testthat/test-fit-mcmc.R,False,True,True,False,34,32,66,"---FILE: R/utils.R---
@@ -281,41 +281,43 @@ check_sampler_transitions_treedepth <- function(post_warmup_sampler_diagnostics,
 }
 
 check_ebfmi <- function(post_warmup_sampler_diagnostics, ebfmi_threshold = .2, return_ebfmi = F) {
-  pwsd <- posterior::as_draws_array(post_warmup_sampler_diagnostics)
-  if (!(""energy__"" %in% dimnames(pwsd)$variable)) {
-    if (! return_ebfmi) {
-      warning(""E-BFMI not computed as the 'energy__' diagnostic could not be located"")
-    } else {
-      stop(""E-BFMI not computed as the 'energy__' diagnostic could not be located"")
-    }
-  } else if (dim(pwsd)[1] <= 2) {
-    if (! return_ebfmi) {
-      warning(""E-BFMI is undefined for posterior chains of length less than 3"")
-    } else {
-      stop(""E-BFMI is undefined for posterior chains of length less than 3"")
-    }
-  } else {
-    energy <- posterior::extract_variable_matrix(pwsd, ""energy__"")
-    if (any(is.na(energy))) {
+  if (!is.null(post_warmup_sampler_diagnostics) && posterior::niterations(post_warmup_sampler_diagnostics) > 0) {
+    pwsd <- posterior::as_draws_array(post_warmup_sampler_diagnostics)
+    if (!(""energy__"" %in% dimnames(pwsd)$variable)) {
       if (! return_ebfmi) {
-        warning(""E-BFMI not computed because 'energy__' contains NAs"")
+        warning(""E-BFMI not computed as the 'energy__' diagnostic could not be located"")
       } else {
-        stop(""E-BFMI not computed because 'energy__' contains NAs"")
+        stop(""E-BFMI not computed as the 'energy__' diagnostic could not be located"")
+      }
+    } else if (dim(pwsd)[1] <= 2) {
+      if (! return_ebfmi) {
+        warning(""E-BFMI is undefined for posterior chains of length less than 3"")
+      } else {
+        stop(""E-BFMI is undefined for posterior chains of length less than 3"")
+      }
+    } else {
+      energy <- posterior::extract_variable_matrix(pwsd, ""energy__"")
+      if (any(is.na(energy))) {
+        if (! return_ebfmi) {
+          warning(""E-BFMI not computed because 'energy__' contains NAs"")
+        } else {
+          stop(""E-BFMI not computed because 'energy__' contains NAs"")
+        }
+      }
+      ebfmi <- apply(energy, 2, function(x) {
+        (sum(diff(x)^2) / length(x)) / stats::var(x)
+      }
+      )
+      if (any(ebfmi < ebfmi_threshold)) {
+        message(paste0(sum(ebfmi < ebfmi_threshold), "" of "", length(ebfmi), "" chains had energy-based Bayesian fraction "",
+        ""of missing information (E-BFMI) less than "", ebfmi_threshold, "", which may indicate poor exploration of the "", 
+        ""posterior""))
+      }
+      if (return_ebfmi) {
+        ebfmi
       }
     }
-    ebfmi <- apply(energy, 2, function(x) {
-      (sum(diff(x)^2) / length(x)) / stats::var(x)
-    }
-    )
-    if (any(ebfmi < ebfmi_threshold)) {
-      message(paste0(sum(ebfmi < ebfmi_threshold), "" of "", length(ebfmi), "" chains had energy-based Bayesian fraction "",
-      ""of missing information (E-BFMI) less than "", ebfmi_threshold, "", which may indicate poor exploration of the "", 
-      ""posterior""))
-    }
-    if (return_ebfmi) {
-      ebfmi
-    }
-  }
+  }  
 }
 
 

---FILE: tests/testthat/test-fit-mcmc.R---
@@ -50,7 +50,7 @@ test_that(""draws() works when gradually adding variables"", {
   expect_equal(posterior::variables(draws_lp__), c(""lp__""))
   expect_type(sampler_diagnostics, ""double"")
   expect_s3_class(sampler_diagnostics, ""draws_array"")
-  expect_equal(posterior::variables(sampler_diagnostics), c(c(""treedepth__"", ""divergent__"", ""accept_stat__"", ""stepsize__"", ""n_leapfrog__"", ""energy__"")))
+  expect_equal(posterior::variables(sampler_diagnostics), c(c(""treedepth__"", ""divergent__"", ""energy__"", ""accept_stat__"", ""stepsize__"", ""n_leapfrog__"")))
   draws_alpha <- fit$draws(variables = c(""alpha""), inc_warmup = TRUE)
   expect_type(draws_alpha, ""double"")
   expect_s3_class(draws_alpha, ""draws_array"")",True,False,Implementation / Logic,6
stan-dev,cmdstanr,ac2a6e2f42dfacce3966cd961fd6dc9c74cf8556,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-05-23T17:33:06Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-05-23T17:33:06Z,catch compiler error for full disk,R/model.R,False,True,True,False,7,0,7,"---FILE: R/model.R---
@@ -513,6 +513,13 @@ compile <- function(quiet = TRUE,
           call. = FALSE
         )
       }
+      if (grepl(""No space left on device"", x) || grepl(""error in backend: IO failure on output stream"", x)) {
+        warning(
+          ""The C++ compiler ran out of disk space and was unable to build the executables for your model!\n"",
+          ""See the above error for more details."",
+          call. = FALSE
+        )
+      }
     },
     error_on_status = FALSE
   )",True,False,Implementation / Logic,6
stan-dev,cmdstanr,9634ad797b2afad73106ba3f273be40eadce4009,Jacob Socolar,jacob.socolar@gmail.com,2021-05-20T21:49:20Z,Jacob Socolar,jacob.socolar@gmail.com,2021-05-20T21:49:20Z,better error messages,R/utils.R;tests/testthat/test-utils.R,False,True,True,False,21,3,24,"---FILE: R/utils.R---
@@ -280,14 +280,29 @@ check_sampler_transitions_treedepth <- function(post_warmup_sampler_diagnostics,
   }
 }
 
-check_ebfmi <- function(post_warmup_sampler_diagnostics, ebfmi_threshold = .3, return_ebfmi = F) {
+check_ebfmi <- function(post_warmup_sampler_diagnostics, ebfmi_threshold = .2, return_ebfmi = F) {
   pwsd <- posterior::as_draws_array(post_warmup_sampler_diagnostics)
   if (!(""energy__"" %in% dimnames(pwsd)$variable)) {
-    warning(""E-BFMI not computed as the 'energy__' diagnostic could not be located"")
+    if (! return_ebfmi) {
+      warning(""E-BFMI not computed as the 'energy__' diagnostic could not be located"")
+    } else {
+      stop(""E-BFMI not computed as the 'energy__' diagnostic could not be located"")
+    }
   } else if (dim(pwsd)[1] <= 1) {
-    warning(""E-BFMI is undefined for posterior chains of length 1"")
+    if (! return_ebfmi) {
+      warning(""E-BFMI is undefined for posterior chains of length less than 2"")
+    } else {
+      stop(""E-BFMI is undefined for posterior chains of length less than 2"")
+    }
   } else {
     energy <- posterior::extract_variable_matrix(pwsd, ""energy__"")
+    if (any is.na(energy)) {
+      if (! return_ebfmi) {
+        warning(""E-BFMI not computed 'energy__' contains NAs"")
+      } else {
+        stop(""E-BFMI not computed 'energy__' contains NAs"")
+      }
+    }
     ebfmi <- apply(energy, 2, function(x) {
       (sum(diff(x)^2) / length(x)) / stats::var(x)
     }

---FILE: tests/testthat/test-utils.R---
@@ -184,6 +184,9 @@ test_that(""check_ebfmi works"", {
   energy_vec <- energy_df$energy__
   expect_equal(suppressMessages(check_ebfmi(energy_df, return_ebfmi = TRUE)), 
                (sum(diff(energy_vec)^2) / length(energy_vec)) / stats::var(energy_vec))
+  energy_df <- data.frame(""energy__"" = 0)
+  expect_error(check_ebfmi(energy_df, return_ebfmi = TRUE), ""E-BFMI is undefined for posterior chains of length 1"")
+  expect_warning(check_ebfmi(energy_df), ""E-BFMI is undefined for posterior chains of length 1"")
 })
 
 test_that(""require_suggested_package() works"", {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,3050048de59638b355055a5cd7544c057ac907bc,Jacob Socolar,jacob.socolar@gmail.com,2021-05-20T19:55:06Z,Jacob Socolar,jacob.socolar@gmail.com,2021-05-20T19:55:06Z,fixed stupid error message typo,R/utils.R,False,True,True,False,7,6,13,"---FILE: R/utils.R---
@@ -282,19 +282,20 @@ check_sampler_transitions_treedepth <- function(post_warmup_sampler_diagnostics,
 
 check_ebfmi <- function(post_warmup_sampler_diagnostics, ebfmi_threshold = .3, return_ebfmi = F) {
   pwsd <- posterior::as_draws_array(post_warmup_sampler_diagnostics)
-  if (! (""energy__"" %in% dimnames(pwsd)$variable)) {
+  if (!(""energy__"" %in% dimnames(pwsd)$variable)) {
     warning(""e-bfmi not computed as the 'energy__' diagnostic could not be located"")
   } else if (dim(pwsd)[1] <= 1) {
     warning(""e-bfmi is undefined for posterior chains of length 1"")
   } else {
-    energy <- posterior::extract_variable_matrix(pwsd, ""energy___"")
+    energy <- posterior::extract_variable_matrix(pwsd, ""energy__"")
     fmi <- apply(energy, 2, function(x) {
       (sum(diff(x)^2) / length(x)) / stats::var(x)
-    })
+    }
+    )
     if (any(fmi < ebfmi_threshold)) {
-      message(sum(fmi < ebfmi_threshold), "" of "", length(fmi) , "" chains had estimated Bayesian fraction
-      of missing information(E-BFMI) less than "" threshold "", which may indicate poor exploration of the
-      posterior. "")
+      message(paste0(sum(fmi < ebfmi_threshold), "" of "", length(fmi), "" chains had estimated Bayesian fraction "",
+      ""of missing information (E-BFMI) less than "", ebfmi_threshold, "", which may indicate poor exploration of the"", 
+      ""posterior.""))
     }
     if(return_ebfmi) {
       fmi",True,False,Implementation / Logic,6
stan-dev,cmdstanr,9d0f895a76e733c0bdc6c37c6b1fcfcbf0fc1bc5,Jacob Socolar,jacob.socolar@gmail.com,2021-05-20T19:00:19Z,Jacob Socolar,jacob.socolar@gmail.com,2021-05-20T19:00:19Z,better messages and error handling,R/utils.R,False,True,True,False,16,8,24,"---FILE: R/utils.R---
@@ -280,18 +280,26 @@ check_sampler_transitions_treedepth <- function(post_warmup_sampler_diagnostics,
   }
 }
 
-check_bfmi <- function(post_warmup_sampler_diagnostics) {
-  if (!is.null(post_warmup_sampler_diagnostics)) {
-    energy <- posterior::extract_variable_matrix(post_warmup_sampler_diagnostics, ""energy__"")
-    ebfmi <- apply(energy, 2, function(x) {
-      (sum(diff(x)^2)/length(x))/stats::var(x)
+check_ebfmi <- function(post_warmup_sampler_diagnostics, ebfmi_threshold = .3, return_ebfmi = F) {
+  pwsd <- posterior::as_draws_array(post_warmup_sampler_diagnostics)
+  if (! (""energy__"" %in% dimnames(pwsd)$variable)) {
+    warning(""e-bfmi not computed as the 'energy__' diagnostic could not be located"")
+  } else if (dim(pwsd)[1] <= 1) {
+    warning(""e-bfmi is undefined for posterior chains of length 1"")
+  } else {
+    energy <- posterior::extract_variable_matrix(pwsd, ""energy___"")
+    fmi <- apply(energy, 2, function(x) {
+      (sum(diff(x)^2) / length(x)) / stats::var(x)
     })
-    if (any(ebfmi < .3)) {
-      message(sum(ebfmi < .3), "" of "", length(ebfmi) , "" chains had estimated Bayesian fraction
+    if (any(fmi < ebfmi_threshold)) {
+      message(sum(fmi < ebfmi_threshold), "" of "", length(fmi) , "" chains had estimated Bayesian fraction
       of missing information(E-BFMI) less than 0.3, which may indicate poor exploration of the
-      posterior. Try to reparameterize the model."")
+      posterior. "")
     }
   }
+  if(return_ebfmi) {
+    fmi
+  }
 }
 
 ",True,False,Implementation / Logic,6
stan-dev,cmdstanr,86bdb33ae04bc5b724f2f1b57432b43bf05f827a,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-05-20T08:18:00Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-05-20T08:18:00Z,fix tests for errors that are now properly written to stderr,tests/testthat/test-failed-chains.R,False,True,True,False,4,8,12,"---FILE: tests/testthat/test-failed-chains.R---
@@ -159,7 +159,7 @@ test_that(""init warnings are shown"", {
 test_that(""optimize error on bad data"", {
   mod <- testing_model(""bernoulli"")
   suppressWarnings(
-    expect_output(
+    expect_message(
       mod$optimize(data = list(a = c(1,2,3)), seed = 123),
       ""Exception: variable does not exist""
     )
@@ -198,18 +198,14 @@ test_that(""gq chains error on wrong input CSV"", {
   mod <- testing_model(""bernoulli_ppc"")
   data_list <- testing_data(""bernoulli_ppc"")
   suppressWarnings(
-    expect_output(
+    expect_message(
       mod$generate_quantities(data = data_list, fitted_params = fit_logistic$output_files()),
       ""Mismatch between model and fitted_parameters csv""
     )
   )
-  if (cmdstan_version() < ""2.26"") {
-    err_msg <- ""Error reading fitted param names""
-  } else {
-    err_msg <- ""Mismatch between model and fitted_parameters csv file""
-  }
+  err_msg <- ""Mismatch between model and fitted_parameters csv file""
   suppressWarnings(
-    expect_output(
+    expect_message(
       mod$generate_quantities(data = data_list, fitted_params = test_path(""resources"", ""csv"", ""bernoulli-fail.csv"")),
       err_msg
     )",True,False,Implementation / Logic,3
stan-dev,cmdstanr,39f9a30a841c8317490349f1b6b4ca783d8067aa,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-05-20T08:06:25Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-05-20T08:06:25Z,fix tests for deprecated warning,tests/testthat/test-model-compile.R,False,True,True,False,2,2,4,"---FILE: tests/testthat/test-model-compile.R---
@@ -413,12 +413,12 @@ test_that(""check_syntax() works with pedantic=TRUE"", {
   mod_dep_warning <- cmdstan_model(stan_file, compile = FALSE)
   expect_message(
     mod_dep_warning$compile(),
-    ""Warning: deprecated language construct used in"",
+    ""deprecated in the Stan language"",
     fixed = TRUE
   )
   expect_message(
     mod_dep_warning$check_syntax(),
-    ""Warning: deprecated language construct used in"",
+    ""deprecated in the Stan language"",
     fixed = TRUE
   )
 })",True,False,Rendering / Conversion,3
stan-dev,cmdstanr,430d63130182967e0212e4be53163ee8f1b7c653,jgabry,jgabry@gmail.com,2021-05-17T01:11:51Z,jgabry,jgabry@gmail.com,2021-05-17T01:11:51Z,merge in master and fix conflict in utils.R,DESCRIPTION;NEWS.md;R/args.R;R/csv.R;R/data.R;R/example.R;R/fit.R;R/install.R;R/knitr.R;R/model.R;R/path.R;R/run.R;R/utils.R;R/zzz.R;man/cmdstan_default_path.Rd;man/install_cmdstan.Rd;man/set_cmdstan_path.Rd;man/write_stan_file.Rd;man/write_stan_tempfile.Rd;tests/testthat/test-csv.R;tests/testthat/test-example.R;tests/testthat/test-model-compile.R;tests/testthat/test-model-init.R;tests/testthat/test-utils.R,False,True,True,False,471,345,816,"---FILE: DESCRIPTION---
@@ -31,7 +31,8 @@ Imports:
     jsonlite (>= 1.2.0),
     posterior (>= 0.1.5),
     processx (>= 3.5.0),
-    R6 (>= 2.4.0)
+    R6 (>= 2.4.0),
+    rlang (>= 0.4.7)
 Suggests: 
     bayesplot,
     knitr,

---FILE: NEWS.md---
@@ -3,6 +3,10 @@
 * Expose CmdStan's `diagnose` method that compares Stan's gradient computations
 to gradients computed via finite differences. (#485)
 
+* `write_stan_file()` now choose file names deterministically based on the code
+so that models do not get unnecessarily recompiled when calling the function
+multiple times with the same code. (#495, @martinmodrak)
+
 # cmdstanr 0.4.0
 
 ### Bug fixes

---FILE: R/args.R---
@@ -48,7 +48,7 @@ CmdStanArgs <- R6::R6Class(
       self$save_latent_dynamics <- save_latent_dynamics
       self$validate_csv <- validate_csv
       self$using_tempdir <- is.null(output_dir)
-      if (getRversion() < '3.5.0') {
+      if (getRversion() < ""3.5.0"") {
         self$output_dir <- output_dir %||% tempdir()
       } else {
         self$output_dir <- output_dir %||% tempdir(check = TRUE)
@@ -90,7 +90,7 @@ CmdStanArgs <- R6::R6Class(
       if (type ==  ""output"" && !is.null(self$output_basename)) {
         basename <- self$output_basename
       }
-      generate_file_names( # defined in utils.R
+      generate_file_names(
         basename = basename,
         ext = "".csv"",
         ids = self$proc_ids,
@@ -508,7 +508,7 @@ DiagnoseArgs <- R6::R6Class(
 #' @noRd
 #' @param self A `CmdStanArgs` object.
 #' @return `TRUE` invisibly unless an error is thrown.
-validate_cmdstan_args = function(self) {
+validate_cmdstan_args <- function(self) {
   validate_exe_file(self$exe_file)
 
   checkmate::assert_directory_exists(self$output_dir, access = ""rw"")
@@ -755,7 +755,7 @@ validate_exe_file <- function(exe_file) {
   if (!length(exe_file) ||
       !nzchar(exe_file) ||
       !file.exists(exe_file)) {
-    stop('Model not compiled. Try running the compile() method first.',
+    stop(""Model not compiled. Try running the compile() method first."",
          call. = FALSE)
   }
   invisible(TRUE)
@@ -776,8 +776,13 @@ process_init_list <- function(init, num_procs) {
   if (any(sapply(init, function(x) length(x) == 0))) {
     stop(""'init' contains empty lists."", call. = FALSE)
   }
-  if (any(grepl(""\\["",names(unlist(init))))) {
-    stop(""'init' contains entries with parameter names that include square-brackets, which is not permitted. To supply inits for a vector, matrix or array of parameters, create a single entry with the parameter's name in the init list and specify init values for the entire parameter container."", call. = FALSE)
+  if (any(grepl(""\\["", names(unlist(init))))) {
+    stop(
+      ""'init' contains entries with parameter names that include square-brackets, which is not permitted. "",
+      ""To supply inits for a vector, matrix or array of parameters, "",
+      ""create a single entry with the parameter's name in the 'init' list "",
+      ""and specify initial values for the entire parameter container."",
+      call. = FALSE)
   }
   init_paths <-
     tempfile(

---FILE: R/csv.R---
@@ -210,7 +210,7 @@ read_cmdstan_csv <- function(files,
     selected_sampler_diag <- rep(FALSE, length(metadata$sampler_diagnostics))
     not_found <- NULL
     for (p in sampler_diagnostics) {
-      matches <- metadata$sampler_diagnostics == p | startsWith(metadata$sampler_diagnostics, paste0(p,"".""))
+      matches <- metadata$sampler_diagnostics == p | startsWith(metadata$sampler_diagnostics, paste0(p, "".""))
       if (!any(matches)) {
         not_found <- c(not_found, p)
       }
@@ -243,10 +243,10 @@ read_cmdstan_csv <- function(files,
       )
       if (metadata$method == ""sample"" && metadata$save_warmup == 1 && num_warmup_draws > 0) {
         warmup_sampler_diagnostics[[warmup_sd_id]] <-
-          post_warmup_sampler_diagnostics[[post_warmup_sd_id]][1:num_warmup_draws,,drop = FALSE]
+          post_warmup_sampler_diagnostics[[post_warmup_sd_id]][1:num_warmup_draws, , drop = FALSE]
         if (num_post_warmup_draws > 0) {
           post_warmup_sampler_diagnostics[[post_warmup_sd_id]] <-
-            post_warmup_sampler_diagnostics[[post_warmup_sd_id]][(num_warmup_draws+1):(num_warmup_draws + num_post_warmup_draws),,drop = FALSE]
+            post_warmup_sampler_diagnostics[[post_warmup_sd_id]][(num_warmup_draws + 1):(num_warmup_draws + num_post_warmup_draws), , drop = FALSE]
         } else {
           post_warmup_sampler_diagnostics[[post_warmup_sd_id]] <- NULL
         }
@@ -264,9 +264,9 @@ read_cmdstan_csv <- function(files,
       )
       if (metadata$method == ""sample"" && metadata$save_warmup == 1 && num_warmup_draws > 0) {
         warmup_draws[[warmup_draws_list_id]] <-
-          draws[[draws_list_id]][1:num_warmup_draws,,drop = FALSE]
+          draws[[draws_list_id]][1:num_warmup_draws, , drop = FALSE]
         if (num_post_warmup_draws > 0) {
-          draws[[draws_list_id]] <- draws[[draws_list_id]][(num_warmup_draws+1):(num_warmup_draws + num_post_warmup_draws),,drop = FALSE]
+          draws[[draws_list_id]] <- draws[[draws_list_id]][(num_warmup_draws + 1):(num_warmup_draws + num_post_warmup_draws), , drop = FALSE]
         } else {
           draws[[draws_list_id]] <- NULL
         }
@@ -342,7 +342,7 @@ read_cmdstan_csv <- function(files,
       format <- ""draws_matrix""
     }
     as_draws_format <- as_draws_format_fun(format)
-    variational_draws <- do.call(as_draws_format, list(draws[[1]][-1, colnames(draws[[1]]) != ""lp__"", drop=FALSE]))
+    variational_draws <- do.call(as_draws_format, list(draws[[1]][-1, colnames(draws[[1]]) != ""lp__"", drop = FALSE]))
     if (!is.null(variational_draws)) {
       if (""log_p__"" %in% posterior::variables(variational_draws)) {
         variational_draws <- posterior::rename_variables(variational_draws, lp__ = ""log_p__"")
@@ -361,7 +361,7 @@ read_cmdstan_csv <- function(files,
       format <- ""draws_matrix""
     }
     as_draws_format <- as_draws_format_fun(format)
-    point_estimates <- do.call(as_draws_format, list(draws[[1]][1,, drop=FALSE]))
+    point_estimates <- do.call(as_draws_format, list(draws[[1]][1, , drop = FALSE]))
     point_estimates <- posterior::subset_draws(point_estimates, variable = variables)
     if (!is.null(point_estimates)) {
       posterior::variables(point_estimates) <- repaired_variables
@@ -534,20 +534,16 @@ for (method in unavailable_methods_CmdStanFit_CSV) {
 #'
 read_csv_metadata <- function(csv_file) {
   checkmate::assert_file_exists(csv_file, access = ""r"", extension = ""csv"")
-  adaptation_terminated <- FALSE
-  param_names_read <- FALSE
   inv_metric_next <- FALSE
-  inv_metric_diagonal_next <- FALSE
   csv_file_info <- list()
   csv_file_info$inv_metric <- NULL
   inv_metric_rows_to_read <- -1
   inv_metric_rows <- -1
-  parsing_done <- FALSE
   dense_inv_metric <- FALSE
   diagnose_gradients <- FALSE
   gradients <- data.frame()
   warmup_time <- 0
-  sampling_time <-0
+  sampling_time <- 0
   total_time <- 0
   if (os_is_windows()) {
     grep_path <- repair_path(Sys.which(""grep.exe""))
@@ -562,7 +558,7 @@ read_csv_metadata <- function(csv_file) {
       stringsAsFactors = FALSE,
       fill = TRUE,
       sep = """",
-      header= FALSE
+      header = FALSE
     )
   )
   if (is.null(metadata) || length(metadata) == 0) {
@@ -604,7 +600,7 @@ read_csv_metadata <- function(csv_file) {
           inv_metric_next <- FALSE
         }
         parse_key_val <- FALSE
-      } else if(diagnose_gradients){
+      } else if (diagnose_gradients) {
         parse_key_val <- FALSE
         tmp <- gsub(""#"", """", line, fixed = TRUE)
         if (nzchar(tmp)) {
@@ -665,8 +661,8 @@ read_csv_metadata <- function(csv_file) {
   }
   if (inv_metric_rows > 0 && csv_file_info$metric == ""dense_e"") {
     rows <- inv_metric_rows
-    cols <- length(csv_file_info$inv_metric)/inv_metric_rows
-    dim(csv_file_info$inv_metric) <- c(rows,cols)
+    cols <- length(csv_file_info$inv_metric) / inv_metric_rows
+    dim(csv_file_info$inv_metric) <- c(rows, cols)
   }
 
   # rename from old cmdstan names to new cmdstanX names
@@ -723,7 +719,7 @@ check_csv_metadata_matches <- function(csv_metadata) {
   if (!all(method == method[1])) {
     stop(""Supplied CSV files were produced by different methods and need to be read in separately!"", call. = FALSE)
   }
-  for(i in 2:length(csv_metadata)) {
+  for (i in 2:length(csv_metadata)) {
     if (length(csv_metadata[[1]]$model_params) != length(csv_metadata[[i]]$model_params) ||
       !all(csv_metadata[[1]]$model_params == csv_metadata[[i]]$model_params)) {
       stop(""Supplied CSV files have samples for different variables!"", call. = FALSE)
@@ -736,7 +732,7 @@ check_csv_metadata_matches <- function(csv_metadata) {
     iter_warmup <- sapply(csv_metadata, function(x) x$iter_warmup)
     if (!all(iter_sampling == iter_sampling[1]) ||
         !all(thin == thin[1]) ||
-        !all(save_warmup == save_warmup[1])||
+        !all(save_warmup == save_warmup[1]) ||
         (save_warmup[1] == 1 && !all(iter_warmup == iter_warmup[1]))) {
       stop(""Supplied CSV files do not match in the number of output samples!"", call. = FALSE)
     }
@@ -782,8 +778,8 @@ repair_variable_names <- function(names) {
 # convert names like beta[1,1] to beta.1.1
 unrepair_variable_names <- function(names) {
   names <- sub(""\\["", ""\\."", names)
-  names <- gsub("","",""\\."",  names)
-  names <- gsub(""\\]"","""",  names)
+  names <- gsub("","", ""\\."",  names)
+  names <- gsub(""\\]"", """",  names)
   names
 }
 
@@ -806,7 +802,7 @@ remaining_columns_to_read <- function(requested, currently_read, all) {
       if (any(all_remaining == p)) {
         unread <- c(unread, p)
       }
-      is_unread_element <- startsWith(all_remaining, paste0(p,""[""))
+      is_unread_element <- startsWith(all_remaining, paste0(p, ""[""))
       if (any(is_unread_element)) {
         unread <- c(unread, all_remaining[is_unread_element])
       }
@@ -818,3 +814,36 @@ remaining_columns_to_read <- function(requested, currently_read, all) {
     """"
   }
 }
+
+#' Returns a list of dimensions for the input variables.
+#'
+#' @noRd
+#' @param variable_names A character vector of variable names including all
+#'   individual elements (e.g., `c(""beta[1]"", ""beta[2]"")`, not just `""beta""`).
+#' @return A list giving the dimensions of the variables. The equivalent of the
+#'   `par_dims` slot of RStan's stanfit objects, except that scalars have
+#'   dimension `1` instead of `0`.
+#' @note For this function to return the correct dimensions the input must be
+#'   already sorted in ascending order. Since CmdStan always has the variables
+#'   sorted correctly we avoid a sort by not sorting again here.
+#'
+variable_dims <- function(variable_names = NULL) {
+  if (is.null(variable_names)) {
+    return(NULL)
+  }
+  dims <- list()
+  uniq_variable_names <- unique(gsub(""\\[.*\\]"", """", variable_names))
+  var_names <- gsub(""\\]"", """", variable_names)
+  for (var in uniq_variable_names) {
+    pattern <- paste0(""^"", var, ""\\["")
+    var_indices <- var_names[grep(pattern, var_names)]
+    var_indices <- gsub(pattern, """", var_indices)
+    if (length(var_indices)) {
+      var_indices <- strsplit(var_indices[length(var_indices)], "","")[[1]]
+      dims[[var]] <- as.numeric(var_indices)
+    } else {
+      dims[[var]] <- 1
+    }
+  }
+  dims
+}

---FILE: R/data.R---
@@ -30,7 +30,7 @@ write_stan_json <- function(data, file) {
     }
 
     if (is.logical(var)) {
-      mode(var) <- ""integer"" # convert TRUE/FALSE to 1/0
+      mode(var) <- ""integer""
     } else if (is.data.frame(var)) {
       var <- data.matrix(var)
     } else if (is.list(var)) {
@@ -40,7 +40,6 @@ write_stan_json <- function(data, file) {
   }
 
   # unboxing variables (N = 10 is stored as N : 10, not N: [10])
-  # handling factors as integers
   jsonlite::write_json(
     data,
     path = file,
@@ -66,7 +65,7 @@ list_to_array <- function(x, name = NULL) {
   }
   all_numeric <- all(sapply(x, function(a) is.numeric(a)))
   if (!all_numeric) {
-    stop(""All elements in list '"", name,""' must be numeric!"", call. = FALSE)
+    stop(""All elements in list '"", name, ""' must be numeric!"", call. = FALSE)
   }
   element_num_of_dim <- length(all_dims[[1]])
   x <- unlist(x)
@@ -111,9 +110,7 @@ process_data <- function(data) {
 
 # check if any objects in the data list have zero as one of their dimensions
 any_zero_dims <- function(data) {
-  has_zero_dims <- sapply(data, function(x) {
-    any(dim(x) == 0)
-  })
+  has_zero_dims <- sapply(data, function(x) any(dim(x) == 0))
   any(has_zero_dims)
 }
 
@@ -153,7 +150,11 @@ draws_to_csv <- function(draws, sampler_diagnostics = NULL) {
   } else { # create a dummy lp__ if it does not exist
     lp__ <- posterior::draws_array(lp__ = zeros, .nchains = n_chains)
   }
-  all_variables <- c(""lp__"", posterior::variables(sampler_diagnostics), draws_variables[!(draws_variables %in% c(""lp__"", ""lp_approx__""))])
+  all_variables <- c(
+    ""lp__"",
+    posterior::variables(sampler_diagnostics),
+    draws_variables[!(draws_variables %in% c(""lp__"", ""lp_approx__""))]
+  )
   draws <- posterior::subset_draws(
     posterior::bind_draws(draws, sampler_diagnostics, lp__, along = ""variable""),
     variable = all_variables
@@ -192,31 +193,34 @@ draws_to_csv <- function(draws, sampler_diagnostics = NULL) {
 process_fitted_params <- function(fitted_params) {
   if (is.character(fitted_params)) {
     paths <- absolute_path(fitted_params)
-  } else if (checkmate::test_r6(fitted_params, classes = ""CmdStanMCMC"") &&
-              all(file.exists(fitted_params$output_files()))) {
+  } else if (checkmate::test_r6(fitted_params, ""CmdStanMCMC"") &&
+             all(file.exists(fitted_params$output_files()))) {
       paths <- absolute_path(fitted_params$output_files())
-  } else if(checkmate::test_r6(fitted_params, classes = c(""CmdStanMCMC""))) {
-    draws <- tryCatch(fitted_params$draws(),
-      error=function(cond) {
-          stop(""Unable to obtain draws from the fit object."", call. = FALSE)
+  } else if (checkmate::test_r6(fitted_params, ""CmdStanMCMC"")) {
+    draws <- tryCatch(
+      fitted_params$draws(),
+      error = function(cond) {
+        stop(""Unable to obtain draws from the fit object."", call. = FALSE)
       }
     )
-    sampler_diagnostics <- tryCatch(fitted_params$sampler_diagnostics(),
-      error=function(cond) {
-          NULL
+    sampler_diagnostics <- tryCatch(
+      fitted_params$sampler_diagnostics(),
+      error = function(cond) {
+        NULL
       }
     )
     paths <- draws_to_csv(draws, sampler_diagnostics)
-  } else if(checkmate::test_r6(fitted_params, classes = c(""CmdStanVB""))) {
-    draws <- tryCatch(fitted_params$draws(),
-      error=function(cond) {
-          stop(""Unable to obtain draws from the fit object."", call. = FALSE)
+  } else if (checkmate::test_r6(fitted_params, ""CmdStanVB"")) {
+    draws <- tryCatch(
+      fitted_params$draws(),
+      error = function(cond) {
+        stop(""Unable to obtain draws from the fit object."", call. = FALSE)
       }
     )
     paths <- draws_to_csv(posterior::as_draws_array(draws))
-  } else if (any(class(fitted_params) == ""draws_array"")){
+  } else if (any(class(fitted_params) == ""draws_array"")) {
     paths <- draws_to_csv(fitted_params)
-  } else if (any(class(fitted_params) == ""draws_matrix"")){
+  } else if (any(class(fitted_params) == ""draws_matrix"")) {
     paths <- draws_to_csv(posterior::as_draws_array(fitted_params))
   } else {
     stop(

---FILE: R/example.R---
@@ -91,18 +91,29 @@ print_example_program <-
 #' Write Stan code to a file
 #'
 #' Convenience function for writing Stan code to a (possibly
-#' [temporary][base::tempfile]) file with a `.stan` extension.
+#' [temporary][base::tempfile]) file with a `.stan` extension. By default, the
+#' file name is chosen deterministically based on a [hash][rlang::hash()]
+#' of the Stan code, and the file is not overwritten if it already has correct
+#' contents. This means that calling this function multiple times with the same
+#' Stan code will reuse the compiled model. This also however means that the
+#' function is potentially not thread-safe. Using `hash_salt = Sys.getpid()`
+#' should ensure thread-safety in the rare cases when it is needed.
 #'
 #' @export
-#' @param code (multiple options) The Stan code:
-#'   * A single string containing a Stan program
-#'   * A character vector containing the individual lines of a Stan program.
+#' @param code (character vector) The Stan code to write to the file. This can
+#'   be a character vector of length one (a string) containing the entire Stan
+#'   program or a character vector with each element containing one line of the
+#'   Stan program.
 #' @param dir (string) An optional path to the directory where the file will be
 #'   written. If omitted, a [temporary directory][base::tempdir] is used by
 #'   default.
 #' @param basename (string) If `dir` is specified, optionally the basename to
-#'   use for the file created. If not specified a file name is generated via
-#'   [base::tempfile()].
+#'   use for the file created. If not specified a file name is generated
+#'   from [hashing][rlang::hash()] the code.
+#' @param force_overwrite (logical) If set to `TRUE` the file will always be
+#'   overwritten and thus the resulting model will always be recompiled.
+#' @param hash_salt (string) Text to add to the model code prior to hashing to
+#'   determine the file name if `basename` is not set.
 #' @return The path to the file.
 #'
 #' @examples
@@ -131,19 +142,39 @@ print_example_program <-
 #' f2 <- write_stan_file(lines)
 #' identical(readLines(f), readLines(f2))
 #'
-write_stan_file <- function(code, dir = tempdir(), basename = NULL) {
+write_stan_file <- function(code, dir = tempdir(), basename = NULL,
+                            force_overwrite = FALSE, hash_salt = """") {
   if (!dir.exists(dir)) {
     dir.create(dir, recursive = TRUE)
   }
+  collapsed_code <- paste0(code, collapse = ""\n"")
+
   if (!is.null(basename)) {
     if (!endsWith(basename, "".stan"")) {
       basename <- paste0(basename, "".stan"")
     }
     file <- file.path(dir, basename)
   } else {
-    file <- tempfile(fileext = "".stan"", tmpdir = dir)
+    hash <- rlang::hash(paste0(hash_salt, collapsed_code))
+    file <- file.path(dir, paste0(""model_"", hash, "".stan""))
+  }
+  overwrite <- TRUE
+  # Do not overwrite file if it has the correct contents (to avoid recompilation)
+  if (!force_overwrite && file.exists(file)) {
+    tryCatch({
+      file_contents <- paste0(readLines(file), collapse = ""\n"")
+      if (gsub(""\r|\n"", ""\n"", file_contents) == gsub(""\r|\n"", ""\n"", collapsed_code)) {
+        overwrite <- FALSE
+      }
+    },
+    error = function(e) {
+      warning(""Error when checking old file contents"", e)
+    })
+  }
+
+  if (overwrite) {
+    cat(code, file = file, sep = ""\n"")
   }
-  cat(code, file = file, sep = ""\n"")
   file
 }
 
@@ -159,4 +190,3 @@ write_stan_tempfile <- function(code, dir = tempdir()) {
           call. = FALSE)
   write_stan_file(code, dir)
 }
-

---FILE: R/fit.R---
@@ -638,7 +638,7 @@ CmdStanFit$set(""public"", name = ""time"", value = time)
 output <- function(id = NULL) {
   # MCMC has separate implementation but doc is shared
   # Non-MCMC fit is obtained with one process only so id is ignored
-  cat(paste(self$runset$procs$proc_output(1), collapse=""\n""))
+  cat(paste(self$runset$procs$proc_output(1), collapse = ""\n""))
 }
 CmdStanFit$set(""public"", name = ""output"", value = output)
 
@@ -843,7 +843,7 @@ CmdStanMCMC <- R6::R6Class(
       if (is.null(id)) {
         self$runset$procs$proc_output()
       } else {
-        cat(paste(self$runset$procs$proc_output(id), collapse=""\n""))
+        cat(paste(self$runset$procs$proc_output(id), collapse = ""\n""))
       }
     },
 
@@ -877,7 +877,7 @@ CmdStanMCMC <- R6::R6Class(
         variables <- matching_res$matching
       }
       if (inc_warmup) {
-        posterior::subset_draws(posterior::bind_draws(private$warmup_draws_, private$draws_, along=""iteration""), variable = variables)
+        posterior::subset_draws(posterior::bind_draws(private$warmup_draws_, private$draws_, along = ""iteration""), variable = variables)
       } else {
         posterior::subset_draws(private$draws_, variable = variables)
       }
@@ -910,7 +910,7 @@ CmdStanMCMC <- R6::R6Class(
           private$draws_ <- posterior::bind_draws(
             private$draws_,
             posterior::subset_draws(csv_contents$post_warmup_draws, variable = missing_variables),
-            along=""variable""
+            along = ""variable""
           )
         }
       }
@@ -923,7 +923,7 @@ CmdStanMCMC <- R6::R6Class(
           private$sampler_diagnostics_ <- posterior::bind_draws(
             private$sampler_diagnostics_,
             posterior::subset_draws(csv_contents$post_warmup_sampler_diagnostics, variable = missing_variables),
-            along=""variable""
+            along = ""variable""
           )
         }
       }
@@ -937,7 +937,7 @@ CmdStanMCMC <- R6::R6Class(
             private$warmup_draws_ <- posterior::bind_draws(
               private$warmup_draws_,
               posterior::subset_draws(csv_contents$warmup_draws, variable = missing_variables),
-              along=""variable""
+              along = ""variable""
             )
           }
         }
@@ -949,7 +949,7 @@ CmdStanMCMC <- R6::R6Class(
             private$warmup_sampler_diagnostics_ <- posterior::bind_draws(
               private$warmup_sampler_diagnostics_,
               posterior::subset_draws(csv_contents$warmup_sampler_diagnostics, variable = missing_variables),
-              along=""variable""
+              along = ""variable""
             )
           }
         }
@@ -1069,7 +1069,7 @@ sampler_diagnostics <- function(inc_warmup = FALSE, format = getOption(""cmdstanr
     posterior::bind_draws(
       private$warmup_sampler_diagnostics_,
       private$sampler_diagnostics_,
-      along=""iteration""
+      along = ""iteration""
     )
   } else {
     private$sampler_diagnostics_
@@ -1134,7 +1134,7 @@ CmdStanMCMC$set(""public"", name = ""inv_metric"", value = inv_metric)
 #' fit_mcmc$num_chains()
 #' }
 #'
-num_chains = function() {
+num_chains <- function() {
   super$num_procs()
 }
 CmdStanMCMC$set(""public"", name = ""num_chains"", value = num_chains)
@@ -1403,7 +1403,7 @@ CmdStanGQ <- R6::R6Class(
       if (is.null(id)) {
         self$runset$procs$proc_output()
       } else {
-        cat(paste(self$runset$procs$proc_output(id), collapse=""\n""))
+        cat(paste(self$runset$procs$proc_output(id), collapse = ""\n""))
       }
     }
   ),
@@ -1426,7 +1426,7 @@ CmdStanGQ <- R6::R6Class(
           posterior::bind_draws(
             private$draws_,
             posterior::subset_draws(csv_contents$generated_quantities, variable = missing_variables),
-            along=""variable""
+            along = ""variable""
           )
       }
       invisible(self)

---FILE: R/install.R---
@@ -18,6 +18,11 @@
 #'   switches, changing the C++ compiler, etc. A change to the `make/local` file
 #'   should typically be followed by calling `rebuild_cmdstan()`.
 #'
+#'   The `check_cmdstan_toolchain()` function attempts to check for the required
+#'   C++ toolchain. It is called internally by `install_cmdstan()` but can also
+#'   be called directly by the user.
+#'
+#'
 #' @export
 #' @param dir (string) The path to the directory in which to install CmdStan.
 #'   The default is to install it in a directory called `.cmdstanr` within the
@@ -105,8 +110,8 @@ install_cmdstan <- function(dir = NULL,
     message(""* Installing CmdStan from "", release_url)
     download_url <- release_url
     split_url <- strsplit(release_url, ""/"")
-    tar_name <- utils::tail(split_url[[1]], n=1)
-    cmdstan_ver <- substr(tar_name, 0, nchar(tar_name)-7)
+    tar_name <- utils::tail(split_url[[1]], n = 1)
+    cmdstan_ver <- substr(tar_name, 0, nchar(tar_name) - 7)
     tar_gz_file <- paste0(cmdstan_ver, "".tar.gz"")
     dir_cmdstan <- file.path(dir, cmdstan_ver)
     dest_file <- file.path(dir, tar_gz_file)
@@ -165,7 +170,7 @@ install_cmdstan <- function(dir = NULL,
     cmdstan_make_local(
       dir = dir_cmdstan,
       cpp_options = list(
-        CXX=""arch -arch arm64e clang++""
+        CXX = ""arch -arch arm64e clang++""
       ),
       append = TRUE
     )
@@ -212,18 +217,18 @@ cmdstan_make_local <- function(dir = cmdstan_path(),
                                append = TRUE) {
   make_local_path <- file.path(dir, ""make"", ""local"")
   if (!is.null(cpp_options)) {
-    built_flags = c()
+    built_flags <- c()
     for (i in seq_len(length(cpp_options))) {
       option_name <- names(cpp_options)[i]
       if (isTRUE(as.logical(cpp_options[[i]]))) {
-        built_flags = c(built_flags, paste0(option_name, ""=true""))
+        built_flags <- c(built_flags, paste0(option_name, ""=true""))
       } else if (isFALSE(as.logical(cpp_options[[i]]))) {
-        built_flags = c(built_flags, paste0(option_name, ""=false""))
+        built_flags <- c(built_flags, paste0(option_name, ""=false""))
       } else {
         if (is.null(option_name) || !nzchar(option_name)) {
-          built_flags = c(built_flags, paste0(cpp_options[[i]]))
+          built_flags <- c(built_flags, paste0(cpp_options[[i]]))
         } else {
-          built_flags = c(built_flags, paste0(option_name, ""="", cpp_options[[i]]))
+          built_flags <- c(built_flags, paste0(option_name, ""="", cpp_options[[i]]))
         }
       }
     }
@@ -236,6 +241,34 @@ cmdstan_make_local <- function(dir = cmdstan_path(),
   }
 }
 
+#' @rdname install_cmdstan
+#' @export
+#' @param fix For `check_cmdstan_toolchain()`, should CmdStanR attempt to fix
+#'   any detected toolchain problems? Currently this option is only available on
+#'   Windows. The default is `FALSE`, in which case problems are only reported
+#'   along with suggested fixes.
+#'
+check_cmdstan_toolchain <- function(fix = FALSE, quiet = FALSE) {
+  if (os_is_windows()) {
+    if (R.version$major >= ""4"") {
+      check_rtools40_windows_toolchain(fix = fix, quiet = quiet)
+    } else {
+      check_rtools35_windows_toolchain(fix = fix, quiet = quiet)
+    }
+  } else {
+    check_unix_make()
+    check_unix_cpp_compiler()
+  }
+  if (!checkmate::test_directory(dirname(tempdir()), access = ""w"")) {
+    stop(""No write permissions to the temporary folder! Please change the permissions or location of the temporary folder."", call. = FALSE)
+  }
+  if (!quiet) {
+    message(""The C++ toolchain required for CmdStan is setup properly!"")
+  }
+  invisible(NULL)
+}
+
+
 # internal ----------------------------------------------------------------
 
 check_install_dir <- function(dir_cmdstan, overwrite = FALSE) {
@@ -320,8 +353,8 @@ build_cmdstan <- function(dir,
                           timeout) {
   translation_args <- NULL
   if (is_rosetta2()) {
-    run_cmd <- '/usr/bin/arch'
-    translation_args <- c('-arch', 'arm64e', 'make')
+    run_cmd <- ""/usr/bin/arch""
+    translation_args <- c(""-arch"", ""arm64e"", ""make"")
   } else {
     run_cmd <- make_cmd()
   }
@@ -333,7 +366,7 @@ build_cmdstan <- function(dir,
     echo = !quiet || is_verbose_mode(),
     spinner = quiet,
     error_on_status = FALSE,
-    stderr_line_callback = function(x,p) { if (quiet) message(x) },
+    stderr_line_callback = function(x, p) { if (quiet) message(x) },
     timeout = timeout
   )
 }
@@ -379,7 +412,7 @@ clean_cmdstan <- function(dir = cmdstan_path(),
     echo = !quiet || is_verbose_mode(),
     spinner = quiet,
     error_on_status = FALSE,
-    stderr_line_callback = function(x,p) { if (quiet) message(x) }
+    stderr_line_callback = function(x, p) { if (quiet) message(x) }
   )
   clean_compile_helper_files()
 }
@@ -393,7 +426,7 @@ build_example <- function(dir, cores, quiet, timeout) {
     echo = !quiet || is_verbose_mode(),
     spinner = quiet,
     error_on_status = FALSE,
-    stderr_line_callback = function(x,p) { if (quiet) message(x) },
+    stderr_line_callback = function(x, p) { if (quiet) message(x) },
     timeout = timeout
   )
 }
@@ -443,15 +476,15 @@ install_mingw32_make <- function(quiet = FALSE) {
   if (!quiet) message(""Installing mingw32-make and writing RTools path to ~/.Renviron ..."")
   processx::run(
     ""pacman"",
-    args = c(""-Syu"", ""mingw-w64-x86_64-make"",""--noconfirm""),
+    args = c(""-Syu"", ""mingw-w64-x86_64-make"", ""--noconfirm""),
     wd = rtools_usr_bin,
     error_on_status = TRUE,
     echo_cmd = is_verbose_mode(),
     echo = is_verbose_mode()
   )
   write('PATH=""${RTOOLS40_HOME}\\usr\\bin;${RTOOLS40_HOME}\\mingw64\\bin;${PATH}""', file = ""~/.Renviron"", append = TRUE)
   Sys.setenv(PATH = paste0(Sys.getenv(""RTOOLS40_HOME""), ""\\usr\\bin;"", Sys.getenv(""RTOOLS40_HOME""), ""\\mingw64\\bin;"", Sys.getenv(""PATH"")))
-	invisible(NULL)
+  invisible(NULL)
 }
 
 check_rtools40_windows_toolchain <- function(fix = FALSE, quiet = FALSE) {
@@ -487,7 +520,7 @@ check_rtools40_windows_toolchain <- function(fix = FALSE, quiet = FALSE) {
     } else {
       install_mingw32_make(quiet = quiet)
       check_rtools40_windows_toolchain(fix = FALSE, quiet = quiet)
-	    return(invisible(NULL))
+      return(invisible(NULL))
     }
   }
   # Check if the mingw32-make and g++ get picked up by default are the RTools-supplied ones
@@ -509,7 +542,9 @@ check_rtools40_windows_toolchain <- function(fix = FALSE, quiet = FALSE) {
 check_rtools35_windows_toolchain <- function(fix = FALSE,
                                              quiet = FALSE,
                                              paths = NULL) {
-  if (is.null(paths)) paths <- c( file.path(""C:/"", ""Rtools""), file.path(""C:/"", ""Rtools35""))
+  if (is.null(paths)) {
+    paths <- c(file.path(""C:/"", ""Rtools""), file.path(""C:/"", ""Rtools35""))
+  }
   mingw32_make_path <- dirname(Sys.which(""mingw32-make""))
   gpp_path <- dirname(Sys.which(""g++""))
   # If mingw32-make and g++ are not found, we check typical RTools 3.5 folders.
@@ -546,13 +581,13 @@ check_rtools35_windows_toolchain <- function(fix = FALSE,
         message(""Writing RTools path to ~/.Renviron ..."")
       }
       if (!nzchar(Sys.getenv(""RTOOLS35_HOME""))) {
-        write(paste0('RTOOLS35_HOME=', rtools_path), file = ""~/.Renviron"", append = TRUE)
-		    Sys.setenv(RTOOLS35_HOME = rtools_path)
+        write(paste0(""RTOOLS35_HOME="", rtools_path), file = ""~/.Renviron"", append = TRUE)
+        Sys.setenv(RTOOLS35_HOME = rtools_path)
       }
       write('PATH=""${RTOOLS35_HOME}\\bin;${RTOOLS35_HOME}\\mingw_64\\bin;${PATH}""', file = ""~/.Renviron"", append = TRUE)
-	    Sys.setenv(PATH = paste0(Sys.getenv(""RTOOLS35_HOME""), ""\\mingw_64\\bin;"", Sys.getenv(""PATH"")))
+      Sys.setenv(PATH = paste0(Sys.getenv(""RTOOLS35_HOME""), ""\\mingw_64\\bin;"", Sys.getenv(""PATH"")))
       check_rtools35_windows_toolchain(fix = FALSE, quiet = quiet)
-	    return(invisible(NULL))
+      return(invisible(NULL))
     } else {
       stop(
         ""\nA toolchain was not found. Please install RTools 3.5 and run"",
@@ -570,9 +605,19 @@ check_unix_make <- function() {
   make_path <- dirname(Sys.which(""make""))
   if (!nzchar(make_path)) {
     if (os_is_macos()) {
-      stop(""The 'make' tool was not found. Please install the command line tools for Mac with 'xcode-select --install' or install Xcode from the app store. Then restart R and run check_cmdstan_toolchain()."", call. = FALSE)
+      stop(
+        ""The 'make' tool was not found. "",
+        ""Please install the command line tools for Mac with 'xcode-select --install' "",
+        ""or install Xcode from the app store. "",
+        ""Then restart R and run check_cmdstan_toolchain()."",
+        call. = FALSE
+      )
     } else {
-      stop(""The 'make' tool was not found. Please install 'make', restart R, and then run check_cmdstan_toolchain()."", call. = FALSE)
+      stop(
+        ""The 'make' tool was not found. "",
+        ""Please install 'make', restart R, and then run check_cmdstan_toolchain()."",
+        call. = FALSE
+      )
     }
 
   }
@@ -583,36 +628,20 @@ check_unix_cpp_compiler <- function() {
   clang_path <- dirname(Sys.which(""clang++""))
   if (!nzchar(gpp_path) && !nzchar(clang_path)) {
     if (os_is_macos()) {
-      stop(""A suitable C++ compiler was not found. Please install the command line tools for Mac with 'xcode-select --install' or install Xcode from the app store. Then restart R and run check_cmdstan_toolchain()."", call. = FALSE)
-    } else {
-      stop(""A C++ compiler was not found. Please install the 'clang++' or 'g++' compiler, restart R, and run check_cmdstan_toolchain()."", call. = FALSE)
-    }
-  }
-}
-
-#' @rdname install_cmdstan
-#' @export
-#' @param fix For `check_cmdstan_toolchain()`, should CmdStanR attempt to fix
-#'   any detected toolchain problems? Currently this option is only available on
-#'   Windows. The default is `FALSE`, in which case problems are only reported
-#'   along with suggested fixes.
-#'
-check_cmdstan_toolchain <- function(fix = FALSE, quiet = FALSE) {
-  if (os_is_windows()) {
-    if (R.version$major >= ""4"") {
-      check_rtools40_windows_toolchain(fix = fix, quiet = quiet)
+      stop(
+        ""A suitable C++ compiler was not found. "",
+        ""Please install the command line tools for Mac with 'xcode-select --install' "",
+        ""or install Xcode from the app store. "",
+        ""Then restart R and run check_cmdstan_toolchain()."",
+        call. = FALSE
+      )
     } else {
-      check_rtools35_windows_toolchain(fix = fix, quiet = quiet)
+      stop(
+        ""A C++ compiler was not found. "",
+        ""Please install the 'clang++' or 'g++' compiler, restart R, "",
+        ""and run check_cmdstan_toolchain()."",
+        call. = FALSE
+      )
     }
-  } else {
-    check_unix_make()
-    check_unix_cpp_compiler()
-  }
-  if (!checkmate::test_directory(dirname(tempdir()), access = ""w"")) {
-    stop(""No write permissions to the temporary folder! Please change the permissions or location of the temporary folder."", call. = FALSE)
   }
-  if (!quiet) {
-    message(""The C++ toolchain required for CmdStan is setup properly!"")
-  }
-  invisible(NULL)
 }

---FILE: R/knitr.R---
@@ -90,4 +90,3 @@ eng_cmdstan <- function(options) {
   code <- paste(options$code, collapse = ""\n"")
   knitr::engine_output(options, code, '')
 }
-

---FILE: R/model.R---
@@ -199,14 +199,13 @@ CmdStanModel <- R6::R6Class(
   ),
   public = list(
     initialize = function(stan_file, compile, ...) {
+      args <- list(...)
       checkmate::assert_file_exists(stan_file, access = ""r"", extension = ""stan"")
       checkmate::assert_flag(compile)
       private$stan_file_ <- absolute_path(stan_file)
       private$model_name_ <- sub("" "", ""_"", strip_ext(basename(private$stan_file_)))
-      args <- list(...)
-      check_stanc_options(args$stanc_options)
       private$precompile_cpp_options_ <- args$cpp_options %||% list()
-      private$precompile_stanc_options_ <- args$stanc_options %||% list()
+      private$precompile_stanc_options_ <- assert_valid_stanc_options(args$stanc_options) %||% list()
       private$precompile_include_paths_ <- args$include_paths
       private$dir_ <- args$dir
 
@@ -368,7 +367,7 @@ compile <- function(quiet = TRUE,
   if (length(stanc_options) == 0 && !is.null(private$precompile_stanc_options_)) {
     stanc_options <- private$precompile_stanc_options_
   }
-  check_stanc_options(stanc_options)
+  stanc_options <- assert_valid_stanc_options(stanc_options)
   if (is.null(include_paths) && !is.null(private$precompile_include_paths_)) {
     include_paths <- private$precompile_include_paths_
   }
@@ -502,7 +501,7 @@ compile <- function(quiet = TRUE,
     echo = !quiet || is_verbose_mode(),
     echo_cmd = is_verbose_mode(),
     spinner = quiet && interactive(),
-    stderr_line_callback = function(x,p) {
+    stderr_line_callback = function(x, p) {
       if (!startsWith(x, paste0(make_cmd(), "": *** No rule to make target""))) {
         message(x)
       }
@@ -622,7 +621,7 @@ check_syntax <- function(pedantic = FALSE,
   if (is.null(stanc_options[[""name""]])) {
     stanc_options[[""name""]] <- paste0(self$model_name(), ""_model"")
   }
-  stanc_built_options = c()
+  stanc_built_options <- c()
   for (i in seq_len(length(stanc_options))) {
     option_name <- names(stanc_options)[i]
     if (isTRUE(as.logical(stanc_options[[i]]))) {
@@ -641,10 +640,10 @@ check_syntax <- function(pedantic = FALSE,
     echo = is_verbose_mode(),
     echo_cmd = is_verbose_mode(),
     spinner = quiet && interactive(),
-    stdout_line_callback = function(x,p) {
+    stdout_line_callback = function(x, p) {
       if (!quiet) cat(x)
     },
-    stderr_line_callback = function(x,p) {
+    stderr_line_callback = function(x, p) {
       message(x)
     },
     error_on_status = FALSE
@@ -1353,3 +1352,38 @@ assert_valid_threads <- function(threads, cpp_options, multiple_chains = FALSE)
   invisible(threads)
 }
 
+assert_valid_stanc_options <- function(stanc_options) {
+  i <- 1
+  names <- names(stanc_options)
+  for (s in stanc_options) {
+    if (!is.null(names[i]) && nzchar(names[i])) {
+      name <- names[i]
+    } else {
+      name <- s
+    }
+    if (startsWith(name, ""--"")) {
+      stop(""No leading hyphens allowed in stanc options ("", name, ""). "",
+           ""Use options without leading hyphens, for example "",
+           ""`stanc_options = list('allow-undefined')`"",
+           call. = FALSE)
+    }
+    i <- i + 1
+  }
+  invisible(stanc_options)
+}
+
+cpp_options_to_compile_flags <- function(cpp_options) {
+  if (length(cpp_options) == 0) {
+    return(NULL)
+  }
+  cpp_built_options <- c()
+  for (i in seq_along(cpp_options)) {
+    option_name <- names(cpp_options)[i]
+    if (is.null(option_name) || !nzchar(option_name)) {
+      cpp_built_options <- c(cpp_built_options, toupper(cpp_options[[i]]))
+    } else {
+      cpp_built_options <- c(cpp_built_options, paste0(toupper(option_name), ""="", cpp_options[[i]]))
+    }
+  }
+  cpp_built_options
+}

---FILE: R/path.R---
@@ -22,8 +22,8 @@
 #' * If the [environment variable][Sys.setenv()] `""CMDSTAN""` exists at load time
 #' then its value will be automatically set as the default path to CmdStan for
 #' the \R session.
-#' * If no environment variable is found when loaded but any directory in the form
-#' `"".cmdstanr/cmdstan-[version]""`, for example `"".cmdstanr/cmdstan-2.23.0""`,
+#' * If no environment variable is found when loaded but any directory in the
+#' form `"".cmdstanr/cmdstan-[version]""` (e.g., `"".cmdstanr/cmdstan-2.23.0""`),
 #' exists in the user's home directory (`Sys.getenv(""HOME"")`, *not* the current
 #' working directory) then the path to the cmdstan with the largest version
 #' number will be set as the path to CmdStan for the \R session. This is the
@@ -108,37 +108,38 @@ cmdstan_default_install_path <- function() {
 
 #' cmdstan_default_path
 #'
-#' Returns the path to the installation of cmdstan with the most recent release version.
+#' Returns the path to the installation of CmdStan with the most recent release
+#' version.
 #'
-#' @keywords internal
-#' @return Path to the cmdstan installation with the most recent release version, NULL if no
-#' installation found.
 #' @export
+#' @keywords internal
+#' @return Path to the CmdStan installation with the most recent release
+#'   version, or `NULL` if no installation found.
+#'
 cmdstan_default_path <- function() {
-  installs_path <- file.path(Sys.getenv(""HOME""), "".cmdstanr"")
+  installs_path <- cmdstan_default_install_path()
   if (dir.exists(installs_path)) {
     cmdstan_installs <- list.dirs(path = installs_path, recursive = FALSE, full.names = FALSE)
-    # if installed in folder cmdstan, with no version
-    # move to cmdstan-version folder
+    # if installed in cmdstan folder with no version move to cmdstan-version folder
     if (""cmdstan"" %in% cmdstan_installs) {
       ver <- read_cmdstan_version(file.path(installs_path, ""cmdstan""))
       old_path <- file.path(installs_path, ""cmdstan"")
-      new_path <- file.path(installs_path, paste0(""cmdstan-"",ver))
+      new_path <- file.path(installs_path, paste0(""cmdstan-"", ver))
       file.rename(old_path, new_path)
       cmdstan_installs <- list.dirs(path = installs_path, recursive = FALSE, full.names = FALSE)
     }
     if (length(cmdstan_installs) > 0) {
       latest_cmdstan <- sort(cmdstan_installs, decreasing = TRUE)[1]
       if (is_release_candidate(latest_cmdstan)) {
         non_rc_path <- strsplit(latest_cmdstan, ""-rc"")[[1]][1]
-        if (dir.exists(file.path(installs_path,non_rc_path))) {
+        if (dir.exists(file.path(installs_path, non_rc_path))) {
           latest_cmdstan <- non_rc_path
         }
       }
-      return(file.path(installs_path,latest_cmdstan))
+      return(file.path(installs_path, latest_cmdstan))
     }
   }
-  return(NULL)
+  NULL
 }
 
 # unset the path (only used in tests)
@@ -148,7 +149,7 @@ unset_cmdstan_path <- function() {
 }
 
 
-#' Find the version of cmdstan from makefile
+#' Find the version of CmdStan from makefile
 #' @noRd
 #' @param path Path to installation.
 #' @return Version number as a string.

---FILE: R/run.R---
@@ -223,7 +223,7 @@ CmdStanRun <- R6::R6Class(
         stop(""No CmdStan runs finished successfully. "",
              ""Unable to run bin/"", tool, ""."", call. = FALSE)
       }
-      target_exe = file.path(""bin"", cmdstan_ext(tool))
+      target_exe <- file.path(""bin"", cmdstan_ext(tool))
       check_target_exe(target_exe)
       run_log <- processx::run(
         command = target_exe,
@@ -303,7 +303,7 @@ check_target_exe <- function(exe) {
   on.exit(procs$cleanup(), add = TRUE)
   if (!is.null(mpi_cmd)) {
     if (is.null(mpi_args)) {
-      mpi_args = list()
+      mpi_args <- list()
     }
     mpi_args[[""exe""]] <- self$exe_file()
   }
@@ -560,11 +560,11 @@ CmdStanProcs <- R6::R6Class(
       private$proc_ids_ <- seq_len(num_procs)
       zeros <- rep(0, num_procs)
       names(zeros) <- private$proc_ids_
-      private$proc_state_ = zeros
-      private$proc_start_time_ = zeros
-      private$proc_total_time_ = zeros
-      private$show_stderr_messages_ = show_stderr_messages
-      private$show_stdout_messages_ = show_stdout_messages
+      private$proc_state_ <- zeros
+      private$proc_start_time_ <- zeros
+      private$proc_total_time_ <- zeros
+      private$show_stderr_messages_ <- show_stderr_messages
+      private$show_stdout_messages_ <- show_stdout_messages
       invisible(self)
     },
     num_procs = function() {
@@ -602,7 +602,7 @@ CmdStanProcs <- R6::R6Class(
         for (i in names(mpi_args)) {
           mpi_args_vector <- c(paste0(""-"", i), mpi_args[[i]], mpi_args_vector)
         }
-        args = c(mpi_args_vector, exe_name, args)
+        args <- c(mpi_args_vector, exe_name, args)
         command <- mpi_cmd
       }
       private$processes_[[id]] <- processx::process$new(
@@ -868,11 +868,11 @@ CmdStanMCMCProcs <- R6::R6Class(
             next_state <- 5
             state <- 5
           }
-          if (grepl(""Gradient evaluation took"",line, fixed = TRUE)
-              || grepl(""leapfrog steps per transition would take"",line, fixed = TRUE)
-              || grepl(""Adjust your expectations accordingly!"",line, fixed = TRUE)
-              || grepl(""stanc_version"",line, fixed = TRUE)
-              || grepl(""stancflags"",line, fixed = TRUE)) {
+          if (grepl(""Gradient evaluation took"", line, fixed = TRUE)
+              || grepl(""leapfrog steps per transition would take"", line, fixed = TRUE)
+              || grepl(""Adjust your expectations accordingly!"", line, fixed = TRUE)
+              || grepl(""stanc_version"", line, fixed = TRUE)
+              || grepl(""stancflags"", line, fixed = TRUE)) {
             ignore_line <- TRUE
           }
           if ((state > 1.5 && state < 5 && !ignore_line) || is_verbose_mode()) {
@@ -1049,4 +1049,4 @@ check_tbb_path <- function() {
       Sys.setenv(PATH = paste0(path_to_TBB, "";"", Sys.getenv(""PATH"")))
     }
   }
-}
\ No newline at end of file
+}

---FILE: R/utils.R---
@@ -16,6 +16,24 @@ is_verbose_mode <- function() {
   if (is.null(x) || length(x) == 0) y else x
 }
 
+# used in both fit.R and csv.R for variable filtering
+matching_variables <- function(variable_filters, variables) {
+  not_found <- c()
+  selected_variables <- c()
+  for (v in variable_filters) {
+    selected <- variables == v | startsWith(variables, paste0(v, ""[""))
+    selected_variables <- c(selected_variables, variables[selected])
+    variables <- variables[!selected]
+    if (!any(selected)) {
+      not_found <- c(not_found, v)
+    }
+  }
+  list(
+    matching = selected_variables,
+    not_found = not_found
+  )
+}
+
 
 # checks for OS and hardware ----------------------------------------------
 
@@ -183,7 +201,7 @@ generate_file_names <-
     }
     if (random) {
       rand_num_pid <- as.integer(stats::runif(1, min = 0, max = 1E7)) + Sys.getpid()
-      rand <- format(as.hexmode(rand_num_pid) , width = 6)
+      rand <- format(as.hexmode(rand_num_pid), width = 6)
       new_names <- paste0(new_names, ""-"", rand)
     }
 
@@ -194,41 +212,8 @@ generate_file_names <-
     new_names
   }
 
+# threading helpers (deprecated) ------------------------------------------
 
-cpp_options_to_compile_flags <- function(cpp_options) {
-  if (length(cpp_options) == 0) {
-    return(NULL)
-  }
-  cpp_built_options = c()
-  for (i in seq_len(length(cpp_options))) {
-    option_name <- names(cpp_options)[i]
-    if (is.null(option_name) || !nzchar(option_name)) {
-      cpp_built_options = c(cpp_built_options, toupper(cpp_options[[i]]))
-    } else {
-      cpp_built_options = c(cpp_built_options, paste0(toupper(option_name), ""="", cpp_options[[i]]))
-    }
-  }
-  cpp_built_options
-}
-
-check_stanc_options <- function(stanc_options) {
-  i <- 1
-  names <- names(stanc_options)
-  for (s in stanc_options){
-    if (!is.null(names[i]) && nzchar(names[i])) {
-      name <- names[i]
-    } else {
-      name <- s
-    }
-    if (startsWith(name, ""--"")) {
-      stop(""No leading hyphens allowed in stanc options ("", name, ""). "",
-           ""Use options without leading hyphens, like for example "",
-           ""`stanc_options = list('allow-undefined')`"",
-           call. = FALSE)
-    }
-    i <- i + 1
-  }
-}
 
 #' Set or get the number of threads used to execute Stan models
 #'
@@ -253,13 +238,15 @@ set_num_threads <- function(num_threads) {
        call. = FALSE)
 }
 
+
+# convergence checks ------------------------------------------------------
 check_divergences <- function(post_warmup_sampler_diagnostics) {
   if (!is.null(post_warmup_sampler_diagnostics)) {
     divergences <- posterior::extract_variable_matrix(post_warmup_sampler_diagnostics, ""divergent__"")
     num_of_draws <- length(divergences)
     num_of_divergences <- sum(divergences)
     if (!is.na(num_of_divergences) && num_of_divergences > 0) {
-      percentage_divergences <- (num_of_divergences)/num_of_draws*100
+      percentage_divergences <- 100 * num_of_divergences / num_of_draws
       message(
         ""\nWarning: "", num_of_divergences, "" of "", num_of_draws,
         "" ("", (format(round(percentage_divergences, 0), nsmall = 1)), ""%)"",
@@ -280,13 +267,15 @@ check_sampler_transitions_treedepth <- function(post_warmup_sampler_diagnostics,
     num_of_draws <- length(treedepth)
     max_treedepth_hit <- sum(treedepth >= metadata$max_treedepth)
     if (!is.na(max_treedepth_hit) && max_treedepth_hit > 0) {
-      percentage_max_treedepth <- (max_treedepth_hit)/num_of_draws*100
-      message(max_treedepth_hit, "" of "", num_of_draws, "" ("", (format(round(percentage_max_treedepth, 0), nsmall = 1)), ""%)"",
-              "" transitions hit the maximum treedepth limit of "", metadata$max_treedepth,
-              "" or 2^"", metadata$max_treedepth, ""-1 leapfrog steps.\n"",
-              ""Trajectories that are prematurely terminated due to this limit will result in slow exploration.\n"",
-              ""Increasing the max_treedepth limit can avoid this at the expense of more computation.\n"",
-              ""If increasing max_treedepth does not remove warnings, try to reparameterize the model.\n"")
+      percentage_max_treedepth <- 100 * max_treedepth_hit / num_of_draws
+      message(
+        max_treedepth_hit, "" of "", num_of_draws, "" ("", (format(round(percentage_max_treedepth, 0), nsmall = 1)), ""%)"",
+        "" transitions hit the maximum treedepth limit of "", metadata$max_treedepth,
+        "" or 2^"", metadata$max_treedepth, ""-1 leapfrog steps.\n"",
+        ""Trajectories that are prematurely terminated due to this limit will result in slow exploration.\n"",
+        ""Increasing the max_treedepth limit can avoid this at the expense of more computation.\n"",
+        ""If increasing max_treedepth does not remove warnings, try to reparameterize the model.\n""
+      )
     }
   }
 }
@@ -299,61 +288,13 @@ check_bfmi <- function(post_warmup_sampler_diagnostics) {
     })
     if (any(ebfmi < .3)) {
       message(sum(ebfmi < .3), "" of "", length(ebfmi) , "" chains had estimated Bayesian fraction
-      of missing information(E-BFMI) less than 0.3, which may indicate poor exploration of the 
+      of missing information(E-BFMI) less than 0.3, which may indicate poor exploration of the
       posterior. Try to reparameterize the model."")
     }
   }
 }
 
-matching_variables <- function(variable_filters, variables) {
-  not_found <- c()
-  selected_variables <- c()
-  for(v in variable_filters) {
-    selected <- variables == v | startsWith(variables, paste0(v, ""[""))
-    selected_variables <- c(selected_variables, variables[selected])
-    variables <- variables[!selected]
-    if (!any(selected)) {
-      not_found <- c(not_found, v)
-    }
-  }
-  list(
-    matching = selected_variables,
-    not_found = not_found
-  )
-}
-
-#' Returns a list of dimensions for the input variables.
-#'
-#' @noRd
-#' @param variable_names A character vector of variable names including all
-#'   individual elements (e.g., `c(""beta[1]"", ""beta[2]"")`, not just `""beta""`).
-#' @return A list giving the dimensions of the variables. The equivalent of the
-#'   `par_dims` slot of RStan's stanfit objects, except that scalars have
-#'   dimension `1` instead of `0`.
-#' @note For this function to return the correct dimensions the input must be
-#'   already sorted in ascending order. Since CmdStan always has the variables
-#'   sorted correctly we avoid a sort by not sorting again here.
-#'
-variable_dims <- function(variable_names = NULL) {
-  if (is.null(variable_names)) {
-    return(NULL)
-  }
-  dims <- list()
-  uniq_variable_names <- unique(gsub(""\\[.*\\]"", """", variable_names))
-  var_names <- gsub(""\\]"", """", variable_names)
-  for (var in uniq_variable_names) {
-    pattern <- paste0(""^"", var, ""\\["")
-    var_indices <- var_names[grep(pattern, var_names)]
-    var_indices <- gsub(pattern, """", var_indices)
-    if (length(var_indices)) {
-      var_indices <- strsplit(var_indices[length(var_indices)], "","")[[1]]
-      dims[[var]] <- as.numeric(var_indices)
-    } else {
-      dims[[var]] <- 1
-    }
-  }
-  dims
-}
+# draws formatting --------------------------------------------------------
 
 as_draws_format_fun <- function(draws_format) {
   if (draws_format %in% c(""draws_array"", ""array"")) {
@@ -384,26 +325,18 @@ valid_draws_formats <- function() {
     ""draws_list"", ""list"", ""draws_df"", ""df"", ""data.frame"")
 }
 
-maybe_convert_draws_format <- function(draws, draws_format) {
-  if (!is.null(draws)) {
-    if (draws_format %in% c(""draws_array"", ""array"")) {
-      if (!posterior::is_draws_array(draws)) {
-        draws <- posterior::as_draws_array(draws)
-      }
-    } else if (draws_format %in% c(""draws_df"", ""df"", ""data.frame"")) {
-      if (!posterior::is_draws_df(draws)) {
-        draws <- posterior::as_draws_df(draws)
-      }
-    } else if (draws_format %in% c(""draws_matrix"", ""matrix"")) {
-      if (!posterior::is_draws_matrix(draws)) {
-        draws <- posterior::as_draws_matrix(draws)
-      }
-    } else if (draws_format %in% c(""draws_list"", ""list"")) {
-      if (!posterior::is_draws_list(draws)) {
-        draws <- posterior::as_draws_list(draws)
-      }
-    }
+maybe_convert_draws_format <- function(draws, format) {
+  if (is.null(draws)) {
+    return(draws)
   }
-  draws
+  format <- sub(""^draws_"", """", format)
+  switch(
+    format,
+    ""array"" = posterior::as_draws_array(draws),
+    ""df"" = posterior::as_draws_df(draws),
+    ""data.frame"" = posterior::as_draws_df(draws),
+    ""list"" = posterior::as_draws_list(draws),
+    ""matrix"" = posterior::as_draws_matrix(draws),
+    stop(""Invalid draws format."", call. = FALSE)
+  )
 }
-

---FILE: R/zzz.R---
@@ -27,7 +27,6 @@ startup_messages <- function() {
   }
 }
 
-
 cmdstanr_initialize <- function() {
   # First check for environment variable CMDSTAN, but if not found
   # then see if default
@@ -37,8 +36,11 @@ cmdstanr_initialize <- function() {
       path <- absolute_path(path)
       suppressMessages(set_cmdstan_path(path))
     } else {
-      warning(""Can't find directory specified by environment variable"",
-              "" 'CMDSTAN'. Path not set."", call. = FALSE)
+      warning(
+        ""Can't find directory specified by environment variable 'CMDSTAN'. "",
+        ""Path not set."",
+        call. = FALSE
+      )
       .cmdstanr$PATH <- NULL
     }
 
@@ -49,7 +51,7 @@ cmdstanr_initialize <- function() {
     }
   }
 
-  if (getRversion() < '3.5.0') {
+  if (getRversion() < ""3.5.0"") {
     .cmdstanr$TEMP_DIR <- tempdir()
   } else {
     .cmdstanr$TEMP_DIR <- tempdir(check = TRUE)

---FILE: man/cmdstan_default_path.Rd---
@@ -7,10 +7,11 @@
 cmdstan_default_path()
 }
 \value{
-Path to the cmdstan installation with the most recent release version, NULL if no
-installation found.
+Path to the CmdStan installation with the most recent release
+version, or \code{NULL} if no installation found.
 }
 \description{
-Returns the path to the installation of cmdstan with the most recent release version.
+Returns the path to the installation of CmdStan with the most recent release
+version.
 }
 \keyword{internal}

---FILE: man/install_cmdstan.Rd---
@@ -105,6 +105,10 @@ Writing to the \code{make/local} file can be used to permanently add makefile
 flags/variables to an installation. For example adding specific compiler
 switches, changing the C++ compiler, etc. A change to the \code{make/local} file
 should typically be followed by calling \code{rebuild_cmdstan()}.
+
+The \code{check_cmdstan_toolchain()} function attempts to check for the required
+C++ toolchain. It is called internally by \code{install_cmdstan()} but can also
+be called directly by the user.
 }
 \examples{
 \dontrun{

---FILE: man/set_cmdstan_path.Rd---
@@ -43,8 +43,8 @@ this to avoid having to manually set the path every session:
 \item If the \link[=Sys.setenv]{environment variable} \code{""CMDSTAN""} exists at load time
 then its value will be automatically set as the default path to CmdStan for
 the \R session.
-\item If no environment variable is found when loaded but any directory in the form
-\code{"".cmdstanr/cmdstan-[version]""}, for example \code{"".cmdstanr/cmdstan-2.23.0""},
+\item If no environment variable is found when loaded but any directory in the
+form \code{"".cmdstanr/cmdstan-[version]""} (e.g., \code{"".cmdstanr/cmdstan-2.23.0""}),
 exists in the user's home directory (\code{Sys.getenv(""HOME"")}, \emph{not} the current
 working directory) then the path to the cmdstan with the largest version
 number will be set as the path to CmdStan for the \R session. This is the

---FILE: man/write_stan_file.Rd---
@@ -4,29 +4,46 @@
 \alias{write_stan_file}
 \title{Write Stan code to a file}
 \usage{
-write_stan_file(code, dir = tempdir(), basename = NULL)
+write_stan_file(
+  code,
+  dir = tempdir(),
+  basename = NULL,
+  force_overwrite = FALSE,
+  hash_salt = """"
+)
 }
 \arguments{
-\item{code}{(multiple options) The Stan code:
-\itemize{
-\item A single string containing a Stan program
-\item A character vector containing the individual lines of a Stan program.
-}}
+\item{code}{(character vector) The Stan code to write to the file. This can
+be a character vector of length one (a string) containing the entire Stan
+program or a character vector with each element containing one line of the
+Stan program.}
 
 \item{dir}{(string) An optional path to the directory where the file will be
 written. If omitted, a \link[base:tempfile]{temporary directory} is used by
 default.}
 
 \item{basename}{(string) If \code{dir} is specified, optionally the basename to
-use for the file created. If not specified a file name is generated via
-\code{\link[base:tempfile]{base::tempfile()}}.}
+use for the file created. If not specified a file name is generated
+from \link[rlang:hash]{hashing} the code.}
+
+\item{force_overwrite}{(logical) If set to \code{TRUE} the file will always be
+overwritten and thus the resulting model will always be recompiled.}
+
+\item{hash_salt}{(string) Text to add to the model code prior to hashing to
+determine the file name if \code{basename} is not set.}
 }
 \value{
 The path to the file.
 }
 \description{
 Convenience function for writing Stan code to a (possibly
-\link[base:tempfile]{temporary}) file with a \code{.stan} extension.
+\link[base:tempfile]{temporary}) file with a \code{.stan} extension. By default, the
+file name is chosen deterministically based on a \link[rlang:hash]{hash}
+of the Stan code, and the file is not overwritten if it already has correct
+contents. This means that calling this function multiple times with the same
+Stan code will reuse the compiled model. This also however means that the
+function is potentially not thread-safe. Using \code{hash_salt = Sys.getpid()}
+should ensure thread-safety in the rare cases when it is needed.
 }
 \examples{
 # stan program as a single string

---FILE: man/write_stan_tempfile.Rd---
@@ -7,11 +7,10 @@
 write_stan_tempfile(code, dir = tempdir())
 }
 \arguments{
-\item{code}{(multiple options) The Stan code:
-\itemize{
-\item A single string containing a Stan program
-\item A character vector containing the individual lines of a Stan program.
-}}
+\item{code}{(character vector) The Stan code to write to the file. This can
+be a character vector of length one (a string) containing the entire Stan
+program or a character vector with each element containing one line of the
+Stan program.}
 
 \item{dir}{(string) An optional path to the directory where the file will be
 written. If omitted, a \link[base:tempfile]{temporary directory} is used by

---FILE: tests/testthat/test-csv.R---
@@ -775,3 +775,29 @@ test_that(""read_cmdstan_csv works with diagnose results"", {
   expect_equal(diagnose_results$gradients$finite_diff, c(8.83081, 4.07931, -25.7167, -4.11423))
   expect_equal(diagnose_results$gradients$error, c(9.919e-09, 3.13568e-08, -5.31186e-09, 5.87693e-09))
 })
+
+test_that(""variable_dims() works"", {
+  expect_null(variable_dims(NULL))
+
+  vars <- c(""a"", ""b[1]"", ""b[2]"", ""b[3]"", ""c[1,1]"", ""c[1,2]"")
+  vars_dims <- list(a = 1, b = 3, c = c(1,2))
+  expect_equal(variable_dims(vars), vars_dims)
+
+  vars <- c(""a"", ""b"")
+  vars_dims <- list(a = 1, b = 1)
+  expect_equal(variable_dims(vars), vars_dims)
+
+  vars <- c(""c[1,1]"", ""c[1,2]"", ""c[1,3]"", ""c[2,1]"", ""c[2,2]"", ""c[2,3]"", ""b[1]"", ""b[2]"", ""b[3]"", ""b[4]"")
+  vars_dims <- list(c = c(2,3), b = 4)
+  expect_equal(variable_dims(vars), vars_dims)
+
+  # make sure not confused by one name being last substring of another name
+  vars <- c(""a[1]"", ""a[2]"", ""aa[1]"", ""aa[2]"", ""aa[3]"")
+  expect_equal(variable_dims(vars), list(a = 2, aa = 3))
+
+  # wrong dimensions for descending order
+  vars <- c(""c[1,1]"", ""c[1,2]"", ""c[1,3]"", ""c[2,3]"", ""c[2,2]"", ""c[2,1]"", ""b[4]"", ""b[2]"", ""b[3]"", ""b[1]"")
+  vars_dims <- list(c = c(2,1), b = 1)
+  expect_equal(variable_dims(vars), vars_dims)
+})
+

---FILE: tests/testthat/test-example.R---
@@ -67,6 +67,38 @@ test_that(""write_stan_file creates dir if necessary"", {
   )
 })
 
+test_that(""write_stan_file by default creates the same file for the same Stan model"", {
+  dir <- file.path(test_path(), ""answers"")
+
+  f1 <- write_stan_file(stan_program, dir = dir)
+  mtime1 <- file.info(f1)$mtime
+
+  f2 <- write_stan_file(paste0(stan_program, ""\n\n""), dir = dir)
+  expect_true(f1 != f2)
+
+  # Test that writing the some model will not touch the file
+  # Wait a tiny bit to make sure the modified time will be different if
+  # overwrite happened
+  Sys.sleep(0.001)
+  f3 <- write_stan_file(stan_program, dir = dir)
+  expect_equal(f1, f3)
+
+  mtime3 <- file.info(f3)$mtime
+  expect_equal(mtime1, mtime3)
+
+  f4 <- write_stan_file(stan_program, dir = dir, hash_salt = ""aaa"")
+  expect_true(f1 != f4)
+
+  f5 <- write_stan_file(stan_program, dir = dir, force_overwrite = TRUE)
+  expect_equal(f1, f5)
+
+  mtime5 <- file.info(f5)$mtime
+  expect_true(mtime1 < mtime5)
+
+
+  try(file.remove(f1, f2, f4), silent = TRUE)
+})
+
 test_that(""write_stan_tempfile is deprecated"", {
   expect_warning(write_stan_tempfile(stan_program), ""deprecated"")
 })

---FILE: tests/testthat/test-model-compile.R---
@@ -243,33 +243,33 @@ test_that(""compiling stops on hyphens in stanc_options"", {
   stan_file <- testing_stan_file(""bernoulli"")
   expect_error(
     cmdstan_model(stan_file, stanc_options = hyphens, compile = FALSE),
-    ""No leading hyphens allowed in stanc options (--allow-undefined). Use options without leading hyphens, like for example `stanc_options = list('allow-undefined')`"",
+    ""No leading hyphens allowed in stanc options (--allow-undefined). Use options without leading hyphens, for example `stanc_options = list('allow-undefined')`"",
     fixed = TRUE
   )
   expect_error(
     cmdstan_model(stan_file, stanc_options = hyphens2, compile = FALSE),
-    ""No leading hyphens allowed in stanc options (--allow-undefined). Use options without leading hyphens, like for example `stanc_options = list('allow-undefined')`"",
+    ""No leading hyphens allowed in stanc options (--allow-undefined). Use options without leading hyphens, for example `stanc_options = list('allow-undefined')`"",
     fixed = TRUE
   )
   expect_error(
     cmdstan_model(stan_file, stanc_options = hyphens3, compile = FALSE),
-    ""No leading hyphens allowed in stanc options (--o). Use options without leading hyphens, like for example `stanc_options = list('allow-undefined')`"",
+    ""No leading hyphens allowed in stanc options (--o). Use options without leading hyphens, for example `stanc_options = list('allow-undefined')`"",
     fixed = TRUE
   )
   mod <- cmdstan_model(stan_file, compile = FALSE)
   expect_error(
     mod$compile(stanc_options = hyphens),
-    ""No leading hyphens allowed in stanc options (--allow-undefined). Use options without leading hyphens, like for example `stanc_options = list('allow-undefined')`"",
+    ""No leading hyphens allowed in stanc options (--allow-undefined). Use options without leading hyphens, for example `stanc_options = list('allow-undefined')`"",
     fixed = TRUE
   )
   expect_error(
     mod$compile(stanc_options = hyphens2),
-    ""No leading hyphens allowed in stanc options (--allow-undefined). Use options without leading hyphens, like for example `stanc_options = list('allow-undefined')`"",
+    ""No leading hyphens allowed in stanc options (--allow-undefined). Use options without leading hyphens, for example `stanc_options = list('allow-undefined')`"",
     fixed = TRUE
   )
   expect_error(
     mod$compile(stanc_options = hyphens3),
-    ""No leading hyphens allowed in stanc options (--o). Use options without leading hyphens, like for example `stanc_options = list('allow-undefined')`"",
+    ""No leading hyphens allowed in stanc options (--o). Use options without leading hyphens, for example `stanc_options = list('allow-undefined')`"",
     fixed = TRUE
   )
 })
@@ -442,7 +442,22 @@ test_that(""compiliation errors if folder with the model name exists"", {
     }
     dir.create(exe)
   }
-  expect_error(cmdstan_model(stan_file),
-               ""There is a subfolder matching the model name in the same folder as the model! Please remove or rename the subfolder and try again."")
+  expect_error(
+    cmdstan_model(stan_file),
+    ""There is a subfolder matching the model name in the same folder as the model! Please remove or rename the subfolder and try again.""
+  )
 })
 
+test_that(""cpp_options_to_compile_flags() works"", {
+  options = list(
+    stan_threads = TRUE
+  )
+  expect_equal(cpp_options_to_compile_flags(options), ""STAN_THREADS=TRUE"")
+  options = list(
+    stan_threads = TRUE,
+    stanc2 = TRUE
+  )
+  expect_equal(cpp_options_to_compile_flags(options), c(""STAN_THREADS=TRUE"", ""STANC2=TRUE""))
+  options = list()
+  expect_equal(cpp_options_to_compile_flags(options), NULL)
+})

---FILE: tests/testthat/test-model-init.R---
@@ -166,7 +166,7 @@ test_that(""error if init list is specified incorrectly"", {
   init_list[[2]] = init_list[[1]]
   expect_error(
     mod_logistic$sample(data = data_list_logistic, chains = 2, init = init_list),
-    ""'init' contains entries with parameter names that include square-brackets, which is not permitted. To supply inits for a vector, matrix or array of parameters, create a single entry with the parameter's name in the init list and specify init values for the entire parameter container.""
+    ""'init' contains entries with parameter names that include square-brackets, which is not permitted.""
   )
 
 })

---FILE: tests/testthat/test-utils.R---
@@ -106,20 +106,6 @@ test_that(""list_to_array fails for non-numeric values"", {
                ""All elements in list 'test-list' must be numeric!"")
 })
 
-test_that(""cpp_options_to_compile_flags() works"", {
-  options = list(
-    stan_threads = TRUE
-  )
-  expect_equal(cpp_options_to_compile_flags(options), ""STAN_THREADS=TRUE"")
-  options = list(
-    stan_threads = TRUE,
-    stanc2 = TRUE
-  )
-  expect_equal(cpp_options_to_compile_flags(options), c(""STAN_THREADS=TRUE"", ""STANC2=TRUE""))
-  options = list()
-  expect_equal(cpp_options_to_compile_flags(options), NULL)
-})
-
 test_that(""cmdstan_make_local() works"", {
   exisiting_make_local <- cmdstan_make_local()
   make_local_path <- file.path(cmdstan_path(), ""make"", ""local"")
@@ -153,31 +139,6 @@ test_that(""cmdstan_make_local() works"", {
   cmdstan_make_local(cpp_options = as.list(exisiting_make_local), append = FALSE)
 })
 
-test_that(""variable_dims() works"", {
-  expect_null(variable_dims(NULL))
-
-  vars <- c(""a"", ""b[1]"", ""b[2]"", ""b[3]"", ""c[1,1]"", ""c[1,2]"")
-  vars_dims <- list(a = 1, b = 3, c = c(1,2))
-  expect_equal(variable_dims(vars), vars_dims)
-
-  vars <- c(""a"", ""b"")
-  vars_dims <- list(a = 1, b = 1)
-  expect_equal(variable_dims(vars), vars_dims)
-
-  vars <- c(""c[1,1]"", ""c[1,2]"", ""c[1,3]"", ""c[2,1]"", ""c[2,2]"", ""c[2,3]"", ""b[1]"", ""b[2]"", ""b[3]"", ""b[4]"")
-  vars_dims <- list(c = c(2,3), b = 4)
-  expect_equal(variable_dims(vars), vars_dims)
-
-  # make sure not confused by one name being last substring of another name
-  vars <- c(""a[1]"", ""a[2]"", ""aa[1]"", ""aa[2]"", ""aa[3]"")
-  expect_equal(variable_dims(vars), list(a = 2, aa = 3))
-
-  # wrong dimensions for descending order
-  vars <- c(""c[1,1]"", ""c[1,2]"", ""c[1,3]"", ""c[2,3]"", ""c[2,2]"", ""c[2,1]"", ""b[4]"", ""b[2]"", ""b[3]"", ""b[1]"")
-  vars_dims <- list(c = c(2,1), b = 1)
-  expect_equal(variable_dims(vars), vars_dims)
-})
-
 test_that(""matching_variables() works"", {
   ret <- matching_variables(c(""beta""),  c(""alpha"", ""beta[1]"", ""beta[2]"", ""beta[3]""))
   expect_equal(",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,78619506051745c1e0599d8f775c80ec2878c766,jgabry,jgabry@gmail.com,2021-05-16T05:09:51Z,jgabry,jgabry@gmail.com,2021-05-16T05:09:51Z,fix tests,tests/testthat/test-model-compile.R;tests/testthat/test-model-init.R,False,True,True,False,11,9,20,"---FILE: tests/testthat/test-model-compile.R---
@@ -243,33 +243,33 @@ test_that(""compiling stops on hyphens in stanc_options"", {
   stan_file <- testing_stan_file(""bernoulli"")
   expect_error(
     cmdstan_model(stan_file, stanc_options = hyphens, compile = FALSE),
-    ""No leading hyphens allowed in stanc options (--allow-undefined). Use options without leading hyphens, like for example `stanc_options = list('allow-undefined')`"",
+    ""No leading hyphens allowed in stanc options (--allow-undefined). Use options without leading hyphens, for example `stanc_options = list('allow-undefined')`"",
     fixed = TRUE
   )
   expect_error(
     cmdstan_model(stan_file, stanc_options = hyphens2, compile = FALSE),
-    ""No leading hyphens allowed in stanc options (--allow-undefined). Use options without leading hyphens, like for example `stanc_options = list('allow-undefined')`"",
+    ""No leading hyphens allowed in stanc options (--allow-undefined). Use options without leading hyphens, for example `stanc_options = list('allow-undefined')`"",
     fixed = TRUE
   )
   expect_error(
     cmdstan_model(stan_file, stanc_options = hyphens3, compile = FALSE),
-    ""No leading hyphens allowed in stanc options (--o). Use options without leading hyphens, like for example `stanc_options = list('allow-undefined')`"",
+    ""No leading hyphens allowed in stanc options (--o). Use options without leading hyphens, for example `stanc_options = list('allow-undefined')`"",
     fixed = TRUE
   )
   mod <- cmdstan_model(stan_file, compile = FALSE)
   expect_error(
     mod$compile(stanc_options = hyphens),
-    ""No leading hyphens allowed in stanc options (--allow-undefined). Use options without leading hyphens, like for example `stanc_options = list('allow-undefined')`"",
+    ""No leading hyphens allowed in stanc options (--allow-undefined). Use options without leading hyphens, for example `stanc_options = list('allow-undefined')`"",
     fixed = TRUE
   )
   expect_error(
     mod$compile(stanc_options = hyphens2),
-    ""No leading hyphens allowed in stanc options (--allow-undefined). Use options without leading hyphens, like for example `stanc_options = list('allow-undefined')`"",
+    ""No leading hyphens allowed in stanc options (--allow-undefined). Use options without leading hyphens, for example `stanc_options = list('allow-undefined')`"",
     fixed = TRUE
   )
   expect_error(
     mod$compile(stanc_options = hyphens3),
-    ""No leading hyphens allowed in stanc options (--o). Use options without leading hyphens, like for example `stanc_options = list('allow-undefined')`"",
+    ""No leading hyphens allowed in stanc options (--o). Use options without leading hyphens, for example `stanc_options = list('allow-undefined')`"",
     fixed = TRUE
   )
 })
@@ -442,8 +442,10 @@ test_that(""compiliation errors if folder with the model name exists"", {
     }
     dir.create(exe)
   }
-  expect_error(cmdstan_model(stan_file),
-               ""There is a subfolder matching the model name in the same folder as the model! Please remove or rename the subfolder and try again."")
+  expect_error(
+    cmdstan_model(stan_file),
+    ""There is a subfolder matching the model name in the same folder as the model! Please remove or rename the subfolder and try again.""
+  )
 })
 
 test_that(""cpp_options_to_compile_flags() works"", {

---FILE: tests/testthat/test-model-init.R---
@@ -166,7 +166,7 @@ test_that(""error if init list is specified incorrectly"", {
   init_list[[2]] = init_list[[1]]
   expect_error(
     mod_logistic$sample(data = data_list_logistic, chains = 2, init = init_list),
-    ""'init' contains entries with parameter names that include square-brackets, which is not permitted. To supply inits for a vector, matrix or array of parameters, create a single entry with the parameter's name in the init list and specify init values for the entire parameter container.""
+    ""'init' contains entries with parameter names that include square-brackets, which is not permitted.""
   )
 
 })",True,False,Rendering / Conversion,3
stan-dev,cmdstanr,3de7d04e895e28e8516ab203fbad7f53f588b4ca,jgabry,jgabry@gmail.com,2021-05-07T02:16:23Z,jgabry,jgabry@gmail.com,2021-05-07T02:16:23Z,fix typo,R/model.R,False,True,True,False,1,1,2,"---FILE: R/model.R---
@@ -1238,7 +1238,7 @@ generate_quantities <- function(fitted_params,
     parallel_procs = checkmate::assert_integerish(parallel_chains, lower = 1, null.ok = TRUE),
     threads_per_proc = assert_valid_threads(threads_per_chain, self$cpp_options(), multiple_chains = TRUE)
   )
-  gq_args <- GenerateQuantitiesArgs$new(fitted_params = fitted_params)
+  gq_args <- GenerateQuantitiesArgs$new(fitted_params = fitted_params_files)
   args <- CmdStanArgs$new(
     method_args = gq_args,
     model_name = self$model_name(),",True,False,Implementation / Logic,6
stan-dev,cmdstanr,1ffb548c4942821b982edbe851ff32f23e54cd4a,jgabry,jgabry@gmail.com,2021-05-04T18:13:27Z,jgabry,jgabry@gmail.com,2021-05-04T18:13:27Z,"regenerate doc after changing argument order

@rok-cesnovar this should fix the failing check",man/model-method-diagnose.Rd,False,False,False,False,8,8,16,"---FILE: man/model-method-diagnose.Rd---
@@ -8,12 +8,12 @@
 \usage{
 diagnose_method(
   data = NULL,
-  epsilon = NULL,
-  error = NULL,
   seed = NULL,
   init = NULL,
   output_dir = NULL,
-  output_basename = NULL
+  output_basename = NULL,
+  epsilon = NULL,
+  error = NULL
 )
 }
 \arguments{
@@ -27,11 +27,6 @@ appendices in the CmdStan manual for details on using these formats.
 \item \code{NULL} or an empty list if the Stan program has no \code{data} block.
 }}
 
-\item{epsilon}{(positive real) The finite difference step size. Default
-value is 1e-6.}
-
-\item{error}{(positive real)  The error threshold. Default value is 1e-6.}
-
 \item{seed}{(positive integer(s)) A seed for the (P)RNG to pass to CmdStan.
 In the case of multi-chain sampling the single \code{seed} will automatically be
 augmented by the the run (chain) ID so that each chain uses a different
@@ -87,6 +82,11 @@ names of the output CSV files of CmdStan.
 \item If \code{NULL} (the default), the basename of the output CSV files
 will be comprised from the model name, timestamp and 5 random characters.
 }}
+
+\item{epsilon}{(positive real) The finite difference step size. Default
+value is 1e-6.}
+
+\item{error}{(positive real)  The error threshold. Default value is 1e-6.}
 }
 \value{
 A \code{\link{CmdStanDiagnose}} object.",False,False,Documentation / Formatting,6
stan-dev,cmdstanr,f795823aea1a00d41bc5ef23a933e2b3d0d9ba58,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-05-04T17:39:34Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-05-04T17:39:34Z,fix arg order in diagnose,R/model.R,False,True,True,False,3,3,6,"---FILE: R/model.R---
@@ -1366,12 +1366,12 @@ check_opencl <- function(cpp_options, opencl_ids) {
 #' @inherit CmdStanDiagnose examples
 #'
 diagnose_method <- function(data = NULL,
-                            epsilon = NULL,
-                            error = NULL,
                             seed = NULL,
                             init = NULL,
                             output_dir = NULL,
-                            output_basename = NULL) {
+                            output_basename = NULL,
+                            epsilon = NULL,
+                            error = NULL) {
   diagnose_args <- DiagnoseArgs$new(
     epsilon = epsilon,
     error = error",True,False,Implementation / Logic,6
stan-dev,cmdstanr,5c91b3b5ed742f3a03710876d95661560d174c7e,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-05-01T11:15:52Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-05-01T11:15:52Z,more doc fixes,R/fit.R;cmdstanr.Rproj;man/fit-method-gradients.Rd;man/read_cmdstan_csv.Rd,False,True,True,False,6,7,13,"---FILE: R/fit.R---
@@ -69,7 +69,7 @@ CmdStanFit <- R6::R6Class(
 #' Extract gradients of the diagnostic
 #'
 #' @name fit-method-gradients
-#' @aliases init
+#' @aliases gradients
 #' @description Return the data frame containing the gradients
 #'   for all parameters in the 
 #'
@@ -81,8 +81,6 @@ CmdStanFit <- R6::R6Class(
 #' \dontrun{
 #' fit <- cmdstanr_example(""logistic"", method = ""diagnose"")
 #'
-#' # retrieve the log of the probability density/mass function
-#' fit$lp()
 #' # retrieve the gradients
 #' fit$gradients()
 #' }

---FILE: cmdstanr.Rproj---
@@ -18,4 +18,7 @@ StripTrailingWhitespace: Yes
 BuildType: Package
 PackageUseDevtools: Yes
 PackageInstallArgs: --no-multiarch --with-keep.source
+PackageBuildArgs: no-build-vignettes
+PackageBuildBinaryArgs: no-build-vignettes
+PackageCheckArgs: --ignore-vignettes
 PackageRoxygenize: rd,collate,namespace

---FILE: man/fit-method-gradients.Rd---
@@ -3,7 +3,7 @@
 \name{fit-method-gradients}
 \alias{fit-method-gradients}
 \alias{CmdStanDiagnose}
-\alias{init}
+\alias{gradients}
 \title{Extract gradients of the diagnostic}
 \value{
 A list of lists. See \strong{Examples}.
@@ -16,8 +16,6 @@ for all parameters in the
 \dontrun{
 fit <- cmdstanr_example(""logistic"", method = ""diagnose"")
 
-# retrieve the log of the probability density/mass function
-fit$lp()
 # retrieve the gradients
 fit$gradients()
 }

---FILE: man/read_cmdstan_csv.Rd---
@@ -125,7 +125,7 @@ print(csv_files)
 # Creating fitting model objects
 
 # Create a CmdStanMCMC object from the CSV files
-fit2 <- as_cmdstan_mcmc(csv_files)
+fit2 <- as_cmdstan_fit(csv_files)
 fit2$print(""beta"")
 
 # Using read_cmdstan_csv",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,3f60ae44c2da1d443c4d2e11451a6466d0275b0f,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-05-01T10:11:55Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-05-01T10:11:55Z,fix docs,R/model.R;man/fit-method-gradients.Rd;man/model-method-diagnose.Rd,False,True,True,False,95,1,96,"---FILE: R/model.R---
@@ -1355,7 +1355,7 @@ check_opencl <- function(cpp_options, opencl_ids) {
 #'   finite differences. Discrepancies between the two indicate that there is
 #'   a problem with the model or initial states or else there is a bug in Stan.
 #'
-#' @inheritParams model-method-diagnose
+#' @inheritParams model-method-sample
 #' @param epsilon (positive real) The finite difference step size. Default
 #'   value is 1e-6.
 #' @param error (positive real)  The error threshold. Default value is 1e-6.

---FILE: man/fit-method-gradients.Rd---
@@ -0,0 +1,28 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/fit.R
+\name{fit-method-gradients}
+\alias{fit-method-gradients}
+\alias{CmdStanDiagnose}
+\alias{init}
+\title{Extract gradients of the diagnostic}
+\value{
+A list of lists. See \strong{Examples}.
+}
+\description{
+Return the data frame containing the gradients
+for all parameters in the
+}
+\examples{
+\dontrun{
+fit <- cmdstanr_example(""logistic"", method = ""diagnose"")
+
+# retrieve the log of the probability density/mass function
+fit$lp()
+# retrieve the gradients
+fit$gradients()
+}
+
+}
+\seealso{
+\code{\link{CmdStanDiagnose}}
+}

---FILE: man/model-method-diagnose.Rd---
@@ -17,10 +17,76 @@ diagnose_method(
 )
 }
 \arguments{
+\item{data}{(multiple options) The data to use for the variables specified in
+the \code{data} block of the Stan program. One of the following:
+\itemize{
+\item A named list of \R objects (like for RStan). Internally this list is then
+written to JSON for CmdStan using \code{\link[=write_stan_json]{write_stan_json()}}.
+\item A path to a data file compatible with CmdStan (JSON or \R dump). See the
+appendices in the CmdStan manual for details on using these formats.
+\item \code{NULL} or an empty list if the Stan program has no \code{data} block.
+}}
+
 \item{epsilon}{(positive real) The finite difference step size. Default
 value is 1e-6.}
 
 \item{error}{(positive real)  The error threshold. Default value is 1e-6.}
+
+\item{seed}{(positive integer(s)) A seed for the (P)RNG to pass to CmdStan.
+In the case of multi-chain sampling the single \code{seed} will automatically be
+augmented by the the run (chain) ID so that each chain uses a different
+seed. The exception is the \verb{transformed data} block, which defaults to
+using same seed for all chains so that the same data is generated for all
+chains if RNG functions are used. The only time \code{seed} should be specified
+as a vector (one element per chain) is if RNG functions are used in
+\verb{transformed data} and the goal is to generate \emph{different} data for each
+chain.}
+
+\item{init}{(multiple options) The initialization method to use for the
+variables declared in the \code{parameters} block of the Stan program:
+\itemize{
+\item A real number \code{x>0}. This initializes \emph{all} parameters randomly between
+\verb{[-x,x]} (on the \emph{unconstrained} parameter space);
+\item The number \code{0}. This initializes \emph{all} parameters to \code{0};
+\item A character vector of paths (one per chain) to JSON or Rdump files
+containing initial values for all or some parameters. See
+\code{\link[=write_stan_json]{write_stan_json()}} to write \R objects to JSON files compatible with
+CmdStan.
+\item A list of lists containing initial values for all or some parameters. For
+MCMC the list should contain a sublist for each chain. For optimization and
+variational inference there should be just one sublist. The sublists should
+have named elements corresponding to the parameters for which you are
+specifying initial values. See \strong{Examples}.
+\item A function that returns a single list with names corresponding to the
+parameters for which you are specifying initial values. The function can
+take no arguments or a single argument \code{chain_id}. For MCMC, if the function
+has argument \code{chain_id} it will be supplied with the chain id (from 1 to
+number of chains) when called to generate the initial values. See
+\strong{Examples}.
+}}
+
+\item{output_dir}{(string) A path to a directory where CmdStan should write
+its output CSV files. For interactive use this can typically be left at
+\code{NULL} (temporary directory) since CmdStanR makes the CmdStan output
+(posterior draws and diagnostics) available in \R via methods of the fitted
+model objects. The behavior of \code{output_dir} is as follows:
+\itemize{
+\item If \code{NULL} (the default), then the CSV files are written to a temporary
+directory and only saved permanently if the user calls one of the \verb{$save_*}
+methods of the fitted model object (e.g.,
+\code{\link[=fit-method-save_output_files]{$save_output_files()}}). These temporary
+files are removed when the fitted model object is
+\link[base:gc]{garbage collected} (manually or automatically).
+\item If a path, then the files are created in \code{output_dir} with names
+corresponding to the defaults used by \verb{$save_output_files()}.
+}}
+
+\item{output_basename}{(string) A string to use as a prefix for the
+names of the output CSV files of CmdStan.
+\itemize{
+\item If \code{NULL} (the default), the basename of the output CSV files
+will be comprised from the model name, timestamp and 5 random characters.
+}}
 }
 \value{
 A \code{\link{CmdStanDiagnose}} object.",True,False,Documentation / Formatting,7
stan-dev,cmdstanr,07b5c3b59560ff817cba7f33fa283245482d7b41,jgabry,jgabry@gmail.com,2021-04-15T23:17:02Z,jgabry,jgabry@gmail.com,2021-04-15T23:17:02Z,a bunch of tiny doc edits and fixes,DESCRIPTION;R/args.R;R/data.R;R/example.R;R/fit.R;R/install.R;R/path.R;man/cmdstanr-package.Rd;man/cmdstanr_example.Rd;man/fit-method-loo.Rd;man/install_cmdstan.Rd;man/set_cmdstan_path.Rd;vignettes/children/comparison-with-rstan.md,False,True,True,False,36,44,80,"---FILE: DESCRIPTION---
@@ -16,8 +16,7 @@ Authors@R:
 Description: A lightweight interface to 'Stan' <https://mc-stan.org>.
     The 'CmdStanR' interface is an alternative to 'RStan' that calls the command 
     line interface for compilation and running algorithms instead of interfacing 
-    with C++ via 'Rcpp'. Methods are provided for conveniently reading the 
-    results into R.
+    with C++ via 'Rcpp'.
 License: BSD_3_clause + file LICENSE
 URL: https://mc-stan.org/cmdstanr, https://discourse.mc-stan.org
 BugReports: https://github.com/stan-dev/cmdstanr/issues

---FILE: R/args.R---
@@ -6,7 +6,7 @@
 #'
 #' @noRd
 #' @details
-#' A `CmdStanArgs` object stores arguments _not_ specific to particular methods,
+#' A `CmdStanArgs` object stores arguments common to all methods,
 #' as well as one of the following objects containing the method-specific
 #' arguments:
 #'
@@ -503,7 +503,7 @@ validate_cmdstan_args = function(self) {
     if (cmdstan_version() < ""2.25"") {
       stop(""Runtime selection of OpenCL devices is only supported with CmdStan version 2.26 or newer."", call. = FALSE)
     }
-    checkmate::assert_vector(self$opencl_ids, len = 2)    
+    checkmate::assert_vector(self$opencl_ids, len = 2)
   }
   invisible(TRUE)
 }

---FILE: R/data.R---
@@ -40,7 +40,6 @@ write_stan_json <- function(data, file) {
     data[[var_name]] <- var
   }
 
-  # call to write JSON with
   # unboxing variables (N = 10 is stored as N : 10, not N: [10])
   # handling factors as integers
   jsonlite::write_json(

---FILE: R/example.R---
@@ -9,7 +9,8 @@
 #'   * `""schools_ncp""`: non-centered parameterization of the ""eight schools""
 #'   model that fixes the problem with divergences.
 #'
-#'   To print the Stan code for a given example use `print_example_program()`.
+#'   To print the Stan code for a given `example` use
+#'   `print_example_program(example)`.
 #'
 #' @param method Which fitting method should be used? The default is the
 #'   `""sample""` method (MCMC).

---FILE: R/fit.R---
@@ -953,7 +953,7 @@ CmdStanMCMC <- R6::R6Class(
 #' @param variables (character vector) The name(s) of the variable(s) in the
 #'   Stan program containing the pointwise log-likelihood. The default is to
 #'   look for `""log_lik""`. This argument is passed to the
-#'   [`$draws()][fit-method-draws] method.
+#'   [`$draws()`][fit-method-draws] method.
 #' @param r_eff There are several options:
 #'   * `TRUE` (the default) will automatically call [loo::relative_eff.array()]
 #'   to compute the `r_eff` argument to pass to [loo::loo.array()].

---FILE: R/install.R---
@@ -3,7 +3,7 @@
 #' @description The `install_cmdstan()` function attempts to download and
 #'   install the latest release of [CmdStan](https://github.com/stan-dev/cmdstan/releases/latest).
 #'   Installing a previous release or a new release candidate is also possible
-#'   by specifying the `release_url` argument.
+#'   by specifying the `version` or `release_url` argument.
 #'   See the first few sections of the CmdStan
 #'   [installation guide](https://mc-stan.org/docs/cmdstan-guide/cmdstan-installation.html)
 #'   for details on the C++ toolchain required for installing CmdStan.
@@ -39,8 +39,7 @@
 #'   user's installation.
 #' @param timeout Timeout (in seconds) for the build stage of the installation.
 #' @param version The CmdStan release version to install. The default is `NULL`,
-#'   which downloads the latest stable release from
-#'   <https://github.com/stan-dev/cmdstan/releases>.
+#'   which downloads the latest stable release from <https://github.com/stan-dev/cmdstan/releases>.
 #' @param release_url The URL for the specific CmdStan release or
 #'   release candidate to install. See <https://github.com/stan-dev/cmdstan/releases>.
 #'   The URL should point to the tarball (`.tar.gz.` file) itself, e.g.,
@@ -289,7 +288,7 @@ download_with_retries <- function(download_url,
                                   retries = 5,
                                   pause_sec = 5,
                                   quiet = TRUE) {
-        
+
     download_rc <- 1
     while (retries > 0 && download_rc != 0) {
       try(

---FILE: R/path.R---
@@ -24,11 +24,11 @@
 #' the \R session.
 #' * If no environment variable is found when loaded but any directory in the form
 #' `"".cmdstanr/cmdstan-[version]""`, for example `"".cmdstanr/cmdstan-2.23.0""`,
-#' exists in the user's home directory (`Sys.getenv(""HOME"")`,
-#' *not* the current working directory) then the path to the cmdstan with the largest
-#' version number will be set as the path to CmdStan for the \R session.
-#' This is the same as the default directory that [install_cmdstan()] would use to
-#' install the latest version of CmdStan.
+#' exists in the user's home directory (`Sys.getenv(""HOME"")`, *not* the current
+#' working directory) then the path to the cmdstan with the largest version
+#' number will be set as the path to CmdStan for the \R session. This is the
+#' same as the default directory that [install_cmdstan()] would use to install
+#' the latest version of CmdStan.
 #'
 #' It is always possible to change the path after loading the package using
 #' `set_cmdstan_path(path)`.
@@ -53,22 +53,18 @@ set_cmdstan_path <- function(path = NULL) {
 cmdstan_path <- function() {
   path <- .cmdstanr$PATH %||% stop_no_path()
   path <- repair_path(path)
-
   if (is.null(.cmdstanr$VERSION)) {
     .cmdstanr$VERSION <- read_cmdstan_version(path)
   }
-
   path
 }
 
 #' @rdname set_cmdstan_path
 #' @export
-#' @return CmdStan version string if available. If CmdStan
-#'   is not found and `error_on_NA` is `FALSE`,
-#'   `cmdstan_version()` returns `NULL`.
-#' @param error_on_NA Logical of length 1, whether to
-#'   throw an error if CmdStan is not found.
-#'   If `FALSE`, `cmdstan_version()` returns `NULL`.
+#' @param error_on_NA Logical of length 1, whether to throw an error if CmdStan
+#'   is not found. If `FALSE`, `cmdstan_version()` returns `NULL`.
+#' @return CmdStan version string if available. If CmdStan is not found and
+#'   `error_on_NA` is `FALSE`, `cmdstan_version()` returns `NULL`.
 cmdstan_version <- function(error_on_NA = TRUE) {
   version <- .cmdstanr$VERSION
   if (is.null(version) && error_on_NA) {

---FILE: man/cmdstanr-package.Rd---
@@ -40,8 +40,8 @@ of RStan but currently they are only available to R users via RStan:
 \item \code{rstan::grad_log_prob()}
 \item \code{rstan::expose_stan_functions()}
 }
-\item Allows others developers to create packages like \strong{rstanarm} with
-\emph{pre-compiled} Stan programs on CRAN.
+\item Allows other developers to distribute R packages with \emph{pre-compiled}
+Stan programs (like \strong{rstanarm}) on CRAN.
 }
 }
 

---FILE: man/cmdstanr_example.Rd---
@@ -25,7 +25,8 @@ divergences.
 model that fixes the problem with divergences.
 }
 
-To print the Stan code for a given example use \code{print_example_program()}.}
+To print the Stan code for a given \code{example} use
+\code{print_example_program(example)}.}
 
 \item{method}{Which fitting method should be used? The default is the
 \code{""sample""} method (MCMC).}

---FILE: man/fit-method-loo.Rd---
@@ -11,7 +11,7 @@ loo(variables = ""log_lik"", r_eff = TRUE, ...)
 \item{variables}{(character vector) The name(s) of the variable(s) in the
 Stan program containing the pointwise log-likelihood. The default is to
 look for \code{""log_lik""}. This argument is passed to the
-\link[=fit-method-draws]{`$draws()} method.}
+\code{\link[=fit-method-draws]{$draws()}} method.}
 
 \item{r_eff}{There are several options:
 \itemize{

---FILE: man/install_cmdstan.Rd---
@@ -56,8 +56,7 @@ user's installation.}
 \item{timeout}{Timeout (in seconds) for the build stage of the installation.}
 
 \item{version}{The CmdStan release version to install. The default is \code{NULL},
-which downloads the latest stable release from
-\url{https://github.com/stan-dev/cmdstan/releases}.}
+which downloads the latest stable release from \url{https://github.com/stan-dev/cmdstan/releases}.}
 
 \item{release_url}{The URL for the specific CmdStan release or
 release candidate to install. See \url{https://github.com/stan-dev/cmdstan/releases}.
@@ -90,7 +89,7 @@ the updated contents are returned.
 The \code{install_cmdstan()} function attempts to download and
 install the latest release of \href{https://github.com/stan-dev/cmdstan/releases/latest}{CmdStan}.
 Installing a previous release or a new release candidate is also possible
-by specifying the \code{release_url} argument.
+by specifying the \code{version} or \code{release_url} argument.
 See the first few sections of the CmdStan
 \href{https://mc-stan.org/docs/cmdstan-guide/cmdstan-installation.html}{installation guide}
 for details on the C++ toolchain required for installing CmdStan.

---FILE: man/set_cmdstan_path.Rd---
@@ -17,17 +17,15 @@ cmdstan_version(error_on_NA = TRUE)
 \code{NULL} (the default) then the path is set to the default path used by
 \code{\link[=install_cmdstan]{install_cmdstan()}} if it exists.}
 
-\item{error_on_NA}{Logical of length 1, whether to
-throw an error if CmdStan is not found.
-If \code{FALSE}, \code{cmdstan_version()} returns \code{NULL}.}
+\item{error_on_NA}{Logical of length 1, whether to throw an error if CmdStan
+is not found. If \code{FALSE}, \code{cmdstan_version()} returns \code{NULL}.}
 }
 \value{
 A string. Either the file path to the CmdStan installation or the
 CmdStan version number.
 
-CmdStan version string if available. If CmdStan
-is not found and \code{error_on_NA} is \code{FALSE},
-\code{cmdstan_version()} returns \code{NULL}.
+CmdStan version string if available. If CmdStan is not found and
+\code{error_on_NA} is \code{FALSE}, \code{cmdstan_version()} returns \code{NULL}.
 }
 \description{
 Use the \code{set_cmdstan_path()} function to tell CmdStanR where the
@@ -46,11 +44,11 @@ then its value will be automatically set as the default path to CmdStan for
 the \R session.
 \item If no environment variable is found when loaded but any directory in the form
 \code{"".cmdstanr/cmdstan-[version]""}, for example \code{"".cmdstanr/cmdstan-2.23.0""},
-exists in the user's home directory (\code{Sys.getenv(""HOME"")},
-\emph{not} the current working directory) then the path to the cmdstan with the largest
-version number will be set as the path to CmdStan for the \R session.
-This is the same as the default directory that \code{\link[=install_cmdstan]{install_cmdstan()}} would use to
-install the latest version of CmdStan.
+exists in the user's home directory (\code{Sys.getenv(""HOME"")}, \emph{not} the current
+working directory) then the path to the cmdstan with the largest version
+number will be set as the path to CmdStan for the \R session. This is the
+same as the default directory that \code{\link[=install_cmdstan]{install_cmdstan()}} would use to install
+the latest version of CmdStan.
 }
 
 It is always possible to change the path after loading the package using

---FILE: vignettes/children/comparison-with-rstan.md---
@@ -15,8 +15,8 @@ but currently they are only available to R users via RStan:
   - `rstan::grad_log_prob()`
   - `rstan::expose_stan_functions()`
   
-* Allows others developers to create packages like **rstanarm** with
-_pre-compiled_ Stan programs on CRAN.
+* Allows other developers to distribute R packages with
+_pre-compiled_ Stan programs (like **rstanarm**) on CRAN.
 
 ### Advantages of CmdStanR
 ",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,ed6e89ba2cd04d26c01ead8041c12ef970289152,jgabry,jgabry@gmail.com,2021-04-15T18:56:24Z,jgabry,jgabry@gmail.com,2021-04-15T18:56:24Z,fix url,docs/articles/opencl.html;vignettes/opencl.Rmd,True,False,True,False,3,2,5,"---FILE: docs/articles/opencl.html---
@@ -145,7 +145,7 @@ <h2 class=""hasAnchor"">
 <p>This vignette demonstrates how to use the OpenCL capabilities of CmdStan with CmdStanR. The functionality described in this vignette requires CmdStan 2.26.1 or newer.</p>
 <p>As of version 2.26.1, users can expect speedups with OpenCL when using vectorized probability distribution functions (functions with the <code>_lpdf</code> or <code>_lpmf</code> suffix) and when the input variables contain at least 20,000 elements.</p>
 <p>The actual speedup for a model will depend on the particular <code>lpdf/lpmf</code> functions used and whether the <code>lpdf/lpmf</code> functions are the bottlenecks of the model. The more computationally complex the function is, the larger the expected speedup. The biggest speedups are expected when using the specialized GLM functions.</p>
-<p>In order to establish the bottlenecks in your model we recommend using <a href=""../profiling.Rmd"">profiling</a>, which was introduced in Stan version 2.26.0.</p>
+<p>In order to establish the bottlenecks in your model we recommend using <a href=""https://mc-stan.org/cmdstanr/articles/profiling.html"">profiling</a>, which was introduced in Stan version 2.26.0.</p>
 </div>
 <div id=""opencl-runtime"" class=""section level2"">
 <h2 class=""hasAnchor"">

---FILE: vignettes/opencl.Rmd---
@@ -30,7 +30,8 @@ speedup. The biggest speedups are expected when using the specialized GLM
 functions.
 
 In order to establish the bottlenecks in your model we recommend using
-[profiling](../profiling.Rmd), which was introduced in Stan version 2.26.0. 
+[profiling](https://mc-stan.org/cmdstanr/articles/profiling.html), 
+which was introduced in Stan version 2.26.0. 
 
 ## OpenCL runtime
 ",False,True,Rendering / Conversion,3
stan-dev,cmdstanr,c8fca5b7a604f7013a2b5fc72ab5f3a4383493b9,jgabry,jgabry@gmail.com,2021-04-15T17:30:25Z,jgabry,jgabry@gmail.com,2021-04-15T17:30:25Z,fix quotes in profiles example,R/fit.R;man/fit-method-profiles.Rd,False,True,True,False,7,4,11,"---FILE: R/fit.R---
@@ -699,11 +699,13 @@ CmdStanFit$set(""public"", name = ""return_codes"", value = return_codes)
 #'   were created.
 #'
 #' @seealso [`CmdStanMCMC`], [`CmdStanMLE`], [`CmdStanVB`], [`CmdStanGQ`]
+#'
 #' @examples
+#'
 #' \dontrun{
 #' # first fit a model using MCMC
 #' mcmc_program <- write_stan_file(
-#'   ""data {
+#'   'data {
 #'     int<lower=0> N;
 #'     int<lower=0,upper=1> y[N];
 #'   }
@@ -721,7 +723,7 @@ CmdStanFit$set(""public"", name = ""return_codes"", value = return_codes)
 #'       y_rep = bernoulli_rng(rep_vector(theta, N));
 #'     }
 #'   }
-#' ""
+#' '
 #' )
 #' mod_mcmc <- cmdstan_model(mcmc_program)
 #'

---FILE: man/fit-method-profiles.Rd---
@@ -20,10 +20,11 @@ Support for profiling Stan programs is available with CmdStan >= 2.26 and
 requires adding profiling statements to the Stan program.
 }
 \examples{
+
 \dontrun{
 # first fit a model using MCMC
 mcmc_program <- write_stan_file(
-  ""data {
+  'data {
     int<lower=0> N;
     int<lower=0,upper=1> y[N];
   }
@@ -41,7 +42,7 @@ mcmc_program <- write_stan_file(
       y_rep = bernoulli_rng(rep_vector(theta, N));
     }
   }
-""
+'
 )
 mod_mcmc <- cmdstan_model(mcmc_program)
 ",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,b8dacb7c7d27df6807e94dbcd7225c8bc1aa6a6c,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-04-11T18:33:21Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-04-11T18:33:21Z,"add tests
fix variable names related issue",R/fit.R;tests/testthat/test-fit-gq.R;tests/testthat/test-fit-mcmc.R;tests/testthat/test-fit-mle.R;tests/testthat/test-fit-vb.R,False,True,True,False,46,8,54,"---FILE: R/fit.R---
@@ -822,6 +822,8 @@ CmdStanMCMC <- R6::R6Class(
       )
       private$draws_ <- maybe_convert_draws_format(private$draws_, format)
       private$warmup_draws_ <- maybe_convert_draws_format(private$warmup_draws_, format)
+      private$sampler_diagnostics_ <- maybe_convert_draws_format(private$sampler_diagnostics_, format)
+      private$warmup_sampler_diagnostics_ <- maybe_convert_draws_format(private$warmup_sampler_diagnostics_, format)
       if (is.null(to_read) || any(nzchar(to_read))) {
         private$read_csv_(variables = to_read, sampler_diagnostics = """", format = format)
       }
@@ -865,7 +867,7 @@ CmdStanMCMC <- R6::R6Class(
         if (is.null(private$draws_)) {
           private$draws_ <- csv_contents$post_warmup_draws
         } else {
-          missing_variables <- !(posterior::variables(csv_contents$post_warmup_draws) %in% posterior::variables(private$draws_))
+          missing_variables <- posterior::variables(csv_contents$post_warmup_draws)[!(posterior::variables(csv_contents$post_warmup_draws) %in% posterior::variables(private$draws_))]
           private$draws_ <- posterior::bind_draws(
             private$draws_,
             posterior::subset_draws(csv_contents$post_warmup_draws, variable = missing_variables),
@@ -874,10 +876,11 @@ CmdStanMCMC <- R6::R6Class(
         }
       }
       if (!is.null(csv_contents$post_warmup_sampler_diagnostics)) {
+        
         if (is.null(private$sampler_diagnostics_)) {
           private$sampler_diagnostics_ <- csv_contents$post_warmup_sampler_diagnostics
         } else {
-          missing_variables <- !(posterior::variables(csv_contents$post_warmup_sampler_diagnostics) %in% posterior::variables(private$sampler_diagnostics_))
+          missing_variables <- posterior::variables(csv_contents$post_warmup_sampler_diagnostics)[!(posterior::variables(csv_contents$post_warmup_sampler_diagnostics) %in% posterior::variables(private$sampler_diagnostics_))]
           private$sampler_diagnostics_ <- posterior::bind_draws(
             private$sampler_diagnostics_,
             posterior::subset_draws(csv_contents$post_warmup_sampler_diagnostics, variable = missing_variables),
@@ -891,7 +894,7 @@ CmdStanMCMC <- R6::R6Class(
           if (is.null(private$warmup_draws_)) {
             private$warmup_draws_ <- csv_contents$warmup_draws
           } else {
-            missing_variables <- !(posterior::variables(csv_contents$warmup_draws) %in% posterior::variables(private$warmup_draws_))
+            missing_variables <- posterior::variables(csv_contents$warmup_draws)[!(posterior::variables(csv_contents$warmup_draws) %in% posterior::variables(private$warmup_draws_))]
             private$warmup_draws_ <- posterior::bind_draws(
               private$warmup_draws_,
               posterior::subset_draws(csv_contents$warmup_draws, variable = missing_variables),
@@ -903,7 +906,7 @@ CmdStanMCMC <- R6::R6Class(
           if (is.null(private$warmup_sampler_diagnostics_)) {
             private$warmup_sampler_diagnostics_ <- csv_contents$warmup_sampler_diagnostics
           } else {
-            missing_variables <- !(posterior::variables(csv_contents$warmup_sampler_diagnostics) %in% posterior::variables(private$warmup_sampler_diagnostics_))
+            missing_variables <- posterior::variables(csv_contents$warmup_sampler_diagnostics)[!(posterior::variables(csv_contents$warmup_sampler_diagnostics) %in% posterior::variables(private$warmup_sampler_diagnostics_))]
             private$warmup_sampler_diagnostics_ <- posterior::bind_draws(
               private$warmup_sampler_diagnostics_,
               posterior::subset_draws(csv_contents$warmup_sampler_diagnostics, variable = missing_variables),
@@ -1011,7 +1014,7 @@ sampler_diagnostics <- function(inc_warmup = FALSE, format = getOption(""cmdstanr
   private$warmup_sampler_diagnostics_ <- maybe_convert_draws_format(private$warmup_sampler_diagnostics_, format)
   private$sampler_diagnostics_ <- maybe_convert_draws_format(private$sampler_diagnostics_, format)
   if (is.null(to_read) || any(nzchar(to_read))) {
-    private$read_csv_(variables = """", sampler_diagnostics = NULL)
+    private$read_csv_(variables = """", sampler_diagnostics = NULL, format = format)
   }
   if (inc_warmup) {
     if (!private$metadata_$save_warmup) {
@@ -1372,11 +1375,11 @@ CmdStanGQ <- R6::R6Class(
       )
       private$metadata_ <- csv_contents$metadata
       if (!is.null(csv_contents$generated_quantities)) {
-        format
+        missing_variables <- posterior::variables(csv_contents$generated_quantities)[!(posterior::variables(csv_contents$generated_quantities) %in% posterior::variables(private$draws_))]
         private$draws_ <-
           posterior::bind_draws(
             private$draws_,
-            csv_contents$generated_quantities,
+            posterior::subset_draws(csv_contents$generated_quantities, variable = missing_variables),
             along=""variable""
           )
       }

---FILE: tests/testthat/test-fit-gq.R---
@@ -134,3 +134,15 @@ test_that(""fitted_params_files() works"", {
     fit$output_files()
   )
 })
+
+test_that(""draws() works for different formats"", {
+  skip_on_cran()
+  a <- fit_gq$draws()
+  expect_true(posterior::is_draws_array(a))
+  a <- fit_gq$draws(format = ""list"")
+  expect_true(posterior::is_draws_list(a))
+  a <- fit_gq$draws(format = ""array"")
+  expect_true(posterior::is_draws_array(a))
+  a <- fit_gq$draws(format = ""df"")
+  expect_true(posterior::is_draws_df(a))
+})

---FILE: tests/testthat/test-fit-mcmc.R---
@@ -297,3 +297,14 @@ test_that(""loo errors if it can't find log lik variables"", {
   )
 })
 
+test_that(""draws() works for different formats"", {
+  skip_on_cran()
+  a <- fit_mcmc$draws()
+  expect_true(posterior::is_draws_array(a))
+  a <- fit_mcmc$draws(format = ""list"")
+  expect_true(posterior::is_draws_list(a))
+  a <- fit_mcmc$draws(format = ""array"")
+  expect_true(posterior::is_draws_array(a))
+  a <- fit_mcmc$draws(format = ""df"")
+  expect_true(posterior::is_draws_df(a))
+})

---FILE: tests/testthat/test-fit-mle.R---
@@ -75,4 +75,3 @@ test_that(""draws() works for different formats"", {
   a <- fit_mle$draws(format = ""df"")
   expect_true(posterior::is_draws_df(a))
 })
-

---FILE: tests/testthat/test-fit-vb.R---
@@ -105,3 +105,16 @@ test_that(""time is reported after vb"", {
   )
 })
 
+
+
+test_that(""draws() works for different formats"", {
+  skip_on_cran()
+  a <- fit_vb$draws()
+  expect_true(posterior::is_draws_matrix(a))
+  a <- fit_vb$draws(format = ""list"")
+  expect_true(posterior::is_draws_list(a))
+  a <- fit_vb$draws(format = ""array"")
+  expect_true(posterior::is_draws_array(a))
+  a <- fit_vb$draws(format = ""df"")
+  expect_true(posterior::is_draws_df(a))
+})",True,False,Implementation / Logic,6
stan-dev,cmdstanr,23fe38ff78647b607481b88292f46deef106cf2a,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-04-07T11:53:40Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-04-07T11:53:40Z,fix the failed chains tests,tests/testthat/test-failed-chains.R,False,True,True,False,4,1,5,"---FILE: tests/testthat/test-failed-chains.R---
@@ -16,14 +16,17 @@ if (not_on_cran()) {
 
   make_some_fail <- function(x) {
     num_files <- 0
+    attempt <- 1
     while (num_files == 0 || num_files == 4) {
       utils::capture.output(
         check_some_fail <- x$sample(
           data = list(pr_fail = 0.5),
-          save_latent_dynamics = TRUE
+          save_latent_dynamics = TRUE,
+          seed = sample.int(attempt*1000, 4)
         )
       )
       num_files <- length(check_some_fail$output_files(include_failed = FALSE))
+      attempt <- attempt + 1
     }
     check_some_fail
   }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,12a62bcece884930605ead2dfc12c69c0b01191b,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-04-06T12:35:59Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-04-06T14:18:36Z,fix seed for multichain,R/args.R;tests/testthat/test-model-sample.R,False,True,True,False,51,3,54,"---FILE: R/args.R---
@@ -837,10 +837,9 @@ validate_seed <- function(seed, num_procs) {
 #' @return An integer vector of length `num_procs`.
 maybe_generate_seed <- function(seed, num_procs) {
   if (is.null(seed)) {
-    seed <- base::sample(.Machine$integer.max, num_procs)
+    seed <- rep(base::sample(.Machine$integer.max, 1), num_procs)
   } else if (length(seed) == 1 && num_procs > 1) {
-    seed <- as.integer(seed)
-    seed <- c(seed, seed + 1:(num_procs -1))
+    seed <- rep(as.integer(seed), num_procs)
   }
   seed
 }

---FILE: tests/testthat/test-model-sample.R---
@@ -264,3 +264,52 @@ test_that(""print statements in transformed data work"", {
   out <- capture.output(fit <- mod$sample(iter_warmup = 1, iter_sampling = 1, chains = 1))
   expect_true(any(grepl(""*N = 2*"", out)))
 })
+
+test_that(""seed works for multi chain sampling"", {
+  skip_on_cran()
+  m <- ""
+  transformed data {
+    int N = 100;
+    vector[N] a;
+    for (i in 1:N) {
+      a[i] = uniform_rng(0, 1);
+    }
+  }
+  parameters {
+    real y;
+  }
+  model {
+    y ~ std_normal();
+  }
+  generated quantities {
+    vector[N] tdata = a;
+    vector[N] gq;
+    for (i in 1:N) {
+      gq[i] = uniform_rng(0, 4);
+    }
+  }
+  ""
+  f <- write_stan_file(m, basename = ""rngs.stan"")
+  mod <- cmdstan_model(f)
+  utils::capture.output(
+    fit_sample <- mod$sample(chains = 2, iter_sampling = 1, iter_warmup = 100, seed = 2)
+  )
+  chain_tdata_1 <- posterior::subset_draws(fit_sample$draws(""tdata""), chain = 1)
+  chain_tdata_2 <- posterior::subset_draws(fit_sample$draws(""tdata""), chain = 2)
+  expect_equal(chain_tdata_1, chain_tdata_2)
+  chain_tdata_1 <- posterior::subset_draws(fit_sample$draws(""gq""), chain = 1)
+  chain_tdata_2 <- posterior::subset_draws(fit_sample$draws(""gq""), chain = 2)
+  expect_false(all(chain_tdata_1 == chain_tdata_2))
+
+  utils::capture.output(
+    fit_sample <- mod$sample(chains = 2, iter_sampling = 1, iter_warmup = 100,
+                             seed = c(1, 2))
+  )
+  chain_tdata_1 <- posterior::subset_draws(fit_sample$draws(""tdata""), chain = 1)
+  chain_tdata_2 <- posterior::subset_draws(fit_sample$draws(""tdata""), chain = 2)
+  expect_false(all(chain_tdata_1 == chain_tdata_2))
+  chain_tdata_1 <- posterior::subset_draws(fit_sample$draws(""gq""), chain = 1)
+  chain_tdata_2 <- posterior::subset_draws(fit_sample$draws(""gq""), chain = 2)
+  expect_false(all(chain_tdata_1 == chain_tdata_2))
+})
+",True,False,Implementation / Logic,6
stan-dev,cmdstanr,a194b304c4a9a530fa8946ebe09c4d9fe389d6f7,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-04-06T08:03:15Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2021-04-06T08:03:15Z,fix issue with dropping names,R/csv.R,False,True,True,False,42,54,96,"---FILE: R/csv.R---
@@ -126,8 +126,6 @@ read_cmdstan_csv <- function(files,
   post_warmup_sampler_diagnostics <- list()
   inv_metric <- list()
   step_size <- list()
-  col_types <- NULL
-  col_select <- NULL
   csv_metadata <- list()
   time <- data.frame()
   file_idx <- 0
@@ -198,65 +196,55 @@ read_cmdstan_csv <- function(files,
     }
     sampler_diagnostics <- metadata$sampler_diagnostics[selected_sampler_diag]
   }
-  if (metadata$method == ""generate_quantities"") {
-    col_select <- c(col_select, variables)
-  } else {
-    col_select <- ""lp__""
-    col_select <- c(col_select, variables[variables!=""lp__""])
-  }
   num_warmup_draws <- ceiling(metadata$iter_warmup / metadata$thin)
   num_post_warmup_draws <- ceiling(metadata$iter_sampling / metadata$thin)
-  for (output_file in files) {    
-    if (length(col_select) > 0) {
-      if (os_is_windows()) {
-        grep_path <- repair_path(Sys.which(""grep.exe""))
-        fread_cmd <- paste0(grep_path, "" -v '^#' --color=never '"", output_file, ""'"")
-      } else {
-        fread_cmd <- paste0(""grep -v '^#' --color=never '"", output_file, ""'"")
-      }
-      if (length(sampler_diagnostics) > 0) {
-        post_warmup_sd_id <- length(post_warmup_sampler_diagnostics) + 1
-        warmup_sd_id <- length(warmup_sampler_diagnostics) + 1
-        suppressWarnings(
-          post_warmup_sampler_diagnostics[[post_warmup_sd_id]] <- data.table::fread(
-            cmd = fread_cmd,
-            select = sampler_diagnostics,
-            data.table = FALSE
-          )
+  for (output_file in files) {
+    if (os_is_windows()) {
+      grep_path <- repair_path(Sys.which(""grep.exe""))
+      fread_cmd <- paste0(grep_path, "" -v '^#' --color=never '"", output_file, ""'"")
+    } else {
+      fread_cmd <- paste0(""grep -v '^#' --color=never '"", output_file, ""'"")
+    }
+    if (length(sampler_diagnostics) > 0) {
+      post_warmup_sd_id <- length(post_warmup_sampler_diagnostics) + 1
+      warmup_sd_id <- length(warmup_sampler_diagnostics) + 1
+      suppressWarnings(
+        post_warmup_sampler_diagnostics[[post_warmup_sd_id]] <- data.table::fread(
+          cmd = fread_cmd,
+          select = sampler_diagnostics,
+          data.table = FALSE
         )
-        if (metadata$method == ""sample"" && metadata$save_warmup == 1 && num_warmup_draws > 0) {
-          warmup_sampler_diagnostics[[warmup_sd_id]] <- 
-            post_warmup_sampler_diagnostics[[post_warmup_sd_id]][1:num_warmup_draws,]
-          if (num_post_warmup_draws > 0) {
-            post_warmup_sampler_diagnostics[[post_warmup_sd_id]] <- 
-              post_warmup_sampler_diagnostics[[post_warmup_sd_id]][(num_warmup_draws+1):(num_warmup_draws + num_post_warmup_draws),]
-          } else {
-            post_warmup_sampler_diagnostics[[post_warmup_sd_id]] <- NULL
-          }          
-        }
+      )
+      if (metadata$method == ""sample"" && metadata$save_warmup == 1 && num_warmup_draws > 0) {
+        warmup_sampler_diagnostics[[warmup_sd_id]] <- 
+          post_warmup_sampler_diagnostics[[post_warmup_sd_id]][1:num_warmup_draws,,drop = FALSE]
+        if (num_post_warmup_draws > 0) {
+          post_warmup_sampler_diagnostics[[post_warmup_sd_id]] <- 
+            post_warmup_sampler_diagnostics[[post_warmup_sd_id]][(num_warmup_draws+1):(num_warmup_draws + num_post_warmup_draws),,drop = FALSE]
+        } else {
+          post_warmup_sampler_diagnostics[[post_warmup_sd_id]] <- NULL
+        }          
       }
-      if (length(variables) > 0) {
-        draws_list_id <- length(draws) + 1
-        warmup_draws_list_id <- length(warmup_draws) + 1
-        suppressWarnings(
-          draws[[draws_list_id]] <- data.table::fread(
-            cmd = fread_cmd,
-            select = col_select,
-            data.table = FALSE
-          )
+    }
+    if (length(variables) > 0) {
+      draws_list_id <- length(draws) + 1
+      warmup_draws_list_id <- length(warmup_draws) + 1
+      suppressWarnings(
+        draws[[draws_list_id]] <- data.table::fread(
+          cmd = fread_cmd,
+          select = variables,
+          data.table = FALSE
         )
-        if (metadata$method == ""sample"" && metadata$save_warmup == 1 && num_warmup_draws > 0) {
-          warmup_draws[[warmup_draws_list_id]] <- 
-            draws[[draws_list_id]][1:num_warmup_draws,]
-          if (num_post_warmup_draws > 0) {
-            draws[[draws_list_id]] <- draws[[draws_list_id]][(num_warmup_draws+1):(num_warmup_draws + num_post_warmup_draws),]
-          } else {
-            draws[[draws_list_id]] <- NULL
-          }
+      )
+      if (metadata$method == ""sample"" && metadata$save_warmup == 1 && num_warmup_draws > 0) {
+        warmup_draws[[warmup_draws_list_id]] <- 
+          draws[[draws_list_id]][1:num_warmup_draws,,drop = FALSE]
+        if (num_post_warmup_draws > 0) {
+          draws[[draws_list_id]] <- draws[[draws_list_id]][(num_warmup_draws+1):(num_warmup_draws + num_post_warmup_draws),,drop = FALSE]
+        } else {
+          draws[[draws_list_id]] <- NULL
         }
       }
-    } else {
-      draws[[length(draws) + 1]] <- NULL
     }
   }
   metadata$inv_metric <- NULL",True,False,Implementation / Logic,6
stan-dev,cmdstanr,e537e06afbf965a7ec8a69313db9514cdb31ca0d,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-03-17T19:22:37Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-03-17T19:22:37Z,fix typo,vignettes/opencl.Rmd,True,False,True,False,1,1,2,"---FILE: vignettes/opencl.Rmd---
@@ -93,7 +93,7 @@ and no OpenCL CPU runtime, the platform and device IDs of the GPU are typically
 both `0`, but the `clinfo` tool can be used to figure out for sure what devices
 are available.
 
-On an Ubuntu system with both CPU and GPU OpenCL support, `clinfo -l` outpus:
+On an Ubuntu system with both CPU and GPU OpenCL support, `clinfo -l` outputs:
 
 ```{bash eval=FALSE}
 Platform #0: AMD Accelerated Parallel Processing",False,True,Documentation / Formatting,4
stan-dev,cmdstanr,21024343fed7c48e1c9484688ddc38c84a0e1136,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-03-16T19:37:58Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-03-16T19:37:58Z,syntax fix,R/model.R,False,True,True,False,1,1,2,"---FILE: R/model.R---
@@ -713,7 +713,7 @@ sample <- function(data = NULL,
                    fixed_param = FALSE,
                    validate_csv = TRUE,
                    show_messages = TRUE,
-                   opencl_ids = NULL
+                   opencl_ids = NULL,
                    # deprecated
                    cores = NULL,
                    num_cores = NULL,",True,False,Implementation / Logic,6
stan-dev,cmdstanr,d05ccdc09609e988abceb4fe8d019a612475559a,wlandau,will.landau@gmail.com,2021-03-16T14:31:08Z,wlandau,will.landau@gmail.com,2021-03-16T14:31:08Z,Fix #467,NEWS.md;R/path.R;man/set_cmdstan_path.Rd;tests/testthat/test-path.R,False,True,True,False,32,3,35,"---FILE: NEWS.md---
@@ -28,6 +28,9 @@ Stan programs requires CmdStan >= 2.26. (#434)
 
 * Suppressing compilation messages when not in interactive mode. (#462, @wlandau)
 
+* Add a new `error_on_NA` argument to `cmdstan_version()` to optionally return `NULL`
+if the CmdStan path is not found (#467, @wlandau).
+
 # cmdstanr 0.3.0
 
 ### Bug fixes

---FILE: R/path.R---
@@ -63,8 +63,18 @@ cmdstan_path <- function() {
 
 #' @rdname set_cmdstan_path
 #' @export
-cmdstan_version <- function() {
-  .cmdstanr$VERSION %||% stop_no_path()
+#' @return CmdStan version string if available. If CmdStan
+#'   is not found and `error_on_NA` is `FALSE`,
+#'   `cmdstan_version()` returns `NULL`.
+#' @param error_on_NA Logical of length 1, whether to
+#'   throw an error if CmdStan is not found.
+#'   If `FALSE`, `cmdstan_version()` returns `NULL`.
+cmdstan_version <- function(error_on_NA = TRUE) {
+  version <- .cmdstanr$VERSION
+  if (is.null(version) && error_on_NA) {
+    stop_no_path()
+  }
+  version
 }
 
 

---FILE: man/set_cmdstan_path.Rd---
@@ -10,16 +10,24 @@ set_cmdstan_path(path = NULL)
 
 cmdstan_path()
 
-cmdstan_version()
+cmdstan_version(error_on_NA = TRUE)
 }
 \arguments{
 \item{path}{The full file path to the CmdStan installation as a string. If
 \code{NULL} (the default) then the path is set to the default path used by
 \code{\link[=install_cmdstan]{install_cmdstan()}} if it exists.}
+
+\item{error_on_NA}{Logical of length 1, whether to
+throw an error if CmdStan is not found.
+If \code{FALSE}, \code{cmdstan_version()} returns \code{NULL}.}
 }
 \value{
 A string. Either the file path to the CmdStan installation or the
 CmdStan version number.
+
+CmdStan version string if available. If CmdStan
+is not found and \code{error_on_NA} is \code{FALSE},
+\code{cmdstan_version()} returns \code{NULL}.
 }
 \description{
 Use the \code{set_cmdstan_path()} function to tell CmdStanR where the

---FILE: tests/testthat/test-path.R---
@@ -86,6 +86,14 @@ test_that(""CmdStan version detected when setting path"", {
   expect_equal(cmdstan_version(), VERSION)
 })
 
+test_that(""cmdstan_version() behavior when version is not set"", {
+  version <- .cmdstanr$VERSION
+  on.exit(.cmdstanr$VERSION <- version)
+  .cmdstanr$VERSION <- NULL
+  expect_error(cmdstan_version())
+  expect_null(cmdstan_version(error_on_NA = FALSE))
+})
+
 test_that(""Warning message is thrown if can't detect version number"", {
   path <- testthat::test_path(""answers"") # valid path but not cmdstan
   expect_warning(",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,c7aedaaecdc150b59b0d9848542b8084c545d2f9,wlandau,will.landau@gmail.com,2021-03-10T21:40:42Z,wlandau,will.landau@gmail.com,2021-03-10T21:40:42Z,Fix #463,.github/workflows/R-CMD-check.yaml;.github/workflows/Test-coverage.yaml,False,False,False,False,40,2,42,"---FILE: .github/workflows/R-CMD-check.yaml---
@@ -38,6 +38,11 @@ jobs:
       CMDSTAN_VERSION: ""2.26.1""
 
     steps:
+      - name: cmdstan env vars
+        run: |
+          echo ""CMDSTAN_PATH=${HOME}/.cmdstanr"" >> $GITHUB_ENV
+        shell: bash
+
       - uses: n1hility/cancel-previous-runs@v2
         with:
           token: ${{ secrets.GITHUB_TOKEN }}
@@ -93,7 +98,20 @@ jobs:
           install.packages(""posterior"", repos = c(""https://mc-stan.org/r-packages/"", getOption(""repos"")), type=""source"")
           install.packages(""cmdstanr"", repos = c(""https://mc-stan.org/r-packages/"", getOption(""repos"")), type=""source"")
           install.packages(""curl"")
-          cmdstanr::install_cmdstan(cores = 2, overwrite = TRUE, version = Sys.getenv(""CMDSTAN_VERSION""))
+        shell: Rscript {0}
+
+      - name: Cache cmdstan
+        uses: actions/cache@v2
+        with:
+          path: ${{ env.CMDSTAN_PATH }}
+          key: ${{ runner.os }}-cmdstan-${{ env.CMDSTAN_VERSION }}
+          restore-keys: ${{ runner.os }}-cmdstan-
+
+      - name: Install cmdstan
+        run: |
+          version <- Sys.getenv(""CMDSTAN_VERSION"")
+          url <- sprintf(""https://github.com/stan-dev/cmdstan/releases/download/v%s/cmdstan-%s.tar.gz"", version, version)
+          cmdstanr::install_cmdstan(cores = 2, release_url = url)
         shell: Rscript {0}
 
       - name: Session info

---FILE: .github/workflows/Test-coverage.yaml---
@@ -20,7 +20,14 @@ jobs:
     env:
       GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
       NOT_CRAN: true
+      CMDSTAN_VERSION: ""2.26.1""
+
     steps:
+      - name: cmdstan env vars
+        run: |
+          echo ""CMDSTAN_PATH=${HOME}/.cmdstanr"" >> $GITHUB_ENV
+        shell: bash
+
       - uses: n1hility/cancel-previous-runs@v2
         with:
           token: ${{ secrets.GITHUB_TOKEN }}
@@ -53,12 +60,25 @@ jobs:
       - name: Install dependencies
         run: |
           install.packages(c(""posterior"", ""cmdstanr"", ""remotes"", ""curl""),repos = c(""https://mc-stan.org/r-packages/"", getOption(""repos"")), dependencies = TRUE)
-          cmdstanr::install_cmdstan(cores = 2, overwrite = TRUE)
           remotes::install_deps(dependencies = TRUE)
           remotes::install_cran(""covr"")
           remotes::install_cran(""gridExtra"")
         shell: Rscript {0}
 
+      - name: Cache cmdstan
+        uses: actions/cache@v2
+        with:
+          path: ${{ env.CMDSTAN_PATH }}
+          key: ${{ runner.os }}-cmdstan-${{ env.CMDSTAN_VERSION }}
+          restore-keys: ${{ runner.os }}-cmdstan-
+
+      - name: Install cmdstan
+        run: |
+          version <- Sys.getenv(""CMDSTAN_VERSION"")
+          url <- sprintf(""https://github.com/stan-dev/cmdstan/releases/download/v%s/cmdstan-%s.tar.gz"", version, version)
+          cmdstanr::install_cmdstan(cores = 2, release_url = url)
+        shell: Rscript {0}
+
       - name: Test coverage
         run: covr::codecov(type = ""all"")
         shell: Rscript {0}",False,False,Data / Input Handling,3
stan-dev,cmdstanr,8cc7d2b3a71aaa5ca0c8db531ee80ae4cf568fa5,wlandau,will.landau@gmail.com,2021-03-10T17:37:34Z,wlandau,will.landau@gmail.com,2021-03-10T17:37:34Z,Try to fix message tests,tests/testthat/helper-custom-expectations.R;tests/testthat/test-knitr.R;tests/testthat/test-model-compile.R,False,True,True,False,22,11,33,"---FILE: tests/testthat/helper-custom-expectations.R---
@@ -36,4 +36,12 @@ expect_gq_output <- function(object, num_chains = NULL) {
     }
   }
   expect_output(object, output)
-}
\ No newline at end of file
+}
+
+expect_interactive_message <- function(object, regexp = NULL) {
+  if (interactive()) {
+    expect_message(object = object, regexp = regexp)
+  } else {
+    expect_silent(object = object)
+  }
+}

---FILE: tests/testthat/test-knitr.R---
@@ -15,7 +15,7 @@ test_that(""eng_cmdstan works"", {
     cache = TRUE,
     cache.path = tempdir()
   ))
-  expect_message(eng_cmdstan(opts), ""Compiling Stan program"")
+  expect_interactive_message(eng_cmdstan(opts), ""Compiling Stan program"")
 
   opts$eval <- FALSE
   expect_silent(eng_cmdstan(opts))

---FILE: tests/testthat/test-model-compile.R---
@@ -33,8 +33,8 @@ test_that(""compile() method works"", {
   if (file.exists(exe)) {
     file.remove(exe)
   }
-  expect_message(mod$compile(quiet = TRUE), ""Compiling Stan program..."")
-  expect_message(mod$compile(quiet = TRUE), ""Model executable is up to date!"")
+  expect_interactive_message(mod$compile(quiet = TRUE), ""Compiling Stan program..."")
+  expect_interactive_message(mod$compile(quiet = TRUE), ""Model executable is up to date!"")
   checkmate::expect_file_exists(mod$hpp_file())
   checkmate::expect_file_exists(exe)
   file.remove(exe)
@@ -45,7 +45,10 @@ test_that(""compile() method works"", {
 test_that(""compile() method forces recompilation force_recompile = TRUE"", {
   skip_on_cran()
   mod$compile(quiet = TRUE)
-  expect_message(mod$compile(quiet = TRUE, force_recompile = TRUE), ""Compiling Stan program..."")
+  expect_interactive_message(
+    mod$compile(quiet = TRUE, force_recompile = TRUE),
+    ""Compiling Stan program...""
+  )
 })
 
 test_that(""compile() method forces recompilation if model modified"", {
@@ -56,7 +59,7 @@ test_that(""compile() method forces recompilation if model modified"", {
     mod$compile(quiet = TRUE)
   }
   Sys.setFileTime(mod$stan_file(), Sys.time() + 1) #touch file to trigger recompile
-  expect_message(mod$compile(quiet = TRUE), ""Compiling Stan program..."")
+  expect_interactive_message(mod$compile(quiet = TRUE), ""Compiling Stan program..."")
 })
 
 test_that(""compile() method works with spaces in path"", {
@@ -75,7 +78,7 @@ test_that(""compile() method works with spaces in path"", {
   if (file.exists(exe)) {
     file.remove(exe)
   }
-  expect_message(mod_spaces$compile(), ""Compiling Stan program..."")
+  expect_interactive_message(mod_spaces$compile(), ""Compiling Stan program..."")
   file.remove(stan_model_with_spaces)
   file.remove(exe)
   file.remove(dir_with_spaces)
@@ -111,7 +114,7 @@ test_that(""compilation works with include_paths"", {
     )
   )
 
-  expect_message(
+  expect_interactive_message(
     mod_w_include <- cmdstan_model(stan_file = stan_program_w_include, quiet = TRUE,
                                    include_paths = test_path(""resources"", ""stan"")),
     ""Compiling Stan program""
@@ -170,15 +173,15 @@ test_that(""switching threads on and off works without rebuild"", {
 test_that(""multiple cpp_options work"", {
   skip_on_cran()
   stan_file <- testing_stan_file(""bernoulli"")
-  expect_message(
+  expect_interactive_message(
     mod <- cmdstan_model(stan_file, cpp_options = list(""DUMMY_TEST2""=""1"", ""DUMMY_TEST2""=""1"",  ""DUMMY_TEST3""=""1""), force_recompile = TRUE),
     ""Compiling Stan program...""
   )
-  expect_message(
+  expect_interactive_message(
     mod$compile(cpp_options = list(""DUMMY_TEST2""=""1"", ""DUMMY_TEST2""=""1"",  ""DUMMY_TEST3""=""1""), force_recompile = TRUE),
     ""Compiling Stan program...""
   )
-  expect_message(
+  expect_interactive_message(
     mod$compile(cpp_options = list(), force_recompile = TRUE),
     ""Compiling Stan program...""
   )",True,False,Implementation / Logic,6
stan-dev,cmdstanr,42f39b7254c561a583fb6ef7644ae700e1556857,wlandau,will.landau@gmail.com,2021-03-10T16:33:07Z,wlandau,will.landau@gmail.com,2021-03-10T16:33:07Z,Fix #429,R/model.R,False,True,True,False,6,2,8,"---FILE: R/model.R---
@@ -422,15 +422,19 @@ compile <- function(quiet = TRUE,
   }
 
   if (!force_recompile) {
-    message(""Model executable is up to date!"")
+    if (interactive()) {
+      message(""Model executable is up to date!"")
+    }
     private$cpp_options_ <- cpp_options
     private$precompile_cpp_options_ <- NULL
     private$precompile_stanc_options_ <- NULL
     private$precompile_include_paths_ <- NULL
     self$exe_file(exe)
     return(invisible(self))
   } else {
-    message(""Compiling Stan program..."")
+    if (interactive()) {
+      message(""Compiling Stan program..."")
+    }
   }
 
   temp_stan_file <- tempfile(pattern = ""model-"", fileext = "".stan"")",True,False,Implementation / Logic,6
stan-dev,cmdstanr,fcaef87b8de25da5fdb6814b12cc1bf487ba4de0,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-03-05T13:48:12Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-03-05T13:48:12Z,"add NEWS.md, fix mac GHA issue",.github/workflows/cmdstan-tarball-check.yaml;NEWS.md,False,False,False,False,3,2,5,"---FILE: .github/workflows/cmdstan-tarball-check.yaml---
@@ -10,7 +10,7 @@ name: Custom CmdStan tarball unit tests
       tarball_url:
         description: 'CmdStan tarball URL to test with.'
         required: true
-        default: 'latest'
+        default: 'https://github.com/stan-dev/cmdstan/releases/download/v2.26.1/cmdstan-2.26.1.tar.gz'
 
 jobs:
   tarball-check:

---FILE: NEWS.md---
@@ -2,6 +2,8 @@
 
 ### Bug fixes
 
+* Fixed bug with spaces in path to the temporary folder on Windows. (#460)
+
 ### New features
 
 * New function `as_cmdstan_fit()` that creates CmdStanMCMC/MLE/VB objects
@@ -20,7 +22,6 @@ Stan programs requires CmdStan >= 2.26. (#434)
 
 * New check for invalid parameter names when supplying init values. (#452)
 
-
 # cmdstanr 0.3.0
 
 ### Bug fixes",False,False,Documentation / Formatting,4
stan-dev,cmdstanr,49bf006a24c7d9360fc8622d94cbf3f2499455db,Mike Lawrence,mike@axemneuro.com,2021-02-17T16:02:25Z,Mike Lawrence,mike@axemneuro.com,2021-02-17T16:02:25Z,better error warning & update news,NEWS.md;R/args.R;tests/testthat/test-model-init.R,False,True,True,False,4,4,8,"---FILE: NEWS.md---
@@ -18,6 +18,8 @@ Stan programs requires CmdStan >= 2.26. (#434)
 
 * New vignette on profiling Stan programs. (#435)
 
+* New check for invalid parameter names when supplying init values. (#452)
+
 
 # cmdstanr 0.3.0
 

---FILE: R/args.R---
@@ -716,7 +716,7 @@ process_init_list <- function(init, num_procs) {
     stop(""'init' contains empty lists."", call. = FALSE)
   }
   if (any(grepl(""\\["",names(unlist(init))))) {
-    stop(""'init' contains entries with parameter names that include square-brackets, which is not permitted. To supply inits for a multi-element parameter, create a single entry with the parameter's name in the init list and use c()/matrix()/etc to specify the values."", call. = FALSE)
+    stop(""'init' contains entries with parameter names that include square-brackets, which is not permitted. To supply inits for a vector, matrix or array of parameters, create a single entry with the parameter's name in the init list and specify init values for the entire parameter container."", call. = FALSE)
   }
   init_paths <-
     tempfile(

---FILE: tests/testthat/test-model-init.R---
@@ -166,9 +166,7 @@ test_that(""error if init list is specified incorrectly"", {
   init_list[[2]] = init_list[[1]]
   expect_error(
     mod_logistic$sample(data = data_list_logistic, chains = 2, init = init_list),
-    ""'init' contains entries with parameter names that include square-brackets, which is not permitted. To supply inits for a multi-element parameter, create a single entry with the parameter's name in the init list and use c()/matrix()/etc to specify the values."",
-    fixed = TRUE
-
+    ""'init' contains entries with parameter names that include square-brackets, which is not permitted. To supply inits for a vector, matrix or array of parameters, create a single entry with the parameter's name in the init list and specify init values for the entire parameter container.""
   )
 
 })",True,False,Implementation / Logic,6
stan-dev,cmdstanr,7907cec23aab1033ba94c13e70446b80f696d47b,Mike Lawrence,mike@axemneuro.com,2021-02-17T14:13:14Z,Mike Lawrence,mike@axemneuro.com,2021-02-17T14:13:14Z,error messages with parens needs fixed=T,tests/testthat/test-model-init.R,False,True,True,False,3,1,4,"---FILE: tests/testthat/test-model-init.R---
@@ -166,7 +166,9 @@ test_that(""error if init list is specified incorrectly"", {
   init_list[[2]] = init_list[[1]]
   expect_error(
     mod_logistic$sample(data = data_list_logistic, chains = 2, init = init_list),
-    ""'init' contains entries with parameter names that include square-brackets, which is not permitted. To supply inits for a multi-element parameter, create a single entry with the parameter's name in the init list and use c()/matrix()/etc to specify the values.""
+    ""'init' contains entries with parameter names that include square-brackets, which is not permitted. To supply inits for a multi-element parameter, create a single entry with the parameter's name in the init list and use c()/matrix()/etc to specify the values."",
+    fixed = TRUE
+
   )
 
 })",True,False,Implementation / Logic,3
stan-dev,cmdstanr,18495d2ff0a44041353201ef5dda785d00157d19,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-02-15T18:40:09Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-02-15T18:40:09Z,fix for model name with spaces,R/csv.R,False,True,True,False,4,4,8,"---FILE: R/csv.R---
@@ -223,9 +223,9 @@ read_cmdstan_csv <- function(files,
     if (length(col_select) > 0) {
       if (os_is_windows()) {
         grep_path <- repair_path(Sys.which(""grep.exe""))
-        fread_cmd <- paste0(grep_path, "" -v '^#' --color=never "", output_file)
+        fread_cmd <- paste0(grep_path, "" -v '^#' --color=never '"", output_file, ""'"")
       } else {
-        fread_cmd <- paste0(""grep -v '^#' --color=never "", output_file)
+        fread_cmd <- paste0(""grep -v '^#' --color=never '"", output_file, ""'"")
       }
       suppressWarnings(
       draws <- data.table::fread(
@@ -512,9 +512,9 @@ read_csv_metadata <- function(csv_file) {
   total_time <- 0
   if (os_is_windows()) {
     grep_path <- repair_path(Sys.which(""grep.exe""))
-    fread_cmd <- paste0(grep_path, "" '^[#a-zA-Z]' --color=never "", csv_file)
+    fread_cmd <- paste0(grep_path, "" '^[#a-zA-Z]' --color=never '"", csv_file, ""'"")
   } else {
-    fread_cmd <- paste0(""grep '^[#a-zA-Z]' --color=never "", csv_file)
+    fread_cmd <- paste0(""grep '^[#a-zA-Z]' --color=never '"", csv_file, ""'"")
   }
   suppressWarnings(
     metadata <- data.table::fread(",True,False,Implementation / Logic,6
stan-dev,cmdstanr,c7444e203db4a08931b5bf5608089a5f0abd2fb8,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-02-05T13:44:04Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-02-05T13:44:04Z,fix missing colon,R/run.R,False,True,True,False,1,1,2,"---FILE: R/run.R---
@@ -927,7 +927,7 @@ CmdStanMCMCProcs <- R6::R6Class(
             cat(""The remaining chains had a mean execution time of"",
                 format(round(mean(self$total_time()), 1), nsmall = 1),
                 ""seconds.\n"")
-            warning(""The returned fit object will only read in results of successful chains. ""
+            warning(""The returned fit object will only read in results of successful chains. "",
               ""Please use read_cmdstan_csv() to read the results of the failed chains separately."",
               ""Use the $output(chain_id) method for more output of the failed chains.""
               immediate. = TRUE,",True,False,Implementation / Logic,6
stan-dev,cmdstanr,83c2721f0c38deb9dd77a0437f95d66e914ba7c2,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-02-05T13:36:45Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-02-05T13:36:45Z,fix inconsistent use of ',R/run.R,False,True,True,False,8,8,16,"---FILE: R/run.R---
@@ -759,7 +759,7 @@ CmdStanProcs <- R6::R6Class(
     },
     report_time = function(id = NULL) {
       if (self$proc_state(id) == 7) {
-        warning(""Fitting finished unexpectedly! Use the '$output()' method for more information.\n"", immediate. = TRUE, call. = FALSE)
+        warning(""Fitting finished unexpectedly! Use the $output() method for more information.\n"", immediate. = TRUE, call. = FALSE)
       } else {
         cat(""Finished in "",
             format(round(self$total_time(), 1), nsmall = 1),
@@ -916,8 +916,8 @@ CmdStanMCMCProcs <- R6::R6Class(
                 format(round(self$total_time(), 1), nsmall = 1),
                 ""seconds.\n"")
           } else if (num_failed == num_chains) {
-            warning(""All chains finished unexpectedly! Use the '$output(chain_id)' method for more information.\n"", call. = FALSE)
-            warning(""Use 'read_cmdstan_csv()' to read the results of the failed chains."",
+            warning(""All chains finished unexpectedly! Use the $output(chain_id) method for more information.\n"", call. = FALSE)
+            warning(""Use read_cmdstan_csv() to read the results of the failed chains."",
                     immediate. = TRUE,
                     call. = FALSE)
           } else {
@@ -928,8 +928,8 @@ CmdStanMCMCProcs <- R6::R6Class(
                 format(round(mean(self$total_time()), 1), nsmall = 1),
                 ""seconds.\n"")
             warning(""The returned fit object will only read in results of successful chains. ""
-              ""Please use 'read_cmdstan_csv()' to read the results of the failed chains separately."",
-              ""Use the '$output(chain_id)' method for more output of the failed chains.""
+              ""Please use read_cmdstan_csv() to read the results of the failed chains separately."",
+              ""Use the $output(chain_id) method for more output of the failed chains.""
               immediate. = TRUE,
               call. = FALSE)
           }
@@ -1010,7 +1010,7 @@ CmdStanGQProcs <- R6::R6Class(
           } else if (num_failed == num_chains) {
             warning(""All chains finished unexpectedly!\n"", call. = FALSE)
             warning(""Use read_cmdstan_csv() to read the results of the failed chains."",
-                    ""Use '$output(chain_id)' on the fit object for more output of the failed chains.""
+                    ""Use $output(chain_id) on the fit object for more output of the failed chains.""
                     immediate. = TRUE,
                     call. = FALSE)
           } else {
@@ -1020,9 +1020,9 @@ CmdStanGQProcs <- R6::R6Class(
             cat(""The remaining chains had a mean execution time of"",
                 format(round(mean(self$total_time()), 1), nsmall = 1),
                 ""seconds.\n"")
-            warning(""The returned fit object will only read in results of successful chains. ""
+            warning(""The returned fit object will only read in results of successful chains. "",
                     ""Please use read_cmdstan_csv() to read the results of the failed chains separately."",
-                    ""Use '$output(chain_id)' on the fit object for more output of the failed chains.""
+                    ""Use $output(chain_id) on the fit object for more output of the failed chains.""
                     immediate. = TRUE,
                     call. = FALSE)
           }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,ff832c844389a25427d3642c873af2cee3719811,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-01-27T17:59:15Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-01-27T18:14:04Z,temporarily remove testing with R-devel on Windows (GHA can not install it - non-cmdstanr related issue),.github/workflows/R-CMD-check.yaml,False,False,False,False,1,1,2,"---FILE: .github/workflows/R-CMD-check.yaml---
@@ -25,7 +25,7 @@ jobs:
         config:
           - {os: macOS-latest, r: 'devel'}
           - {os: macOS-latest, r: 'release'}
-          - {os: windows-latest, r: 'devel'}
+          # - {os: windows-latest, r: 'devel'}
           - {os: windows-latest, r: 'release'}
           - {os: windows-latest, r: 'oldrel'}
           - {os: ubuntu-20.04, r: 'devel'}",False,False,Data / Input Handling,3
stan-dev,cmdstanr,369a3eb820d134a4a54bc25e31edfcb421967733,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-01-25T19:56:53Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-01-25T19:56:53Z,temporary fix for RC tests,tests/testthat/test-install.R,False,True,True,False,1,1,2,"---FILE: tests/testthat/test-install.R---
@@ -59,7 +59,7 @@ test_that(""install_cmdstan() errors if it times out"", {
   } else {
     dir <- tempdir(check = TRUE)
   }
-  ver <- latest_released_version()
+  ver <- ""2.26.0-rc1"" #latest_released_version()
   dir_exists <- dir.exists(file.path(dir, paste0(""cmdstan-"",ver)))
   # with quiet=TRUE
   expect_warning(",True,False,Implementation / Logic,6
stan-dev,cmdstanr,d9a3b6e90a35bf8f80cfca2273ef48c35659a10c,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-01-23T19:57:46Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-01-23T19:57:46Z,a different fix,tests/testthat/test-install.R,False,True,True,False,1,4,5,"---FILE: tests/testthat/test-install.R---
@@ -30,7 +30,6 @@ test_that(""install_cmdstan() successfully installs cmdstan"", {
 test_that(""install_cmdstan() errors if installation already exists"", {
   skip_if_offline()
   skip_on_cran()
-  skip_if(grepl(""rc.+$"", cmdstanr::cmdstan_path()))
   if (not_on_cran()) {
     # want to test passing NULL to install_cmdstan but need a real dir to
     # check in dir.exists() below so also create dir_check
@@ -39,14 +38,12 @@ test_that(""install_cmdstan() errors if installation already exists"", {
     install_dir <- tempdir()
   }
   dir <- file.path(install_dir, ""cmdstan-2.23.0"")
-  fake_folder <- FALSE
   if (!dir.exists(dir)) {
-    fake_folder <- TRUE
     dir.create(dir)
   }
   expect_warning(
     install_cmdstan(dir = install_dir, overwrite = FALSE,
-                    release_url = cmdstan_test_tarball_url),
+                    version = ""2.23.0""),
     ""An installation already exists"",
     fixed = TRUE
   )",True,False,Implementation / Logic,6
stan-dev,cmdstanr,ecb0200ed2595b248234317869556755d21aec91,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-01-23T17:25:49Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-01-23T17:25:49Z,temporary fix for test,tests/testthat/test-install.R,False,True,True,False,3,1,4,"---FILE: tests/testthat/test-install.R---
@@ -1,7 +1,9 @@
 context(""install"")
 
 if (not_on_cran()) {
-  cmdstan_test_tarball_url <- Sys.getenv(""CMDSTAN_TEST_TARBALL_URL"")
+  #cmdstan_test_tarball_url <- Sys.getenv(""CMDSTAN_TEST_TARBALL_URL"")
+  cmdstan_test_tarball_url <- 
+    ""https://github.com/stan-dev/cmdstan/releases/download/v2.26.0-rc1/cmdstan-2.26.0-rc1.tar.gz""
   if (!nzchar(cmdstan_test_tarball_url)) {
     cmdstan_test_tarball_url <- NULL
   }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,e7bd9240f4ece63f21e83d767ae15a1ff4d7d5a0,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-01-21T19:49:58Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-01-21T19:49:58Z,fix syntax,R/run.R,False,True,True,False,1,1,2,"---FILE: R/run.R---
@@ -70,7 +70,7 @@ CmdStanRun <- R6::R6Class(
       }
     },
     profile_files = function(include_failed = FALSE) {
-      if (!length(private$profile_files_))
+      if (!length(private$profile_files_)) {
         stop(
           ""No profile files found. "",
           ""The model that produced the fit did not use any profiling."",",True,False,Implementation / Logic,6
stan-dev,cmdstanr,eecb8a94952216830780eafcfa8b4e9781712369,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-01-21T18:52:50Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-01-21T18:52:50Z,fix profile_file NA bug,R/run.R,False,True,True,False,1,1,2,"---FILE: R/run.R---
@@ -258,7 +258,7 @@ CmdStanRun <- R6::R6Class(
   ),
   private = list(
     output_files_ = character(),
-    profile_files_ = character(),
+    profile_files_ = NULL,
     output_files_saved_ = FALSE,
     latent_dynamics_files_ = NULL,
     latent_dynamics_files_saved_ = FALSE,",True,False,Implementation / Logic,6
stan-dev,cmdstanr,43a3487d97d017c1747753b88db960738d99cabe,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-01-21T16:59:47Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-01-21T17:58:56Z,fix tests,tests/testthat/test-fit-shared.R;tests/testthat/test-profiling.R,False,True,True,False,1,22,23,"---FILE: tests/testthat/test-fit-shared.R---
@@ -399,23 +399,3 @@ test_that(""sig_figs works with all methods"", {
     c(0.12, 0.12345, 0.123456789)
   )
 })
-
-test_that(""profiling errors if no profiling files are present"", {
-  skip_on_cran()
-  mod <- testing_model(""logistic"")
-  suppressWarnings(
-    utils::capture.output(
-      fit <- mod$sample(data = testing_data(""logistic""), refresh = 0)
-    )
-  )
-  expect_error(
-    fit$profile_files(),
-    ""No profile files found. The model that produced the fit did not use any profiling."",
-    fixed = TRUE
-  )
-
-# expect_error(fit$profiles(),
-#              ""No profile files found. The model that produced the fit did not use any profiling."")
-# expect_error(fit$save_profile_files(),
-#              ""No profile files found. The model that produced the fit did not use any profiling."")
-})

---FILE: tests/testthat/test-profiling.R---
@@ -34,7 +34,7 @@ test_that(""profiling errors if no profiling files are present"", {
                ""No profile files found. The model that produced the fit did not use any profiling."")
 })
 
-test_that(""saving diagnostic csv output works"", {
+test_that(""saving profile csv output works"", {
   skip_on_cran()
   mod <- testing_model(""logistic_profiling"")
   utils::capture.output(
@@ -52,4 +52,3 @@ test_that(""saving diagnostic csv output works"", {
 
   expect_false(any(file.exists(old_paths)))
 })
-",True,False,Environment / Configuration,3
stan-dev,cmdstanr,3632e52a94303b3eb42f873f478c38075868f6f0,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-01-21T16:26:38Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-01-21T16:26:38Z,fix test,tests/testthat/test-profiling.R,False,True,True,False,4,0,4,"---FILE: tests/testthat/test-profiling.R---
@@ -1,3 +1,7 @@
+if (not_on_cran()) {
+  set_cmdstan_path()
+}
+
 test_that(""profiling works if profiling data is present"", {
   skip_on_cran()
   mod <- testing_model(""logistic_profiling"")",True,False,Implementation / Logic,3
stan-dev,cmdstanr,abf779150c8380b36aee86de0b060914ec34e5e2,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-01-21T14:56:10Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-01-21T14:56:10Z,fix finalizing,R/args.R;R/run.R;tests/testthat/test-fit-shared.R;tests/testthat/test-profiling.R,False,True,True,False,32,10,42,"---FILE: R/args.R---
@@ -147,7 +147,7 @@ CmdStanArgs <- R6::R6Class(
         args$output <- c(args$output, paste0(""sig_figs="", self$sig_figs))
       }
 
-      if (!is.null(file)) {
+      if (!is.null(profile_file)) {
         args$output <- c(args$output, paste0(""profile_file="", profile_file))
       }
 

---FILE: R/run.R---
@@ -78,7 +78,7 @@ CmdStanRun <- R6::R6Class(
         )
       }
       if (include_failed) {
-        private$profile_files_[]
+        private$profile_files_[file.exists(private$profile_files_)]
       } else {
         ok <- self$procs$is_finished() | self$procs$is_queued()
         private$profile_files_[ok && file.exists(private$profile_files_)]
@@ -277,7 +277,7 @@ CmdStanRun <- R6::R6Class(
           if (self$args$save_latent_dynamics && !private$latent_dynamics_files_saved_)
             self$latent_dynamics_files(include_failed = TRUE),
           if (cmdstan_version() > ""2.25.0"" && !private$profile_files_saved_)
-            self$profile_files(include_failed = TRUE)
+            private$profile_files_[file.exists(private$profile_files_)]
         )
         unlink(temp_files)
       }

---FILE: tests/testthat/test-fit-shared.R---
@@ -399,3 +399,23 @@ test_that(""sig_figs works with all methods"", {
     c(0.12, 0.12345, 0.123456789)
   )
 })
+
+test_that(""profiling errors if no profiling files are present"", {
+  skip_on_cran()
+  mod <- testing_model(""logistic"")
+  suppressWarnings(
+    utils::capture.output(
+      fit <- mod$sample(data = testing_data(""logistic""), refresh = 0)
+    )
+  )
+  expect_error(
+    fit$profile_files(),
+    ""No profile files found. The model that produced the fit did not use any profiling."",
+    fixed = TRUE
+  )
+
+# expect_error(fit$profiles(),
+#              ""No profile files found. The model that produced the fit did not use any profiling."")
+# expect_error(fit$save_profile_files(),
+#              ""No profile files found. The model that produced the fit did not use any profiling."")
+})

---FILE: tests/testthat/test-profiling.R---
@@ -1,5 +1,3 @@
-context(""profiling"")
-
 test_that(""profiling works if profiling data is present"", {
   skip_on_cran()
   mod <- testing_model(""logistic_profiling"")
@@ -16,18 +14,22 @@ test_that(""profiling works if profiling data is present"", {
 test_that(""profiling errors if no profiling files are present"", {
   skip_on_cran()
   mod <- testing_model(""logistic"")
-  utils::capture.output(
-    fit <- mod$sample(data = testing_data(""logistic""), refresh = 0)
+  suppressWarnings(
+    utils::capture.output(
+      fit <- mod$sample(data = testing_data(""logistic""), refresh = 0)
+    )
+  )
+  expect_error(
+    fit$profile_files(),
+    ""No profile files found. The model that produced the fit did not use any profiling."",
+    fixed = TRUE
   )
-  expect_error(fit$profile_files(),
-               ""No profile files found. The model that produced the fit did not use any profiling."")
   expect_error(fit$profiles(),
                ""No profile files found. The model that produced the fit did not use any profiling."")
   expect_error(fit$save_profile_files(),
                ""No profile files found. The model that produced the fit did not use any profiling."")
 })
 
-
 test_that(""saving diagnostic csv output works"", {
   skip_on_cran()
   mod <- testing_model(""logistic_profiling"")",True,False,Implementation / Logic,6
stan-dev,cmdstanr,087cfbd3e1216707ffcd11deec198c494bf95328,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-01-21T12:14:47Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-01-21T12:14:47Z,"fix case when the files do not exist
add tests",R/run.R;tests/testthat/test-profiling.R,False,True,True,False,25,17,42,"---FILE: R/run.R---
@@ -70,15 +70,18 @@ CmdStanRun <- R6::R6Class(
       }
     },
     profile_files = function(include_failed = FALSE) {
-      if (cmdstan_version() < ""2.26"") {
-        stop(""Profiling is only available with CmdStan 2.26+!"")
+      if (!any(file.exists(private$profile_files_))) {
+        stop(
+          ""No profile files found. "",
+          ""The model that produced the fit did not use any profiling."",
+          call. = FALSE
+        )
       }
       if (include_failed) {
-        private$profile_files_[file.exists(private$profile_files_)]
+        private$profile_files_[]
       } else {
         ok <- self$procs$is_finished() | self$procs$is_queued()
-        ok_profile_files <- private$profile_files_[ok]
-        ok_profile_files[file.exists(ok_profile_files)]
+        private$profile_files_[ok && file.exists(private$profile_files_)]
       }
     },
     save_output_files = function(dir = ""."",

---FILE: tests/testthat/test-profiling.R---
@@ -1,24 +1,29 @@
-context(""read_cmdstan_csv"")
-
-if (not_on_cran()) {
-  set_cmdstan_path()
-  fit_logistic_no_profiling <- testing_fit(""logistic"", method = ""sample"", seed = 123)
-  fit_logistic_profiling <- testing_fit(""logistic_profiling"", method = ""sample"", seed = 123)
-}
+context(""profiling"")
 
 test_that(""profiling works if profiling data is present"", {
   skip_on_cran()
-  expect_equal(length(fit_logistic_profiling$profile_files()), 4)
-  profiles <- fit_logistic_profiling$profiles()
+  mod <- testing_model(""logistic_profiling"")
+  utils::capture.output(
+    fit <- mod$sample(data = testing_data(""logistic_profiling""), refresh = 0)
+  )
+  expect_equal(length(fit$profile_files()), 4)
+  profiles <- fit$profiles()
   expect_equal(length(profiles), 4)
   expect_equal(dim(profiles[[1]]), c(3,9))
   expect_equal(profiles[[1]][,""name""], c(""glm"", ""priors"", ""udf""))
 })
 
 test_that(""profiling works if no profiling data is present"", {
   skip_on_cran()
-  expect_equal(fit_logistic_no_profiling$profile_files(), character(0))
-  profiles <- fit_logistic_no_profiling$profiles()
-  expect_equal(length(profiles), 0)
+  mod <- testing_model(""logistic"")
+  utils::capture.output(
+    fit <- mod$sample(data = testing_data(""logistic""), refresh = 0)
+  )
+  expect_error(fit$profile_files(),
+               ""No profile files found. The model that produced the fit did not use any profiling."")
+  expect_error(fit$profiles(),
+               ""No profile files found. The model that produced the fit did not use any profiling."")
+  expect_error(fit$save_profile_files(),
+               ""No profile files found. The model that produced the fit did not use any profiling."")
 })
 ",True,False,Implementation / Logic,6
stan-dev,cmdstanr,4e1100ebf1bfaeebac45ca5cc9e1b159dd896e52,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-01-20T20:02:34Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-01-20T20:02:34Z,fix finalize,R/run.R,False,True,True,False,2,2,4,"---FILE: R/run.R---
@@ -269,8 +269,8 @@ CmdStanRun <- R6::R6Class(
             self$output_files(include_failed = TRUE),
           if (self$args$save_latent_dynamics && !private$latent_dynamics_files_saved_)
             self$latent_dynamics_files(include_failed = TRUE),
-          if (self$args$save_profile_files && !private$profile_files_saved_)
-            self$save_profile_files(include_failed = TRUE)
+          if (cmdstan_version() > ""2.25.0"" && !private$profile_files_saved_)
+            self$profile_files(include_failed = TRUE)
         )
         unlink(temp_files)
       }",True,False,Implementation / Logic,3
stan-dev,cmdstanr,e4d5f0427765cf5689fb0b8b29532185aa341d6c,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-01-20T19:39:19Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-01-20T19:39:19Z,fix profile_file arg,R/args.R,False,True,True,False,1,1,2,"---FILE: R/args.R---
@@ -148,7 +148,7 @@ CmdStanArgs <- R6::R6Class(
       }
 
       if (!is.null(file)) {
-        args$output <- c(args$output, paste0(""file="", profile_file))
+        args$output <- c(args$output, paste0(""profile_file="", profile_file))
       }
 
       args <- do.call(c, append(args, list(use.names = FALSE)))",True,False,Implementation / Logic,6
stan-dev,cmdstanr,08d65862ded1d08adc6319c02398657119c971a8,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-01-20T17:41:59Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-01-20T17:41:59Z,fix docs,R/args.R;R/fit.R;man/fit-method-save_output_files.Rd,False,True,True,False,19,9,28,"---FILE: R/args.R---
@@ -151,7 +151,6 @@ CmdStanArgs <- R6::R6Class(
         args$output <- c(args$output, paste0(""file="", profile_file))
       }
 
-
       args <- do.call(c, append(args, list(use.names = FALSE)))
       self$method_args$compose(idx, args)
     },

---FILE: R/fit.R---
@@ -401,7 +401,7 @@ CmdStanFit$set(""public"", name = ""cmdstan_diagnose"", value = cmdstan_diagnose)
 #'
 #' @name fit-method-save_output_files
 #' @aliases fit-method-save_data_file fit-method-save_latent_dynamics_files
-#'   fit-method-save_profile_files fit-method-output_files fit-method-data_file
+#'   fit-method-output_files fit-method-data_file fit-method-latent_dynamics_files
 #'   fit-method-latent_dynamics_files save_output_files save_data_file save_latent_dynamics_files
 #'   save_profile_files output_files data_file latent_dynamics_files profile_files
 #'
@@ -441,7 +441,6 @@ CmdStanFit$set(""public"", name = ""cmdstan_diagnose"", value = cmdstan_diagnose)
 #' For `$save_data_file()` no `id` is included in the file name because even
 #' with multiple MCMC chains the data file is the same.
 #' 
-#'
 #' @return
 #' The `$save_*` methods print a message with the new file paths and (invisibly)
 #' return a character vector of the new paths (or `NA` for any that couldn't be
@@ -483,7 +482,7 @@ save_latent_dynamics_files <- function(dir = ""."",
 }
 CmdStanFit$set(""public"", name = ""save_latent_dynamics_files"", value = save_latent_dynamics_files)
 
-#' @rdname fit-method-save_profile_files
+#' @rdname fit-method-save_output_files
 save_profile_files <- function(dir = ""."",
                                        basename = NULL,
                                        timestamp = TRUE,
@@ -502,29 +501,29 @@ save_data_file <- function(dir = ""."",
 CmdStanFit$set(""public"", name = ""save_data_file"", value = save_data_file)
 
 
-#' @rdname fit-method-output_files
+#' @rdname fit-method-save_output_files
 #' @param include_failed Should CmdStan runs that failed also be included? The
 #'   default is `FALSE.`
 output_files <- function(include_failed = FALSE) {
   self$runset$output_files(include_failed)
 }
 CmdStanFit$set(""public"", name = ""output_files"", value = output_files)
 
-#' @rdname fit-method-profile_files
+#' @rdname fit-method-save_output_files
 #' @param include_failed Should CmdStan runs that failed also be included? The
 #'   default is `FALSE.`
 profile_files <- function(include_failed = FALSE) {
   self$runset$profile_files(include_failed)
 }
 CmdStanFit$set(""public"", name = ""profile_files"", value = profile_files)
 
-#' @rdname fit-method-latent_dynamics_files
+#' @rdname fit-method-save_output_files
 latent_dynamics_files <- function(include_failed = FALSE) {
   self$runset$latent_dynamics_files(include_failed)
 }
 CmdStanFit$set(""public"", name = ""latent_dynamics_files"", value = latent_dynamics_files)
 
-#' @rdname fit-method-data_file
+#' @rdname fit-method-save_output_files
 data_file <- function() {
   self$runset$data_file()
 }

---FILE: man/fit-method-save_output_files.Rd---
@@ -5,7 +5,6 @@
 \alias{save_output_files}
 \alias{fit-method-save_data_file}
 \alias{fit-method-save_latent_dynamics_files}
-\alias{fit-method-save_profile_files}
 \alias{fit-method-output_files}
 \alias{fit-method-data_file}
 \alias{fit-method-latent_dynamics_files}
@@ -27,7 +26,17 @@ save_latent_dynamics_files(
   random = TRUE
 )
 
+save_profile_files(dir = ""."", basename = NULL, timestamp = TRUE, random = TRUE)
+
 save_data_file(dir = ""."", basename = NULL, timestamp = TRUE, random = TRUE)
+
+output_files(include_failed = FALSE)
+
+profile_files(include_failed = FALSE)
+
+latent_dynamics_files(include_failed = FALSE)
+
+data_file()
 }
 \arguments{
 \item{dir}{(string) Path to directory where the files should be saved.}
@@ -39,6 +48,9 @@ Defaults to \code{TRUE}. See \strong{Details}.}
 
 \item{random}{(logical) Should random alphanumeric characters be added to the
 end of the file name(s)? Defaults to \code{TRUE}. See \strong{Details}.}
+
+\item{include_failed}{Should CmdStan runs that failed also be included? The
+default is \code{FALSE.}}
 }
 \value{
 The \verb{$save_*} methods print a message with the new file paths and (invisibly)",True,False,Documentation / Formatting,7
stan-dev,cmdstanr,7dc229e3f2adff386e09b1be179a76cdcb5c4622,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-01-20T17:36:22Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-01-20T17:36:22Z,fix arg,R/args.R,False,True,True,False,3,3,6,"---FILE: R/args.R---
@@ -103,14 +103,14 @@ CmdStanArgs <- R6::R6Class(
     #' @param idx The run id. For MCMC this is the chain id, for optimization
     #'   this is just 1.
     #' @param output_file File path to csv file where output will be written.
-    #' @param file File path to csv file where profile data will be written.
+    #' @param profile_file File path to csv file where profile data will be written.
     #' @param latent_dynamics_file File path to csv file where the extra latent
     #'   dynamics information will be written.
     #' @return Character vector of arguments of the form ""name=value"".
     #'
     compose_all_args = function(idx = NULL,
                                 output_file = NULL,
-                                file = NULL,
+                                profile_file = NULL,
                                 latent_dynamics_file = NULL) {
       args <- list()
       idx <- idx %||% 1
@@ -148,7 +148,7 @@ CmdStanArgs <- R6::R6Class(
       }
 
       if (!is.null(file)) {
-        args$output <- c(args$output, paste0(""file="", file))
+        args$output <- c(args$output, paste0(""file="", profile_file))
       }
 
 ",True,False,Implementation / Logic,6
stan-dev,cmdstanr,14e1172b0046d6077d06e06d5354c3fceed70831,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-01-19T20:18:37Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-01-19T20:18:37Z,fix for prints,R/run.R,False,True,True,False,0,1,1,"---FILE: R/run.R---
@@ -774,7 +774,6 @@ CmdStanMCMCProcs <- R6::R6Class(
             next_state <- 1.5
           }
           if (state < 3 && grepl(""profile_file ="", line, perl = TRUE)) {
-            state <- 3
             next_state <- 3
           }
           if (state <= 3 && grepl(""Rejecting initial value:"", line, perl = TRUE)) {",True,False,Implementation / Logic,3
stan-dev,cmdstanr,9359ac7ef7d6947a9b9d7be408272cd47ee67422,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-01-19T18:04:35Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2021-01-19T18:28:10Z,test fixes for 2_26,R/run.R;tests/testthat/test-failed-chains.R;tests/testthat/test-fit-shared.R;tests/testthat/test-model-compile.R,False,True,True,False,11,4,15,"---FILE: R/run.R---
@@ -688,6 +688,9 @@ CmdStanProcs <- R6::R6Class(
           if (self$proc_state(id) == 2 && grepl(""refresh = "", line, perl = TRUE)) {
             self$set_proc_state(id, new_state = 2.5)
           }
+          if (self$proc_state(id) == 2.5 && grepl(""Exception:"", line, fixed = TRUE)) {
+            self$set_proc_state(id, new_state = 3)
+          }
           if (private$proc_state_[[id]] == 3.5) {
             message(line)
           } else if ((private$show_stdout_messages_ && private$proc_state_[[id]] >= 3) || is_verbose_mode()) {

---FILE: tests/testthat/test-failed-chains.R---
@@ -155,7 +155,6 @@ test_that(""init warnings are shown"", {
 
 test_that(""optimize error on bad data"", {
   mod <- testing_model(""bernoulli"")
-
   suppressWarnings(
     expect_output(
       mod$optimize(data = list(a = c(1,2,3))),
@@ -201,10 +200,15 @@ test_that(""gq chains error on wrong input CSV"", {
       ""Mismatch between model and fitted_parameters csv""
     )
   )
+  if (cmdstan_version() < ""2.26"") {
+    err_msg <- ""Error reading fitted param names""
+  } else {
+    err_msg <- ""Mismatch between model and fitted_parameters csv file""
+  }
   suppressWarnings(
     expect_output(
       mod$generate_quantities(data = data_list, fitted_params = test_path(""resources"", ""csv"", ""bernoulli-fail.csv"")),
-      ""Error reading fitted param names""
+      err_msg
     )
   )
   expect_warning(

---FILE: tests/testthat/test-fit-shared.R---
@@ -126,7 +126,7 @@ test_that(""cmdstan_summary() and cmdstan_diagnose() work correctly"", {
     } else if (method == ""generate_quantities"") {
       expect_error(fit$cmdstan_summary(), ""Not available for generate_quantities method"")
       expect_error(fit$cmdstan_diagnose(), ""Not available for generate_quantities method"")
-    } else {
+    } else if (method == ""sample"") {
       expect_output(fit$cmdstan_summary(), ""Inference for Stan model"")
       expect_output(fit$cmdstan_diagnose(), ""Processing complete"")
     }

---FILE: tests/testthat/test-model-compile.R---
@@ -275,7 +275,7 @@ test_that(""compiling stops on hyphens in stanc_options"", {
 test_that(""compiling works with only names in list"", {
   skip_on_cran()
   stan_file <- testing_stan_file(""bernoulli"")
-  mod <- cmdstan_model(stan_file, stanc_options = list(""allow-undefined"", ""warn-pedantic""), force_recompile = TRUE)
+  mod <- cmdstan_model(stan_file, stanc_options = list(""warn-pedantic""), force_recompile = TRUE, quiet = FALSE)
   checkmate::expect_r6(
     mod,
     ""CmdStanModel""",True,False,Implementation / Logic,6
stan-dev,cmdstanr,117c5eff95ba38ea25528fd20ba3c499890aa4cf,Hamada S. Badr,hamada.s.badr@gmail.com,2021-01-17T00:33:33Z,Hamada S. Badr,hamada.s.badr@gmail.com,2021-01-17T00:33:36Z,"GHA: cancel-previous-runs: Fix unexpected input

Unexpected input(s) 'workflow', valid inputs are ['token']",.github/workflows/R-CMD-check.yaml,False,False,False,False,0,1,1,"---FILE: .github/workflows/R-CMD-check.yaml---
@@ -40,7 +40,6 @@ jobs:
       - uses: n1hility/cancel-previous-runs@v2
         with:
           token: ${{ secrets.GITHUB_TOKEN }}
-          workflow: R-CMD-check.yaml
         if: ""!startsWith(github.ref, 'refs/tags/') && github.ref != 'refs/heads/master'""
 
       - uses: actions/checkout@v2",False,False,Data / Input Handling,4
stan-dev,cmdstanr,125cea73d43114d9cb6cf6554f72687f237788eb,Hamada S. Badr,hamada.s.badr@gmail.com,2021-01-16T23:30:43Z,Hamada S. Badr,hamada.s.badr@gmail.com,2021-01-16T23:30:46Z,"GHA: Test-coverage: Fixe wrong indentation

```
.github/workflows/Test-coverage.yaml:91:15: [error] wrong indentation: expected 10 but found 14 (indentation)
```",.github/workflows/Test-coverage.yaml,False,False,False,False,1,1,2,"---FILE: .github/workflows/Test-coverage.yaml---
@@ -88,7 +88,7 @@ jobs:
 
       - uses: r-lib/actions/setup-r@master
         with:
-              r-version: 'release'
+          r-version: 'release'
 
       - uses: r-lib/actions/setup-pandoc@master
 ",False,False,Environment / Configuration,4
stan-dev,cmdstanr,c69b8b2239a3af422b7219e85db8f7cb5004fd54,Hamada S. Badr,hamada.s.badr@gmail.com,2021-01-16T22:58:08Z,Hamada S. Badr,hamada.s.badr@gmail.com,2021-01-16T22:58:20Z,"GHA: yaml: Lint all workflows

> yamllint -f parsable .github/workflows/R-CMD-check.yaml

```
.github/workflows/R-CMD-check.yaml:1:1: [warning] missing document start ""---"" (document-start)
.github/workflows/R-CMD-check.yaml:1:1: [warning] truthy value should be one of [false, true] (truthy)
.github/workflows/R-CMD-check.yaml:22:33: [error] too many spaces after comma (commas)
.github/workflows/R-CMD-check.yaml:23:33: [error] too many spaces after comma (commas)
.github/workflows/R-CMD-check.yaml:27:33: [error] too many spaces after comma (commas)
.github/workflows/R-CMD-check.yaml:28:33: [error] too many spaces after comma (commas)
.github/workflows/R-CMD-check.yaml:29:33: [error] too many spaces after comma (commas)
.github/workflows/R-CMD-check.yaml:40:81: [error] line too long (88 > 80 characters) (line-length)
.github/workflows/R-CMD-check.yaml:46:81: [error] line too long (124 > 80 characters) (line-length)
.github/workflows/R-CMD-check.yaml:47:1: [error] trailing spaces (trailing-spaces)
.github/workflows/R-CMD-check.yaml:57:1: [error] trailing spaces (trailing-spaces)
.github/workflows/R-CMD-check.yaml:72:81: [error] line too long (101 > 80 characters) (line-length)
.github/workflows/R-CMD-check.yaml:73:81: [error] line too long (103 > 80 characters) (line-length)
.github/workflows/R-CMD-check.yaml:81:81: [error] line too long (111 > 80 characters) (line-length)
.github/workflows/R-CMD-check.yaml:82:81: [error] line too long (81 > 80 characters) (line-length)
.github/workflows/R-CMD-check.yaml:88:81: [error] line too long (120 > 80 characters) (line-length)
.github/workflows/R-CMD-check.yaml:89:81: [error] line too long (119 > 80 characters) (line-length)
.github/workflows/R-CMD-check.yaml:104:81: [error] line too long (176 > 80 characters) (line-length)
```

> yamllint -f parsable .github/workflows/cmdstan-tarball-check.yaml

```
.github/workflows/cmdstan-tarball-check.yaml:1:1: [warning] missing document start ""---"" (document-start)
.github/workflows/cmdstan-tarball-check.yaml:1:1: [warning] truthy value should be one of [false, true] (truthy)
.github/workflows/cmdstan-tarball-check.yaml:1:4: [error] trailing spaces (trailing-spaces)
.github/workflows/cmdstan-tarball-check.yaml:21:33: [error] too many spaces after comma (commas)
.github/workflows/cmdstan-tarball-check.yaml:23:33: [error] too many spaces after comma (commas)
.github/workflows/cmdstan-tarball-check.yaml:35:81: [error] line too long (124 > 80 characters) (line-length)
.github/workflows/cmdstan-tarball-check.yaml:36:1: [error] trailing spaces (trailing-spaces)
.github/workflows/cmdstan-tarball-check.yaml:46:1: [error] trailing spaces (trailing-spaces)
.github/workflows/cmdstan-tarball-check.yaml:60:81: [error] line too long (101 > 80 characters) (line-length)
.github/workflows/cmdstan-tarball-check.yaml:61:81: [error] line too long (103 > 80 characters) (line-length)
.github/workflows/cmdstan-tarball-check.yaml:69:81: [error] line too long (111 > 80 characters) (line-length)
.github/workflows/cmdstan-tarball-check.yaml:70:81: [error] line too long (81 > 80 characters) (line-length)
.github/workflows/cmdstan-tarball-check.yaml:76:81: [error] line too long (120 > 80 characters) (line-length)
.github/workflows/cmdstan-tarball-check.yaml:77:81: [error] line too long (119 > 80 characters) (line-length)
.github/workflows/cmdstan-tarball-check.yaml:81:81: [error] line too long (122 > 80 characters) (line-length)
.github/workflows/cmdstan-tarball-check.yaml:95:81: [error] line too long (176 > 80 characters) (line-length)
```

> yamllint -f parsable .github/workflows/Test-coverage.yaml

```
.github/workflows/Test-coverage.yaml:1:1: [warning] missing document start ""---"" (document-start)
.github/workflows/Test-coverage.yaml:1:1: [warning] truthy value should be one of [false, true] (truthy)
.github/workflows/Test-coverage.yaml:24:81: [error] line too long (88 > 80 characters) (line-length)
.github/workflows/Test-coverage.yaml:33:81: [error] line too long (87 > 80 characters) (line-length)
.github/workflows/Test-coverage.yaml:38:81: [error] line too long (101 > 80 characters) (line-length)
.github/workflows/Test-coverage.yaml:50:81: [error] line too long (159 > 80 characters) (line-length)
.github/workflows/Test-coverage.yaml:73:81: [error] line too long (124 > 80 characters) (line-length)
.github/workflows/Test-coverage.yaml:87:15: [error] wrong indentation: expected 10 but found 14 (indentation)
.github/workflows/Test-coverage.yaml:94:81: [error] line too long (101 > 80 characters) (line-length)
.github/workflows/Test-coverage.yaml:99:81: [error] line too long (159 > 80 characters) (line-length)
```",.github/workflows/R-CMD-check.yaml;.github/workflows/Test-coverage.yaml;.github/workflows/cmdstan-tarball-check.yaml,False,False,False,False,26,14,40,"---FILE: .github/workflows/R-CMD-check.yaml---
@@ -1,4 +1,8 @@
-on:
+---
+# Github Actions workflow to check CmdStanR
+# yamllint disable rule:line-length
+
+'on':
   push:
     branches:
       - master
@@ -19,14 +23,14 @@ jobs:
       fail-fast: true
       matrix:
         config:
-          - {os: macOS-latest,   r: 'devel'}
-          - {os: macOS-latest,   r: 'release'}
+          - {os: macOS-latest, r: 'devel'}
+          - {os: macOS-latest, r: 'release'}
           - {os: windows-latest, r: 'devel'}
           - {os: windows-latest, r: 'release'}
           - {os: windows-latest, r: 'oldrel'}
-          - {os: ubuntu-20.04,   r: 'devel'}
-          - {os: ubuntu-20.04,   r: 'release'}
-          - {os: ubuntu-20.04,   r: 'oldrel'}
+          - {os: ubuntu-20.04, r: 'devel'}
+          - {os: ubuntu-20.04, r: 'release'}
+          - {os: ubuntu-20.04, r: 'oldrel'}
     env:
       R_REMOTES_NO_ERRORS_FROM_WARNINGS: true
       GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
@@ -44,7 +48,7 @@ jobs:
       - name: Set path for RTools 4.0
         if: runner.os == 'Windows'
         run: echo ""C:/rtools40/usr/bin;C:/rtools40/mingw64/bin"" | Out-File -Append -FilePath $env:GITHUB_PATH -Encoding utf8
-      
+
       - name: Install mingw32-make and check toolchain path
         if: runner.os == 'Windows'
         run: |
@@ -54,7 +58,7 @@ jobs:
           mingw32-make --version
           Get-Command mingw32-make | Select-Object -ExpandProperty Definition
         shell: powershell
-      
+
       - name: Install MPI
         if: runner.os == 'Linux'
         run: |

---FILE: .github/workflows/Test-coverage.yaml---
@@ -1,4 +1,8 @@
-on:
+---
+# Github Actions workflow to analyze CmdStanR code, test coverage
+# yamllint disable rule:line-length
+
+'on':
   push:
     branches:
       - master

---FILE: .github/workflows/cmdstan-tarball-check.yaml---
@@ -1,4 +1,8 @@
-on: 
+---
+# Github Actions workflow to check CmdStanR tarball
+# yamllint disable rule:line-length
+
+'on':
   workflow_dispatch:
     inputs:
       tarball_url:
@@ -18,9 +22,9 @@ jobs:
       fail-fast: true
       matrix:
         config:
-          - {os: macOS-latest,   r: 'release'}
+          - {os: macOS-latest, r: 'release'}
           - {os: windows-latest, r: 'release'}
-          - {os: ubuntu-20.04,   r: 'release'}
+          - {os: ubuntu-20.04, r: 'release'}
     env:
       R_REMOTES_NO_ERRORS_FROM_WARNINGS: true
       GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
@@ -33,7 +37,7 @@ jobs:
       - name: Set path for RTools 4.0
         if: runner.os == 'Windows'
         run: echo ""C:/rtools40/usr/bin;C:/rtools40/mingw64/bin"" | Out-File -Append -FilePath $env:GITHUB_PATH -Encoding utf8
-      
+
       - name: Install mingw32-make and check toolchain path
         if: runner.os == 'Windows'
         run: |
@@ -43,7 +47,7 @@ jobs:
           mingw32-make --version
           Get-Command mingw32-make | Select-Object -ExpandProperty Definition
         shell: powershell
-      
+
       - name: Install MPI
         if: runner.os == 'Linux'
         run: |",False,False,Environment / Configuration,4
stan-dev,cmdstanr,ef3d394d3adaf013ba40c51f8d96f0634189ba60,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-12-28T16:25:36Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-12-28T16:25:36Z,fix test,tests/testthat/test-utils.R,False,True,True,False,10,10,20,"---FILE: tests/testthat/test-utils.R---
@@ -11,18 +11,18 @@ test_that(""check_divergences() works"", {
   csv_files <- c(test_path(""resources"", ""csv"", ""model1-2-no-warmup.csv""))
   csv_output <- read_cmdstan_csv(csv_files)
   output <- ""14 of 100 \\(14.0%\\) transitions ended with a divergence.""
-  expect_message(check_divergences(csv_contents$post_warmup_sampler_diagnostics), output)
+  expect_message(check_divergences(csv_output$post_warmup_sampler_diagnostics), output)
 
   csv_files <- c(test_path(""resources"", ""csv"", ""model1-2-no-warmup.csv""),
                  test_path(""resources"", ""csv"", ""model1-2-no-warmup.csv""))
   csv_output <- read_cmdstan_csv(csv_files)
   output <- ""28 of 200 \\(14.0%\\) transitions ended with a divergence.""
-  expect_message(check_divergences(csv_contents$post_warmup_sampler_diagnostics), output)
+  expect_message(check_divergences(csv_output$post_warmup_sampler_diagnostics), output)
 
   csv_files <- c(test_path(""resources"", ""csv"", ""model1-2-warmup.csv""))
   csv_output <- read_cmdstan_csv(csv_files)
   output <- ""1 of 100 \\(1.0%\\) transitions ended with a divergence.""
-  expect_message(check_divergences(csv_contents$post_warmup_sampler_diagnostics), output)
+  expect_message(check_divergences(csv_output$post_warmup_sampler_diagnostics), output)
 
 
   fit_wramup_no_samples <- testing_fit(""logistic"", method = ""sample"",
@@ -32,7 +32,7 @@ test_that(""check_divergences() works"", {
                           save_warmup = TRUE,
                           validate_csv = FALSE)
   csv_output <- read_cmdstan_csv(fit_wramup_no_samples$output_files())
-  expect_message(check_divergences(csv_contents$post_warmup_sampler_diagnostics), regexp = NA)
+  expect_message(check_divergences(csv_output$post_warmup_sampler_diagnostics), regexp = NA)
 })
 
 test_that(""check_sampler_transitions_treedepth() works"", {
@@ -42,8 +42,8 @@ test_that(""check_sampler_transitions_treedepth() works"", {
   output <- ""16 of 100 \\(16.0%\\) transitions hit the maximum treedepth limit of 5 or 2\\^5-1 leapfrog steps.""
   expect_message(
     check_sampler_transitions_treedepth(
-      csv_contents$post_warmup_sampler_diagnostics,
-      csv_contents$metadata),
+      csv_output$post_warmup_sampler_diagnostics,
+      csv_output$metadata),
     output
   )
 
@@ -53,8 +53,8 @@ test_that(""check_sampler_transitions_treedepth() works"", {
   output <- ""32 of 200 \\(16.0%\\) transitions hit the maximum treedepth limit of 5 or 2\\^5-1 leapfrog steps.""
   expect_message(
     check_sampler_transitions_treedepth(
-      csv_contents$post_warmup_sampler_diagnostics,
-      csv_contents$metadata),
+      csv_output$post_warmup_sampler_diagnostics,
+      csv_output$metadata),
     output
   )
 
@@ -63,8 +63,8 @@ test_that(""check_sampler_transitions_treedepth() works"", {
   output <- ""1 of 100 \\(1.0%\\) transitions hit the maximum treedepth limit of 5 or 2\\^5-1 leapfrog steps.""
   expect_message(
     check_sampler_transitions_treedepth(
-      csv_contents$post_warmup_sampler_diagnostics,
-      csv_contents$metadata),
+      csv_output$post_warmup_sampler_diagnostics,
+      csv_output$metadata),
     output
   )
 })",True,False,Implementation / Logic,6
stan-dev,cmdstanr,6d424ec5e135feb89465737331be04f84d87032f,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-12-27T09:41:44Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-12-27T09:47:02Z,apply same fix for GQ,R/csv.R,False,True,True,False,9,9,18,"---FILE: R/csv.R---
@@ -120,7 +120,11 @@ read_cmdstan_csv <- function(files,
                              sampler_diagnostics = NULL) {
   checkmate::assert_file_exists(files, access = ""r"", extension = ""csv"")
   metadata <- NULL
-  generated_quantities <- NULL
+  warmup_draws <- list()
+  post_warmup_draws <- list()
+  warmup_sampler_diagnostics_draws <- list()
+  post_warmup_sampler_diagnostics_draws <- list()
+  generated_quantities <- list()
   variational_draws <- NULL
   point_estimates <- NULL
   inv_metric <- list()
@@ -130,10 +134,6 @@ read_cmdstan_csv <- function(files,
   metadata <- NULL
   time <- data.frame()
   not_matching <- c()
-  warmup_draws <- list()
-  post_warmup_draws <- list()
-  warmup_sampler_diagnostics_draws <- list()
-  post_warmup_sampler_diagnostics_draws <- list()
   for (output_file in files) {
     if (is.null(metadata)) {
       metadata <- read_csv_metadata(output_file)
@@ -277,9 +277,7 @@ read_cmdstan_csv <- function(files,
       } else if (metadata$method == ""optimize"") {
         point_estimates <- posterior::as_draws_matrix(draws[1,, drop=FALSE])[, variables]
       } else if (metadata$method == ""generate_quantities"") {
-          generated_quantities <- posterior::bind_draws(generated_quantities,
-                                                        posterior::as_draws_array(draws),
-                                                        along=""chain"")
+        generated_quantities[[length(generated_quantities) + 1]] <- draws
       }
     }
   }
@@ -290,7 +288,6 @@ read_cmdstan_csv <- function(files,
   }
 
   metadata$inv_metric <- NULL
-  metadata$lines_to_skip <- NULL
   metadata$model_params <- repair_variable_names(metadata$model_params)
   repaired_variables <- repair_variable_names(variables)
   if (metadata$method == ""variational"") {
@@ -365,6 +362,9 @@ read_cmdstan_csv <- function(files,
     )
   } else if (metadata$method == ""generate_quantities"") {
     if (!is.null(generated_quantities)) {
+      generated_quantities <- lapply(generated_quantities, posterior::as_draws_array)
+      generated_quantities[[""along""]] <- ""chain""
+      generated_quantities <- do.call(posterior::bind_draws, generated_quantities)
       posterior::variables(generated_quantities) <- repaired_variables
     }
     list(",True,False,Implementation / Logic,6
stan-dev,cmdstanr,27fcc9bf47b8a7162ac05146705d0d97c0ea8d81,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-12-26T16:16:16Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-12-26T18:21:32Z,add fixed = TRUE,tests/testthat/test-install.R,False,True,True,False,11,6,17,"---FILE: tests/testthat/test-install.R---
@@ -1,5 +1,12 @@
 context(""install"")
 
+if (not_on_cran()) {
+  cmdstan_test_tarball_url <- Sys.getenv(""CMDSTAN_TEST_TARBALL_URL"")
+  if (!nzchar(cmdstan_test_tarball_url)) {
+    cmdstan_test_tarball_url <- NULL
+  }
+}
+
 test_that(""install_cmdstan() successfully installs cmdstan"", {
   skip_on_cran()
   skip_if_offline()
@@ -9,18 +16,15 @@ test_that(""install_cmdstan() successfully installs cmdstan"", {
   } else {
     dir <- tempdir(check = TRUE)
   }
-  cmdstan_test_tarball_url <- Sys.getenv(""CMDSTAN_TEST_TARBALL_URL"")
-  if (!nzchar(cmdstan_test_tarball_url)) {
-    cmdstan_test_tarball_url <- NULL
-  }
   expect_message(
     expect_output(
       install_cmdstan(dir = dir, cores = 2, quiet = FALSE, overwrite = TRUE,
                       release_url = cmdstan_test_tarball_url),
       ""Compiling, linking C++ code"",
       fixed = TRUE
     ),
-    ""CmdStan path set""
+    ""CmdStan path set"",
+    fixed = TRUE
   )
 })
 
@@ -44,7 +48,8 @@ test_that(""install_cmdstan() errors if installation already exists"", {
   expect_warning(
     install_cmdstan(dir = install_dir, overwrite = FALSE,
                     release_url = cmdstan_test_tarball_url),
-    ""An installation already exists""
+    ""An installation already exists"",
+    fixed = TRUE
   )
 })
 ",True,False,Implementation / Logic,6
stan-dev,cmdstanr,19b84d0be34a0b0bcc46157424b8e9315263c540,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-12-26T16:16:16Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-12-26T16:16:16Z,test fix - version on rebuild,tests/testthat/test-install.R,False,True,True,False,1,1,2,"---FILE: tests/testthat/test-install.R---
@@ -240,7 +240,7 @@ test_that(""clean and rebuild works"", {
   if (os_is_windows()) skip_on_covr()
   expect_output(
     rebuild_cmdstan(),
-    paste0(""CmdStan v"", latest_released_version(), "" built"")
+    paste0(""CmdStan v"", cmdstan_version(), "" built"")
   )
 })
 ",True,False,Implementation / Logic,3
stan-dev,cmdstanr,91800a147d7c443a45fac862ea72e3de2e4e4edd,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-12-26T15:30:25Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-12-26T15:30:25Z,fix names,R/install.R;tests/testthat/test-install.R,False,True,True,False,5,2,7,"---FILE: R/install.R---
@@ -289,7 +289,7 @@ check_install_dir <- function(dir_cmdstan, overwrite = FALSE) {
 
 github_auth_token <- function() {
   github_pat <- Sys.getenv(""GITHUB_PAT"")
-  if (nzchar(access_token)) {
+  if (nzchar(github_pat)) {
     auth_token <- c(Authorization = paste0(""token "", github_pat))
   } else {
     auth_token <- NULL

---FILE: tests/testthat/test-install.R---
@@ -9,7 +9,10 @@ test_that(""install_cmdstan() successfully installs cmdstan"", {
   } else {
     dir <- tempdir(check = TRUE)
   }
-  cmdstan_test_tarball_url <- getOption(""CMDSTAN_TEST_TARBALL_URL"")
+  cmdstan_test_tarball_url <- Sys.getenv(""CMDSTAN_TEST_TARBALL_URL"")
+  if (!nzchar(cmdstan_test_tarball_url)) {
+    cmdstan_test_tarball_url <- NULL
+  }
   expect_message(
     expect_output(
       install_cmdstan(dir = dir, cores = 2, quiet = FALSE, overwrite = TRUE,",True,False,Implementation / Logic,6
stan-dev,cmdstanr,5d3a7d70f63f46dd601a49543cea6689ea907a3f,jgabry,jgabry@gmail.com,2020-12-22T05:43:07Z,jgabry,jgabry@gmail.com,2020-12-22T05:43:07Z,fix some typos,R/install.R,False,True,True,False,4,5,9,"---FILE: R/install.R---
@@ -101,7 +101,7 @@ install_cmdstan <- function(dir = NULL,
       stop(release_url, "" is not a .tar.gz archive!"",
            ""cmdstanr supports installing from .tar.gz archives only."", call. = FALSE)
     }
-    message(""* Installing Cmdstan from "", release_url)
+    message(""* Installing CmdStan from "", release_url)
     download_url <- release_url
     split_url <- strsplit(release_url, ""/"")
     tar_name <- utils::tail(split_url[[1]], n=1)
@@ -126,12 +126,12 @@ install_cmdstan <- function(dir = NULL,
   tar_downloaded <- download_with_retries(download_url, dest_file)
   if (!tar_downloaded) {
     if (!is.null(version)) {
-      stop(""Download of Cmdstan failed. Please check if the supplied version number is valid."", call. = FALSE)
+      stop(""Download of CmdStan failed. Please check if the supplied version number is valid."", call. = FALSE)
     }
     if (!is.null(release_url)) {
-      stop(""Download of Cmdstan failed. Please check if the supplied release URL is valid."", call. = FALSE)
+      stop(""Download of CmdStan failed. Please check if the supplied release URL is valid."", call. = FALSE)
     }
-    stop(""Download of Cmdstan failed. Please try again."", call. = FALSE)
+    stop(""Download of CmdStan failed. Please try again."", call. = FALSE)
   }
   message(""* Download complete"")
 
@@ -270,7 +270,6 @@ cmdstan_make_local <- function(dir = cmdstan_path(),
 # internal ----------------------------------------------------------------
 
 check_install_dir <- function(dir_cmdstan, overwrite = FALSE) {
-  browser()
   if (dir.exists(dir_cmdstan)) {
     if (!overwrite) {
       warning(",True,False,Implementation / Logic,6
stan-dev,cmdstanr,67d1c5f6ed5026f7b4dc89b4d893f9289b34411b,jgabry,jgabry@gmail.com,2020-12-19T16:53:52Z,jgabry,jgabry@gmail.com,2020-12-19T16:53:52Z,trying fixing windows test coverage failure,.github/workflows/Test-coverage.yaml,False,False,False,False,1,0,1,"---FILE: .github/workflows/Test-coverage.yaml---
@@ -100,6 +100,7 @@ jobs:
           remotes::install_deps(dependencies = TRUE)
           remotes::install_cran(""covr"")
           remotes::install_cran(""gridExtra"")
+          remotes::install_cran(""knitr"")
         shell: Rscript {0}
 
       - name: Test coverage",False,False,Data / Input Handling,3
stan-dev,cmdstanr,670d1d1d178bf0be70807fbfc353788a934f38b4,jgabry,jgabry@gmail.com,2020-12-19T00:17:55Z,jgabry,jgabry@gmail.com,2020-12-19T00:17:55Z,fix more tests,R/fit.R;R/read_csv.R;tests/testthat/test-failed-chains.R,False,True,True,False,22,17,39,"---FILE: R/fit.R---
@@ -15,6 +15,11 @@ CmdStanFit <- R6::R6Class(
       self$runset$num_procs()
     },
     print = function(variables = NULL, ..., digits = 2, max_rows = 10) {
+      if (is.null(private$draws_) &&
+          !length(self$output_files(include_failed = FALSE))) {
+        stop(""Fitting failed. Unable to print."", call. = FALSE)
+      }
+
       # filter variables before passing to summary to avoid computing anything
       # that won't be printed because of max_rows
       all_variables <- self$metadata()$model_params
@@ -30,21 +35,20 @@ CmdStanFit <- R6::R6Class(
         total_rows <- length(matches$matching)
         variables_to_print <- matches$matching[seq_len(max_rows)]
       }
-
       # if max_rows > length(variables_to_print) some will be NA
       variables_to_print <- variables_to_print[!is.na(variables_to_print)]
 
       out <- self$summary(variables_to_print, ...)
       out <- as.data.frame(out)
-      out[, 1] <- format(out[, 1], justify = ""left"")
+      out[,  1] <- format(out[, 1], justify = ""left"")
       out[, -1] <- format(round(out[, -1], digits = digits), nsmall = digits)
       for (col in grep(""ess_"", colnames(out), value = TRUE)) {
         out[[col]] <- as.integer(out[[col]])
       }
 
       opts <- options(max.print = prod(dim(out)))
       on.exit(options(max.print = opts$max.print), add = TRUE)
-      base::print(out, row.names=FALSE)
+      base::print(out, row.names = FALSE)
       if (max_rows < total_rows) {
         cat(""\n # showing"", max_rows, ""of"", total_rows,
             ""rows (change via 'max_rows' argument)\n"")

---FILE: R/read_csv.R---
@@ -418,11 +418,11 @@ as_cmdstan_vb <- function(files) {
 # internal ----------------------------------------------------------------
 
 # CmdStanFit2 -------------------------------------------------------------
-#' Create a CmdStanMCMC/MLE/VB-ish objects from `read_cmdstan_csv()` output
+#' Create CmdStanMCMC/MLE/VB-ish objects from `read_cmdstan_csv()` output
 #' instead of from a CmdStanRun object
 #'
 #' The resulting object has fewer methods than a CmdStanMCMC/MLE/VB object
-#' because it doesn't have access to the CSV files directly.
+#' because it doesn't have a CmdStanRun object
 #'
 #' @noRd
 #'
@@ -483,16 +483,9 @@ CmdStanVB2 <- R6::R6Class(
   private = list(output_files_ = NULL)
 )
 
-error_unavailable_CmdStanFit2 <- function(...) {
-  fun <- switch(class(self)[1],
-                CmdStanMCMC2 = ""as_cmdstan_mcmc()"",
-                CmdStanMLE2 = ""as_cmdstan_mle()"",
-                CmdStanVB2 = ""as_cmdstan_vb()"")
-  stop(""This method is not available for objects created using "", fun, ""."",
-       call. = FALSE)
-}
-unavailable_methods_CmdStanFit2 <-
-  c(
+
+# these methods are unavailable because there's no CmdStanRun object
+unavailable_methods_CmdStanFit2 <- c(
     paste0(""cmdstan_"", c(""diagnose"", ""summary"")),
     ""data_file"", ""save_data_file"",
     ""latent_dynamics_files"", ""save_latent_dynamics_files"",
@@ -503,6 +496,14 @@ unavailable_methods_CmdStanFit2 <-
     ""time"",
     ""num_procs""
   )
+error_unavailable_CmdStanFit2 <- function(...) {
+  fun <- switch(class(self)[1],
+                CmdStanMCMC2 = ""as_cmdstan_mcmc()"",
+                CmdStanMLE2 = ""as_cmdstan_mle()"",
+                CmdStanVB2 = ""as_cmdstan_vb()"")
+  stop(""This method is not available for objects created using "", fun, ""."",
+       call. = FALSE)
+}
 for (method in unavailable_methods_CmdStanFit2) {
   CmdStanMCMC2$set(""public"", name = method, value = error_unavailable_CmdStanFit2)
   CmdStanMLE2$set(""public"", name = method, value = error_unavailable_CmdStanFit2)

---FILE: tests/testthat/test-failed-chains.R---
@@ -126,9 +126,9 @@ test_that(""errors when using draws after all chains fail"", {
   expect_error(fit_all_fail$sampler_diagnostics(), ""No chains finished successfully"")
   expect_error(fit_all_fail$cmdstan_summary(), ""Unable to run bin/stansummary"")
   expect_error(fit_all_fail$cmdstan_diagnose(), ""Unable to run bin/diagnose"")
-  expect_error(fit_all_fail$print(), ""Fitting failed. Unable to retrieve the metadata."")
+  expect_error(fit_all_fail$print(), ""Fitting failed. Unable to print"")
   expect_error(fit_all_fail$inv_metric(), ""No chains finished successfully"")
-  expect_error(fit_all_fail$metadata(), ""Fitting failed. Unable to retrieve the metadata."")
+  expect_error(fit_all_fail$metadata(), ""Fitting failed. Unable to retrieve the metadata"")
   expect_error(fit_all_fail$inv_metric(), ""No chains finished successfully"")
 })
 ",True,False,Implementation / Logic,6
stan-dev,cmdstanr,45491252184246b0c79a62c22f4bd85cdec41f06,jgabry,jgabry@gmail.com,2020-12-18T22:55:54Z,jgabry,jgabry@gmail.com,2020-12-18T22:55:54Z,fix another test,tests/testthat/test-csv.R,False,True,True,False,2,2,4,"---FILE: tests/testthat/test-csv.R---
@@ -482,12 +482,12 @@ test_that(""as_cmdstan_* functions created fitted model objects from csv"", {
     expect_s3_class(fit$draws(), ""draws"")
     checkmate::expect_numeric(fit$lp())
     expect_output(fit$print(), ""variable"")
-    expect_length(fit$output_files(), if (method == ""mcmc"") fit$num_chains() else 1)
+    expect_length(fit$output_files(), if (class == ""mcmc"") fit$num_chains() else 1)
     expect_s3_class(fit$summary(), ""draws_summary"")
 
     if (class == ""mcmc"") {
       expect_s3_class(fit$sampler_diagnostics(), ""draws_array"")
-      expect_s3_class(fit$inv_metric(), ""draws_array"")
+      expect_type(fit$inv_metric(), ""list"")
     }
     if (class == ""mle"") {
       checkmate::expect_numeric(fit$mle())",True,False,Implementation / Logic,6
stan-dev,cmdstanr,a20e17be34de9e9bd77c75a024d997a89f82d68c,jgabry,jgabry@gmail.com,2020-12-18T22:52:28Z,jgabry,jgabry@gmail.com,2020-12-18T22:52:28Z,fix test,tests/testthat/test-csv.R,False,True,True,False,1,1,2,"---FILE: tests/testthat/test-csv.R---
@@ -480,7 +480,7 @@ test_that(""as_cmdstan_* functions created fitted model objects from csv"", {
   for (class in names(fits)) {
     fit <- fits[[class]]
     expect_s3_class(fit$draws(), ""draws"")
-    checkmate::expect_numeric(fit$lp_approx())
+    checkmate::expect_numeric(fit$lp())
     expect_output(fit$print(), ""variable"")
     expect_length(fit$output_files(), if (method == ""mcmc"") fit$num_chains() else 1)
     expect_s3_class(fit$summary(), ""draws_summary"")",True,False,Implementation / Logic,6
stan-dev,cmdstanr,adebd6a794f0f95fb48e89a8c64bda3cf90ede9b,jgabry,jgabry@gmail.com,2020-12-17T17:38:20Z,jgabry,jgabry@gmail.com,2020-12-17T17:38:20Z,"fix r cmd check NOTE about assignment to global env

the idea for this fix comes from https://github.com/yihui/knitr/issues/1824#issuecomment-647333232",R/knitr.R;R/zzz.R,False,True,True,False,21,10,31,"---FILE: R/knitr.R---
@@ -80,7 +80,7 @@ eng_cmdstan <- function(options) {
     }
     file <- write_stan_file(options$code, dir = dir)
     mod <- cmdstan_model(file)
-    assign(output_var, mod, envir = knitr::knit_global())
+    assign(output_var, mod, envir = cmdstanr_knitr_env())
   }
   options$engine <- ""stan"" # for syntax highlighting
   code <- paste(options$code, collapse = ""\n"")

---FILE: R/zzz.R---
@@ -1,12 +1,3 @@
-.onAttach <- function(...) {
-  startup_messages()
-}
-
-.onLoad <- function(...) {
-  cmdstanr_initialize()
-}
-
-
 startup_messages <- function() {
   packageStartupMessage(""This is cmdstanr version "", utils::packageVersion(""cmdstanr""))
   packageStartupMessage(""- Online documentation and vignettes at mc-stan.org/cmdstanr"")
@@ -65,3 +56,23 @@ cmdstanr_initialize <- function() {
   }
   invisible(TRUE)
 }
+
+cmdstanr_knitr_env_function_generator <- function(env1) {
+  function(env2 = NULL) {
+    if (!is.null(env2)) {
+      env1 <<- env2
+    }
+    invisible(env1)
+  }
+}
+cmdstanr_knitr_env <- cmdstanr_knitr_env_function_generator(new.env())
+
+
+.onAttach <- function(...) {
+  startup_messages()
+}
+
+.onLoad <- function(...) {
+  cmdstanr_knitr_env(knitr::knit_global())
+  cmdstanr_initialize()
+}",True,False,Implementation / Logic,6
stan-dev,cmdstanr,b425a32a41c3c03f215d5042bb07d02cbf28cb2b,jgabry,jgabry@gmail.com,2020-12-16T22:14:46Z,jgabry,jgabry@gmail.com,2020-12-16T22:14:46Z,fix r cmd check issues,R/cmdstanr-package.R;R/fit.R;man/fit-method-num_chains.Rd,False,True,True,False,4,4,8,"---FILE: R/cmdstanr-package.R---
@@ -52,4 +52,4 @@
 #'
 NULL
 
-if (getRversion() >= ""2.15.1"")  utils::globalVariables(c(""self"", ""private""))
+if (getRversion() >= ""2.15.1"")  utils::globalVariables(c(""self"", ""private"", ""super""))

---FILE: R/fit.R---
@@ -980,7 +980,7 @@ CmdStanMCMC$set(""public"", name = ""inv_metric"", value = inv_metric)
 #' @name fit-method-num_chains
 #' @aliases num_chains
 #' @description The `$num_chains()` method returns the number of MCMC chains.
-#' @return Am integer.
+#' @return An integer.
 #'
 #' @seealso [`CmdStanMCMC`]
 #'
@@ -1092,7 +1092,7 @@ CmdStanMLE <- R6::R6Class(
 mle <- function(variables = NULL) {
   x <- self$draws(variables)
   x <- x[, colnames(x) != ""lp__""]
-  setNames(as.numeric(x), nm = posterior::variables(x))
+  stats::setNames(as.numeric(x), posterior::variables(x))
 }
 CmdStanMLE$set(""public"", name = ""mle"", value = mle)
 

---FILE: man/fit-method-num_chains.Rd---
@@ -8,7 +8,7 @@
 num_chains()
 }
 \value{
-Am integer.
+An integer.
 }
 \description{
 The \verb{$num_chains()} method returns the number of MCMC chains.",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,691a37c234b31b948c7e816bc8c9b69e1fac3f6a,jgabry,jgabry@gmail.com,2020-12-16T19:47:51Z,jgabry,jgabry@gmail.com,2020-12-16T19:47:51Z,fix usage section in model.R,R/args.R;R/model.R;man-roxygen/model-sample-args.R;man/model-method-check_syntax.Rd;man/model-method-compile.Rd;man/model-method-generate-quantities.Rd;man/model-method-optimize.Rd;man/model-method-sample.Rd;man/model-method-sample_mpi.Rd;man/model-method-variational.Rd,False,True,True,False,388,536,924,"---FILE: R/args.R---
@@ -829,7 +829,7 @@ validate_seed <- function(seed, num_procs) {
 #' @return An integer vector of length `num_procs`.
 maybe_generate_seed <- function(seed, num_procs) {
   if (is.null(seed)) {
-    seed <- sample(.Machine$integer.max, num_procs)
+    seed <- base::sample(.Machine$integer.max, num_procs)
   } else if (length(seed) == 1 && num_procs > 1) {
     seed <- as.integer(seed)
     seed <- c(seed, seed + 1:(num_procs -1))

---FILE: R/model.R---
@@ -276,23 +276,7 @@ CmdStanModel <- R6::R6Class(
 #'   `$hpp_file()` methods. The default is to create the executable in the same
 #'   directory as the Stan program and to write the generated C++ code in a
 #'   temporary directory. To save the C++ code to a non-temporary location use
-#'   `$save_hpp_file()`.
-#'
-#' @section Usage:
-#'   ```
-#'   $compile(
-#'     quiet = TRUE,
-#'     dir = NULL,
-#'     pedantic = FALSE,
-#'     include_paths = NULL,
-#'     cpp_options = list(),
-#'     stanc_options = list(),
-#'     force_recompile = FALSE
-#'   )
-#'   $exe_file()
-#'   $hpp_file()
-#'   $save_hpp_file(dir = NULL)
-#'   ```
+#'   `$save_hpp_file(dir)`.
 #'
 #' @param quiet (logical) Should the verbose output from CmdStan during
 #'   compilation be suppressed? The default is `TRUE`, but if you encounter an
@@ -320,13 +304,15 @@ CmdStanModel <- R6::R6Class(
 #'   https://mc-stan.org/docs/cmdstan-guide/stanc.html.
 #' @param force_recompile (logical) Should the model be recompiled even if was
 #'   not modified since last compiled. The default is `FALSE`.
+#' @param threads Deprecated and will be removed in a future release. Please
+#'   turn on threading via `cpp_options = list(stan_threads = TRUE)` instead.
 #'
 #' @section Value: The `$compile()` method is called for its side effect of
 #'   creating the executable and adding its path to the [`CmdStanModel`] object,
 #'   but it also returns the [`CmdStanModel`] object invisibly.
 #'
-#'   The `$exe_file()`, `$hpp_file()`, and `$save_hpp_file()` methods all return
-#'   file paths.
+#'   After compilation, the `$exe_file()`, `$hpp_file()`, and `$save_hpp_file()`
+#'   methods can be used and return file paths.
 #'
 #' @template seealso-docs
 #'
@@ -357,17 +343,15 @@ CmdStanModel <- R6::R6Class(
 #'
 #' }
 #'
-NULL
-
-compile_method <- function(quiet = TRUE,
-                           dir = NULL,
-                           pedantic = FALSE,
-                           include_paths = NULL,
-                           cpp_options = list(),
-                           stanc_options = list(),
-                           force_recompile = FALSE,
-                           #deprecated
-                           threads = FALSE) {
+compile <- function(quiet = TRUE,
+                    dir = NULL,
+                    pedantic = FALSE,
+                    include_paths = NULL,
+                    cpp_options = list(),
+                    stanc_options = list(),
+                    force_recompile = FALSE,
+                    #deprecated
+                    threads = FALSE) {
   if (length(cpp_options) == 0 && !is.null(private$precompile_cpp_options_)) {
     cpp_options <- private$precompile_cpp_options_
   }
@@ -527,7 +511,7 @@ compile_method <- function(quiet = TRUE,
   private$precompile_include_paths_ <- NULL
   invisible(self)
 }
-CmdStanModel$set(""public"", name = ""compile"", value = compile_method)
+CmdStanModel$set(""public"", name = ""compile"", value = compile)
 
 #' Check syntax of a Stan program
 #'
@@ -539,16 +523,6 @@ CmdStanModel$set(""public"", name = ""compile"", value = compile_method)
 #'   checks the Stan program for syntax errors and returns `TRUE` (invisibly) if
 #'   parsing succeeds. If invalid syntax in found an error is thrown.
 #'
-#' @section Usage:
-#'   ```
-#'   $check_syntax(
-#'     pedantic = FALSE,
-#'     include_paths = NULL,
-#'     stanc_options = list(),
-#'     quiet = FALSE
-#'   )
-#'   ```
-#'
 #' @param pedantic (logical) Should pedantic mode be turned on? The default is
 #'   `FALSE`. Pedantic mode attempts to warn you about potential issues in your
 #'   Stan program beyond syntax errors. For details see the [*Pedantic mode*
@@ -595,12 +569,10 @@ CmdStanModel$set(""public"", name = ""compile"", value = compile_method)
 #' mod$check_syntax(pedantic = TRUE)
 #' }
 #'
-NULL
-
-check_syntax_method <- function(pedantic = FALSE,
-                                include_paths = NULL,
-                                stanc_options = list(),
-                                quiet = FALSE) {
+check_syntax <- function(pedantic = FALSE,
+                         include_paths = NULL,
+                         stanc_options = list(),
+                         quiet = FALSE) {
   if (length(stanc_options) == 0 && !is.null(private$precompile_stanc_options_)) {
     stanc_options <- private$precompile_stanc_options_
   }
@@ -669,7 +641,7 @@ check_syntax_method <- function(pedantic = FALSE,
   }
   invisible(TRUE)
 }
-CmdStanModel$set(""public"", name = ""check_syntax"", value = check_syntax_method)
+CmdStanModel$set(""public"", name = ""check_syntax"", value = check_syntax)
 
 #' Run Stan's MCMC algorithms
 #'
@@ -687,88 +659,53 @@ CmdStanModel$set(""public"", name = ""check_syntax"", value = check_syntax_method)
 #'   [CmdStan Users Guide](https://mc-stan.org/docs/cmdstan-guide/)
 #'   for more details.
 #'
-#' @section Usage:
-#'   ```
-#'   $sample(
-#'     data = NULL,
-#'     seed = NULL,
-#'     refresh = NULL,
-#'     init = NULL,
-#'     save_latent_dynamics = FALSE,
-#'     output_dir = NULL,
-#'     sig_figs = NULL,
-#'     chains = 4,
-#'     parallel_chains = getOption(""mc.cores"", 1),
-#'     chain_ids = seq_len(chains),
-#'     threads_per_chain = NULL,
-#'     iter_warmup = NULL,
-#'     iter_sampling = NULL,
-#'     save_warmup = FALSE,
-#'     thin = NULL,
-#'     max_treedepth = NULL,
-#'     adapt_engaged = TRUE,
-#'     adapt_delta = NULL,
-#'     step_size = NULL,
-#'     metric = NULL,
-#'     metric_file = NULL,
-#'     inv_metric = NULL,
-#'     init_buffer = NULL,
-#'     term_buffer = NULL,
-#'     window = NULL,
-#'     fixed_param = FALSE,
-#'     validate_csv = TRUE,
-#'     show_messages = TRUE
-#'   )
-#'   ```
-#'
 #' @template model-common-args
 #' @template model-sample-args
+#' @param cores,num_cores,num_chains,num_warmup,num_samples,save_extra_diagnostics,max_depth,stepsize
+#'   Deprecated and will be removed in a future release.
 #'
 #' @section Value: A [`CmdStanMCMC`] object.
 #'
 #' @template seealso-docs
 #' @inherit cmdstan_model examples
 #'
-NULL
-
-sample_method <- function(data = NULL,
-                          seed = NULL,
-                          refresh = NULL,
-                          init = NULL,
-                          save_latent_dynamics = FALSE,
-                          output_dir = NULL,
-                          sig_figs = NULL,
-                          chains = 4,
-                          parallel_chains = getOption(""mc.cores"", 1),
-                          chain_ids = seq_len(chains),
-                          threads_per_chain = NULL,
-                          iter_warmup = NULL,
-                          iter_sampling = NULL,
-                          save_warmup = FALSE,
-                          thin = NULL,
-                          max_treedepth = NULL,
-                          adapt_engaged = TRUE,
-                          adapt_delta = NULL,
-                          step_size = NULL,
-                          metric = NULL,
-                          metric_file = NULL,
-                          inv_metric = NULL,
-                          init_buffer = NULL,
-                          term_buffer = NULL,
-                          window = NULL,
-                          fixed_param = FALSE,
-                          validate_csv = TRUE,
-                          show_messages = TRUE,
-                          # deprecated
-                          cores = NULL,
-                          num_cores = NULL,
-                          num_chains = NULL,
-                          num_warmup = NULL,
-                          num_samples = NULL,
-                          save_extra_diagnostics = NULL,
-                          max_depth = NULL,
-                          stepsize = NULL) {
-
+sample <- function(data = NULL,
+                   seed = NULL,
+                   refresh = NULL,
+                   init = NULL,
+                   save_latent_dynamics = FALSE,
+                   output_dir = NULL,
+                   sig_figs = NULL,
+                   chains = 4,
+                   parallel_chains = getOption(""mc.cores"", 1),
+                   chain_ids = seq_len(chains),
+                   threads_per_chain = NULL,
+                   iter_warmup = NULL,
+                   iter_sampling = NULL,
+                   save_warmup = FALSE,
+                   thin = NULL,
+                   max_treedepth = NULL,
+                   adapt_engaged = TRUE,
+                   adapt_delta = NULL,
+                   step_size = NULL,
+                   metric = NULL,
+                   metric_file = NULL,
+                   inv_metric = NULL,
+                   init_buffer = NULL,
+                   term_buffer = NULL,
+                   window = NULL,
+                   fixed_param = FALSE,
+                   validate_csv = TRUE,
+                   show_messages = TRUE,
+                   # deprecated
+                   cores = NULL,
+                   num_cores = NULL,
+                   num_chains = NULL,
+                   num_warmup = NULL,
+                   num_samples = NULL,
+                   save_extra_diagnostics = NULL,
+                   max_depth = NULL,
+                   stepsize = NULL) {
   # temporary deprecation warnings
   if (!is.null(cores)) {
     warning(""'cores' is deprecated. Please use 'parallel_chains' instead."")
@@ -868,7 +805,7 @@ sample_method <- function(data = NULL,
   runset$run_cmdstan()
   CmdStanMCMC$new(runset)
 }
-CmdStanModel$set(""public"", name = ""sample"", value = sample_method)
+CmdStanModel$set(""public"", name = ""sample"", value = sample)
 
 #' Run Stan's MCMC algorithms with MPI
 #'
@@ -906,48 +843,13 @@ CmdStanModel$set(""public"", name = ""sample"", value = sample_method)
 #'   only define the number of processes. To use `n_procs` processes specify
 #'   `mpi_args = list(""n"" = n_procs)`.
 #'
-#' @section Usage:
-#'   ```
-#'   $sample_mpi(
-#'     data = NULL,
-#'     mpi_cmd = ""mpiexec"",
-#'     mpi_args = NULL,
-#'     seed = NULL,
-#'     refresh = NULL,
-#'     init = NULL,
-#'     save_latent_dynamics = FALSE,
-#'     output_dir = NULL,
-#'     sig_figs = NULL,
-#'     chains = 4,
-#'     chain_ids = seq_len(chains),
-#'     iter_warmup = NULL,
-#'     iter_sampling = NULL,
-#'     save_warmup = FALSE,
-#'     thin = NULL,
-#'     max_treedepth = NULL,
-#'     adapt_engaged = TRUE,
-#'     adapt_delta = NULL,
-#'     step_size = NULL,
-#'     metric = NULL,
-#'     metric_file = NULL,
-#'     inv_metric = NULL,
-#'     init_buffer = NULL,
-#'     term_buffer = NULL,
-#'     window = NULL,
-#'     fixed_param = FALSE,
-#'     validate_csv = TRUE,
-#'     show_messages = TRUE
-#'   )
-#'   ```
-#'
+#' @inheritParams model-method-sample
 #' @param mpi_cmd (character vector) The MPI launcher used for launching MPI
 #'   processes. The default launcher is `""mpiexec""`.
 #' @param mpi_args (list) A list of arguments to use when launching MPI
 #'   processes. For example, `mpi_args = list(""n"" = 4)` launches the executable
 #'   as `mpiexec -n 4 model_executable`, followed by CmdStan arguments for the
 #'   model executable.
-#' @template model-common-args
-#' @template model-sample-args
 #'
 #' @section Value: A [`CmdStanMCMC`] object.
 #'
@@ -963,36 +865,34 @@ CmdStanModel$set(""public"", name = ""sample"", value = sample_method)
 #' # fit <- mod$sample_mpi(..., mpi_args = list(""n"" = 4))
 #' }
 #'
-NULL
-
-sample_mpi_method <- function(data = NULL,
-                              mpi_cmd = ""mpiexec"",
-                              mpi_args = NULL,
-                              seed = NULL,
-                              refresh = NULL,
-                              init = NULL,
-                              save_latent_dynamics = FALSE,
-                              output_dir = NULL,
-                              chains = 1,
-                              chain_ids = seq_len(chains),
-                              iter_warmup = NULL,
-                              iter_sampling = NULL,
-                              save_warmup = FALSE,
-                              thin = NULL,
-                              max_treedepth = NULL,
-                              adapt_engaged = TRUE,
-                              adapt_delta = NULL,
-                              step_size = NULL,
-                              metric = NULL,
-                              metric_file = NULL,
-                              inv_metric = NULL,
-                              init_buffer = NULL,
-                              term_buffer = NULL,
-                              window = NULL,
-                              fixed_param = FALSE,
-                              sig_figs = NULL,
-                              validate_csv = TRUE,
-                              show_messages = TRUE) {
+sample_mpi <- function(data = NULL,
+                       mpi_cmd = ""mpiexec"",
+                       mpi_args = NULL,
+                       seed = NULL,
+                       refresh = NULL,
+                       init = NULL,
+                       save_latent_dynamics = FALSE,
+                       output_dir = NULL,
+                       chains = 1,
+                       chain_ids = seq_len(chains),
+                       iter_warmup = NULL,
+                       iter_sampling = NULL,
+                       save_warmup = FALSE,
+                       thin = NULL,
+                       max_treedepth = NULL,
+                       adapt_engaged = TRUE,
+                       adapt_delta = NULL,
+                       step_size = NULL,
+                       metric = NULL,
+                       metric_file = NULL,
+                       inv_metric = NULL,
+                       init_buffer = NULL,
+                       term_buffer = NULL,
+                       window = NULL,
+                       fixed_param = FALSE,
+                       sig_figs = NULL,
+                       validate_csv = TRUE,
+                       show_messages = TRUE) {
   if (fixed_param) {
     chains <- 1
     save_warmup <- FALSE
@@ -1040,7 +940,7 @@ sample_mpi_method <- function(data = NULL,
   runset$run_cmdstan_mpi(mpi_cmd, mpi_args)
   CmdStanMCMC$new(runset)
 }
-CmdStanModel$set(""public"", name = ""sample_mpi"", value = sample_mpi_method)
+CmdStanModel$set(""public"", name = ""sample_mpi"", value = sample_mpi)
 
 #' Run Stan's optimization algorithms
 #'
@@ -1066,29 +966,6 @@ CmdStanModel$set(""public"", name = ""sample_mpi"", value = sample_mpi_method)
 #'
 #'   -- [*CmdStan User's Guide*](https://mc-stan.org/docs/cmdstan-guide/)
 #'
-#' @section Usage:
-#'   ```
-#'   $optimize(
-#'     data = NULL,
-#'     seed = NULL,
-#'     refresh = NULL,
-#'     init = NULL,
-#'     save_latent_dynamics = FALSE,
-#'     output_dir = NULL,
-#'     sig_figs = NULL,
-#'     threads = NULL,
-#'     algorithm = NULL,
-#'     init_alpha = NULL,
-#'     iter = NULL,
-#'     tol_obj = NULL,
-#'     tol_rel_obj = NULL,
-#'     tol_grad = NULL,
-#'     tol_rel_grad = NULL,
-#'     tol_param = NULL,
-#'     history_size = NULL
-#'   )
-#'   ```
-#'
 #' @template model-common-args
 #' @param threads (positive integer) If the model was
 #'   [compiled][model-method-compile] with threading support, the number of
@@ -1114,25 +991,23 @@ CmdStanModel$set(""public"", name = ""sample_mpi"", value = sample_mpi_method)
 #' @template seealso-docs
 #' @inherit cmdstan_model examples
 #'
-NULL
-
-optimize_method <- function(data = NULL,
-                            seed = NULL,
-                            refresh = NULL,
-                            init = NULL,
-                            save_latent_dynamics = FALSE,
-                            output_dir = NULL,
-                            sig_figs = NULL,
-                            threads = NULL,
-                            algorithm = NULL,
-                            init_alpha = NULL,
-                            iter = NULL,
-                            tol_obj = NULL,
-                            tol_rel_obj = NULL,
-                            tol_grad = NULL,
-                            tol_rel_grad = NULL,
-                            tol_param = NULL,
-                            history_size = NULL) {
+optimize <- function(data = NULL,
+                     seed = NULL,
+                     refresh = NULL,
+                     init = NULL,
+                     save_latent_dynamics = FALSE,
+                     output_dir = NULL,
+                     sig_figs = NULL,
+                     threads = NULL,
+                     algorithm = NULL,
+                     init_alpha = NULL,
+                     iter = NULL,
+                     tol_obj = NULL,
+                     tol_rel_obj = NULL,
+                     tol_grad = NULL,
+                     tol_rel_grad = NULL,
+                     tol_param = NULL,
+                     history_size = NULL) {
   checkmate::assert_integerish(threads, lower = 1, len = 1, null.ok = TRUE)
   if (is.null(self$cpp_options()[[""stan_threads""]])) {
     if (!is.null(threads)) {
@@ -1182,7 +1057,7 @@ optimize_method <- function(data = NULL,
   runset$run_cmdstan()
   CmdStanMLE$new(runset)
 }
-CmdStanModel$set(""public"", name = ""optimize"", value = optimize_method)
+CmdStanModel$set(""public"", name = ""optimize"", value = optimize)
 
 
 #' Run Stan's variational approximation algorithms
@@ -1208,30 +1083,6 @@ CmdStanModel$set(""public"", name = ""optimize"", value = optimize_method)
 #'
 #'   -- [*CmdStan Interface User's Guide*](https://github.com/stan-dev/cmdstan/releases/latest)
 #'
-#' @section Usage:
-#'   ```
-#'   $variational(
-#'     data = NULL,
-#'     seed = NULL,
-#'     refresh = NULL,
-#'     init = NULL,
-#'     save_latent_dynamics = FALSE,
-#'     output_dir = NULL,
-#'     sig_figs = NULL,
-#'     threads = NULL,
-#'     algorithm = NULL,
-#'     iter = NULL,
-#'     grad_samples = NULL,
-#'     elbo_samples = NULL,
-#'     eta = NULL,
-#'     adapt_engaged = NULL,
-#'     adapt_iter = NULL,
-#'     tol_rel_obj = NULL,
-#'     eval_elbo = NULL,
-#'     output_samples = NULL
-#'   )
-#'   ```
-#'
 #' @template model-common-args
 #' @param threads (positive integer) If the model was
 #'   [compiled][model-method-compile] with threading support, the number of
@@ -1260,26 +1111,24 @@ CmdStanModel$set(""public"", name = ""optimize"", value = optimize_method)
 #' @template seealso-docs
 #' @inherit cmdstan_model examples
 #'
-NULL
-
-variational_method <- function(data = NULL,
-                               seed = NULL,
-                               refresh = NULL,
-                               init = NULL,
-                               save_latent_dynamics = FALSE,
-                               output_dir = NULL,
-                               sig_figs = NULL,
-                               threads = NULL,
-                               algorithm = NULL,
-                               iter = NULL,
-                               grad_samples = NULL,
-                               elbo_samples = NULL,
-                               eta = NULL,
-                               adapt_engaged = NULL,
-                               adapt_iter = NULL,
-                               tol_rel_obj = NULL,
-                               eval_elbo = NULL,
-                               output_samples = NULL) {
+variational <- function(data = NULL,
+                        seed = NULL,
+                        refresh = NULL,
+                        init = NULL,
+                        save_latent_dynamics = FALSE,
+                        output_dir = NULL,
+                        sig_figs = NULL,
+                        threads = NULL,
+                        algorithm = NULL,
+                        iter = NULL,
+                        grad_samples = NULL,
+                        elbo_samples = NULL,
+                        eta = NULL,
+                        adapt_engaged = NULL,
+                        adapt_iter = NULL,
+                        tol_rel_obj = NULL,
+                        eval_elbo = NULL,
+                        output_samples = NULL) {
   checkmate::assert_integerish(threads, lower = 1, len = 1, null.ok = TRUE)
   if (is.null(self$cpp_options()[[""stan_threads""]])) {
     if (!is.null(threads)) {
@@ -1330,7 +1179,7 @@ variational_method <- function(data = NULL,
   runset$run_cmdstan()
   CmdStanVB$new(runset)
 }
-CmdStanModel$set(""public"", name = ""variational"", value = variational_method)
+CmdStanModel$set(""public"", name = ""variational"", value = variational)
 
 #' Run Stan's standalone generated quantities method
 #'
@@ -1342,27 +1191,13 @@ CmdStanModel$set(""public"", name = ""variational"", value = variational_method)
 #'   runs Stan's standalone generated quantities to obtain generated quantities
 #'   based on previously fitted parameters.
 #'
-#' @section Usage:
-#'   ```
-#'   $generate_quantities(
-#'     fitted_params,
-#'     data = NULL,
-#'     seed = NULL,
-#'     output_dir = NULL,
-#'     sig_figs = NULL,
-#'     parallel_chains = getOption(""mc.cores"", 1),
-#'     threads_per_chain = NULL
-#'   )
-#'   ```
-#'
+#' @inheritParams model-method-sample
 #' @param fitted_params (multiple options) The parameter draws to use. One of
 #'   the following:
 #'  * A [CmdStanMCMC] or [CmdStanVB] fitted model object.
 #'  * A [posterior::draws_array] (for MCMC) or [posterior::draws_matrix] (for
 #'  VB) object returned by CmdStanR's [`$draws()`][fit-method-draws] method.
 #'  * A character vector of paths to CmdStan CSV output files.
-#' @param data,seed,output_dir,sig_figs,parallel_chains,threads_per_chain Same
-#'   as for the [`$sample()`][model-method-sample] method.
 #'
 #' @section Value: A [`CmdStanGQ`] object.
 #'
@@ -1411,15 +1246,13 @@ CmdStanModel$set(""public"", name = ""variational"", value = variational_method)
 #' as_draws_df(fit_gq$draws())
 #' }
 #'
-NULL
-
-generate_quantities_method <- function(fitted_params,
-                                       data = NULL,
-                                       seed = NULL,
-                                       output_dir = NULL,
-                                       sig_figs = NULL,
-                                       parallel_chains = getOption(""mc.cores"", 1),
-                                       threads_per_chain = NULL) {
+generate_quantities <- function(fitted_params,
+                                data = NULL,
+                                seed = NULL,
+                                output_dir = NULL,
+                                sig_figs = NULL,
+                                parallel_chains = getOption(""mc.cores"", 1),
+                                threads_per_chain = NULL) {
   checkmate::assert_integerish(parallel_chains, lower = 1, null.ok = TRUE)
   checkmate::assert_integerish(threads_per_chain, lower = 1, len = 1, null.ok = TRUE)
   if (is.null(self$cpp_options()[[""stan_threads""]])) {
@@ -1461,4 +1294,4 @@ generate_quantities_method <- function(fitted_params,
   runset$run_cmdstan()
   CmdStanGQ$new(runset)
 }
-CmdStanModel$set(""public"", name = ""generate_quantities"", value = generate_quantities_method)
+CmdStanModel$set(""public"", name = ""generate_quantities"", value = generate_quantities)

---FILE: man-roxygen/model-sample-args.R---
@@ -4,8 +4,7 @@
 #'   to run in parallel. If `parallel_chains` is not specified then the default
 #'   is to look for the option `""mc.cores""`, which can be set for an entire \R
 #'   session by `options(mc.cores=value)`. If the `""mc.cores""` option has not
-#'   been set then the default is `1`. This argument is available for
-#'   the `$sample()` method but not for the `$sample_mpi()` method.
+#'   been set then the default is `1`.
 #' @param chain_ids (vector) A vector of chain IDs. Must contain `chains` unique
 #'   positive integers. If not set, the default chain IDs are used (integers
 #'   starting from `1`).
@@ -18,8 +17,6 @@
 #'   `parallel_chains*threads_per_chain`. For an example of using threading see
 #'   the Stan case study [Reduce Sum: A Minimal
 #'   Example](https://mc-stan.org/users/documentation/case-studies/reduce_sum_tutorial.html).
-#'   This argument is available for the `$sample()` method but not for the
-#'   `$sample_mpi()` method.
 #'
 #' @param show_messages (logical) When `TRUE` (the default), prints all
 #'   informational messages, for example rejection of the current proposal.

---FILE: man/model-method-check_syntax.Rd---
@@ -4,6 +4,14 @@
 \alias{model-method-check_syntax}
 \alias{check_syntax}
 \title{Check syntax of a Stan program}
+\usage{
+check_syntax(
+  pedantic = FALSE,
+  include_paths = NULL,
+  stanc_options = list(),
+  quiet = FALSE
+)
+}
 \arguments{
 \item{pedantic}{(logical) Should pedantic mode be turned on? The default is
 \code{FALSE}. Pedantic mode attempts to warn you about potential issues in your
@@ -28,16 +36,6 @@ The \verb{$check_syntax()} method of a \code{\link{CmdStanModel}} object
 checks the Stan program for syntax errors and returns \code{TRUE} (invisibly) if
 parsing succeeds. If invalid syntax in found an error is thrown.
 }
-\section{Usage}{
-\preformatted{$check_syntax(
-  pedantic = FALSE,
-  include_paths = NULL,
-  stanc_options = list(),
-  quiet = FALSE
-)
-}
-}
-
 \section{Value}{
  The \verb{$check_syntax()} method returns \code{TRUE} (invisibly) if
 the model is valid.

---FILE: man/model-method-compile.Rd---
@@ -4,6 +4,18 @@
 \alias{model-method-compile}
 \alias{compile}
 \title{Compile a Stan program}
+\usage{
+compile(
+  quiet = TRUE,
+  dir = NULL,
+  pedantic = FALSE,
+  include_paths = NULL,
+  cpp_options = list(),
+  stanc_options = list(),
+  force_recompile = FALSE,
+  threads = FALSE
+)
+}
 \arguments{
 \item{quiet}{(logical) Should the verbose output from CmdStan during
 compilation be suppressed? The default is \code{TRUE}, but if you encounter an
@@ -36,6 +48,9 @@ https://mc-stan.org/docs/cmdstan-guide/stanc.html.}
 
 \item{force_recompile}{(logical) Should the model be recompiled even if was
 not modified since last compiled. The default is \code{FALSE}.}
+
+\item{threads}{Deprecated and will be removed in a future release. Please
+turn on threading via \code{cpp_options = list(stan_threads = TRUE)} instead.}
 }
 \description{
 The \verb{$compile()} method of a \code{\link{CmdStanModel}} object translates
@@ -50,31 +65,15 @@ containing the generated C++ code are available via the \verb{$exe_file()} and
 \verb{$hpp_file()} methods. The default is to create the executable in the same
 directory as the Stan program and to write the generated C++ code in a
 temporary directory. To save the C++ code to a non-temporary location use
-\verb{$save_hpp_file()}.
+\verb{$save_hpp_file(dir)}.
 }
-\section{Usage}{
-\preformatted{$compile(
-  quiet = TRUE,
-  dir = NULL,
-  pedantic = FALSE,
-  include_paths = NULL,
-  cpp_options = list(),
-  stanc_options = list(),
-  force_recompile = FALSE
-)
-$exe_file()
-$hpp_file()
-$save_hpp_file(dir = NULL)
-}
-}
-
 \section{Value}{
  The \verb{$compile()} method is called for its side effect of
 creating the executable and adding its path to the \code{\link{CmdStanModel}} object,
 but it also returns the \code{\link{CmdStanModel}} object invisibly.
 
-The \verb{$exe_file()}, \verb{$hpp_file()}, and \verb{$save_hpp_file()} methods all return
-file paths.
+After compilation, the \verb{$exe_file()}, \verb{$hpp_file()}, and \verb{$save_hpp_file()}
+methods can be used and return file paths.
 }
 
 \examples{

---FILE: man/model-method-generate-quantities.Rd---
@@ -4,6 +4,17 @@
 \alias{model-method-generate-quantities}
 \alias{generate_quantities}
 \title{Run Stan's standalone generated quantities method}
+\usage{
+generate_quantities(
+  fitted_params,
+  data = NULL,
+  seed = NULL,
+  output_dir = NULL,
+  sig_figs = NULL,
+  parallel_chains = getOption(""mc.cores"", 1),
+  threads_per_chain = NULL
+)
+}
 \arguments{
 \item{fitted_params}{(multiple options) The parameter draws to use. One of
 the following:
@@ -14,27 +25,60 @@ VB) object returned by CmdStanR's \code{\link[=fit-method-draws]{$draws()}} meth
 \item A character vector of paths to CmdStan CSV output files.
 }}
 
-\item{data, seed, output_dir, sig_figs, parallel_chains, threads_per_chain}{Same
-as for the \code{\link[=model-method-sample]{$sample()}} method.}
+\item{data}{(multiple options) The data to use for the variables specified in
+the \code{data} block of the Stan program. One of the following:
+\itemize{
+\item A named list of \R objects (like for RStan). Internally this list is then
+written to JSON for CmdStan using \code{\link[=write_stan_json]{write_stan_json()}}.
+\item A path to a data file compatible with CmdStan (JSON or \R dump). See the
+appendices in the CmdStan manual for details on using these formats.
+\item \code{NULL} or an empty list if the Stan program has no \code{data} block.
+}}
+
+\item{seed}{(positive integer) A seed for the (P)RNG to pass to CmdStan.}
+
+\item{output_dir}{(string) A path to a directory where CmdStan should write
+its output CSV files. For interactive use this can typically be left at
+\code{NULL} (temporary directory) since CmdStanR makes the CmdStan output
+(posterior draws and diagnostics) available in \R via methods of the fitted
+model objects. The behavior of \code{output_dir} is as follows:
+\itemize{
+\item If \code{NULL} (the default), then the CSV files are written to a temporary
+directory and only saved permanently if the user calls one of the \verb{$save_*}
+methods of the fitted model object (e.g.,
+\code{\link[=fit-method-save_output_files]{$save_output_files()}}). These temporary
+files are removed when the fitted model object is
+\link[base:gc]{garbage collected} (manually or automatically).
+\item If a path, then the files are created in \code{output_dir} with names
+corresponding to the defaults used by \verb{$save_output_files()}.
+}}
+
+\item{sig_figs}{(positive integer) The number of significant figures used
+when storing the output values. By default, CmdStan represent the output
+values with 6 significant figures. The upper limit for \code{sig_figs} is 18.
+Increasing this value will result in larger output CSV files and thus an
+increased usage of disk space.}
+
+\item{parallel_chains}{(positive integer) The \emph{maximum} number of MCMC chains
+to run in parallel. If \code{parallel_chains} is not specified then the default
+is to look for the option \code{""mc.cores""}, which can be set for an entire \R
+session by \code{options(mc.cores=value)}. If the \code{""mc.cores""} option has not
+been set then the default is \code{1}.}
+
+\item{threads_per_chain}{(positive integer) If the model was
+\link[=model-method-compile]{compiled} with threading support, the number of
+threads to use in parallelized sections \emph{within} an MCMC chain (e.g., when
+using the Stan functions \code{reduce_sum()} or \code{map_rect()}). This is in
+contrast with \code{parallel_chains}, which specifies the number of chains to
+run in parallel. The actual number of CPU cores used use is
+\code{parallel_chains*threads_per_chain}. For an example of using threading see
+the Stan case study \href{https://mc-stan.org/users/documentation/case-studies/reduce_sum_tutorial.html}{Reduce Sum: A Minimal Example}.}
 }
 \description{
 The \verb{$generate_quantities()} method of a \code{\link{CmdStanModel}} object
 runs Stan's standalone generated quantities to obtain generated quantities
 based on previously fitted parameters.
 }
-\section{Usage}{
-\preformatted{$generate_quantities(
-  fitted_params,
-  data = NULL,
-  seed = NULL,
-  output_dir = NULL,
-  sig_figs = NULL,
-  parallel_chains = getOption(""mc.cores"", 1),
-  threads_per_chain = NULL
-)
-}
-}
-
 \section{Value}{
  A \code{\link{CmdStanGQ}} object.
 }

---FILE: man/model-method-optimize.Rd---
@@ -4,6 +4,27 @@
 \alias{model-method-optimize}
 \alias{optimize}
 \title{Run Stan's optimization algorithms}
+\usage{
+optimize(
+  data = NULL,
+  seed = NULL,
+  refresh = NULL,
+  init = NULL,
+  save_latent_dynamics = FALSE,
+  output_dir = NULL,
+  sig_figs = NULL,
+  threads = NULL,
+  algorithm = NULL,
+  init_alpha = NULL,
+  iter = NULL,
+  tol_obj = NULL,
+  tol_rel_obj = NULL,
+  tol_grad = NULL,
+  tol_rel_grad = NULL,
+  tol_param = NULL,
+  history_size = NULL
+)
+}
 \arguments{
 \item{data}{(multiple options) The data to use for the variables specified in
 the \code{data} block of the Stan program. One of the following:
@@ -81,8 +102,6 @@ increased usage of disk space.}
 threads to use in parallelized sections (e.g., when
 using the Stan functions \code{reduce_sum()} or \code{map_rect()}).}
 
-\item{iter}{(positive integer) The maximum number of iterations.}
-
 \item{algorithm}{(string) The optimization algorithm. One of \code{""lbfgs""},
 \code{""bfgs""}, or \code{""newton""}. The control parameters below are only available
 for \code{""lbfgs""} and \verb{""bfgs}. For their default values and more details see
@@ -91,6 +110,8 @@ running \code{cmdstanr_example(method=""optimize"")$metadata()}.}
 
 \item{init_alpha}{(positive real) The initial step size parameter.}
 
+\item{iter}{(positive integer) The maximum number of iterations.}
+
 \item{tol_obj}{(positive real) Convergence tolerance on changes in objective function value.}
 
 \item{tol_rel_obj}{(positive real) Convergence tolerance on relative changes in objective function value.}
@@ -124,29 +145,6 @@ variables. Thus modes correspond to modes of the model as written.
 
 -- \href{https://mc-stan.org/docs/cmdstan-guide/}{\emph{CmdStan User's Guide}}
 }
-\section{Usage}{
-\preformatted{$optimize(
-  data = NULL,
-  seed = NULL,
-  refresh = NULL,
-  init = NULL,
-  save_latent_dynamics = FALSE,
-  output_dir = NULL,
-  sig_figs = NULL,
-  threads = NULL,
-  algorithm = NULL,
-  init_alpha = NULL,
-  iter = NULL,
-  tol_obj = NULL,
-  tol_rel_obj = NULL,
-  tol_grad = NULL,
-  tol_rel_grad = NULL,
-  tol_param = NULL,
-  history_size = NULL
-)
-}
-}
-
 \section{Value}{
  A \code{\link{CmdStanMLE}} object.
 }

---FILE: man/model-method-sample.Rd---
@@ -4,6 +4,46 @@
 \alias{model-method-sample}
 \alias{sample}
 \title{Run Stan's MCMC algorithms}
+\usage{
+sample(
+  data = NULL,
+  seed = NULL,
+  refresh = NULL,
+  init = NULL,
+  save_latent_dynamics = FALSE,
+  output_dir = NULL,
+  sig_figs = NULL,
+  chains = 4,
+  parallel_chains = getOption(""mc.cores"", 1),
+  chain_ids = seq_len(chains),
+  threads_per_chain = NULL,
+  iter_warmup = NULL,
+  iter_sampling = NULL,
+  save_warmup = FALSE,
+  thin = NULL,
+  max_treedepth = NULL,
+  adapt_engaged = TRUE,
+  adapt_delta = NULL,
+  step_size = NULL,
+  metric = NULL,
+  metric_file = NULL,
+  inv_metric = NULL,
+  init_buffer = NULL,
+  term_buffer = NULL,
+  window = NULL,
+  fixed_param = FALSE,
+  validate_csv = TRUE,
+  show_messages = TRUE,
+  cores = NULL,
+  num_cores = NULL,
+  num_chains = NULL,
+  num_warmup = NULL,
+  num_samples = NULL,
+  save_extra_diagnostics = NULL,
+  max_depth = NULL,
+  stepsize = NULL
+)
+}
 \arguments{
 \item{data}{(multiple options) The data to use for the variables specified in
 the \code{data} block of the Stan program. One of the following:
@@ -83,8 +123,7 @@ default is 4.}
 to run in parallel. If \code{parallel_chains} is not specified then the default
 is to look for the option \code{""mc.cores""}, which can be set for an entire \R
 session by \code{options(mc.cores=value)}. If the \code{""mc.cores""} option has not
-been set then the default is \code{1}. This argument is available for
-the \verb{$sample()} method but not for the \verb{$sample_mpi()} method.}
+been set then the default is \code{1}.}
 
 \item{chain_ids}{(vector) A vector of chain IDs. Must contain \code{chains} unique
 positive integers. If not set, the default chain IDs are used (integers
@@ -97,30 +136,16 @@ using the Stan functions \code{reduce_sum()} or \code{map_rect()}). This is in
 contrast with \code{parallel_chains}, which specifies the number of chains to
 run in parallel. The actual number of CPU cores used use is
 \code{parallel_chains*threads_per_chain}. For an example of using threading see
-the Stan case study \href{https://mc-stan.org/users/documentation/case-studies/reduce_sum_tutorial.html}{Reduce Sum: A Minimal Example}.
-This argument is available for the \verb{$sample()} method but not for the
-\verb{$sample_mpi()} method.}
+the Stan case study \href{https://mc-stan.org/users/documentation/case-studies/reduce_sum_tutorial.html}{Reduce Sum: A Minimal Example}.}
 
-\item{show_messages}{(logical) When \code{TRUE} (the default), prints all
-informational messages, for example rejection of the current proposal.
-Disable if you wish silence these messages, but this is not recommended
-unless you are very sure that the model is correct up to numerical error.
-If the messages are silenced then the \verb{$output()} method of the resulting
-fit object can be used to display all the silenced messages.}
-
-\item{validate_csv}{(logical) When \code{TRUE} (the default), validate the
-sampling results in the csv files. Disable if you wish to manually read in
-the sampling results and validate them yourself, for example using
-\code{\link[=read_cmdstan_csv]{read_cmdstan_csv()}}.}
+\item{iter_warmup}{(positive integer) The number of warmup iterations to run
+per chain. Note: in the CmdStan User's Guide this is referred to as
+\code{num_warmup}.}
 
 \item{iter_sampling}{(positive integer) The number of post-warmup iterations
 to run per chain. Note: in the CmdStan User's Guide this is referred to as
 \code{num_samples}.}
 
-\item{iter_warmup}{(positive integer) The number of warmup iterations to run
-per chain. Note: in the CmdStan User's Guide this is referred to as
-\code{num_warmup}.}
-
 \item{save_warmup}{(logical) Should warmup iterations be saved? The default
 is \code{FALSE}. If \code{save_warmup=TRUE} then you can use
 \link[=fit-method-draws]{$draws(inc_warmup=TRUE)} to include warmup when
@@ -185,6 +210,20 @@ when, for example, trying to generate pseudo-data using the generated
 quantities block. If the parameters block is empty then using
 \code{fixed_param=TRUE} is mandatory. When \code{fixed_param=TRUE} the \code{chains} and
 \code{parallel_chains} arguments will be set to \code{1}.}
+
+\item{validate_csv}{(logical) When \code{TRUE} (the default), validate the
+sampling results in the csv files. Disable if you wish to manually read in
+the sampling results and validate them yourself, for example using
+\code{\link[=read_cmdstan_csv]{read_cmdstan_csv()}}.}
+
+\item{show_messages}{(logical) When \code{TRUE} (the default), prints all
+informational messages, for example rejection of the current proposal.
+Disable if you wish silence these messages, but this is not recommended
+unless you are very sure that the model is correct up to numerical error.
+If the messages are silenced then the \verb{$output()} method of the resulting
+fit object can be used to display all the silenced messages.}
+
+\item{cores, num_cores, num_chains, num_warmup, num_samples, save_extra_diagnostics, max_depth, stepsize}{Deprecated and will be removed in a future release.}
 }
 \description{
 The \verb{$sample()} method of a \code{\link{CmdStanModel}} object runs the
@@ -197,40 +236,6 @@ installed version of CmdStan. See the
 \href{https://mc-stan.org/docs/cmdstan-guide/}{CmdStan Users Guide}
 for more details.
 }
-\section{Usage}{
-\preformatted{$sample(
-  data = NULL,
-  seed = NULL,
-  refresh = NULL,
-  init = NULL,
-  save_latent_dynamics = FALSE,
-  output_dir = NULL,
-  sig_figs = NULL,
-  chains = 4,
-  parallel_chains = getOption(""mc.cores"", 1),
-  chain_ids = seq_len(chains),
-  threads_per_chain = NULL,
-  iter_warmup = NULL,
-  iter_sampling = NULL,
-  save_warmup = FALSE,
-  thin = NULL,
-  max_treedepth = NULL,
-  adapt_engaged = TRUE,
-  adapt_delta = NULL,
-  step_size = NULL,
-  metric = NULL,
-  metric_file = NULL,
-  inv_metric = NULL,
-  init_buffer = NULL,
-  term_buffer = NULL,
-  window = NULL,
-  fixed_param = FALSE,
-  validate_csv = TRUE,
-  show_messages = TRUE
-)
-}
-}
-
 \section{Value}{
  A \code{\link{CmdStanMCMC}} object.
 }

---FILE: man/model-method-sample_mpi.Rd---
@@ -4,15 +4,39 @@
 \alias{model-method-sample_mpi}
 \alias{sample_mpi}
 \title{Run Stan's MCMC algorithms with MPI}
+\usage{
+sample_mpi(
+  data = NULL,
+  mpi_cmd = ""mpiexec"",
+  mpi_args = NULL,
+  seed = NULL,
+  refresh = NULL,
+  init = NULL,
+  save_latent_dynamics = FALSE,
+  output_dir = NULL,
+  chains = 1,
+  chain_ids = seq_len(chains),
+  iter_warmup = NULL,
+  iter_sampling = NULL,
+  save_warmup = FALSE,
+  thin = NULL,
+  max_treedepth = NULL,
+  adapt_engaged = TRUE,
+  adapt_delta = NULL,
+  step_size = NULL,
+  metric = NULL,
+  metric_file = NULL,
+  inv_metric = NULL,
+  init_buffer = NULL,
+  term_buffer = NULL,
+  window = NULL,
+  fixed_param = FALSE,
+  sig_figs = NULL,
+  validate_csv = TRUE,
+  show_messages = TRUE
+)
+}
 \arguments{
-\item{mpi_cmd}{(character vector) The MPI launcher used for launching MPI
-processes. The default launcher is \code{""mpiexec""}.}
-
-\item{mpi_args}{(list) A list of arguments to use when launching MPI
-processes. For example, \code{mpi_args = list(""n"" = 4)} launches the executable
-as \verb{mpiexec -n 4 model_executable}, followed by CmdStan arguments for the
-model executable.}
-
 \item{data}{(multiple options) The data to use for the variables specified in
 the \code{data} block of the Stan program. One of the following:
 \itemize{
@@ -23,6 +47,14 @@ appendices in the CmdStan manual for details on using these formats.
 \item \code{NULL} or an empty list if the Stan program has no \code{data} block.
 }}
 
+\item{mpi_cmd}{(character vector) The MPI launcher used for launching MPI
+processes. The default launcher is \code{""mpiexec""}.}
+
+\item{mpi_args}{(list) A list of arguments to use when launching MPI
+processes. For example, \code{mpi_args = list(""n"" = 4)} launches the executable
+as \verb{mpiexec -n 4 model_executable}, followed by CmdStan arguments for the
+model executable.}
+
 \item{seed}{(positive integer) A seed for the (P)RNG to pass to CmdStan.}
 
 \item{refresh}{(non-negative integer) The number of iterations between
@@ -78,57 +110,21 @@ files are removed when the fitted model object is
 corresponding to the defaults used by \verb{$save_output_files()}.
 }}
 
-\item{sig_figs}{(positive integer) The number of significant figures used
-when storing the output values. By default, CmdStan represent the output
-values with 6 significant figures. The upper limit for \code{sig_figs} is 18.
-Increasing this value will result in larger output CSV files and thus an
-increased usage of disk space.}
-
 \item{chains}{(positive integer) The number of Markov chains to run. The
 default is 4.}
 
-\item{parallel_chains}{(positive integer) The \emph{maximum} number of MCMC chains
-to run in parallel. If \code{parallel_chains} is not specified then the default
-is to look for the option \code{""mc.cores""}, which can be set for an entire \R
-session by \code{options(mc.cores=value)}. If the \code{""mc.cores""} option has not
-been set then the default is \code{1}. This argument is available for
-the \verb{$sample()} method but not for the \verb{$sample_mpi()} method.}
-
 \item{chain_ids}{(vector) A vector of chain IDs. Must contain \code{chains} unique
 positive integers. If not set, the default chain IDs are used (integers
 starting from \code{1}).}
 
-\item{threads_per_chain}{(positive integer) If the model was
-\link[=model-method-compile]{compiled} with threading support, the number of
-threads to use in parallelized sections \emph{within} an MCMC chain (e.g., when
-using the Stan functions \code{reduce_sum()} or \code{map_rect()}). This is in
-contrast with \code{parallel_chains}, which specifies the number of chains to
-run in parallel. The actual number of CPU cores used use is
-\code{parallel_chains*threads_per_chain}. For an example of using threading see
-the Stan case study \href{https://mc-stan.org/users/documentation/case-studies/reduce_sum_tutorial.html}{Reduce Sum: A Minimal Example}.
-This argument is available for the \verb{$sample()} method but not for the
-\verb{$sample_mpi()} method.}
-
-\item{show_messages}{(logical) When \code{TRUE} (the default), prints all
-informational messages, for example rejection of the current proposal.
-Disable if you wish silence these messages, but this is not recommended
-unless you are very sure that the model is correct up to numerical error.
-If the messages are silenced then the \verb{$output()} method of the resulting
-fit object can be used to display all the silenced messages.}
-
-\item{validate_csv}{(logical) When \code{TRUE} (the default), validate the
-sampling results in the csv files. Disable if you wish to manually read in
-the sampling results and validate them yourself, for example using
-\code{\link[=read_cmdstan_csv]{read_cmdstan_csv()}}.}
+\item{iter_warmup}{(positive integer) The number of warmup iterations to run
+per chain. Note: in the CmdStan User's Guide this is referred to as
+\code{num_warmup}.}
 
 \item{iter_sampling}{(positive integer) The number of post-warmup iterations
 to run per chain. Note: in the CmdStan User's Guide this is referred to as
 \code{num_samples}.}
 
-\item{iter_warmup}{(positive integer) The number of warmup iterations to run
-per chain. Note: in the CmdStan User's Guide this is referred to as
-\code{num_warmup}.}
-
 \item{save_warmup}{(logical) Should warmup iterations be saved? The default
 is \code{FALSE}. If \code{save_warmup=TRUE} then you can use
 \link[=fit-method-draws]{$draws(inc_warmup=TRUE)} to include warmup when
@@ -193,6 +189,24 @@ when, for example, trying to generate pseudo-data using the generated
 quantities block. If the parameters block is empty then using
 \code{fixed_param=TRUE} is mandatory. When \code{fixed_param=TRUE} the \code{chains} and
 \code{parallel_chains} arguments will be set to \code{1}.}
+
+\item{sig_figs}{(positive integer) The number of significant figures used
+when storing the output values. By default, CmdStan represent the output
+values with 6 significant figures. The upper limit for \code{sig_figs} is 18.
+Increasing this value will result in larger output CSV files and thus an
+increased usage of disk space.}
+
+\item{validate_csv}{(logical) When \code{TRUE} (the default), validate the
+sampling results in the csv files. Disable if you wish to manually read in
+the sampling results and validate them yourself, for example using
+\code{\link[=read_cmdstan_csv]{read_cmdstan_csv()}}.}
+
+\item{show_messages}{(logical) When \code{TRUE} (the default), prints all
+informational messages, for example rejection of the current proposal.
+Disable if you wish silence these messages, but this is not recommended
+unless you are very sure that the model is correct up to numerical error.
+If the messages are silenced then the \verb{$output()} method of the resulting
+fit object can be used to display all the silenced messages.}
 }
 \description{
 The \verb{$sample_mpi()} method of a \code{\link{CmdStanModel}} object is
@@ -226,40 +240,6 @@ other MPI launch arguments (\code{mpi_args}). In most cases, it is enough to
 only define the number of processes. To use \code{n_procs} processes specify
 \code{mpi_args = list(""n"" = n_procs)}.
 }
-\section{Usage}{
-\preformatted{$sample_mpi(
-  data = NULL,
-  mpi_cmd = ""mpiexec"",
-  mpi_args = NULL,
-  seed = NULL,
-  refresh = NULL,
-  init = NULL,
-  save_latent_dynamics = FALSE,
-  output_dir = NULL,
-  sig_figs = NULL,
-  chains = 4,
-  chain_ids = seq_len(chains),
-  iter_warmup = NULL,
-  iter_sampling = NULL,
-  save_warmup = FALSE,
-  thin = NULL,
-  max_treedepth = NULL,
-  adapt_engaged = TRUE,
-  adapt_delta = NULL,
-  step_size = NULL,
-  metric = NULL,
-  metric_file = NULL,
-  inv_metric = NULL,
-  init_buffer = NULL,
-  term_buffer = NULL,
-  window = NULL,
-  fixed_param = FALSE,
-  validate_csv = TRUE,
-  show_messages = TRUE
-)
-}
-}
-
 \section{Value}{
  A \code{\link{CmdStanMCMC}} object.
 }

---FILE: man/model-method-variational.Rd---
@@ -4,6 +4,28 @@
 \alias{model-method-variational}
 \alias{variational}
 \title{Run Stan's variational approximation algorithms}
+\usage{
+variational(
+  data = NULL,
+  seed = NULL,
+  refresh = NULL,
+  init = NULL,
+  save_latent_dynamics = FALSE,
+  output_dir = NULL,
+  sig_figs = NULL,
+  threads = NULL,
+  algorithm = NULL,
+  iter = NULL,
+  grad_samples = NULL,
+  elbo_samples = NULL,
+  eta = NULL,
+  adapt_engaged = NULL,
+  adapt_iter = NULL,
+  tol_rel_obj = NULL,
+  eval_elbo = NULL,
+  output_samples = NULL
+)
+}
 \arguments{
 \item{data}{(multiple options) The data to use for the variables specified in
 the \code{data} block of the Stan program. One of the following:
@@ -127,30 +149,6 @@ matrix for the approximation.
 
 -- \href{https://github.com/stan-dev/cmdstan/releases/latest}{\emph{CmdStan Interface User's Guide}}
 }
-\section{Usage}{
-\preformatted{$variational(
-  data = NULL,
-  seed = NULL,
-  refresh = NULL,
-  init = NULL,
-  save_latent_dynamics = FALSE,
-  output_dir = NULL,
-  sig_figs = NULL,
-  threads = NULL,
-  algorithm = NULL,
-  iter = NULL,
-  grad_samples = NULL,
-  elbo_samples = NULL,
-  eta = NULL,
-  adapt_engaged = NULL,
-  adapt_iter = NULL,
-  tol_rel_obj = NULL,
-  eval_elbo = NULL,
-  output_samples = NULL
-)
-}
-}
-
 \section{Value}{
  A \code{\link{CmdStanVB}} object.
 }",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,5e14aa3870d0a5574548541af0f829979aa07e56,jgabry,jgabry@gmail.com,2020-12-15T20:50:00Z,jgabry,jgabry@gmail.com,2020-12-15T20:50:00Z,fix url in vignette,docs/articles/cmdstanr.html;vignettes/cmdstanr.Rmd,True,False,True,False,18,18,36,"---FILE: docs/articles/cmdstanr.html---
@@ -155,7 +155,7 @@ <h2 class=""hasAnchor"">
 <div id=""installing-cmdstan"" class=""section level2"">
 <h2 class=""hasAnchor"">
 <a href=""#installing-cmdstan"" class=""anchor""></a>Installing CmdStan</h2>
-<p>CmdStanR requires a working installation of <a href=""https://mc-stan.org/users/interfaces/cmdstan/"">CmdStan</a>, the shell interface to Stan. If you dont have CmdStan installed then CmdStanR can install it for you, assuming you have a suitable C++ toolchain. The requirements are described in the CmdStan Guide:</p>
+<p>CmdStanR requires a working installation of <a href=""https://mc-stan.org/users/interfaces/cmdstan.html"">CmdStan</a>, the shell interface to Stan. If you dont have CmdStan installed then CmdStanR can install it for you, assuming you have a suitable C++ toolchain. The requirements are described in the CmdStan Guide:</p>
 <ul>
 <li><a href=""https://mc-stan.org/docs/cmdstan-guide/cmdstan-installation.html"" class=""uri"">https://mc-stan.org/docs/cmdstan-guide/cmdstan-installation.html</a></li>
 </ul>
@@ -347,7 +347,7 @@ <h3 class=""hasAnchor"">
 <a href=""#cmdstan-utilities"" class=""anchor""></a>CmdStan utilities</h3>
 <p>The <a href=""https://mc-stan.org/cmdstanr/reference/fit-method-cmdstan_summary.html""><code>$cmdstan_diagnose()</code></a> and <a href=""https://mc-stan.org/cmdstanr/reference/fit-method-cmdstan_summary.html""><code>$cmdstan_summary()</code></a> methods call CmdStans <code>diagnose</code> and <code>stansummary</code> utilities:</p>
 <div class=""sourceCode"" id=""cb34""><html><body><pre class=""r""><span class=""no"">fit</span>$<span class=""fu""><a href=""../reference/fit-method-cmdstan_summary.html"">cmdstan_diagnose</a></span>()</pre></body></html></div>
-<pre><code>Processing csv files: /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmpc0HNAt/bernoulli-202012121754-1-4ccd8b.csv, /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmpc0HNAt/bernoulli-202012121754-2-4ccd8b.csv, /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmpc0HNAt/bernoulli-202012121754-3-4ccd8b.csv, /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmpc0HNAt/bernoulli-202012121754-4-4ccd8b.csv
+<pre><code>Processing csv files: /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpzEjL6R/bernoulli-202012151349-1-91a8ba.csv, /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpzEjL6R/bernoulli-202012151349-2-91a8ba.csv, /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpzEjL6R/bernoulli-202012151349-3-91a8ba.csv, /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpzEjL6R/bernoulli-202012151349-4-91a8ba.csv
 
 Checking sampler transitions treedepth.
 Treedepth satisfactory for all transitions.
@@ -364,24 +364,24 @@ <h3 class=""hasAnchor"">
 
 Processing complete, no problems detected.</code></pre>
 <div class=""sourceCode"" id=""cb36""><html><body><pre class=""r""><span class=""no"">fit</span>$<span class=""fu""><a href=""../reference/fit-method-cmdstan_summary.html"">cmdstan_summary</a></span>()</pre></body></html></div>
-<pre><code>Input files: /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmpc0HNAt/bernoulli-202012121754-1-4ccd8b.csv, /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmpc0HNAt/bernoulli-202012121754-2-4ccd8b.csv, /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmpc0HNAt/bernoulli-202012121754-3-4ccd8b.csv, /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmpc0HNAt/bernoulli-202012121754-4-4ccd8b.csv
+<pre><code>Input files: /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpzEjL6R/bernoulli-202012151349-1-91a8ba.csv, /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpzEjL6R/bernoulli-202012151349-2-91a8ba.csv, /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpzEjL6R/bernoulli-202012151349-3-91a8ba.csv, /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpzEjL6R/bernoulli-202012151349-4-91a8ba.csv
 Inference for Stan model: bernoulli_model
 4 chains: each with iter=(1000,1000,1000,1000); warmup=(0,0,0,0); thin=(1,1,1,1); 4000 iterations saved.
 
-Warmup took (0.0060, 0.0070, 0.0050, 0.0060) seconds, 0.024 seconds total
-Sampling took (0.018, 0.015, 0.014, 0.013) seconds, 0.060 seconds total
+Warmup took (0.0060, 0.0060, 0.0060, 0.0060) seconds, 0.024 seconds total
+Sampling took (0.015, 0.014, 0.013, 0.013) seconds, 0.055 seconds total
 
                 Mean     MCSE  StdDev     5%   50%   95%    N_Eff  N_Eff/s    R_hat
 
-lp__            -7.3  2.0e-02    0.76   -8.8  -7.0  -6.8     1431    23846      1.0
-accept_stat__   0.90  2.5e-03    0.15   0.57  0.97   1.0  3.7e+03  6.2e+04  1.0e+00
-stepsize__       1.1  8.8e-02    0.12   0.93   1.2   1.3  2.0e+00  3.3e+01  3.5e+13
-treedepth__      1.4  8.2e-03    0.51    1.0   1.0   2.0  3.8e+03  6.3e+04  1.0e+00
-n_leapfrog__     2.5  1.9e-01     1.3    1.0   3.0   3.0  4.3e+01  7.2e+02  1.0e+00
+lp__            -7.3  2.0e-02    0.76   -8.8  -7.0  -6.8     1431    26014      1.0
+accept_stat__   0.90  2.5e-03    0.15   0.57  0.97   1.0  3.7e+03  6.7e+04  1.0e+00
+stepsize__       1.1  8.8e-02    0.12   0.93   1.2   1.3  2.0e+00  3.6e+01  3.5e+13
+treedepth__      1.4  8.2e-03    0.51    1.0   1.0   2.0  3.8e+03  6.9e+04  1.0e+00
+n_leapfrog__     2.5  1.9e-01     1.3    1.0   3.0   3.0  4.3e+01  7.9e+02  1.0e+00
 divergent__     0.00      nan    0.00   0.00  0.00  0.00      nan      nan      nan
-energy__         7.8  2.7e-02     1.0    6.8   7.4   9.9  1.5e+03  2.4e+04  1.0e+00
+energy__         7.8  2.7e-02     1.0    6.8   7.4   9.9  1.5e+03  2.7e+04  1.0e+00
 
-theta           0.25  3.1e-03    0.12  0.080  0.24  0.48     1542    25706      1.0
+theta           0.25  3.1e-03    0.12  0.080  0.24  0.48     1542    28043      1.0
 
 Samples were drawn using hmc with nuts.
 For each parameter, N_Eff is a crude measure of effective sample size,
@@ -434,8 +434,8 @@ <h3 class=""hasAnchor"">
   This procedure has not been thoroughly tested and may be unstable 
   or buggy. The interface is subject to change. 
 ------------------------------------------------------------ 
-Gradient evaluation took 1.2e-05 seconds 
-1000 transitions using 10 leapfrog steps per transition would take 0.12 seconds. 
+Gradient evaluation took 9e-06 seconds 
+1000 transitions using 10 leapfrog steps per transition would take 0.09 seconds. 
 Adjust your expectations accordingly! 
 Begin eta adaptation. 
 Iteration:   1 / 250 [  0%]  (Adaptation) 

---FILE: vignettes/cmdstanr.Rmd---
@@ -59,10 +59,10 @@ color_scheme_set(""brightblue"")
 ## Installing CmdStan
 
 CmdStanR requires a working installation of
-[CmdStan](https://mc-stan.org/users/interfaces/cmdstan/), the shell interface to
-Stan. If you don't have CmdStan installed then CmdStanR can install it for you,
-assuming you have a suitable C++ toolchain. The requirements are described in
-the CmdStan Guide:
+[CmdStan](https://mc-stan.org/users/interfaces/cmdstan.html), the shell
+interface to Stan. If you don't have CmdStan installed then CmdStanR can install
+it for you, assuming you have a suitable C++ toolchain. The requirements are
+described in the CmdStan Guide:
 
 * https://mc-stan.org/docs/cmdstan-guide/cmdstan-installation.html
 ",False,True,Documentation / Formatting,4
stan-dev,cmdstanr,56c4cd2fac3bd3674b767c4216f2adb6a4e1842c,jgabry,jgabry@gmail.com,2020-12-15T05:01:13Z,jgabry,jgabry@gmail.com,2020-12-15T05:01:13Z,"only look for ""PCH file""

fixes #400",R/model.R,False,True,True,False,7,4,11,"---FILE: R/model.R---
@@ -505,10 +505,13 @@ compile_method <- function(quiet = TRUE,
     spinner = quiet && interactive(),
     stderr_line_callback = function(x,p) {
       if (!startsWith(x, paste0(make_cmd(), "": *** No rule to make target""))) message(x)
-      if (grepl(""PCH file uses an older PCH format that is no longer supported"", x, fixed = TRUE)
-          || grepl(""PCH file built from a different branch"", x, fixed = TRUE)) {
-        warning(""Cmdstan encountered an issue with an outdated precompiled header (PCH). Run rebuild_cmdstan() to rebuild the PCH files.\n"",
-        ""If the issue persists please open a bug report."")
+      if (grepl(""PCH file"", x)) {
+        warning(
+          ""CmdStan encountered an issue with an outdated precompiled header (PCH). "",
+          ""Please run rebuild_cmdstan() to rebuild the PCH files.\n"",
+          ""If the issue persists please open a bug report."",
+          call. = FALSE
+        )
       }
     },
     error_on_status = FALSE",True,False,Implementation / Logic,6
stan-dev,cmdstanr,8e5f5d23afdf508f5d8680dcacd3a0948e5ddecd,jgabry,jgabry@gmail.com,2020-12-14T18:49:55Z,jgabry,jgabry@gmail.com,2020-12-14T18:49:55Z,"new line after message about max_rows

fixes #402",R/fit.R,False,True,True,False,1,1,2,"---FILE: R/fit.R---
@@ -127,7 +127,7 @@ CmdStanFit <- R6::R6Class(
       print(out, row.names=FALSE)
       if (max_rows < total_rows) {
         cat(""\n # showing"", max_rows, ""of"", total_rows,
-            ""rows (change via 'max_rows' argument)"")
+            ""rows (change via 'max_rows' argument)\n"")
       }
       invisible(self)
     },",True,False,Implementation / Logic,6
stan-dev,cmdstanr,5b7f8139fc44e2df3adfb05535fd5872d9e37218,jgabry,jgabry@gmail.com,2020-12-14T18:39:57Z,jgabry,jgabry@gmail.com,2020-12-14T18:39:57Z,"allow empty data list

fixes #401",R/data.R;tests/testthat/test-model-data.R,False,True,True,False,21,0,21,"---FILE: R/data.R---
@@ -84,6 +84,9 @@ list_to_array <- function(x, name = NULL) {
 #'   CmdStan, or a named list of \R objects to pass to [write_stan_json()].
 #' @return Path to data file.
 process_data <- function(data) {
+  if (length(data) == 0) {
+    data <- NULL
+  }
   if (is.null(data)) {
     path <- data
   } else if (is.character(data)) {

---FILE: tests/testthat/test-model-data.R---
@@ -46,3 +46,21 @@ test_that(""error if data contains NA elements"", {
   expect_error(mod$sample(data = data_list2), ""Data includes NA values"")
   expect_error(mod$sample(data = data_list3), ""Data includes NA values"")
 })
+
+test_that(""empty data list doesn't error if no data block"", {
+  mod <- cmdstan_model(write_stan_file(""
+  parameters {
+    real x;
+  }
+  model {
+    x ~ normal(0, 1);
+  }
+  ""))
+
+  expect_sample_output(
+    fit <- mod$sample(data = list(), chains = 1)
+  )
+
+  # would error if fitting failed
+  expect_silent(fit$draws())
+})",True,False,Implementation / Logic,6
stan-dev,cmdstanr,1e0cb7f63fec1d0f05b3cdb19f302316743a07a5,jgabry,jgabry@gmail.com,2020-12-12T22:00:50Z,jgabry,jgabry@gmail.com,2020-12-12T22:00:50Z,fix test,tests/testthat/test-model-optimize.R,False,True,True,False,6,3,9,"---FILE: tests/testthat/test-model-optimize.R---
@@ -84,9 +84,8 @@ test_that(""optimize() errors with bad combination of arguments"", {
     ""'tol_grad' can't be used when algorithm is 'newton'""
   )
   expect_error(
-    mod$optimize(data = data_list, algorithm = ""bfgs"", history_size = -10),
-    ""not >= 0"",
-    fixed = TRUE
+    mod$optimize(data = data_list, algorithm = ""bfgs"", tol_obj = -10),
+    ""not >= 0""
   )
   expect_error(
     mod$optimize(data = data_list, init_alpha = 0.1),
@@ -106,6 +105,10 @@ test_that(""optimize() errors with bad combination of arguments"", {
     mod$optimize(data = data_list, algorithm = ""lbfgs"", history_size = 1.5),
     ""Must be of type 'integerish'""
   )
+  expect_error(
+    mod$optimize(data = data_list, algorithm = ""lbfgs"", history_size = -1),
+    ""not >= 1""
+  )
 })
 
 test_that(""optimize() works with (L-)BFGS tolerances specified"", {",True,False,Implementation / Logic,3
stan-dev,cmdstanr,7eb46059ac8184b39073f774f212ccc4300fed56,jgabry,jgabry@gmail.com,2020-12-12T19:28:16Z,jgabry,jgabry@gmail.com,2020-12-12T19:28:16Z,fix 'iter' doc,R/model.R;man/model-method-optimize.Rd,False,True,True,False,2,2,4,"---FILE: R/model.R---
@@ -1203,7 +1203,7 @@ CmdStanModel$set(""public"", name = ""sample_mpi"", value = sample_mpi_method)
 #'   `""bfgs""`, or `""newton""`. The control parameters below are only available
 #'   for `""lbfgs""` and `""bfgs`. For their default values see the CmdStan User's
 #'   Guide or run `cmdstanr_example(method=""optimize"")$metadata()`.
-#'   * `iter`: (positive integer) The number of iterations.
+#'   * `iter`: (positive integer) The maximum number of iterations.
 #'   * `init_alpha`: (positive real) The initial step size parameter.
 #'   * `tol_obj`: (positive real) Convergence tolerance on changes in objective function value.
 #'   * `tol_rel_obj`: (positive real) Convergence tolerance on relative changes in objective function value.

---FILE: man/model-method-optimize.Rd---
@@ -127,7 +127,7 @@ using the Stan functions \code{reduce_sum()} or \code{map_rect()}).
 \code{""bfgs""}, or \code{""newton""}. The control parameters below are only available
 for \code{""lbfgs""} and \verb{""bfgs}. For their default values see the CmdStan User's
 Guide or run \code{cmdstanr_example(method=""optimize"")$metadata()}.
-\item \code{iter}: (positive integer) The number of iterations.
+\item \code{iter}: (positive integer) The maximum number of iterations.
 \item \code{init_alpha}: (positive real) The initial step size parameter.
 \item \code{tol_obj}: (positive real) Convergence tolerance on changes in objective function value.
 \item \code{tol_rel_obj}: (positive real) Convergence tolerance on relative changes in objective function value.",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,72e9b65d6ae0cee813a2a539fab30706c2f35947,jgabry,jgabry@gmail.com,2020-12-12T19:25:56Z,jgabry,jgabry@gmail.com,2020-12-12T19:25:56Z,"fix tests

.make_arg('algorithm') needs to come after .make_arg('iter')",R/args.R,False,True,True,False,3,3,6,"---FILE: R/args.R---
@@ -343,9 +343,9 @@ OptimizeArgs <- R6::R6Class(
   lock_objects = FALSE,
   public = list(
     method = ""optimize"",
-    initialize = function(algorithm = NULL,
+    initialize = function(iter = NULL,
+                          algorithm = NULL,
                           init_alpha = NULL,
-                          iter = NULL,
                           tol_obj = NULL,
                           tol_rel_obj = NULL,
                           tol_grad = NULL,
@@ -377,8 +377,8 @@ OptimizeArgs <- R6::R6Class(
       }
       new_args <- list(
         ""method=optimize"",
-        .make_arg(""algorithm""),
         .make_arg(""iter""),
+        .make_arg(""algorithm""),
         .make_arg(""init_alpha""),
         .make_arg(""tol_obj""),
         .make_arg(""tol_rel_obj""),",True,False,Implementation / Logic,6
stan-dev,cmdstanr,759e5f96331c35e8d05edbc3e3313d96cc9aca76,jgabry,jgabry@gmail.com,2020-12-08T19:48:50Z,jgabry,jgabry@gmail.com,2020-12-08T19:48:50Z,"break up long error message line (doesn't matter, just easier to read)",R/data.R,False,True,True,False,5,2,7,"---FILE: R/data.R---
@@ -191,7 +191,7 @@ draws_to_csv <- function(draws, sampler_diagnostics = NULL) {
 process_fitted_params <- function(fitted_params) {
   if (is.character(fitted_params)) {
     paths <- absolute_path(fitted_params)
-  } else if (checkmate::test_r6(fitted_params, classes = ""CmdStanMCMC"") && 
+  } else if (checkmate::test_r6(fitted_params, classes = ""CmdStanMCMC"") &&
               all(file.exists(fitted_params$output_files()))) {
       paths <- absolute_path(fitted_params$output_files())
   } else if(checkmate::test_r6(fitted_params, classes = c(""CmdStanMCMC""))) {
@@ -218,7 +218,10 @@ process_fitted_params <- function(fitted_params) {
   } else if (any(class(fitted_params) == ""draws_matrix"")){
     paths <- draws_to_csv(posterior::as_draws_array(fitted_params))
   } else {
-    stop(""'fitted_params' must be a list of paths to CSV files, a CmdStanMCMC/CmdStanVB object, a posterior::draws_array or a posterior::draws_matrix."", call. = FALSE)
+    stop(
+      ""'fitted_params' must be a list of paths to CSV files, "",
+      ""a CmdStanMCMC/CmdStanVB object, "",
+      ""a posterior::draws_array or a posterior::draws_matrix."", call. = FALSE)
   }
   paths
 }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,ba33a301e4b7684534763c052fc52b5aba7c8b54,jgabry,jgabry@gmail.com,2020-12-04T23:17:13Z,jgabry,jgabry@gmail.com,2020-12-04T23:17:13Z,"use 1 core in test

I think the test is erroring on windows because we still have a bug in relative_eff with multiple cores in the released version of loo. will be fixed in the new loo.",tests/testthat/test-fit-mcmc.R,False,True,True,False,1,1,2,"---FILE: tests/testthat/test-fit-mcmc.R---
@@ -259,7 +259,7 @@ test_that(""loo method works if log_lik is available"", {
   skip_on_cran()
   skip_if_not_installed(""loo"")
   fit_bernoulli <- testing_fit(""bernoulli_log_lik"")
-  expect_s3_class(suppressWarnings(fit_bernoulli$loo(cores = 2, save_psis = TRUE)), ""loo"")
+  expect_s3_class(suppressWarnings(fit_bernoulli$loo(cores = 1, save_psis = TRUE)), ""loo"")
   expect_s3_class(suppressWarnings(fit_bernoulli$loo(r_eff = FALSE)), ""loo"")
 })
 ",True,False,Implementation / Logic,3
stan-dev,cmdstanr,6b9ba1f0c63f0bd30a19cdb4e4e4af8cb0c57273,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-12-03T20:42:49Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-12-03T20:42:49Z,catch PCH issues,R/model.R,False,True,True,False,5,0,5,"---FILE: R/model.R---
@@ -503,6 +503,11 @@ compile_method <- function(quiet = TRUE,
     spinner = quiet && interactive(),
     stderr_line_callback = function(x,p) {
       if (!startsWith(x, paste0(make_cmd(), "": *** No rule to make target""))) message(x)
+      if (regexpr(""PCH file uses an older PCH format that is no longer supported"", x, fixed = TRUE) > 0
+          || regexpr(""PCH file built from a different branch"", x, fixed = TRUE) > 0) {
+        warning(""Cmdstan encounterd an issue with an outdated precompiled header (PCH). Run rebuild_cmdstan() to rebuild the PCH files.\n"",
+        ""If the issue persists please open a bug report."")
+      }
     },
     error_on_status = FALSE
   )",True,False,Implementation / Logic,6
stan-dev,cmdstanr,00660e5dc45d22fcf6fd2aa83ba68ec065c778ed,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-12-01T19:40:40Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-12-01T19:40:40Z,error if CMDSTAN_VERSION is not present,R/path.R,False,True,True,False,3,0,3,"---FILE: R/path.R---
@@ -157,6 +157,9 @@ read_cmdstan_version <- function(path) {
   }
   makefile <- readLines(makefile_path)
   version_line <- grep(""^CMDSTAN_VERSION :="", makefile, value = TRUE)
+  if (length(version_line) == 0) {
+    stop(""CmdStan makefile is missing a version number."", call. = FALSE)
+  }
   sub(""CMDSTAN_VERSION := "", """", version_line)
 }
 ",True,False,Implementation / Logic,6
stan-dev,cmdstanr,c36b49b34276bbe9912bdc62529a6176fe136617,jgabry,jgabry@gmail.com,2020-12-01T18:22:35Z,jgabry,jgabry@gmail.com,2020-12-01T18:22:35Z,fix typo,R/fit.R;docs/reference/fit-method-summary.html;man/fit-method-summary.Rd,False,True,True,False,4,4,8,"---FILE: R/fit.R---
@@ -502,7 +502,7 @@ NULL
 #' @aliases summary print.CmdStanMCMC print.CmdStanMLE print.CmdStanVB
 #' @description The `$summary()` method runs
 #'   [`summarise_draws()`][posterior::draws_summary] from the \pkg{posterior}
-#'   package and returns the ouput. For MCMC only post-warmup draws are included
+#'   package and returns the output. For MCMC only post-warmup draws are included
 #'   in the summary.
 #'
 #'   The `$print()` method prints the same summary stats but removes the extra

---FILE: docs/reference/fit-method-summary.html---
@@ -49,7 +49,7 @@
 <meta property=""og:title"" content=""Compute a summary table of MCMC estimates and diagnostics  fit-method-summary"" />
 <meta property=""og:description"" content=""The $summary() method runs
 summarise_draws() from the posterior
-package and returns the ouput. For MCMC only post-warmup draws are included
+package and returns the output. For MCMC only post-warmup draws are included
 in the summary.
 The $print() method prints the same summary stats but removes the extra
 formatting used for printing tibbles and returns the fitted model object
@@ -188,7 +188,7 @@ <h1>Compute a summary table of MCMC estimates and diagnostics</h1>
     <div class=""ref-description"">
     <p>The <code>$summary()</code> method runs
 <code><a href='https://mc-stan.org/posterior/reference/draws_summary.html'>summarise_draws()</a></code> from the <span class=""pkg"">posterior</span>
-package and returns the ouput. For MCMC only post-warmup draws are included
+package and returns the output. For MCMC only post-warmup draws are included
 in the summary.</p>
 <p>The <code>$print()</code> method prints the same summary stats but removes the extra
 formatting used for printing tibbles and returns the fitted model object

---FILE: man/fit-method-summary.Rd---
@@ -10,7 +10,7 @@
 \description{
 The \verb{$summary()} method runs
 \code{\link[posterior:draws_summary]{summarise_draws()}} from the \pkg{posterior}
-package and returns the ouput. For MCMC only post-warmup draws are included
+package and returns the output. For MCMC only post-warmup draws are included
 in the summary.
 
 The \verb{$print()} method prints the same summary stats but removes the extra",True,False,Documentation / Formatting,7
stan-dev,cmdstanr,fd35431b736f667a8e617143b56adbbce52f35bb,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-11-25T14:05:29Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-11-25T14:05:29Z,fix tests,tests/testthat/test-model-generate_quantities.R;tests/testthat/test-threads.R,False,True,True,False,1,1,2,"---FILE: tests/testthat/test-model-generate_quantities.R---
@@ -60,6 +60,7 @@ test_that(""generate_quantities work for different chains and parallel_chains"", {
   expect_gq_output(
     mod_gq$generate_quantities(data = data_list, fitted_params = fit, parallel_chains = 4)
   )
+  mod_gq <- cmdstan_model(testing_stan_file(""bernoulli_ppc""), cpp_options = list(stan_threads = TRUE))
   expect_gq_output(
     mod_gq$generate_quantities(data = data_list, fitted_params = fit_1_chain, threads_per_chain = 2)
   )

---FILE: tests/testthat/test-threads.R---
@@ -162,6 +162,5 @@ test_that(""threading works with generate_quantities()"", {
   )
   expect_equal(as.integer(Sys.getenv(""STAN_NUM_THREADS"")), 4)
   expect_equal(f_gq$metadata()$threads_per_chain, 4)
-  file.remove(mod_gq$exe_file())
 })
 ",True,False,Environment / Configuration,3
stan-dev,cmdstanr,79568aabcbe1b6deae3b5bbff72adb7ec9a993d0,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-11-20T16:53:23Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-11-20T16:53:23Z,fix test,tests/testthat/test-model-compile.R,False,True,True,False,3,6,9,"---FILE: tests/testthat/test-model-compile.R---
@@ -342,13 +342,10 @@ test_that(""pedantic check works"", {
     ""Stan program is syntactically correct""
   )
 
-  a <- utils::capture.output(
-    expect_message(
-     mod_pedantic_warn$check_syntax(stanc_options = list(""warn-pedantic"" = TRUE)),
-     """"
-    )
+  expect_message(
+    mod_pedantic_warn$check_syntax(stanc_options = list(""warn-pedantic"" = TRUE)),
+    ""The parameter x was declared but was not used in the density calculation.""
   )
-  expect_match(paste0(a, collapse = ""\n""), ""The parameter x was declared but was not used in the density calculation."")
 })
 
 test_that(""compiling stops on hyphens in stanc_options"", {",True,False,Rendering / Conversion,3
stan-dev,cmdstanr,b8803501049cf03c07174df112fdc55419d00597,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-11-20T15:49:30Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-11-20T15:49:30Z,fix double warning,R/model.R;tests/testthat/test-model-compile.R,False,True,True,False,35,1,36,"---FILE: R/model.R---
@@ -600,8 +600,11 @@ check_syntax_method <- function(quiet = FALSE,
     command = stanc_cmd(),
     args = c(self$stan_file(), stanc_built_options, stancflags_val),
     wd = cmdstan_path(),
-    echo = !quiet,
+    echo = FALSE,
     spinner = quiet && interactive(),
+    stdout_line_callback = function(x,p) {
+      if (!quiet) cat(x)
+    },
     stderr_line_callback = function(x,p) {
       message(x)
     },

---FILE: tests/testthat/test-model-compile.R---
@@ -280,6 +280,37 @@ test_that(""check_syntax() works"", {
     mod_ok$check_syntax(stanc_options = list(""allow-undefined"", ""warn-pedantic""), quiet = TRUE),
     regexp = NA
   )
+
+  pedantic_model <- write_stan_file(""
+  data {
+    int N;
+    int y[N];
+  }
+  parameters {
+    // should have <lower=0> but omitting to demonstrate pedantic mode
+    real lambda;
+  }
+  model {
+    y ~ poisson(lambda);
+  }
+  "")
+  mod_pedantic <- cmdstan_model(pedantic_model, compile = FALSE)
+  expect_output(
+    mod_pedantic$check_syntax(stanc_options = list(""warn-pedantic"")),
+    regexp = NA
+  )
+  expect_message(
+    mod_pedantic$check_syntax(stanc_options = list(""warn-pedantic"")),
+    ""The parameter lambda has no priors.""
+  )
+  expect_output(
+    mod_pedantic$check_syntax(stanc_options = list(""warn-pedantic""), quiet = TRUE),
+    regexp = NA
+  )
+  expect_message(
+    mod_pedantic$check_syntax(stanc_options = list(""warn-pedantic""), quiet = TRUE),
+    ""The parameter lambda has no priors.""
+  )
 })
 
 test_that(""check_syntax() works with include_paths"", {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,6deb453cda91d402c9ff299b076fddcbfd2459fb,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-11-18T18:16:24Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-11-18T18:16:24Z,fix handling cpp_options,R/utils.R,False,True,True,False,6,2,8,"---FILE: R/utils.R---
@@ -203,9 +203,13 @@ cpp_options_to_compile_flags <- function(cpp_options) {
   cpp_built_options = c()
   for (i in seq_len(length(cpp_options))) {
     option_name <- names(cpp_options)[i]
-    cpp_built_options = c(cpp_built_options, paste0(toupper(option_name), ""="", cpp_options[[i]]))
+    if (is.null(option_name) || !nzchar(option_name)) {
+      cpp_built_options = c(cpp_built_options, toupper(cpp_options[[i]]))
+    } else {
+      cpp_built_options = c(cpp_built_options, paste0(toupper(option_name), ""="", cpp_options[[i]]))
+    }    
   }
-  paste0(cpp_built_options, collapse = "" "")
+  cpp_built_options
 }
 
 check_stanc_options <- function(stanc_options) {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,d537225e38f233a719ea1add88ab2730730cc7aa,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-11-15T09:48:43Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-11-15T09:48:43Z,fix GQ,R/fit.R,False,True,True,False,1,1,2,"---FILE: R/fit.R---
@@ -1230,7 +1230,7 @@ CmdStanGQ <- R6::R6Class(
         stop(""Can't find the following variable(s) in the output: "",
              paste(matching_res$not_found, collapse = "", ""), call. = FALSE)
       }
-      private$draws_[,,variables]
+      private$draws_[,,matching_res$matching]
     },
     output = function(id = NULL) {
       if (is.null(id)) {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,193a077959d5d8fca8dc0fb83f681a0b06f3540e,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-11-13T08:49:16Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-11-13T08:49:16Z,fix stanc options handling in check_syntax,NEWS.md;R/model.R;tests/testthat/test-model-compile.R,False,True,True,False,18,1,19,"---FILE: NEWS.md---
@@ -1,3 +1,11 @@
+# Items for next tagged release
+
+### Bug fixes
+
+* Fixed bug with processing stanc_options in `check_syntax()`.
+
+### New features
+
 # cmdstanr 0.2.0
 
 ### Bug fixes

---FILE: R/model.R---
@@ -584,12 +584,13 @@ check_syntax_method <- function(quiet = FALSE,
   if (is.null(stanc_options[[""name""]])) {
     stanc_options[[""name""]] <- model_name
   }
-
   stanc_built_options = c()
   for (i in seq_len(length(stanc_options))) {
     option_name <- names(stanc_options)[i]
     if (isTRUE(as.logical(stanc_options[[i]]))) {
       stanc_built_options <- c(stanc_built_options, paste0(""--"", option_name))
+    } else if (is.null(option_name) || !nzchar(option_name)) {
+      stanc_built_options <- c(stanc_built_options, paste0(""--"", stanc_options[[i]]))
     } else {
       stanc_built_options <- c(stanc_built_options, paste0(""--"", option_name, ""="", stanc_options[[i]]))
     }

---FILE: tests/testthat/test-model-compile.R---
@@ -255,6 +255,14 @@ test_that(""check_syntax() works"", {
     mod_ok$check_syntax(quiet = TRUE),
     regexp = NA
   )
+  expect_message(
+    mod_ok$check_syntax(stanc_options = list(""allow-undefined"", ""warn-pedantic"")),
+    ""Stan program is syntactically correct""
+  )
+  expect_message(
+    mod_ok$check_syntax(stanc_options = list(""allow-undefined"", ""warn-pedantic""), quiet = TRUE),
+    regexp = NA
+  )
 })
 
 test_that(""check_syntax() works with include_paths"", {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,1a30f3749d41fad4b1d6c4bdbb9a61219d8e56e4,jgabry,jgabry@gmail.com,2020-11-13T00:37:23Z,jgabry,jgabry@gmail.com,2020-11-13T00:37:23Z,Fix doc for quiet arg in check_syntax,R/model.R;docs/reference/model-method-check_syntax.html;man/model-method-check_syntax.Rd,False,True,True,False,16,21,37,"---FILE: R/model.R---
@@ -485,7 +485,6 @@ compile_method <- function(quiet = TRUE,
              cpp_options_to_compile_flags(cpp_options),
              stancflags_val),
     wd = cmdstan_path(),
-    echo_cmd = !quiet,
     echo = !quiet,
     spinner = quiet && interactive(),
     stderr_line_callback = function(x,p) {
@@ -521,17 +520,17 @@ CmdStanModel$set(""public"", name = ""compile"", value = compile_method)
 #' @section Usage:
 #'   ```
 #'   $check_syntax(
-#'     quiet = TRUE,
+#'     quiet = FALSE,
 #'     include_paths = NULL,
 #'     stanc_options = list()
 #'   )
 #'   ```
 #'
 #' @section Arguments:
-#'   * `quiet`: (logical) Should informational messages be printed? Default is
-#'   `FALSE`, which will print a message if the model is valid or the compiler
-#'   error message if there are syntax errors in the model. If `TRUE`, only the
-#'   error message will be printed.
+#'   * `quiet`: (logical) Should informational messages be suppressed? The
+#'   default is `FALSE`, which will print a message if the Stan program is valid
+#'   or the compiler error message if there are syntax errors. If `TRUE`, only
+#'   the error message will be printed.
 #'   * `include_paths`: (character vector) Paths to directories where Stan
 #'   should look for files specified in `#include` directives in the Stan
 #'   program.
@@ -600,7 +599,6 @@ check_syntax_method <- function(quiet = FALSE,
     command = stanc_cmd(),
     args = c(self$stan_file(), stanc_built_options, stancflags_val),
     wd = cmdstan_path(),
-    echo_cmd = !quiet,
     echo = !quiet,
     spinner = quiet && interactive(),
     stderr_line_callback = function(x,p) {

---FILE: docs/reference/model-method-check_syntax.html---
@@ -189,7 +189,7 @@ <h2 class=""hasAnchor"" id=""usage""><a class=""anchor"" href=""#usage""></a>Usage</h2>
 
     
 <pre>$check_syntax(
-  quiet = TRUE,
+  quiet = FALSE,
   include_paths = NULL,
   stanc_options = list()
 )
@@ -200,10 +200,10 @@ <h2 class=""hasAnchor"" id=""arguments""><a class=""anchor"" href=""#arguments""></a>Arg
     
 
 <ul>
-<li><p><code>quiet</code>: (logical) Should informational messages be printed? Default is
-<code>FALSE</code>, which will print a message if the model is valid or the compiler
-error message if there are syntax errors in the model. If <code>TRUE</code>, only the
-error message will be printed.</p></li>
+<li><p><code>quiet</code>: (logical) Should informational messages be suppressed? The
+default is <code>FALSE</code>, which will print a message if the Stan program is valid
+or the compiler error message if there are syntax errors. If <code>TRUE</code>, only
+the error message will be printed.</p></li>
 <li><p><code>include_paths</code>: (character vector) Paths to directories where Stan
 should look for files specified in <code>#include</code> directives in the Stan
 program.</p></li>
@@ -238,10 +238,7 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 <span class='no'>file</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/file.path.html'>file.path</a></span>(<span class='fu'><a href='set_cmdstan_path.html'>cmdstan_path</a></span>(), <span class='st'>""examples/bernoulli/bernoulli.stan""</span>)
 
 <span class='no'>mod</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='cmdstan_model.html'>cmdstan_model</a></span>(<span class='no'>file</span>, <span class='kw'>compile</span> <span class='kw'>=</span> <span class='fl'>FALSE</span>)
-<span class='no'>mod</span>$<span class='fu'>check_syntax</span>()</div><div class='output co'>#&gt; Running bin/stanc \
-#&gt;   /Users/jgabry/.cmdstanr/cmdstan-2.25.0/examples/bernoulli/bernoulli.stan \
-#&gt;   '--o=/var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//RtmpL7jcf4/model-4754fa99a.hpp' \
-#&gt;   '--name=bernoulli_model'</div><div class='output co'>#&gt; <span class='message'>Stan program is syntactically correct</span></div><div class='input'># }
+<span class='no'>mod</span>$<span class='fu'>check_syntax</span>()</div><div class='output co'>#&gt; <span class='message'>Stan program is syntactically correct</span></div><div class='input'># }
 
 </div></pre>
   </div>

---FILE: man/model-method-check_syntax.Rd---
@@ -11,7 +11,7 @@ parsing succeeds. If invalid syntax in found an error is thrown.
 }
 \section{Usage}{
 \preformatted{$check_syntax(
-  quiet = TRUE,
+  quiet = FALSE,
   include_paths = NULL,
   stanc_options = list()
 )
@@ -21,10 +21,10 @@ parsing succeeds. If invalid syntax in found an error is thrown.
 \section{Arguments}{
 
 \itemize{
-\item \code{quiet}: (logical) Should informational messages be printed? Default is
-\code{FALSE}, which will print a message if the model is valid or the compiler
-error message if there are syntax errors in the model. If \code{TRUE}, only the
-error message will be printed.
+\item \code{quiet}: (logical) Should informational messages be suppressed? The
+default is \code{FALSE}, which will print a message if the Stan program is valid
+or the compiler error message if there are syntax errors. If \code{TRUE}, only
+the error message will be printed.
 \item \code{include_paths}: (character vector) Paths to directories where Stan
 should look for files specified in \verb{#include} directives in the Stan
 program.",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,f92fb24714b809975574bff1cfdc8cb30f57938a,jgabry,jgabry@gmail.com,2020-11-12T23:33:38Z,jgabry,jgabry@gmail.com,2020-11-12T23:33:38Z,"fix R cmd check NOTE

runif -> stats::runif",R/utils.R,False,True,True,False,1,1,2,"---FILE: R/utils.R---
@@ -183,7 +183,7 @@ generate_file_names <-
       new_names <- paste0(new_names, ""-"", ids)
     }
     if (random) {
-      rand_num_pid <- as.integer(runif(1, min = 0, max = 1E7)) + Sys.getpid()
+      rand_num_pid <- as.integer(stats::runif(1, min = 0, max = 1E7)) + Sys.getpid()
       rand <- format(as.hexmode(rand_num_pid) , width = 6)
       new_names <- paste0(new_names, ""-"", rand)
     }",True,False,Implementation / Logic,3
stan-dev,cmdstanr,36519ed596b76eec4a731a32bb5b7d2d3cd92876,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-11-12T20:41:23Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-11-12T20:41:23Z,bugfix,R/model.R;R/utils.R;tests/testthat/test-model-compile.R,False,True,True,False,6,4,10,"---FILE: R/model.R---
@@ -470,8 +470,10 @@ compile_method <- function(quiet = TRUE,
   stanc_built_options = c()
   for (i in seq_len(length(stanc_options))) {
     option_name <- names(stanc_options)[i]
-    if (isTRUE(as.logical(stanc_options[[i]])) || is.null(option_name)) {
+    if (isTRUE(as.logical(stanc_options[[i]]))) {
       stanc_built_options = c(stanc_built_options, paste0(""--"", option_name))
+    } else if (is.null(option_name) || !nzchar(option_name)) {
+      stanc_built_options = c(stanc_built_options, paste0(""--"", stanc_options[[i]]))
     } else {
       stanc_built_options = c(stanc_built_options, paste0(""--"", option_name, ""="", ""'"", stanc_options[[i]], ""'""))
     }

---FILE: R/utils.R---
@@ -215,7 +215,7 @@ check_stanc_options <- function(stanc_options) {
     if(!is.null(names[i]) && nzchar(names[i])) {
       name <- names[i]
     } else {
-      name <- stanc_options[[i]]
+      name <- s
     }
     if (startsWith(name, ""--"")) {
       stop(""No leading hyphens allowed in stanc options ("",name, ""). Use options without leading hyphens, like for example `stanc_options = list('allow-undefined')`"",

---FILE: tests/testthat/test-model-compile.R---
@@ -338,8 +338,8 @@ test_that(""compiling works with only names in list"", {
   skip_on_cran()
   stan_file <- testing_stan_file(""bernoulli"")
   mod <- cmdstan_model(stan_file, stanc_options = list(""allow-undefined"", ""warn-pedantic""), force_recompile = TRUE)
-  expect_type(
+  checkmate::expect_r6(
     mod,
-    ""dada""
+    ""CmdStanModel""
   )
 })",True,False,Implementation / Logic,6
stan-dev,cmdstanr,04ac91d20aa36a4ea8b767301f92670d9bdb938b,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-11-12T20:09:07Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-11-12T20:09:07Z,test fix,tests/testthat/test-model-compile.R,False,True,True,False,1,1,2,"---FILE: tests/testthat/test-model-compile.R---
@@ -337,7 +337,7 @@ test_that(""compiling stops on hyphens in stanc_options"", {
 test_that(""compiling works with only names in list"", {
   skip_on_cran()
   stan_file <- testing_stan_file(""bernoulli"")
-  mod <- cmdstan_model(stan_file, stanc_options = list(""allow-undefined"", ""warn-pedantic""), force_compile = TRUE)
+  mod <- cmdstan_model(stan_file, stanc_options = list(""allow-undefined"", ""warn-pedantic""), force_recompile = TRUE)
   expect_type(
     mod,
     ""dada""",True,False,Rendering / Conversion,3
stan-dev,cmdstanr,4d02d6da8d2a19d58a806129763ba0f81cd07093,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-11-12T14:35:15Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-11-12T14:35:15Z,nicer error for leading hyphens,R/model.R;R/utils.R;tests/testthat/test-model-compile.R,False,True,True,False,60,2,62,"---FILE: R/model.R---
@@ -201,6 +201,7 @@ CmdStanModel <- R6::R6Class(
       private$stan_file_ <- absolute_path(stan_file)
 
       args <- list(...)
+      check_stanc_options(args$stanc_options)
       private$precompile_cpp_options_ <- args$cpp_options %||% list()
       private$precompile_stanc_options_ <- args$stanc_options %||% list()
       private$precompile_include_paths_ <- args$include_paths
@@ -366,6 +367,7 @@ compile_method <- function(quiet = TRUE,
   if (length(stanc_options) == 0 && !is.null(private$precompile_stanc_options_)) {
     stanc_options <- private$precompile_stanc_options_
   }
+  check_stanc_options(stanc_options)
   if (is.null(include_paths) && !is.null(private$precompile_include_paths_)) {
     include_paths <- private$precompile_include_paths_
   }

---FILE: R/utils.R---
@@ -208,6 +208,23 @@ cpp_options_to_compile_flags <- function(cpp_options) {
   paste0(cpp_built_options, collapse = "" "")
 }
 
+check_stanc_options <- function(stanc_options) {
+  i <- 1
+  names <- names(stanc_options)
+  for(s in stanc_options){
+    if(!is.null(names[i]) && nzchar(names[i])) {
+      name <- names[i]
+    } else {
+      name <- stanc_options[[i]]
+    }
+    if (startsWith(name, ""--"")) {
+      stop(""No leading hyphens allowed in stanc options ("",name, ""). Use options without leading hyphens, like for example `stanc_options = list('allow-undefined')`"",
+         call. = FALSE)
+    }
+    i <- i + 1
+  }
+}
+
 prepare_precompiled <- function(cpp_options = list(), quiet = FALSE) {
   flags <- NULL
   if (!is.null(cpp_options$stan_threads)) {
@@ -288,7 +305,8 @@ num_threads <- function() {
 #' @export
 #' @param num_threads (positive integer) The number of threads to set.
 set_num_threads <- function(num_threads) {
-  stop(""Please use the 'threads_per_chain' argument in the $sample() method instead of set_num_threads()."")
+  stop(""Please use the 'threads_per_chain' argument in the $sample() method instead of set_num_threads()."",
+       call. = FALSE)
 }
 
 check_divergences <- function(data_csv) {
@@ -381,3 +399,4 @@ variable_dims <- function(variable_names = NULL) {
   }
   dims
 }
+

---FILE: tests/testthat/test-model-compile.R---
@@ -295,4 +295,41 @@ test_that(""pedantic check works"", {
   expect_match(paste0(a, collapse = ""\n""), ""The parameter x was declared but was not used in the density calculation."")
 })
 
-
+test_that(""compiling stops on hyphens in stanc_options"", {
+  skip_on_cran()
+  hyphens = list(""--allow-undefined"")
+  hyphens2 = list(""--allow-undefined"" = TRUE)
+  hyphens3 = list(""--o"" = ""something"")
+  stan_file <- testing_stan_file(""bernoulli"")
+  expect_error(
+    cmdstan_model(stan_file, stanc_options = hyphens, compile = FALSE),
+    ""No leading hyphens allowed in stanc options (--allow-undefined). Use options without leading hyphens, like for example `stanc_options = list('allow-undefined')`"",
+    fixed = TRUE
+  )
+  expect_error(
+    cmdstan_model(stan_file, stanc_options = hyphens2, compile = FALSE),
+    ""No leading hyphens allowed in stanc options (--allow-undefined). Use options without leading hyphens, like for example `stanc_options = list('allow-undefined')`"",
+    fixed = TRUE
+  )
+  expect_error(
+    cmdstan_model(stan_file, stanc_options = hyphens3, compile = FALSE),
+    ""No leading hyphens allowed in stanc options (--o). Use options without leading hyphens, like for example `stanc_options = list('allow-undefined')`"",
+    fixed = TRUE
+  )
+  mod <- cmdstan_model(stan_file, compile = FALSE)
+  expect_error(
+    mod$compile(stanc_options = hyphens),
+    ""No leading hyphens allowed in stanc options (--allow-undefined). Use options without leading hyphens, like for example `stanc_options = list('allow-undefined')`"",
+    fixed = TRUE
+  )
+  expect_error(
+    mod$compile(stanc_options = hyphens2),
+    ""No leading hyphens allowed in stanc options (--allow-undefined). Use options without leading hyphens, like for example `stanc_options = list('allow-undefined')`"",
+    fixed = TRUE
+  )
+  expect_error(
+    mod$compile(stanc_options = hyphens3),
+    ""No leading hyphens allowed in stanc options (--o). Use options without leading hyphens, like for example `stanc_options = list('allow-undefined')`"",
+    fixed = TRUE
+  )
+})",True,False,Implementation / Logic,6
stan-dev,cmdstanr,e1d1c6070b308b10b9a3b99e96cc0c33e093f728,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-11-12T11:32:31Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-11-12T11:32:31Z,fix for fixed_param,R/read_csv.R,False,True,True,False,7,3,10,"---FILE: R/read_csv.R---
@@ -412,9 +412,13 @@ read_csv_metadata <- function(csv_file) {
     if (!startsWith(line, ""#"") && is.null(csv_file_info[[""model_params""]])) {
       # if no # at the start of line, the line is the CSV header
       all_names <- strsplit(line, "","")[[1]]
-      csv_file_info[[""sampler_diagnostics""]] <- all_names[endsWith(all_names, ""__"")]
-      csv_file_info[[""sampler_diagnostics""]] <- csv_file_info[[""sampler_diagnostics""]][!(csv_file_info[[""sampler_diagnostics""]] %in% c(""lp__"", ""log_p__"", ""log_g__""))]
-      csv_file_info[[""model_params""]] <- all_names[!(all_names %in% csv_file_info[[""sampler_diagnostics""]])]
+      if (all(csv_file_info$algorithm != ""fixed_param"")) {
+        csv_file_info[[""sampler_diagnostics""]] <- all_names[endsWith(all_names, ""__"")]
+        csv_file_info[[""sampler_diagnostics""]] <- csv_file_info[[""sampler_diagnostics""]][!(csv_file_info[[""sampler_diagnostics""]] %in% c(""lp__"", ""log_p__"", ""log_g__""))]
+        csv_file_info[[""model_params""]] <- all_names[!(all_names %in% csv_file_info[[""sampler_diagnostics""]])]
+      } else {
+        csv_file_info[[""model_params""]] <- all_names[!endsWith(all_names, ""__"")]
+      }
     } else {
       parse_key_val <- TRUE
       if (regexpr(""# Diagonal elements of inverse mass matrix:"", line, perl = TRUE) > 0",True,False,Implementation / Logic,6
stan-dev,cmdstanr,d37a2dc1b8c161435d99c4da10360bf9fd1440be,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-11-11T19:20:03Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-11-11T19:20:03Z,fix another indent,.github/workflows/Test-coverage.yaml,False,False,False,False,5,5,10,"---FILE: .github/workflows/Test-coverage.yaml---
@@ -100,8 +100,8 @@ jobs:
           remotes::install_cran(""gridExtra"")
         shell: Rscript {0}
 
-        - name: Test coverage
-          run: |
-            options(covr.gcov = 'C:/rtools40/mingw64/bin/gcov.exe');
-            covr::codecov(type = ""all"")
-          shell: Rscript {0}
+      - name: Test coverage
+        run: |
+          options(covr.gcov = 'C:/rtools40/mingw64/bin/gcov.exe');
+          covr::codecov(type = ""all"")
+        shell: Rscript {0}",False,False,Data / Input Handling,3
stan-dev,cmdstanr,46b3a4652bbc3e3f51e4f9d782ea32adfa696e92,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-11-11T19:06:21Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-11-11T19:06:21Z,fix indent,.github/workflows/Test-coverage.yaml,False,False,False,False,12,12,24,"---FILE: .github/workflows/Test-coverage.yaml---
@@ -91,17 +91,17 @@ jobs:
           saveRDS(remotes::dev_package_deps(dependencies = TRUE), "".github/depends.Rds"", version = 2)
         shell: Rscript {0}
 
-     - name: Install dependencies
-       run: |
-         install.packages(c(""posterior"", ""cmdstanr"", ""remotes""),repos = c(""https://mc-stan.org/r-packages/"", getOption(""repos"")))
-         cmdstanr::install_cmdstan(cores = 2, overwrite = TRUE, release_url = ""https://github.com/stan-dev/cmdstan/releases/download/v2.25.0/cmdstan-2.25.0.tar.gz"")
-         remotes::install_deps(dependencies = TRUE)
-         remotes::install_cran(""covr"")
-         remotes::install_cran(""gridExtra"")
-       shell: Rscript {0}
-
-      - name: Test coverage
+      - name: Install dependencies
         run: |
-          options(covr.gcov = 'C:/rtools40/mingw64/bin/gcov.exe');
-          covr::codecov(type = ""all"")
+          install.packages(c(""posterior"", ""cmdstanr"", ""remotes""),repos = c(""https://mc-stan.org/r-packages/"", getOption(""repos"")))
+          cmdstanr::install_cmdstan(cores = 2, overwrite = TRUE, release_url = ""https://github.com/stan-dev/cmdstan/releases/download/v2.25.0/cmdstan-2.25.0.tar.gz"")
+          remotes::install_deps(dependencies = TRUE)
+          remotes::install_cran(""covr"")
+          remotes::install_cran(""gridExtra"")
         shell: Rscript {0}
+
+        - name: Test coverage
+          run: |
+            options(covr.gcov = 'C:/rtools40/mingw64/bin/gcov.exe');
+            covr::codecov(type = ""all"")
+          shell: Rscript {0}",False,False,Documentation / Formatting,3
stan-dev,cmdstanr,ca0d5b489790c4f078ed15d8337ffd2922b3a232,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-11-11T14:05:08Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-11-11T14:05:08Z,fix test,tests/testthat/test-fit-shared.R,False,True,True,False,5,1,6,"---FILE: tests/testthat/test-fit-shared.R---
@@ -138,7 +138,11 @@ test_that(""draws() method returns a 'draws' object"", {
   for (method in all_methods) {
     fit <- fits[[method]]
     draws <- fit$draws()
-    expect_type(draws, ""double"")
+    if (method == ""generate_quantities"") {
+      expect_type(draws, ""integer"")
+    } else {
+      expect_type(draws, ""double"")
+    }
     expect_s3_class(draws, ""draws"")
   }
 })",True,False,Implementation / Logic,3
stan-dev,cmdstanr,358e62398c0beb6637f10b0442559855becb68e0,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-11-04T18:52:54Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-11-04T18:52:54Z,fix,R/fit.R,False,True,True,False,1,1,2,"---FILE: R/fit.R---
@@ -169,7 +169,7 @@ CmdStanFit <- R6::R6Class(
                               basename = NULL,
                               timestamp = TRUE,
                               random = TRUE) {
-      self$runs,et$save_data_file(dir, basename, timestamp, random)
+      self$runset$save_data_file(dir, basename, timestamp, random)
     },
     return_codes = function() {
       self$runset$procs$return_codes()",True,False,Implementation / Logic,6
stan-dev,cmdstanr,22fab18b86420c2853011bb2215376a0470e7532,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-10-29T17:49:00Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-10-29T18:55:49Z,bugfix,R/run.R,False,True,True,False,8,7,15,"---FILE: R/run.R---
@@ -392,8 +392,7 @@ CmdStanRun$set(""private"", name = ""run_generate_quantities_"", value = .run_genera
   }
   successful_fit = FALSE
   if (self$method() == ""optimize"") {
-    if (procs$get_proc(id)$get_exit_status() == 0 ||
-        procs$get_proc(id)$get_exit_status() == 70) {
+    if (procs$proc_state(id = id) > 3) {
       successful_fit = TRUE
     }
   } else if (procs$get_proc(id)$get_exit_status() == 0) {
@@ -615,6 +614,9 @@ CmdStanProcs <- R6::R6Class(
           if (regexpr(""Optimization terminated with error"", line, perl = TRUE) > 0) {
             self$set_proc_state(id, new_state = 3.5)
           }
+          if (regexpr(""Optimization terminated normally"", line, perl = TRUE) > 0) {
+            self$set_proc_state(id, new_state = 4)
+          }
           if (self$proc_state(id) == 2 && regexpr(""refresh = "", line, perl = TRUE) > 0) {
             self$set_proc_state(id, new_state = 2.5)
           }
@@ -689,14 +691,14 @@ CmdStanMCMCProcs <- R6::R6Class(
           # (Note: state 2 is only used because rejection in cmdstan is printed
           # to stdout not stderr and we want to avoid printing the intial chain metadata)
           next_state <- state
-          if (state < 3 && regexpr(""Rejecting initial value:"", line, perl = TRUE) > 0) {
-            state <- 2
-            next_state <- 2
-          }
           if (state < 3 && regexpr(""refresh ="", line, perl = TRUE) > 0) {
             state <- 1.5
             next_state <- 1.5
           }
+          if (state <= 3 && regexpr(""Rejecting initial value:"", line, perl = TRUE) > 0) {
+            state <- 2
+            next_state <- 2
+          }
           if (state < 3 && regexpr(""Iteration:"", line, perl = TRUE) > 0) {
             state <- 3 # 3 =  warmup
             next_state <- 3
@@ -711,7 +713,6 @@ CmdStanMCMCProcs <- R6::R6Class(
           }
           if (regexpr(""\\[100%\\]"", line, perl = TRUE) > 0) {
             next_state <- 5 # writing csv and finishing
-            state <- 5
           }
           if (regexpr(""seconds (Total)"", line, fixed = TRUE) > 0) {
             private$proc_total_time_[[id]] <- as.double(trimws(sub(""seconds (Total)"", """", line, fixed = TRUE)))",True,False,Implementation / Logic,3
stan-dev,cmdstanr,8fd583fc9598c369df5d431bd0382401cf0024c4,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-10-29T14:02:07Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-10-29T14:02:07Z,fix prints for transformed data,R/run.R,False,True,True,False,22,2,24,"---FILE: R/run.R---
@@ -675,6 +675,7 @@ CmdStanMCMCProcs <- R6::R6Class(
       for (line in out) {
         private$proc_output_[[id]] <- c(private$proc_output_[[id]], line)
         if (nzchar(line)) {
+          ignore_line <- FALSE
           last_section_start_time <- private$proc_section_time_[id, ""last_section_start""]
           state <- private$proc_state_[[id]]
           # State machine for reading stdout.
@@ -692,6 +693,10 @@ CmdStanMCMCProcs <- R6::R6Class(
             state <- 2
             next_state <- 2
           }
+          if (state < 3 && regexpr(""refresh ="", line, perl = TRUE) > 0) {
+            state <- 1.5
+            next_state <- 1.5
+          }
           if (state < 3 && regexpr(""Iteration:"", line, perl = TRUE) > 0) {
             state <- 3 # 3 =  warmup
             next_state <- 3
@@ -706,18 +711,29 @@ CmdStanMCMCProcs <- R6::R6Class(
           }
           if (regexpr(""\\[100%\\]"", line, perl = TRUE) > 0) {
             next_state <- 5 # writing csv and finishing
+            state <- 5
           }
           if (regexpr(""seconds (Total)"", line, fixed = TRUE) > 0) {
             private$proc_total_time_[[id]] <- as.double(trimws(sub(""seconds (Total)"", """", line, fixed = TRUE)))
+            next_state <- 5
+            state <- 5
           }
           if (regexpr(""seconds (Sampling)"", line, fixed = TRUE) > 0) {
-            
             private$proc_section_time_[id, ""sampling""] <- as.double(trimws(sub(""seconds (Sampling)"", """", line, fixed = TRUE)))
+            next_state <- 5
+            state <- 5
           }
           if (regexpr(""seconds (Warm-up)"", line, fixed = TRUE) > 0) {
             private$proc_section_time_[id, ""warmup""] <- as.double(trimws(sub(""Elapsed Time: "", """", sub(""seconds (Warm-up)"", """", line, fixed = TRUE), fixed = TRUE)))
+            next_state <- 5
+            state <- 5
           }
-          if (state > 1 && state < 5) {
+          if (regexpr(""Gradient evaluation took"",line, fixed = TRUE) > 0
+              || regexpr(""leapfrog steps per transition would take"",line, fixed = TRUE) > 0
+              || regexpr(""Adjust your expectations accordingly!"",line, fixed = TRUE) > 0) {
+            ignore_line <- TRUE
+          }
+          if (state > 1.5 && state < 5 && !ignore_line) {
             if (state == 2) {
               message(""Chain "", id, "" "", line)
             } else {
@@ -732,6 +748,10 @@ CmdStanMCMCProcs <- R6::R6Class(
             message(""Chain "", id, "" "", line)
           }
           private$proc_state_[[id]] <- next_state
+        } else {
+          if (private$proc_state_[[id]] == 1.5) {
+            private$proc_state_[[id]] <- 3
+          }
         }
       }
       invisible(self)",True,False,Implementation / Logic,3
stan-dev,cmdstanr,7e2c747961bdfd27908af1d6fbfc149f793c3870,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-10-29T11:25:04Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-10-29T11:25:04Z,fix prints for optimize/variational,R/run.R,False,True,True,False,20,7,27,"---FILE: R/run.R---
@@ -611,13 +611,24 @@ CmdStanProcs <- R6::R6Class(
       }
       for (line in out) {
         private$proc_output_[[id]] <- c(private$proc_output_[[id]], line)
-        if (regexpr(""Optimization terminated with error"", line, perl = TRUE) > 0) {
-          self$set_proc_state(id, new_state = 3)
-        }
-        if (private$proc_state_[[id]] == 3) {
-          message(line)
-        } else if (private$show_stdout_messages_) {        
-          cat(line, collapse = ""\n"")
+        if (nzchar(line)) {
+          if (regexpr(""Optimization terminated with error"", line, perl = TRUE) > 0) {
+            self$set_proc_state(id, new_state = 3.5)
+          }
+          if (self$proc_state(id) == 2 && regexpr(""refresh = "", line, perl = TRUE) > 0) {
+            self$set_proc_state(id, new_state = 2.5)
+          }
+          if (private$proc_state_[[id]] == 3.5) {
+            message(line)
+          } else if (private$show_stdout_messages_ && private$proc_state_[[id]] >= 3) {        
+            cat(line, collapse = ""\n"")
+          }
+        } else {
+          # after the metadata is printed and we found a blank line
+          # this represents the start of fitting
+          if (self$proc_state(id) == 2.5) {
+              self$set_proc_state(id, new_state = 3)
+          } 
         }
       }
       invisible(self)
@@ -806,6 +817,8 @@ CmdStanGQProcs <- R6::R6Class(
             cat(""Chain"", id, line, ""\n"")
           }
         } else {
+          # after the metadata is printed and we found a blank line
+          # this represents the start of fitting
           if (self$proc_state(id) == 1.5) {
               self$set_proc_state(id, new_state = 2)
           } ",True,False,Implementation / Logic,3
stan-dev,cmdstanr,c50ca1cdccb85990f29c70c67659563a8c61abd1,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-10-29T09:55:08Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-10-29T09:55:08Z,message on error and return fit for optimize even with return code != 0,R/run.R,False,True,True,False,21,3,24,"---FILE: R/run.R---
@@ -390,7 +390,16 @@ CmdStanRun$set(""private"", name = ""run_generate_quantities_"", value = .run_genera
     }
     procs$set_active_procs(procs$num_alive())
   }
-  if (procs$get_proc(id)$get_exit_status() == 0) {
+  successful_fit = FALSE
+  if (self$method() == ""optimize"") {
+    if (procs$get_proc(id)$get_exit_status() == 0 ||
+        procs$get_proc(id)$get_exit_status() == 70) {
+      successful_fit = TRUE
+    }
+  } else if (procs$get_proc(id)$get_exit_status() == 0) {
+    successful_fit = TRUE
+  }
+  if (successful_fit) {
     procs$set_proc_state(id = id, new_state = 5) # mark_proc_stop will mark this process successful
   } else {
     procs$set_proc_state(id = id, new_state = 4) # mark_proc_stop will mark this process unsuccessful
@@ -602,7 +611,12 @@ CmdStanProcs <- R6::R6Class(
       }
       for (line in out) {
         private$proc_output_[[id]] <- c(private$proc_output_[[id]], line)
-        if (private$show_stdout_messages_) {        
+        if (regexpr(""Optimization terminated with error"", line, perl = TRUE) > 0) {
+          self$set_proc_state(id, new_state = 3)
+        }
+        if (private$proc_state_[[id]] == 3) {
+          message(line)
+        } else if (private$show_stdout_messages_) {        
           cat(line, collapse = ""\n"")
         }
       }
@@ -787,10 +801,14 @@ CmdStanGQProcs <- R6::R6Class(
         private$proc_output_[[id]] <- c(private$proc_output_[[id]], line)
         if (nzchar(line)) {
           if (self$proc_state(id) == 1 && regexpr(""refresh = "", line, perl = TRUE) > 0) {
-            self$set_proc_state(id, new_state = 2)
+            self$set_proc_state(id, new_state = 1.5)
           } else if (self$proc_state(id) >= 2) {
             cat(""Chain"", id, line, ""\n"")
           }
+        } else {
+          if (self$proc_state(id) == 1.5) {
+              self$set_proc_state(id, new_state = 2)
+          } 
         }
       }
       invisible(self)",True,False,Implementation / Logic,3
stan-dev,cmdstanr,7d00c431e305c65dc0ebdb49fcc09d8519f5e871,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-10-25T08:46:23Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-10-25T08:46:23Z,fix arg doc,R/install.R;man/install_cmdstan.Rd,False,True,True,False,7,7,14,"---FILE: R/install.R---
@@ -52,9 +52,9 @@
 #' @param cpp_options A list specifying any makefile flags/variables to be
 #'   written to the `make/local` file. For example, `list(""CXX"" = ""clang++"")`
 #'   will force the use of clang for compilation.
-#' @param check_toolchain A list specifying any makefile flags/variables to be
-#'   written to the `make/local` file. For example, `list(""CXX"" = ""clang++"")`
-#'   will force the use of clang for compilation.
+#' @param check_toolchain Should `install_cmdstan()` check that the
+#'   required toolchain is installed and properly configured.
+#'   The default is `TRUE`.
 #'
 #' @examples
 #' # install_cmdstan(cores = 4)

---FILE: man/install_cmdstan.Rd---
@@ -46,7 +46,7 @@ system processes be suppressed when building the CmdStan binaries?
 The default is \code{FALSE}.
 For \code{check_cmdstan_toolchain()}, should the function supress
 printing informational messages? The default is \code{FALSE}.
-If \code{TRUE} \code{check_cmdstan_toolchain()} only output errors.}
+If \code{TRUE} \code{check_cmdstan_toolchain()} only outputs errors.}
 
 \item{overwrite}{When an existing installation is found in \code{dir}, should
 CmdStan still be downloaded and reinstalled? The default is \code{FALSE}, in
@@ -69,9 +69,9 @@ release from \href{https://github.com/stan-dev/cmdstan/releases}{GitHub}. If
 written to the \code{make/local} file. For example, \code{list(""CXX"" = ""clang++"")}
 will force the use of clang for compilation.}
 
-\item{check_toolchain}{A list specifying any makefile flags/variables to be
-written to the \code{make/local} file. For example, \code{list(""CXX"" = ""clang++"")}
-will force the use of clang for compilation.}
+\item{check_toolchain}{Should \code{install_cmdstan()} check that the
+required toolchain is installed and properly configured.
+The default is \code{TRUE}.}
 
 \item{append}{For \code{cmdstan_make_local()}, should the listed makefile flags be
 appended to the end of the existing \code{make/local} file? The default is \code{TRUE}.",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,ea56b0074ecbd7b850ab8cca34621e7af316e7a4,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-10-24T14:33:59Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-10-24T14:33:59Z,fix test with os dependant err msg,tests/testthat/test-install.R,False,True,True,False,6,1,7,"---FILE: tests/testthat/test-install.R---
@@ -127,9 +127,14 @@ test_that(""toolchain checks on Unix work"", {
   skip_if(os_is_windows())
   path_backup <- Sys.getenv(""PATH"")
   Sys.setenv(""PATH"" = """")
+  if (os_is_macos()) {
+    err_msg <- ""A suitable C++ compiler was not found. Please install the command line tools for Mac with 'xcode-select --install' or install Xcode from the app store. Then restart R and run check_cmdstan_toolchain().""
+  } else {
+    err_msg <- ""A C++ compiler was not found. Please install the 'clang++' or 'g++' compiler, restart R, and run check_cmdstan_toolchain().""
+  }
   expect_error(
     check_unix_cpp_compiler(),
-    ""A C++ compiler was not found. Please install the 'clang++' or 'g++' compiler, restart R, and run check_cmdstan_toolchain()."",
+    err_msg,
     fixed = TRUE
   )
   expect_error(",True,False,Environment / Configuration,3
stan-dev,cmdstanr,74d8dff679f013f27755870fbbe5cb2d105847c0,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-10-24T09:36:17Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-10-24T09:36:17Z,moved path fixes to install_mingw32_make. added tests for rtools40,R/install.R;tests/testthat/test-install.R,False,True,True,False,181,159,340,"---FILE: R/install.R---
@@ -426,16 +426,18 @@ build_status_ok <- function(process_log, quiet = FALSE) {
   TRUE
 }
 
-install_mingw32_make <- function() {
+install_mingw32_make <- function(quiet = FALSE) {
+  if (!quiet) message(""Installing mingw32-make and writing RTools path to ~/.Renviron ..."")
   processx::run(
     ""pacman"",
     args = c(""-Syu"", ""mingw-w64-x86_64-make"",""--noconfirm""),
     wd = file.path(Sys.getenv(""RTOOLS40_HOME""), ""usr"", ""bin""),
     error_on_status = TRUE
   )
-  invisible(NULL)
-}
-
+  write('PATH=""${RTOOLS40_HOME}\\usr\\bin;${RTOOLS40_HOME}\\mingw64\\bin;${PATH}""', file = ""~/.Renviron"", append = TRUE)
+  Sys.setenv(PATH = paste0(Sys.getenv(""RTOOLS40_HOME""), ""\\usr\\bin;"", Sys.getenv(""RTOOLS40_HOME""), ""\\mingw64\\bin;"", Sys.getenv(""PATH"")))
+	invisible(NULL)
+}     
 
 check_rtools40_windows_toolchain <- function(fix = FALSE, quiet = FALSE) {
   rtools_path <- Sys.getenv(""RTOOLS40_HOME"")
@@ -468,12 +470,9 @@ check_rtools40_windows_toolchain <- function(fix = FALSE, quiet = FALSE) {
         call. = FALSE
       )
     } else {
-      if (!quiet) message(""Installing mingw32-make and writing RTools path to ~/.Renviron ..."")
-      install_mingw32_make()
-      write('PATH=""${RTOOLS40_HOME}\\usr\\bin;${RTOOLS40_HOME}\\mingw64\\bin;${PATH}""', file = ""~/.Renviron"", append = TRUE)
-      Sys.setenv(PATH = paste0(Sys.getenv(""RTOOLS40_HOME""), ""\\usr\\bin;"", Sys.getenv(""RTOOLS40_HOME""), ""\\mingw64\\bin;"", Sys.getenv(""PATH"")))
-	  check_rtools40_windows_toolchain(fix = FALSE, quiet = quiet)
-	  return(invisible(NULL))
+      install_mingw32_make(quiet = quiet)
+      check_rtools40_windows_toolchain(fix = FALSE, quiet = quiet)
+	    return(invisible(NULL))
     }
   }
   # Check if the mingw32-make and g++ get picked up by default are the RTools-supplied ones
@@ -485,12 +484,9 @@ check_rtools40_windows_toolchain <- function(fix = FALSE, quiet = FALSE) {
         call. = FALSE
       )
     } else {
-      if (!quiet) message(""Installing mingw32-make and writing RTools path to ~/.Renviron ..."")
-      install_mingw32_make()
-      write('PATH=""${RTOOLS40_HOME}\\usr\\bin;${RTOOLS40_HOME}\\mingw64\\bin;${PATH}""', file = ""~/.Renviron"", append = TRUE)
-      Sys.setenv(PATH = paste0(Sys.getenv(""RTOOLS40_HOME""), ""\\usr\\bin;"", Sys.getenv(""RTOOLS40_HOME""), ""\\mingw64\\bin;"", Sys.getenv(""PATH"")))
-	  check_rtools40_windows_toolchain(fix = FALSE, quiet = quiet)
-	  return(invisible(NULL))
+      install_mingw32_make(quiet = quiet)
+      check_rtools40_windows_toolchain(fix = FALSE, quiet = quiet)
+      return(invisible(NULL))
     }
   }
 }

---FILE: tests/testthat/test-install.R---
@@ -1,164 +1,190 @@
 context(""install"")
 
-test_that(""install_cmdstan() successfully installs cmdstan"", {
-  skip_if_offline()
-  if (os_is_windows()) skip_on_covr()
-  if (getRversion() < '3.5.0') {
-    dir <- tempdir()
-  } else {
-    dir <- tempdir(check = TRUE)
-  }
-  expect_message(
-    expect_output(
-      install_cmdstan(dir = dir, cores = 2, quiet = FALSE, overwrite = TRUE,
-                      release_url = test_release_url()),
-      ""Compiling, linking C++ code"",
-      fixed = TRUE
-    ),
-    ""CmdStan path set""
-  )
-})
-
-test_that(""install_cmdstan() errors if installation already exists"", {
-  skip_if_offline()
-  if (os_is_windows()) skip_on_covr()
-  if (not_on_cran()) {
-    # want to test passing NULL to install_cmdstan but need a real dir to
-    # check in dir.exists() below so also create dir_check
-    install_dir <- cmdstan_default_install_path()
-  } else {
-    install_dir <- tempdir()
-  }
-  dir <- file.path(install_dir, ""cmdstan-2.23.0"")
-  fake_folder <- FALSE
-  if (!dir.exists(dir)) {
-    fake_folder <- TRUE
-    dir.create(dir)
-  }
-  expect_warning(
-    install_cmdstan(dir = install_dir, overwrite = FALSE,
-                    release_url = test_release_url()),
-    ""An installation already exists""
-  )
-})
-
-test_that(""install_cmdstan() errors if it times out"", {
-  skip_if_offline()
-  if (os_is_windows()) skip_on_covr()
-  if (getRversion() < '3.5.0') {
-    dir <- tempdir()
-  } else {
-    dir <- tempdir(check = TRUE)
-  }
-  ver <- latest_released_version()
-  dir_exists <- dir.exists(file.path(dir, paste0(""cmdstan-"",ver)))
-  # with quiet=TRUE
-  expect_warning(
-    expect_message(
-      install_cmdstan(dir = dir, timeout = 1, quiet = TRUE, overwrite = dir_exists,
-                      release_url = test_release_url()),
-      if (dir_exists) ""* Removing the existing installation"" else ""* * Installing Cmdstan from https://github.com"",
-      fixed = TRUE
-    ),
-    ""increasing the value of the 'timeout' argument and running again with 'quiet=FALSE'"",
-    fixed = TRUE
-  )
-  dir_exists <- dir.exists(file.path(dir, paste0(""cmdstan-"",ver)))
-  # with quiet=FALSE
-  expect_warning(
-    expect_message(
-      install_cmdstan(dir = dir, timeout = 1, quiet = FALSE, overwrite = dir_exists,
-                      release_url = test_release_url()),
-      if (dir_exists) ""* Removing the existing installation"" else ""* * Installing Cmdstan from https://github.com"",
-      fixed = TRUE
-    ),
-    ""Try increasing the value of the 'timeout' argument."",
-    fixed = TRUE
-  )
-})
-
-test_that(""install_cmdstan() errors if invalid version or URL"", {
-  skip_if_offline()
-  expect_error(
-    install_cmdstan(version = ""2.23.2""),
-    ""Download of Cmdstan failed. Please check if the supplied version number is valid.""
-  )
-  expect_error(
-    install_cmdstan(release_url = ""https://github.com/stan-dev/cmdstan/releases/download/v2.23.2/cmdstan-2.23.2.tar.gz""),
-    ""Download of Cmdstan failed. Please check if the supplied release URL is valid.""
-  )
-})
-
-test_that(""install_cmdstan() works with version and release_url"", {
-  skip_if_offline()
-  if (os_is_windows()) skip_on_covr()
-  if (getRversion() < '3.5.0') {
-    dir <- tempdir()
-  } else {
-    dir <- tempdir(check = TRUE)
-  }
-  expect_message(
-    expect_output(
-      install_cmdstan(dir = dir, overwrite = TRUE, cores = 4,
-                      release_url = ""https://github.com/stan-dev/cmdstan/releases/download/v2.24.0/cmdstan-2.24.0.tar.gz""),
-      ""Compiling, linking C++ code"",
-      fixed = TRUE
-    ),
-    ""Finished installing CmdStan""
-  )
-  expect_warning(
-    expect_message(
-      expect_output(
-        install_cmdstan(dir = dir, overwrite = TRUE, cores = 4,
-                        version = ""2.23.0"",
-                        # the URL is intentionally invalid to test that the version has higher priority
-                        release_url = ""https://github.com/stan-dev/cmdstan/releases/download/v2.23.2/cmdstan-2.23.2.tar.gz""),
-        ""Compiling, linking C++ code"",
-        fixed = TRUE
-      ),
-      ""Finished installing CmdStan""
-    ),
-    ""version and release_url are supplied to install_cmdstan()""
-  )
-  expect_true(dir.exists(file.path(dir, ""cmdstan-2.23.0"")))
-})
+# test_that(""install_cmdstan() successfully installs cmdstan"", {
+#   skip_if_offline()
+#   if (os_is_windows()) skip_on_covr()
+#   if (getRversion() < '3.5.0') {
+#     dir <- tempdir()
+#   } else {
+#     dir <- tempdir(check = TRUE)
+#   }
+#   expect_message(
+#     expect_output(
+#       install_cmdstan(dir = dir, cores = 2, quiet = FALSE, overwrite = TRUE,
+#                       release_url = test_release_url()),
+#       ""Compiling, linking C++ code"",
+#       fixed = TRUE
+#     ),
+#     ""CmdStan path set""
+#   )
+# })
+#
+# test_that(""install_cmdstan() errors if installation already exists"", {
+#   skip_if_offline()
+#   if (os_is_windows()) skip_on_covr()
+#   if (not_on_cran()) {
+#     # want to test passing NULL to install_cmdstan but need a real dir to
+#     # check in dir.exists() below so also create dir_check
+#     install_dir <- cmdstan_default_install_path()
+#   } else {
+#     install_dir <- tempdir()
+#   }
+#   dir <- file.path(install_dir, ""cmdstan-2.23.0"")
+#   fake_folder <- FALSE
+#   if (!dir.exists(dir)) {
+#     fake_folder <- TRUE
+#     dir.create(dir)
+#   }
+#   expect_warning(
+#     install_cmdstan(dir = install_dir, overwrite = FALSE,
+#                     release_url = test_release_url()),
+#     ""An installation already exists""
+#   )
+# })
+#
+# test_that(""install_cmdstan() errors if it times out"", {
+#   skip_if_offline()
+#   if (os_is_windows()) skip_on_covr()
+#   if (getRversion() < '3.5.0') {
+#     dir <- tempdir()
+#   } else {
+#     dir <- tempdir(check = TRUE)
+#   }
+#   ver <- latest_released_version()
+#   dir_exists <- dir.exists(file.path(dir, paste0(""cmdstan-"",ver)))
+#   # with quiet=TRUE
+#   expect_warning(
+#     expect_message(
+#       install_cmdstan(dir = dir, timeout = 1, quiet = TRUE, overwrite = dir_exists,
+#                       release_url = test_release_url()),
+#       if (dir_exists) ""* Removing the existing installation"" else ""* * Installing Cmdstan from https://github.com"",
+#       fixed = TRUE
+#     ),
+#     ""increasing the value of the 'timeout' argument and running again with 'quiet=FALSE'"",
+#     fixed = TRUE
+#   )
+#   dir_exists <- dir.exists(file.path(dir, paste0(""cmdstan-"",ver)))
+#   # with quiet=FALSE
+#   expect_warning(
+#     expect_message(
+#       install_cmdstan(dir = dir, timeout = 1, quiet = FALSE, overwrite = dir_exists,
+#                       release_url = test_release_url()),
+#       if (dir_exists) ""* Removing the existing installation"" else ""* * Installing Cmdstan from https://github.com"",
+#       fixed = TRUE
+#     ),
+#     ""Try increasing the value of the 'timeout' argument."",
+#     fixed = TRUE
+#   )
+# })
+#
+# test_that(""install_cmdstan() errors if invalid version or URL"", {
+#   skip_if_offline()
+#   expect_error(
+#     install_cmdstan(version = ""2.23.2""),
+#     ""Download of Cmdstan failed. Please check if the supplied version number is valid.""
+#   )
+#   expect_error(
+#     install_cmdstan(release_url = ""https://github.com/stan-dev/cmdstan/releases/download/v2.23.2/cmdstan-2.23.2.tar.gz""),
+#     ""Download of Cmdstan failed. Please check if the supplied release URL is valid.""
+#   )
+# })
+#
+# test_that(""install_cmdstan() works with version and release_url"", {
+#   skip_if_offline()
+#   if (os_is_windows()) skip_on_covr()
+#   if (getRversion() < '3.5.0') {
+#     dir <- tempdir()
+#   } else {
+#     dir <- tempdir(check = TRUE)
+#   }
+#   expect_message(
+#     expect_output(
+#       install_cmdstan(dir = dir, overwrite = TRUE, cores = 4,
+#                       release_url = ""https://github.com/stan-dev/cmdstan/releases/download/v2.24.0/cmdstan-2.24.0.tar.gz""),
+#       ""Compiling, linking C++ code"",
+#       fixed = TRUE
+#     ),
+#     ""Finished installing CmdStan""
+#   )
+#   expect_warning(
+#     expect_message(
+#       expect_output(
+#         install_cmdstan(dir = dir, overwrite = TRUE, cores = 4,
+#                         version = ""2.23.0"",
+#                         # the URL is intentionally invalid to test that the version has higher priority
+#                         release_url = ""https://github.com/stan-dev/cmdstan/releases/download/v2.23.2/cmdstan-2.23.2.tar.gz""),
+#         ""Compiling, linking C++ code"",
+#         fixed = TRUE
+#       ),
+#       ""Finished installing CmdStan""
+#     ),
+#     ""version and release_url are supplied to install_cmdstan()""
+#   )
+#   expect_true(dir.exists(file.path(dir, ""cmdstan-2.23.0"")))
+# })
+#
+# test_that(""toolchain checks on Unix work"", {
+#   skip_if(os_is_windows())
+#   path_backup <- Sys.getenv(""PATH"")
+#   Sys.setenv(""PATH"" = """")
+#   expect_error(
+#     check_unix_cpp_compiler(),
+#     ""A C++ compiler was not found. Please install the 'clang++' or 'g++' compiler, restart R, and run check_cmdstan_toolchain()."",
+#     fixed = TRUE
+#   )
+#   expect_error(
+#     check_unix_make(),
+#     ""The 'make' tool was not found. Please install 'make', restart R, and then run check_cmdstan_toolchain()."",
+#     fixed = TRUE
+#   )
+#   Sys.setenv(""PATH"" = path_backup)
+# })
+#
+# test_that(""toolchain checks on Windows with RTools 3.5 work"", {
+#   skip_if_not(os_is_windows())
+#   path_backup <- Sys.getenv(""PATH"")
+#   Sys.setenv(""PATH"" = """")
+#   expect_error(
+#     check_rtools35_windows_toolchain(),
+#     ""\nA toolchain was not found. Please install RTools 3.5 and run"",
+#     fixed = TRUE
+#   )
+#   Sys.setenv(""PATH"" = path_backup)
+# })
 
-test_that(""toolchain checks on Unix work"", {
-  skip_if(os_is_windows())
-  path_backup <- Sys.getenv(""PATH"")
-  Sys.setenv(""PATH"" = """")
+test_that(""toolchain checks without fixes on Windows with RTools 4.0 work"", {
+  skip_if_not(os_is_windows())
+  rtools40_home_backup <- Sys.getenv(""RTOOLS40_HOME"")
+  Sys.setenv(""RTOOLS40_HOME"" = """")
   expect_error(
-    check_unix_cpp_compiler(),
-    ""A C++ compiler was not found. Please install the 'clang++' or 'g++' compiler, restart R, and run check_cmdstan_toolchain()."",
+    check_rtools40_windows_toolchain(),
+    ""\nRTools 4.0 was not found but is required to run CmdStan with R version 4.x."",
     fixed = TRUE
   )
+
+  Sys.setenv(""RTOOLS40_HOME"" = ""C:/with spaces/"")
   expect_error(
-    check_unix_make(),
-    ""The 'make' tool was not found. Please install 'make', restart R, and then run check_cmdstan_toolchain()."",
+    check_rtools40_windows_toolchain(),
+    ""\nRTools 4.0 is installed in a path with spaces or brackets, which is not supported."",
     fixed = TRUE
   )
-  Sys.setenv(""PATH"" = path_backup)
-})
 
-test_that(""toolchain checks on Windows with RTools 3.5 work"", {
-  skip_if_not(os_is_windows())
+  Sys.setenv(""RTOOLS40_HOME"" = rtools40_home_backup)
   path_backup <- Sys.getenv(""PATH"")
   Sys.setenv(""PATH"" = """")
   expect_error(
-    check_rtools35_windows_toolchain(),
-    ""\nA toolchain was not found. Please install RTools 3.5 and run"",
+    check_rtools40_windows_toolchain(),
+    ""\nRTools installation found but PATH was not properly set.\nRun check_cmdstan_toolchain(fix = TRUE) to fix the issue."",
     fixed = TRUE
   )
-  Sys.setenv(""PATH"" = path_backup)
-})
 
-test_that(""toolchain checks on Windows with RTools 4.0 work"", {
-  skip_if_not(os_is_windows())
-  path_backup <- Sys.getenv(""PATH"")
-  Sys.setenv(""PATH"" = """")
+  tmpdir <- tempdir()
+  gpp_location <- file.path(rtools40_home_backup, ""mingw64"", ""bin"", ""g++.exe"")
+  file.copy(gpp_location, file.path(tmpdir, ""g++.exe""))
+  Sys.setenv(""PATH"" = paste0(tmpdir, "";"", path_backup))
   expect_error(
     check_rtools40_windows_toolchain(),
-    ""\nRTools 4.0 was not found but is required to run CmdStan with R version 4.x."",
+    ""\nOther C++ toolchains installed on your system conflict with RTools.\nPlease run check_cmdstan_toolchain(fix = TRUE) to fix the issue."",
     fixed = TRUE
   )
   Sys.setenv(""PATH"" = path_backup)",True,False,Implementation / Logic,6
stan-dev,cmdstanr,b33de6ff542ec55d6b236f8dba319f111f521b90,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-10-16T14:21:30Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-10-16T14:22:08Z,fix tests,tests/testthat/test-fit-gq.R;tests/testthat/test-fit-shared.R,False,True,True,False,10,2,12,"---FILE: tests/testthat/test-fit-gq.R---
@@ -31,7 +31,7 @@ test_that(""draws() method returns draws_array (reading csv works)"", {
   draws_sum_y <- fit_gq$draws(variables = c(""sum_y"", ""y_rep""))
   draws_y_sum <- fit_gq$draws(variables = c(""y_rep"", ""sum_y""))
   draws_all_after <- fit_gq$draws()
-  expect_type(draws, ""double"")
+  expect_type(draws, ""integer"")
   expect_s3_class(draws, ""draws_array"")
   expect_equal(posterior::variables(draws), PARAM_NAMES)
   expect_equal(posterior::nchains(draws), fit_gq$num_chains())

---FILE: tests/testthat/test-fit-shared.R---
@@ -135,10 +135,18 @@ test_that(""cmdstan_summary() and cmdstan_diagnose() work correctly"", {
 
 test_that(""draws() method returns a 'draws' object"", {
   skip_on_cran()
+  types <- list(
+    ""sample"" = ""double"",
+    ""optimize"" = ""double"",
+    ""variational"" = ""double"",
+    ""generate_quantities"" = ""integer""
+  )
   for (method in all_methods) {
     fit <- fits[[method]]
     draws <- fit$draws()
-    expect_type(draws, ""double"")
+    print(draws)
+    print(typeof(draws))
+    expect_type(draws, types[[method]])
     expect_s3_class(draws, ""draws"")
   }
 })",True,False,Implementation / Logic,3
stan-dev,cmdstanr,45b41af6570468d1c7fd1febed267e05073cfb3f,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-10-07T08:57:51Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-10-07T08:57:51Z,install mingw32-make with pacman on unit tests and a fix for test coverage,.github/workflows/R-CMD-check.yaml;.github/workflows/Test-coverage.yaml,False,False,False,False,11,8,19,"---FILE: .github/workflows/R-CMD-check.yaml---
@@ -40,6 +40,17 @@ jobs:
 
       - uses: actions/checkout@v2
 
+      - name: Set paths
+        run: |
+          echo ""::add-path::C:/rtools40/usr/bin""
+          echo ""::add-path::C:/rtools40/mingw64/bin""
+        shell: powershell
+      
+      - name: Install mingw32-make
+        run: |
+          pacman -Syu mingw-w64-x86_64-make --noconfirm
+        shell: powershell
+
       - uses: r-lib/actions/setup-r@master
         with:
           r-version: ${{ matrix.config.r }}

---FILE: .github/workflows/Test-coverage.yaml---
@@ -63,14 +63,6 @@ jobs:
       GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
     steps:
       - uses: actions/checkout@v2
-
-      - name: Download RTools 
-        run: Invoke-WebRequest -Uri https://cran.r-project.org/bin/windows/Rtools/rtools40-x86_64.exe -OutFile ./R40.exe
-        shell: powershell
-      
-      - name: Download RTools 
-        run: Start-Process -FilePath ./R40.exe -ArgumentList /VERYSILENT -NoNewWindow -Wait
-        shell: powershell
   
       - name: Set paths
         run: |",False,False,Data / Input Handling,3
stan-dev,cmdstanr,24f177bb940d0768cd54a5ad566b6ea0169ad232,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-10-07T06:47:02Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-10-07T06:47:02Z,set threads for vroom to eliminate the GA occasional bug,R/read_csv.R,False,True,True,False,2,1,3,"---FILE: R/read_csv.R---
@@ -214,7 +214,8 @@ read_cmdstan_csv <- function(files,
       altrep = FALSE,
       progress = FALSE,
       skip = metadata$lines_to_skip,
-      col_select = col_select
+      col_select = col_select,
+      num_threads = 1
     )
     if (metadata$method == ""generate_quantities"") {
       # set the first arg as double to silence the type detection info",True,False,Implementation / Logic,3
stan-dev,cmdstanr,bcd216ff3ff7af288edce0bdb1555342c3338454,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-10-07T06:14:46Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-10-07T06:14:46Z,fix CI,.github/workflows/R-CMD-check.yaml,False,False,False,False,0,9,9,"---FILE: .github/workflows/R-CMD-check.yaml---
@@ -55,15 +55,6 @@ jobs:
           key: ${{ runner.os }}-${{ hashFiles('.github/R-version') }}-1-${{ hashFiles('.github/depends.Rds') }}
           restore-keys: ${{ runner.os }}-${{ hashFiles('.github/R-version') }}-1-
 
-      - name: Install system dependencies
-        if: runner.os == 'Linux'
-        env:
-          RHUB_PLATFORM: linux-x86_64-ubuntu-gcc
-        run: |
-          Rscript -e ""remotes::install_github('r-hub/sysreqs')""
-          sysreqs=$(Rscript -e ""cat(sysreqs::sysreq_commands('DESCRIPTION'))"")
-          sudo -s eval ""$sysreqs""
-
       - name: Install dependencies
         run: |
           remotes::install_deps(dependencies = TRUE)",False,False,Documentation / Formatting,3
stan-dev,cmdstanr,29c0ae6103e9aeeb081c19d03a7b18a1a3d64d7e,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-10-06T18:36:04Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-10-06T18:36:04Z,another fix,.github/workflows/Test-coverage.yaml,False,False,False,False,0,2,2,"---FILE: .github/workflows/Test-coverage.yaml---
@@ -62,8 +62,6 @@ jobs:
     env:
       GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
     steps:
-        if: ""!startsWith(github.ref, 'refs/tags/') && github.ref != 'refs/heads/master'""
-
       - uses: actions/checkout@v2
 
       - uses: r-lib/actions/setup-r@master",False,False,Data / Input Handling,3
stan-dev,cmdstanr,f3970eec476d7858fadfb8c52889c9c0e38d1dcd,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-10-06T18:35:07Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-10-06T18:35:07Z,fix canceling jobs,.github/workflows/R-CMD-check.yaml;.github/workflows/Test-coverage.yaml,False,False,False,False,5,9,14,"---FILE: .github/workflows/R-CMD-check.yaml---
@@ -33,10 +33,10 @@ jobs:
 
     steps:
       - uses: n1hility/cancel-previous-runs@v2
-      with:
-        token: ${{ secrets.GITHUB_TOKEN }}
-        workflow: c-cpp.yml
-      if: ""!startsWith(github.ref, 'refs/tags/') && github.ref != 'refs/heads/master'""
+        with:
+          token: ${{ secrets.GITHUB_TOKEN }}
+          workflow: R-CMD-check.yaml
+        if: ""!startsWith(github.ref, 'refs/tags/') && github.ref != 'refs/heads/master'""
 
       - uses: actions/checkout@v2
 

---FILE: .github/workflows/Test-coverage.yaml---
@@ -19,7 +19,7 @@ jobs:
       - uses: n1hility/cancel-previous-runs@v2
         with:
           token: ${{ secrets.GITHUB_TOKEN }}
-          workflow: c-cpp.yml
+          workflow: Test-coverage.yml
         if: ""!startsWith(github.ref, 'refs/tags/') && github.ref != 'refs/heads/master'""
       - uses: actions/checkout@v2
 
@@ -62,10 +62,6 @@ jobs:
     env:
       GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
     steps:
-      - uses: n1hility/cancel-previous-runs@v2
-        with:
-          token: ${{ secrets.GITHUB_TOKEN }}
-          workflow: c-cpp.yml
         if: ""!startsWith(github.ref, 'refs/tags/') && github.ref != 'refs/heads/master'""
 
       - uses: actions/checkout@v2",False,False,Data / Input Handling,3
stan-dev,cmdstanr,f744354b847f8645a1ed8803ca0e335e3380cbc0,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-10-06T18:08:42Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-10-06T18:08:42Z,"fail fast on test failure
windows test coverage
refactor test names",.github/workflows/R-CMD-check.yaml;.github/workflows/Test-coverage.yaml,False,False,False,False,38,5,43,"---FILE: .github/workflows/R-CMD-check.yaml---
@@ -6,7 +6,7 @@ on:
     branches:
       - master
 
-name: R-CMD-check
+name: Unit tests
 
 jobs:
   R-CMD-check:
@@ -16,7 +16,7 @@ jobs:
     name: ${{ matrix.config.os }} (${{ matrix.config.r }})
 
     strategy:
-      fail-fast: false
+      fail-fast: true
       matrix:
         config:
           - {os: macOS-latest,   r: 'devel'}

---FILE: .github/workflows/Test-coverage.yaml---
@@ -6,12 +6,13 @@ on:
     branches:
       - master
 
-name: test-coverage
+name: Test coverage
 
 jobs:
-  test-coverage:
+  test-coverage-ubuntu:
+    name: ""Linux""
     if: ""! contains(github.event.head_commit.message, '[ci skip]')""
-    runs-on: ubuntu-16.04
+    runs-on: ubuntu-20.04
     env:
       GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
     steps:
@@ -48,3 +49,35 @@ jobs:
       - name: Test coverage
         run: covr::codecov(type = ""all"")
         shell: Rscript {0}
+
+  test-coverage-windows:
+    name: ""Windows""
+    if: ""! contains(github.event.head_commit.message, '[ci skip]')""
+    runs-on: windows-latest
+    env:
+      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
+    steps:
+      - uses: actions/checkout@v2
+
+      - uses: r-lib/actions/setup-r@master
+
+      - uses: r-lib/actions/setup-pandoc@master
+
+      - name: Query dependencies
+        run: |
+          install.packages('remotes')
+          saveRDS(remotes::dev_package_deps(dependencies = TRUE), "".github/depends.Rds"", version = 2)
+        shell: Rscript {0}
+
+      - name: Install dependencies
+        run: |
+          install.packages(c(""posterior"", ""cmdstanr"", ""remotes""),repos = c(""https://mc-stan.org/r-packages/"", getOption(""repos"")))
+          cmdstanr::install_cmdstan(cores = 2, overwrite = TRUE, release_url = ""https://github.com/stan-dev/cmdstan/releases/download/v2.24.1/cmdstan-2.24.1.tar.gz"")
+          remotes::install_deps(dependencies = TRUE)
+          remotes::install_cran(""covr"")
+          remotes::install_cran(""gridExtra"")
+        shell: Rscript {0}
+
+      - name: Test coverage
+        run: covr::codecov(type = ""all"")
+        shell: Rscript {0}
\ No newline at end of file",False,False,Rendering / Conversion,3
stan-dev,cmdstanr,2acb4bc92374f6f185bfd70036ba3ddeb86c870b,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-10-06T17:37:17Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-10-06T17:37:17Z,"improve error reporting
add testing",R/install.R;tests/testthat/test-install.R,False,True,True,False,42,6,48,"---FILE: R/install.R---
@@ -280,9 +280,14 @@ download_with_retries <- function(download_url,
                                   quiet = TRUE) {
     download_rc <- 1
     while (retries > 0 && download_rc != 0) {
-      download_rc <- utils::download.file(url = download_url,
-                                          destfile = destination_file,
-                                          quiet = quiet)
+      try(
+        suppressWarnings(
+          download_rc <- utils::download.file(url = download_url,
+                                            destfile = destination_file,
+                                            quiet = quiet)
+        ),
+        silent = TRUE                                    
+      )
       if (download_rc != 0) {
         Sys.sleep(pause_sec)
       }

---FILE: tests/testthat/test-install.R---
@@ -74,10 +74,41 @@ test_that(""install_cmdstan() errors if it times out"", {
   )
 })
 
-test_that(""install_cmdstan() errors if installation already exists"", {
+test_that(""install_cmdstan() errors if invalid version or URL"", {
   skip_if_offline()
-  expect_warning(
+  expect_error(
     install_cmdstan(version = ""2.23.2""),
-    ""cannot open URL 'https://github.com/stan-dev/cmdstan/releases/download/v2.23.2/cmdstan-2.23.2.tar.gz'""
+    ""Download of Cmdstan failed. Please check if the supplied version number is valid.""
+  )
+  expect_error(
+    install_cmdstan(release_url = ""https://github.com/stan-dev/cmdstan/releases/download/v2.23.2/cmdstan-2.23.2.tar.gz""),
+    ""Download of Cmdstan failed. Please check if the supplied release URL is valid.""
+  )
+})
+
+test_that(""install_cmdstan() works with version and release_url"", {
+  skip_if_offline()
+  if (getRversion() < '3.5.0') {
+    dir <- tempdir()
+  } else {
+    dir <- tempdir(check = TRUE)
+  }
+  expect_message(
+    expect_output(
+      install_cmdstan(dir = dir, overwrite = TRUE, cores = 4,
+                      release_url = ""https://github.com/stan-dev/cmdstan/releases/download/v2.23.0/cmdstan-2.23.0.tar.gz""),
+      ""Compiling, linking C++ code"",
+      fixed = TRUE
+    ),
+    ""Finished installing CmdStan""
+  )
+  expect_message(
+    expect_output(
+      install_cmdstan(dir = dir, overwrite = TRUE, cores = 4,
+                      version = ""2.23.0""),
+      ""Compiling, linking C++ code"",
+      fixed = TRUE
+    ),
+    ""Finished installing CmdStan""
   )
 })",True,False,Implementation / Logic,6
stan-dev,cmdstanr,b829320287680203393978ca0af8eaef7802a189,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-10-06T07:16:27Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-10-06T07:16:27Z,fix undefined run_times_0,tests/testthat/test-fit-mcmc.R,False,True,True,False,3,2,5,"---FILE: tests/testthat/test-fit-mcmc.R---
@@ -162,6 +162,7 @@ test_that(""time() method works after mcmc"", {
     ncols = 4
   )
 
+  run_times_0 <- fit_mcmc_0$time()
   checkmate::expect_number(run_times_0$total, finite = TRUE)
   checkmate::expect_data_frame(run_times_0$chains,
                                any.missing = TRUE,
@@ -170,8 +171,8 @@ test_that(""time() method works after mcmc"", {
                                ncols = 4)
   print(run_times_0)
   for (j in 1:nrow(run_times_0$chains)) {
-    checkmate::expect_number(run_times_0$chains$warmup[j], finite = TRUE)
-    checkmate::expect_number(run_times_0$chains$sampling[j], finite = TRUE)
+    checkmate::expect_number(run_times_0$chains$warmup[j])
+    checkmate::expect_number(run_times_0$chains$sampling[j])
   }
 })
 ",True,False,Implementation / Logic,3
stan-dev,cmdstanr,3233d6a7c55be1aa2b80f8853adf0c04432d6a58,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-10-06T06:54:12Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-10-06T06:55:03Z,"fix test, the times are now always reported",R/run.R;tests/testthat/test-fit-mcmc.R,False,True,True,False,3,12,15,"---FILE: R/run.R---
@@ -194,11 +194,6 @@ CmdStanRun <- R6::R6Class(
           sampling = self$procs$proc_section_time(""sampling"")[self$procs$is_finished()],
           total = self$procs$proc_total_time()[self$procs$is_finished()]
         )
-
-        if (isTRUE(self$args$refresh == 0)) {
-          warning(""Separate warmup and sampling times are not available "",
-                  ""after running with 'refresh=0'."", call. = FALSE)
-        }
         time <- list(total = self$procs$total_time(), chains = chain_time)
       }
       time

---FILE: tests/testthat/test-fit-mcmc.R---
@@ -162,20 +162,16 @@ test_that(""time() method works after mcmc"", {
     ncols = 4
   )
 
-  # after refresh=0 warmup and sampling times should be NA
-  testthat::expect_warning(
-    run_times_0 <- fit_mcmc_0$time(),
-    ""Separate warmup and sampling times are not available""
-  )
   checkmate::expect_number(run_times_0$total, finite = TRUE)
   checkmate::expect_data_frame(run_times_0$chains,
                                any.missing = TRUE,
                                types = c(""integer"", ""numeric""),
                                nrows = fit_mcmc_0$runset$num_procs(),
                                ncols = 4)
+  print(run_times_0)
   for (j in 1:nrow(run_times_0$chains)) {
-    checkmate::expect_scalar_na(run_times_0$chains$warmup[j])
-    checkmate::expect_scalar_na(run_times_0$chains$sampling[j])
+    checkmate::expect_number(run_times_0$chains$warmup[j], finite = TRUE)
+    checkmate::expect_number(run_times_0$chains$sampling[j], finite = TRUE)
   }
 })
 ",True,False,Implementation / Logic,6
stan-dev,cmdstanr,1d4daf54bfdf6b6d04e390256f0d9958a1467efe,jgabry,jgabry@gmail.com,2020-10-05T21:12:15Z,jgabry,jgabry@gmail.com,2020-10-05T21:12:15Z,fix failing test,R/data.R;tests/testthat/test-utils.R,False,True,True,False,3,2,5,"---FILE: R/data.R---
@@ -54,7 +54,7 @@ write_stan_json <- function(data, file) {
 }
 
 
-list_to_array <- function(x, name) {
+list_to_array <- function(x, name = NULL) {
   list_length <- length(x)
   if (list_length == 0) {
     return(NULL)

---FILE: tests/testthat/test-utils.R---
@@ -88,7 +88,8 @@ test_that(""list_to_array works with empty list"", {
 })
 
 test_that(""list_to_array fails for non-numeric values"", {
-  expect_error(list_to_array(list(k = ""test"")), ""All elements of the list must be numeric!"")
+  expect_error(list_to_array(list(k = ""test""), name = ""test-list""),
+               ""All elements in list 'test-list' must be numeric!"")
 })
 
 test_that(""cpp_options_to_compile_flags() works"", {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,1101e184f5368e0f923c25268d437b4e52f20f49,jgabry,jgabry@gmail.com,2020-09-11T16:43:39Z,jgabry,jgabry@gmail.com,2020-09-11T16:43:39Z,"write list of matrices correctly to json

fixes #296",R/data.R;tests/testthat/answers/json-lists.json;tests/testthat/answers/json-matrix-lists.json;tests/testthat/answers/json-vector-lists.json;tests/testthat/test-json.R,False,True,True,False,73,55,128,"---FILE: R/data.R---
@@ -35,7 +35,7 @@ write_stan_json <- function(data, file) {
     } else if (is.data.frame(var)) {
       var <- data.matrix(var)
     } else if (is.list(var)) {
-      var <- list_to_array(var)
+      var <- list_to_array(var, var_name)
     }
     data[[var_name]] <- var
   }
@@ -54,22 +54,25 @@ write_stan_json <- function(data, file) {
 }
 
 
-list_to_array <- function(x) {
+list_to_array <- function(x, name) {
   list_length <- length(x)
-  if (list_length == 0 ) return(NULL)
-  element_dim <- length(x[[1]])
-  check_equal_dim <- function(x, target_dim) { !is.null(element_dim) && length(x) == target_dim }
-  all_same_size <- all(sapply(x, check_equal_dim, target_dim = element_dim))
-  if (!all_same_size) {
-    stop(""All matrices/vectors in the list must be the same size!"", call. = FALSE)
+  if (list_length == 0) {
+    return(NULL)
+  }
+  all_dims <- lapply(x, function(z) dim(z) %||% length(z))
+  all_equal_dim <- all(sapply(all_dims, function(d) {
+    isTRUE(all.equal(d, all_dims[[1]]))
+  }))
+  if (!all_equal_dim) {
+    stop(""All matrices/vectors in list '"", name, ""' must be the same size!"", call. = FALSE)
   }
   all_numeric <- all(sapply(x, function(a) is.numeric(a)))
   if (!all_numeric) {
-    stop(""All elements of the list must be numeric!"", call. = FALSE)
+    stop(""All elements in list '"", name,""' must be numeric!"", call. = FALSE)
   }
-  element_num_of_dim <- length(element_dim)
+  element_num_of_dim <- length(all_dims[[1]])
   x <- unlist(x)
-  dim(x) <- c(element_dim, list_length)
+  dim(x) <- c(all_dims[[1]], list_length)
   aperm(x, c(element_num_of_dim + 1L, seq_len(element_num_of_dim)))
 }
 

---FILE: tests/testthat/answers/json-lists.json---
@@ -1,6 +0,0 @@
-{
-  ""N"": [
-    [26, 26, 26],
-    [26, 26, 26]
-  ]
-}

---FILE: tests/testthat/answers/json-matrix-lists.json---
@@ -0,0 +1,12 @@
+{
+  ""M"": [
+    [
+      [1, 3],
+      [2, 4]
+    ],
+    [
+      [5, 6],
+      [7, 8]
+    ]
+  ]
+}

---FILE: tests/testthat/answers/json-vector-lists.json---
@@ -0,0 +1,6 @@
+{
+  ""N"": [
+    [1, 2, 3],
+    [4, 5, 6]
+  ]
+}

---FILE: tests/testthat/test-json.R---
@@ -1,6 +1,6 @@
 context(""json"")
 
-test_that(""test JSON output unboxing"", {
+test_that(""JSON output unboxing works"", {
   temp_file <- tempfile()
   N <- 10
   write_stan_json(list(N = N), file = temp_file)
@@ -9,7 +9,7 @@ test_that(""test JSON output unboxing"", {
                       file = test_path(""answers"", ""json-unboxing.json""))
 })
 
-test_that(""test JSON output boolean"", {
+test_that(""JSON output for boolean is correct"", {
   temp_file <- tempfile()
   N <- c(TRUE, FALSE, TRUE)
   write_stan_json(list(N = N), file = temp_file)
@@ -18,7 +18,7 @@ test_that(""test JSON output boolean"", {
                       file = test_path(""answers"", ""json-boolean.json""))
 })
 
-test_that(""test JSON output factor"", {
+test_that(""JSON output for factors is correct"", {
   temp_file <- tempfile()
   N <- factor(c(0,1,2,2,1,0), labels = c(""c1"", ""c2"", ""c3""))
   write_stan_json(list(N = N), file = temp_file)
@@ -27,7 +27,7 @@ test_that(""test JSON output factor"", {
                       file = test_path(""answers"", ""json-factor.json""))
 })
 
-test_that(""test JSON output integer vector"", {
+test_that(""JSON output for integer vector is correct"", {
   temp_file <- tempfile()
   N <- c(1.0, 2.0, 3, 4)
 
@@ -37,7 +37,7 @@ test_that(""test JSON output integer vector"", {
                       file = test_path(""answers"", ""json-integer.json""))
 })
 
-test_that(""test JSON output data frame and matrix"", {
+test_that(""JSON output for data frame and matrix is correct"", {
   temp_file_df <- tempfile()
   temp_file_mat <- tempfile()
   x <- 1:3
@@ -54,62 +54,65 @@ test_that(""test JSON output data frame and matrix"", {
                       file = test_path(""answers"", ""json-df-matrix.json""))
 })
 
-test_that(""test JSON output lists"", {
+test_that(""JSON output for list of vectors is correct"", {
   temp_file <- tempfile()
-  I <- 2; J <- 3;
-  N <- lapply(1:I, function(i) rep(26, J))
+  N <- list(c(1,2,3), c(4,5,6))
 
   write_stan_json(list(N = N), file = temp_file)
   json_output <- readLines(temp_file)
   expect_known_output(cat(json_output, sep = ""\n""),
-                      file = test_path(""answers"", ""json-lists.json""))
+                      file = test_path(""answers"", ""json-vector-lists.json""))
 })
 
-test_that(""test JSON errors"", {
+test_that(""JSON output for list of matrices is correct"", {
+  temp_file <- tempfile()
+  matrices <- list(
+    matrix(1:4, nrow = 2, byrow = FALSE),
+    matrix(5:8, nrow = 2, byrow = TRUE)
+  )
+  write_stan_json(list(M = matrices), file = temp_file)
+  json_output <- readLines(temp_file)
+  expect_known_output(cat(json_output, sep = ""\n""),
+                      file = test_path(""answers"", ""json-matrix-lists.json""))
+})
+
+test_that(""write_stan_json() throws correct errors"", {
   skip_on_cran()
   temp_file <- tempfile()
 
-  N <- c(1.0, 2.0, 3, 4)
   expect_error(
-    write_stan_json(list(N = N), file = c(1,2)),
+    write_stan_json(list(N = c(1.0, 2.0, 3, 4)), file = c(1,2)),
     ""The supplied filename is invalid!""
   )
   expect_error(
     write_stan_json(list(N = N), file = """"),
     ""The supplied filename is invalid!""
   )
 
-  I <- 2; J <- 3;
-  N <- lapply(1:I, function(i) {
-    if (i==1)
-      rep(26, J)
-    else
-      rep(26, J-1)
-  })
   expect_error(
-    write_stan_json(list(N = N), file = ""abc.txt""),
-    ""All matrices/vectors in the list must be the same size!""
+    write_stan_json(list(N = list(c(26, 26, 26), c(26, 26))), file = ""abc.txt""),
+    ""All matrices/vectors in list 'N' must be the same size!""
   )
-  N <- lapply(1:I, function(i) {
-    if (i==1)
-      rep(26, J)
-    else
-      J
-  })
   expect_error(
-    write_stan_json(list(N = N), file = ""abc.txt""),
-    ""All matrices/vectors in the list must be the same size!""
+    write_stan_json(list(N = list(c(26, 26, 26), 3)), file = ""abc.txt""),
+    ""All matrices/vectors in list 'N' must be the same size!""
   )
-  I <- 2; J <- 3;
-  N <- lapply(1:I, function(i) {
-    if (i==1)
-      rep(26, J)
-    else
-      NULL
-  })
   expect_error(
-    write_stan_json(list(N = N), file = ""abc.txt""),
-    ""All matrices/vectors in the list must be the same size!""
+    write_stan_json(list(N = list(c(26, 26, 26), NULL)), file = ""abc.txt""),
+    ""All matrices/vectors in list 'N' must be the same size!""
+  )
+  expect_error(
+    write_stan_json(list(N = list(c(26, 26, 26), matrix(c(26, 26, 26), ncol = 1))), file = ""abc.txt""),
+    ""All matrices/vectors in list 'N' must be the same size!""
+  )
+  expect_error(
+    write_stan_json(list(N = list(matrix(1:8, ncol = 2), matrix(1:9, ncol = 3))), file = ""abc.txt""),
+    ""All matrices/vectors in list 'N' must be the same size!""
+  )
+
+  expect_error(
+    write_stan_json(list(N = list(""abc"", ""def"")), file = ""abc.txt""),
+    ""All elements in list 'N' must be numeric!""
   )
 
   expect_error(",True,False,Implementation / Logic,6
stan-dev,cmdstanr,2b385caa837d2c70f23424b90a5e6b88af67c5c8,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-09-02T09:42:33Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-09-02T09:42:33Z,cleanup and minor fixes after testing,R/install.R,False,True,True,False,22,24,46,"---FILE: R/install.R---
@@ -416,7 +416,7 @@ install_mingw32_make <- function() {
 }
 
 
-check_rtools40_windows_toolchain <- function() {
+check_rtools40_windows_toolchain <- function(fix = FALSE, quiet = FALSE) {
   rtools_path <- Sys.getenv(""RTOOLS40_HOME"")
   # If RTOOLS40_HOME is not set (the env. variable gets set on install)
   # we assume that RTools 40 is not installed.
@@ -450,7 +450,9 @@ check_rtools40_windows_toolchain <- function() {
       if (!quiet) message(""Installing mingw32-make and writing RTools path to ~/.Renviron ..."")
       install_mingw32_make()
       write('PATH=""${RTOOLS40_HOME}\\usr\\bin;${RTOOLS40_HOME}\\mingw64\\bin;${PATH}""', file = ""~/.Renviron"", append = TRUE)
-      stop(""Please restart R and run check_cmdstan_toolchain() to confirm the installation was successful."", call. = FALSE)
+      Sys.setenv(PATH = paste0(Sys.getenv(""RTOOLS40_HOME""), ""\\usr\\bin;"", Sys.getenv(""RTOOLS40_HOME""), ""\\mingw64\\bin;"", Sys.getenv(""PATH"")))
+	  check_rtools40_windows_toolchain(fix = FALSE, quiet = quiet)
+	  return(invisible(NULL))
     }
   }
   # Check if the mingw32-make and g++ get picked up by default are the RTools-supplied ones
@@ -465,12 +467,14 @@ check_rtools40_windows_toolchain <- function() {
       if (!quiet) message(""Installing mingw32-make and writing RTools path to ~/.Renviron ..."")
       install_mingw32_make()
       write('PATH=""${RTOOLS40_HOME}\\usr\\bin;${RTOOLS40_HOME}\\mingw64\\bin;${PATH}""', file = ""~/.Renviron"", append = TRUE)
-      stop(""Please restart R and run check_cmdstan_toolchain() to confirm the installation was successful."", call. = FALSE)
+      Sys.setenv(PATH = paste0(Sys.getenv(""RTOOLS40_HOME""), ""\\usr\\bin;"", Sys.getenv(""RTOOLS40_HOME""), ""\\mingw64\\bin;"", Sys.getenv(""PATH"")))
+	  check_rtools40_windows_toolchain(fix = FALSE, quiet = quiet)
+	  return(invisible(NULL))
     }
   }
 }
 
-check_rtools35_windows_toolchain <- function() {
+check_rtools35_windows_toolchain <- function(fix = FALSE, quiet = FALSE) {
   mingw32_make_path <- dirname(Sys.which(""mingw32-make""))
   gpp_path <- dirname(Sys.which(""g++""))
   # If mingw32-make and g++ are not found, we check typical RTools 3.5 folders.
@@ -480,17 +484,7 @@ check_rtools35_windows_toolchain <- function() {
     if (!nzchar(rtools_path)) {
       typical_paths <- c(
         file.path(""C:/"", ""Rtools""),
-        file.path(""C:/"", ""Rtools35""),
-        file.path(""C:/"", ""RTools""),
-        file.path(""C:/"", ""RTools35""),
-        file.path(""C:/"", ""rtools""),
-        file.path(""C:/"", ""rtools35""),
-        file.path(""c:/"", ""Rtools""),
-        file.path(""c:/"", ""Rtools35""),
-        file.path(""c:/"", ""RTools""),
-        file.path(""c:/"", ""RTools35""),
-        file.path(""c:/"", ""rtools""),
-        file.path(""c:/"", ""rtools35"")
+        file.path(""C:/"", ""Rtools35"")
       )
       found_rtools <- FALSE
       for (p in typical_paths) {
@@ -499,12 +493,13 @@ check_rtools35_windows_toolchain <- function() {
             stop(
               ""\nMultiple RTools 3.5 installations found. Please select the installation to use by running"",
               ""\n\nwrite(\'RTOOLS35_HOME=rtools35/install/path/\', file = \""~/.Renviron\"", append = TRUE)"",
-              ""\n\nThen restart R and run 'cmdstanr::check_cmdstan_toolchain(fix = FALSE)'."",
+              ""\n\nThen restart R and run 'cmdstanr::check_cmdstan_toolchain(fix = TRUE)'."",
               call. = FALSE
             )
           } else {
             rtools_path <- p
-          }        
+			found_rtools <- TRUE
+		  }
         }
       }
     }
@@ -519,24 +514,27 @@ check_rtools35_windows_toolchain <- function() {
       if (!quiet) {
         message(""Writing RTools path to ~/.Renviron ..."")
       }
-      if (nzchar(Sys.getenv(""RTOOLS35_HOME""))) {
+      if (!nzchar(Sys.getenv(""RTOOLS35_HOME""))) {
         write(paste0('RTOOLS35_HOME=', rtools_path), file = ""~/.Renviron"", append = TRUE)
+		Sys.setenv(RTOOLS35_HOME = rtools_path)
       }
       write('PATH=""${RTOOLS35_HOME}\\bin;${RTOOLS35_HOME}\\mingw_64\\bin;${PATH}""', file = ""~/.Renviron"", append = TRUE)
-      stop(""Please restart R and run check_cmdstan_toolchain() to confirm the installation was successful."", call. = FALSE)
+	  Sys.setenv(PATH = paste0(Sys.getenv(""RTOOLS35_HOME""), ""\\mingw_64\\bin;"", Sys.getenv(""PATH"")))
+      check_rtools35_windows_toolchain(fix = FALSE, quiet = quiet)
+	  return(invisible(NULL))
     } else {
       stop(
         ""\nA toolchain was not found. Please install RTools 3.5 and run"",
         ""\n\nwrite(\'RTOOLS35_HOME=rtools35/install/path/\', file = \""~/.Renviron\"", append = TRUE)"",
         ""\nreplacing 'rtools35/install/path/' with the actual install path of RTools 3.5."",
-        ""\n\nThen restart R and run 'cmdstanr::check_cmdstan_toolchain(fix = FALSE)'."",
+        ""\n\nThen restart R and run 'cmdstanr::check_cmdstan_toolchain(fix = TRUE)'."",
         call. = FALSE
       )
     }
   }
 }
 
-check_unix_toolchain <- function() {
+check_unix_toolchain <- function(fix = FALSE, quiet = FALSE) {
   # On Unix systems we check for make and a suitable compiler
   make_path <- dirname(Sys.which(""make""))
   if (!nzchar(make_path)) {
@@ -570,12 +568,12 @@ check_unix_toolchain <- function() {
 check_cmdstan_toolchain <- function(fix = FALSE, quiet = FALSE) {
   if (os_is_windows()) {
     if (R.version$major >= ""4"") {
-      check_rtools40_windows_toolchain()
+      check_rtools40_windows_toolchain(fix = fix, quiet = quiet)
     } else {
-      check_rtools35_windows_toolchain() 
+      check_rtools35_windows_toolchain(fix = fix, quiet = quiet)
     }
   } else {
-    check_unix_toolchain()
+    check_unix_toolchain(fix = fix, quiet = quiet)
   }
   if (!quiet) {
     message(""The CmdStan toolchain is setup properly!"")",True,False,Implementation / Logic,6
stan-dev,cmdstanr,f04353ff7cf30b689cc2f58af399b4a060f6668a,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-08-29T10:14:35Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-08-29T10:14:35Z,replace check_only with fix,R/install.R,False,True,True,False,2,2,4,"---FILE: R/install.R---
@@ -513,7 +513,7 @@ check_cmdstan_toolchain <- function(fix = FALSE, quiet = FALSE) {
                 stop(
                   ""\nMultiple RTools 3.5 installations found. Please select the installation to use by running"",
                   ""\n\nwrite(\'RTOOLS35_HOME=rtools35/install/path/\', file = \""~/.Renviron\"", append = TRUE)"",
-                  ""\n\nThen restart R and run 'cmdstanr::check_cmdstan_toolchain(check_only = FALSE)'."",
+                  ""\n\nThen restart R and run 'cmdstanr::check_cmdstan_toolchain(fix = FALSE)'."",
                   call. = FALSE
                 )
               } else {
@@ -543,7 +543,7 @@ check_cmdstan_toolchain <- function(fix = FALSE, quiet = FALSE) {
             ""\nA toolchain was not found. Please install RTools 3.5 and run"",
             ""\n\nwrite(\'RTOOLS35_HOME=rtools35/install/path/\', file = \""~/.Renviron\"", append = TRUE)"",
             ""\nreplacing 'rtools35/install/path/' with the actual install path of RTools 3.5."",
-            ""\n\nThen restart R and run 'cmdstanr::check_cmdstan_toolchain(check_only = FALSE)'."",
+            ""\n\nThen restart R and run 'cmdstanr::check_cmdstan_toolchain(fix = FALSE)'."",
             call. = FALSE
           )
         }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,afc4d968b1429b4ab211867bb2445d2687a0e6bb,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-08-29T10:13:42Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-08-29T10:13:42Z,fix newlines,R/install.R,False,True,True,False,35,26,61,"---FILE: R/install.R---
@@ -436,51 +436,50 @@ check_cmdstan_toolchain <- function(fix = FALSE, quiet = FALSE) {
       # If RTOOLS40_HOME is not set (the env. variable gets set on install)
       # we assume that RTools 40 is not installed.
       if (!nzchar(rtools_path)) {
-        error_message <- c(
+        stop(
           ""\nRTools 4.0 was not found but is required to run CmdStan with R version 4.x."",
-          ""Please install RTools 4.0 and run check_cmdstan_toolchain().""
+          ""\nPlease install RTools 4.0 and run check_cmdstan_toolchain()."",
+          call. = FALSE
         )
-        stop(paste0(error_message, collapse = ""\n""), call. = FALSE)
       }
       # If RTools is installed in a path with spaces or brackets
       # we error as this path is not valid
       if (regexpr(""\\(|)| "", rtools_path) > 0) {
-        error_message <- c(
+        stop(
           ""\nRTools 4.0 is installed in a path with spaces or brackets, which is not supported."",
-          ""Please reinstall RTools 4.0 to a valid path, restart R, and then run check_cmdstan_toolchain().""
+          ""\nPlease reinstall RTools 4.0 to a valid path, restart R, and then run check_cmdstan_toolchain()."",
+          call. = FALSE
         )
-        stop(paste0(error_message, collapse = ""\n""), call. = FALSE)
-      }
-      if (fix) {
-        install_mingw32_make()
       }
       toolchain_path <- repair_path(file.path(rtools_path, ""mingw64"", ""bin""))
       mingw32_make_path <- dirname(Sys.which(""mingw32-make""))
       gpp_path <- dirname(Sys.which(""g++""))
       
       if (!nzchar(mingw32_make_path) || !nzchar(gpp_path)) {
         if (!fix) {
-          error_message <- c(
+          stop(
             ""\nRTools installation found but PATH was not properly set."",
-            ""Run check_cmdstan_toolchain(fix = TRUE) to fix the issue.""
+            ""\nRun check_cmdstan_toolchain(fix = TRUE) to fix the issue."",
+            call. = FALSE
           )
-          stop(paste0(error_message, collapse = ""\n""), call. = FALSE)
         } else {
-          if (!quiet) message(""Writing RTools path to ~/.Renviron ..."")
+          if (!quiet) message(""Installing mingw32-make and writing RTools path to ~/.Renviron ..."")
+          install_mingw32_make()
           write('PATH=""${RTOOLS40_HOME}\\usr\\bin;${RTOOLS40_HOME}\\mingw64\\bin;${PATH}""', file = ""~/.Renviron"", append = TRUE)
           stop(""Please restart R and run check_cmdstan_toolchain() to confirm the installation was successful."", call. = FALSE)
         }
       }
       # Check if the mingw32-make and g++ get picked up by default are the RTools-supplied ones
       if (toolchain_path != mingw32_make_path || gpp_path != toolchain_path) {
         if (!fix) {
-          error_message <- c(
+          stop(
             ""\nOther C++ toolchains installed on your system conflict with RTools."",
-            ""Please run check_cmdstan_toolchain(fix = TRUE) to fix the issue.""
+            ""\nPlease run check_cmdstan_toolchain(fix = TRUE) to fix the issue."",
+            call. = FALSE
           )
-          stop(paste0(error_message, collapse = ""\n""), call. = FALSE)
         } else {
-          if (!quiet) message(""Writing RTools path to ~/.Renviron ..."")
+          if (!quiet) message(""Installing mingw32-make and writing RTools path to ~/.Renviron ..."")
+          install_mingw32_make()
           write('PATH=""${RTOOLS40_HOME}\\usr\\bin;${RTOOLS40_HOME}\\mingw64\\bin;${PATH}""', file = ""~/.Renviron"", append = TRUE)
           stop(""Please restart R and run check_cmdstan_toolchain() to confirm the installation was successful."", call. = FALSE)
         }
@@ -507,19 +506,29 @@ check_cmdstan_toolchain <- function(fix = FALSE, quiet = FALSE) {
             file.path(""c:/"", ""rtools""),
             file.path(""c:/"", ""rtools35"")
           )
+          found_rtools <- FALSE
           for (p in typical_paths) {
             if (dir.exists(p)) {
-              rtools_path <- p
+              if (found_rtools) {
+                stop(
+                  ""\nMultiple RTools 3.5 installations found. Please select the installation to use by running"",
+                  ""\n\nwrite(\'RTOOLS35_HOME=rtools35/install/path/\', file = \""~/.Renviron\"", append = TRUE)"",
+                  ""\n\nThen restart R and run 'cmdstanr::check_cmdstan_toolchain(check_only = FALSE)'."",
+                  call. = FALSE
+                )
+              } else {
+                rtools_path <- p
+              }        
             }
           }
         }
         if (nzchar(rtools_path)) {
           if (!fix) {
-            error_message <- c(
+            stop(
               ""\nRTools installation found but PATH was not properly set."",
-              ""Run check_cmdstan_toolchain(fix = TRUE) to fix the issue.""
+              ""\nRun check_cmdstan_toolchain(fix = TRUE) to fix the issue."",
+              call. = FALSE
             )
-            stop(paste0(error_message, collapse = ""\n""), call. = FALSE)
           }
           if (!quiet) {
             message(""Writing RTools path to ~/.Renviron ..."")
@@ -530,13 +539,13 @@ check_cmdstan_toolchain <- function(fix = FALSE, quiet = FALSE) {
           write('PATH=""${RTOOLS35_HOME}\\bin;${RTOOLS35_HOME}\\mingw_64\\bin;${PATH}""', file = ""~/.Renviron"", append = TRUE)
           stop(""Please restart R and run check_cmdstan_toolchain() to confirm the installation was successful."", call. = FALSE)
         } else {
-          error_message <- c(
+          stop(
             ""\nA toolchain was not found. Please install RTools 3.5 and run"",
-            ""\nwrite(\'RTOOLS35_HOME=rtools35/install/path/\', file = \""~/.Renviron\"", append = TRUE)"",
-            ""replacing 'rtools35/install/path/' with the actual install path of RTools 3.5."",
-            ""\nThen restart R and run 'cmdstanr::check_cmdstan_toolchain(check_only = FALSE)'.""
+            ""\n\nwrite(\'RTOOLS35_HOME=rtools35/install/path/\', file = \""~/.Renviron\"", append = TRUE)"",
+            ""\nreplacing 'rtools35/install/path/' with the actual install path of RTools 3.5."",
+            ""\n\nThen restart R and run 'cmdstanr::check_cmdstan_toolchain(check_only = FALSE)'."",
+            call. = FALSE
           )
-          stop(paste0(error_message, collapse = ""\n""), call. = FALSE)
         }
       }
     }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,bc713be0aa0a4f629ba7c1dddac1e7cd5a7515f1,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-08-28T15:40:29Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-08-28T15:40:29Z,fix messages,R/install.R,False,True,True,False,9,9,18,"---FILE: R/install.R---
@@ -430,7 +430,7 @@ check_cmdstan_toolchain <- function(fix = FALSE, quiet = FALSE) {
         error_message <- c(
           """",
           ""RTools 4.0 is required to run cmdstanr with R version 4.x, but was not found."",
-          ""Install RTools 4.0 and run 'cmdstanr::install_cmdstan_toolchain()'""
+          ""Install RTools 4.0 and run 'cmdstanr::check_cmdstan_toolchain()'""
         )
         stop(paste0(error_message, collapse = ""\n""), call. = FALSE)
       }
@@ -440,7 +440,7 @@ check_cmdstan_toolchain <- function(fix = FALSE, quiet = FALSE) {
         error_message <- c(
           """",
           ""RTools 4.0 is installed in a path with spaces or brackets, which is not supported."",
-          ""Reinstall RTools 4.0 to a valid path, restart R and run 'cmdstanr::install_cmdstan_toolchain()'""
+          ""Reinstall RTools 4.0 to a valid path, restart R and run 'cmdstanr::check_cmdstan_toolchain()'""
         )
         stop(paste0(error_message, collapse = ""\n""), call. = FALSE)
       }
@@ -456,13 +456,13 @@ check_cmdstan_toolchain <- function(fix = FALSE, quiet = FALSE) {
           error_message <- c(
             """",
             ""RTools installation found but PATH was not properly set."",
-            ""Run 'cmdstanr::install_cmdstan_toolchain(check_only = FALSE)' to fix the issue.""
+            ""Run 'cmdstanr::check_cmdstan_toolchain(check_only = FALSE)' to fix the issue.""
           )
           stop(paste0(error_message, collapse = ""\n""), call. = FALSE)
         } else {
           if (!quiet) message(""Writing RTools path to ~/.Renviron ..."")
           write('PATH=""${RTOOLS40_HOME}\\usr\\bin;${RTOOLS40_HOME}\\mingw64\\bin;${PATH}""', file = ""~/.Renviron"", append = TRUE)
-          stop(""Restart R and run install_cmdstan_toolchain(check_only = TRUE) to confirm the installation was successful."", call. = FALSE)
+          stop(""Restart R and run check_cmdstan_toolchain(check_only = TRUE) to confirm the installation was successful."", call. = FALSE)
         }
       }
       # Check if the mingw32-make and g++ get picked up by default are the RTools-supplied ones
@@ -471,13 +471,13 @@ check_cmdstan_toolchain <- function(fix = FALSE, quiet = FALSE) {
           error_message <- c(
             """",
             ""Other C++ toolchains installed on your system conflict with RTools."",
-            ""Run 'cmdstanr::install_cmdstan_toolchain(check_only = FALSE)' to fix the issue.""
+            ""Run 'cmdstanr::check_cmdstan_toolchain(check_only = FALSE)' to fix the issue.""
           )
           stop(paste0(error_message, collapse = ""\n""), call. = FALSE)
         } else {
           if (!quiet) message(""Writing RTools path to ~/.Renviron ..."")
           write('PATH=""${RTOOLS40_HOME}\\usr\\bin;${RTOOLS40_HOME}\\mingw64\\bin;${PATH}""', file = ""~/.Renviron"", append = TRUE)
-          stop(""Restart R and run install_cmdstan_toolchain(check_only = TRUE) to confirm the installation was successful."", call. = FALSE)
+          stop(""Restart R and run check_cmdstan_toolchain(check_only = TRUE) to confirm the installation was successful."", call. = FALSE)
         }
       }
     } else {
@@ -513,7 +513,7 @@ check_cmdstan_toolchain <- function(fix = FALSE, quiet = FALSE) {
             error_message <- c(
               """",
               ""A RTools installation was found, but the PATH is not properly set."",
-              ""Run 'cmdstanr::install_cmdstan_toolchain(check_only = FALSE)' to fix the issue.""
+              ""Run 'cmdstanr::check_cmdstan_toolchain(check_only = FALSE)' to fix the issue.""
             )
             stop(paste0(error_message, collapse = ""\n""), call. = FALSE)
           }
@@ -522,7 +522,7 @@ check_cmdstan_toolchain <- function(fix = FALSE, quiet = FALSE) {
             write(paste0('RTOOLS35_HOME=', rtools_path), file = ""~/.Renviron"", append = TRUE)
           }
           write('PATH=""${RTOOLS35_HOME}\\bin;${RTOOLS35_HOME}\\mingw_64\\bin;${PATH}""', file = ""~/.Renviron"", append = TRUE)
-          stop(""Restart R and run install_cmdstan_toolchain(check_only = TRUE) to confirm the installation was successful."", call. = FALSE)
+          stop(""Restart R and run check_cmdstan_toolchain(check_only = TRUE) to confirm the installation was successful."", call. = FALSE)
         } else {
           error_message <- c(
             """",
@@ -531,7 +531,7 @@ check_cmdstan_toolchain <- function(fix = FALSE, quiet = FALSE) {
             ""write(\'RTOOLS35_HOME=rtools35/install/path/\', file = \""~/.Renviron\"", append = TRUE)"",
             ""replacing 'rtools35/install/path/' with the actual install path of RTools 3.5."",
             """",
-            ""Then restart R and run 'cmdstanr::install_cmdstan_toolchain(check_only = FALSE)'.""
+            ""Then restart R and run 'cmdstanr::check_cmdstan_toolchain(check_only = FALSE)'.""
           )
           stop(paste0(error_message, collapse = ""\n""), call. = FALSE)
         }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,2cbef1da0cc4ca518201aeaa38a8190bbebbfaa5,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-08-27T19:20:36Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-08-27T19:20:36Z,fix binding to only bind new variables,R/fit.R,False,True,True,False,8,4,12,"---FILE: R/fit.R---
@@ -937,32 +937,36 @@ CmdStanMCMC <- R6::R6Class(
       private$metadata_ <- data_csv$metadata
 
       if (!is.null(data_csv$post_warmup_draws)) {
+        missing_variables <- !(posterior::variables(data_csv$post_warmup_draws) %in% posterior::variables(private$draws_))
         private$draws_ <- posterior::bind_draws(
           private$draws_,
-          data_csv$post_warmup_draws,
+          data_csv$post_warmup_draws[,,missing_variables],
           along=""variable""
         )
       }
       if (!is.null(data_csv$post_warmup_sampler_diagnostics)) {
+        missing_variables <- !(posterior::variables(data_csv$post_warmup_sampler_diagnostics) %in% posterior::variables(private$sampler_diagnostics_))
         private$sampler_diagnostics_ <- posterior::bind_draws(
           private$sampler_diagnostics_,
-          data_csv$post_warmup_sampler_diagnostics,
+          data_csv$post_warmup_sampler_diagnostics[,,missing_variables],
           along=""variable""
         )
       }
       if (!is.null(data_csv$metadata$save_warmup)
          && data_csv$metadata$save_warmup) {
         if (!is.null(data_csv$warmup_draws)) {
+          missing_variables <- !(posterior::variables(data_csv$warmup_draws) %in% posterior::variables(private$warmup_draws_))
           private$warmup_draws_ <- posterior::bind_draws(
             private$warmup_draws_,
-            data_csv$warmup_draws,
+            data_csv$warmup_draws[,,missing_variables],
             along=""variable""
           )
         }
         if (!is.null(data_csv$warmup_sampler_diagnostics)) {
+          missing_variables <- !(posterior::variables(data_csv$warmup_sampler_diagnostics) %in% posterior::variables(private$warmup_sampler_diagnostics_))
           private$warmup_sampler_diagnostics_ <- posterior::bind_draws(
             private$warmup_sampler_diagnostics_,
-            data_csv$warmup_sampler_diagnostics,
+            data_csv$warmup_sampler_diagnostics[,,missing_variables],
             along=""variable""
           )
         }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,76744470946a7581b3f37fe8a2ada0c77f3687c2,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-08-27T19:11:55Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-08-27T19:11:55Z,fix for dir in cmdstan_model,R/model.R,False,True,True,False,1,0,1,"---FILE: R/model.R---
@@ -375,6 +375,7 @@ compile_method <- function(quiet = TRUE,
     dir <- absolute_path(dir)
   }
   if (!is.null(dir)) {
+    dir <- repair_path(dir)
     checkmate::assert_directory_exists(dir, access = ""rw"")
   }
 ",True,False,Implementation / Logic,6
stan-dev,cmdstanr,b3a0d7c84eb8385349f6f363bf794484b26f0d9f,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-08-27T18:57:37Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-08-27T18:59:58Z,fix trailing / windows bug,R/args.R;R/fit.R;R/install.R;R/utils.R;tests/testthat/test-model-output_dir.R,False,True,True,False,25,9,34,"---FILE: R/args.R---
@@ -53,7 +53,7 @@ CmdStanArgs <- R6::R6Class(
       } else {
         self$output_dir <- output_dir %||% tempdir(check = TRUE)
       }
-
+      self$output_dir <- repair_path(self$output_dir)
       if (is.function(init)) {
         init <- process_init_function(init, length(self$proc_ids))
       } else if (is.list(init) && !is.data.frame(init)) {
@@ -66,7 +66,7 @@ CmdStanArgs <- R6::R6Class(
     },
     validate = function() {
       validate_cmdstan_args(self)
-      self$output_dir <- absolute_path(self$output_dir)
+      self$output_dir <- repair_path(absolute_path(self$output_dir))
       if (is.character(self$data_file)) {
         self$data_file <- absolute_path(self$data_file)
       }

---FILE: R/fit.R---
@@ -937,32 +937,36 @@ CmdStanMCMC <- R6::R6Class(
       private$metadata_ <- data_csv$metadata
 
       if (!is.null(data_csv$post_warmup_draws)) {
+        missing_variables <- !(posterior::variables(data_csv$post_warmup_draws) %in% posterior::variables(private$draws_))
         private$draws_ <- posterior::bind_draws(
           private$draws_,
-          data_csv$post_warmup_draws,
+          data_csv$post_warmup_draws[,,missing_variables],
           along=""variable""
         )
       }
       if (!is.null(data_csv$post_warmup_sampler_diagnostics)) {
+        missing_variables <- !(posterior::variables(data_csv$post_warmup_sampler_diagnostics) %in% posterior::variables(private$sampler_diagnostics_))
         private$sampler_diagnostics_ <- posterior::bind_draws(
           private$sampler_diagnostics_,
-          data_csv$post_warmup_sampler_diagnostics,
+          data_csv$post_warmup_sampler_diagnostics[,,missing_variables],
           along=""variable""
         )
       }
       if (!is.null(data_csv$metadata$save_warmup)
          && data_csv$metadata$save_warmup) {
         if (!is.null(data_csv$warmup_draws)) {
+          missing_variables <- !(posterior::variables(data_csv$warmup_draws) %in% posterior::variables(private$warmup_draws_))
           private$warmup_draws_ <- posterior::bind_draws(
             private$warmup_draws_,
-            data_csv$warmup_draws,
+            data_csv$warmup_draws[,,missing_variables],
             along=""variable""
           )
         }
         if (!is.null(data_csv$warmup_sampler_diagnostics)) {
+          missing_variables <- !(posterior::variables(data_csv$warmup_sampler_diagnostics) %in% posterior::variables(private$warmup_sampler_diagnostics_))
           private$warmup_sampler_diagnostics_ <- posterior::bind_draws(
             private$warmup_sampler_diagnostics_,
-            data_csv$warmup_sampler_diagnostics,
+            data_csv$warmup_sampler_diagnostics[,,missing_variables],
             along=""variable""
           )
         }

---FILE: R/install.R---
@@ -61,8 +61,8 @@ install_cmdstan <- function(dir = NULL,
       dir.create(dir, recursive = TRUE)
     }
   } else {
-    checkmate::assert_directory_exists(dir, access = ""rwx"")
     dir <- repair_path(dir)
+    checkmate::assert_directory_exists(dir, access = ""rwx"")    
   }
 
   if (!is.null(release_url)) {

---FILE: R/utils.R---
@@ -68,7 +68,7 @@ repair_path <- function(path) {
   path <- gsub(""\\\\"", ""/"", path)
   path <- gsub(""//"", ""/"", path)
   if (endsWith(path, ""/"")) {
-    # remove trailing ""/"" (is this necessary?)
+    # remove trailing ""/""
     path <- substr(path, 1, nchar(path) - 1)
   }
   path

---FILE: tests/testthat/test-model-output_dir.R---
@@ -68,4 +68,16 @@ test_that(""error if output_dir is invalid"", {
   file.remove(list.files(sandbox, full.names = TRUE, recursive = TRUE))
 })
 
-
+test_that(""output_dir works with trailing /"", {
+  skip_on_cran()
+  test_dir <- file.path(sandbox, ""trailing"")
+  dir.create(test_dir)
+  fit <- testing_fit(
+    ""bernoulli"",
+    method = ""sample"",
+    seed = 123,
+    output_dir = paste0(test_dir,""/"")
+  )
+  expect_equal(fit$runset$args$output_dir, absolute_path(test_dir))
+  expect_equal(length(list.files(test_dir)), fit$num_procs())
+})",True,False,Implementation / Logic,6
stan-dev,cmdstanr,1140229aa01fcd0e1efe601550e95f79570da21d,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-08-27T18:57:18Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-08-27T18:57:25Z,fix test,tests/testthat/test-csv.R;tests/testthat/test-fit-mcmc.R,False,True,True,False,4,4,8,"---FILE: tests/testthat/test-csv.R---
@@ -336,9 +336,9 @@ test_that(""read_cmdstan_csv() works with no samples"", {
   csv_output_dense_e_0_w <- read_cmdstan_csv(fit_bernoulli_dense_e_no_samples_warmup$output_files())
   expect_equal(csv_output_dense_e_0_w$post_warmup_sampler_diagnostics, NULL)
   csv_output_dense_e_0_w <- read_cmdstan_csv(fit_bernoulli_dense_e_no_samples_warmup$output_files())
-  expect_equal(dim(csv_output_dense_e_0_w$warmup_draws), c(100,2,2))
+  expect_equal(dim(csv_output_dense_e_0_w$warmup_draws), c(100, 2, 2))
   csv_output_dense_e_0_w <- read_cmdstan_csv(fit_bernoulli_dense_e_no_samples_warmup$output_files())
-  expect_equal(dim(csv_output_dense_e_0_w$warmup_sampler_diagnostics), c(100,2,6))
+  expect_equal(dim(csv_output_dense_e_0_w$warmup_sampler_diagnostics), c(100, 2, 6))
 })
 
 test_that(""read_cmdstan_csv() reads values up to adaptation"", {

---FILE: tests/testthat/test-fit-mcmc.R---
@@ -198,14 +198,14 @@ test_that(""inc_warmup in draws() works"", {
   y0 <- fit_mcmc_0$sampler_diagnostics(inc_warmup = FALSE)
   y1 <- fit_mcmc_1$sampler_diagnostics(inc_warmup = FALSE)
   y2 <- fit_mcmc_1$sampler_diagnostics(inc_warmup = TRUE)
-  # y3 <- fit_mcmc_3$sampler_diagnostics(inc_warmup = TRUE)
+  y3 <- fit_mcmc_3$sampler_diagnostics(inc_warmup = TRUE)
   y4 <- fit_mcmc_3$sampler_diagnostics(inc_warmup = FALSE)
   expect_equal(dim(y0), c(1000, 2, 6))
   expect_error(fit_mcmc_0$sampler_diagnostics(inc_warmup = TRUE),
                ""Warmup sampler diagnostics were requested from a fit object without them!"")
   expect_equal(dim(y1), c(1000, 2, 6))
   expect_equal(dim(y2), c(2000, 2, 6))
-  # expect_equal(dim(y3), c(100, 1, 6))
+  expect_equal(dim(y3), c(100, 1, 6))
   expect_equal(dim(y4), NULL)
 })
 ",True,False,Implementation / Logic,6
stan-dev,cmdstanr,2063cf7886f7b95d9505a5b4363709c2382589c5,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-08-27T13:26:49Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-08-27T13:26:49Z,fix documentation of $check_syntax(),R/model.R,False,True,True,False,2,2,4,"---FILE: R/model.R---
@@ -527,8 +527,8 @@ CmdStanModel$set(""public"", name = ""compile"", value = compile_method)
 #'
 #' @section Arguments:
 #'   * `quiet`: (logical) Should informational messages be printed? Default is
-#'   `TRUE`, which will print a message if the model is valid or the compiler
-#'   error message if there are syntax errors in the model. If `FALSE`, only the
+#'   `FALSE`, which will print a message if the model is valid or the compiler
+#'   error message if there are syntax errors in the model. If `TRUE`, only the
 #'   error message will be printed.
 #'   * `include_paths`: (character vector) Paths to directories where Stan
 #'   should look for files specified in `#include` directives in the Stan",True,False,Documentation / Formatting,4
stan-dev,cmdstanr,628023e13362d1c5707f5dd150935e9d1d32e674,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-08-26T18:49:39Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-08-26T18:49:39Z,fix sampler diagnostics return with no sampler and warmup saved,R/read_csv.R;tests/testthat/test-csv.R;tests/testthat/test-fit-mcmc.R,False,True,True,False,35,10,45,"---FILE: R/read_csv.R---
@@ -255,23 +255,27 @@ read_cmdstan_csv <- function(files,
               posterior::as_draws_array(draws[1:num_warmup_draws, variables]),
               along=""chain""
             )
-            post_warmup_draws <- posterior::bind_draws(
-              post_warmup_draws,
-              posterior::as_draws_array(draws[(num_warmup_draws+1):all_draws, variables]),
-              along=""chain""
-            )
+            if (num_post_warmup_draws > 0) {
+              post_warmup_draws <- posterior::bind_draws(
+                post_warmup_draws,
+                posterior::as_draws_array(draws[(num_warmup_draws+1):all_draws, variables]),
+                along=""chain""
+              )
+            }            
           }
           if (length(sampler_diagnostics) > 0) {
             warmup_sampler_diagnostics_draws <- posterior::bind_draws(
               warmup_sampler_diagnostics_draws,
               posterior::as_draws_array(draws[1:num_warmup_draws, sampler_diagnostics]),
               along=""chain""
             )
-            post_warmup_sampler_diagnostics_draws <- posterior::bind_draws(
-              post_warmup_sampler_diagnostics_draws,
-              posterior::as_draws_array(draws[(num_warmup_draws+1):all_draws, sampler_diagnostics]),
-              along=""chain""
-            )
+            if (num_post_warmup_draws > 0) {
+              post_warmup_sampler_diagnostics_draws <- posterior::bind_draws(
+                post_warmup_sampler_diagnostics_draws,
+                posterior::as_draws_array(draws[(num_warmup_draws+1):all_draws, sampler_diagnostics]),
+                along=""chain""
+              )
+            }
           }
         } else {
             warmup_draws <- NULL

---FILE: tests/testthat/test-csv.R---
@@ -12,6 +12,9 @@ if (not_on_cran()) {
                           seed = 123, chains = 2, iter_sampling = 0, metric = ""diag_e"")
   fit_bernoulli_dense_e_no_samples <- testing_fit(""bernoulli"", method = ""sample"",
                           seed = 123, chains = 2, iter_sampling = 0, metric = ""dense_e"")
+  fit_bernoulli_dense_e_no_samples_warmup <- testing_fit(""bernoulli"", method = ""sample"", seed = 123, chains = 2,
+                                                         iter_warmup = 100, iter_sampling = 0, save_warmup = 1,
+                                                         metric = ""dense_e"")
   fit_bernoulli_thin_1 <- testing_fit(""bernoulli"", method = ""sample"",
                           seed = 123, chains = 2, iter_sampling = 1000, iter_warmup = 1000, thin = 1)
   fit_logistic_thin_1 <- testing_fit(""logistic"", method = ""sample"",
@@ -328,6 +331,14 @@ test_that(""read_cmdstan_csv() works with no samples"", {
   expect_equal(csv_output_diag_e_0$post_warmup_draws, NULL)
   csv_output_dense_e_0 <- read_cmdstan_csv(fit_bernoulli_dense_e_no_samples$output_files())
   expect_equal(csv_output_dense_e_0$post_warmup_draws, NULL)
+  csv_output_dense_e_0_w <- read_cmdstan_csv(fit_bernoulli_dense_e_no_samples_warmup$output_files())
+  expect_equal(csv_output_dense_e_0_w$post_warmup_draws, NULL)
+  csv_output_dense_e_0_w <- read_cmdstan_csv(fit_bernoulli_dense_e_no_samples_warmup$output_files())
+  expect_equal(csv_output_dense_e_0_w$post_warmup_sampler_diagnostics, NULL)
+  csv_output_dense_e_0_w <- read_cmdstan_csv(fit_bernoulli_dense_e_no_samples_warmup$output_files())
+  expect_equal(dim(csv_output_dense_e_0_w$warmup_draws), c(100,2,2))
+  csv_output_dense_e_0_w <- read_cmdstan_csv(fit_bernoulli_dense_e_no_samples_warmup$output_files())
+  expect_equal(dim(csv_output_dense_e_0_w$warmup_sampler_diagnostics), c(100,2,6))
 })
 
 test_that(""read_cmdstan_csv() reads values up to adaptation"", {

---FILE: tests/testthat/test-fit-mcmc.R---
@@ -14,6 +14,12 @@ if (not_on_cran()) {
                             seed = 1234, chains = 1,
                             iter_sampling = 100000,
                             refresh = 0, metric = ""dense_e"")
+  fit_mcmc_3 <- testing_fit(""logistic"", method = ""sample"",
+                            seed = 1234, chains = 1,
+                            iter_warmup = 100,
+                            iter_sampling = 0,
+                            save_warmup = 1,
+                            refresh = 0, metric = ""dense_e"")
   PARAM_NAMES <- c(""alpha"", ""beta[1]"", ""beta[2]"", ""beta[3]"")
 }
 
@@ -192,11 +198,15 @@ test_that(""inc_warmup in draws() works"", {
   y0 <- fit_mcmc_0$sampler_diagnostics(inc_warmup = FALSE)
   y1 <- fit_mcmc_1$sampler_diagnostics(inc_warmup = FALSE)
   y2 <- fit_mcmc_1$sampler_diagnostics(inc_warmup = TRUE)
+  # y3 <- fit_mcmc_3$sampler_diagnostics(inc_warmup = TRUE)
+  y4 <- fit_mcmc_3$sampler_diagnostics(inc_warmup = FALSE)
   expect_equal(dim(y0), c(1000, 2, 6))
   expect_error(fit_mcmc_0$sampler_diagnostics(inc_warmup = TRUE),
                ""Warmup sampler diagnostics were requested from a fit object without them!"")
   expect_equal(dim(y1), c(1000, 2, 6))
   expect_equal(dim(y2), c(2000, 2, 6))
+  # expect_equal(dim(y3), c(100, 1, 6))
+  expect_equal(dim(y4), NULL)
 })
 
 test_that(""inc_warmup in draws() works"", {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,bf22b210839da034d53407b49f097979b99a5a14,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-08-21T20:27:14Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-08-21T20:27:14Z,fix trailing / in output_dir bug,R/args.R;R/utils.R;tests/testthat/test-model-output_dir.R,False,True,True,False,18,4,22,"---FILE: R/args.R---
@@ -53,7 +53,7 @@ CmdStanArgs <- R6::R6Class(
       } else {
         self$output_dir <- output_dir %||% tempdir(check = TRUE)
       }
-
+      self$output_dir <- repair_path(self$output_dir)
       if (is.function(init)) {
         init <- process_init_function(init, length(self$proc_ids))
       } else if (is.list(init) && !is.data.frame(init)) {
@@ -66,7 +66,7 @@ CmdStanArgs <- R6::R6Class(
     },
     validate = function() {
       validate_cmdstan_args(self)
-      self$output_dir <- absolute_path(self$output_dir)
+      self$output_dir <- repair_path(absolute_path(self$output_dir))
       if (is.character(self$data_file)) {
         self$data_file <- absolute_path(self$data_file)
       }
@@ -446,7 +446,6 @@ VariationalArgs <- R6::R6Class(
 #' @return `TRUE` invisibly unless an error is thrown.
 validate_cmdstan_args = function(self) {
   validate_exe_file(self$exe_file)
-
   checkmate::assert_directory_exists(self$output_dir, access = ""rw"")
 
   # at least 1 run id (chain id)

---FILE: R/utils.R---
@@ -68,7 +68,7 @@ repair_path <- function(path) {
   path <- gsub(""\\\\"", ""/"", path)
   path <- gsub(""//"", ""/"", path)
   if (endsWith(path, ""/"")) {
-    # remove trailing ""/"" (is this necessary?)
+    # remove trailing ""/""
     path <- substr(path, 1, nchar(path) - 1)
   }
   path

---FILE: tests/testthat/test-model-output_dir.R---
@@ -68,4 +68,19 @@ test_that(""error if output_dir is invalid"", {
   file.remove(list.files(sandbox, full.names = TRUE, recursive = TRUE))
 })
 
+test_that(""output_dir works with trailing /"", {
+  skip_on_cran()
+  test_dir <- file.path(sandbox, ""trailing"")
+  dir.create(test_dir)
+  fit <- testing_fit(
+    ""bernoulli"",
+    method = ""sample"",
+    seed = 123,
+    output_dir = paste0(test_dir,""/"")
+  )
+  expect_equal(fit$runset$args$output_dir, absolute_path(test_dir))
+  expect_equal(length(list.files(test_dir)), fit$num_procs())
+})
+
+
 ",True,False,Implementation / Logic,6
stan-dev,cmdstanr,a447a011e8e4b6d297bf4b5743859077cc092993,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-08-19T20:09:04Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-08-19T20:09:04Z,fix divergences check when no samples,R/utils.R;tests/testthat/test-utils.R,False,True,True,False,12,2,14,"---FILE: R/utils.R---
@@ -279,7 +279,7 @@ check_divergences <- function(data_csv) {
     divergences <- posterior::extract_variable_matrix(data_csv$post_warmup_sampler_diagnostics, ""divergent__"")
     num_of_draws <- length(divergences)
     num_of_divergences <- sum(divergences)
-    if (num_of_divergences > 0) {
+    if (!is.na(num_of_divergences) && num_of_divergences > 0) {
       percentage_divergences <- (num_of_divergences)/num_of_draws*100
       message(
         ""\nWarning: "", num_of_divergences, "" of "", num_of_draws,
@@ -301,7 +301,7 @@ check_sampler_transitions_treedepth <- function(data_csv) {
     num_of_draws <- length(treedepth)
     max_treedepth <- data_csv$metadata$max_treedepth
     max_treedepth_hit <- sum(treedepth >= max_treedepth)
-    if (max_treedepth_hit > 0) {
+    if (!is.na(max_treedepth_hit) && max_treedepth_hit > 0) {
       percentage_max_treedepth <- (max_treedepth_hit)/num_of_draws*100
       message(max_treedepth_hit, "" of "", num_of_draws, "" ("", (format(round(percentage_max_treedepth, 0), nsmall = 1)), ""%)"",
               "" transitions hit the maximum treedepth limit of "", max_treedepth,

---FILE: tests/testthat/test-utils.R---
@@ -23,6 +23,16 @@ test_that(""check_divergences() works"", {
   csv_output <- read_cmdstan_csv(csv_files)
   output <- ""1 of 100 \\(1.0%\\) transitions ended with a divergence.""
   expect_message(check_divergences(csv_output), output)
+
+
+  fit_wramup_no_samples <- testing_fit(""logistic"", method = ""sample"",
+                          seed = 123, chains = 1,
+                          iter_sampling = 0,
+                          iter_warmup = 10,
+                          save_warmup = TRUE,
+                          validate_csv = FALSE)
+  csv_output <- read_cmdstan_csv(fit_wramup_no_samples$output_files())
+  expect_message(check_divergences(csv_output), regexp = NA)
 })
 
 test_that(""check_sampler_transitions_treedepth() works"", {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,1bc8e3ac1f26bdd5886421371eacc9ed14198e52,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-08-19T13:34:51Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-08-19T13:34:51Z,minor fixes for vignette,vignettes/cmdstanr-internals.Rmd,True,False,True,False,15,9,24,"---FILE: vignettes/cmdstanr-internals.Rmd---
@@ -103,23 +103,29 @@ mod$exe_file()
 
 ### Pedantic check
 
-If you are using CmdStan version 2.24 or later, you can run a pedantic check for your model, by setting the `warn-pedantic`
-stanc option. You can supply the option during regular compilation, but a more convenient way is to use the `$check_syntax()`
-method of the `CmdStanModel` object. 
+If you are using CmdStan version 2.24 or later, you can run a pedantic check for your model,
+by setting the `warn-pedantic` stanc option. You can supply the option during regular
+compilation, but a more convenient way is to use the `$check_syntax()` method of the
+`CmdStanModel` object. 
 
 This check warns you about potential issues in your model, like for example: 
-- Distribution usages issues: Distribution arguments do not match the distribution specification, or some specific distribution is used in an inadvisable way.
+- Distribution usages issues: Distribution arguments do not match the distribution specification,
+  or some specific distribution is used in an inadvisable way.
 - Unused parameter: A parameter is defined but does not contribute to target.
-- Large or small constant in a distribution: Very large or very small constants are used as distribution arguments.
-- Control flow depends on a parameter: Branching control flow (like if/else) depends on a parameter value.
+- Large or small constant in a distribution: Very large or very small constants are used
+  as distribution arguments.
+- Control flow depends on a parameter: Branching control flow (like if/else) depends
+  on a parameter value.
 - Parameter has multiple twiddles: A parameter is on the left-hand side of multiple twiddles.
 - Parameter has zero or multiple priors: A parameter has more than one prior distribution.
 - Variable is used before assignment: A variable is used before being assigned a value.
 - Strict or nonsensical parameter bounds: A parameter is given questionable bounds.
 
-```{r pedantic-check}
-mod <- cmdstan_model(stan_file, compile = FALSE) # create a model object, compilation is not required
-mod$check_syntax(stanc_options = list(""warn-pedantic"" = TRUE)) # run a syntax check with the Stan compiler flag
+```{r pedantic-check, eval = FALSE}
+# create a model object, compilation is not required
+mod <- cmdstan_model(stan_file, compile = FALSE)
+# run a syntax check with the --warn-pedantic Stan compiler option
+mod$check_syntax(stanc_options = list(""warn-pedantic"" = TRUE)) 
 ```
 
 ### Executable location",False,True,Rendering / Conversion,6
stan-dev,cmdstanr,ce45343c925e284a500234d88fc1c9d585750998,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-08-19T13:06:08Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-08-19T13:06:08Z,add to vignete and fix comments,R/model.R;vignettes/cmdstanr-internals.Rmd,True,True,True,False,33,9,42,"---FILE: R/model.R---
@@ -508,33 +508,36 @@ CmdStanModel$set(""public"", name = ""compile"", value = compile_method)
 
 #' Check syntax of a Stan program
 #'
-#' @name model-method-syntax_check
-#' @aliases syntax_check
+#' @name model-method-check_syntax
+#' @aliases check_syntax
 #' @family CmdStanModel methods
 #'
-#' @description The `$syntax_check()` method of a [`CmdStanModel`] object
+#' @description The `$check_syntax()` method of a [`CmdStanModel`] object
 #'   checks the Stan program for syntax errors and returns `TRUE` (invisibly) if 
 #'   parsing succeeds. In case of a syntax error, an error is thrown.
 #'   
 #' @section Usage:
 #'   ```
-#'   $syntax_check(
+#'   $check_syntax(
 #'     quiet = TRUE,
 #'     include_paths = NULL,
 #'     stanc_options = list()
 #'   )
 #'   ```
 #'
 #' @section Arguments:
-#'   * `quiet`: (logical) Should the compile command be printed.
+#'   * `quiet`: (logical) Should informational messages on compiling be printed.
+#'   Default is `TRUE`, which will print a message if the model is valid or the 
+#'   compiler error message if there are syntax errors in the model.
+#'   If `FALSE`, only the error message will be printed.
 #'   * `include_paths`: (character vector) Paths to directories where Stan
 #'   should look for files specified in `#include` directives in the Stan
 #'   program.
 #'   * `stanc_options`: (list) Any Stan-to-C++ transpiler options to be used
 #'   when compiling the model. See the documentation for the
 #'   [`$compile()`][model-method-compile] method for details.
 #'
-#' @section Value: The `$syntax_check()` method returns `TRUE` (invisibly) if the model
+#' @section Value: The `$check_syntax()` method returns `TRUE` (invisibly) if the model
 #'   is valid.
 #'
 #' @template seealso-docs
@@ -544,12 +547,12 @@ CmdStanModel$set(""public"", name = ""compile"", value = compile_method)
 #' file <- file.path(cmdstan_path(), ""examples/bernoulli/bernoulli.stan"")
 #'
 #' mod <- cmdstan_model(file, compile = FALSE)
-#' mod$syntax_check()
+#' mod$check_syntax()
 #' }
 #'
 NULL
 
-syntax_check_method <- function(quiet = TRUE,
+check_syntax_method <- function(quiet = TRUE,
                            include_paths = NULL,
                            stanc_options = list()) {
   if (length(stanc_options) == 0 && !is.null(private$precompile_stanc_options_)) {
@@ -612,7 +615,7 @@ syntax_check_method <- function(quiet = TRUE,
 
   invisible(TRUE)
 }
-CmdStanModel$set(""public"", name = ""syntax_check"", value = syntax_check_method)
+CmdStanModel$set(""public"", name = ""check_syntax"", value = check_syntax_method)
 
 #' Run Stan's MCMC algorithms
 #'

---FILE: vignettes/cmdstanr-internals.Rmd---
@@ -101,6 +101,27 @@ mod$compile()
 mod$exe_file()
 ```
 
+### Pedantic check
+
+If you are using CmdStan version 2.24 or later, you can run a pedantic check for your model, by setting the `warn-pedantic`
+stanc option. You can supply the option during regular compilation, but a more convenient way is to use the `$check_syntax()`
+method of the `CmdStanModel` object. 
+
+This check warns you about potential issues in your model, like for example: 
+- Distribution usages issues: Distribution arguments do not match the distribution specification, or some specific distribution is used in an inadvisable way.
+- Unused parameter: A parameter is defined but does not contribute to target.
+- Large or small constant in a distribution: Very large or very small constants are used as distribution arguments.
+- Control flow depends on a parameter: Branching control flow (like if/else) depends on a parameter value.
+- Parameter has multiple twiddles: A parameter is on the left-hand side of multiple twiddles.
+- Parameter has zero or multiple priors: A parameter has more than one prior distribution.
+- Variable is used before assignment: A variable is used before being assigned a value.
+- Strict or nonsensical parameter bounds: A parameter is given questionable bounds.
+
+```{r pedantic-check}
+mod <- cmdstan_model(stan_file, compile = FALSE) # create a model object, compilation is not required
+mod$check_syntax(stanc_options = list(""warn-pedantic"" = TRUE)) # run a syntax check with the Stan compiler flag
+```
+
 ### Executable location
 
 By default, the executable is created in the same directory as the file",True,True,Rendering / Conversion,6
stan-dev,cmdstanr,8e4dafcca166eafe76a27da8ef3a75ccb65f8249,jgabry,jgabry@gmail.com,2020-08-18T15:41:08Z,jgabry,jgabry@gmail.com,2020-08-18T15:41:08Z,"error if NAs in data list

fixes #283",R/data.R;tests/testthat/test-data.R;tests/testthat/test-model-data.R,False,True,True,False,28,1,29,"---FILE: R/data.R---
@@ -94,6 +94,9 @@ process_data <- function(data) {
         call. = FALSE
       )
     }
+    if (any_na_elements(data)) {
+      stop(""Data includes NA values."", call. = FALSE)
+    }
     path <- tempfile(pattern = ""standata-"", fileext = "".json"")
     write_stan_json(data = data, file = path)
   } else {
@@ -102,14 +105,20 @@ process_data <- function(data) {
   path
 }
 
-# check if any objects in the data list have zero
+# check if any objects in the data list have zero as one of their dimensions
 any_zero_dims <- function(data) {
   has_zero_dims <- sapply(data, function(x) {
     any(dim(x) == 0)
   })
   any(has_zero_dims)
 }
 
+# check if any objects in the data list contain NAs
+any_na_elements <- function(data) {
+  has_na_elements <- sapply(data, anyNA)
+  any(has_na_elements)
+}
+
 
 #' Process fitted params for the generate quantities method
 #'

---FILE: tests/testthat/test-data.R---
@@ -7,6 +7,13 @@ if (not_on_cran()) {
   fit_optimize <- testing_fit(""bernoulli"", method = ""optimize"", seed = 123)
 }
 
+test_that(""NAs detected in data list"", {
+  expect_false(any_na_elements(list(y = 1)))
+  expect_true(any_na_elements(list(y = 1, N = NA)))
+  expect_true(any_na_elements(list(x = matrix(NA, 1, 1))))
+  expect_true(any_na_elements(list(x = list(1, NA))))
+})
+
 test_that(""process_fitted_params() works with basic input types"", {
   temp_file <- tempfile()
   temp_files <- c(tempfile(),

---FILE: tests/testthat/test-model-data.R---
@@ -35,3 +35,14 @@ test_that(""error if CmdStan < 2.22 and any 0-dimensional data objects"", {
   .cmdstanr$VERSION <- ver
 })
 
+test_that(""error if data contains NA elements"", {
+  # some different ways data can contain NAs
+  data_list1 <- data_list2 <- data_list3 <- data_list
+  data_list1$N <- NA
+  data_list2$y[3] <- NA
+  data_list3$X[3, 2] <- NA
+
+  expect_error(mod$sample(data = data_list1), ""Data includes NA values"")
+  expect_error(mod$sample(data = data_list2), ""Data includes NA values"")
+  expect_error(mod$sample(data = data_list3), ""Data includes NA values"")
+})",True,False,Implementation / Logic,6
stan-dev,cmdstanr,6bbe421dc63e5cd6b8ada2e82c78d5388df002fc,jgabry,jgabry@gmail.com,2020-08-17T15:42:56Z,jgabry,jgabry@gmail.com,2020-08-17T15:42:56Z,"bump version to 0.1.2

because we deprecated write_stan_tempfile(). see https://github.com/paul-buerkner/brms/issues/981",DESCRIPTION;NEWS.md,False,False,False,False,6,3,9,"---FILE: DESCRIPTION---
@@ -1,7 +1,7 @@
 Package: cmdstanr
 Title: R Interface to 'CmdStan'
-Version: 0.1.1
-Date: 2020-08-03
+Version: 0.1.2
+Date: 2020-08-17
 Authors@R: 
     c(person(given = ""Jonah"", family = ""Gabry"", role = c(""aut"", ""cre""),
            email = ""jsg2201@columbia.edu""),

---FILE: NEWS.md---
@@ -1,4 +1,7 @@
-# Items for next release
+# cmdstanr 0.1.2
+
+* User is notified by message at load time if a new release of CmdStan is
+available. (#265, #273)
 
 * `write_stan_file()` replaces `write_stan_tempfile()`, which is now deprecated.
 With the addition of the `dir` argument, the file written is not necessarily",False,False,Reproducibility / Versioning,7
stan-dev,cmdstanr,497a0c8f08ed234f5df7819dd0a279017982f5ba,Jonah Gabry,jgabry@gmail.com,2020-08-15T04:56:31Z,GitHub,noreply@github.com,2020-08-15T04:56:31Z,"fix typo in vignette

[ci skip]",vignettes/cmdstanr.Rmd,True,False,True,False,1,1,2,"---FILE: vignettes/cmdstanr.Rmd---
@@ -81,7 +81,7 @@ that would have been used by `install_cmdstan()` (see #2).
 2. If no environment variable is found when loaded but any directory in the form
 `"".cmdstanr/cmdstan-[version]""`, for example `"".cmdstanr/cmdstan-2.23.0""`,
 exists in the user's home directory (`Sys.getenv(""HOME"")`,
-*not* the current working directory) then the path to the cmdstan with the
+*not* the current working directory) then the path to the CmdStan with the
 largest version number will be set as the path to CmdStan for the R session.
 This is the same as the default directory that `install_cmdstan()` uses to
 install the latest version of CmdStan, so if that's how you installed CmdStan",False,True,Documentation / Formatting,4
stan-dev,cmdstanr,c6851aff49d037a0e7e64ce90a47063db5fd9346,jgabry,jgabry@gmail.com,2020-08-13T17:06:19Z,jgabry,jgabry@gmail.com,2020-08-13T17:06:19Z,"fix loading if no previous cmdstan installation

closes #274",R/zzz.R,False,True,True,False,3,1,4,"---FILE: R/zzz.R---
@@ -24,8 +24,10 @@ startup_messages <- function() {
   ))
   if (!skip_version_check) {
     latest_version <- try(suppressWarnings(latest_released_version()), silent = TRUE)
+    current_version <- try(cmdstan_version(), silent = TRUE)
     if (!inherits(latest_version, ""try-error"")
-        && latest_version > cmdstan_version()) {
+        && !inherits(current_version, ""try-error"")
+        && latest_version > current_version) {
       packageStartupMessage(
         ""\nA newer version of CmdStan is available. See ?install_cmdstan() to install it."",
         ""\nTo disable this check set option or environment variable CMDSTANR_NO_VER_CHECK=TRUE.""",True,False,Implementation / Logic,6
stan-dev,cmdstanr,239e991019598a810201db84a1b143969d6bdb81,jgabry,jgabry@gmail.com,2020-08-03T18:14:24Z,jgabry,jgabry@gmail.com,2020-08-03T18:14:24Z,try fixing test coverage error,.github/workflows/Test-coverage.yaml;vignettes/r_markdown.Rmd,True,False,True,False,2,1,3,"---FILE: .github/workflows/Test-coverage.yaml---
@@ -42,6 +42,7 @@ jobs:
           cmdstanr::install_cmdstan(cores = 2, overwrite = TRUE, release_url = ""https://github.com/stan-dev/cmdstan/releases/download/v2.24.0/cmdstan-2.24.0.tar.gz"")
           remotes::install_deps(dependencies = TRUE)
           remotes::install_cran(""covr"")
+          remotes::install_cran(""gridExtra"")
         shell: Rscript {0}
 
       - name: Test coverage

---FILE: vignettes/r_markdown.Rmd---
@@ -7,7 +7,7 @@ output:
 params:
   EVAL: !r identical(Sys.getenv(""NOT_CRAN""), ""true"")
 vignette: >
-  %\VignetteIndexEntry{R Markdown Stan Engine}
+  %\VignetteIndexEntry{R Markdown CmdStan Engine}
   %\VignetteEngine{knitr::rmarkdown}
   %\VignetteEncoding{UTF-8}
 ---",False,True,Rendering / Conversion,3
stan-dev,cmdstanr,43ed5fd57adb899c85c9e0c792661fb0338a92a3,jgabry,jgabry@gmail.com,2020-08-02T20:26:16Z,jgabry,jgabry@gmail.com,2020-08-02T20:26:16Z,fix my typo when editing description,DESCRIPTION;man/eng_stan.Rd,False,False,False,False,2,2,4,"---FILE: DESCRIPTION---
@@ -5,7 +5,7 @@ Date: 2020-07-29
 Authors@R: 
     c(person(given = ""Jonah"", family = ""Gabry"", role = c(""aut"", ""cre""),
            email = ""jsg2201@columbia.edu""),
-      person(given = ""Rok"", family = ""enovar"", role = ""aut""), 
+      person(given = ""Rok"", family = ""enovar"", role = ""aut"", 
            email = ""rok.cesnovar@fri.uni-lj.si""),     
       person(given = ""Ben"", family = ""Bales"", role = ""ctb""),     
       person(given = ""Mitzi"", family = ""Morris"", role = ""ctb""), 

---FILE: man/eng_stan.Rd---
@@ -7,7 +7,7 @@
 eng_stan(options)
 }
 \arguments{
-\item{options}{Chunk options, as provided by \code{knitr} during chunk execution}
+\item{options}{Chunk options, as provided by \code{knitr} during chunk execution.}
 }
 \description{
 This provides a \code{stan} engine for \code{knitr}, suitable for usage when attempting",False,False,Documentation / Formatting,7
stan-dev,cmdstanr,b65a219380fe7eaeab38661543ca408f4f8eb933,jgabry,jgabry@gmail.com,2020-08-02T20:01:08Z,jgabry,jgabry@gmail.com,2020-08-02T20:01:08Z,"code around defining knitr_valid_path

It occured to me that to be totally safe we should directly copy the function definition from knitr to avoid issues copying GPL code in more liberally licensed BSD package.",R/knitr.R,False,True,True,False,11,12,23,"---FILE: R/knitr.R---
@@ -50,22 +50,21 @@ eng_stan <- function(options) {
     )
   }
   if (options$eval) {
-    if (options$cache)
-      dir <- knitr_valid_path(options[[""cache.path""]], options$label)
-    else
+    if (options$cache) {
+      cache_path <- options$cache.path
+      if (length(cache_path) == 0L || is.na(cache_path) || cache_path == ""NA"") {
+        cache_path <- """"
+      }
+      dir <- paste0(cache_path, options$label)
+    } else {
       dir <- tempdir()
-    model_file <- write_stan_tempfile(options$code, dir)
-    csm <- cmdstan_model(model_file)
-    assign(output_var, csm, envir = knitr::knit_global())
+    }
+    file <- write_stan_tempfile(options$code, dir)
+    mod <- cmdstan_model(file)
+    assign(output_var, mod, envir = knitr::knit_global())
   }
   options$engine <- ""stan"" # for syntax highlighting
   code <- paste(options$code, collapse = ""\n"")
   knitr::engine_output(options, code, '')
 }
 
-# Since {knitr} does not export valid_path():
-knitr_valid_path <- function(prefix, label) {
-  if (length(prefix) == 0L || is.na(prefix) || prefix == ""NA"")
-    prefix <- """"
-  return(paste0(prefix, label))
-}",True,False,Implementation / Logic,6
stan-dev,cmdstanr,4dd2c183f206afbf37e8c1b8dc04fb9040f80823,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-07-30T09:14:25Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-07-30T09:14:25Z,fix tests to match after renaming,tests/testthat/test-csv.R,False,True,True,False,8,8,16,"---FILE: tests/testthat/test-csv.R---
@@ -481,7 +481,7 @@ test_that(""read_cmdstan_csv() errors for files from different methods"", {
   )
 })
 
-test_that(""stan_variables and stan_var_dims works in read_cdmstan_csv()"", {
+test_that(""stan_variables and stan_variable_dims works in read_cdmstan_csv()"", {
   skip_on_cran()
   bern_opt <- read_cmdstan_csv(fit_bernoulli_optimize$output_files())
   bern_vi <- read_cmdstan_csv(fit_bernoulli_variational$output_files())
@@ -501,14 +501,14 @@ test_that(""stan_variables and stan_var_dims works in read_cdmstan_csv()"", {
 
   expect_equal(gq$metadata$stan_variables, c(""y_rep"",""sum_y""))
 
-  expect_equal(bern_opt$metadata$stan_var_dims, list(lp__ = 1, theta = 1))
-  expect_equal(bern_vi$metadata$stan_var_dims, list(lp__ = 1, lp_approx__ = 1, theta = 1))
-  expect_equal(bern_samp$metadata$stan_var_dims, list(lp__ = 1, theta = 1))
+  expect_equal(bern_opt$metadata$stan_variable_dims, list(lp__ = 1, theta = 1))
+  expect_equal(bern_vi$metadata$stan_variable_dims, list(lp__ = 1, lp_approx__ = 1, theta = 1))
+  expect_equal(bern_samp$metadata$stan_variable_dims, list(lp__ = 1, theta = 1))
 
-  expect_equal(log_opt$metadata$stan_var_dims, list(lp__ = 1, alpha = 1, beta = 3))
-  expect_equal(log_vi$metadata$stan_var_dims, list(lp__ = 1, lp_approx__ = 1, alpha = 1, beta = 3))
-  expect_equal(log_samp$metadata$stan_var_dims, list(lp__ = 1, alpha = 1, beta = 3))
+  expect_equal(log_opt$metadata$stan_variable_dims, list(lp__ = 1, alpha = 1, beta = 3))
+  expect_equal(log_vi$metadata$stan_variable_dims, list(lp__ = 1, lp_approx__ = 1, alpha = 1, beta = 3))
+  expect_equal(log_samp$metadata$stan_variable_dims, list(lp__ = 1, alpha = 1, beta = 3))
 
-  expect_equal(gq$metadata$stan_var_dims, list(y_rep = 10, sum_y = 1))
+  expect_equal(gq$metadata$stan_variable_dims, list(y_rep = 10, sum_y = 1))
 })
 ",True,False,Implementation / Logic,3
stan-dev,cmdstanr,5b2c612d4447e7ebe057adc962ede10288d94789,jgabry,jgabry@gmail.com,2020-07-29T20:02:26Z,jgabry,jgabry@gmail.com,2020-07-29T20:02:26Z,"fix typo in code comments

[ci skip]",R/install.R,False,True,True,False,1,1,2,"---FILE: R/install.R---
@@ -135,7 +135,7 @@ install_cmdstan <- function(dir = NULL,
       )
     }
     if (version > ""2.22"" && version < ""2.24"") {
-      # cmdstan 2.23 unnecesserily required chmod after moving the windows-stanc
+      # cmdstan 2.23 unnecessarily required chmod after moving the windows-stanc
       # this moves the exe file so the make command that requires chmod is not used
       windows_stanc <- file.path(dir_cmdstan, ""bin"", ""windows-stanc"")
       bin_stanc_exe <- file.path(dir_cmdstan, ""bin"", ""stanc.exe"")",True,False,Implementation / Logic,6
stan-dev,cmdstanr,77b68fc7147d5f39d88012c5f769493ebf0dfdee,jgabry,jgabry@gmail.com,2020-07-29T18:06:06Z,jgabry,jgabry@gmail.com,2020-07-29T18:06:06Z,fix install_cmdstan doc,R/install.R;docs/reference/install_cmdstan.html;man/install_cmdstan.Rd,False,True,True,False,20,16,36,"---FILE: R/install.R---
@@ -2,11 +2,12 @@
 #'
 #' @description The `install_cmdstan()` function attempts to download and
 #'   install the latest release of
-#'   [CmdStan](https://github.com/stan-dev/cmdstan/releases/latest) or a
-#'   development version from a repository. Currently the necessary C++ tool
+#'   [CmdStan](https://github.com/stan-dev/cmdstan/releases/latest). Installing
+#'   a previous release or a new release candidate is also possible by
+#'   specifying the `release_url` argument. Currently the necessary C++ tool
 #'   chain is assumed to be available, but in the future CmdStanR may help
-#'   install the requirements. See the first few sections of the CmdStan
-#'   [installation guide](https://mc-stan.org/docs/2_24/cmdstan-guide/cmdstan-installation.html)
+#'   install the requirements. See the first few sections of the
+#'   CmdStan [installation guide](https://mc-stan.org/docs/2_24/cmdstan-guide/cmdstan-installation.html)
 #'   for details on the required toolchain.
 #'
 #'   The `rebuild_cmdstan()` function cleans and rebuilds the cmdstan

---FILE: docs/reference/install_cmdstan.html---
@@ -49,11 +49,12 @@
 <meta property=""og:title"" content=""Install CmdStan or clean and rebuild an existing installation  install_cmdstan"" />
 <meta property=""og:description"" content=""The install_cmdstan() function attempts to download and
 install the latest release of
-CmdStan or a
-development version from a repository. Currently the necessary C++ tool
+CmdStan. Installing
+a previous release or a new release candidate is also possible by
+specifying the release_url argument. Currently the necessary C++ tool
 chain is assumed to be available, but in the future CmdStanR may help
-install the requirements. See the first few sections of the CmdStan
-installation guide
+install the requirements. See the first few sections of the
+CmdStan installation guide
 for details on the required toolchain.
 The rebuild_cmdstan() function cleans and rebuilds the cmdstan
 installation. Use this function in case of any issues when compiling
@@ -194,11 +195,12 @@ <h1>Install CmdStan or clean and rebuild an existing installation</h1>
     <div class=""ref-description"">
     <p>The <code>install_cmdstan()</code> function attempts to download and
 install the latest release of
-<a href='https://github.com/stan-dev/cmdstan/releases/latest'>CmdStan</a> or a
-development version from a repository. Currently the necessary C++ tool
+<a href='https://github.com/stan-dev/cmdstan/releases/latest'>CmdStan</a>. Installing
+a previous release or a new release candidate is also possible by
+specifying the <code>release_url</code> argument. Currently the necessary C++ tool
 chain is assumed to be available, but in the future CmdStanR may help
-install the requirements. See the first few sections of the CmdStan
-<a href='https://mc-stan.org/docs/2_24/cmdstan-guide/cmdstan-installation.html'>installation guide</a>
+install the requirements. See the first few sections of the
+CmdStan <a href='https://mc-stan.org/docs/2_24/cmdstan-guide/cmdstan-installation.html'>installation guide</a>
 for details on the required toolchain.</p>
 <p>The <code>rebuild_cmdstan()</code> function cleans and rebuilds the cmdstan
 installation. Use this function in case of any issues when compiling

---FILE: man/install_cmdstan.Rd---
@@ -67,11 +67,12 @@ the updated contents are returned.
 \description{
 The \code{install_cmdstan()} function attempts to download and
 install the latest release of
-\href{https://github.com/stan-dev/cmdstan/releases/latest}{CmdStan} or a
-development version from a repository. Currently the necessary C++ tool
+\href{https://github.com/stan-dev/cmdstan/releases/latest}{CmdStan}. Installing
+a previous release or a new release candidate is also possible by
+specifying the \code{release_url} argument. Currently the necessary C++ tool
 chain is assumed to be available, but in the future CmdStanR may help
-install the requirements. See the first few sections of the CmdStan
-\href{https://mc-stan.org/docs/2_24/cmdstan-guide/cmdstan-installation.html}{installation guide}
+install the requirements. See the first few sections of the
+CmdStan \href{https://mc-stan.org/docs/2_24/cmdstan-guide/cmdstan-installation.html}{installation guide}
 for details on the required toolchain.
 
 The \code{rebuild_cmdstan()} function cleans and rebuilds the cmdstan",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,2e10ce68d1bec855f937bfe8e35c20d24f4e9922,jgabry,jgabry@gmail.com,2020-07-28T22:54:10Z,jgabry,jgabry@gmail.com,2020-07-28T22:54:10Z,fix bug that introduces NAs if names like both a[ and aa[,R/utils.R;tests/testthat/test-utils.R,False,True,True,False,7,5,12,"---FILE: R/utils.R---
@@ -347,7 +347,7 @@ variable_dims <- function(variable_names = NULL) {
   uniq_variable_names <- unique(gsub(""\\[.*\\]"", """", variable_names))
   var_names <- gsub(""\\]"", """", variable_names)
   for (var in uniq_variable_names) {
-    pattern <- paste0(var, ""\\["")
+    pattern <- paste0(""^"", var, ""\\["")
     var_indices <- var_names[grep(pattern, var_names)]
     var_indices <- gsub(pattern, """", var_indices)
     if (length(var_indices)) {

---FILE: tests/testthat/test-utils.R---
@@ -129,6 +129,8 @@ test_that(""cmdstan_make_local() works"", {
 })
 
 test_that(""variable_dims() works"", {
+  expect_null(variable_dims(NULL))
+
   vars <- c(""a"", ""b[1]"", ""b[2]"", ""b[3]"", ""c[1,1]"", ""c[1,2]"")
   vars_dims <- list(a = 1, b = 3, c = c(1,2))
   expect_equal(variable_dims(vars), vars_dims)
@@ -137,14 +139,14 @@ test_that(""variable_dims() works"", {
   vars_dims <- list(a = 1, b = 1)
   expect_equal(variable_dims(vars), vars_dims)
 
-  vars <- c()
-  vars_dims <- NULL
-  expect_equal(variable_dims(vars), vars_dims)
-
   vars <- c(""c[1,1]"", ""c[1,2]"", ""c[1,3]"", ""c[2,1]"", ""c[2,2]"", ""c[2,3]"", ""b[1]"", ""b[2]"", ""b[3]"", ""b[4]"")
   vars_dims <- list(c = c(2,3), b = 4)
   expect_equal(variable_dims(vars), vars_dims)
 
+  # make sure not confused by one name being last substring of another name
+  vars <- c(""a[1]"", ""a[2]"", ""aa[1]"", ""aa[2]"", ""aa[3]"")
+  expect_equal(variable_dims(vars), list(a = 2, aa = 3))
+
   # wrong dimensions for descending order
   vars <- c(""c[1,1]"", ""c[1,2]"", ""c[1,3]"", ""c[2,3]"", ""c[2,2]"", ""c[2,1]"", ""b[4]"", ""b[2]"", ""b[3]"", ""b[1]"")
   vars_dims <- list(c = c(2,1), b = 1)",True,False,Implementation / Logic,6
stan-dev,cmdstanr,bbcb15cc07f69ac565aeba36fc4399678cdb03b7,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-07-28T08:04:22Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-07-28T08:04:22Z,fix tests,R/model.R;tests/testthat/test-model-compile.R,False,True,True,False,33,21,54,"---FILE: R/model.R---
@@ -454,7 +454,9 @@ compile_method <- function(quiet = TRUE,
     }
   }
   stancflags_val <- paste0(""STANCFLAGS += "", stancflags_val, paste0(stanc_built_options, collapse = "" ""))
-  prepare_precompiled(cpp_options, quiet)
+  if (cmdstan_version() < ""2.24"") {
+    prepare_precompiled(cpp_options, quiet)
+  }
   run_log <- processx::run(
     command = make_cmd(),
     args = c(tmp_exe,

---FILE: tests/testthat/test-model-compile.R---
@@ -141,18 +141,20 @@ test_that(""name in STANCFLAGS is set correctly"", {
 test_that(""switching threads on and off works without rebuild"", {
   skip_on_cran()
   main_path_o <- file.path(cmdstan_path(), ""src"", ""cmdstan"", ""main.o"")
+  main_path_threads_o <- file.path(cmdstan_path(), ""src"", ""cmdstan"", ""main_threads.o"")
+  if (file.exists(main_path_threads_o)) {
+    file.remove(main_path_threads_o)
+  }
   mod$compile(force_recompile = TRUE)
 
   before_mtime <- file.mtime(main_path_o)
   mod$compile(force_recompile = TRUE)
   after_mtime <- file.mtime(main_path_o)
   expect_equal(before_mtime, after_mtime)
+  expect_false(file.exists(main_path_threads_o))
 
-  before_mtime <- file.mtime(main_path_o)
   mod$compile(force_recompile = TRUE, cpp_options = list(stan_threads = TRUE))
-  after_mtime <- file.mtime(main_path_o)
-  time_diff <- as.double((after_mtime - before_mtime), units = ""secs"")
-  expect_gt(time_diff, 0)
+  checkmate::expect_file_exists(main_path_threads_o)
 
   before_mtime <- file.mtime(main_path_o)
   mod$compile(force_recompile = TRUE, cpp_options = list(stan_threads = TRUE))
@@ -162,27 +164,35 @@ test_that(""switching threads on and off works without rebuild"", {
   before_mtime <- file.mtime(main_path_o)
   mod$compile(force_recompile = TRUE)
   after_mtime <- file.mtime(main_path_o)
-  time_diff <- as.double((after_mtime - before_mtime), units = ""secs"")
-  expect_gt(time_diff, 0)
+  expect_equal(before_mtime, after_mtime)
 })
 
 test_that(""message is shown on building main.o"", {
   skip_on_cran()
-  main_o_files <- c(
-    file.path(cmdstan_path(), ""src"", ""cmdstan"", ""main.o""),
-    file.path(cmdstan_path(), ""src"", ""cmdstan"", ""main_noflags.o"")
-  )
-  for (f in main_o_files) {
-    if (file.exists(f))
-      file.remove(f)
+  if (cmdstan_version() > ""2.23"") {
+    expect_message(
+      mod$compile(force_recompile = TRUE),
+      ""Compiling Stan program..."",
+      fixed = TRUE
+    )
+    return(invisible(NULL))
+  } else {
+    main_o_files <- c(
+      file.path(cmdstan_path(), ""src"", ""cmdstan"", ""main.o""),
+      file.path(cmdstan_path(), ""src"", ""cmdstan"", ""main_noflags.o"")
+    )
+    for (f in main_o_files) {
+      if (file.exists(f))
+        file.remove(f)
+    }
+    expect_message(
+      mod$compile(force_recompile = TRUE),
+      ""Compiling the main object file and precompiled headers (may take up to a few minutes). "",
+      ""This is only necessary for the first compilation after installation or when "",
+      ""threading, MPI or OpenCL are used for the first time."",
+      fixed = TRUE
+    )
   }
-  expect_message(
-    mod$compile(force_recompile = TRUE),
-    ""Compiling the main object file and precompiled headers (may take up to a few minutes). "",
-    ""This is only necessary for the first compilation after installation or when "",
-    ""threading, MPI or OpenCL are used for the first time."",
-    fixed = TRUE
-  )
 })
 
 test_that(""compile errors are shown"", {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,184680707159c198d8848b56289cb5a4d34ba90e,Jonah Gabry,jgabry@gmail.com,2020-07-28T03:20:35Z,GitHub,noreply@github.com,2020-07-28T03:20:35Z,"Fix internal doc in args.R

[ci skip]",R/args.R,False,True,True,False,1,1,2,"---FILE: R/args.R---
@@ -2,7 +2,7 @@
 #'
 #' These objects store arguments for creating the call to CmdStan and provide a
 #' `compose()` method for creating a character vector of arguments that can be
-#' passed to the `args` argument of [processx::run()].
+#' passed to the `args` argument of [processx::process$new()].
 #'
 #' @noRd
 #' @details",True,False,Implementation / Logic,6
stan-dev,cmdstanr,857432a077678582930dd60c6b9349f66d873382,jgabry,jgabry@gmail.com,2020-07-24T01:27:39Z,jgabry,jgabry@gmail.com,2020-07-24T01:27:39Z,actually fix tests,R/read_csv.R,False,True,True,False,3,1,4,"---FILE: R/read_csv.R---
@@ -229,7 +229,9 @@ read_cmdstan_csv <- function(files,
       suppressWarnings(do.call(vroom::vroom, vroom_args))
     })
     if (!inherits(draws, ""try-error"")) {
-      draws <- draws[!is.na(draws$lp__), ]
+      if (metadata$method != ""generate_quantities"") {
+        draws <- draws[!is.na(draws$lp__), ]
+      }
     } else {
       if (vroom_warnings == 0) { # only warn the first time instead of for every csv file
         warning(",True,False,Implementation / Logic,6
stan-dev,cmdstanr,ce52b00ef4f306821e0e66d63f8a941c9d42f674,jgabry,jgabry@gmail.com,2020-07-24T01:20:14Z,jgabry,jgabry@gmail.com,2020-07-24T01:20:14Z,fix failing test,R/read_csv.R,False,True,True,False,3,3,6,"---FILE: R/read_csv.R---
@@ -228,7 +228,9 @@ read_cmdstan_csv <- function(files,
     draws <- try(silent = TRUE, expr = {
       suppressWarnings(do.call(vroom::vroom, vroom_args))
     })
-    if (inherits(draws, ""try-error"")) {
+    if (!inherits(draws, ""try-error"")) {
+      draws <- draws[!is.na(draws$lp__), ]
+    } else {
       if (vroom_warnings == 0) { # only warn the first time instead of for every csv file
         warning(
           ""Fast CSV reading with vroom::vroom() failed. Using utils::read.csv() instead. "",
@@ -241,8 +243,6 @@ read_cmdstan_csv <- function(files,
       draws <- utils::read.csv(output_file, comment.char = ""#"", skip = metadata$lines_to_skip)
       draws <- draws[, col_select]
     }
-    draws <- draws[!is.na(draws$lp__), ]
-
 
     if (nrow(draws) > 0) {
       if (metadata$method == ""sample"") {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,6e4fde6cb67089c7b115d012464dbab959a46a30,jgabry,jgabry@gmail.com,2020-07-24T01:04:13Z,jgabry,jgabry@gmail.com,2020-07-24T01:04:13Z,"use read.csv if vroom fails

Fixes #249",R/read_csv.R,False,True,True,False,36,31,67,"---FILE: R/read_csv.R---
@@ -121,6 +121,8 @@ read_cmdstan_csv <- function(files,
   col_types <- NULL
   col_select <- NULL
   not_matching <- c()
+  vroom_warnings <- 0
+
   for (output_file in files) {
     if (is.null(metadata)) {
       metadata <- read_csv_metadata(output_file)
@@ -204,41 +206,44 @@ read_cmdstan_csv <- function(files,
       all_draws <- 1
     }
 
+    vroom_args <- list(
+      file = output_file,
+      comment = ""#"",
+      delim = "","",
+      trim_ws = TRUE,
+      altrep = FALSE,
+      progress = FALSE,
+      skip = metadata$lines_to_skip,
+      col_select = col_select
+    )
     if (metadata$method == ""generate_quantities"") {
-      # set the first arg as double
-      # to silence the type detection info
-      col_types <- list()
-      col_types[[col_select[1]]] = ""d""
-      suppressWarnings(
-        draws <- vroom::vroom(
-          output_file,
-          comment = ""#"",
-          delim = ',',
-          col_select = col_select,
-          col_types = col_types,
-          trim_ws = TRUE,
-          altrep = FALSE,
-          progress = FALSE,
-          skip = metadata$lines_to_skip
-        )
-      )
+      # set the first arg as double to silence the type detection info
+      vroom_args$col_types <- list()
+      vroom_args$col_types[[col_select[1]]] <- ""d""
     } else {
-      suppressWarnings(
-        draws <- vroom::vroom(
-          output_file,
-          comment = ""#"",
-          delim = ',',
-          trim_ws = TRUE,
-          col_select = col_select,
-          col_types = c(""lp__"" = ""d""),
-          altrep = FALSE,
-          progress = FALSE,
-          skip = metadata$lines_to_skip,
-          n_max = all_draws * 2
+      vroom_args$col_types <- c(""lp__"" = ""d"")
+      vroom_args$n_max <- all_draws * 2
+    }
+
+    draws <- try(silent = TRUE, expr = {
+      suppressWarnings(do.call(vroom::vroom, vroom_args))
+    })
+    if (inherits(draws, ""try-error"")) {
+      if (vroom_warnings == 0) { # only warn the first time instead of for every csv file
+        warning(
+          ""Fast CSV reading with vroom::vroom() failed. Using utils::read.csv() instead. "",
+          ""\nTo help avoid this in the future, please report this issue at github.com/stan-dev/cmdstanr/issues "",
+          ""and include the output from sessionInfo(). Thank you!"",
+          call. = FALSE
         )
-      )
-      draws <- draws[!is.na(draws$lp__), ]
+      }
+      vroom_warnings <- vroom_warnings + 1
+      draws <- utils::read.csv(output_file, comment.char = ""#"", skip = metadata$lines_to_skip)
+      draws <- draws[, col_select]
     }
+    draws <- draws[!is.na(draws$lp__), ]
+
+
     if (nrow(draws) > 0) {
       if (metadata$method == ""sample"") {
         if (metadata$save_warmup == 1) {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,2cdccfc8c07fb5815636bfa29d680c86c5d740a8,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-07-22T14:55:02Z,Rok Cesnovar,rok.cesnovar@fri.uni-lj.si,2020-07-22T14:55:02Z,fix non rc path,R/path.R,False,True,True,False,1,1,2,"---FILE: R/path.R---
@@ -124,7 +124,7 @@ cmdstan_default_path <- function() {
       latest_cmdstan <- sort(cmdstan_installs, decreasing = TRUE)[1]
       if (is_release_candidate(latest_cmdstan)) {
         non_rc_path <- strsplit(latest_cmdstan, ""-rc"")[[1]][1]
-        if (dir.exists(file.path(installs_path,latest_cmdstan))) {
+        if (dir.exists(file.path(installs_path,non_rc_path))) {
           latest_cmdstan <- non_rc_path
         }
       }",True,False,Implementation / Logic,3
stan-dev,cmdstanr,2bdb10c2f21e4f7ad235c4e5d557633391fc70b6,jgabry,jgabry@gmail.com,2020-07-03T22:57:22Z,jgabry,jgabry@gmail.com,2020-07-03T22:57:22Z,fix test,tests/testthat/test-model-compile.R,False,True,True,False,1,1,2,"---FILE: tests/testthat/test-model-compile.R---
@@ -12,7 +12,7 @@ test_that(""object initialized correctly"", {
   expect_equal(mod$exe_file(), character(0))
   expect_error(
     mod$hpp_file(),
-    ""The .hpp file does not exists. Please (e)compile the model."",
+    ""The .hpp file does not exists. Please (re)compile the model."",
     fixed = TRUE
   )
 })",True,False,Rendering / Conversion,3
stan-dev,cmdstanr,5cb06e5268eb48cc17931131204ce106297aa784,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-07-03T19:11:43Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-07-03T19:11:43Z,fix error message and test,R/model.R;tests/testthat/test-model-compile.R,False,True,True,False,6,2,8,"---FILE: R/model.R---
@@ -219,7 +219,7 @@ CmdStanModel <- R6::R6Class(
     },
     hpp_file = function() {
       if (!length(private$hpp_file_)) {
-        stop(""The .hpp file no longer exists. Please recompile the model with 'force_recompile=TRUE'"", call. = FALSE)
+        stop(""The .hpp file does not exists. Please (e)compile the model."", call. = FALSE)
       }
       private$hpp_file_
     },

---FILE: tests/testthat/test-model-compile.R---
@@ -10,7 +10,11 @@ test_that(""object initialized correctly"", {
   skip_on_cran()
   expect_equal(mod$stan_file(), stan_program)
   expect_equal(mod$exe_file(), character(0))
-  expect_equal(mod$hpp_file(), character(0))
+  expect_error(
+    mod$hpp_file(),
+    ""The .hpp file does not exists. Please (e)compile the model."",
+    fixed = TRUE
+  )
 })
 
 test_that(""error if no compile() before model fitting"", {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,0b94de9028e63c1f2d8a58db6d57bc76adc9b9fc,jgabry,jgabry@gmail.com,2020-07-03T15:15:56Z,jgabry,jgabry@gmail.com,2020-07-03T15:15:56Z,fix test,tests/testthat/test-model-compile.R;vignettes/cmdstanr-internals.Rmd,True,True,True,False,3,3,6,"---FILE: tests/testthat/test-model-compile.R---
@@ -225,6 +225,6 @@ test_that(""dir arg works for cmdstan_model and $compile()"", {
 
   expect_error(
     cmdstan_model(stan_program, dir = ""ABCD""),
-    ""Assertion on 'dir' failed: Directory 'ABCD' does not exists.""
+    ""Assertion on 'dir' failed""
   )
 })

---FILE: vignettes/cmdstanr-internals.Rmd---
@@ -104,8 +104,8 @@ mod$exe_file()
 ### Executable location
 
 By default, the executable is created in the same directory as the file
-containing the Stan program. You can also specify a different location with the 
-`dir` argument of the `cmdstan_model` function.
+containing the Stan program. You can also specify a different location with the
+`dir` argument:
 
 ```{r compile-with-dir, eval = FALSE}
 mod <- cmdstan_model(stan_file, dir = ""path/to/directory/for/executable"")",True,True,Rendering / Conversion,6
stan-dev,cmdstanr,2b5dea08ec7804072d18c0bd81746b3960f3c013,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-07-03T06:10:48Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-07-03T10:12:17Z,fix vignette chunk name,vignettes/cmdstanr-internals.Rmd,True,False,True,False,1,1,2,"---FILE: vignettes/cmdstanr-internals.Rmd---
@@ -107,7 +107,7 @@ By default, the executable is created in the same directory as the file
 containing the Stan program. You can also specify a different location with the 
 `dir` argument of the `cmdstan_model` function.
 
-```{r compile-method, eval = FALSE}
+```{r compile-with-dir, eval = FALSE}
 mod <- cmdstan_model(stan_file, dir = ""path/to/directory/for/executable"")
 ```
 ",False,True,Rendering / Conversion,6
stan-dev,cmdstanr,fdd2a443745dac25c2b2f061fbd53054afecc66d,jgabry,jgabry@gmail.com,2020-07-03T00:05:44Z,jgabry,jgabry@gmail.com,2020-07-03T00:05:44Z,fix test,tests/testthat/resources/data/info_message.data.rds;tests/testthat/test-model-sample.R,False,True,True,False,4,1,5,"---FILE: tests/testthat/test-model-sample.R---
@@ -128,7 +128,10 @@ test_that(""sample() prints informational messages depening on show_messages"", {
   skip_on_cran()
   mod_info_msg <- testing_model(""info_message"")
   expect_sample_output(
-    expect_message(mod_info_msg$sample(), ""Informational Message: The current Metropolis proposal is about to be rejected"")
+    expect_message(
+      mod_info_msg$sample(),
+      ""Informational Message: The current Metropolis proposal is about to be rejected""
+    )
   )
   expect_sample_output(
     expect_message(mod_info_msg$sample(show_messages = FALSE), regexp = NA)",True,False,Implementation / Logic,6
stan-dev,cmdstanr,3af675399082b538214b8e3e2b8b5e03e54d4827,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-07-02T15:13:35Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-07-02T15:13:35Z,"fix messages
add call. = FALSE",R/fit.R;tests/testthat/test-failed-chains.R,False,True,True,False,17,29,46,"---FILE: R/fit.R---
@@ -29,7 +29,7 @@ CmdStanFit <- R6::R6Class(
 
     draws = function(variables = NULL) {
       if (!length(self$output_files(include_failed = FALSE))) {
-        stop(""Fitting failed. Unable to retrieve the draws."")
+        stop(""Fitting failed. Unable to retrieve the draws."", call. = FALSE)
       }
       # CmdStanMCMC has its own implementation, this is used for VB and MLE
       if (is.null(private$draws_)) {
@@ -46,13 +46,7 @@ CmdStanFit <- R6::R6Class(
 
     metadata = function() {
       if (!length(self$output_files(include_failed = FALSE))) {
-        if (self$runset$method() == ""sample"") {
-          stop(""No chains finished successfully. Unable to retrieve the metadata."")
-        } else if (self$runset$method() == ""generate_quantities"") {
-          stop(""Generating quantities for all MCMC chains failed. Unable to retrieve the metadata."", call. = FALSE)
-        } else {
-          stop(""Fitting failed. Unable to retrieve the metadata."")
-        }
+        stop(""Fitting failed. Unable to retrieve the metadata."", call. = FALSE)
       }
       if (is.null(private$metadata_)) {
         private$read_csv_()
@@ -98,13 +92,7 @@ CmdStanFit <- R6::R6Class(
     # print summary table without using tibbles
     print = function(variables = NULL, ..., digits = 2, max_rows = 10) {
       if (!length(self$output_files(include_failed = FALSE))) {
-        if (self$runset$method() == ""sample"") {
-          stop(""No chains finished successfully. Unable to print."")
-        } else if (self$runset$method() == ""generate_quantities"") {
-          stop(""Generating quantities for all MCMC chains failed. Unable to print."", call. = FALSE)
-        } else {
-          stop(""Fitting failed. Unable to print."")
-        }
+        stop(""Fitting failed. Unable to print."", call. = FALSE)
       }
       # filter variables before passing to summary to avoid computing anything
       # that won't be printed because of max_rows
@@ -116,7 +104,7 @@ CmdStanFit <- R6::R6Class(
         matches <- matching_variables(variables, all_variables)
         if (length(matches$not_found) > 0) {
           stop(""Can't find the following variable(s): "",
-               paste(matches$not_found, collapse = "", ""))
+               paste(matches$not_found, collapse = "", ""), call. = FALSE)
         }
         total_rows <- length(matches$matching)
         variables_to_print <- matches$matching[seq_len(max_rows)]
@@ -745,7 +733,7 @@ CmdStanMCMC <- R6::R6Class(
 
     draws = function(variables = NULL, inc_warmup = FALSE) {
       if (!length(self$output_files(include_failed = FALSE))) {
-        stop(""No chains finished successfully. Unable to retrieve the draws."")
+        stop(""No chains finished successfully. Unable to retrieve the draws."", call. = FALSE)
       }
       if (inc_warmup && !private$metadata_$save_warmup) {
         stop(""Warmup draws were requested from a fit object without them! "",
@@ -766,7 +754,7 @@ CmdStanMCMC <- R6::R6Class(
       matching_res <- matching_variables(variables, private$metadata_$model_params)
       if (length(matching_res$not_found)) {
         stop(""Can't find the following variable(s) in the output: "",
-             paste(matching_res$not_found, collapse = "", ""))
+             paste(matching_res$not_found, collapse = "", ""), call. = FALSE)
       }
       variables <- repair_variable_names(matching_res$matching)
       if (inc_warmup) {
@@ -778,7 +766,7 @@ CmdStanMCMC <- R6::R6Class(
 
     sampler_diagnostics = function(inc_warmup = FALSE) {
       if (!length(self$output_files(include_failed = FALSE))) {
-        stop(""No chains finished successfully. Unable to retrieve the sampler diagnostics."")
+        stop(""No chains finished successfully. Unable to retrieve the sampler diagnostics."", call. = FALSE)
       }
       to_read <- remaining_columns_to_read(
         requested = NULL,
@@ -791,7 +779,7 @@ CmdStanMCMC <- R6::R6Class(
       if (inc_warmup) {
         if (!private$metadata_$save_warmup) {
           stop(""Warmup sampler diagnostics were requested from a fit object without them! "",
-               ""Please rerun the model with save_warmup = TRUE."")
+               ""Please rerun the model with save_warmup = TRUE."", call. = FALSE)
         }
         posterior::bind_draws(
           private$warmup_sampler_diagnostics_,
@@ -806,7 +794,7 @@ CmdStanMCMC <- R6::R6Class(
     # returns list of inverse metrics
     inv_metric = function(matrix = TRUE) {
       if (!length(self$output_files(include_failed = FALSE))) {
-        stop(""No chains finished successfully. Unable to retrieve the inverse metrics."")
+        stop(""No chains finished successfully. Unable to retrieve the inverse metrics."", call. = FALSE)
       }
       if (is.null(private$inv_metric_)) {
         private$read_csv_(variables = """", sampler_diagnostics = """")
@@ -827,7 +815,7 @@ CmdStanMCMC <- R6::R6Class(
     inv_metric_ = NULL,
     read_csv_ = function(variables = NULL, sampler_diagnostics = NULL) {
       if (!length(self$output_files(include_failed = FALSE))) {
-        stop(""No chains finished successfully. Unable to retrieve the draws."")
+        stop(""No chains finished successfully. Unable to retrieve the draws."", call. = FALSE)
       }
       data_csv <- read_cmdstan_csv(
         files = self$output_files(include_failed = FALSE),
@@ -927,7 +915,7 @@ CmdStanMLE <- R6::R6Class(
     # inherits draws_ and metadata_ slots from CmdStanFit
     read_csv_ = function() {
       if (!length(self$output_files(include_failed = FALSE))) {
-        stop(""Optimization failed. Unable to retrieve the draws and metadata."")
+        stop(""Optimization failed. Unable to retrieve the draws."", call. = FALSE)
       }
       optim_output <- read_cmdstan_csv(self$output_files())
       private$draws_ <- optim_output$point_estimates
@@ -994,7 +982,7 @@ CmdStanVB <- R6::R6Class(
     # inherits draws_ and metadata_ slots from CmdStanFit
     read_csv_ = function() {
       if (!length(self$output_files(include_failed = FALSE))) {
-        stop(""Variational inference failed. Unable to retrieve the draws."")
+        stop(""Variational inference failed. Unable to retrieve the draws."", call. = FALSE)
       }
       vb_output <- read_cmdstan_csv(self$output_files())
       private$draws_ <- vb_output$draws
@@ -1084,7 +1072,7 @@ CmdStanGQ <- R6::R6Class(
     # inherits draws_ and metadata_ slots from CmdStanFit
     read_csv_ = function(variables = NULL) {
       if (!length(self$output_files(include_failed = FALSE))) {
-        stop(""Generating quantities for all input MCMC chains failed. Unable to retrieve the generated quantities."")
+        stop(""Generating quantities for all MCMC chains failed. Unable to retrieve the generated quantities."", call. = FALSE)
       }
       data_csv <- read_cmdstan_csv(
         files = self$output_files(include_failed = FALSE),

---FILE: tests/testthat/test-failed-chains.R---
@@ -126,9 +126,9 @@ test_that(""errors when using draws after all chains fail"", {
   expect_error(fit_all_fail$sampler_diagnostics(), ""No chains finished successfully"")
   expect_error(fit_all_fail$cmdstan_summary(), ""Unable to run bin/stansummary"")
   expect_error(fit_all_fail$cmdstan_diagnose(), ""Unable to run bin/diagnose"")
-  expect_error(fit_all_fail$print(), ""No chains finished successfully"")
+  expect_error(fit_all_fail$print(), ""Fitting failed. Unable to print."")
   expect_error(fit_all_fail$inv_metric(), ""No chains finished successfully"")
-  expect_error(fit_all_fail$metadata(), ""No chains finished successfully"")
+  expect_error(fit_all_fail$metadata(), ""Fitting failed. Unable to retrieve the metadata."")
   expect_error(fit_all_fail$inv_metric(), ""No chains finished successfully"")
 })
 
@@ -220,11 +220,11 @@ test_that(""gq chains error on wrong input CSV"", {
   )
   expect_error(
     fit$metadata(),
-    ""Generating quantities for all MCMC chains failed. Unable to retrieve the metadata.""
+    ""Fitting failed. Unable to retrieve the metadata.""
   )
   expect_error(
     fit$print(),
-    ""Generating quantities for all MCMC chains failed. Unable to print.""
+    ""Fitting failed. Unable to print.""
   )
   expect_warning(
     utils::capture.output(",True,False,Implementation / Logic,6
stan-dev,cmdstanr,51ab26a1d7337b3f96bf1e393c16d0df6d3670e1,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-07-02T10:19:17Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-07-02T10:19:17Z,add error messages,R/fit.R;R/read_csv.R;tests/testthat/test-csv.R,False,True,True,False,43,3,46,"---FILE: R/fit.R---
@@ -28,6 +28,9 @@ CmdStanFit <- R6::R6Class(
     },
 
     draws = function(variables = NULL) {
+      if (!length(self$output_files(include_failed = FALSE))) {
+        stop(""Fitting failed. Unable to retrieve the draws."")
+      }
       # CmdStanMCMC has its own implementation, this is used for VB and MLE
       if (is.null(private$draws_)) {
         private$read_csv_()
@@ -42,6 +45,15 @@ CmdStanFit <- R6::R6Class(
     },
 
     metadata = function() {
+      if (!length(self$output_files(include_failed = FALSE))) {
+        if (self$runset$method() == ""sample"") {
+          stop(""No chains finished successfully. Unable to retrieve the metadata."")
+        } else if (self$runset$method() == ""generate_quantities"") {
+          stop(""Generating quantities for all MCMC chains failed. Unable to retrieve the metadata."", call. = FALSE)
+        } else {
+          stop(""Fitting failed. Unable to retrieve the metadata."")
+        }
+      }
       if (is.null(private$metadata_)) {
         private$read_csv_()
       }
@@ -85,6 +97,15 @@ CmdStanFit <- R6::R6Class(
 
     # print summary table without using tibbles
     print = function(variables = NULL, ..., digits = 2, max_rows = 10) {
+      if (!length(self$output_files(include_failed = FALSE))) {
+        if (self$runset$method() == ""sample"") {
+          stop(""No chains finished successfully. Unable to print."")
+        } else if (self$runset$method() == ""generate_quantities"") {
+          stop(""Generating quantities for all MCMC chains failed. Unable to print."", call. = FALSE)
+        } else {
+          stop(""Fitting failed. Unable to print."")
+        }
+      }
       # filter variables before passing to summary to avoid computing anything
       # that won't be printed because of max_rows
       all_variables <- self$metadata()$model_params
@@ -784,6 +805,9 @@ CmdStanMCMC <- R6::R6Class(
 
     # returns list of inverse metrics
     inv_metric = function(matrix = TRUE) {
+      if (!length(self$output_files(include_failed = FALSE))) {
+        stop(""No chains finished successfully. Unable to retrieve the inverse metrics."")
+      }
       if (is.null(private$inv_metric_)) {
         private$read_csv_(variables = """", sampler_diagnostics = """")
       }
@@ -802,6 +826,9 @@ CmdStanMCMC <- R6::R6Class(
     warmup_draws_ = NULL,
     inv_metric_ = NULL,
     read_csv_ = function(variables = NULL, sampler_diagnostics = NULL) {
+      if (!length(self$output_files(include_failed = FALSE))) {
+        stop(""No chains finished successfully. Unable to retrieve the draws."")
+      }
       data_csv <- read_cmdstan_csv(
         files = self$output_files(include_failed = FALSE),
         variables = variables,
@@ -899,6 +926,9 @@ CmdStanMLE <- R6::R6Class(
   private = list(
     # inherits draws_ and metadata_ slots from CmdStanFit
     read_csv_ = function() {
+      if (!length(self$output_files(include_failed = FALSE))) {
+        stop(""Optimization failed. Unable to retrieve the draws and metadata."")
+      }
       optim_output <- read_cmdstan_csv(self$output_files())
       private$draws_ <- optim_output$point_estimates
       private$metadata_ <- optim_output$metadata
@@ -963,6 +993,9 @@ CmdStanVB <- R6::R6Class(
   private = list(
     # inherits draws_ and metadata_ slots from CmdStanFit
     read_csv_ = function() {
+      if (!length(self$output_files(include_failed = FALSE))) {
+        stop(""Variational inference failed. Unable to retrieve the draws."")
+      }
       vb_output <- read_cmdstan_csv(self$output_files())
       private$draws_ <- vb_output$draws
       private$metadata_ <- vb_output$metadata
@@ -1018,7 +1051,7 @@ CmdStanGQ <- R6::R6Class(
     },
     draws = function(variables = NULL) {
       if (!length(self$output_files(include_failed = FALSE))) {
-        stop(""No chains finished successfully. Unable to retrieve the generated quantities."", call. = FALSE)
+        stop(""Generating quantities for all MCMC chains failed. Unable to retrieve the generated quantities."", call. = FALSE)
       }
       to_read <- remaining_columns_to_read(
         requested = variables,
@@ -1050,6 +1083,9 @@ CmdStanGQ <- R6::R6Class(
   private = list(
     # inherits draws_ and metadata_ slots from CmdStanFit
     read_csv_ = function(variables = NULL) {
+      if (!length(self$output_files(include_failed = FALSE))) {
+        stop(""Generating quantities for all input MCMC chains failed. Unable to retrieve the generated quantities."")
+      }
       data_csv <- read_cmdstan_csv(
         files = self$output_files(include_failed = FALSE),
         variables = variables,

---FILE: R/read_csv.R---
@@ -107,6 +107,7 @@
 read_cmdstan_csv <- function(files,
                             variables = NULL,
                             sampler_diagnostics = NULL) {
+  checkmate::assert_file_exists(files, access = ""r"", extension = ""csv"")
   metadata <- NULL
   warmup_draws <- NULL
   warmup_sampler_diagnostics_draws <- NULL
@@ -121,7 +122,6 @@ read_cmdstan_csv <- function(files,
   col_select <- NULL
   not_matching <- c()
   for (output_file in files) {
-    checkmate::assert_file_exists(output_file, access = ""r"", extension = ""csv"")
     if (is.null(metadata)) {
       metadata <- read_csv_metadata(output_file)
       if (!is.null(metadata$inv_metric)) {

---FILE: tests/testthat/test-csv.R---
@@ -74,7 +74,11 @@ test_that(""read_cmdstan_csv() fails if the file does not exist"", {
   skip_on_cran()
   csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-doesntexist.csv""))
   expect_error(read_cmdstan_csv(csv_files),
-               ""Assertion on 'output_file' failed: File does not exist: 'resources/csv/model1-1-doesntexist.csv'."")
+               ""Assertion on 'files' failed: File does not exist: 'resources/csv/model1-1-doesntexist.csv'."")
+  expect_error(read_cmdstan_csv(NULL),
+               ""Assertion on 'files' failed: No file provided."")
+  expect_error(read_cmdstan_csv(character(0)),
+               ""Assertion on 'files' failed: No file provided."")
 })
 
 test_that(""read_cmdstan_csv() fails with empty csv file"", {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,0183cd4af27d2aadb2f599e9f5746b3870285893,jgabry,jgabry@gmail.com,2020-07-01T13:46:38Z,jgabry,jgabry@gmail.com,2020-07-01T13:46:38Z,Error if empty inits,R/args.R;tests/testthat/test-model-init.R,False,True,True,False,15,0,15,"---FILE: R/args.R---
@@ -669,6 +669,9 @@ process_init_list <- function(init, num_procs) {
   if (length(init) != num_procs) {
     stop(""'init' has the wrong length. See documentation of 'init' argument."", call. = FALSE)
   }
+  if (any(sapply(init, function(x) length(x) == 0))) {
+    stop(""'init' contains empty lists."", call. = FALSE)
+  }
 
   init_paths <-
     tempfile(

---FILE: tests/testthat/test-model-init.R---
@@ -147,6 +147,12 @@ test_that(""error if init list is specified incorrectly"", {
     mod_logistic$optimize(data = data_list_logistic, init = init_list),
     ""'init' has the wrong length""
   )
+
+  init_list <- list(list(), list())
+  expect_error(
+    mod_logistic$sample(data = data_list_logistic, chains = 2, init = init_list),
+    ""'init' contains empty lists.""
+  )
 })
 
 test_that(""init can be a function"", {
@@ -217,4 +223,10 @@ test_that(""error if init function specified incorrectly"", {
     mod_logistic$sample(data = data_list_logistic, chains = 2, init = init_fun),
     ""If 'init' is a function it must return a single list""
   )
+
+  init_fun <- function() list()
+  expect_error(
+    mod_logistic$sample(data = data_list_logistic, chains = 1, init = init_fun),
+    ""'init' contains empty lists.""
+  )
 })",True,False,Implementation / Logic,6
stan-dev,cmdstanr,3a7d2704e20570ac1f8fbe3577120e8f61b361b5,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-07-01T07:28:23Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-07-01T07:28:23Z,fix test again,tests/testthat/test-model-compile.R,False,True,True,False,2,1,3,"---FILE: tests/testthat/test-model-compile.R---
@@ -177,7 +177,8 @@ test_that(""message is shown on building main.o"", {
     mod$compile(force_recompile = TRUE),
     ""Compiling the main object file and precompiled headers (may take up to a few minutes). "",
     ""This is only necessary for the first compilation after installation or when "",
-    ""threading, MPI or OpenCL are used for the first time.""
+    ""threading, MPI or OpenCL are used for the first time."",
+    fixed = TRUE
   )
 })
 ",True,False,Rendering / Conversion,3
stan-dev,cmdstanr,d5504ae7f8d0c6781324e298e0906dc7de4d77f5,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-07-01T07:02:06Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-07-01T07:02:06Z,fix test,tests/testthat/test-model-compile.R,False,True,True,False,6,2,8,"---FILE: tests/testthat/test-model-compile.R---
@@ -173,8 +173,12 @@ test_that(""message is shown on building main.o"", {
     if (file.exists(f))
       file.remove(f)
   }
-  expect_message(mod$compile(force_recompile = TRUE),
-                 ""Re-compiling the main object file and precompiled headers. This might take up to a few minutes ..."")
+  expect_message(
+    mod$compile(force_recompile = TRUE),
+    ""Compiling the main object file and precompiled headers (may take up to a few minutes). "",
+    ""This is only necessary for the first compilation after installation or when "",
+    ""threading, MPI or OpenCL are used for the first time.""
+  )
 })
 
 test_that(""compile errors are shown"", {",True,False,Rendering / Conversion,3
stan-dev,cmdstanr,f517d4b3054ce4f4622c81dce6dcaa8168225295,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-07-01T06:21:55Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-07-01T06:21:55Z,fix message,R/utils.R,False,True,True,False,5,1,6,"---FILE: R/utils.R---
@@ -216,7 +216,11 @@ prepare_precompiled <- function(cpp_options = list(), quiet = FALSE) {
     model_header_gch_used <- FALSE
   }
   if (!file.exists(main_path_w_flags)) {
-    message(""Re-compiling the main object file and precompiled headers. This might take up to a few minutes ..."")
+    message(
+      ""Compiling the main object file and precompiled headers (may take up to a few minutes). "",
+      ""This is only necessary the first time a model is compiled after installation or when "",
+      ""threading, MPI or OpenCL are used for the first time.""
+    )
     clean_compile_helper_files()
     run_log <- processx::run(
       command = make_cmd(),",True,False,Environment / Configuration,3
stan-dev,cmdstanr,95d9ec0b9cb1411812867f2eb5b4ef77b4a87b13,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-30T19:00:53Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-30T19:00:53Z,fix seed for variational to prevent random breaks,tests/testthat/test-csv.R,False,True,True,False,2,2,4,"---FILE: tests/testthat/test-csv.R---
@@ -3,9 +3,9 @@ context(""read_cmdstan_csv"")
 if (not_on_cran()) {
   set_cmdstan_path()
   fit_bernoulli_optimize <- testing_fit(""bernoulli"", method = ""optimize"")
-  fit_bernoulli_variational <- testing_fit(""bernoulli"", method = ""variational"")
+  fit_bernoulli_variational <- testing_fit(""bernoulli"", method = ""variational"", seed = 123)
   fit_logistic_optimize <- testing_fit(""logistic"", method = ""optimize"")
-  fit_logistic_variational <- testing_fit(""logistic"", method = ""variational"")
+  fit_logistic_variational <- testing_fit(""logistic"", method = ""variational"", seed = 123)
   fit_logistic_variational_short <- testing_fit(""logistic"", method = ""variational"", output_samples = 100)
 
   fit_bernoulli_diag_e_no_samples <- testing_fit(""bernoulli"", method = ""sample"",",True,False,Implementation / Logic,3
stan-dev,cmdstanr,7a5f18a185e6c70d505769b68b2d360f567fb057,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-30T14:04:22Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-30T14:04:22Z,fix test,tests/testthat/test-fit-gq.R;tests/testthat/test-model-generate_quantities.R,False,True,True,False,5,7,12,"---FILE: tests/testthat/test-fit-gq.R---
@@ -4,8 +4,6 @@ if (not_on_cran()) {
   set_cmdstan_path()
   fit <- testing_fit(""bernoulli"", method = ""sample"", seed = 123)
   fit_gq <- testing_fit(""bernoulli_ppc"", method = ""generate_quantities"", seed = 123, fitted_params = fit)
-  mod <- testing_model(""bernoulli_ppc"")
-  data_list <- testing_data(""bernoulli_ppc"")
   PARAM_NAMES <- c(""y_rep[1]"", ""y_rep[2]"", ""y_rep[3]"", ""y_rep[4]"", ""y_rep[5]"",
                    ""y_rep[6]"", ""y_rep[7]"", ""y_rep[8]"", ""y_rep[9]"", ""y_rep[10]"", ""sum_y"")
 }

---FILE: tests/testthat/test-model-generate_quantities.R---
@@ -52,19 +52,19 @@ test_that(""generate_quantities work for different chains and parallel_chains"", {
   fit_1_chain <- testing_fit(""bernoulli"", method = ""sample"", seed = 123, chains = 1)
   fit_gq <- testing_fit(""bernoulli_ppc"", method = ""generate_quantities"", seed = 123, fitted_params = fit)
   expect_gq_output(
-    mod$generate_quantities(data = data_list, fitted_params = fit_1_chain)
+    mod_gq$generate_quantities(data = data_list, fitted_params = fit_1_chain)
   )
   expect_gq_output(
-    mod$generate_quantities(data = data_list, fitted_params = fit, parallel_chains = 2)
+    mod_gq$generate_quantities(data = data_list, fitted_params = fit, parallel_chains = 2)
   )
   expect_gq_output(
-    mod$generate_quantities(data = data_list, fitted_params = fit, parallel_chains = 4)
+    mod_gq$generate_quantities(data = data_list, fitted_params = fit, parallel_chains = 4)
   )
   expect_gq_output(
-    mod$generate_quantities(data = data_list, fitted_params = fit_1_chain, threads_per_chain = 2)
+    mod_gq$generate_quantities(data = data_list, fitted_params = fit_1_chain, threads_per_chain = 2)
   )
   expect_output(
-    mod$generate_quantities(data = data_list, fitted_params = fit_1_chain, threads_per_chain = 2),
+    mod_gq$generate_quantities(data = data_list, fitted_params = fit_1_chain, threads_per_chain = 2),
     ""2 thread(s) per chain"",
     fixed = TRUE
   )",True,False,Implementation / Logic,3
stan-dev,cmdstanr,e98cf6e1b5fcaa37404653cfdca4ae800baa1178,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-30T13:40:20Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-30T13:40:20Z,fix tests,tests/testthat/test-data.R,False,True,True,False,4,4,8,"---FILE: tests/testthat/test-data.R---
@@ -20,19 +20,19 @@ test_that(""process_fitted_params() works with basic input types"", {
 test_that(""process_fitted_params() errors with bad args"", {
   expect_error(
     process_fitted_params(5),
-    ""'fitted_params' should be a vector of paths or a sampling fit object \\(CmdStanMCMC\\).""
+    ""'fitted_params' should be a vector of paths or a CmdStanMCMC object.""
   )
   expect_error(
     process_fitted_params(NULL),
-    ""'fitted_params' should be a vector of paths or a sampling fit object \\(CmdStanMCMC\\).""
+    ""'fitted_params' should be a vector of paths or a CmdStanMCMC object.""
   )
   expect_error(
     process_fitted_params(fit_vb),
-    ""'fitted_params' should be a vector of paths or a sampling fit object \\(CmdStanMCMC\\).""
+    ""'fitted_params' should be a vector of paths or a CmdStanMCMC object.""
   )
   expect_error(
     process_fitted_params(fit_optimize),
-    ""'fitted_params' should be a vector of paths or a sampling fit object \\(CmdStanMCMC\\).""
+    ""'fitted_params' should be a vector of paths or a CmdStanMCMC object.""
   )
 
   fit_tmp <- testing_fit(""bernoulli"", method = ""sample"", seed = 123)",True,False,Implementation / Logic,6
stan-dev,cmdstanr,44fc0318401feff46ffe3783763f43e1cf547e99,jgabry,jgabry@gmail.com,2020-06-29T21:16:05Z,jgabry,jgabry@gmail.com,2020-06-29T21:16:05Z,fix metadata$fitted_params,R/read_csv.R,False,True,True,False,1,0,1,"---FILE: R/read_csv.R---
@@ -142,6 +142,7 @@ read_cmdstan_csv <- function(files,
       metadata$id <- c(metadata$id, csv_file_info$id)
       metadata$seed <- c(metadata$seed, csv_file_info$seed)
       metadata$step_size_adaptation <- c(metadata$step_size_adaptation, csv_file_info$step_size_adaptation)
+      metadata$fitted_params <- c(metadata$fitted_params, csv_file_info$fitted_params)
 
       if (!is.null(csv_file_info$inv_metric)) {
         inv_metric[[csv_file_info$id]] <- csv_file_info$inv_metric",True,False,Implementation / Logic,6
stan-dev,cmdstanr,8e4b72bad74d414bda7889857dccf9c84f4bfaab,jgabry,jgabry@gmail.com,2020-06-29T21:13:39Z,jgabry,jgabry@gmail.com,2020-06-29T21:13:39Z,fix metadata$fixed_params,tests/testthat/test-csv.R,False,True,True,False,4,1,5,"---FILE: tests/testthat/test-csv.R---
@@ -1,4 +1,4 @@
-context(""read-sample-csv"")
+context(""read_cmdstan_csv"")
 
 if (not_on_cran()) {
   set_cmdstan_path()
@@ -448,6 +448,9 @@ test_that(""read_cmdstan_csv() works for generate_quantities"", {
   expect_equal(posterior::variables(csv_output_4$generated_quantities), y_rep_params)
   csv_output_5 <- read_cmdstan_csv(fit_gq$output_files(), variables = c(""sum_y"", ""y_rep""))
   expect_equal(posterior::variables(csv_output_5$generated_quantities), c(""sum_y"", y_rep_params))
+
+  # metadata$fitted_params has correct number of files
+  expect_length(csv_output_5$metadata$fitted_params, fit_gq$num_chains())
 })
 
 test_that(""read_cmdstan_csv() errors for files from different methods"", {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,3abf41d75bb6f1141d47079861c491c8c54396dc,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-27T15:05:24Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-27T15:05:24Z,"vb test sometimes failed, give it a fixed seed",tests/testthat/test-fit-vb.R,False,True,True,False,9,2,11,"---FILE: tests/testthat/test-fit-vb.R---
@@ -94,7 +94,14 @@ test_that(""output() works for vb"", {
 
 test_that(""time is reported after vb"", {
   skip_on_cran()
-  expect_output(mod$variational(data = data_list),
-                ""Finished in"")
+  expect_output(
+    mod$variational(data = data_list,
+                    seed = 123,
+                    elbo_samples = 1000,
+                    iter = 2000,
+                    output_samples = 50
+                    ),
+    ""Finished in""
+  )
 })
 ",True,False,Implementation / Logic,3
stan-dev,cmdstanr,ddb4a840b615c4dcc2afc9e737c04cec91e1b615,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-27T12:44:45Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-27T12:44:45Z,remove unreachable error check,R/read_csv.R,False,True,True,False,0,3,3,"---FILE: R/read_csv.R---
@@ -229,9 +229,6 @@ read_cmdstan_csv <- function(files,
         )
       )
       draws <- draws[!is.na(draws$lp__), ]
-    }    
-    if (ncol(draws) == 0) {
-      stop(""The supplied csv file does not contain any data!"", call. = FALSE)
     }
     if (nrow(draws) > 0) {
       if (metadata$method == ""sample"") {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,319fa846819ad176ce8e3ca33b71a746d88f8267,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-27T12:24:52Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-27T12:24:52Z,add test for variational csv error with csvs of different length,tests/testthat/test-csv.R,False,True,True,False,8,0,8,"---FILE: tests/testthat/test-csv.R---
@@ -6,6 +6,7 @@ if (not_on_cran()) {
   fit_bernoulli_variational <- testing_fit(""bernoulli"", method = ""variational"")
   fit_logistic_optimize <- testing_fit(""logistic"", method = ""optimize"")
   fit_logistic_variational <- testing_fit(""logistic"", method = ""variational"")
+  fit_logistic_variational_short <- testing_fit(""logistic"", method = ""variational"", output_samples = 100)
 
   fit_bernoulli_diag_e_no_samples <- testing_fit(""bernoulli"", method = ""sample"",
                           seed = 123, chains = 2, iter_sampling = 0, metric = ""diag_e"")
@@ -418,6 +419,13 @@ test_that(""read_cmdstan_csv() works for variational"", {
   expect_equal(posterior::variables(csv_output_4$draws), c(""beta[1]"", ""beta[2]"", ""beta[3]""))
   csv_output_5 <- read_cmdstan_csv(fit_logistic_variational$output_files(), variables = c(""alpha"", ""beta[2]""))
   expect_equal(posterior::variables(csv_output_5$draws), c(""alpha"", ""beta[2]""))
+
+  diff_samples_variational <- c(fit_logistic_variational$output_files(),
+                                fit_logistic_variational_short$output_files())
+  expect_error(
+    read_cmdstan_csv(diff_samples_variational),
+    ""Supplied CSV files dont match in the number of output samples!""
+  )
 })
 
 test_that(""read_cmdstan_csv() works for generate_quantities"", {",True,False,Implementation / Logic,3
stan-dev,cmdstanr,7adc96a046c3992c7196861ed5916063ea129944,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-27T12:14:05Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-27T12:14:05Z,"improve error message for different methods
added tests
vroom only reads selected gqs",R/read_csv.R;tests/testthat/resources/csv/bernoulli_ppc-1-gq.csv;tests/testthat/test-csv.R;tests/testthat/test-fit-gq.R,False,True,True,False,83,3,86,"---FILE: R/read_csv.R---
@@ -206,6 +206,7 @@ read_cmdstan_csv <- function(files,
           output_file,
           comment = ""#"",
           delim = ',',
+          col_select = col_select,
           col_types = col_types,
           trim_ws = TRUE,
           altrep = FALSE,
@@ -524,14 +525,14 @@ check_csv_metadata_matches <- function(a, b) {
   if (a$model_name != b$model_name) {
     return(list(error = ""Supplied CSV files were not generated with the same model!""))
   }
+  if (a$method != b$method) {
+    return(list(error = ""Supplied CSV files were produced by different methods and need to be read in separately!""))
+  }
   if ((length(a$model_params) != length(b$model_params)) ||
       !(all(a$model_params == b$model_params) &&
         all(a$sampler_diagnostics == b$sampler_diagnostics))) {
     return(list(error = ""Supplied CSV files have samples for different variables!""))
   }
-  if (a$method != b$method) {
-    return(list(error = ""Supplied CSV files were produced by different methods and need to be read in separately!""))
-  }
   if (a$method == ""sample"") {  
     if (a$iter_sampling != b$iter_sampling ||
         a$thin != b$thin ||

---FILE: tests/testthat/resources/csv/bernoulli_ppc-1-gq.csv---
@@ -0,0 +1,23 @@
+# stan_version_major = 2
+# stan_version_minor = 23
+# stan_version_patch = 0
+# model = bernoulli_ppc_model
+# method = generate_quantities
+#   generate_quantities
+#     fitted_params = /tmp/RtmpCvOIQ1/fittedParams-202006271227-1-b85b52.csv
+# id = 1
+# data
+#   file = /home/rok/.cmdstanr/cmdstan-2.23.0/examples/bernoulli/bernoulli.data.json
+# init = 2 (Default)
+# random
+#   seed = 123
+# output
+#   file = /tmp/RtmpCvOIQ1/bernoulli_ppc-202006271227-1-986540.csv
+#   diagnostic_file =  (Default)
+#   refresh = 250
+y_rep.1,y_rep.2,y_rep.3,y_rep.4,y_rep.5,y_rep.6,y_rep.7,y_rep.8,y_rep.9,y_rep.10
+0,0,0,0,0,0,0,0,0,0
+0,1,1,0,1,0,1,1,0,0
+0,0,0,0,0,0,0,0,0,0
+0,0,0,0,0,1,0,0,0,1
+1,0,0,0,0,0,0,0,0,0
\ No newline at end of file

---FILE: tests/testthat/test-csv.R---
@@ -29,6 +29,8 @@ if (not_on_cran()) {
                           seed = 123, chains = 2, iter_sampling = 1000, iter_warmup = 1000, thin = 10, save_warmup = 0)
   fit_logistic_thin_10_with_warmup <- testing_fit(""logistic"", method = ""sample"",
                           seed = 123, chains = 2, iter_sampling = 1000, iter_warmup = 1000, thin = 10, save_warmup = 1)
+
+  fit_gq <- testing_fit(""bernoulli_ppc"", method = ""generate_quantities"", seed = 123, fitted_params = fit_bernoulli_thin_1)
 }
 
 test_that(""read_cmdstan_csv() fails for different model names"", {
@@ -417,3 +419,49 @@ test_that(""read_cmdstan_csv() works for variational"", {
   csv_output_5 <- read_cmdstan_csv(fit_logistic_variational$output_files(), variables = c(""alpha"", ""beta[2]""))
   expect_equal(posterior::variables(csv_output_5$draws), c(""alpha"", ""beta[2]""))
 })
+
+test_that(""read_cmdstan_csv() works for generate_quantities"", {
+  skip_on_cran()
+
+  csv_output_1 <- read_cmdstan_csv(fit_gq$output_files())
+  expect_equal(dim(csv_output_1$generated_quantities), c(1000, 2, 11))
+  y_rep_params <- c(""y_rep[1]"", ""y_rep[2]"", ""y_rep[3]"", ""y_rep[4]"", ""y_rep[5]"",
+                    ""y_rep[6]"", ""y_rep[7]"", ""y_rep[8]"", ""y_rep[9]"", ""y_rep[10]"")
+  csv_file <- test_path(""resources"", ""csv"", ""bernoulli_ppc-1-gq.csv"")
+  csv_output_3 <- read_cmdstan_csv(csv_file)
+  expect_equal(as.numeric(csv_output_3$generated_quantities[1,1,""y_rep[1]""]), 0)
+  expect_equal(as.numeric(csv_output_3$generated_quantities[2,1,""y_rep[2]""]), 1)
+  expect_equal(as.numeric(csv_output_3$generated_quantities[4,1,]), c(0,0,0,0,0,1,0,0,0,1))
+  expect_equal(dim(csv_output_3$generated_quantities), c(5, 1, 10))
+  expect_equal(csv_output_3$metadata$model_params, y_rep_params)
+
+  # variable filtering
+  csv_output_4 <- read_cmdstan_csv(fit_gq$output_files(), variables = ""y_rep"")
+  expect_equal(posterior::variables(csv_output_4$generated_quantities), y_rep_params)
+  csv_output_5 <- read_cmdstan_csv(fit_gq$output_files(), variables = c(""sum_y"", ""y_rep""))
+  expect_equal(posterior::variables(csv_output_5$generated_quantities), c(""sum_y"", y_rep_params))
+})
+
+test_that(""read_cmdstan_csv() errors for files from different methods"", {
+  skip_on_cran()
+  files <- c(fit_bernoulli_variational$output_files(),fit_bernoulli_optimize$output_files())
+  expect_error(
+    read_cmdstan_csv(files),
+    ""Supplied CSV files were produced by different methods and need to be read in separately!""
+  )
+  files <- c(fit_bernoulli_thin_1$output_files(),fit_bernoulli_optimize$output_files())
+  expect_error(
+    read_cmdstan_csv(files),
+    ""Supplied CSV files were produced by different methods and need to be read in separately!""
+  )
+  files <- c(fit_bernoulli_variational$output_files(),fit_bernoulli_thin_1$output_files())
+  expect_error(
+    read_cmdstan_csv(files),
+    ""Supplied CSV files were produced by different methods and need to be read in separately!""
+  )
+  files <- c(fit_bernoulli_variational$output_files(),fit_bernoulli_optimize$output_files())
+  expect_error(
+    read_cmdstan_csv(files),
+    ""Supplied CSV files were produced by different methods and need to be read in separately!""
+  )
+})

---FILE: tests/testthat/test-fit-gq.R---
@@ -128,3 +128,11 @@ test_that(""time() method works after mcmc"", {
     ncols = 2
   )
 })
+
+test_that(""fitted_params_files() method works"", {
+  skip_on_cran()
+  expect_equal(
+    fit_gq$fitted_params_files(),
+    fit$output_files()
+  )
+})",True,False,Implementation / Logic,6
stan-dev,cmdstanr,ac4a442e67c3fbdd4afce5c36b47f3cb9b26e6dc,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-27T09:33:54Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-27T09:33:54Z,"fitted params is mandatory
better errors if draws() or sampler_diagnostics() missing
nicer filenames for temp fitted params files
fitted_params_files function for CmdstanGQ",R/data.R;R/fit.R;R/model.R,False,True,True,False,22,15,37,"---FILE: R/data.R---
@@ -112,17 +112,24 @@ process_data <- function(data) {
 #'   CmdStan or a fit object.
 #' @return Path to data file.
 process_fitted_params <- function(fitted_params) {
-  if (is.null(fitted_params)) {
-    path <- fitted_params
-  } else if (is.character(fitted_params)) {
-    path <- absolute_path(fitted_params)
+  if (is.character(fitted_params)) {
+    paths <- absolute_path(fitted_params)
   } else if (checkmate::test_r6(fitted_params, classes = (""CmdStanMCMC""))) {
     if (all(file.exists(fitted_params$output_files()))) {
-      path <- absolute_path(fitted_params$output_files())
+      paths <- absolute_path(fitted_params$output_files())
     } else {
-      # write to a temporary CSV file
-      draws <- posterior::as_draws_array(fitted_params$draws())
-      sampler_diagnostics <- posterior::as_draws_array(fitted_params$sampler_diagnostics())
+      draws <- tryCatch( posterior::as_draws_array(fitted_params$draws()),
+        error=function(cond) {
+            stop(""Unable to obtain draws from the fit (CmdStanMCMC) object."", call. = FALSE)   
+            return(NA)
+        }
+      )
+      sampler_diagnostics <- tryCatch(posterior::as_draws_array(fitted_params$sampler_diagnostics()),
+        error=function(cond) {
+            stop(""Unable to obtain sampler diagnostics from the fit (CmdStanMCMC) object."", call. = FALSE)   
+            return(NA)
+        }
+      ) 
       if (!is.null(draws)) {
         variables <- dimnames(draws)$variable
         non_lp_variables <- variables[variables != ""lp__""]
@@ -136,7 +143,7 @@ process_fitted_params <- function(fitted_params) {
         chains <- dimnames(draws)$chain
         iterations <- length(dimnames(draws)$iteration)
         paths <- generate_file_names(
-            basename = ""fittedParams-"",
+            basename = ""fittedParams"",
             ids = chains
         )
         paths <- file.path(tempdir(), paths)
@@ -159,15 +166,12 @@ process_fitted_params <- function(fitted_params) {
           )
           chain <- chain + 1
         }
-        return(paths)
-      } else {
-        stop(""No draws found in the fit (CmdStanMCMC) object."", call. = FALSE)    
       }
     }
   } else {
-    stop(""'data' should be a path, a vector of paths or a sampling fit object (CmdStanMCMC)."", call. = FALSE)
+    stop(""'fitted_params' should be a vector of paths or a sampling fit object (CmdStanMCMC)."", call. = FALSE)
   }
-  path
+  paths
 }
 
 # check if any objects in the data list have zero

---FILE: R/fit.R---
@@ -922,6 +922,9 @@ CmdStanGQ <- R6::R6Class(
   classname = ""CmdStanGQ"",
   inherit = CmdStanFit,
   public = list(
+    fitted_params_files = function() {
+      self$runset$args$method_args$fitted_params
+    },
     num_chains = function() {
       super$num_procs()
     },

---FILE: R/model.R---
@@ -889,7 +889,7 @@ CmdStanModel$set(""public"", name = ""variational"", value = variational_method)
 #'
 NULL
 
-generate_quantities_method <- function(fitted_params = NULL,
+generate_quantities_method <- function(fitted_params,
                             data = NULL,
                             seed = NULL,
                             refresh = NULL,",True,False,Implementation / Logic,6
stan-dev,cmdstanr,bc9e3047548a6d39707e53176ea348167ac99074,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-27T08:10:49Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-27T08:10:49Z,"added another variable to gq test model
added gq tests
fixed time() and num_chains for gq",R/fit.R;R/run.R;tests/testthat/resources/stan/bernoulli_ppc.stan;tests/testthat/test-fit-gq.R,False,True,True,False,126,180,306,"---FILE: R/fit.R---
@@ -917,6 +917,9 @@ CmdStanGQ <- R6::R6Class(
   classname = ""CmdStanGQ"",
   inherit = CmdStanFit,
   public = list(
+    num_chains = function() {
+      super$num_procs()
+    },
     draws = function(variables = NULL) {
       if (!length(self$output_files(include_failed = FALSE))) {
         stop(""No chains finished successfully. Unable to retrieve the generated quantities."", call. = FALSE)
@@ -939,6 +942,13 @@ CmdStanGQ <- R6::R6Class(
       }
       variables <- repair_variable_names(matching_res$matching)
       private$draws_[,,variables]
+    },
+    output = function(id = NULL) {
+      if (is.null(id)) {
+        self$runset$procs$proc_output()
+      } else {
+        cat(paste(self$runset$procs$proc_output(id), collapse=""\n""))
+      }
     }
   ),
   private = list(

---FILE: R/run.R---
@@ -178,8 +178,15 @@ CmdStanRun <- R6::R6Class(
     },
 
     time = function() {
-      if (self$method() != ""sample"") {
+      if (self$method() %in% c(""optimize"", ""variational"")) {
         time <- list(total = self$procs$total_time())
+      } else if (self$method() == ""generate_quantities"") {
+        chain_time <- data.frame(
+          chain_id = self$procs$proc_ids()[self$procs$is_finished()],
+          total = self$procs$proc_total_time()[self$procs$is_finished()]
+        )
+
+        time <- list(total = self$procs$total_time(), chains = chain_time)
       } else {
         chain_time <- data.frame(
           chain_id = self$procs$proc_ids()[self$procs$is_finished()],
@@ -194,8 +201,8 @@ CmdStanRun <- R6::R6Class(
         }
         time <- list(total = self$procs$total_time(), chains = chain_time)
       }
-      time
-    }
+      time 
+    }   
   ),
   private = list(
     output_files_ = character(),

---FILE: tests/testthat/resources/stan/bernoulli_ppc.stan---
@@ -11,6 +11,8 @@ model {
 }
 generated quantities {
   int y_rep[N];
+  int sum_y;
   for (n in 1:N)
     y_rep[n] = bernoulli_rng(theta);
+  sum_y = sum(y_rep);
 }

---FILE: tests/testthat/test-fit-gq.R---
@@ -7,7 +7,7 @@ if (not_on_cran()) {
   mod <- testing_model(""bernoulli_ppc"")
   data_list <- testing_data(""bernoulli_ppc"")
   PARAM_NAMES <- c(""y_rep[1]"", ""y_rep[2]"", ""y_rep[3]"", ""y_rep[4]"", ""y_rep[5]"",
-                   ""y_rep[6]"", ""y_rep[7]"", ""y_rep[8]"", ""y_rep[9]"", ""y_rep[10]"")
+                   ""y_rep[6]"", ""y_rep[7]"", ""y_rep[8]"", ""y_rep[9]"", ""y_rep[10]"", ""sum_y"")
 }
 
 test_that(""draws() stops for unkown variables"", {
@@ -25,179 +25,106 @@ test_that(""draws() stops for unkown variables"", {
   )
 })
 
-# test_that(""draws() method returns draws_array (reading csv works)"", {
-#   skip_on_cran()
-#   draws <- fit_mcmc$draws()
-#   draws_betas <- fit_mcmc$draws(variables = ""beta"")
-#   draws_beta <- fit_mcmc$draws(variables = ""beta[1]"")
-#   draws_alpha_beta <- fit_mcmc$draws(variables = c(""alpha"", ""beta""))
-#   draws_beta_alpha <- fit_mcmc$draws(variables = c(""beta"", ""alpha""))
-#   draws_all_after <- fit_mcmc$draws()
-#   expect_type(draws, ""double"")
-#   expect_s3_class(draws, ""draws_array"")
-#   expect_equal(posterior::variables(draws), c(""lp__"", PARAM_NAMES))
-#   expect_equal(posterior::nchains(draws), fit_mcmc$num_chains())
-#   expect_s3_class(draws_betas, ""draws_array"")
-#   expect_equal(posterior::nvariables(draws_betas), 3)
-#   expect_equal(posterior::nchains(draws_betas), fit_mcmc$num_chains())
-#   expect_s3_class(draws_beta, ""draws_array"")
-#   expect_equal(posterior::nvariables(draws_beta), 1)
-#   expect_equal(posterior::nchains(draws_beta), fit_mcmc$num_chains())
-#   expect_s3_class(draws_alpha_beta, ""draws_array"")
-#   expect_equal(posterior::nvariables(draws_alpha_beta), 4)
-#   expect_equal(posterior::nchains(draws_alpha_beta), fit_mcmc$num_chains())
-#   expect_s3_class(draws_all_after, ""draws_array"")
-#   expect_equal(posterior::nvariables(draws_all_after), 5)
-#   expect_equal(posterior::nchains(draws_all_after), fit_mcmc$num_chains())
-#
-#   # check the order of the draws
-#   expect_equal(posterior::variables(draws_alpha_beta), c(""alpha"", ""beta[1]"", ""beta[2]"", ""beta[3]""))
-#   expect_equal(posterior::variables(draws_beta_alpha), c(""beta[1]"", ""beta[2]"", ""beta[3]"", ""alpha""))
-# })
-#
-# test_that(""inv_metric method works after mcmc"", {
-#   skip_on_cran()
-#   x <- fit_mcmc_1$inv_metric()
-#   expect_length(x, fit_mcmc_1$num_chains())
-#   checkmate::expect_matrix(x[[1]])
-#   checkmate::expect_matrix(x[[2]])
-#   expect_equal(x[[1]], diag(diag(x[[1]])))
-#
-#   x <- fit_mcmc_1$inv_metric(matrix=FALSE)
-#   expect_length(x, fit_mcmc_1$num_chains())
-#   expect_null(dim(x[[1]]))
-#   checkmate::expect_numeric(x[[1]])
-#   checkmate::expect_numeric(x[[2]])
-#
-#   x <- fit_mcmc_2$inv_metric()
-#   expect_length(x, fit_mcmc_2$num_chains())
-#   checkmate::expect_matrix(x[[1]])
-#   expect_false(x[[1]][1,2] == 0) # dense
-# })
-#
-# test_that(""summary() method works after mcmc"", {
-#   skip_on_cran()
-#   x <- fit_mcmc$summary()
-#   expect_s3_class(x, ""draws_summary"")
-#   expect_equal(x$variable, c(""lp__"", PARAM_NAMES))
-#
-#   x <- fit_mcmc$summary(NULL, c(""rhat"", ""sd""))
-#   expect_equal(colnames(x), c(""variable"", ""rhat"", ""sd""))
-#
-#   x <- fit_mcmc$summary(""lp__"", c(""median"", ""mad""))
-#   expect_equal(x$variable, ""lp__"")
-#   expect_equal(colnames(x), c(""variable"", ""median"", ""mad""))
-# })
-#
-# test_that(""print() method works after mcmc"", {
-#   skip_on_cran()
-#   expect_output(expect_s3_class(fit_mcmc$print(), ""CmdStanMCMC""), ""variable"")
-#   expect_output(fit_mcmc$print(max_rows = 1), ""# showing 1 of 5 rows"")
-#   expect_output(fit_mcmc$print(NULL, c(""ess_sd"")), ""ess_sd"")
-#
-#   # test on model with more parameters
-#   fit <- cmdstanr_example(""schools_ncp"")
-#   expect_output(fit$print(), ""showing 10 of 19 rows"")
-#   expect_output(fit$print(max_rows = 2), ""showing 2 of 19 rows"")
-#   expect_output(fit$print(max_rows = 19), ""theta[8]"", fixed=TRUE) # last parameter
-#   expect_output(fit$print(""theta"", max_rows = 2), ""showing 2 of 8 rows"")
-#   expect_error(
-#     fit$print(variable = ""unknown"", max_rows = 20),
-#     ""Can't find the following variable(s): unknown"",
-#     fixed = TRUE
-#   ) # unknown parameter
-#
-#   out <- capture.output(fit$print(""theta""))
-#   expect_length(out, 9) # columns names + 8 thetas
-#   expect_match(out[1], ""variable"")
-#   expect_match(out[2], ""theta[1]"", fixed = TRUE)
-#   expect_match(out[9], ""theta[8]"", fixed = TRUE)
-#   expect_false(any(grepl(""mu|tau|theta_raw"", out)))
-#
-#   # make sure the row order is correct
-#   out <- capture.output(fit$print(c(""theta[1]"", ""tau"", ""mu"", ""theta_raw[3]"")))
-#   expect_length(out, 5)
-#   expect_match(out[1], "" variable"", out[1])
-#   expect_match(out[2], "" theta[1]"", fixed = TRUE)
-#   expect_match(out[3], "" tau"")
-#   expect_match(out[4], "" mu"")
-#   expect_match(out[5], "" theta_raw[3]"", fixed = TRUE)
-# })
-#
-# test_that(""output() method works after mcmc"", {
-#   skip_on_cran()
-#   checkmate::expect_list(
-#     fit_mcmc$output(),
-#     types = ""character"",
-#     any.missing = FALSE,
-#     len = fit_mcmc$runset$num_procs()
-#   )
-#   expect_output(fit_mcmc$output(id = 1), ""Gradient evaluation took"")
-# })
-#
-# test_that(""time() method works after mcmc"", {
-#   skip_on_cran()
-#   run_times <- fit_mcmc$time()
-#   checkmate::expect_list(run_times, names = ""strict"", any.missing = FALSE)
-#   testthat::expect_named(run_times, c(""total"", ""chains""))
-#   checkmate::expect_number(run_times$total, finite = TRUE)
-#   checkmate::expect_data_frame(
-#     run_times$chains,
-#     any.missing = FALSE,
-#     types = c(""integer"", ""numeric""),
-#     nrows = fit_mcmc$runset$num_procs(),
-#     ncols = 4
-#   )
-#
-#   # after refresh=0 warmup and sampling times should be NA
-#   testthat::expect_warning(
-#     run_times_0 <- fit_mcmc_0$time(),
-#     ""Separate warmup and sampling times are not available""
-#   )
-#   checkmate::expect_number(run_times_0$total, finite = TRUE)
-#   checkmate::expect_data_frame(run_times_0$chains,
-#                                any.missing = TRUE,
-#                                types = c(""integer"", ""numeric""),
-#                                nrows = fit_mcmc_0$runset$num_procs(),
-#                                ncols = 4)
-#   for (j in 1:nrow(run_times_0$chains)) {
-#     checkmate::expect_scalar_na(run_times_0$chains$warmup[j])
-#     checkmate::expect_scalar_na(run_times_0$chains$sampling[j])
-#   }
-# })
-#
-# test_that(""inc_warmup in draws() works"", {
-#   skip_on_cran()
-#   x0 <- fit_mcmc_0$draws(inc_warmup = FALSE)
-#   x1 <- fit_mcmc_1$draws(inc_warmup = FALSE)
-#   x2 <- fit_mcmc_1$draws(inc_warmup = TRUE)
-#   x2_a <- fit_mcmc_1$draws(inc_warmup = TRUE, variables = c(""alpha""))
-#   x2_b <- fit_mcmc_1$draws(inc_warmup = TRUE, variables = c(""beta""))
-#   x2_after <- fit_mcmc_1$draws(inc_warmup = TRUE)
-#   expect_equal(dim(x0), c(1000, 2, 5))
-#   expect_error(fit_mcmc_0$draws(inc_warmup = TRUE),
-#                ""Warmup draws were requested from a fit object without them!"")
-#   expect_equal(dim(x1), c(1000, 2, 5))
-#   expect_equal(dim(x2), c(2000, 2, 5))
-#   expect_equal(dim(x2_a), c(2000, 2, 1))
-#   expect_equal(dim(x2_b), c(2000, 2, 3))
-#   expect_equal(dim(x2_after), c(2000, 2, 5))
-#   y0 <- fit_mcmc_0$sampler_diagnostics(inc_warmup = FALSE)
-#   y1 <- fit_mcmc_1$sampler_diagnostics(inc_warmup = FALSE)
-#   y2 <- fit_mcmc_1$sampler_diagnostics(inc_warmup = TRUE)
-#   expect_equal(dim(y0), c(1000, 2, 6))
-#   expect_error(fit_mcmc_0$sampler_diagnostics(inc_warmup = TRUE),
-#                ""Warmup sampler diagnostics were requested from a fit object without them!"")
-#   expect_equal(dim(y1), c(1000, 2, 6))
-#   expect_equal(dim(y2), c(2000, 2, 6))
-# })
-#
-# test_that(""inc_warmup in draws() works"", {
-#   skip_on_cran()
-#   x3 <- fit_mcmc_2$draws(inc_warmup = FALSE)
-#   expect_equal(dim(x3), c(100000, 1, 5))
-#   expect_error(fit_mcmc_2$draws(inc_warmup = TRUE),
-#                ""Warmup draws were requested from a fit object without them! Please rerun the model with save_warmup = TRUE."")
-#   y3 <- fit_mcmc_2$sampler_diagnostics(inc_warmup = FALSE)
-#   expect_equal(dim(y3), c(100000, 1, 6))
-# })
+test_that(""draws() method returns draws_array (reading csv works)"", {
+  skip_on_cran()
+  draws <- fit_gq$draws()
+  draws_ys <- fit_gq$draws(variables = ""y_rep"")
+  draws_y <- fit_gq$draws(variables = ""y_rep[1]"")
+  draws_sum_y <- fit_gq$draws(variables = c(""sum_y"", ""y_rep""))
+  draws_y_sum <- fit_gq$draws(variables = c(""y_rep"", ""sum_y""))
+  draws_all_after <- fit_gq$draws()
+  expect_type(draws, ""double"")
+  expect_s3_class(draws, ""draws_array"")
+  expect_equal(posterior::variables(draws), PARAM_NAMES)
+  expect_equal(posterior::nchains(draws), fit_gq$num_chains())
+  expect_s3_class(draws_ys, ""draws_array"")
+  expect_equal(posterior::nvariables(draws_ys), 10)
+  expect_equal(posterior::nchains(draws_ys), fit_gq$num_chains())
+  expect_s3_class(draws_y, ""draws_array"")
+  expect_equal(posterior::nvariables(draws_y), 1)
+  expect_equal(posterior::nchains(draws_y), fit_gq$num_chains())
+  expect_s3_class(draws_sum_y, ""draws_array"")
+  expect_equal(posterior::nvariables(draws_sum_y), 11)
+  expect_equal(posterior::nchains(draws_sum_y), fit_gq$num_chains())
+  expect_s3_class(draws_all_after, ""draws_array"")
+  expect_equal(posterior::nvariables(draws_all_after), 11)
+  expect_equal(posterior::nchains(draws_all_after), fit_gq$num_chains())
+
+  expect_equal(dim(draws), c(1000, 4, 11))
+  expect_equal(dim(draws_ys), c(1000, 4, 10))
+  expect_equal(dim(draws_y), c(1000, 4, 1))
+  expect_equal(dim(draws_all_after), c(1000, 4, 11))
+
+  # check the order of the draws
+  expect_equal(posterior::variables(draws_sum_y), c(""sum_y"", PARAM_NAMES[1:(length(PARAM_NAMES)-1)]))
+  expect_equal(posterior::variables(draws_y_sum), PARAM_NAMES)
+})
+
+test_that(""summary() method works after gq"", {
+  skip_on_cran()
+  x <- fit_gq$summary()
+  expect_s3_class(x, ""draws_summary"")
+  expect_equal(x$variable, PARAM_NAMES)
+
+  x <- fit_gq$summary(""sum_y"", c(""median"", ""mad""))
+  expect_equal(x$variable, ""sum_y"")
+  expect_equal(colnames(x), c(""variable"", ""median"", ""mad""))
+})
+
+test_that(""print() method works after mcmc"", {
+  skip_on_cran()
+  expect_output(expect_s3_class(fit_gq$print(), ""CmdStanGQ""), ""variable"")
+  expect_output(fit_gq$print(max_rows = 1), ""# showing 1 of 11 rows"")
+  expect_output(fit_gq$print(NULL, c(""mad"")), ""mad"")
+
+  expect_output(fit_gq$print(), ""showing 10 of 11 rows"")
+  expect_output(fit_gq$print(max_rows = 2), ""showing 2 of 11 rows"")
+  expect_output(fit_gq$print(max_rows = 11), ""sum_y"", fixed=TRUE) # last parameter
+  expect_output(fit_gq$print(""y_rep"", max_rows = 2), ""showing 2 of 10 rows"")
+  expect_error(
+    fit_gq$print(variable = ""unknown"", max_rows = 20),
+    ""Can't find the following variable(s): unknown"",
+    fixed = TRUE
+  ) # unknown parameter
+
+  out <- capture.output(fit_gq$print(""y_rep""))
+  expect_length(out, 11) # columns names + 1 y_rep
+  expect_match(out[1], ""variable"")
+  expect_match(out[2], ""y_rep[1]"", fixed = TRUE)
+  expect_match(out[9], ""y_rep[8]"", fixed = TRUE)
+  expect_false(any(grepl(""sum_y|theta"", out)))
+
+  # make sure the row order is correct
+  out <- capture.output(fit_gq$print(c(""y_rep[1]"", ""sum_y"", ""y_rep[3]"")))
+  expect_length(out, 4)
+  expect_match(out[1], "" variable"", out[1])
+  expect_match(out[2], "" y_rep[1]"", fixed = TRUE)
+  expect_match(out[3], "" sum_y"")
+  expect_match(out[4], "" y_rep[3]"", fixed = TRUE)
+})
+
+test_that(""output() method works after gq"", {
+  skip_on_cran()
+  checkmate::expect_list(
+    fit_gq$output(),
+    types = ""character"",
+    any.missing = FALSE,
+    len = fit_gq$runset$num_procs()
+  )
+  expect_output(fit_gq$output(id = 1), ""method = generate_quantities"")
+})
+
+test_that(""time() method works after mcmc"", {
+  skip_on_cran()
+  run_times <- fit_gq$time()
+  checkmate::expect_list(run_times, names = ""strict"", any.missing = FALSE)
+  testthat::expect_named(run_times, c(""total"", ""chains""))
+  checkmate::expect_number(run_times$total, finite = TRUE)
+  checkmate::expect_data_frame(
+    run_times$chains,
+    any.missing = FALSE,
+    types = c(""integer"", ""numeric""),
+    nrows = fit_gq$runset$num_procs(),
+    ncols = 2
+  )
+})",True,False,Implementation / Logic,6
stan-dev,cmdstanr,9a4f4fbab63392f44a659ae32fde574a7bdcebef,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-27T07:36:47Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-27T07:36:47Z,"remove ""sampling"" from the error message",R/fit.R;R/read_csv.R;tests/testthat/test-csv.R;tests/testthat/test-fit-gq.R;tests/testthat/test-fit-mcmc.R,False,True,True,False,187,43,230,"---FILE: R/fit.R---
@@ -678,7 +678,7 @@ CmdStanMCMC <- R6::R6Class(
       }
       matching_res <- matching_variables(variables, private$metadata_$model_params)
       if (length(matching_res$not_found)) {
-        stop(""Can't find the following variable(s) in the sampling output: "",
+        stop(""Can't find the following variable(s) in the output: "",
              paste(matching_res$not_found, collapse = "", ""))
       }
       variables <- repair_variable_names(matching_res$matching)

---FILE: R/read_csv.R---
@@ -153,7 +153,7 @@ read_cmdstan_csv <- function(files,
       } else { # filter using variables
         res <- matching_variables(variables, metadata$model_params)
         if (length(res$not_found)) {
-          stop(""Can't find the following variable(s) in the sampling output: "",
+          stop(""Can't find the following variable(s) in the output: "",
                paste(res$not_found, collapse = "", ""), call. = FALSE)
         }
         variables <- res$matching
@@ -173,7 +173,7 @@ read_cmdstan_csv <- function(files,
           selected_sampler_diag <- selected_sampler_diag | matches
         }
         if (length(not_found)) {
-          stop(""Can't find the following sampler diagnostic(s) in the sampling output: "",
+          stop(""Can't find the following sampler diagnostic(s) in the output: "",
                paste(not_found, collapse = "", ""), call. = FALSE)
         }
         sampler_diagnostics <- metadata$sampler_diagnostics[selected_sampler_diag]

---FILE: tests/testthat/test-csv.R---
@@ -300,10 +300,10 @@ test_that(""read_cmdstan_csv() works with filtered variables"", {
   expect_equal(dim(csv_output_1$post_warmup_draws), c(1000, 2, 2))
   expect_equal(dim(csv_output_1$post_warmup_sampler_diagnostics), c(1000, 2, 2))
   expect_error(read_cmdstan_csv(fit_logistic_thin_1$output_files(), variables = c(""NOPE""), sampler_diagnostics = list(""n_leapfrog__"", ""divergent__"")),
-               ""Can't find the following variable(s) in the sampling output: NOPE"",
+               ""Can't find the following variable(s) in the output: NOPE"",
                fixed = TRUE)
   expect_error(read_cmdstan_csv(fit_logistic_thin_1$output_files(), sampler_diagnostics = list(""BAD_1"", ""BAD_2"")),
-               ""Can't find the following sampler diagnostic(s) in the sampling output: BAD_1, BAD_2"",
+               ""Can't find the following sampler diagnostic(s) in the output: BAD_1, BAD_2"",
                fixed = TRUE)
 })
 

---FILE: tests/testthat/test-fit-gq.R---
@@ -1,59 +1,203 @@
-# context(""fitted-mle"")
+context(""fitted-gq"")
 
-# if (not_on_cran()) {
-#   set_cmdstan_path()
-#   fit_mle <- testing_fit(""logistic"", method = ""generate_quantities"", seed = 123)
-#   mod <- testing_model(""bernoulli"")
-#   data_list <- testing_data(""bernoulli"")
-#   PARAM_NAMES <- c(""alpha"", ""beta[1]"", ""beta[2]"", ""beta[3]"")
-# }
+if (not_on_cran()) {
+  set_cmdstan_path()
+  fit <- testing_fit(""bernoulli"", method = ""sample"", seed = 123)
+  fit_gq <- testing_fit(""bernoulli_ppc"", method = ""generate_quantities"", seed = 123, fitted_params = fit)
+  mod <- testing_model(""bernoulli_ppc"")
+  data_list <- testing_data(""bernoulli_ppc"")
+  PARAM_NAMES <- c(""y_rep[1]"", ""y_rep[2]"", ""y_rep[3]"", ""y_rep[4]"", ""y_rep[5]"",
+                   ""y_rep[6]"", ""y_rep[7]"", ""y_rep[8]"", ""y_rep[9]"", ""y_rep[10]"")
+}
 
-# test_that(""mle and lp methods work after optimization"", {
+test_that(""draws() stops for unkown variables"", {
+  skip_on_cran()
+  expect_error(
+    fit_gq$draws(variables = ""ABCD""),
+    ""Can't find the following variable(s) in the output: ABCD"",
+    fixed = TRUE
+  )
+  fit_gq$draws()
+  expect_error(
+    fit_gq$draws(variables = c(""ABCD"", ""EFGH"")),
+    ""Can't find the following variable(s) in the output: ABCD, EFGH"",
+    fixed = TRUE
+  )
+})
+
+# test_that(""draws() method returns draws_array (reading csv works)"", {
 #   skip_on_cran()
-#   expect_named(fit_mle$mle(), PARAM_NAMES)
-#   checkmate::expect_numeric(fit_mle$lp(), len = 1)
+#   draws <- fit_mcmc$draws()
+#   draws_betas <- fit_mcmc$draws(variables = ""beta"")
+#   draws_beta <- fit_mcmc$draws(variables = ""beta[1]"")
+#   draws_alpha_beta <- fit_mcmc$draws(variables = c(""alpha"", ""beta""))
+#   draws_beta_alpha <- fit_mcmc$draws(variables = c(""beta"", ""alpha""))
+#   draws_all_after <- fit_mcmc$draws()
+#   expect_type(draws, ""double"")
+#   expect_s3_class(draws, ""draws_array"")
+#   expect_equal(posterior::variables(draws), c(""lp__"", PARAM_NAMES))
+#   expect_equal(posterior::nchains(draws), fit_mcmc$num_chains())
+#   expect_s3_class(draws_betas, ""draws_array"")
+#   expect_equal(posterior::nvariables(draws_betas), 3)
+#   expect_equal(posterior::nchains(draws_betas), fit_mcmc$num_chains())
+#   expect_s3_class(draws_beta, ""draws_array"")
+#   expect_equal(posterior::nvariables(draws_beta), 1)
+#   expect_equal(posterior::nchains(draws_beta), fit_mcmc$num_chains())
+#   expect_s3_class(draws_alpha_beta, ""draws_array"")
+#   expect_equal(posterior::nvariables(draws_alpha_beta), 4)
+#   expect_equal(posterior::nchains(draws_alpha_beta), fit_mcmc$num_chains())
+#   expect_s3_class(draws_all_after, ""draws_array"")
+#   expect_equal(posterior::nvariables(draws_all_after), 5)
+#   expect_equal(posterior::nchains(draws_all_after), fit_mcmc$num_chains())
+#
+#   # check the order of the draws
+#   expect_equal(posterior::variables(draws_alpha_beta), c(""alpha"", ""beta[1]"", ""beta[2]"", ""beta[3]""))
+#   expect_equal(posterior::variables(draws_beta_alpha), c(""beta[1]"", ""beta[2]"", ""beta[3]"", ""alpha""))
 # })
-
-# test_that(""summary method works after optimization"", {
+#
+# test_that(""inv_metric method works after mcmc"", {
+#   skip_on_cran()
+#   x <- fit_mcmc_1$inv_metric()
+#   expect_length(x, fit_mcmc_1$num_chains())
+#   checkmate::expect_matrix(x[[1]])
+#   checkmate::expect_matrix(x[[2]])
+#   expect_equal(x[[1]], diag(diag(x[[1]])))
+#
+#   x <- fit_mcmc_1$inv_metric(matrix=FALSE)
+#   expect_length(x, fit_mcmc_1$num_chains())
+#   expect_null(dim(x[[1]]))
+#   checkmate::expect_numeric(x[[1]])
+#   checkmate::expect_numeric(x[[2]])
+#
+#   x <- fit_mcmc_2$inv_metric()
+#   expect_length(x, fit_mcmc_2$num_chains())
+#   checkmate::expect_matrix(x[[1]])
+#   expect_false(x[[1]][1,2] == 0) # dense
+# })
+#
+# test_that(""summary() method works after mcmc"", {
 #   skip_on_cran()
-#   x <- fit_mle$summary()
+#   x <- fit_mcmc$summary()
 #   expect_s3_class(x, ""draws_summary"")
-#   expect_equal(colnames(x), c(""variable"", ""estimate""))
 #   expect_equal(x$variable, c(""lp__"", PARAM_NAMES))
-
-#   x <- fit_mle$summary(""lp__"")
-#   expect_equal(colnames(x), c(""variable"", ""estimate""))
+#
+#   x <- fit_mcmc$summary(NULL, c(""rhat"", ""sd""))
+#   expect_equal(colnames(x), c(""variable"", ""rhat"", ""sd""))
+#
+#   x <- fit_mcmc$summary(""lp__"", c(""median"", ""mad""))
 #   expect_equal(x$variable, ""lp__"")
+#   expect_equal(colnames(x), c(""variable"", ""median"", ""mad""))
 # })
-
-# test_that(""print() method works after optimization"", {
+#
+# test_that(""print() method works after mcmc"", {
 #   skip_on_cran()
-#   expect_output(expect_s3_class(fit_mle$print(), ""CmdStanMLE""), ""estimate"")
-#   expect_output(fit_mle$print(max_rows = 1), ""# showing 1 of 5 rows"")
+#   expect_output(expect_s3_class(fit_mcmc$print(), ""CmdStanMCMC""), ""variable"")
+#   expect_output(fit_mcmc$print(max_rows = 1), ""# showing 1 of 5 rows"")
+#   expect_output(fit_mcmc$print(NULL, c(""ess_sd"")), ""ess_sd"")
+#
+#   # test on model with more parameters
+#   fit <- cmdstanr_example(""schools_ncp"")
+#   expect_output(fit$print(), ""showing 10 of 19 rows"")
+#   expect_output(fit$print(max_rows = 2), ""showing 2 of 19 rows"")
+#   expect_output(fit$print(max_rows = 19), ""theta[8]"", fixed=TRUE) # last parameter
+#   expect_output(fit$print(""theta"", max_rows = 2), ""showing 2 of 8 rows"")
 #   expect_error(
-#     fit_mle$print(variable = ""unknown"", max_rows = 20),
+#     fit$print(variable = ""unknown"", max_rows = 20),
 #     ""Can't find the following variable(s): unknown"",
 #     fixed = TRUE
 #   ) # unknown parameter
+#
+#   out <- capture.output(fit$print(""theta""))
+#   expect_length(out, 9) # columns names + 8 thetas
+#   expect_match(out[1], ""variable"")
+#   expect_match(out[2], ""theta[1]"", fixed = TRUE)
+#   expect_match(out[9], ""theta[8]"", fixed = TRUE)
+#   expect_false(any(grepl(""mu|tau|theta_raw"", out)))
+#
+#   # make sure the row order is correct
+#   out <- capture.output(fit$print(c(""theta[1]"", ""tau"", ""mu"", ""theta_raw[3]"")))
+#   expect_length(out, 5)
+#   expect_match(out[1], "" variable"", out[1])
+#   expect_match(out[2], "" theta[1]"", fixed = TRUE)
+#   expect_match(out[3], "" tau"")
+#   expect_match(out[4], "" mu"")
+#   expect_match(out[5], "" theta_raw[3]"", fixed = TRUE)
 # })
-
-# test_that(""time() method works after optimization"", {
+#
+# test_that(""output() method works after mcmc"", {
+#   skip_on_cran()
+#   checkmate::expect_list(
+#     fit_mcmc$output(),
+#     types = ""character"",
+#     any.missing = FALSE,
+#     len = fit_mcmc$runset$num_procs()
+#   )
+#   expect_output(fit_mcmc$output(id = 1), ""Gradient evaluation took"")
+# })
+#
+# test_that(""time() method works after mcmc"", {
 #   skip_on_cran()
-#   run_times <- fit_mle$time()
+#   run_times <- fit_mcmc$time()
 #   checkmate::expect_list(run_times, names = ""strict"", any.missing = FALSE)
-#   testthat::expect_named(run_times, c(""total""))
+#   testthat::expect_named(run_times, c(""total"", ""chains""))
 #   checkmate::expect_number(run_times$total, finite = TRUE)
+#   checkmate::expect_data_frame(
+#     run_times$chains,
+#     any.missing = FALSE,
+#     types = c(""integer"", ""numeric""),
+#     nrows = fit_mcmc$runset$num_procs(),
+#     ncols = 4
+#   )
+#
+#   # after refresh=0 warmup and sampling times should be NA
+#   testthat::expect_warning(
+#     run_times_0 <- fit_mcmc_0$time(),
+#     ""Separate warmup and sampling times are not available""
+#   )
+#   checkmate::expect_number(run_times_0$total, finite = TRUE)
+#   checkmate::expect_data_frame(run_times_0$chains,
+#                                any.missing = TRUE,
+#                                types = c(""integer"", ""numeric""),
+#                                nrows = fit_mcmc_0$runset$num_procs(),
+#                                ncols = 4)
+#   for (j in 1:nrow(run_times_0$chains)) {
+#     checkmate::expect_scalar_na(run_times_0$chains$warmup[j])
+#     checkmate::expect_scalar_na(run_times_0$chains$sampling[j])
+#   }
 # })
-
-
-# test_that(""output() works for optimization"", {
+#
+# test_that(""inc_warmup in draws() works"", {
 #   skip_on_cran()
-#   expect_output(fit_mle$output(),
-#                 ""method = optimize"")
+#   x0 <- fit_mcmc_0$draws(inc_warmup = FALSE)
+#   x1 <- fit_mcmc_1$draws(inc_warmup = FALSE)
+#   x2 <- fit_mcmc_1$draws(inc_warmup = TRUE)
+#   x2_a <- fit_mcmc_1$draws(inc_warmup = TRUE, variables = c(""alpha""))
+#   x2_b <- fit_mcmc_1$draws(inc_warmup = TRUE, variables = c(""beta""))
+#   x2_after <- fit_mcmc_1$draws(inc_warmup = TRUE)
+#   expect_equal(dim(x0), c(1000, 2, 5))
+#   expect_error(fit_mcmc_0$draws(inc_warmup = TRUE),
+#                ""Warmup draws were requested from a fit object without them!"")
+#   expect_equal(dim(x1), c(1000, 2, 5))
+#   expect_equal(dim(x2), c(2000, 2, 5))
+#   expect_equal(dim(x2_a), c(2000, 2, 1))
+#   expect_equal(dim(x2_b), c(2000, 2, 3))
+#   expect_equal(dim(x2_after), c(2000, 2, 5))
+#   y0 <- fit_mcmc_0$sampler_diagnostics(inc_warmup = FALSE)
+#   y1 <- fit_mcmc_1$sampler_diagnostics(inc_warmup = FALSE)
+#   y2 <- fit_mcmc_1$sampler_diagnostics(inc_warmup = TRUE)
+#   expect_equal(dim(y0), c(1000, 2, 6))
+#   expect_error(fit_mcmc_0$sampler_diagnostics(inc_warmup = TRUE),
+#                ""Warmup sampler diagnostics were requested from a fit object without them!"")
+#   expect_equal(dim(y1), c(1000, 2, 6))
+#   expect_equal(dim(y2), c(2000, 2, 6))
 # })
-
-# test_that(""time is reported after optimization"", {
+#
+# test_that(""inc_warmup in draws() works"", {
 #   skip_on_cran()
-#   expect_output(mod$optimize(data = data_list),
-#                 ""Finished in"")
+#   x3 <- fit_mcmc_2$draws(inc_warmup = FALSE)
+#   expect_equal(dim(x3), c(100000, 1, 5))
+#   expect_error(fit_mcmc_2$draws(inc_warmup = TRUE),
+#                ""Warmup draws were requested from a fit object without them! Please rerun the model with save_warmup = TRUE."")
+#   y3 <- fit_mcmc_2$sampler_diagnostics(inc_warmup = FALSE)
+#   expect_equal(dim(y3), c(100000, 1, 6))
 # })

---FILE: tests/testthat/test-fit-mcmc.R---
@@ -21,13 +21,13 @@ test_that(""draws() stops for unkown variables"", {
   skip_on_cran()
   expect_error(
     draws_betas <- fit_mcmc$draws(variables = ""ABCD""),
-    ""Can't find the following variable(s) in the sampling output: ABCD"",
+    ""Can't find the following variable(s) in the output: ABCD"",
     fixed = TRUE
   )
   fit_mcmc$draws()
   expect_error(
     draws_betas <- fit_mcmc$draws(variables = c(""ABCD"", ""EFGH"")),
-    ""Can't find the following variable(s) in the sampling output: ABCD, EFGH"",
+    ""Can't find the following variable(s) in the output: ABCD, EFGH"",
     fixed = TRUE
   )
 })",True,False,Implementation / Logic,6
stan-dev,cmdstanr,bbf0b3abf8cc3d8c11f822474754293b76671ce3,jgabry,jgabry@gmail.com,2020-06-27T05:20:14Z,jgabry,jgabry@gmail.com,2020-06-27T05:20:14Z,flesh out fixed param doc a little,R/model.R;docs/reference/model-method-sample.html;man/model-method-sample.Rd,False,True,True,False,74,80,154,"---FILE: R/model.R---
@@ -459,7 +459,7 @@ CmdStanModel$set(""public"", name = ""compile"", value = compile_method)
 #'   [$draws(inc_warmup=TRUE)][fit-method-draws] to include warmup when
 #'   accessing the draws.
 #'   * `thin`: (positive integer) The period between saved samples. This should
-#'   typically be left at its default (no thinning) unless memory is a problem.
+#'   be left at its default (no thinning) unless memory is a problem.
 #'   * `max_treedepth`: (positive integer) The maximum allowed tree depth for the
 #'   NUTS engine. See the _Tree Depth_ section of the CmdStan manual for more
 #'   details.
@@ -499,10 +499,17 @@ CmdStanModel$set(""public"", name = ""compile"", value = compile_method)
 #'   * `window`: (nonnegative integer) Initial width of slow timestep/metric
 #'   adaptation interval.
 #'   * `fixed_param`: (logical) When `TRUE`, call CmdStan with argument
-#'   `""algorithm=fixed_param""`. The default is `FALSE`.
+#'   `""algorithm=fixed_param""`. The default is `FALSE`. The fixed parameter
+#'   sampler generates a new sample without changing the current state of the
+#'   Markov chain; only generated quantities may change. This can be useful
+#'   when, for example, trying to generate pseudo-data using the generated
+#'   quantities block. If the parameters block is empty then using
+#'   `fixed_param=TRUE` is mandatory. When `fixed_param=TRUE` the `chains` and
+#'   `parallel_chains` arguments will be set to `1`.
 #'   * `validate_csv`: (logical) When `TRUE` (the default), validate the
 #'   sampling results in the csv files. Disable if you wish to manually read in
-#'   the sampling results and validate them.
+#'   the sampling results and validate them yourself, for example using
+#'   [read_cmdstan_csv()].
 #'
 #' @section Value: The `$sample()` method returns a [`CmdStanMCMC`] object.
 #'
@@ -546,11 +553,6 @@ sample_method <- function(data = NULL,
                           max_depth = NULL,
                           stepsize = NULL) {
 
-  if (fixed_param) {
-    chains <- 1
-    parallel_chains <- 1
-    save_warmup <- FALSE
-  }
   # temporary deprecation warnings
   if (!is.null(cores)) {
     warning(""'cores' is deprecated. Please use 'parallel_chains' instead."")
@@ -584,18 +586,28 @@ sample_method <- function(data = NULL,
     warning(""'save_extra_diagnostics' is deprecated. Please use 'save_latent_dynamics' instead."")
     save_latent_dynamics <- save_extra_diagnostics
   }
+
+  if (fixed_param) {
+    chains <- 1
+    parallel_chains <- 1
+    save_warmup <- FALSE
+  }
+
   checkmate::assert_integerish(chains, lower = 1, len = 1)
   checkmate::assert_integerish(parallel_chains, lower = 1, null.ok = TRUE)
   checkmate::assert_integerish(threads_per_chain, lower = 1, len = 1, null.ok = TRUE)
-  # check if model was not compiled with threading
   if (is.null(self$cpp_options()[[""stan_threads""]])) {
     if (!is.null(threads_per_chain)) {
-      warning(""'threads_per_chain' is set but the model was not compiled with 'cpp_options = list(stan_threads = TRUE)' so 'threads_per_chain' will have no effect!"")
+      warning(""'threads_per_chain' is set but the model was not compiled with "",
+              ""'cpp_options = list(stan_threads = TRUE)' so 'threads_per_chain' will have no effect!"",
+              call. = FALSE)
       threads_per_chain <- NULL
     }
   } else {
     if (is.null(threads_per_chain)) {
-      stop(""The model was compiled with 'cpp_options = list(stan_threads = TRUE)' but 'threads_per_chain' was not set!"")
+      stop(""The model was compiled with 'cpp_options = list(stan_threads = TRUE)' "",
+           ""but 'threads_per_chain' was not set!"",
+           call. = FALSE)
     }
   }
 

---FILE: docs/reference/model-method-sample.html---
@@ -254,11 +254,12 @@ <h2 class=""hasAnchor"" id=""arguments-shared-by-all-fitting-methods""><a class=""anc
 <code>NULL</code> (temporary directory) since CmdStanR makes the CmdStan output (e.g.,
 posterior draws and diagnostics) available in <span style=""R"">R</span> via methods of the fitted
 model objects. The behavior of <code>output_dir</code> is as follows:</p><ul>
-<li><p>If <code>NULL</code> (the default) then the CSV files are written to a temporary
+<li><p>If <code>NULL</code> (the default), then the CSV files are written to a temporary
 directory and only saved permanently if the user calls one of the
 <code>$save_*</code> methods of the fitted model object (e.g.,
-<code><a href='fit-method-save_output_files.html'>$save_output_files()</a></code>).</p></li>
-<li><p>If a path then the files are created in <code>output_dir</code> with names
+<code><a href='fit-method-save_output_files.html'>$save_output_files()</a></code>). These temporary
+files are removed when the fitted model object is garbage collected.</p></li>
+<li><p>If a path, then the files are created in <code>output_dir</code> with names
 corresponding the defaults used by <code>$save_output_files()</code> (and similar
 methods like <code>$save_latent_dynamics_files()</code>).</p></li>
 </ul></li>
@@ -340,10 +341,17 @@ <h2 class=""hasAnchor"" id=""arguments-unique-to-the-sample-method""><a class=""ancho
 <li><p><code>window</code>: (nonnegative integer) Initial width of slow timestep/metric
 adaptation interval.</p></li>
 <li><p><code>fixed_param</code>: (logical) When <code>TRUE</code>, call CmdStan with argument
-<code>""algorithm=fixed_param""</code>. The default is <code>FALSE</code>.</p></li>
+<code>""algorithm=fixed_param""</code>. The default is <code>FALSE</code>. The fixed parameter
+sampler generates a new sample without changing the current state of the
+Markov chain; only generated quantities may change. This can be useful
+when, for example, trying to generate pseudo-data using the generated
+quantities block. If the parameters block is empty then using
+<code>fixed_param=TRUE</code> is mandatory. When <code>fixed_param=TRUE</code> the <code>chains</code> and
+<code>parallel_chains</code> arguments will be set to <code>1</code>.</p></li>
 <li><p><code>validate_csv</code>: (logical) When <code>TRUE</code> (the default), validate the
 sampling results in the csv files. Disable if you wish to manually read in
-the sampling results and validate them.</p></li>
+the sampling results and validate them yourself, for example using
+<code><a href='read_cmdstan_csv.html'>read_cmdstan_csv()</a></code>.</p></li>
 </ul>
 
     <h2 class=""hasAnchor"" id=""value""><a class=""anchor"" href=""#value""></a>Value</h2>
@@ -401,18 +409,6 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
   <span class='kw'>parallel_chains</span> <span class='kw'>=</span> <span class='fl'>2</span>
 )</div><div class='output co'>#&gt; Running MCMC with 2 parallel chains...
 #&gt; 
-#&gt; Running ./bernoulli 'id=1' random 'seed=123' data \
-#&gt;   'file=/var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpahDDBq/standata-c939efa6c4.json' \
-#&gt;   output \
-#&gt;   'file=/var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpahDDBq/bernoulli-202006202309-1-ad8e56.csv' \
-#&gt;   'method=sample' 'save_warmup=0' 'algorithm=hmc' 'engine=nuts' adapt \
-#&gt;   'engaged=1'
-#&gt; Running ./bernoulli 'id=2' random 'seed=124' data \
-#&gt;   'file=/var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpahDDBq/standata-c939efa6c4.json' \
-#&gt;   output \
-#&gt;   'file=/var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpahDDBq/bernoulli-202006202309-2-ad8e56.csv' \
-#&gt;   'method=sample' 'save_warmup=0' 'algorithm=hmc' 'engine=nuts' adapt \
-#&gt;   'engaged=1'
 #&gt; Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup) 
 #&gt; Chain 1 Iteration:  100 / 2000 [  5%]  (Warmup) 
 #&gt; Chain 1 Iteration:  200 / 2000 [ 10%]  (Warmup) 
@@ -457,11 +453,11 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; Chain 2 Iteration: 1800 / 2000 [ 90%]  (Sampling) 
 #&gt; Chain 2 Iteration: 1900 / 2000 [ 95%]  (Sampling) 
 #&gt; Chain 2 Iteration: 2000 / 2000 [100%]  (Sampling) 
-#&gt; Chain 1 finished in 0.2 seconds.
-#&gt; Chain 2 finished in 0.2 seconds.
+#&gt; Chain 1 finished in 0.1 seconds.
+#&gt; Chain 2 finished in 0.1 seconds.
 #&gt; 
 #&gt; Both chains finished successfully.
-#&gt; Mean chain execution time: 0.2 seconds.
+#&gt; Mean chain execution time: 0.1 seconds.
 #&gt; Total execution time: 0.2 seconds.</div><div class='input'>
 <span class='co'># Use 'posterior' package for summaries</span>
 <span class='no'>fit_mcmc</span>$<span class='fu'><a href='fit-method-summary.html'>summary</a></span>()</div><div class='output co'>#&gt; <span style='color: #949494;'># A tibble: 2 x 10</span><span>
@@ -512,9 +508,9 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 <span class='fu'><a href='https://mc-stan.org/bayesplot/reference/MCMC-distributions.html'>mcmc_hist</a></span>(<span class='no'>fit_mcmc</span>$<span class='fu'><a href='fit-method-draws.html'>draws</a></span>(<span class='st'>""theta""</span>))</div><div class='output co'>#&gt; <span class='message'>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</span></div><div class='img'><img src='model-method-sample-1.png' alt='' width='700' height='433' /></div><div class='input'>
 <span class='co'># Call CmdStan's diagnose and stansummary utilities</span>
 <span class='no'>fit_mcmc</span>$<span class='fu'><a href='fit-method-cmdstan_summary.html'>cmdstan_diagnose</a></span>()</div><div class='output co'>#&gt; Running bin/diagnose \
-#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpahDDBq/bernoulli-202006202309-1-ad8e56.csv \
-#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpahDDBq/bernoulli-202006202309-2-ad8e56.csv
-#&gt; Processing csv files: /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpahDDBq/bernoulli-202006202309-1-ad8e56.csv, /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpahDDBq/bernoulli-202006202309-2-ad8e56.csv
+#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpEWAtYP/bernoulli-202006270118-1-0e17de.csv \
+#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpEWAtYP/bernoulli-202006270118-2-0e17de.csv
+#&gt; Processing csv files: /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpEWAtYP/bernoulli-202006270118-1-0e17de.csv, /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpEWAtYP/bernoulli-202006270118-2-0e17de.csv
 #&gt; 
 #&gt; Checking sampler transitions treedepth.
 #&gt; Treedepth satisfactory for all transitions.
@@ -530,23 +526,23 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; Split R-hat values satisfactory all parameters.
 #&gt; 
 #&gt; Processing complete, no problems detected.</div><div class='input'><span class='no'>fit_mcmc</span>$<span class='fu'><a href='fit-method-cmdstan_summary.html'>cmdstan_summary</a></span>()</div><div class='output co'>#&gt; Running bin/stansummary \
-#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpahDDBq/bernoulli-202006202309-1-ad8e56.csv \
-#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpahDDBq/bernoulli-202006202309-2-ad8e56.csv
+#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpEWAtYP/bernoulli-202006270118-1-0e17de.csv \
+#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpEWAtYP/bernoulli-202006270118-2-0e17de.csv
 #&gt; Inference for Stan model: bernoulli_model
 #&gt; 2 chains: each with iter=(1000,1000); warmup=(0,0); thin=(1,1); 2000 iterations saved.
 #&gt; 
-#&gt; Warmup took (0.0079, 0.0078) seconds, 0.016 seconds total
-#&gt; Sampling took (0.018, 0.016) seconds, 0.034 seconds total
+#&gt; Warmup took (0.012, 0.011) seconds, 0.023 seconds total
+#&gt; Sampling took (0.025, 0.021) seconds, 0.046 seconds total
 #&gt; 
 #&gt;                 Mean     MCSE  StdDev     5%   50%   95%    N_Eff  N_Eff/s    R_hat
-#&gt; lp__            -7.3  3.1e-02    0.74   -8.8  -7.0  -6.8  5.9e+02  1.7e+04  1.0e+00
-#&gt; accept_stat__   0.92  5.0e-03    0.14   0.61  0.97   1.0  7.3e+02  2.2e+04  1.0e+00
-#&gt; stepsize__       1.0  9.0e-02   0.090   0.93   1.1   1.1  1.0e+00  3.0e+01  2.6e+13
-#&gt; treedepth__      1.4  1.2e-02    0.52    1.0   1.0   2.0  1.9e+03  5.5e+04  1.0e+00
-#&gt; n_leapfrog__     2.6  4.0e-01     1.5    1.0   3.0   7.0  1.4e+01  4.2e+02  1.0e+00
+#&gt; lp__            -7.3  3.1e-02    0.74   -8.8  -7.0  -6.8  5.9e+02  1.3e+04  1.0e+00
+#&gt; accept_stat__   0.92  5.0e-03    0.14   0.61  0.97   1.0  7.3e+02  1.6e+04  1.0e+00
+#&gt; stepsize__       1.0  9.0e-02   0.090   0.93   1.1   1.1  1.0e+00  2.2e+01  2.6e+13
+#&gt; treedepth__      1.4  1.2e-02    0.52    1.0   1.0   2.0  1.9e+03  4.0e+04  1.0e+00
+#&gt; n_leapfrog__     2.6  4.0e-01     1.5    1.0   3.0   7.0  1.4e+01  3.0e+02  1.0e+00
 #&gt; divergent__     0.00      nan    0.00   0.00  0.00  0.00      nan      nan      nan
-#&gt; energy__         7.8  4.0e-02     1.0    6.8   7.4  10.0  6.9e+02  2.1e+04  1.0e+00
-#&gt; theta           0.25  4.5e-03    0.12  0.081  0.23  0.49  7.6e+02  2.2e+04  1.0e+00
+#&gt; energy__         7.8  4.0e-02     1.0    6.8   7.4  10.0  6.9e+02  1.5e+04  1.0e+00
+#&gt; theta           0.25  4.5e-03    0.12  0.081  0.23  0.49  7.6e+02  1.6e+04  1.0e+00
 #&gt; 
 #&gt; Samples were drawn using hmc with nuts.
 #&gt; For each parameter, N_Eff is a crude measure of effective sample size,
@@ -555,30 +551,14 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; </div><div class='input'>
 <span class='co'># For models fit using MCMC, if you like working with RStan's stanfit objects</span>
 <span class='co'># then you can create one with rstan::read_stan_csv()</span>
-<span class='kw'>if</span> (<span class='fu'><a href='https://rdrr.io/r/base/library.html'>require</a></span>(<span class='no'>rstan</span>, <span class='kw'>quietly</span> <span class='kw'>=</span> <span class='fl'>TRUE</span>)) {
-  <span class='no'>stanfit</span> <span class='kw'>&lt;-</span> <span class='kw pkg'>rstan</span><span class='kw ns'>::</span><span class='fu'><a href='https://rdrr.io/pkg/rstan/man/stan_csv.html'>read_stan_csv</a></span>(<span class='no'>fit_mcmc</span>$<span class='fu'><a href='fit-method-save_output_files.html'>output_files</a></span>())
-  <span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span>(<span class='no'>stanfit</span>)
-}</div><div class='output co'>#&gt; Inference for Stan model: bernoulli-202006202309-1-ad8e56.
-#&gt; 2 chains, each with iter=2000; warmup=1000; thin=1; 
-#&gt; post-warmup draws per chain=1000, total post-warmup draws=2000.
-#&gt; 
-#&gt;        mean se_mean   sd  2.5%   25%   50%   75% 97.5% n_eff Rhat
-#&gt; theta  0.25    0.00 0.12  0.06  0.16  0.23  0.33  0.53   754    1
-#&gt; lp__  -7.28    0.03 0.74 -9.50 -7.45 -7.00 -6.80 -6.75   586    1
-#&gt; 
-#&gt; Samples were drawn using NUTS(diag_e) at Sat Jun 20 23:09:11 2020.
-#&gt; For each parameter, n_eff is a crude measure of effective sample size,
-#&gt; and Rhat is the potential scale reduction factor on split chains (at 
-#&gt; convergence, Rhat=1).</div><div class='input'>
+
+<span class='co'># stanfit &lt;- rstan::read_stan_csv(fit_mcmc$output_files())</span>
+
+
 <span class='co'># Run 'optimize' method to get a point estimate (default is Stan's LBFGS algorithm)</span>
 <span class='co'># and also demonstrate specifying data as a path to a file instead of a list</span>
 <span class='no'>my_data_file</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/file.path.html'>file.path</a></span>(<span class='fu'><a href='set_cmdstan_path.html'>cmdstan_path</a></span>(), <span class='st'>""examples/bernoulli/bernoulli.data.json""</span>)
-<span class='no'>fit_optim</span> <span class='kw'>&lt;-</span> <span class='no'>mod</span>$<span class='fu'><a href='model-method-optimize.html'>optimize</a></span>(<span class='kw'>data</span> <span class='kw'>=</span> <span class='no'>my_data_file</span>, <span class='kw'>seed</span> <span class='kw'>=</span> <span class='fl'>123</span>)</div><div class='output co'>#&gt; Running ./bernoulli 'id=1' random 'seed=123' data \
-#&gt;   'file=/Users/jgabry/.cmdstanr/cmdstan-2.23.0/examples/bernoulli/bernoulli.data.json' \
-#&gt;   output \
-#&gt;   'file=/var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpahDDBq/bernoulli-202006202309-1-5bec75.csv' \
-#&gt;   'method=optimize'
-#&gt; method = optimize 
+<span class='no'>fit_optim</span> <span class='kw'>&lt;-</span> <span class='no'>mod</span>$<span class='fu'><a href='model-method-optimize.html'>optimize</a></span>(<span class='kw'>data</span> <span class='kw'>=</span> <span class='no'>my_data_file</span>, <span class='kw'>seed</span> <span class='kw'>=</span> <span class='fl'>123</span>)</div><div class='output co'>#&gt; method = optimize 
 #&gt;   optimize 
 #&gt;     algorithm = lbfgs (Default) 
 #&gt;       lbfgs 
@@ -598,7 +578,7 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; random 
 #&gt;   seed = 123 
 #&gt; output 
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpahDDBq/bernoulli-202006202309-1-5bec75.csv 
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpEWAtYP/bernoulli-202006270119-1-40f1e6.csv 
 #&gt;   diagnostic_file =  (Default) 
 #&gt;   refresh = 100 (Default) 
 #&gt;  
@@ -607,19 +587,14 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt;        6      -5.00402   0.000103557   2.55661e-07           1           1        9    
 #&gt; Optimization terminated normally:  
 #&gt;   Convergence detected: relative gradient magnitude is below tolerance 
-#&gt; Finished in  0.1 seconds.</div><div class='input'>
+#&gt; Finished in  0.3 seconds.</div><div class='input'>
 <span class='no'>fit_optim</span>$<span class='fu'><a href='fit-method-summary.html'>summary</a></span>()</div><div class='output co'>#&gt; </span><span style='color: #949494;'># A tibble: 2 x 2</span><span>
 #&gt;   variable estimate
 #&gt;   </span><span style='color: #949494;font-style: italic;'>&lt;chr&gt;</span><span>       </span><span style='color: #949494;font-style: italic;'>&lt;dbl&gt;</span><span>
 #&gt; </span><span style='color: #BCBCBC;'>1</span><span> lp__        -</span><span style='color: #BB0000;'>5.00</span><span>
 #&gt; </span><span style='color: #BCBCBC;'>2</span><span> theta        0.2 </div><div class='input'>
 <span class='co'># Run 'variational' to approximate the posterior (default is meanfield ADVI)</span>
-<span class='no'>fit_vb</span> <span class='kw'>&lt;-</span> <span class='no'>mod</span>$<span class='fu'><a href='model-method-variational.html'>variational</a></span>(<span class='kw'>data</span> <span class='kw'>=</span> <span class='no'>stan_data</span>, <span class='kw'>seed</span> <span class='kw'>=</span> <span class='fl'>123</span>)</div><div class='output co'>#&gt; Running ./bernoulli 'id=1' random 'seed=123' data \
-#&gt;   'file=/var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpahDDBq/standata-c939601211b.json' \
-#&gt;   output \
-#&gt;   'file=/var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpahDDBq/bernoulli-202006202309-1-2476b1.csv' \
-#&gt;   'method=variational'
-#&gt; method = variational 
+<span class='no'>fit_vb</span> <span class='kw'>&lt;-</span> <span class='no'>mod</span>$<span class='fu'><a href='model-method-variational.html'>variational</a></span>(<span class='kw'>data</span> <span class='kw'>=</span> <span class='no'>stan_data</span>, <span class='kw'>seed</span> <span class='kw'>=</span> <span class='fl'>123</span>)</div><div class='output co'>#&gt; method = variational 
 #&gt;   variational 
 #&gt;     algorithm = meanfield (Default) 
 #&gt;       meanfield 
@@ -635,12 +610,12 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt;     output_samples = 1000 (Default) 
 #&gt; id = 1 
 #&gt; data 
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpahDDBq/standata-c939601211b.json 
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpEWAtYP/standata-372556c95067.json 
 #&gt; init = 2 (Default) 
 #&gt; random 
 #&gt;   seed = 123 
 #&gt; output 
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpahDDBq/bernoulli-202006202309-1-2476b1.csv 
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpEWAtYP/bernoulli-202006270119-1-bdc6b4.csv 
 #&gt;   diagnostic_file =  (Default) 
 #&gt;   refresh = 100 (Default) 
 #&gt;  
@@ -652,8 +627,8 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt;  
 #&gt;  
 #&gt;  
-#&gt; Gradient evaluation took 1.9e-05 seconds 
-#&gt; 1000 transitions using 10 leapfrog steps per transition would take 0.19 seconds. 
+#&gt; Gradient evaluation took 1.7e-05 seconds 
+#&gt; 1000 transitions using 10 leapfrog steps per transition would take 0.17 seconds. 
 #&gt; Adjust your expectations accordingly! 
 #&gt;  
 #&gt;  

---FILE: man/model-method-sample.Rd---
@@ -172,10 +172,17 @@ adaptation interval during warmup.
 \item \code{window}: (nonnegative integer) Initial width of slow timestep/metric
 adaptation interval.
 \item \code{fixed_param}: (logical) When \code{TRUE}, call CmdStan with argument
-\code{""algorithm=fixed_param""}. The default is \code{FALSE}.
+\code{""algorithm=fixed_param""}. The default is \code{FALSE}. The fixed parameter
+sampler generates a new sample without changing the current state of the
+Markov chain; only generated quantities may change. This can be useful
+when, for example, trying to generate pseudo-data using the generated
+quantities block. If the parameters block is empty then using
+\code{fixed_param=TRUE} is mandatory. When \code{fixed_param=TRUE} the \code{chains} and
+\code{parallel_chains} arguments will be set to \code{1}.
 \item \code{validate_csv}: (logical) When \code{TRUE} (the default), validate the
 sampling results in the csv files. Disable if you wish to manually read in
-the sampling results and validate them.
+the sampling results and validate them yourself, for example using
+\code{\link[=read_cmdstan_csv]{read_cmdstan_csv()}}.
 }
 }
 ",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,cede9dae134a88507b61cac0c94bbc2cd511339d,jgabry,jgabry@gmail.com,2020-06-27T05:17:12Z,jgabry,jgabry@gmail.com,2020-06-27T05:17:12Z,"Fix mistake in doc

[ci skip]",R/cmdstanr-package.R;R/read_csv.R;docs/reference/cmdstanr-package.html;docs/reference/index.html;docs/reference/read_cmdstan_csv.html;man/cmdstanr-package.Rd;man/read_cmdstan_csv.Rd,False,True,True,False,425,76,501,"---FILE: R/cmdstanr-package.R---
@@ -1,4 +1,4 @@
-#' CmdStanR: the \R interface to CmdStan
+#' CmdStanR: the R interface to CmdStan
 #'
 #' @docType package
 #' @name cmdstanr-package

---FILE: R/read_csv.R---
@@ -1,4 +1,4 @@
-#' Read CmdStan CSV files into \R
+#' Read CmdStan CSV files into R
 #'
 #' `read_cmdstan_csv()` is used internally by CmdStanR to read CmdStan's output
 #' CSV files into \R. It can also be used by CmdStan users as a more flexible
@@ -38,8 +38,8 @@
 #' * `warmup_sampler_diagnostics`:  If `save_warmup` was `TRUE` when fitting the
 #' model then a [`draws_array`][posterior::draws_array] of warmup draws of the
 #' sampler diagnostic variables.
-#' * `sampler_diagnostics`: A [`draws_array`][posterior::draws_array] of
-#' post-warmup draws of the sampler diagnostic variables.
+#' * `post_warmup_sampler_diagnostics`: A [`draws_array`][posterior::draws_array]
+#' of post-warmup draws of the sampler diagnostic variables.
 #'
 #' For [optimization][model-method-optimize] the returned list also includes the
 #' following components:

---FILE: docs/reference/cmdstanr-package.html---
@@ -6,7 +6,7 @@
 <meta http-equiv=""X-UA-Compatible"" content=""IE=edge"">
 <meta name=""viewport"" content=""width=device-width, initial-scale=1.0"">
 
-<title>CmdStanR: the <span style=""R"">R</span> interface to CmdStan  cmdstanr-package  cmdstanr</title>
+<title>CmdStanR: the R interface to CmdStan  cmdstanr-package  cmdstanr</title>
 
 <!-- favicons -->
 <link rel=""icon"" type=""image/png"" sizes=""16x16"" href=""../favicon-16x16.png"">
@@ -46,7 +46,7 @@
 
 
 
-<meta property=""og:title"" content=""CmdStanR: the <span style=""R"">R</span> interface to CmdStan  cmdstanr-package"" />
+<meta property=""og:title"" content=""CmdStanR: the R interface to CmdStan  cmdstanr-package"" />
 <meta property=""og:description"" content=""
    Stan Development Team
 CmdStanR: the R interface to CmdStan."" />
@@ -169,7 +169,7 @@
 <div class=""row"">
   <div class=""col-md-9 contents"">
     <div class=""page-header"">
-    <h1>CmdStanR: the <span style=""R"">R</span> interface to CmdStan</h1>
+    <h1>CmdStanR: the R interface to CmdStan</h1>
     <small class=""dont-index"">Source: <a href='https://github.com/stan-dev/cmdstanr/blob/master/R/cmdstanr-package.R'><code>R/cmdstanr-package.R</code></a></small>
     <div class=""hidden name""><code>cmdstanr-package.Rd</code></div>
     </div>
@@ -231,9 +231,10 @@ <h2 class=""hasAnchor"" id=""see-also""><a class=""anchor"" href=""#see-also""></a>See a
     <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examples</h2>
     <pre class=""examples""><div class='input'><span class='co'># \dontrun{</span>
 <span class='fu'><a href='https://rdrr.io/r/base/library.html'>library</a></span>(<span class='no'>cmdstanr</span>)
-<span class='fu'><a href='https://rdrr.io/r/base/library.html'>library</a></span>(<span class='no'>posterior</span>)
-<span class='fu'><a href='https://rdrr.io/r/base/library.html'>library</a></span>(<span class='no'>bayesplot</span>)
-<span class='fu'><a href='https://mc-stan.org/bayesplot/reference/bayesplot-colors.html'>color_scheme_set</a></span>(<span class='st'>""brightblue""</span>)
+<span class='fu'><a href='https://rdrr.io/r/base/library.html'>library</a></span>(<span class='no'>posterior</span>)</div><div class='output co'>#&gt; <span class='message'>This is posterior version 0.1.0</span></div><div class='input'><span class='fu'><a href='https://rdrr.io/r/base/library.html'>library</a></span>(<span class='no'>bayesplot</span>)</div><div class='output co'>#&gt; <span class='message'>This is bayesplot version 1.7.2.9000</span></div><div class='output co'>#&gt; <span class='message'>- Online documentation and vignettes at mc-stan.org/bayesplot</span></div><div class='output co'>#&gt; <span class='message'>- bayesplot theme set to bayesplot::theme_default()</span></div><div class='output co'>#&gt; <span class='message'>   * Does _not_ affect other ggplot2 plots</span></div><div class='output co'>#&gt; <span class='message'>   * See ?bayesplot_theme_set for details on theme setting</span></div><div class='output co'>#&gt; <span class='message'></span>
+#&gt; <span class='message'>Attaching package: bayesplot</span></div><div class='output co'>#&gt; <span class='message'>The following object is masked from package:posterior:</span>
+#&gt; <span class='message'></span>
+#&gt; <span class='message'>    rhat</span></div><div class='input'><span class='fu'><a href='https://mc-stan.org/bayesplot/reference/bayesplot-colors.html'>color_scheme_set</a></span>(<span class='st'>""brightblue""</span>)
 
 <span class='co'># Set path to cmdstan</span>
 <span class='co'># (Note: if you installed CmdStan via install_cmdstan() with default settings</span>
@@ -266,18 +267,6 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
   <span class='kw'>parallel_chains</span> <span class='kw'>=</span> <span class='fl'>2</span>
 )</div><div class='output co'>#&gt; Running MCMC with 2 parallel chains...
 #&gt; 
-#&gt; Running ./bernoulli 'id=1' random 'seed=123' data \
-#&gt;   'file=/var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpahDDBq/standata-c93933e5ccb.json' \
-#&gt;   output \
-#&gt;   'file=/var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpahDDBq/bernoulli-202006202308-1-3e1516.csv' \
-#&gt;   'method=sample' 'save_warmup=0' 'algorithm=hmc' 'engine=nuts' adapt \
-#&gt;   'engaged=1'
-#&gt; Running ./bernoulli 'id=2' random 'seed=124' data \
-#&gt;   'file=/var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpahDDBq/standata-c93933e5ccb.json' \
-#&gt;   output \
-#&gt;   'file=/var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpahDDBq/bernoulli-202006202308-2-3e1516.csv' \
-#&gt;   'method=sample' 'save_warmup=0' 'algorithm=hmc' 'engine=nuts' adapt \
-#&gt;   'engaged=1'
 #&gt; Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup) 
 #&gt; Chain 1 Iteration:  100 / 2000 [  5%]  (Warmup) 
 #&gt; Chain 1 Iteration:  200 / 2000 [ 10%]  (Warmup) 
@@ -327,7 +316,7 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; 
 #&gt; Both chains finished successfully.
 #&gt; Mean chain execution time: 0.1 seconds.
-#&gt; Total execution time: 0.1 seconds.</div><div class='input'>
+#&gt; Total execution time: 0.2 seconds.</div><div class='input'>
 <span class='co'># Use 'posterior' package for summaries</span>
 <span class='no'>fit_mcmc</span>$<span class='fu'><a href='fit-method-summary.html'>summary</a></span>()</div><div class='output co'>#&gt; <span style='color: #949494;'># A tibble: 2 x 10</span><span>
 #&gt;   variable   mean median    sd   mad      q5    q95  rhat ess_bulk ess_tail
@@ -377,9 +366,9 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 <span class='fu'><a href='https://mc-stan.org/bayesplot/reference/MCMC-distributions.html'>mcmc_hist</a></span>(<span class='no'>fit_mcmc</span>$<span class='fu'><a href='fit-method-draws.html'>draws</a></span>(<span class='st'>""theta""</span>))</div><div class='output co'>#&gt; <span class='message'>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</span></div><div class='img'><img src='cmdstanr-package-1.png' alt='' width='700' height='433' /></div><div class='input'>
 <span class='co'># Call CmdStan's diagnose and stansummary utilities</span>
 <span class='no'>fit_mcmc</span>$<span class='fu'><a href='fit-method-cmdstan_summary.html'>cmdstan_diagnose</a></span>()</div><div class='output co'>#&gt; Running bin/diagnose \
-#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpahDDBq/bernoulli-202006202308-1-3e1516.csv \
-#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpahDDBq/bernoulli-202006202308-2-3e1516.csv
-#&gt; Processing csv files: /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpahDDBq/bernoulli-202006202308-1-3e1516.csv, /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpahDDBq/bernoulli-202006202308-2-3e1516.csv
+#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpEWAtYP/bernoulli-202006270115-1-57bde3.csv \
+#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpEWAtYP/bernoulli-202006270115-2-57bde3.csv
+#&gt; Processing csv files: /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpEWAtYP/bernoulli-202006270115-1-57bde3.csv, /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpEWAtYP/bernoulli-202006270115-2-57bde3.csv
 #&gt; 
 #&gt; Checking sampler transitions treedepth.
 #&gt; Treedepth satisfactory for all transitions.
@@ -395,23 +384,23 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; Split R-hat values satisfactory all parameters.
 #&gt; 
 #&gt; Processing complete, no problems detected.</div><div class='input'><span class='no'>fit_mcmc</span>$<span class='fu'><a href='fit-method-cmdstan_summary.html'>cmdstan_summary</a></span>()</div><div class='output co'>#&gt; Running bin/stansummary \
-#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpahDDBq/bernoulli-202006202308-1-3e1516.csv \
-#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpahDDBq/bernoulli-202006202308-2-3e1516.csv
+#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpEWAtYP/bernoulli-202006270115-1-57bde3.csv \
+#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpEWAtYP/bernoulli-202006270115-2-57bde3.csv
 #&gt; Inference for Stan model: bernoulli_model
 #&gt; 2 chains: each with iter=(1000,1000); warmup=(0,0); thin=(1,1); 2000 iterations saved.
 #&gt; 
-#&gt; Warmup took (0.0078, 0.0078) seconds, 0.016 seconds total
-#&gt; Sampling took (0.017, 0.016) seconds, 0.034 seconds total
+#&gt; Warmup took (0.0061, 0.0061) seconds, 0.012 seconds total
+#&gt; Sampling took (0.014, 0.013) seconds, 0.027 seconds total
 #&gt; 
 #&gt;                 Mean     MCSE  StdDev     5%   50%   95%    N_Eff  N_Eff/s    R_hat
-#&gt; lp__            -7.3  3.1e-02    0.74   -8.8  -7.0  -6.8  5.9e+02  1.7e+04  1.0e+00
-#&gt; accept_stat__   0.92  5.0e-03    0.14   0.61  0.97   1.0  7.3e+02  2.2e+04  1.0e+00
-#&gt; stepsize__       1.0  9.0e-02   0.090   0.93   1.1   1.1  1.0e+00  3.0e+01  2.6e+13
-#&gt; treedepth__      1.4  1.2e-02    0.52    1.0   1.0   2.0  1.9e+03  5.5e+04  1.0e+00
-#&gt; n_leapfrog__     2.6  4.0e-01     1.5    1.0   3.0   7.0  1.4e+01  4.2e+02  1.0e+00
+#&gt; lp__            -7.3  3.1e-02    0.74   -8.8  -7.0  -6.8  5.9e+02  2.2e+04  1.0e+00
+#&gt; accept_stat__   0.92  5.0e-03    0.14   0.61  0.97   1.0  7.3e+02  2.8e+04  1.0e+00
+#&gt; stepsize__       1.0  9.0e-02   0.090   0.93   1.1   1.1  1.0e+00  3.8e+01  2.6e+13
+#&gt; treedepth__      1.4  1.2e-02    0.52    1.0   1.0   2.0  1.9e+03  7.0e+04  1.0e+00
+#&gt; n_leapfrog__     2.6  4.0e-01     1.5    1.0   3.0   7.0  1.4e+01  5.3e+02  1.0e+00
 #&gt; divergent__     0.00      nan    0.00   0.00  0.00  0.00      nan      nan      nan
-#&gt; energy__         7.8  4.0e-02     1.0    6.8   7.4  10.0  6.9e+02  2.0e+04  1.0e+00
-#&gt; theta           0.25  4.5e-03    0.12  0.081  0.23  0.49  7.6e+02  2.2e+04  1.0e+00
+#&gt; energy__         7.8  4.0e-02     1.0    6.8   7.4  10.0  6.9e+02  2.6e+04  1.0e+00
+#&gt; theta           0.25  4.5e-03    0.12  0.081  0.23  0.49  7.6e+02  2.8e+04  1.0e+00
 #&gt; 
 #&gt; Samples were drawn using hmc with nuts.
 #&gt; For each parameter, N_Eff is a crude measure of effective sample size,
@@ -420,30 +409,14 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; </div><div class='input'>
 <span class='co'># For models fit using MCMC, if you like working with RStan's stanfit objects</span>
 <span class='co'># then you can create one with rstan::read_stan_csv()</span>
-<span class='kw'>if</span> (<span class='fu'><a href='https://rdrr.io/r/base/library.html'>require</a></span>(<span class='no'>rstan</span>, <span class='kw'>quietly</span> <span class='kw'>=</span> <span class='fl'>TRUE</span>)) {
-  <span class='no'>stanfit</span> <span class='kw'>&lt;-</span> <span class='kw pkg'>rstan</span><span class='kw ns'>::</span><span class='fu'><a href='https://rdrr.io/pkg/rstan/man/stan_csv.html'>read_stan_csv</a></span>(<span class='no'>fit_mcmc</span>$<span class='fu'><a href='fit-method-save_output_files.html'>output_files</a></span>())
-  <span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span>(<span class='no'>stanfit</span>)
-}</div><div class='output co'>#&gt; Inference for Stan model: bernoulli-202006202308-1-3e1516.
-#&gt; 2 chains, each with iter=2000; warmup=1000; thin=1; 
-#&gt; post-warmup draws per chain=1000, total post-warmup draws=2000.
-#&gt; 
-#&gt;        mean se_mean   sd  2.5%   25%   50%   75% 97.5% n_eff Rhat
-#&gt; theta  0.25    0.00 0.12  0.06  0.16  0.23  0.33  0.53   754    1
-#&gt; lp__  -7.28    0.03 0.74 -9.50 -7.45 -7.00 -6.80 -6.75   586    1
-#&gt; 
-#&gt; Samples were drawn using NUTS(diag_e) at Sat Jun 20 23:08:21 2020.
-#&gt; For each parameter, n_eff is a crude measure of effective sample size,
-#&gt; and Rhat is the potential scale reduction factor on split chains (at 
-#&gt; convergence, Rhat=1).</div><div class='input'>
+
+<span class='co'># stanfit &lt;- rstan::read_stan_csv(fit_mcmc$output_files())</span>
+
+
 <span class='co'># Run 'optimize' method to get a point estimate (default is Stan's LBFGS algorithm)</span>
 <span class='co'># and also demonstrate specifying data as a path to a file instead of a list</span>
 <span class='no'>my_data_file</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/file.path.html'>file.path</a></span>(<span class='fu'><a href='set_cmdstan_path.html'>cmdstan_path</a></span>(), <span class='st'>""examples/bernoulli/bernoulli.data.json""</span>)
-<span class='no'>fit_optim</span> <span class='kw'>&lt;-</span> <span class='no'>mod</span>$<span class='fu'><a href='model-method-optimize.html'>optimize</a></span>(<span class='kw'>data</span> <span class='kw'>=</span> <span class='no'>my_data_file</span>, <span class='kw'>seed</span> <span class='kw'>=</span> <span class='fl'>123</span>)</div><div class='output co'>#&gt; Running ./bernoulli 'id=1' random 'seed=123' data \
-#&gt;   'file=/Users/jgabry/.cmdstanr/cmdstan-2.23.0/examples/bernoulli/bernoulli.data.json' \
-#&gt;   output \
-#&gt;   'file=/var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpahDDBq/bernoulli-202006202308-1-da9275.csv' \
-#&gt;   'method=optimize'
-#&gt; method = optimize 
+<span class='no'>fit_optim</span> <span class='kw'>&lt;-</span> <span class='no'>mod</span>$<span class='fu'><a href='model-method-optimize.html'>optimize</a></span>(<span class='kw'>data</span> <span class='kw'>=</span> <span class='no'>my_data_file</span>, <span class='kw'>seed</span> <span class='kw'>=</span> <span class='fl'>123</span>)</div><div class='output co'>#&gt; method = optimize 
 #&gt;   optimize 
 #&gt;     algorithm = lbfgs (Default) 
 #&gt;       lbfgs 
@@ -463,7 +436,7 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; random 
 #&gt;   seed = 123 
 #&gt; output 
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpahDDBq/bernoulli-202006202308-1-da9275.csv 
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpEWAtYP/bernoulli-202006270115-1-739a5d.csv 
 #&gt;   diagnostic_file =  (Default) 
 #&gt;   refresh = 100 (Default) 
 #&gt;  
@@ -479,12 +452,7 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; </span><span style='color: #BCBCBC;'>1</span><span> lp__        -</span><span style='color: #BB0000;'>5.00</span><span>
 #&gt; </span><span style='color: #BCBCBC;'>2</span><span> theta        0.2 </div><div class='input'>
 <span class='co'># Run 'variational' to approximate the posterior (default is meanfield ADVI)</span>
-<span class='no'>fit_vb</span> <span class='kw'>&lt;-</span> <span class='no'>mod</span>$<span class='fu'><a href='model-method-variational.html'>variational</a></span>(<span class='kw'>data</span> <span class='kw'>=</span> <span class='no'>stan_data</span>, <span class='kw'>seed</span> <span class='kw'>=</span> <span class='fl'>123</span>)</div><div class='output co'>#&gt; Running ./bernoulli 'id=1' random 'seed=123' data \
-#&gt;   'file=/var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpahDDBq/standata-c9391dc57935.json' \
-#&gt;   output \
-#&gt;   'file=/var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpahDDBq/bernoulli-202006202308-1-9895d8.csv' \
-#&gt;   'method=variational'
-#&gt; method = variational 
+<span class='no'>fit_vb</span> <span class='kw'>&lt;-</span> <span class='no'>mod</span>$<span class='fu'><a href='model-method-variational.html'>variational</a></span>(<span class='kw'>data</span> <span class='kw'>=</span> <span class='no'>stan_data</span>, <span class='kw'>seed</span> <span class='kw'>=</span> <span class='fl'>123</span>)</div><div class='output co'>#&gt; method = variational 
 #&gt;   variational 
 #&gt;     algorithm = meanfield (Default) 
 #&gt;       meanfield 
@@ -500,12 +468,12 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt;     output_samples = 1000 (Default) 
 #&gt; id = 1 
 #&gt; data 
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpahDDBq/standata-c9391dc57935.json 
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpEWAtYP/standata-3725649b64ed.json 
 #&gt; init = 2 (Default) 
 #&gt; random 
 #&gt;   seed = 123 
 #&gt; output 
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpahDDBq/bernoulli-202006202308-1-9895d8.csv 
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpEWAtYP/bernoulli-202006270115-1-ff3735.csv 
 #&gt;   diagnostic_file =  (Default) 
 #&gt;   refresh = 100 (Default) 
 #&gt;  
@@ -517,8 +485,8 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt;  
 #&gt;  
 #&gt;  
-#&gt; Gradient evaluation took 1.8e-05 seconds 
-#&gt; 1000 transitions using 10 leapfrog steps per transition would take 0.18 seconds. 
+#&gt; Gradient evaluation took 3.5e-05 seconds 
+#&gt; 1000 transitions using 10 leapfrog steps per transition would take 0.35 seconds. 
 #&gt; Adjust your expectations accordingly! 
 #&gt;  
 #&gt;  

---FILE: docs/reference/index.html---
@@ -194,7 +194,7 @@ <h2 id=""section-package-description"" class=""hasAnchor""><a href=""#section-package
         <td>
           <p><code><a href=""cmdstanr-package.html"">cmdstanr-package</a></code> </p>
         </td>
-        <td><p>CmdStanR: the <span style=""R"">R</span> interface to CmdStan</p></td>
+        <td><p>CmdStanR: the R interface to CmdStan</p></td>
       </tr>
     </tbody><tbody>
       <tr>
@@ -376,9 +376,9 @@ <h2 id=""section-other-tools-for-working-with-cmdstan"" class=""hasAnchor""><a href=
       <tr>
         
         <td>
-          <p><code><a href=""read_sample_csv.html"">read_sample_csv()</a></code> </p>
+          <p><code><a href=""read_cmdstan_csv.html"">read_cmdstan_csv()</a></code> </p>
         </td>
-        <td><p>Read CmdStan CSV files into <span style=""R"">R</span></p></td>
+        <td><p>Read CmdStan CSV files into R</p></td>
       </tr><tr>
         
         <td>

---FILE: docs/reference/read_cmdstan_csv.html---
@@ -0,0 +1,381 @@
+<!-- Generated by pkgdown: do not edit by hand -->
+<!DOCTYPE html>
+<html lang=""en"">
+  <head>
+  <meta charset=""utf-8"">
+<meta http-equiv=""X-UA-Compatible"" content=""IE=edge"">
+<meta name=""viewport"" content=""width=device-width, initial-scale=1.0"">
+
+<title>Read CmdStan CSV files into R  read_cmdstan_csv  cmdstanr</title>
+
+<!-- favicons -->
+<link rel=""icon"" type=""image/png"" sizes=""16x16"" href=""../favicon-16x16.png"">
+<link rel=""icon"" type=""image/png"" sizes=""32x32"" href=""../favicon-32x32.png"">
+<link rel=""apple-touch-icon"" type=""image/png"" sizes=""180x180"" href=""../apple-touch-icon.png"" />
+<link rel=""apple-touch-icon"" type=""image/png"" sizes=""120x120"" href=""../apple-touch-icon-120x120.png"" />
+<link rel=""apple-touch-icon"" type=""image/png"" sizes=""76x76"" href=""../apple-touch-icon-76x76.png"" />
+<link rel=""apple-touch-icon"" type=""image/png"" sizes=""60x60"" href=""../apple-touch-icon-60x60.png"" />
+
+<!-- jquery -->
+<script src=""https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"" integrity=""sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="" crossorigin=""anonymous""></script>
+<!-- Bootstrap -->
+<link href=""https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css"" rel=""stylesheet"" crossorigin=""anonymous"" />
+
+
+<script src=""https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js"" integrity=""sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4="" crossorigin=""anonymous""></script>
+
+<!-- bootstrap-toc -->
+<link rel=""stylesheet"" href=""../bootstrap-toc.css"">
+<script src=""../bootstrap-toc.js""></script>
+
+<!-- Font Awesome icons -->
+<link rel=""stylesheet"" href=""https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css"" integrity=""sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk="" crossorigin=""anonymous"" />
+<link rel=""stylesheet"" href=""https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css"" integrity=""sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw="" crossorigin=""anonymous"" />
+
+<!-- clipboard.js -->
+<script src=""https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js"" integrity=""sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI="" crossorigin=""anonymous""></script>
+
+<!-- headroom.js -->
+<script src=""https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js"" integrity=""sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0="" crossorigin=""anonymous""></script>
+<script src=""https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js"" integrity=""sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4="" crossorigin=""anonymous""></script>
+
+<!-- pkgdown -->
+<link href=""../pkgdown.css"" rel=""stylesheet"">
+<script src=""../pkgdown.js""></script>
+
+
+
+
+<meta property=""og:title"" content=""Read CmdStan CSV files into R  read_cmdstan_csv"" />
+<meta property=""og:description"" content=""read_cmdstan_csv() is used internally by CmdStanR to read CmdStan's output
+CSV files into R. It can also be used by CmdStan users as a more flexible
+and efficient alternative to rstan::read_stan_csv()."" />
+<meta property=""og:image"" content=""https://mc-stan.org/cmdstanr/logo.png"" />
+
+
+
+
+<!-- mathjax -->
+<script src=""https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js"" integrity=""sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k="" crossorigin=""anonymous""></script>
+<script src=""https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js"" integrity=""sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA="" crossorigin=""anonymous""></script>
+
+<!--[if lt IE 9]>
+<script src=""https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js""></script>
+<script src=""https://oss.maxcdn.com/respond/1.4.2/respond.min.js""></script>
+<![endif]-->
+
+
+
+  </head>
+
+  <body data-spy=""scroll"" data-target=""#toc"">
+    <div class=""container template-reference-topic"">
+      <header>
+      <div class=""navbar navbar-default navbar-fixed-top"" role=""navigation"">
+  <div class=""container"">
+    <div class=""navbar-header"">
+      <button type=""button"" class=""navbar-toggle collapsed"" data-toggle=""collapse"" data-target=""#navbar"" aria-expanded=""false"">
+        <span class=""sr-only"">Toggle navigation</span>
+        <span class=""icon-bar""></span>
+        <span class=""icon-bar""></span>
+        <span class=""icon-bar""></span>
+      </button>
+      <span class=""navbar-brand"">
+        <a class=""navbar-link"" href=""../index.html"">cmdstanr</a>
+        <span class=""version label label-danger"" data-toggle=""tooltip"" data-placement=""bottom"" title=""Unreleased version"">0.0.0.9006</span>
+      </span>
+    </div>
+
+    <div id=""navbar"" class=""navbar-collapse collapse"">
+      <ul class=""nav navbar-nav"">
+        <li>
+  <a href=""../index.html"">
+    <span class=""fa fa-home fa-lg""></span>
+     
+  </a>
+</li>
+<li>
+  <a href=""../articles/index.html"">Vignettes</a>
+</li>
+<li>
+  <a href=""../reference/index.html"">Functions</a>
+</li>
+<li class=""dropdown"">
+  <a href=""#"" class=""dropdown-toggle"" data-toggle=""dropdown"" role=""button"" aria-expanded=""false"">
+    Other Packages
+     
+    <span class=""caret""></span>
+  </a>
+  <ul class=""dropdown-menu"" role=""menu"">
+    <li>
+      <a href=""https://mc-stan.org/rstan"">rstan</a>
+    </li>
+    <li>
+      <a href=""https://mc-stan.org/rstanarm"">rstanarm</a>
+    </li>
+    <li>
+      <a href=""https://mc-stan.org/bayesplot"">bayesplot</a>
+    </li>
+    <li>
+      <a href=""https://mc-stan.org/shinystan"">shinystan</a>
+    </li>
+    <li>
+      <a href=""https://mc-stan.org/loo"">loo</a>
+    </li>
+    <li>
+      <a href=""https://mc-stan.org/projpred"">projpred</a>
+    </li>
+    <li>
+      <a href=""https://mc-stan.org/rstantools"">rstantools</a>
+    </li>
+    <li>
+      <a href=""https://mc-stan.org/posterior"">posterior</a>
+    </li>
+  </ul>
+</li>
+<li>
+  <a href=""https://mc-stan.org"">Stan</a>
+</li>
+      </ul>
+      <ul class=""nav navbar-nav navbar-right"">
+        <li>
+  <a href=""https://twitter.com/mcmc_stan"">
+    <span class=""fa fa-twitter""></span>
+     
+  </a>
+</li>
+<li>
+  <a href=""https://github.com/stan-dev/cmdstanr"">
+    <span class=""fa fa-github""></span>
+     
+  </a>
+</li>
+<li>
+  <a href=""https://discourse.mc-stan.org/"">
+    <span class=""fa fa-users""></span>
+     
+  </a>
+</li>
+      </ul>
+      
+    </div><!--/.nav-collapse -->
+  </div><!--/.container -->
+</div><!--/.navbar -->
+
+      
+
+      </header>
+
+<div class=""row"">
+  <div class=""col-md-9 contents"">
+    <div class=""page-header"">
+    <h1>Read CmdStan CSV files into R</h1>
+    <small class=""dont-index"">Source: <a href='https://github.com/stan-dev/cmdstanr/blob/master/R/read_csv.R'><code>R/read_csv.R</code></a></small>
+    <div class=""hidden name""><code>read_cmdstan_csv.Rd</code></div>
+    </div>
+
+    <div class=""ref-description"">
+    <p><code>read_cmdstan_csv()</code> is used internally by CmdStanR to read CmdStan's output
+CSV files into <span style=""R"">R</span>. It can also be used by CmdStan users as a more flexible
+and efficient alternative to <code><a href='https://rdrr.io/pkg/rstan/man/stan_csv.html'>rstan::read_stan_csv()</a></code>.</p>
+    </div>
+
+    <pre class=""usage""><span class='fu'>read_cmdstan_csv</span>(<span class='no'>files</span>, <span class='kw'>variables</span> <span class='kw'>=</span> <span class='kw'>NULL</span>, <span class='kw'>sampler_diagnostics</span> <span class='kw'>=</span> <span class='kw'>NULL</span>)</pre>
+
+    <h2 class=""hasAnchor"" id=""arguments""><a class=""anchor"" href=""#arguments""></a>Arguments</h2>
+    <table class=""ref-arguments"">
+    <colgroup><col class=""name"" /><col class=""desc"" /></colgroup>
+    <tr>
+      <th>files</th>
+      <td><p>A character vector of paths to the CSV files to read.</p></td>
+    </tr>
+    <tr>
+      <th>variables</th>
+      <td><p>Optionally, a character vector naming the variables
+(parameters, transformed parameters, and generated quantities) to read in.</p><ul>
+<li><p>If <code>NULL</code> (the default) then all variables are included.</p></li>
+<li><p>If an empty string (<code>variables=""""</code>) then none are included.</p></li>
+<li><p>For non-scalar variables all elements or specific elements can be selected:</p><ul>
+<li><p><code>variables = ""theta""</code> selects all elements of <code>theta</code>;</p></li>
+<li><p><code>variables = c(""theta[1]"", ""theta[3]"")</code> selects only the 1st and 3rd elements.</p></li>
+</ul></li>
+</ul></td>
+    </tr>
+    <tr>
+      <th>sampler_diagnostics</th>
+      <td><p>Works the same way as <code>variables</code> but for sampler
+diagnostic variables (e.g., <code>""treedepth__""</code>, <code>""accept_stat__""</code>, etc.).
+Ignored if the model was not fit using MCMC.</p></td>
+    </tr>
+    </table>
+
+    <h2 class=""hasAnchor"" id=""value""><a class=""anchor"" href=""#value""></a>Value</h2>
+
+    <p>A named list with the following components:</p><ul>
+<li><p><code>metadata</code>: A list of the meta information from the run that produced the
+CSV file(s). See <strong>Examples</strong> below.</p></li>
+</ul>
+
+<p>The other components in the returned list depend on the method that produced
+the CSV file(s).</p>
+<p>For <a href='model-method-sample.html'>sampling</a> the returned list
+also includes the following components:</p><ul>
+<li><p><code>inv_metric</code>: A list (one element per chain) of inverse mass matrices
+or their diagonals, depending on the type of metric used.</p></li>
+<li><p><code>step_size</code>: A list (one element per chain) of the step sizes used.</p></li>
+<li><p><code>warmup_draws</code>:  If <code>save_warmup</code> was <code>TRUE</code> when fitting the model then a
+<code><a href='https://mc-stan.org/posterior/reference/draws_array.html'>draws_array</a></code> of warmup draws.</p></li>
+<li><p><code>post_warmup_draws</code>: A <code><a href='https://mc-stan.org/posterior/reference/draws_array.html'>draws_array</a></code> of
+post-warmup draws.</p></li>
+<li><p><code>warmup_sampler_diagnostics</code>:  If <code>save_warmup</code> was <code>TRUE</code> when fitting the
+model then a <code><a href='https://mc-stan.org/posterior/reference/draws_array.html'>draws_array</a></code> of warmup draws of the
+sampler diagnostic variables.</p></li>
+<li><p><code>post_warmup_sampler_diagnostics</code>: A <code><a href='https://mc-stan.org/posterior/reference/draws_array.html'>draws_array</a></code>
+of post-warmup draws of the sampler diagnostic variables.</p></li>
+</ul>
+
+<p>For <a href='model-method-optimize.html'>optimization</a> the returned list also includes the
+following components:</p><ul>
+<li><p><code>point_estimates</code>: Point estimates for the model parameters.</p></li>
+</ul>
+
+<p>For <a href='model-method-variational.html'>variational inference</a> the returned list also
+includes the following components:</p><ul>
+<li><p><code>draws</code>: A <code><a href='https://mc-stan.org/posterior/reference/draws_matrix.html'>draws_matrix</a></code> of draws from the
+approximate posterior distribution.</p></li>
+</ul>
+
+
+    <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examples</h2>
+    <pre class=""examples""><div class='input'><span class='co'># \dontrun{</span>
+<span class='no'>stan_program</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/tempfile.html'>tempfile</a></span>(<span class='kw'>fileext</span><span class='kw'>=</span><span class='st'>"".stan""</span>)
+<span class='fu'><a href='https://rdrr.io/r/base/cat.html'>cat</a></span>(<span class='st'>""
+parameters {
+  real alpha_scalar;
+  vector[2] theta_vector;
+  matrix[2,2] tau_matrix;
+}
+model {
+  alpha_scalar ~ std_normal();
+  theta_vector ~ std_normal();
+  to_vector(tau_matrix) ~ std_normal();
+}
+""</span>, <span class='kw'>file</span> <span class='kw'>=</span> <span class='no'>stan_program</span>)
+
+<span class='co'># only using capture.output to avoid too much printed output in example</span>
+<span class='no'>out</span> <span class='kw'>&lt;-</span> <span class='kw pkg'>utils</span><span class='kw ns'>::</span><span class='fu'><a href='https://rdrr.io/r/utils/capture.output.html'>capture.output</a></span>(
+  <span class='no'>mod</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='cmdstan_model.html'>cmdstan_model</a></span>(<span class='no'>stan_program</span>),
+  <span class='no'>fit</span> <span class='kw'>&lt;-</span> <span class='no'>mod</span>$<span class='fu'><a href='model-method-sample.html'>sample</a></span>(<span class='kw'>save_warmup</span><span class='kw'>=</span><span class='fl'>TRUE</span>)
+)</div><div class='output co'>#&gt; <span class='message'>Compiling Stan program...</span></div><div class='input'>
+<span class='co'># Read in everything</span>
+<span class='no'>x</span> <span class='kw'>&lt;-</span> <span class='fu'>read_cmdstan_csv</span>(<span class='no'>fit</span>$<span class='fu'><a href='fit-method-save_output_files.html'>output_files</a></span>())
+<span class='fu'><a href='https://rdrr.io/r/utils/str.html'>str</a></span>(<span class='no'>x</span>)</div><div class='output co'>#&gt; List of 7
+#&gt;  $ metadata                       :List of 30
+#&gt;   ..$ stan_version_major  : num 2
+#&gt;   ..$ stan_version_minor  : num 23
+#&gt;   ..$ stan_version_patch  : num 0
+#&gt;   ..$ method              : chr ""sample""
+#&gt;   ..$ save_warmup         : num 1
+#&gt;   ..$ thin                : num 1
+#&gt;   ..$ gamma               : num 0.05
+#&gt;   ..$ kappa               : num 0.75
+#&gt;   ..$ t0                  : num 10
+#&gt;   ..$ init_buffer         : num 75
+#&gt;   ..$ term_buffer         : num 50
+#&gt;   ..$ window              : num 25
+#&gt;   ..$ algorithm           : chr ""hmc""
+#&gt;   ..$ engine              : chr ""nuts""
+#&gt;   ..$ metric              : chr ""diag_e""
+#&gt;   ..$ stepsize_jitter     : num 0
+#&gt;   ..$ id                  : num [1:4] 1 2 3 4
+#&gt;   ..$ init                : num 2
+#&gt;   ..$ seed                : num [1:4] 1.67e+09 1.25e+09 1.01e+09 2.06e+09
+#&gt;   ..$ refresh             : num 100
+#&gt;   ..$ model_params        : chr [1:8] ""lp__"" ""alpha_scalar"" ""theta_vector[1]"" ""theta_vector[2]"" ...
+#&gt;   ..$ sampler_diagnostics : chr [1:6] ""accept_stat__"" ""stepsize__"" ""treedepth__"" ""n_leapfrog__"" ...
+#&gt;   ..$ model_name          : chr ""file372528de0950_model""
+#&gt;   ..$ adapt_engaged       : num 1
+#&gt;   ..$ adapt_delta         : num 0.8
+#&gt;   ..$ max_treedepth       : num 10
+#&gt;   ..$ step_size           : num 1
+#&gt;   ..$ step_size_adaptation: num [1:4] 0.701 0.692 0.759 0.687
+#&gt;   ..$ iter_warmup         : num 1000
+#&gt;   ..$ iter_sampling       : num 1000
+#&gt;  $ inv_metric                     :List of 4
+#&gt;   ..$ : num [1:7] 1.001 1.076 0.996 0.886 1.113 ...
+#&gt;   ..$ : num [1:7] 0.884 0.986 0.916 1.014 0.943 ...
+#&gt;   ..$ : num [1:7] 0.928 0.889 1.069 1.153 1.052 ...
+#&gt;   ..$ : num [1:7] 0.89 1.179 1.148 0.926 0.879 ...
+#&gt;  $ step_size                      :List of 4
+#&gt;   ..$ : num 0.701
+#&gt;   ..$ : num 0.692
+#&gt;   ..$ : num 0.759
+#&gt;   ..$ : num 0.687
+#&gt;  $ warmup_draws                   : 'draws_array' num [1:1000, 1:4, 1:8] -6.39 -6.39 -6.39 -5.12 -6.04 ...
+#&gt;   ..- attr(*, ""dimnames"")=List of 3
+#&gt;   .. ..$ iteration: chr [1:1000] ""1"" ""2"" ""3"" ""4"" ...
+#&gt;   .. ..$ chain    : chr [1:4] ""1"" ""2"" ""3"" ""4""
+#&gt;   .. ..$ variable : chr [1:8] ""lp__"" ""alpha_scalar"" ""theta_vector[1]"" ""theta_vector[2]"" ...
+#&gt;  $ post_warmup_draws              : 'draws_array' num [1:1000, 1:4, 1:8] -3.97 -2.41 -3.78 -3.52 -3.88 ...
+#&gt;   ..- attr(*, ""dimnames"")=List of 3
+#&gt;   .. ..$ iteration: chr [1:1000] ""1"" ""2"" ""3"" ""4"" ...
+#&gt;   .. ..$ chain    : chr [1:4] ""1"" ""2"" ""3"" ""4""
+#&gt;   .. ..$ variable : chr [1:8] ""lp__"" ""alpha_scalar"" ""theta_vector[1]"" ""theta_vector[2]"" ...
+#&gt;  $ warmup_sampler_diagnostics     : 'draws_array' num [1:1000, 1:4, 1:6] 9.68e-01 0.00 1.62e-05 9.89e-01 9.94e-01 ...
+#&gt;   ..- attr(*, ""dimnames"")=List of 3
+#&gt;   .. ..$ iteration: chr [1:1000] ""1"" ""2"" ""3"" ""4"" ...
+#&gt;   .. ..$ chain    : chr [1:4] ""1"" ""2"" ""3"" ""4""
+#&gt;   .. ..$ variable : chr [1:6] ""accept_stat__"" ""stepsize__"" ""treedepth__"" ""n_leapfrog__"" ...
+#&gt;  $ post_warmup_sampler_diagnostics: 'draws_array' num [1:1000, 1:4, 1:6] 0.993 1 0.923 1 0.961 ...
+#&gt;   ..- attr(*, ""dimnames"")=List of 3
+#&gt;   .. ..$ iteration: chr [1:1000] ""1"" ""2"" ""3"" ""4"" ...
+#&gt;   .. ..$ chain    : chr [1:4] ""1"" ""2"" ""3"" ""4""
+#&gt;   .. ..$ variable : chr [1:6] ""accept_stat__"" ""stepsize__"" ""treedepth__"" ""n_leapfrog__"" ...</div><div class='input'>
+<span class='co'># Don't read in any of the sampler diagnostic variables</span>
+<span class='no'>x</span> <span class='kw'>&lt;-</span> <span class='fu'>read_cmdstan_csv</span>(<span class='no'>fit</span>$<span class='fu'><a href='fit-method-save_output_files.html'>output_files</a></span>(), <span class='kw'>sampler_diagnostics</span> <span class='kw'>=</span> <span class='st'>""""</span>)
+
+<span class='co'># Don't read in any of the parameters or generated quantities</span>
+<span class='no'>x</span> <span class='kw'>&lt;-</span> <span class='fu'>read_cmdstan_csv</span>(<span class='no'>fit</span>$<span class='fu'><a href='fit-method-save_output_files.html'>output_files</a></span>(), <span class='kw'>variables</span> <span class='kw'>=</span> <span class='st'>""""</span>)
+
+<span class='co'># Read in only specific parameters and sampler diagnostics</span>
+<span class='no'>x</span> <span class='kw'>&lt;-</span> <span class='fu'>read_cmdstan_csv</span>(
+  <span class='no'>fit</span>$<span class='fu'><a href='fit-method-save_output_files.html'>output_files</a></span>(),
+  <span class='kw'>variables</span> <span class='kw'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span>(<span class='st'>""alpha_scalar""</span>, <span class='st'>""theta_vector[2]""</span>),
+  <span class='kw'>sampler_diagnostics</span> <span class='kw'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span>(<span class='st'>""n_leapfrog__""</span>, <span class='st'>""accept_stat__""</span>)
+)
+
+<span class='co'># For non-scalar parameters all elements can be selected or only some elements,</span>
+<span class='co'># e.g. all of ""theta_vector"" but only one element of ""tau_matrix""</span>
+<span class='no'>x</span> <span class='kw'>&lt;-</span> <span class='fu'>read_cmdstan_csv</span>(
+  <span class='no'>fit</span>$<span class='fu'><a href='fit-method-save_output_files.html'>output_files</a></span>(),
+  <span class='kw'>variables</span> <span class='kw'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span>(<span class='st'>""theta_vector""</span>, <span class='st'>""tau_matrix[2,1]""</span>)
+)
+<span class='co'># }</span></div></pre>
+  </div>
+  <div class=""col-md-3 hidden-xs hidden-sm"" id=""pkgdown-sidebar"">
+    <nav id=""toc"" data-toggle=""toc"" class=""sticky-top"">
+      <h2 data-toc-skip>Contents</h2>
+    </nav>
+  </div>
+</div>
+
+
+      <footer>
+      <div class=""copyright"">
+  <p>Developed by Jonah Gabry, Rok enovar.</p>
+</div>
+
+<div class=""pkgdown"">
+  <p>Site built with <a href=""https://pkgdown.r-lib.org/"">pkgdown</a> 1.5.1.</p>
+</div>
+
+      </footer>
+   </div>
+
+  
+
+
+  </body>
+</html>
+
+

---FILE: man/cmdstanr-package.Rd---
@@ -5,7 +5,7 @@
 \alias{cmdstanr-package}
 \alias{cmdstanr}
 \alias{CmdStanR}
-\title{CmdStanR: the \R interface to CmdStan}
+\title{CmdStanR: the R interface to CmdStan}
 \description{
 \if{html}{
    \figure{logo.png}{options: width=""50"" alt=""https://mc-stan.org/about/logo/""}

---FILE: man/read_cmdstan_csv.Rd---
@@ -2,7 +2,7 @@
 % Please edit documentation in R/read_csv.R
 \name{read_cmdstan_csv}
 \alias{read_cmdstan_csv}
-\title{Read CmdStan CSV files into \R}
+\title{Read CmdStan CSV files into R}
 \usage{
 read_cmdstan_csv(files, variables = NULL, sampler_diagnostics = NULL)
 }
@@ -48,8 +48,8 @@ post-warmup draws.
 \item \code{warmup_sampler_diagnostics}:  If \code{save_warmup} was \code{TRUE} when fitting the
 model then a \code{\link[posterior:draws_array]{draws_array}} of warmup draws of the
 sampler diagnostic variables.
-\item \code{sampler_diagnostics}: A \code{\link[posterior:draws_array]{draws_array}} of
-post-warmup draws of the sampler diagnostic variables.
+\item \code{post_warmup_sampler_diagnostics}: A \code{\link[posterior:draws_array]{draws_array}}
+of post-warmup draws of the sampler diagnostic variables.
 }
 
 For \link[=model-method-optimize]{optimization} the returned list also includes the",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,e4fedb7d6696ba08b70c872ecf7274767d222352,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-26T19:59:11Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-26T20:01:10Z,add processing output and catching failures,R/run.R,False,True,True,False,68,8,76,"---FILE: R/run.R---
@@ -327,7 +327,6 @@ CmdStanRun$set(""private"", name = ""run_sample_"", value = .run_sample)
         wd = dirname(self$exe_file())
       )
       procs$mark_proc_start(chain_id)
-      procs$set_proc_state(id = chain_id, new_state = 2) # active process
       procs$set_active_procs(procs$active_procs() + 1)
       chain_ind <- chain_ind + 1
     }
@@ -336,6 +335,15 @@ CmdStanRun$set(""private"", name = ""run_sample_"", value = .run_sample)
     while (procs$active_procs() == start_active_procs &&
            procs$active_procs() > 0) {
       procs$wait(0.1)
+      procs$poll(0)
+      for (chain_id in chains) {
+        if (!procs$is_queued(chain_id)) {
+          output <- procs$get_proc(chain_id)$read_output_lines()
+          procs$process_output(output, chain_id)
+          error_output <- procs$get_proc(chain_id)$read_error_lines()
+          procs$process_error_output(error_output, chain_id)
+        }
+      }
       procs$set_active_procs(procs$num_alive())
     }
     procs$check_finished()
@@ -377,7 +385,11 @@ CmdStanRun$set(""private"", name = ""run_generate_quantities_"", value = .run_genera
     }
     procs$set_active_procs(procs$num_alive())
   }
-  procs$set_proc_state(id = id, new_state = 5) # successful process
+  if (self$get_proc(id)$get_exit_status() == 0) {
+    self$set_proc_state(id = id, new_state = 5) # mark_proc_stop will mark this process successful
+  } else {
+    self$set_proc_state(id = id, new_state = 4) # mark_proc_stop will mark this process unsuccessful
+  }
   procs$mark_proc_stop(id)
   procs$set_total_time(as.double((Sys.time() - start_time), units = ""secs""))
   procs$report_time()
@@ -588,9 +600,13 @@ CmdStanProcs <- R6::R6Class(
       invisible(self)
     },
     report_time = function(id = NULL) {
-      cat(""Finished in "",
-              format(round(self$total_time(), 1), nsmall = 1),
-              ""seconds.\n"")
+      if (self$proc_state(id) == 7) {
+        warning(""Fitting finished unexpectedly!\n"", immediate. = TRUE, call. = FALSE)
+      } else {        
+        cat(""Finished in "",
+                format(round(self$total_time(), 1), nsmall = 1),
+                ""seconds.\n"")
+      }
     }
   ),
   private = list(
@@ -729,7 +745,7 @@ CmdStanMCMCProcs <- R6::R6Class(
 )
 
 CmdStanGQProcs <- R6::R6Class(
-  classname = ""CmdStanMCMCProcs"",
+  classname = ""CmdStanGQProcs"",
   inherit = CmdStanProcs,
   public = list(
     check_finished = function() {
@@ -738,29 +754,73 @@ CmdStanGQProcs <- R6::R6Class(
         if (self$is_still_working(id) && !self$is_queued(id) && !self$is_alive(id)) {
           # if the process just finished make sure we process all
           # input and mark the process finished
-          self$set_proc_state(id = id, new_state = 5) # all gq process are marked successful
+          if (self$get_proc(id)$get_exit_status() == 0) {
+            self$set_proc_state(id = id, new_state = 5) # mark_proc_stop will mark this process successful
+          } else {
+            self$set_proc_state(id = id, new_state = 4) # mark_proc_stop will mark this process unsuccessful
+          }          
           self$mark_proc_stop(id)
           self$report_time(id)
         }
       }
       invisible(self)
     },
     process_output = function(out, id) {
+      if (length(out) == 0) {
+        return(NULL)
+      }
+      for (line in out) {
+        private$proc_output_[[id]] <- c(private$proc_output_[[id]], line)
+        if (nzchar(line)) {
+          if (self$proc_state(id) == 1 && regexpr(""refresh = "", line, perl = TRUE) > 0) {
+            self$set_proc_state(id, new_state = 2)
+          } else if (self$proc_state(id) >= 2) {
+            cat(""Chain"", id, line, ""\n"")
+          }
+        }
+      }
       invisible(self)
     },
     report_time = function(id = NULL) {
       if (!is.null(id)) {
-        cat(""Chain"", id, ""finished in"", format(round(self$proc_total_time(id), 1), nsmall = 1), ""seconds.\n"")
+        if (self$proc_state(id) == 7) {
+          warning(""Chain "", id, "" finished unexpectedly!\n"", immediate. = TRUE, call. = FALSE)
+        } else {
+          cat(""Chain"", id, ""finished in"", format(round(self$proc_total_time(id), 1), nsmall = 1), ""seconds.\n"")
+        }        
         return(invisible(NULL))
       } else {
         num_chains <- self$num_procs()
         if (num_chains > 1) {
+          num_failed <- self$num_failed()
+          if (num_failed == 0) {
+            if (num_chains == 2) {
+              cat(""\nBoth chains finished successfully.\n"")
+            } else {
+              cat(""\nAll"", num_chains, ""chains finished successfully.\n"")
+            }
             cat(""Mean chain execution time:"",
                 format(round(mean(self$proc_total_time()), 1), nsmall = 1),
                 ""seconds.\n"")
             cat(""Total execution time:"",
                 format(round(self$total_time(), 1), nsmall = 1),
                 ""seconds.\n"")
+          } else if (num_failed == num_chains) {
+            warning(""All chains finished unexpectedly!\n"", call. = FALSE)
+            warning(""Use read_cmdstan_csv() to read the results of the failed chains."",
+                    immediate. = TRUE,
+                    call. = FALSE)
+          } else {
+            warning(num_failed, "" chain(s) finished unexpectedly!"",
+                    immediate. = TRUE,
+                    call. = FALSE)
+            cat(""The remaining chains had a mean execution time of"",
+                format(round(mean(self$total_time()), 1), nsmall = 1),
+                ""seconds.\n"")
+            warning(""The returned fit object will only read in results of succesful chains. Please use read_cmdstan_csv() to read the results of the failed chains separately."",
+                    immediate. = TRUE,
+                    call. = FALSE)
+          }
         }
         return(invisible(NULL))
       }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,840738ba996402703fe1db6959d7d220f8656f72,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-26T08:55:03Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-26T08:55:03Z,fix tests,tests/testthat/test-csv.R,False,True,True,False,3,3,6,"---FILE: tests/testthat/test-csv.R---
@@ -44,19 +44,19 @@ test_that(""read_cmdstan_csv() fails for different number of samples in csv"", {
   csv_files <- c(fit_logistic_thin_1$output_files(),
                  fit_logistic_thin_10$output_files())
   expect_error(read_cmdstan_csv(csv_files),
-               ""Supplied CSV files dont match in the number of stored samples!"")
+               ""Supplied CSV files dont match in the number of output samples!"")
   csv_files <- c(fit_logistic_thin_1$output_files(),
                  fit_logistic_thin_1a$output_files())
   expect_error(read_cmdstan_csv(csv_files),
-               ""Supplied CSV files dont match in the number of stored samples!"")
+               ""Supplied CSV files dont match in the number of output samples!"")
   csv_files <- c(fit_logistic_thin_1$output_files(),
                  fit_logistic_thin_1b$output_files())
   expect_warning(read_cmdstan_csv(csv_files),
                ""The supplied csv files do not match in the following arguments: iter_warmup"")
   csv_files <- c(fit_logistic_thin_1$output_files(),
                  fit_logistic_thin_1_with_warmup$output_files())
   expect_error(read_cmdstan_csv(csv_files),
-                 ""Supplied CSV files dont match in the number of stored samples!"")
+                 ""Supplied CSV files dont match in the number of output samples!"")
 })
 
 test_that(""read_cmdstan_csv() fails for different variables"", {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,cea295cf2d86011848c7708348113365b58bc456,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-25T13:34:57Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-25T13:34:57Z,"fix the bug that deletes saved output and latent dynamics files, added tests",R/run.R;tests/testthat/test-fit-shared.R,False,True,True,False,59,2,61,"---FILE: R/run.R---
@@ -76,6 +76,7 @@ CmdStanRun <- R6::R6Class(
       message(""Moved "", length(current_files),
               "" files and set internal paths to new locations:\n"",
               paste(""-"", new_paths, collapse = ""\n""))
+      private$output_files_saved_ <- TRUE
       invisible(new_paths)
     },
     save_latent_dynamics_files = function(dir = ""."",
@@ -97,6 +98,7 @@ CmdStanRun <- R6::R6Class(
       message(""Moved "", length(current_files),
               "" files and set internal paths to new locations:\n"",
               paste(""-"", new_paths, collapse = ""\n""))
+      private$latent_dynamics_files_saved_ <- TRUE
       invisible(new_paths)
     },
     save_data_file = function(dir = ""."",
@@ -192,14 +194,17 @@ CmdStanRun <- R6::R6Class(
   ),
   private = list(
     output_files_ = character(),
+    output_files_saved_ = FALSE,
     latent_dynamics_files_ = NULL,
+    latent_dynamics_files_saved_ = FALSE,
     command_args_ = list(),
 
     finalize = function() {
       if (self$args$using_tempdir) {
         temp_files <- c(
-          self$output_files(include_failed = TRUE),
-          if (self$args$save_latent_dynamics)
+          if (!private$output_files_saved_)
+            self$output_files(include_failed = TRUE),
+          if (self$args$save_latent_dynamics && !private$latent_dynamics_files_saved_)
             self$latent_dynamics_files(include_failed = TRUE)
         )
         unlink(temp_files)

---FILE: tests/testthat/test-fit-shared.R---
@@ -163,3 +163,55 @@ test_that(""metadata() returns list"", {
   }
 })
 
+test_that(""output and latent dynamics files are cleaned up correctly"", {
+  skip_on_cran()
+  for (method in c(""sample"", ""variational"")) {
+    fit <- testing_fit(""logistic"", method = method, seed = 123, save_latent_dynamics = TRUE)
+    out_files <- fit$output_files()
+    latent_dynamics_files <- fit$latent_dynamics_files()
+    expect_true(all(file.exists(out_files)))
+    expect_true(all(file.exists(latent_dynamics_files)))
+    rm(fit)
+    gc()
+    expect_true(!any(file.exists(out_files)))
+    expect_true(!any(file.exists(latent_dynamics_files)))
+
+    fit <- testing_fit(""logistic"", method = method, seed = 123, save_latent_dynamics = TRUE)
+    fit$save_output_files(dir = tempdir())
+    out_files <- fit$output_files()
+    latent_dynamics_files <- fit$latent_dynamics_files()
+    expect_true(all(file.exists(out_files)))
+    expect_true(all(file.exists(latent_dynamics_files)))
+    rm(fit)
+    gc()
+    expect_true(all(file.exists(out_files)))
+    expect_true(!any(file.exists(latent_dynamics_files)))
+    file.remove(out_files)
+
+    fit <- testing_fit(""logistic"", method = method, seed = 123, save_latent_dynamics = TRUE)
+    fit$save_latent_dynamics_files(dir = tempdir())
+    out_files <- fit$output_files()
+    latent_dynamics_files <- fit$latent_dynamics_files()
+    expect_true(all(file.exists(out_files)))
+    expect_true(all(file.exists(latent_dynamics_files)))
+    rm(fit)
+    gc()
+    expect_true(!any(file.exists(out_files)))
+    expect_true(all(file.exists(latent_dynamics_files)))
+    file.remove(latent_dynamics_files)
+
+    fit <- testing_fit(""logistic"", method = method, seed = 123, save_latent_dynamics = TRUE)
+    fit$save_output_files(dir = tempdir())
+    fit$save_latent_dynamics_files(dir = tempdir())
+    out_files <- fit$output_files()
+    latent_dynamics_files <- fit$latent_dynamics_files()
+    expect_true(all(file.exists(out_files)))
+    expect_true(all(file.exists(latent_dynamics_files)))
+    rm(fit)
+    gc()
+    expect_true(all(file.exists(out_files)))
+    expect_true(all(file.exists(latent_dynamics_files)))
+    file.remove(out_files)
+    file.remove(latent_dynamics_files)
+  }
+})",True,False,Implementation / Logic,6
stan-dev,cmdstanr,a51de2a3b33895da9a83f73fb3351ed58ba6f3c2,jgabry,jgabry@gmail.com,2020-06-24T22:50:00Z,jgabry,jgabry@gmail.com,2020-06-24T22:50:00Z,fix bug if specifying 'variables' with variational or optimize,R/read_csv.R;tests/testthat/test-csv.R,False,True,True,False,24,8,32,"---FILE: R/read_csv.R---
@@ -257,13 +257,14 @@ read_cmdstan_csv <- function(files,
         variational_draws <- posterior::as_draws_matrix(
           draws[-1, colnames(draws) != ""lp__"", drop=FALSE]
         )
-        variational_draws <- posterior::rename_variables(
-          variational_draws,
-          lp__ = ""log_p__"",
-          lp_approx__ = ""log_g__""
-        )
+        if (""log_p__"" %in% posterior::variables(variational_draws)) {
+          variational_draws <- posterior::rename_variables(variational_draws, lp__ = ""log_p__"")
+        }
+        if (""log_g__"" %in% posterior::variables(variational_draws)) {
+          variational_draws <- posterior::rename_variables(variational_draws, lp_approx__ = ""log_g__"")
+        }
       } else if (metadata$method == ""optimize"") {
-        point_estimates <- posterior::as_draws_matrix(draws[1,, drop=FALSE])
+        point_estimates <- posterior::as_draws_matrix(draws[1,, drop=FALSE])[, variables]
       }
     }
   }
@@ -298,8 +299,11 @@ read_cmdstan_csv <- function(files,
     metadata$model_params <- metadata$model_params[metadata$model_params != ""lp__""]
     metadata$model_params <- gsub(""log_p__"", ""lp__"", metadata$model_params)
     metadata$model_params <- gsub(""log_g__"", ""lp_approx__"", metadata$model_params)
+    repaired_variables <- repaired_variables[repaired_variables != ""lp__""]
+    repaired_variables <- gsub(""log_p__"", ""lp__"", repaired_variables)
+    repaired_variables <- gsub(""log_g__"", ""lp_approx__"", repaired_variables)
     if (!is.null(variational_draws)) {
-      posterior::variables(variational_draws) <- metadata$model_params
+      posterior::variables(variational_draws) <- repaired_variables
     }
     list(
       metadata = metadata,

---FILE: tests/testthat/test-csv.R---
@@ -52,7 +52,7 @@ test_that(""read_cmdstan_csv() fails for different number of samples in csv"", {
   csv_files <- c(fit_logistic_thin_1$output_files(),
                  fit_logistic_thin_1b$output_files())
   expect_warning(read_cmdstan_csv(csv_files),
-               ""The supplied csv files do not match in the following arguments: iter_warmup!"")
+               ""The supplied csv files do not match in the following arguments: iter_warmup"")
   csv_files <- c(fit_logistic_thin_1$output_files(),
                  fit_logistic_thin_1_with_warmup$output_files())
   expect_error(read_cmdstan_csv(csv_files),
@@ -388,6 +388,12 @@ test_that(""read_cmdstan_csv() works for optimize"", {
   csv_output_3 <- read_cmdstan_csv(csv_file)
   expect_equal(as.numeric(csv_output_3$point_estimates[1,""lp__""]), -12.2173)
   expect_equal(as.numeric(csv_output_3$point_estimates[1,""theta""]), 0.300001)
+
+  # variable filtering
+  csv_output_4 <- read_cmdstan_csv(fit_logistic_optimize$output_files(), variables = ""beta"")
+  expect_equal(posterior::variables(csv_output_4$point_estimates), c(""beta[1]"", ""beta[2]"", ""beta[3]""))
+  csv_output_5 <- read_cmdstan_csv(fit_logistic_optimize$output_files(), variables = c(""alpha"", ""lp__"", ""beta[2]""))
+  expect_equal(posterior::variables(csv_output_5$point_estimates), c(""alpha"", ""lp__"", ""beta[2]""))
 })
 
 
@@ -404,4 +410,10 @@ test_that(""read_cmdstan_csv() works for variational"", {
   expect_equal(as.numeric(csv_output_3$draws[1,""theta""]), 0.230751)
   expect_equal(dim(csv_output_3$draws), c(50, 3))
   expect_equal(csv_output_3$metadata$model_params, c(""lp__"", ""lp_approx__"", ""theta""))
+
+  # variable filtering
+  csv_output_4 <- read_cmdstan_csv(fit_logistic_variational$output_files(), variables = ""beta"")
+  expect_equal(posterior::variables(csv_output_4$draws), c(""beta[1]"", ""beta[2]"", ""beta[3]""))
+  csv_output_5 <- read_cmdstan_csv(fit_logistic_variational$output_files(), variables = c(""alpha"", ""beta[2]""))
+  expect_equal(posterior::variables(csv_output_5$draws), c(""alpha"", ""beta[2]""))
 })",True,False,Implementation / Logic,6
stan-dev,cmdstanr,c00655e999cd3c169bc26fdadfd0038b9bbdc1bc,jgabry,jgabry@gmail.com,2020-06-23T22:10:59Z,jgabry,jgabry@gmail.com,2020-06-23T22:10:59Z,fix bug in draws and sampler_diagnostics,R/fit.R;docs/articles/cmdstanr-internals.html;man/fit-method-save_object.Rd,False,True,True,False,72,67,139,"---FILE: R/fit.R---
@@ -166,9 +166,10 @@ CmdStanFit <- R6::R6Class(
 #'
 #' temp_rds_file <- tempfile(fileext = "".RDS"")
 #' fit$save_object(file = temp_rds_file)
-#'
 #' rm(fit)
+#'
 #' fit <- readRDS(temp_rds_file)
+#' fit$summary()
 #' }
 #'
 NULL
@@ -650,7 +651,7 @@ CmdStanMCMC <- R6::R6Class(
         all = private$sampling_info_$model_params
       )
 
-      if (is.null(to_read) || (length(to_read) > 0)) {
+      if (is.null(to_read) || any(nzchar(to_read))) {
         private$read_csv_(variables = to_read, sampler_diagnostics = """")
       }
       if (is.null(variables)) {
@@ -678,7 +679,7 @@ CmdStanMCMC <- R6::R6Class(
         currently_read = dimnames(private$sampler_diagnostics_)$variable,
         all = private$sampling_info_$sampler_diagnostics
       )
-      if (is.null(to_read) || (length(to_read) > 0)) {
+      if (is.null(to_read) || any(nzchar(to_read))) {
         private$read_csv_(variables = """", sampler_diagnostics = NULL)
       }
       if (inc_warmup) {

---FILE: docs/articles/cmdstanr-internals.html---
@@ -247,19 +247,19 @@ <h3 class=""hasAnchor"">
 <span class=""no"">fit</span> <span class=""kw"">&lt;-</span> <span class=""no"">mod</span>$<span class=""fu""><a href=""../reference/model-method-sample.html"">sample</a></span>(<span class=""kw"">data</span> <span class=""kw"">=</span> <span class=""no"">data_list</span>)</pre></body></html></div>
 <p>When fitting a model, the default behavior is to write the output from CmdStan to CSV files in a temporary directory:</p>
 <div class=""sourceCode"" id=""cb25""><html><body><pre class=""r""><span class=""no"">fit</span>$<span class=""fu""><a href=""../reference/fit-method-save_output_files.html"">output_files</a></span>()</pre></body></html></div>
-<pre><code>[1] ""/var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmplaARek/bernoulli-202006231743-1-9a44ba.csv""
-[2] ""/var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmplaARek/bernoulli-202006231743-2-9a44ba.csv""
-[3] ""/var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmplaARek/bernoulli-202006231743-3-9a44ba.csv""
-[4] ""/var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmplaARek/bernoulli-202006231743-4-9a44ba.csv""</code></pre>
+<pre><code>[1] ""/var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpRtIdGY/bernoulli-202006231807-1-ecaa20.csv""
+[2] ""/var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpRtIdGY/bernoulli-202006231807-2-ecaa20.csv""
+[3] ""/var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpRtIdGY/bernoulli-202006231807-3-ecaa20.csv""
+[4] ""/var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpRtIdGY/bernoulli-202006231807-4-ecaa20.csv""</code></pre>
 <p>These files will be lost if you end your R session or if you remove the <code>fit</code> object and force (or wait for) garbage collection.</p>
 <div class=""sourceCode"" id=""cb27""><html><body><pre class=""r""><span class=""no"">files</span> <span class=""kw"">&lt;-</span> <span class=""no"">fit</span>$<span class=""fu""><a href=""../reference/fit-method-save_output_files.html"">output_files</a></span>()
 <span class=""fu""><a href=""https://rdrr.io/r/base/files.html"">file.exists</a></span>(<span class=""no"">files</span>)</pre></body></html></div>
 <pre><code>[1] TRUE TRUE TRUE TRUE</code></pre>
 <div class=""sourceCode"" id=""cb29""><html><body><pre class=""r""><span class=""fu""><a href=""https://rdrr.io/r/base/rm.html"">rm</a></span>(<span class=""no"">fit</span>)
 <span class=""fu""><a href=""https://rdrr.io/r/base/gc.html"">gc</a></span>()</pre></body></html></div>
 <pre><code>          used (Mb) gc trigger (Mb) limit (Mb) max used (Mb)
-Ncells  913858 48.9    1821475 97.3         NA  1245481 66.6
-Vcells 1678927 12.9    8388608 64.0      16384  2517288 19.3</code></pre>
+Ncells  913849 48.9    1821450 97.3         NA  1245551 66.6
+Vcells 1678942 12.9    8388608 64.0      16384  2460758 18.8</code></pre>
 <div class=""sourceCode"" id=""cb31""><html><body><pre class=""r""><span class=""fu""><a href=""https://rdrr.io/r/base/files.html"">file.exists</a></span>(<span class=""no"">files</span>)</pre></body></html></div>
 <pre><code>[1] FALSE FALSE FALSE FALSE</code></pre>
 </div>
@@ -347,7 +347,7 @@ <h3 class=""hasAnchor"">
     summary: function (variables = NULL, ...) 
     time: function () 
   Private:
-    draws_: -8.54695 -6.76065 -7.09215 -6.76343 -6.76772 -6.75266 -7 ...
+    draws_: -6.76479 -6.92299 -7.21979 -7.66959 -6.92109 -7.26711 -6 ...
     inv_metric_: list
     read_csv_: function (variables = NULL, sampler_diagnostics = NULL) 
     sampler_diagnostics_: NULL
@@ -356,27 +356,11 @@ <h3 class=""hasAnchor"">
     warmup_sampler_diagnostics_: NULL </code></pre>
 <p>For models with many parameters, transformed parameters, or generated quantities, if only some are requested (e.g., by specifying the <code>variables</code> argument to <code>fit$draws()</code>) then CmdStanR will only read in the requested variables (unless they have already been read in).</p>
 </div>
-<div id=""saving-fitted-model-objects"" class=""section level3"">
-<h3 class=""hasAnchor"">
-<a href=""#saving-fitted-model-objects"" class=""anchor""></a>Saving fitted model objects</h3>
-<p>Because the contents of the CSV files are only read into R when they are needed, in order to save a fitted model object containing <em>all</em> of the posterior draws and sampler diagnostics you should either make sure to call <code>fit$draws()</code> and <code>fit$sampler_diagnostics()</code> before saving the object <code>fit</code>, or use the special <code>$save_object()</code> method provided by CmdStanR, which will ensure that everything has been read into R before saving the object using <code><a href=""https://rdrr.io/r/base/readRDS.html"">saveRDS()</a></code>:</p>
-<div class=""sourceCode"" id=""cb39""><html><body><pre class=""r""><span class=""no"">temp_rds_file</span> <span class=""kw"">&lt;-</span> <span class=""fu""><a href=""https://rdrr.io/r/base/tempfile.html"">tempfile</a></span>(<span class=""kw"">fileext</span> <span class=""kw"">=</span> <span class=""st"">"".RDS""</span>) <span class=""co""># temporary file just for demonstration</span>
-<span class=""no"">fit</span>$<span class=""fu""><a href=""../reference/fit-method-save_object.html"">save_object</a></span>(<span class=""kw"">file</span> <span class=""kw"">=</span> <span class=""no"">temp_rds_file</span>)</pre></body></html></div>
-<p>We can check that this worked by removing <code>fit</code> and loading it back in from the save file:</p>
-<div class=""sourceCode"" id=""cb40""><html><body><pre class=""r""><span class=""fu""><a href=""https://rdrr.io/r/base/rm.html"">rm</a></span>(<span class=""no"">fit</span>)
-<span class=""no"">fit</span> <span class=""kw"">&lt;-</span> <span class=""fu""><a href=""https://rdrr.io/r/base/readRDS.html"">readRDS</a></span>(<span class=""no"">temp_rds_file</span>)
-<span class=""no"">fit</span>$<span class=""fu""><a href=""../reference/fit-method-summary.html"">summary</a></span>()</pre></body></html></div>
-<pre><code># A tibble: 2 x 10
-  variable   mean median    sd   mad      q5    q95  rhat ess_bulk ess_tail
-  &lt;chr&gt;     &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
-1 lp__     -7.30  -7.03  0.763 0.376 -8.80   -6.75   1.00    1677.    1978.
-2 theta     0.250  0.234 0.123 0.128  0.0783  0.474  1.00    1391.    1756.</code></pre>
-</div>
 <div id=""read_sample_csv"" class=""section level3"">
 <h3 class=""hasAnchor"">
 <a href=""#read_sample_csv"" class=""anchor""></a>read_sample_csv()</h3>
 <p>Internally, the <code><a href=""../reference/read_sample_csv.html"">read_sample_csv()</a></code> function is used to read the CmdStan CSV files into R. This function is exposed to users, so you can also call it directly:</p>
-<div class=""sourceCode"" id=""cb42""><html><body><pre class=""r""><span class=""co""># see ?read_sample_csv for info on optional arguments controlling </span>
+<div class=""sourceCode"" id=""cb39""><html><body><pre class=""r""><span class=""co""># see ?read_sample_csv for info on optional arguments controlling </span>
 <span class=""co""># what information is read in</span>
 <span class=""no"">csv_contents</span> <span class=""kw"">&lt;-</span> <span class=""fu""><a href=""../reference/read_sample_csv.html"">read_sample_csv</a></span>(<span class=""no"">fit</span>$<span class=""fu""><a href=""../reference/fit-method-save_output_files.html"">output_files</a></span>())
 <span class=""fu""><a href=""https://rdrr.io/r/utils/str.html"">str</a></span>(<span class=""no"">csv_contents</span>)</pre></body></html></div>
@@ -400,11 +384,11 @@ <h3 class=""hasAnchor"">
   ..$ stepsize_jitter    : num 0
   ..$ id                 : num [1:4] 1 2 3 4
   ..$ init               : num 2
-  ..$ seed               : num [1:4] 4.40e+08 1.22e+09 1.30e+09 6.87e+08
+  ..$ seed               : num [1:4] 2.48e+08 1.13e+09 1.05e+09 1.18e+09
   ..$ refresh            : num 100
   ..$ model_params       : chr [1:2] ""lp__"" ""theta""
   ..$ sampler_diagnostics: chr [1:6] ""accept_stat__"" ""stepsize__"" ""treedepth__"" ""n_leapfrog__"" ...
-  ..$ stepsize_adaptation: num 1
+  ..$ stepsize_adaptation: num 1.03
   ..$ model_name         : chr ""bernoulli_model""
   ..$ adapt_engaged      : num 1
   ..$ adapt_delta        : num 0.8
@@ -414,23 +398,23 @@ <h3 class=""hasAnchor"">
   ..$ iter_sampling      : num 1000
   ..$ lines_to_skip      : num 38
  $ inv_metric                     :List of 4
-  ..$ : num 0.466
-  ..$ : num 0.54
-  ..$ : num 0.485
-  ..$ : num 0.498
+  ..$ : num 0.543
+  ..$ : num 0.551
+  ..$ : num 0.474
+  ..$ : num 0.49
  $ step_size                      :List of 4
-  ..$ : num 1
-  ..$ : num 0.75
-  ..$ : num 1.01
   ..$ : num 1.03
+  ..$ : num 0.951
+  ..$ : num 1.16
+  ..$ : num 0.912
  $ warmup_draws                   : NULL
- $ post_warmup_draws              : 'draws_array' num [1:1000, 1:4, 1:2] -8.55 -6.76 -7.09 -6.76 -6.77 ...
+ $ post_warmup_draws              : 'draws_array' num [1:1000, 1:4, 1:2] -6.76 -6.92 -7.22 -7.67 -6.92 ...
   ..- attr(*, ""dimnames"")=List of 3
   .. ..$ iteration: chr [1:1000] ""1"" ""2"" ""3"" ""4"" ...
   .. ..$ chain    : chr [1:4] ""1"" ""2"" ""3"" ""4""
   .. ..$ variable : chr [1:2] ""lp__"" ""theta""
  $ warmup_sampler_diagnostics     : NULL
- $ post_warmup_sampler_diagnostics: 'draws_array' num [1:1000, 1:4, 1:6] 0.738 0.878 0.95 0.99 0.996 ...
+ $ post_warmup_sampler_diagnostics: 'draws_array' num [1:1000, 1:4, 1:6] 0.788 0.966 0.977 0.972 1 ...
   ..- attr(*, ""dimnames"")=List of 3
   .. ..$ iteration: chr [1:1000] ""1"" ""2"" ""3"" ""4"" ...
   .. ..$ chain    : chr [1:4] ""1"" ""2"" ""3"" ""4""
@@ -441,40 +425,59 @@ <h3 class=""hasAnchor"">
 <a href=""#saving-and-accessing-advanced-algorithm-info-latent-dynamics"" class=""anchor""></a>Saving and accessing advanced algorithm info (latent dynamics)</h3>
 <p>If <code>save_latent_dynamics</code> is set to <code>TRUE</code> when running the <code>$sample()</code> method then additional CSV files are created (one per chain) that provide access to quantities used under the hood by Stans implementation of dynamic Hamiltonian Monte Carlo.</p>
 <p>CmdStanR does not yet provide a special method for processing these files but they can be read into R using Rs standard CSV reading functions:</p>
-<div class=""sourceCode"" id=""cb44""><html><body><pre class=""r""><span class=""no"">fit</span> <span class=""kw"">&lt;-</span> <span class=""no"">mod</span>$<span class=""fu""><a href=""../reference/model-method-sample.html"">sample</a></span>(<span class=""kw"">data</span> <span class=""kw"">=</span> <span class=""no"">data_list</span>, <span class=""kw"">save_latent_dynamics</span> <span class=""kw"">=</span> <span class=""fl"">TRUE</span>)</pre></body></html></div>
-<div class=""sourceCode"" id=""cb45""><html><body><pre class=""r""><span class=""no"">fit</span>$<span class=""fu""><a href=""../reference/fit-method-save_output_files.html"">latent_dynamics_files</a></span>()</pre></body></html></div>
-<pre><code>[1] ""/var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmplaARek/bernoulli-diagnostic-202006231743-1-92bc63.csv""
-[2] ""/var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmplaARek/bernoulli-diagnostic-202006231743-2-92bc63.csv""
-[3] ""/var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmplaARek/bernoulli-diagnostic-202006231743-3-92bc63.csv""
-[4] ""/var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmplaARek/bernoulli-diagnostic-202006231743-4-92bc63.csv""</code></pre>
-<div class=""sourceCode"" id=""cb47""><html><body><pre class=""r""><span class=""co""># read one of the files in</span>
+<div class=""sourceCode"" id=""cb41""><html><body><pre class=""r""><span class=""no"">fit</span> <span class=""kw"">&lt;-</span> <span class=""no"">mod</span>$<span class=""fu""><a href=""../reference/model-method-sample.html"">sample</a></span>(<span class=""kw"">data</span> <span class=""kw"">=</span> <span class=""no"">data_list</span>, <span class=""kw"">save_latent_dynamics</span> <span class=""kw"">=</span> <span class=""fl"">TRUE</span>)</pre></body></html></div>
+<div class=""sourceCode"" id=""cb42""><html><body><pre class=""r""><span class=""no"">fit</span>$<span class=""fu""><a href=""../reference/fit-method-save_output_files.html"">latent_dynamics_files</a></span>()</pre></body></html></div>
+<pre><code>[1] ""/var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpRtIdGY/bernoulli-diagnostic-202006231807-1-0068a8.csv""
+[2] ""/var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpRtIdGY/bernoulli-diagnostic-202006231807-2-0068a8.csv""
+[3] ""/var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpRtIdGY/bernoulli-diagnostic-202006231807-3-0068a8.csv""
+[4] ""/var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpRtIdGY/bernoulli-diagnostic-202006231807-4-0068a8.csv""</code></pre>
+<div class=""sourceCode"" id=""cb44""><html><body><pre class=""r""><span class=""co""># read one of the files in</span>
 <span class=""no"">x</span> <span class=""kw"">&lt;-</span> <span class=""kw pkg"">utils</span><span class=""kw ns"">::</span><span class=""fu""><a href=""https://rdrr.io/r/utils/read.table.html"">read.csv</a></span>(<span class=""no"">fit</span>$<span class=""fu""><a href=""../reference/fit-method-save_output_files.html"">latent_dynamics_files</a></span>()[<span class=""fl"">1</span>], <span class=""kw"">comment.char</span> <span class=""kw"">=</span> <span class=""st"">""#""</span>)
 <span class=""fu""><a href=""https://rdrr.io/r/utils/head.html"">head</a></span>(<span class=""no"">x</span>)</pre></body></html></div>
 <pre><code>      lp__ accept_stat__ stepsize__ treedepth__ n_leapfrog__ divergent__
-1 -8.16957      0.684702     1.1014           1            1           0
-2 -7.21336      1.000000     1.1014           2            3           0
-3 -6.84419      0.982612     1.1014           2            3           0
-4 -7.05866      0.951315     1.1014           1            1           0
-5 -8.62239      0.865112     1.1014           2            3           0
-6 -6.74832      1.000000     1.1014           1            3           0
-  energy__      theta    p_theta    g_theta
-1  8.23835 -0.0506837 -0.5687600  2.8479800
-2  7.95764 -1.7825900  1.8709300 -1.2722000
-3  7.39741 -1.3986900  1.6130000 -0.6237160
-4  7.05920 -1.6505300  0.0502225 -1.0675500
-5  9.15094  0.0968538 -1.5766300  3.2903300
-6  8.14955 -1.1149900 -2.5671000 -0.0367046</code></pre>
+1 -7.10114      0.995261   0.836241           1            1           0
+2 -6.74803      0.994965   0.836241           1            3           0
+3 -6.74802      1.000000   0.836241           2            3           0
+4 -7.05039      0.845968   0.836241           2            3           0
+5 -7.83290      0.900421   0.836241           1            3           0
+6 -7.71554      1.000000   0.836241           2            3           0
+  energy__    theta     p_theta      g_theta
+1  7.15462 -1.68919 -0.42150200 -1.129420000
+2  7.16006 -1.10162 -1.16996000 -0.006763980
+3  6.74803 -1.09872 -0.00576005 -0.000234225
+4  7.71661 -1.64273  1.48771000 -1.054880000
+5  7.86549 -2.18434 -0.32905300 -1.786010000
+6  7.93231 -2.11723  0.84862400 -1.710800000</code></pre>
 <p>The column <code>lp__</code> is also provided via <code>fit$draws()</code>, and the columns <code>accept_stat__</code>, <code>stepsize__</code>, <code>treedepth__</code>, <code>n_leapfrog__</code>, <code>divergent__</code>, and <code>energy__</code> are also provided by <code>fit$sampler_diagnostics()</code>, but there are several columns unique to the latent dynamics file:</p>
-<div class=""sourceCode"" id=""cb49""><html><body><pre class=""r""><span class=""fu""><a href=""https://rdrr.io/r/utils/head.html"">head</a></span>(<span class=""no"">x</span>[, <span class=""fu""><a href=""https://rdrr.io/r/base/c.html"">c</a></span>(<span class=""st"">""theta""</span>, <span class=""st"">""p_theta""</span>, <span class=""st"">""g_theta""</span>)])</pre></body></html></div>
-<pre><code>       theta    p_theta    g_theta
-1 -0.0506837 -0.5687600  2.8479800
-2 -1.7825900  1.8709300 -1.2722000
-3 -1.3986900  1.6130000 -0.6237160
-4 -1.6505300  0.0502225 -1.0675500
-5  0.0968538 -1.5766300  3.2903300
-6 -1.1149900 -2.5671000 -0.0367046</code></pre>
+<div class=""sourceCode"" id=""cb46""><html><body><pre class=""r""><span class=""fu""><a href=""https://rdrr.io/r/utils/head.html"">head</a></span>(<span class=""no"">x</span>[, <span class=""fu""><a href=""https://rdrr.io/r/base/c.html"">c</a></span>(<span class=""st"">""theta""</span>, <span class=""st"">""p_theta""</span>, <span class=""st"">""g_theta""</span>)])</pre></body></html></div>
+<pre><code>     theta     p_theta      g_theta
+1 -1.68919 -0.42150200 -1.129420000
+2 -1.10162 -1.16996000 -0.006763980
+3 -1.09872 -0.00576005 -0.000234225
+4 -1.64273  1.48771000 -1.054880000
+5 -2.18434 -0.32905300 -1.786010000
+6 -2.11723  0.84862400 -1.710800000</code></pre>
 <p>Our model has a single parameter <code>theta</code> and the three columns above correspond to <code>theta</code> in the <em>unconstrained</em> space (<code>theta</code> on the constrained space is accessed via <code>fit$draws()</code>), the auxiliary momentum <code>p_theta</code>, and the gradient <code>g_theta</code>. In general, each of these three columns will exist for <em>every</em> parameter in the model.</p>
 </div>
+</div>
+<div id=""saving-fitted-model-objects"" class=""section level2"">
+<h2 class=""hasAnchor"">
+<a href=""#saving-fitted-model-objects"" class=""anchor""></a>Saving fitted model objects</h2>
+<p>As described above, the contents of the CSV files are only read into R when they are needed. This means that in order to save a fitted model object containing <em>all</em> of the posterior draws and sampler diagnostics you should either make sure to call <code>fit$draws()</code> and <code>fit$sampler_diagnostics()</code> before saving the object <code>fit</code>, or use the special <code>$save_object()</code> method provided by CmdStanR, which will ensure that everything has been read into R before saving the object using <code><a href=""https://rdrr.io/r/base/readRDS.html"">saveRDS()</a></code>:</p>
+<div class=""sourceCode"" id=""cb48""><html><body><pre class=""r""><span class=""no"">temp_rds_file</span> <span class=""kw"">&lt;-</span> <span class=""fu""><a href=""https://rdrr.io/r/base/tempfile.html"">tempfile</a></span>(<span class=""kw"">fileext</span> <span class=""kw"">=</span> <span class=""st"">"".RDS""</span>) <span class=""co""># temporary file just for demonstration</span>
+<span class=""no"">fit</span>$<span class=""fu""><a href=""../reference/fit-method-save_object.html"">save_object</a></span>(<span class=""kw"">file</span> <span class=""kw"">=</span> <span class=""no"">temp_rds_file</span>)</pre></body></html></div>
+<p>We can check that this worked by removing <code>fit</code> and loading it back in from the save file:</p>
+<div class=""sourceCode"" id=""cb49""><html><body><pre class=""r""><span class=""fu""><a href=""https://rdrr.io/r/base/rm.html"">rm</a></span>(<span class=""no"">fit</span>); <span class=""fu""><a href=""https://rdrr.io/r/base/gc.html"">gc</a></span>()</pre></body></html></div>
+<pre><code>          used (Mb) gc trigger (Mb) limit (Mb) max used (Mb)
+Ncells  930843 49.8    1821450 97.3         NA  1821450 97.3
+Vcells 1769173 13.5    8388608 64.0      16384  3443682 26.3</code></pre>
+<div class=""sourceCode"" id=""cb51""><html><body><pre class=""r""><span class=""no"">fit</span> <span class=""kw"">&lt;-</span> <span class=""fu""><a href=""https://rdrr.io/r/base/readRDS.html"">readRDS</a></span>(<span class=""no"">temp_rds_file</span>)
+<span class=""no"">fit</span>$<span class=""fu""><a href=""../reference/fit-method-summary.html"">summary</a></span>()</pre></body></html></div>
+<pre><code># A tibble: 2 x 10
+  variable   mean median    sd   mad      q5    q95  rhat ess_bulk ess_tail
+  &lt;chr&gt;     &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
+1 lp__     -7.29  -7.00  0.742 0.344 -8.77   -6.75   1.00    1704.    1707.
+2 theta     0.249  0.233 0.121 0.124  0.0777  0.471  1.00    1398.    1523.</code></pre>
 </div>
   </div>
 

---FILE: man/fit-method-save_object.Rd---
@@ -30,9 +30,10 @@ fit <- cmdstanr_example(""logistic"")
 
 temp_rds_file <- tempfile(fileext = "".RDS"")
 fit$save_object(file = temp_rds_file)
-
 rm(fit)
+
 fit <- readRDS(temp_rds_file)
+fit$summary()
 }
 
 }",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,346db20c2781ec00f62a426dd7b452b6617195ec,jgabry,jgabry@gmail.com,2020-06-23T00:43:54Z,jgabry,jgabry@gmail.com,2020-06-23T00:43:54Z,edit error message,R/data.R;tests/testthat/test-model-data.R,False,True,True,False,15,8,23,"---FILE: R/data.R---
@@ -89,11 +89,11 @@ process_data <- function(data) {
   } else if (is.character(data)) {
     path <- absolute_path(data)
   } else if (is.list(data) && !is.data.frame(data)) {
-    if (cmdstan_version() < ""2.22"" && has_any_zero_dims(data)) {
+    if (cmdstan_version() < ""2.22"" && any_zero_dims(data)) {
       stop(
-        ""For CmdStan < 2.22, if there are any data objects with a dimension with "",
-        ""zero elements then 'data' must be a file created by rstan::stan_rdump(). "",
-        ""To use a named list please update your CmdStan installation using install_cmdstan()."",
+        ""Data includes 0-dimensional data structures. To use this data please "",
+        ""either update your CmdStan installation with install_cmdstan() "",
+        ""or specify data as a file created by rstan::stan_rdump()."",
         call. = FALSE
       )
     }
@@ -105,7 +105,8 @@ process_data <- function(data) {
   path
 }
 
-has_any_zero_dims <- function(data) {
+# check if any objects in the data list have zero
+any_zero_dims <- function(data) {
   has_zero_dims <- sapply(data, function(x) {
     any(dim(x) == 0)
   })

---FILE: tests/testthat/test-model-data.R---
@@ -7,24 +7,30 @@ if (not_on_cran()) {
   data_list <- testing_data(""logistic"")
 }
 
-test_that(""error if data is list and CmdStan < 2.22"", {
+test_that(""error if CmdStan < 2.22 and any 0-dimensional data objects"", {
   skip_on_cran()
   ver <- cmdstan_version()
   .cmdstanr$VERSION <- ""2.21.0""
   expect_sample_output(
     fit <- mod$sample(data = data_list)
   )
 
+  data_list$X <- array(1, dim = 0)
+  expect_error(
+    fit <- mod$sample(data = data_list),
+    ""Data includes 0-dimensional data structures.""
+  )
+
   data_list$X <- array(1, dim = c(100, 0))
   expect_error(
     fit <- mod$sample(data = data_list),
-    ""To use a named list please update your CmdStan installation""
+    ""Data includes 0-dimensional data structures.""
   )
 
   data_list$X <- array(1, dim = c(100, 3, 0))
   expect_error(
     fit <- mod$sample(data = data_list),
-    ""To use a named list please update your CmdStan installation""
+    ""Data includes 0-dimensional data structures""
   )
   .cmdstanr$VERSION <- ver
 })",True,False,Implementation / Logic,6
stan-dev,cmdstanr,a5049d3c8f733f1557723e41369c8c38e77ce449,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-21T09:09:03Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-21T09:09:03Z,fix the rsession crash bug with csvs with a very large number of columns,R/read_csv.R,False,True,True,False,18,11,29,"---FILE: R/read_csv.R---
@@ -155,24 +155,26 @@ read_sample_csv <- function(files,
       col_select <- c(col_select, variables[variables!=""lp__""])
       col_select <- c(col_select, sampler_diagnostics)
     }
-    suppressWarnings(
+    num_warmup_draws <- ceiling(sampling_info$iter_warmup/sampling_info$thin)
+    num_post_warmup_draws <- ceiling(sampling_info$iter_sampling/sampling_info$thin)
+    all_draws <- num_warmup_draws + num_post_warmup_draws
+    suppressWarnings(      
       draws <- vroom::vroom(output_file,
-                            comment = ""# "",
-                            delim = ',',
-                            trim_ws = TRUE,
-                            col_select = col_select,
-                            col_types = c(""lp__"" = ""d""),
-                            altrep = FALSE,
-                            progress = FALSE)
+                  comment = ""#"",
+                  delim = ',',
+                  trim_ws = TRUE,
+                  col_select = col_select,
+                  col_types = c(""lp__"" = ""d""),
+                  altrep = FALSE,
+                  progress = FALSE,
+                  skip = sampling_info$lines_to_skip,
+                  n_max = all_draws*2)
     )
     if (ncol(draws) == 0) {
       stop(""The supplied csv file does not contain any sampling data!"")
     }
     draws <- draws[!is.na(draws$lp__), ]
     if (nrow(draws) > 0) {
-      num_warmup_draws <- ceiling(sampling_info$iter_warmup/sampling_info$thin)
-      num_post_warmup_draws <- ceiling(sampling_info$iter_sampling/sampling_info$thin)
-      all_draws <- num_warmup_draws + num_post_warmup_draws
       if (sampling_info$save_warmup == 1) {
         if (length(variables) > 0) {
           new_warmup_draws <- posterior::as_draws_array(draws[1:num_warmup_draws, variables])
@@ -321,6 +323,7 @@ read_sample_info_csv <- function(csv_file) {
   csv_file_info[[""inv_metric""]] <- NULL
   inv_metric_rows <- 0
   parsing_done <- FALSE
+  lines_before_param_names <- 0
   while (length(line <- readLines(con, n = 1, warn = FALSE)) > 0 && !parsing_done) {
     if (!startsWith(line, ""#"")) {
       if (!param_names_read) {
@@ -343,6 +346,9 @@ read_sample_info_csv <- function(csv_file) {
         }
       }
     } else {
+      if (!param_names_read) {
+        lines_before_param_names <- lines_before_param_names + 1
+      }
       if (!adaptation_terminated) {
         if (regexpr(""# Adaptation terminated"", line, perl = TRUE) > 0) {
           adaptation_terminated <- TRUE
@@ -431,6 +437,7 @@ read_sample_info_csv <- function(csv_file) {
   csv_file_info$diagnostic_file <- NULL
   csv_file_info$metric_file <- NULL
   csv_file_info$num_threads <- NULL
+  csv_file_info$lines_to_skip <- lines_before_param_names
 
   csv_file_info
 }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,747e04cb9cc313feb867f3b3cc3b8ae8ffcd84a4,jgabry,jgabry@gmail.com,2020-06-20T22:55:29Z,jgabry,jgabry@gmail.com,2020-06-20T22:55:29Z,fix tibble warnings in tests,R/read_csv.R,False,True,True,False,1,1,2,"---FILE: R/read_csv.R---
@@ -168,7 +168,7 @@ read_sample_csv <- function(files,
     if (ncol(draws) == 0) {
       stop(""The supplied csv file does not contain any sampling data!"")
     }
-    draws <- draws[!is.na(draws[,1]),]
+    draws <- draws[!is.na(draws$lp__), ]
     if (nrow(draws) > 0) {
       num_warmup_draws <- ceiling(sampling_info$iter_warmup/sampling_info$thin)
       num_post_warmup_draws <- ceiling(sampling_info$iter_sampling/sampling_info$thin)",True,False,Implementation / Logic,6
stan-dev,cmdstanr,5d7312d06ea1857e8b642870a44d56eed7a82156,jgabry,jgabry@gmail.com,2020-06-20T20:23:22Z,jgabry,jgabry@gmail.com,2020-06-20T20:23:22Z,"add tests

fixes #211",tests/testthat/test-csv.R;tests/testthat/test-fit-mcmc.R,False,True,True,False,25,0,25,"---FILE: tests/testthat/test-csv.R---
@@ -309,6 +309,13 @@ test_that(""read_sample_csv() works with filtered variables"", {
                fixed = TRUE)
 })
 
+test_that(""read_sample_csv returned filtered variables in correct order"", {
+  csv_output_1 <- read_sample_csv(fit_logistic_thin_1$output_files(), variables = c(""lp__"", ""beta[1]""), sampler_diagnostics = """")
+  expect_equal(posterior::variables(csv_output_1$post_warmup_draws), c(""lp__"", ""beta[1]""))
+  csv_output_2 <- read_sample_csv(fit_logistic_thin_1$output_files(), variables = c(""beta[1]"", ""lp__""), sampler_diagnostics = """")
+  expect_equal(posterior::variables(csv_output_2$post_warmup_draws), c(""beta[1]"", ""lp__""))
+})
+
 test_that(""read_sample_csv() works with no samples"", {
   skip_on_cran()
 
@@ -340,6 +347,19 @@ test_that(""remaining_columns_to_read() works"", {
   expect_equal(remaining_columns_to_read(NULL, NULL, c(""a"", ""b"", ""c"")), c(""a"", ""b"", ""c""))
   expect_equal(remaining_columns_to_read(c(""a"", ""b"", ""c""), c(""a"", ""b"", ""c""), NULL), """")
   expect_equal(remaining_columns_to_read(c(""a"", ""b"", ""c""), NULL, c(""a"", ""b"", ""c"")), c(""a"", ""b"", ""c""))
+
+  # with vector and matrix variables
+  b_vec <- paste0(""b["", 1:4, ""]"")
+  c_mat <- paste0(""c["", c(1,2,1,2), "","", c(1,1,2,2), ""]"")
+  all_vars <- c(""a"", b_vec, c_mat)
+  expect_equal(
+    remaining_columns_to_read(c(""a"", ""b[2]""), c(""a"", c_mat), all_vars),
+    ""b[2]""
+  )
+  expect_equal(
+    remaining_columns_to_read(c(""a"", ""b"", ""c""), c(paste0(""b["", c(1,4), ""]""), ""c[1,2]""), all_vars),
+    c(""a"", ""b[2]"", ""b[3]"", ""c[1,1]"", ""c[2,1]"", ""c[2,2]"")
+  )
 })
 
 test_that(""read_sample_csv() reads adaptation step size correctly"", {

---FILE: tests/testthat/test-fit-mcmc.R---
@@ -38,6 +38,7 @@ test_that(""draws() method returns draws_array (reading csv works)"", {
   draws_betas <- fit_mcmc$draws(variables = ""beta"")
   draws_beta <- fit_mcmc$draws(variables = ""beta[1]"")
   draws_alpha_beta <- fit_mcmc$draws(variables = c(""alpha"", ""beta""))
+  draws_beta_alpha <- fit_mcmc$draws(variables = c(""beta"", ""alpha""))
   draws_all_after <- fit_mcmc$draws()
   expect_type(draws, ""double"")
   expect_s3_class(draws, ""draws_array"")
@@ -55,6 +56,10 @@ test_that(""draws() method returns draws_array (reading csv works)"", {
   expect_s3_class(draws_all_after, ""draws_array"")
   expect_equal(posterior::nvariables(draws_all_after), 5)
   expect_equal(posterior::nchains(draws_all_after), fit_mcmc$num_chains())
+
+  # check the order of the draws
+  expect_equal(posterior::variables(draws_alpha_beta), c(""alpha"", ""beta[1]"", ""beta[2]"", ""beta[3]""))
+  expect_equal(posterior::variables(draws_beta_alpha), c(""beta[1]"", ""beta[2]"", ""beta[3]"", ""alpha""))
 })
 
 test_that(""inv_metric method works after mcmc"", {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,ee4cf82aebace10fe4293b18e46c3584846687b0,jgabry,jgabry@gmail.com,2020-06-20T20:16:37Z,jgabry,jgabry@gmail.com,2020-06-20T20:16:37Z,fix bug in remaining_cols_to_read,R/read_csv.R,False,True,True,False,5,1,6,"---FILE: R/read_csv.R---
@@ -504,9 +504,13 @@ remaining_columns_to_read <- function(requested, currently_read, all) {
     all_remaining <- all[!(all %in% currently_read)]
     unread <- c()
     for (p in requested) {
-      if (any(all_remaining == p) || any(startsWith(all_remaining, paste0(p,""."")))) {
+      if (any(all_remaining == p)) {
         unread <- c(unread, p)
       }
+      is_unread_element <- startsWith(all_remaining, paste0(p,""[""))
+      if (any(is_unread_element)) {
+        unread <- c(unread, all_remaining[is_unread_element])
+      }
     }
   }
   if (length(unread)) {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,e80fc2ebec9d3c11935568875695efd400f00199,jgabry,jgabry@gmail.com,2020-06-20T20:16:04Z,jgabry,jgabry@gmail.com,2020-06-20T20:16:04Z,"throw inc_warmup error immediately

not related to this bugfix but we should throw this error right away instead of after reading from the CSV",R/fit.R,False,True,True,False,5,4,9,"---FILE: R/fit.R---
@@ -578,6 +578,11 @@ CmdStanMCMC <- R6::R6Class(
       if (!length(self$output_files(include_failed = FALSE))) {
         stop(""No chains finished successfully. Unable to retrieve the draws."")
       }
+      if (inc_warmup && !private$sampling_info_$save_warmup) {
+        stop(""Warmup draws were requested from a fit object without them! "",
+             ""Please rerun the model with save_warmup = TRUE."", call. = FALSE)
+      }
+
       to_read <- remaining_columns_to_read(
         requested = variables,
         currently_read = dimnames(private$draws_)$variable,
@@ -597,10 +602,6 @@ CmdStanMCMC <- R6::R6Class(
       }
       variables <- repair_variable_names(matching_res$matching)
       if (inc_warmup) {
-        if (!private$sampling_info_$save_warmup) {
-          stop(""Warmup draws were requested from a fit object without them! "",
-               ""Please rerun the model with save_warmup = TRUE."")
-        }
         posterior::bind_draws(private$warmup_draws_, private$draws_, along=""iteration"")[,,variables]
       } else {
         private$draws_[,,variables]",True,False,Implementation / Logic,6
stan-dev,cmdstanr,67d6d741bac1fea3475123efd008603c773f3745,jgabry,jgabry@gmail.com,2020-06-19T18:02:34Z,jgabry,jgabry@gmail.com,2020-06-19T18:02:34Z,minor punctuation fix in doc,R/fit.R;man/CmdStanMLE.Rd;man/CmdStanVB.Rd,False,True,True,False,4,4,8,"---FILE: R/fit.R---
@@ -760,7 +760,7 @@ CmdStanMCMC <- R6::R6Class(
 #'  [`$save_data_file()`][fit-method-save_data_file] \tab Save JSON data file
 #'  to a specified location. \cr
 #'  [`$time()`][fit-method-time] \tab Report the total run time. \cr
-#'  `$output()` \tab Pretty print the output that was printed during optimization \cr
+#'  `$output()` \tab Pretty print the output that was printed during optimization. \cr
 #' }
 #'
 NULL
@@ -821,7 +821,7 @@ CmdStanMLE <- R6::R6Class(
 #'  [`$save_latent_dynamics_files()`][fit-method-save_latent_dynamics_files]
 #'    \tab Save diagnostic CSV files to a specified location. \cr
 #'  [`$time()`][fit-method-time] \tab Report the total run time. \cr
-#'  `$output()` \tab Pretty print the output that was printed during fitting.' \cr
+#'  `$output()` \tab Pretty print the output that was printed during fitting. \cr
 #' }
 #'
 NULL

---FILE: man/CmdStanMLE.Rd---
@@ -25,7 +25,7 @@ files to a specified location. \cr
 \code{\link[=fit-method-save_data_file]{$save_data_file()}} \tab Save JSON data file
 to a specified location. \cr
 \code{\link[=fit-method-time]{$time()}} \tab Report the total run time. \cr
-\verb{$output()} \tab Pretty print the output that was printed during optimization \cr
+\verb{$output()} \tab Pretty print the output that was printed during optimization. \cr
 }
 }
 \seealso{

---FILE: man/CmdStanVB.Rd---
@@ -32,7 +32,7 @@ variational approximation to the posterior. \cr
 \code{\link[=fit-method-save_latent_dynamics_files]{$save_latent_dynamics_files()}}
 \tab Save diagnostic CSV files to a specified location. \cr
 \code{\link[=fit-method-time]{$time()}} \tab Report the total run time. \cr
-\verb{$output()} \tab Pretty print the output that was printed during fitting.' \cr
+\verb{$output()} \tab Pretty print the output that was printed during fitting. \cr
 }
 }
 \seealso{",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,d94ec17cc3cc13a599227bfa2c8c5cee7a2fa091,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-17T18:28:39Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-17T18:28:39Z,remove the make no rule error,R/model.R,False,True,True,False,3,1,4,"---FILE: R/model.R---
@@ -341,7 +341,9 @@ compile_method <- function(quiet = TRUE,
     echo_cmd = !quiet,
     echo = !quiet,
     spinner = quiet && interactive(),
-    stderr_line_callback = function(x,p) { message(x) },
+    stderr_line_callback = function(x,p) {
+        if (!startsWith(x, paste0(make_cmd(), "": *** No rule to make target""))) message(x)
+    },
     error_on_status = FALSE
   )
   if (run_log$status != 0) {",True,False,Implementation / Logic,3
stan-dev,cmdstanr,6f97533bc25490269bda92db06a1fdd7f4e5bb16,jgabry,jgabry@gmail.com,2020-06-17T18:16:14Z,jgabry,jgabry@gmail.com,2020-06-17T18:16:14Z,avoid 'Error in self$compile(...)' part of message,R/model.R,False,True,True,False,2,1,3,"---FILE: R/model.R---
@@ -345,7 +345,8 @@ compile_method <- function(quiet = TRUE,
     error_on_status = FALSE
   )
   if (run_log$status != 0) {
-    stop(""An error occured during compilation! See the message above for more information."")
+    stop(""An error occured during compilation! See the message above for more information."",
+         call. = FALSE)
   }
 
   file.copy(tmp_exe, exe, overwrite = TRUE)",True,False,Implementation / Logic,6
stan-dev,cmdstanr,92b06161a8934086f9eddeaff88f538424d9c412,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-17T17:24:48Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-17T17:24:48Z,error after processx::run with a nicer message,R/model.R,False,True,True,False,5,2,7,"---FILE: R/model.R---
@@ -341,9 +341,12 @@ compile_method <- function(quiet = TRUE,
     echo_cmd = !quiet,
     echo = !quiet,
     spinner = quiet,
-    stderr_line_callback = function(x,p) { if (!quiet) message(x) },
-    error_on_status = TRUE
+    stderr_line_callback = function(x,p) { message(x) },
+    error_on_status = FALSE
   )
+  if (run_log$status != 0) {
+    stop(""An error occured during compilation! See the message above for more information."")
+  }
 
   file.copy(tmp_exe, exe, overwrite = TRUE)
   private$cpp_options_ <- cpp_options",True,False,Implementation / Logic,6
stan-dev,cmdstanr,720cd831de37abbcedff4698ae11da1278e90e16,jgabry,jgabry@gmail.com,2020-06-16T16:33:46Z,jgabry,jgabry@gmail.com,2020-06-16T16:33:46Z,fix tests and doc,R/fit.R;docs/reference/fit-method-summary.html;docs/reference/index.html;man/fit-method-summary.Rd;tests/testthat/test-fit-mcmc.R;tests/testthat/test-fit-mle.R;tests/testthat/test-fit-vb.R,False,True,True,False,91,63,154,"---FILE: R/fit.R---
@@ -281,28 +281,33 @@ NULL
 #' Compute a summary table of MCMC estimates and diagnostics
 #'
 #' @name fit-method-summary
-#' @aliases summary
-#' @description Run [`summarise_draws()`][posterior::draws_summary]
-#'   from the \pkg{posterior} package. For MCMC only post-warmup draws are
-#'   included in the summary.
+#' @aliases summary print.CmdStanMCMC print.CmdStanMLE print.CmdStanVB
+#' @description The `$summary()` method runs
+#'   [`summarise_draws()`][posterior::draws_summary] from the \pkg{posterior}
+#'   package. For MCMC only post-warmup draws are included in the summary.
 #'
-#'   The `$print()` method is a wrapper around the `$summary()` method that
-#'   removes the extra formatting used for printing tibbles.
+#'   The `$print()` method prints the same summary but removes the extra
+#'   formatting used for printing tibbles.
 #'
 #' @section Usage:
 #'   ```
 #'   $summary(variables = NULL, ...)
-#'   $print(variables = NULL, ..., digits = 2)
+#'   $print(variables = NULL, ..., digits = 2, max_rows = 10)
 #'   ```
 #' @section Arguments:
 #' * `variables`: (character vector) The variables to include.
 #' * `...`: Optional arguments to pass to
 #' [`posterior::summarise_draws()`][posterior::draws_summary].
 #' * `digits`: (integer) For `print` only, the number of digits to use for
 #' rounding.
+#' * `max_rows`: (integer) For `print` only, the maximum number of rows to print.
 #'
 #' @section Value:
-#' See [`posterior::summarise_draws()`][posterior::draws_summary].
+#' The `$summary()` method returns the tibble created by
+#' [`posterior::summarise_draws()`][posterior::draws_summary].
+#'
+#' The `$print()` method returns the fitted model object itself (invisibly),
+#' which is the standard behavior for print methods in \R.
 #'
 #' @seealso [`CmdStanMCMC`], [`CmdStanMLE`], [`CmdStanVB`]
 #'
@@ -311,6 +316,7 @@ NULL
 #' fit <- cmdstanr_example(""logistic"")
 #' fit$summary()
 #' fit$print()
+#' fit$print(max_rows = 2) # same as print(fit, max_rows = 2)
 #'
 #' # include only certain variables
 #' fit$summary(""beta"")

---FILE: docs/reference/fit-method-summary.html---
@@ -47,9 +47,11 @@
 
 
 <meta property=""og:title"" content=""Compute a summary table of MCMC estimates and diagnostics  fit-method-summary"" />
-<meta property=""og:description"" content=""Run summarise_draws()
-from the posterior package. For MCMC only post-warmup draws are
-included in the summary."" />
+<meta property=""og:description"" content=""The $summary() method runs
+summarise_draws() from the posterior
+package. For MCMC only post-warmup draws are included in the summary.
+The $print() method prints the same summary but removes the extra
+formatting used for printing tibbles."" />
 <meta property=""og:image"" content=""https://mc-stan.org/cmdstanr/logo.png"" />
 
 
@@ -82,7 +84,7 @@
       </button>
       <span class=""navbar-brand"">
         <a class=""navbar-link"" href=""../index.html"">cmdstanr</a>
-        <span class=""version label label-danger"" data-toggle=""tooltip"" data-placement=""bottom"" title=""Unreleased version"">0.0.0.9005</span>
+        <span class=""version label label-danger"" data-toggle=""tooltip"" data-placement=""bottom"" title=""Unreleased version"">0.0.0.9006</span>
       </span>
     </div>
 
@@ -175,33 +177,43 @@ <h1>Compute a summary table of MCMC estimates and diagnostics</h1>
     </div>
 
     <div class=""ref-description"">
-    <p>Run <code><a href='https://mc-stan.org/posterior/reference/draws_summary.html'>summarise_draws()</a></code>
-from the <span class=""pkg"">posterior</span> package. For MCMC only post-warmup draws are
-included in the summary.</p>
+    <p>The <code>$summary()</code> method runs
+<code><a href='https://mc-stan.org/posterior/reference/draws_summary.html'>summarise_draws()</a></code> from the <span class=""pkg"">posterior</span>
+package. For MCMC only post-warmup draws are included in the summary.</p>
+<p>The <code>$print()</code> method prints the same summary but removes the extra
+formatting used for printing tibbles.</p>
     </div>
 
 
 
     <h2 class=""hasAnchor"" id=""usage""><a class=""anchor"" href=""#usage""></a>Usage</h2>
 
     
-<pre>$summary(...)
+<pre>$summary(variables = NULL, ...)
+$print(variables = NULL, ..., digits = 2, max_rows = 10)
 </pre>
 
     <h2 class=""hasAnchor"" id=""arguments""><a class=""anchor"" href=""#arguments""></a>Arguments</h2>
 
     
 
 <ul>
+<li><p><code>variables</code>: (character vector) The variables to include.</p></li>
 <li><p><code>...</code>: Optional arguments to pass to
 <code><a href='https://mc-stan.org/posterior/reference/draws_summary.html'>posterior::summarise_draws()</a></code>.</p></li>
+<li><p><code>digits</code>: (integer) For <code>print</code> only, the number of digits to use for
+rounding.</p></li>
+<li><p><code>max_rows</code>: (integer) For <code>print</code> only, the maximum number of rows to print.</p></li>
 </ul>
 
     <h2 class=""hasAnchor"" id=""value""><a class=""anchor"" href=""#value""></a>Value</h2>
 
     
 
-<p>See <code><a href='https://mc-stan.org/posterior/reference/draws_summary.html'>posterior::summarise_draws()</a></code>.</p>
+<p>The <code>$summary()</code> method returns the tibble created by
+<code><a href='https://mc-stan.org/posterior/reference/draws_summary.html'>posterior::summarise_draws()</a></code>.</p>
+<p>The <code>$print()</code> method returns the fitted model object itself (invisibly),
+which is the standard behavior for print methods in <span style=""R"">R</span>.</p>
     <h2 class=""hasAnchor"" id=""see-also""><a class=""anchor"" href=""#see-also""></a>See also</h2>
 
     <div class='dont-index'><p><code><a href='CmdStanMCMC.html'>CmdStanMCMC</a></code>, <code><a href='CmdStanMLE.html'>CmdStanMLE</a></code>, <code><a href='CmdStanVB.html'>CmdStanVB</a></code></p></div>
@@ -211,18 +223,38 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 <span class='no'>fit</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='cmdstanr_example.html'>cmdstanr_example</a></span>(<span class='st'>""logistic""</span>)</div><div class='output co'>#&gt; <span class='message'>Model executable is up to date!</span></div><div class='input'><span class='no'>fit</span>$<span class='fu'>summary</span>()</div><div class='output co'>#&gt; <span style='color: #949494;'># A tibble: 5 x 10</span><span>
 #&gt;   variable    mean  median    sd   mad       q5      q95  rhat ess_bulk ess_tail
 #&gt;   </span><span style='color: #949494;font-style: italic;'>&lt;chr&gt;</span><span>      </span><span style='color: #949494;font-style: italic;'>&lt;dbl&gt;</span><span>   </span><span style='color: #949494;font-style: italic;'>&lt;dbl&gt;</span><span> </span><span style='color: #949494;font-style: italic;'>&lt;dbl&gt;</span><span> </span><span style='color: #949494;font-style: italic;'>&lt;dbl&gt;</span><span>    </span><span style='color: #949494;font-style: italic;'>&lt;dbl&gt;</span><span>    </span><span style='color: #949494;font-style: italic;'>&lt;dbl&gt;</span><span> </span><span style='color: #949494;font-style: italic;'>&lt;dbl&gt;</span><span>    </span><span style='color: #949494;font-style: italic;'>&lt;dbl&gt;</span><span>    </span><span style='color: #949494;font-style: italic;'>&lt;dbl&gt;</span><span>
-#&gt; </span><span style='color: #BCBCBC;'>1</span><span> lp__     -</span><span style='color: #BB0000;'>65.9</span><span>   -</span><span style='color: #BB0000;'>65.6</span><span>   1.41  1.23  -</span><span style='color: #BB0000;'>68.7</span><span>    -</span><span style='color: #BB0000;'>64.3</span><span>     1.00    </span><span style='text-decoration: underline;'>2</span><span>201.    </span><span style='text-decoration: underline;'>2</span><span>896.
-#&gt; </span><span style='color: #BCBCBC;'>2</span><span> alpha      0.378   0.377 0.215 0.212   0.025</span><span style='text-decoration: underline;'>7</span><span>   0.738   1.00    </span><span style='text-decoration: underline;'>4</span><span>068.    </span><span style='text-decoration: underline;'>2</span><span>995.
-#&gt; </span><span style='color: #BCBCBC;'>3</span><span> beta[1]   -</span><span style='color: #BB0000;'>0.664</span><span>  -</span><span style='color: #BB0000;'>0.662</span><span> 0.250 0.244  -</span><span style='color: #BB0000;'>1.09</span><span>    -</span><span style='color: #BB0000;'>0.265</span><span>   1.00    </span><span style='text-decoration: underline;'>4</span><span>421.    </span><span style='text-decoration: underline;'>3</span><span>013.
-#&gt; </span><span style='color: #BCBCBC;'>4</span><span> beta[2]   -</span><span style='color: #BB0000;'>0.276</span><span>  -</span><span style='color: #BB0000;'>0.274</span><span> 0.226 0.232  -</span><span style='color: #BB0000;'>0.653</span><span>    0.088</span><span style='text-decoration: underline;'>3</span><span>  1.00    </span><span style='text-decoration: underline;'>4</span><span>042.    </span><span style='text-decoration: underline;'>3</span><span>181.
-#&gt; </span><span style='color: #BCBCBC;'>5</span><span> beta[3]    0.688   0.681 0.266 0.263   0.253    1.14    1.00    </span><span style='text-decoration: underline;'>4</span><span>212.    </span><span style='text-decoration: underline;'>3</span><span>444.</div><div class='input'><span class='no'>fit</span>$<span class='fu'>summary</span>(<span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span>(<span class='st'>""mean""</span>, <span class='st'>""sd""</span>))</div><div class='output co'>#&gt; </span><span style='color: #949494;'># A tibble: 5 x 3</span><span>
+#&gt; </span><span style='color: #BCBCBC;'>1</span><span> lp__     -</span><span style='color: #BB0000;'>66.0</span><span>   -</span><span style='color: #BB0000;'>65.7</span><span>   1.43  1.28  -</span><span style='color: #BB0000;'>68.8</span><span>    -</span><span style='color: #BB0000;'>64.3</span><span>     1.00    </span><span style='text-decoration: underline;'>2</span><span>053.    </span><span style='text-decoration: underline;'>2</span><span>672.
+#&gt; </span><span style='color: #BCBCBC;'>2</span><span> alpha      0.380   0.373 0.222 0.220   0.018</span><span style='text-decoration: underline;'>4</span><span>   0.753   1.00    </span><span style='text-decoration: underline;'>4</span><span>413.    </span><span style='text-decoration: underline;'>3</span><span>074.
+#&gt; </span><span style='color: #BCBCBC;'>3</span><span> beta[1]   -</span><span style='color: #BB0000;'>0.674</span><span>  -</span><span style='color: #BB0000;'>0.666</span><span> 0.252 0.247  -</span><span style='color: #BB0000;'>1.10</span><span>    -</span><span style='color: #BB0000;'>0.274</span><span>   1.00    </span><span style='text-decoration: underline;'>3</span><span>950.    </span><span style='text-decoration: underline;'>2</span><span>963.
+#&gt; </span><span style='color: #BCBCBC;'>4</span><span> beta[2]   -</span><span style='color: #BB0000;'>0.272</span><span>  -</span><span style='color: #BB0000;'>0.273</span><span> 0.222 0.219  -</span><span style='color: #BB0000;'>0.637</span><span>    0.096</span><span style='text-decoration: underline;'>5</span><span>  1.00    </span><span style='text-decoration: underline;'>4</span><span>540.    </span><span style='text-decoration: underline;'>3</span><span>173.
+#&gt; </span><span style='color: #BCBCBC;'>5</span><span> beta[3]    0.685   0.680 0.267 0.259   0.256    1.14    1.00    </span><span style='text-decoration: underline;'>4</span><span>481.    </span><span style='text-decoration: underline;'>3</span><span>085.</div><div class='input'><span class='no'>fit</span>$<span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span>()</div><div class='output co'>#&gt;  variable   mean median   sd  mad     q5    q95 rhat ess_bulk ess_tail
+#&gt;   lp__    -65.97 -65.67 1.43 1.28 -68.80 -64.28 1.00     2052     2671
+#&gt;   alpha     0.38   0.37 0.22 0.22   0.02   0.75 1.00     4412     3074
+#&gt;   beta[1]  -0.67  -0.67 0.25 0.25  -1.10  -0.27 1.00     3949     2963
+#&gt;   beta[2]  -0.27  -0.27 0.22 0.22  -0.64   0.10 1.00     4539     3173
+#&gt;   beta[3]   0.68   0.68 0.27 0.26   0.26   1.14 1.00     4481     3084</div><div class='input'><span class='no'>fit</span>$<span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span>(<span class='kw'>max_rows</span> <span class='kw'>=</span> <span class='fl'>2</span>) <span class='co'># same as print(fit, max_rows = 2)</span></div><div class='output co'>#&gt;  variable   mean median   sd  mad     q5    q95 rhat ess_bulk ess_tail
+#&gt;     lp__  -65.97 -65.67 1.43 1.28 -68.80 -64.28 1.00     2052     2671
+#&gt;     alpha   0.38   0.37 0.22 0.22   0.02   0.75 1.00     4412     3074
+#&gt; 
+#&gt;  # showing 2 of 5 rows (change via 'max_rows' argument)</div><div class='input'>
+<span class='co'># include only certain variables</span>
+<span class='no'>fit</span>$<span class='fu'>summary</span>(<span class='st'>""beta""</span>)</div><div class='output co'>#&gt; </span><span style='color: #949494;'># A tibble: 3 x 10</span><span>
+#&gt;   variable   mean median    sd   mad     q5     q95  rhat ess_bulk ess_tail
+#&gt;   </span><span style='color: #949494;font-style: italic;'>&lt;chr&gt;</span><span>     </span><span style='color: #949494;font-style: italic;'>&lt;dbl&gt;</span><span>  </span><span style='color: #949494;font-style: italic;'>&lt;dbl&gt;</span><span> </span><span style='color: #949494;font-style: italic;'>&lt;dbl&gt;</span><span> </span><span style='color: #949494;font-style: italic;'>&lt;dbl&gt;</span><span>  </span><span style='color: #949494;font-style: italic;'>&lt;dbl&gt;</span><span>   </span><span style='color: #949494;font-style: italic;'>&lt;dbl&gt;</span><span> </span><span style='color: #949494;font-style: italic;'>&lt;dbl&gt;</span><span>    </span><span style='color: #949494;font-style: italic;'>&lt;dbl&gt;</span><span>    </span><span style='color: #949494;font-style: italic;'>&lt;dbl&gt;</span><span>
+#&gt; </span><span style='color: #BCBCBC;'>1</span><span> beta[1]  -</span><span style='color: #BB0000;'>0.674</span><span> -</span><span style='color: #BB0000;'>0.666</span><span> 0.252 0.247 -</span><span style='color: #BB0000;'>1.10</span><span>  -</span><span style='color: #BB0000;'>0.274</span><span>   1.00    </span><span style='text-decoration: underline;'>3</span><span>950.    </span><span style='text-decoration: underline;'>2</span><span>963.
+#&gt; </span><span style='color: #BCBCBC;'>2</span><span> beta[2]  -</span><span style='color: #BB0000;'>0.272</span><span> -</span><span style='color: #BB0000;'>0.273</span><span> 0.222 0.219 -</span><span style='color: #BB0000;'>0.637</span><span>  0.096</span><span style='text-decoration: underline;'>5</span><span>  1.00    </span><span style='text-decoration: underline;'>4</span><span>540.    </span><span style='text-decoration: underline;'>3</span><span>173.
+#&gt; </span><span style='color: #BCBCBC;'>3</span><span> beta[3]   0.685  0.680 0.267 0.259  0.256  1.14    1.00    </span><span style='text-decoration: underline;'>4</span><span>481.    </span><span style='text-decoration: underline;'>3</span><span>085.</div><div class='input'><span class='no'>fit</span>$<span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span>(<span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span>(<span class='st'>""alpha""</span>, <span class='st'>""beta[2]""</span>))</div><div class='output co'>#&gt;  variable  mean median   sd  mad    q5  q95 rhat ess_bulk ess_tail
+#&gt;   alpha    0.38   0.37 0.22 0.22  0.02 0.75 1.00     4412     3074
+#&gt;   beta[2] -0.27  -0.27 0.22 0.22 -0.64 0.10 1.00     4539     3173</div><div class='input'>
+<span class='co'># include all variables but only certain summaries</span>
+<span class='no'>fit</span>$<span class='fu'>summary</span>(<span class='kw'>NULL</span>, <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span>(<span class='st'>""mean""</span>, <span class='st'>""sd""</span>))</div><div class='output co'>#&gt; </span><span style='color: #949494;'># A tibble: 5 x 3</span><span>
 #&gt;   variable    mean    sd
 #&gt;   </span><span style='color: #949494;font-style: italic;'>&lt;chr&gt;</span><span>      </span><span style='color: #949494;font-style: italic;'>&lt;dbl&gt;</span><span> </span><span style='color: #949494;font-style: italic;'>&lt;dbl&gt;</span><span>
-#&gt; </span><span style='color: #BCBCBC;'>1</span><span> lp__     -</span><span style='color: #BB0000;'>65.9</span><span>   1.41 
-#&gt; </span><span style='color: #BCBCBC;'>2</span><span> alpha      0.378 0.215
-#&gt; </span><span style='color: #BCBCBC;'>3</span><span> beta[1]   -</span><span style='color: #BB0000;'>0.664</span><span> 0.250
-#&gt; </span><span style='color: #BCBCBC;'>4</span><span> beta[2]   -</span><span style='color: #BB0000;'>0.276</span><span> 0.226
-#&gt; </span><span style='color: #BCBCBC;'>5</span><span> beta[3]    0.688 0.266</div><div class='input'># }
+#&gt; </span><span style='color: #BCBCBC;'>1</span><span> lp__     -</span><span style='color: #BB0000;'>66.0</span><span>   1.43 
+#&gt; </span><span style='color: #BCBCBC;'>2</span><span> alpha      0.380 0.222
+#&gt; </span><span style='color: #BCBCBC;'>3</span><span> beta[1]   -</span><span style='color: #BB0000;'>0.674</span><span> 0.252
+#&gt; </span><span style='color: #BCBCBC;'>4</span><span> beta[2]   -</span><span style='color: #BB0000;'>0.272</span><span> 0.222
+#&gt; </span><span style='color: #BCBCBC;'>5</span><span> beta[3]    0.685 0.267</div><div class='input'># }
 
 </div></span></pre>
   </div>

---FILE: docs/reference/index.html---
@@ -79,7 +79,7 @@
       </button>
       <span class=""navbar-brand"">
         <a class=""navbar-link"" href=""../index.html"">cmdstanr</a>
-        <span class=""version label label-danger"" data-toggle=""tooltip"" data-placement=""bottom"" title=""Unreleased version"">0.0.0.9005</span>
+        <span class=""version label label-danger"" data-toggle=""tooltip"" data-placement=""bottom"" title=""Unreleased version"">0.0.0.9006</span>
       </span>
     </div>
 

---FILE: man/fit-method-summary.Rd---
@@ -3,18 +3,21 @@
 \name{fit-method-summary}
 \alias{fit-method-summary}
 \alias{summary}
+\alias{print.CmdStanMCMC}
+\alias{print.CmdStanMLE}
+\alias{print.CmdStanVB}
 \title{Compute a summary table of MCMC estimates and diagnostics}
 \description{
-Run \code{\link[posterior:draws_summary]{summarise_draws()}}
-from the \pkg{posterior} package. For MCMC only post-warmup draws are
-included in the summary.
+The \verb{$summary()} method runs
+\code{\link[posterior:draws_summary]{summarise_draws()}} from the \pkg{posterior}
+package. For MCMC only post-warmup draws are included in the summary.
 
-The \verb{$print()} method is a wrapper around the \verb{$summary()} method that
-removes the extra formatting used for printing tibbles.
+The \verb{$print()} method prints the same summary but removes the extra
+formatting used for printing tibbles.
 }
 \section{Usage}{
 \preformatted{$summary(variables = NULL, ...)
-$print(variables = NULL, ..., digits = 2)
+$print(variables = NULL, ..., digits = 2, max_rows = 10)
 }
 }
 
@@ -26,19 +29,25 @@ $print(variables = NULL, ..., digits = 2)
 \code{\link[posterior:draws_summary]{posterior::summarise_draws()}}.
 \item \code{digits}: (integer) For \code{print} only, the number of digits to use for
 rounding.
+\item \code{max_rows}: (integer) For \code{print} only, the maximum number of rows to print.
 }
 }
 
 \section{Value}{
 
-See \code{\link[posterior:draws_summary]{posterior::summarise_draws()}}.
+The \verb{$summary()} method returns the tibble created by
+\code{\link[posterior:draws_summary]{posterior::summarise_draws()}}.
+
+The \verb{$print()} method returns the fitted model object itself (invisibly),
+which is the standard behavior for print methods in \R.
 }
 
 \examples{
 \dontrun{
 fit <- cmdstanr_example(""logistic"")
 fit$summary()
 fit$print()
+fit$print(max_rows = 2) # same as print(fit, max_rows = 2)
 
 # include only certain variables
 fit$summary(""beta"")

---FILE: tests/testthat/test-fit-mcmc.R---
@@ -74,17 +74,9 @@ test_that(""summary() method works after mcmc"", {
 
 test_that(""print() method works after mcmc"", {
   skip_on_cran()
-  x <- fit_mcmc$print()
-  expect_s3_class(x, ""data.frame"")
-  expect_equal(rownames(x), c(""lp__"", PARAM_NAMES))
-
-  x <- fit_mcmc$print(NULL, c(""rhat"", ""sd""))
-  expect_equal(rownames(x), c(""lp__"", PARAM_NAMES))
-  expect_equal(colnames(x), c(""rhat"", ""sd""))
-
-  x <- fit_mcmc$print(""lp__"", c(""median"", ""mad""))
-  expect_equal(rownames(x), ""lp__"")
-  expect_equal(colnames(x), c(""median"", ""mad""))
+  expect_output(expect_s3_class(fit_mcmc$print(), ""CmdStanMCMC""), ""variable"")
+  expect_output(fit_mcmc$print(max_rows = 1), ""# showing 1 of 5 rows"")
+  expect_output(fit_mcmc$print(NULL, c(""ess_sd"")), ""ess_sd"")
 })
 
 

---FILE: tests/testthat/test-fit-mle.R---
@@ -12,7 +12,7 @@ test_that(""mle and lp methods work after optimization"", {
   checkmate::expect_numeric(fit_mle$lp(), len = 1)
 })
 
-test_that(""summary method doesn't error for optimization"", {
+test_that(""summary method works after optimization"", {
   skip_on_cran()
   x <- fit_mle$summary()
   expect_s3_class(x, ""draws_summary"")
@@ -24,14 +24,8 @@ test_that(""summary method doesn't error for optimization"", {
   expect_equal(x$variable, ""lp__"")
 })
 
-test_that(""print method works error for optimization"", {
+test_that(""print() method works after optimization"", {
   skip_on_cran()
-  x <- fit_mle$print()
-  expect_s3_class(x, ""data.frame"")
-  expect_equal(colnames(x), ""estimate"")
-  expect_equal(rownames(x), c(""lp__"", PARAM_NAMES))
-
-  x <- fit_mle$print(""lp__"")
-  expect_equal(colnames(x), c(""estimate""))
-  expect_equal(rownames(x), ""lp__"")
+  expect_output(expect_s3_class(fit_mle$print(), ""CmdStanMLE""), ""estimate"")
+  expect_output(fit_mle$print(max_rows = 1), ""# showing 1 of 5 rows"")
 })

---FILE: tests/testthat/test-fit-vb.R---
@@ -21,13 +21,8 @@ test_that(""summary() method works after vb"", {
 
 test_that(""print() method works after vb"", {
   skip_on_cran()
-  x <- fit_vb$print()
-  expect_s3_class(x, ""data.frame"")
-  expect_equal(rownames(x), c(""lp__"", ""lp_approx__"", PARAM_NAMES))
-
-  x <- fit_vb$print(c(""lp__"", ""lp_approx__""), c(""mean"", ""sd""))
-  expect_equal(rownames(x), c(""lp__"", ""lp_approx__""))
-  expect_equal(colnames(x), c(""mean"", ""sd""))
+  expect_output(expect_s3_class(fit_vb$print(), ""CmdStanVB""), ""variable"")
+  expect_output(fit_vb$print(max_rows = 1), ""# showing 1 of 6 rows"")
 })
 
 test_that(""draws() method returns posterior sample (reading csv works)"", {",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,32994dbb03b75cf0475bd95f7ecb41018661ff4d,jgabry,jgabry@gmail.com,2020-06-15T21:52:34Z,jgabry,jgabry@gmail.com,2020-06-15T21:52:34Z,fix failing test,tests/testthat/test-failed-chains.R,False,True,True,False,1,1,2,"---FILE: tests/testthat/test-failed-chains.R---
@@ -140,7 +140,7 @@ test_that(""init warnings are shown"", {
   suppressWarnings(
     expect_message(
       utils::capture.output(
-        mod_init_warnings$sample(chains = 1)
+        fit <- mod_init_warnings$sample(chains = 1)
       ),
       ""Rejecting initial value""
     )",True,False,Implementation / Logic,3
stan-dev,cmdstanr,9b86a6583e40a6b2a38a511f16c08743ca031416,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-13T08:20:04Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-13T08:20:04Z,typo fix,.github/workflows/Test-coverage.yaml,False,False,False,False,1,1,2,"---FILE: .github/workflows/Test-coverage.yaml---
@@ -35,7 +35,7 @@ jobs:
 
       - name: Install dependencies
         run: |
-          install.packages(c(""posterior, cmdstanr, remotes""),repos = c(""https://mc-stan.org/r-packages/"", getOption(""repos"")))
+          install.packages(c(""posterior"", ""cmdstanr"", ""remotes""),repos = c(""https://mc-stan.org/r-packages/"", getOption(""repos"")))
           cmdstanr::install_cmdstan(cores = 2, overwrite = TRUE, release_url = ""https://github.com/stan-dev/cmdstan/releases/download/v2.23.0/cmdstan-2.23.0.tar.gz"")
           remotes::install_deps(dependencies = TRUE)
           remotes::install_cran(""covr"")",False,False,Data / Input Handling,3
stan-dev,cmdstanr,3b7c49379e20f6e15bed68ecf15b8f3fe1dd960a,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-13T08:17:36Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-13T08:17:49Z,fix threading,DESCRIPTION;R/run.R;tests/testthat/test-threads.R,False,True,True,False,11,4,15,"---FILE: DESCRIPTION---
@@ -1,6 +1,6 @@
 Package: cmdstanr
 Title: R Interface to 'CmdStan'
-Version: 0.0.0.9004
+Version: 0.0.0.9005
 Authors@R: 
     c(person(given = ""Jonah"", family = ""Gabry"", role = c(""aut"", ""cre""),
            email = ""jsg2201@columbia.edu""),

---FILE: R/run.R---
@@ -215,7 +215,7 @@ CmdStanRun <- R6::R6Class(
     current_path <- Sys.getenv(""PATH"")
     if (regexpr(""path_to_TBB"", current_path, perl = TRUE) <= 0) {
       Sys.setenv(PATH = paste0(path_to_TBB, "";"", Sys.getenv(""PATH"")))
-    }    
+    }
   }
   if (procs$num_runs() == 1) {
     start_msg <- ""Running MCMC with 1 chain""
@@ -230,8 +230,10 @@ CmdStanRun <- R6::R6Class(
   }
   if (is.null(procs$threads_per_chain())) {
     cat(paste0(start_msg, ""...\n\n""))
+    Sys.setenv(""STAN_NUM_THREADS"" = """")
   } else {
     cat(paste0(start_msg, "", with "", procs$threads_per_chain(), "" thread(s) per chain...\n\n""))
+    Sys.setenv(""STAN_NUM_THREADS"" = as.integer(procs$threads_per_chain()))
   }
   start_time <- Sys.time()
   chains <- procs$run_ids()
@@ -319,7 +321,7 @@ CmdStanProcs <- R6::R6Class(
                                    .var.name = ""threads_per_chain"")
       private$num_runs_ <- as.integer(num_runs)
       private$num_cores_ <- as.integer(num_cores)
-      private$threads_per_chain_ <- as.integer(threads_per_chain)
+      private$threads_per_chain_ <- threads_per_chain
       private$active_cores_ <- 0
       private$run_ids_ <- seq_len(num_runs)
       zeros <- rep(0, num_runs)

---FILE: tests/testthat/test-threads.R---
@@ -9,7 +9,6 @@ if (not_on_cran()) {
 test_that(""using threads_per_chain without stan_threads set in compile() warns"", {
   skip_on_cran()
   mod <- cmdstan_model(stan_program)
-
   expect_warning(
     expect_output(
       mod$sample(data = data_file_json, threads_per_chain = 4),
@@ -35,15 +34,21 @@ test_that(""threading works"", {
     ""Running MCMC with 4 parallel chains, with 1 thread(s) per chain.."",
     fixed = TRUE
   )
+  num_threads <- as.integer(Sys.getenv(""STAN_NUM_THREADS""))
+  expect_equal(num_threads, 1)
   expect_output(
     mod$sample(data = data_file_json,  parallel_chains = 4, threads_per_chain = 2),
     ""Running MCMC with 4 parallel chains, with 2 thread(s) per chain.."",
     fixed = TRUE
   )
+  num_threads <- as.integer(Sys.getenv(""STAN_NUM_THREADS""))
+  expect_equal(num_threads, 2)
   expect_output(
     mod$sample(data = data_file_json,  parallel_chains = 4, threads_per_chain = 4),
     ""Running MCMC with 4 parallel chains, with 4 thread(s) per chain.."",
     fixed = TRUE
   )
+  num_threads <- as.integer(Sys.getenv(""STAN_NUM_THREADS""))
+  expect_equal(num_threads, 4)
 })
 ",True,False,Dependency / Package,6
stan-dev,cmdstanr,2c5eaedc282060db42c98d24c2fd51133a088acb,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-12T13:26:03Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-12T13:26:03Z,ubuntu fix,.github/workflows/R-CMD-check.yaml,False,False,False,False,1,0,1,"---FILE: .github/workflows/R-CMD-check.yaml---
@@ -61,6 +61,7 @@ jobs:
           Rscript -e ""remotes::install_github('r-hub/sysreqs')""
           sysreqs=$(Rscript -e ""cat(sysreqs::sysreq_commands('DESCRIPTION'))"")
           sudo -s eval ""$sysreqs""
+          sudo apt install r-cran-stringi
 
       - name: Install dependencies
         run: |",False,False,Data / Input Handling,3
stan-dev,cmdstanr,14e039e715aa8682469b6fedcc77c6dcbd77fa63,jgabry,jgabry@gmail.com,2020-06-11T22:26:42Z,jgabry,jgabry@gmail.com,2020-06-11T22:26:42Z,fix typo in doc link,R/fit.R;man/CmdStanMCMC.Rd,False,True,True,False,2,2,4,"---FILE: R/fit.R---
@@ -380,7 +380,7 @@ NULL
 #'
 #' @description A `CmdStanMCMC` object is the fitted model object returned by
 #'   the [`$sample()`][model-method-sample] method of a [`CmdStanModel`] object.
-#'   Like `CmdStanModel` objects, `CmdStanMCMC` objects are [R6][R6::R6class]
+#'   Like `CmdStanModel` objects, `CmdStanMCMC` objects are [R6][R6::R6Class]
 #'   objects.
 #'
 #' @details

---FILE: man/CmdStanMCMC.Rd---
@@ -6,7 +6,7 @@
 \description{
 A \code{CmdStanMCMC} object is the fitted model object returned by
 the \code{\link[=model-method-sample]{$sample()}} method of a \code{\link{CmdStanModel}} object.
-Like \code{CmdStanModel} objects, \code{CmdStanMCMC} objects are \link[R6:R6class]{R6}
+Like \code{CmdStanModel} objects, \code{CmdStanMCMC} objects are \link[R6:R6Class]{R6}
 objects.
 }
 \details{",True,False,Documentation / Formatting,7
stan-dev,cmdstanr,266202fa11dc60414b90dc41b00031973abf6a21,jgabry,jgabry@gmail.com,2020-06-11T20:51:17Z,jgabry,jgabry@gmail.com,2020-06-11T20:51:17Z,fix R cmd check warnings about doc links,R/fit.R;R/model.R;man/CmdStanMCMC.Rd;man/CmdStanMLE.Rd;man/CmdStanModel.Rd;man/CmdStanVB.Rd;man/fit-method-draws.Rd;man/fit-method-sampler_diagnostics.Rd;man/fit-method-summary.Rd,False,True,True,False,40,35,75,"---FILE: R/fit.R---
@@ -128,7 +128,8 @@ CmdStanFit <- R6::R6Class(
 #' variables are included.
 #' * `inc_warmup`: (logical) For MCMC only, should warmup draws be included?
 #' Defaults to `FALSE`.
-#' * `...`: Arguments passed on to [posterior::as_draws()].
+#' * `...`: Arguments passed on to
+#' [`posterior::as_draws_array()`][posterior::draws_array].
 #'
 #' @section Value:
 #' * For MCMC, a 3-D [`draws_array`][posterior::draws_array] object (iteration x
@@ -196,7 +197,8 @@ NULL
 #'   ```
 #' @section Arguments:
 #' * `inc_warmup`: (logical) Should warmup draws be included? Defaults to `FALSE`.
-#' * `...`: Optional arguments to pass to [posterior::as_draws_array()].
+#' * `...`: Arguments passed on to
+#' [`posterior::as_draws_array()`][posterior::draws_array].
 #'
 #' @section Value:
 #' A 3-D [`draws_array`][posterior::draws_array] object (iteration x chain x
@@ -253,23 +255,22 @@ NULL
 
 #' Compute a summary table of MCMC estimates and diagnostics
 #'
-#' Run `posterior::summarise_draws()` to compute a summary table of MCMC
-#' estimates and diagnostics.
-#'
 #' @name fit-method-summary
 #' @aliases summary
-#' @description Run [posterior::summarise_draws()] from the \pkg{posterior}
-#'   package. For MCMC only post-warmup draws are included in the summary.
+#' @description Run [`summarise_draws()`][posterior::draws_summary]
+#'   from the \pkg{posterior} package. For MCMC only post-warmup draws are
+#'   included in the summary.
 #'
 #' @section Usage:
 #'   ```
 #'   $summary(...)
 #'   ```
 #' @section Arguments:
-#' * `...`: Optional arguments to pass to [posterior::summarise_draws()].
+#' * `...`: Optional arguments to pass to
+#' [`posterior::summarise_draws()`][posterior::draws_summary].
 #'
 #' @section Value:
-#' See [posterior::summarise_draws()].
+#' See [`posterior::summarise_draws()`][posterior::draws_summary].
 #'
 #' @seealso [`CmdStanMCMC`], [`CmdStanMLE`], [`CmdStanVB`]
 #'
@@ -379,7 +380,7 @@ NULL
 #'
 #' @description A `CmdStanMCMC` object is the fitted model object returned by
 #'   the [`$sample()`][model-method-sample] method of a [`CmdStanModel`] object.
-#'   Like `CmdStanModel` objects, `CmdStanMCMC` objects are [R6][R6::R6]
+#'   Like `CmdStanModel` objects, `CmdStanMCMC` objects are [R6][R6::R6class]
 #'   objects.
 #'
 #' @details
@@ -392,7 +393,7 @@ NULL
 #'  [`$sampler_diagnostics()`][fit-method-sampler_diagnostics]
 #'    \tab Return sampler diagnostics as a [`draws_array`][posterior::draws_array]. \cr
 #'  [`$summary()`][fit-method-summary]
-#'    \tab Run [posterior::summarise_draws()]. \cr
+#'    \tab Run [`posterior::summarise_draws()`][posterior::draws_summary]. \cr
 #'  [`$lp()`][fit-method-lp]
 #'    \tab Return the total log probability density (`target`) computed in the
 #'  model block of the Stan program. \cr
@@ -603,7 +604,8 @@ CmdStanMCMC <- R6::R6Class(
 #'  **Method** \tab **Description** \cr
 #'  [`draws()`][fit-method-draws] \tab Return the point estimate as a 1-row
 #'  [`draws_matrix`][posterior::draws_matrix]. \cr
-#'  [`$summary()`][fit-method-summary] \tab Run [posterior::summarise_draws()]. \cr
+#'  [`$summary()`][fit-method-summary] \tab Run
+#'  [`posterior::summarise_draws()`][posterior::draws_summary]. \cr
 #'  [`$lp()`][fit-method-lp] \tab Return the total log probability density
 #'  (`target`) computed in the model block of the Stan program. \cr
 #'  `$mle()` \tab Return the penalized maximum likelihod estimate (posterior
@@ -655,7 +657,8 @@ CmdStanMLE <- R6::R6Class(
 #'  **Method** \tab **Description** \cr
 #'  [`$draws()`][fit-method-draws] \tab Return approximate posterior draws
 #'  as a [`draws_matrix`][posterior::draws_matrix]. \cr
-#'  [`$summary()`][fit-method-summary] \tab Run [posterior::summarise_draws()]. \cr
+#'  [`$summary()`][fit-method-summary] \tab
+#'  Run [`posterior::summarise_draws()`][posterior::draws_summary]. \cr
 #'  [`$lp()`][fit-method-lp] \tab Return the total log probability density
 #'  (`target`) computed in the model block of the Stan program. \cr
 #'  [`$lp_approx()`][fit-method-lp] \tab Return the log density of the

---FILE: R/model.R---
@@ -83,10 +83,10 @@ cmdstan_model <- function(stan_file, compile = TRUE, ...) {
 #' CmdStanModel objects
 #'
 #' @name CmdStanModel
-#' @description A `CmdStanModel` object is an [R6][R6::R6] object created by the
-#'   [cmdstan_model()] function. The object stores the path to a Stan program
-#'   and compiled executable (once created), and provides methods for fitting
-#'   the model using Stan's algorithms. See the **Details** section for
+#' @description A `CmdStanModel` object is an [R6][R6::R6Class] object created
+#'   by the [cmdstan_model()] function. The object stores the path to a Stan
+#'   program and compiled executable (once created), and provides methods for
+#'   fitting the model using Stan's algorithms. See the **Details** section for
 #'   available methods.
 #'
 #' @details

---FILE: man/CmdStanMCMC.Rd---
@@ -6,7 +6,7 @@
 \description{
 A \code{CmdStanMCMC} object is the fitted model object returned by
 the \code{\link[=model-method-sample]{$sample()}} method of a \code{\link{CmdStanModel}} object.
-Like \code{CmdStanModel} objects, \code{CmdStanMCMC} objects are \link[R6:R6]{R6}
+Like \code{CmdStanModel} objects, \code{CmdStanMCMC} objects are \link[R6:R6class]{R6}
 objects.
 }
 \details{
@@ -19,7 +19,7 @@ objects.
 \code{\link[=fit-method-sampler_diagnostics]{$sampler_diagnostics()}}
 \tab Return sampler diagnostics as a \code{\link[posterior:draws_array]{draws_array}}. \cr
 \code{\link[=fit-method-summary]{$summary()}}
-\tab Run \code{\link[posterior:summarise_draws]{posterior::summarise_draws()}}. \cr
+\tab Run \code{\link[posterior:draws_summary]{posterior::summarise_draws()}}. \cr
 \code{\link[=fit-method-lp]{$lp()}}
 \tab Return the total log probability density (\code{target}) computed in the
 model block of the Stan program. \cr

---FILE: man/CmdStanMLE.Rd---
@@ -14,7 +14,8 @@ A \code{CmdStanMLE} object is the fitted model object returned by the
 \strong{Method} \tab \strong{Description} \cr
 \code{\link[=fit-method-draws]{draws()}} \tab Return the point estimate as a 1-row
 \code{\link[posterior:draws_matrix]{draws_matrix}}. \cr
-\code{\link[=fit-method-summary]{$summary()}} \tab Run \code{\link[posterior:summarise_draws]{posterior::summarise_draws()}}. \cr
+\code{\link[=fit-method-summary]{$summary()}} \tab Run
+\code{\link[posterior:draws_summary]{posterior::summarise_draws()}}. \cr
 \code{\link[=fit-method-lp]{$lp()}} \tab Return the total log probability density
 (\code{target}) computed in the model block of the Stan program. \cr
 \verb{$mle()} \tab Return the penalized maximum likelihod estimate (posterior

---FILE: man/CmdStanModel.Rd---
@@ -4,10 +4,10 @@
 \alias{CmdStanModel}
 \title{CmdStanModel objects}
 \description{
-A \code{CmdStanModel} object is an \link[R6:R6]{R6} object created by the
-\code{\link[=cmdstan_model]{cmdstan_model()}} function. The object stores the path to a Stan program
-and compiled executable (once created), and provides methods for fitting
-the model using Stan's algorithms. See the \strong{Details} section for
+A \code{CmdStanModel} object is an \link[R6:R6Class]{R6} object created
+by the \code{\link[=cmdstan_model]{cmdstan_model()}} function. The object stores the path to a Stan
+program and compiled executable (once created), and provides methods for
+fitting the model using Stan's algorithms. See the \strong{Details} section for
 available methods.
 }
 \details{

---FILE: man/CmdStanVB.Rd---
@@ -15,7 +15,8 @@ A \code{CmdStanVB} object is the fitted model object returned by the
 \strong{Method} \tab \strong{Description} \cr
 \code{\link[=fit-method-draws]{$draws()}} \tab Return approximate posterior draws
 as a \code{\link[posterior:draws_matrix]{draws_matrix}}. \cr
-\code{\link[=fit-method-summary]{$summary()}} \tab Run \code{\link[posterior:summarise_draws]{posterior::summarise_draws()}}. \cr
+\code{\link[=fit-method-summary]{$summary()}} \tab
+Run \code{\link[posterior:draws_summary]{posterior::summarise_draws()}}. \cr
 \code{\link[=fit-method-lp]{$lp()}} \tab Return the total log probability density
 (\code{target}) computed in the model block of the Stan program. \cr
 \code{\link[=fit-method-lp]{$lp_approx()}} \tab Return the log density of the

---FILE: man/fit-method-draws.Rd---
@@ -26,7 +26,8 @@ quantities) to read in. If \code{NULL} (the default) then the draws of all
 variables are included.
 \item \code{inc_warmup}: (logical) For MCMC only, should warmup draws be included?
 Defaults to \code{FALSE}.
-\item \code{...}: Arguments passed on to \code{\link[posterior:as_draws]{posterior::as_draws()}}.
+\item \code{...}: Arguments passed on to
+\code{\link[posterior:draws_array]{posterior::as_draws_array()}}.
 }
 }
 

---FILE: man/fit-method-sampler_diagnostics.Rd---
@@ -17,7 +17,8 @@ chain of MCMC.
 
 \itemize{
 \item \code{inc_warmup}: (logical) Should warmup draws be included? Defaults to \code{FALSE}.
-\item \code{...}: Optional arguments to pass to \code{\link[posterior:as_draws_array]{posterior::as_draws_array()}}.
+\item \code{...}: Arguments passed on to
+\code{\link[posterior:draws_array]{posterior::as_draws_array()}}.
 }
 }
 

---FILE: man/fit-method-summary.Rd---
@@ -5,12 +5,9 @@
 \alias{summary}
 \title{Compute a summary table of MCMC estimates and diagnostics}
 \description{
-Run \code{\link[posterior:summarise_draws]{posterior::summarise_draws()}} from the \pkg{posterior}
-package. For MCMC only post-warmup draws are included in the summary.
-}
-\details{
-Run \code{posterior::summarise_draws()} to compute a summary table of MCMC
-estimates and diagnostics.
+Run \code{\link[posterior:draws_summary]{summarise_draws()}}
+from the \pkg{posterior} package. For MCMC only post-warmup draws are
+included in the summary.
 }
 \section{Usage}{
 \preformatted{$summary(...)
@@ -20,13 +17,14 @@ estimates and diagnostics.
 \section{Arguments}{
 
 \itemize{
-\item \code{...}: Optional arguments to pass to \code{\link[posterior:summarise_draws]{posterior::summarise_draws()}}.
+\item \code{...}: Optional arguments to pass to
+\code{\link[posterior:draws_summary]{posterior::summarise_draws()}}.
 }
 }
 
 \section{Value}{
 
-See \code{\link[posterior:summarise_draws]{posterior::summarise_draws()}}.
+See \code{\link[posterior:draws_summary]{posterior::summarise_draws()}}.
 }
 
 \examples{",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,ae324cba83993d83f4e2b8e065c80486ec08e7dc,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-11T19:55:09Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-11T19:55:09Z,fix one more test,tests/testthat/test-model-sample-metric.R,False,True,True,False,3,3,6,"---FILE: tests/testthat/test-model-sample-metric.R---
@@ -45,7 +45,7 @@ test_that(""sample() method works with provided inv_metrics"", {
 
   expect_sample_output(fit_r <- mod$sample(data = data_list,
                                            chains = 3,
-                                           cores = 2,
+                                           parallel_chains = 2,
                                            metric = ""dense_e"",
                                            metric_file = inv_metric_matrix_r))
 })
@@ -69,7 +69,7 @@ test_that(""sample() method works with lists of inv_metrics"", {
 
   expect_error(fit_r <- mod$sample(data = data_list,
                                    chains = 3,
-                                   cores = 2,
+                                   parallel_chains = 2,
                                    metric = ""diag_e"",
                                    inv_metric = list(inv_metric_vector, inv_metric_vector)),
                ""2 metric\\(s\\) provided. Must provide 1 or 3 metric\\(s\\) for 3 chain\\(s\\)"")
@@ -91,7 +91,7 @@ test_that(""sample() method works with lists of inv_metrics"", {
 
   expect_error(fit_r <- mod$sample(data = data_list,
                                    chains = 3,
-                                   cores = 2,
+                                   parallel_chains = 2,
                                    metric = ""diag_e"",
                                    metric_file = c(inv_metric_vector_json, inv_metric_vector_json)),
                ""2 metric\\(s\\) provided. Must provide 1 or 3 metric\\(s\\) for 3 chain\\(s\\)"")",True,False,Implementation / Logic,3
stan-dev,cmdstanr,63e6631d381e96187f0cb592c61620c691793e97,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-11T19:53:42Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-11T19:53:42Z,fix tests,R/run.R;tests/testthat/helper-custom-expectations.R;tests/testthat/test-model-sample.R,False,True,True,False,9,4,13,"---FILE: R/run.R---
@@ -218,7 +218,7 @@ CmdStanRun <- R6::R6Class(
     }    
   }
   if (procs$num_runs() == 1) {
-    start_msg <- ""Running MCMC with one chain""
+    start_msg <- ""Running MCMC with 1 chain""
   } else if (procs$num_runs() == procs$num_cores()) {
     start_msg <- paste0(""Running MCMC with "", procs$num_runs(), "" parallel chains"")
   } else {
@@ -314,7 +314,7 @@ CmdStanProcs <- R6::R6Class(
     initialize = function(num_runs, num_cores, threads_per_chain = NULL) {
       checkmate::assert_integerish(num_runs, lower = 1, len = 1, any.missing = FALSE)
       checkmate::assert_integerish(num_cores, lower = 1, len = 1, any.missing = FALSE,
-                                   .var.name = ""cores"")
+                                   .var.name = ""parallel_chains"")
       checkmate::assert_integerish(threads_per_chain, lower = 1, len = 1, null.ok = TRUE,
                                    .var.name = ""threads_per_chain"")
       private$num_runs_ <- as.integer(num_runs)

---FILE: tests/testthat/helper-custom-expectations.R---
@@ -6,9 +6,14 @@ expect_experimental_message <- function(object) {
 }
 
 expect_sample_output <- function(object, num_chains = NULL) {
+  
   output <- ""Running MCMC with""
   if (!is.null(num_chains)) {
-    output <- paste(output, num_chains, ""chain"")
+    if (num_chains == 1) {
+      output <- paste(output, num_chains, ""chain"")
+    } else {
+      output <- paste(output, num_chains, ""sequential chain"")
+    }
   }
   expect_output(object, output)
 }

---FILE: tests/testthat/test-model-sample.R---
@@ -184,7 +184,7 @@ test_that(""mc.cores option detected"", {
   options(mc.cores = NULL)
   expect_output(
     mod$sample(data = data_list, chains = 2),
-    ""Running MCMC with 2 sequential chains "",
+    ""Running MCMC with 2 sequential chains"",
     fixed = TRUE
   )
 })",True,False,Implementation / Logic,6
stan-dev,cmdstanr,5bde0489539fefbeb864b124bf180e94c5e09eb2,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-10T10:09:34Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-10T10:18:19Z,fix cpp_options storing,R/model.R,False,True,True,False,19,10,29,"---FILE: R/model.R---
@@ -119,7 +119,10 @@ CmdStanModel <- R6::R6Class(
     exe_file_ = character(),
     cpp_options_ = list(),
     stanc_options_ = list(),
-    include_paths_ = NULL
+    include_paths_ = NULL,
+    precompile_cpp_options_ = NULL,
+    precompile_stanc_options_ = NULL,
+    precompile_include_paths_ = NULL
   ),
   public = list(
     initialize = function(stan_file, compile, ...) {
@@ -129,15 +132,15 @@ CmdStanModel <- R6::R6Class(
       args <- list(...)
       cpp_options_exists <- ""cpp_options"" %in% names(args)
       if (cpp_options_exists) {
-        private$cpp_options_ = args$cpp_options
+        private$precompile_cpp_options_ = args$cpp_options
       }
       stanc_options_exists <- ""stanc_options"" %in% names(args)
       if (stanc_options_exists) {
-        private$stanc_options_ = args$stanc_options
+        private$precompile_stanc_options_ = args$stanc_options
       }
       include_paths_exists <- ""include_paths"" %in% names(args)
       if (include_paths_exists) {
-        private$include_paths_ = args$include_paths
+        private$precompile_include_paths_ = args$include_paths
       }
       if (compile) {
         self$compile(...)
@@ -236,14 +239,14 @@ compile_method <- function(quiet = TRUE,
                            force_recompile = FALSE,
                            #deprecated
                            threads = FALSE) {
-  if (!length(cpp_options) && length(private$cpp_options_)) {
-    cpp_options <- private$cpp_options_
+  if (length(cpp_options) == 0 && !is.null(private$precompile_cpp_options_)) {
+    cpp_options = private$precompile_cpp_options_
   }
-  if (!length(stanc_options) && length(private$stanc_options_)) {
-    stanc_options <- private$stanc_options_
+  if (length(stanc_options) == 0 && !is.null(private$precompile_stanc_options_)) {
+    stanc_options = private$precompile_stanc_options_
   }
-  if (is.null(include_paths) && !is.null(private$include_paths_)) {
-    include_paths <- private$include_paths_
+  if (is.null(include_paths) && !is.null(private$precompile_include_paths_)) {
+    include_paths = private$precompile_include_paths_
   }
   # temporary deprecation warnings
   if (isTRUE(threads)) {
@@ -283,6 +286,9 @@ compile_method <- function(quiet = TRUE,
   if (!force_recompile) {
     message(""Model executable is up to date!"")
     private$cpp_options_ <- cpp_options
+    private$precompile_cpp_options_ <- NULL
+    private$precompile_stanc_options_ <- NULL
+    private$precompile_include_paths_ <- NULL
     self$exe_file(exe)
     return(invisible(self))
   } else {
@@ -341,6 +347,9 @@ compile_method <- function(quiet = TRUE,
 
   file.copy(tmp_exe, exe, overwrite = TRUE)
   private$cpp_options_ <- cpp_options
+  private$precompile_cpp_options_ <- NULL
+  private$precompile_stanc_options_ <- NULL
+  private$precompile_include_paths_ <- NULL
   private$exe_file_ <- exe
   invisible(self)
 }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,dbf058d59fb5013d559799dce3f6f54881e16454,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-10T06:38:56Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-10T06:38:56Z,fix time diff testing,tests/testthat/test-model-compile.R,False,True,True,False,4,2,6,"---FILE: tests/testthat/test-model-compile.R---
@@ -147,7 +147,8 @@ test_that(""switching threads on and off works without rebuild"", {
   before_mtime <- file.mtime(main_path_o)
   mod$compile(force_recompile = TRUE, cpp_options = list(stan_threads = TRUE))
   after_mtime <- file.mtime(main_path_o)
-  expect_gt(after_mtime, before_mtime)
+  time_diff <- as.double((after_mtime - before_mtime), units = ""secs"")
+  expect_gt(time_diff, 0)
 
   before_mtime <- file.mtime(main_path_o)
   mod$compile(force_recompile = TRUE, cpp_options = list(stan_threads = TRUE))
@@ -157,5 +158,6 @@ test_that(""switching threads on and off works without rebuild"", {
   before_mtime <- file.mtime(main_path_o)
   mod$compile(force_recompile = TRUE)
   after_mtime <- file.mtime(main_path_o)
-  expect_gt(after_mtime, before_mtime)
+  time_diff <- as.double((after_mtime - before_mtime), units = ""secs"")
+  expect_gt(time_diff, 0)
 })",True,False,Rendering / Conversion,3
stan-dev,cmdstanr,d95ce249b1f4a9f245c9db15f75e51e83b20e5ab,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-09T19:17:09Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-09T19:17:09Z,fix appveyor,.appveyor.yml,False,False,False,False,1,0,1,"---FILE: .appveyor.yml---
@@ -64,6 +64,7 @@ install:
   - Rscript -e ""sessionInfo()""
   - Rscript -e ""install.packages(c('remotes', 'covr', 'knitr', 'xml2'), repos = 'https://cloud.r-project.org')""
   - Rscript -e ""options(repos = c('https://mc-stan.org/r-packages', CRAN = 'https://cloud.r-project.org'), download.file.method = 'auto')""
+  - Rscript -e ""install.packages('posterior', repos = c('https://mc-stan.org/r-packages', CRAN = 'https://cloud.r-project.org'))""
   - Rscript -e ""remotes::install_deps(dependencies = TRUE, type='win.binary')""
   - echo ""Finished installing R dependencies""
 ",False,False,Data / Input Handling,3
stan-dev,cmdstanr,de5bd0fb8182c42ab02febd72cb80b9622629616,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-09T18:48:11Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-09T18:48:11Z,fix typo,.appveyor.yml,False,False,False,False,1,1,2,"---FILE: .appveyor.yml---
@@ -63,7 +63,7 @@ install:
   - echo ""Installing R package dependencies""
   - Rscript -e ""sessionInfo()""
   - Rscript -e ""install.packages(c('remotes', 'covr', 'knitr', 'xml2'), repos = 'https://cloud.r-project.org')""
-  - Rscript -e ""options(repos = c(""https://mc-stan.org/r-packages"", CRAN = 'https://cloud.r-project.org'), download.file.method = 'auto')""
+  - Rscript -e ""options(repos = c('https://mc-stan.org/r-packages', CRAN = 'https://cloud.r-project.org'), download.file.method = 'auto')""
   - Rscript -e ""remotes::install_deps(dependencies = TRUE, type='win.binary')""
   - echo ""Finished installing R dependencies""
 ",False,False,Data / Input Handling,3
stan-dev,cmdstanr,a999ed9150c17cc7b9bf2d985601afa992be5cee,jgabry,jgabry@gmail.com,2020-06-08T18:44:20Z,jgabry,jgabry@gmail.com,2020-06-08T18:44:20Z,"""parameter"" -> ""variable"" in error messages",R/fit.R;R/read_csv.R;tests/testthat/test-csv.R;tests/testthat/test-fit-mcmc.R,False,True,True,False,25,16,41,"---FILE: R/fit.R---
@@ -423,7 +423,8 @@ CmdStanMCMC <- R6::R6Class(
       }
       matching_res <- matching_variables(variables, private$sampling_info_$model_params)
       if (length(matching_res$not_found)) {
-        stop(""Can't find parameter(s): "", paste(matching_res$not_found, collapse = "", ""), "" in the sampling output!"")
+        stop(""Can't find the following variable(s) in the sampling output: "",
+             paste(matching_res$not_found, collapse = "", ""))
       }
       variables <- repair_variable_names(matching_res$matching)
       if (inc_warmup) {

---FILE: R/read_csv.R---
@@ -119,20 +119,21 @@ read_sample_csv <- function(files,
       id <- csv_file_info$id
     }
     if (is.null(col_select)) {
-      if (is.null(variables)) { # variables = NULL returns all parameters
+      if (is.null(variables)) { # variables = NULL returns all
         variables <- sampling_info$model_params
-      } else if (!any(nzchar(variables))) { # if variables = """" returns no parameters
+      } else if (!any(nzchar(variables))) { # if variables = """" returns none
         variables <- NULL
       } else { # filter using variables
         res <- matching_variables(variables, sampling_info$model_params)
         if (length(res$not_found)) {
-          stop(""Can't find parameter(s): "", paste(res$not_found, collapse = "", ""), "" in the sampling output!"")
+          stop(""Can't find the following variable(s) in the sampling output: "",
+               paste(res$not_found, collapse = "", ""))
         }
         variables <- res$matching
       }
       if (is.null(sampler_diagnostics)) {
         sampler_diagnostics <- sampling_info$sampler_diagnostics
-      } else if (!any(nzchar(sampler_diagnostics))) { # if sampler_diagnostics = """" dont return any sampler_diagnostics
+      } else if (!any(nzchar(sampler_diagnostics))) { # if sampler_diagnostics = """" returns none
         sampler_diagnostics <- NULL
       } else {
         selected_sampler_diag <- rep(FALSE, length(sampling_info$sampler_diagnostics))
@@ -145,7 +146,8 @@ read_sample_csv <- function(files,
           selected_sampler_diag <- selected_sampler_diag | matches
         }
         if (length(not_found)) {
-          stop(""Can't find sampler diagnostic(s): "", paste(not_found, collapse = "", ""), "" in the sampling output!"")
+          stop(""Can't find the following sampler diagnostic(s) in the sampling output: "",
+               paste(not_found, collapse = "", ""))
         }
         sampler_diagnostics <- sampling_info$sampler_diagnostics[selected_sampler_diag]
       }
@@ -400,7 +402,7 @@ read_sample_info_csv <- function(csv_file) {
     stop(""Supplied CSV file was not generated with sampling. Consider using read_optim_csv or read_vb_csv!"")
   }
   if (length(csv_file_info$sampler_diagnostics) == 0 && length(csv_file_info$model_params) == 0) {
-    stop(""The supplied csv file does not contain any parameter names or data!"")
+    stop(""The supplied csv file does not contain any variable names or data!"")
   }
   if (inverse_metric_rows > 0) {
     rows <- inverse_metric_rows
@@ -444,7 +446,7 @@ check_sampling_csv_info_matches <- function(a, b) {
   if ((length(a$model_params) != length(b$model_params)) ||
       !(all(a$model_params == b$model_params) &&
         all(a$sampler_diagnostics == b$sampler_diagnostics))) {
-    return(list(error = ""Supplied CSV files have samples for different parameters!""))
+    return(list(error = ""Supplied CSV files have samples for different variables!""))
   }
   if (a$iter_sampling != b$iter_sampling ||
       a$thin != b$thin ||

---FILE: tests/testthat/test-csv.R---
@@ -55,12 +55,12 @@ test_that(""read_sample_csv() fails for different number of samples in csv"", {
                  ""Supplied CSV files dont match in the number of stored samples!"")
 })
 
-test_that(""read_sample_csv() fails for different parameters"", {
+test_that(""read_sample_csv() fails for different variables"", {
   skip_on_cran()
   csv_files <- c(fit_bernoulli_thin_1$output_files(),
                  test_path(""resources"", ""csv"", ""bernoulli-3-diff_params.csv""))
   expect_error(read_sample_csv(csv_files),
-               ""Supplied CSV files have samples for different parameters!"")
+               ""Supplied CSV files have samples for different variables!"")
 })
 
 test_that(""read_sample_csv() fails if the file does not exist"", {
@@ -89,7 +89,7 @@ test_that(""read_sample_csv() fails with the no params listed"", {
   skip_on_cran()
   file_path <- test_path(""resources"", ""csv"", ""model1-3-no-params.csv"")
   expect_error(read_sample_csv(file_path),
-               ""The supplied csv file does not contain any parameter names or data!"")
+               ""The supplied csv file does not contain any variable names or data!"")
 })
 
 test_that(""read_sample_csv() matches rstan::read_stan_csv()"", {
@@ -275,7 +275,7 @@ test_that(""read_sample_csv() works with thin"", {
   expect_equal(dim(csv_output_10_with_warmup$warmup_draws), c(100, 2, 5))
 })
 
-test_that(""read_sample_csv() works with filtered parameters"", {
+test_that(""read_sample_csv() works with filtered variables"", {
   skip_on_cran()
   csv_output_1 <- read_sample_csv(fit_logistic_thin_1$output_files(), variables = NULL, sampler_diagnostics = list())
   expect_equal(dim(csv_output_1$post_warmup_draws), c(1000, 2, 5))
@@ -302,7 +302,11 @@ test_that(""read_sample_csv() works with filtered parameters"", {
   expect_equal(dim(csv_output_1$post_warmup_draws), c(1000, 2, 2))
   expect_equal(dim(csv_output_1$post_warmup_sampler_diagnostics), c(1000, 2, 2))
   expect_error(read_sample_csv(fit_logistic_thin_1$output_files(), variables = c(""NOPE""), sampler_diagnostics = list(""n_leapfrog__"", ""divergent__"")),
-               ""Can\'t find parameter\\(s\\)\\: NOPE in the sampling output!"")
+               ""Can't find the following variable(s) in the sampling output: NOPE"",
+               fixed = TRUE)
+  expect_error(read_sample_csv(fit_logistic_thin_1$output_files(), sampler_diagnostics = list(""BAD_1"", ""BAD_2"")),
+               ""Can't find the following sampler diagnostic(s) in the sampling output: BAD_1, BAD_2"",
+               fixed = TRUE)
 })
 
 test_that(""read_sample_csv() works with no samples"", {

---FILE: tests/testthat/test-fit-mcmc.R---
@@ -21,12 +21,14 @@ if (not_on_cran()) {
 test_that(""draws() stops for unkown variables"", {
   expect_error(
     draws_betas <- fit_mcmc$draws(variables = ""ABCD""),
-    ""Can't find parameter\\(s\\): ABCD in the sampling output!""
+    ""Can't find the following variable(s) in the sampling output: ABCD"",
+    fixed = TRUE
   )
   fit_mcmc$draws()
   expect_error(
-    draws_betas <- fit_mcmc$draws(variables = ""ABCD""),
-    ""Can't find parameter\\(s\\): ABCD in the sampling output!""
+    draws_betas <- fit_mcmc$draws(variables = c(""ABCD"", ""EFGH"")),
+    ""Can't find the following variable(s) in the sampling output: ABCD, EFGH"",
+    fixed = TRUE
   )
 })
 ",True,False,Implementation / Logic,6
stan-dev,cmdstanr,3d79193397a61eb8af50b00aca958e6d24a921fa,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-08T17:15:31Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-08T17:15:31Z,bugfix and test,R/fit.R;tests/testthat/test-fit-mcmc.R,False,True,True,False,17,1,18,"---FILE: R/fit.R---
@@ -421,7 +421,11 @@ CmdStanMCMC <- R6::R6Class(
       if (is.null(variables)) {
         variables <- private$sampling_info_$model_params
       }
-      variables <- repair_variable_names(matching_variables(variables, private$sampling_info_$model_params)$matching)
+      matching_res <- matching_variables(variables, private$sampling_info_$model_params)
+      if (length(matching_res$not_found)) {
+        stop(""Can't find parameter(s): "", paste(matching_res$not_found, collapse = "", ""), "" in the sampling output!"")
+      }
+      variables <- repair_variable_names(matching_res$matching)
       if (inc_warmup) {
         if (!private$sampling_info_$save_warmup) {
           stop(""Warmup draws were requested from a fit object without them! "",

---FILE: tests/testthat/test-fit-mcmc.R---
@@ -18,6 +18,18 @@ if (not_on_cran()) {
 }
 
 
+test_that(""draws() stops for unkown variables"", {
+  expect_error(
+    draws_betas <- fit_mcmc$draws(variables = ""ABCD""),
+    ""Can't find parameter\\(s\\): ABCD in the sampling output!""
+  )
+  fit_mcmc$draws()
+  expect_error(
+    draws_betas <- fit_mcmc$draws(variables = ""ABCD""),
+    ""Can't find parameter\\(s\\): ABCD in the sampling output!""
+  )
+})
+
 test_that(""draws() method returns draws_array (reading csv works)"", {
   skip_on_cran()
   draws <- fit_mcmc$draws()",True,False,Implementation / Logic,6
stan-dev,cmdstanr,2f385f1a55d566c3520e5e590feb8c838eebc901,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-08T06:15:22Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-08T06:15:22Z,fix docs,R/model.R;man/cmdstan_model.Rd,False,True,True,False,0,3,3,"---FILE: R/model.R---
@@ -6,7 +6,6 @@
 #'
 #' @export
 #' @param stan_file The path to a `.stan` file containing a Stan program.
-#' @param exe_file Optionally, a path to an existing executable.
 #' @param compile Do compilation? The default is `TRUE`. If `FALSE`
 #'   compilation can be done later via the [`$compile()`][model-method-compile]
 #'   method.

---FILE: man/cmdstan_model.Rd---
@@ -15,8 +15,6 @@ method.}
 
 \item{...}{Optionally, additional arguments to pass to the
 \code{\link[=model-method-compile]{$compile()}} method if \code{compile=TRUE}.}
-
-\item{exe_file}{Optionally, a path to an existing executable.}
 }
 \value{
 A \code{\link{CmdStanModel}} object.",True,False,Documentation / Formatting,7
stan-dev,cmdstanr,af5e214b466ac6a888fc1543b9275451ceb71fe8,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-06T12:44:06Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-06T12:44:06Z,add tests and bugfix,R/fit.R;tests/testthat/test-fit-mcmc.R,False,True,True,False,26,3,29,"---FILE: R/fit.R---
@@ -410,8 +410,9 @@ CmdStanMCMC <- R6::R6Class(
         currently_read = dimnames(private$draws_)$variable,
         all = private$sampling_info_$model_params
       )
+      
       if (is.null(to_read) || (length(to_read) > 0)) {
-        private$read_csv_(variables = variables, sampler_diagnostics = """")
+        private$read_csv_(variables = to_read, sampler_diagnostics = """")
       }
       if (is.null(variables)) {
         variables <- private$sampling_info_$model_params
@@ -485,7 +486,7 @@ CmdStanMCMC <- R6::R6Class(
         } else {
           private$draws_ <-
             posterior::bind_draws(
-              data_csv$post_warmup_draws[,,-1],
+              data_csv$post_warmup_draws,
               private$draws_,
               along=""variable""
             )
@@ -511,7 +512,7 @@ CmdStanMCMC <- R6::R6Class(
           } else {
             private$warmup_draws_ <-
               posterior::bind_draws(
-                data_csv$warmup_draws[,,-1],
+                data_csv$warmup_draws,
                 private$warmup_draws_,
                 along=""variable""
               )

---FILE: tests/testthat/test-fit-mcmc.R---
@@ -21,10 +21,26 @@ if (not_on_cran()) {
 test_that(""draws() method returns draws_array (reading csv works)"", {
   skip_on_cran()
   draws <- fit_mcmc$draws()
+  draws_betas <- fit_mcmc$draws(variables = ""beta"")
+  draws_beta <- fit_mcmc$draws(variables = ""beta[1]"")
+  draws_alpha_beta <- fit_mcmc$draws(variables = c(""alpha"", ""beta""))
+  draws_all_after <- fit_mcmc$draws()
   expect_type(draws, ""double"")
   expect_s3_class(draws, ""draws_array"")
   expect_equal(posterior::variables(draws), c(""lp__"", PARAM_NAMES))
   expect_equal(posterior::nchains(draws), fit_mcmc$num_chains())
+  expect_s3_class(draws_betas, ""draws_array"")
+  expect_equal(posterior::nvariables(draws_betas), 3)
+  expect_equal(posterior::nchains(draws_betas), fit_mcmc$num_chains())
+  expect_s3_class(draws_beta, ""draws_array"")
+  expect_equal(posterior::nvariables(draws_beta), 1)
+  expect_equal(posterior::nchains(draws_beta), fit_mcmc$num_chains())
+  expect_s3_class(draws_alpha_beta, ""draws_array"")
+  expect_equal(posterior::nvariables(draws_alpha_beta), 4)
+  expect_equal(posterior::nchains(draws_alpha_beta), fit_mcmc$num_chains())
+  expect_s3_class(draws_all_after, ""draws_array"")
+  expect_equal(posterior::nvariables(draws_all_after), 5)
+  expect_equal(posterior::nchains(draws_all_after), fit_mcmc$num_chains())
 })
 
 test_that(""summary() method works after mcmc"", {
@@ -84,11 +100,17 @@ test_that(""inc_warmup in draws() works"", {
   x0 <- fit_mcmc_0$draws(inc_warmup = FALSE)
   x1 <- fit_mcmc_1$draws(inc_warmup = FALSE)
   x2 <- fit_mcmc_1$draws(inc_warmup = TRUE)
+  x2_a <- fit_mcmc_1$draws(inc_warmup = TRUE, variables = c(""alpha""))
+  x2_b <- fit_mcmc_1$draws(inc_warmup = TRUE, variables = c(""beta""))
+  x2_after <- fit_mcmc_1$draws(inc_warmup = TRUE)
   expect_equal(dim(x0), c(1000, 2, 5))
   expect_error(fit_mcmc_0$draws(inc_warmup = TRUE),
                ""Warmup draws were requested from a fit object without them!"")
   expect_equal(dim(x1), c(1000, 2, 5))
   expect_equal(dim(x2), c(2000, 2, 5))
+  expect_equal(dim(x2_a), c(2000, 2, 1))
+  expect_equal(dim(x2_b), c(2000, 2, 3))
+  expect_equal(dim(x2_after), c(2000, 2, 5))
   y0 <- fit_mcmc_0$sampler_diagnostics(inc_warmup = FALSE)
   y1 <- fit_mcmc_1$sampler_diagnostics(inc_warmup = FALSE)
   y2 <- fit_mcmc_1$sampler_diagnostics(inc_warmup = TRUE)",True,False,Implementation / Logic,6
stan-dev,cmdstanr,d54ad27e049e43976fed297682306fc01d88cf67,jgabry,jgabry@gmail.com,2020-06-05T19:19:32Z,jgabry,jgabry@gmail.com,2020-06-05T19:19:32Z,fix typo in error message,R/read_csv.R;tests/testthat/test-csv.R,False,True,True,False,2,2,4,"---FILE: R/read_csv.R---
@@ -449,7 +449,7 @@ read_sample_info_csv <- function(csv_file) {
 #'
 check_sampling_csv_info_matches <- function(a, b) {
   if (a$model_name != b$model_name) {
-    return(list(error = ""Supplied CSV files were not generated wtih the same model!""))
+    return(list(error = ""Supplied CSV files were not generated with the same model!""))
   }
   if ((length(a$model_params) != length(b$model_params)) ||
       !(all(a$model_params == b$model_params) &&

---FILE: tests/testthat/test-csv.R---
@@ -32,7 +32,7 @@ test_that(""read_sample_csv() fails for different model names"", {
   csv_files <- c(fit_bernoulli_thin_1$output_files(),
                  fit_logistic_thin_1$output_files())
   expect_error(read_sample_csv(csv_files),
-               ""Supplied CSV files were not generated wtih the same model!"")
+               ""Supplied CSV files were not generated with the same model!"")
 })
 
 test_that(""read_sample_csv() fails for different number of samples in csv"", {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,4e8de0f851b4ba3b76ec43e39892c0be20e524d6,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-03T11:54:34Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-03T11:54:34Z,debugging travis issue,tests/testthat/test-csv.R,False,True,True,False,355,355,710,"---FILE: tests/testthat/test-csv.R---
@@ -1,355 +1,355 @@
-context(""read-sample-csv"")
-
-if (not_on_cran()) {
-  set_cmdstan_path()
-  fit_bernoulli_optimize <- testing_fit(""bernoulli"", method = ""optimize"")
-  fit_bernoulli_diag_e_no_samples <- testing_fit(""bernoulli"", method = ""sample"",
-                          seed = 123, chains = 2, iter_sampling = 0, metric = ""diag_e"")
-  fit_bernoulli_dense_e_no_samples <- testing_fit(""bernoulli"", method = ""sample"",
-                          seed = 123, chains = 2, iter_sampling = 0, metric = ""dense_e"")
-  fit_bernoulli_thin_1 <- testing_fit(""bernoulli"", method = ""sample"",
-                          seed = 123, chains = 2, iter_sampling = 1000, iter_warmup = 1000, thin = 1)
-  fit_logistic_thin_1 <- testing_fit(""logistic"", method = ""sample"",
-                          seed = 123, chains = 2, iter_sampling = 1000, iter_warmup = 1000, thin = 1)
-  fit_logistic_thin_1a <- testing_fit(""logistic"", method = ""sample"",
-                                     seed = 123, chains = 2, iter_sampling = 500, iter_warmup = 1000, thin = 1)
-  fit_logistic_thin_1b <- testing_fit(""logistic"", method = ""sample"",
-                                      seed = 123, chains = 2, iter_sampling = 1000, iter_warmup = 500, thin = 1)
-  fit_logistic_thin_1_with_warmup <- testing_fit(""logistic"", method = ""sample"",
-                          seed = 123, chains = 2, iter_sampling = 1000, iter_warmup = 1000, thin = 1, save_warmup = 1)
-  fit_logistic_thin_3 <- testing_fit(""logistic"", method = ""sample"",
-                          seed = 123, chains = 2, iter_sampling = 1000, iter_warmup = 1000, thin = 3)
-  fit_logistic_thin_3_with_warmup <- testing_fit(""logistic"", method = ""sample"",
-                          seed = 123, chains = 2, iter_sampling = 1000, iter_warmup = 1000, thin = 3, save_warmup = 1)
-  fit_logistic_thin_10 <- testing_fit(""logistic"", method = ""sample"",
-                          seed = 123, chains = 2, iter_sampling = 1000, iter_warmup = 1000, thin = 10, save_warmup = 0)
-  fit_logistic_thin_10_with_warmup <- testing_fit(""logistic"", method = ""sample"",
-                          seed = 123, chains = 2, iter_sampling = 1000, iter_warmup = 1000, thin = 10, save_warmup = 1)
-}
-
-test_that(""read_sample_csv() fails for different model names"", {
-  skip_on_cran()
-  csv_files <- c(fit_bernoulli_thin_1$output_files(),
-                 fit_logistic_thin_1$output_files())
-  expect_error(read_sample_csv(csv_files),
-               ""Supplied CSV files were not generated wtih the same model!"")
-})
-
-test_that(""read_sample_csv() fails for different number of samples in csv"", {
-  skip_on_cran()
-  csv_files <- c(fit_logistic_thin_1$output_files(),
-                 fit_logistic_thin_10$output_files())
-  expect_error(read_sample_csv(csv_files),
-               ""Supplied CSV files dont match in the number of stored samples!"")
-  csv_files <- c(fit_logistic_thin_1$output_files(),
-                 fit_logistic_thin_1a$output_files())
-  expect_error(read_sample_csv(csv_files),
-               ""Supplied CSV files dont match in the number of stored samples!"")
-  csv_files <- c(fit_logistic_thin_1$output_files(),
-                 fit_logistic_thin_1b$output_files())
-  expect_warning(read_sample_csv(csv_files),
-               ""The supplied csv files do not match in the following arguments: iter_warmup!"")
-  csv_files <- c(fit_logistic_thin_1$output_files(),
-                 fit_logistic_thin_1_with_warmup$output_files())
-  expect_error(read_sample_csv(csv_files),
-                 ""Supplied CSV files dont match in the number of stored samples!"")
-})
-
-test_that(""read_sample_csv() fails for different parameters"", {
-  skip_on_cran()
-  csv_files <- c(fit_bernoulli_thin_1$output_files(),
-                 test_path(""resources"", ""csv"", ""bernoulli-3-diff_params.csv""))
-  expect_error(read_sample_csv(csv_files),
-               ""Supplied CSV files have samples for different parameters!"")
-})
-
-test_that(""read_sample_csv() fails if the file does not exist"", {
-  skip_on_cran()
-  csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-doesntexist.csv""))
-  expect_error(read_sample_csv(csv_files),
-               ""Assertion on 'output_file' failed: File does not exist: 'resources/csv/model1-1-doesntexist.csv'."")
-})
-
-test_that(""read_sample_csv() fails for non-sampling csv"", {
-  skip_on_cran()
-  expect_error(read_sample_csv(fit_bernoulli_optimize$output_files()),
-               ""Supplied CSV file was not generated with sampling. Consider using read_optim_csv or read_vb_csv!"")
-})
-
-test_that(""read_sample_csv() fails with empty csv file"", {
-  skip_on_cran()
-  file_path <- test_path(""resources"", ""csv"", ""empty.csv"")
-  file.create(file_path)
-  expect_error(read_sample_csv(file_path),
-               ""Supplied CSV file is corrupt!"")
-  file.remove(file_path)
-})
-
-test_that(""read_sample_csv() fails with the no params listed"", {
-  skip_on_cran()
-  file_path <- test_path(""resources"", ""csv"", ""model1-3-no-params.csv"")
-  expect_error(read_sample_csv(file_path),
-               ""The supplied csv file does not contain any parameter names or data!"")
-})
-
-test_that(""read_sample_csv() matches rstan::read_stan_csv()"", {
-  skip_on_cran()
-  csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-warmup.csv""),
-                 test_path(""resources"", ""csv"", ""model1-2-warmup.csv""))
-
-  draws_array <- readRDS(test_path(""answers"", ""rstan-read-stan-csv-no-warmup.rds""))
-  draws_array <- posterior::as_draws_array(draws_array)
-  csv_output <- read_sample_csv(csv_files)
-  expect_equal(csv_output$post_warmup_draws[,, ""mu""],
-               draws_array[,,""mu""])
-  expect_equal(csv_output$post_warmup_draws[,, ""sigma""],
-               draws_array[,,""sigma""])
-  expect_equal(csv_output$post_warmup_draws[,, ""lp__""],
-               draws_array[,,""lp__""])
-})
-
-test_that(""read_sample_csv() matches rstan::read_stan_csv() with save_warmup"", {
-  skip_on_cran()
-  csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-warmup.csv""),
-                 test_path(""resources"", ""csv"", ""model1-2-warmup.csv""))
-
-  draws_array <- readRDS(test_path(""answers"", ""rstan-read-stan-csv-warmup.rds""))
-  draws_array <- posterior::as_draws_array(draws_array)
-  csv_output <- read_sample_csv(csv_files)
-
-  warmup_iter <- csv_output$sampling_info$iter_warmup
-  num_iter <- csv_output$sampling_info$iter_sampling + csv_output$sampling_info$iter_warmup
-
-  draws_array_post_warmup <- draws_array[(warmup_iter+1):num_iter,,]
-  draws_array_warmup <- draws_array[1:warmup_iter,,]
-
-  expect_equal(posterior::extract_variable_matrix(csv_output$post_warmup_draws, ""mu""),
-               posterior::extract_variable_matrix(draws_array_post_warmup, ""mu""))
-  expect_equal(posterior::extract_variable_matrix(csv_output$post_warmup_draws, ""sigma""),
-               posterior::extract_variable_matrix(draws_array_post_warmup, ""sigma""))
-  expect_equal(posterior::extract_variable_matrix(csv_output$post_warmup_draws, ""lp__""),
-               posterior::extract_variable_matrix(draws_array_post_warmup, ""lp__""))
-  expect_equal(posterior::extract_variable_matrix(csv_output$warmup_draws, ""mu""),
-               posterior::extract_variable_matrix(draws_array_warmup, ""mu""))
-  expect_equal(posterior::extract_variable_matrix(csv_output$warmup_draws, ""sigma""),
-               posterior::extract_variable_matrix(draws_array_warmup, ""sigma""))
-  expect_equal(posterior::extract_variable_matrix(csv_output$warmup_draws, ""lp__""),
-               posterior::extract_variable_matrix(draws_array_warmup, ""lp__""))
-})
-
-test_that(""read_sample_csv() matches rstan::read_stan_csv() for csv file without warmup"", {
-  skip_on_cran()
-  csv_files <- c(test_path(""resources"", ""csv"", ""model1-2-no-warmup.csv""))
-
-  draws_array <- readRDS(test_path(""answers"", ""rstan-read-stan-csv-no-warmup-file.rds""))
-  draws_array <- posterior::as_draws_array(draws_array)
-  csv_output <- read_sample_csv(csv_files)
-
-  expect_equal(posterior::extract_variable_matrix(csv_output$post_warmup_draws, ""mu""),
-               posterior::extract_variable_matrix(draws_array, ""mu""))
-  expect_equal(posterior::extract_variable_matrix(csv_output$post_warmup_draws, ""sigma""),
-               posterior::extract_variable_matrix(draws_array, ""sigma""))
-  expect_equal(posterior::extract_variable_matrix(csv_output$post_warmup_draws, ""lp__""),
-               posterior::extract_variable_matrix(draws_array, ""lp__""))
-})
-
-test_that(""read_sample_csv() returns correct diagonal of inverse mass matrix"", {
-  skip_on_cran()
-  csv_files <- c(test_path(""resources"", ""csv"", ""model1-2-no-warmup.csv""))
-  csv_output <- read_sample_csv(csv_files)
-  expect_equal(as.vector(csv_output$inverse_metric[[2]]),
-               c(0.909635, 0.066384))
-  csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-warmup.csv""),test_path(""resources"", ""csv"", ""model1-2-warmup.csv""))
-  csv_output <- read_sample_csv(csv_files)
-  expect_equal(as.vector(csv_output$inverse_metric[[1]]),
-               c(1.00098, 0.068748))
-  expect_equal(as.vector(csv_output$inverse_metric[[2]]),
-               c(0.909635, 0.066384))
-})
-
-test_that(""read_sample_csv() returns correct dense inverse mass matrix"", {
-  skip_on_cran()
-  csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-dense_e_metric.csv""))
-  csv_output <- read_sample_csv(csv_files)
-  expect_equal(as.vector(csv_output$inverse_metric[[1]]),
-               c(10.2742, -0.189148, 5.92065, 8.2658, 10.9931, 8.67196, 9.75007, 8.30008, 6.3396, 8.75422,
-                -0.189148, 0.552614, 2.28054, 0.587285, -0.557112, 0.0689745, -1.06614, -0.502288, 1.49863, 0.450733,
-                5.92065, 2.28054, 52.7011, 7.89278, 3.9639, 5.71556, 2.16445, 1.88834, 13.8962, 15.1166,
-                8.2658, 0.587285, 7.89278, 30.7924, 8.39762, 8.51489, 8.27253, 9.96521, 7.58758, 7.8403,
-                10.9931, -0.557112, 3.9639, 8.39762, 39.6164, 9.88103, 9.62453, 9.80744, 6.28594, 6.77034,
-                8.67196, 0.0689745, 5.71556, 8.51489, 9.88103, 29.6702, 8.5937, 8.3289, 8.76294, 5.63637,
-                9.75007, -1.06614, 2.16445, 8.27253, 9.62453, 8.5937, 26.3294, 10.1908, 2.76266, 4.56938,
-                8.30008, -0.502288, 1.88834, 9.96521, 9.80744, 8.3289, 10.1908, 26.5846, 3.7247, 4.26521,
-                6.3396, 1.49863, 13.8962, 7.58758, 6.28594, 8.76294, 2.76266, 3.7247, 28.8872, 8.43035,
-                8.75422, 0.450733, 15.1166, 7.8403, 6.77034, 5.63637, 4.56938, 4.26521, 8.43035, 42.5438))
-})
-
-test_that(""read_sample_csv() returns correct dense inverse mass matrix for 2 csv files "", {
-  skip_on_cran()
-  csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-dense_e_metric.csv""),
-                 test_path(""resources"", ""csv"", ""model1-2-dense_e_metric.csv""))
-  csv_output <- read_sample_csv(csv_files)
-  expect_equal(as.vector(csv_output$inverse_metric[[1]]),
-             c(10.2742, -0.189148, 5.92065, 8.2658, 10.9931, 8.67196, 9.75007, 8.30008, 6.3396, 8.75422,
-                -0.189148, 0.552614, 2.28054, 0.587285, -0.557112, 0.0689745, -1.06614, -0.502288, 1.49863, 0.450733,
-                5.92065, 2.28054, 52.7011, 7.89278, 3.9639, 5.71556, 2.16445, 1.88834, 13.8962, 15.1166,
-                8.2658, 0.587285, 7.89278, 30.7924, 8.39762, 8.51489, 8.27253, 9.96521, 7.58758, 7.8403,
-                10.9931, -0.557112, 3.9639, 8.39762, 39.6164, 9.88103, 9.62453, 9.80744, 6.28594, 6.77034,
-                8.67196, 0.0689745, 5.71556, 8.51489, 9.88103, 29.6702, 8.5937, 8.3289, 8.76294, 5.63637,
-                9.75007, -1.06614, 2.16445, 8.27253, 9.62453, 8.5937, 26.3294, 10.1908, 2.76266, 4.56938,
-                8.30008, -0.502288, 1.88834, 9.96521, 9.80744, 8.3289, 10.1908, 26.5846, 3.7247, 4.26521,
-                6.3396, 1.49863, 13.8962, 7.58758, 6.28594, 8.76294, 2.76266, 3.7247, 28.8872, 8.43035,
-                8.75422, 0.450733, 15.1166, 7.8403, 6.77034, 5.63637, 4.56938, 4.26521, 8.43035, 42.5438))
-  expect_equal(as.vector(csv_output$inverse_metric[[2]]),
-             c( 11.08, -0.305763, 5.27013, 7.33046, 7.31263, 6.93229, 10.1923, 7.46852, 7.51557, 7.78791,
-                -0.305763, 0.678461, 1.70598, 0.337143, -0.69887, 0.423236, -0.974023, -0.605539, 1.83794, 0.0780934,
-                5.27013, 1.70598, 36.2726, 7.9386, 3.88642, 12.0214, 4.2487, 3.84886, 12.9738, 4.34037,
-                7.33046, 0.337143, 7.9386, 23.9878, 4.93047, 5.76139, 7.34008, 7.78631, 6.79063, 8.13132,
-                7.31263, -0.69887, 3.88642, 4.93047, 25.3662, 7.2269, 7.5408, 8.18066, 5.77239, 7.53072,
-                6.93229, 0.423236, 12.0214, 5.76139, 7.2269, 24.0619, 7.24315, 7.194, 10.1647, 5.61617,
-                10.1923, -0.974023, 4.2487, 7.34008, 7.5408, 7.24315, 26.2403, 6.91029, 1.26095, 4.72335,
-                7.46852, -0.605539, 3.84886, 7.78631, 8.18066, 7.194, 6.91029, 30.2862, 5.61914, 8.10162,
-                7.51557, 1.83794, 12.9738, 6.79063, 5.77239, 10.1647, 1.26095, 5.61914, 34.5498, 7.75486,
-                7.78791, 0.0780934, 4.34037, 8.13132, 7.53072, 5.61617, 4.72335, 8.10162, 7.75486, 35.6602))
-})
-
-test_that(""read_sample_csv() matches rstan::read_stan_csv() for csv file"", {
-  skip_on_cran()
-  csv_files <- c(test_path(""resources"", ""csv"", ""model1-2-warmup.csv""))
-
-  sampler_diagnostics <- readRDS(test_path(""answers"", ""rstan-read-stan-csv-sampler-params.rds""))
-  sampler_diagnostics <- posterior::as_draws_array(sampler_diagnostics[[1]])
-  csv_output <- read_sample_csv(csv_files)
-  num_warmup <- csv_output$sampling_info$iter_warmup/csv_output$sampling_info$thin
-  if(csv_output$sampling_info$save_warmup) {
-    num_iter <- csv_output$sampling_info$iter_sampling + csv_output$sampling_info$iter_warmup
-  } else {
-    num_iter <- csv_output$sampling_info$iter_sampling
-  }
-
-  # match warmup sampler info
-  expect_equal(posterior::extract_variable_matrix(csv_output$warmup_sampler_diagnostics, ""divergent__""),
-               posterior::extract_variable_matrix(sampler_diagnostics[1:num_warmup,,], ""divergent__""))
-  expect_equal(posterior::extract_variable_matrix(csv_output$warmup_sampler_diagnostics, ""accept_stat__""),
-               posterior::extract_variable_matrix(sampler_diagnostics[1:num_warmup,,], ""accept_stat__""))
-  expect_equal(posterior::extract_variable_matrix(csv_output$warmup_sampler_diagnostics, ""treedepth__""),
-               posterior::extract_variable_matrix(sampler_diagnostics[1:num_warmup,,], ""treedepth__""))
-  expect_equal(posterior::extract_variable_matrix(csv_output$warmup_sampler_diagnostics, ""stepsize__""),
-               posterior::extract_variable_matrix(sampler_diagnostics[1:num_warmup,,], ""stepsize__""))
-  expect_equal(posterior::extract_variable_matrix(csv_output$warmup_sampler_diagnostics, ""n_leapfrog__""),
-               posterior::extract_variable_matrix(sampler_diagnostics[1:num_warmup,,], ""n_leapfrog__""))
-  expect_equal(posterior::extract_variable_matrix(csv_output$warmup_sampler_diagnostics, ""energy__""),
-               posterior::extract_variable_matrix(sampler_diagnostics[1:num_warmup,,], ""energy__""))
-  # match post-warmup sampling info
-  expect_equal(posterior::extract_variable_matrix(csv_output$post_warmup_sampler_diagnostics, ""divergent__""),
-               posterior::extract_variable_matrix(sampler_diagnostics[(num_warmup+1):num_iter,,], ""divergent__""))
-  expect_equal(posterior::extract_variable_matrix(csv_output$post_warmup_sampler_diagnostics, ""accept_stat__""),
-               posterior::extract_variable_matrix(sampler_diagnostics[(num_warmup+1):num_iter,,], ""accept_stat__""))
-  expect_equal(posterior::extract_variable_matrix(csv_output$post_warmup_sampler_diagnostics, ""treedepth__""),
-               posterior::extract_variable_matrix(sampler_diagnostics[(num_warmup+1):num_iter,,], ""treedepth__""))
-  expect_equal(posterior::extract_variable_matrix(csv_output$post_warmup_sampler_diagnostics, ""stepsize__""),
-               posterior::extract_variable_matrix(sampler_diagnostics[(num_warmup+1):num_iter,,], ""stepsize__""))
-  expect_equal(posterior::extract_variable_matrix(csv_output$post_warmup_sampler_diagnostics, ""n_leapfrog__""),
-               posterior::extract_variable_matrix(sampler_diagnostics[(num_warmup+1):num_iter,,], ""n_leapfrog__""))
-  expect_equal(posterior::extract_variable_matrix(csv_output$post_warmup_sampler_diagnostics, ""energy__""),
-               posterior::extract_variable_matrix(sampler_diagnostics[(num_warmup+1):num_iter,,], ""energy__""))
-})
-
-test_that(""read_sample_csv() works with thin"", {
-  skip_on_cran()
-
-  csv_output_1 <- read_sample_csv(fit_logistic_thin_1$output_files())
-  csv_output_3 <- read_sample_csv(fit_logistic_thin_3$output_files())
-  csv_output_10 <- read_sample_csv(fit_logistic_thin_10$output_files())
-  csv_output_1_with_warmup <- read_sample_csv(fit_logistic_thin_1_with_warmup$output_files())
-  csv_output_3_with_warmup <- read_sample_csv(fit_logistic_thin_3_with_warmup$output_files())
-  csv_output_10_with_warmup <- read_sample_csv(fit_logistic_thin_10_with_warmup$output_files())
-  expect_equal(dim(csv_output_1$post_warmup_draws), c(1000, 2, 5))
-  expect_equal(dim(csv_output_3$post_warmup_draws), c(334, 2, 5))
-  expect_equal(dim(csv_output_10$post_warmup_draws), c(100, 2, 5))
-  expect_equal(dim(csv_output_1_with_warmup$post_warmup_draws), c(1000, 2, 5))
-  expect_equal(dim(csv_output_1_with_warmup$warmup_draws), c(1000, 2, 5))
-  expect_equal(dim(csv_output_3_with_warmup$post_warmup_draws), c(334, 2, 5))
-  expect_equal(dim(csv_output_3_with_warmup$warmup_draws), c(334, 2, 5))
-  expect_equal(dim(csv_output_10_with_warmup$post_warmup_draws), c(100, 2, 5))
-  expect_equal(dim(csv_output_10_with_warmup$warmup_draws), c(100, 2, 5))
-})
-
-test_that(""read_sample_csv() works with filtered parameters"", {
-  skip_on_cran()
-  csv_output_1 <- read_sample_csv(fit_logistic_thin_1$output_files(), pars = NULL, sampler_diagnostics = list())
-  expect_equal(dim(csv_output_1$post_warmup_draws), c(1000, 2, 5))
-  expect_equal(dim(csv_output_1$post_warmup_sampler_diagnostics), NULL)
-  csv_output_1 <- read_sample_csv(fit_logistic_thin_1$output_files(), pars = """", sampler_diagnostics = """")
-  expect_equal(dim(csv_output_1$post_warmup_draws), NULL)
-  expect_equal(dim(csv_output_1$post_warmup_sampler_diagnostics), NULL)
-  csv_output_1 <- read_sample_csv(fit_logistic_thin_1$output_files(), pars = """", sampler_diagnostics = NULL)
-  expect_equal(dim(csv_output_1$post_warmup_draws), NULL)
-  expect_equal(dim(csv_output_1$post_warmup_sampler_diagnostics), c(1000, 2, 6))
-  csv_output_1 <- read_sample_csv(fit_logistic_thin_1$output_files(), pars = c(""lp__"", ""alpha""), sampler_diagnostics = """")
-  expect_equal(dim(csv_output_1$post_warmup_draws), c(1000, 2, 2))
-  expect_equal(dim(csv_output_1$post_warmup_sampler_diagnostics), NULL)
-  csv_output_1 <- read_sample_csv(fit_logistic_thin_1$output_files(), pars = c(""lp__"", ""beta[1]""), sampler_diagnostics = """")
-  expect_equal(dim(csv_output_1$post_warmup_draws), c(1000, 2, 2))
-  expect_equal(dim(csv_output_1$post_warmup_sampler_diagnostics), NULL)
-  csv_output_1 <- read_sample_csv(fit_logistic_thin_1$output_files(), pars = c(""lp__"", ""beta""), sampler_diagnostics = """")
-  expect_equal(dim(csv_output_1$post_warmup_draws), c(1000, 2, 4))
-  expect_equal(dim(csv_output_1$post_warmup_sampler_diagnostics), NULL)
-  csv_output_1 <- read_sample_csv(fit_logistic_thin_1$output_files(), pars = """", sampler_diagnostics = c(""n_leapfrog__"", ""divergent__""))
-  expect_equal(dim(csv_output_1$post_warmup_draws), NULL)
-  expect_equal(dim(csv_output_1$post_warmup_sampler_diagnostics), c(1000, 2, 2))
-  csv_output_1 <- read_sample_csv(fit_logistic_thin_1$output_files(), pars = c(""lp__"", ""alpha""), sampler_diagnostics = c(""n_leapfrog__"", ""divergent__""))
-  expect_equal(dim(csv_output_1$post_warmup_draws), c(1000, 2, 2))
-  expect_equal(dim(csv_output_1$post_warmup_sampler_diagnostics), c(1000, 2, 2))
-  expect_error(read_sample_csv(fit_logistic_thin_1$output_files(), pars = c(""NOPE""), sampler_diagnostics = list(""n_leapfrog__"", ""divergent__"")),
-               ""Can\'t find parameter\\(s\\)\\: NOPE in the sampling output!"")
-})
-
-test_that(""read_sample_csv() works with no samples"", {
-  skip_on_cran()
-
-  csv_output_diag_e_0 <- read_sample_csv(fit_bernoulli_diag_e_no_samples$output_files())
-  expect_equal(csv_output_diag_e_0$post_warmup_draws, NULL)
-  csv_output_dense_e_0 <- read_sample_csv(fit_bernoulli_dense_e_no_samples$output_files())
-  expect_equal(csv_output_dense_e_0$post_warmup_draws, NULL)
-})
-
-test_that(""read_sample_csv() reads values up to adaptation"", {
-  skip_on_cran()
-
-  csv_files <- test_path(""resources"", ""csv"", ""bernoulli-3-diff_params.csv"")
-
-  csv_out <- read_sample_csv(csv_files)
-  expect_equal(csv_out$sampling_info$pi, 3.14)
-  expect_true(is.null(csv_out$sampling_info$pi_square))
-})
-
-test_that(""remaining_columns_to_read() works"", {
-  expect_equal(remaining_columns_to_read(NULL, NULL, NULL), NULL)
-  expect_equal(remaining_columns_to_read(NULL, c(""a""), NULL), NULL)
-  expect_equal(remaining_columns_to_read(NULL, NULL, c(""a"")), c(""a""))
-  expect_equal(remaining_columns_to_read(c(""a""), c(""a""), NULL), """")
-  expect_equal(remaining_columns_to_read(c(""a""), NULL, c(""a"")), c(""a""))
-  expect_equal(remaining_columns_to_read(c(""a""), c(""a"", ""b"", ""c""), NULL), """")
-  expect_equal(remaining_columns_to_read(c(""a""), NULL, c(""a"", ""b"", ""c"")), c(""a""))
-  expect_equal(remaining_columns_to_read(NULL, c(""a"", ""b"", ""c""), NULL), NULL)
-  expect_equal(remaining_columns_to_read(NULL, NULL, c(""a"", ""b"", ""c"")), c(""a"", ""b"", ""c""))
-  expect_equal(remaining_columns_to_read(c(""a"", ""b"", ""c""), c(""a"", ""b"", ""c""), NULL), """")
-  expect_equal(remaining_columns_to_read(c(""a"", ""b"", ""c""), NULL, c(""a"", ""b"", ""c"")), c(""a"", ""b"", ""c""))
-})
-
-test_that(""read_sample_csv() reads adaptation step size correctly"", {
-  skip_on_cran()
-
-  csv_files <- test_path(""resources"", ""csv"", ""model1-2-no-warmup.csv"")
-
-  csv_out <- read_sample_csv(csv_files)
-  expect_equal(csv_out$step_size[[2]], 0.672434)
-
-  csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-dense_e_metric.csv""),
-                 test_path(""resources"", ""csv"", ""model1-2-dense_e_metric.csv""))
-
-  csv_out <- read_sample_csv(csv_files)
-  expect_equal(csv_out$step_size[[1]], 0.11757)
-  expect_equal(csv_out$step_size[[2]], 0.232778)
-})
+# context(""read-sample-csv"")
+#
+# if (not_on_cran()) {
+#   set_cmdstan_path()
+#   fit_bernoulli_optimize <- testing_fit(""bernoulli"", method = ""optimize"")
+#   fit_bernoulli_diag_e_no_samples <- testing_fit(""bernoulli"", method = ""sample"",
+#                           seed = 123, chains = 2, iter_sampling = 0, metric = ""diag_e"")
+#   fit_bernoulli_dense_e_no_samples <- testing_fit(""bernoulli"", method = ""sample"",
+#                           seed = 123, chains = 2, iter_sampling = 0, metric = ""dense_e"")
+#   fit_bernoulli_thin_1 <- testing_fit(""bernoulli"", method = ""sample"",
+#                           seed = 123, chains = 2, iter_sampling = 1000, iter_warmup = 1000, thin = 1)
+#   fit_logistic_thin_1 <- testing_fit(""logistic"", method = ""sample"",
+#                           seed = 123, chains = 2, iter_sampling = 1000, iter_warmup = 1000, thin = 1)
+#   fit_logistic_thin_1a <- testing_fit(""logistic"", method = ""sample"",
+#                                      seed = 123, chains = 2, iter_sampling = 500, iter_warmup = 1000, thin = 1)
+#   fit_logistic_thin_1b <- testing_fit(""logistic"", method = ""sample"",
+#                                       seed = 123, chains = 2, iter_sampling = 1000, iter_warmup = 500, thin = 1)
+#   fit_logistic_thin_1_with_warmup <- testing_fit(""logistic"", method = ""sample"",
+#                           seed = 123, chains = 2, iter_sampling = 1000, iter_warmup = 1000, thin = 1, save_warmup = 1)
+#   fit_logistic_thin_3 <- testing_fit(""logistic"", method = ""sample"",
+#                           seed = 123, chains = 2, iter_sampling = 1000, iter_warmup = 1000, thin = 3)
+#   fit_logistic_thin_3_with_warmup <- testing_fit(""logistic"", method = ""sample"",
+#                           seed = 123, chains = 2, iter_sampling = 1000, iter_warmup = 1000, thin = 3, save_warmup = 1)
+#   fit_logistic_thin_10 <- testing_fit(""logistic"", method = ""sample"",
+#                           seed = 123, chains = 2, iter_sampling = 1000, iter_warmup = 1000, thin = 10, save_warmup = 0)
+#   fit_logistic_thin_10_with_warmup <- testing_fit(""logistic"", method = ""sample"",
+#                           seed = 123, chains = 2, iter_sampling = 1000, iter_warmup = 1000, thin = 10, save_warmup = 1)
+# }
+#
+# test_that(""read_sample_csv() fails for different model names"", {
+#   skip_on_cran()
+#   csv_files <- c(fit_bernoulli_thin_1$output_files(),
+#                  fit_logistic_thin_1$output_files())
+#   expect_error(read_sample_csv(csv_files),
+#                ""Supplied CSV files were not generated wtih the same model!"")
+# })
+#
+# test_that(""read_sample_csv() fails for different number of samples in csv"", {
+#   skip_on_cran()
+#   csv_files <- c(fit_logistic_thin_1$output_files(),
+#                  fit_logistic_thin_10$output_files())
+#   expect_error(read_sample_csv(csv_files),
+#                ""Supplied CSV files dont match in the number of stored samples!"")
+#   csv_files <- c(fit_logistic_thin_1$output_files(),
+#                  fit_logistic_thin_1a$output_files())
+#   expect_error(read_sample_csv(csv_files),
+#                ""Supplied CSV files dont match in the number of stored samples!"")
+#   csv_files <- c(fit_logistic_thin_1$output_files(),
+#                  fit_logistic_thin_1b$output_files())
+#   expect_warning(read_sample_csv(csv_files),
+#                ""The supplied csv files do not match in the following arguments: iter_warmup!"")
+#   csv_files <- c(fit_logistic_thin_1$output_files(),
+#                  fit_logistic_thin_1_with_warmup$output_files())
+#   expect_error(read_sample_csv(csv_files),
+#                  ""Supplied CSV files dont match in the number of stored samples!"")
+# })
+#
+# test_that(""read_sample_csv() fails for different parameters"", {
+#   skip_on_cran()
+#   csv_files <- c(fit_bernoulli_thin_1$output_files(),
+#                  test_path(""resources"", ""csv"", ""bernoulli-3-diff_params.csv""))
+#   expect_error(read_sample_csv(csv_files),
+#                ""Supplied CSV files have samples for different parameters!"")
+# })
+#
+# test_that(""read_sample_csv() fails if the file does not exist"", {
+#   skip_on_cran()
+#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-doesntexist.csv""))
+#   expect_error(read_sample_csv(csv_files),
+#                ""Assertion on 'output_file' failed: File does not exist: 'resources/csv/model1-1-doesntexist.csv'."")
+# })
+#
+# test_that(""read_sample_csv() fails for non-sampling csv"", {
+#   skip_on_cran()
+#   expect_error(read_sample_csv(fit_bernoulli_optimize$output_files()),
+#                ""Supplied CSV file was not generated with sampling. Consider using read_optim_csv or read_vb_csv!"")
+# })
+#
+# test_that(""read_sample_csv() fails with empty csv file"", {
+#   skip_on_cran()
+#   file_path <- test_path(""resources"", ""csv"", ""empty.csv"")
+#   file.create(file_path)
+#   expect_error(read_sample_csv(file_path),
+#                ""Supplied CSV file is corrupt!"")
+#   file.remove(file_path)
+# })
+#
+# test_that(""read_sample_csv() fails with the no params listed"", {
+#   skip_on_cran()
+#   file_path <- test_path(""resources"", ""csv"", ""model1-3-no-params.csv"")
+#   expect_error(read_sample_csv(file_path),
+#                ""The supplied csv file does not contain any parameter names or data!"")
+# })
+#
+# test_that(""read_sample_csv() matches rstan::read_stan_csv()"", {
+#   skip_on_cran()
+#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-warmup.csv""),
+#                  test_path(""resources"", ""csv"", ""model1-2-warmup.csv""))
+#
+#   draws_array <- readRDS(test_path(""answers"", ""rstan-read-stan-csv-no-warmup.rds""))
+#   draws_array <- posterior::as_draws_array(draws_array)
+#   csv_output <- read_sample_csv(csv_files)
+#   expect_equal(csv_output$post_warmup_draws[,, ""mu""],
+#                draws_array[,,""mu""])
+#   expect_equal(csv_output$post_warmup_draws[,, ""sigma""],
+#                draws_array[,,""sigma""])
+#   expect_equal(csv_output$post_warmup_draws[,, ""lp__""],
+#                draws_array[,,""lp__""])
+# })
+#
+# test_that(""read_sample_csv() matches rstan::read_stan_csv() with save_warmup"", {
+#   skip_on_cran()
+#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-warmup.csv""),
+#                  test_path(""resources"", ""csv"", ""model1-2-warmup.csv""))
+#
+#   draws_array <- readRDS(test_path(""answers"", ""rstan-read-stan-csv-warmup.rds""))
+#   draws_array <- posterior::as_draws_array(draws_array)
+#   csv_output <- read_sample_csv(csv_files)
+#
+#   warmup_iter <- csv_output$sampling_info$iter_warmup
+#   num_iter <- csv_output$sampling_info$iter_sampling + csv_output$sampling_info$iter_warmup
+#
+#   draws_array_post_warmup <- draws_array[(warmup_iter+1):num_iter,,]
+#   draws_array_warmup <- draws_array[1:warmup_iter,,]
+#
+#   expect_equal(posterior::extract_variable_matrix(csv_output$post_warmup_draws, ""mu""),
+#                posterior::extract_variable_matrix(draws_array_post_warmup, ""mu""))
+#   expect_equal(posterior::extract_variable_matrix(csv_output$post_warmup_draws, ""sigma""),
+#                posterior::extract_variable_matrix(draws_array_post_warmup, ""sigma""))
+#   expect_equal(posterior::extract_variable_matrix(csv_output$post_warmup_draws, ""lp__""),
+#                posterior::extract_variable_matrix(draws_array_post_warmup, ""lp__""))
+#   expect_equal(posterior::extract_variable_matrix(csv_output$warmup_draws, ""mu""),
+#                posterior::extract_variable_matrix(draws_array_warmup, ""mu""))
+#   expect_equal(posterior::extract_variable_matrix(csv_output$warmup_draws, ""sigma""),
+#                posterior::extract_variable_matrix(draws_array_warmup, ""sigma""))
+#   expect_equal(posterior::extract_variable_matrix(csv_output$warmup_draws, ""lp__""),
+#                posterior::extract_variable_matrix(draws_array_warmup, ""lp__""))
+# })
+#
+# test_that(""read_sample_csv() matches rstan::read_stan_csv() for csv file without warmup"", {
+#   skip_on_cran()
+#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-2-no-warmup.csv""))
+#
+#   draws_array <- readRDS(test_path(""answers"", ""rstan-read-stan-csv-no-warmup-file.rds""))
+#   draws_array <- posterior::as_draws_array(draws_array)
+#   csv_output <- read_sample_csv(csv_files)
+#
+#   expect_equal(posterior::extract_variable_matrix(csv_output$post_warmup_draws, ""mu""),
+#                posterior::extract_variable_matrix(draws_array, ""mu""))
+#   expect_equal(posterior::extract_variable_matrix(csv_output$post_warmup_draws, ""sigma""),
+#                posterior::extract_variable_matrix(draws_array, ""sigma""))
+#   expect_equal(posterior::extract_variable_matrix(csv_output$post_warmup_draws, ""lp__""),
+#                posterior::extract_variable_matrix(draws_array, ""lp__""))
+# })
+#
+# test_that(""read_sample_csv() returns correct diagonal of inverse mass matrix"", {
+#   skip_on_cran()
+#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-2-no-warmup.csv""))
+#   csv_output <- read_sample_csv(csv_files)
+#   expect_equal(as.vector(csv_output$inverse_metric[[2]]),
+#                c(0.909635, 0.066384))
+#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-warmup.csv""),test_path(""resources"", ""csv"", ""model1-2-warmup.csv""))
+#   csv_output <- read_sample_csv(csv_files)
+#   expect_equal(as.vector(csv_output$inverse_metric[[1]]),
+#                c(1.00098, 0.068748))
+#   expect_equal(as.vector(csv_output$inverse_metric[[2]]),
+#                c(0.909635, 0.066384))
+# })
+#
+# test_that(""read_sample_csv() returns correct dense inverse mass matrix"", {
+#   skip_on_cran()
+#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-dense_e_metric.csv""))
+#   csv_output <- read_sample_csv(csv_files)
+#   expect_equal(as.vector(csv_output$inverse_metric[[1]]),
+#                c(10.2742, -0.189148, 5.92065, 8.2658, 10.9931, 8.67196, 9.75007, 8.30008, 6.3396, 8.75422,
+#                 -0.189148, 0.552614, 2.28054, 0.587285, -0.557112, 0.0689745, -1.06614, -0.502288, 1.49863, 0.450733,
+#                 5.92065, 2.28054, 52.7011, 7.89278, 3.9639, 5.71556, 2.16445, 1.88834, 13.8962, 15.1166,
+#                 8.2658, 0.587285, 7.89278, 30.7924, 8.39762, 8.51489, 8.27253, 9.96521, 7.58758, 7.8403,
+#                 10.9931, -0.557112, 3.9639, 8.39762, 39.6164, 9.88103, 9.62453, 9.80744, 6.28594, 6.77034,
+#                 8.67196, 0.0689745, 5.71556, 8.51489, 9.88103, 29.6702, 8.5937, 8.3289, 8.76294, 5.63637,
+#                 9.75007, -1.06614, 2.16445, 8.27253, 9.62453, 8.5937, 26.3294, 10.1908, 2.76266, 4.56938,
+#                 8.30008, -0.502288, 1.88834, 9.96521, 9.80744, 8.3289, 10.1908, 26.5846, 3.7247, 4.26521,
+#                 6.3396, 1.49863, 13.8962, 7.58758, 6.28594, 8.76294, 2.76266, 3.7247, 28.8872, 8.43035,
+#                 8.75422, 0.450733, 15.1166, 7.8403, 6.77034, 5.63637, 4.56938, 4.26521, 8.43035, 42.5438))
+# })
+#
+# test_that(""read_sample_csv() returns correct dense inverse mass matrix for 2 csv files "", {
+#   skip_on_cran()
+#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-dense_e_metric.csv""),
+#                  test_path(""resources"", ""csv"", ""model1-2-dense_e_metric.csv""))
+#   csv_output <- read_sample_csv(csv_files)
+#   expect_equal(as.vector(csv_output$inverse_metric[[1]]),
+#              c(10.2742, -0.189148, 5.92065, 8.2658, 10.9931, 8.67196, 9.75007, 8.30008, 6.3396, 8.75422,
+#                 -0.189148, 0.552614, 2.28054, 0.587285, -0.557112, 0.0689745, -1.06614, -0.502288, 1.49863, 0.450733,
+#                 5.92065, 2.28054, 52.7011, 7.89278, 3.9639, 5.71556, 2.16445, 1.88834, 13.8962, 15.1166,
+#                 8.2658, 0.587285, 7.89278, 30.7924, 8.39762, 8.51489, 8.27253, 9.96521, 7.58758, 7.8403,
+#                 10.9931, -0.557112, 3.9639, 8.39762, 39.6164, 9.88103, 9.62453, 9.80744, 6.28594, 6.77034,
+#                 8.67196, 0.0689745, 5.71556, 8.51489, 9.88103, 29.6702, 8.5937, 8.3289, 8.76294, 5.63637,
+#                 9.75007, -1.06614, 2.16445, 8.27253, 9.62453, 8.5937, 26.3294, 10.1908, 2.76266, 4.56938,
+#                 8.30008, -0.502288, 1.88834, 9.96521, 9.80744, 8.3289, 10.1908, 26.5846, 3.7247, 4.26521,
+#                 6.3396, 1.49863, 13.8962, 7.58758, 6.28594, 8.76294, 2.76266, 3.7247, 28.8872, 8.43035,
+#                 8.75422, 0.450733, 15.1166, 7.8403, 6.77034, 5.63637, 4.56938, 4.26521, 8.43035, 42.5438))
+#   expect_equal(as.vector(csv_output$inverse_metric[[2]]),
+#              c( 11.08, -0.305763, 5.27013, 7.33046, 7.31263, 6.93229, 10.1923, 7.46852, 7.51557, 7.78791,
+#                 -0.305763, 0.678461, 1.70598, 0.337143, -0.69887, 0.423236, -0.974023, -0.605539, 1.83794, 0.0780934,
+#                 5.27013, 1.70598, 36.2726, 7.9386, 3.88642, 12.0214, 4.2487, 3.84886, 12.9738, 4.34037,
+#                 7.33046, 0.337143, 7.9386, 23.9878, 4.93047, 5.76139, 7.34008, 7.78631, 6.79063, 8.13132,
+#                 7.31263, -0.69887, 3.88642, 4.93047, 25.3662, 7.2269, 7.5408, 8.18066, 5.77239, 7.53072,
+#                 6.93229, 0.423236, 12.0214, 5.76139, 7.2269, 24.0619, 7.24315, 7.194, 10.1647, 5.61617,
+#                 10.1923, -0.974023, 4.2487, 7.34008, 7.5408, 7.24315, 26.2403, 6.91029, 1.26095, 4.72335,
+#                 7.46852, -0.605539, 3.84886, 7.78631, 8.18066, 7.194, 6.91029, 30.2862, 5.61914, 8.10162,
+#                 7.51557, 1.83794, 12.9738, 6.79063, 5.77239, 10.1647, 1.26095, 5.61914, 34.5498, 7.75486,
+#                 7.78791, 0.0780934, 4.34037, 8.13132, 7.53072, 5.61617, 4.72335, 8.10162, 7.75486, 35.6602))
+# })
+#
+# test_that(""read_sample_csv() matches rstan::read_stan_csv() for csv file"", {
+#   skip_on_cran()
+#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-2-warmup.csv""))
+#
+#   sampler_diagnostics <- readRDS(test_path(""answers"", ""rstan-read-stan-csv-sampler-params.rds""))
+#   sampler_diagnostics <- posterior::as_draws_array(sampler_diagnostics[[1]])
+#   csv_output <- read_sample_csv(csv_files)
+#   num_warmup <- csv_output$sampling_info$iter_warmup/csv_output$sampling_info$thin
+#   if(csv_output$sampling_info$save_warmup) {
+#     num_iter <- csv_output$sampling_info$iter_sampling + csv_output$sampling_info$iter_warmup
+#   } else {
+#     num_iter <- csv_output$sampling_info$iter_sampling
+#   }
+#
+#   # match warmup sampler info
+#   expect_equal(posterior::extract_variable_matrix(csv_output$warmup_sampler_diagnostics, ""divergent__""),
+#                posterior::extract_variable_matrix(sampler_diagnostics[1:num_warmup,,], ""divergent__""))
+#   expect_equal(posterior::extract_variable_matrix(csv_output$warmup_sampler_diagnostics, ""accept_stat__""),
+#                posterior::extract_variable_matrix(sampler_diagnostics[1:num_warmup,,], ""accept_stat__""))
+#   expect_equal(posterior::extract_variable_matrix(csv_output$warmup_sampler_diagnostics, ""treedepth__""),
+#                posterior::extract_variable_matrix(sampler_diagnostics[1:num_warmup,,], ""treedepth__""))
+#   expect_equal(posterior::extract_variable_matrix(csv_output$warmup_sampler_diagnostics, ""stepsize__""),
+#                posterior::extract_variable_matrix(sampler_diagnostics[1:num_warmup,,], ""stepsize__""))
+#   expect_equal(posterior::extract_variable_matrix(csv_output$warmup_sampler_diagnostics, ""n_leapfrog__""),
+#                posterior::extract_variable_matrix(sampler_diagnostics[1:num_warmup,,], ""n_leapfrog__""))
+#   expect_equal(posterior::extract_variable_matrix(csv_output$warmup_sampler_diagnostics, ""energy__""),
+#                posterior::extract_variable_matrix(sampler_diagnostics[1:num_warmup,,], ""energy__""))
+#   # match post-warmup sampling info
+#   expect_equal(posterior::extract_variable_matrix(csv_output$post_warmup_sampler_diagnostics, ""divergent__""),
+#                posterior::extract_variable_matrix(sampler_diagnostics[(num_warmup+1):num_iter,,], ""divergent__""))
+#   expect_equal(posterior::extract_variable_matrix(csv_output$post_warmup_sampler_diagnostics, ""accept_stat__""),
+#                posterior::extract_variable_matrix(sampler_diagnostics[(num_warmup+1):num_iter,,], ""accept_stat__""))
+#   expect_equal(posterior::extract_variable_matrix(csv_output$post_warmup_sampler_diagnostics, ""treedepth__""),
+#                posterior::extract_variable_matrix(sampler_diagnostics[(num_warmup+1):num_iter,,], ""treedepth__""))
+#   expect_equal(posterior::extract_variable_matrix(csv_output$post_warmup_sampler_diagnostics, ""stepsize__""),
+#                posterior::extract_variable_matrix(sampler_diagnostics[(num_warmup+1):num_iter,,], ""stepsize__""))
+#   expect_equal(posterior::extract_variable_matrix(csv_output$post_warmup_sampler_diagnostics, ""n_leapfrog__""),
+#                posterior::extract_variable_matrix(sampler_diagnostics[(num_warmup+1):num_iter,,], ""n_leapfrog__""))
+#   expect_equal(posterior::extract_variable_matrix(csv_output$post_warmup_sampler_diagnostics, ""energy__""),
+#                posterior::extract_variable_matrix(sampler_diagnostics[(num_warmup+1):num_iter,,], ""energy__""))
+# })
+#
+# test_that(""read_sample_csv() works with thin"", {
+#   skip_on_cran()
+#
+#   csv_output_1 <- read_sample_csv(fit_logistic_thin_1$output_files())
+#   csv_output_3 <- read_sample_csv(fit_logistic_thin_3$output_files())
+#   csv_output_10 <- read_sample_csv(fit_logistic_thin_10$output_files())
+#   csv_output_1_with_warmup <- read_sample_csv(fit_logistic_thin_1_with_warmup$output_files())
+#   csv_output_3_with_warmup <- read_sample_csv(fit_logistic_thin_3_with_warmup$output_files())
+#   csv_output_10_with_warmup <- read_sample_csv(fit_logistic_thin_10_with_warmup$output_files())
+#   expect_equal(dim(csv_output_1$post_warmup_draws), c(1000, 2, 5))
+#   expect_equal(dim(csv_output_3$post_warmup_draws), c(334, 2, 5))
+#   expect_equal(dim(csv_output_10$post_warmup_draws), c(100, 2, 5))
+#   expect_equal(dim(csv_output_1_with_warmup$post_warmup_draws), c(1000, 2, 5))
+#   expect_equal(dim(csv_output_1_with_warmup$warmup_draws), c(1000, 2, 5))
+#   expect_equal(dim(csv_output_3_with_warmup$post_warmup_draws), c(334, 2, 5))
+#   expect_equal(dim(csv_output_3_with_warmup$warmup_draws), c(334, 2, 5))
+#   expect_equal(dim(csv_output_10_with_warmup$post_warmup_draws), c(100, 2, 5))
+#   expect_equal(dim(csv_output_10_with_warmup$warmup_draws), c(100, 2, 5))
+# })
+#
+# test_that(""read_sample_csv() works with filtered parameters"", {
+#   skip_on_cran()
+#   csv_output_1 <- read_sample_csv(fit_logistic_thin_1$output_files(), pars = NULL, sampler_diagnostics = list())
+#   expect_equal(dim(csv_output_1$post_warmup_draws), c(1000, 2, 5))
+#   expect_equal(dim(csv_output_1$post_warmup_sampler_diagnostics), NULL)
+#   csv_output_1 <- read_sample_csv(fit_logistic_thin_1$output_files(), pars = """", sampler_diagnostics = """")
+#   expect_equal(dim(csv_output_1$post_warmup_draws), NULL)
+#   expect_equal(dim(csv_output_1$post_warmup_sampler_diagnostics), NULL)
+#   csv_output_1 <- read_sample_csv(fit_logistic_thin_1$output_files(), pars = """", sampler_diagnostics = NULL)
+#   expect_equal(dim(csv_output_1$post_warmup_draws), NULL)
+#   expect_equal(dim(csv_output_1$post_warmup_sampler_diagnostics), c(1000, 2, 6))
+#   csv_output_1 <- read_sample_csv(fit_logistic_thin_1$output_files(), pars = c(""lp__"", ""alpha""), sampler_diagnostics = """")
+#   expect_equal(dim(csv_output_1$post_warmup_draws), c(1000, 2, 2))
+#   expect_equal(dim(csv_output_1$post_warmup_sampler_diagnostics), NULL)
+#   csv_output_1 <- read_sample_csv(fit_logistic_thin_1$output_files(), pars = c(""lp__"", ""beta[1]""), sampler_diagnostics = """")
+#   expect_equal(dim(csv_output_1$post_warmup_draws), c(1000, 2, 2))
+#   expect_equal(dim(csv_output_1$post_warmup_sampler_diagnostics), NULL)
+#   csv_output_1 <- read_sample_csv(fit_logistic_thin_1$output_files(), pars = c(""lp__"", ""beta""), sampler_diagnostics = """")
+#   expect_equal(dim(csv_output_1$post_warmup_draws), c(1000, 2, 4))
+#   expect_equal(dim(csv_output_1$post_warmup_sampler_diagnostics), NULL)
+#   csv_output_1 <- read_sample_csv(fit_logistic_thin_1$output_files(), pars = """", sampler_diagnostics = c(""n_leapfrog__"", ""divergent__""))
+#   expect_equal(dim(csv_output_1$post_warmup_draws), NULL)
+#   expect_equal(dim(csv_output_1$post_warmup_sampler_diagnostics), c(1000, 2, 2))
+#   csv_output_1 <- read_sample_csv(fit_logistic_thin_1$output_files(), pars = c(""lp__"", ""alpha""), sampler_diagnostics = c(""n_leapfrog__"", ""divergent__""))
+#   expect_equal(dim(csv_output_1$post_warmup_draws), c(1000, 2, 2))
+#   expect_equal(dim(csv_output_1$post_warmup_sampler_diagnostics), c(1000, 2, 2))
+#   expect_error(read_sample_csv(fit_logistic_thin_1$output_files(), pars = c(""NOPE""), sampler_diagnostics = list(""n_leapfrog__"", ""divergent__"")),
+#                ""Can\'t find parameter\\(s\\)\\: NOPE in the sampling output!"")
+# })
+#
+# test_that(""read_sample_csv() works with no samples"", {
+#   skip_on_cran()
+#
+#   csv_output_diag_e_0 <- read_sample_csv(fit_bernoulli_diag_e_no_samples$output_files())
+#   expect_equal(csv_output_diag_e_0$post_warmup_draws, NULL)
+#   csv_output_dense_e_0 <- read_sample_csv(fit_bernoulli_dense_e_no_samples$output_files())
+#   expect_equal(csv_output_dense_e_0$post_warmup_draws, NULL)
+# })
+#
+# test_that(""read_sample_csv() reads values up to adaptation"", {
+#   skip_on_cran()
+#
+#   csv_files <- test_path(""resources"", ""csv"", ""bernoulli-3-diff_params.csv"")
+#
+#   csv_out <- read_sample_csv(csv_files)
+#   expect_equal(csv_out$sampling_info$pi, 3.14)
+#   expect_true(is.null(csv_out$sampling_info$pi_square))
+# })
+#
+# test_that(""remaining_columns_to_read() works"", {
+#   expect_equal(remaining_columns_to_read(NULL, NULL, NULL), NULL)
+#   expect_equal(remaining_columns_to_read(NULL, c(""a""), NULL), NULL)
+#   expect_equal(remaining_columns_to_read(NULL, NULL, c(""a"")), c(""a""))
+#   expect_equal(remaining_columns_to_read(c(""a""), c(""a""), NULL), """")
+#   expect_equal(remaining_columns_to_read(c(""a""), NULL, c(""a"")), c(""a""))
+#   expect_equal(remaining_columns_to_read(c(""a""), c(""a"", ""b"", ""c""), NULL), """")
+#   expect_equal(remaining_columns_to_read(c(""a""), NULL, c(""a"", ""b"", ""c"")), c(""a""))
+#   expect_equal(remaining_columns_to_read(NULL, c(""a"", ""b"", ""c""), NULL), NULL)
+#   expect_equal(remaining_columns_to_read(NULL, NULL, c(""a"", ""b"", ""c"")), c(""a"", ""b"", ""c""))
+#   expect_equal(remaining_columns_to_read(c(""a"", ""b"", ""c""), c(""a"", ""b"", ""c""), NULL), """")
+#   expect_equal(remaining_columns_to_read(c(""a"", ""b"", ""c""), NULL, c(""a"", ""b"", ""c"")), c(""a"", ""b"", ""c""))
+# })
+#
+# test_that(""read_sample_csv() reads adaptation step size correctly"", {
+#   skip_on_cran()
+#
+#   csv_files <- test_path(""resources"", ""csv"", ""model1-2-no-warmup.csv"")
+#
+#   csv_out <- read_sample_csv(csv_files)
+#   expect_equal(csv_out$step_size[[2]], 0.672434)
+#
+#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-dense_e_metric.csv""),
+#                  test_path(""resources"", ""csv"", ""model1-2-dense_e_metric.csv""))
+#
+#   csv_out <- read_sample_csv(csv_files)
+#   expect_equal(csv_out$step_size[[1]], 0.11757)
+#   expect_equal(csv_out$step_size[[2]], 0.232778)
+# })",True,False,Implementation / Logic,6
stan-dev,cmdstanr,893ee5c898c8444edef2375ab88e9b2024f86228,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-03T10:52:06Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-03T10:52:06Z,fix tests,tests/testthat/test-threads.R,False,True,True,False,3,3,6,"---FILE: tests/testthat/test-threads.R---
@@ -18,17 +18,17 @@ test_that(""threading works"", {
 
   expect_output(
     mod$sample(data = data_file_json, cores = 4, threads_per_chain = 1),
-    ""Running MCMC with 4 chain(s) on 4 core(s) with 1  thread(s) per chain.."",
+    ""Running MCMC with 4 chain(s) on 4 core(s) with 1 thread(s) per chain.."",
     fixed = TRUE
   )
   expect_output(
     mod$sample(data = data_file_json,  cores = 4, threads_per_chain = 2),
-    ""Running MCMC with 4 chain(s) on 4 core(s) with 2  thread(s) per chain.."",
+    ""Running MCMC with 4 chain(s) on 4 core(s) with 2 thread(s) per chain.."",
     fixed = TRUE
   )
   expect_output(
     mod$sample(data = data_file_json,  cores = 4, threads_per_chain = 4),
-    ""Running MCMC with 4 chain(s) on 4 core(s) with 4  thread(s) per chain.."",
+    ""Running MCMC with 4 chain(s) on 4 core(s) with 4 thread(s) per chain.."",
     fixed = TRUE
   )
 ",True,False,Implementation / Logic,3
stan-dev,cmdstanr,73a05caa6c0b4ad7bb24dad3b4822a0bb88430a9,jgabry,jgabry@gmail.com,2020-06-02T17:19:21Z,jgabry,jgabry@gmail.com,2020-06-02T17:19:21Z,"add aliases to document methods

fixes #186",R/fit.R;R/model.R;man/CmdStanMCMC.Rd;man/CmdStanModel.Rd;man/cmdstan_model.Rd;man/cmdstanr-package.Rd;man/fit-method-cmdstan_summary.Rd;man/fit-method-draws.Rd;man/fit-method-sampler_diagnostics.Rd;man/fit-method-save_output_files.Rd;man/fit-method-summary.Rd;man/model-method-compile.Rd;man/model-method-optimize.Rd;man/model-method-sample.Rd;man/model-method-variational.Rd,False,True,True,False,104,4,108,"---FILE: R/fit.R---
@@ -108,6 +108,7 @@ CmdStanFit <- R6::R6Class(
 #' Extract posterior draws
 #'
 #' @name fit-method-draws
+#' @aliases draws
 #' @description Extract posterior draws after MCMC or approximate posterior
 #'   draws after variational approximation using formats provided by the
 #'   \pkg{posterior} package.
@@ -141,6 +142,7 @@ NULL
 #' Extract sampler diagnostics
 #'
 #' @name fit-method-sampler_diagnostics
+#' @aliases sampler_diagnostics
 #' @description Extract the values of sampler diagnostics for each iteration and
 #'   chain of MCMC.
 #'
@@ -165,6 +167,7 @@ NULL
 #' Run `posterior::summarise_draws()`
 #'
 #' @name fit-method-summary
+#' @aliases summary
 #' @description Run [posterior::summarise_draws()] from the \pkg{posterior}
 #'   package.
 #'
@@ -180,13 +183,18 @@ NULL
 #'
 #' @seealso [`CmdStanMCMC`], [`CmdStanMLE`], [`CmdStanVB`]
 #'
+#' @examples
+#' \dontrun{
+#' fit$summary()
+#' }
+#'
 NULL
 
 
 #' Run CmdStan's `bin/stansummary` and `bin/diagnose`
 #'
 #' @name fit-method-cmdstan_summary
-#' @aliases fit-method-cmdstan_diagnose
+#' @aliases fit-method-cmdstan_diagnose cmdstan_summary cmdstan_diagnose
 #' @note Although these methods also work for models fit using the
 #'   [`$variational()`][model-method-variational] method, much of the output is
 #'   only relevant for models fit using the [`$sample()`][model-method-sample]
@@ -200,6 +208,12 @@ NULL
 #'
 #' @seealso [`CmdStanMCMC`], [`CmdStanMLE`], [`CmdStanVB`]
 #'
+#' @examples
+#' \dontrun{
+#' fit$cmdstan_summary()
+#' fit$cmdstan_diagnose()
+#' }
+#'
 NULL
 
 
@@ -208,6 +222,8 @@ NULL
 #' @name fit-method-save_output_files
 #' @aliases fit-method-save_data_file fit-method-save_latent_dynamics_files
 #'   fit-method-output_files fit-method-data_file fit-method-latent_dynamics_files
+#'   save_output_files save_data_file save_latent_dynamics_files
+#'   output_files data_file latent_dynamics_files
 #'
 #' @description All fitted model objects have methods for saving (moving to a
 #'   specified location) the files created by CmdStanR to hold CmdStan output
@@ -302,7 +318,7 @@ NULL
 #'  [`$save_latent_dynamics_files()`][fit-method-save_latent_dynamics_files]
 #'    \tab Save diagnostic CSV files to a specified location. \cr
 #'  `$time()` \tab Return a list containing the total time and a data frame of
-#'    execution times of all chains. \cr
+#'    execution times of all chains (in seconds). \cr
 #'  `$output()` \tab Return the stdout and stderr of all chains as a list of
 #'    character vectors, or pretty print the output for a single chain if
 #'    `id` argument is specified. \cr

---FILE: R/model.R---
@@ -48,6 +48,10 @@
 #' # Use 'posterior' package for summaries
 #' fit_mcmc$summary()
 #'
+#' # Get posterior draws
+#' draws <- fit_mcmc$draws()
+#' print(draws)
+#'
 #' # Call CmdStan's diagnose and stansummary utilities
 #' fit_mcmc$cmdstan_diagnose()
 #' fit_mcmc$cmdstan_summary()
@@ -154,6 +158,7 @@ CmdStanModel <- R6::R6Class(
 #' Compile a Stan program or get the Stan code
 #'
 #' @name model-method-compile
+#' @aliases compile
 #' @family CmdStanModel methods
 #'
 #' @description The `$compile()` method of a [`CmdStanModel`] object calls
@@ -309,6 +314,7 @@ CmdStanModel$set(""public"", name = ""compile"", value = compile_method)
 #' Run Stan's MCMC algorithms
 #'
 #' @name model-method-sample
+#' @aliases sample
 #' @family CmdStanModel methods
 #'
 #' @description The `$sample()` method of a [`CmdStanModel`] object runs the
@@ -539,6 +545,7 @@ CmdStanModel$set(""public"", name = ""sample"", value = sample_method)
 #' Run Stan's optimization algorithms
 #'
 #' @name model-method-optimize
+#' @aliases optimize
 #' @family CmdStanModel methods
 #'
 #' @description The `$optimize()` method of a [`CmdStanModel`] object runs
@@ -632,6 +639,7 @@ CmdStanModel$set(""public"", name = ""optimize"", value = optimize_method)
 #' Run Stan's variational approximation algorithms
 #'
 #' @name model-method-variational
+#' @aliases variational
 #' @family CmdStanModel methods
 #'
 #' @description The `$variational()` method of a [`CmdStanModel`] object runs

---FILE: man/CmdStanMCMC.Rd---
@@ -31,7 +31,7 @@ objects.
 \code{\link[=fit-method-save_latent_dynamics_files]{$save_latent_dynamics_files()}}
 \tab Save diagnostic CSV files to a specified location. \cr
 \verb{$time()} \tab Return a list containing the total time and a data frame of
-execution times of all chains. \cr
+execution times of all chains (in seconds). \cr
 \verb{$output()} \tab Return the stdout and stderr of all chains as a list of
 character vectors, or pretty print the output for a single chain if
 \code{id} argument is specified. \cr

---FILE: man/CmdStanModel.Rd---
@@ -58,6 +58,10 @@ fit_mcmc <- mod$sample(
 # Use 'posterior' package for summaries
 fit_mcmc$summary()
 
+# Get posterior draws
+draws <- fit_mcmc$draws()
+print(draws)
+
 # Call CmdStan's diagnose and stansummary utilities
 fit_mcmc$cmdstan_diagnose()
 fit_mcmc$cmdstan_summary()

---FILE: man/cmdstan_model.Rd---
@@ -61,6 +61,10 @@ fit_mcmc <- mod$sample(
 # Use 'posterior' package for summaries
 fit_mcmc$summary()
 
+# Get posterior draws
+draws <- fit_mcmc$draws()
+print(draws)
+
 # Call CmdStan's diagnose and stansummary utilities
 fit_mcmc$cmdstan_diagnose()
 fit_mcmc$cmdstan_summary()

---FILE: man/cmdstanr-package.Rd---
@@ -82,6 +82,10 @@ fit_mcmc <- mod$sample(
 # Use 'posterior' package for summaries
 fit_mcmc$summary()
 
+# Get posterior draws
+draws <- fit_mcmc$draws()
+print(draws)
+
 # Call CmdStan's diagnose and stansummary utilities
 fit_mcmc$cmdstan_diagnose()
 fit_mcmc$cmdstan_summary()

---FILE: man/fit-method-cmdstan_summary.Rd---
@@ -3,6 +3,8 @@
 \name{fit-method-cmdstan_summary}
 \alias{fit-method-cmdstan_summary}
 \alias{fit-method-cmdstan_diagnose}
+\alias{cmdstan_summary}
+\alias{cmdstan_diagnose}
 \title{Run CmdStan's \code{bin/stansummary} and \code{bin/diagnose}}
 \description{
 Run CmdStan's \code{bin/stansummary} and \code{bin/diagnose}
@@ -19,6 +21,13 @@ $cmdstan_diagnose()
 }
 }
 
+\examples{
+\dontrun{
+fit$cmdstan_summary()
+fit$cmdstan_diagnose()
+}
+
+}
 \seealso{
 \code{\link{CmdStanMCMC}}, \code{\link{CmdStanMLE}}, \code{\link{CmdStanVB}}
 }

---FILE: man/fit-method-draws.Rd---
@@ -2,6 +2,7 @@
 % Please edit documentation in R/fit.R
 \name{fit-method-draws}
 \alias{fit-method-draws}
+\alias{draws}
 \title{Extract posterior draws}
 \description{
 Extract posterior draws after MCMC or approximate posterior
@@ -41,3 +42,27 @@ stored in the \code{draws_matrix} format.
 }
 }
 
+\examples{
+\dontrun{
+library(cmdstanr)
+library(posterior)
+
+stan_program <- file.path(cmdstan_path(), ""examples/bernoulli/bernoulli.stan"")
+mod <- cmdstan_model(stan_program)
+fit <- mod$sample(
+  data = list(N = 10, y = c(0,1,0,0,0,0,0,0,0,1)),
+  seed = 123,
+  chains = 2,
+  cores = 2
+)
+draws_array <- fit$draws()
+str(draws_array)
+
+draws_matrix <- as_draws_matrix(draws_array)
+str(draws_matrix)
+
+draws_df <- as_draws_df(draws_array)
+str(draws_df)
+}
+
+}

---FILE: man/fit-method-sampler_diagnostics.Rd---
@@ -2,6 +2,7 @@
 % Please edit documentation in R/fit.R
 \name{fit-method-sampler_diagnostics}
 \alias{fit-method-sampler_diagnostics}
+\alias{sampler_diagnostics}
 \title{Extract sampler diagnostics}
 \description{
 Extract the values of sampler diagnostics for each iteration and

---FILE: man/fit-method-save_output_files.Rd---
@@ -7,6 +7,12 @@
 \alias{fit-method-output_files}
 \alias{fit-method-data_file}
 \alias{fit-method-latent_dynamics_files}
+\alias{save_output_files}
+\alias{save_data_file}
+\alias{save_latent_dynamics_files}
+\alias{output_files}
+\alias{data_file}
+\alias{latent_dynamics_files}
 \title{Save output and data files}
 \description{
 All fitted model objects have methods for saving (moving to a
@@ -50,7 +56,7 @@ the form \code{basename-timestamp-id-random}, where
 \item \code{basename} is the user's provided \code{basename} argument;
 \item \code{timestamp} is of the form \code{format(Sys.time(), ""\%Y\%m\%d\%H\%M"")};
 \item \code{id} is the MCMC chain id (or \code{1} for non MCMC);
-\item \code{random} contains six random alphanumeric characters.
+\item \code{random} contains six random alphanumeric characters;
 }
 
 For \verb{$save_latent_dynamics_files()} everything is the same as for

---FILE: man/fit-method-summary.Rd---
@@ -2,6 +2,7 @@
 % Please edit documentation in R/fit.R
 \name{fit-method-summary}
 \alias{fit-method-summary}
+\alias{summary}
 \title{Run \code{posterior::summarise_draws()}}
 \description{
 Run \code{\link[posterior:summarise_draws]{posterior::summarise_draws()}} from the \pkg{posterior}
@@ -24,6 +25,12 @@ package.
 The data frame returned by \code{\link[posterior:summarise_draws]{posterior::summarise_draws()}}.
 }
 
+\examples{
+\dontrun{
+fit$summary()
+}
+
+}
 \seealso{
 \code{\link{CmdStanMCMC}}, \code{\link{CmdStanMLE}}, \code{\link{CmdStanVB}}
 }

---FILE: man/model-method-compile.Rd---
@@ -2,6 +2,7 @@
 % Please edit documentation in R/model.R
 \name{model-method-compile}
 \alias{model-method-compile}
+\alias{compile}
 \title{Compile a Stan program or get the Stan code}
 \description{
 The \verb{$compile()} method of a \code{\link{CmdStanModel}} object calls

---FILE: man/model-method-optimize.Rd---
@@ -2,6 +2,7 @@
 % Please edit documentation in R/model.R
 \name{model-method-optimize}
 \alias{model-method-optimize}
+\alias{optimize}
 \title{Run Stan's optimization algorithms}
 \description{
 The \verb{$optimize()} method of a \code{\link{CmdStanModel}} object runs
@@ -134,6 +135,10 @@ fit_mcmc <- mod$sample(
 # Use 'posterior' package for summaries
 fit_mcmc$summary()
 
+# Get posterior draws
+draws <- fit_mcmc$draws()
+print(draws)
+
 # Call CmdStan's diagnose and stansummary utilities
 fit_mcmc$cmdstan_diagnose()
 fit_mcmc$cmdstan_summary()

---FILE: man/model-method-sample.Rd---
@@ -2,6 +2,7 @@
 % Please edit documentation in R/model.R
 \name{model-method-sample}
 \alias{model-method-sample}
+\alias{sample}
 \title{Run Stan's MCMC algorithms}
 \description{
 The \verb{$sample()} method of a \code{\link{CmdStanModel}} object runs the
@@ -201,6 +202,10 @@ fit_mcmc <- mod$sample(
 # Use 'posterior' package for summaries
 fit_mcmc$summary()
 
+# Get posterior draws
+draws <- fit_mcmc$draws()
+print(draws)
+
 # Call CmdStan's diagnose and stansummary utilities
 fit_mcmc$cmdstan_diagnose()
 fit_mcmc$cmdstan_summary()

---FILE: man/model-method-variational.Rd---
@@ -2,6 +2,7 @@
 % Please edit documentation in R/model.R
 \name{model-method-variational}
 \alias{model-method-variational}
+\alias{variational}
 \title{Run Stan's variational approximation algorithms}
 \description{
 The \verb{$variational()} method of a \code{\link{CmdStanModel}} object runs
@@ -151,6 +152,10 @@ fit_mcmc <- mod$sample(
 # Use 'posterior' package for summaries
 fit_mcmc$summary()
 
+# Get posterior draws
+draws <- fit_mcmc$draws()
+print(draws)
+
 # Call CmdStan's diagnose and stansummary utilities
 fit_mcmc$cmdstan_diagnose()
 fit_mcmc$cmdstan_summary()",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,98fcdc093ce1aaaf93b0ea73abdd047cd9b7d127,jgabry,jgabry@gmail.com,2020-06-02T17:15:25Z,jgabry,jgabry@gmail.com,2020-06-02T17:15:25Z,"add aliases to document methods

fixes #186",R/fit.R;R/model.R;man/CmdStanMCMC.Rd;man/CmdStanModel.Rd;man/cmdstan_model.Rd;man/cmdstanr-package.Rd;man/fit-method-cmdstan_summary.Rd;man/fit-method-draws.Rd;man/fit-method-sampler_diagnostics.Rd;man/fit-method-save_output_files.Rd;man/fit-method-summary.Rd;man/model-method-compile.Rd;man/model-method-optimize.Rd;man/model-method-sample.Rd;man/model-method-variational.Rd,False,True,True,False,104,4,108,"---FILE: R/fit.R---
@@ -108,6 +108,7 @@ CmdStanFit <- R6::R6Class(
 #' Extract posterior draws
 #'
 #' @name fit-method-draws
+#' @aliases draws
 #' @description Extract posterior draws after MCMC or approximate posterior
 #'   draws after variational approximation using formats provided by the
 #'   \pkg{posterior} package.
@@ -141,6 +142,7 @@ NULL
 #' Extract sampler diagnostics
 #'
 #' @name fit-method-sampler_diagnostics
+#' @aliases sampler_diagnostics
 #' @description Extract the values of sampler diagnostics for each iteration and
 #'   chain of MCMC.
 #'
@@ -165,6 +167,7 @@ NULL
 #' Run `posterior::summarise_draws()`
 #'
 #' @name fit-method-summary
+#' @aliases summary
 #' @description Run [posterior::summarise_draws()] from the \pkg{posterior}
 #'   package.
 #'
@@ -180,13 +183,18 @@ NULL
 #'
 #' @seealso [`CmdStanMCMC`], [`CmdStanMLE`], [`CmdStanVB`]
 #'
+#' @examples
+#' \dontrun{
+#' fit$summary()
+#' }
+#'
 NULL
 
 
 #' Run CmdStan's `bin/stansummary` and `bin/diagnose`
 #'
 #' @name fit-method-cmdstan_summary
-#' @aliases fit-method-cmdstan_diagnose
+#' @aliases fit-method-cmdstan_diagnose cmdstan_summary cmdstan_diagnose
 #' @note Although these methods also work for models fit using the
 #'   [`$variational()`][model-method-variational] method, much of the output is
 #'   only relevant for models fit using the [`$sample()`][model-method-sample]
@@ -200,6 +208,12 @@ NULL
 #'
 #' @seealso [`CmdStanMCMC`], [`CmdStanMLE`], [`CmdStanVB`]
 #'
+#' @examples
+#' \dontrun{
+#' fit$cmdstan_summary()
+#' fit$cmdstan_diagnose()
+#' }
+#'
 NULL
 
 
@@ -208,6 +222,8 @@ NULL
 #' @name fit-method-save_output_files
 #' @aliases fit-method-save_data_file fit-method-save_latent_dynamics_files
 #'   fit-method-output_files fit-method-data_file fit-method-latent_dynamics_files
+#'   save_output_files save_data_file save_latent_dynamics_files
+#'   output_files data_file latent_dynamics_files
 #'
 #' @description All fitted model objects have methods for saving (moving to a
 #'   specified location) the files created by CmdStanR to hold CmdStan output
@@ -302,7 +318,7 @@ NULL
 #'  [`$save_latent_dynamics_files()`][fit-method-save_latent_dynamics_files]
 #'    \tab Save diagnostic CSV files to a specified location. \cr
 #'  `$time()` \tab Return a list containing the total time and a data frame of
-#'    execution times of all chains. \cr
+#'    execution times of all chains (in seconds). \cr
 #'  `$output()` \tab Return the stdout and stderr of all chains as a list of
 #'    character vectors, or pretty print the output for a single chain if
 #'    `id` argument is specified. \cr

---FILE: R/model.R---
@@ -48,6 +48,10 @@
 #' # Use 'posterior' package for summaries
 #' fit_mcmc$summary()
 #'
+#' # Get posterior draws
+#' draws <- fit_mcmc$draws()
+#' print(draws)
+#'
 #' # Call CmdStan's diagnose and stansummary utilities
 #' fit_mcmc$cmdstan_diagnose()
 #' fit_mcmc$cmdstan_summary()
@@ -154,6 +158,7 @@ CmdStanModel <- R6::R6Class(
 #' Compile a Stan program or get the Stan code
 #'
 #' @name model-method-compile
+#' @aliases compile
 #' @family CmdStanModel methods
 #'
 #' @description The `$compile()` method of a [`CmdStanModel`] object calls
@@ -309,6 +314,7 @@ CmdStanModel$set(""public"", name = ""compile"", value = compile_method)
 #' Run Stan's MCMC algorithms
 #'
 #' @name model-method-sample
+#' @aliases sample
 #' @family CmdStanModel methods
 #'
 #' @description The `$sample()` method of a [`CmdStanModel`] object runs the
@@ -539,6 +545,7 @@ CmdStanModel$set(""public"", name = ""sample"", value = sample_method)
 #' Run Stan's optimization algorithms
 #'
 #' @name model-method-optimize
+#' @aliases optimize
 #' @family CmdStanModel methods
 #'
 #' @description The `$optimize()` method of a [`CmdStanModel`] object runs
@@ -632,6 +639,7 @@ CmdStanModel$set(""public"", name = ""optimize"", value = optimize_method)
 #' Run Stan's variational approximation algorithms
 #'
 #' @name model-method-variational
+#' @aliases variational
 #' @family CmdStanModel methods
 #'
 #' @description The `$variational()` method of a [`CmdStanModel`] object runs

---FILE: man/CmdStanMCMC.Rd---
@@ -31,7 +31,7 @@ objects.
 \code{\link[=fit-method-save_latent_dynamics_files]{$save_latent_dynamics_files()}}
 \tab Save diagnostic CSV files to a specified location. \cr
 \verb{$time()} \tab Return a list containing the total time and a data frame of
-execution times of all chains. \cr
+execution times of all chains (in seconds). \cr
 \verb{$output()} \tab Return the stdout and stderr of all chains as a list of
 character vectors, or pretty print the output for a single chain if
 \code{id} argument is specified. \cr

---FILE: man/CmdStanModel.Rd---
@@ -58,6 +58,10 @@ fit_mcmc <- mod$sample(
 # Use 'posterior' package for summaries
 fit_mcmc$summary()
 
+# Get posterior draws
+draws <- fit_mcmc$draws()
+print(draws)
+
 # Call CmdStan's diagnose and stansummary utilities
 fit_mcmc$cmdstan_diagnose()
 fit_mcmc$cmdstan_summary()

---FILE: man/cmdstan_model.Rd---
@@ -61,6 +61,10 @@ fit_mcmc <- mod$sample(
 # Use 'posterior' package for summaries
 fit_mcmc$summary()
 
+# Get posterior draws
+draws <- fit_mcmc$draws()
+print(draws)
+
 # Call CmdStan's diagnose and stansummary utilities
 fit_mcmc$cmdstan_diagnose()
 fit_mcmc$cmdstan_summary()

---FILE: man/cmdstanr-package.Rd---
@@ -82,6 +82,10 @@ fit_mcmc <- mod$sample(
 # Use 'posterior' package for summaries
 fit_mcmc$summary()
 
+# Get posterior draws
+draws <- fit_mcmc$draws()
+print(draws)
+
 # Call CmdStan's diagnose and stansummary utilities
 fit_mcmc$cmdstan_diagnose()
 fit_mcmc$cmdstan_summary()

---FILE: man/fit-method-cmdstan_summary.Rd---
@@ -3,6 +3,8 @@
 \name{fit-method-cmdstan_summary}
 \alias{fit-method-cmdstan_summary}
 \alias{fit-method-cmdstan_diagnose}
+\alias{cmdstan_summary}
+\alias{cmdstan_diagnose}
 \title{Run CmdStan's \code{bin/stansummary} and \code{bin/diagnose}}
 \description{
 Run CmdStan's \code{bin/stansummary} and \code{bin/diagnose}
@@ -19,6 +21,13 @@ $cmdstan_diagnose()
 }
 }
 
+\examples{
+\dontrun{
+fit$cmdstan_summary()
+fit$cmdstan_diagnose()
+}
+
+}
 \seealso{
 \code{\link{CmdStanMCMC}}, \code{\link{CmdStanMLE}}, \code{\link{CmdStanVB}}
 }

---FILE: man/fit-method-draws.Rd---
@@ -2,6 +2,7 @@
 % Please edit documentation in R/fit.R
 \name{fit-method-draws}
 \alias{fit-method-draws}
+\alias{draws}
 \title{Extract posterior draws}
 \description{
 Extract posterior draws after MCMC or approximate posterior
@@ -41,3 +42,27 @@ stored in the \code{draws_matrix} format.
 }
 }
 
+\examples{
+\dontrun{
+library(cmdstanr)
+library(posterior)
+
+stan_program <- file.path(cmdstan_path(), ""examples/bernoulli/bernoulli.stan"")
+mod <- cmdstan_model(stan_program)
+fit <- mod$sample(
+  data = list(N = 10, y = c(0,1,0,0,0,0,0,0,0,1)),
+  seed = 123,
+  chains = 2,
+  cores = 2
+)
+draws_array <- fit$draws()
+str(draws_array)
+
+draws_matrix <- as_draws_matrix(draws_array)
+str(draws_matrix)
+
+draws_df <- as_draws_df(draws_array)
+str(draws_df)
+}
+
+}

---FILE: man/fit-method-sampler_diagnostics.Rd---
@@ -2,6 +2,7 @@
 % Please edit documentation in R/fit.R
 \name{fit-method-sampler_diagnostics}
 \alias{fit-method-sampler_diagnostics}
+\alias{sampler_diagnostics}
 \title{Extract sampler diagnostics}
 \description{
 Extract the values of sampler diagnostics for each iteration and

---FILE: man/fit-method-save_output_files.Rd---
@@ -7,6 +7,12 @@
 \alias{fit-method-output_files}
 \alias{fit-method-data_file}
 \alias{fit-method-latent_dynamics_files}
+\alias{save_output_files}
+\alias{save_data_file}
+\alias{save_latent_dynamics_files}
+\alias{output_files}
+\alias{data_file}
+\alias{latent_dynamics_files}
 \title{Save output and data files}
 \description{
 All fitted model objects have methods for saving (moving to a
@@ -50,7 +56,7 @@ the form \code{basename-timestamp-id-random}, where
 \item \code{basename} is the user's provided \code{basename} argument;
 \item \code{timestamp} is of the form \code{format(Sys.time(), ""\%Y\%m\%d\%H\%M"")};
 \item \code{id} is the MCMC chain id (or \code{1} for non MCMC);
-\item \code{random} contains six random alphanumeric characters.
+\item \code{random} contains six random alphanumeric characters;
 }
 
 For \verb{$save_latent_dynamics_files()} everything is the same as for

---FILE: man/fit-method-summary.Rd---
@@ -2,6 +2,7 @@
 % Please edit documentation in R/fit.R
 \name{fit-method-summary}
 \alias{fit-method-summary}
+\alias{summary}
 \title{Run \code{posterior::summarise_draws()}}
 \description{
 Run \code{\link[posterior:summarise_draws]{posterior::summarise_draws()}} from the \pkg{posterior}
@@ -24,6 +25,12 @@ package.
 The data frame returned by \code{\link[posterior:summarise_draws]{posterior::summarise_draws()}}.
 }
 
+\examples{
+\dontrun{
+fit$summary()
+}
+
+}
 \seealso{
 \code{\link{CmdStanMCMC}}, \code{\link{CmdStanMLE}}, \code{\link{CmdStanVB}}
 }

---FILE: man/model-method-compile.Rd---
@@ -2,6 +2,7 @@
 % Please edit documentation in R/model.R
 \name{model-method-compile}
 \alias{model-method-compile}
+\alias{compile}
 \title{Compile a Stan program or get the Stan code}
 \description{
 The \verb{$compile()} method of a \code{\link{CmdStanModel}} object calls

---FILE: man/model-method-optimize.Rd---
@@ -2,6 +2,7 @@
 % Please edit documentation in R/model.R
 \name{model-method-optimize}
 \alias{model-method-optimize}
+\alias{optimize}
 \title{Run Stan's optimization algorithms}
 \description{
 The \verb{$optimize()} method of a \code{\link{CmdStanModel}} object runs
@@ -134,6 +135,10 @@ fit_mcmc <- mod$sample(
 # Use 'posterior' package for summaries
 fit_mcmc$summary()
 
+# Get posterior draws
+draws <- fit_mcmc$draws()
+print(draws)
+
 # Call CmdStan's diagnose and stansummary utilities
 fit_mcmc$cmdstan_diagnose()
 fit_mcmc$cmdstan_summary()

---FILE: man/model-method-sample.Rd---
@@ -2,6 +2,7 @@
 % Please edit documentation in R/model.R
 \name{model-method-sample}
 \alias{model-method-sample}
+\alias{sample}
 \title{Run Stan's MCMC algorithms}
 \description{
 The \verb{$sample()} method of a \code{\link{CmdStanModel}} object runs the
@@ -201,6 +202,10 @@ fit_mcmc <- mod$sample(
 # Use 'posterior' package for summaries
 fit_mcmc$summary()
 
+# Get posterior draws
+draws <- fit_mcmc$draws()
+print(draws)
+
 # Call CmdStan's diagnose and stansummary utilities
 fit_mcmc$cmdstan_diagnose()
 fit_mcmc$cmdstan_summary()

---FILE: man/model-method-variational.Rd---
@@ -2,6 +2,7 @@
 % Please edit documentation in R/model.R
 \name{model-method-variational}
 \alias{model-method-variational}
+\alias{variational}
 \title{Run Stan's variational approximation algorithms}
 \description{
 The \verb{$variational()} method of a \code{\link{CmdStanModel}} object runs
@@ -151,6 +152,10 @@ fit_mcmc <- mod$sample(
 # Use 'posterior' package for summaries
 fit_mcmc$summary()
 
+# Get posterior draws
+draws <- fit_mcmc$draws()
+print(draws)
+
 # Call CmdStan's diagnose and stansummary utilities
 fit_mcmc$cmdstan_diagnose()
 fit_mcmc$cmdstan_summary()",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,f73b2e690076198db7e1a51268845530997763d5,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-02T16:58:25Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-02T16:58:25Z,fix doxygen,man/read_sample_csv.Rd,False,False,False,False,5,5,10,"---FILE: man/read_sample_csv.Rd---
@@ -14,15 +14,15 @@ read_sample_csv(
 \arguments{
 \item{files}{Paths to the CSV files to read.}
 
-\item{sampler_diagnostics}{(list) When \code{NULL}, the function will return
+\item{pars}{(character vector) When \code{NULL}, the function will return
+draws for all model parameters. When supplied a list, the function
+will return  draws from the listed model parameters.}
+
+\item{sampler_diagnostics}{(character vector) When \code{NULL}, the function will return
 draws for all sampler diagnostics . When supplied a list, the function
 will return  draws from the listed sampler diagnostics .}
 
 \item{cores}{The number of cores to use to read and process the output files}
-
-\item{parameters}{(list) When \code{NULL}, the function will return
-draws for all model parameters. When supplied a list, the function
-will return  draws from the listed model parameters.}
 }
 \value{
 A named list containing:",False,False,Documentation / Formatting,6
stan-dev,cmdstanr,0e67160d42b912b188a97d540fb3d31ce1d46bf9,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-01T19:43:19Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-01T19:43:19Z,fix comment,R/read_csv.R,False,True,True,False,2,2,4,"---FILE: R/read_csv.R---
@@ -168,10 +168,10 @@ read_sample_info_csv <- function(csv_file) {
 #'
 #' @export
 #' @param files Paths to the CSV files to read.
-#' @param parameters (list) When `NULL`, the function will return
+#' @param pars (character vector) When `NULL`, the function will return
 #' draws for all model parameters. When supplied a list, the function
 #' will return  draws from the listed model parameters.
-#' @param sampler_diagnostics (list) When `NULL`, the function will return
+#' @param sampler_diagnostics (character vector) When `NULL`, the function will return
 #' draws for all sampler diagnostics . When supplied a list, the function
 #' will return  draws from the listed sampler diagnostics .
 #' @param cores The number of cores to use to read and process the output files",True,False,Implementation / Logic,6
stan-dev,cmdstanr,c0637817da34a20cb234f48d449acc579418daeb,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-01T18:33:59Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-01T18:33:59Z,fix summary,DESCRIPTION;R/fit.R;R/read_csv.R;man/fit-method-save_output_files.Rd;man/read_sample_csv.Rd;tests/testthat/test-fit-mcmc.R,False,True,True,False,16,21,37,"---FILE: DESCRIPTION---
@@ -1,6 +1,6 @@
 Package: cmdstanr
 Title: R Interface to 'CmdStan'
-Version: 0.0.0.9001
+Version: 0.0.0.9002
 Authors@R: 
     c(person(given = ""Jonah"", family = ""Gabry"", role = c(""aut"", ""cre""),
            email = ""jsg2201@columbia.edu""),

---FILE: R/fit.R---
@@ -321,7 +321,7 @@ CmdStanMCMC <- R6::R6Class(
         if (self$runset$args$validate_csv && !runset$args$method_args$fixed_param) {
           data_csv <- read_sample_csv(self$output_files(),
                                       pars = """",
-                                      sampler_diagnostics = list(""treedepth__"", ""divergent__""),
+                                      sampler_diagnostics = c(""treedepth__"", ""divergent__""),
                                       cores = self$runset$procs$num_cores()
           )
           check_divergences(data_csv)
@@ -345,12 +345,10 @@ CmdStanMCMC <- R6::R6Class(
       }
       to_read <- remaining_columns_to_read(pars, dimnames(private$draws_)$variable, private$sampling_info_$model_params)
       if (is.null(to_read) || (length(to_read) > 0)) {
-        private$read_csv_(pars = pars, sampler_diagnostics = list())
+        private$read_csv_(pars = pars, sampler_diagnostics = """")
       }
       if (is.null(pars)) {
         pars <- private$sampling_info_$model_params
-      } else {
-        pars <- unlist(pars)
       }
       if (inc_warmup) {
         if (!private$sampling_info_$save_warmup) {
@@ -363,14 +361,13 @@ CmdStanMCMC <- R6::R6Class(
         private$draws_[,,pars]
       }
     },
-
     sampler_diagnostics = function(inc_warmup = FALSE) {
       if (!length(self$output_files(include_failed = FALSE))) {
         stop(""No chains finished successfully. Unable to retrieve the sampler diagnostics."")
       }
       to_read <- remaining_columns_to_read(NULL, dimnames(private$sampler_diagnostics_)$variable, private$sampling_info_$sampler_diagnostics)
       if (is.null(to_read) || (length(to_read) > 0)) {
-        private$read_csv_(parameters = list(), sampler_diagnostics = NULL)
+        private$read_csv_(pars = """", sampler_diagnostics = NULL)
       }
       if (inc_warmup) {
         if (!private$sampling_info_$save_warmup) {
@@ -390,14 +387,12 @@ CmdStanMCMC <- R6::R6Class(
     draws_ = NULL,
     sampling_info_ = NULL,
     read_csv_ = function(pars = NULL, sampler_diagnostics = NULL) {
-      parameters_to_read <- remaining_columns_to_read(parameters, dimnames(private$draws_)$variable, private$sampling_info_$model_params)
+      parameters_to_read <- remaining_columns_to_read(pars, dimnames(private$draws_)$variable, private$sampling_info_$model_params)
       sampler_diagnostics_to_read <- remaining_columns_to_read(sampler_diagnostics, dimnames(private$sampler_diagnostics_)$variable, private$sampling_info_$sampler_diagnostics)
       data_csv <- read_sample_csv(self$output_files(include_failed = FALSE),
                                   pars = parameters_to_read,
                                   sampler_diagnostics = sampler_diagnostics_to_read,
                                   cores = self$runset$procs$num_cores())
-      private$draws_ <- data_csv$post_warmup_draws
-      private$sampler_diagnostics_ <- data_csv$post_warmup_sampler_diagnostics
       private$sampling_info_ <- data_csv$sampling_info
       if (!is.null(data_csv$post_warmup_draws)) {
         if (is.null(private$draws_)) {

---FILE: R/read_csv.R---
@@ -386,7 +386,7 @@ read_sample_csv <- function(files,
     not_matching_list <- paste(unique(not_matching), collapse = "", "")
     warning(""The supplied csv files do not match in the following arguments: "", not_matching_list, ""!"")
   }
-  sampling_info$model_params <- repaired_model_params
+  sampling_info$model_params <- repair_variable_names(sampling_info$model_params)
   sampling_info$inverse_metric <- NULL
   list(
     sampling_info = sampling_info,

---FILE: man/fit-method-save_output_files.Rd---
@@ -50,7 +50,7 @@ the form \code{basename-timestamp-id-random}, where
 \item \code{basename} is the user's provided \code{basename} argument;
 \item \code{timestamp} is of the form \code{format(Sys.time(), ""\%Y\%m\%d\%H\%M"")};
 \item \code{id} is the MCMC chain id (or \code{1} for non MCMC);
-\item \code{random} contains six random alphanumeric characters.
+\item \code{random} contains six random alphanumeric characters;
 }
 
 For \verb{$save_latent_dynamics_files()} everything is the same as for

---FILE: man/read_sample_csv.Rd---
@@ -6,23 +6,23 @@
 \usage{
 read_sample_csv(
   files,
-  parameters = NULL,
+  pars = NULL,
   sampler_diagnostics = NULL,
   cores = getOption(""mc.cores"", 1)
 )
 }
 \arguments{
 \item{files}{Paths to the CSV files to read.}
 
-\item{parameters}{(list) When \code{NULL}, the function will return
-draws for all model parameters. When supplied a list, the function
-will return  draws from the listed model parameters.}
-
 \item{sampler_diagnostics}{(list) When \code{NULL}, the function will return
 draws for all sampler diagnostics . When supplied a list, the function
 will return  draws from the listed sampler diagnostics .}
 
 \item{cores}{The number of cores to use to read and process the output files}
+
+\item{parameters}{(list) When \code{NULL}, the function will return
+draws for all model parameters. When supplied a list, the function
+will return  draws from the listed model parameters.}
 }
 \value{
 A named list containing:
@@ -51,11 +51,11 @@ fit <- mod$sample(data = list(N = 10, y = c(0,1,0,0,0,0,0,0,0,1)))
 # Read all draws
 d <- read_sample_csv(fit$output_files())
 # Read only model parameter draws
-d <- read_sample_csv(fit$output_files(), parameters = NULL, sampler_diagnostics = list())
+d <- read_sample_csv(fit$output_files(), pars = NULL, sampler_diagnostics = """")
 # Read only specific parameter draws
-d <- read_sample_csv(fit$output_files(), parameters = list(""beta"", ""theta""), sampler_diagnostics = list())
+d <- read_sample_csv(fit$output_files(), pars = c(""beta"", ""theta""), sampler_diagnostics = """")
 # Read only specific sampler diagnostic
-d <- read_sample_csv(fit$output_files(), parameters = list(), sampler_diagnostics = c(""divergent__""))
+d <- read_sample_csv(fit$output_files(), pars = """", sampler_diagnostics = c(""divergent__""))
 }
 
 }

---FILE: tests/testthat/test-fit-mcmc.R---
@@ -104,7 +104,7 @@ test_that(""inc_warmup in draws() works"", {
   x3 <- fit_mcmc_2$draws(inc_warmup = FALSE)
   expect_equal(dim(x3), c(100000, 1, 5))
   expect_error(fit_mcmc_2$draws(inc_warmup = TRUE),
-               ""Warmup draws were requested from a fit object without them! Please restart the sampling with save_warmup = TRUE."")
+               ""Warmup draws were requested from a fit object without them! Please rerun the model with save_warmup = TRUE."")
   y3 <- fit_mcmc_2$sampler_diagnostics(inc_warmup = FALSE)
   expect_equal(dim(y3), c(100000, 1, 6))
 })",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,26b3827f1e2953a457d611ccfe427792dbd86847,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-01T17:12:14Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-06-01T17:12:14Z,fix comments,R/model.R;R/run.R;R/utils.R,False,True,True,False,7,4,11,"---FILE: R/model.R---
@@ -422,8 +422,11 @@ CmdStanModel$set(""public"", name = ""compile"", value = compile_method)
 #'   * `validate_csv`: (logical) When `TRUE` (the default), validate the
 #'   sampling results in the csv files. Disable if you wish to manually read in
 #'   the sampling results and validate them.
-#'   * `threads_per_chain`: (positive integer) The number of threads to use per MCMC chaing
-#'   to run parallel sections of model.
+#'   * `threads_per_chain`: (positive integer) The number of threads to use in 
+#'   parallel sections (for example reduce_sum or map_rect) of a MCMC chain.
+#'   This is contrast with `cores` that specifies the maximum amount of CPU cores
+#'   used across all chains.
+#'
 #' @section Value: The `$sample()` method returns a [`CmdStanMCMC`] object.
 #'
 #' @template seealso-docs

---FILE: R/run.R---
@@ -282,7 +282,7 @@ CmdStanProcs <- R6::R6Class(
     #   chains. Currently for other methods this must be set to 1.
     # @param num_cores The number of cores for running MCMC chains in parallel.
     #   Currently for other method this must be set to 1.
-    # @param threads_per_chain The number of threads to use per MCMC chaing
+    # @param threads_per_chain The number of threads to use per MCMC chain
     #   to run parallel sections of model. 
     initialize = function(num_runs, num_cores, threads_per_chain = NULL) {
       checkmate::assert_integerish(num_runs, lower = 1, len = 1, any.missing = FALSE)

---FILE: R/utils.R---
@@ -341,7 +341,7 @@ NULL
 #' @export
 #' @return The value of the environment variable `STAN_NUM_THREADS`.
 num_threads <- function() {
-  warning(""'stan_threads()' is deprecated. Please use the 'sampling_info()' method of the fit object to obtain the number of threads used."")
+  warning(""'num_threads()' is deprecated. Please use the 'sampling_info()' method of the fit object to obtain the number of threads used."")
   num_threads <- Sys.getenv(""STAN_NUM_THREADS"")
   as.integer(num_threads)
 }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,a4ab62957d7138884b77d736406b1ee2e662a65c,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-05-24T17:13:12Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-05-24T17:13:12Z,fix compile bug if header dependency changed,R/install.R;R/utils.R,False,True,True,False,34,35,69,"---FILE: R/install.R---
@@ -286,6 +286,37 @@ build_cmdstan <- function(dir,
   )
 }
 
+# Removes files that are used to simplify switching to using threading,
+# opencl or mpi.
+clean_compile_helper_files <- function() {
+  # remove main_.*.o files and model_header_.*.hpp.gch files
+  files_to_remove <- c(
+    list.files(
+      path = file.path(cmdstan_path(), ""src"", ""cmdstan""),
+      pattern = ""main.*\\.o$"",
+      full.names = TRUE
+    ),
+    list.files(
+      path = file.path(cmdstan_path(), ""src"", ""cmdstan""),
+      pattern = ""main.*\\.d$"",
+      full.names = TRUE
+    ),
+    list.files(
+      path = file.path(cmdstan_path(), ""stan"", ""src"", ""stan"", ""model""),
+      pattern = ""model_header.*\\.hpp.gch$"",
+      full.names = TRUE
+    ),
+    list.files(
+      path = file.path(cmdstan_path(), ""stan"", ""src"", ""stan"", ""model""),
+      pattern = ""model_header.*\\.d$"",
+      full.names = TRUE
+    )
+  )
+  if (!is.null(files_to_remove)) {
+    file.remove(files_to_remove)
+  }
+}
+
 clean_cmdstan <- function(dir = cmdstan_path(),
                           cores = getOption(""mc.cores"", 2),
                           quiet = FALSE) {
@@ -299,20 +330,7 @@ clean_cmdstan <- function(dir = cmdstan_path(),
     error_on_status = FALSE,
     stderr_line_callback = function(x,p) { if(quiet) message(x) }
   )
-  # remove main_.*.o files and model_header_.*.hpp.gch files
-  files_to_remove <- c(
-    list.files(
-      path = file.path(cmdstan_path(), ""src"", ""cmdstan""),
-      pattern = ""main_.*\\.o$"",
-      full.names = TRUE
-    ),
-    list.files(
-      path = file.path(cmdstan_path(), ""stan"", ""src"", ""stan"", ""model""),
-      pattern = ""model_header_.*\\.hpp.gch$"",
-      full.names = TRUE
-    )
-  )
-  file.remove(files_to_remove)
+  clean_compile_helper_files()
 }
 
 build_example <- function(dir, cores, quiet, timeout) {

---FILE: R/utils.R---
@@ -285,27 +285,15 @@ prepare_precompiled <- function(cpp_options = list(), quiet = FALSE) {
   }
   main_path_w_flags <- file.path(cmdstan_path(), ""src"", ""cmdstan"", paste0(""main_"", flags, "".o""))
   main_path_o <- file.path(cmdstan_path(), ""src"", ""cmdstan"", ""main.o"")
-  main_path_d <- file.path(cmdstan_path(), ""src"", ""cmdstan"", ""main.d"")
   model_header_path_w_flags <- file.path(cmdstan_path(), ""stan"", ""src"", ""stan"", ""model"", paste0(""model_header_"", flags, "".hpp.gch""))
   model_header_path_gch <- file.path(cmdstan_path(), ""stan"", ""src"", ""stan"", ""model"", ""model_header.hpp.gch"")
-  model_header_path_d <- file.path(cmdstan_path(), ""stan"", ""src"", ""stan"", ""model"", ""model_header.d"")
-  model_header_path_hpp <- file.path(cmdstan_path(), ""stan"", ""src"", ""stan"", ""model"", ""model_header.d"")
   if (file.exists(model_header_path_gch)) {
     model_header_gch_used <- TRUE
   } else {
     model_header_gch_used <- FALSE
   }
   if (!file.exists(main_path_w_flags)) {
-
-    files_to_remove <- c(
-      main_path_o,
-      main_path_d,
-      model_header_path_gch,
-      model_header_path_d
-    )
-    for (file in files_to_remove) if (file.exists(file)) {
-      file.remove(file)
-    }
+    clean_compile_helper_files()
     run_log <- processx::run(
       command = make_cmd(),
       args = c(cpp_options_to_compile_flags(cpp_options),
@@ -330,14 +318,7 @@ prepare_precompiled <- function(cpp_options = list(), quiet = FALSE) {
         stderr_line_callback = function(x,p) { if (!quiet) message(x) },
         error_on_status = TRUE
       )
-      if (file.exists(model_header_path_gch)) {
-        file.copy(model_header_path_gch, model_header_path_w_flags)
-      }
-    }
-  } else {
-    file.copy(main_path_w_flags, main_path_o, overwrite=TRUE)
-    if (model_header_gch_used && file.exists(model_header_path_w_flags)) {
-      file.copy(model_header_path_w_flags, model_header_path_gch, overwrite=TRUE)
+      file.copy(model_header_path_gch, model_header_path_w_flags)
     }
   }
 }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,6d24d0851d8487e3fe8e9013219219b2e071c370,jgabry,jgabry@gmail.com,2020-05-19T12:55:41Z,jgabry,jgabry@gmail.com,2020-05-19T12:55:41Z,fix warning about '@noRd has no parameters',R/run.R,False,True,True,False,11,12,23,"---FILE: R/run.R---
@@ -458,17 +458,16 @@ CmdStanProcs <- R6::R6Class(
         if (nzchar(line)) {
           last_section_start_time <- private$chain_info_[id,""last_section_start_time""]
           state <- private$chain_info_[id,""state""]
-          #' @noRd
-          #' State machine for reading stdout.
-          #' 0 - chain has not started yet
-          #' 1 - chain is initializing (before iterations) and no output is printed
-          #' 2 - chain is initializing and inital values were rejected (output is printed)
-          #' 3 - chain is in warmup
-          #' 4 - chain is in sampling
-          #' 5 - iterations are done but the chain process has not stopped yet
-          #' 6 - the chain's process has stopped
-          #' state 2 is only used because rejection in cmdstan is printed to stdout not stderr
-          #' and we want to avoid printing the intial chain metadata
+          # State machine for reading stdout.
+          # 0 - chain has not started yet
+          # 1 - chain is initializing (before iterations) and no output is printed
+          # 2 - chain is initializing and inital values were rejected (output is printed)
+          # 3 - chain is in warmup
+          # 4 - chain is in sampling
+          # 5 - iterations are done but the chain process has not stopped yet
+          # 6 - the chain's process has stopped
+          # (Note: state 2 is only used because rejection in cmdstan is printed
+          # to stdout not stderr and we want to avoid printing the intial chain metadata)
           next_state <- state
           if (state < 3 && regexpr(""Rejecting initial value:"", line, perl = TRUE) > 0) {
             state <- 2
@@ -507,7 +506,7 @@ CmdStanProcs <- R6::R6Class(
           if (self$is_error_message(line)) {
             # will print all remaining output in case of exceptions
             if(state == 1) {
-              state = 2;
+              state <- 2;
             }
             message(""Chain "", id, "" "", line)
           }",True,False,Documentation / Formatting,3
stan-dev,cmdstanr,6cf55ccbfb55c241597cc32bd2ccd0d50ebd52cc,jgabry,jgabry@gmail.com,2020-05-18T23:25:44Z,jgabry,jgabry@gmail.com,2020-05-18T23:25:44Z,fix failing tests,tests/testthat/test-fit-mcmc.R,False,True,True,False,2,2,4,"---FILE: tests/testthat/test-fit-mcmc.R---
@@ -82,15 +82,15 @@ test_that(""inc_warmup in draws() works"", {
   x2 <- fit_mcmc_1$draws(inc_warmup = TRUE)
   expect_equal(dim(x0), c(1000, 2, 5))
   expect_error(fit_mcmc_0$draws(inc_warmup = TRUE),
-               ""Warmup draws were requested from a fit object without them! Please restart the sampling with save_warmup = TRUE."")
+               ""Warmup draws were requested from a fit object without them!"")
   expect_equal(dim(x1), c(1000, 2, 5))
   expect_equal(dim(x2), c(2000, 2, 5))
   y0 <- fit_mcmc_0$sampler_diagnostics(inc_warmup = FALSE)
   y1 <- fit_mcmc_1$sampler_diagnostics(inc_warmup = FALSE)
   y2 <- fit_mcmc_1$sampler_diagnostics(inc_warmup = TRUE)
   expect_equal(dim(y0), c(1000, 2, 6))
   expect_error(fit_mcmc_0$sampler_diagnostics(inc_warmup = TRUE),
-               ""Warmup sampler diagnostics were requested from a fit object without them! Please restart the sampling with save_warmup = TRUE."")
+               ""Warmup sampler diagnostics were requested from a fit object without them!"")
   expect_equal(dim(y1), c(1000, 2, 6))
   expect_equal(dim(y2), c(2000, 2, 6))
 })",True,False,Implementation / Logic,3
stan-dev,cmdstanr,ca2b456ff0807ca77f48af4ea8339f743a2e54d9,jgabry,jgabry@gmail.com,2020-05-18T22:38:16Z,jgabry,jgabry@gmail.com,2020-05-18T22:38:16Z,edit error message text,R/fit.R,False,True,True,False,12,10,22,"---FILE: R/fit.R---
@@ -357,7 +357,8 @@ CmdStanMCMC <- R6::R6Class(
       }
       if (inc_warmup) {
         if (!private$sampling_info_$save_warmup) {
-          stop(""Warmup draws were requested from a fit object without them! Please restart the sampling with save_warmup = TRUE."")
+          stop(""Warmup draws were requested from a fit object without them! "",
+               ""Please rerun the model with save_warmup = TRUE."")
         }
 
         posterior::bind_draws(private$warmup_draws_, private$draws_, along=""iteration"")[,,parameters]
@@ -378,7 +379,8 @@ CmdStanMCMC <- R6::R6Class(
       }
       if (inc_warmup) {
         if (!private$sampling_info_$save_warmup) {
-          stop(""Warmup sampler diagnostics were requested from a fit object without them! Please restart the sampling with save_warmup = TRUE."")
+          stop(""Warmup sampler diagnostics were requested from a fit object without them! "",
+               ""Please rerun the model with save_warmup = TRUE."")
         }
         posterior::bind_draws(private$warmup_sampler_diagnostics_, private$sampler_diagnostics_, along=""iteration"")
       } else {
@@ -414,31 +416,31 @@ CmdStanMCMC <- R6::R6Class(
                                   sampler_diagnostics = sampler_diagnostics_to_read,
                                   cores = self$runset$procs$num_cores())
       private$sampling_info_ <- data_csv$sampling_info
-      if(!is.null(data_csv$post_warmup_draws)) {
-        if(is.null(private$draws_)) {
+      if (!is.null(data_csv$post_warmup_draws)) {
+        if (is.null(private$draws_)) {
           private$draws_ <- data_csv$post_warmup_draws
         } else {
           private$draws_ <- posterior::bind_draws(data_csv$post_warmup_draws[,,-1], private$draws_, along=""variable"")
         }
       }
-      if(!is.null(data_csv$post_warmup_sampler_diagnostics)) {
-        if(is.null(private$sampler_diagnostics_)) {
+      if (!is.null(data_csv$post_warmup_sampler_diagnostics)) {
+        if (is.null(private$sampler_diagnostics_)) {
           private$sampler_diagnostics_ <- data_csv$post_warmup_sampler_diagnostics
         } else {
           private$sampler_diagnostics_ <- posterior::bind_draws(data_csv$post_warmup_sampler_diagnostics, private$sampler_diagnostics_, along=""variable"")
         }
       }
       if (!is.null(data_csv$sampling_info$save_warmup)
          && data_csv$sampling_info$save_warmup) {
-        if(!is.null(data_csv$warmup_draws)) {
-          if(is.null(private$warmup_draws_)) {
+        if (!is.null(data_csv$warmup_draws)) {
+          if (is.null(private$warmup_draws_)) {
             private$warmup_draws_ <- data_csv$warmup_draws
           } else {
             private$warmup_draws_ <- posterior::bind_draws(data_csv$warmup_draws[,,-1], private$warmup_draws_, along=""variable"")
           }
         }
-        if(!is.null(data_csv$warmup_sampler_diagnostics)) {
-          if(is.null(private$warmup_sampler_diagnostics_)) {
+        if (!is.null(data_csv$warmup_sampler_diagnostics)) {
+          if (is.null(private$warmup_sampler_diagnostics_)) {
             private$warmup_sampler_diagnostics_ <- data_csv$warmup_sampler_diagnostics
           } else {
             private$warmup_sampler_diagnostics_ <- posterior::bind_draws(data_csv$warmup_sampler_diagnostics, private$warmup_sampler_diagnostics_, along=""variable"")",True,False,Implementation / Logic,6
stan-dev,cmdstanr,b08f25fdef99dd451d02ad3720532aa0cc82dcbd,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-05-16T17:56:06Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-05-16T17:56:06Z,fix dir,R/utils.R,False,True,True,False,1,1,2,"---FILE: R/utils.R---
@@ -455,7 +455,7 @@ check_sampler_transitions_treedepth <- function(data_csv) {
 #' cmdstan_make_local(flags = flags)
 #' 
 cmdstan_make_local <- function(dir = cmdstan_path(), flags = NULL, append = TRUE) {
-  make_local_path <- file.path(cmdstan_path(), ""make"", ""local"")
+  make_local_path <- file.path(dir, ""make"", ""local"")
   if (!is.null(flags)) {
     built_flags = c()
     for (i in seq_len(length(flags))) {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,a26ca637daab3e8a488417d9dda42c65342e8b9d,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-05-16T17:38:14Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-05-16T17:38:14Z,"fix test, docs",R/utils.R;man/cmdstan_make_local.Rd;tests/testthat/test-install.R,False,True,True,False,4,4,8,"---FILE: R/utils.R---
@@ -442,7 +442,7 @@ check_sampler_transitions_treedepth <- function(data_csv) {
 #' @export
 #' @param dir Path to the directory of the CmdStan installation. The default is
 #'   the path to the Cmdstan installation in use.
-#' @param flags 
+#' @param flags a list of flags to be written to the make/local file.
 #' @param append Should the listed makefile flags be appended to the end of an existing
 #'   make/local file? The default is `FALSE`.
 #' @example

---FILE: man/cmdstan_make_local.Rd---
@@ -11,7 +11,7 @@ cmdstan_make_local(dir = cmdstan_path(), flags = NULL, append = TRUE)
 \item{dir}{Path to the directory of the CmdStan installation. The default is
 the path to the Cmdstan installation in use.}
 
-\item{flags}{}
+\item{flags}{a list of flags to be written to the make/local file.}
 
 \item{append}{Should the listed makefile flags be appended to the end of an existing
 make/local file? The default is \code{FALSE}.}

---FILE: tests/testthat/test-install.R---
@@ -54,7 +54,7 @@ test_that(""install_cmdstan() errors if it times out"", {
     expect_message(
       install_cmdstan(dir = dir, timeout = 1, quiet = TRUE, overwrite = dir_exists,
                       release_url = test_release_url()),
-      if (dir_exists) ""* Removing the existing installation"" else ""* Latest CmdStan release"",
+      if (dir_exists) ""* Removing the existing installation"" else ""* * Installing Cmdstan from https://github.com"",
       fixed = TRUE
     ),
     ""increasing the value of the 'timeout' argument and running again with 'quiet=FALSE'"",
@@ -66,7 +66,7 @@ test_that(""install_cmdstan() errors if it times out"", {
     expect_message(
       install_cmdstan(dir = dir, timeout = 1, quiet = FALSE, overwrite = dir_exists,
                       release_url = test_release_url()),
-      if (dir_exists) ""* Removing the existing installation"" else ""* Latest CmdStan release"",
+      if (dir_exists) ""* Removing the existing installation"" else ""* * Installing Cmdstan from https://github.com"",
       fixed = TRUE
     ),
     ""Try increasing the value of the 'timeout' argument."",",True,False,Documentation / Formatting,7
stan-dev,cmdstanr,35418a60d8b6d5d7e832b567157d3d340efe2a3c,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-05-16T16:34:31Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-05-16T16:34:31Z,windows fix for 2.23 to not require chmod,R/install.R,False,True,True,False,10,1,11,"---FILE: R/install.R---
@@ -85,7 +85,16 @@ install_cmdstan <- function(dir = NULL,
           call. = FALSE)
   }
   file.remove(dest_file)
-
+  # windows bugfixes
+  if (os_is_windows()) {
+    if ((cmdstan_ver > ""2.22"") && (cmdstan_ver < ""2.24"")) {
+      windows_stanc <- file.path(dir_cmdstan, ""bin"", ""windows-stanc"")
+      bin_stanc_exe <- file.path(dir_cmdstan, ""bin"", ""stanc.exe"")
+      if (file.exists(windows_stanc)) {
+        file.rename(windows_stanc, bin_stanc_exe)
+      }
+    }
+  }
   message(""* Building CmdStan binaries..."")
   build_log <- build_cmdstan(dir_cmdstan, cores, quiet, timeout)
   if (!build_status_ok(build_log, quiet = quiet)) {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,80aaf91ac21479c34ea231b5053816875362cd20,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-05-16T16:33:03Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-05-16T16:33:03Z,fix docs,R/install.R;man/install_cmdstan.Rd,False,True,True,False,17,9,26,"---FILE: R/install.R---
@@ -32,7 +32,7 @@
 #'   compilation.
 #'
 install_cmdstan <- function(dir = NULL,
-                            cores = 2,
+                            cores = getOption(""mc.cores"", 2),
                             quiet = FALSE,
                             overwrite = FALSE,
                             timeout = 1200,
@@ -91,13 +91,16 @@ install_cmdstan <- function(dir = NULL,
           call. = FALSE)
   }
   file.remove(dest_file)
-  cmdstan_make_local(flags = makefile_flags, append = TRUE)
-  if (os_is_windows() && (cmdstan_ver < ""2.24"")) {
-    cmdstan_make_local(flags = list(
-      ""ifeq (gcc,$(CXX_TYPE))"",
-      ""CXXFLAGS_WARNINGS+= -Wno-int-in-bool-context -Wno-attributes"",
-      ""endif""
-    ), append = TRUE)
+  cmdstan_make_local(dir = dir_cmdstan, flags = makefile_flags, append = TRUE)
+  # windows bugfixes
+  if (os_is_windows()) {
+    if ((cmdstan_ver < ""2.24"")) {
+      cmdstan_make_local(dir = dir_cmdstan, flags = list(
+        ""ifeq (gcc,$(CXX_TYPE))"",
+        ""CXXFLAGS_WARNINGS+= -Wno-int-in-bool-context -Wno-attributes"",
+        ""endif""
+      ), append = TRUE)
+    }
   }  
   message(""* Building CmdStan binaries..."")
   build_log <- build_cmdstan(dir_cmdstan, cores, quiet, timeout)

---FILE: man/install_cmdstan.Rd---
@@ -10,7 +10,8 @@ install_cmdstan(
   quiet = FALSE,
   overwrite = FALSE,
   timeout = 1200,
-  release_url = NULL
+  release_url = NULL,
+  makefile_flags = list()
 )
 }
 \arguments{
@@ -37,6 +38,10 @@ installation process. The default is \code{timeout=600} (10 minutes).}
 
 \item{release_url}{Specifies the URL to a specific Cmdstan release to be installed.
 By default set to NULL, which downloads the latest stable release from stan-dev/cmdstan.}
+
+\item{makefile_flags}{Specifies any makefile flags/variables to be written to the
+make/local file. For example list(""CXX"" = ""clang++"") will force the use of clang for
+compilation.}
 }
 \description{
 \if{html}{\figure{logo.png}{options: width=""25px"" alt=""https://mc-stan.org/about/logo/""}}",True,False,Documentation / Formatting,7
stan-dev,cmdstanr,1517918538b5596bc449ffa222efed09558f74b6,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-05-16T08:02:56Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-05-16T09:59:34Z,fix path and version,R/install.R,False,True,True,False,3,2,5,"---FILE: R/install.R---
@@ -87,8 +87,9 @@ install_cmdstan <- function(dir = NULL,
           call. = FALSE)
   }
   file.remove(dest_file)
-  if (os_is_windows() && (cmdstan_version() < ""2.24"")) {
-    write(""ifeq (gcc,$(CXX_TYPE))\nCXXFLAGS_WARNINGS+= -Wno-int-in-bool-context -Wno-attributes\nendif"", file.path(cmdstan_path(), ""make"", ""local""), append = TRUE)
+  if (os_is_windows() && (cmdstan_ver < ""2.24"")) {
+    write(""ifeq (gcc,$(CXX_TYPE))\nCXXFLAGS_WARNINGS+= -Wno-int-in-bool-context -Wno-attributes\nendif"",
+          file.path(dir_cmdstan, ""make"", ""local""), append = TRUE)
   }  
   message(""* Building CmdStan binaries..."")
   build_log <- build_cmdstan(dir_cmdstan, cores, quiet, timeout)",True,False,Implementation / Logic,6
stan-dev,cmdstanr,d991c9e32d885164b47d97d31e62a10c2963a0f5,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-05-16T08:04:48Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-05-16T08:04:48Z,fix options,R/model.R,False,True,True,False,1,1,2,"---FILE: R/model.R---
@@ -242,7 +242,7 @@ compile_method <- function(quiet = TRUE,
   # temporary deprecation warnings
   if (isTRUE(threads)) {
     warning(""'threads' is deprecated. Please use 'cpp_options = list(stan_threads = TRUE)' instead."")
-    stanc_options[[""stan_threads""]] <- TRUE
+    cpp_options[[""stan_threads""]] <- TRUE
   }
   if (!force_recompile) {
     message(""Model executable is up to date!"")",True,False,Implementation / Logic,6
stan-dev,cmdstanr,8cd8ad744d07dd60b9efdafbd5265a7a1b1d8a96,jgabry,jgabry@gmail.com,2020-05-12T16:59:14Z,jgabry,jgabry@gmail.com,2020-05-12T16:59:14Z,fix failing tests,R/read_csv.R;tests/testthat/test-csv.R;tests/testthat/test-fit-shared.R,False,True,True,False,4,4,8,"---FILE: R/read_csv.R---
@@ -20,8 +20,8 @@ check_sampling_csv_info_matches <- function(a, b) {
     return(list(error = ""Supplied CSV files dont match in the number of stored samples!""))
   }
   match_list <- c(""stan_version_major"", ""stan_version_minor"", ""stan_version_patch"", ""gamma"", ""kappa"",
-                  ""t0"", ""init_buffer"", ""term_buffer"", ""window"", ""algorithm"", ""engine"", ""max_depth"",
-                  ""metric"", ""stepsize"", ""stepsize_jitter"", ""adapt_engaged"", ""adapt_delta"", ""num_warmup"")
+                  ""t0"", ""init_buffer"", ""term_buffer"", ""window"", ""algorithm"", ""engine"", ""max_treedepth"",
+                  ""metric"", ""step_size"", ""stepsize_jitter"", ""adapt_engaged"", ""adapt_delta"", ""iter_warmup"")
   not_matching <- c()
   for (name in names(a)) {
     if ((name %in% match_list) && (is.null(b[[name]]) ||  all(a[[name]] != b[[name]]))) {

---FILE: tests/testthat/test-csv.R---
@@ -48,7 +48,7 @@ test_that(""read_sample_csv() fails for different number of samples in csv"", {
   csv_files <- c(fit_logistic_thin_1$output_files(),
                  fit_logistic_thin_1b$output_files())
   expect_warning(read_sample_csv(csv_files),
-               ""The supplied csv files do not match in the following arguments: num_warmup!"")
+               ""The supplied csv files do not match in the following arguments: iter_warmup!"")
   csv_files <- c(fit_logistic_thin_1$output_files(),
                  fit_logistic_thin_1_with_warmup$output_files())
   expect_error(read_sample_csv(csv_files),

---FILE: tests/testthat/test-fit-shared.R---
@@ -34,7 +34,7 @@ test_that(""saving csv output files works"", {
 
     expect_message(
       paths <- fit$save_output_files(tempdir(), basename = ""testing-output""),
-      paste(""Moved"", fit$num_runs(), ""output files and set internal paths"")
+      paste(""Moved"", fit$num_runs(), ""files and set internal paths"")
     )
     checkmate::expect_file_exists(paths, extension = ""csv"")
     expect_true(all(file.size(paths) > 0))",True,False,Implementation / Logic,6
stan-dev,cmdstanr,d0be300209694a068ce62fc4913504058d200b3a,jgabry,jgabry@gmail.com,2020-05-12T16:24:40Z,jgabry,jgabry@gmail.com,2020-05-12T16:24:40Z,fix more uses of max_treedepth and step_size,R/args.R;R/read_csv.R;R/utils.R;man/read_sample_csv.Rd;tests/testthat/test-csv.R;tests/testthat/test-model-sample.R,False,True,True,False,41,32,73,"---FILE: R/args.R---
@@ -713,7 +713,7 @@ available_metrics <- function() {
 #' @param arg_name Name of slot in `self` containing the argument value.
 #' @param cmdstan_arg_name Name of corresponding argument for CmdStan (if not
 #'   the same as arg_name). For example for `arg_name=""max_treedepth""` we have
-#'   `cmdstan_arg_name=""max_depth""` (at least until CmdStan 3).
+#'   `cmdstan_arg_name=""max_depth""` (at least until names change in CmdStan 3).
 #' @param idx Chain id (only applicable for MCMC).
 compose_arg <- function(self, arg_name, cmdstan_arg_name = NULL, idx = NULL) {
   val <- self[[arg_name]]

---FILE: R/read_csv.R---
@@ -13,11 +13,11 @@ check_sampling_csv_info_matches <- function(a, b) {
   if ((length(a$model_params)!= length(b$model_params)) || !(all(a$model_params == b$model_params) && all(a$sampler_diagnostics == b$sampler_diagnostics))) {
     return(list(error = ""Supplied CSV files have samples for different parameters!""))
   }
-  if(a$num_samples != b$num_samples ||
-    a$thin != b$thin ||
-    a$save_warmup != b$save_warmup ||
-    (a$save_warmup == 1 && a$num_warmup != b$num_warmup)) {
-      return(list(error = ""Supplied CSV files dont match in the number of stored samples!""))
+  if (a$iter_sampling != b$iter_sampling ||
+      a$thin != b$thin ||
+      a$save_warmup != b$save_warmup ||
+      (a$save_warmup == 1 && a$iter_warmup != b$iter_warmup)) {
+    return(list(error = ""Supplied CSV files dont match in the number of stored samples!""))
   }
   match_list <- c(""stan_version_major"", ""stan_version_minor"", ""stan_version_patch"", ""gamma"", ""kappa"",
                   ""t0"", ""init_buffer"", ""term_buffer"", ""window"", ""algorithm"", ""engine"", ""max_depth"",
@@ -59,13 +59,13 @@ read_sample_info_csv <- function(csv_file) {
         csv_file_info[[""model_params""]] <- c()
         for(x in all_names) {
           if (csv_file_info$algorithm != ""fixed_param"") {
-            if (endsWith(x, ""__"") && x != ""lp__""){
+            if (endsWith(x, ""__"") && x != ""lp__"") {
               csv_file_info[[""sampler_diagnostics""]] <- c(csv_file_info[[""sampler_diagnostics""]], x)
             } else {
               csv_file_info[[""model_params""]] <- c(csv_file_info[[""model_params""]], x)
             }
           } else {
-            if (!endsWith(x, ""__"")){
+            if (!endsWith(x, ""__"")) {
               csv_file_info[[""model_params""]] <- c(csv_file_info[[""model_params""]], x)
             }
           }
@@ -136,16 +136,27 @@ read_sample_info_csv <- function(csv_file) {
     cols <- length(csv_file_info$inverse_metric)/inverse_metric_rows
     dim(csv_file_info$inverse_metric) <- c(rows,cols)
   }
+
+  # rename from old cmdstan names to new cmdstanX names
   csv_file_info$model_name <- csv_file_info$model
-  csv_file_info$model <- NULL
   csv_file_info$adapt_engaged <- csv_file_info$engaged
   csv_file_info$adapt_delta <- csv_file_info$delta
+  csv_file_info$max_treedepth <- csv_file_info$max_depth
+  csv_file_info$step_size <- csv_file_info$stepsize
+  csv_file_info$iter_warmup <- csv_file_info$num_warmup
+  csv_file_info$iter_sampling <- csv_file_info$num_samples
+  csv_file_info$model <- NULL
   csv_file_info$engaged <- NULL
   csv_file_info$delta <- NULL
+  csv_file_info$max_depth <- NULL
+  csv_file_info$stepsize <- NULL
+  csv_file_info$num_warmup <- NULL
+  csv_file_info$num_samples <- NULL
   csv_file_info$file <- NULL
   csv_file_info$diagnostic_file <- NULL
   csv_file_info$metric_file <- NULL
-  return(csv_file_info)
+
+  csv_file_info
 }
 
 #' Read sampling results from the supplied CSV files
@@ -160,17 +171,17 @@ read_sample_info_csv <- function(csv_file) {
 #'
 #' @return The list of sampling arguments, the diagonal of the inverse mass
 #' matrix, the post-warmup samples, the sampling parameters and warmup samples
-#' if the run was run with save_warmup = 1.
+#' if the run was run with `save_warmup = 1`.
 #'
 read_sample_csv <- function(output_files) {
   sampling_info <- NULL
   warmup_draws <- NULL
   warmup_sampler_diagnostics_draws <- NULL
   post_warmup_draws <- NULL
   post_warmup_sampler_diagnostics_draws <- NULL
-  inverse_metric = list()
-  step_size = list()
-  not_matching = c()
+  inverse_metric <- list()
+  step_size <- list()
+  not_matching <- c()
   for(output_file in output_files) {
     checkmate::assert_file_exists(output_file, access = ""r"", extension = ""csv"")
     # read meta data
@@ -186,14 +197,12 @@ read_sample_csv <- function(output_files) {
     } else {
       csv_file_info <- read_sample_info_csv(output_file)
       # check if sampling info matches
-      check <- check_sampling_csv_info_matches(sampling_info,
-                                  csv_file_info)
+      check <- check_sampling_csv_info_matches(sampling_info, csv_file_info)
       if (!is.null(check$error)) {
         stop(check$error)
       }
       not_matching <- c(not_matching, check$not_matching)
-      sampling_info$id <- c(sampling_info$id,
-                            csv_file_info$id)
+      sampling_info$id <- c(sampling_info$id, csv_file_info$id)
 
       if (!is.null(csv_file_info$inverse_metric)) {
         inverse_metric[[csv_file_info$id]] <- csv_file_info$inverse_metric
@@ -206,8 +215,8 @@ read_sample_csv <- function(output_files) {
     # read sampling data
     draws <- utils::read.csv(output_file, header = TRUE, comment.char = ""#"")
     if (nrow(draws) > 0) {
-      num_warmup_draws <- ceiling(sampling_info$num_warmup/sampling_info$thin)
-      num_post_warmup_draws <- ceiling(sampling_info$num_samples/sampling_info$thin)
+      num_warmup_draws <- ceiling(sampling_info$iter_warmup/sampling_info$thin)
+      num_post_warmup_draws <- ceiling(sampling_info$iter_sampling/sampling_info$thin)
       all_draws <- num_warmup_draws + num_post_warmup_draws
 
       if (sampling_info$save_warmup == 1) {
@@ -272,7 +281,7 @@ read_sample_csv <- function(output_files) {
   if (!is.null(post_warmup_draws)){
     dimnames(post_warmup_draws)$variable <- repair_variable_names(sampling_info$model_params)
   }
-  if(length(not_matching) > 0) {
+  if (length(not_matching) > 0) {
     not_matching_list <- paste(unique(not_matching), collapse = "", "")
     warning(""The supplied csv files do not match in the following arguments: "", not_matching_list, ""!"")
   }

---FILE: R/utils.R---
@@ -313,7 +313,7 @@ prepare_precompiled <- function(cpp_options, quiet = FALSE) {
     model_header_gch_used <- FALSE
   }
   if (!file.exists(main_path_w_flags)) {
-    
+
     files_to_remove <- c(
       main_path_o,
       main_path_d,
@@ -411,7 +411,7 @@ check_sampler_transitions_treedepth <- function(data_csv) {
   if (!is.null(data_csv$post_warmup_sampler_diagnostics)) {
     treedepth <- posterior::extract_variable_matrix(data_csv$post_warmup_sampler_diagnostics, ""treedepth__"")
     num_of_draws <- length(treedepth)
-    max_treedepth <- data_csv$sampling_info$max_depth
+    max_treedepth <- data_csv$sampling_info$max_treedepth
     max_treedepth_hit <- sum(treedepth >= max_treedepth)
     if (max_treedepth_hit > 0) {
       percentage_max_treedepth <- (max_treedepth_hit)/num_of_draws*100

---FILE: man/read_sample_csv.Rd---
@@ -12,7 +12,7 @@ read_sample_csv(output_files)
 \value{
 The list of sampling arguments, the diagonal of the inverse mass
 matrix, the post-warmup samples, the sampling parameters and warmup samples
-if the run was run with save_warmup = 1.
+if the run was run with \code{save_warmup = 1}.
 }
 \description{
 Read sampling results from the supplied CSV files. Returns a list containing

---FILE: tests/testthat/test-csv.R---
@@ -117,8 +117,8 @@ test_that(""read_sample_csv() matches rstan::read_stan_csv() with save_warmup"", {
   draws_array <- posterior::as_draws_array(draws_array)
   csv_output <- read_sample_csv(csv_files)
 
-  warmup_iter <- csv_output$sampling_info$num_warmup
-  num_iter <- csv_output$sampling_info$num_samples+csv_output$sampling_info$num_warmup
+  warmup_iter <- csv_output$sampling_info$iter_warmup
+  num_iter <- csv_output$sampling_info$iter_sampling + csv_output$sampling_info$iter_warmup
 
   draws_array_post_warmup <- draws_array[(warmup_iter+1):num_iter,,]
   draws_array_warmup <- draws_array[1:warmup_iter,,]
@@ -220,11 +220,11 @@ test_that(""read_sample_csv() matches rstan::read_stan_csv() for csv file"", {
   sampler_diagnostics <- readRDS(test_path(""answers"", ""rstan-read-stan-csv-sampler-params.rds""))
   sampler_diagnostics <- posterior::as_draws_array(sampler_diagnostics[[1]])
   csv_output <- read_sample_csv(csv_files)
-  num_warmup <- csv_output$sampling_info$num_warmup/csv_output$sampling_info$thin
+  num_warmup <- csv_output$sampling_info$iter_warmup/csv_output$sampling_info$thin
   if(csv_output$sampling_info$save_warmup) {
-    num_iter <- csv_output$sampling_info$num_samples + csv_output$sampling_info$num_warmup
+    num_iter <- csv_output$sampling_info$iter_sampling + csv_output$sampling_info$iter_warmup
   } else {
-    num_iter <- csv_output$sampling_info$num_samples
+    num_iter <- csv_output$sampling_info$iter_sampling
   }
 
   # match warmup sampler info

---FILE: tests/testthat/test-model-sample.R---
@@ -27,7 +27,7 @@ if (not_on_cran()) {
     seed = 12345,
     max_treedepth = 6,
     metric = ""dense_e"",
-    stepsize = 1.1,
+    step_size = 1.1,
     adapt_engaged = TRUE,
     adapt_delta = 0.7,
     save_latent_dynamics = FALSE,
@@ -51,7 +51,7 @@ if (not_on_cran()) {
     seed = -10,
     max_treedepth = 0,
     metric = ""NOT_A_METRIC"",
-    stepsize = 0,
+    step_size = 0,
     adapt_engaged = ""NO"",
     adapt_delta = 2,
     save_latent_dynamics = ""NOT_LOGICAL"",
@@ -67,7 +67,7 @@ if (not_on_cran()) {
     cores = ""NOT_A_NUMBER"",
     init = ""NOT_A_FILE"",
     seed = 1:10,
-    stepsize = 1:10,
+    step_size = 1:10,
     metric = c(""AA"", ""BB""),
     init_buffer = -5,
     term_buffer = -6,",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,c3ecf6f4e21ed5a159227b6faa7966374a5fa4dc,jgabry,jgabry@gmail.com,2020-05-11T21:26:05Z,jgabry,jgabry@gmail.com,2020-05-11T21:26:05Z,fix a few more old arg name usages,tests/testthat/test-failed-chains.R;tests/testthat/test-model-sample.R,False,True,True,False,4,4,8,"---FILE: tests/testthat/test-failed-chains.R---
@@ -104,7 +104,7 @@ test_that(""init warnings are shown"", {
   suppressWarnings(
     expect_message(
       utils::capture.output(
-        mod_init_warnings$sample(num_chains = 1)
+        mod_init_warnings$sample(chains = 1)
       ),
       ""Rejecting initial value""
     )

---FILE: tests/testthat/test-model-sample.R---
@@ -193,14 +193,14 @@ test_that(""sample() method runs when fixed_param = TRUE"", {
   skip_on_cran()
   mod_fp$compile()
 
-  expect_sample_output(fit_1000 <- mod_fp$sample(fixed_param = TRUE, num_samples = 1000), 1)
+  expect_sample_output(fit_1000 <- mod_fp$sample(fixed_param = TRUE, iter_sampling = 1000), 1)
   expect_is(fit_1000, ""CmdStanMCMC"")
   expect_equal(dim(fit_1000$draws()), c(1000,1,10))
 
-  expect_sample_output(fit_500 <- mod_fp$sample(fixed_param = TRUE, num_samples = 500), 1)
+  expect_sample_output(fit_500 <- mod_fp$sample(fixed_param = TRUE, iter_sampling = 500), 1)
   expect_equal(dim(fit_500$draws()), c(500,1,10))
 
-  expect_sample_output(fit_500_w <- mod_fp$sample(fixed_param = TRUE, num_samples = 500, num_warmup = 5000), 1)
+  expect_sample_output(fit_500_w <- mod_fp$sample(fixed_param = TRUE, iter_sampling = 500, iter_warmup = 5000), 1)
   expect_equal(dim(fit_500_w$draws()), c(500,1,10))
 
   expect_equal(fit_1000$sampling_info()$algorithm, ""fixed_param"")",True,False,Rendering / Conversion,3
stan-dev,cmdstanr,091bab21602740c6e9f9eecb745845b7b53c72a9,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-05-11T18:53:31Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-05-11T18:53:31Z,fixed tests,R/model.R;tests/testthat/test-model-compile.R,False,True,True,False,98,99,197,"---FILE: R/model.R---
@@ -214,9 +214,9 @@ compile_method <- function(quiet = TRUE,
                            cpp_options = list(),
                            stanc_options = list(),
                            force_recompile = FALSE) {
-  if (is.null(self$exe_file())) {
+  if (all(nzchar(self$exe_file()))) {
     exe <- cmdstan_ext(strip_ext(self$stan_file()))
-  } else {
+  } else {    
     exe <- cmdstan_ext(strip_ext(self$exe_file()))
   }
   if (is.null(self$stan_file())) {
@@ -233,10 +233,9 @@ compile_method <- function(quiet = TRUE,
              && file.mtime(exe) < file.mtime(self$stan_file())) {
     force_recompile <- TRUE
   }
-
   if (!force_recompile) {
     message(""Model executable is up to date!"")
-    private$exe_file(exe)
+    self$exe_file(exe)
     return(invisible(self))
   } else {
     message(""Compiling Stan program..."")

---FILE: tests/testthat/test-model-compile.R---
@@ -24,7 +24,7 @@ test_that(""error if no compile() before model fitting"", {
 test_that(""compile() method works"", {
   skip_on_cran()
   # remove executable if exists
-  exe <- cmdstan_ext(file.path(dirname(mod$stan_file()),mod$model_name()))
+  exe <- cmdstan_ext(strip_ext(mod$stan_file()))
   if (file.exists(exe)) {
     file.remove(exe)
   }
@@ -38,97 +38,97 @@ test_that(""compile() method works"", {
   expect_output(print(out), ""Translating Stan model"")
 })
 
-# test_that(""compile() method forces recompilation force_recompile = TRUE"", {
-#   skip_on_cran()
-#   mod$compile(quiet = TRUE)
-#   expect_message(mod$compile(quiet = TRUE, force_recompile = TRUE), ""Compiling Stan program..."")
-# })
-#
-# test_that(""compile() method forces recompilation if model modified"", {
-#   skip_on_cran()
-#   # remove executable if exists
-#   exe <- cmdstan_ext(strip_ext(mod$stan_file()))
-#   if (!file.exists(exe)) {
-#     mod$compile(quiet = TRUE)
-#   }
-#   Sys.setFileTime(mod$stan_file(), Sys.time()) #touch file to trigger recompile
-#   expect_message(mod$compile(quiet = TRUE), ""Compiling Stan program..."")
-# })
-#
-# test_that(""compile() method works with spaces in path"", {
-#   skip_on_cran()
-#   stan_file <- testing_stan_file(""bernoulli"")
-#   stan_model_with_spaces <- testing_stan_file(""folder spaces/bernoulli spaces"")
-#
-#   dir_with_spaces <- test_path(""resources"", ""stan"", ""folder spaces"")
-#   if (!file.exists(dir_with_spaces)) {
-#     dir.create(dir_with_spaces)
-#   }
-#   file.copy(stan_file, stan_model_with_spaces)
-#
-#   mod_spaces <- cmdstan_model(stan_file = stan_model_with_spaces, compile = FALSE)
-#   exe <- cmdstan_ext(strip_ext(mod_spaces$stan_file()))
-#   if (file.exists(exe)) {
-#     file.remove(exe)
-#   }
-#   expect_message(mod_spaces$compile(), ""Compiling Stan program..."")
-#   file.remove(stan_model_with_spaces)
-#   file.remove(exe)
-#   file.remove(dir_with_spaces)
-# })
-#
-# test_that(""compile() method overwrites binaries"", {
-#   skip_on_cran()
-#   mod$compile(quiet = TRUE)
-#   old_time = file.mtime(mod$exe_file())
-#   mod$compile(quiet = TRUE, force_recompile = TRUE)
-#   new_time =
-#   expect_gt(file.mtime(mod$exe_file()), old_time)
-# })
-#
-# test_that(""compilation works with include_paths"", {
-#   skip_on_cran()
-#
-#   stan_program_w_include <- testing_stan_file(""bernoulli_include"")
-#   exe <- cmdstan_ext(strip_ext(stan_program_w_include))
-#   if(file.exists(exe)) {
-#     file.remove(exe)
-#   }
-#   expect_error(
-#     cmdstan_model(stan_file = stan_program_w_include, include_paths = ""NOT_A_DIR"",
-#                   quiet = TRUE),
-#     ""Directory 'NOT_A_DIR' does not exist""
-#   )
-#
-#   expect_error(
-#     expect_output(
-#       cmdstan_model(stan_file = stan_program_w_include, quiet = TRUE),
-#       ""could not find include file""
-#     )
-#   )
-#
-#   expect_message(
-#     mod_w_include <- cmdstan_model(stan_file = stan_program_w_include, quiet = TRUE,
-#                                    include_paths = test_path(""resources"", ""stan"")),
-#     ""Compiling Stan program""
-#   )
-#   expect_equal(
-#     mod_w_include$exe_file(),
-#     cmdstan_ext(strip_ext(absolute_path(stan_program_w_include)))
-#   )
-# })
-#
-# test_that(""name in STANCFLAGS is set correctly"", {
-#   skip_on_cran()
-#   out <- utils::capture.output(mod$compile(quiet = FALSE, force_recompile = TRUE))
-#   if(os_is_windows()) {
-#     out_no_name <- ""bin/stanc.exe --name='bernoulli_model' --o""
-#     out_name <- ""bin/stanc.exe --name='bernoulli2_model' --o""
-#   } else {
-#     out_no_name <- ""bin/stanc --name='bernoulli_model' --o""
-#     out_name <- ""bin/stanc --name='bernoulli2_model' --o""
-#   }
-#   expect_output(print(out), out_no_name)
-#   out <- utils::capture.output(mod$compile(quiet = FALSE, force_recompile = TRUE, stanc_options = list(name = ""bernoulli2_model"")))
-#   expect_output(print(out), out_name)
-# })
+test_that(""compile() method forces recompilation force_recompile = TRUE"", {
+  skip_on_cran()
+  mod$compile(quiet = TRUE)
+  expect_message(mod$compile(quiet = TRUE, force_recompile = TRUE), ""Compiling Stan program..."")
+})
+
+test_that(""compile() method forces recompilation if model modified"", {
+  skip_on_cran()
+  # remove executable if exists
+  exe <- cmdstan_ext(strip_ext(mod$stan_file()))
+  if (!file.exists(exe)) {
+    mod$compile(quiet = TRUE)
+  }
+  Sys.setFileTime(mod$stan_file(), Sys.time()) #touch file to trigger recompile
+  expect_message(mod$compile(quiet = TRUE), ""Compiling Stan program..."")
+})
+
+test_that(""compile() method works with spaces in path"", {
+  skip_on_cran()
+  stan_file <- testing_stan_file(""bernoulli"")
+  stan_model_with_spaces <- testing_stan_file(""folder spaces/bernoulli spaces"")
+
+  dir_with_spaces <- test_path(""resources"", ""stan"", ""folder spaces"")
+  if (!file.exists(dir_with_spaces)) {
+    dir.create(dir_with_spaces)
+  }
+  file.copy(stan_file, stan_model_with_spaces)
+
+  mod_spaces <- cmdstan_model(stan_file = stan_model_with_spaces, compile = FALSE)
+  exe <- cmdstan_ext(strip_ext(mod_spaces$stan_file()))
+  if (file.exists(exe)) {
+    file.remove(exe)
+  }
+  expect_message(mod_spaces$compile(), ""Compiling Stan program..."")
+  file.remove(stan_model_with_spaces)
+  file.remove(exe)
+  file.remove(dir_with_spaces)
+})
+
+test_that(""compile() method overwrites binaries"", {
+  skip_on_cran()
+  mod$compile(quiet = TRUE)
+  old_time = file.mtime(mod$exe_file())
+  mod$compile(quiet = TRUE, force_recompile = TRUE)
+  new_time =
+  expect_gt(file.mtime(mod$exe_file()), old_time)
+})
+
+test_that(""compilation works with include_paths"", {
+  skip_on_cran()
+
+  stan_program_w_include <- testing_stan_file(""bernoulli_include"")
+  exe <- cmdstan_ext(strip_ext(stan_program_w_include))
+  if(file.exists(exe)) {
+    file.remove(exe)
+  }
+  expect_error(
+    cmdstan_model(stan_file = stan_program_w_include, include_paths = ""NOT_A_DIR"",
+                  quiet = TRUE),
+    ""Directory 'NOT_A_DIR' does not exist""
+  )
+
+  expect_error(
+    expect_output(
+      cmdstan_model(stan_file = stan_program_w_include, quiet = TRUE),
+      ""could not find include file""
+    )
+  )
+
+  expect_message(
+    mod_w_include <- cmdstan_model(stan_file = stan_program_w_include, quiet = TRUE,
+                                   include_paths = test_path(""resources"", ""stan"")),
+    ""Compiling Stan program""
+  )
+  expect_equal(
+    mod_w_include$exe_file(),
+    cmdstan_ext(strip_ext(absolute_path(stan_program_w_include)))
+  )
+})
+
+test_that(""name in STANCFLAGS is set correctly"", {
+  skip_on_cran()
+  out <- utils::capture.output(mod$compile(quiet = FALSE, force_recompile = TRUE))
+  if(os_is_windows()) {
+    out_no_name <- ""bin/stanc.exe --name='bernoulli_model' --o""
+    out_name <- ""bin/stanc.exe --name='bernoulli2_model' --o""
+  } else {
+    out_no_name <- ""bin/stanc --name='bernoulli_model' --o""
+    out_name <- ""bin/stanc --name='bernoulli2_model' --o""
+  }
+  expect_output(print(out), out_no_name)
+  out <- utils::capture.output(mod$compile(quiet = FALSE, force_recompile = TRUE, stanc_options = list(name = ""bernoulli2_model"")))
+  expect_output(print(out), out_name)
+})",True,False,Implementation / Logic,6
stan-dev,cmdstanr,4817d5847589ee17ade931057e965c223a8503a3,jgabry,jgabry@gmail.com,2020-05-11T16:48:55Z,jgabry,jgabry@gmail.com,2020-05-11T16:48:55Z,"fix compile method doc

[ci skip]",DESCRIPTION;R/model.R;man/model-method-compile.Rd,False,True,True,False,8,14,22,"---FILE: DESCRIPTION---
@@ -17,7 +17,7 @@ URL: https://mc-stan.org/cmdstanr, https://discourse.mc-stan.org
 BugReports: https://github.com/stan-dev/cmdstanr/issues
 Encoding: UTF-8
 LazyData: true
-RoxygenNote: 7.0.2
+RoxygenNote: 7.1.0
 Roxygen: list(markdown = TRUE, r6 = FALSE)
 SystemRequirements: 'CmdStan' <https://mc-stan.org/users/interfaces/cmdstan>
 Imports: 

---FILE: R/model.R---
@@ -166,11 +166,8 @@ CmdStanModel <- R6::R6Class(
 #'   $compile(
 #'     quiet = TRUE,
 #'     include_paths = NULL,
-#'     threads = FALSE,
-#'     opencl = FALSE,
-#'     opencl_platform_id = 0,
-#'     opencl_device_id = 0,
-#'     compiler_flags = NULL,
+#'     cpp_options = list(),
+#'     stanc_options = list(),
 #'     force_recompile = FALSE
 #'   )
 #'   $exe_file()
@@ -216,7 +213,7 @@ compile_method <- function(quiet = TRUE,
                            stanc_options = list(),
                            force_recompile = FALSE) {
   if(is.null(stanc_options[[""name""]])) {
-    if (is.null(self$model_name())) {    
+    if (is.null(self$model_name())) {
       exe <- cmdstan_ext(strip_ext(self$stan_file()))
       self$model_name(sub("" "", ""_"",
                         paste0(strip_ext(basename(self$stan_file())), ""_model"")))
@@ -236,7 +233,7 @@ compile_method <- function(quiet = TRUE,
   } else if (file.mtime(exe) < file.mtime(self$stan_file())) {
     force_recompile <- TRUE
   }
-  
+
   if (!force_recompile) {
     message(""Model executable is up to date!"")
     private$exe_file_ <- exe
@@ -254,7 +251,7 @@ compile_method <- function(quiet = TRUE,
     path_to_TBB <- file.path(cmdstan_path(), ""stan"", ""lib"", ""stan_math"", ""lib"", ""tbb"")
     Sys.setenv(PATH = paste0(path_to_TBB, "";"", Sys.getenv(""PATH"")))
   }
-  
+
   stancflags_val <- """"
   if (!is.null(include_paths)) {
     checkmate::assert_directory_exists(include_paths, access = ""r"")

---FILE: man/model-method-compile.Rd---
@@ -14,11 +14,8 @@ the path to the executable can be accesed via the \verb{$exe_file()} method.
 \preformatted{$compile(
   quiet = TRUE,
   include_paths = NULL,
-  threads = FALSE,
-  opencl = FALSE,
-  opencl_platform_id = 0,
-  opencl_device_id = 0,
-  compiler_flags = NULL,
+  cpp_options = list(),
+  stanc_options = list(),
   force_recompile = FALSE
 )
 $exe_file()",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,088cba0362192e73dea50fac6ff53253222bec60,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-05-10T11:42:14Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-05-10T11:42:14Z,fix travis,.travis.yml,False,False,False,False,2,2,4,"---FILE: .travis.yml---
@@ -21,8 +21,8 @@ env:
 # this before_script works if cmdstanr is in r_github_packages above
 before_script:
   - Rscript -e 'cmdstanr::install_cmdstan(cores = 2, overwrite = TRUE, release_url = ""https://github.com/stan-dev/cmdstan/releases/download/v2.23.0/cmdstan-2.23.0.tar.gz"")'
-  - sudo touch $HOME/.cmdstanr/cmdstan/make/local
-  - sudo chown -R $USER:$USER $HOME/.cmdstanr/cmdstan/make/local
+  - sudo touch $HOME/.cmdstanr/cmdstan-2.23.0/make/local
+  - sudo chown -R $USER:$USER $HOME/.cmdstanr/cmdstan-2.23.0/make/local
 
 after_success:
   - travis_wait Rscript -e 'covr::codecov(line_exclusions = list(""R/zzz.R""))'",False,False,Data / Input Handling,3
stan-dev,cmdstanr,b084ed6a2a4686cc106199f49d069d87789a9ee5,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-05-10T10:35:23Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-05-10T10:35:23Z,fix warnings,R/install.R;R/read_csv.R,False,True,True,False,2,2,4,"---FILE: R/install.R---
@@ -49,7 +49,7 @@ install_cmdstan <- function(dir = NULL,
     message(""* Installing Cmdstan from "", release_url)
     download_url <- release_url
     split_url <- strsplit(release_url, ""/"")
-    tar_name <- tail(split_url[[1]], n=1)
+    tar_name <- utils::tail(split_url[[1]], n=1)
     cmdstan_ver <- substr(tar_name, 0, nchar(tar_name)-7)
     tar_gz_file <- paste0(cmdstan_ver, "".tar.gz"")
     dir_cmdstan <- file.path(dir, cmdstan_ver)

---FILE: R/read_csv.R---
@@ -320,7 +320,7 @@ read_vb_csv <- function(output_file) {
   colnames(mat) <- repair_variable_names(colnames(mat))
   mat <- mat[, colnames(mat) != ""lp__"", drop=FALSE]
   draws <- posterior::as_draws_matrix(mat)
-  draws <- posterior::rename_variables(draws, lp__ = log_p__, lp_approx__ = log_g__)
+  draws <- posterior::rename_variables(draws, lp__ = ""log_p__"", lp_approx__ = ""log_g__"")
   list(draws = draws)
 }
 ",True,False,Implementation / Logic,6
stan-dev,cmdstanr,3cdf445259edbf6eb3342e58aa685103b5479380,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-05-10T10:15:26Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-05-10T10:15:26Z,fix initialize,R/path.R,False,True,True,False,4,4,8,"---FILE: R/path.R---
@@ -115,11 +115,11 @@ cmdstan_default_path <- function() {
     # if installed in folder cmdstan, with no version
     # move to cmdstan-version folder
     if (""cmdstan"" %in% cmdstan_installs) {
-      ver <- read_cmdstan_version(file.path(path, ""cmdstan""))
-      old_path <- file.path(path, ""cmdstan"")
-      new_path <- file.path(path, paste0(""cmdstan-"",ver))
+      ver <- read_cmdstan_version(file.path(installs_path, ""cmdstan""))
+      old_path <- file.path(installs_path, ""cmdstan"")
+      new_path <- file.path(installs_path, paste0(""cmdstan-"",ver))
       file.rename(old_path, new_path)
-      cmdstan_installs <- list.dirs(path = path, recursive = FALSE, full.names = FALSE)
+      cmdstan_installs <- list.dirs(path = installs_path, recursive = FALSE, full.names = FALSE)
     }
     if(length(cmdstan_installs) > 0) {
       return(file.path(installs_path,sort(cmdstan_installs, decreasing = TRUE)[1]))",True,False,Implementation / Logic,6
stan-dev,cmdstanr,96ddd02e7766dd8ff5eb94f81af9546a4fe40592,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-05-10T10:07:30Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-05-10T10:07:30Z,fix tests,tests/testthat/test-install.R,False,True,True,False,15,11,26,"---FILE: tests/testthat/test-install.R---
@@ -19,20 +19,24 @@ test_that(""install_cmdstan() successfully installs cmdstan"", {
 
 test_that(""install_cmdstan() errors if installation already exists"", {
   skip_if_offline()
+  ver <- latest_released_version()
   if (not_on_cran()) {
     # want to test passing NULL to install_cmdstan but need a real dir to
     # check in dir.exists() below so also create dir_check
-    dir <- NULL
-    dir_check <- cmdstan_default_path()
+    install_dir <- cmdstan_default_install_path()
   } else {
-    dir <- dir_check <- tempdir()
+    install_dir <- tempdir()
   }
-  if (dir.exists(file.path(dir_check, ""cmdstan""))) {
-    expect_warning(
-      install_cmdstan(dir = dir, overwrite = FALSE),
-      ""An installation already exists""
-    )
+  dir <- file.path(install_dir, paste0(""cmdstan-"",ver))
+  fake_folder <- FALSE
+  if (!dir.exists(dir)) {
+    fake_folder <- TRUE
+    dir.create(dir)
   }
+  expect_warning(
+    install_cmdstan(dir = install_dir, overwrite = FALSE),
+    ""An installation already exists""
+  )
 })
 
 test_that(""install_cmdstan() errors if it times out"", {
@@ -42,8 +46,8 @@ test_that(""install_cmdstan() errors if it times out"", {
   } else {
     dir <- tempdir(check = TRUE)
   }
-  dir_exists <- dir.exists(file.path(dir, ""cmdstan""))
-
+  ver <- latest_released_version()
+  dir_exists <- dir.exists(file.path(dir, paste0(""cmdstan-"",ver)))
   # with quiet=TRUE
   expect_warning(
     expect_message(
@@ -54,7 +58,7 @@ test_that(""install_cmdstan() errors if it times out"", {
     ""increasing the value of the 'timeout' argument and running again with 'quiet=FALSE'"",
     fixed = TRUE
   )
-
+  dir_exists <- dir.exists(file.path(dir, paste0(""cmdstan-"",ver)))
   # with quiet=FALSE
   expect_warning(
     expect_message(",True,False,Implementation / Logic,6
stan-dev,cmdstanr,9a108370ebde661c337b69797f0fb8a7a10881a8,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-03-22T18:09:33Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-03-22T18:09:33Z,fix test,tests/testthat/test-model-sample.R,False,True,True,False,3,3,6,"---FILE: tests/testthat/test-model-sample.R---
@@ -203,7 +203,7 @@ test_that(""sample() method runs when fixed_param = TRUE"", {
   expect_sample_output(fit_500_w <- mod_fp$sample(fixed_param = TRUE, num_samples = 500, num_warmup = 5000), 1)
   expect_equal(dim(fit_500_w$draws()), c(500,1,10))
 
-  expect_equal(fit_1000$sampling_info$algorithm, ""fixed_param"")
-  expect_equal(fit_500$sampling_info$algorithm, ""fixed_param"")
-  expect_equal(fit_500_w$sampling_info$algorithm, ""fixed_param"")
+  expect_equal(fit_1000$sampling_info()$algorithm, ""fixed_param"")
+  expect_equal(fit_500$sampling_info()$algorithm, ""fixed_param"")
+  expect_equal(fit_500_w$sampling_info()$algorithm, ""fixed_param"")
 })",True,False,Implementation / Logic,3
stan-dev,cmdstanr,2cc184e8a9a7c5d57fa8b40262e9a2039d9c4577,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-03-16T17:43:19Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-03-16T17:43:19Z,fix param doxy,R/utils.R;man/set_cmdstan_cpp_options.Rd,False,True,True,False,7,2,9,"---FILE: R/utils.R---
@@ -256,8 +256,8 @@ write_stan_json <- function(data, file) {
 #' Set the Cmdstan make options or flags used when compiling the
 #' generated C++ code.
 #'
-#' @cpp_options a list of make options to use when compiling the generated C++ code
-#' @quiet If TRUE suppresses all the output.
+#' @param cpp_options a list of make options to use when compiling the generated C++ code
+#' @param quiet If TRUE suppresses all the output.
 #' @return TRUE if the cpp_options were changed, FALSE otherwise
 #' @export
 #'

---FILE: man/set_cmdstan_cpp_options.Rd---
@@ -7,6 +7,11 @@ generated C++ code.}
 \usage{
 set_cmdstan_cpp_options(cpp_options, quiet = FALSE)
 }
+\arguments{
+\item{cpp_options}{a list of make options to use when compiling the generated C++ code}
+
+\item{quiet}{If TRUE suppresses all the output.}
+}
 \value{
 TRUE if the cpp_options were changed, FALSE otherwise
 }",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,3d26361a49dfc012138f084fd15401e90acaa5c3,Ben,bbbales2@gmail.com,2020-03-11T17:46:23Z,Ben,bbbales2@gmail.com,2020-03-11T17:46:23Z,Added missing force_compile doc line and fixed type (Issue #75),R/model.R;man/model-method-compile.Rd,False,True,True,False,8,6,14,"---FILE: R/model.R---
@@ -160,7 +160,8 @@ CmdStanModel <- R6::R6Class(
 #'     opencl = FALSE,
 #'     opencl_platform_id = 0,
 #'     opencl_device_id = 0,
-#'     compiler_flags = NULL
+#'     compiler_flags = NULL,
+#'     force_recompile = FALSE
 #'   )
 #'   $exe_file()
 #'   ```
@@ -190,7 +191,7 @@ CmdStanModel <- R6::R6Class(
 #'     OpenCL platform on which to run the compiled model.
 #'   * `compiler_flags`: (character vector) Any additional compiler flags to be
 #'     used when compiling the model.
-#'   * `force_recompile`: (character vector) Should the model be recompiled
+#'   * `force_recompile`: (logical) Should the model be recompiled
 #'     even if was not modified since last compiled. The default is `FALSE`.
 #'
 #' @section Value: This method is called for its side effect of creating the
@@ -231,7 +232,7 @@ compile_method <- function(quiet = TRUE,
   } else if (file.mtime(exe) < file.mtime(self$stan_file())) {
     recompile <- TRUE
   }
-                
+
   model_name <- paste0(strip_ext(basename(self$stan_file())), ""_model"")
   if (!recompile) {
     message(""Model executable is up to date!"")
@@ -285,7 +286,7 @@ compile_method <- function(quiet = TRUE,
     stderr_line_callback = function(x,p) { if(quiet) message(x) },
     error_on_status = TRUE
   )
-  
+
   file.copy(tmp_exe, exe, overwrite = TRUE)
   private$exe_file_ <- exe
   invisible(self)

---FILE: man/model-method-compile.Rd---
@@ -18,7 +18,8 @@ the path to the executable can be accesed via the \verb{$exe_file()} method.
   opencl = FALSE,
   opencl_platform_id = 0,
   opencl_device_id = 0,
-  compiler_flags = NULL
+  compiler_flags = NULL,
+  force_recompile = FALSE
 )
 $exe_file()
 }
@@ -51,7 +52,7 @@ to run the compiled model.
 OpenCL platform on which to run the compiled model.
 \item \code{compiler_flags}: (character vector) Any additional compiler flags to be
 used when compiling the model.
-\item \code{force_recompile}: (character vector) Should the model be recompiled
+\item \code{force_recompile}: (logical) Should the model be recompiled
 even if was not modified since last compiled. The default is \code{FALSE}.
 }
 }",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,a47cd301208eb30f1e9773c0b096273cfce2f344,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-03-10T08:38:25Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-03-10T08:38:25Z,added docs and fixed typos,R/run.R;docs/articles/cmdstanr.html;docs/reference/CmdStanModel.html;docs/reference/cmdstan_model.html;docs/reference/cmdstanr-package.html;docs/reference/model-method-optimize.html;docs/reference/model-method-sample.html;docs/reference/model-method-variational.html;tests/testthat/test-model-sample.R,False,True,True,False,21,10,31,"---FILE: R/run.R---
@@ -457,6 +457,17 @@ CmdStanProcs <- R6::R6Class(
         if (nzchar(line)) {
           last_section_start_time <- private$chain_info_[id,""last_section_start_time""]
           state <- private$chain_info_[id,""state""]
+          #' @noRd
+          #' State machine for reading stdout. 
+          #' 0 - chain has not started yet
+          #' 1 - chain is initializing (before iterations) and no output is printed
+          #' 2 - chain is initializing and inital values were rejected (output is printed)
+          #' 3 - chain is in warmup
+          #' 4 - chain is in sampling
+          #' 5 - iterations are done but the chain process has not stopped yet
+          #' 6 - the chain's process has stopped
+          #' state 2 is only used because rejection in cmdstan is printed to stdout not stderr
+          #' and we want to avoid printing the intial chain metadata
           next_state <- state
           if (state < 3 && regexpr(""Rejecting initial value:"", line, perl = TRUE) > 0) {
             state <- 2
@@ -517,9 +528,9 @@ CmdStanProcs <- R6::R6Class(
         num_failed <- self$num_failed()
         if (num_failed == 0) {
           if (num_chains == 2) {
-            cat(""\nBoth chains finished succesfully.\n"")
+            cat(""\nBoth chains finished successfully.\n"")
           } else {
-            cat(""\nAll"", num_chains, ""chains finished succesfully.\n"")
+            cat(""\nAll"", num_chains, ""chains finished successfully.\n"")
           }
           cat(""Mean chain execution time:"",
               format(round(mean(self$total_chain_times()), 1), nsmall = 1),

---FILE: docs/articles/cmdstanr.html---
@@ -256,7 +256,7 @@ <h4 class=""hasAnchor"">
 Chain 1 finished in 0.2 seconds.
 Chain 2 finished in 0.2 seconds.
 
-Both chains finished succesfully.
+Both chains finished successfully.
 Mean chain execution time: 0.2 seconds.
 Total execution time: 0.3 seconds.</code></pre>
 <p>The <a href=""https://mc-stan.org/cmdstanr/reference/model-method-sample.html""><code>$sample()</code></a> method creates <a href=""https://r6.r-lib.org/"">R6</a> <a href=""https://mc-stan.org/cmdstanr/reference/CmdStanMCMC.html""><code>CmdStanMCMC</code></a> objects.</p>

---FILE: docs/reference/CmdStanModel.html---
@@ -293,7 +293,7 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; Chain 1 finished in 0.2 seconds.
 #&gt; Chain 2 finished in 0.2 seconds.
 #&gt; 
-#&gt; Both chains finished succesfully.
+#&gt; Both chains finished successfully.
 #&gt; Mean chain execution time: 0.2 seconds.
 #&gt; Total execution time: 0.3 seconds.</div><div class='input'>
 <span class='co'># Use 'posterior' package for summaries</span>

---FILE: docs/reference/cmdstan_model.html---
@@ -297,7 +297,7 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; Chain 1 finished in 0.2 seconds.
 #&gt; Chain 2 finished in 0.1 seconds.
 #&gt; 
-#&gt; Both chains finished succesfully.
+#&gt; Both chains finished successfully.
 #&gt; Mean chain execution time: 0.1 seconds.
 #&gt; Total execution time: 0.2 seconds.</div><div class='input'>
 <span class='co'># Use 'posterior' package for summaries</span>

---FILE: docs/reference/cmdstanr-package.html---
@@ -307,7 +307,7 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; Chain 1 finished in 0.2 seconds.
 #&gt; Chain 2 finished in 0.2 seconds.
 #&gt; 
-#&gt; Both chains finished succesfully.
+#&gt; Both chains finished successfully.
 #&gt; Mean chain execution time: 0.2 seconds.
 #&gt; Total execution time: 0.2 seconds.</div><div class='input'>
 <span class='co'># Use 'posterior' package for summaries</span>

---FILE: docs/reference/model-method-optimize.html---
@@ -367,7 +367,7 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; Chain 1 finished in 0.2 seconds.
 #&gt; Chain 2 finished in 0.1 seconds.
 #&gt; 
-#&gt; Both chains finished succesfully.
+#&gt; Both chains finished successfully.
 #&gt; Mean chain execution time: 0.2 seconds.
 #&gt; Total execution time: 0.2 seconds.</div><div class='input'>
 <span class='co'># Use 'posterior' package for summaries</span>

---FILE: docs/reference/model-method-sample.html---
@@ -427,7 +427,7 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; Chain 1 finished in 0.1 seconds.
 #&gt; Chain 2 finished in 0.1 seconds.
 #&gt; 
-#&gt; Both chains finished succesfully.
+#&gt; Both chains finished successfully.
 #&gt; Mean chain execution time: 0.1 seconds.
 #&gt; Total execution time: 0.2 seconds.</div><div class='input'>
 <span class='co'># Use 'posterior' package for summaries</span>

---FILE: docs/reference/model-method-variational.html---
@@ -383,7 +383,7 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; Chain 1 finished in 0.2 seconds.
 #&gt; Chain 2 finished in 0.2 seconds.
 #&gt; 
-#&gt; Both chains finished succesfully.
+#&gt; Both chains finished successfully.
 #&gt; Mean chain execution time: 0.2 seconds.
 #&gt; Total execution time: 0.2 seconds.</div><div class='input'>
 <span class='co'># Use 'posterior' package for summaries</span>

---FILE: tests/testthat/test-model-sample.R---
@@ -164,7 +164,7 @@ test_that(""sampling in parallel works"", {
 
   expect_output(
     mod$sample(data = data_list, num_chains = 2, num_cores = 2),
-    ""Both chains finished succesfully"",
+    ""Both chains finished successfully"",
     fixed = TRUE
   )
 })",True,False,Documentation / Formatting,4
stan-dev,cmdstanr,ac0ce4cbcc512aaed6673c940da6628584742071,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-03-09T07:53:20Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-03-09T07:53:20Z,fix the model name,R/model.R,False,True,True,False,6,1,7,"---FILE: R/model.R---
@@ -225,6 +225,7 @@ compile_method <- function(quiet = TRUE,
   exe <- cmdstan_ext(strip_ext(self$stan_file()))
   recompile <- make_local_changed || force_recompile ||
                !file.exists(exe) || (file.mtime(exe) < file.mtime(self$stan_file()))
+  model_name <- paste0(strip_ext(basename(self$stan_file())), ""_model"")
   if (!recompile) {
     message(""Model executable is up to date!"")
     private$exe_file_ <- exe
@@ -258,9 +259,13 @@ compile_method <- function(quiet = TRUE,
     include_paths <- paste0(""STANCFLAGS += --include_paths="", include_paths)
   }
 
+  # TODO(Rok): Once we handle stancflags separately this should be overriden
+  # if a user specifies their own name
+  model_name_stancflag <- paste0(""STANCFLAGS+=--name="", model_name)
+
   run_log <- processx::run(
     command = make_cmd(),
-    args = c(tmp_exe, include_paths),
+    args = c(tmp_exe, include_paths, model_name_stancflag),
     wd = cmdstan_path(),
     echo_cmd = !quiet,
     echo = !quiet,",True,False,Environment / Configuration,3
stan-dev,cmdstanr,e231467fb0f31ff01f6366363f129972fce6efb9,jgabry,jgabry@gmail.com,2020-03-04T16:28:22Z,jgabry,jgabry@gmail.com,2020-03-04T16:28:22Z,fix failing tests,R/fit.R,False,True,True,False,5,1,6,"---FILE: R/fit.R---
@@ -302,7 +302,11 @@ CmdStanMCMC <- R6::R6Class(
   public = list(
     initialize = function(runset) {
       super$initialize(runset)
-      private$read_csv_(diagnostic_warnings = TRUE)
+      if (!length(self$output_files())) {
+        warning(""No chains finished successfully. Unable to retrieve the fit."")
+      } else {
+        private$read_csv_(diagnostic_warnings = TRUE)
+      }
     },
     num_chains = function() {
       super$num_runs()",True,False,Implementation / Logic,6
stan-dev,cmdstanr,858c86eb2562b3944c87d05abc7d91ecbddeed5a,jgabry,jgabry@gmail.com,2020-03-02T23:01:50Z,jgabry,jgabry@gmail.com,2020-03-02T23:01:50Z,"fix typo in doc

[ci skip]",R/fit.R;man/fit-method-sampler_diagnostics.Rd,False,True,True,False,2,2,4,"---FILE: R/fit.R---
@@ -130,7 +130,7 @@ NULL
 #'
 #' @section Value:
 #' A 3-D [`draws_array`][posterior::draws_array] object (iteration x chain x
-#' variable). The variables for Stan's default MCMC algorith are
+#' variable). The variables for Stan's default MCMC algorithm are
 #' `""accept_stat__""`, `""stepsize__""`, `""treedepth__""`, `""n_leapfrog__""`,
 #' `""divergent__""`, `""energy__""`.
 #'

---FILE: man/fit-method-sampler_diagnostics.Rd---
@@ -23,7 +23,7 @@ iteration and chain of MCMC.
 \section{Value}{
 
 A 3-D \code{\link[posterior:draws_array]{draws_array}} object (iteration x chain x
-variable). The variables for Stan's default MCMC algorith are
+variable). The variables for Stan's default MCMC algorithm are
 \code{""accept_stat__""}, \code{""stepsize__""}, \code{""treedepth__""}, \code{""n_leapfrog__""},
 \code{""divergent__""}, \code{""energy__""}.
 }",True,False,Documentation / Formatting,7
stan-dev,cmdstanr,b2357cfd4ccade94b8c60bfffe184445bfa63006,jgabry,jgabry@gmail.com,2020-03-02T22:41:44Z,jgabry,jgabry@gmail.com,2020-03-02T22:41:44Z,"fix names of CmdStanVB methods (advances #21)

log_p should be lp (this is already the case for CmdStanMLE) and log_g I guess should be lp_approx",R/fit.R;man/CmdStanVB.Rd;tests/testthat/test-fit-vb.R,False,True,True,False,17,18,35,"---FILE: R/fit.R---
@@ -447,9 +447,9 @@ CmdStanMLE <- R6::R6Class(
 #'  [`$draws()`][fit-method-draws] \tab Return approximate posterior draws
 #'  as a [`draws_matrix`][posterior::draws_matrix]. \cr
 #'  [`$summary()`][fit-method-summary] \tab Run [posterior::summarise_draws()]. \cr
-#'  `$log_p()` \tab Return a numeric vector containing the target
+#'  `$lp()` \tab Return a numeric vector containing the target
 #'  (log-posterior) evaluated at each of the draws. \cr
-#'  `$log_g()` \tab Return a numeric vector containing the log density of the
+#'  `$lp_approx()` \tab Return a numeric vector containing the log density of the
 #'  variational approximation to the posterior evaluated at each of the draws. \cr
 #'  [`$cmdstan_summary()`][fit-method-cmdstan_summary]
 #'    \tab Run and print CmdStan's `bin/stansummary`. \cr
@@ -469,24 +469,23 @@ CmdStanVB <- R6::R6Class(
   classname = ""CmdStanVB"",
   inherit = CmdStanFit,
   public = list(
-    log_p = function() {
-      # iter x params array
-      if (is.null(private$log_p_)) private$read_csv_()
-      private$log_p_
+    lp = function() {
+      if (is.null(private$lp_)) private$read_csv_()
+      private$lp_
     },
-    log_g = function() {
+    lp_approx = function() {
       # iter x params array
-      if (is.null(private$log_g_)) private$read_csv_()
-      private$log_g_
+      if (is.null(private$lp_approx_)) private$read_csv_()
+      private$lp_approx_
     }
   ),
   private = list(
-    log_p_ = NULL,
-    log_g_ = NULL,
+    lp_ = NULL,
+    lp_approx_ = NULL,
     read_csv_ = function() {
       vb_output <- read_vb_csv(self$output_files())
-      private$log_p_ <- vb_output[[""log_p""]]
-      private$log_g_ <- vb_output[[""log_g""]]
+      private$lp_ <- vb_output[[""log_p""]]
+      private$lp_approx_ <- vb_output[[""log_g""]]
       private$draws_ <- posterior::as_draws_matrix(vb_output[[""draws""]])
       invisible(self)
     }

---FILE: man/CmdStanVB.Rd---
@@ -16,9 +16,9 @@ A \code{CmdStanVB} object is the fitted model object returned by the
 \code{\link[=fit-method-draws]{$draws()}} \tab Return approximate posterior draws
 as a \code{\link[posterior:draws_matrix]{draws_matrix}}. \cr
 \code{\link[=fit-method-summary]{$summary()}} \tab Run \code{\link[posterior:summarise_draws]{posterior::summarise_draws()}}. \cr
-\verb{$log_p()} \tab Return a numeric vector containing the target
+\verb{$lp()} \tab Return a numeric vector containing the target
 (log-posterior) evaluated at each of the draws. \cr
-\verb{$log_g()} \tab Return a numeric vector containing the log density of the
+\verb{$lp_approx()} \tab Return a numeric vector containing the log density of the
 variational approximation to the posterior evaluated at each of the draws. \cr
 \code{\link[=fit-method-cmdstan_summary]{$cmdstan_summary()}}
 \tab Run and print CmdStan's \code{bin/stansummary}. \cr

---FILE: tests/testthat/test-fit-vb.R---
@@ -26,10 +26,10 @@ test_that(""draws() method returns posterior sample (reading csv works)"", {
   expect_equal(posterior::variables(draws), PARAM_NAMES)
 })
 
-test_that(""log_p(), log_g() methods return vectors (reading csv works)"", {
+test_that(""lp(), lp_approx() methods return vectors (reading csv works)"", {
   skip_on_cran()
-  lp <- fit_vb$log_p()
-  lg <- fit_vb$log_g()
+  lp <- fit_vb$lp()
+  lg <- fit_vb$lp_approx()
   expect_type(lp, ""double"")
   expect_type(lg, ""double"")
   expect_equal(length(lp), nrow(fit_vb$draws()))",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,020914961a0645aec74512cba420c32570566a21,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-02-28T14:59:07Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-02-28T14:59:07Z,fix warmup only run,R/read_csv.R,False,True,True,False,4,2,6,"---FILE: R/read_csv.R---
@@ -240,8 +240,10 @@ read_sample_csv <- function(output_files) {
   }
   if(!is.null(warmup_draws)){
     dimnames(warmup_draws)$variable <- repair_variable_names(sampling_info$model_params)
-  }  
-  dimnames(post_warmup_draws)$variable <- repair_variable_names(sampling_info$model_params)
+  }
+  if(!is.null(post_warmup_draws)){
+    dimnames(post_warmup_draws)$variable <- repair_variable_names(sampling_info$model_params)
+  }
   sampling_info$model_params <- repair_variable_names(sampling_info$model_params)
   sampling_info$inverse_metric <- NULL
   sampling_info$step_size <- NULL  ",True,False,Implementation / Logic,6
stan-dev,cmdstanr,bd6871bcc6067318f8069af862d274be9da15535,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-02-28T12:37:46Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-02-28T12:37:46Z,fix names,R/read_csv.R,False,True,True,False,4,0,4,"---FILE: R/read_csv.R---
@@ -238,6 +238,10 @@ read_sample_csv <- function(output_files) {
       }
     }
   }
+  if(!is.null(warmup_draws)){
+    dimnames(warmup_draws)$variable <- repair_variable_names(sampling_info$model_params)
+  }  
+  dimnames(post_warmup_draws)$variable <- repair_variable_names(sampling_info$model_params)
   sampling_info$model_params <- repair_variable_names(sampling_info$model_params)
   sampling_info$inverse_metric <- NULL
   sampling_info$step_size <- NULL  ",True,False,Implementation / Logic,6
stan-dev,cmdstanr,1e40e6eef7afead1ce27e1c833cba28865c59e87,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-02-28T12:31:52Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-02-28T12:31:52Z,"fix the number of draws bug, fix tests",R/read_csv.R;R/utils.R;tests/testthat/test-utils.R,False,True,True,False,21,24,45,"---FILE: R/read_csv.R---
@@ -181,8 +181,9 @@ read_sample_csv <- function(output_files) {
     draws <- utils::read.csv(output_file, header = TRUE, comment.char = ""#"")
     if(nrow(draws) > 0) {
       num_warmup_draws <- ceiling(sampling_info$num_warmup/sampling_info$thin)
-      num_post_warmup_draws <- ceiling(sampling_info$num_warmup/sampling_info$thin)
+      num_post_warmup_draws <- ceiling(sampling_info$num_samples/sampling_info$thin)
       all_draws <- num_warmup_draws + num_post_warmup_draws
+      
       if(sampling_info$save_warmup == 1) {
 
         new_warmup_draws <- posterior::as_draws_array(draws[1:num_warmup_draws, sampling_info$model_params])

---FILE: R/utils.R---
@@ -407,16 +407,14 @@ check_divergences <- function(data_csv) {
   if(!is.null(data_csv$post_warmup_sampler_diagnostics)) {
     divergences <- posterior::extract_one_variable_matrix(data_csv$post_warmup_sampler_diagnostics, ""divergent__"")
     num_of_draws <- length(divergences)
-    if(num_of_draws > 0) {
-      num_of_divergences <- sum(divergences)
-      if (num_of_divergences > 0) {
-        percentage_divergences <- (num_of_divergences)/num_of_draws*100
-        message(num_of_divergences, "" of "", num_of_draws, "" ("", (format(round(percentage_divergences, 0), nsmall = 1)), ""%)"",
-                "" transitions ended with a divergence.\n"",
-                ""These divergent transitions indicate that HMC is not fully able to explore the posterior distribution.\n"",
-                ""Try increasing adapt delta closer to 1.\n"",
-                ""If this doesn't remove all divergences, try to reparameterize the model.\n"")
-      }
+    num_of_divergences <- sum(divergences)
+    if (num_of_divergences > 0) {
+      percentage_divergences <- (num_of_divergences)/num_of_draws*100
+      message(num_of_divergences, "" of "", num_of_draws, "" ("", (format(round(percentage_divergences, 0), nsmall = 1)), ""%)"",
+              "" transitions ended with a divergence.\n"",
+              ""These divergent transitions indicate that HMC is not fully able to explore the posterior distribution.\n"",
+              ""Try increasing adapt delta closer to 1.\n"",
+              ""If this doesn't remove all divergences, try to reparameterize the model.\n"")
     }
   }  
 }
@@ -425,18 +423,16 @@ check_sampler_transitions_treedepth <- function(data_csv) {
   if(!is.null(data_csv$post_warmup_sampler_diagnostics)) {
     treedepth <- posterior::extract_one_variable_matrix(data_csv$post_warmup_sampler_diagnostics, ""treedepth__"")
     num_of_draws <- length(treedepth)
-    if(num_of_draws > 0) {
-      max_treedepth <- data_csv$sampling_info$max_depth
-      max_treedepth_hit <- sum(treedepth >= max_treedepth)
-      if (max_treedepth_hit > 0) {
-        percentage_max_treedepth <- (max_treedepth_hit)/num_of_draws*100
-        message(max_treedepth_hit, "" of "", num_of_draws, "" ("", (format(round(percentage_max_treedepth, 0), nsmall = 1)), ""%)"",
-                "" transitions hit the maximum treedepth limit of "", max_treedepth,
-                "" or 2^"", max_treedepth, ""-1 leapfrog steps.\n"",
-                ""Trajectories that are prematurely terminated due to this limit will result in slow exploration.\n"",
-                ""Increasing the max_depth limit can avoid this at the expense of more computation.\n"",
-                ""If increasing max_depth does not remove warnings, try to reparameterize the model.\n"")
-      }
+    max_treedepth <- data_csv$sampling_info$max_depth
+    max_treedepth_hit <- sum(treedepth >= max_treedepth)
+    if (max_treedepth_hit > 0) {
+      percentage_max_treedepth <- (max_treedepth_hit)/num_of_draws*100
+      message(max_treedepth_hit, "" of "", num_of_draws, "" ("", (format(round(percentage_max_treedepth, 0), nsmall = 1)), ""%)"",
+              "" transitions hit the maximum treedepth limit of "", max_treedepth,
+              "" or 2^"", max_treedepth, ""-1 leapfrog steps.\n"",
+              ""Trajectories that are prematurely terminated due to this limit will result in slow exploration.\n"",
+              ""Increasing the max_depth limit can avoid this at the expense of more computation.\n"",
+              ""If increasing max_depth does not remove warnings, try to reparameterize the model.\n"")
     }
   }
 }

---FILE: tests/testthat/test-utils.R---
@@ -35,7 +35,7 @@ test_that(""check_sampler_transitions_treedepth() works"", {
   csv_files <- c(test_path(""resources"", ""csv"", ""model1-2-no-warmup.csv""),
                  test_path(""resources"", ""csv"", ""model1-2-no-warmup.csv""))
   csv_output <- read_sample_csv(csv_files)
-  output <- ""32 of 100 \\(16.0%\\) transitions hit the maximum treedepth limit of 5 or 2\\^5-1 leapfrog steps.""
+  output <- ""32 of 200 \\(16.0%\\) transitions hit the maximum treedepth limit of 5 or 2\\^5-1 leapfrog steps.""
   expect_message(check_sampler_transitions_treedepth(csv_output), output)
 
   csv_files <- c(test_path(""resources"", ""csv"", ""model1-2-warmup.csv""))",True,False,Implementation / Logic,6
stan-dev,cmdstanr,7aeb9d7822b80dd308e87a9c8a336d0ee94edb58,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-02-28T11:51:35Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-02-28T11:51:35Z,cleanup and fixing tests,R/read_csv.R;tests/testthat/test-csv.R,False,True,True,False,10,12,22,"---FILE: R/read_csv.R---
@@ -116,12 +116,6 @@ read_sample_info_csv <- function(csv_file) {
   } else if(csv_file_info$method != ""sample"") {
     stop(""Supplied CSV file was not generated with sampling. Consider using read_optim_csv or read_vb_csv!"")
   }
-  if(csv_file_info$save_warmup == 1) {
-    csv_file_info$num_iter <- csv_file_info$num_warmup + csv_file_info$num_samples
-  } else {
-    csv_file_info$num_iter <- csv_file_info$num_samples
-  }
-  csv_file_info$num_iter <- csv_file_info$num_iter / csv_file_info$thin
   if(csv_file_info$inverse_metric_rows > 0) {
     rows <- csv_file_info$inverse_metric_rows
     cols <- length(csv_file_info$inverse_metric)/csv_file_info$inverse_metric_rows
@@ -186,30 +180,34 @@ read_sample_csv <- function(output_files) {
     # read sampling data
     draws <- utils::read.csv(output_file, header = TRUE, comment.char = ""#"")
     if(nrow(draws) > 0) {
+      num_warmup_draws <- ceiling(sampling_info$num_warmup/sampling_info$thin)
+      num_post_warmup_draws <- ceiling(sampling_info$num_warmup/sampling_info$thin)
+      all_draws <- num_warmup_draws + num_post_warmup_draws
       if(sampling_info$save_warmup == 1) {
-        new_warmup_draws <- posterior::as_draws_array(draws[1:sampling_info$num_warmup/sampling_info$thin, sampling_info$model_params])
+
+        new_warmup_draws <- posterior::as_draws_array(draws[1:num_warmup_draws, sampling_info$model_params])
         if(is.null(warmup_draws)) {
           warmup_draws <- new_warmup_draws
         } else {
           warmup_draws <- posterior::bind_draws(warmup_draws,
                                                 new_warmup_draws,
                                                 along=""chain"")
         }
-        new_warmup_sampler_diagnostics_draws <- posterior::as_draws_array(draws[1:sampling_info$num_warmup/sampling_info$thin, sampling_info$sampler_diagnostics])
+        new_warmup_sampler_diagnostics_draws <- posterior::as_draws_array(draws[1:num_warmup_draws, sampling_info$sampler_diagnostics])
         if(is.null(warmup_sampler_diagnostics_draws)) {
           warmup_sampler_diagnostics_draws <- new_warmup_sampler_diagnostics_draws
         } else {
           warmup_sampler_diagnostics_draws <- posterior::bind_draws(warmup_sampler_diagnostics_draws,
                                                                     new_warmup_sampler_diagnostics_draws,
                                                                     along=""chain"")
         }
-        new_post_warmup_draws <- posterior::as_draws_array(draws[(sampling_info$num_warmup/sampling_info$thin+1):sampling_info$num_iter, sampling_info$model_params])
+        new_post_warmup_draws <- posterior::as_draws_array(draws[(num_warmup_draws+1):all_draws, sampling_info$model_params])
         if(is.null(post_warmup_draws)) {
           post_warmup_draws <- new_post_warmup_draws
         } else {
           post_warmup_draws <- posterior::bind_draws(post_warmup_draws, new_post_warmup_draws, along=""chain"")
         }
-        new_post_warmup_sampler_diagnostics_draws <- posterior::as_draws_array(draws[(sampling_info$num_warmup/sampling_info$thin+1):sampling_info$num_iter, sampling_info$sampler_diagnostics])
+        new_post_warmup_sampler_diagnostics_draws <- posterior::as_draws_array(draws[(num_warmup_draws+1):all_draws, sampling_info$sampler_diagnostics])
         if(is.null(post_warmup_sampler_diagnostics_draws)) {
           post_warmup_sampler_diagnostics_draws <- new_post_warmup_sampler_diagnostics_draws
         } else {

---FILE: tests/testthat/test-csv.R---
@@ -263,9 +263,9 @@ test_that(""read_sample_csv() works with no samples"", {
   skip_on_cran()
 
   csv_output_diag_e_0 <- read_sample_csv(fit_bernoulli_diag_e_no_samples$output_files())
-  expect_equal(dim(csv_output_diag_e_0$post_warmup_draws), c(0,2,2))
+  expect_equal(csv_output_diag_e_0$post_warmup_draws, NULL)
   csv_output_dense_e_0 <- read_sample_csv(fit_bernoulli_dense_e_no_samples$output_files())
-  expect_equal(dim(csv_output_dense_e_0$post_warmup_draws), c(0,2,2))
+  expect_equal(csv_output_dense_e_0$post_warmup_draws, NULL)
 })
 
 test_that(""read_sample_csv() reads values up to adaptation"", {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,41de92a1623646e3901754744f7055c7d381ad04,jgabry,jgabry@gmail.com,2020-02-27T18:43:49Z,jgabry,jgabry@gmail.com,2020-02-27T18:43:49Z,"fix use of posterior::summarise_draws

closes #111",R/fit.R;tests/testthat/test-fit-mcmc.R;tests/testthat/test-fit-mle.R;tests/testthat/test-fit-vb.R,False,True,True,False,32,28,60,"---FILE: R/fit.R---
@@ -37,18 +37,19 @@ CmdStanFit <- R6::R6Class(
 
     summary = function(...) {
       if (self$runset$method() == ""sample"") {
-        if (!length(self$output_files())) {
-          stop(""No chains finished successfully. Unable to retrieve the fit."",
-              call. = FALSE)
-        }
         summary <- posterior::summarise_draws(self$draws(), ...)
-      } else { # don't include MCMC diagnostics for non MCMC
-        args <- list(...)
-        args$x <- self$draws()
-        if (!""measures"" %in% names(args)) {
-          args$measures <- posterior::default_summary_measures()
+      } else {
+        if (!length(list(...))) {
+          # if user didn't supply any args use default summary measures,
+          # which don't include MCMC-specific things
+          summary <- posterior::summarise_draws(
+            self$draws(),
+            posterior::default_summary_measures()
+          )
+        } else {
+          # otherwise use whatever the user specified via ...
+          summary <- posterior::summarise_draws(self$draws(), ...)
         }
-        summary <- do.call(posterior::summarise_draws, args)
       }
       if (self$runset$method() == ""optimize"") {
         summary <- summary[, c(""variable"", ""mean"")]

---FILE: tests/testthat/test-fit-mcmc.R---
@@ -25,6 +25,9 @@ test_that(""summary() method works after mcmc"", {
   x <- fit_mcmc$summary()
   expect_s3_class(x, ""draws_summary"")
   expect_equal(x$variable, c(""lp__"", PARAM_NAMES))
+
+  x <- fit_mcmc$summary(c(""rhat"", ""sd""))
+  expect_equal(colnames(x), c(""variable"", ""rhat"", ""sd""))
 })
 
 test_that(""output() method works after mcmc"", {

---FILE: tests/testthat/test-fit-mle.R---
@@ -12,11 +12,11 @@ test_that(""reading in csv optimization output works"", {
   expect_named(fit_mle$lp(), ""lp__"")
 })
 
-# test_that(""summary method doesn't error for optimization"", {
-#   skip_on_cran()
-#   # summary method for optimization isn't fully designed yet
-#   x <- fit_mle$summary()
-#   expect_s3_class(x, ""draws_summary"")
-#   expect_equal(colnames(x), c(""variable"", ""estimate""))
-#   expect_equal(x$variable, PARAM_NAMES)
-# })
+test_that(""summary method doesn't error for optimization"", {
+  skip_on_cran()
+  # summary method for optimization isn't fully designed yet
+  x <- fit_mle$summary()
+  expect_s3_class(x, ""draws_summary"")
+  expect_equal(colnames(x), c(""variable"", ""estimate""))
+  expect_equal(x$variable, PARAM_NAMES)
+})

---FILE: tests/testthat/test-fit-vb.R---
@@ -6,17 +6,17 @@ if (not_on_cran()) {
   PARAM_NAMES <- c(""alpha"", ""beta[1]"", ""beta[2]"", ""beta[3]"")
 }
 
-# test_that(""summary() method works after vb"", {
-#   skip_on_cran()
-#   x <- fit_vb$summary()
-#   expect_s3_class(x, ""draws_summary"")
-#   expect_equal(x$variable, PARAM_NAMES)
+test_that(""summary() method works after vb"", {
+  skip_on_cran()
+  x <- fit_vb$summary()
+  expect_s3_class(x, ""draws_summary"")
+  expect_equal(x$variable, PARAM_NAMES)
 
-#   x <- fit_vb$summary(measures = c(""mean"", ""sd""))
-#   expect_s3_class(x, ""draws_summary"")
-#   expect_equal(x$variable, PARAM_NAMES)
-#   expect_equal(colnames(x), c(""variable"", ""mean"", ""sd""))
-# })
+  x <- fit_vb$summary(c(""mean"", ""sd""))
+  expect_s3_class(x, ""draws_summary"")
+  expect_equal(x$variable, PARAM_NAMES)
+  expect_equal(colnames(x), c(""variable"", ""mean"", ""sd""))
+})
 
 test_that(""draws() method returns posterior sample (reading csv works)"", {
   skip_on_cran()",True,False,Implementation / Logic,6
stan-dev,cmdstanr,fa506fc317402ffb448614fd3c3a7bf93fe42584,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-02-27T11:09:28Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-02-27T11:09:28Z,fix cmdstan_version due to the new added CMDSTAN_VERSION_DOC that was added on develop,R/path.R,False,True,True,False,1,1,2,"---FILE: R/path.R---
@@ -150,6 +150,6 @@ read_cmdstan_version <- function(path) {
     return(NULL)
   }
   makefile <- readLines(makefile_path)
-  version_line <- grep(""^CMDSTAN_VERSION"", makefile, value = TRUE)
+  version_line <- grep(""^CMDSTAN_VERSION :="", makefile, value = TRUE)
   sub(""CMDSTAN_VERSION := "", """", version_line)
 }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,d7ea60442a8287cb8f082f60a4e65176c005997d,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-02-27T07:36:33Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-02-27T07:36:33Z,"remove error check, add error on inc_warmup = TRUE and save_warmup = FALSE",R/fit.R;tests/testthat/test-fit-mcmc.R,False,True,True,False,22,19,41,"---FILE: R/fit.R---
@@ -18,10 +18,6 @@ CmdStanFit <- R6::R6Class(
     },
 
     draws = function() {
-      if (!length(self$output_files())) {
-        stop(""No chains finished successfully. Unable to retrieve the fit."",
-             call. = FALSE)
-      }
       if (is.null(private$draws_)) {
         private$read_csv_()
       }
@@ -276,29 +272,27 @@ CmdStanMCMC <- R6::R6Class(
     },
 
     draws = function(inc_warmup = FALSE) {
-      if (!length(self$output_files())) {
-        stop(""No chains finished successfully. Unable to retrieve the fit."",
-             call. = FALSE)
-      }
       if (is.null(private$draws_)) {
         private$read_csv_()
       }
-      if(inc_warmup && private$sampling_info_$save_warmup) {
+      if(inc_warmup) {
+        if(!private$sampling_info_$save_warmup) {
+          stop(""Warmup draws were requested from a fit object without them! Please restart the sampling with save_warmup = TRUE."")
+        }
         posterior::bind_draws(private$warmup_draws_, private$draws_, along=""iteration"")
       } else {
         private$draws_
       }
     },
 
     sampler_diagnostics = function(inc_warmup = FALSE) {
-      if (!length(self$output_files())) {
-        stop(""No chains finished successfully. Unable to retrieve the fit."",
-             call. = FALSE)
-      }
       if (is.null(private$draws_)) {
         private$read_csv_()
       }
-      if(inc_warmup && private$sampling_info_$save_warmup) {
+      if(inc_warmup) {
+        if(!private$sampling_info_$save_warmup) {
+          stop(""Warmup sampler diagnostics were requested from a fit object without them! Please restart the sampling with save_warmup = TRUE."")
+        }
         posterior::bind_draws(private$warmup_sampler_diagnostics_, private$sampler_diagnostics_, along=""iteration"")
       } else {
         private$sampler_diagnostics_

---FILE: tests/testthat/test-fit-mcmc.R---
@@ -75,11 +75,20 @@ test_that(""time() method works after mcmc"", {
 test_that(""inc_warmup in draws() works"", {
   skip_on_cran()
   x0 <- fit_mcmc_0$draws(inc_warmup = FALSE)
-  x1 <- fit_mcmc_0$draws(inc_warmup = TRUE)
-  x2 <- fit_mcmc_1$draws(inc_warmup = FALSE)
-  x3 <- fit_mcmc_1$draws(inc_warmup = TRUE)
+  x1 <- fit_mcmc_1$draws(inc_warmup = FALSE)
+  x2 <- fit_mcmc_1$draws(inc_warmup = TRUE)
   expect_equal(dim(x0), c(1000, 2, 5))
+  expect_error(fit_mcmc_0$draws(inc_warmup = TRUE),
+               ""Warmup draws were requested from a fit object without them! Please restart the sampling with save_warmup = TRUE."")
   expect_equal(dim(x1), c(1000, 2, 5))
-  expect_equal(dim(x2), c(1000, 2, 5))
-  expect_equal(dim(x3), c(2000, 2, 5))
+  expect_equal(dim(x2), c(2000, 2, 5))
+  y0 <- fit_mcmc_0$sampler_diagnostics(inc_warmup = FALSE)
+  y1 <- fit_mcmc_1$sampler_diagnostics(inc_warmup = FALSE)
+  y2 <- fit_mcmc_1$sampler_diagnostics(inc_warmup = TRUE)
+  expect_equal(dim(y0), c(1000, 2, 6))
+  expect_error(fit_mcmc_0$sampler_diagnostics(inc_warmup = TRUE),
+               ""Warmup sampler diagnostics were requested from a fit object without them! Please restart the sampling with save_warmup = TRUE."")
+  expect_equal(dim(y1), c(1000, 2, 6))
+  expect_equal(dim(y2), c(2000, 2, 6))
+
 })",True,False,Implementation / Logic,6
stan-dev,cmdstanr,01e1cefe54429d317bcfe769106ae7e9df1f4644,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-02-25T21:14:04Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-02-25T21:14:04Z,fix draws() and summary() on chain fail,R/fit.R,False,True,True,False,8,0,8,"---FILE: R/fit.R---
@@ -18,6 +18,10 @@ CmdStanFit <- R6::R6Class(
     },
 
     draws = function() {
+      if (!length(self$output_files())) {
+        stop(""No chains finished successfully. Unable to retrieve the fit."",
+             call. = FALSE)
+      }
       if (is.null(private$draws_)) {
         private$read_csv_()
       }
@@ -33,6 +37,10 @@ CmdStanFit <- R6::R6Class(
 
     summary = function(...) {
       if (self$runset$method() == ""sample"") {
+        if (!length(self$output_files())) {
+          stop(""No chains finished successfully. Unable to retrieve the fit."",
+              call. = FALSE)
+        }
         summary <- posterior::summarise_draws(self$draws(), ...)
       } else { # don't include MCMC diagnostics for non MCMC
         args <- list(...)",True,False,Implementation / Logic,6
stan-dev,cmdstanr,6a4d9b5986933e84f8de98db0b2543ac16d2f57a,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-02-25T20:59:44Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-02-25T20:59:44Z,fix behavior when all chains fail,R/fit.R,False,True,True,False,4,2,6,"---FILE: R/fit.R---
@@ -250,7 +250,8 @@ CmdStanMCMC <- R6::R6Class(
       private$draws_ <- data_csv$post_warmup_draws
       private$sampler_diagnostics_ <- data_csv$post_warmup_sampler_diagnostics
       private$sampling_info_ <- data_csv$sampling_info
-      if(data_csv$sampling_info$save_warmup) {
+      if(!is.null(data_csv$sampling_info$save_warmup) 
+         && data_csv$sampling_info$save_warmup) {
         private$warmup_draws_ <- data_csv$warmup_draws
         private$warmup_sampler_diagnostics_ <- data_csv$warmup_sampler_diagnostics
       }
@@ -279,7 +280,8 @@ CmdStanMCMC <- R6::R6Class(
       private$draws_ <- data_csv$post_warmup_draws
       private$sampler_diagnostics_ <- data_csv$post_warmup_sampler_diagnostics
       private$sampling_info_ <- data_csv$sampling_info
-      if(data_csv$sampling_info$save_warmup) {
+      if(!is.null(data_csv$sampling_info$save_warmup) 
+         && data_csv$sampling_info$save_warmup) {
         private$warmup_draws_ <- data_csv$warmup_draws
         private$warmup_sampler_diagnostics_ <- data_csv$warmup_sampler_diagnostics
       }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,4027088134a3a71035c95fdd7fae573f5a6ed803,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-02-24T19:11:50Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-02-24T19:11:50Z,more fixes,R/fit.R;R/read_csv.R;R/utils.R;tests/testthat/test-csv.R,False,True,True,False,54,44,98,"---FILE: R/fit.R---
@@ -247,6 +247,11 @@ CmdStanMCMC <- R6::R6Class(
       data_csv <- read_sample_csv(self$output_files())
       check_divergences(data_csv)
       check_sampler_transitions_treedepth(data_csv)
+      private$draws_ <- data_csv$post_warmup_draws
+      private$warmup_draws_ <- data_csv$warmup_draws
+      private$sampling_info_ <- data_csv$sampling_info
+      private$sampler_diagnostics_ <- data_csv$sampling_info
+      private$warmup_sampler_diagnostics_ <- data_csv$sampling_info
     },
     num_chains = function() {
       super$num_runs()
@@ -260,16 +265,20 @@ CmdStanMCMC <- R6::R6Class(
     }
   ),
   private = list(
-    sampler_params_ = NULL,
+    sampler_diagnostics_ = NULL,
+    warmup_sampler_diagnostics_ = NULL,
     warmup_draws_ = NULL,
     read_csv_ = function() {
       if (!length(self$output_files())) {
         stop(""No chains finished successfully. Unable to retrieve the fit."",
              call. = FALSE)
       }
       data_csv <- read_sample_csv(self$output_files())
-      private$draws_ <- data_csv$post_warmup
+      private$draws_ <- data_csv$post_warmup_draws
+      private$warmup_draws_ <- data_csv$warmup_draws
       private$sampling_info_ <- data_csv$sampling_info
+      private$sampler_diagnostics_ <- data_csv$sampling_info
+      private$warmup_sampler_diagnostics_ <- data_csv$sampling_info
       invisible(self)
     }
   )

---FILE: R/read_csv.R---
@@ -10,7 +10,7 @@ check_sampling_csv_info_matches <- function(a, b) {
   if (a$model_name != b$model_name) {
     return(""Supplied CSV files were not generated wtih the same model!"")
   }
-  if ((length(a$model_params)!= length(b$model_params)) || !(all(a$model_params == b$model_params) && all(a$sampler_params == b$sampler_params))) {
+  if ((length(a$model_params)!= length(b$model_params)) || !(all(a$model_params == b$model_params) && all(a$sampler_diagnostics == b$sampler_diagnostics))) {
     return(""Supplied CSV files have samples for different parameters!"")
   }
   dont_match_list <- c(""id"", ""inverse_metric"", ""step_size"")
@@ -46,11 +46,11 @@ read_sample_info_csv <- function(csv_file) {
       if(!param_names_read) {
         param_names_read <- TRUE
         all_names <- strsplit(line, "","")[[1]]
-        csv_file_info[[""sampler_params""]] <- c()
+        csv_file_info[[""sampler_diagnostics""]] <- c()
         csv_file_info[[""model_params""]] <- c()
         for(x in all_names) {
           if(endsWith(x, ""__"") && x != ""lp__""){
-            csv_file_info[[""sampler_params""]] <- c(csv_file_info[[""sampler_params""]], x)
+            csv_file_info[[""sampler_diagnostics""]] <- c(csv_file_info[[""sampler_diagnostics""]], x)
           } else {
             csv_file_info[[""model_params""]] <- c(csv_file_info[[""model_params""]], x)
           }
@@ -142,7 +142,7 @@ read_sample_info_csv <- function(csv_file) {
     term_buffer = csv_file_info$term_buffer,
     window = csv_file_info$window,
     model_params = csv_file_info$model_params,
-    sampler_params = csv_file_info$sampler_params,
+    sampler_diagnostics = csv_file_info$sampler_diagnostics,
     inverse_metric = csv_file_info$inverse_metric,
     step_size = csv_file_info$step_size
   )
@@ -162,17 +162,18 @@ read_sample_info_csv <- function(csv_file) {
 read_sample_csv <- function(output_files) {
   sampling_info <- NULL
   warmup_draws_array <- list()
-  warmup_sampling_params_draws <- list()
+  warmup_sampler_diagnostics_draws <- list()
   post_warmup_draws_array <- list()
-  post_warmup_sampling_params_draws <- list()
+  post_warmup_sampler_diagnostics_draws <- list()
   inverse_metric = list()
+  step_size = list()
   for(output_file in output_files) {
     checkmate::assert_file_exists(output_file, access = ""r"", extension = ""csv"")
     # read meta data
     if (is.null(sampling_info)) {
       sampling_info <- read_sample_info_csv(output_file)
-      inverse_metric <- list()
       inverse_metric[[sampling_info$id]] <- sampling_info$inverse_metric
+      step_size[[sampling_info$id]] <- sampling_info$step_size
       id <- sampling_info$id
     } else {
       csv_file_info <- read_sample_info_csv(output_file)
@@ -185,22 +186,23 @@ read_sample_csv <- function(output_files) {
       sampling_info$id <- c(sampling_info$id,
                             csv_file_info$id)
       inverse_metric[[csv_file_info$id]] <- csv_file_info$inverse_metric
+      step_size[[csv_file_info$id]] <- csv_file_info$step_size
       id <- csv_file_info$id
     }
     # read sampling data
     draws <- utils::read.csv(output_file, header = TRUE, comment.char = ""#"")
 
     if(sampling_info$save_warmup == 1) {
       warmup_draws_array[[id]] <- draws[1:sampling_info$num_warmup/sampling_info$thin, sampling_info$model_params]
-      warmup_sampling_params_draws[[id]] <- draws[1:sampling_info$num_warmup/sampling_info$thin, sampling_info$sampler_params]
+      warmup_sampler_diagnostics_draws[[id]] <- draws[1:sampling_info$num_warmup/sampling_info$thin, sampling_info$sampler_diagnostics]
       post_warmup_draws_array[[id]] <- draws[(sampling_info$num_warmup/sampling_info$thin+1):sampling_info$num_iter, sampling_info$model_params]
-      post_warmup_sampling_params_draws[[id]] <- draws[(sampling_info$num_warmup/sampling_info$thin+1):sampling_info$num_iter, sampling_info$sampler_params]
+      post_warmup_sampler_diagnostics_draws[[id]] <- draws[(sampling_info$num_warmup/sampling_info$thin+1):sampling_info$num_iter, sampling_info$sampler_diagnostics]
 
     } else {
       warmup_draws_array <- NULL
-      warmup_sampling_params_draws <- NULL
+      warmup_sampler_diagnostics_draws <- NULL
       post_warmup_draws_array[[id]] <- draws[, sampling_info$model_params]
-      post_warmup_sampling_params_draws[[id]] <- draws[, sampling_info$sampler_params]
+      post_warmup_sampler_diagnostics_draws[[id]] <- draws[, sampling_info$sampler_diagnostics]
     }
   }
   sampling_info$model_params <- repair_variable_names(sampling_info$model_params)
@@ -212,33 +214,32 @@ read_sample_csv <- function(output_files) {
                                                           dim = c(sampling_info$num_warmup/sampling_info$thin, num_chains, length(sampling_info$model_params)),
                                                           dimnames = list(NULL, NULL, sampling_info$model_params)))
     }
-    if(!is.null(warmup_sampling_params_draws) && (length(warmup_sampling_params_draws) > 0)) {
-          warmup_sampling_params_draws <- posterior::as_draws_array(array(unlist(do.call(rbind, warmup_sampling_params_draws)),
-                                                             dim = c(sampling_info$num_warmup/sampling_info$thin, num_chains, length(sampling_info$sampler_params)),
-                                                             dimnames = list(NULL, NULL, sampling_info$sampler_params)))
+    if(!is.null(warmup_sampler_diagnostics_draws) && (length(warmup_sampler_diagnostics_draws) > 0)) {
+          warmup_sampler_diagnostics_draws <- posterior::as_draws_array(array(unlist(do.call(rbind, warmup_sampler_diagnostics_draws)),
+                                                             dim = c(sampling_info$num_warmup/sampling_info$thin, num_chains, length(sampling_info$sampler_diagnostics)),
+                                                             dimnames = list(NULL, NULL, sampling_info$sampler_diagnostics)))
     }
   }
   if(!is.null(post_warmup_draws_array) && (length(post_warmup_draws_array) > 0)) {
     post_warmup_draws_array <- posterior::as_draws_array(array(unlist(do.call(rbind, post_warmup_draws_array)),
                                                              dim = c(sampling_info$num_samples/sampling_info$thin, num_chains, length(sampling_info$model_params)),
                                                              dimnames = list(NULL, NULL, sampling_info$model_params)))
   }
-  if(!is.null(post_warmup_sampling_params_draws) && (length(post_warmup_sampling_params_draws) > 0)) {
-    post_warmup_sampling_params_draws <- posterior::as_draws_array(array(unlist(do.call(rbind, post_warmup_sampling_params_draws)),
-                                                             dim = c(sampling_info$num_samples/sampling_info$thin, num_chains, length(sampling_info$sampler_params)),
-                                                             dimnames = list(NULL, NULL, sampling_info$sampler_params)))
+  if(!is.null(post_warmup_sampler_diagnostics_draws) && (length(post_warmup_sampler_diagnostics_draws) > 0)) {
+    post_warmup_sampler_diagnostics_draws <- posterior::as_draws_array(array(unlist(do.call(rbind, post_warmup_sampler_diagnostics_draws)),
+                                                             dim = c(sampling_info$num_samples/sampling_info$thin, num_chains, length(sampling_info$sampler_diagnostics)),
+                                                             dimnames = list(NULL, NULL, sampling_info$sampler_diagnostics)))
   }
   sampling_info$inverse_metric <- NULL
-  step_size_temp <- sampling_info$step_size
-  sampling_info$step_size <- NULL
+  sampling_info$step_size <- NULL  
   list(
     sampling_info = sampling_info,
     inverse_metric = inverse_metric,
-    step_size = step_size_temp,
-    warmup = warmup_draws_array,
-    post_warmup = post_warmup_draws_array,
-    warmup_sampler = warmup_sampling_params_draws,
-    post_warmup_sampler = post_warmup_sampling_params_draws
+    step_size = step_size,
+    warmup_draws = warmup_draws_array,
+    post_warmup_draws = post_warmup_draws_array,
+    warmup_sampler_diagnostics = warmup_sampler_diagnostics_draws,
+    post_warmup_sampler_diagnostics = post_warmup_sampler_diagnostics_draws
   )
 }
 

---FILE: R/utils.R---
@@ -405,7 +405,7 @@ set_num_threads <- function(num_threads) {
 
 check_divergences <- function(data_csv) {
   if(!is.null(data_csv$sampling_info$num_samples) && data_csv$sampling_info$num_samples > 0) {
-    divergences <- posterior::extract_one_variable_matrix(data_csv$post_warmup_sampler, ""divergent__"")
+    divergences <- posterior::extract_one_variable_matrix(data_csv$warmup_sampler_diagnostics, ""divergent__"")
     num_of_divergences <- sum(divergences)
     if (num_of_divergences > 0) {
       num_iter <- data_csv$sampling_info$num_samples/data_csv$sampling_info$thin
@@ -422,7 +422,7 @@ check_divergences <- function(data_csv) {
 check_sampler_transitions_treedepth <- function(data_csv) {
   if(!is.null(data_csv$sampling_info$num_samples) && data_csv$sampling_info$num_samples > 0) {
     max_treedepth <- data_csv$sampling_info$max_depth
-    treedepth <- posterior::extract_one_variable_matrix(data_csv$post_warmup_sampler, ""treedepth__"")
+    treedepth <- posterior::extract_one_variable_matrix(data_csv$warmup_sampler_diagnostics, ""treedepth__"")
     max_treedepth_hit <- sum(treedepth >= max_treedepth)
     if (max_treedepth_hit > 0) {
       num_iter <- data_csv$sampling_info$num_samples/data_csv$sampling_info$thin

---FILE: tests/testthat/test-csv.R---
@@ -198,37 +198,37 @@ test_that(""read_sample_csv() matches rstan::read_stan_csv() for csv file"", {
   skip_on_cran()
   csv_files <- c(test_path(""resources"", ""csv"", ""model1-2-warmup.csv""))
 
-  sampler_params <- readRDS(test_path(""answers"", ""rstan-read-stan-csv-sampler-params.rds""))
-  sampler_params <- posterior::as_draws_array(sampler_params[[1]])
+  sampler_diagnostics <- readRDS(test_path(""answers"", ""rstan-read-stan-csv-sampler-params.rds""))
+  sampler_diagnostics <- posterior::as_draws_array(sampler_diagnostics[[1]])
   csv_output <- read_sample_csv(csv_files)
   num_warmup <- csv_output$sampling_info$num_warmup/csv_output$sampling_info$thin
   num_iter <- csv_output$sampling_info$num_iter
   # match warmup sampler info
   expect_equal(posterior::extract_one_variable_matrix(csv_output$warmup_sampler, ""divergent__""),
-               posterior::extract_one_variable_matrix(sampler_params[1:num_warmup,,], ""divergent__""))
+               posterior::extract_one_variable_matrix(sampler_diagnostics[1:num_warmup,,], ""divergent__""))
   expect_equal(posterior::extract_one_variable_matrix(csv_output$warmup_sampler, ""accept_stat__""),
-               posterior::extract_one_variable_matrix(sampler_params[1:num_warmup,,], ""accept_stat__""))
+               posterior::extract_one_variable_matrix(sampler_diagnostics[1:num_warmup,,], ""accept_stat__""))
   expect_equal(posterior::extract_one_variable_matrix(csv_output$warmup_sampler, ""treedepth__""),
-               posterior::extract_one_variable_matrix(sampler_params[1:num_warmup,,], ""treedepth__""))
+               posterior::extract_one_variable_matrix(sampler_diagnostics[1:num_warmup,,], ""treedepth__""))
   expect_equal(posterior::extract_one_variable_matrix(csv_output$warmup_sampler, ""stepsize__""),
-               posterior::extract_one_variable_matrix(sampler_params[1:num_warmup,,], ""stepsize__""))
+               posterior::extract_one_variable_matrix(sampler_diagnostics[1:num_warmup,,], ""stepsize__""))
   expect_equal(posterior::extract_one_variable_matrix(csv_output$warmup_sampler, ""n_leapfrog__""),
-               posterior::extract_one_variable_matrix(sampler_params[1:num_warmup,,], ""n_leapfrog__""))
+               posterior::extract_one_variable_matrix(sampler_diagnostics[1:num_warmup,,], ""n_leapfrog__""))
   expect_equal(posterior::extract_one_variable_matrix(csv_output$warmup_sampler, ""energy__""),
-               posterior::extract_one_variable_matrix(sampler_params[1:num_warmup,,], ""energy__""))
+               posterior::extract_one_variable_matrix(sampler_diagnostics[1:num_warmup,,], ""energy__""))
   # match post-warmup sampling info
   expect_equal(posterior::extract_one_variable_matrix(csv_output$post_warmup_sampler, ""divergent__""),
-               posterior::extract_one_variable_matrix(sampler_params[(num_warmup+1):num_iter,,], ""divergent__""))
+               posterior::extract_one_variable_matrix(sampler_diagnostics[(num_warmup+1):num_iter,,], ""divergent__""))
   expect_equal(posterior::extract_one_variable_matrix(csv_output$post_warmup_sampler, ""accept_stat__""),
-               posterior::extract_one_variable_matrix(sampler_params[(num_warmup+1):num_iter,,], ""accept_stat__""))
+               posterior::extract_one_variable_matrix(sampler_diagnostics[(num_warmup+1):num_iter,,], ""accept_stat__""))
   expect_equal(posterior::extract_one_variable_matrix(csv_output$post_warmup_sampler, ""treedepth__""),
-               posterior::extract_one_variable_matrix(sampler_params[(num_warmup+1):num_iter,,], ""treedepth__""))
+               posterior::extract_one_variable_matrix(sampler_diagnostics[(num_warmup+1):num_iter,,], ""treedepth__""))
   expect_equal(posterior::extract_one_variable_matrix(csv_output$post_warmup_sampler, ""stepsize__""),
-               posterior::extract_one_variable_matrix(sampler_params[(num_warmup+1):num_iter,,], ""stepsize__""))
+               posterior::extract_one_variable_matrix(sampler_diagnostics[(num_warmup+1):num_iter,,], ""stepsize__""))
   expect_equal(posterior::extract_one_variable_matrix(csv_output$post_warmup_sampler, ""n_leapfrog__""),
-               posterior::extract_one_variable_matrix(sampler_params[(num_warmup+1):num_iter,,], ""n_leapfrog__""))
+               posterior::extract_one_variable_matrix(sampler_diagnostics[(num_warmup+1):num_iter,,], ""n_leapfrog__""))
   expect_equal(posterior::extract_one_variable_matrix(csv_output$post_warmup_sampler, ""energy__""),
-               posterior::extract_one_variable_matrix(sampler_params[(num_warmup+1):num_iter,,], ""energy__""))
+               posterior::extract_one_variable_matrix(sampler_diagnostics[(num_warmup+1):num_iter,,], ""energy__""))
 })
 
 test_that(""read_sample_csv() works with thin"", {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,401437181d4f8aad7d5b200c30c0aacb0b4d9bf1,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-02-18T13:04:46Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-02-18T13:04:46Z,fix rmd,vignettes/cmdstanr.Rmd,True,False,True,False,1,1,2,"---FILE: vignettes/cmdstanr.Rmd---
@@ -175,7 +175,7 @@ fit$cmdstan_summary()
 The `$draws()` method of the `CmdStanMCMC` object can be used to extract
 the post-warmup posterior draws:
 
-```{r stanfit}
+```{r draws}
 draws <- fit$draws()
 str(draws)
 ```",False,True,Rendering / Conversion,3
stan-dev,cmdstanr,4e4df8fd1382a1df427649d44c114d9e43d8a7a0,jgabry,jgabry@gmail.com,2020-02-17T22:43:26Z,jgabry,jgabry@gmail.com,2020-02-17T22:43:26Z,"use try to avoid error reported in #97

Fix #97. Previous fix in #99 removed the error but introduced a bug where processes are not terminated.",R/run.R,False,True,True,False,3,1,4,"---FILE: R/run.R---
@@ -306,7 +306,9 @@ CmdStanProcs <- R6::R6Class(
       private$run_ids_
     },
     cleanup = function() {
-      lapply(private$processes_, function(p) p$kill_tree)
+      lapply(private$processes_, function(p) {
+        try(p$kill_tree(), silent = TRUE)
+      })
       invisible(self)
     },
     poll = function(ms) { # time in milliseconds",True,False,Implementation / Logic,3
stan-dev,cmdstanr,44e1d5c9eab49378276b8f819a80ba2c76b473a1,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-02-10T09:21:58Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2020-02-10T09:21:58Z,fix TMP_DIR typo,R/path.R,False,True,True,False,1,1,2,"---FILE: R/path.R---
@@ -74,7 +74,7 @@ cmdstan_version <- function() {
 .cmdstanr <- new.env(parent = emptyenv())
 .cmdstanr$PATH <- NULL
 .cmdstanr$VERSION <- NULL
-.cmdstanr$TMP_DIR <- NULL
+.cmdstanr$TEMP_DIR <- NULL
 
 # path to temp directory
 cmdstan_tempdir <- function() {",True,False,Implementation / Logic,6
stan-dev,cmdstanr,4845369cdf66cdfded08f38f669a75a40b1000e3,Rok enovar,rok.cesnovar@fri.uni-lj.si,2020-01-16T13:09:31Z,GitHub,noreply@github.com,2020-01-16T13:09:31Z,"Revert ""Switch back to using Rdata temporarily while issue with 0x0s gets resolved for JSON""",DESCRIPTION;R/model.R;tests/testthat/test-fit-shared.R,False,True,True,False,6,6,12,"---FILE: DESCRIPTION---
@@ -24,12 +24,12 @@ Imports:
     checkmate,
     posterior (>= 0.0.1),
     processx,
-    rstan,
     R6
 Suggests: 
     jsonlite (>= 1.2.0),
     knitr,
     rmarkdown,
+    rstan,
     testthat (>= 2.1.0)
 VignetteBuilder: knitr
 Remotes: 

---FILE: R/model.R---
@@ -664,8 +664,8 @@ process_data <- function(data) {
   } else if (is.character(data)) {
     path <- absolute_path(data)
   } else if (is.list(data) && !is.data.frame(data)) {
-    path <- tempfile(pattern = ""standata-"", fileext = "".dat"")
-    rstan::stan_rdump(names(data), file = path, env = list2env(data))
+    path <- tempfile(pattern = ""standata-"", fileext = "".json"")
+    write_stan_json(data = data, file = path)
   } else {
     stop(""'data' should be a path or a named list."", call. = FALSE)
   }

---FILE: tests/testthat/test-fit-shared.R---
@@ -96,16 +96,16 @@ test_that(""saving data file works"", {
   for (method in all_methods) {
     fit <- fits[[method]]
     old_path <- fit$data_file()
-    checkmate::expect_file_exists(old_path, extension = ""dat"")
+    checkmate::expect_file_exists(old_path, extension = ""json"")
 
     expect_message(
       path <- fit$save_data_file(tempdir(), basename = NULL,
                                  timestamp = FALSE, random = FALSE),
       ""Moved data file and set internal path""
     )
-    checkmate::expect_file_exists(path, extension = ""dat"")
+    checkmate::expect_file_exists(path, extension = ""json"")
     expect_true(file.size(path) > 0)
-    expect_equal(basename(path), ""logistic.dat"")
+    expect_equal(basename(path), ""logistic.json"")
 
     expect_false(file.exists(old_path))
     expect_equal(fit$data_file(), path)",True,False,Dependency / Package,6
stan-dev,cmdstanr,83d44b43256f131d4135481c458c013839654336,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-12-07T20:13:25Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-12-07T20:13:25Z,fix typo (#87),R/model.R;man/model-method-sample.Rd,False,True,True,False,2,2,4,"---FILE: R/model.R---
@@ -347,7 +347,7 @@ CmdStanModel$set(""public"", name = ""compile"", value = compile_method)
 #'   section of the CmdStan documentation for more details. To specify a
 #'   precomputed (inverse) metric, see the `inv_metric` argument below.
 #'   * `metric_file`: (character) A character vector containing paths to JSON or
-#'   Rdump file files (one per chain) compatible with CmdStan that contain
+#'   Rdump files (one per chain) compatible with CmdStan that contain
 #'   precomputed inverse metrics. The `metric_file` argument is inherited from
 #'   CmdStan but is confusing in that the entry in JSON or Rdump file(s) must be
 #'   named `inv_metric`, referring to the _inverse_ metric. We recommend instead

---FILE: man/model-method-sample.Rd---
@@ -138,7 +138,7 @@ specifying the geometry of the base manifold. See the \emph{Euclidean Metric}
 section of the CmdStan documentation for more details. To specify a
 precomputed (inverse) metric, see the \code{inv_metric} argument below.
 \item \code{metric_file}: (character) A character vector containing paths to JSON or
-Rdump file files (one per chain) compatible with CmdStan that contain
+Rdump files (one per chain) compatible with CmdStan that contain
 precomputed inverse metrics. The \code{metric_file} argument is inherited from
 CmdStan but is confusing in that the entry in JSON or Rdump file(s) must be
 named \code{inv_metric}, referring to the \emph{inverse} metric. We recommend instead",True,False,Documentation / Formatting,7
stan-dev,cmdstanr,7a09f8f45a275326bbec927306373d7d21a43023,Ben,bbbales2@gmail.com,2019-12-07T19:00:03Z,Ben,bbbales2@gmail.com,2019-12-07T19:00:03Z,"Added checks to make sure divergences/max treedepths warnings don't happen in warmup

Fixed typos in csv tests where it wasn't testing warmup but was supposed to (Issue #98)",tests/testthat/resources/csv/model1-2-warmup.csv;tests/testthat/test-csv.R;tests/testthat/test-utils.R,False,True,True,False,24,14,38,"---FILE: tests/testthat/resources/csv/model1-2-warmup.csv---
@@ -136,12 +136,12 @@ lp__,accept_stat__,stepsize__,treedepth__,n_leapfrog__,divergent__,energy__,mu,s
 -19.9159,0.73431,0.20032,3,7,0,20.1456,6.38048,8.61689
 -16.0273,0.868314,0.180442,3,7,0,20.9755,5.98202,5.12046
 -14.7018,0.99918,0.207965,2,3,0,16.3676,6.13762,3.95076
--15.1606,0.828703,0.303994,3,7,0,17.2007,5.55058,4.55167
+-15.1606,0.828703,0.303994,5,31,1,17.2007,5.55058,4.55167
 # Adaptation terminated
 # Step size = 0.672434
 # Diagonal elements of inverse mass matrix:
 # 0.909635, 0.066384
--13.1138,0.997617,0.672434,3,7,0,14.201,5.23122,2.76874
+-13.1138,0.997617,0.672434,5,31,1,14.201,5.23122,2.76874
 -13.7799,0.904983,0.672434,1,3,0,14.2557,5.8696,3.21667
 -14.273,0.92045,0.672434,2,7,0,14.976,6.09167,2.3105
 -15.918,0.935406,0.672434,3,7,0,17.0692,6.2332,4.94063

---FILE: tests/testthat/test-csv.R---
@@ -204,18 +204,18 @@ test_that(""read_sample_csv() matches rstan::read_stan_csv() for csv file"", {
   num_warmup <- csv_output$sampling_info$num_warmup/csv_output$sampling_info$thin
   num_iter <- csv_output$sampling_info$num_iter
   # match warmup sampler info
-  expect_equal(posterior::extract_one_variable_matrix(csv_output$post_warmup_sampler, ""divergent__""),
-               posterior::extract_one_variable_matrix(sampler_params[(num_warmup+1):num_iter,,], ""divergent__""))
-  expect_equal(posterior::extract_one_variable_matrix(csv_output$post_warmup_sampler, ""accept_stat__""),
-               posterior::extract_one_variable_matrix(sampler_params[(num_warmup+1):num_iter,,], ""accept_stat__""))
-  expect_equal(posterior::extract_one_variable_matrix(csv_output$post_warmup_sampler, ""treedepth__""),
-               posterior::extract_one_variable_matrix(sampler_params[(num_warmup+1):num_iter,,], ""treedepth__""))
-  expect_equal(posterior::extract_one_variable_matrix(csv_output$post_warmup_sampler, ""stepsize__""),
-               posterior::extract_one_variable_matrix(sampler_params[(num_warmup+1):num_iter,,], ""stepsize__""))
-  expect_equal(posterior::extract_one_variable_matrix(csv_output$post_warmup_sampler, ""n_leapfrog__""),
-               posterior::extract_one_variable_matrix(sampler_params[(num_warmup+1):num_iter,,], ""n_leapfrog__""))
-  expect_equal(posterior::extract_one_variable_matrix(csv_output$post_warmup_sampler, ""energy__""),
-               posterior::extract_one_variable_matrix(sampler_params[(num_warmup+1):num_iter,,], ""energy__""))
+  expect_equal(posterior::extract_one_variable_matrix(csv_output$warmup_sampler, ""divergent__""),
+               posterior::extract_one_variable_matrix(sampler_params[1:num_warmup,,], ""divergent__""))
+  expect_equal(posterior::extract_one_variable_matrix(csv_output$warmup_sampler, ""accept_stat__""),
+               posterior::extract_one_variable_matrix(sampler_params[1:num_warmup,,], ""accept_stat__""))
+  expect_equal(posterior::extract_one_variable_matrix(csv_output$warmup_sampler, ""treedepth__""),
+               posterior::extract_one_variable_matrix(sampler_params[1:num_warmup,,], ""treedepth__""))
+  expect_equal(posterior::extract_one_variable_matrix(csv_output$warmup_sampler, ""stepsize__""),
+               posterior::extract_one_variable_matrix(sampler_params[1:num_warmup,,], ""stepsize__""))
+  expect_equal(posterior::extract_one_variable_matrix(csv_output$warmup_sampler, ""n_leapfrog__""),
+               posterior::extract_one_variable_matrix(sampler_params[1:num_warmup,,], ""n_leapfrog__""))
+  expect_equal(posterior::extract_one_variable_matrix(csv_output$warmup_sampler, ""energy__""),
+               posterior::extract_one_variable_matrix(sampler_params[1:num_warmup,,], ""energy__""))
   # match post-warmup sampling info
   expect_equal(posterior::extract_one_variable_matrix(csv_output$post_warmup_sampler, ""divergent__""),
                posterior::extract_one_variable_matrix(sampler_params[(num_warmup+1):num_iter,,], ""divergent__""))

---FILE: tests/testthat/test-utils.R---
@@ -6,6 +6,11 @@ test_that(""check_divergences() works"", {
   csv_output <- read_sample_csv(csv_files)
   output <- ""14 of 100 \\(14%\\) transitions ended with a divergence.""
   expect_message(check_divergences(csv_output), output)
+
+  csv_files <- c(test_path(""resources"", ""csv"", ""model1-2-warmup.csv""))
+  csv_output <- read_sample_csv(csv_files)
+  output <- ""1 of 100 \\(1%\\) transitions ended with a divergence.""
+  expect_message(check_divergences(csv_output), output)
 })
 
 test_that(""check_sampler_transitions_treedepth() works"", {
@@ -14,4 +19,9 @@ test_that(""check_sampler_transitions_treedepth() works"", {
   csv_output <- read_sample_csv(csv_files)
   output <- ""16 of 100 \\(16%\\) transitions hit the maximum treedepth limit of 5 or 2\\^5-1 leapfrog steps.""
   expect_message(check_sampler_transitions_treedepth(csv_output), output)
+
+  csv_files <- c(test_path(""resources"", ""csv"", ""model1-2-warmup.csv""))
+  csv_output <- read_sample_csv(csv_files)
+  output <- ""1 of 100 \\(1%\\) transitions hit the maximum treedepth limit of 5 or 2\\^5-1 leapfrog steps.""
+  expect_message(check_sampler_transitions_treedepth(csv_output), output)
 })",True,False,Data / Input Handling,4
stan-dev,cmdstanr,3c4f3bd471622915d2d20241784076fecbcd4752,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-12-07T17:21:52Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-12-07T17:21:52Z,fix behavior on no succesfull chains,R/read_csv.R;R/utils.R,False,True,True,False,15,7,22,"---FILE: R/read_csv.R---
@@ -202,20 +202,28 @@ read_sample_csv <- function(output_files) {
   sampling_info$model_params <- repair_variable_names(sampling_info$model_params)
   num_chains <- length(sampling_info$id)
   if(!is.null(warmup_draws_array)) {
-    warmup_draws_array <- posterior::as_draws_array(array(unlist(do.call(rbind, warmup_draws_array)),
+    if(!is.null(warmup_draws_array) && (length(warmup_draws_array) > 0)) {
+      
+      warmup_draws_array <- posterior::as_draws_array(array(unlist(do.call(rbind, warmup_draws_array)),
                                                           dim = c(sampling_info$num_warmup/sampling_info$thin, num_chains, length(sampling_info$model_params)),
                                                           dimnames = list(NULL, NULL, sampling_info$model_params)))
-    warmup_sampling_params_draws <- posterior::as_draws_array(array(unlist(do.call(rbind, warmup_sampling_params_draws)),
+    }
+    if(!is.null(warmup_sampling_params_draws) && (length(warmup_sampling_params_draws) > 0)) {
+          warmup_sampling_params_draws <- posterior::as_draws_array(array(unlist(do.call(rbind, warmup_sampling_params_draws)),
                                                              dim = c(sampling_info$num_warmup/sampling_info$thin, num_chains, length(sampling_info$sampler_params)),
                                                              dimnames = list(NULL, NULL, sampling_info$sampler_params)))
+    }
   }
-
-  post_warmup_draws_array <- posterior::as_draws_array(array(unlist(do.call(rbind, post_warmup_draws_array)),
+  if(!is.null(post_warmup_draws_array) && (length(post_warmup_draws_array) > 0)) {
+    post_warmup_draws_array <- posterior::as_draws_array(array(unlist(do.call(rbind, post_warmup_draws_array)),
                                                              dim = c(sampling_info$num_samples/sampling_info$thin, num_chains, length(sampling_info$model_params)),
                                                              dimnames = list(NULL, NULL, sampling_info$model_params)))
-  post_warmup_sampling_params_draws <- posterior::as_draws_array(array(unlist(do.call(rbind, post_warmup_sampling_params_draws)),
+  }
+  if(!is.null(post_warmup_sampling_params_draws) && (length(post_warmup_sampling_params_draws) > 0)) {
+    post_warmup_sampling_params_draws <- posterior::as_draws_array(array(unlist(do.call(rbind, post_warmup_sampling_params_draws)),
                                                              dim = c(sampling_info$num_samples/sampling_info$thin, num_chains, length(sampling_info$sampler_params)),
                                                              dimnames = list(NULL, NULL, sampling_info$sampler_params)))
+  }  
   list(
     sampling_info = sampling_info,
     inverse_mass_matrix = inverse_mass_matrix,

---FILE: R/utils.R---
@@ -369,7 +369,7 @@ set_num_threads <- function(num_threads) {
 }
 
 check_divergences <- function(data_csv) {
-  if(data_csv$sampling_info$num_samples > 0) {
+  if(!is.null(data_csv$sampling_info$num_samples) && data_csv$sampling_info$num_samples > 0) {
     divergences <- posterior::extract_one_variable_matrix(data_csv$post_warmup_sampler, ""divergent__"")
     num_of_divergences <- sum(divergences)
     if (num_of_divergences > 0) {
@@ -385,7 +385,7 @@ check_divergences <- function(data_csv) {
 }
 
 check_sampler_transitions_treedepth <- function(data_csv) {
-  if(data_csv$sampling_info$num_samples > 0) {
+  if(!is.null(data_csv$sampling_info$num_samples) && data_csv$sampling_info$num_samples > 0) {
     max_treedepth <- data_csv$sampling_info$max_depth
     treedepth <- posterior::extract_one_variable_matrix(data_csv$post_warmup_sampler, ""treedepth__"")
     max_treedepth_hit <- sum(treedepth >= max_treedepth)",True,False,Implementation / Logic,6
stan-dev,cmdstanr,daa3b8757b0cbb094c85143aed5026e061f73f65,Rok,rok.cesnovar@fri.uni-lj.si,2019-12-07T07:33:45Z,Rok,rok.cesnovar@fri.uni-lj.si,2019-12-07T07:33:45Z,fix sampling args matching,R/read_csv.R,False,True,True,False,5,4,9,"---FILE: R/read_csv.R---
@@ -13,8 +13,9 @@ check_sampling_csv_info_matches <- function(a, b) {
   if ((length(a$model_params)!= length(b$model_params)) || !(all(a$model_params == b$model_params) && all(a$sampler_params == b$sampler_params))) {
     return(""Supplied CSV files have samples for different parameters!"")
   }
+  dont_match_list <- c(""id"", ""inverse_mass_matrix"")
   for (name in names(a)) {
-    if (name != ""id"" && name != ""inverse_mass_matrix"" && (is.null(b[[name]]) ||  a[[name]] != b[[name]])) {
+    if (!(name %in% dont_match_list) && (is.null(b[[name]]) ||  all(a[[name]] != b[[name]]))) {
       return(""Supplied CSV files do not match in all sampling settings!"")
     }
   }
@@ -99,7 +100,7 @@ read_sample_info_csv <- function(csv_file) {
       }
       if(csv_file_info$inverse_mass_matrix_rows == 0) {
         csv_file_info$inverse_mass_matrix <- rapply(inv_mass_matrix_split, as.numeric)
-      } else {        
+      } else {
         csv_file_info$inverse_mass_matrix <- c(csv_file_info$inverse_mass_matrix, rapply(inv_mass_matrix_split, as.numeric))
       }
       csv_file_info$inverse_mass_matrix_rows <- csv_file_info$inverse_mass_matrix_rows + 1
@@ -185,7 +186,7 @@ read_sample_csv <- function(output_files) {
     }
     # read sampling data
     draws <- utils::read.csv(output_file, header = TRUE, comment.char = ""#"")
-    
+
     if(sampling_info$save_warmup == 1) {
       warmup_draws_array[[id]] <- draws[1:sampling_info$num_warmup/sampling_info$thin, sampling_info$model_params]
       warmup_sampling_params_draws[[id]] <- draws[1:sampling_info$num_warmup/sampling_info$thin, sampling_info$sampler_params]
@@ -208,7 +209,7 @@ read_sample_csv <- function(output_files) {
                                                              dim = c(sampling_info$num_warmup/sampling_info$thin, num_chains, length(sampling_info$sampler_params)),
                                                              dimnames = list(NULL, NULL, sampling_info$sampler_params)))
   }
-  
+
   post_warmup_draws_array <- posterior::as_draws_array(array(unlist(do.call(rbind, post_warmup_draws_array)),
                                                              dim = c(sampling_info$num_samples/sampling_info$thin, num_chains, length(sampling_info$model_params)),
                                                              dimnames = list(NULL, NULL, sampling_info$model_params)))",True,False,Implementation / Logic,6
stan-dev,cmdstanr,85a20401d0887d2f23059bdaa8f3809878942203,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-11-30T08:37:59Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-11-30T08:37:59Z,fix the diff params test,R/read_csv.R;tests/testthat/resources/csv/bernoulli-3-diff_params.csv;tests/testthat/test-csv.R,False,True,True,False,210,209,419,"---FILE: R/read_csv.R---
@@ -7,13 +7,13 @@
 #' @param b the second sampling info to check
 #'
 check_sampling_csv_info_matches <- function(a, b) {
-  if(a$model_name != b$model_name) {
+  if (a$model_name != b$model_name) {
     return(""Supplied CSV files were not generated wtih the same model!"")
   }
-  if(!(all(a$model_params == b$model_params) && all(a$sampler_params == b$sampler_params))) {
+  if ((length(a$model_params)!= length(b$model_params)) || !(all(a$model_params == b$model_params) && all(a$sampler_params == b$sampler_params))) {
     return(""Supplied CSV files have samples for different parameters!"")
   }
-  for(name in names(a)) {
+  for (name in names(a)) {
     if (name != ""id"" && name != ""inverse_mass_matrix"" && (is.null(b[[name]]) ||  a[[name]] != b[[name]])) {
       return(""Supplied CSV files do not match in all sampling settings!"")
     }
@@ -91,7 +91,7 @@ read_sample_info_csv <- function(csv_file) {
       } else {
         csv_file_info$inverse_mass_matrix <- c(csv_file_info$inverse_mass_matrix, rapply(strsplit(gsub(""# "", """", line), "",""), as.numeric))
       }
-      csv_file_info$inverse_mass_matrix_rows <- csv_file_info$inverse_mass_matrix_rows +1
+      csv_file_info$inverse_mass_matrix_rows <- csv_file_info$inverse_mass_matrix_rows + 1
     }
   }
   close(con)

---FILE: tests/testthat/resources/csv/bernoulli-3-diff_params.csv---
@@ -1,12 +1,12 @@
 # stan_version_major = 2
 # stan_version_minor = 21
 # stan_version_patch = 0
-# model = model1
+# model = bernoulli_model
 # method = sample (Default)
 #   sample
-#     num_samples = 100 (Default)
-#     num_warmup = 100 (Default)
-#     save_warmup = 1
+#     num_samples = 1000 (Default)
+#     num_warmup = 1000 (Default)
+#     save_warmup = 0
 #     thin = 1 (Default)
 #     adapt
 #       engaged = 1 (Default)
@@ -21,12 +21,12 @@
 #       hmc
 #         engine = nuts (Default)
 #           nuts
-#             max_depth = 5
+#             max_depth = 10
 #         metric = diag_e (Default)
 #         metric_file =  (Default)
 #         stepsize = 1 (Default)
 #         stepsize_jitter = 0 (Default)
-# id = 1
+# id = 3
 # data
 #   file = /tmp/RtmpcXhiID/standata-124764cd0999.json
 # init = 2 (Default)
@@ -37,14 +37,13 @@
 #   diagnostic_file =  (Default)
 #   refresh = 100 (Default)
 lp__,accept_stat__,stepsize__,treedepth__,n_leapfrog__,divergent__,energy__,mu,theta
--32.3122,1,0.125,2,3,0,43.1912,-0.780945,2.9559
 # Adaptation terminated
 # Step size = 0.712907
 # Diagonal elements of inverse mass matrix:
 # 1.00098, 0.068748
 -19.4938,0.953779,0.712907,2,3,0,19.4971,8.11498,7.4563
-# 
+#
 #  Elapsed Time: 0.038029 seconds (Warm-up)
 #                0.030711 seconds (Sampling)
 #                0.06874 seconds (Total)
-# 
+#

---FILE: tests/testthat/test-csv.R---
@@ -2,6 +2,8 @@ context(""read-sample-csv"")
 
 if (not_on_cran()) {
   set_cmdstan_path()
+  fit_bernoulli_thin_1 <- testing_fit(""bernoulli"", method = ""sample"",
+                          seed = 123, num_chains = 2, num_samples = 1000, num_warmup = 1000, thin = 1)
   fit_logistic_thin_1 <- testing_fit(""logistic"", method = ""sample"",
                           seed = 123, num_chains = 2, num_samples = 1000, num_warmup = 1000, thin = 1)
   fit_logistic_thin_1_with_warmup <- testing_fit(""logistic"", method = ""sample"",
@@ -12,202 +14,202 @@ if (not_on_cran()) {
                           seed = 123, num_chains = 2, num_samples = 1000, num_warmup = 1000, thin = 10, save_warmup = 1)
 }
 
-# test_that(""read_sample_csv() fails for different model names"", {
-#   skip_on_cran()
-#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-warmup.csv""),
-#                  test_path(""resources"", ""csv"", ""model1-3-diff_name.csv""))
-#   expect_error(read_sample_csv(csv_files),
-#                ""Supplied CSV files were not generated wtih the same model!"")
-# })
-
-# test_that(""read_sample_csv() fails for different sampling settings"", {
-#   skip_on_cran()
-#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-warmup.csv""),
-#                  test_path(""resources"", ""csv"", ""model1-3-diff_args.csv""))
-#   expect_error(read_sample_csv(csv_files),
-#                ""Supplied CSV files do not match in all sampling settings!"")
-# })
-
-# test_that(""read_sample_csv() fails for different parameters"", {
-#   skip_on_cran()
-#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-warmup.csv""),
-#                  test_path(""resources"", ""csv"", ""model1-3-diff_params.csv""))
-#   expect_error(read_sample_csv(csv_files),
-#                ""Supplied CSV files have samples for different parameters!"")
-# })
-
-# test_that(""read_sample_csv() fails if the file does not exist"", {
-#   skip_on_cran()
-#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-doesntexist.csv""))
-#   expect_error(read_sample_csv(csv_files),
-#                ""Assertion on 'output_file' failed: File does not exist: 'resources/csv/model1-1-doesntexist.csv'."")
-# })
-
-# test_that(""read_sample_csv() fails for non-sampling csv"", {
-#   skip_on_cran()
-#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-nonsampling.csv""))
-#   expect_error(read_sample_csv(csv_files),
-#                ""Supplied CSV file was not generated with sampling. Consider using read_optim_csv or read_vb_csv!"")
-# })
-
-# test_that(""read_sample_csv() fails with empty csv file"", {
-#   skip_on_cran()
-#   file_path <- test_path(""resources"", ""csv"", ""empty.csv"")
-#   file.create(file_path)
-#   expect_error(read_sample_csv(file_path),
-#                ""Supplied CSV file is corrupt!"")
-#   file.remove(file_path)
-# })
-
-# test_that(""read_sample_csv() fails with the no params listed"", {
-#   skip_on_cran()
-#   file_path <- test_path(""resources"", ""csv"", ""model1-3-no-params.csv"")
-#   expect_error(read_sample_csv(file_path),
-#                ""no lines available in input"")
-# })
-
-# test_that(""read_sample_csv() matches rstan::read_stan_csv()"", {
-#   skip_on_cran()
-#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-warmup.csv""),
-#                  test_path(""resources"", ""csv"", ""model1-2-warmup.csv""))
-
-#   draws_array <- readRDS(test_path(""answers"", ""rstan-read-stan-csv-no-warmup.rds""))
-#   draws_array <- posterior::as_draws_array(draws_array)
-#   csv_output <- read_sample_csv(csv_files)
-#   expect_equal(csv_output$post_warmup[,, ""mu""],
-#                draws_array[,,""mu""])
-#   expect_equal(csv_output$post_warmup[,, ""sigma""],
-#                draws_array[,,""sigma""])
-#   expect_equal(csv_output$post_warmup[,, ""lp__""],
-#                draws_array[,,""lp__""])
-# })
-
-# test_that(""read_sample_csv() matches rstan::read_stan_csv() with save_warmup"", {
-#   skip_on_cran()
-#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-warmup.csv""),
-#                  test_path(""resources"", ""csv"", ""model1-2-warmup.csv""))
-
-#   draws_array <- readRDS(test_path(""answers"", ""rstan-read-stan-csv-warmup.rds""))
-#   draws_array <- posterior::as_draws_array(draws_array)
-#   csv_output <- read_sample_csv(csv_files)
-
-#   warmup_iter <- csv_output$sampling_info$num_warmup
-#   num_iter <- csv_output$sampling_info$num_iter
-
-#   draws_array_post_warmup <- draws_array[(warmup_iter+1):num_iter,,]
-#   draws_array_warmup <- draws_array[1:warmup_iter,,]
-
-#   expect_equal(posterior::extract_one_variable_matrix(csv_output$post_warmup, ""mu""),
-#                posterior::extract_one_variable_matrix(draws_array_post_warmup, ""mu""))
-#   expect_equal(posterior::extract_one_variable_matrix(csv_output$post_warmup, ""sigma""),
-#                posterior::extract_one_variable_matrix(draws_array_post_warmup, ""sigma""))
-#   expect_equal(posterior::extract_one_variable_matrix(csv_output$post_warmup, ""lp__""),
-#                posterior::extract_one_variable_matrix(draws_array_post_warmup, ""lp__""))
-#   expect_equal(posterior::extract_one_variable_matrix(csv_output$warmup, ""mu""),
-#                posterior::extract_one_variable_matrix(draws_array_warmup, ""mu""))
-#   expect_equal(posterior::extract_one_variable_matrix(csv_output$warmup, ""sigma""),
-#                posterior::extract_one_variable_matrix(draws_array_warmup, ""sigma""))
-#   expect_equal(posterior::extract_one_variable_matrix(csv_output$warmup, ""lp__""),
-#                posterior::extract_one_variable_matrix(draws_array_warmup, ""lp__""))
-# })
-
-# test_that(""read_sample_csv() matches rstan::read_stan_csv() for csv file without warmup"", {
-#   skip_on_cran()
-#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-2-no-warmup.csv""))
-
-#   draws_array <- readRDS(test_path(""answers"", ""rstan-read-stan-csv-no-warmup-file.rds""))
-#   draws_array <- posterior::as_draws_array(draws_array)
-#   csv_output <- read_sample_csv(csv_files)
-
-#   expect_equal(posterior::extract_one_variable_matrix(csv_output$post_warmup, ""mu""),
-#                posterior::extract_one_variable_matrix(draws_array, ""mu""))
-#   expect_equal(posterior::extract_one_variable_matrix(csv_output$post_warmup, ""sigma""),
-#                posterior::extract_one_variable_matrix(draws_array, ""sigma""))
-#   expect_equal(posterior::extract_one_variable_matrix(csv_output$post_warmup, ""lp__""),
-#                posterior::extract_one_variable_matrix(draws_array, ""lp__""))
-# })
-
-# test_that(""read_sample_csv() returns correct diagonal of inverse mass matrix"", {
-#   skip_on_cran()
-#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-2-no-warmup.csv""))
-#   csv_output <- read_sample_csv(csv_files)
-#   expect_equal(as.vector(csv_output$inverse_mass_matrix[[2]]),
-#                c(0.909635, 0.066384))
-#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-warmup.csv""),test_path(""resources"", ""csv"", ""model1-2-warmup.csv""))
-#   csv_output <- read_sample_csv(csv_files)
-#   expect_equal(as.vector(csv_output$inverse_mass_matrix[[1]]),
-#                c(1.00098, 0.068748))
-#   expect_equal(as.vector(csv_output$inverse_mass_matrix[[2]]),
-#                c(0.909635, 0.066384))
-# })
-
-# test_that(""read_sample_csv() returns correct dense inverse mass matrix"", {
-#   skip_on_cran()
-#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-dense_e_metric.csv""))
-#   csv_output <- read_sample_csv(csv_files)
-#   expect_equal(as.vector(csv_output$inverse_mass_matrix[[1]]),
-#                c(10.2742, -0.189148, 5.92065, 8.2658, 10.9931, 8.67196, 9.75007, 8.30008, 6.3396, 8.75422,
-#                 -0.189148, 0.552614, 2.28054, 0.587285, -0.557112, 0.0689745, -1.06614, -0.502288, 1.49863, 0.450733,
-#                 5.92065, 2.28054, 52.7011, 7.89278, 3.9639, 5.71556, 2.16445, 1.88834, 13.8962, 15.1166,
-#                 8.2658, 0.587285, 7.89278, 30.7924, 8.39762, 8.51489, 8.27253, 9.96521, 7.58758, 7.8403,
-#                 10.9931, -0.557112, 3.9639, 8.39762, 39.6164, 9.88103, 9.62453, 9.80744, 6.28594, 6.77034,
-#                 8.67196, 0.0689745, 5.71556, 8.51489, 9.88103, 29.6702, 8.5937, 8.3289, 8.76294, 5.63637,
-#                 9.75007, -1.06614, 2.16445, 8.27253, 9.62453, 8.5937, 26.3294, 10.1908, 2.76266, 4.56938,
-#                 8.30008, -0.502288, 1.88834, 9.96521, 9.80744, 8.3289, 10.1908, 26.5846, 3.7247, 4.26521,
-#                 6.3396, 1.49863, 13.8962, 7.58758, 6.28594, 8.76294, 2.76266, 3.7247, 28.8872, 8.43035,
-#                 8.75422, 0.450733, 15.1166, 7.8403, 6.77034, 5.63637, 4.56938, 4.26521, 8.43035, 42.5438))
-# })
-
-# test_that(""read_sample_csv() returns correct dense inverse mass matrix for 2 csv files "", {
-#   skip_on_cran()
-#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-dense_e_metric.csv""),
-#                  test_path(""resources"", ""csv"", ""model1-2-dense_e_metric.csv""))
-#   csv_output <- read_sample_csv(csv_files)
-#   expect_equal(as.vector(csv_output$inverse_mass_matrix[[1]]),
-#              c(10.2742, -0.189148, 5.92065, 8.2658, 10.9931, 8.67196, 9.75007, 8.30008, 6.3396, 8.75422,
-#                 -0.189148, 0.552614, 2.28054, 0.587285, -0.557112, 0.0689745, -1.06614, -0.502288, 1.49863, 0.450733,
-#                 5.92065, 2.28054, 52.7011, 7.89278, 3.9639, 5.71556, 2.16445, 1.88834, 13.8962, 15.1166,
-#                 8.2658, 0.587285, 7.89278, 30.7924, 8.39762, 8.51489, 8.27253, 9.96521, 7.58758, 7.8403,
-#                 10.9931, -0.557112, 3.9639, 8.39762, 39.6164, 9.88103, 9.62453, 9.80744, 6.28594, 6.77034,
-#                 8.67196, 0.0689745, 5.71556, 8.51489, 9.88103, 29.6702, 8.5937, 8.3289, 8.76294, 5.63637,
-#                 9.75007, -1.06614, 2.16445, 8.27253, 9.62453, 8.5937, 26.3294, 10.1908, 2.76266, 4.56938,
-#                 8.30008, -0.502288, 1.88834, 9.96521, 9.80744, 8.3289, 10.1908, 26.5846, 3.7247, 4.26521,
-#                 6.3396, 1.49863, 13.8962, 7.58758, 6.28594, 8.76294, 2.76266, 3.7247, 28.8872, 8.43035,
-#                 8.75422, 0.450733, 15.1166, 7.8403, 6.77034, 5.63637, 4.56938, 4.26521, 8.43035, 42.5438))
-#   expect_equal(as.vector(csv_output$inverse_mass_matrix[[2]]),
-#              c( 11.08, -0.305763, 5.27013, 7.33046, 7.31263, 6.93229, 10.1923, 7.46852, 7.51557, 7.78791,
-#                 -0.305763, 0.678461, 1.70598, 0.337143, -0.69887, 0.423236, -0.974023, -0.605539, 1.83794, 0.0780934,
-#                 5.27013, 1.70598, 36.2726, 7.9386, 3.88642, 12.0214, 4.2487, 3.84886, 12.9738, 4.34037,
-#                 7.33046, 0.337143, 7.9386, 23.9878, 4.93047, 5.76139, 7.34008, 7.78631, 6.79063, 8.13132,
-#                 7.31263, -0.69887, 3.88642, 4.93047, 25.3662, 7.2269, 7.5408, 8.18066, 5.77239, 7.53072,
-#                 6.93229, 0.423236, 12.0214, 5.76139, 7.2269, 24.0619, 7.24315, 7.194, 10.1647, 5.61617,
-#                 10.1923, -0.974023, 4.2487, 7.34008, 7.5408, 7.24315, 26.2403, 6.91029, 1.26095, 4.72335,
-#                 7.46852, -0.605539, 3.84886, 7.78631, 8.18066, 7.194, 6.91029, 30.2862, 5.61914, 8.10162,
-#                 7.51557, 1.83794, 12.9738, 6.79063, 5.77239, 10.1647, 1.26095, 5.61914, 34.5498, 7.75486,
-#                 7.78791, 0.0780934, 4.34037, 8.13132, 7.53072, 5.61617, 4.72335, 8.10162, 7.75486, 35.6602))
-# })
-
-
-# test_that(""read_sample_csv() matches rstan::read_stan_csv() for csv file without warmup"", {
-#   skip_on_cran()
-#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-2-warmup.csv""))
-
-#   sampler_params <- readRDS(test_path(""answers"", ""rstan-read-stan-csv-sampler-params.rds""))
-#   sampler_params <- posterior::as_draws_array(sampler_params[[1]])
-#   csv_output <- read_sample_csv(csv_files)
-#   expect_equal(posterior::extract_one_variable_matrix(csv_output$sampler, ""divergent__""),
-#                posterior::extract_one_variable_matrix(sampler_params, ""divergent__""))
-#   expect_equal(posterior::extract_one_variable_matrix(csv_output$sampler, ""accept_stat__""),
-#                posterior::extract_one_variable_matrix(sampler_params, ""accept_stat__""))
-#   expect_equal(posterior::extract_one_variable_matrix(csv_output$sampler, ""treedepth__""),
-#                posterior::extract_one_variable_matrix(sampler_params, ""treedepth__""))
-#   expect_equal(posterior::extract_one_variable_matrix(csv_output$sampler, ""stepsize__""),
-#                posterior::extract_one_variable_matrix(sampler_params, ""stepsize__""))
-#   expect_equal(posterior::extract_one_variable_matrix(csv_output$sampler, ""n_leapfrog__""),
-#                posterior::extract_one_variable_matrix(sampler_params, ""n_leapfrog__""))
-#   expect_equal(posterior::extract_one_variable_matrix(csv_output$sampler, ""energy__""),
-#                posterior::extract_one_variable_matrix(sampler_params, ""energy__""))
-# })
+test_that(""read_sample_csv() fails for different model names"", {
+  skip_on_cran()
+  csv_files <- c(fit_bernoulli_thin_1$output_files(),
+                 fit_logistic_thin_1$output_files())
+  expect_error(read_sample_csv(csv_files),
+               ""Supplied CSV files were not generated wtih the same model!"")
+})
+
+test_that(""read_sample_csv() fails for different sampling settings"", {
+  skip_on_cran()
+  csv_files <- c(fit_logistic_thin_1$output_files(),
+                 fit_logistic_thin_10$output_files())
+  expect_error(read_sample_csv(csv_files),
+               ""Supplied CSV files do not match in all sampling settings!"")
+})
+
+test_that(""read_sample_csv() fails for different parameters"", {
+  skip_on_cran()
+  csv_files <- c(fit_bernoulli_thin_1$output_files(),
+                 test_path(""resources"", ""csv"", ""bernoulli-3-diff_params.csv""))
+  expect_error(read_sample_csv(csv_files),
+               ""Supplied CSV files have samples for different parameters!"")
+})
+
+test_that(""read_sample_csv() fails if the file does not exist"", {
+  skip_on_cran()
+  csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-doesntexist.csv""))
+  expect_error(read_sample_csv(csv_files),
+               ""Assertion on 'output_file' failed: File does not exist: 'resources/csv/model1-1-doesntexist.csv'."")
+})
+
+test_that(""read_sample_csv() fails for non-sampling csv"", {
+  skip_on_cran()
+  csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-nonsampling.csv""))
+  expect_error(read_sample_csv(csv_files),
+               ""Supplied CSV file was not generated with sampling. Consider using read_optim_csv or read_vb_csv!"")
+})
+
+test_that(""read_sample_csv() fails with empty csv file"", {
+  skip_on_cran()
+  file_path <- test_path(""resources"", ""csv"", ""empty.csv"")
+  file.create(file_path)
+  expect_error(read_sample_csv(file_path),
+               ""Supplied CSV file is corrupt!"")
+  file.remove(file_path)
+})
+
+test_that(""read_sample_csv() fails with the no params listed"", {
+  skip_on_cran()
+  file_path <- test_path(""resources"", ""csv"", ""model1-3-no-params.csv"")
+  expect_error(read_sample_csv(file_path),
+               ""no lines available in input"")
+})
+
+test_that(""read_sample_csv() matches rstan::read_stan_csv()"", {
+  skip_on_cran()
+  csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-warmup.csv""),
+                 test_path(""resources"", ""csv"", ""model1-2-warmup.csv""))
+
+  draws_array <- readRDS(test_path(""answers"", ""rstan-read-stan-csv-no-warmup.rds""))
+  draws_array <- posterior::as_draws_array(draws_array)
+  csv_output <- read_sample_csv(csv_files)
+  expect_equal(csv_output$post_warmup[,, ""mu""],
+               draws_array[,,""mu""])
+  expect_equal(csv_output$post_warmup[,, ""sigma""],
+               draws_array[,,""sigma""])
+  expect_equal(csv_output$post_warmup[,, ""lp__""],
+               draws_array[,,""lp__""])
+})
+
+test_that(""read_sample_csv() matches rstan::read_stan_csv() with save_warmup"", {
+  skip_on_cran()
+  csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-warmup.csv""),
+                 test_path(""resources"", ""csv"", ""model1-2-warmup.csv""))
+
+  draws_array <- readRDS(test_path(""answers"", ""rstan-read-stan-csv-warmup.rds""))
+  draws_array <- posterior::as_draws_array(draws_array)
+  csv_output <- read_sample_csv(csv_files)
+
+  warmup_iter <- csv_output$sampling_info$num_warmup
+  num_iter <- csv_output$sampling_info$num_iter
+
+  draws_array_post_warmup <- draws_array[(warmup_iter+1):num_iter,,]
+  draws_array_warmup <- draws_array[1:warmup_iter,,]
+
+  expect_equal(posterior::extract_one_variable_matrix(csv_output$post_warmup, ""mu""),
+               posterior::extract_one_variable_matrix(draws_array_post_warmup, ""mu""))
+  expect_equal(posterior::extract_one_variable_matrix(csv_output$post_warmup, ""sigma""),
+               posterior::extract_one_variable_matrix(draws_array_post_warmup, ""sigma""))
+  expect_equal(posterior::extract_one_variable_matrix(csv_output$post_warmup, ""lp__""),
+               posterior::extract_one_variable_matrix(draws_array_post_warmup, ""lp__""))
+  expect_equal(posterior::extract_one_variable_matrix(csv_output$warmup, ""mu""),
+               posterior::extract_one_variable_matrix(draws_array_warmup, ""mu""))
+  expect_equal(posterior::extract_one_variable_matrix(csv_output$warmup, ""sigma""),
+               posterior::extract_one_variable_matrix(draws_array_warmup, ""sigma""))
+  expect_equal(posterior::extract_one_variable_matrix(csv_output$warmup, ""lp__""),
+               posterior::extract_one_variable_matrix(draws_array_warmup, ""lp__""))
+})
+
+test_that(""read_sample_csv() matches rstan::read_stan_csv() for csv file without warmup"", {
+  skip_on_cran()
+  csv_files <- c(test_path(""resources"", ""csv"", ""model1-2-no-warmup.csv""))
+
+  draws_array <- readRDS(test_path(""answers"", ""rstan-read-stan-csv-no-warmup-file.rds""))
+  draws_array <- posterior::as_draws_array(draws_array)
+  csv_output <- read_sample_csv(csv_files)
+
+  expect_equal(posterior::extract_one_variable_matrix(csv_output$post_warmup, ""mu""),
+               posterior::extract_one_variable_matrix(draws_array, ""mu""))
+  expect_equal(posterior::extract_one_variable_matrix(csv_output$post_warmup, ""sigma""),
+               posterior::extract_one_variable_matrix(draws_array, ""sigma""))
+  expect_equal(posterior::extract_one_variable_matrix(csv_output$post_warmup, ""lp__""),
+               posterior::extract_one_variable_matrix(draws_array, ""lp__""))
+})
+
+test_that(""read_sample_csv() returns correct diagonal of inverse mass matrix"", {
+  skip_on_cran()
+  csv_files <- c(test_path(""resources"", ""csv"", ""model1-2-no-warmup.csv""))
+  csv_output <- read_sample_csv(csv_files)
+  expect_equal(as.vector(csv_output$inverse_mass_matrix[[2]]),
+               c(0.909635, 0.066384))
+  csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-warmup.csv""),test_path(""resources"", ""csv"", ""model1-2-warmup.csv""))
+  csv_output <- read_sample_csv(csv_files)
+  expect_equal(as.vector(csv_output$inverse_mass_matrix[[1]]),
+               c(1.00098, 0.068748))
+  expect_equal(as.vector(csv_output$inverse_mass_matrix[[2]]),
+               c(0.909635, 0.066384))
+})
+
+test_that(""read_sample_csv() returns correct dense inverse mass matrix"", {
+  skip_on_cran()
+  csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-dense_e_metric.csv""))
+  csv_output <- read_sample_csv(csv_files)
+  expect_equal(as.vector(csv_output$inverse_mass_matrix[[1]]),
+               c(10.2742, -0.189148, 5.92065, 8.2658, 10.9931, 8.67196, 9.75007, 8.30008, 6.3396, 8.75422,
+                -0.189148, 0.552614, 2.28054, 0.587285, -0.557112, 0.0689745, -1.06614, -0.502288, 1.49863, 0.450733,
+                5.92065, 2.28054, 52.7011, 7.89278, 3.9639, 5.71556, 2.16445, 1.88834, 13.8962, 15.1166,
+                8.2658, 0.587285, 7.89278, 30.7924, 8.39762, 8.51489, 8.27253, 9.96521, 7.58758, 7.8403,
+                10.9931, -0.557112, 3.9639, 8.39762, 39.6164, 9.88103, 9.62453, 9.80744, 6.28594, 6.77034,
+                8.67196, 0.0689745, 5.71556, 8.51489, 9.88103, 29.6702, 8.5937, 8.3289, 8.76294, 5.63637,
+                9.75007, -1.06614, 2.16445, 8.27253, 9.62453, 8.5937, 26.3294, 10.1908, 2.76266, 4.56938,
+                8.30008, -0.502288, 1.88834, 9.96521, 9.80744, 8.3289, 10.1908, 26.5846, 3.7247, 4.26521,
+                6.3396, 1.49863, 13.8962, 7.58758, 6.28594, 8.76294, 2.76266, 3.7247, 28.8872, 8.43035,
+                8.75422, 0.450733, 15.1166, 7.8403, 6.77034, 5.63637, 4.56938, 4.26521, 8.43035, 42.5438))
+})
+
+test_that(""read_sample_csv() returns correct dense inverse mass matrix for 2 csv files "", {
+  skip_on_cran()
+  csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-dense_e_metric.csv""),
+                 test_path(""resources"", ""csv"", ""model1-2-dense_e_metric.csv""))
+  csv_output <- read_sample_csv(csv_files)
+  expect_equal(as.vector(csv_output$inverse_mass_matrix[[1]]),
+             c(10.2742, -0.189148, 5.92065, 8.2658, 10.9931, 8.67196, 9.75007, 8.30008, 6.3396, 8.75422,
+                -0.189148, 0.552614, 2.28054, 0.587285, -0.557112, 0.0689745, -1.06614, -0.502288, 1.49863, 0.450733,
+                5.92065, 2.28054, 52.7011, 7.89278, 3.9639, 5.71556, 2.16445, 1.88834, 13.8962, 15.1166,
+                8.2658, 0.587285, 7.89278, 30.7924, 8.39762, 8.51489, 8.27253, 9.96521, 7.58758, 7.8403,
+                10.9931, -0.557112, 3.9639, 8.39762, 39.6164, 9.88103, 9.62453, 9.80744, 6.28594, 6.77034,
+                8.67196, 0.0689745, 5.71556, 8.51489, 9.88103, 29.6702, 8.5937, 8.3289, 8.76294, 5.63637,
+                9.75007, -1.06614, 2.16445, 8.27253, 9.62453, 8.5937, 26.3294, 10.1908, 2.76266, 4.56938,
+                8.30008, -0.502288, 1.88834, 9.96521, 9.80744, 8.3289, 10.1908, 26.5846, 3.7247, 4.26521,
+                6.3396, 1.49863, 13.8962, 7.58758, 6.28594, 8.76294, 2.76266, 3.7247, 28.8872, 8.43035,
+                8.75422, 0.450733, 15.1166, 7.8403, 6.77034, 5.63637, 4.56938, 4.26521, 8.43035, 42.5438))
+  expect_equal(as.vector(csv_output$inverse_mass_matrix[[2]]),
+             c( 11.08, -0.305763, 5.27013, 7.33046, 7.31263, 6.93229, 10.1923, 7.46852, 7.51557, 7.78791,
+                -0.305763, 0.678461, 1.70598, 0.337143, -0.69887, 0.423236, -0.974023, -0.605539, 1.83794, 0.0780934,
+                5.27013, 1.70598, 36.2726, 7.9386, 3.88642, 12.0214, 4.2487, 3.84886, 12.9738, 4.34037,
+                7.33046, 0.337143, 7.9386, 23.9878, 4.93047, 5.76139, 7.34008, 7.78631, 6.79063, 8.13132,
+                7.31263, -0.69887, 3.88642, 4.93047, 25.3662, 7.2269, 7.5408, 8.18066, 5.77239, 7.53072,
+                6.93229, 0.423236, 12.0214, 5.76139, 7.2269, 24.0619, 7.24315, 7.194, 10.1647, 5.61617,
+                10.1923, -0.974023, 4.2487, 7.34008, 7.5408, 7.24315, 26.2403, 6.91029, 1.26095, 4.72335,
+                7.46852, -0.605539, 3.84886, 7.78631, 8.18066, 7.194, 6.91029, 30.2862, 5.61914, 8.10162,
+                7.51557, 1.83794, 12.9738, 6.79063, 5.77239, 10.1647, 1.26095, 5.61914, 34.5498, 7.75486,
+                7.78791, 0.0780934, 4.34037, 8.13132, 7.53072, 5.61617, 4.72335, 8.10162, 7.75486, 35.6602))
+})
+
+
+test_that(""read_sample_csv() matches rstan::read_stan_csv() for csv file without warmup"", {
+  skip_on_cran()
+  csv_files <- c(test_path(""resources"", ""csv"", ""model1-2-warmup.csv""))
+
+  sampler_params <- readRDS(test_path(""answers"", ""rstan-read-stan-csv-sampler-params.rds""))
+  sampler_params <- posterior::as_draws_array(sampler_params[[1]])
+  csv_output <- read_sample_csv(csv_files)
+  expect_equal(posterior::extract_one_variable_matrix(csv_output$sampler, ""divergent__""),
+               posterior::extract_one_variable_matrix(sampler_params, ""divergent__""))
+  expect_equal(posterior::extract_one_variable_matrix(csv_output$sampler, ""accept_stat__""),
+               posterior::extract_one_variable_matrix(sampler_params, ""accept_stat__""))
+  expect_equal(posterior::extract_one_variable_matrix(csv_output$sampler, ""treedepth__""),
+               posterior::extract_one_variable_matrix(sampler_params, ""treedepth__""))
+  expect_equal(posterior::extract_one_variable_matrix(csv_output$sampler, ""stepsize__""),
+               posterior::extract_one_variable_matrix(sampler_params, ""stepsize__""))
+  expect_equal(posterior::extract_one_variable_matrix(csv_output$sampler, ""n_leapfrog__""),
+               posterior::extract_one_variable_matrix(sampler_params, ""n_leapfrog__""))
+  expect_equal(posterior::extract_one_variable_matrix(csv_output$sampler, ""energy__""),
+               posterior::extract_one_variable_matrix(sampler_params, ""energy__""))
+})
 
 test_that(""read_sample_csv() works with thin"", {
   skip_on_cran()",True,False,Data / Input Handling,6
stan-dev,cmdstanr,799981a559cf6cebcb47e697fbde9b292c717a8c,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-11-29T18:05:43Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-11-29T18:05:43Z,"only use arguments from sampleArgs, fix use with thin",R/read_csv.R;tests/testthat/resources/csv/model1-1-dense_e_metric.csv;tests/testthat/resources/csv/model1-2-dense_e_metric.csv;tests/testthat/resources/csv/model1-2-no-warmup.csv;tests/testthat/resources/csv/model1-3-diff_args.csv;tests/testthat/resources/csv/model1-3-diff_data_file.csv;tests/testthat/resources/csv/model1-3-diff_stan_version.csv;tests/testthat/test-csv.R,False,True,True,False,399,360,759,"---FILE: R/read_csv.R---
@@ -7,26 +7,15 @@
 #' @param b the second sampling info to check
 #'
 check_sampling_csv_info_matches <- function(a, b) {
-  if(a$stan_version_major != b$stan_version_major ||
-     a$stan_version_minor != b$stan_version_minor ||
-     a$stan_version_patch != b$stan_version_patch) {
-    return(""Supplied CSV files were not generated with the same version of Cmdstan!"")
-  }
-  if(a$model != b$model) {
+  if(a$model_name != b$model_name) {
     return(""Supplied CSV files were not generated wtih the same model!"")
   }
-  if(!all(a$model_params == b$model_params)) {
+  if(!(all(a$model_params == b$model_params) && all(a$sampler_params == b$sampler_params))) {
     return(""Supplied CSV files have samples for different parameters!"")
   }
-  if(a$data_file != b$data_file) {
-    return(""Supplied CSV files have samples from chains run with non-matching data!"")
-  }
   for(name in names(a)) {
-    if(startsWith(name, ""sample_"")) {
-      if ((is.null(b[[name]]) ||  a[[name]] != b[[name]])
-          && regexpr(""metric"", name) == 0) {
-        return(""Supplied CSV files do not match in all sampling settings!"")
-      }
+    if (name != ""id"" && name != ""inverse_mass_matrix"" && (is.null(b[[name]]) ||  a[[name]] != b[[name]])) {
+      return(""Supplied CSV files do not match in all sampling settings!"")
     }
   }
   NULL
@@ -43,12 +32,14 @@ check_sampling_csv_info_matches <- function(a, b) {
 read_sample_info_csv <- function(csv_file) {
   checkmate::assert_file_exists(csv_file, access = ""r"", extension = ""csv"")
   param_names_read <- FALSE
-  sampling_params_read <- FALSE
-  diagonal_matrix_next <- FALSE
+  inverse_mass_matrix_next <- FALSE
+  inverse_mass_matrix_diagonal_next <- FALSE
   diagonal_matrix_read <- FALSE
   arg_prefix <- """"
   csv_file_info = list()
   con  <- file(csv_file, open = ""r"")
+  csv_file_info[[""inverse_mass_matrix""]] <- NULL
+  csv_file_info$inverse_mass_matrix_rows <- 0
   while (length(line <- readLines(con, n = 1, warn = FALSE)) > 0) {
     if (!startsWith(line, ""#"")) {
       if(!param_names_read) {
@@ -65,7 +56,7 @@ read_sample_info_csv <- function(csv_file) {
         }
         next;
       } else {
-        if(diagonal_matrix_read){
+        if(inverse_mass_matrix_next || inverse_mass_matrix_diagonal_next){
           break;
         } else {
           next;
@@ -77,59 +68,69 @@ read_sample_info_csv <- function(csv_file) {
       tmp <- gsub(""#"", """", line, fixed = TRUE)
       tmp <- gsub(""(Default)"", """", tmp, fixed = TRUE)
       key_val <- grep(""="", tmp, fixed = TRUE, value = TRUE)
-      if(length(key_val) == 0) {
-        arg_name <- trimws(tmp)
-        if(arg_prefix != """" && !sampling_params_read) {
-          arg_prefix <- paste(arg_prefix, arg_name, sep = ""_"")
+      key_val <- strsplit(key_val, split = ""="", fixed = TRUE)
+      key_val <- rapply(key_val, trimws)
+      if (length(key_val) == 2) {
+        numeric_val <- suppressWarnings(as.numeric(key_val[2]))
+        if(!is.na(numeric_val)) {
+          csv_file_info[[key_val[1]]] <- numeric_val
         } else {
-          arg_prefix <- trimws(tmp)
-        }
-      } else {
-        key_val <- strsplit(key_val, split = ""="", fixed = TRUE)
-        key_val <- rapply(key_val, trimws)
-        if(length(key_val) == 2) {
-          numeric_val <- suppressWarnings(as.numeric(key_val[2]))
-          # marks the end of sampling args
-          if(key_val[1] == ""id"" || key_val[1] == ""init"") {
-            arg_prefix <- """"
-            sampling_params_read <- TRUE
-          }
-          if(arg_prefix != """"){
-            setting_name <- paste(arg_prefix, key_val[1], sep = ""_"")
-          } else {
-            setting_name <- key_val[1]
-          }
-          if(!is.na(numeric_val)) {
-            csv_file_info[[setting_name]] <- numeric_val
-          } else {
-            csv_file_info[[setting_name]] <- key_val[2]
-          }
+          csv_file_info[[key_val[1]]] <- key_val[2]
         }
       }
     }
-    if (regexpr(""# Step size = "", line, perl = TRUE) > 0) {
-      key_val <- grep(""="", tmp, fixed = TRUE, value = TRUE)
-      csv_file_info[[""step_size""]] <- as.numeric(key_val[2])
-    }
     if (regexpr(""# Diagonal elements of inverse mass matrix:"", line, perl = TRUE) > 0) {
-      diagonal_matrix_next <- TRUE
-    } else if(diagonal_matrix_next) {
-      csv_file_info$inverse_mass_matrix_diag <- rapply(strsplit(gsub(""# "", """", line), "",""), as.numeric)
-      diagonal_matrix_next <- FALSE
-      diagonal_matrix_read <- TRUE
+      inverse_mass_matrix_diagonal_next <- TRUE
+    } else if (regexpr(""# Elements of inverse mass matrix:"", line, perl = TRUE) > 0){
+      inverse_mass_matrix_next <- TRUE
+    } else if(inverse_mass_matrix_diagonal_next) {
+      csv_file_info$inverse_mass_matrix <- rapply(strsplit(gsub(""# "", """", line), "",""), as.numeric)
+    } else if(inverse_mass_matrix_next) {
+      if(csv_file_info$inverse_mass_matrix_rows == 0) {
+        csv_file_info$inverse_mass_matrix <- rapply(strsplit(gsub(""# "", """", line), "",""), as.numeric)
+      } else {
+        csv_file_info$inverse_mass_matrix <- c(csv_file_info$inverse_mass_matrix, rapply(strsplit(gsub(""# "", """", line), "",""), as.numeric))
+      }
+      csv_file_info$inverse_mass_matrix_rows <- csv_file_info$inverse_mass_matrix_rows +1
     }
   }
   close(con)
-  if(is.null(csv_file_info$inverse_mass_matrix_diag)) {
-    csv_file_info$inverse_mass_matrix_diag <- NULL
-  }
   if(is.null(csv_file_info$method)) {
     stop(""Supplied CSV file is corrupt!"")
-  }
-  if(csv_file_info$method != ""sample"") {
+  } else if(csv_file_info$method != ""sample"") {
     stop(""Supplied CSV file was not generated with sampling. Consider using read_optim_csv or read_vb_csv!"")
   }
-  csv_file_info
+  if(csv_file_info$save_warmup == 1) {
+    num_iter <- csv_file_info$num_warmup + csv_file_info$num_samples
+  } else {
+    num_iter <- csv_file_info$num_samples
+  }
+  num_iter <- num_iter / csv_file_info$thin
+  if(csv_file_info$inverse_mass_matrix_rows > 0) {
+    rows <- csv_file_info$inverse_mass_matrix_rows
+    cols <- length(csv_file_info$inverse_mass_matrix)/csv_file_info$inverse_mass_matrix_rows
+    dim(csv_file_info$inverse_mass_matrix) <- c(rows,cols)
+  }
+  list(
+    model_name = csv_file_info$model,
+    method = ""sample"",
+    num_iter = num_iter,
+    id = csv_file_info$id,
+    num_warmup = csv_file_info$num_warmup,
+    num_samples = csv_file_info$num_samples,
+    save_warmup = csv_file_info$save_warmup,
+    thin =  csv_file_info$thin,
+    max_depth = csv_file_info$max_depth,
+    adapt_engaged = csv_file_info$engaged,
+    adapt_delta = csv_file_info$delta,
+    stepsize = csv_file_info$stepsize,
+    init_buffer = csv_file_info$init_buffer,
+    term_buffer = csv_file_info$term_buffer,
+    window = csv_file_info$window,
+    model_params = csv_file_info$model_params,
+    sampler_params = csv_file_info$sampler_params,
+    inverse_mass_matrix = csv_file_info$inverse_mass_matrix
+  )
 }
 
 #' Reads sampling results from the supplied CSV files. Returns a list
@@ -149,12 +150,14 @@ read_sample_csv <- function(output_files) {
   sampling_params_draws <- c()
   post_warmup_draws_array <- c()
   warmup_draws_array <- c()
+  inverse_mass_matrix = c()
   for(output_file in output_files) {
     checkmate::assert_file_exists(output_file, access = ""r"", extension = ""csv"")
     # read meta data
     if (is.null(sampling_info)) {
       sampling_info <- read_sample_info_csv(output_file)
-      inverse_mass_matrix_diag <- sampling_info$inverse_mass_matrix_diag
+      inverse_mass_matrix <- list()
+      inverse_mass_matrix[[sampling_info$id]] <- sampling_info$inverse_mass_matrix
     } else {
       csv_file_info <- read_sample_info_csv(output_file)
       # check if sampling info matches
@@ -165,64 +168,40 @@ read_sample_csv <- function(output_files) {
       }
       sampling_info$id <- c(sampling_info$id,
                             csv_file_info$id)
-      sampling_info$init <- c(sampling_info$init,
-                              csv_file_info$init)
-      sampling_info$random_seed <- c(sampling_info$random_seed,
-                                     csv_file_info$random_seed)
-      sampling_info$output_file <- c(sampling_info$output_file,
-                                     csv_file_info$output_file)
-      sampling_info$output_diagnostic_file <- c(sampling_info$output_diagnostic_file,
-                                                csv_file_info$output_diagnostic_file)
-      sampling_info$output_refresh <- c(sampling_info$output_refresh,
-                                        csv_file_info$output_refresh)
-      inverse_mass_matrix_diag <- cbind(inverse_mass_matrix_diag,
-                                        csv_file_info$inverse_mass_matrix_diag)
+      inverse_mass_matrix[[csv_file_info$id]] <- csv_file_info$inverse_mass_matrix
     }
     # read sampling data
-    if(sampling_info$sample_save_warmup == 1) {
-      num_of_draws <- sampling_info$sample_num_samples + sampling_info$sample_num_warmup
-    } else {
-      num_of_draws <- sampling_info$sample_num_samples
-    }
     draws <- utils::read.csv(output_file, header = TRUE, comment.char = ""#"")
     sampling_params_draws <- rbind(sampling_params_draws, draws[, sampling_info$sampler_params])
-    if(sampling_info$sample_save_warmup == 1) {
+    if(sampling_info$save_warmup == 1) {
       warmup_draws_array <- rbind(warmup_draws_array,
-                                  draws[1:sampling_info$sample_num_warmup, sampling_info$model_params])
+                                  draws[1:sampling_info$num_warmup/sampling_info$thin, sampling_info$model_params])
       post_warmup_draws_array <- rbind(post_warmup_draws_array,
-                                       draws[(sampling_info$sample_num_warmup+1):num_of_draws, sampling_info$model_params])
+                                       draws[(sampling_info$num_warmup/sampling_info$thin+1):sampling_info$num_iter, sampling_info$model_params])
     } else {
       warmup_draws_array <- NULL
       post_warmup_draws_array <- rbind(post_warmup_draws_array,
                                        draws[, sampling_info$model_params])
     }
 
   }
-  #inverse mass matrix is returned separately
-  sampling_info$inverse_mass_matrix_diag <- NULL
-  if(!is.null(inverse_mass_matrix_diag)) {
-    if(!is.array(inverse_mass_matrix_diag)) {
-      inverse_mass_matrix_diag <- array(inverse_mass_matrix_diag, dim = c(length(inverse_mass_matrix_diag),1))
-    }
-    dimnames(inverse_mass_matrix_diag) <- list(diagonal_elements = seq(dim(sampling_info$inverse_mass_matrix_diag)[1]),
-                                               chain_id = sampling_info$id)
-  }
   sampling_info$model_params <- repair_variable_names(sampling_info$model_params)
   num_chains <- length(sampling_info$id)
   if(!is.null(warmup_draws_array)) {
     warmup_draws_array <- posterior::as_draws_array(array(unlist(warmup_draws_array),
-                                                          dim = c(sampling_info$sample_num_warmup, num_chains, length(sampling_info$model_params)),
+                                                          dim = c(sampling_info$num_warmup/sampling_info$thin, num_chains, length(sampling_info$model_params)),
                                                           dimnames = list(NULL, NULL, sampling_info$model_params)))
   }
+  
   post_warmup_draws_array <- posterior::as_draws_array(array(unlist(post_warmup_draws_array),
-                                                             dim = c(sampling_info$sample_num_samples, num_chains, length(sampling_info$model_params)),
+                                                             dim = c(sampling_info$num_samples/sampling_info$thin, num_chains, length(sampling_info$model_params)),
                                                              dimnames = list(NULL, NULL, sampling_info$model_params)))
   sampling_params_draws <- posterior::as_draws_array(array(unlist(sampling_params_draws),
-                                                             dim = c(num_of_draws, num_chains, length(sampling_info$sampler_params)),
+                                                             dim = c(sampling_info$num_iter, num_chains, length(sampling_info$sampler_params)),
                                                              dimnames = list(NULL, NULL, sampling_info$sampler_params)))
   list(
     sampling_info = sampling_info,
-    inverse_mass_matrix_diag = inverse_mass_matrix_diag,
+    inverse_mass_matrix = inverse_mass_matrix,
     warmup = warmup_draws_array,
     post_warmup = post_warmup_draws_array,
     sampler = sampling_params_draws

---FILE: tests/testthat/resources/csv/model1-1-dense_e_metric.csv---
@@ -0,0 +1,53 @@
+# stan_version_major = 2
+# stan_version_minor = 21
+# stan_version_patch = 0
+# model = warning_model
+# method = sample (Default)
+#   sample
+#     num_samples = 1000 (Default)
+#     num_warmup = 1000 (Default)
+#     save_warmup = 0 (Default)
+#     thin = 1 (Default)
+#     adapt
+#       engaged = 1 (Default)
+#       gamma = 0.050000000000000003 (Default)
+#       delta = 0.80000000000000004 (Default)
+#       kappa = 0.75 (Default)
+#       t0 = 10 (Default)
+#       init_buffer = 75 (Default)
+#       term_buffer = 50 (Default)
+#       window = 25 (Default)
+#     algorithm = hmc (Default)
+#       hmc
+#         engine = nuts (Default)
+#           nuts
+#             max_depth = 5
+#         metric = dense_e
+#         metric_file =  (Default)
+#         stepsize = 1 (Default)
+#         stepsize_jitter = 0 (Default)
+# id = 1
+# data
+#   file = /tmp/RtmpwuXj7q/standata-626e1446a4cd.dat
+# init = 2 (Default)
+# random
+#   seed = 832246860
+# output
+#   file = /tmp/RtmpwuXj7q/warning-201911291346-1-563d96.csv
+#   diagnostic_file =  (Default)
+#   refresh = 100 (Default)
+lp__,accept_stat__,stepsize__,treedepth__,n_leapfrog__,divergent__,energy__,mu,tau,theta.1,theta.2,theta.3,theta.4,theta.5,theta.6,theta.7,theta.8
+# Adaptation terminated
+# Step size = 0.11757
+# Elements of inverse mass matrix:
+# 10.2742, -0.189148, 5.92065, 8.2658, 10.9931, 8.67196, 9.75007, 8.30008, 6.3396, 8.75422
+# -0.189148, 0.552614, 2.28054, 0.587285, -0.557112, 0.0689745, -1.06614, -0.502288, 1.49863, 0.450733
+# 5.92065, 2.28054, 52.7011, 7.89278, 3.9639, 5.71556, 2.16445, 1.88834, 13.8962, 15.1166
+# 8.2658, 0.587285, 7.89278, 30.7924, 8.39762, 8.51489, 8.27253, 9.96521, 7.58758, 7.8403
+# 10.9931, -0.557112, 3.9639, 8.39762, 39.6164, 9.88103, 9.62453, 9.80744, 6.28594, 6.77034
+# 8.67196, 0.0689745, 5.71556, 8.51489, 9.88103, 29.6702, 8.5937, 8.3289, 8.76294, 5.63637
+# 9.75007, -1.06614, 2.16445, 8.27253, 9.62453, 8.5937, 26.3294, 10.1908, 2.76266, 4.56938
+# 8.30008, -0.502288, 1.88834, 9.96521, 9.80744, 8.3289, 10.1908, 26.5846, 3.7247, 4.26521
+# 6.3396, 1.49863, 13.8962, 7.58758, 6.28594, 8.76294, 2.76266, 3.7247, 28.8872, 8.43035
+# 8.75422, 0.450733, 15.1166, 7.8403, 6.77034, 5.63637, 4.56938, 4.26521, 8.43035, 42.5438
+-6.22318,0.789257,0.11757,3,7,0,10.0181,3.451,0.646028,3.6284,4.4898,4.54992,3.50833,2.93186,3.77877,4.01059,1.97369

---FILE: tests/testthat/resources/csv/model1-2-dense_e_metric.csv---
@@ -0,0 +1,53 @@
+# stan_version_major = 2
+# stan_version_minor = 21
+# stan_version_patch = 0
+# model = warning_model
+# method = sample (Default)
+#   sample
+#     num_samples = 1000 (Default)
+#     num_warmup = 1000 (Default)
+#     save_warmup = 0 (Default)
+#     thin = 1 (Default)
+#     adapt
+#       engaged = 1 (Default)
+#       gamma = 0.050000000000000003 (Default)
+#       delta = 0.80000000000000004 (Default)
+#       kappa = 0.75 (Default)
+#       t0 = 10 (Default)
+#       init_buffer = 75 (Default)
+#       term_buffer = 50 (Default)
+#       window = 25 (Default)
+#     algorithm = hmc (Default)
+#       hmc
+#         engine = nuts (Default)
+#           nuts
+#             max_depth = 5
+#         metric = dense_e
+#         metric_file =  (Default)
+#         stepsize = 1 (Default)
+#         stepsize_jitter = 0 (Default)
+# id = 2
+# data
+#   file = /tmp/RtmpwuXj7q/standata-626e2e1de93.dat
+# init = 2 (Default)
+# random
+#   seed = 1742584894
+# output
+#   file = /tmp/RtmpwuXj7q/warning-201911291802-1-b9bf01.csv
+#   diagnostic_file =  (Default)
+#   refresh = 100 (Default)
+lp__,accept_stat__,stepsize__,treedepth__,n_leapfrog__,divergent__,energy__,mu,tau,theta.1,theta.2,theta.3,theta.4,theta.5,theta.6,theta.7,theta.8
+# Adaptation terminated
+# Step size = 0.232778
+# Elements of inverse mass matrix:
+# 11.08, -0.305763, 5.27013, 7.33046, 7.31263, 6.93229, 10.1923, 7.46852, 7.51557, 7.78791
+# -0.305763, 0.678461, 1.70598, 0.337143, -0.69887, 0.423236, -0.974023, -0.605539, 1.83794, 0.0780934
+# 5.27013, 1.70598, 36.2726, 7.9386, 3.88642, 12.0214, 4.2487, 3.84886, 12.9738, 4.34037
+# 7.33046, 0.337143, 7.9386, 23.9878, 4.93047, 5.76139, 7.34008, 7.78631, 6.79063, 8.13132
+# 7.31263, -0.69887, 3.88642, 4.93047, 25.3662, 7.2269, 7.5408, 8.18066, 5.77239, 7.53072
+# 6.93229, 0.423236, 12.0214, 5.76139, 7.2269, 24.0619, 7.24315, 7.194, 10.1647, 5.61617
+# 10.1923, -0.974023, 4.2487, 7.34008, 7.5408, 7.24315, 26.2403, 6.91029, 1.26095, 4.72335
+# 7.46852, -0.605539, 3.84886, 7.78631, 8.18066, 7.194, 6.91029, 30.2862, 5.61914, 8.10162
+# 7.51557, 1.83794, 12.9738, 6.79063, 5.77239, 10.1647, 1.26095, 5.61914, 34.5498, 7.75486
+# 7.78791, 0.0780934, 4.34037, 8.13132, 7.53072, 5.61617, 4.72335, 8.10162, 7.75486, 35.6602
+-12.1669,0.771978,0.232778,3,7,0,19.0882,5.46421,2.63041,5.84162,5.91101,3.42499,6.52557,7.03691,8.51128,5.55333,2.67202

---FILE: tests/testthat/resources/csv/model1-3-diff_args.csv---
@@ -11,8 +11,8 @@
 #     adapt
 #       engaged = 1 (Default)
 #       gamma = 0.050000000000000003 (Default)
-#       delta = 0.80000000000000004 (Default)
-#       kappa = 1.75 (Default)
+#       delta = 0.90000000000000004 (Default)
+#       kappa = 0.75 (Default)
 #       t0 = 10 (Default)
 #       init_buffer = 75 (Default)
 #       term_buffer = 50 (Default)
@@ -43,8 +43,8 @@ lp__,accept_stat__,stepsize__,treedepth__,n_leapfrog__,divergent__,energy__,mu,s
 # Diagonal elements of inverse mass matrix:
 # 1.00098, 0.068748
 -19.4938,0.953779,0.712907,2,3,0,19.4971,8.11498,7.4563
-# 
+#
 #  Elapsed Time: 0.038029 seconds (Warm-up)
 #                0.030711 seconds (Sampling)
 #                0.06874 seconds (Total)
-# 
+#

---FILE: tests/testthat/resources/csv/model1-3-diff_data_file.csv---
@@ -1,50 +0,0 @@
-# stan_version_major = 2
-# stan_version_minor = 21
-# stan_version_patch = 0
-# model = model1
-# method = sample (Default)
-#   sample
-#     num_samples = 100 (Default)
-#     num_warmup = 100 (Default)
-#     save_warmup = 1
-#     thin = 1 (Default)
-#     adapt
-#       engaged = 1 (Default)
-#       gamma = 0.050000000000000003 (Default)
-#       delta = 0.80000000000000004 (Default)
-#       kappa = 0.75 (Default)
-#       t0 = 10 (Default)
-#       init_buffer = 75 (Default)
-#       term_buffer = 50 (Default)
-#       window = 25 (Default)
-#     algorithm = hmc (Default)
-#       hmc
-#         engine = nuts (Default)
-#           nuts
-#             max_depth = 5
-#         metric = diag_e (Default)
-#         metric_file =  (Default)
-#         stepsize = 1 (Default)
-#         stepsize_jitter = 0 (Default)
-# id = 1
-# data
-#   file = /tmp/RtmpcXhiID/standata.json
-# init = 2 (Default)
-# random
-#   seed = 1927315875
-# output
-#   file = /tmp/RtmpcXhiID/tests-201911231643-1-3613bb.csv
-#   diagnostic_file =  (Default)
-#   refresh = 100 (Default)
-lp__,accept_stat__,stepsize__,treedepth__,n_leapfrog__,divergent__,energy__,mu,sigma
--32.3122,1,0.125,2,3,0,43.1912,-0.780945,2.9559
-# Adaptation terminated
-# Step size = 0.712907
-# Diagonal elements of inverse mass matrix:
-# 1.00098, 0.068748
--19.4938,0.953779,0.712907,2,3,0,19.4971,8.11498,7.4563
-# 
-#  Elapsed Time: 0.038029 seconds (Warm-up)
-#                0.030711 seconds (Sampling)
-#                0.06874 seconds (Total)
-# 

---FILE: tests/testthat/resources/csv/model1-3-diff_stan_version.csv---
@@ -1,50 +0,0 @@
-# stan_version_major = 2
-# stan_version_minor = 20
-# stan_version_patch = 0
-# model = model1
-# method = sample (Default)
-#   sample
-#     num_samples = 100 (Default)
-#     num_warmup = 100 (Default)
-#     save_warmup = 1
-#     thin = 1 (Default)
-#     adapt
-#       engaged = 1 (Default)
-#       gamma = 0.050000000000000003 (Default)
-#       delta = 0.80000000000000004 (Default)
-#       kappa = 0.75 (Default)
-#       t0 = 10 (Default)
-#       init_buffer = 75 (Default)
-#       term_buffer = 50 (Default)
-#       window = 25 (Default)
-#     algorithm = hmc (Default)
-#       hmc
-#         engine = nuts (Default)
-#           nuts
-#             max_depth = 5
-#         metric = diag_e (Default)
-#         metric_file =  (Default)
-#         stepsize = 1 (Default)
-#         stepsize_jitter = 0 (Default)
-# id = 1
-# data
-#   file = /tmp/RtmpcXhiID/standata-124764cd0999.json
-# init = 2 (Default)
-# random
-#   seed = 1927315875
-# output
-#   file = /tmp/RtmpcXhiID/tests-201911231643-1-3613bb.csv
-#   diagnostic_file =  (Default)
-#   refresh = 100 (Default)
-lp__,accept_stat__,stepsize__,treedepth__,n_leapfrog__,divergent__,energy__,mu,sigma
--32.3122,1,0.125,2,3,0,43.1912,-0.780945,2.9559
-# Adaptation terminated
-# Step size = 0.712907
-# Diagonal elements of inverse mass matrix:
-# 1.00098, 0.068748
--19.4938,0.953779,0.712907,2,3,0,19.4971,8.11498,7.4563
-# 
-#  Elapsed Time: 0.038029 seconds (Warm-up)
-#                0.030711 seconds (Sampling)
-#                0.06874 seconds (Total)
-# 

---FILE: tests/testthat/test-csv.R---
@@ -1,172 +1,226 @@
 context(""read-sample-csv"")
 
 if (not_on_cran()) {
-
+  set_cmdstan_path()
+  fit_logistic_thin_1 <- testing_fit(""logistic"", method = ""sample"",
+                          seed = 123, num_chains = 2, num_samples = 1000, num_warmup = 1000, thin = 1)
+  fit_logistic_thin_1_with_warmup <- testing_fit(""logistic"", method = ""sample"",
+                          seed = 123, num_chains = 2, num_samples = 1000, num_warmup = 1000, thin = 1, save_warmup = 1)
+  fit_logistic_thin_10 <- testing_fit(""logistic"", method = ""sample"",
+                          seed = 123, num_chains = 2, num_samples = 1000, num_warmup = 1000, thin = 10, save_warmup = 0)
+  fit_logistic_thin_10_with_warmup <- testing_fit(""logistic"", method = ""sample"",
+                          seed = 123, num_chains = 2, num_samples = 1000, num_warmup = 1000, thin = 10, save_warmup = 1)
 }
 
-test_that(""read_sample_csv() fails for different stan version"", {
-  skip_on_cran()
-  csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-warmup.csv""),
-                 test_path(""resources"", ""csv"", ""model1-3-diff_stan_version.csv""))
-  expect_error(read_sample_csv(csv_files),
-               ""Supplied CSV files were not generated with the same version of Cmdstan!"")
-})
-
-test_that(""read_sample_csv() fails for different model names"", {
-  skip_on_cran()
-  csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-warmup.csv""),
-                 test_path(""resources"", ""csv"", ""model1-3-diff_name.csv""))
-  expect_error(read_sample_csv(csv_files),
-               ""Supplied CSV files were not generated wtih the same model!"")
-})
-
-test_that(""read_sample_csv() fails for different data file names names"", {
-  skip_on_cran()
-  csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-warmup.csv""),
-                 test_path(""resources"", ""csv"", ""model1-3-diff_data_file.csv""))
-  expect_error(read_sample_csv(csv_files),
-               ""Supplied CSV files have samples from chains run with non-matching data!"")
-})
-
-test_that(""read_sample_csv() fails for different sampling settings"", {
-  skip_on_cran()
-  csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-warmup.csv""),
-                 test_path(""resources"", ""csv"", ""model1-3-diff_args.csv""))
-  expect_error(read_sample_csv(csv_files),
-               ""Supplied CSV files do not match in all sampling settings!"")
-})
-
-test_that(""read_sample_csv() fails for different parameters"", {
-  skip_on_cran()
-  csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-warmup.csv""),
-                 test_path(""resources"", ""csv"", ""model1-3-diff_params.csv""))
-  expect_error(read_sample_csv(csv_files),
-               ""Supplied CSV files have samples for different parameters!"")
-})
-
-test_that(""read_sample_csv() fails if the file does not exist"", {
-  skip_on_cran()
-  csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-doesntexist.csv""))
-  expect_error(read_sample_csv(csv_files),
-               ""Assertion on 'output_file' failed: File does not exist: 'resources/csv/model1-1-doesntexist.csv'."")
-})
-
-test_that(""read_sample_csv() fails for non-sampling csv"", {
-  skip_on_cran()
-  csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-nonsampling.csv""))
-  expect_error(read_sample_csv(csv_files),
-               ""Supplied CSV file was not generated with sampling. Consider using read_optim_csv or read_vb_csv!"")
-})
-
-test_that(""read_sample_csv() fails with empty csv file"", {
-  skip_on_cran()
-  file_path <- test_path(""resources"", ""csv"", ""empty.csv"")
-  file.create(file_path)
-  expect_error(read_sample_csv(file_path),
-               ""Supplied CSV file is corrupt!"")
-  file.remove(file_path)
-})
-
-test_that(""read_sample_csv() fails with the no params listed"", {
-  skip_on_cran()
-  file_path <- test_path(""resources"", ""csv"", ""model1-3-no-params.csv"")
-  expect_error(read_sample_csv(file_path),
-               ""no lines available in input"")
-})
-
-test_that(""read_sample_csv() matches rstan::read_stan_csv()"", {
-  skip_on_cran()
-  csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-warmup.csv""),
-                 test_path(""resources"", ""csv"", ""model1-2-warmup.csv""))
-
-  draws_array <- readRDS(test_path(""answers"", ""rstan-read-stan-csv-no-warmup.rds""))
-  draws_array <- posterior::as_draws_array(draws_array)
-  csv_output <- read_sample_csv(csv_files)
-  expect_equal(csv_output$post_warmup[,, ""mu""],
-               draws_array[,,""mu""])
-  expect_equal(csv_output$post_warmup[,, ""sigma""],
-               draws_array[,,""sigma""])
-  expect_equal(csv_output$post_warmup[,, ""lp__""],
-               draws_array[,,""lp__""])
-})
-
-test_that(""read_sample_csv() matches rstan::read_stan_csv() with save_warmup"", {
-  skip_on_cran()
-  csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-warmup.csv""),
-                 test_path(""resources"", ""csv"", ""model1-2-warmup.csv""))
-
-  draws_array <- readRDS(test_path(""answers"", ""rstan-read-stan-csv-warmup.rds""))
-  draws_array <- posterior::as_draws_array(draws_array)
-  csv_output <- read_sample_csv(csv_files)
-
-  warmup_iter <- csv_output$sampling_info$sample_num_warmup
-  all_iter <- warmup_iter + csv_output$sampling_info$sample_num_samples
-
-  draws_array_post_warmup <- draws_array[(warmup_iter+1):all_iter,,]
-  draws_array_warmup <- draws_array[1:warmup_iter,,]
-
-  expect_equal(posterior::extract_one_variable_matrix(csv_output$post_warmup, ""mu""),
-               posterior::extract_one_variable_matrix(draws_array_post_warmup, ""mu""))
-  expect_equal(posterior::extract_one_variable_matrix(csv_output$post_warmup, ""sigma""),
-               posterior::extract_one_variable_matrix(draws_array_post_warmup, ""sigma""))
-  expect_equal(posterior::extract_one_variable_matrix(csv_output$post_warmup, ""lp__""),
-               posterior::extract_one_variable_matrix(draws_array_post_warmup, ""lp__""))
-  expect_equal(posterior::extract_one_variable_matrix(csv_output$warmup, ""mu""),
-               posterior::extract_one_variable_matrix(draws_array_warmup, ""mu""))
-  expect_equal(posterior::extract_one_variable_matrix(csv_output$warmup, ""sigma""),
-               posterior::extract_one_variable_matrix(draws_array_warmup, ""sigma""))
-  expect_equal(posterior::extract_one_variable_matrix(csv_output$warmup, ""lp__""),
-               posterior::extract_one_variable_matrix(draws_array_warmup, ""lp__""))
-})
-
-test_that(""read_sample_csv() matches rstan::read_stan_csv() for csv file without warmup"", {
-  skip_on_cran()
-  csv_files <- c(test_path(""resources"", ""csv"", ""model1-3-no-warmup.csv""))
-
-  draws_array <- readRDS(test_path(""answers"", ""rstan-read-stan-csv-no-warmup-file.rds""))
-  draws_array <- posterior::as_draws_array(draws_array)
-  csv_output <- read_sample_csv(csv_files)
-
-  expect_equal(posterior::extract_one_variable_matrix(csv_output$post_warmup, ""mu""),
-               posterior::extract_one_variable_matrix(draws_array, ""mu""))
-  expect_equal(posterior::extract_one_variable_matrix(csv_output$post_warmup, ""sigma""),
-               posterior::extract_one_variable_matrix(draws_array, ""sigma""))
-  expect_equal(posterior::extract_one_variable_matrix(csv_output$post_warmup, ""lp__""),
-               posterior::extract_one_variable_matrix(draws_array, ""lp__""))
-})
-
-test_that(""read_sample_csv() returns correct diagonal of inverse mass matrix"", {
+# test_that(""read_sample_csv() fails for different model names"", {
+#   skip_on_cran()
+#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-warmup.csv""),
+#                  test_path(""resources"", ""csv"", ""model1-3-diff_name.csv""))
+#   expect_error(read_sample_csv(csv_files),
+#                ""Supplied CSV files were not generated wtih the same model!"")
+# })
+
+# test_that(""read_sample_csv() fails for different sampling settings"", {
+#   skip_on_cran()
+#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-warmup.csv""),
+#                  test_path(""resources"", ""csv"", ""model1-3-diff_args.csv""))
+#   expect_error(read_sample_csv(csv_files),
+#                ""Supplied CSV files do not match in all sampling settings!"")
+# })
+
+# test_that(""read_sample_csv() fails for different parameters"", {
+#   skip_on_cran()
+#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-warmup.csv""),
+#                  test_path(""resources"", ""csv"", ""model1-3-diff_params.csv""))
+#   expect_error(read_sample_csv(csv_files),
+#                ""Supplied CSV files have samples for different parameters!"")
+# })
+
+# test_that(""read_sample_csv() fails if the file does not exist"", {
+#   skip_on_cran()
+#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-doesntexist.csv""))
+#   expect_error(read_sample_csv(csv_files),
+#                ""Assertion on 'output_file' failed: File does not exist: 'resources/csv/model1-1-doesntexist.csv'."")
+# })
+
+# test_that(""read_sample_csv() fails for non-sampling csv"", {
+#   skip_on_cran()
+#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-nonsampling.csv""))
+#   expect_error(read_sample_csv(csv_files),
+#                ""Supplied CSV file was not generated with sampling. Consider using read_optim_csv or read_vb_csv!"")
+# })
+
+# test_that(""read_sample_csv() fails with empty csv file"", {
+#   skip_on_cran()
+#   file_path <- test_path(""resources"", ""csv"", ""empty.csv"")
+#   file.create(file_path)
+#   expect_error(read_sample_csv(file_path),
+#                ""Supplied CSV file is corrupt!"")
+#   file.remove(file_path)
+# })
+
+# test_that(""read_sample_csv() fails with the no params listed"", {
+#   skip_on_cran()
+#   file_path <- test_path(""resources"", ""csv"", ""model1-3-no-params.csv"")
+#   expect_error(read_sample_csv(file_path),
+#                ""no lines available in input"")
+# })
+
+# test_that(""read_sample_csv() matches rstan::read_stan_csv()"", {
+#   skip_on_cran()
+#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-warmup.csv""),
+#                  test_path(""resources"", ""csv"", ""model1-2-warmup.csv""))
+
+#   draws_array <- readRDS(test_path(""answers"", ""rstan-read-stan-csv-no-warmup.rds""))
+#   draws_array <- posterior::as_draws_array(draws_array)
+#   csv_output <- read_sample_csv(csv_files)
+#   expect_equal(csv_output$post_warmup[,, ""mu""],
+#                draws_array[,,""mu""])
+#   expect_equal(csv_output$post_warmup[,, ""sigma""],
+#                draws_array[,,""sigma""])
+#   expect_equal(csv_output$post_warmup[,, ""lp__""],
+#                draws_array[,,""lp__""])
+# })
+
+# test_that(""read_sample_csv() matches rstan::read_stan_csv() with save_warmup"", {
+#   skip_on_cran()
+#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-warmup.csv""),
+#                  test_path(""resources"", ""csv"", ""model1-2-warmup.csv""))
+
+#   draws_array <- readRDS(test_path(""answers"", ""rstan-read-stan-csv-warmup.rds""))
+#   draws_array <- posterior::as_draws_array(draws_array)
+#   csv_output <- read_sample_csv(csv_files)
+
+#   warmup_iter <- csv_output$sampling_info$num_warmup
+#   num_iter <- csv_output$sampling_info$num_iter
+
+#   draws_array_post_warmup <- draws_array[(warmup_iter+1):num_iter,,]
+#   draws_array_warmup <- draws_array[1:warmup_iter,,]
+
+#   expect_equal(posterior::extract_one_variable_matrix(csv_output$post_warmup, ""mu""),
+#                posterior::extract_one_variable_matrix(draws_array_post_warmup, ""mu""))
+#   expect_equal(posterior::extract_one_variable_matrix(csv_output$post_warmup, ""sigma""),
+#                posterior::extract_one_variable_matrix(draws_array_post_warmup, ""sigma""))
+#   expect_equal(posterior::extract_one_variable_matrix(csv_output$post_warmup, ""lp__""),
+#                posterior::extract_one_variable_matrix(draws_array_post_warmup, ""lp__""))
+#   expect_equal(posterior::extract_one_variable_matrix(csv_output$warmup, ""mu""),
+#                posterior::extract_one_variable_matrix(draws_array_warmup, ""mu""))
+#   expect_equal(posterior::extract_one_variable_matrix(csv_output$warmup, ""sigma""),
+#                posterior::extract_one_variable_matrix(draws_array_warmup, ""sigma""))
+#   expect_equal(posterior::extract_one_variable_matrix(csv_output$warmup, ""lp__""),
+#                posterior::extract_one_variable_matrix(draws_array_warmup, ""lp__""))
+# })
+
+# test_that(""read_sample_csv() matches rstan::read_stan_csv() for csv file without warmup"", {
+#   skip_on_cran()
+#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-2-no-warmup.csv""))
+
+#   draws_array <- readRDS(test_path(""answers"", ""rstan-read-stan-csv-no-warmup-file.rds""))
+#   draws_array <- posterior::as_draws_array(draws_array)
+#   csv_output <- read_sample_csv(csv_files)
+
+#   expect_equal(posterior::extract_one_variable_matrix(csv_output$post_warmup, ""mu""),
+#                posterior::extract_one_variable_matrix(draws_array, ""mu""))
+#   expect_equal(posterior::extract_one_variable_matrix(csv_output$post_warmup, ""sigma""),
+#                posterior::extract_one_variable_matrix(draws_array, ""sigma""))
+#   expect_equal(posterior::extract_one_variable_matrix(csv_output$post_warmup, ""lp__""),
+#                posterior::extract_one_variable_matrix(draws_array, ""lp__""))
+# })
+
+# test_that(""read_sample_csv() returns correct diagonal of inverse mass matrix"", {
+#   skip_on_cran()
+#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-2-no-warmup.csv""))
+#   csv_output <- read_sample_csv(csv_files)
+#   expect_equal(as.vector(csv_output$inverse_mass_matrix[[2]]),
+#                c(0.909635, 0.066384))
+#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-warmup.csv""),test_path(""resources"", ""csv"", ""model1-2-warmup.csv""))
+#   csv_output <- read_sample_csv(csv_files)
+#   expect_equal(as.vector(csv_output$inverse_mass_matrix[[1]]),
+#                c(1.00098, 0.068748))
+#   expect_equal(as.vector(csv_output$inverse_mass_matrix[[2]]),
+#                c(0.909635, 0.066384))
+# })
+
+# test_that(""read_sample_csv() returns correct dense inverse mass matrix"", {
+#   skip_on_cran()
+#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-dense_e_metric.csv""))
+#   csv_output <- read_sample_csv(csv_files)
+#   expect_equal(as.vector(csv_output$inverse_mass_matrix[[1]]),
+#                c(10.2742, -0.189148, 5.92065, 8.2658, 10.9931, 8.67196, 9.75007, 8.30008, 6.3396, 8.75422,
+#                 -0.189148, 0.552614, 2.28054, 0.587285, -0.557112, 0.0689745, -1.06614, -0.502288, 1.49863, 0.450733,
+#                 5.92065, 2.28054, 52.7011, 7.89278, 3.9639, 5.71556, 2.16445, 1.88834, 13.8962, 15.1166,
+#                 8.2658, 0.587285, 7.89278, 30.7924, 8.39762, 8.51489, 8.27253, 9.96521, 7.58758, 7.8403,
+#                 10.9931, -0.557112, 3.9639, 8.39762, 39.6164, 9.88103, 9.62453, 9.80744, 6.28594, 6.77034,
+#                 8.67196, 0.0689745, 5.71556, 8.51489, 9.88103, 29.6702, 8.5937, 8.3289, 8.76294, 5.63637,
+#                 9.75007, -1.06614, 2.16445, 8.27253, 9.62453, 8.5937, 26.3294, 10.1908, 2.76266, 4.56938,
+#                 8.30008, -0.502288, 1.88834, 9.96521, 9.80744, 8.3289, 10.1908, 26.5846, 3.7247, 4.26521,
+#                 6.3396, 1.49863, 13.8962, 7.58758, 6.28594, 8.76294, 2.76266, 3.7247, 28.8872, 8.43035,
+#                 8.75422, 0.450733, 15.1166, 7.8403, 6.77034, 5.63637, 4.56938, 4.26521, 8.43035, 42.5438))
+# })
+
+# test_that(""read_sample_csv() returns correct dense inverse mass matrix for 2 csv files "", {
+#   skip_on_cran()
+#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-dense_e_metric.csv""),
+#                  test_path(""resources"", ""csv"", ""model1-2-dense_e_metric.csv""))
+#   csv_output <- read_sample_csv(csv_files)
+#   expect_equal(as.vector(csv_output$inverse_mass_matrix[[1]]),
+#              c(10.2742, -0.189148, 5.92065, 8.2658, 10.9931, 8.67196, 9.75007, 8.30008, 6.3396, 8.75422,
+#                 -0.189148, 0.552614, 2.28054, 0.587285, -0.557112, 0.0689745, -1.06614, -0.502288, 1.49863, 0.450733,
+#                 5.92065, 2.28054, 52.7011, 7.89278, 3.9639, 5.71556, 2.16445, 1.88834, 13.8962, 15.1166,
+#                 8.2658, 0.587285, 7.89278, 30.7924, 8.39762, 8.51489, 8.27253, 9.96521, 7.58758, 7.8403,
+#                 10.9931, -0.557112, 3.9639, 8.39762, 39.6164, 9.88103, 9.62453, 9.80744, 6.28594, 6.77034,
+#                 8.67196, 0.0689745, 5.71556, 8.51489, 9.88103, 29.6702, 8.5937, 8.3289, 8.76294, 5.63637,
+#                 9.75007, -1.06614, 2.16445, 8.27253, 9.62453, 8.5937, 26.3294, 10.1908, 2.76266, 4.56938,
+#                 8.30008, -0.502288, 1.88834, 9.96521, 9.80744, 8.3289, 10.1908, 26.5846, 3.7247, 4.26521,
+#                 6.3396, 1.49863, 13.8962, 7.58758, 6.28594, 8.76294, 2.76266, 3.7247, 28.8872, 8.43035,
+#                 8.75422, 0.450733, 15.1166, 7.8403, 6.77034, 5.63637, 4.56938, 4.26521, 8.43035, 42.5438))
+#   expect_equal(as.vector(csv_output$inverse_mass_matrix[[2]]),
+#              c( 11.08, -0.305763, 5.27013, 7.33046, 7.31263, 6.93229, 10.1923, 7.46852, 7.51557, 7.78791,
+#                 -0.305763, 0.678461, 1.70598, 0.337143, -0.69887, 0.423236, -0.974023, -0.605539, 1.83794, 0.0780934,
+#                 5.27013, 1.70598, 36.2726, 7.9386, 3.88642, 12.0214, 4.2487, 3.84886, 12.9738, 4.34037,
+#                 7.33046, 0.337143, 7.9386, 23.9878, 4.93047, 5.76139, 7.34008, 7.78631, 6.79063, 8.13132,
+#                 7.31263, -0.69887, 3.88642, 4.93047, 25.3662, 7.2269, 7.5408, 8.18066, 5.77239, 7.53072,
+#                 6.93229, 0.423236, 12.0214, 5.76139, 7.2269, 24.0619, 7.24315, 7.194, 10.1647, 5.61617,
+#                 10.1923, -0.974023, 4.2487, 7.34008, 7.5408, 7.24315, 26.2403, 6.91029, 1.26095, 4.72335,
+#                 7.46852, -0.605539, 3.84886, 7.78631, 8.18066, 7.194, 6.91029, 30.2862, 5.61914, 8.10162,
+#                 7.51557, 1.83794, 12.9738, 6.79063, 5.77239, 10.1647, 1.26095, 5.61914, 34.5498, 7.75486,
+#                 7.78791, 0.0780934, 4.34037, 8.13132, 7.53072, 5.61617, 4.72335, 8.10162, 7.75486, 35.6602))
+# })
+
+
+# test_that(""read_sample_csv() matches rstan::read_stan_csv() for csv file without warmup"", {
+#   skip_on_cran()
+#   csv_files <- c(test_path(""resources"", ""csv"", ""model1-2-warmup.csv""))
+
+#   sampler_params <- readRDS(test_path(""answers"", ""rstan-read-stan-csv-sampler-params.rds""))
+#   sampler_params <- posterior::as_draws_array(sampler_params[[1]])
+#   csv_output <- read_sample_csv(csv_files)
+#   expect_equal(posterior::extract_one_variable_matrix(csv_output$sampler, ""divergent__""),
+#                posterior::extract_one_variable_matrix(sampler_params, ""divergent__""))
+#   expect_equal(posterior::extract_one_variable_matrix(csv_output$sampler, ""accept_stat__""),
+#                posterior::extract_one_variable_matrix(sampler_params, ""accept_stat__""))
+#   expect_equal(posterior::extract_one_variable_matrix(csv_output$sampler, ""treedepth__""),
+#                posterior::extract_one_variable_matrix(sampler_params, ""treedepth__""))
+#   expect_equal(posterior::extract_one_variable_matrix(csv_output$sampler, ""stepsize__""),
+#                posterior::extract_one_variable_matrix(sampler_params, ""stepsize__""))
+#   expect_equal(posterior::extract_one_variable_matrix(csv_output$sampler, ""n_leapfrog__""),
+#                posterior::extract_one_variable_matrix(sampler_params, ""n_leapfrog__""))
+#   expect_equal(posterior::extract_one_variable_matrix(csv_output$sampler, ""energy__""),
+#                posterior::extract_one_variable_matrix(sampler_params, ""energy__""))
+# })
+
+test_that(""read_sample_csv() works with thin"", {
   skip_on_cran()
-  csv_files <- c(test_path(""resources"", ""csv"", ""model1-3-no-warmup.csv""))
-  csv_output <- read_sample_csv(csv_files)
-  expect_equal(as.vector(csv_output$inverse_mass_matrix_diag),
-               c(0.909635, 0.066384))
-  csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-warmup.csv""),test_path(""resources"", ""csv"", ""model1-2-warmup.csv""))
-  csv_output <- read_sample_csv(csv_files)
-  expect_equal(as.vector(csv_output$inverse_mass_matrix_diag),
-               c(1.00098, 0.068748,
-                 0.909635, 0.066384))
-})
 
-test_that(""read_sample_csv() matches rstan::read_stan_csv() for csv file without warmup"", {
-  skip_on_cran()
-  csv_files <- c(test_path(""resources"", ""csv"", ""model1-2-warmup.csv""))
-
-  sampler_params <- readRDS(test_path(""answers"", ""rstan-read-stan-csv-sampler-params.rds""))
-  sampler_params <- posterior::as_draws_array(sampler_params[[1]])
-  csv_output <- read_sample_csv(csv_files)
-  expect_equal(posterior::extract_one_variable_matrix(csv_output$sampler, ""divergent__""),
-               posterior::extract_one_variable_matrix(sampler_params, ""divergent__""))
-  expect_equal(posterior::extract_one_variable_matrix(csv_output$sampler, ""accept_stat__""),
-               posterior::extract_one_variable_matrix(sampler_params, ""accept_stat__""))
-  expect_equal(posterior::extract_one_variable_matrix(csv_output$sampler, ""treedepth__""),
-               posterior::extract_one_variable_matrix(sampler_params, ""treedepth__""))
-  expect_equal(posterior::extract_one_variable_matrix(csv_output$sampler, ""stepsize__""),
-               posterior::extract_one_variable_matrix(sampler_params, ""stepsize__""))
-  expect_equal(posterior::extract_one_variable_matrix(csv_output$sampler, ""n_leapfrog__""),
-               posterior::extract_one_variable_matrix(sampler_params, ""n_leapfrog__""))
-  expect_equal(posterior::extract_one_variable_matrix(csv_output$sampler, ""energy__""),
-               posterior::extract_one_variable_matrix(sampler_params, ""energy__""))
+  csv_output_1 <- read_sample_csv(fit_logistic_thin_1$output_files())
+  csv_output_10 <- read_sample_csv(fit_logistic_thin_10$output_files())
+  csv_output_1_with_warmup <- read_sample_csv(fit_logistic_thin_1_with_warmup$output_files())
+  csv_output_10_with_warmup <- read_sample_csv(fit_logistic_thin_10_with_warmup$output_files())
+  expect_equal(dim(csv_output_1$post_warmup), c(1000, 2, 5))
+  expect_equal(dim(csv_output_10$post_warmup), c(100, 2, 5))
+  expect_equal(dim(csv_output_1_with_warmup$post_warmup), c(1000, 2, 5))
+  expect_equal(dim(csv_output_1_with_warmup$warmup), c(1000, 2, 5))
+  expect_equal(dim(csv_output_10_with_warmup$post_warmup), c(100, 2, 5))
+  expect_equal(dim(csv_output_10_with_warmup$warmup), c(100, 2, 5))
 })
 
-",True,False,Data / Input Handling,6
stan-dev,cmdstanr,bf0cb07918658fb34d86ff0a374f78dad87b393e,Ben,bbbales2@gmail.com,2019-11-26T17:29:46Z,Ben,bbbales2@gmail.com,2019-11-26T17:29:46Z,"Updated extensions in data file checks to "".dat"" instead of "".json"" (Issue #96)",tests/testthat/test-fit-shared.R,False,True,True,False,3,3,6,"---FILE: tests/testthat/test-fit-shared.R---
@@ -96,16 +96,16 @@ test_that(""saving data file works"", {
   for (method in all_methods) {
     fit <- fits[[method]]
     old_path <- fit$data_file()
-    checkmate::expect_file_exists(old_path, extension = ""json"")
+    checkmate::expect_file_exists(old_path, extension = ""dat"")
 
     expect_message(
       path <- fit$save_data_file(tempdir(), basename = NULL,
                                  timestamp = FALSE, random = FALSE),
       ""Moved data file and set internal path""
     )
-    checkmate::expect_file_exists(path, extension = ""json"")
+    checkmate::expect_file_exists(path, extension = ""dat"")
     expect_true(file.size(path) > 0)
-    expect_equal(basename(path), ""logistic.json"")
+    expect_equal(basename(path), ""logistic.dat"")
 
     expect_false(file.exists(old_path))
     expect_equal(fit$data_file(), path)",True,False,Implementation / Logic,6
stan-dev,cmdstanr,0bf73d32a951c8750dcc90b3c048814fa9fac55c,Ben,bbbales2@gmail.com,2019-11-25T20:34:59Z,Ben,bbbales2@gmail.com,2019-11-25T20:35:08Z,Add rstan as import (Issue #96),DESCRIPTION;R/model.R,False,True,True,False,2,2,4,"---FILE: DESCRIPTION---
@@ -24,12 +24,12 @@ Imports:
     checkmate,
     posterior (>= 0.0.1),
     processx,
+    rstan,
     R6
 Suggests: 
     jsonlite (>= 1.2.0),
     knitr,
     rmarkdown,
-    rstan,
     testthat (>= 2.1.0)
 VignetteBuilder: knitr
 Remotes:  

---FILE: R/model.R---
@@ -665,7 +665,7 @@ process_data <- function(data) {
     path <- absolute_path(data)
   } else if (is.list(data) && !is.data.frame(data)) {
     path <- tempfile(pattern = ""standata-"", fileext = "".dat"")
-    stan_rdump(names(data), file = path, env = list2env(data))
+    rstan::stan_rdump(names(data), file = path, env = list2env(data))
   } else {
     stop(""'data' should be a path or a named list."", call. = FALSE)
   }",True,False,Dependency / Package,7
stan-dev,cmdstanr,2a4c44a5650954bf16c4dbc70bfbf9a6fc4a5a21,Ben,bbbales2@gmail.com,2019-11-25T20:28:00Z,Ben,bbbales2@gmail.com,2019-11-25T20:28:00Z,Switch back to using Rdata temporarily while issue with 0x0s gets resolved for JSON (Issue #96),R/model.R,False,True,True,False,2,2,4,"---FILE: R/model.R---
@@ -664,8 +664,8 @@ process_data <- function(data) {
   } else if (is.character(data)) {
     path <- absolute_path(data)
   } else if (is.list(data) && !is.data.frame(data)) {
-    path <- tempfile(pattern = ""standata-"", fileext = "".json"")
-    write_stan_json(data = data, file = path)
+    path <- tempfile(pattern = ""standata-"", fileext = "".dat"")
+    stan_rdump(names(data), file = path, env = list2env(data))
   } else {
     stop(""'data' should be a path or a named list."", call. = FALSE)
   }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,9aaec69ba5c9e5bbb04d49c9c0a0134bb61e034f,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-11-25T19:30:25Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-11-25T19:30:25Z,fix for warmup-only run,R/utils.R,False,True,True,False,4,0,4,"---FILE: R/utils.R---
@@ -369,6 +369,8 @@ set_num_threads <- function(num_threads) {
 }
 
 check_divergences <- function(data_csv) {
+  if(data_csv$sampling_info$sample_num_samples == 0)
+    return(NULL)
   if(data_csv$sampling_info$sample_save_warmup == 1) {
     first_iter <- data_csv$sampling_info$sample_num_warmup + 1
     last_iter <- data_csv$sampling_info$sample_num_warmup + data_csv$sampling_info$sample_num_samples
@@ -390,6 +392,8 @@ check_divergences <- function(data_csv) {
 }
 
 check_sampler_transitions_treedepth <- function(data_csv) {
+  if(data_csv$sampling_info$sample_num_samples == 0)
+    return(NULL)
   if(data_csv$sampling_info$sample_save_warmup == 1) {
     first_iter <- data_csv$sampling_info$sample_num_warmup + 1
     last_iter <- data_csv$sampling_info$sample_num_warmup + data_csv$sampling_info$sample_num_samples",True,False,Implementation / Logic,6
stan-dev,cmdstanr,6704b19b9bf1ed5748c8c514dc32a0a5a9815901,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-11-25T14:52:12Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-11-25T14:52:12Z,dont throw when num of samples doesnt match args as that is an issue for failed chains,R/read_csv.R;tests/testthat/test-csv.R,False,True,True,False,0,13,13,"---FILE: R/read_csv.R---
@@ -183,9 +183,6 @@ read_sample_csv <- function(output_files) {
       num_of_draws <- sampling_info$sample_num_samples
     }
     draws <- utils::read.csv(output_file, header = TRUE, comment.char = ""#"")
-    if (dim(draws)[1] != num_of_draws) {
-      stop(""Supplied CSV file is corrupt. The number of samples does not match the sampling arguments!"")
-    }
     sampling_params_draws <- rbind(sampling_params_draws, draws[, sampling_info$sampler_params])
     if(sampling_info$sample_save_warmup == 1) {
       warmup_draws_array <- rbind(warmup_draws_array,

---FILE: tests/testthat/test-csv.R---
@@ -74,16 +74,6 @@ test_that(""read_sample_csv() fails with the no params listed"", {
                ""no lines available in input"")
 })
 
-test_that(""read_sample_csv() fails with the number of samples found not matchin sampling arguments"", {
-  skip_on_cran()
-  file_path <- test_path(""resources"", ""csv"", ""model1-3-no-samples.csv"")
-  expect_error(read_sample_csv(file_path),
-               ""Supplied CSV file is corrupt. The number of samples does not match the sampling arguments!"")
-  file_path <- test_path(""resources"", ""csv"", ""model1-3-diff_params.csv"")
-  expect_error(read_sample_csv(file_path),
-               ""Supplied CSV file is corrupt. The number of samples does not match the sampling arguments!"")
-})
-
 test_that(""read_sample_csv() matches rstan::read_stan_csv()"", {
   skip_on_cran()
   csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-warmup.csv""),",True,False,Implementation / Logic,6
stan-dev,cmdstanr,966ebdac75a9f393e9fb388efb530a61702a6136,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-11-25T14:49:59Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-11-25T14:49:59Z,"no warnings for warmup, minor text fixes",R/utils.R,False,True,True,False,22,15,37,"---FILE: R/utils.R---
@@ -369,14 +369,17 @@ set_num_threads <- function(num_threads) {
 }
 
 check_divergences <- function(data_csv) {
-  divergences <- posterior::extract_one_variable_matrix(data_csv$sampler, ""divergent__"")
+  if(data_csv$sampling_info$sample_save_warmup == 1) {
+    first_iter <- data_csv$sampling_info$sample_num_warmup + 1
+    last_iter <- data_csv$sampling_info$sample_num_warmup + data_csv$sampling_info$sample_num_samples
+  } else {
+    first_iter <- 1
+    last_iter <- data_csv$sampling_info$sample_num_samples
+  }
+  divergences <- posterior::extract_one_variable_matrix(data_csv$sampler[first_iter:last_iter,,], ""divergent__"")
   num_of_divergences <- sum(divergences)
   if (num_of_divergences > 0) {
-    if(data_csv$sampling_info$sample_save_warmup == 1) {
-      num_iter <- data_csv$sampling_info$sample_num_samples + data_csv$sampling_info$sample_num_warmup
-    } else {
-      num_iter <- data_csv$sampling_info$sample_num_samples
-    }
+    num_iter <- data_csv$sampling_info$sample_num_samples
     percentage_divergences <- (num_of_divergences)/num_iter*100
     message(num_of_divergences, "" of "", num_iter, "" ("", (format(round(percentage_divergences, 0), nsmall = 0)), ""%)"",
             "" transitions ended with a divergence.\n"",
@@ -387,20 +390,24 @@ check_divergences <- function(data_csv) {
 }
 
 check_sampler_transitions_treedepth <- function(data_csv) {
+  if(data_csv$sampling_info$sample_save_warmup == 1) {
+    first_iter <- data_csv$sampling_info$sample_num_warmup + 1
+    last_iter <- data_csv$sampling_info$sample_num_warmup + data_csv$sampling_info$sample_num_samples
+  } else {
+    first_iter <- 1
+    last_iter <- data_csv$sampling_info$sample_num_samples
+  }
   max_treedepth <- data_csv$sampling_info$sample_adapt_hmc_nuts_max_depth
-  treedepth <- posterior::extract_one_variable_matrix(data_csv$sampler, ""treedepth__"")
+  treedepth <- posterior::extract_one_variable_matrix(data_csv$sampler[first_iter:last_iter,,], ""treedepth__"")
   max_treedepth_hit <- sum(treedepth >= max_treedepth)
-    if (max_treedepth_hit > 0) {
-      if(data_csv$sampling_info$sample_save_warmup == 1) {
-      num_iter <- data_csv$sampling_info$sample_num_samples + data_csv$sampling_info$sample_num_warmup
-    } else {
-      num_iter <- data_csv$sampling_info$sample_num_samples
-    }
+  if (max_treedepth_hit > 0) {
+    num_iter <- data_csv$sampling_info$sample_num_samples
     percentage_max_treedepth <- (max_treedepth_hit)/num_iter*100
     message(max_treedepth_hit, "" of "", num_iter, "" ("", (format(round(percentage_max_treedepth, 0), nsmall = 0)), ""%)"",
             "" transitions hit the maximum treedepth limit of "", max_treedepth,
-            "" or 2^"", max_treedepth, "" leapfrog steps.\n"",
+            "" or 2^"", max_treedepth, ""-1 leapfrog steps.\n"",
             ""Trajectories that are prematurely terminated due to this limit will result in slow exploration.\n"",
-            ""For optimal performance, increase this limit."")
+            ""Increasing the max_treedepth limit can avoid this at the expense of more computation.\n"",
+            ""If increasing max_depth does not remove warnings, try to reparameterize the model.\n"")
   }
 }",True,False,Implementation / Logic,3
stan-dev,cmdstanr,4de565653df1a94b65fac7f081284a07d5c646f7,"Serra Traynor, Carlos",carlos.serratraynor@astrazeneca.com,2019-11-24T21:49:11Z,"Serra Traynor, Carlos",carlos.serratraynor@astrazeneca.com,2019-11-24T21:49:11Z,"Fix to bug 97

Small typo in line 309 run.R fixed p$kill_tree() -> p$kill_tree",R/run.R,False,True,True,False,1,1,2,"---FILE: R/run.R---
@@ -306,7 +306,7 @@ CmdStanProcs <- R6::R6Class(
       private$run_ids_
     },
     cleanup = function() {
-      lapply(private$processes_, function(p) p$kill_tree())
+      lapply(private$processes_, function(p) p$kill_tree)
       invisible(self)
     },
     poll = function(ms) { # time in milliseconds",True,False,Implementation / Logic,3
stan-dev,cmdstanr,db530ce3acbacd665ca0b82b8af347463b910649,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-11-24T20:02:25Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-11-24T20:02:25Z,fix bug for sampler parameters when save_warmup = 0,R/read_csv.R,False,True,True,False,1,1,2,"---FILE: R/read_csv.R---
@@ -219,7 +219,7 @@ read_sample_csv <- function(output_files) {
                                                              dim = c(sampling_info$sample_num_samples, num_chains, length(sampling_info$model_params)),
                                                              dimnames = list(NULL, NULL, sampling_info$model_params)))
   sampling_params_draws <- posterior::as_draws_array(array(unlist(sampling_params_draws),
-                                                             dim = c(sampling_info$sample_num_samples+sampling_info$sample_num_warmup, num_chains, length(sampling_info$sampler_params)),
+                                                             dim = c(num_of_draws, num_chains, length(sampling_info$sampler_params)),
                                                              dimnames = list(NULL, NULL, sampling_info$sampler_params)))
   list(
     sampling_info = sampling_info,",True,False,Implementation / Logic,6
stan-dev,cmdstanr,10f2a950073f8175f6cdd7f53c6ebf1199f4e4d7,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-11-24T10:40:12Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-11-24T10:40:12Z,fixed extension on assert,R/read_csv.R,False,True,True,False,2,2,4,"---FILE: R/read_csv.R---
@@ -39,7 +39,7 @@ check_sampling_csv_info_matches <- function(a, b) {
 #' diagonal of the inverse mass matrix
 #'
 read_sample_info_csv <- function(csv_file) {
-  checkmate::assert_file_exists(csv_file, access = ""r"", extension = ""stan"")
+  checkmate::assert_file_exists(csv_file, access = ""r"", extension = ""csv"")
   param_names_read <- FALSE
   sampling_params_read <- FALSE
   diagonal_matrix_next <- FALSE
@@ -135,7 +135,7 @@ read_sample_csv <- function(output_files) {
   post_warmup_draws_array <- c()
   warmup_draws_array <- c()
   for(output_file in output_files) {
-    checkmate::assert_file_exists(output_file, access = ""r"", extension = ""stan"")
+    checkmate::assert_file_exists(output_file, access = ""r"", extension = ""csv"")
     # read meta data
     if (is.null(sampling_info)) {
       sampling_info <- read_sample_info_csv(output_file)",True,False,Implementation / Logic,6
stan-dev,cmdstanr,cc7c2ba77d01fccacddc3de9721813a4add6f1d6,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-11-24T10:26:34Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-11-24T10:26:34Z,change the check function to return error rather than call stop(),R/read_csv.R,False,True,True,False,12,6,18,"---FILE: R/read_csv.R---
@@ -9,25 +9,26 @@ check_sampling_csv_info_matches <- function(a, b) {
   if(a$stan_version_major != b$stan_version_major ||
      a$stan_version_minor != b$stan_version_minor ||
      a$stan_version_patch != b$stan_version_patch) {
-    stop(""Supplied CSV files were not generated with the same version of Cmdstan!"")
+    return(""Supplied CSV files were not generated with the same version of Cmdstan!"")
   }
   if(a$model != b$model) {
-    stop(""Supplied CSV files were not generated wtih the same model!"")
+    return(""Supplied CSV files were not generated wtih the same model!"")
   }
   if(!all(a$params == b$params)) {
-    stop(""Supplied CSV files have samples for different parameters!"")
+    return(""Supplied CSV files have samples for different parameters!"")
   }
   if(a$data_file != b$data_file) {
-    stop(""Supplied CSV files have samples from chains run with non-matching data!"")
+    return(""Supplied CSV files have samples from chains run with non-matching data!"")
   }
   for(name in names(a)) {
     if(startsWith(name, ""sample_"")) {
       if (is.null(b[[name]]) ||
           a[[name]] != b[[name]]) {
-        stop(""Supplied CSV files do not match in all sampling settings!"")
+        return(""Supplied CSV files do not match in all sampling settings!"")
       }
     }
   }
+  NULL
 }
 
 #' Reads the sampling arguments and the diagonal of the
@@ -38,6 +39,7 @@ check_sampling_csv_info_matches <- function(a, b) {
 #' diagonal of the inverse mass matrix
 #'
 read_sample_info_csv <- function(csv_file) {
+  checkmate::assert_file_exists(csv_file, access = ""r"", extension = ""stan"")
   param_names_read <- FALSE
   sampling_params_read <- FALSE
   diagonal_matrix_next <- FALSE
@@ -133,15 +135,19 @@ read_sample_csv <- function(output_files) {
   post_warmup_draws_array <- c()
   warmup_draws_array <- c()
   for(output_file in output_files) {
+    checkmate::assert_file_exists(output_file, access = ""r"", extension = ""stan"")
     # read meta data
     if (is.null(sampling_info)) {
       sampling_info <- read_sample_info_csv(output_file)
       inverse_mass_matrix_diag <- sampling_info$inverse_mass_matrix_diag
     } else {
       csv_file_info <- read_sample_info_csv(output_file)
       # check if sampling info matches
-      check_sampling_csv_info_matches(sampling_info,
+      error <- check_sampling_csv_info_matches(sampling_info,
                                   csv_file_info)
+      if(!is.null(error)) {
+        stop(error)
+      }
       sampling_info$id <- c(sampling_info$id,
                             csv_file_info$id)
       sampling_info$init <- c(sampling_info$init,",True,False,Implementation / Logic,6
stan-dev,cmdstanr,134c6a2b66875bddc37a84e82af1ff9d75966c4e,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-11-23T21:18:18Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-11-23T21:18:18Z,add remaining tests for failures,tests/testthat/resources/csv/model1-3-diff_args.csv;tests/testthat/resources/csv/model1-3-diff_data_file.csv;tests/testthat/resources/csv/model1-3-diff_name.csv;tests/testthat/resources/csv/model1-3-diff_stan_version.csv;tests/testthat/test-csv.R,False,True,True,False,4125,5,4130,"---FILE: tests/testthat/resources/csv/model1-3-diff_name.csv---
@@ -1,7 +1,7 @@
 # stan_version_major = 2
-# stan_version_minor = 20
+# stan_version_minor = 21
 # stan_version_patch = 0
-# model = model1
+# model = model_fail
 # method = sample (Default)
 #   sample
 #     num_samples = 1000 (Default)

---FILE: tests/testthat/resources/csv/model1-3-diff_stan_version.csv---
@@ -1,7 +1,7 @@
 # stan_version_major = 2
-# stan_version_minor = 21
+# stan_version_minor = 20
 # stan_version_patch = 0
-# model = model1_fail
+# model = model1
 # method = sample (Default)
 #   sample
 #     num_samples = 1000 (Default)

---FILE: tests/testthat/test-csv.R---
@@ -7,7 +7,31 @@ if (not_on_cran()) {
 test_that(""read_sample_csv() fails for different stan version"", {
   skip_on_cran()
   csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-nowarmup.csv""),
-                 test_path(""resources"", ""csv"", ""model1-3-diff_name.csv""))
+                 test_path(""resources"", ""csv"", ""model1-3-diff_stan_version.csv""))
   expect_error(read_sample_csv(csv_files),
                ""Supplied CSV files were not generated with the same version of Cmdstan!"")
 })
+
+test_that(""read_sample_csv() fails for different model names"", {
+  skip_on_cran()
+  csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-nowarmup.csv""),
+                 test_path(""resources"", ""csv"", ""model1-3-diff_name.csv""))
+  expect_error(read_sample_csv(csv_files),
+               ""Supplied CSV files were not generated wtih the same model!"")
+})
+
+test_that(""read_sample_csv() fails for different data file names names"", {
+  skip_on_cran()
+  csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-nowarmup.csv""),
+                 test_path(""resources"", ""csv"", ""model1-3-diff_data_file.csv""))
+  expect_error(read_sample_csv(csv_files),
+               ""Supplied CSV files have samples from chains run with non-matching data!"")
+})
+
+test_that(""read_sample_csv() fails for different sampling settings"", {
+  skip_on_cran()
+  csv_files <- c(test_path(""resources"", ""csv"", ""model1-1-nowarmup.csv""),
+                 test_path(""resources"", ""csv"", ""model1-3-diff_args.csv""))
+  expect_error(read_sample_csv(csv_files),
+               ""Supplied CSV files do not match in all sampling settings!"")
+})",True,False,Data / Input Handling,3
stan-dev,cmdstanr,b7c155a39e4d7c0dddaed519e95fbabbd3219d12,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-11-20T21:54:08Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-11-20T21:54:08Z,fix travis branch,.travis.yml,False,False,False,False,1,1,2,"---FILE: .travis.yml---
@@ -13,7 +13,7 @@ cache:
 # FIXME: replace with cmdstanr master eventually
 r_github_packages:
   - r-lib/covr
-  - stan-dev/cmdstanr@install_cmdstan_from_r
+  - stan-dev/cmdstanr
 
 warnings_are_errors: true
 env:",False,False,Data / Input Handling,3
stan-dev,cmdstanr,ff4bae9d1d03d414d3928bf8bcb0e1efc84b6c4f,jgabry,jgabry@gmail.com,2019-11-20T18:23:43Z,jgabry,jgabry@gmail.com,2019-11-20T18:23:43Z,"Fix test that was failing

don't use `NULL` in file.path",tests/testthat/test-install.R,False,True,True,False,5,2,7,"---FILE: tests/testthat/test-install.R---
@@ -16,11 +16,14 @@ test_that(""install_cmdstan() successfully installs cmdstan"", {
 test_that(""install_cmdstan() errors if installation already exists"", {
   skip_if_offline()
   if (not_on_cran()) {
+    # want to test passing NULL to install_cmdstan but need a real dir to
+    # check in dir.exists() below so also create dir_check
     dir <- NULL
+    dir_check <- cmdstan_default_path()
   } else {
-    dir <- tempdir()
+    dir <- dir_check <- tempdir()
   }
-  if (dir.exists(file.path(dir, ""cmdstan""))) {
+  if (dir.exists(file.path(dir_check, ""cmdstan""))) {
     expect_warning(
       install_cmdstan(dir = dir, overwrite = FALSE),
       ""An installation already exists""",True,False,Implementation / Logic,6
stan-dev,cmdstanr,fef7f69a2225ece80eee3ec8960a5b933b73f33d,Jonah Gabry,jgabry@gmail.com,2019-11-20T05:59:59Z,GitHub,noreply@github.com,2019-11-20T05:59:59Z,"Update test-install.R

test for repo clone passing Travis and appveyor but errors on covr::codecov() at least for now",tests/testthat/test-install.R,False,True,True,False,1,0,1,"---FILE: tests/testthat/test-install.R---
@@ -29,6 +29,7 @@ test_that(""install_cmdstan() errors if installation already exists"", {
 })
 
 test_that(""internal clone_repo() function clones the repo"", {
+  skip_on_covr() 
   skip_on_cran()
   skip_if_offline()
   clone_dir <- tempfile(tmpdir = tempdir(check=TRUE))",True,False,Implementation / Logic,3
stan-dev,cmdstanr,5622ad27f708382ec9965cafab32cfc28ccf504f,jgabry,jgabry@gmail.com,2019-11-19T03:07:20Z,jgabry,jgabry@gmail.com,2019-11-19T03:07:20Z,fix test error,tests/testthat/teardown-remove-files.R;tests/testthat/test-model-output_dir.R,False,True,True,False,6,5,11,"---FILE: tests/testthat/teardown-remove-files.R---
@@ -7,11 +7,12 @@ all_files_in_stan <-
 not_stan_programs <- !grepl("".stan$"", all_files_in_stan)
 file.remove(all_files_in_stan[not_stan_programs])
 
-# remove all files from answers/sandbox except readme
+# remove all files from answers/sandbox except README
 all_files_in_sandbox <-
   list.files(test_path(""answers"", ""sandbox""),
              full.names = TRUE,
-             include.dirs = TRUE,
+             include.dirs = FALSE,
              recursive = TRUE)
 not_readme <- !grepl(""README$"", all_files_in_sandbox)
 file.remove(all_files_in_sandbox[not_readme])
+file.remove(list.dirs(test_path(""answers"", ""sandbox""), recursive = FALSE))

---FILE: tests/testthat/test-model-output_dir.R---
@@ -29,19 +29,19 @@ test_that(""error if output_dir is invalid"", {
   skip_on_cran()
 
   expect_error(
-    mod$sample(output_dir = ""NOT_A_DIR""),
+    testing_fit(""bernoulli"", output_dir = ""NOT_A_DIR""),
     ""Directory 'NOT_A_DIR' does not exist"",
     fixed = TRUE
   )
   expect_error(
-    mod$sample(output_dir = list()),
+    testing_fit(""bernoulli"", output_dir = TRUE),
     ""No directory provided""
   )
 
   not_readable <- test_path(""answers"", ""sandbox"", ""locked"")
   dir.create(not_readable, mode = 0)
   expect_error(
-    mod$sample(output_dir = not_readable),
+    testing_fit(""bernoulli"", output_dir = not_readable),
     ""not readable""
   )
 })",True,False,Documentation / Formatting,3
stan-dev,cmdstanr,a3727d8da170dcb1dbc8d2c0d2c5afb231f210d3,jgabry,jgabry@gmail.com,2019-11-18T17:52:16Z,jgabry,jgabry@gmail.com,2019-11-18T17:52:16Z,fix typos in test,tests/testthat/test-model-sample.R,False,True,True,False,1,1,2,"---FILE: tests/testthat/test-model-sample.R---
@@ -145,7 +145,7 @@ test_that(""sample() method errors for any invalid arguments before calling cmdst
 test_that(""sample works for warmup-only run"", {
   skip_on_cran()
   expect_output(
-    fit <- mod_ok$sample(num_chains = 2, data = standata, num_samples = 0),
+    fit <- mod$sample(num_chains = 2, data = data_list, num_samples = 0),
     ""Iteration: 1000 / 1000 [100%]  (Warmup)"",
     fixed = TRUE
   )",True,False,Implementation / Logic,3
stan-dev,cmdstanr,35ff64fa608b799c051182f0348ef48077a73b01,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-11-17T10:19:54Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-11-17T10:19:54Z,fix env variable,.appveyor.yml,False,False,False,False,2,2,4,"---FILE: .appveyor.yml---
@@ -37,10 +37,10 @@ install:
         Where-Object pullRequestId -eq $env:APPVEYOR_PULL_REQUEST_NUMBER)[0].buildNumber) { `
         throw ""There are newer queued builds for this pull request, failing early."" }
   
-        & ""C:\\Program Files\\Git\\mingw64\\bin\\curl.exe"" -s -o ../R-win.exe -L https://cran.rstudio.com/bin/windows/base/R-""+$env:_R_VERSION+""-win.exe
+        & ""C:\\Program Files\\Git\\mingw64\\bin\\curl.exe"" -s -o ../R-win.exe -L https://cran.rstudio.com/bin/windows/base/R-$env:_R_VERSION-win.exe
         echo ""Running R installer""
         Start-Process -FilePath ..\R-win.exe -ArgumentList ""/VERYSILENT /DIR=C:\R"" -NoNewWindow -Wait
-        & ""C:\\Program Files\\Git\\mingw64\\bin\\curl.exe"" -s -o ../R-tools-win.exe -L https://cran.rstudio.com/bin/windows/Rtools/Rtools""+$env:_RTOOLS_VERSION+"".exe
+        & ""C:\\Program Files\\Git\\mingw64\\bin\\curl.exe"" -s -o ../R-tools-win.exe -L https://cran.rstudio.com/bin/windows/Rtools/Rtools$env:_RTOOLS_VERSION.exe
         echo ""Running RTools installer""
         Start-Process -FilePath ..\R-tools-win.exe -ArgumentList /VERYSILENT -NoNewWindow -Wait
   - SET PATH=C:\\R\\bin\\x64;C:\\Rtools\\bin;C:\\Rtools\\mingw_64\\bin;C:\\Rtools\\mingw_32\\bin;%PATH%",False,False,Data / Input Handling,3
stan-dev,cmdstanr,3bf6626c938c2af4d2a49c91a0c6b10fa39df386,jgabry,jgabry@gmail.com,2019-11-16T22:38:32Z,jgabry,jgabry@gmail.com,2019-11-16T22:38:32Z,Fix typo in message,R/model.R,False,True,True,False,1,1,2,"---FILE: R/model.R---
@@ -634,7 +634,7 @@ variational_method <- function(data = NULL,
   runset$run_cmdstan()
 
   message(
-    ""Optimization method is experimental and "",
+    ""Variational method is experimental and "",
     ""the structure of returned object may change.""
   )
   CmdStanVB$new(runset)",True,False,Implementation / Logic,6
stan-dev,cmdstanr,23c1fdda3217ab7e25f0e32540f936dda7803936,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-11-16T21:56:23Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-11-16T21:56:23Z,add appveyor file and fix regexpr,.appveyor.yml;R/run.R,False,True,True,False,87,7,94,"---FILE: .appveyor.yml---
@@ -0,0 +1,80 @@
+skip_branch_with_pr: true
+version: '{build}'
+image: Visual Studio 2017
+
+platform:
+  - x64
+
+# cache:
+#   - C:\\R\\
+#   - C:\\Rtools
+
+init:
+  ps: |
+        $ErrorActionPreference = ""Stop""
+        Invoke-WebRequest https://gist.githubusercontent.com/rok-cesnovar/0d74c310d41b12e62f842de4ea92322b/raw/90b718b2dac8dbf0fda49abdf0b6bd29b344be35/appveyor_install_cmdstanr.R -OutFile ""..\appveyor_install_cmdstanr.R""
+clone_folder: c:\projects\cmdstanr
+shallow_clone: true
+clone_depth: 1
+
+environment:
+  NOT_CRAN: true
+  _R_CHECK_FORCE_SUGGESTS_: false
+  USE_RTOOLS: true
+  HOME: C:\Users\appveyor\
+
+install:
+  # If there is a newer build queued for the same PR, cancel this one.
+  # The AppVeyor 'rollout builds' option is supposed to serve the same
+  # purpose but it is problematic because it tends to cancel builds pushed
+  # directly to master instead of just PR builds (or the converse).
+  # credits: JuliaLang developers.
+  - ps: |
+        if ($env:APPVEYOR_PULL_REQUEST_NUMBER -and $env:APPVEYOR_BUILD_NUMBER -ne ((Invoke-RestMethod `
+        https://ci.appveyor.com/api/projects/$env:APPVEYOR_ACCOUNT_NAME/$env:APPVEYOR_PROJECT_SLUG/history?recordsNumber=50).builds | `
+        Where-Object pullRequestId -eq $env:APPVEYOR_PULL_REQUEST_NUMBER)[0].buildNumber) { `
+        throw ""There are newer queued builds for this pull request, failing early."" }
+  
+        & ""C:\\Program Files\\Git\\mingw64\\bin\\curl.exe"" -s -o ../R-win.exe -L https://cran.rstudio.com/bin/windows/base/R-3.6.1-win.exe
+        echo ""Running R installer""
+        Start-Process -FilePath ..\R-win.exe -ArgumentList ""/VERYSILENT /DIR=C:\R"" -NoNewWindow -Wait
+        & ""C:\\Program Files\\Git\\mingw64\\bin\\curl.exe"" -s -o ../R-tools-win.exe -L https://cran.rstudio.com/bin/windows/Rtools/Rtools35.exe
+        echo ""Running RTools installer""
+        Start-Process -FilePath ..\R-tools-win.exe -ArgumentList /VERYSILENT -NoNewWindow -Wait
+  - SET PATH=C:\\R\\bin\\x64;C:\\Rtools\\bin;C:\\Rtools\\mingw_64\\bin;C:\\Rtools\\mingw_32\\bin;%PATH%
+  - g++ --version
+  - mingw32-make --version
+  - Rscript -e ""sessionInfo()""
+  - Rscript ..\\appveyor_install_cmdstanr.R 
+  - bash inst/make_cmdstan.sh -j2 -w
+  - echo ""Installation done""
+
+build: false
+
+test_script:
+  - SET PATH=C:\\R\\bin\\x64;C:\\Rtools\\bin;C:\\Rtools\\mingw_64\\bin;%PATH%
+  - R.exe CMD build . --no-build-vignettes --no-manual
+  - R.exe CMD check .\\cmdstanr_0.0.0.9000.tar.gz --no-build-vignettes --no-manual --as-cran --install-args=--build
+
+on_failure:
+  - 7z a failure.zip *.Rcheck\*
+  - appveyor PushArtifact failure.zip
+
+artifacts:
+  - path: '*.Rcheck\**\*.log'
+    name: Logs
+
+  - path: '*.Rcheck\**\*.out'
+    name: Logs
+
+  - path: '*.Rcheck\**\*.fail'
+    name: Logs
+
+  - path: '*.Rcheck\**\*.Rout'
+    name: Logs
+
+  - path: '\*_*.tar.gz'
+    name: Bits
+
+  - path: '\*_*.zip'
+    name: Bits
\ No newline at end of file

---FILE: R/run.R---
@@ -423,9 +423,9 @@ CmdStanProcs <- R6::R6Class(
     },
     is_error_message = function(line) {
       startsWith(line, ""Exception:"") ||
-      (regexpr(line, ""either mistyped or misplaced."") > 0) ||
-      (regexpr(line, ""A method must be specified!"") > 0) ||
-      (regexpr(line, ""is not a valid value for"") > 0)
+      (regexpr(""either mistyped or misplaced."", line, perl = TRUE) > 0) ||
+      (regexpr(""A method must be specified!"", line, perl = TRUE) > 0) ||
+      (regexpr(""is not a valid value for"", line, perl = TRUE) > 0)
     },
     process_sample_output = function(out, id) {
       id <- as.character(id)
@@ -438,22 +438,22 @@ CmdStanProcs <- R6::R6Class(
           last_section_start_time <- private$chain_info_[id,""last_section_start_time""]
           state <- private$chain_info_[id,""state""]
           next_state <- state
-          if (state == 1 && regexpr(""Iteration:"", line) > 0) {
+          if (state == 1 && regexpr(""Iteration:"", line, perl = TRUE) > 0) {
             state <- 2
             next_state <- 2
             private$chain_info_[id,""last_section_start_time""] <- Sys.time()
           }
-          if (state == 1 && regexpr(""Elapsed Time:"", line) > 0) {
+          if (state == 1 && regexpr(""Elapsed Time:"", line, perl = TRUE) > 0) {
             state <- 4
             next_state <- 4
           }
           if (private$chain_info_[id,""state""] == 2 &&
-              regexpr(""(Sampling)"", line) > 0) {
+              regexpr(""(Sampling)"", line, perl = TRUE) > 0) {
             next_state <- 3 # 3 = sampling
             private$chain_info_[id,""warmup_time""] <- Sys.time() - last_section_start_time
             private$chain_info_[id,""last_section_start_time""] <- Sys.time()
           }
-          if (regexpr(""\\[100%\\]"", line) > 0) {
+          if (regexpr(""\\[100%\\]"", line, perl = TRUE) > 0) {
             if (state == 2) { #warmup only run
               private$chain_info_[id,""warmup_time""] <- Sys.time() - last_section_start_time
             } else if (state == 3) { # sampling",True,False,Data / Input Handling,3
stan-dev,cmdstanr,73a96c45f13c32db84735d353221739cb79375c2,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-11-16T21:43:33Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-11-16T21:43:33Z,apply windows & appveyor fixes,R/model.R;tests/testthat/helper-envvars-and-paths.R;tests/testthat/test-model-compile.R;tests/testthat/test-path.R,False,True,True,False,6,5,11,"---FILE: R/model.R---
@@ -234,7 +234,7 @@ compile_method <- function(quiet = TRUE,
     path_to_TBB <- file.path(cmdstan_path(), ""stan"", ""lib"", ""stan_math"", ""lib"", ""tbb"")
     Sys.setenv(PATH = paste0(path_to_TBB, "";"", Sys.getenv(""PATH"")))
   }
-
+  
   if (!is.null(include_paths)) {
     checkmate::assert_directory_exists(include_paths, access = ""r"")
     include_paths <- absolute_path(include_paths)

---FILE: tests/testthat/helper-envvars-and-paths.R---
@@ -24,7 +24,8 @@ not_on_cran <- function() {
 
 set_cmdstan_path_for_tests <- function() {
   if (on_appveyor()) {
-    set_cmdstan_path(""C:/MinGW/msys/1.0/.cmdstanr/cmdstan"")
+    set_cmdstan_path(""C:/Users/appveyor/.cmdstanr/cmdstan/"")
+    Sys.setenv(PATH = paste0(""C:\\R\\bin\\x64;C:\\Rtools\\bin;C:\\Rtools\\mingw_64\\bin;C:\\Rtools\\mingw_32\\bin;"", Sys.getenv(""PATH"")))
   } else {
     set_cmdstan_path()
   }

---FILE: tests/testthat/test-model-compile.R---
@@ -37,13 +37,13 @@ test_that(""compile() method forces recompilation if changes in flags"", {
   skip_on_cran()
   skip_on_ci() # FIXME: this test seems to pass locally but fail on travis
   expect_message(
-    mod$compile(opencl=TRUE),
+    mod$compile(threads=TRUE),
     ""change in the compiler flags was found""
   )
 
   # change it back
   expect_message(
-    mod$compile(opencl=FALSE),
+    mod$compile(threads=FALSE),
     ""change in the compiler flags was found""
   )
 })

---FILE: tests/testthat/test-path.R---
@@ -53,7 +53,7 @@ test_that(""cmdstanr_initialize() also looks for default path"", {
 
   unset_cmdstan_path()
   cmdstanr_initialize()
-  expect_equal(cmdstan_path(), PATH)
+  expect_equal(tolower(cmdstan_path()), tolower(PATH))
 })
 
 ",True,False,Implementation / Logic,6
stan-dev,cmdstanr,aa0e51014a7264384d4c3fee719450f0cbdde004,jgabry,jgabry@gmail.com,2019-11-16T18:09:07Z,jgabry,jgabry@gmail.com,2019-11-16T18:09:07Z,fix extra dot in path,R/utils.R,False,True,True,False,5,1,6,"---FILE: R/utils.R---
@@ -133,7 +133,11 @@ copy_temp_files <-
 
     ext <- if (startsWith(ext, ""."")) ext else paste0(""."", ext)
     new_names <- paste0(new_names, ext)
-    destinations <- file.path(new_dir, new_names)
+    if (new_dir == ""."") {
+      destinations <- new_names
+    } else {
+      destinations <- file.path(new_dir, new_names)
+    }
 
     copied <- file.copy(
       from = current_paths,",True,False,File I/O and Export,3
stan-dev,cmdstanr,6f1628bfa94fff882ee1a4bc3ec5f4b2e1ba8017,Jonah Gabry,jgabry@gmail.com,2019-11-15T22:43:37Z,GitHub,noreply@github.com,2019-11-15T22:43:37Z,"Fix typo in vignette

[ci skip]",vignettes/cmdstanr.Rmd,True,False,True,False,1,1,2,"---FILE: vignettes/cmdstanr.Rmd---
@@ -195,7 +195,7 @@ to the individual documentation pages:
 
 The RStan interface ([**rstan**](https://mc-stan.org/rstan) package) is an
 in-memory interface to Stan and relies on R packages like **Rcpp** and
-**inline** call C++ code from R. On the other hand, the CmdStanR interface does
+**inline** to call C++ code from R. On the other hand, the CmdStanR interface does
 not directly call any C++ code from R, instead relying on CmdStan for
 compilation, running algorithms, and writing results to output files.
 ",False,True,Documentation / Formatting,4
stan-dev,cmdstanr,0fb69c0c13de940b5bd7408fc7cbc3e1a0d9bd9b,jgabry,jgabry@gmail.com,2019-11-15T04:58:20Z,jgabry,jgabry@gmail.com,2019-11-15T04:58:20Z,fix failing test,R/run.R,False,True,True,False,2,1,3,"---FILE: R/run.R---
@@ -73,7 +73,8 @@ CmdStanRun <- R6::R6Class(
                                      basename = NULL,
                                      timestamp = TRUE) {
       # FIXME use self$diagnostic_files(include_failed=TRUE) once #76 is fixed
-      current_files <- private$diagnostic_files_
+      current_files <- self$diagnostic_files() # used so we get error if 0 files
+      current_files <- private$diagnostic_files_ # used so we still save all of them
       new_paths <- copy_temp_files(
         current_paths = current_files,
         new_dir = dir,",True,False,Implementation / Logic,6
stan-dev,cmdstanr,97310e129fe4af3085811ea4246d72eed46c20a1,jgabry,jgabry@gmail.com,2019-11-15T04:51:23Z,jgabry,jgabry@gmail.com,2019-11-15T04:51:23Z,"fix issue with not all files getting saved

this will be easier after #76 , but this should work for now",R/run.R,False,True,True,False,10,6,16,"---FILE: R/run.R---
@@ -52,35 +52,39 @@ CmdStanRun <- R6::R6Class(
     save_output_files = function(dir = ""."",
                                  basename = NULL,
                                  timestamp = TRUE) {
+      # FIXME use self$output_files(include_failed=TRUE) once #76 is fixed
+      current_files <- private$output_files_
       new_paths <- copy_temp_files(
-        current_paths = self$output_files(), # FIXME use include_failed=TRUE once #76 is fixed
+        current_paths = current_files,
         new_dir = dir,
         new_basename = basename %||% self$model_name(),
         ids = self$run_ids(),
         ext = "".csv"",
         timestamp = timestamp
       )
-      file.remove(self$output_files())
+      file.remove(current_files)
       private$output_files_ <- new_paths
-      message(""Moved "", length(self$output_files()),
+      message(""Moved "", length(current_files),
               "" output files and set internal paths to new locations:\n"",
               paste(""-"", new_paths, collapse = ""\n""))
       invisible(new_paths)
     },
     save_diagnostic_files = function(dir = ""."",
                                      basename = NULL,
                                      timestamp = TRUE) {
+      # FIXME use self$diagnostic_files(include_failed=TRUE) once #76 is fixed
+      current_files <- private$diagnostic_files_
       new_paths <- copy_temp_files(
-        current_paths = self$diagnostic_files(), # FIXME use include_failed=TRUE once #76 is fixed
+        current_paths = current_files,
         new_dir = dir,
         new_basename = paste0(basename %||% self$model_name(), ""-diagnostic""),
         ids = self$run_ids(),
         ext = "".csv"",
         timestamp = timestamp
       )
-      file.remove(self$diagnostic_files())
+      file.remove(current_files)
       private$diagnostic_files_ <- new_paths
-      message(""Moved "", length(self$diagnostic_files()),
+      message(""Moved "", length(current_files),
               "" diagnostic files and set internal paths to new locations:\n"",
               paste(""-"", new_paths, collapse = ""\n""))
       invisible(new_paths)",True,False,Implementation / Logic,6
stan-dev,cmdstanr,744cf2005205472cea52ae0a12416c65099d0117,jgabry,jgabry@gmail.com,2019-11-14T05:44:03Z,jgabry,jgabry@gmail.com,2019-11-14T05:44:03Z,fix typos and other minor doc edits,R/cmdstanr-package.R;R/fit.R;R/model.R;R/path.R;man/CmdStanMCMC.Rd;man/CmdStanMLE.Rd;man/CmdStanModel.Rd;man/CmdStanVB.Rd;man/cmdstan_model.Rd;man/cmdstanr-package.Rd;man/model-method-compile.Rd;man/model-method-optimize.Rd;man/model-method-sample.Rd,False,True,True,False,78,74,152,"---FILE: R/cmdstanr-package.R---
@@ -27,17 +27,21 @@
 #'   and \pkg{inline} to call C++ code from R. On the other hand, the \R code in
 #'   this package does not directly call any C++ code, instead relying on
 #'   CmdStan for compilation, running algorithms, and writing results to output
-#'   files. Both forms of interfacing with Stan have advantages and
-#'   disadvantages. An in-memory interface like RStan is able to offer more
-#'   advanced features than CmdStanR (for example RStan's `log_prob` and
-#'   `grad_log_prob` methods) but keeping up with Stan releases is more
-#'   complicated for RStan, often requiring non-trivial changes to the
-#'   \pkg{rstan} package and always requiring new CRAN releases of \pkg{rstan}
-#'   and \pkg{StanHeaders}. With CmdStanR, the latest features in Stan will be
-#'   available from \R immediately after updating CmdStan, which can be done
-#'   with the [install_cmdstan()] function.
-#'
-#'   The licenses of CmdStanR (BSD-3) and RStan (GPL-3) are also different.
+#'   files.
+#'
+#'   Both forms of interfacing with Stan have advantages and disadvantages. An
+#'   in-memory interface like RStan is able to offer more advanced features than
+#'   CmdStanR (for example the `rstan::log_prob()` and `rstan::grad_log_prob()`
+#'   methods) but keeping up with Stan releases is more complicated for RStan,
+#'   often requiring non-trivial changes to the \pkg{rstan} package and always
+#'   requiring new CRAN releases of \pkg{rstan} and \pkg{StanHeaders}. With
+#'   CmdStanR, the latest features in Stan will be available from \R immediately
+#'   after updating CmdStan, which can be done with the [install_cmdstan()]
+#'   function.
+#'
+#'   Another difference between RStan and CmdStanR is the license. RStan is
+#'   GPL-3 while the license for CmdStanR (like Stan) is BSD-3, which is a bit
+#'   more permissive.
 #'
 #' @template seealso-docs
 #' @inherit cmdstan_model examples

---FILE: R/fit.R---
@@ -12,7 +12,7 @@
 #'   objects.
 #'
 #' @details
-#' `CmdStanMCMC` objects have the following associated methods:
+#' `CmdStanMCMC` objects have the following methods:
 #'
 #' \tabular{ll}{
 #'  **Method** \tab **Description** \cr
@@ -113,7 +113,7 @@ CmdStanMCMC <- R6::R6Class(
 #'   object.
 #'
 #' @details
-#' `CmdStanMLE` objects have the following associated methods:
+#' `CmdStanMLE` objects have the following methods:
 #'
 #' \tabular{ll}{
 #'  **Method** \tab **Description** \cr
@@ -138,8 +138,8 @@ CmdStanMLE <- R6::R6Class(
       invisible(self)
     },
     summary = function() {
-      # FIXME: what should summary for optimization do?
-      # (bin/stansummary isn't compatible)
+      # FIXME: we only have point estimates for optimization,
+      # so what should summary do?
 
       cat(""Estimates from optimization:\n"")
       c(self$mle(), self$lp())
@@ -177,7 +177,7 @@ CmdStanMLE <- R6::R6Class(
 #'   [`CmdStanModel`] object.
 #'
 #' @details
-#' `CmdStanVB` objects have the following associated methods:
+#' `CmdStanVB` objects have the following methods:
 #'
 #' \tabular{ll}{
 #'  **Method** \tab **Description** \cr

---FILE: R/model.R---
@@ -10,7 +10,7 @@
 #'   compilation can be done later via the [`$compile()`][model-method-compile]
 #'   method.
 #' @param ... Optionally, additional arguments to pass to the
-#'   [`$compile()`][model-method-compile] method. Ignored if `compile=FALSE`.
+#'   [`$compile()`][model-method-compile] method if `compile=TRUE`.
 #'
 #' @return A [`CmdStanModel`] object.
 #'
@@ -85,10 +85,10 @@ cmdstan_model <- function(stan_file, compile = TRUE, ...) {
 #' CmdStanModel objects
 #'
 #' @name CmdStanModel
-#' @description A `CmdStanModel` object is an [R6][R6::R6] object returned by
-#'   the [cmdstan_model()] function. The object stores the path to a Stan
-#'   program as well as a path to a compiled executable once created, and
-#'   provides methods for fitting the model. See **Details** section for
+#' @description A `CmdStanModel` object is an [R6][R6::R6] object created by the
+#'   [cmdstan_model()] function. The object stores the path to a Stan program
+#'   and compiled executable (once created), and provides methods for fitting
+#'   the model using Stan's algorithms. See the **Details** section for
 #'   available methods.
 #'
 #' @details
@@ -99,7 +99,7 @@ cmdstan_model <- function(stan_file, compile = TRUE, ...) {
 #'  code \tab Return Stan program as a string. \cr
 #'  print \tab Print readable version of Stan program. \cr
 #'  stan_file \tab Return the file path to the Stan program. \cr
-#'  exe_file \tab Return the file path to the compiled executable once compiled. \cr
+#'  exe_file \tab Return the file path to the compiled executable. \cr
 #'  [compile][model-method-compile] \tab Compile Stan program. \cr
 #'  [sample][model-method-sample]
 #'    \tab Run CmdStan's `""sample""` method, return [`CmdStanMCMC`] object. \cr
@@ -152,11 +152,11 @@ CmdStanModel <- R6::R6Class(
 #' @name model-method-compile
 #' @family CmdStanModel methods
 #'
-#' @description The `$compile()` method of a [`CmdStanModel`] object calls CmdStan
-#'   to translate a Stan program to C++ and then create a compiled executable.
-#'   The resulting files are placed in the same directory as the Stan program
-#'   associated with the `CmdStanModel` object. After compilation the path
-#'   to the executable can be accesed via the `$exe_file()` method.
+#' @description The `$compile()` method of a [`CmdStanModel`] object calls
+#'   CmdStan to translate a Stan program to C++ and create a compiled
+#'   executable. The resulting files are placed in the same directory as the
+#'   Stan program associated with the `CmdStanModel` object. After compilation
+#'   the path to the executable can be accesed via the `$exe_file()` method.
 #'
 #' @section Usage:
 #'   ```
@@ -174,8 +174,8 @@ CmdStanModel <- R6::R6Class(
 #'
 #' @section Arguments:
 #'   Leaving all arguments at their defaults should be fine for most users, but
-#'   optional arguments are provided to enable new features in CmdStan (and the
-#'   Stan Math library). See the CmdStan manual for more details.
+#'   optional arguments are provided to enable features in CmdStan (and the Stan
+#'   Math library). See the CmdStan manual for more details.
 #'   * `quiet`: (logical) Should the verbose output from CmdStan during
 #'     compilation be suppressed? The default is `TRUE`, but if you encounter an
 #'     error we recommend trying again with `quiet=FALSE` to see more of the
@@ -326,7 +326,7 @@ CmdStanModel$set(""public"", name = ""compile"", value = compile_method)
 #'   * `save_warmup`: (logical) Should warmup iterations be saved? The default
 #'   is `FALSE`.
 #'   * `thin`: (positive integer) The period between saved samples. This should
-#'   typically be left at its default (no thinning).
+#'   typically be left at its default (no thinning) unless memory is a problem.
 #'   * `max_depth`: (positive integer) The maximum allowed tree depth for the
 #'   NUTS engine. See the _Tree Depth_ section of the CmdStan manual for more
 #'   details.
@@ -357,13 +357,13 @@ CmdStanModel$set(""public"", name = ""compile"", value = compile_method)
 #'   can be used as an alternative to the `metric_file` argument. A vector is
 #'   interpreted as a diagonal metric. The inverse metric is usually set to an
 #'   estimate of the posterior covariance. See the `adapt_engaged` argument
-#'   above for details (and control over) on how specifying a precomputed
+#'   above for details on (and control over) how specifying a precomputed
 #'   inverse metric interacts with adaptation.
-#'   * `init_buffer`: (non-negative integer) Width of initial fast timestep
+#'   * `init_buffer`: (nonnegative integer) Width of initial fast timestep
 #'   adaptation interval during warmup.
-#'   * `term_buffer`: (non-negative integer) Width of final fast timestep
+#'   * `term_buffer`: (nonnegative integer) Width of final fast timestep
 #'   adaptation interval during warmup.
-#'   * `window`: (non-negative integer) Initial width of slow timestep/metric
+#'   * `window`: (nonnegative integer) Initial width of slow timestep/metric
 #'   adaptation interval.
 #'
 #' @section Value: The `$sample()` method returns a [`CmdStanMCMC`] object.
@@ -473,7 +473,7 @@ CmdStanModel$set(""public"", name = ""sample"", value = sample_method)
 #'   * `algorithm`: (string) The optimization algorithm. One of `""lbfgs""`,
 #'   `""bfgs""`, or `""newton""`.
 #'   * `iter`: (positive integer) The number of iterations.
-#'   * `init_alpha`: (non-negative real) The line search step size for first
+#'   * `init_alpha`: (nonnegative real) The line search step size for first
 #'   iteration. Not applicable if `algorithm=""newton""`.
 #'
 #' @section Value: The `$optimize()` method returns a [`CmdStanMLE`] object.
@@ -651,7 +651,7 @@ CmdStanModel$set(""public"", name = ""variational"", value = variational_method)
 #' Write data to a temporary `.json` file if necessary
 #' @noRd
 #' @param data If not `NULL`, then either a path to a data file compatible with
-#'   CmdStan, or a named list of \R objects in the style that RStan uses.
+#'   CmdStan, or a named list of \R objects to pass to [write_stan_json()].
 #' @return Path to data file.
 process_data <- function(data) {
   if (is.null(data)) {
@@ -660,10 +660,7 @@ process_data <- function(data) {
     path <- absolute_path(data)
   } else if (is.list(data) && !is.data.frame(data)) {
     path <- tempfile(pattern = ""standata-"", fileext = "".json"")
-    write_stan_json(
-      data = data,
-      file = path
-    )
+    write_stan_json(data = data, file = path)
   } else {
     stop(""'data' should be a path or a named list."", call. = FALSE)
   }

---FILE: R/path.R---
@@ -95,7 +95,6 @@ stop_no_path <- function() {
 #' @return A file path.
 #' @export
 cmdstan_default_path <- function() {
-  # "".cmdstanr/cmdstan"" is a symlink to latest version
   file.path(Sys.getenv(""HOME""), "".cmdstanr"", ""cmdstan"")
 }
 

---FILE: man/CmdStanMCMC.Rd---
@@ -10,7 +10,7 @@ Like \code{CmdStanModel} objects, \code{CmdStanMCMC} objects are \link[R6:R6]{R6
 objects.
 }
 \details{
-\code{CmdStanMCMC} objects have the following associated methods:
+\code{CmdStanMCMC} objects have the following methods:
 
 \tabular{ll}{
 \strong{Method} \tab \strong{Description} \cr

---FILE: man/CmdStanMLE.Rd---
@@ -9,7 +9,7 @@ A \code{CmdStanMLE} object is the fitted model object returned by the
 object.
 }
 \details{
-\code{CmdStanMLE} objects have the following associated methods:
+\code{CmdStanMLE} objects have the following methods:
 
 \tabular{ll}{
 \strong{Method} \tab \strong{Description} \cr

---FILE: man/CmdStanModel.Rd---
@@ -4,10 +4,10 @@
 \alias{CmdStanModel}
 \title{CmdStanModel objects}
 \description{
-A \code{CmdStanModel} object is an \link[R6:R6]{R6} object returned by
-the \code{\link[=cmdstan_model]{cmdstan_model()}} function. The object stores the path to a Stan
-program as well as a path to a compiled executable once created, and
-provides methods for fitting the model. See \strong{Details} section for
+A \code{CmdStanModel} object is an \link[R6:R6]{R6} object created by the
+\code{\link[=cmdstan_model]{cmdstan_model()}} function. The object stores the path to a Stan program
+and compiled executable (once created), and provides methods for fitting
+the model using Stan's algorithms. See the \strong{Details} section for
 available methods.
 }
 \details{
@@ -18,7 +18,7 @@ available methods.
 code \tab Return Stan program as a string. \cr
 print \tab Print readable version of Stan program. \cr
 stan_file \tab Return the file path to the Stan program. \cr
-exe_file \tab Return the file path to the compiled executable once compiled. \cr
+exe_file \tab Return the file path to the compiled executable. \cr
 \link[=model-method-compile]{compile} \tab Compile Stan program. \cr
 \link[=model-method-sample]{sample}
 \tab Run CmdStan's \code{""sample""} method, return \code{\link{CmdStanMCMC}} object. \cr

---FILE: man/CmdStanVB.Rd---
@@ -9,7 +9,7 @@ A \code{CmdStanVB} object is the fitted model object returned by the
 \code{\link{CmdStanModel}} object.
 }
 \details{
-\code{CmdStanVB} objects have the following associated methods:
+\code{CmdStanVB} objects have the following methods:
 
 \tabular{ll}{
 \strong{Method} \tab \strong{Description} \cr

---FILE: man/cmdstan_model.Rd---
@@ -14,7 +14,7 @@ compilation can be done later via the \code{\link[=model-method-compile]{$compil
 method.}
 
 \item{...}{Optionally, additional arguments to pass to the
-\code{\link[=model-method-compile]{$compile()}} method. Ignored if \code{compile=FALSE}.}
+\code{\link[=model-method-compile]{$compile()}} method if \code{compile=TRUE}.}
 }
 \value{
 A \code{\link{CmdStanModel}} object.

---FILE: man/cmdstanr-package.Rd---
@@ -33,17 +33,21 @@ an in-memory interface to Stan and relies on \R packages like \pkg{Rcpp}
 and \pkg{inline} to call C++ code from R. On the other hand, the \R code in
 this package does not directly call any C++ code, instead relying on
 CmdStan for compilation, running algorithms, and writing results to output
-files. Both forms of interfacing with Stan have advantages and
-disadvantages. An in-memory interface like RStan is able to offer more
-advanced features than CmdStanR (for example RStan's \code{log_prob} and
-\code{grad_log_prob} methods) but keeping up with Stan releases is more
-complicated for RStan, often requiring non-trivial changes to the
-\pkg{rstan} package and always requiring new CRAN releases of \pkg{rstan}
-and \pkg{StanHeaders}. With CmdStanR, the latest features in Stan will be
-available from \R immediately after updating CmdStan, which can be done
-with the \code{\link[=install_cmdstan]{install_cmdstan()}} function.
-
-The licenses of CmdStanR (BSD-3) and RStan (GPL-3) are also different.
+files.
+
+Both forms of interfacing with Stan have advantages and disadvantages. An
+in-memory interface like RStan is able to offer more advanced features than
+CmdStanR (for example the \code{rstan::log_prob()} and \code{rstan::grad_log_prob()}
+methods) but keeping up with Stan releases is more complicated for RStan,
+often requiring non-trivial changes to the \pkg{rstan} package and always
+requiring new CRAN releases of \pkg{rstan} and \pkg{StanHeaders}. With
+CmdStanR, the latest features in Stan will be available from \R immediately
+after updating CmdStan, which can be done with the \code{\link[=install_cmdstan]{install_cmdstan()}}
+function.
+
+Another difference between RStan and CmdStanR is the license. RStan is
+GPL-3 while the license for CmdStanR (like Stan) is BSD-3, which is a bit
+more permissive.
 }
 
 \examples{

---FILE: man/model-method-compile.Rd---
@@ -4,11 +4,11 @@
 \alias{model-method-compile}
 \title{Compile a Stan program or get the Stan code}
 \description{
-The \verb{$compile()} method of a \code{\link{CmdStanModel}} object calls CmdStan
-to translate a Stan program to C++ and then create a compiled executable.
-The resulting files are placed in the same directory as the Stan program
-associated with the \code{CmdStanModel} object. After compilation the path
-to the executable can be accesed via the \verb{$exe_file()} method.
+The \verb{$compile()} method of a \code{\link{CmdStanModel}} object calls
+CmdStan to translate a Stan program to C++ and create a compiled
+executable. The resulting files are placed in the same directory as the
+Stan program associated with the \code{CmdStanModel} object. After compilation
+the path to the executable can be accesed via the \verb{$exe_file()} method.
 }
 \section{Usage}{
 \preformatted{$compile(
@@ -27,8 +27,8 @@ $exe_file()
 \section{Arguments}{
 
 Leaving all arguments at their defaults should be fine for most users, but
-optional arguments are provided to enable new features in CmdStan (and the
-Stan Math library). See the CmdStan manual for more details.
+optional arguments are provided to enable features in CmdStan (and the Stan
+Math library). See the CmdStan manual for more details.
 \itemize{
 \item \code{quiet}: (logical) Should the verbose output from CmdStan during
 compilation be suppressed? The default is \code{TRUE}, but if you encounter an

---FILE: man/model-method-optimize.Rd---
@@ -79,7 +79,7 @@ by the installed version of CmdStan.
 \item \code{algorithm}: (string) The optimization algorithm. One of \code{""lbfgs""},
 \code{""bfgs""}, or \code{""newton""}.
 \item \code{iter}: (positive integer) The number of iterations.
-\item \code{init_alpha}: (non-negative real) The line search step size for first
+\item \code{init_alpha}: (nonnegative real) The line search step size for first
 iteration. Not applicable if \code{algorithm=""newton""}.
 }
 }

---FILE: man/model-method-sample.Rd---
@@ -103,7 +103,7 @@ per chain.
 \item \code{save_warmup}: (logical) Should warmup iterations be saved? The default
 is \code{FALSE}.
 \item \code{thin}: (positive integer) The period between saved samples. This should
-typically be left at its default (no thinning).
+typically be left at its default (no thinning) unless memory is a problem.
 \item \code{max_depth}: (positive integer) The maximum allowed tree depth for the
 NUTS engine. See the \emph{Tree Depth} section of the CmdStan manual for more
 details.
@@ -134,13 +134,13 @@ matrix (if \code{metric='dense_e'}) for initializing the inverse metric, which
 can be used as an alternative to the \code{metric_file} argument. A vector is
 interpreted as a diagonal metric. The inverse metric is usually set to an
 estimate of the posterior covariance. See the \code{adapt_engaged} argument
-above for details (and control over) on how specifying a precomputed
+above for details on (and control over) how specifying a precomputed
 inverse metric interacts with adaptation.
-\item \code{init_buffer}: (non-negative integer) Width of initial fast timestep
+\item \code{init_buffer}: (nonnegative integer) Width of initial fast timestep
 adaptation interval during warmup.
-\item \code{term_buffer}: (non-negative integer) Width of final fast timestep
+\item \code{term_buffer}: (nonnegative integer) Width of final fast timestep
 adaptation interval during warmup.
-\item \code{window}: (non-negative integer) Initial width of slow timestep/metric
+\item \code{window}: (nonnegative integer) Initial width of slow timestep/metric
 adaptation interval.
 }
 }",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,c0c8f05a0ef2bcaedc73f5f43df5b423785f3503,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-11-13T20:02:54Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-11-13T20:03:13Z,fix path in tests,tests/testthat/helper-envvars-and-paths.R,False,True,True,False,1,1,2,"---FILE: tests/testthat/helper-envvars-and-paths.R---
@@ -17,7 +17,7 @@ not_on_cran <- function() {
 
 set_cmdstan_path_for_tests <- function() {
   if (on_appveyor()) {
-    set_cmdstan_path(""C:/Users/appveyor/.cmdstanr/cmdstan"")
+    set_cmdstan_path(""C:/MinGW/msys/1.0/.cmdstanr/cmdstan"")
   } else {
     set_cmdstan_path()
   }",True,False,Implementation / Logic,3
stan-dev,cmdstanr,931917539c1420f7c88c180a16ba4b1cafa72ad6,Rok,rok.cesnovar@fri.uni-lj.si,2019-11-13T18:33:52Z,Rok,rok.cesnovar@fri.uni-lj.si,2019-11-13T18:33:52Z,fix win tests,tests/testthat/helper-envvars-and-paths.R;tests/testthat/test-model.R,False,True,True,False,11,3,14,"---FILE: tests/testthat/helper-envvars-and-paths.R---
@@ -18,3 +18,11 @@ set_cmdstan_path_for_tests <- function() {
     set_cmdstan_path()
   }
 }
+
+delete_extensions <- function() {
+  if (os_is_windows()) {
+    c("".exe"", "".o"", "".hpp"")
+  } else {
+    c("""", "".o"","".hpp"")
+  }
+}

---FILE: tests/testthat/test-model.R---
@@ -61,7 +61,7 @@ test_that(""compilation works when stan program not in cmdstan dir"", {
   expect_output(print(out), ""is up to date"")
 
   # cleanup
-  file.remove(paste0(mod_2$exe_file(), c("""", "".o"","".hpp"")))
+  file.remove(paste0(strip_ext(mod_2$exe_file()), delete_extensions()))
 })
 
 test_that(""compilation works with include_paths"", {
@@ -86,10 +86,10 @@ test_that(""compilation works with include_paths"", {
                                    include_paths = test_path(""resources"", ""stan"")),
     ""Compiling Stan program""
   )
-  expect_equal(mod_w_include$exe_file(), strip_ext(absolute_path(stan_program_w_include)))
+  expect_equal(mod_w_include$exe_file(), cmdstan_ext(strip_ext(absolute_path(stan_program_w_include))))
 
   # cleanup
-  file.remove(paste0(mod_w_include$exe_file(), c("""", "".o"","".hpp"")))
+  file.remove(paste0(strip_ext(mod_w_include$exe_file()), delete_extensions()))
 })
 
 ",True,False,File I/O and Export,3
stan-dev,cmdstanr,08d6a6e51c5a1492e1b8e8a68077622d14628f91,Jonah Gabry,jgabry@gmail.com,2019-11-12T23:58:12Z,GitHub,noreply@github.com,2019-11-12T23:58:12Z,Add github issue templates,.github/ISSUE_TEMPLATE/bug_report.md;.github/ISSUE_TEMPLATE/feature_request.md;.github/ISSUE_TEMPLATE/other.md,False,False,False,False,60,0,60,"---FILE: .github/ISSUE_TEMPLATE/bug_report.md---
@@ -0,0 +1,26 @@
+---
+name: Bug report
+about: Create a report to help us improve
+title: ''
+labels: bug
+assignees: ''
+
+---
+
+**Describe the bug**
+A description of what the bug is.
+
+**To Reproduce**
+Steps to reproduce the behavior.
+
+**Expected behavior**
+A description of what you expected to happen.
+
+**Operating system**
+Your operating system (e.g. mac os x 10.15, windows 10, etc.)
+
+**CmdStanR version number**
+Your CmdStanR version number (e.g. from `packageVersion(""cmdstanr"")`). 
+
+**Additional context**
+Add any other context about the problem here.

---FILE: .github/ISSUE_TEMPLATE/feature_request.md---
@@ -0,0 +1,20 @@
+---
+name: Feature request
+about: Suggest an idea for this project
+title: ''
+labels: feature
+assignees: ''
+
+---
+
+**Is your feature request related to a problem? Please describe.**
+A clear and concise description of what the problem is. Ex. I'm always frustrated when [...]
+
+**Describe the solution you'd like**
+A clear and concise description of what you want to happen.
+
+**Describe alternatives you've considered**
+A clear and concise description of any alternative solutions or features you've considered.
+
+**Additional context**
+Add any other context about the feature request here.

---FILE: .github/ISSUE_TEMPLATE/other.md---
@@ -0,0 +1,14 @@
+---
+name: Other
+about: Issues that don't fit under ""Bug report"" or ""Feature request""
+title: ''
+labels: ''
+assignees: ''
+
+---
+
+**Describe the issue**
+
+
+**CmdStanR version number**
+Your CmdStanR version number (e.g. from `packageVersion(""cmdstanr"")`).",False,False,Documentation / Formatting,6
stan-dev,cmdstanr,3e1873cf79957a7ce1fc879405dd5f87bbbfda8c,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-11-09T15:46:00Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-11-09T15:46:00Z,fix check,R/run.R,False,True,True,False,3,3,6,"---FILE: R/run.R---
@@ -302,9 +302,9 @@ CmdStanProcs <- R6::R6Class(
     },
     is_error_message = function(line) {
       startsWith(line, ""Exception:"") ||
-      regexpr(line, ""either mistyped or misplaced."") ||
-      regexpr(line, ""A method must be specified!"") ||
-      regexpr(line, ""is not a valid value for"")
+      (regexpr(line, ""either mistyped or misplaced."") > 0) ||
+      (regexpr(line, ""A method must be specified!"") > 0) ||
+      (regexpr(line, ""is not a valid value for"") > 0)
     },
     process_sample_output = function(out, id) {
       id <- as.character(id)",True,False,Implementation / Logic,3
stan-dev,cmdstanr,6170e501e87e9c9bfa7ab4eb1acb1b518d28214d,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-11-09T12:33:09Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-11-09T12:33:09Z,better handling of errors,R/run.R,False,True,True,False,15,3,18,"---FILE: R/run.R---
@@ -300,6 +300,12 @@ CmdStanProcs <- R6::R6Class(
       }
       invisible(self)
     },
+    is_error_message = function(line) {
+      startsWith(line, ""Exception:"") ||
+      regexpr(line, ""either mistyped or misplaced."") ||
+      regexpr(line, ""A method must be specified!"") ||
+      regexpr(line, ""is not a valid value for"")
+    },
     process_sample_output = function(out, id) {
       id <- as.character(id)
       if (length(out) == 0) {
@@ -334,9 +340,15 @@ CmdStanProcs <- R6::R6Class(
             }
             next_state <- 4 # writing csv and finishing
           }
-          if ((state > 1 && state < 4) ||
-              (state == 1 && startsWith(line, ""Exception:""))) {
-            cat(paste0(""CHAIN "", id,"": "", line, ""\n""))
+          if (state > 1 && state < 4) {
+            cat(""CHAIN "", id,"": "", line, ""\n"")
+          }
+          if (self$is_error_message(line)) {
+            # will print all remaining output in case of excpetions
+            if(state == 1) {
+              state = 2;
+            }
+            message(""CHAIN "", id,"": "", line)
           }
           private$chain_info_[id,""state""] <- next_state
         }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,b22317cfb17e92288cf8bc606212bc94d3e7d33e,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-11-09T12:00:50Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-11-09T12:00:50Z,add error on status and print stderr on quiet for other process::run,R/fit.R;R/install.R;R/model.R;R/utils.R,False,True,True,False,17,8,25,"---FILE: R/fit.R---
@@ -48,7 +48,8 @@ CmdStanMCMC <- R6::R6Class(
         args = self$output_files(),
         wd = cmdstan_path(),
         echo_cmd = TRUE,
-        echo = TRUE
+        echo = TRUE,
+        error_on_status = TRUE
       )
     },
     diagnose = function() {
@@ -60,7 +61,8 @@ CmdStanMCMC <- R6::R6Class(
         args = self$output_files(),
         wd = cmdstan_path(),
         echo_cmd = TRUE,
-        echo = TRUE
+        echo = TRUE,
+        error_on_status = TRUE
       )
     },
     draws = function() {
@@ -211,7 +213,8 @@ CmdStanVB <- R6::R6Class(
         args = self$output_files(),
         wd = cmdstan_path(),
         echo_cmd = TRUE,
-        echo = TRUE
+        echo = TRUE,
+        error_on_status = TRUE
       )
     },
     draws = function() {

---FILE: R/install.R---
@@ -67,7 +67,8 @@ install_cmdstan <- function(dir = NULL,
     echo_cmd = FALSE,
     echo = !quiet,
     spinner = quiet,
-    error_on_status = FALSE
+    error_on_status = FALSE,
+    stderr_line_callback = function(x,p) { if(quiet) message(x) }
   )
 
   if (is.na(install_log$status) || install_log$status != 0) {
@@ -121,7 +122,9 @@ cmdstan_git_checkout_branch <- function(repo_branch,
     args = make_cmdstan,
     echo = !quiet,
     echo_cmd = !quiet,
-    spinner = quiet
+    spinner = quiet,
+    stderr_line_callback = function(x,p) { if(quiet) message(x) },
+    error_on_status = TRUE
   )
   invisible(install_log)
 }

---FILE: R/model.R---
@@ -518,7 +518,8 @@ optimize_method <- function(data = NULL,
     args = runset$command_args()[[1]],
     wd = dirname(self$exe_file()),
     echo_cmd = FALSE,
-    echo = TRUE
+    echo = TRUE,
+    error_on_status = TRUE
   )
   CmdStanMLE$new(runset)
 }
@@ -646,7 +647,8 @@ variational_method <- function(data = NULL,
     args = runset$command_args()[[1]],
     wd = dirname(self$exe_file()),
     echo_cmd = FALSE,
-    echo = TRUE
+    echo = TRUE,
+    error_on_status = TRUE
   )
   CmdStanVB$new(runset)
 }

---FILE: R/utils.R---
@@ -35,7 +35,8 @@ check_target_exe <- function(exe) {
       args = exe,
       wd = cmdstan_path(),
       echo_cmd = TRUE,
-      echo = TRUE
+      echo = TRUE,
+      error_on_status = TRUE
     )
   }
 }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,39b58ce68aecdb7056ade4aa4dcaf4b02a5fae09,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-11-09T10:28:57Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-11-09T10:28:57Z,print warnings/errors always,R/model.R;R/utils.R,False,True,True,False,6,1,7,"---FILE: R/model.R---
@@ -241,7 +241,8 @@ compile_method <- function(quiet = TRUE,
     wd = cmdstan_path(),
     echo_cmd = !quiet,
     echo = !quiet,
-    spinner = quiet
+    spinner = quiet,
+    stderr_line_callback = parse_compile_error
   )
 
   private$exe_file_ <- exe

---FILE: R/utils.R---
@@ -376,3 +376,7 @@ set_num_threads <- function(num_threads) {
          call. = FALSE)
   }
 }
+
+parse_compile_error = function(line, proc) {
+  warning(line, immediate. = TRUE, call. = FALSE)
+}
\ No newline at end of file",True,False,Implementation / Logic,6
stan-dev,cmdstanr,f5cf427b796e395d9c77c5d24610e989e30f283e,jgabry,jgabry@gmail.com,2019-11-09T01:46:02Z,jgabry,jgabry@gmail.com,2019-11-09T01:46:02Z,"fix output_files

(need single | to allow vectorized)",R/fit.R,False,True,True,False,4,2,6,"---FILE: R/fit.R---
@@ -446,7 +446,7 @@ RunSet <- R6::R6Class(
     output_files = function() {
       # if we are using background processes only output the file if
       # the process finished normally
-      ok <- self$procs()$is_finished() || self$procs()$is_queued()
+      ok <- self$procs()$is_finished() | self$procs()$is_queued()
       private$output_files_[ok]
     },
 
@@ -734,7 +734,9 @@ CmdStanProcs <- R6::R6Class(
         } else if (num_failed == num_chains) {
           warning(""All chains finished unexpectedly!\n"", call. = FALSE)
         } else {
-          warning(num_failed, "" chain(s) finished unexpectedly!\n"", call. = FALSE)
+          warning(num_failed, "" chain(s) finished unexpectedly!"",
+                  immediate. = TRUE,
+                  call. = FALSE)
           cat(""The remaining chains had a mean execution time of"",
               format(round(mean(self$total_time()), 1), nsmall = 1),
               ""seconds.\n"")",True,False,Implementation / Logic,6
stan-dev,cmdstanr,5370a96ac978a3d7b06ffaebef321780d96cd8f1,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-11-08T09:30:27Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-11-08T09:30:27Z,fix for output_files for other functions,R/fit.R;tests/testthat/test-metric.R,False,True,True,False,8,3,11,"---FILE: R/fit.R---
@@ -454,7 +454,12 @@ RunSet <- R6::R6Class(
       private$diagnostic_files_
     },
     output_files = function() {
-      chain_finished <- sapply(strsplit(private$output_files_, ""-""), function(x) private$chain_info_[as.integer(x[4]), ""state""]==5)
+      chain_finished <- sapply(strsplit(private$output_files_, ""-""), function(x) {
+        # if we are using background processes only output the file if
+        # the process finished normally
+        private$chain_info_[as.integer(x[4]), ""state""] == 0 ||
+        private$chain_info_[as.integer(x[4]), ""state""] == 5
+      })
       private$output_files_[chain_finished]
     },
     # ._check_retcodes = function() all(private$retcodes_  == 0),
@@ -596,7 +601,7 @@ RunSet <- R6::R6Class(
         private$procs_
       } else {
         private$procs_[[id]] <- proc
-      }   
+      }
     }
   ),
   private = list(

---FILE: tests/testthat/test-metric.R---
@@ -12,7 +12,7 @@ if (NOT_CRAN) {
 }
 
 expect_sample_output <- function(object) {
-  testthat::expect_output(object, ""Gradient evaluation took"")
+  testthat::expect_output(object, ""Running MCMC with "")
 }
 
 # Sample ------------------------------------------------------------------",True,False,Implementation / Logic,3
stan-dev,cmdstanr,cb89c467065f99593583b2f5b02076be0c9c22a1,Ben,bbbales2@gmail.com,2019-11-07T21:59:43Z,Ben,bbbales2@gmail.com,2019-11-07T21:59:43Z,Rebuilt documentation (Issue #66),man/model-method-sample.Rd,False,False,False,False,2,2,4,"---FILE: man/model-method-sample.Rd---
@@ -25,10 +25,10 @@ some data.
   max_depth = NULL,
   adapt_engaged = TRUE,
   adapt_delta = NULL,
-  stepsize = NULL
+  stepsize = NULL,
   metric = NULL,
   metric_file = NULL,
-  inv_metric = NULL,,
+  inv_metric = NULL,
   init_buffer = NULL,
   term_buffer = NULL,
   window = NULL",False,False,Documentation / Formatting,7
stan-dev,cmdstanr,1a315a64c1659f930e22181676657d77efa34d1d,Ben,bbbales2@gmail.com,2019-11-07T21:58:55Z,Ben,bbbales2@gmail.com,2019-11-07T21:58:55Z,Fixed commas (Issue #66),R/model.R,False,True,True,False,2,2,4,"---FILE: R/model.R---
@@ -277,10 +277,10 @@ CmdStanModel$set(""public"", name = ""compile"", value = compile_method)
 #'     max_depth = NULL,
 #'     adapt_engaged = TRUE,
 #'     adapt_delta = NULL,
-#'     stepsize = NULL
+#'     stepsize = NULL,
 #'     metric = NULL,
 #'     metric_file = NULL,
-#'     inv_metric = NULL,,
+#'     inv_metric = NULL,
 #'     init_buffer = NULL,
 #'     term_buffer = NULL,
 #'     window = NULL",True,False,Implementation / Logic,6
stan-dev,cmdstanr,550da983e79b03b8c8f185dff862bebbfd498780,Ben,bbbales2@gmail.com,2019-11-07T21:06:04Z,Ben,bbbales2@gmail.com,2019-11-07T21:06:04Z,Rebuilt docs (Issue #66),man/model-method-sample.Rd,False,False,False,False,14,14,28,"---FILE: man/model-method-sample.Rd---
@@ -23,12 +23,12 @@ some data.
   save_warmup = FALSE,
   thin = NULL,
   max_depth = NULL,
-  metric = NULL,
-  metric_file = NULL,
-  inv_metric = NULL,
-  stepsize = NULL,
   adapt_engaged = TRUE,
   adapt_delta = NULL,
+  stepsize = NULL
+  metric = NULL,
+  metric_file = NULL,
+  inv_metric = NULL,,
   init_buffer = NULL,
   term_buffer = NULL,
   window = NULL
@@ -99,11 +99,14 @@ per chain.
 is \code{FALSE}.
 \item \code{thin}: (positive integer) The period between saved samples. This should
 typically be left at its default (no thinning).
-\item \code{adapt_engaged}: (logical) Do adaptation during warmup? The default is
-\code{TRUE}. If also specifying a precomputed inverse metric via the \code{inv_metric}
-argument (or \code{metric_file}) then, if \code{adapt_engaged=TRUE}, Stan will use
-the provided inverse metric just as an initial guess during adaptation. To
-turn off adaptation when using a precomputed inverse metric set
+\item \code{max_depth}: (positive integer) The maximum allowed tree depth for the
+NUTS engine. See the \emph{Tree Depth} section of the CmdStan manual for more
+details.
+\item \code{adapt_engaged}: (logical) Do warmup adaptation? The default is \code{TRUE}.
+If a precomputed inverse metric is specified via the \code{inv_metric} argument
+(or \code{metric_file}) then, if \code{adapt_engaged=TRUE}, Stan will use the
+provided inverse metric just as an initial guess during adaptation. To turn
+off adaptation when using a precomputed inverse metric set
 \code{adapt_engaged=FALSE}.
 \item \code{adapt_delta}: (real in \code{(0,1)}) The adaptation target acceptance
 statistic.
@@ -126,11 +129,8 @@ matrix (if \code{metric='dense_e'}) for initializing the inverse metric, which
 can be used as an alternative to the \code{metric_file} argument. A vector is
 interpreted as a diagonal metric. The inverse metric is usually set to an
 estimate of the posterior covariance. See the \code{adapt_engaged} argument
-above for details on how specifying a precomputed inverse metric interacts
-with adaptation.
-\item \code{max_depth}: (positive integer) The maximum allowed tree depth for the
-NUTS engine. See the \emph{Tree Depth} section of the CmdStan manual for more
-details.
+above for details (and control over) on how specifying a precomputed
+inverse metric interacts with adaptation.
 \item \code{init_buffer}: (non-negative integer) Width of initial fast timestep
 adaptation interval during warmup
 \item \code{term_buffer}: (non-negative integer) Width of final fast timestep",False,False,Documentation / Formatting,7
stan-dev,cmdstanr,2604628e9d7dc7c974b0c19097b7605f40d4ac01,Ben,bbbales2@gmail.com,2019-11-07T20:56:06Z,Ben,bbbales2@gmail.com,2019-11-07T20:56:06Z,Moved arguments around. Removed test (Issue #66),R/args.R;R/model.R;tests/testthat/test-model.R,False,True,True,False,18,19,37,"---FILE: R/args.R---
@@ -133,12 +133,12 @@ SampleArgs <- R6::R6Class(
                           save_warmup = NULL,
                           thin = NULL,
                           max_depth = NULL,
+                          adapt_engaged = NULL,
+                          adapt_delta = NULL,
+                          stepsize = NULL,
                           metric = NULL,
                           metric_file = NULL,
                           inv_metric = NULL,
-                          stepsize = NULL,
-                          adapt_engaged = NULL,
-                          adapt_delta = NULL,
                           init_buffer = NULL,
                           term_buffer = NULL,
                           window = NULL) {
@@ -151,6 +151,9 @@ SampleArgs <- R6::R6Class(
       self$save_warmup <- save_warmup
       self$thin <- thin
       self$max_depth <- max_depth
+      self$adapt_engaged <- adapt_engaged
+      self$adapt_delta <- adapt_delta
+      self$stepsize <- stepsize # TODO: cmdstanpy uses step_size but cmdstan is stepsize
       self$metric <- metric
       self$inv_metric <- inv_metric
       if (!is.null(inv_metric)) {
@@ -179,9 +182,6 @@ SampleArgs <- R6::R6Class(
       } else if (!is.null(metric_file)) {
         self$metric_file <- sapply(metric_file, absolute_path)
       }
-      self$stepsize <- stepsize # TODO: cmdstanpy uses step_size but cmdstan is stepsize
-      self$adapt_engaged <- adapt_engaged
-      self$adapt_delta <- adapt_delta
       self$init_buffer <- init_buffer
       self$term_buffer <- term_buffer
       self$window <- window

---FILE: R/model.R---
@@ -275,12 +275,12 @@ CmdStanModel$set(""public"", name = ""compile"", value = compile_method)
 #'     save_warmup = FALSE,
 #'     thin = NULL,
 #'     max_depth = NULL,
-#'     metric = NULL,
-#'     metric_file = NULL,
-#'     inv_metric = NULL,
-#'     stepsize = NULL,
 #'     adapt_engaged = TRUE,
 #'     adapt_delta = NULL,
+#'     stepsize = NULL
+#'     metric = NULL,
+#'     metric_file = NULL,
+#'     inv_metric = NULL,,
 #'     init_buffer = NULL,
 #'     term_buffer = NULL,
 #'     window = NULL
@@ -312,6 +312,9 @@ CmdStanModel$set(""public"", name = ""compile"", value = compile_method)
 #'   is `FALSE`.
 #'   * `thin`: (positive integer) The period between saved samples. This should
 #'   typically be left at its default (no thinning).
+#'   * `max_depth`: (positive integer) The maximum allowed tree depth for the
+#'   NUTS engine. See the _Tree Depth_ section of the CmdStan manual for more
+#'   details.
 #'   * `adapt_engaged`: (logical) Do warmup adaptation? The default is `TRUE`.
 #'   If a precomputed inverse metric is specified via the `inv_metric` argument
 #'   (or `metric_file`) then, if `adapt_engaged=TRUE`, Stan will use the
@@ -341,9 +344,6 @@ CmdStanModel$set(""public"", name = ""compile"", value = compile_method)
 #'   estimate of the posterior covariance. See the `adapt_engaged` argument
 #'   above for details (and control over) on how specifying a precomputed
 #'   inverse metric interacts with adaptation.
-#'   * `max_depth`: (positive integer) The maximum allowed tree depth for the
-#'   NUTS engine. See the _Tree Depth_ section of the CmdStan manual for more
-#'   details.
 #'   * `init_buffer`: (non-negative integer) Width of initial fast timestep
 #'   adaptation interval during warmup
 #'   * `term_buffer`: (non-negative integer) Width of final fast timestep
@@ -369,13 +369,13 @@ sample_method <- function(data = NULL,
                           num_samples = NULL,
                           save_warmup = FALSE,
                           thin = NULL,
+                          max_depth = NULL,
                           adapt_engaged = TRUE,
                           adapt_delta = NULL,
+                          stepsize = NULL,
                           metric = NULL,
                           metric_file = NULL,
                           inv_metric = NULL,
-                          stepsize = NULL,
-                          max_depth = NULL,
                           init_buffer = NULL,
                           term_buffer = NULL,
                           window = NULL) {
@@ -390,12 +390,12 @@ sample_method <- function(data = NULL,
     save_warmup = save_warmup,
     thin = thin,
     max_depth = max_depth,
+    adapt_engaged = adapt_engaged,
+    adapt_delta = adapt_delta,
+    stepsize = stepsize,
     metric = metric,
     metric_file = metric_file,
     inv_metric = inv_metric,
-    stepsize = stepsize,
-    adapt_engaged = adapt_engaged,
-    adapt_delta = adapt_delta,
     init_buffer = init_buffer,
     term_buffer = term_buffer,
     window = window

---FILE: tests/testthat/test-model.R---
@@ -185,7 +185,6 @@ if (NOT_CRAN) {
   )
 
   bad_arg_values_3 <- list(
-    data_file = rep(""NOT_A_FILE"", 5),
     init = rep(""NOT_A_FILE"", 10),
     metric = c(""AA"", ""BB"", ""CC"")
   )",True,False,Implementation / Logic,6
stan-dev,cmdstanr,4ba1fcf7df204b0a1e44d3ecf0c7b3943f111bb1,Ben,bbbales2@gmail.com,2019-11-06T20:38:29Z,Ben,bbbales2@gmail.com,2019-11-06T20:38:29Z,Rebuilt docs (Issue #66),man/model-method-sample.Rd,False,False,False,False,10,1,11,"---FILE: man/model-method-sample.Rd---
@@ -26,7 +26,10 @@ some data.
   metric = NULL,
   stepsize = NULL,
   adapt_engaged = TRUE,
-  adapt_delta = NULL
+  adapt_delta = NULL,
+  init_buffer = NULL,
+  term_buffer = NULL,
+  window = NULL
 )
 }
 }
@@ -116,6 +119,12 @@ precomputed metric set \code{adapt_engaged=FALSE}.
 \item \code{max_depth}: (positive integer) The maximum allowed tree depth for the
 NUTS engine. See the \emph{Tree Depth} section of the CmdStan manual for more
 details.
+\item \code{init_buffer}: (non-negative integer) Width of initial fast timestep
+adaptation interval during warmup
+\item \code{term_buffer}: (non-negative integer) Width of final fast timestep
+adaptation interval during warmup
+\item \code{window}: (non-negative integer) Initial width of slow timestep/metric
+adaptation interval
 }
 }
 ",False,False,Documentation / Formatting,7
stan-dev,cmdstanr,761a70e6eef455443cdb5c11f71697847801f91f,Ben,bbbales2@gmail.com,2019-11-06T20:33:32Z,Ben,bbbales2@gmail.com,2019-11-06T20:33:32Z,Sample works if metric_file and inv_metric are both not specified. Made checks on metric values fail appropriately (Issue #63),R/args.R;man/model-method-sample.Rd;tests/testthat/test-metric.R,False,True,True,False,29,17,46,"---FILE: R/args.R---
@@ -150,13 +150,13 @@ SampleArgs <- R6::R6Class(
       self$max_depth <- max_depth
       self$metric <- metric
       self$inv_metric <- inv_metric
-      if(!is.null(inv_metric)) {
-        if(!is.null(metric_file)) {
-          stop(""Only one of inv_metric and metric_file can be non-NULL"")
+      if (!is.null(inv_metric)) {
+        if (!is.null(metric_file)) {
+          stop(""Only one of inv_metric and metric_file can be specified"")
         }
 
         # wrap inv_metric in list if not in one
-        if(!is.list(inv_metric)) {
+        if (!is.list(inv_metric)) {
           inv_metric = list(inv_metric)
         }
 
@@ -167,12 +167,12 @@ SampleArgs <- R6::R6Class(
             tmpdir = cmdstan_tempdir(),
             fileext = "".json""
           )
-        for(i in seq_along(inv_metric_paths)) {
+        for (i in seq_along(inv_metric_paths)) {
           write_stan_json(list(inv_metric = inv_metric[[i]]), inv_metric_paths[i])
         }
 
         self$metric_file <- inv_metric_paths
-      } else {
+      } else if (!is.null(metric_file)) {
         self$metric_file <- sapply(metric_file, absolute_path)
       }
       self$stepsize <- stepsize # TODO: cmdstanpy uses step_size but cmdstan is stepsize
@@ -597,8 +597,9 @@ validate_metric <- function(metric) {
   }
 
   checkmate::assert_character(metric, any.missing = FALSE, min.len = 1)
+  checkmate::assert_subset(metric, choices = available_metrics())
 
-  return(invisible(metric %in% available_metrics()))
+  return(invisible(TRUE))
 }
 
 #' Validate metric file
@@ -614,9 +615,9 @@ validate_metric_file <- function(metric_file, num_runs) {
 
   checkmate::assert_file_exists(metric_file, access = ""r"")
 
-  if(length(metric_file) != 1 && length(metric_file) != num_runs) {
+  if (length(metric_file) != 1 && length(metric_file) != num_runs) {
     stop(length(metric_file), "" metric(s) provided. Must provide "",
-         if(num_runs > 1) ""1 or "", num_runs, "" metric(s) for "",
+         if (num_runs > 1) ""1 or "", num_runs, "" metric(s) for "",
          num_runs, "" chain(s)"")
   }
 

---FILE: man/model-method-sample.Rd---
@@ -24,6 +24,8 @@ some data.
   thin = NULL,
   max_depth = NULL,
   metric = NULL,
+  metric_file = NULL,
+  inv_metric = NULL,
   stepsize = NULL,
   adapt_engaged = TRUE,
   adapt_delta = NULL
@@ -105,14 +107,23 @@ during warmup.
 One of the following:
 \itemize{
 \item A single string from among \code{""diag_e""}, \code{""dense_e""}, \code{""unit_e""}.
-\item A character vector containing paths to files (one per chain) compatible
-with CmdStan that contain precomputed metrics. Each path must be to a
-JSON or Rdump file that contains an entry \code{inv_metric} whose value is
-either the diagonal vector or the full covariance matrix. If
-\code{adapt_engaged=TRUE}, Stan will use the provided metric just as an
-initial guess during adaptation. To turn off adaptation when using a
-precomputed metric set \code{adapt_engaged=FALSE}.
 }
+\item \code{metric_file}: (character) A character vector containing paths to files
+(one per chain) compatible with CmdStan that contain precomputed metrics.
+Each path must be to a JSON or Rdump file that contains an entry
+\code{inv_metric} whose value is either the diagonal vector or the full
+covariance matrix. If \code{adapt_engaged=TRUE}, Stan will use the provided
+metric just as an initial guess during adaptation. To turn off adaptation
+when using a precomputed metric set \code{adapt_engaged=FALSE}. Cannot be
+used in conjunction with \code{inv_metric}.
+\item \code{inv_metric}: (vector, matrix) A vector (if metric == 'diag_e') or a
+matrix (if metric == 'dense_e') for initializing the inverse metric. The
+vector is interpreted as a diagonal metric. The inverse metric is
+usually set to an estimate of the posterior covariance. If
+\code{adapt_engaged=TRUE}, Stan will use the provided metric just as an
+initial guess during adaptation. To turn off adaptation when using
+a precomputed metric set \code{adapt_engaged=FALSE}. Cannot be used in
+conjunction with \code{metric_file}.
 \item \code{max_depth}: (positive integer) The maximum allowed tree depth for the
 NUTS engine. See the \emph{Tree Depth} section of the CmdStan manual for more
 details.

---FILE: tests/testthat/test-metric.R---
@@ -117,5 +117,5 @@ test_that(""sample() method fails if metric_file and inv_metric both provided"", {
                           metric = ""diag_e"",
                           inv_metric = inv_metric_vector,
                           metric_file = inv_metric_vector_json),
-               ""Only one of inv_metric and metric_file can be non-NULL"")
+               ""Only one of inv_metric and metric_file can be specified"")
 })",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,e71ee47a07b8f97b991c9232b602d3300e5f08f7,Ben,bbbales2@gmail.com,2019-11-06T19:27:42Z,Ben,bbbales2@gmail.com,2019-11-06T19:27:42Z,"Added init_buffer, term_buffer, window arguments. (Issue #66)",R/args.R;R/model.R;tests/testthat/test-model.R,False,True,True,False,62,10,72,"---FILE: R/args.R---
@@ -39,9 +39,9 @@ CmdStanArgs <- R6::R6Class(
       self$model_name <- model_name
       self$exe_file <- exe_file
       self$run_ids <- run_ids
-      self$data_file <- repair_path(data_file)
+      self$data_file <- if(!is.null(data_file)) sapply(data_file, repair_path)
       self$seed <- seed
-      self$init <- repair_path(init)
+      self$init <- if(!is.null(init)) sapply(init, repair_path)
       self$refresh <- refresh
       self$method_args <- method_args
       self$save_diagnostics <- save_diagnostics
@@ -136,7 +136,10 @@ SampleArgs <- R6::R6Class(
                           metric = NULL,
                           stepsize = NULL,
                           adapt_engaged = NULL,
-                          adapt_delta = NULL) {
+                          adapt_delta = NULL,
+                          init_buffer = NULL,
+                          term_buffer = NULL,
+                          window = NULL) {
 
       # TODO: cmdstanpy uses different names for these but these are same as
       # regular cmdstan for now
@@ -151,6 +154,9 @@ SampleArgs <- R6::R6Class(
       self$stepsize <- stepsize # TODO: cmdstanpy uses step_size but cmdstan is stepsize
       self$adapt_engaged <- adapt_engaged
       self$adapt_delta <- adapt_delta
+      self$init_buffer <- init_buffer
+      self$term_buffer <- term_buffer
+      self$window <- window
 
       if (metric_is_file(self$metric)) {
         self$metric <- sapply(self$metric, repair_path)
@@ -195,7 +201,10 @@ SampleArgs <- R6::R6Class(
         if (!is.null(self$adapt_delta) || !is.null(self$adapt_engaged))
           ""adapt"",
         .make_arg(""adapt_delta""),
-        .make_arg(""adapt_engaged"")
+        .make_arg(""adapt_engaged""),
+        .make_arg(""init_buffer""),
+        .make_arg(""term_buffer""),
+        .make_arg(""window"")
       )
 
       # convert list to character vector
@@ -396,6 +405,18 @@ validate_sample_args <- function(self, num_runs) {
                                lower = 1,
                                len = 1,
                                null.ok = TRUE)
+  checkmate::assert_integerish(self$init_buffer,
+                               lower = 0,
+                               len = 1,
+                               null.ok = TRUE)
+  checkmate::assert_integerish(self$term_buffer,
+                               lower = 0,
+                               len = 1,
+                               null.ok = TRUE)
+  checkmate::assert_integerish(self$window,
+                               lower = 0,
+                               len = 1,
+                               null.ok = TRUE)
 
   if (length(self$stepsize) == 1) {
     checkmate::assert_number(self$stepsize, lower = .Machine$double.eps)

---FILE: R/model.R---
@@ -265,7 +265,10 @@ CmdStanModel$set(""public"", name = ""compile"", value = compile_method)
 #'     metric = NULL,
 #'     stepsize = NULL,
 #'     adapt_engaged = TRUE,
-#'     adapt_delta = NULL
+#'     adapt_delta = NULL,
+#'     init_buffer = NULL,
+#'     term_buffer = NULL,
+#'     window = NULL
 #'   )
 #'   ```
 #'
@@ -314,6 +317,12 @@ CmdStanModel$set(""public"", name = ""compile"", value = compile_method)
 #'   * `max_depth`: (positive integer) The maximum allowed tree depth for the
 #'   NUTS engine. See the _Tree Depth_ section of the CmdStan manual for more
 #'   details.
+#'   * `init_buffer`: (non-negative integer) Width of initial fast timestep
+#'   adaptation interval during warmup
+#'   * `term_buffer`: (non-negative integer) Width of final fast timestep
+#'   adaptation interval during warmup
+#'   * `window`: (non-negative integer) Initial width of slow timestep/metric
+#'   adaptation interval
 #'
 #' @section Value: The `$sample()` method returns a [`CmdStanMCMC`] object.
 #'
@@ -337,7 +346,10 @@ sample_method <- function(data = NULL,
                           adapt_delta = NULL,
                           metric = NULL,
                           stepsize = NULL,
-                          max_depth = NULL) {
+                          max_depth = NULL,
+                          init_buffer = NULL,
+                          term_buffer = NULL,
+                          window = NULL) {
 
   num_chains <- num_chains %||% 1
   checkmate::assert_integerish(num_chains, lower = 1)
@@ -352,7 +364,10 @@ sample_method <- function(data = NULL,
     metric = metric,
     stepsize = stepsize,
     adapt_engaged = adapt_engaged,
-    adapt_delta = adapt_delta
+    adapt_delta = adapt_delta,
+    init_buffer = init_buffer,
+    term_buffer = term_buffer,
+    window = window
   )
   cmdstan_args <- CmdStanArgs$new(
     method_args = sample_args,

---FILE: tests/testthat/test-model.R---
@@ -117,7 +117,10 @@ if (NOT_CRAN) {
     stepsize = 1.1,
     adapt_engaged = TRUE,
     adapt_delta = 0.7,
-    save_diagnostics = FALSE
+    save_diagnostics = FALSE,
+    init_buffer = 20,
+    term_buffer = 0,
+    window = 15
   )
 
   # using any one of these should cause sample() to error
@@ -136,17 +139,24 @@ if (NOT_CRAN) {
     stepsize = 0,
     adapt_engaged = ""NO"",
     adapt_delta = 2,
-    save_diagnostics = ""NOT_LOGICAL""
+    save_diagnostics = ""NOT_LOGICAL"",
+    init_buffer = ""NOT_INTEGER"",
+    term_buffer = ""NOT_INTEGER"",
+    window = ""NOT_INTEGER""
   )
 
   bad_arg_values_2 <- list(
     init = ""NOT_A_FILE"",
     seed = 1:10,
     stepsize = 1:10,
-    metric = c(""AA"", ""BB"")
+    metric = c(""AA"", ""BB""),
+    init_buffer = -5,
+    term_buffer = -6,
+    window = -7
   )
 
   bad_arg_values_3 <- list(
+    data_file = rep(""NOT_A_FILE"", 5),
     init = rep(""NOT_A_FILE"", 10),
     metric = c(""AA"", ""BB"", ""CC"")
   )
@@ -205,6 +215,12 @@ test_that(""sample() method errors for any invalid arguments before calling cmdst
     args[[nm]] <- bad_arg_values_2[[nm]]
     expect_error(do.call(mod$sample, args), regexp = nm)
   }
+
+  for (nm in names(bad_arg_values_3)) {
+    args <- ok_arg_values
+    args[[nm]] <- bad_arg_values_3[[nm]]
+    expect_error(do.call(mod$sample, args), regexp = nm)
+  }
 })
 
 ",True,False,Implementation / Logic,6
stan-dev,cmdstanr,2800de6c7daf0aeef094ba2247f26215f40c4370,Ben,bbbales2@gmail.com,2019-11-06T15:59:00Z,Ben,bbbales2@gmail.com,2019-11-06T15:59:00Z,Cleaned up tests and moved them to their own file. Added test inv_metrics. (Issue #63),R/args.R;R/model.R;tests/testthat/resources/data/bernoulli.inv_metric.dense_e.data.R;tests/testthat/resources/data/bernoulli.inv_metric.dense_e.json;tests/testthat/resources/data/bernoulli.inv_metric.diag_e.data.R;tests/testthat/resources/data/bernoulli.inv_metric.diag_e.json;tests/testthat/test-metric.R;tests/testthat/test-model.R,False,True,True,False,158,99,257,"---FILE: R/args.R---
@@ -134,8 +134,8 @@ SampleArgs <- R6::R6Class(
                           thin = NULL,
                           max_depth = NULL,
                           metric = NULL,
-                          inv_metric = NULL,
                           metric_file = NULL,
+                          inv_metric = NULL,
                           stepsize = NULL,
                           adapt_engaged = NULL,
                           adapt_delta = NULL) {
@@ -161,21 +161,19 @@ SampleArgs <- R6::R6Class(
         }
 
         # write all inv_metrics to disk
-        inv_metric_paths <- c()
-        for(metric_i in 1:length(inv_metric)) {
-          inv_metric_path <-
-            file.path(
-              cmdstan_tempdir(),
-              paste0(""inv_metric-"", metric_i, "".json"")
-            )
-          write_stan_json(list(inv_metric = inv_metric[[metric_i]]), inv_metric_path)
-          inv_metric_paths <- c(inv_metric_paths, inv_metric_path)
+        inv_metric_paths <-
+          tempfile(
+            pattern = paste0(""inv_metric-"", 1:length(inv_metric), ""-""),
+            tmpdir = cmdstan_tempdir(),
+            fileext = "".json""
+          )
+        for(i in seq_along(inv_metric_paths)) {
+          write_stan_json(list(inv_metric = inv_metric[[i]]), inv_metric_paths[i])
         }
 
         self$metric_file <- inv_metric_paths
       } else {
-        self$metric_file <- sapply(metric_file, repair_path)
-        self$metric_file <- sapply(self$metric_file, absolute_path)
+        self$metric_file <- sapply(metric_file, absolute_path)
       }
       self$stepsize <- stepsize # TODO: cmdstanpy uses step_size but cmdstan is stepsize
       self$adapt_engaged <- adapt_engaged
@@ -614,20 +612,12 @@ validate_metric_file <- function(metric_file, num_runs) {
     return(invisible(TRUE))
   }
 
-  checkmate::assert_character(metric_file, any.missing = FALSE, min.len = 1)
+  checkmate::assert_file_exists(metric_file, access = ""r"")
 
-  if(is.character(metric_file)) {
-    files_exist = sapply(metric_file, function(file) checkmate::test_file_exists(file, access = ""r""))
-    # TODO: need to check if in the right format (see CmdStanPy implementation)
-    if (any(!files_exist)) {
-      stop(paste0(""Could not read metric file(s): "", paste(metric_file[!files_exist], collapse = "", "")), call. = FALSE)
-    }
-
-    if(length(metric_file) != 1 && length(metric_file) != num_runs) {
-      stop(paste0(length(metric_file), "" metric(s) provided. Must provide "",
-                  if(num_runs > 1) ""1 or "" else """", num_runs, "" metric(s) for "",
-                  num_runs, "" chain(s)""))
-    }
+  if(length(metric_file) != 1 && length(metric_file) != num_runs) {
+    stop(length(metric_file), "" metric(s) provided. Must provide "",
+         if(num_runs > 1) ""1 or "", num_runs, "" metric(s) for "",
+         num_runs, "" chain(s)"")
   }
 
   invisible(TRUE)

---FILE: R/model.R---
@@ -263,8 +263,8 @@ CmdStanModel$set(""public"", name = ""compile"", value = compile_method)
 #'     thin = NULL,
 #'     max_depth = NULL,
 #'     metric = NULL,
-#'     inv_metric = NULL,
 #'     metric_file = NULL,
+#'     inv_metric = NULL,
 #'     stepsize = NULL,
 #'     adapt_engaged = TRUE,
 #'     adapt_delta = NULL
@@ -306,22 +306,22 @@ CmdStanModel$set(""public"", name = ""compile"", value = compile_method)
 #'   _Euclidean Metric_ section of the CmdStan documentation for more details.
 #'   One of the following:
 #'     - A single string from among `""diag_e""`, `""dense_e""`, `""unit_e""`.
-#'   * `inv_metric`: (vector, matrix) A vector (if metric == 'diag_e') or a
-#'     matrix (if metric == 'dense_e') for initializing the inverse metric. The
-#'     vector is interpreted as a diagonal metric. The inverse metric is
-#'     usually set to an estimate of the posterior covariance. If
-#'     `adapt_engaged=TRUE`, Stan will use the provided metric just as an
-#'     initial guess during adaptation. To turn off adaptation when using
-#'     a precomputed metric set `adapt_engaged=FALSE`. Cannot be used in
-#'     conjunction with metric_file.
 #'   * `metric_file`: (character) A character vector containing paths to files
 #'     (one per chain) compatible with CmdStan that contain precomputed metrics.
 #'     Each path must be to a JSON or Rdump file that contains an entry
 #'     `inv_metric` whose value is either the diagonal vector or the full
 #'     covariance matrix. If `adapt_engaged=TRUE`, Stan will use the provided
 #'     metric just as an initial guess during adaptation. To turn off adaptation
 #'     when using a precomputed metric set `adapt_engaged=FALSE`. Cannot be
-#'     used in conjunction with inv_metric.
+#'     used in conjunction with `inv_metric`.
+#'   * `inv_metric`: (vector, matrix) A vector (if metric == 'diag_e') or a
+#'     matrix (if metric == 'dense_e') for initializing the inverse metric. The
+#'     vector is interpreted as a diagonal metric. The inverse metric is
+#'     usually set to an estimate of the posterior covariance. If
+#'     `adapt_engaged=TRUE`, Stan will use the provided metric just as an
+#'     initial guess during adaptation. To turn off adaptation when using
+#'     a precomputed metric set `adapt_engaged=FALSE`. Cannot be used in
+#'     conjunction with `metric_file`.
 #'   * `max_depth`: (positive integer) The maximum allowed tree depth for the
 #'   NUTS engine. See the _Tree Depth_ section of the CmdStan manual for more
 #'   details.
@@ -347,8 +347,8 @@ sample_method <- function(data = NULL,
                           adapt_engaged = TRUE,
                           adapt_delta = NULL,
                           metric = NULL,
-                          inv_metric = NULL,
                           metric_file = NULL,
+                          inv_metric = NULL,
                           stepsize = NULL,
                           max_depth = NULL) {
 
@@ -363,8 +363,8 @@ sample_method <- function(data = NULL,
     thin = thin,
     max_depth = max_depth,
     metric = metric,
-    inv_metric = inv_metric,
     metric_file = metric_file,
+    inv_metric = inv_metric,
     stepsize = stepsize,
     adapt_engaged = adapt_engaged,
     adapt_delta = adapt_delta

---FILE: tests/testthat/resources/data/bernoulli.inv_metric.dense_e.data.R---
@@ -0,0 +1,3 @@
+inv_metric <- 
+structure(c(1),
+.Dim = c(1, 1))

---FILE: tests/testthat/resources/data/bernoulli.inv_metric.dense_e.json---
@@ -0,0 +1,3 @@
+{
+  ""inv_metric"" : [[1]]
+}

---FILE: tests/testthat/resources/data/bernoulli.inv_metric.diag_e.data.R---
@@ -0,0 +1 @@
+inv_metric <- c(1)

---FILE: tests/testthat/resources/data/bernoulli.inv_metric.diag_e.json---
@@ -0,0 +1,3 @@
+{
+  ""inv_metric"" : [1]
+}

---FILE: tests/testthat/test-metric.R---
@@ -0,0 +1,121 @@
+# Setup -------------------------------------------------------------------
+NOT_CRAN <-
+  identical(Sys.getenv(""NOT_CRAN""), ""true"") ||
+  identical(Sys.getenv(""TRAVIS""), ""true"")
+
+if (NOT_CRAN) {
+  set_cmdstan_path()
+  stan_program <- file.path(cmdstan_path(), ""examples"", ""bernoulli"", ""bernoulli.stan"")
+  mod <- cmdstan_model(stan_file = stan_program)
+
+  data_list <- list(N = 10, y = c(0,1,0,0,0,0,0,0,0,1))
+}
+
+expect_sample_output <- function(object) {
+  testthat::expect_output(object, ""Gradient evaluation took"")
+}
+
+# Sample ------------------------------------------------------------------
+context(""CmdStanModel-sample-with-metric"")
+
+test_that(""sample() method works with provided inv_metrics"", {
+  skip_on_cran()
+
+  inv_metric_vector <- array(1, dim = c(1))
+  inv_metric_matrix <- matrix(1, nrow = 1, ncol = 1)
+
+  inv_metric_vector_json <- test_path(""resources"", ""data"", ""bernoulli.inv_metric.diag_e.json"")
+  inv_metric_matrix_json <- test_path(""resources"", ""data"", ""bernoulli.inv_metric.dense_e.json"")
+
+  inv_metric_vector_r <- test_path(""resources"", ""data"", ""bernoulli.inv_metric.diag_e.data.R"")
+  inv_metric_matrix_r <- test_path(""resources"", ""data"", ""bernoulli.inv_metric.dense_e.data.R"")
+
+  expect_sample_output(fit_r <- mod$sample(data = data_list,
+                                           num_chains = 1,
+                                           metric = ""diag_e"",
+                                           inv_metric = inv_metric_vector))
+
+  expect_sample_output(fit_r <- mod$sample(data = data_list,
+                                           num_chains = 1,
+                                           metric = ""dense_e"",
+                                           inv_metric = inv_metric_matrix))
+
+  expect_sample_output(fit_json <- mod$sample(data = data_list,
+                                              num_chains = 1,
+                                              metric = ""diag_e"",
+                                              metric_file = inv_metric_vector_json))
+
+  expect_sample_output(fit_json <- mod$sample(data = data_list,
+                                              num_chains = 1,
+                                              metric = ""dense_e"",
+                                              metric_file = inv_metric_matrix_json))
+
+  expect_sample_output(fit_r <- mod$sample(data = data_list,
+                                           num_chains = 1,
+                                           metric = ""diag_e"",
+                                           metric_file = inv_metric_vector_r))
+
+  expect_sample_output(fit_r <- mod$sample(data = data_list,
+                                           num_chains = 1,
+                                           metric = ""dense_e"",
+                                           metric_file = inv_metric_matrix_r))
+})
+
+
+test_that(""sample() method works with lists of inv_metrics"", {
+  skip_on_cran()
+
+  inv_metric_vector <- array(1, dim = c(1))
+  inv_metric_vector_json <- test_path(""resources"", ""data"", ""bernoulli.inv_metric.diag_e.json"")
+
+  expect_sample_output(fit_r <- mod$sample(data = data_list,
+                                           num_chains = 1,
+                                           metric = ""diag_e"",
+                                           inv_metric = list(inv_metric_vector)))
+
+  expect_sample_output(fit_r <- mod$sample(data = data_list,
+                                           num_chains = 2,
+                                           metric = ""diag_e"",
+                                           inv_metric = list(inv_metric_vector, inv_metric_vector)))
+
+  expect_error(fit_r <- mod$sample(data = data_list,
+                                   num_chains = 3,
+                                   metric = ""diag_e"",
+                                   inv_metric = list(inv_metric_vector, inv_metric_vector)),
+               ""2 metric\\(s\\) provided. Must provide 1 or 3 metric\\(s\\) for 3 chain\\(s\\)"")
+
+  expect_sample_output(fit_r <- mod$sample(data = data_list,
+                                           num_chains = 1,
+                                           metric = ""diag_e"",
+                                           metric_file = list(inv_metric_vector_json)))
+
+  expect_sample_output(fit_r <- mod$sample(data = data_list,
+                                           num_chains = 2,
+                                           metric = ""diag_e"",
+                                           metric_file = list(inv_metric_vector_json, inv_metric_vector_json)))
+
+  expect_sample_output(fit_r <- mod$sample(data = data_list,
+                                           num_chains = 2,
+                                           metric = ""diag_e"",
+                                           metric_file = c(inv_metric_vector_json, inv_metric_vector_json)))
+
+  expect_error(fit_r <- mod$sample(data = data_list,
+                                   num_chains = 3,
+                                   metric = ""diag_e"",
+                                   metric_file = c(inv_metric_vector_json, inv_metric_vector_json)),
+               ""2 metric\\(s\\) provided. Must provide 1 or 3 metric\\(s\\) for 3 chain\\(s\\)"")
+})
+
+test_that(""sample() method fails if metric_file and inv_metric both provided"", {
+  skip_on_cran()
+
+  inv_metric_vector <- array(1, dim = c(1))
+  inv_metric_vector_json <- test_path(""resources"", ""data"", ""bernoulli.inv_metric.diag_e.json"")
+
+  expect_error(mod$sample(data = data_file_r,
+                          num_chains = 1,
+                          metric = ""diag_e"",
+                          inv_metric = inv_metric_vector,
+                          metric_file = inv_metric_vector_json),
+               ""Only one of inv_metric and metric_file can be non-NULL"")
+})

---FILE: tests/testthat/test-model.R---
@@ -183,68 +183,6 @@ test_that(""sample() method works with init file"", {
   expect_sample_output(mod$sample(data = data_file_r, init = init_file))
 })
 
-test_that(""sample() method works with provided inv_metrics"", {
-  skip_on_cran()
-
-  inv_metric_vector <- array(1, dim = c(1))
-  inv_metric_matrix <- matrix(1, nrow = 1, ncol = 1)
-
-  inv_metric_vector_json <- test_path(""resources"", ""data"", ""bernoulli.inv_metric.diag_e.json"")
-  inv_metric_matrix_json <- test_path(""resources"", ""data"", ""bernoulli.inv_metric.dense_e.json"")
-
-  inv_metric_vector_r <- test_path(""resources"", ""data"", ""bernoulli.inv_metric.diag_e.data.R"")
-  inv_metric_matrix_r <- test_path(""resources"", ""data"", ""bernoulli.inv_metric.dense_e.data.R"")
-
-  expect_sample_output(fit_r <- mod$sample(data = data_file_r,
-                                           num_chains = 1,
-                                           metric = ""diag_e"",
-                                           inv_metric = inv_metric_vector))
-  expect_is(fit_r, ""CmdStanMCMC"")
-
-  expect_sample_output(fit_r <- mod$sample(data = data_file_r,
-                                           num_chains = 1,
-                                           metric = ""dense_e"",
-                                           inv_metric = inv_metric_matrix))
-  expect_is(fit_r, ""CmdStanMCMC"")
-
-  expect_sample_output(fit_json <- mod$sample(data = data_file_json,
-                                              num_chains = 1,
-                                              metric = ""diag_e"",
-                                              metric_file = inv_metric_vector_json))
-  expect_is(fit_json, ""CmdStanMCMC"")
-
-  expect_sample_output(fit_json <- mod$sample(data = data_file_json,
-                                              num_chains = 1,
-                                              metric = ""dense_e"",
-                                              metric_file = inv_metric_matrix_json))
-  expect_is(fit_json, ""CmdStanMCMC"")
-
-  expect_sample_output(fit_r <- mod$sample(data = data_file_json,
-                                              num_chains = 1,
-                                              metric = ""diag_e"",
-                                              metric_file = inv_metric_vector_r))
-  expect_is(fit_r, ""CmdStanMCMC"")
-
-  expect_sample_output(fit_r <- mod$sample(data = data_file_json,
-                                              num_chains = 1,
-                                              metric = ""dense_e"",
-                                              metric_file = inv_metric_matrix_r))
-  expect_is(fit_r, ""CmdStanMCMC"")
-})
-
-test_that(""sample() method fails if metric_file and inv_metric both provided"", {
-  skip_on_cran()
-
-  inv_metric_vector <- array(1, dim = c(1))
-  inv_metric_vector_json <- test_path(""resources"", ""data"", ""bernoulli.inv_metric.diag_e.json"")
-
-  expect_error(mod$sample(data = data_file_r,
-                          num_chains = 1,
-                          metric = ""diag_e"",
-                          inv_metric = inv_metric_vector,
-                          metric_file = inv_metric_vector_json))
-})
-
 test_that(""sample() method runs when all arguments specified"", {
   skip_on_cran()
 ",True,False,Implementation / Logic,6
stan-dev,cmdstanr,05f646b4c52d90516e2919e3b44ba8a0ce6b0084,Ben,bbbales2@gmail.com,2019-11-05T22:23:47Z,Ben,bbbales2@gmail.com,2019-11-05T22:23:47Z,Added code to allow specification of custom metric (Issue #63),R/args.R;R/model.R;tests/testthat/test-model.R,False,True,True,False,155,49,204,"---FILE: R/args.R---
@@ -134,6 +134,8 @@ SampleArgs <- R6::R6Class(
                           thin = NULL,
                           max_depth = NULL,
                           metric = NULL,
+                          inv_metric = NULL,
+                          metric_file = NULL,
                           stepsize = NULL,
                           adapt_engaged = NULL,
                           adapt_delta = NULL) {
@@ -147,15 +149,38 @@ SampleArgs <- R6::R6Class(
       self$thin <- thin
       self$max_depth <- max_depth
       self$metric <- metric
-      # self$metric_file <- character()
+      self$inv_metric <- inv_metric
+      if(!is.null(inv_metric)) {
+        if(!is.null(metric_file)) {
+          stop(""Only one of inv_metric and metric_file can be non-NULL"")
+        }
+
+        # wrap inv_metric in list if not in one
+        if(!is.list(inv_metric)) {
+          inv_metric = list(inv_metric)
+        }
+
+        # write all inv_metrics to disk
+        inv_metric_paths <- c()
+        for(metric_i in 1:length(inv_metric)) {
+          inv_metric_path <-
+            file.path(
+              cmdstan_tempdir(),
+              paste0(""inv_metric-"", metric_i, "".json"")
+            )
+          write_stan_json(list(inv_metric = inv_metric[[metric_i]]), inv_metric_path)
+          inv_metric_paths <- c(inv_metric_paths, inv_metric_path)
+        }
+
+        self$metric_file <- inv_metric_paths
+      } else {
+        self$metric_file <- sapply(metric_file, repair_path)
+        self$metric_file <- sapply(self$metric_file, absolute_path)
+      }
       self$stepsize <- stepsize # TODO: cmdstanpy uses step_size but cmdstan is stepsize
       self$adapt_engaged <- adapt_engaged
       self$adapt_delta <- adapt_delta
 
-      if (metric_is_file(self$metric)) {
-        self$metric <- sapply(self$metric, repair_path)
-      }
-
       if (is.logical(self$adapt_engaged)) {
         self$adapt_engaged <- as.integer(self$adapt_engaged)
       }
@@ -166,7 +191,7 @@ SampleArgs <- R6::R6Class(
     },
     validate = function(num_runs) {
       validate_sample_args(self, num_runs)
-      self$metric <- maybe_recycle_metric(self$metric, num_runs)
+      self$metric_file <- maybe_recycle_metric_file(self$metric_file, num_runs)
       invisible(self)
     },
 
@@ -188,7 +213,8 @@ SampleArgs <- R6::R6Class(
         .make_arg(""save_warmup""),
         .make_arg(""thin""),
         ""algorithm=hmc"",
-        .make_arg(""metric"", idx),
+        .make_arg(""metric""),
+        .make_arg(""metric_file"", idx),
         .make_arg(""stepsize"", idx),
         ""engine=nuts"",
         .make_arg(""max_depth""),
@@ -408,7 +434,8 @@ validate_sample_args <- function(self, num_runs) {
 
   # TODO: implement other checks for metric from cmdstanpy:
   # https://github.com/stan-dev/cmdstanpy/blob/master/cmdstanpy/cmdstan_args.py#L130
-  validate_metric(self$metric, num_runs)
+  validate_metric(self$metric)
+  validate_metric_file(self$metric_file, num_runs)
 
   invisible(TRUE)
 }
@@ -560,68 +587,70 @@ maybe_generate_seed <- function(seed, num_runs) {
   seed
 }
 
-
-# Check if metric speficied as file(s).
-# This particular function doesn't check if files exist
-metric_is_file <- function(metric) {
-  if (is.null(metric)) return(FALSE)
-  if (length(metric) > 1) return(TRUE)
-  !metric %in% available_metrics()
-}
-
 #' Validate metric
 #' @noRd
 #' @param metric User's `metric` argument.
 #' @param num_runs Number of CmdStan runs (number of MCMC chains).
 #' @return Either throws an error or returns `invisible(TRUE)`.
 #'
-validate_metric <- function(metric, num_runs) {
+validate_metric <- function(metric) {
   if (is.null(metric)) {
     return(invisible(TRUE))
   }
 
   checkmate::assert_character(metric, any.missing = FALSE, min.len = 1)
 
-  # TODO: need to check if in the right format (see CmdStanPy implementation)
-  if (length(metric) == 1) {
-    must_have_file <- !metric %in% available_metrics()
-    if (must_have_file) {
-      if (!checkmate::test_file_exists(metric, access = ""r"")) {
-        stop(""'metric' is not one of {'diag_e', 'dense_e', 'unit_e'} but "",
-             ""is also not a path to a readable file."", call. = FALSE)
-      }
+  return(invisible(metric %in% available_metrics()))
+}
+
+#' Validate metric file
+#' @noRd
+#' @param metric_file User's `metric_file` argument.
+#' @param num_runs Number of CmdStan runs (number of MCMC chains).
+#' @return Either throws an error or returns `invisible(TRUE)`.
+#'
+validate_metric_file <- function(metric_file, num_runs) {
+  if (is.null(metric_file)) {
+    return(invisible(TRUE))
+  }
+
+  checkmate::assert_character(metric_file, any.missing = FALSE, min.len = 1)
+
+  if(is.character(metric_file)) {
+    files_exist = sapply(metric_file, function(file) checkmate::test_file_exists(file, access = ""r""))
+    # TODO: need to check if in the right format (see CmdStanPy implementation)
+    if (any(!files_exist)) {
+      stop(paste0(""Could not read metric file(s): "", paste(metric_file[!files_exist], collapse = "", "")), call. = FALSE)
+    }
+
+    if(length(metric_file) != 1 && length(metric_file) != num_runs) {
+      stop(paste0(length(metric_file), "" metric(s) provided. Must provide "",
+                  if(num_runs > 1) ""1 or "" else """", num_runs, "" metric(s) for "",
+                  num_runs, "" chain(s)""))
     }
-  } else if (length(metric) != num_runs) {
-    stop(""'metric' must have length equal to one or the number of chains."",
-         call. = FALSE)
-  } else {
-    checkmate::assert_file_exists(metric, access = ""r"")
   }
 
   invisible(TRUE)
 }
 
-#' Recycle metric if not a file (i.e. is one of 'diag_e', 'dense_e', 'unit_e')
+#' Recycle metric_file if not NULL
 #' @noRd
-#' @param metric Already validated `metric` argument.
+#' @param metric_file Path to already validated `metric_file` argument.
 #' @param num_runs Number of CmdStan runs.
-#' @return `metric`, unless a string of length 1 (and not a file path), in which
-#'   case `rep(metric, num_runs)`.
-maybe_recycle_metric <- function(metric, num_runs) {
-  if (is.null(metric) ||
-      length(metric) == num_runs ||
-      !metric %in% available_metrics()) {
-    return(metric)
+#' @return `rep(metric_file, num_runs)` if metric_file is a single path, otherwise
+#'    return `metric_file`.
+maybe_recycle_metric_file <- function(metric_file, num_runs) {
+  if (is.null(metric_file) ||
+      length(metric_file) == num_runs) {
+    return(metric_file)
   }
-  rep(metric, num_runs)
+  rep(metric_file, num_runs)
 }
 
 available_metrics <- function() {
   c(""unit_e"", ""diag_e"", ""dense_e"")
 }
 
-
-
 # Composition helpers -----------------------------------------------------
 
 #' Helper function to make valid CmdStan arguments

---FILE: R/model.R---
@@ -263,6 +263,8 @@ CmdStanModel$set(""public"", name = ""compile"", value = compile_method)
 #'     thin = NULL,
 #'     max_depth = NULL,
 #'     metric = NULL,
+#'     inv_metric = NULL,
+#'     metric_file = NULL,
 #'     stepsize = NULL,
 #'     adapt_engaged = TRUE,
 #'     adapt_delta = NULL
@@ -304,13 +306,22 @@ CmdStanModel$set(""public"", name = ""compile"", value = compile_method)
 #'   _Euclidean Metric_ section of the CmdStan documentation for more details.
 #'   One of the following:
 #'     - A single string from among `""diag_e""`, `""dense_e""`, `""unit_e""`.
-#'     - A character vector containing paths to files (one per chain) compatible
-#'     with CmdStan that contain precomputed metrics. Each path must be to a
-#'     JSON or Rdump file that contains an entry `inv_metric` whose value is
-#'     either the diagonal vector or the full covariance matrix. If
+#'   * `inv_metric`: (vector, matrix) A vector (if metric == 'diag_e') or a
+#'     matrix (if metric == 'dense_e') for initializing the inverse metric. The
+#'     vector is interpreted as a diagonal metric. The inverse metric is
+#'     usually set to an estimate of the posterior covariance. If
 #'     `adapt_engaged=TRUE`, Stan will use the provided metric just as an
-#'     initial guess during adaptation. To turn off adaptation when using a
-#'     precomputed metric set `adapt_engaged=FALSE`.
+#'     initial guess during adaptation. To turn off adaptation when using
+#'     a precomputed metric set `adapt_engaged=FALSE`. Cannot be used in
+#'     conjunction with metric_file.
+#'   * `metric_file`: (character) A character vector containing paths to files
+#'     (one per chain) compatible with CmdStan that contain precomputed metrics.
+#'     Each path must be to a JSON or Rdump file that contains an entry
+#'     `inv_metric` whose value is either the diagonal vector or the full
+#'     covariance matrix. If `adapt_engaged=TRUE`, Stan will use the provided
+#'     metric just as an initial guess during adaptation. To turn off adaptation
+#'     when using a precomputed metric set `adapt_engaged=FALSE`. Cannot be
+#'     used in conjunction with inv_metric.
 #'   * `max_depth`: (positive integer) The maximum allowed tree depth for the
 #'   NUTS engine. See the _Tree Depth_ section of the CmdStan manual for more
 #'   details.
@@ -336,6 +347,8 @@ sample_method <- function(data = NULL,
                           adapt_engaged = TRUE,
                           adapt_delta = NULL,
                           metric = NULL,
+                          inv_metric = NULL,
+                          metric_file = NULL,
                           stepsize = NULL,
                           max_depth = NULL) {
 
@@ -350,6 +363,8 @@ sample_method <- function(data = NULL,
     thin = thin,
     max_depth = max_depth,
     metric = metric,
+    inv_metric = inv_metric,
+    metric_file = metric_file,
     stepsize = stepsize,
     adapt_engaged = adapt_engaged,
     adapt_delta = adapt_delta

---FILE: tests/testthat/test-model.R---
@@ -183,6 +183,68 @@ test_that(""sample() method works with init file"", {
   expect_sample_output(mod$sample(data = data_file_r, init = init_file))
 })
 
+test_that(""sample() method works with provided inv_metrics"", {
+  skip_on_cran()
+
+  inv_metric_vector <- array(1, dim = c(1))
+  inv_metric_matrix <- matrix(1, nrow = 1, ncol = 1)
+
+  inv_metric_vector_json <- test_path(""resources"", ""data"", ""bernoulli.inv_metric.diag_e.json"")
+  inv_metric_matrix_json <- test_path(""resources"", ""data"", ""bernoulli.inv_metric.dense_e.json"")
+
+  inv_metric_vector_r <- test_path(""resources"", ""data"", ""bernoulli.inv_metric.diag_e.data.R"")
+  inv_metric_matrix_r <- test_path(""resources"", ""data"", ""bernoulli.inv_metric.dense_e.data.R"")
+
+  expect_sample_output(fit_r <- mod$sample(data = data_file_r,
+                                           num_chains = 1,
+                                           metric = ""diag_e"",
+                                           inv_metric = inv_metric_vector))
+  expect_is(fit_r, ""CmdStanMCMC"")
+
+  expect_sample_output(fit_r <- mod$sample(data = data_file_r,
+                                           num_chains = 1,
+                                           metric = ""dense_e"",
+                                           inv_metric = inv_metric_matrix))
+  expect_is(fit_r, ""CmdStanMCMC"")
+
+  expect_sample_output(fit_json <- mod$sample(data = data_file_json,
+                                              num_chains = 1,
+                                              metric = ""diag_e"",
+                                              metric_file = inv_metric_vector_json))
+  expect_is(fit_json, ""CmdStanMCMC"")
+
+  expect_sample_output(fit_json <- mod$sample(data = data_file_json,
+                                              num_chains = 1,
+                                              metric = ""dense_e"",
+                                              metric_file = inv_metric_matrix_json))
+  expect_is(fit_json, ""CmdStanMCMC"")
+
+  expect_sample_output(fit_r <- mod$sample(data = data_file_json,
+                                              num_chains = 1,
+                                              metric = ""diag_e"",
+                                              metric_file = inv_metric_vector_r))
+  expect_is(fit_r, ""CmdStanMCMC"")
+
+  expect_sample_output(fit_r <- mod$sample(data = data_file_json,
+                                              num_chains = 1,
+                                              metric = ""dense_e"",
+                                              metric_file = inv_metric_matrix_r))
+  expect_is(fit_r, ""CmdStanMCMC"")
+})
+
+test_that(""sample() method fails if metric_file and inv_metric both provided"", {
+  skip_on_cran()
+
+  inv_metric_vector <- array(1, dim = c(1))
+  inv_metric_vector_json <- test_path(""resources"", ""data"", ""bernoulli.inv_metric.diag_e.json"")
+
+  expect_error(mod$sample(data = data_file_r,
+                          num_chains = 1,
+                          metric = ""diag_e"",
+                          inv_metric = inv_metric_vector,
+                          metric_file = inv_metric_vector_json))
+})
+
 test_that(""sample() method runs when all arguments specified"", {
   skip_on_cran()
 ",True,False,Implementation / Logic,6
stan-dev,cmdstanr,c2badbe8d18ddf3278dd0ac20b956e3b699b3c88,jgabry,jgabry@gmail.com,2019-11-04T21:50:12Z,jgabry,jgabry@gmail.com,2019-11-04T21:50:12Z,"Update fit.R

Fix issue where tempfiles were overwritten",R/fit.R,False,True,True,False,8,6,14,"---FILE: R/fit.R---
@@ -364,18 +364,20 @@ RunSet <- R6::R6Class(
       private$diagnostic_files_ <- NULL
       if (args$save_diagnostics) {
         private$diagnostic_files_ <-
-          file.path(
-            cmdstan_tempdir(),
-            paste0(args$csv_basename(), ""-diagnostic-"", args$run_ids, "".csv"")
+          tempfile(
+            pattern = paste0(args$csv_basename(), ""-diagnostic-"", args$run_ids, ""-""),
+            tmpdir = cmdstan_tempdir(),
+            fileext = "".csv""
           )
         invisible(file.create(private$diagnostic_files_))
       }
 
       # output csv files if diagnostic_file=TRUE
       private$output_files_ <-
-        file.path(
-          cmdstan_tempdir(),
-          paste0(args$csv_basename(), ""-"", args$run_ids, "".csv"")
+        tempfile(
+          pattern = paste0(args$csv_basename(), ""-"", args$run_ids, ""-""),
+          tmpdir = cmdstan_tempdir(),
+          fileext = "".csv""
         )
       invisible(file.create(private$output_files_))
 ",True,False,Implementation / Logic,6
stan-dev,cmdstanr,7da73ae4f345ae09049831159361a402769b2013,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-11-03T17:27:18Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-11-03T17:27:18Z,fix docs,R/fit.R;man/CmdStanMCMC.Rd,False,True,True,False,2,2,4,"---FILE: R/fit.R---
@@ -21,7 +21,7 @@
 #'  `draws` \tab
 #'    Return post-warmup draws as an `iters x chains x variables` array. \cr
 #'  `time` \tab Return execution times of all chains \cr
-#'  `output(id)` \tab Return the stdout and stderr of the chain with the provided id
+#'  `output(id)` \tab Return the stdout and stderr of the chain with the provided id \cr
 #'  [`save_output_files`][fit-method-save_output_files]
 #'    \tab Save output CSV files to a specified location. \cr
 #'  [`save_data_file`][fit-method-save_data_file]

---FILE: man/CmdStanMCMC.Rd---
@@ -19,7 +19,7 @@ objects.
 \code{draws} \tab
 Return post-warmup draws as an \code{iters x chains x variables} array. \cr
 \code{time} \tab Return execution times of all chains \cr
-\code{output(id)} \tab Return the stdout and stderr of the chain with the provided id
+\code{output(id)} \tab Return the stdout and stderr of the chain with the provided id \cr
 \code{\link[=fit-method-save_output_files]{save_output_files}}
 \tab Save output CSV files to a specified location. \cr
 \code{\link[=fit-method-save_data_file]{save_data_file}}",True,False,Documentation / Formatting,7
stan-dev,cmdstanr,80e819cfd6ed91e0d2450bdad7ee63144e94801c,jgabry,jgabry@gmail.com,2019-11-01T00:30:11Z,jgabry,jgabry@gmail.com,2019-11-01T00:30:11Z,actually don't error if installation exists,inst/make_cmdstan.sh,False,False,False,False,6,7,13,"---FILE: inst/make_cmdstan.sh---
@@ -111,9 +111,9 @@ fi
 
 if [[ ${OVERWRITE} -ne 1 ]]; then
     if [[ -d ${INSTALL_DIR} ]]; then
-        error_msg ""Error: an installation already exists at ${RELDIR}/cmdstan.""
+        error_msg ""Error: an installation already exists at ${RELDIR}/cmdstan""
         error_msg ""Please remove or rename the 'cmdstan' folder or set overwrite=TRUE in install_cmdstan().""
-        exit 1;
+        exit 0; # don't actually error though
     fi
 fi
 
@@ -165,12 +165,11 @@ else
 fi
 
 pushd cmdstan > /dev/null
-echo ""* Building CmdStan binaries""
+echo ""* Building CmdStan binaries.""
 build_cmdstan
-echo ""* Installed ${CS} to ${RELDIR}/cmdstan""
 
-# cleanup
+echo ""* Cleaning up ...""
 pushd -0 > /dev/null
 dirs -c > /dev/null
-echo """"
-echo ""* CmdStan installation location: `ls -Fd ${RELDIR}/cmdstan`""
+echo ""* Finished installing CmdStan to `ls -Fd ${RELDIR}/cmdstan`""
+",False,False,Implementation / Logic,3
stan-dev,cmdstanr,a27db12da6c96c9c435e9da9b9d77598e2a056c7,jgabry,jgabry@gmail.com,2019-10-31T21:12:15Z,jgabry,jgabry@gmail.com,2019-10-31T21:12:15Z,"Update install.R

* Still return install_log even if an error",R/install.R,False,True,True,False,15,2,17,"---FILE: R/install.R---
@@ -57,9 +57,22 @@ install_cmdstan <- function(dir = NULL,
     args = make_cmdstan,
     echo = !quiet,
     echo_cmd = !quiet,
-    spinner = quiet
+    spinner = quiet,
+    error_on_status = FALSE
   )
 
+  if (is.na(install_log$status) || install_log$status != 0) {
+    if (!quiet) {
+      suggestion <- ""See the error message(s) above.""
+    } else {
+      suggestion <- ""Please try again with 'quiet=FALSE' to get the full error output.""
+    }
+    cat(""\n"")
+    warning(""There was a problem during installation. "", suggestion,
+            call. = FALSE)
+    return(invisible(install_log))
+  }
+
   if (!is.null(dir)) {
     install_path <- file.path(dir, ""cmdstan"")
   } else {
@@ -68,7 +81,7 @@ install_cmdstan <- function(dir = NULL,
 
   message(
     ""\nUse set_cmdstan_path('"", install_path, ""') "",
-    ""to point CmdStanR to the location of the new installation.""
+    ""to point CmdStanR to the location of the CmdStan installation.""
   )
   invisible(install_log)
 }",True,False,Implementation / Logic,6
stan-dev,cmdstanr,c8b9355c59a0ecd95f556e4d100afda62f5b3413,jgabry,jgabry@gmail.com,2019-10-31T21:07:07Z,jgabry,jgabry@gmail.com,2019-10-31T21:07:07Z,"Update make_cmdstan.sh

* Define echoerr() so we can get red text for important error messages

* Clean up the other echo lines a little bit

* now errors if finds an existing installation but overwrite is FALSE",inst/make_cmdstan.sh,False,False,False,False,27,27,54,"---FILE: inst/make_cmdstan.sh---
@@ -1,8 +1,7 @@
 #!/usr/bin/env bash
 
-# install a cmdstan release into a specified directory
+# install a CmdStan release into a specified directory
 #  - build binaries, compile example model to build model header
-#  - symlink downloaded version as ""cmdstan""
 
 while getopts "":d:v:j:wrob:u:c"" opt; do
   case $opt in
@@ -81,57 +80,58 @@ build_cmdstan() {
     fi
 }
 
+echoerr() {
+  printf ""%s\n"" ""$*"" >&2;
+}
+
 INSTALL_DIR=cmdstan
 pushd ${RELDIR} > /dev/null
 
 if [[ ${REPO_CHECKOUT_BRANCH} -ne 0 ]]; then
     git fetch origin
     PULL_RC=$?
     if [[ ${PULL_RC} -ne 0 ]]; then
-        echo ""error pulling from the repository""
-        echo ""please check if the branch exists on the clone repository and""
-        echo ""there are not any unstashed changes in ${RELDIR}/cmdstan""
+        echoerr ""Error: pulling from the repository failed.""
+        echoerr ""Please check that the branch exists in the repository to be cloned,""
+        echoerr ""and that there are not any unstashed changes in ${RELDIR}/cmdstan.""
         exit ${GIT_RC}
     fi
     git checkout ${REPO_BRANCH}
     CHECKOUT_RC=$?
     if [[ ${CHECKOUT_RC} -ne 0 ]]; then
-        echo ""error checking out git branch""
+        echoerr ""Error: checking out git branch failed.""
         exit ${GIT_RC}
     fi
     git submodule update --recursive
     cleanup_cmdstan
     build_cmdstan
-    echo ""branch checkout and rebuild done""
+    echo ""* Finished checking out branch and rebuilding.""
     exit 0;
 fi
 
 if [[ ${OVERWRITE} -ne 1 ]]; then
     if [[ -d ${INSTALL_DIR} ]]; then
-        echo ""cmdstan found in ${RELDIR}/, installation stopped""
-        echo ""remove the cmdstan folder or set overwrite = TRUE in install_cmdstan()""
-        echo """"
-        echo ""CmdStan installation location: `ls -Fd ${RELDIR}/cmdstan`""
-        exit 0;
+        echoerr ""Error: an installation already exists at ${RELDIR}/cmdstan.""
+        echoerr ""Please remove the 'cmdstan' folder or set overwrite=TRUE in install_cmdstan().""
+        exit 1;
     fi
 fi
 
 if [[ -e cmdstan ]]; then
-    echo ""removing the existing installation of cmdstan""
+    echo ""* Removing the existing installation of CmdStan.""
     rm -rf cmdstan
 fi
 
 if [[ ${REPO_CLONE} -ne 0 ]]; then
-    echo ""cloning ${REPO_URL} and checking out branch ${REPO_BRANCH}""
-    echo ""this may take a few minutes ...""
+    echo ""* Cloning ${REPO_URL} and checking out branch ${REPO_BRANCH}. This may take a few minutes ...""
     git clone --recursive ${REPO_URL} -b ${REPO_BRANCH} ${INSTALL_DIR}
     GIT_RC=$?
     if [[ ${GIT_RC} -ne 0 ]]; then
-        echo ""error cloning repository""
+        echoerr ""Error: cloning repository failed.""
         exit ${GIT_RC}
     fi
 else
-    
+
     if [ -z ${VER} ]; then
         TAG=`curl -s https://api.github.com/repos/stan-dev/cmdstan/releases/latest | grep ""tag_name""`
         echo $TAG > tmp-tag
@@ -141,36 +141,36 @@ else
 
     CS=cmdstan-${VER}
 
-    echo ""installing cmdstan ${VER} in ${RELDIR}""
-    echo ""downloading ${CS}.tar.gz from github""
+    echo ""* Installing CmdStan ${VER} in ${RELDIR}""
+    echo ""* Downloading ${CS}.tar.gz from GitHub.""
 
     curl -s -OL https://github.com/stan-dev/cmdstan/releases/download/v${VER}/${CS}.tar.gz
     CURL_RC=$?
     if [[ ${CURL_RC} -ne 0 ]]; then
-        echo ""github download failed, curl exited with: ${CURL_RC}""
+        echoerr ""Error: GitHub download failed, curl exited with: ${CURL_RC}""
         exit ${CURL_RC}
     fi
-    echo ""download complete""
+    echo ""* Download complete.""
+
+    echo ""* Unpacking archive ...""
 
-    echo ""unpacking archive""
-    
     mkdir cmdstan
     tar xzf ${CS}.tar.gz -C cmdstan/ --strip-components 1
     TAR_RC=$?
     if [[ ${TAR_RC} -ne 0 ]]; then
-        echo ""corrupt download file ${CS}.tar.gz, tar exited with: ${TAR_RC}""
+        echoerr ""Error: corrupt download file ${CS}.tar.gz, tar exited with: ${TAR_RC}""
         exit ${TAR_RC}
     fi
     rm ${CS}.tar.gz
 fi
 
 pushd cmdstan > /dev/null
-echo ""building cmdstan binaries""
+echo ""* Building CmdStan binaries""
 build_cmdstan
-echo ""installed ${CS} to ${RELDIR}/cmdstan""
+echo ""* Installed ${CS} to ${RELDIR}/cmdstan""
 
 # cleanup
 pushd -0 > /dev/null
 dirs -c > /dev/null
 echo """"
-echo ""CmdStan installation location: `ls -Fd ${RELDIR}/cmdstan`""
+echo ""* CmdStan installation location: `ls -Fd ${RELDIR}/cmdstan`""",False,False,Rendering / Conversion,3
stan-dev,cmdstanr,183decda78367a595c592f752090aaacee9fd88c,jgabry,jgabry@gmail.com,2019-10-30T00:14:25Z,jgabry,jgabry@gmail.com,2019-10-30T00:14:25Z,"update and fix documentation

fixes all things mentioned by @bbbales2 in #52  (plus a bunch of other things I improved in the doc)",R/fit.R;R/model.R;man-roxygen/model-common-args.R;man/CmdStanModel.Rd;man/cmdstan_model.Rd;man/cmdstanr-package.Rd;man/fit-method-save_output_files.Rd;man/model-method-optimize.Rd;man/model-method-sample.Rd;man/model-method-variational.Rd,False,True,True,False,177,120,297,"---FILE: R/fit.R---
@@ -403,7 +403,7 @@ RunSet <- R6::R6Class(
     method = function() private$args_$method,
     command = function() private$args_$command(),
     command_args = function() private$command_args_,
-    # console_files = function() private$console_files_,
+    console_files = function() private$console_files_,
     data_file = function() private$args_$data_file,
     output_files = function() private$output_files_,
     diagnostic_files = function() {

---FILE: R/model.R---
@@ -27,7 +27,7 @@
 #'
 #' set_cmdstan_path(path = NULL)
 #'
-#' # Create a CmdStan model object from a Stan program,
+#' # Create a CmdStanModel object from a Stan program,
 #' # here using the example model that comes with CmdStan
 #' stan_program <- file.path(cmdstan_path(), ""examples/bernoulli/bernoulli.stan"")
 #' mod <- cmdstan_model(stan_program)
@@ -269,38 +269,48 @@ CmdStanModel$set(""public"", name = ""compile"", value = compile_method)
 #' @template model-common-args
 #' @section Arguments unique to the `sample` method: In addition to the
 #'   arguments above, the `$sample()` method also has its own set of arguments.
-#'   These arguments are described briefly here and in greater detail in the
-#'   CmdStan manual. Arguments left at `NULL` default to the default used by the
-#'   installed version of CmdStan.
+#'
+#'   The following arguments are offered by CmdStanR but not CmdStan:
+#'
 #'   * `num_chains`: (positive integer) The number of Markov chains to run.
-#'   * `num_samples`: (positive integer) The number of sampling iterations.
-#'   * `num_warmup`: (positive integer) The number of warmup iterations.
-#'   * `save_warmup`: (logical) Should warmup iterations also be saved?
-#'     The default is `FALSE`.
+#'   Currently the chains are run sequentially, but the option to
+#'   execute CmdStan runs in parallel is coming soon.
+#'   This argument does not correspond to an argument in CmdStan because all
+#'   CmdStan arguments pertain to the execution of a single run only.
+#'
+#'   The rest of the arguments correspond to arguments offered by CmdStan. They
+#'   are described briefly here and in greater detail in the CmdStan manual.
+#'   Arguments left at `NULL` default to the default used by the installed
+#'   version of CmdStan.
+#'
+#'   * `num_samples`: (positive integer) The number of post-warmup iterations to
+#'   run per chain.
+#'   * `num_warmup`: (positive integer) The number of warmup iterations to run
+#'   per chain.
+#'   * `save_warmup`: (logical) Should warmup iterations be saved? The default
+#'   is `FALSE`.
 #'   * `thin`: (positive integer) The period between saved samples. This should
-#'     typically be left at its default (no thinning).
+#'   typically be left at its default (no thinning).
 #'   * `adapt_engaged`: (logical) Do warmup adaptation?
 #'   * `adapt_delta`: (real in `(0,1)`) The adaptation target acceptance
-#'     statistic.
+#'   statistic.
 #'   * `stepsize`: (positive real) The _initial_ step size for the discrete
-#'     approximation to continuous Hamiltonian dynamics. This is further tuned
-#'     during warmup.
-#'   * `metric`: (character) The geometry of the base manifold. One of the
-#'     following:
-#'      - A single string from among `""diag_e""`, `""dense_e""`, `""unit_e""`;
-#'      - A character vector containing paths to files (one per chain)
-#'        compatible with CmdStan that contain precomputed metrics.
-#'        Each path must be to a JSON or Rdump file that contains an entry
-#'        `inv_metric` whose value is either the diagonal vector or the full
-#'        covariance matrix.
-#'
-#'     If you want to turn off adaptation when using a precomputed metric set
-#'     `adapt_engaged=FALSE`, otherwise it will use the provided metric just
-#'     as an initial guess during adaptation. See the _Euclidean Metric_ section
-#'     of the CmdStan manual for more details on these options.
-#'
-#'   * `max_depth`: (positive integer) The maximum allowed tree depth. See the
-#'     _Tree Depth_ section of the CmdStan manual for more details.
+#'   approximation to continuous Hamiltonian dynamics. This is further tuned
+#'   during warmup.
+#'   * `metric`: (character) The geometry of the base manifold. See the
+#'   _Euclidean Metric_ section of the CmdStan documentation for more details.
+#'   One of the following:
+#'     - A single string from among `""diag_e""`, `""dense_e""`, `""unit_e""`.
+#'     - A character vector containing paths to files (one per chain) compatible
+#'     with CmdStan that contain precomputed metrics. Each path must be to a
+#'     JSON or Rdump file that contains an entry `inv_metric` whose value is
+#'     either the diagonal vector or the full covariance matrix. If
+#'     `adapt_engaged=TRUE`, Stan will use the provided metric just as an
+#'     initial guess during adaptation. To turn off adaptation when using a
+#'     precomputed metric set `adapt_engaged=FALSE`.
+#'   * `max_depth`: (positive integer) The maximum allowed tree depth for the
+#'   NUTS engine. See the _Tree Depth_ section of the CmdStan manual for more
+#'   details.
 #'
 #' @section Value: The `$sample()` method returns a [`CmdStanMCMC`] object.
 #'
@@ -405,11 +415,12 @@ CmdStanModel$set(""public"", name = ""sample"", value = sample_method)
 #'   arguments. These arguments are described briefly here and in greater detail
 #'   in the CmdStan manual. Arguments left at `NULL` default to the default used
 #'   by the installed version of CmdStan.
-#'   * `algorithm`: (string) The optimization algorithm. One of
-#'     `""lbfgs""`, `""bfgs""`, or `""newton""`.
+#'
+#'   * `algorithm`: (string) The optimization algorithm. One of `""lbfgs""`,
+#'   `""bfgs""`, or `""newton""`.
 #'   * `iter`: (positive integer) The number of iterations.
 #'   * `init_alpha`: (non-negative real) The line search step size for first
-#'      iteration. Not applicable if `algorithm=""newton""`.
+#'   iteration. Not applicable if `algorithm=""newton""`.
 #'
 #' @section Value: The `$optimize()` method returns a [`CmdStanMLE`] object.
 #'
@@ -507,22 +518,23 @@ CmdStanModel$set(""public"", name = ""optimize"", value = optimize_method)
 #'   arguments. These arguments are described briefly here and in greater detail
 #'   in the CmdStan manual. Arguments left at `NULL` default to the default used
 #'   by the installed version of CmdStan.
+#'
 #'   * `algorithm`: (string) The algorithm. Either `""meanfield""` or `""fullrank""`.
 #'   * `iter`: (positive integer) The _maximum_ number of iterations.
 #'   * `grad_samples`: (positive integer) The number of samples for Monte Carlo
-#'     estimate of gradients.
+#'   estimate of gradients.
 #'   * `elbo_samples`: (positive integer) The number of samples for Monte Carlo
-#'     estimate of ELBO (objective function).
+#'   estimate of ELBO (objective function).
 #'   * `eta`: (positive real) The stepsize weighting parameter for adaptive
-#'     stepsize sequence.
+#'   stepsize sequence.
 #'   * `adapt_engaged`: (logical) Do warmup adaptation?
 #'   * `adapt_iter`: (positive integer) The _maximum_ number of adaptation
-#'     iterations.
+#'   iterations.
 #'   * `tol_rel_obj`: (positive real) Convergence tolerance on the relative norm
-#'     of the objective.
+#'   of the objective.
 #'   * `eval_elbo`: (positive integer) Evaluate ELBO every Nth iteration.
-#'   * `output_samples:` (positive integer) Number of posterior samples to
-#'     draw and save.
+#'   * `output_samples:` (positive integer) Number of posterior samples to draw
+#'   and save.
 #'
 #' @section Value: The `$variational()` method returns a [`CmdStanVB`] object.
 #'

---FILE: man-roxygen/model-common-args.R---
@@ -2,22 +2,28 @@
 #'   be specified for any of the fitting methods (`sample`, `optimize`,
 #'   `variational`). Arguments left at `NULL` default to the default used by the
 #'   installed version of CmdStan.
-#'   * `data` (multiple options): The data to use:
-#'      - A named list of \R objects like for RStan;
-#'      - A path to a data file compatible with CmdStan (\R dump or JSON). See
-#'        the appendices in the CmdStan manual for details on using these
-#'        formats.
+#'   * `data`: (multiple options) The data to use. One of the following:
+#'     - A named list of \R objects (like for RStan). Internally this list is
+#'       then written to JSON for CmdStan using [write_stan_json()].
+#'     - A path to a data file compatible with CmdStan (JSON or \R dump). See
+#'       the appendices in the CmdStan manual for details on using these formats.
 #'   * `seed`: (positive integer) A seed for the (P)RNG to pass to CmdStan.
 #'   * `refresh`: (non-negative integer) The number of iterations between
 #'     screen updates.
 #'   * `init`: (multiple options) The initialization method:
-#'      - A real number `x>0` initializes randomly between `[-x,x]` (on the
-#'      *unconstrained* parameter space);
-#'      - `0` initializes to `0`;
-#'      - A character vector of data file paths (one per chain) to
-#'        initialization files.
+#'     - A real number `x>0` initializes randomly between `[-x,x]` (on the
+#'       *unconstrained* parameter space);
+#'     - `0` initializes to `0`;
+#'     - A character vector of data file paths (one per chain) to
+#'       initialization files.
 #'   * `save_diagnostics`: (logical) Should auxiliary diagnostic information
-#'     (beyond standard diagnostics) be written to separate diagnostic CSV files?
-#'     The default is `FALSE`, which is appropriate for most use cases. This
-#'     argument is a replacement for the `diagnostic_file` argument to CmdStan.
+#'     (beyond standard diagnostics) be written to temporary diagnostic CSV
+#'     files? This argument replaces CmdStan's `diagnostic_file` argument and
+#'     the content written to CSV is controlled by the user's CmdStan
+#'     installation and not CmdStanR. The default is `save_diagnostics=FALSE`,
+#'     which is appropriate for almost every use case (all diagnostics
+#'     recommended for users to check are _always_ saved, e.g., divergences for
+#'     HMC). To save the temporary files created when `save_diagnostics=TRUE`
+#'     see the [`$save_diagnostic_files()`][fit-method-save_diagnostic_files]
+#'     method.
 #'

---FILE: man/CmdStanModel.Rd---
@@ -38,7 +38,7 @@ exe_file \tab Return the file path to the compiled executable once compiled. \cr
 
 set_cmdstan_path(path = NULL)
 
-# Create a CmdStan model object from a Stan program,
+# Create a CmdStanModel object from a Stan program,
 # here using the example model that comes with CmdStan
 stan_program <- file.path(cmdstan_path(), ""examples/bernoulli/bernoulli.stan"")
 mod <- cmdstan_model(stan_program)

---FILE: man/cmdstan_model.Rd---
@@ -34,7 +34,7 @@ file containing a Stan program.
 
 set_cmdstan_path(path = NULL)
 
-# Create a CmdStan model object from a Stan program,
+# Create a CmdStanModel object from a Stan program,
 # here using the example model that comes with CmdStan
 stan_program <- file.path(cmdstan_path(), ""examples/bernoulli/bernoulli.stan"")
 mod <- cmdstan_model(stan_program)

---FILE: man/cmdstanr-package.Rd---
@@ -56,7 +56,7 @@ The licenses of CmdStanR (BSD-3) and RStan (GPL-3) are also different.
 
 set_cmdstan_path(path = NULL)
 
-# Create a CmdStan model object from a Stan program,
+# Create a CmdStanModel object from a Stan program,
 # here using the example model that comes with CmdStan
 stan_program <- file.path(cmdstan_path(), ""examples/bernoulli/bernoulli.stan"")
 mod <- cmdstan_model(stan_program)

---FILE: man/fit-method-save_output_files.Rd---
@@ -4,24 +4,33 @@
 \alias{fit-method-save_output_files}
 \alias{fit-method-save_data_file}
 \alias{fit-method-save_diagnostic_files}
+\alias{fit-method-output_files}
+\alias{fit-method-data_file}
+\alias{fit-method-diagnostic_files}
 \title{Save output and data files}
 \description{
-All fitted model objects have methods \code{$save_output_files()} and
-\code{$save_data_file()}. These methods move csv output files and R dump or json
-data files from the CmdStanR temporary directory to a user-specified
-location. By default the suffix \code{'-<run_id>_<timestamp>'} is added to the
-file name(s), where \code{run_id} is the chain number if applicable (MCMC only)
-and \code{1} otherwise. If files with the specified names already exist they are
-overwritten, but this shouldn't occur unless the \code{timestamp} argument has
-been intentionally set to \code{FALSE}.
+All fitted model objects have methods for saving (copying to a
+specified location) the temporary files created by CmdStanR for CmdStan
+output and data files. These methods move output files or data files from
+the CmdStanR temporary directory to a user-specified location. By default
+the suffix \code{'-<run_id>_<timestamp>'} is added to the file name(s), where
+\code{run_id} is the chain number if applicable (MCMC only) and \code{1} otherwise.
+If files with the specified names already exist they are overwritten, but
+this shouldn't occur unless the \code{timestamp} argument has been intentionally
+set to \code{FALSE}.
 
-\code{$save_diagnostic_files()} can only be used if \code{save_diagnostics=TRUE} when
-fitting the model.
+If necessary, the versions without the \code{save_} prefix (e.g.,
+\code{$output_files()}) can be used to get the path(s) to the temporary file(s)
+themselves.
 }
 \section{Usage}{
 \preformatted{$save_output_files(dir = ""."", basename = NULL, timestamp = TRUE)
 $save_data_file(dir = ""."", basename = NULL, timestamp = TRUE)
 $save_diagnostic_files(dir = ""."", basename = NULL, timestamp = TRUE)
+
+$output_files()
+$data_file()
+$diagnostic_files()
 }
 }
 
@@ -37,8 +46,9 @@ the form
 }
 
 \section{Value}{
- The paths to the new files or \code{NA} for any that couldn't be
-copied.
+ For the \code{$save_*} methods, the paths to the new files or \code{NA}
+for any that couldn't be copied. For the methods without the \code{save_}
+prefix, the path to the temporary files.
 }
 
 \seealso{

---FILE: man/model-method-optimize.Rd---
@@ -37,12 +37,12 @@ be specified for any of the fitting methods (\code{sample}, \code{optimize},
 \code{variational}). Arguments left at \code{NULL} default to the default used by the
 installed version of CmdStan.
 \itemize{
-\item \code{data} (multiple options): The data to use:
+\item \code{data}: (multiple options) The data to use. One of the following:
 \itemize{
-\item A named list of \R objects like for RStan;
-\item A path to a data file compatible with CmdStan (\R dump or JSON). See
-the appendices in the CmdStan manual for details on using these
-formats.
+\item A named list of \R objects (like for RStan). Internally this list is
+then written to JSON for CmdStan using \code{\link[=write_stan_json]{write_stan_json()}}.
+\item A path to a data file compatible with CmdStan (JSON or \R dump). See
+the appendices in the CmdStan manual for details on using these formats.
 }
 \item \code{seed}: (positive integer) A seed for the (P)RNG to pass to CmdStan.
 \item \code{refresh}: (non-negative integer) The number of iterations between
@@ -56,9 +56,15 @@ screen updates.
 initialization files.
 }
 \item \code{save_diagnostics}: (logical) Should auxiliary diagnostic information
-(beyond standard diagnostics) be written to separate diagnostic CSV files?
-The default is \code{FALSE}, which is appropriate for most use cases. This
-argument is a replacement for the \code{diagnostic_file} argument to CmdStan.
+(beyond standard diagnostics) be written to temporary diagnostic CSV
+files? This argument replaces CmdStan's \code{diagnostic_file} argument and
+the content written to CSV is controlled by the user's CmdStan
+installation and not CmdStanR. The default is \code{save_diagnostics=FALSE},
+which is appropriate for almost every use case (all diagnostics
+recommended for users to check are \emph{always} saved, e.g., divergences for
+HMC). To save the temporary files created when \code{save_diagnostics=TRUE}
+see the \code{\link[=fit-method-save_diagnostic_files]{$save_diagnostic_files()}}
+method.
 }
 }
 
@@ -69,8 +75,8 @@ arguments. These arguments are described briefly here and in greater detail
 in the CmdStan manual. Arguments left at \code{NULL} default to the default used
 by the installed version of CmdStan.
 \itemize{
-\item \code{algorithm}: (string) The optimization algorithm. One of
-\code{""lbfgs""}, \code{""bfgs""}, or \code{""newton""}.
+\item \code{algorithm}: (string) The optimization algorithm. One of \code{""lbfgs""},
+\code{""bfgs""}, or \code{""newton""}.
 \item \code{iter}: (positive integer) The number of iterations.
 \item \code{init_alpha}: (non-negative real) The line search step size for first
 iteration. Not applicable if \code{algorithm=""newton""}.
@@ -91,7 +97,7 @@ iteration. Not applicable if \code{algorithm=""newton""}.
 
 set_cmdstan_path(path = NULL)
 
-# Create a CmdStan model object from a Stan program,
+# Create a CmdStanModel object from a Stan program,
 # here using the example model that comes with CmdStan
 stan_program <- file.path(cmdstan_path(), ""examples/bernoulli/bernoulli.stan"")
 mod <- cmdstan_model(stan_program)

---FILE: man/model-method-sample.Rd---
@@ -37,12 +37,12 @@ be specified for any of the fitting methods (\code{sample}, \code{optimize},
 \code{variational}). Arguments left at \code{NULL} default to the default used by the
 installed version of CmdStan.
 \itemize{
-\item \code{data} (multiple options): The data to use:
+\item \code{data}: (multiple options) The data to use. One of the following:
 \itemize{
-\item A named list of \R objects like for RStan;
-\item A path to a data file compatible with CmdStan (\R dump or JSON). See
-the appendices in the CmdStan manual for details on using these
-formats.
+\item A named list of \R objects (like for RStan). Internally this list is
+then written to JSON for CmdStan using \code{\link[=write_stan_json]{write_stan_json()}}.
+\item A path to a data file compatible with CmdStan (JSON or \R dump). See
+the appendices in the CmdStan manual for details on using these formats.
 }
 \item \code{seed}: (positive integer) A seed for the (P)RNG to pass to CmdStan.
 \item \code{refresh}: (non-negative integer) The number of iterations between
@@ -56,24 +56,42 @@ screen updates.
 initialization files.
 }
 \item \code{save_diagnostics}: (logical) Should auxiliary diagnostic information
-(beyond standard diagnostics) be written to separate diagnostic CSV files?
-The default is \code{FALSE}, which is appropriate for most use cases. This
-argument is a replacement for the \code{diagnostic_file} argument to CmdStan.
+(beyond standard diagnostics) be written to temporary diagnostic CSV
+files? This argument replaces CmdStan's \code{diagnostic_file} argument and
+the content written to CSV is controlled by the user's CmdStan
+installation and not CmdStanR. The default is \code{save_diagnostics=FALSE},
+which is appropriate for almost every use case (all diagnostics
+recommended for users to check are \emph{always} saved, e.g., divergences for
+HMC). To save the temporary files created when \code{save_diagnostics=TRUE}
+see the \code{\link[=fit-method-save_diagnostic_files]{$save_diagnostic_files()}}
+method.
 }
 }
 
 \section{Arguments unique to the \code{sample} method}{
  In addition to the
 arguments above, the \code{$sample()} method also has its own set of arguments.
-These arguments are described briefly here and in greater detail in the
-CmdStan manual. Arguments left at \code{NULL} default to the default used by the
-installed version of CmdStan.
+
+The following arguments are offered by CmdStanR but not CmdStan:
 \itemize{
 \item \code{num_chains}: (positive integer) The number of Markov chains to run.
-\item \code{num_samples}: (positive integer) The number of sampling iterations.
-\item \code{num_warmup}: (positive integer) The number of warmup iterations.
-\item \code{save_warmup}: (logical) Should warmup iterations also be saved?
-The default is \code{FALSE}.
+Currently the chains are run sequentially, but the option to
+execute CmdStan runs in parallel is coming soon.
+This argument does not correspond to an argument in CmdStan because all
+CmdStan arguments pertain to the execution of a single run only.
+}
+
+The rest of the arguments correspond to arguments offered by CmdStan. They
+are described briefly here and in greater detail in the CmdStan manual.
+Arguments left at \code{NULL} default to the default used by the installed
+version of CmdStan.
+\itemize{
+\item \code{num_samples}: (positive integer) The number of post-warmup iterations to
+run per chain.
+\item \code{num_warmup}: (positive integer) The number of warmup iterations to run
+per chain.
+\item \code{save_warmup}: (logical) Should warmup iterations be saved? The default
+is \code{FALSE}.
 \item \code{thin}: (positive integer) The period between saved samples. This should
 typically be left at its default (no thinning).
 \item \code{adapt_engaged}: (logical) Do warmup adaptation?
@@ -82,23 +100,22 @@ statistic.
 \item \code{stepsize}: (positive real) The \emph{initial} step size for the discrete
 approximation to continuous Hamiltonian dynamics. This is further tuned
 during warmup.
-\item \code{metric}: (character) The geometry of the base manifold. One of the
-following:
+\item \code{metric}: (character) The geometry of the base manifold. See the
+\emph{Euclidean Metric} section of the CmdStan documentation for more details.
+One of the following:
 \itemize{
-\item A single string from among \code{""diag_e""}, \code{""dense_e""}, \code{""unit_e""};
-\item A character vector containing paths to files (one per chain)
-compatible with CmdStan that contain precomputed metrics.
-Each path must be to a JSON or Rdump file that contains an entry
-\code{inv_metric} whose value is either the diagonal vector or the full
-covariance matrix.
+\item A single string from among \code{""diag_e""}, \code{""dense_e""}, \code{""unit_e""}.
+\item A character vector containing paths to files (one per chain) compatible
+with CmdStan that contain precomputed metrics. Each path must be to a
+JSON or Rdump file that contains an entry \code{inv_metric} whose value is
+either the diagonal vector or the full covariance matrix. If
+\code{adapt_engaged=TRUE}, Stan will use the provided metric just as an
+initial guess during adaptation. To turn off adaptation when using a
+precomputed metric set \code{adapt_engaged=FALSE}.
 }
-
-If you want to turn off adaptation when using a precomputed metric set
-\code{adapt_engaged=FALSE}, otherwise it will use the provided metric just
-as an initial guess during adaptation. See the \emph{Euclidean Metric} section
-of the CmdStan manual for more details on these options.
-\item \code{max_depth}: (positive integer) The maximum allowed tree depth. See the
-\emph{Tree Depth} section of the CmdStan manual for more details.
+\item \code{max_depth}: (positive integer) The maximum allowed tree depth for the
+NUTS engine. See the \emph{Tree Depth} section of the CmdStan manual for more
+details.
 }
 }
 
@@ -116,7 +133,7 @@ of the CmdStan manual for more details on these options.
 
 set_cmdstan_path(path = NULL)
 
-# Create a CmdStan model object from a Stan program,
+# Create a CmdStanModel object from a Stan program,
 # here using the example model that comes with CmdStan
 stan_program <- file.path(cmdstan_path(), ""examples/bernoulli/bernoulli.stan"")
 mod <- cmdstan_model(stan_program)

---FILE: man/model-method-variational.Rd---
@@ -44,12 +44,12 @@ be specified for any of the fitting methods (\code{sample}, \code{optimize},
 \code{variational}). Arguments left at \code{NULL} default to the default used by the
 installed version of CmdStan.
 \itemize{
-\item \code{data} (multiple options): The data to use:
+\item \code{data}: (multiple options) The data to use. One of the following:
 \itemize{
-\item A named list of \R objects like for RStan;
-\item A path to a data file compatible with CmdStan (\R dump or JSON). See
-the appendices in the CmdStan manual for details on using these
-formats.
+\item A named list of \R objects (like for RStan). Internally this list is
+then written to JSON for CmdStan using \code{\link[=write_stan_json]{write_stan_json()}}.
+\item A path to a data file compatible with CmdStan (JSON or \R dump). See
+the appendices in the CmdStan manual for details on using these formats.
 }
 \item \code{seed}: (positive integer) A seed for the (P)RNG to pass to CmdStan.
 \item \code{refresh}: (non-negative integer) The number of iterations between
@@ -63,9 +63,15 @@ screen updates.
 initialization files.
 }
 \item \code{save_diagnostics}: (logical) Should auxiliary diagnostic information
-(beyond standard diagnostics) be written to separate diagnostic CSV files?
-The default is \code{FALSE}, which is appropriate for most use cases. This
-argument is a replacement for the \code{diagnostic_file} argument to CmdStan.
+(beyond standard diagnostics) be written to temporary diagnostic CSV
+files? This argument replaces CmdStan's \code{diagnostic_file} argument and
+the content written to CSV is controlled by the user's CmdStan
+installation and not CmdStanR. The default is \code{save_diagnostics=FALSE},
+which is appropriate for almost every use case (all diagnostics
+recommended for users to check are \emph{always} saved, e.g., divergences for
+HMC). To save the temporary files created when \code{save_diagnostics=TRUE}
+see the \code{\link[=fit-method-save_diagnostic_files]{$save_diagnostic_files()}}
+method.
 }
 }
 
@@ -90,8 +96,8 @@ iterations.
 \item \code{tol_rel_obj}: (positive real) Convergence tolerance on the relative norm
 of the objective.
 \item \code{eval_elbo}: (positive integer) Evaluate ELBO every Nth iteration.
-\item \code{output_samples:} (positive integer) Number of posterior samples to
-draw and save.
+\item \code{output_samples:} (positive integer) Number of posterior samples to draw
+and save.
 }
 }
 
@@ -109,7 +115,7 @@ draw and save.
 
 set_cmdstan_path(path = NULL)
 
-# Create a CmdStan model object from a Stan program,
+# Create a CmdStanModel object from a Stan program,
 # here using the example model that comes with CmdStan
 stan_program <- file.path(cmdstan_path(), ""examples/bernoulli/bernoulli.stan"")
 mod <- cmdstan_model(stan_program)",True,False,Documentation / Formatting,7
stan-dev,cmdstanr,3f48fc995c6de3cef1a62c075278107acb913535,jgabry,jgabry@gmail.com,2019-10-30T00:11:42Z,jgabry,jgabry@gmail.com,2019-10-30T00:11:42Z,always error if no diagnostic files found,R/fit.R,False,True,True,False,52,42,94,"---FILE: R/fit.R---
@@ -67,21 +67,13 @@ CmdStanMCMC <- R6::R6Class(
       # iter x chains x params array
       if (is.null(private$draws_)) private$read_csv()
       private$draws_
-    },
+    }
     # sampler_params = function() {
     #   # currently sampler params list from rstan::get_sampler_params()
     #   # but this shouldn't use rstan
     #   if (is.null(private$sampler_params_)) private$read_csv()
     #   private$sampler_params_
-    # },
-    output_files = function() {
-      # get the paths to the temporary output csv files
-      self$runset$output_files()
-    },
-    diagnostic_files = function() {
-      # get the paths to the temporary diagnostic csv files
-      self$runset$diagnostic_files()
-    }
+    # }
   ),
   private = list(
     draws_ = NULL,
@@ -158,12 +150,6 @@ CmdStanMLE <- R6::R6Class(
     lp = function() {
       if (is.null(private$lp_)) private$read_csv()
       private$lp_
-    },
-    output_files = function() {
-      self$runset$output_files()
-    },
-    diagnostic_files = function() {
-      self$runset$diagnostic_files()
     }
   ),
   private = list(
@@ -242,12 +228,6 @@ CmdStanVB <- R6::R6Class(
       # iter x params array
       if (is.null(private$log_g_)) private$read_csv()
       private$log_g_
-    },
-    output_files = function() {
-      self$runset$output_files()
-    },
-    diagnostic_files = function() {
-      self$runset$diagnostic_files()
     }
   ),
   private = list(
@@ -278,24 +258,31 @@ CmdStanVB <- R6::R6Class(
 #'
 #' @name fit-method-save_output_files
 #' @aliases fit-method-save_data_file fit-method-save_diagnostic_files
+#'   fit-method-output_files fit-method-data_file fit-method-diagnostic_files
 #'
-#' @description All fitted model objects have methods `$save_output_files()` and
-#'   `$save_data_file()`. These methods move csv output files and R dump or json
-#'   data files from the CmdStanR temporary directory to a user-specified
-#'   location. By default the suffix `'-<run_id>_<timestamp>'` is added to the
-#'   file name(s), where `run_id` is the chain number if applicable (MCMC only)
-#'   and `1` otherwise. If files with the specified names already exist they are
-#'   overwritten, but this shouldn't occur unless the `timestamp` argument has
-#'   been intentionally set to `FALSE`.
+#' @description All fitted model objects have methods for saving (copying to a
+#'   specified location) the temporary files created by CmdStanR for CmdStan
+#'   output and data files. These methods move output files or data files from
+#'   the CmdStanR temporary directory to a user-specified location. By default
+#'   the suffix `'-<run_id>_<timestamp>'` is added to the file name(s), where
+#'   `run_id` is the chain number if applicable (MCMC only) and `1` otherwise.
+#'   If files with the specified names already exist they are overwritten, but
+#'   this shouldn't occur unless the `timestamp` argument has been intentionally
+#'   set to `FALSE`.
 #'
-#'   `$save_diagnostic_files()` can only be used if `save_diagnostics=TRUE` when
-#'   fitting the model.
+#'   If necessary, the versions without the `save_` prefix (e.g.,
+#'   `$output_files()`) can be used to get the path(s) to the temporary file(s)
+#'   themselves.
 #'
 #' @section Usage:
 #'   ```
 #'   $save_output_files(dir = ""."", basename = NULL, timestamp = TRUE)
 #'   $save_data_file(dir = ""."", basename = NULL, timestamp = TRUE)
 #'   $save_diagnostic_files(dir = ""."", basename = NULL, timestamp = TRUE)
+#'
+#'   $output_files()
+#'   $data_file()
+#'   $diagnostic_files()
 #'   ```
 #'
 #' @section Arguments:
@@ -305,13 +292,33 @@ CmdStanVB <- R6::R6Class(
 #'   Defaults to `TRUE`. The timestamp is preceeded by an underscore is of
 #'   the form
 #'
-#' @section Value: The paths to the new files or `NA` for any that couldn't be
-#'   copied.
+#' @section Value: For the `$save_*` methods, the paths to the new files or `NA`
+#'   for any that couldn't be copied. For the methods without the `save_`
+#'   prefix, the path to the temporary files.
 #'
 #' @seealso [`CmdStanMCMC`], [`CmdStanMLE`], [`CmdStanVB`]
 #'
 NULL
 
+output_files_method <- function() {
+  self$runset$output_files()
+}
+diagnostic_files_method = function() {
+  self$runset$diagnostic_files()
+}
+data_file_method <- function() {
+  self$runset$data_file()
+}
+CmdStanMCMC$set(""public"", ""output_files"", output_files_method)
+CmdStanMLE$set(""public"", ""output_files"", output_files_method)
+CmdStanVB$set(""public"", ""output_files"", output_files_method)
+CmdStanMCMC$set(""public"", ""diagnostic_files"", diagnostic_files_method)
+CmdStanMLE$set(""public"", ""diagnostic_files"", diagnostic_files_method)
+CmdStanVB$set(""public"", ""diagnostic_files"", diagnostic_files_method)
+CmdStanMCMC$set(""public"", ""data_file"", data_file_method)
+CmdStanMLE$set(""public"", ""data_file"", data_file_method)
+CmdStanVB$set(""public"", ""data_file"", data_file_method)
+
 save_output_files_method <- function(dir = ""."", basename = NULL, timestamp = TRUE) {
   self$runset$save_output_files(dir, basename, timestamp)
 }
@@ -396,10 +403,19 @@ RunSet <- R6::R6Class(
     method = function() private$args_$method,
     command = function() private$args_$command(),
     command_args = function() private$command_args_,
+    # console_files = function() private$console_files_,
     data_file = function() private$args_$data_file,
-    diagnostic_files = function() private$diagnostic_files_,
     output_files = function() private$output_files_,
-    console_files = function() private$console_files_,
+    diagnostic_files = function() {
+      if (!length(private$diagnostic_files_)) {
+        stop(
+          ""No diagnostic files found. "",
+          ""Set 'save_diagnostics=TRUE' when fitting the model."",
+          call. = FALSE
+        )
+      }
+      private$diagnostic_files_
+    },
 
     # ._check_retcodes = function() all(private$retcodes_  == 0),
     # ._retcode = function(idx) private$retcodes_[idx],
@@ -425,12 +441,6 @@ RunSet <- R6::R6Class(
     save_diagnostic_files = function(dir = ""."",
                                      basename = NULL,
                                      timestamp = TRUE) {
-      if (!length(self$diagnostic_files())) {
-        stop(
-          ""No diagnostic files found. "",
-          ""Set 'save_diagnostics=TRUE' when fitting the model."",
-          call. = FALSE)
-      }
       copy_temp_files(
         current_paths = self$diagnostic_files(),
         new_dir = dir,",True,False,Implementation / Logic,6
stan-dev,cmdstanr,986f23da0dc61e2e08a2f1abd59f2f2c7e36bd36,jgabry,jgabry@gmail.com,2019-10-29T16:58:28Z,jgabry,jgabry@gmail.com,2019-10-29T16:58:28Z,"fix typo in doc

[ci skip]",R/fit.R;man/fit-method-save_output_files.Rd,False,True,True,False,2,2,4,"---FILE: R/fit.R---
@@ -288,7 +288,7 @@ CmdStanVB <- R6::R6Class(
 #'   overwritten, but this shouldn't occur unless the `timestamp` argument has
 #'   been intentionally set to `FALSE`.
 #'
-#'   `save_diagnostic_files()` can only be used if `save_diagnostics=TRUE` when
+#'   `$save_diagnostic_files()` can only be used if `save_diagnostics=TRUE` when
 #'   fitting the model.
 #'
 #' @section Usage:

---FILE: man/fit-method-save_output_files.Rd---
@@ -15,7 +15,7 @@ and \code{1} otherwise. If files with the specified names already exist they are
 overwritten, but this shouldn't occur unless the \code{timestamp} argument has
 been intentionally set to \code{FALSE}.
 
-\code{save_diagnostic_files()} can only be used if \code{save_diagnostics=TRUE} when
+\code{$save_diagnostic_files()} can only be used if \code{save_diagnostics=TRUE} when
 fitting the model.
 }
 \section{Usage}{",True,False,Documentation / Formatting,7
stan-dev,cmdstanr,da373944517011f1a5455412686f895c536d7130,jgabry,jgabry@gmail.com,2019-10-29T14:57:54Z,jgabry,jgabry@gmail.com,2019-10-29T14:57:54Z,minor doc fix,R/fit.R;man/fit-method-save_output_files.Rd,False,True,True,False,2,2,4,"---FILE: R/fit.R---
@@ -289,7 +289,7 @@ CmdStanVB <- R6::R6Class(
 #'   overwritten, but this shouldn't occur unless the `timestamp` argument has
 #'   been intentionally set to `FALSE`.
 #'
-#'   `save_diagnostic_files()` can be used if `save_diagnostics=TRUE` when
+#'   `save_diagnostic_files()` can only be used if `save_diagnostics=TRUE` when
 #'   fitting the model.
 #'
 #' @section Usage:

---FILE: man/fit-method-save_output_files.Rd---
@@ -14,7 +14,7 @@ and \code{1} otherwise. If files with the specified names already exist they are
 overwritten, but this shouldn't occur unless the \code{timestamp} argument has
 been intentionally set to \code{FALSE}.
 
-\code{save_diagnostic_files()} can be used if \code{save_diagnostics=TRUE} when
+\code{save_diagnostic_files()} can only be used if \code{save_diagnostics=TRUE} when
 fitting the model.
 }
 \section{Usage}{",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,9e38fabb2f2b390dd27175927c0983df1929e473,jgabry,jgabry@gmail.com,2019-10-29T14:53:29Z,jgabry,jgabry@gmail.com,2019-10-29T14:53:29Z,"fix typo in doc

[ci skip]",R/args.R,False,True,True,False,1,1,2,"---FILE: R/args.R---
@@ -66,7 +66,7 @@ CmdStanArgs <- R6::R6Class(
     # @param idx The run id. For MCMC this is the chain id, for optimization
     #   this is just 1.
     # @param output_file File path to csv file where output will be written.
-    # @param output_file File path to csv file where diagnostics will be written.
+    # @param diagnostic_file File path to csv file where diagnostics will be written.
     # @return Character vector of arguments of the form ""name=value"".
     #
     compose_all_args = function(idx = NULL,",True,False,Implementation / Logic,6
stan-dev,cmdstanr,916170f5c6944da9e4100983f98c22b95875fce9,jgabry,jgabry@gmail.com,2019-10-25T20:39:52Z,jgabry,jgabry@gmail.com,2019-10-25T20:39:52Z,"fix tests after using pretty=TRUE

also uses expect_known_output to compare to reference files",tests/testthat/answers/json-boolean.json;tests/testthat/answers/json-factor.json;tests/testthat/answers/json-integer.json;tests/testthat/answers/json-lists.json;tests/testthat/answers/json-unboxing.json;tests/testthat/test-json.R,False,True,True,False,28,21,49,"---FILE: tests/testthat/answers/json-boolean.json---
@@ -0,0 +1,3 @@
+{
+  ""N"": [1, 0, 1]
+}

---FILE: tests/testthat/answers/json-factor.json---
@@ -0,0 +1,3 @@
+{
+  ""N"": [1, 2, 3, 3, 2, 1]
+}

---FILE: tests/testthat/answers/json-integer.json---
@@ -0,0 +1,3 @@
+{
+  ""N"": [1, 2, 3, 4]
+}

---FILE: tests/testthat/answers/json-lists.json---
@@ -0,0 +1,6 @@
+{
+  ""N"": [
+    [26, 26, 26],
+    [26, 26, 26]
+  ]
+}

---FILE: tests/testthat/answers/json-unboxing.json---
@@ -0,0 +1,3 @@
+{
+  ""N"": 10
+}

---FILE: tests/testthat/test-json.R---
@@ -1,61 +1,50 @@
-# Setup -------------------------------------------------------------------
-NOT_CRAN <-
-  identical(Sys.getenv(""NOT_CRAN""), ""true"") ||
-  identical(Sys.getenv(""TRAVIS""), ""true"")
-
-
-if (NOT_CRAN) {
-  set_cmdstan_path()
-}
-
 
 test_that(""test JSON output unboxing"", {
-  skip_on_cran()
   temp_file <- tempfile()
   N <- 10
   write_stan_json(list(N = N), file = temp_file)
   json_output <- readLines(temp_file)
-  expect_equal(json_output, ""{\""N\"":10}"")
+  expect_known_output(cat(json_output, sep = ""\n""),
+                      file = test_path(""answers"", ""json-unboxing.json""))
 })
 
 test_that(""test JSON output boolean"", {
-  skip_on_cran()
   temp_file <- tempfile()
   N <- c(TRUE, FALSE, TRUE)
   write_stan_json(list(N = N), file = temp_file)
   json_output <- readLines(temp_file)
-  expect_equal(json_output, ""{\""N\"":[1,0,1]}"")
+  expect_known_output(cat(json_output, sep = ""\n""),
+                      file = test_path(""answers"", ""json-boolean.json""))
 })
 
 test_that(""test JSON output factor"", {
-  skip_on_cran()
   temp_file <- tempfile()
   N = factor(c(0,1,2,2,1,0), labels = c(""c1"", ""c2"", ""c3""))
   write_stan_json(list(N = N), file = temp_file)
   json_output <- readLines(temp_file)
-  expect_equal(json_output, ""{\""N\"":[1,2,3,3,2,1]}"")
+  expect_known_output(cat(json_output, sep = ""\n""),
+                      file = test_path(""answers"", ""json-factor.json""))
 })
 
 test_that(""test JSON output integer vector"", {
-  skip_on_cran()
   temp_file <- tempfile()
   N = c(1.0, 2.0, 3, 4)
 
   write_stan_json(list(N = N), file = temp_file)
   json_output <- readLines(temp_file)
-  expect_equal(json_output, ""{\""N\"":[1,2,3,4]}"")
+  expect_known_output(cat(json_output, sep = ""\n""),
+                      file = test_path(""answers"", ""json-integer.json""))
 })
 
 test_that(""test JSON output lists"", {
-  skip_on_cran()
   temp_file <- tempfile()
   I <- 2; J <- 3;
   N <- lapply(1:I, function(i) rep(26, J))
 
-
   write_stan_json(list(N = N), file = temp_file)
   json_output <- readLines(temp_file)
-  expect_equal(json_output, ""{\""N\"":[[26,26,26],[26,26,26]]}"")
+  expect_known_output(cat(json_output, sep = ""\n""),
+                      file = test_path(""answers"", ""json-lists.json""))
 })
 
 test_that(""test JSON errors"", {",True,False,Data / Input Handling,3
stan-dev,cmdstanr,2bc34a2878a0d6a21cefdc0afd1cb0b9d01930ab,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-10-24T07:35:23Z,rok-cesnovar,rok.cesnovar@fri.uni-lj.si,2019-10-24T07:35:23Z,"move jsonlite to suggested, move warnings to errors",DESCRIPTION;R/utils.R;tests/testthat/test-json.R,False,True,True,False,22,45,67,"---FILE: DESCRIPTION---
@@ -23,11 +23,11 @@ SystemRequirements: CmdStan <https://mc-stan.org/users/interfaces/cmdstan>
 Imports: 
     checkmate,
     processx,
-    R6,
-    jsonlite (>= 1.2)
+    R6
 Suggests: 
     knitr,
     rmarkdown,
     rstan,
-    testthat (>= 2.1.0)
+    testthat (>= 2.1.0),
+    jsonlite (>= 1.2.0)
 VignetteBuilder: knitr

---FILE: R/utils.R---
@@ -179,44 +179,29 @@ write_json <- function(data) {
   checkmate::assert_names(names(data), type = ""unique"")
   temp_file <- tempfile(pattern = ""standata-"", fileext = "".json"")
   cmdstanr_jsondump(
-    list = names(data),
-    file = temp_file,
-    envir = as.environment(data)
+    data = data,
+    file = temp_file
   )
   temp_file
 }
 
-#' Dump data to temporary file in format readable by CmdStan
+#' Dump data to a JSON file readable by CmdStan
 #'
-#' @param list A vector of character string: the names of one or more R objects to be dumped.
+#' @param data A named list of objects to be written in a json file
 #' @param file A character string represeneting the path to the output file
-#' @param envir The environment to search for the listed objects.
 #' @export
-#' @return Path to temporary file containing the data.
-cmdstanr_jsondump <- function(list,
-                          file,
-                          envir = parent.frame()) {
+cmdstanr_jsondump <- function(data, file) {
   if (!requireNamespace(""jsonlite"", quietly = TRUE)) {
     stop(""Please install the 'jsonlite' package."", call. = FALSE)
   }
-  temp_file <- tempfile(pattern = ""standata-"", fileext = "".json"")
   # check filename is valid(vector of characters) and of nonzero length
   if (!is.character(file) || !nzchar(file)) {
-    warning(""The supplied filename is invalid!"")
-    return(invisible(character()))
-  }
-  # check if all variables in list exist
-  variable_exists <- sapply(list, exists, envir = envir)
-  if(!all(variable_exists)) {
-    warning(paste(""The following objects were not found: "", paste(list[!variable_exists], collapse = "", "")))
-    return(invisible(character()))
+    stop(""The supplied filename is invalid!"")
   }
-  data = list()
-  for (var_name in list) {
-    var <- get(var_name, envir)
+  for (var_name in names(data)) {
+    var <- data[[var_name]]
     if(!(is.numeric(var) || is.factor(var) || is.logical(var) || is.data.frame(var)  || is.list(var))) {
-      warning(paste(""Variable "", var_name, "" is of invalid type.""))
-      return(invisible(character()))
+      stop(paste(""Variable "", var_name, "" is of invalid type.""))
     }
     # convert TRUE/FALSE to 1/0
     if(is.logical(var)) {

---FILE: tests/testthat/test-json.R---
@@ -13,8 +13,7 @@ test_that(""test JSON output unboxing"", {
   skip_on_cran()
   temp_file <- tempfile()
   N <- 10
-
-  cmdstanr_jsondump(c(""N""), file = temp_file)
+  cmdstanr_jsondump(list(N = N), file = temp_file)
   json_output <- readLines(temp_file)
   expect_equal(json_output, ""{\""N\"":10}"")
 })
@@ -23,8 +22,7 @@ test_that(""test JSON output boolean"", {
   skip_on_cran()
   temp_file <- tempfile()
   N <- c(TRUE, FALSE, TRUE)
-
-  cmdstanr_jsondump(c(""N""), file = temp_file)
+  cmdstanr_jsondump(list(N = N), file = temp_file)
   json_output <- readLines(temp_file)
   expect_equal(json_output, ""{\""N\"":[1,0,1]}"")
 })
@@ -33,8 +31,7 @@ test_that(""test JSON output factor"", {
   skip_on_cran()
   temp_file <- tempfile()
   N = factor(c(0,1,2,2,1,0), labels = c(""c1"", ""c2"", ""c3""))
-
-  cmdstanr_jsondump(c(""N""), file = temp_file)
+  cmdstanr_jsondump(list(N = N), file = temp_file)
   json_output <- readLines(temp_file)
   expect_equal(json_output, ""{\""N\"":[1,2,3,3,2,1]}"")
 })
@@ -44,8 +41,7 @@ test_that(""test JSON output integer vector"", {
   temp_file <- tempfile()
   N = c(1.0, 2.0, 3, 4)
 
-
-  cmdstanr_jsondump(c(""N""), file = temp_file)
+  cmdstanr_jsondump(list(N = N), file = temp_file)
   json_output <- readLines(temp_file)
   expect_equal(json_output, ""{\""N\"":[1,2,3,4]}"")
 })
@@ -57,25 +53,21 @@ test_that(""test JSON output lists"", {
   N <- lapply(1:I, function(i) rep(26, J))
 
 
-  cmdstanr_jsondump(c(""N""), file = temp_file)
+  cmdstanr_jsondump(list(N = N), file = temp_file)
   json_output <- readLines(temp_file)
   expect_equal(json_output, ""{\""N\"":[[26,26,26],[26,26,26]]}"")
 })
 
-test_that(""test JSON warnings"", {
+test_that(""test JSON errors"", {
   skip_on_cran()
   temp_file <- tempfile()
   N = c(1.0, 2.0, 3, 4)
-  expect_warning(
-    cmdstanr_jsondump(c(""N""), file = c(1,2)),
+  expect_error(
+    cmdstanr_jsondump(list(N = N), file = c(1,2)),
     ""The supplied filename is invalid!""
   )
-  expect_warning(
-    cmdstanr_jsondump(c(""N""), file = """"),
+  expect_error(
+    cmdstanr_jsondump(list(N = N), file = """"),
     ""The supplied filename is invalid!""
   )
-  expect_warning(
-    cmdstanr_jsondump(c(""K"", ""P""), file = temp_file),
-    ""The following objects were not found:  K, P""
-  )
 })",True,False,Dependency / Package,6
stan-dev,cmdstanr,96fd55759801335a3755708aca8ca93cc0cb7c2e,jgabry,jgabry@gmail.com,2019-10-20T04:50:04Z,jgabry,jgabry@gmail.com,2019-10-20T04:50:04Z,Fix installation location message,R/install.R;inst/make_cmdstan.sh;man/install_cmdstan.Rd,False,True,True,False,5,3,8,"---FILE: R/install.R---
@@ -13,7 +13,8 @@
 #' @param dir Path to the directory in which to install CmdStan. The default is
 #'   to install it in a folder `"".cmdstanr""` in the user's home directory
 #'   (`Sys.getenv(""HOME"")`).
-#' @param cores The number of CPU cores to use to parallelize building CmdStan.
+#' @param cores The number of CPU cores to use to parallelize building CmdStan
+#'   and speed up installation.
 #' @param quiet Defaults to `FALSE`, but if `TRUE` will suppress the verbose
 #'   output during the installation process.
 #'

---FILE: inst/make_cmdstan.sh---
@@ -84,5 +84,5 @@ echo ""installed ${CS}; symlink: `ls -l ${RELDIR}/cmdstan`""
 pushd -0 > /dev/null
 dirs -c > /dev/null
 echo """"
-echo ""CmdStan installation location: `ls -Fd ${RELDIR}/* | grep -v @ | grep -v gz`""
+echo ""CmdStan installation location: `ls -Fd ${RELDIR}/${CS}`""
 echo ""Can use symlink: ${RELDIR}/cmdstan""

---FILE: man/install_cmdstan.Rd---
@@ -11,7 +11,8 @@ install_cmdstan(dir = NULL, cores = 2, quiet = FALSE)
 to install it in a folder \code{"".cmdstanr""} in the user's home directory
 (\code{Sys.getenv(""HOME"")}).}
 
-\item{cores}{The number of CPU cores to use to parallelize building CmdStan.}
+\item{cores}{The number of CPU cores to use to parallelize building CmdStan
+and speed up installation.}
 
 \item{quiet}{Defaults to \code{FALSE}, but if \code{TRUE} will suppress the verbose
 output during the installation process.}",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,9802869d3553fb476ae63c99d78228b7f7ce78ec,Jonah Gabry,jgabry@gmail.com,2019-10-20T03:48:59Z,GitHub,noreply@github.com,2019-10-20T03:48:59Z,"fix stan_threads doc page and other minor changes

@rok-cesnovar I made a few small changes here since I had a little time:

* `num_threads` might as well just return an integer since there can't be a non-integer number of threads

* For now I changed the name from `get_num_threads` to `num_threads`, so that there's `num_threads` and `set_num_threads` like there is `cmdstan_path` and `set_cmdstan_path`. But I'm open to going the other way and changing to `get_cmdstan_path` or something else for both.

* I put `@name stan_threads` to create a doc page that can be accessed by `?stan_threads`, then used `@rdname stan_threads` for both `num_threads` and `set_num_threads` so that they are both documented in the ""stan_threads"" page. So now it's possible to use ?stan_threads, `?num_threads`, or `?set_num_threads` to get to this page. This should fix the warnings from `R CMD check` that were causing travis to fail",R/utils.R,False,True,True,False,20,10,30,"---FILE: R/utils.R---
@@ -194,17 +194,21 @@ write_rdump <- function(data) {
   temp_file
 }
 
+
+
+# compilation, build files, threading -------------------------------------
+
 #' Cleanup build files of a Stan model
 #'
-#' deletese the model_name.o, model_name.hpp and the executable.
+#' deletes the model_name.o, model_name.hpp and the executable.
 #'
 #' @param model_path (string) The absolute path to the model
 #' @param remove_main (logical) Set TRUE to also remove the cmdstan main.o
 #' @noRd
 build_cleanup <- function(model_path,
                           remove_main = FALSE) {
-  model_hpp_file = paste(model_path, "".hpp"", sep = """")
-  model_o_file = paste(model_path, "".o"", sep = """")
+  model_hpp_file <- paste(model_path, "".hpp"", sep = """")
+  model_o_file <- paste(model_path, "".o"", sep = """")
   if(file.exists(model_hpp_file)) {
     file.remove(model_hpp_file)
   }
@@ -252,20 +256,26 @@ set_make_local <- function(threads = FALSE,
   return(FALSE)
 }
 
-#' @rdname stan_threads
-#' Returns the number of threads used to execute Stan models.
+
+#' Set or get the number of threads used to execute Stan models
+#'
+#' @name stan_threads
+#' @description These functions set or get the `STAN_NUM_THREADS` environment
+#'   variable.
 #'
-#' @return Returns the value of environment variable of STAN_NUM_THREADS
+NULL
+
+#' @rdname stan_threads
 #' @export
-get_num_threads <- function() {
+#' @return The value of the environment variable `STAN_NUM_THREADS`.
+num_threads <- function() {
   num_threads <- Sys.getenv(""STAN_NUM_THREADS"")
-  return(as.numeric(num_threads))
+  as.integer(num_threads)
 }
 
 #' @rdname stan_threads
-#' Sets the environment variable STAN_NUM_THREADS to the provided value
-#' @param num_threads (non-zero positive integer) the number of threads to set
 #' @export
+#' @param num_threads (positive integer) The number of threads to set.
 set_num_threads <- function(num_threads) {
   if(is.numeric(num_threads) && num_threads%%1==0 && num_threads > 0) {
     Sys.setenv(""STAN_NUM_THREADS"" = num_threads)",True,False,Implementation / Logic,6
stan-dev,cmdstanr,3642adef64b79b1310835a4c95a9cb6eea133ebc,jgabry,jgabry@gmail.com,2019-10-15T20:23:41Z,jgabry,jgabry@gmail.com,2019-10-15T20:23:41Z,Fix link in vignette,docs/articles/cmdstanr.html;vignettes/cmdstanr.Rmd,True,False,True,False,28,28,56,"---FILE: docs/articles/cmdstanr.html---
@@ -160,7 +160,7 @@ <h3 class=""hasAnchor"">
 <div class=""sourceCode"" id=""cb5""><pre class=""sourceCode r""><code class=""sourceCode r""><a class=""sourceLine"" id=""cb5-1"" data-line-number=""1"">file &lt;-<span class=""st""> </span><span class=""kw""><a href=""https://rdrr.io/r/base/file.path.html"">file.path</a></span>(<span class=""kw""><a href=""../reference/cmdstan_path.html"">cmdstan_path</a></span>(), <span class=""st"">""examples""</span>, <span class=""st"">""bernoulli""</span>, <span class=""st"">""bernoulli.stan""</span>)</a>
 <a class=""sourceLine"" id=""cb5-2"" data-line-number=""2"">mod &lt;-<span class=""st""> </span><span class=""kw""><a href=""../reference/cmdstan_model.html"">cmdstan_model</a></span>(file)</a></code></pre></div>
 <p>The object <code>mod</code> is an <a href=""https://r6.r-lib.org/"">R6</a> object, which is similar to Rs reference class objects. This design choice was made to make CmdStanR and CmdStanPy have similar user interfaces.</p>
-<p>The <a href=""https://mc-stan.org/cmdstanr/reference/model-method-compile.html""><code>compile()</code></a> method is used to translate the Stan code to C++ and compile the C++ code:</p>
+<p>The <a href=""https://mc-stan.org/cmdstanr/reference/model-method-compile.html""><code>$compile()</code></a> method is used to translate the Stan code to C++ and compile the C++ code:</p>
 <div class=""sourceCode"" id=""cb6""><pre class=""sourceCode r""><code class=""sourceCode r""><a class=""sourceLine"" id=""cb6-1"" data-line-number=""1"">mod<span class=""op"">$</span><span class=""kw"">compile</span>()</a></code></pre></div>
 <pre><code>Running make \
   /Users/jgabry/.cmdstanr/cmdstan/examples/bernoulli/bernoulli
@@ -182,7 +182,7 @@ <h3 class=""hasAnchor"">
 <div id=""model-fitting"" class=""section level3"">
 <h3 class=""hasAnchor"">
 <a href=""#model-fitting"" class=""anchor""></a>Model fitting</h3>
-<p>To run Stans MCMC algorithm we can use the <a href=""https://mc-stan.org/cmdstanr/reference/model-method-compile.html""><code><a href=""https://rdrr.io/r/base/sample.html"">sample()</a></code></a> method for <a href=""https://mc-stan.org/cmdstanr/reference/CmdStanModel.html""><code>CmdStanModel</code></a> objects. Data can be passed in as a named list of R objects (like for RStan) or as a path to a data file compatible with CmdStan (R dump or JSON).</p>
+<p>To run Stans MCMC algorithm we can use the <a href=""https://mc-stan.org/cmdstanr/reference/model-method-sample.html""><code>$sample()</code></a> method for <a href=""https://mc-stan.org/cmdstanr/reference/CmdStanModel.html""><code>CmdStanModel</code></a> objects. Data can be passed in as a named list of R objects (like for RStan) or as a path to a data file compatible with CmdStan (R dump or JSON).</p>
 <div class=""sourceCode"" id=""cb10""><pre class=""sourceCode r""><code class=""sourceCode r""><a class=""sourceLine"" id=""cb10-1"" data-line-number=""1"">data_list &lt;-<span class=""st""> </span><span class=""kw""><a href=""https://rdrr.io/r/base/list.html"">list</a></span>(<span class=""dt"">N =</span> <span class=""dv"">10</span>, <span class=""dt"">y =</span><span class=""kw""><a href=""https://rdrr.io/r/base/c.html"">c</a></span>(<span class=""dv"">0</span>,<span class=""dv"">1</span>,<span class=""dv"">0</span>,<span class=""dv"">0</span>,<span class=""dv"">0</span>,<span class=""dv"">0</span>,<span class=""dv"">0</span>,<span class=""dv"">0</span>,<span class=""dv"">0</span>,<span class=""dv"">1</span>))</a>
 <a class=""sourceLine"" id=""cb10-2"" data-line-number=""2"">fit_mcmc &lt;-<span class=""st""> </span>mod<span class=""op"">$</span><span class=""kw""><a href=""https://rdrr.io/r/base/sample.html"">sample</a></span>(<span class=""dt"">data =</span> data_list, <span class=""dt"">seed =</span> <span class=""dv"">123</span>, <span class=""dt"">num_chains =</span> <span class=""dv"">2</span>)</a></code></pre></div>
 <pre><code>method = sample (Default)
@@ -211,12 +211,12 @@ <h3 class=""hasAnchor"">
         stepsize_jitter = 0 (Default)
 id = 1
 data
-  file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpxzWm8C/standata-31aa3c33079e.data.R
+  file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpxE1xDU/standata-337120ce8d5b.data.R
 init = 2 (Default)
 random
   seed = 123
 output
-  file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//RtmpxzWm8C/bernoulli-stan-sample-1.csv
+  file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//RtmpxE1xDU/bernoulli-stan-sample-1.csv
   diagnostic_file =  (Default)
   refresh = 100 (Default)
 
@@ -249,9 +249,9 @@ <h3 class=""hasAnchor"">
 Iteration: 1900 / 2000 [ 95%]  (Sampling)
 Iteration: 2000 / 2000 [100%]  (Sampling)
 
- Elapsed Time: 0.013463 seconds (Warm-up)
-               0.021477 seconds (Sampling)
-               0.03494 seconds (Total)
+ Elapsed Time: 0.012173 seconds (Warm-up)
+               0.018743 seconds (Sampling)
+               0.030916 seconds (Total)
 
 method = sample (Default)
   sample
@@ -279,18 +279,18 @@ <h3 class=""hasAnchor"">
         stepsize_jitter = 0 (Default)
 id = 2
 data
-  file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpxzWm8C/standata-31aa3c33079e.data.R
+  file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmpxE1xDU/standata-337120ce8d5b.data.R
 init = 2 (Default)
 random
   seed = 124
 output
-  file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//RtmpxzWm8C/bernoulli-stan-sample-2.csv
+  file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//RtmpxE1xDU/bernoulli-stan-sample-2.csv
   diagnostic_file =  (Default)
   refresh = 100 (Default)
 
 
-Gradient evaluation took 1.8e-05 seconds
-1000 transitions using 10 leapfrog steps per transition would take 0.18 seconds.
+Gradient evaluation took 1.7e-05 seconds
+1000 transitions using 10 leapfrog steps per transition would take 0.17 seconds.
 Adjust your expectations accordingly!
 
 
@@ -317,29 +317,29 @@ <h3 class=""hasAnchor"">
 Iteration: 1900 / 2000 [ 95%]  (Sampling)
 Iteration: 2000 / 2000 [100%]  (Sampling)
 
- Elapsed Time: 0.013003 seconds (Warm-up)
-               0.019351 seconds (Sampling)
-               0.032354 seconds (Total)</code></pre>
+ Elapsed Time: 0.010768 seconds (Warm-up)
+               0.017686 seconds (Sampling)
+               0.028454 seconds (Total)</code></pre>
 <div class=""sourceCode"" id=""cb12""><pre class=""sourceCode r""><code class=""sourceCode r""><a class=""sourceLine"" id=""cb12-1"" data-line-number=""1""><span class=""co""># calls CmdStan's bin/stansummary</span></a>
 <a class=""sourceLine"" id=""cb12-2"" data-line-number=""2"">fit_mcmc<span class=""op"">$</span><span class=""kw""><a href=""https://rdrr.io/r/base/summary.html"">summary</a></span>()</a></code></pre></div>
 <pre><code>Running bin/stansummary \
-  /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//RtmpxzWm8C/bernoulli-stan-sample-1.csv \
-  /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//RtmpxzWm8C/bernoulli-stan-sample-2.csv
+  /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//RtmpxE1xDU/bernoulli-stan-sample-1.csv \
+  /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//RtmpxE1xDU/bernoulli-stan-sample-2.csv
 Inference for Stan model: bernoulli_model
 2 chains: each with iter=(1000,1000); warmup=(0,0); thin=(1,1); 2000 iterations saved.
 
-Warmup took (0.013, 0.013) seconds, 0.026 seconds total
-Sampling took (0.021, 0.019) seconds, 0.041 seconds total
+Warmup took (0.012, 0.011) seconds, 0.023 seconds total
+Sampling took (0.019, 0.018) seconds, 0.036 seconds total
 
                 Mean     MCSE   StdDev     5%   50%   95%  N_Eff  N_Eff/s    R_hat
-lp__            -7.3  2.7e-02  7.3e-01   -8.9  -7.0  -6.8    738    18087  1.0e+00
-accept_stat__   0.92  3.1e-03  1.3e-01   0.64  0.97   1.0   1670    40892  1.0e+00
-stepsize__      0.92  1.7e-03  1.7e-03   0.92  0.92  0.92    1.0       25  1.4e+12
-treedepth__      1.3  1.1e-02  4.7e-01    1.0   1.0   2.0   1968    48197  1.0e+00
-n_leapfrog__     2.4  2.5e-02  1.0e+00    1.0   3.0   3.0   1640    40172  1.0e+00
-divergent__     0.00  0.0e+00  0.0e+00   0.00  0.00  0.00   1000    24493      nan
-energy__         7.8  4.0e-02  1.0e+00    6.8   7.5   9.8    647    15841  1.0e+00
-theta           0.24  4.6e-03  1.2e-01  0.077  0.22  0.47    720    17638  1.0e+00
+lp__            -7.3  2.7e-02  7.3e-01   -8.9  -7.0  -6.8    738    20271  1.0e+00
+accept_stat__   0.92  3.1e-03  1.3e-01   0.64  0.97   1.0   1670    45830  1.0e+00
+stepsize__      0.92  1.7e-03  1.7e-03   0.92  0.92  0.92    1.0       28  1.4e+12
+treedepth__      1.3  1.1e-02  4.7e-01    1.0   1.0   2.0   1968    54017  1.0e+00
+n_leapfrog__     2.4  2.5e-02  1.0e+00    1.0   3.0   3.0   1640    45023  1.0e+00
+divergent__     0.00  0.0e+00  0.0e+00   0.00  0.00  0.00   1000    27451      nan
+energy__         7.8  4.0e-02  1.0e+00    6.8   7.5   9.8    647    17754  1.0e+00
+theta           0.24  4.6e-03  1.2e-01  0.077  0.22  0.47    720    19768  1.0e+00
 
 Samples were drawn using hmc with nuts.
 For each parameter, N_Eff is a crude measure of effective sample size,

---FILE: vignettes/cmdstanr.Rmd---
@@ -89,7 +89,7 @@ R's reference class objects. This design choice was made to make CmdStanR
 and CmdStanPy have similar user interfaces. 
 
 The
-[`compile()`](https://mc-stan.org/cmdstanr/reference/model-method-compile.html)
+[`$compile()`](https://mc-stan.org/cmdstanr/reference/model-method-compile.html)
 method is used to translate the Stan code to C++ and compile the C++ code:
 
 ```{r compile}
@@ -101,7 +101,7 @@ mod$print()  # print the Stan program
 ### Model fitting
 
 To run Stan's MCMC algorithm we can use the
-[`sample()`](https://mc-stan.org/cmdstanr/reference/model-method-compile.html)
+[`$sample()`](https://mc-stan.org/cmdstanr/reference/model-method-sample.html)
 method for
 [`CmdStanModel`](https://mc-stan.org/cmdstanr/reference/CmdStanModel.html)
 objects. Data can be passed in as a named list of R objects (like for RStan) or",False,True,Rendering / Conversion,6
stan-dev,cmdstanr,3937374dc8dc61ce00c13f2baf1e1abec9aec863,jgabry,jgabry@gmail.com,2019-10-15T17:58:01Z,jgabry,jgabry@gmail.com,2019-10-15T17:58:01Z,fix bad links in docs,R/fit.R;docs/reference/CmdStanMCMC.html;docs/reference/CmdStanMLE.html;docs/reference/CmdStanModel.html;docs/reference/CmdStanVB.html;docs/reference/cmdstan_model.html;docs/reference/model-method-compile.html;docs/reference/model-method-optimize.html;docs/reference/model-method-sample.html;docs/reference/model-method-variational.html;man/CmdStanMCMC.Rd;man/CmdStanMLE.Rd;man/CmdStanVB.Rd,False,True,True,False,195,195,390,"---FILE: R/fit.R---
@@ -7,7 +7,7 @@
 #' @template seealso-docs
 #'
 #' @description A `CmdStanMCMC` object is the fitted model object returned by
-#'   the [`sample()`][CmdStanModel-method-sample] method of a [`CmdStanModel`]
+#'   the [`sample()`][model-method-sample] method of a [`CmdStanModel`]
 #'   object. Like `CmdStanModel` objects, `CmdStanMCMC` objects are [R6][R6::R6]
 #'   objects.
 #'
@@ -106,7 +106,7 @@ CmdStanMCMC <- R6::R6Class(
 #' @template seealso-docs
 #'
 #' @description A `CmdStanMLE` object is the fitted model object returned by the
-#'   [`optimize()`][CmdStanModel-method-optimize] method of a [`CmdStanModel`]
+#'   [`optimize()`][model-method-optimize] method of a [`CmdStanModel`]
 #'   object.
 #'
 #' @details
@@ -173,7 +173,7 @@ CmdStanMLE <- R6::R6Class(
 #' @template seealso-docs
 #'
 #' @description A `CmdStanVB` object is the fitted model object returned by the
-#'   [`variational()`][CmdStanModel-method-variational] method of a
+#'   [`variational()`][model-method-variational] method of a
 #'   [`CmdStanModel`] object.
 #'
 #' @details

---FILE: docs/reference/CmdStanMCMC.html---
@@ -162,7 +162,7 @@ <h1>CmdStanMCMC objects</h1>
 
     <div class=""ref-description"">
     <p>A <code>CmdStanMCMC</code> object is the fitted model object returned by
-the <code><a href='https://rdrr.io/r/base/sample.html'>sample()</a></code> method of a <code><a href='CmdStanModel.html'>CmdStanModel</a></code>
+the <code><a href='model-method-sample.html'>sample()</a></code> method of a <code><a href='CmdStanModel.html'>CmdStanModel</a></code>
 object. Like <code>CmdStanModel</code> objects, <code>CmdStanMCMC</code> objects are <a href='https://rdrr.io/pkg/R6/man/R6Class.html'>R6</a>
 objects.</p>
     </div>

---FILE: docs/reference/CmdStanMLE.html---
@@ -161,7 +161,7 @@ <h1>CmdStanMLE objects</h1>
 
     <div class=""ref-description"">
     <p>A <code>CmdStanMLE</code> object is the fitted model object returned by the
-<code><a href='https://rdrr.io/r/stats/optimize.html'>optimize()</a></code> method of a <code><a href='CmdStanModel.html'>CmdStanModel</a></code>
+<code><a href='model-method-optimize.html'>optimize()</a></code> method of a <code><a href='CmdStanModel.html'>CmdStanModel</a></code>
 object.</p>
     </div>
 

---FILE: docs/reference/CmdStanModel.html---
@@ -251,18 +251,18 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt;         stepsize_jitter = 0 (Default)
 #&gt; id = 1
 #&gt; data
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmpu3Awk6/standata-1c4f69600c54.data.R
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmp6HNWGV/standata-26f04036dbc4.data.R
 #&gt; init = 2 (Default)
 #&gt; random
 #&gt;   seed = 123
 #&gt; output
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-sample-1.csv
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-sample-1.csv
 #&gt;   diagnostic_file =  (Default)
 #&gt;   refresh = 100 (Default)
 #&gt; 
 #&gt; 
-#&gt; Gradient evaluation took 1.8e-05 seconds
-#&gt; 1000 transitions using 10 leapfrog steps per transition would take 0.18 seconds.
+#&gt; Gradient evaluation took 2.1e-05 seconds
+#&gt; 1000 transitions using 10 leapfrog steps per transition would take 0.21 seconds.
 #&gt; Adjust your expectations accordingly!
 #&gt; 
 #&gt; 
@@ -289,9 +289,9 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; Iteration: 1900 / 2000 [ 95%]  (Sampling)
 #&gt; Iteration: 2000 / 2000 [100%]  (Sampling)
 #&gt; 
-#&gt;  Elapsed Time: 0.012728 seconds (Warm-up)
-#&gt;                0.020008 seconds (Sampling)
-#&gt;                0.032736 seconds (Total)
+#&gt;  Elapsed Time: 0.012692 seconds (Warm-up)
+#&gt;                0.0214 seconds (Sampling)
+#&gt;                0.034092 seconds (Total)
 #&gt; 
 #&gt; method = sample (Default)
 #&gt;   sample
@@ -319,12 +319,12 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt;         stepsize_jitter = 0 (Default)
 #&gt; id = 2
 #&gt; data
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmpu3Awk6/standata-1c4f69600c54.data.R
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmp6HNWGV/standata-26f04036dbc4.data.R
 #&gt; init = 2 (Default)
 #&gt; random
 #&gt;   seed = 124
 #&gt; output
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-sample-2.csv
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-sample-2.csv
 #&gt;   diagnostic_file =  (Default)
 #&gt;   refresh = 100 (Default)
 #&gt; 
@@ -357,29 +357,29 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; Iteration: 1900 / 2000 [ 95%]  (Sampling)
 #&gt; Iteration: 2000 / 2000 [100%]  (Sampling)
 #&gt; 
-#&gt;  Elapsed Time: 0.011255 seconds (Warm-up)
-#&gt;                0.018377 seconds (Sampling)
-#&gt;                0.029632 seconds (Total)
+#&gt;  Elapsed Time: 0.012851 seconds (Warm-up)
+#&gt;                0.020171 seconds (Sampling)
+#&gt;                0.033022 seconds (Total)
 #&gt; </div><div class='input'>
 <span class='co'># Call CmdStan's bin/summary</span>
 <span class='no'>fit_mcmc</span>$<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span>()</div><div class='output co'>#&gt; Running bin/stansummary \
-#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-sample-1.csv \
-#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-sample-2.csv
+#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-sample-1.csv \
+#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-sample-2.csv
 #&gt; Inference for Stan model: bernoulli_model
 #&gt; 2 chains: each with iter=(1000,1000); warmup=(0,0); thin=(1,1); 2000 iterations saved.
 #&gt; 
-#&gt; Warmup took (0.013, 0.011) seconds, 0.024 seconds total
-#&gt; Sampling took (0.020, 0.018) seconds, 0.038 seconds total
+#&gt; Warmup took (0.013, 0.013) seconds, 0.026 seconds total
+#&gt; Sampling took (0.021, 0.020) seconds, 0.042 seconds total
 #&gt; 
 #&gt;                 Mean     MCSE   StdDev     5%   50%   95%  N_Eff  N_Eff/s    R_hat
-#&gt; lp__            -7.3  2.7e-02  7.3e-01   -8.9  -7.0  -6.8    738    19238  1.0e+00
-#&gt; accept_stat__   0.92  3.1e-03  1.3e-01   0.64  0.97   1.0   1670    43494  1.0e+00
-#&gt; stepsize__      0.92  1.7e-03  1.7e-03   0.92  0.92  0.92    1.0       26  1.4e+12
-#&gt; treedepth__      1.3  1.1e-02  4.7e-01    1.0   1.0   2.0   1968    51264  1.0e+00
-#&gt; n_leapfrog__     2.4  2.5e-02  1.0e+00    1.0   3.0   3.0   1640    42729  1.0e+00
-#&gt; divergent__     0.00  0.0e+00  0.0e+00   0.00  0.00  0.00   1000    26052      nan
-#&gt; energy__         7.8  4.0e-02  1.0e+00    6.8   7.5   9.8    647    16849  1.0e+00
-#&gt; theta           0.24  4.6e-03  1.2e-01  0.077  0.22  0.47    720    18760  1.0e+00
+#&gt; lp__            -7.3  2.7e-02  7.3e-01   -8.9  -7.0  -6.8    738    17764  1.0e+00
+#&gt; accept_stat__   0.92  3.1e-03  1.3e-01   0.64  0.97   1.0   1670    40161  1.0e+00
+#&gt; stepsize__      0.92  1.7e-03  1.7e-03   0.92  0.92  0.92    1.0       24  1.4e+12
+#&gt; treedepth__      1.3  1.1e-02  4.7e-01    1.0   1.0   2.0   1968    47335  1.0e+00
+#&gt; n_leapfrog__     2.4  2.5e-02  1.0e+00    1.0   3.0   3.0   1640    39454  1.0e+00
+#&gt; divergent__     0.00  0.0e+00  0.0e+00   0.00  0.00  0.00   1000    24055      nan
+#&gt; energy__         7.8  4.0e-02  1.0e+00    6.8   7.5   9.8    647    15558  1.0e+00
+#&gt; theta           0.24  4.6e-03  1.2e-01  0.077  0.22  0.47    720    17322  1.0e+00
 #&gt; 
 #&gt; Samples were drawn using hmc with nuts.
 #&gt; For each parameter, N_Eff is a crude measure of effective sample size,
@@ -409,7 +409,7 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; random
 #&gt;   seed = 123
 #&gt; output
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-optimize-1.csv
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-optimize-1.csv
 #&gt;   diagnostic_file =  (Default)
 #&gt;   refresh = 100 (Default)
 #&gt; 
@@ -438,12 +438,12 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt;     output_samples = 1000 (Default)
 #&gt; id = 1
 #&gt; data
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmpu3Awk6/standata-1c4f20c994d8.data.R
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmp6HNWGV/standata-26f0519641cb.data.R
 #&gt; init = 2 (Default)
 #&gt; random
 #&gt;   seed = 123
 #&gt; output
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-variational-1.csv
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-variational-1.csv
 #&gt;   diagnostic_file =  (Default)
 #&gt;   refresh = 100 (Default)
 #&gt; 
@@ -455,8 +455,8 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; 
 #&gt; 
 #&gt; 
-#&gt; Gradient evaluation took 1.9e-05 seconds
-#&gt; 1000 transitions using 10 leapfrog steps per transition would take 0.19 seconds.
+#&gt; Gradient evaluation took 2.7e-05 seconds
+#&gt; 1000 transitions using 10 leapfrog steps per transition would take 0.27 seconds.
 #&gt; Adjust your expectations accordingly!
 #&gt; 
 #&gt; 
@@ -491,7 +491,7 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; COMPLETED.</div><div class='input'>
 <span class='co'># Call CmdStan's bin/summary</span>
 <span class='no'>fit_vb</span>$<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span>()</div><div class='output co'>#&gt; Running bin/stansummary \
-#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-variational-1.csv
+#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-variational-1.csv
 #&gt; Warning: non-fatal error reading adapation data
 #&gt; Inference for Stan model: bernoulli_model
 #&gt; 1 chains: each with iter=(1001); warmup=(0); thin=(0); 1001 iterations saved.
@@ -526,7 +526,7 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; theta  0.24    0.00 0.12  0.06  0.14  0.22  0.32  0.52   720    1
 #&gt; lp__  -7.32    0.03 0.73 -9.37 -7.53 -7.05 -6.81 -6.75   737    1
 #&gt; 
-#&gt; Samples were drawn using NUTS(diag_e) at Tue Oct 15 12:37:15 2019.
+#&gt; Samples were drawn using NUTS(diag_e) at Tue Oct 15 13:57:39 2019.
 #&gt; For each parameter, n_eff is a crude measure of effective sample size,
 #&gt; and Rhat is the potential scale reduction factor on split chains (at 
 #&gt; convergence, Rhat=1).</div><div class='input'>

---FILE: docs/reference/CmdStanVB.html---
@@ -161,7 +161,7 @@ <h1>CmdStanVB objects</h1>
 
     <div class=""ref-description"">
     <p>A <code>CmdStanVB</code> object is the fitted model object returned by the
-<code>variational()</code> method of a
+<code><a href='model-method-variational.html'>variational()</a></code> method of a
 <code><a href='CmdStanModel.html'>CmdStanModel</a></code> object.</p>
     </div>
 

---FILE: docs/reference/cmdstan_model.html---
@@ -246,18 +246,18 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt;         stepsize_jitter = 0 (Default)
 #&gt; id = 1
 #&gt; data
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmpu3Awk6/standata-1c4f6635755.data.R
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmp6HNWGV/standata-26f04d8472b6.data.R
 #&gt; init = 2 (Default)
 #&gt; random
 #&gt;   seed = 123
 #&gt; output
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-sample-1.csv
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-sample-1.csv
 #&gt;   diagnostic_file =  (Default)
 #&gt;   refresh = 100 (Default)
 #&gt; 
 #&gt; 
-#&gt; Gradient evaluation took 1.8e-05 seconds
-#&gt; 1000 transitions using 10 leapfrog steps per transition would take 0.18 seconds.
+#&gt; Gradient evaluation took 2.1e-05 seconds
+#&gt; 1000 transitions using 10 leapfrog steps per transition would take 0.21 seconds.
 #&gt; Adjust your expectations accordingly!
 #&gt; 
 #&gt; 
@@ -284,9 +284,9 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; Iteration: 1900 / 2000 [ 95%]  (Sampling)
 #&gt; Iteration: 2000 / 2000 [100%]  (Sampling)
 #&gt; 
-#&gt;  Elapsed Time: 0.011495 seconds (Warm-up)
-#&gt;                0.018069 seconds (Sampling)
-#&gt;                0.029564 seconds (Total)
+#&gt;  Elapsed Time: 0.014115 seconds (Warm-up)
+#&gt;                0.021552 seconds (Sampling)
+#&gt;                0.035667 seconds (Total)
 #&gt; 
 #&gt; method = sample (Default)
 #&gt;   sample
@@ -314,18 +314,18 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt;         stepsize_jitter = 0 (Default)
 #&gt; id = 2
 #&gt; data
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmpu3Awk6/standata-1c4f6635755.data.R
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmp6HNWGV/standata-26f04d8472b6.data.R
 #&gt; init = 2 (Default)
 #&gt; random
 #&gt;   seed = 124
 #&gt; output
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-sample-2.csv
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-sample-2.csv
 #&gt;   diagnostic_file =  (Default)
 #&gt;   refresh = 100 (Default)
 #&gt; 
 #&gt; 
-#&gt; Gradient evaluation took 1.7e-05 seconds
-#&gt; 1000 transitions using 10 leapfrog steps per transition would take 0.17 seconds.
+#&gt; Gradient evaluation took 2.2e-05 seconds
+#&gt; 1000 transitions using 10 leapfrog steps per transition would take 0.22 seconds.
 #&gt; Adjust your expectations accordingly!
 #&gt; 
 #&gt; 
@@ -352,29 +352,29 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; Iteration: 1900 / 2000 [ 95%]  (Sampling)
 #&gt; Iteration: 2000 / 2000 [100%]  (Sampling)
 #&gt; 
-#&gt;  Elapsed Time: 0.01131 seconds (Warm-up)
-#&gt;                0.020368 seconds (Sampling)
-#&gt;                0.031678 seconds (Total)
+#&gt;  Elapsed Time: 0.014268 seconds (Warm-up)
+#&gt;                0.02421 seconds (Sampling)
+#&gt;                0.038478 seconds (Total)
 #&gt; </div><div class='input'>
 <span class='co'># Call CmdStan's bin/summary</span>
 <span class='no'>fit_mcmc</span>$<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span>()</div><div class='output co'>#&gt; Running bin/stansummary \
-#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-sample-1.csv \
-#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-sample-2.csv
+#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-sample-1.csv \
+#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-sample-2.csv
 #&gt; Inference for Stan model: bernoulli_model
 #&gt; 2 chains: each with iter=(1000,1000); warmup=(0,0); thin=(1,1); 2000 iterations saved.
 #&gt; 
-#&gt; Warmup took (0.011, 0.011) seconds, 0.023 seconds total
-#&gt; Sampling took (0.018, 0.020) seconds, 0.038 seconds total
+#&gt; Warmup took (0.014, 0.014) seconds, 0.028 seconds total
+#&gt; Sampling took (0.022, 0.024) seconds, 0.046 seconds total
 #&gt; 
 #&gt;                 Mean     MCSE   StdDev     5%   50%   95%  N_Eff  N_Eff/s    R_hat
-#&gt; lp__            -7.3  2.7e-02  7.3e-01   -8.9  -7.0  -6.8    738    19212  1.0e+00
-#&gt; accept_stat__   0.92  3.1e-03  1.3e-01   0.64  0.97   1.0   1670    43436  1.0e+00
-#&gt; stepsize__      0.92  1.7e-03  1.7e-03   0.92  0.92  0.92    1.0       26  1.4e+12
-#&gt; treedepth__      1.3  1.1e-02  4.7e-01    1.0   1.0   2.0   1968    51195  1.0e+00
-#&gt; n_leapfrog__     2.4  2.5e-02  1.0e+00    1.0   3.0   3.0   1640    42671  1.0e+00
-#&gt; divergent__     0.00  0.0e+00  0.0e+00   0.00  0.00  0.00   1000    26017      nan
-#&gt; energy__         7.8  4.0e-02  1.0e+00    6.8   7.5   9.8    647    16827  1.0e+00
-#&gt; theta           0.24  4.6e-03  1.2e-01  0.077  0.22  0.47    720    18735  1.0e+00
+#&gt; lp__            -7.3  2.7e-02  7.3e-01   -8.9  -7.0  -6.8    738    16137  1.0e+00
+#&gt; accept_stat__   0.92  3.1e-03  1.3e-01   0.64  0.97   1.0   1670    36483  1.0e+00
+#&gt; stepsize__      0.92  1.7e-03  1.7e-03   0.92  0.92  0.92    1.0       22  1.4e+12
+#&gt; treedepth__      1.3  1.1e-02  4.7e-01    1.0   1.0   2.0   1968    43000  1.0e+00
+#&gt; n_leapfrog__     2.4  2.5e-02  1.0e+00    1.0   3.0   3.0   1640    35841  1.0e+00
+#&gt; divergent__     0.00  0.0e+00  0.0e+00   0.00  0.00  0.00   1000    21852      nan
+#&gt; energy__         7.8  4.0e-02  1.0e+00    6.8   7.5   9.8    647    14133  1.0e+00
+#&gt; theta           0.24  4.6e-03  1.2e-01  0.077  0.22  0.47    720    15736  1.0e+00
 #&gt; 
 #&gt; Samples were drawn using hmc with nuts.
 #&gt; For each parameter, N_Eff is a crude measure of effective sample size,
@@ -404,7 +404,7 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; random
 #&gt;   seed = 123
 #&gt; output
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-optimize-1.csv
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-optimize-1.csv
 #&gt;   diagnostic_file =  (Default)
 #&gt;   refresh = 100 (Default)
 #&gt; 
@@ -433,12 +433,12 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt;     output_samples = 1000 (Default)
 #&gt; id = 1
 #&gt; data
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmpu3Awk6/standata-1c4f63fa90b9.data.R
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmp6HNWGV/standata-26f03287327c.data.R
 #&gt; init = 2 (Default)
 #&gt; random
 #&gt;   seed = 123
 #&gt; output
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-variational-1.csv
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-variational-1.csv
 #&gt;   diagnostic_file =  (Default)
 #&gt;   refresh = 100 (Default)
 #&gt; 
@@ -450,8 +450,8 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; 
 #&gt; 
 #&gt; 
-#&gt; Gradient evaluation took 2.1e-05 seconds
-#&gt; 1000 transitions using 10 leapfrog steps per transition would take 0.21 seconds.
+#&gt; Gradient evaluation took 2e-05 seconds
+#&gt; 1000 transitions using 10 leapfrog steps per transition would take 0.2 seconds.
 #&gt; Adjust your expectations accordingly!
 #&gt; 
 #&gt; 
@@ -486,7 +486,7 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; COMPLETED.</div><div class='input'>
 <span class='co'># Call CmdStan's bin/summary</span>
 <span class='no'>fit_vb</span>$<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span>()</div><div class='output co'>#&gt; Running bin/stansummary \
-#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-variational-1.csv
+#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-variational-1.csv
 #&gt; Warning: non-fatal error reading adapation data
 #&gt; Inference for Stan model: bernoulli_model
 #&gt; 1 chains: each with iter=(1001); warmup=(0); thin=(0); 1001 iterations saved.
@@ -518,7 +518,7 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; theta  0.24    0.00 0.12  0.06  0.14  0.22  0.32  0.52   720    1
 #&gt; lp__  -7.32    0.03 0.73 -9.37 -7.53 -7.05 -6.81 -6.75   737    1
 #&gt; 
-#&gt; Samples were drawn using NUTS(diag_e) at Tue Oct 15 12:37:16 2019.
+#&gt; Samples were drawn using NUTS(diag_e) at Tue Oct 15 13:57:41 2019.
 #&gt; For each parameter, n_eff is a crude measure of effective sample size,
 #&gt; and Rhat is the potential scale reduction factor on split chains (at 
 #&gt; convergence, Rhat=1).</div><div class='input'>

---FILE: docs/reference/model-method-compile.html---
@@ -246,12 +246,12 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt;         stepsize_jitter = 0 (Default)
 #&gt; id = 1
 #&gt; data
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmpu3Awk6/standata-1c4f28af2f35.data.R
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmp6HNWGV/standata-26f0693cd032.data.R
 #&gt; init = 2 (Default)
 #&gt; random
 #&gt;   seed = 123
 #&gt; output
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-sample-1.csv
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-sample-1.csv
 #&gt;   diagnostic_file =  (Default)
 #&gt;   refresh = 100 (Default)
 #&gt; 
@@ -284,9 +284,9 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; Iteration: 1900 / 2000 [ 95%]  (Sampling)
 #&gt; Iteration: 2000 / 2000 [100%]  (Sampling)
 #&gt; 
-#&gt;  Elapsed Time: 0.014206 seconds (Warm-up)
-#&gt;                0.024648 seconds (Sampling)
-#&gt;                0.038854 seconds (Total)
+#&gt;  Elapsed Time: 0.013353 seconds (Warm-up)
+#&gt;                0.021173 seconds (Sampling)
+#&gt;                0.034526 seconds (Total)
 #&gt; 
 #&gt; method = sample (Default)
 #&gt;   sample
@@ -314,18 +314,18 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt;         stepsize_jitter = 0 (Default)
 #&gt; id = 2
 #&gt; data
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmpu3Awk6/standata-1c4f28af2f35.data.R
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmp6HNWGV/standata-26f0693cd032.data.R
 #&gt; init = 2 (Default)
 #&gt; random
 #&gt;   seed = 124
 #&gt; output
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-sample-2.csv
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-sample-2.csv
 #&gt;   diagnostic_file =  (Default)
 #&gt;   refresh = 100 (Default)
 #&gt; 
 #&gt; 
-#&gt; Gradient evaluation took 3.2e-05 seconds
-#&gt; 1000 transitions using 10 leapfrog steps per transition would take 0.32 seconds.
+#&gt; Gradient evaluation took 2e-05 seconds
+#&gt; 1000 transitions using 10 leapfrog steps per transition would take 0.2 seconds.
 #&gt; Adjust your expectations accordingly!
 #&gt; 
 #&gt; 
@@ -352,29 +352,29 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; Iteration: 1900 / 2000 [ 95%]  (Sampling)
 #&gt; Iteration: 2000 / 2000 [100%]  (Sampling)
 #&gt; 
-#&gt;  Elapsed Time: 0.015812 seconds (Warm-up)
-#&gt;                0.032053 seconds (Sampling)
-#&gt;                0.047865 seconds (Total)
+#&gt;  Elapsed Time: 0.013493 seconds (Warm-up)
+#&gt;                0.021744 seconds (Sampling)
+#&gt;                0.035237 seconds (Total)
 #&gt; </div><div class='input'>
 <span class='co'># Call CmdStan's bin/summary</span>
 <span class='no'>fit_mcmc</span>$<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span>()</div><div class='output co'>#&gt; Running bin/stansummary \
-#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-sample-1.csv \
-#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-sample-2.csv
+#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-sample-1.csv \
+#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-sample-2.csv
 #&gt; Inference for Stan model: bernoulli_model
 #&gt; 2 chains: each with iter=(1000,1000); warmup=(0,0); thin=(1,1); 2000 iterations saved.
 #&gt; 
-#&gt; Warmup took (0.014, 0.016) seconds, 0.030 seconds total
-#&gt; Sampling took (0.025, 0.032) seconds, 0.057 seconds total
+#&gt; Warmup took (0.013, 0.013) seconds, 0.027 seconds total
+#&gt; Sampling took (0.021, 0.022) seconds, 0.043 seconds total
 #&gt; 
 #&gt;                 Mean     MCSE   StdDev     5%   50%   95%  N_Eff  N_Eff/s    R_hat
-#&gt; lp__            -7.3  2.7e-02  7.3e-01   -8.9  -7.0  -6.8    738    13024  1.0e+00
-#&gt; accept_stat__   0.92  3.1e-03  1.3e-01   0.64  0.97   1.0   1670    29445  1.0e+00
-#&gt; stepsize__      0.92  1.7e-03  1.7e-03   0.92  0.92  0.92    1.0       18  1.4e+12
-#&gt; treedepth__      1.3  1.1e-02  4.7e-01    1.0   1.0   2.0   1968    34704  1.0e+00
-#&gt; n_leapfrog__     2.4  2.5e-02  1.0e+00    1.0   3.0   3.0   1640    28926  1.0e+00
-#&gt; divergent__     0.00  0.0e+00  0.0e+00   0.00  0.00  0.00   1000    17636      nan
-#&gt; energy__         7.8  4.0e-02  1.0e+00    6.8   7.5   9.8    647    11407  1.0e+00
-#&gt; theta           0.24  4.6e-03  1.2e-01  0.077  0.22  0.47    720    12700  1.0e+00
+#&gt; lp__            -7.3  2.7e-02  7.3e-01   -8.9  -7.0  -6.8    738    17207  1.0e+00
+#&gt; accept_stat__   0.92  3.1e-03  1.3e-01   0.64  0.97   1.0   1670    38901  1.0e+00
+#&gt; stepsize__      0.92  1.7e-03  1.7e-03   0.92  0.92  0.92    1.0       23  1.4e+12
+#&gt; treedepth__      1.3  1.1e-02  4.7e-01    1.0   1.0   2.0   1968    45851  1.0e+00
+#&gt; n_leapfrog__     2.4  2.5e-02  1.0e+00    1.0   3.0   3.0   1640    38217  1.0e+00
+#&gt; divergent__     0.00  0.0e+00  0.0e+00   0.00  0.00  0.00   1000    23301      nan
+#&gt; energy__         7.8  4.0e-02  1.0e+00    6.8   7.5   9.8    647    15070  1.0e+00
+#&gt; theta           0.24  4.6e-03  1.2e-01  0.077  0.22  0.47    720    16779  1.0e+00
 #&gt; 
 #&gt; Samples were drawn using hmc with nuts.
 #&gt; For each parameter, N_Eff is a crude measure of effective sample size,
@@ -404,7 +404,7 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; random
 #&gt;   seed = 123
 #&gt; output
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-optimize-1.csv
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-optimize-1.csv
 #&gt;   diagnostic_file =  (Default)
 #&gt;   refresh = 100 (Default)
 #&gt; 
@@ -433,12 +433,12 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt;     output_samples = 1000 (Default)
 #&gt; id = 1
 #&gt; data
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmpu3Awk6/standata-1c4f5445571.data.R
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmp6HNWGV/standata-26f01788b898.data.R
 #&gt; init = 2 (Default)
 #&gt; random
 #&gt;   seed = 123
 #&gt; output
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-variational-1.csv
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-variational-1.csv
 #&gt;   diagnostic_file =  (Default)
 #&gt;   refresh = 100 (Default)
 #&gt; 
@@ -486,7 +486,7 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; COMPLETED.</div><div class='input'>
 <span class='co'># Call CmdStan's bin/summary</span>
 <span class='no'>fit_vb</span>$<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span>()</div><div class='output co'>#&gt; Running bin/stansummary \
-#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-variational-1.csv
+#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-variational-1.csv
 #&gt; Warning: non-fatal error reading adapation data
 #&gt; Inference for Stan model: bernoulli_model
 #&gt; 1 chains: each with iter=(1001); warmup=(0); thin=(0); 1001 iterations saved.
@@ -518,7 +518,7 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; theta  0.24    0.00 0.12  0.06  0.14  0.22  0.32  0.52   720    1
 #&gt; lp__  -7.32    0.03 0.73 -9.37 -7.53 -7.05 -6.81 -6.75   737    1
 #&gt; 
-#&gt; Samples were drawn using NUTS(diag_e) at Tue Oct 15 12:37:18 2019.
+#&gt; Samples were drawn using NUTS(diag_e) at Tue Oct 15 13:57:42 2019.
 #&gt; For each parameter, n_eff is a crude measure of effective sample size,
 #&gt; and Rhat is the potential scale reduction factor on split chains (at 
 #&gt; convergence, Rhat=1).</div><div class='input'>

---FILE: docs/reference/model-method-optimize.html---
@@ -298,12 +298,12 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt;         stepsize_jitter = 0 (Default)
 #&gt; id = 1
 #&gt; data
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmpu3Awk6/standata-1c4f6736837b.data.R
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmp6HNWGV/standata-26f071042b54.data.R
 #&gt; init = 2 (Default)
 #&gt; random
 #&gt;   seed = 123
 #&gt; output
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-sample-1.csv
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-sample-1.csv
 #&gt;   diagnostic_file =  (Default)
 #&gt;   refresh = 100 (Default)
 #&gt; 
@@ -336,9 +336,9 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; Iteration: 1900 / 2000 [ 95%]  (Sampling)
 #&gt; Iteration: 2000 / 2000 [100%]  (Sampling)
 #&gt; 
-#&gt;  Elapsed Time: 0.019904 seconds (Warm-up)
-#&gt;                0.031333 seconds (Sampling)
-#&gt;                0.051237 seconds (Total)
+#&gt;  Elapsed Time: 0.013973 seconds (Warm-up)
+#&gt;                0.022374 seconds (Sampling)
+#&gt;                0.036347 seconds (Total)
 #&gt; 
 #&gt; method = sample (Default)
 #&gt;   sample
@@ -366,18 +366,18 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt;         stepsize_jitter = 0 (Default)
 #&gt; id = 2
 #&gt; data
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmpu3Awk6/standata-1c4f6736837b.data.R
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmp6HNWGV/standata-26f071042b54.data.R
 #&gt; init = 2 (Default)
 #&gt; random
 #&gt;   seed = 124
 #&gt; output
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-sample-2.csv
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-sample-2.csv
 #&gt;   diagnostic_file =  (Default)
 #&gt;   refresh = 100 (Default)
 #&gt; 
 #&gt; 
-#&gt; Gradient evaluation took 2.5e-05 seconds
-#&gt; 1000 transitions using 10 leapfrog steps per transition would take 0.25 seconds.
+#&gt; Gradient evaluation took 1.8e-05 seconds
+#&gt; 1000 transitions using 10 leapfrog steps per transition would take 0.18 seconds.
 #&gt; Adjust your expectations accordingly!
 #&gt; 
 #&gt; 
@@ -404,29 +404,29 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; Iteration: 1900 / 2000 [ 95%]  (Sampling)
 #&gt; Iteration: 2000 / 2000 [100%]  (Sampling)
 #&gt; 
-#&gt;  Elapsed Time: 0.013346 seconds (Warm-up)
-#&gt;                0.023377 seconds (Sampling)
-#&gt;                0.036723 seconds (Total)
+#&gt;  Elapsed Time: 0.012806 seconds (Warm-up)
+#&gt;                0.022654 seconds (Sampling)
+#&gt;                0.03546 seconds (Total)
 #&gt; </div><div class='input'>
 <span class='co'># Call CmdStan's bin/summary</span>
 <span class='no'>fit_mcmc</span>$<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span>()</div><div class='output co'>#&gt; Running bin/stansummary \
-#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-sample-1.csv \
-#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-sample-2.csv
+#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-sample-1.csv \
+#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-sample-2.csv
 #&gt; Inference for Stan model: bernoulli_model
 #&gt; 2 chains: each with iter=(1000,1000); warmup=(0,0); thin=(1,1); 2000 iterations saved.
 #&gt; 
-#&gt; Warmup took (0.020, 0.013) seconds, 0.033 seconds total
-#&gt; Sampling took (0.031, 0.023) seconds, 0.055 seconds total
+#&gt; Warmup took (0.014, 0.013) seconds, 0.027 seconds total
+#&gt; Sampling took (0.022, 0.023) seconds, 0.045 seconds total
 #&gt; 
 #&gt;                 Mean     MCSE   StdDev     5%   50%   95%  N_Eff  N_Eff/s    R_hat
-#&gt; lp__            -7.3  2.7e-02  7.3e-01   -8.9  -7.0  -6.8    738    13498  1.0e+00
-#&gt; accept_stat__   0.92  3.1e-03  1.3e-01   0.64  0.97   1.0   1670    30516  1.0e+00
-#&gt; stepsize__      0.92  1.7e-03  1.7e-03   0.92  0.92  0.92    1.0       18  1.4e+12
-#&gt; treedepth__      1.3  1.1e-02  4.7e-01    1.0   1.0   2.0   1968    35967  1.0e+00
-#&gt; n_leapfrog__     2.4  2.5e-02  1.0e+00    1.0   3.0   3.0   1640    29979  1.0e+00
-#&gt; divergent__     0.00  0.0e+00  0.0e+00   0.00  0.00  0.00   1000    18278      nan
-#&gt; energy__         7.8  4.0e-02  1.0e+00    6.8   7.5   9.8    647    11822  1.0e+00
-#&gt; theta           0.24  4.6e-03  1.2e-01  0.077  0.22  0.47    720    13162  1.0e+00
+#&gt; lp__            -7.3  2.7e-02  7.3e-01   -8.9  -7.0  -6.8    738    16400  1.0e+00
+#&gt; accept_stat__   0.92  3.1e-03  1.3e-01   0.64  0.97   1.0   1670    37078  1.0e+00
+#&gt; stepsize__      0.92  1.7e-03  1.7e-03   0.92  0.92  0.92    1.0       22  1.4e+12
+#&gt; treedepth__      1.3  1.1e-02  4.7e-01    1.0   1.0   2.0   1968    43701  1.0e+00
+#&gt; n_leapfrog__     2.4  2.5e-02  1.0e+00    1.0   3.0   3.0   1640    36425  1.0e+00
+#&gt; divergent__     0.00  0.0e+00  0.0e+00   0.00  0.00  0.00   1000    22208      nan
+#&gt; energy__         7.8  4.0e-02  1.0e+00    6.8   7.5   9.8    647    14364  1.0e+00
+#&gt; theta           0.24  4.6e-03  1.2e-01  0.077  0.22  0.47    720    15993  1.0e+00
 #&gt; 
 #&gt; Samples were drawn using hmc with nuts.
 #&gt; For each parameter, N_Eff is a crude measure of effective sample size,
@@ -456,7 +456,7 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; random
 #&gt;   seed = 123
 #&gt; output
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-optimize-1.csv
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-optimize-1.csv
 #&gt;   diagnostic_file =  (Default)
 #&gt;   refresh = 100 (Default)
 #&gt; 
@@ -485,12 +485,12 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt;     output_samples = 1000 (Default)
 #&gt; id = 1
 #&gt; data
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmpu3Awk6/standata-1c4f2bf2352d.data.R
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmp6HNWGV/standata-26f048b8d1c3.data.R
 #&gt; init = 2 (Default)
 #&gt; random
 #&gt;   seed = 123
 #&gt; output
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-variational-1.csv
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-variational-1.csv
 #&gt;   diagnostic_file =  (Default)
 #&gt;   refresh = 100 (Default)
 #&gt; 
@@ -502,8 +502,8 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; 
 #&gt; 
 #&gt; 
-#&gt; Gradient evaluation took 2.1e-05 seconds
-#&gt; 1000 transitions using 10 leapfrog steps per transition would take 0.21 seconds.
+#&gt; Gradient evaluation took 1.9e-05 seconds
+#&gt; 1000 transitions using 10 leapfrog steps per transition would take 0.19 seconds.
 #&gt; Adjust your expectations accordingly!
 #&gt; 
 #&gt; 
@@ -538,7 +538,7 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; COMPLETED.</div><div class='input'>
 <span class='co'># Call CmdStan's bin/summary</span>
 <span class='no'>fit_vb</span>$<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span>()</div><div class='output co'>#&gt; Running bin/stansummary \
-#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-variational-1.csv
+#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-variational-1.csv
 #&gt; Warning: non-fatal error reading adapation data
 #&gt; Inference for Stan model: bernoulli_model
 #&gt; 1 chains: each with iter=(1001); warmup=(0); thin=(0); 1001 iterations saved.
@@ -570,7 +570,7 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; theta  0.24    0.00 0.12  0.06  0.14  0.22  0.32  0.52   720    1
 #&gt; lp__  -7.32    0.03 0.73 -9.37 -7.53 -7.05 -6.81 -6.75   737    1
 #&gt; 
-#&gt; Samples were drawn using NUTS(diag_e) at Tue Oct 15 12:37:19 2019.
+#&gt; Samples were drawn using NUTS(diag_e) at Tue Oct 15 13:57:43 2019.
 #&gt; For each parameter, n_eff is a crude measure of effective sample size,
 #&gt; and Rhat is the potential scale reduction factor on split chains (at 
 #&gt; convergence, Rhat=1).</div><div class='input'>

---FILE: docs/reference/model-method-sample.html---
@@ -324,12 +324,12 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt;         stepsize_jitter = 0 (Default)
 #&gt; id = 1
 #&gt; data
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmpu3Awk6/standata-1c4f2e08e9d3.data.R
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmp6HNWGV/standata-26f024de5878.data.R
 #&gt; init = 2 (Default)
 #&gt; random
 #&gt;   seed = 123
 #&gt; output
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-sample-1.csv
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-sample-1.csv
 #&gt;   diagnostic_file =  (Default)
 #&gt;   refresh = 100 (Default)
 #&gt; 
@@ -362,9 +362,9 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; Iteration: 1900 / 2000 [ 95%]  (Sampling)
 #&gt; Iteration: 2000 / 2000 [100%]  (Sampling)
 #&gt; 
-#&gt;  Elapsed Time: 0.013959 seconds (Warm-up)
-#&gt;                0.02127 seconds (Sampling)
-#&gt;                0.035229 seconds (Total)
+#&gt;  Elapsed Time: 0.013431 seconds (Warm-up)
+#&gt;                0.022308 seconds (Sampling)
+#&gt;                0.035739 seconds (Total)
 #&gt; 
 #&gt; method = sample (Default)
 #&gt;   sample
@@ -392,18 +392,18 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt;         stepsize_jitter = 0 (Default)
 #&gt; id = 2
 #&gt; data
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmpu3Awk6/standata-1c4f2e08e9d3.data.R
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmp6HNWGV/standata-26f024de5878.data.R
 #&gt; init = 2 (Default)
 #&gt; random
 #&gt;   seed = 124
 #&gt; output
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-sample-2.csv
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-sample-2.csv
 #&gt;   diagnostic_file =  (Default)
 #&gt;   refresh = 100 (Default)
 #&gt; 
 #&gt; 
-#&gt; Gradient evaluation took 2.1e-05 seconds
-#&gt; 1000 transitions using 10 leapfrog steps per transition would take 0.21 seconds.
+#&gt; Gradient evaluation took 2e-05 seconds
+#&gt; 1000 transitions using 10 leapfrog steps per transition would take 0.2 seconds.
 #&gt; Adjust your expectations accordingly!
 #&gt; 
 #&gt; 
@@ -430,29 +430,29 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; Iteration: 1900 / 2000 [ 95%]  (Sampling)
 #&gt; Iteration: 2000 / 2000 [100%]  (Sampling)
 #&gt; 
-#&gt;  Elapsed Time: 0.012909 seconds (Warm-up)
-#&gt;                0.021591 seconds (Sampling)
-#&gt;                0.0345 seconds (Total)
+#&gt;  Elapsed Time: 0.013384 seconds (Warm-up)
+#&gt;                0.024306 seconds (Sampling)
+#&gt;                0.03769 seconds (Total)
 #&gt; </div><div class='input'>
 <span class='co'># Call CmdStan's bin/summary</span>
 <span class='no'>fit_mcmc</span>$<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span>()</div><div class='output co'>#&gt; Running bin/stansummary \
-#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-sample-1.csv \
-#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-sample-2.csv
+#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-sample-1.csv \
+#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-sample-2.csv
 #&gt; Inference for Stan model: bernoulli_model
 #&gt; 2 chains: each with iter=(1000,1000); warmup=(0,0); thin=(1,1); 2000 iterations saved.
 #&gt; 
-#&gt; Warmup took (0.014, 0.013) seconds, 0.027 seconds total
-#&gt; Sampling took (0.021, 0.022) seconds, 0.043 seconds total
+#&gt; Warmup took (0.013, 0.013) seconds, 0.027 seconds total
+#&gt; Sampling took (0.022, 0.024) seconds, 0.047 seconds total
 #&gt; 
 #&gt;                 Mean     MCSE   StdDev     5%   50%   95%  N_Eff  N_Eff/s    R_hat
-#&gt; lp__            -7.3  2.7e-02  7.3e-01   -8.9  -7.0  -6.8    738    17229  1.0e+00
-#&gt; accept_stat__   0.92  3.1e-03  1.3e-01   0.64  0.97   1.0   1670    38952  1.0e+00
-#&gt; stepsize__      0.92  1.7e-03  1.7e-03   0.92  0.92  0.92    1.0       23  1.4e+12
-#&gt; treedepth__      1.3  1.1e-02  4.7e-01    1.0   1.0   2.0   1968    45911  1.0e+00
-#&gt; n_leapfrog__     2.4  2.5e-02  1.0e+00    1.0   3.0   3.0   1640    38267  1.0e+00
-#&gt; divergent__     0.00  0.0e+00  0.0e+00   0.00  0.00  0.00   1000    23331      nan
-#&gt; energy__         7.8  4.0e-02  1.0e+00    6.8   7.5   9.8    647    15090  1.0e+00
-#&gt; theta           0.24  4.6e-03  1.2e-01  0.077  0.22  0.47    720    16801  1.0e+00
+#&gt; lp__            -7.3  2.7e-02  7.3e-01   -8.9  -7.0  -6.8    738    15842  1.0e+00
+#&gt; accept_stat__   0.92  3.1e-03  1.3e-01   0.64  0.97   1.0   1670    35816  1.0e+00
+#&gt; stepsize__      0.92  1.7e-03  1.7e-03   0.92  0.92  0.92    1.0       22  1.4e+12
+#&gt; treedepth__      1.3  1.1e-02  4.7e-01    1.0   1.0   2.0   1968    42214  1.0e+00
+#&gt; n_leapfrog__     2.4  2.5e-02  1.0e+00    1.0   3.0   3.0   1640    35186  1.0e+00
+#&gt; divergent__     0.00  0.0e+00  0.0e+00   0.00  0.00  0.00   1000    21453      nan
+#&gt; energy__         7.8  4.0e-02  1.0e+00    6.8   7.5   9.8    647    13875  1.0e+00
+#&gt; theta           0.24  4.6e-03  1.2e-01  0.077  0.22  0.47    720    15448  1.0e+00
 #&gt; 
 #&gt; Samples were drawn using hmc with nuts.
 #&gt; For each parameter, N_Eff is a crude measure of effective sample size,
@@ -482,7 +482,7 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; random
 #&gt;   seed = 123
 #&gt; output
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-optimize-1.csv
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-optimize-1.csv
 #&gt;   diagnostic_file =  (Default)
 #&gt;   refresh = 100 (Default)
 #&gt; 
@@ -511,12 +511,12 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt;     output_samples = 1000 (Default)
 #&gt; id = 1
 #&gt; data
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmpu3Awk6/standata-1c4f4b2f3341.data.R
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmp6HNWGV/standata-26f01824131.data.R
 #&gt; init = 2 (Default)
 #&gt; random
 #&gt;   seed = 123
 #&gt; output
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-variational-1.csv
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-variational-1.csv
 #&gt;   diagnostic_file =  (Default)
 #&gt;   refresh = 100 (Default)
 #&gt; 
@@ -528,8 +528,8 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; 
 #&gt; 
 #&gt; 
-#&gt; Gradient evaluation took 4.3e-05 seconds
-#&gt; 1000 transitions using 10 leapfrog steps per transition would take 0.43 seconds.
+#&gt; Gradient evaluation took 2e-05 seconds
+#&gt; 1000 transitions using 10 leapfrog steps per transition would take 0.2 seconds.
 #&gt; Adjust your expectations accordingly!
 #&gt; 
 #&gt; 
@@ -564,7 +564,7 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; COMPLETED.</div><div class='input'>
 <span class='co'># Call CmdStan's bin/summary</span>
 <span class='no'>fit_vb</span>$<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span>()</div><div class='output co'>#&gt; Running bin/stansummary \
-#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-variational-1.csv
+#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-variational-1.csv
 #&gt; Warning: non-fatal error reading adapation data
 #&gt; Inference for Stan model: bernoulli_model
 #&gt; 1 chains: each with iter=(1001); warmup=(0); thin=(0); 1001 iterations saved.
@@ -596,7 +596,7 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; theta  0.24    0.00 0.12  0.06  0.14  0.22  0.32  0.52   720    1
 #&gt; lp__  -7.32    0.03 0.73 -9.37 -7.53 -7.05 -6.81 -6.75   737    1
 #&gt; 
-#&gt; Samples were drawn using NUTS(diag_e) at Tue Oct 15 12:37:20 2019.
+#&gt; Samples were drawn using NUTS(diag_e) at Tue Oct 15 13:57:44 2019.
 #&gt; For each parameter, n_eff is a crude measure of effective sample size,
 #&gt; and Rhat is the potential scale reduction factor on split chains (at 
 #&gt; convergence, Rhat=1).</div><div class='input'>

---FILE: docs/reference/model-method-variational.html---
@@ -316,12 +316,12 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt;         stepsize_jitter = 0 (Default)
 #&gt; id = 1
 #&gt; data
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmpu3Awk6/standata-1c4f271ac518.data.R
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmp6HNWGV/standata-26f05fedea8a.data.R
 #&gt; init = 2 (Default)
 #&gt; random
 #&gt;   seed = 123
 #&gt; output
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-sample-1.csv
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-sample-1.csv
 #&gt;   diagnostic_file =  (Default)
 #&gt;   refresh = 100 (Default)
 #&gt; 
@@ -354,9 +354,9 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; Iteration: 1900 / 2000 [ 95%]  (Sampling)
 #&gt; Iteration: 2000 / 2000 [100%]  (Sampling)
 #&gt; 
-#&gt;  Elapsed Time: 0.015502 seconds (Warm-up)
-#&gt;                0.02332 seconds (Sampling)
-#&gt;                0.038822 seconds (Total)
+#&gt;  Elapsed Time: 0.013047 seconds (Warm-up)
+#&gt;                0.021648 seconds (Sampling)
+#&gt;                0.034695 seconds (Total)
 #&gt; 
 #&gt; method = sample (Default)
 #&gt;   sample
@@ -384,18 +384,18 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt;         stepsize_jitter = 0 (Default)
 #&gt; id = 2
 #&gt; data
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmpu3Awk6/standata-1c4f271ac518.data.R
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmp6HNWGV/standata-26f05fedea8a.data.R
 #&gt; init = 2 (Default)
 #&gt; random
 #&gt;   seed = 124
 #&gt; output
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-sample-2.csv
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-sample-2.csv
 #&gt;   diagnostic_file =  (Default)
 #&gt;   refresh = 100 (Default)
 #&gt; 
 #&gt; 
-#&gt; Gradient evaluation took 2e-05 seconds
-#&gt; 1000 transitions using 10 leapfrog steps per transition would take 0.2 seconds.
+#&gt; Gradient evaluation took 2.1e-05 seconds
+#&gt; 1000 transitions using 10 leapfrog steps per transition would take 0.21 seconds.
 #&gt; Adjust your expectations accordingly!
 #&gt; 
 #&gt; 
@@ -422,29 +422,29 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; Iteration: 1900 / 2000 [ 95%]  (Sampling)
 #&gt; Iteration: 2000 / 2000 [100%]  (Sampling)
 #&gt; 
-#&gt;  Elapsed Time: 0.016043 seconds (Warm-up)
-#&gt;                0.029265 seconds (Sampling)
-#&gt;                0.045308 seconds (Total)
+#&gt;  Elapsed Time: 0.013426 seconds (Warm-up)
+#&gt;                0.022259 seconds (Sampling)
+#&gt;                0.035685 seconds (Total)
 #&gt; </div><div class='input'>
 <span class='co'># Call CmdStan's bin/summary</span>
 <span class='no'>fit_mcmc</span>$<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span>()</div><div class='output co'>#&gt; Running bin/stansummary \
-#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-sample-1.csv \
-#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-sample-2.csv
+#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-sample-1.csv \
+#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-sample-2.csv
 #&gt; Inference for Stan model: bernoulli_model
 #&gt; 2 chains: each with iter=(1000,1000); warmup=(0,0); thin=(1,1); 2000 iterations saved.
 #&gt; 
-#&gt; Warmup took (0.016, 0.016) seconds, 0.032 seconds total
-#&gt; Sampling took (0.023, 0.029) seconds, 0.053 seconds total
+#&gt; Warmup took (0.013, 0.013) seconds, 0.026 seconds total
+#&gt; Sampling took (0.022, 0.022) seconds, 0.044 seconds total
 #&gt; 
 #&gt;                 Mean     MCSE   StdDev     5%   50%   95%  N_Eff  N_Eff/s    R_hat
-#&gt; lp__            -7.3  2.7e-02  7.3e-01   -8.9  -7.0  -6.8    738    14043  1.0e+00
-#&gt; accept_stat__   0.92  3.1e-03  1.3e-01   0.64  0.97   1.0   1670    31749  1.0e+00
-#&gt; stepsize__      0.92  1.7e-03  1.7e-03   0.92  0.92  0.92    1.0       19  1.4e+12
-#&gt; treedepth__      1.3  1.1e-02  4.7e-01    1.0   1.0   2.0   1968    37421  1.0e+00
-#&gt; n_leapfrog__     2.4  2.5e-02  1.0e+00    1.0   3.0   3.0   1640    31191  1.0e+00
-#&gt; divergent__     0.00  0.0e+00  0.0e+00   0.00  0.00  0.00   1000    19017      nan
-#&gt; energy__         7.8  4.0e-02  1.0e+00    6.8   7.5   9.8    647    12299  1.0e+00
-#&gt; theta           0.24  4.6e-03  1.2e-01  0.077  0.22  0.47    720    13694  1.0e+00
+#&gt; lp__            -7.3  2.7e-02  7.3e-01   -8.9  -7.0  -6.8    738    16819  1.0e+00
+#&gt; accept_stat__   0.92  3.1e-03  1.3e-01   0.64  0.97   1.0   1670    38024  1.0e+00
+#&gt; stepsize__      0.92  1.7e-03  1.7e-03   0.92  0.92  0.92    1.0       23  1.4e+12
+#&gt; treedepth__      1.3  1.1e-02  4.7e-01    1.0   1.0   2.0   1968    44817  1.0e+00
+#&gt; n_leapfrog__     2.4  2.5e-02  1.0e+00    1.0   3.0   3.0   1640    37355  1.0e+00
+#&gt; divergent__     0.00  0.0e+00  0.0e+00   0.00  0.00  0.00   1000    22775      nan
+#&gt; energy__         7.8  4.0e-02  1.0e+00    6.8   7.5   9.8    647    14730  1.0e+00
+#&gt; theta           0.24  4.6e-03  1.2e-01  0.077  0.22  0.47    720    16401  1.0e+00
 #&gt; 
 #&gt; Samples were drawn using hmc with nuts.
 #&gt; For each parameter, N_Eff is a crude measure of effective sample size,
@@ -474,7 +474,7 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; random
 #&gt;   seed = 123
 #&gt; output
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-optimize-1.csv
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-optimize-1.csv
 #&gt;   diagnostic_file =  (Default)
 #&gt;   refresh = 100 (Default)
 #&gt; 
@@ -503,12 +503,12 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt;     output_samples = 1000 (Default)
 #&gt; id = 1
 #&gt; data
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmpu3Awk6/standata-1c4f4e81beb6.data.R
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/Rtmp6HNWGV/standata-26f07cc13b39.data.R
 #&gt; init = 2 (Default)
 #&gt; random
 #&gt;   seed = 123
 #&gt; output
-#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-variational-1.csv
+#&gt;   file = /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-variational-1.csv
 #&gt;   diagnostic_file =  (Default)
 #&gt;   refresh = 100 (Default)
 #&gt; 
@@ -520,8 +520,8 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; 
 #&gt; 
 #&gt; 
-#&gt; Gradient evaluation took 1.9e-05 seconds
-#&gt; 1000 transitions using 10 leapfrog steps per transition would take 0.19 seconds.
+#&gt; Gradient evaluation took 2.1e-05 seconds
+#&gt; 1000 transitions using 10 leapfrog steps per transition would take 0.21 seconds.
 #&gt; Adjust your expectations accordingly!
 #&gt; 
 #&gt; 
@@ -556,7 +556,7 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; COMPLETED.</div><div class='input'>
 <span class='co'># Call CmdStan's bin/summary</span>
 <span class='no'>fit_vb</span>$<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span>()</div><div class='output co'>#&gt; Running bin/stansummary \
-#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmpu3Awk6/bernoulli-stan-variational-1.csv
+#&gt;   /var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T//Rtmp6HNWGV/bernoulli-stan-variational-1.csv
 #&gt; Warning: non-fatal error reading adapation data
 #&gt; Inference for Stan model: bernoulli_model
 #&gt; 1 chains: each with iter=(1001); warmup=(0); thin=(0); 1001 iterations saved.
@@ -588,7 +588,7 @@ <h2 class=""hasAnchor"" id=""examples""><a class=""anchor"" href=""#examples""></a>Examp
 #&gt; theta  0.24    0.00 0.12  0.06  0.14  0.22  0.32  0.52   720    1
 #&gt; lp__  -7.32    0.03 0.73 -9.37 -7.53 -7.05 -6.81 -6.75   737    1
 #&gt; 
-#&gt; Samples were drawn using NUTS(diag_e) at Tue Oct 15 12:37:21 2019.
+#&gt; Samples were drawn using NUTS(diag_e) at Tue Oct 15 13:57:46 2019.
 #&gt; For each parameter, n_eff is a crude measure of effective sample size,
 #&gt; and Rhat is the potential scale reduction factor on split chains (at 
 #&gt; convergence, Rhat=1).</div><div class='input'>

---FILE: man/CmdStanMCMC.Rd---
@@ -5,7 +5,7 @@
 \title{CmdStanMCMC objects}
 \description{
 A \code{CmdStanMCMC} object is the fitted model object returned by
-the \code{\link[=CmdStanModel-method-sample]{sample()}} method of a \code{\link{CmdStanModel}}
+the \code{\link[=model-method-sample]{sample()}} method of a \code{\link{CmdStanModel}}
 object. Like \code{CmdStanModel} objects, \code{CmdStanMCMC} objects are \link[R6:R6]{R6}
 objects.
 }

---FILE: man/CmdStanMLE.Rd---
@@ -5,7 +5,7 @@
 \title{CmdStanMLE objects}
 \description{
 A \code{CmdStanMLE} object is the fitted model object returned by the
-\code{\link[=CmdStanModel-method-optimize]{optimize()}} method of a \code{\link{CmdStanModel}}
+\code{\link[=model-method-optimize]{optimize()}} method of a \code{\link{CmdStanModel}}
 object.
 }
 \details{

---FILE: man/CmdStanVB.Rd---
@@ -5,7 +5,7 @@
 \title{CmdStanVB objects}
 \description{
 A \code{CmdStanVB} object is the fitted model object returned by the
-\code{\link[=CmdStanModel-method-variational]{variational()}} method of a
+\code{\link[=model-method-variational]{variational()}} method of a
 \code{\link{CmdStanModel}} object.
 }
 \details{",True,False,Documentation / Formatting,7
stan-dev,cmdstanr,1e462c6cd83211239ff4ec64b2f02ddca6cdf9ea,jgabry,jgabry@gmail.com,2019-10-15T01:10:13Z,jgabry,jgabry@gmail.com,2019-10-15T01:10:13Z,fix testthat.R,tests/testthat.R,False,True,True,False,4,1,5,"---FILE: tests/testthat.R---
@@ -1,7 +1,10 @@
 library(testthat)
 library(cmdstanr)
 
-NOT_CRAN <- !identical(Sys.getenv(""NOT_CRAN""), ""true"")
+NOT_CRAN <-
+  identical(Sys.getenv(""NOT_CRAN""), ""true"") ||
+  identical(Sys.getenv(""TRAVIS""), ""true"")
+
 if (NOT_CRAN) {
   test_check(""cmdstanr"")
 } else {",True,False,Dependency / Package,3
stan-dev,cmdstanr,111ee3c8ddad35fcda1cfa574d77547f57788728,jgabry,jgabry@gmail.com,2019-10-14T22:59:22Z,jgabry,jgabry@gmail.com,2019-10-14T22:59:22Z,"convert relative to absolute path correctly

fixes #30",R/model.R;R/path.R;R/utils.R,False,True,True,False,19,12,31,"---FILE: R/model.R---
@@ -101,7 +101,7 @@ CmdStanModel <- R6::R6Class(
   public = list(
     initialize = function(stan_file) {
       checkmate::assert_file_exists(stan_file, access = ""r"", extension = ""stan"")
-      private$stan_file_ <- repair_path(stan_file)
+      private$stan_file_ <- absolute_path(stan_file)
       invisible(self)
     },
     stan_file = function() private$stan_file_,
@@ -119,7 +119,6 @@ CmdStanModel <- R6::R6Class(
 )
 
 
-
 # CmdStanModel methods -----------------------------------
 
 #' Compile a Stan program or get the Stan code

---FILE: R/path.R---
@@ -31,10 +31,6 @@ cmdstan_path <- function() {
     stop(""CmdStan path has not been set yet. See ?set_cmdstan_path."",
          call. = FALSE)
   }
-  if (substr(path, nchar(path), nchar(path)) == ""/"") {
-    # remove training ""/"" (is this necessary?)
-    path <- substr(path, 1, nchar(path) - 1)
-  }
   path <- repair_path(path)
 
   if (is.null(.cmdstanr$VERSION)) {

---FILE: R/utils.R---
@@ -25,7 +25,14 @@ repair_path <- function(path) {
   if (!length(path) || !is.character(path)) {
     return(path)
   }
-  gsub(""\\\\"", ""/"", path)
+  path <- path.expand(path)
+  path <- gsub(""\\\\"", ""/"", path)
+  path <- gsub(""//"", ""/"", path)
+  if (substr(path, nchar(path), nchar(path)) == ""/"") {
+    # remove training ""/"" (is this necessary?)
+    path <- substr(path, 1, nchar(path) - 1)
+  }
+  path
 }
 
 #' Get extension for executable depending on OS
@@ -48,14 +55,19 @@ strip_ext <- function(file) {
 }
 
 # If a file/dir exists return its absolute path
-# unlike tools::file_path_as_absolute() it doesn't error if can't be found
-absolute_path <- function(x) {
-  if (!file.exists(x)) {
-    return(x)
+# doesn't error if not found
+absolute_path <- function(path) {
+  if (!file.exists(path)) {
+    return(path)
   }
-  tools::file_path_as_absolute(x)
+  new_path <- repair_path(path)
+  if (grepl(""^~"", path) || grepl(""^(/+|[A-Za-z]:)"", new_path)) {
+    return(new_path)
+  }
+  repair_path(file.path(getwd(), new_path))
 }
 
+
 # Change extension from a file path
 change_ext <- function(file, ext) {
   out <- strip_ext(file)",True,False,Implementation / Logic,6
stan-dev,cmdstanr,bae732ad7ae8698e20e818228a28442fb4658d0f,Jonah Gabry,jgabry@gmail.com,2019-10-13T03:30:25Z,GitHub,noreply@github.com,2019-10-13T03:30:25Z,"Fix typo in doc

[ci skip]",R/model.R,False,True,True,False,1,1,2,"---FILE: R/model.R---
@@ -6,7 +6,7 @@
 #'
 #' @export
 #' @param stan_file Path to Stan program.
-#' @return An [`CmdStanModel`] object.
+#' @return A [`CmdStanModel`] object.
 #'
 #' @template seealso-website
 #' @seealso [install_cmdstan()], [cmdstan_path()]",True,False,Documentation / Formatting,4
stan-dev,cmdstanr,98df277415f17a9b0add100e2f9255ecdd9bb48a,jgabry,jgabry@gmail.com,2019-10-12T05:00:23Z,jgabry,jgabry@gmail.com,2019-10-12T05:00:23Z,"Fix typo in doc

[ci skip]",R/fit.R;man/CmdStanMLE.Rd,False,True,True,False,4,4,8,"---FILE: R/fit.R---
@@ -139,11 +139,11 @@ CmdStanMCMC <- R6::R6Class(
 #' \describe{
 #'   \item{`mle()`}{
 #'   Return the maximum likelihood estimate or estimated posterior mode.
-#'   },
+#'   }
 #'   \item{`lp()`}{
 #'   Return the the total log probability density (up to an additive constant)
 #'   computed in the model block of the Stan program.
-#'   },
+#'   }
 #'   \item{`save_output_files(dir, basename = NULL)`}{
 #'   Move output csv file from temporary directory to a specified directory.
 #'   }

---FILE: man/CmdStanMLE.Rd---
@@ -14,11 +14,11 @@ associated methods:
 \describe{
 \item{\code{mle()}}{
 Return the maximum likelihood estimate or estimated posterior mode.
-},
+}
 \item{\code{lp()}}{
 Return the the total log probability density (up to an additive constant)
 computed in the model block of the Stan program.
-},
+}
 \item{\code{save_output_files(dir, basename = NULL)}}{
 Move output csv file from temporary directory to a specified directory.
 }",True,False,Documentation / Formatting,7
stan-dev,cmdstanr,96c5dbecf468a23bac8240c5ed2135110bf741d8,Jonah Gabry,jgabry@gmail.com,2019-10-11T21:31:00Z,GitHub,noreply@github.com,2019-10-11T21:31:00Z,Fix check warning due to missing link,man/CmdStanModel-method-variational.Rd,False,False,False,False,1,1,2,"---FILE: man/CmdStanModel-method-variational.Rd---
@@ -76,7 +76,7 @@ draw and save.
 }
 
 \section{Value}{
- The \code{variational} method returns a \code{\link{CmdStanVB}} object.
+ The \code{variational} method returns a \code{CmdStanVB} object.
 }
 
 \examples{",False,False,Documentation / Formatting,7
stan-dev,cmdstanr,c981fa9930e4c9bbd1ee179f9b44f2efa81db4b6,Jonah Gabry,jgabry@gmail.com,2019-10-11T21:24:34Z,GitHub,noreply@github.com,2019-10-11T21:24:34Z,"Fix r cmd check warning

Dont link to CmdStanVB until it exists",R/model.R,False,True,True,False,4,4,8,"---FILE: R/model.R---
@@ -73,11 +73,11 @@ cmdstan_model <- function(stan_file) {
 #'  [compile][CmdStanModel-method-other] \tab Compile Stan program  \cr
 #'  Fitting methods \tab Run Stan's algorithms  \cr
 #'  [sample][CmdStanModel-method-sample] \tab
-#'    Run CmdStan's `""sample""` method, return [CmdStanMCMC] object  \cr
+#'    Run CmdStan's `""sample""` method, return [`CmdStanMCMC`] object  \cr
 #'  [optimize][CmdStanModel-method-optimize]
-#'    \tab Run CmdStan's `""optimize""` method, return [CmdStanMLE] object  \cr
+#'    \tab Run CmdStan's `""optimize""` method, return [`CmdStanMLE`] object  \cr
 #'  [variational][CmdStanModel-method-variational]
-#'    \tab Run CmdStan's `""variational""` method, return [CmdStanVB] object  \cr
+#'    \tab Run CmdStan's `""variational""` method, return `CmdStanVB` object  \cr
 #' }
 #'
 #' @inherit cmdstan_model examples
@@ -482,7 +482,7 @@ NULL
 #'   * `output_samples:` (positive integer) Number of posterior samples to
 #'     draw and save.
 #'
-#' @section Value: The `variational` method returns a [`CmdStanVB`] object.
+#' @section Value: The `variational` method returns a `CmdStanVB` object.
 #'
 #' @seealso [CmdStanModel]
 #' @inherit cmdstan_model examples",True,False,Implementation / Logic,6
stan-dev,cmdstanr,f0ef4ca636aaa9056c26474d7a4877c52af38be4,jgabry,jgabry@gmail.com,2019-10-10T22:28:57Z,jgabry,jgabry@gmail.com,2019-10-10T22:28:57Z,"model.R: fix typo in example

[ci skip]",R/model.R;man/CmdStanModel.Rd;man/cmdstan_model.Rd,False,True,True,False,18,18,36,"---FILE: R/model.R---
@@ -13,16 +13,16 @@
 #' @examples
 #' \dontrun{
 #' # Set path to cmdstan
-#' # Note: if you used install_cmdstan() with default settings then
-#' # the path below should work. Otherwise change it to wherever you have
-#' # a CmdStan installation.
+#' # Note: if you installed CmdStan via install_cmdstan() with default settings
+#' # then default below should work. Otherwise use the `path` argument to
+#' # specify the location of your CmdStan installation.
 #'
-#' set_cmdstan_path(file.path(Sys.getenv(""HOME""), "".cmdstanr/cmdstan""))
+#' set_cmdstan_path(path = NULL)
 #'
 #' # Create a CmdStan model object from a Stan program,
 #' # here using the example model that comes with CmdStan
 #' stan_program <- file.path(cmdstan_path(), ""examples/bernoulli/bernoulli.stan"")
-#' mod <- cmdstan_model(my_stan_program)
+#' mod <- cmdstan_model(stan_program)
 #' mod$print()
 #'
 #' # Compile to create executable
@@ -34,7 +34,7 @@
 #' fit <- mod$sample(data = standata, seed = 123, num_chains = 2)
 #' fit$summary()
 #'
-#' # Can also specify data as a path to a file (like CmdStan)
+#' # Can also specify data as a path to a file readable by CmdStan
 #' my_data_file <- file.path(cmdstan_path(), ""examples/bernoulli/bernoulli.data.R"")
 #' fit2 <- mod$sample(data = my_data_file, seed = 123)
 #' fit2$summary()

---FILE: man/CmdStanModel.Rd---
@@ -44,16 +44,16 @@ CmdStan. Those csv files are written to the same directory as \code{stan_file}.
 \examples{
 \dontrun{
 # Set path to cmdstan
-# Note: if you used install_cmdstan() with default settings then
-# the path below should work. Otherwise change it to wherever you have
-# a CmdStan installation.
+# Note: if you installed CmdStan via install_cmdstan() with default settings
+# then default below should work. Otherwise use the `path` argument to
+# specify the location of your CmdStan installation.
 
-set_cmdstan_path(file.path(Sys.getenv(""HOME""), "".cmdstanr/cmdstan""))
+set_cmdstan_path(path = NULL)
 
 # Create a CmdStan model object from a Stan program,
 # here using the example model that comes with CmdStan
 stan_program <- file.path(cmdstan_path(), ""examples/bernoulli/bernoulli.stan"")
-mod <- cmdstan_model(my_stan_program)
+mod <- cmdstan_model(stan_program)
 mod$print()
 
 # Compile to create executable
@@ -65,7 +65,7 @@ standata <- list(N = 10, y =c(0,1,0,0,0,0,0,0,0,1))
 fit <- mod$sample(data = standata, seed = 123, num_chains = 2)
 fit$summary()
 
-# Can also specify data as a path to a file (like CmdStan)
+# Can also specify data as a path to a file readable by CmdStan
 my_data_file <- file.path(cmdstan_path(), ""examples/bernoulli/bernoulli.data.R"")
 fit2 <- mod$sample(data = my_data_file, seed = 123)
 fit2$summary()

---FILE: man/cmdstan_model.Rd---
@@ -20,16 +20,16 @@ file containing a Stan program.
 \examples{
 \dontrun{
 # Set path to cmdstan
-# Note: if you used install_cmdstan() with default settings then
-# the path below should work. Otherwise change it to wherever you have
-# a CmdStan installation.
+# Note: if you installed CmdStan via install_cmdstan() with default settings
+# then default below should work. Otherwise use the `path` argument to
+# specify the location of your CmdStan installation.
 
-set_cmdstan_path(file.path(Sys.getenv(""HOME""), "".cmdstanr/cmdstan""))
+set_cmdstan_path(path = NULL)
 
 # Create a CmdStan model object from a Stan program,
 # here using the example model that comes with CmdStan
 stan_program <- file.path(cmdstan_path(), ""examples/bernoulli/bernoulli.stan"")
-mod <- cmdstan_model(my_stan_program)
+mod <- cmdstan_model(stan_program)
 mod$print()
 
 # Compile to create executable
@@ -41,7 +41,7 @@ standata <- list(N = 10, y =c(0,1,0,0,0,0,0,0,0,1))
 fit <- mod$sample(data = standata, seed = 123, num_chains = 2)
 fit$summary()
 
-# Can also specify data as a path to a file (like CmdStan)
+# Can also specify data as a path to a file readable by CmdStan
 my_data_file <- file.path(cmdstan_path(), ""examples/bernoulli/bernoulli.data.R"")
 fit2 <- mod$sample(data = my_data_file, seed = 123)
 fit2$summary()",True,False,Documentation / Formatting,7
stan-dev,cmdstanr,351988d575a16c57d8b6a51c4c9a8122a8037275,jgabry,jgabry@gmail.com,2019-10-10T02:22:47Z,jgabry,jgabry@gmail.com,2019-10-10T02:22:47Z,"add more tests

* possible to use init file
* correct error message if try to sample without compiling
* optimize 'newton' and 'init_alpha' can't be specified at the same time",R/args.R;R/model.R;R/path.R;R/utils.R;man/cmdstan_path.Rd;tests/testthat/test-model.R;tests/testthat/test-path.R,False,True,True,False,78,35,113,"---FILE: R/args.R---
@@ -61,7 +61,9 @@ CmdStanArgs <- R6::R6Class(
                                    null.ok = FALSE)
 
       checkmate::assert_integerish(self$refresh, lower = 0, null.ok = TRUE)
-      checkmate::assert_file_exists(self$data_file, access = ""r"")
+      if (!is.null(self$data_file)) {
+        checkmate::assert_file_exists(self$data_file, access = ""r"")
+      }
 
       num_runs <- length(self$run_ids)
       validate_init(self$init, num_runs)
@@ -300,7 +302,7 @@ OptimizeArgs <- R6::R6Class(
       checkmate::assert_integerish(self$iter, lower = 0, null.ok = TRUE)
       checkmate::assert_number(self$init_alpha, lower = 0, null.ok = TRUE)
       if (!is.null(self$init_alpha) && isTRUE(self$algorithm == ""newton"")) {
-        stop(""'init_alpha' must not be set when algorithm is 'newton'."",
+        stop(""'init_alpha' can't be used when algorithm is 'newton'."",
              call. = FALSE)
       }
       invisible(self)
@@ -330,14 +332,14 @@ OptimizeArgs <- R6::R6Class(
 
 # FixedParamArgs -------------------------------------------------------------
 
-FixedParamArgs <- R6::R6Class(
-  ""FixedParamArgs"",
-  public = list(
-    method = ""fixed_param"",
-    compose = function(idx, args = NULL) c(args, ""method=fixed_param""),
-    validate = function(num_runs) invisible(self)
-  )
-)
+# FixedParamArgs <- R6::R6Class(
+#   ""FixedParamArgs"",
+#   public = list(
+#     method = ""fixed_param"",
+#     compose = function(idx, args = NULL) c(args, ""method=fixed_param""),
+#     validate = function(num_runs) invisible(self)
+#   )
+# )
 
 
 # Validation helpers ------------------------------------------------------

---FILE: R/model.R---
@@ -252,7 +252,7 @@ compile_stan_program <- function(stan_file) {
 #' @return Path to data file.
 process_data <- function(data) {
   if (is.null(data)) {
-    path <- absolute_path(""."")
+    path <- data
   } else if (is.character(data)) {
     path <- absolute_path(data)
   } else if (is.list(data) && !is.data.frame(data)) {

---FILE: R/path.R---
@@ -4,7 +4,7 @@
 #' can be set using the `set_cmdstan_path()` function. See **Details**.
 #'
 #' @export
-#' @return The full file path to the CmdStan installation.
+#' @return The file path to the CmdStan installation.
 #'
 #' @details
 #' Before the package can be used it needs to know where the CmdStan
@@ -17,11 +17,12 @@
 #' * If no environment variable is found when loaded but the directory
 #'   `"".cmdstanr/cmdstan""` exists in the user's home directory
 #'   (`Sys.getenv(""HOME"")`, *not* the current working directory) then it will
-#'   be set as the path to CmdStan. This is the default directory that
-#'   [install_cmdstan()] uses to install the latest version of CmdStan.
+#'   be set as the path to CmdStan for the \R session. This is the same as the
+#'   default directory that [install_cmdstan()] would use to install the latest
+#'   version of CmdStan.
 #'
-#' It is always possible to change the path after loading the package using the
-#' `set_cmdstan_path()` function.
+#' It is always possible to change the path after loading the package using
+#' `set_cmdstan_path(path)`.
 #'
 #'
 cmdstan_path <- function() {
@@ -119,6 +120,7 @@ cmdstanr_initialize <- function() {
   }
 
   .cmdstanr$TEMP_DIR <- tempdir(check = TRUE)
+  invisible(TRUE)
 }
 
 

---FILE: R/utils.R---
@@ -62,12 +62,6 @@ change_ext <- function(file, ext) {
   paste0(out, ext)
 }
 
-# Check for .stan file extension
-has_stan_ext <- function(stan_file) {
-  stopifnot(is.character(stan_file))
-  isTRUE(tools::file_ext(stan_file) == ""stan"")
-}
-
 
 # read, write, and copy files --------------------------------------------
 

---FILE: man/cmdstan_path.Rd---
@@ -15,7 +15,7 @@ set_cmdstan_path(path = NULL)
 \code{\link[=install_cmdstan]{install_cmdstan()}} if it exists.}
 }
 \value{
-The full file path to the CmdStan installation.
+The file path to the CmdStan installation.
 }
 \description{
 \code{cmdstan_path()} returns the full path to the CmdStan installation. The path
@@ -32,10 +32,11 @@ the \R session.
 \item If no environment variable is found when loaded but the directory
 \code{"".cmdstanr/cmdstan""} exists in the user's home directory
 (\code{Sys.getenv(""HOME"")}, \emph{not} the current working directory) then it will
-be set as the path to CmdStan. This is the default directory that
-\code{\link[=install_cmdstan]{install_cmdstan()}} uses to install the latest version of CmdStan.
+be set as the path to CmdStan for the \R session. This is the same as the
+default directory that \code{\link[=install_cmdstan]{install_cmdstan()}} would use to install the latest
+version of CmdStan.
 }
 
-It is always possible to change the path after loading the package using the
-\code{set_cmdstan_path()} function.
+It is always possible to change the path after loading the package using
+\code{set_cmdstan_path(path)}.
 }

---FILE: tests/testthat/test-model.R---
@@ -15,6 +15,15 @@ if (NOT_CRAN) {
 # Compile -----------------------------------------------------------------
 context(""CmdStanModel-compile"")
 
+test_that(""error if no compile() before sample()"", {
+  skip_on_cran()
+  expect_error(
+    mod$sample(),
+    ""Model not compiled. Try running the compile() method first."",
+    fixed = TRUE
+  )
+})
+
 test_that(""compile() method works"", {
   skip_on_cran()
   out <- capture.output(mod$compile())
@@ -50,7 +59,7 @@ if (NOT_CRAN) {
     save_warmup = FALSE,
     thin = 2,
     refresh = 5,
-    init = NULL,
+    init = 1.5,
     seed = 12345,
     max_depth = 6,
     metric = ""dense_e"",
@@ -86,10 +95,7 @@ if (NOT_CRAN) {
 }
 
 expect_sample_output <- function(object) {
-  testthat::expect_output(
-    object,
-    regexp = ""Gradient evaluation took""
-  )
+  testthat::expect_output(object, ""Gradient evaluation took"")
 }
 
 test_that(""sample() method doesn't error with data list"", {
@@ -106,14 +112,33 @@ test_that(""sample() method doesn't error with data file"", {
   expect_is(fit, ""CmdStanMCMC"")
 })
 
-test_that(""sample() method runs when all arguments specified validly"", {
+test_that(""sample() method works with init file"", {
+  skip_on_cran()
+  skip_if_not_installed(""rstan"")
+
+  init_list <- list(theta = 0.5)
+  init_file <- tempfile(
+    tmpdir = cmdstan_tempdir(),
+    pattern = ""testing-inits-"",
+    fileext = "".data.R""
+  )
+  rstan::stan_rdump(
+    names(init_list),
+    envir = as.environment(init_list),
+    file = init_file
+  )
+  expect_sample_output(mod$sample(data = data_file, init = init_file))
+})
+
+
+test_that(""sample() method runs when all arguments specified"", {
   skip_on_cran()
 
   expect_sample_output(fit <- do.call(mod$sample, ok_arg_values))
   expect_is(fit, ""CmdStanMCMC"")
 })
 
-test_that(""sample() method errors for invalid arguments before calling cmdstan"", {
+test_that(""sample() method errors for any invalid arguments before calling cmdstan"", {
   skip_on_cran()
 
   capture.output(mod$compile())
@@ -186,7 +211,7 @@ test_that(""optimize() method runs when all arguments specified validly"", {
   expect_is(fit2, ""CmdStanMLE"")
 })
 
-test_that(""optimize() method errors for invalid arguments before calling cmdstan"", {
+test_that(""optimize() method errors for any invalid argument before calling cmdstan"", {
   skip_on_cran()
 
   for (nm in names(bad_arg_values)) {
@@ -198,3 +223,13 @@ test_that(""optimize() method errors for invalid arguments before calling cmdstan
     )
   }
 })
+
+test_that(""optimize() errors when combining 'newton' with 'init_alpha'"", {
+  skip_on_cran()
+  expect_error(
+    expect_experimental_warning(
+      mod$optimize(data = data_list, algorithm = ""newton"", init_alpha = 0.1)
+    ),
+    ""'init_alpha' can't be used when algorithm is 'newton'""
+  )
+})

---FILE: tests/testthat/test-path.R---
@@ -48,6 +48,15 @@ test_that(""Setting path from env var is detected"", {
   Sys.setenv(CMDSTAN = PATH)
   expect_silent(cmdstanr_initialize())
   expect_equal(cmdstan_path(), PATH)
+  Sys.unsetenv(""CMDSTAN"")
+})
+
+test_that(""cmdstanr_initialize() also looks for default path"", {
+  skip_on_cran()
+
+  unset_cmdstan_path()
+  cmdstanr_initialize()
+  expect_equal(cmdstan_path(), PATH)
 })
 
 ",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,4890e190b5835c75faf9634b7d8dd5c830332506,jgabry,jgabry@gmail.com,2019-10-09T06:27:48Z,jgabry,jgabry@gmail.com,2019-10-09T06:27:48Z,fix tests and cleanup doc,R/fit.R;R/model.R;man/CmdStanModel.Rd;man/cmdstan_model.Rd;tests/testthat/test-fit.R;tests/testthat/test-model.R,False,True,True,False,134,85,219,"---FILE: R/fit.R---
@@ -91,6 +91,10 @@ CmdStanMCMC <- R6::R6Class(
       if (is.null(private$sampler_params_)) private$read_csv()
       private$sampler_params_
     },
+    output_files = function() {
+      # get the paths to the temporary output csv files
+      self$runset$output_files()
+    },
     save_output_files = function(dir = ""."", basename = NULL) {
       self$runset$save_output_files(dir, basename)
     },
@@ -115,9 +119,10 @@ CmdStanMCMC <- R6::R6Class(
              call. = FALSE)
       }
       stanfit <- rstan::read_stan_csv(self$runset$output_files())
-      private$posterior_sample_ <- # FIXME get save_warmup from CmdStanArgs
+      private$posterior_sample_ <-
         rstan::extract(stanfit, permuted = FALSE, inc_warmup = FALSE)
-      private$sampler_params_ <- rstan::get_sampler_params(stanfit, inc_warmup = FALSE)
+      private$sampler_params_ <-
+        rstan::get_sampler_params(stanfit, inc_warmup = FALSE)
     }
   )
 )
@@ -165,6 +170,9 @@ CmdStanMLE <- R6::R6Class(
       private$mle_ <- out
       out
     },
+    output_files = function() {
+      self$runset$output_files()
+    },
     save_output_files = function(dir = ""."", basename = NULL) {
       self$runset$save_output_files(dir, basename)
     },
@@ -213,6 +221,7 @@ RunSet <- R6::R6Class(
       invisible(file.create(private$output_files_, private$console_files_))
       invisible(self)
     },
+    args = function() private$args_,
     num_runs = function() private$num_runs_,
     num_chains = function() private$num_runs_,
     run_ids = function() private$args_$run_ids,

---FILE: R/model.R---
@@ -12,24 +12,38 @@
 #'
 #' @examples
 #' \dontrun{
-#' set_cmdstan_path(""/Users/jgabry/Documents/Stan/cmdstan-2.20.0"")
-#' my_stan_program <- file.path(cmdstan_path(), ""examples/bernoulli/bernoulli.stan"")
-#' mod <- cmdstan_model(stan_file = my_stan_program)
+#' # Set path to cmdstan
+#' # Note: if you used install_cmdstan() with default settings then
+#' # the path below should work. Otherwise change it to wherever you have
+#' # a CmdStan installation.
+#'
+#' set_cmdstan_path(file.path(Sys.getenv(""HOME""), "".cmdstanr/cmdstan""))
+#'
+#' # Create a CmdStan model object from a Stan program,
+#' # here using the example model that comes with CmdStan
+#' stan_program <- file.path(cmdstan_path(), ""examples/bernoulli/bernoulli.stan"")
+#' mod <- cmdstan_model(my_stan_program)
 #' mod$print()
+#'
+#' # Compile to create executable
 #' mod$compile()
 #'
-#' # specify data as a named list (like RStan)
+#' # Run MCMC (Stan's dynamic HMC/NUTS),
+#' # specifying data as a named list (like RStan)
 #' standata <- list(N = 10, y =c(0,1,0,0,0,0,0,0,0,1))
 #' fit <- mod$sample(data = standata, seed = 123, num_chains = 2)
 #' fit$summary()
 #'
-#' # specify data as a path to a file (like CmdStan)
+#' # Can also specify data as a path to a file (like CmdStan)
 #' my_data_file <- file.path(cmdstan_path(), ""examples/bernoulli/bernoulli.data.R"")
 #' fit2 <- mod$sample(data = my_data_file, seed = 123)
 #' fit2$summary()
 #'
-#' # can also create a stanfit object using rstan package
-#' # stanfit <- rstan::read_stan_csv(fit$output_files)
+#' # If you like working with RStan's stanfit objects then you can
+#' # also create a stanfit object with rstan::read_stan_csv()
+#' if (require(rstan, quietly = TRUE)) {
+#'   stanfit <- rstan::read_stan_csv(fit$output_files())
+#' }
 #' }
 #'
 cmdstan_model <- function(stan_file) {
@@ -112,7 +126,7 @@ CmdStanModel <- R6::R6Class(
     },
 
     sample = function(data = NULL,
-                      num_chains = NULL, # TODO: should this default to 1 or 4?
+                      num_chains = NULL, # TODO: CmdStan does 1 chain, but should this default to 4?
                       # num_cores = NULL,
                       num_warmup = NULL,
                       num_samples = NULL,

---FILE: man/CmdStanModel.Rd---
@@ -43,24 +43,35 @@ CmdStan. Those csv files are written to the same directory as \code{stan_file}.
 }
 \examples{
 \dontrun{
-set_cmdstan_path(""/Users/jgabry/Documents/Stan/cmdstan-2.20.0"")
-my_stan_program <- file.path(cmdstan_path(), ""examples/bernoulli/bernoulli.stan"")
-mod <- cmdstan_model(stan_file = my_stan_program)
+# Set path to cmdstan
+# Note: if you used install_cmdstan() with default settings then
+# the path below should work. Otherwise change it to wherever you have
+# a CmdStan installation.
+
+set_cmdstan_path(file.path(Sys.getenv(""HOME""), "".cmdstanr/cmdstan""))
+
+# Create a CmdStan model object from a Stan program,
+# here using the example model that comes with CmdStan
+stan_program <- file.path(cmdstan_path(), ""examples/bernoulli/bernoulli.stan"")
+mod <- cmdstan_model(my_stan_program)
 mod$print()
+
+# Compile to create executable
 mod$compile()
 
-# specify data as a named list (like RStan)
+# Run MCMC (Stan's dynamic HMC/NUTS),
+# specifying data as a named list (like RStan)
 standata <- list(N = 10, y =c(0,1,0,0,0,0,0,0,0,1))
 fit <- mod$sample(data = standata, seed = 123, num_chains = 2)
 fit$summary()
 
-# specify data as a path to a file (like CmdStan)
+# Can also specify data as a path to a file (like CmdStan)
 my_data_file <- file.path(cmdstan_path(), ""examples/bernoulli/bernoulli.data.R"")
 fit2 <- mod$sample(data = my_data_file, seed = 123)
 fit2$summary()
 
 # can also create a stanfit object using rstan package
-# stanfit <- rstan::read_stan_csv(fit$output_files)
+# stanfit <- rstan::read_stan_csv(fit$output_files())
 }
 
 }

---FILE: man/cmdstan_model.Rd---
@@ -19,24 +19,35 @@ file containing a Stan program.
 }
 \examples{
 \dontrun{
-set_cmdstan_path(""/Users/jgabry/Documents/Stan/cmdstan-2.20.0"")
-my_stan_program <- file.path(cmdstan_path(), ""examples/bernoulli/bernoulli.stan"")
-mod <- cmdstan_model(stan_file = my_stan_program)
+# Set path to cmdstan
+# Note: if you used install_cmdstan() with default settings then
+# the path below should work. Otherwise change it to wherever you have
+# a CmdStan installation.
+
+set_cmdstan_path(file.path(Sys.getenv(""HOME""), "".cmdstanr/cmdstan""))
+
+# Create a CmdStan model object from a Stan program,
+# here using the example model that comes with CmdStan
+stan_program <- file.path(cmdstan_path(), ""examples/bernoulli/bernoulli.stan"")
+mod <- cmdstan_model(my_stan_program)
 mod$print()
+
+# Compile to create executable
 mod$compile()
 
-# specify data as a named list (like RStan)
+# Run MCMC (Stan's dynamic HMC/NUTS),
+# specifying data as a named list (like RStan)
 standata <- list(N = 10, y =c(0,1,0,0,0,0,0,0,0,1))
 fit <- mod$sample(data = standata, seed = 123, num_chains = 2)
 fit$summary()
 
-# specify data as a path to a file (like CmdStan)
+# Can also specify data as a path to a file (like CmdStan)
 my_data_file <- file.path(cmdstan_path(), ""examples/bernoulli/bernoulli.data.R"")
 fit2 <- mod$sample(data = my_data_file, seed = 123)
 fit2$summary()
 
 # can also create a stanfit object using rstan package
-# stanfit <- rstan::read_stan_csv(fit$output_files)
+# stanfit <- rstan::read_stan_csv(fit$output_files())
 }
 
 }

---FILE: tests/testthat/test-fit.R---
@@ -62,6 +62,7 @@ test_that(""sample() method returns posterior sample (reading csv works)"", {
 context(""CmdStanMLE"")
 
 test_that(""reading in csv optimization output works"", {
+  skip_on_cran()
   expect_named(fit_mle$mle(), ""mle"")
   expect_named(fit_mle$mle()$mle, c(""lp__"", ""theta""))
 })

---FILE: tests/testthat/test-model.R---
@@ -46,48 +46,50 @@ test_that(""code() and print() methods work"", {
 # Sample ------------------------------------------------------------------
 context(""CmdStanModel-sample"")
 
-# these are all valid for sample()
-ok_arg_values <- list(
-  data = data_list,
-  num_chains = 2,
-  num_warmup = 50,
-  num_samples = 100,
-  save_warmup = FALSE,
-  thin = 2,
-  refresh = 5,
-  init = NULL,
-  seed = 12345,
-  max_depth = 6,
-  metric = ""dense_e"",
-  stepsize = 1.1,
-  adapt_engaged = TRUE,
-  adapt_delta = 0.7
-)
-
-# using any one of these should cause sample() to error
-bad_arg_values <- list(
-  data = ""NOT_A_FILE"",
-  num_chains = -1,
-  num_warmup = -1,
-  num_samples = -1,
-  save_warmup = ""NO"",
-  thin = 0,
-  refresh = -10,
-  init = -10,
-  seed = -10,
-  max_depth = 0,
-  metric = ""NOT_A_METRIC"",
-  stepsize = 0,
-  adapt_engaged = ""NO"",
-  adapt_delta = 2
-)
-
-bad_arg_values_2 <- list(
-  init = ""NOT_A_FILE"",
-  seed = 1:10,
-  stepsize = 1:10,
-  metric = c(""AA"", ""BB"", ""CC"")
-)
+if (TRAVIS || NOT_CRAN) {
+  # these are all valid for sample()
+  ok_arg_values <- list(
+    data = data_list,
+    num_chains = 2,
+    num_warmup = 50,
+    num_samples = 100,
+    save_warmup = FALSE,
+    thin = 2,
+    refresh = 5,
+    init = NULL,
+    seed = 12345,
+    max_depth = 6,
+    metric = ""dense_e"",
+    stepsize = 1.1,
+    adapt_engaged = TRUE,
+    adapt_delta = 0.7
+  )
+
+  # using any one of these should cause sample() to error
+  bad_arg_values <- list(
+    data = ""NOT_A_FILE"",
+    num_chains = -1,
+    num_warmup = -1,
+    num_samples = -1,
+    save_warmup = ""NO"",
+    thin = 0,
+    refresh = -10,
+    init = -10,
+    seed = -10,
+    max_depth = 0,
+    metric = ""NOT_A_METRIC"",
+    stepsize = 0,
+    adapt_engaged = ""NO"",
+    adapt_delta = 2
+  )
+
+  bad_arg_values_2 <- list(
+    init = ""NOT_A_FILE"",
+    seed = 1:10,
+    stepsize = 1:10,
+    metric = c(""AA"", ""BB"", ""CC"")
+  )
+}
 
 expect_sample_output <- function(object) {
   testthat::expect_output(
@@ -139,28 +141,29 @@ test_that(""sample() method errors for invalid arguments before calling cmdstan"",
 # Optimize ----------------------------------------------------------------
 context(""CmdStanModel-optimize"")
 
-# these are all valid for optimize()
-ok_arg_values <- list(
-  data = data_list,
-  refresh = 5,
-  init = NULL,
-  seed = 12345,
-  algorithm = ""lbfgs"",
-  iter = 100,
-  init_alpha = 0.002
-)
-
-# using any of these should cause optimize() to error
-bad_arg_values <- list(
-  data = ""NOT_A_FILE"",
-  refresh = -20,
-  init = ""NOT_A_FILE"",
-  seed = ""NOT_A_SEED"",
-  algorithm = ""NOT_AN_ALGORITHM"",
-  iter = -20,
-  init_alpha = -20
-)
+if (TRAVIS || NOT_CRAN) {
+  # these are all valid for optimize()
+  ok_arg_values <- list(
+    data = data_list,
+    refresh = 5,
+    init = NULL,
+    seed = 12345,
+    algorithm = ""lbfgs"",
+    iter = 100,
+    init_alpha = 0.002
+  )
 
+  # using any of these should cause optimize() to error
+  bad_arg_values <- list(
+    data = ""NOT_A_FILE"",
+    refresh = -20,
+    init = ""NOT_A_FILE"",
+    seed = ""NOT_A_SEED"",
+    algorithm = ""NOT_AN_ALGORITHM"",
+    iter = -20,
+    init_alpha = -20
+  )
+}
 
 expect_experimental_warning <- function(object) {
   testthat::expect_warning(",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,240ebe771021d0d20c05b97127e30dba00ba997c,Jonah Gabry,jgabry@gmail.com,2019-10-09T03:26:35Z,GitHub,noreply@github.com,2019-10-09T03:26:35Z,Fix typo in readme,README.md,False,False,False,False,1,1,2,"---FILE: README.md---
@@ -13,7 +13,7 @@ CmdStanR is a lightweight interface to [Stan](https://mc-stan.org) for R users
 CmdStanR is in early stages of development and currently requires RStan to use
 `rstan::stan_rdump()` for writing data files and `rstan::read_stan_csv()` for
 reading CmdStan output into R (RStan is not used to compile anything). This
-dependency on RStan will be eventually be removed.
+dependency on RStan will eventually be removed.
 
 ### Goals
 ",False,False,Documentation / Formatting,7
stan-dev,cmdstanr,c824eda013ee4148eb716db11ab6d3d22328082f,Jonah Gabry,jgabry@gmail.com,2019-10-08T23:43:21Z,GitHub,noreply@github.com,2019-10-08T23:43:21Z,"Fix typos in readme

[ci skip]",README.md,False,False,False,False,1,1,2,"---FILE: README.md---
@@ -11,7 +11,7 @@ CmdStanR is a lightweight interface to [Stan](https://mc-stan.org) for R users
 (see [CmdStanPy](https://github.com/stan-dev/cmdstanpy) for Python).
 
 CmdStanR is in early stages of development and currently requires RStan to use
-`rstan::stan_rdump()` to write data files and `rstan::read_stan_csv()` to
+`rstan::stan_rdump()` for writing data files and `rstan::read_stan_csv()` for
 reading CmdStan output into R (RStan is not used to compile anything). This
 dependency on RStan will be eventually be removed.
 ",False,False,Documentation / Formatting,7
stan-dev,cmdstanr,746ccb653cf8ad3fa088aa3323a4682cf68cf00f,jgabry,jgabry@gmail.com,2019-10-08T00:50:04Z,jgabry,jgabry@gmail.com,2019-10-08T00:50:04Z,Fix link in doc,R/install_cmdstan.R;man/install_cmdstan.Rd,False,True,True,False,8,6,14,"---FILE: R/install_cmdstan.R---
@@ -1,8 +1,9 @@
 #' Install the latest release of CmdStan
 #'
-#' Runs the script `make_cmdstan.sh` ([source code on GitHub]). Currently
-#' assumes that the necessary C++ tool chain is available, but in the future
-#' CmdStanR may help install the requirements.
+#' Runs the script `make_cmdstan.sh` (see `inst/make_cmdstan.sh` on
+#' [GitHub](https://github.com/stan-dev/cmdstanr)). Currently assumes that the
+#' necessary C++ tool chain is available, but in the future CmdStanR may help
+#' install the requirements.
 #'
 #' @export
 #' @param dir Path to the directory in which to install CmdStan. The default is

---FILE: man/install_cmdstan.Rd---
@@ -12,7 +12,8 @@ to install it in a folder \code{.cmdstanr} in the user's home directory
 (\code{Sys.getenv(""HOME"")}).}
 }
 \description{
-Runs the script \code{make_cmdstan.sh} (\link{source code on GitHub}). Currently
-assumes that the necessary C++ tool chain is available, but in the future
-CmdStanR may help install the requirements.
+Runs the script \code{make_cmdstan.sh} (see \code{inst/make_cmdstan.sh} on
+\href{https://github.com/stan-dev/cmdstanr}{GitHub}). Currently assumes that the
+necessary C++ tool chain is available, but in the future CmdStanR may help
+install the requirements.
 }",True,False,Documentation / Formatting,7
stan-dev,cmdstanr,d3e77c7cb2dee4e6ed3e032b2092ba8325ef41ce,jgabry,jgabry@gmail.com,2019-10-07T22:19:15Z,jgabry,jgabry@gmail.com,2019-10-07T22:19:15Z,add informative messages/warnings/errors when setting paths,.Rbuildignore;R/model.R;R/path.R;R/utils.R;R/zzz.R;tests/testthat/test-cmdstan_path.R;tests/testthat/test-model.R,False,True,True,False,92,20,112,"---FILE: .Rbuildignore---
@@ -2,4 +2,3 @@
 ^\.Rproj\.user$
 design-questions
 ^\.travis\.yml$
-^install_cmdstan\.py$

---FILE: R/model.R---
@@ -174,7 +174,11 @@ CmdStanModel <- R6::R6Class(
                         init_alpha = NULL,
                         iter = NULL) {
 
-      # stop(""Optimization not yet enabled."")
+      warning(
+        ""Optimization method is experimental and "",
+        ""the structure of returned object may change."",
+        call. = FALSE
+      )
 
       optimize_args <- OptimizeArgs$new(
         algorithm = algorithm,
@@ -232,9 +236,9 @@ compile_stan_program <- function(stan_file) {
 #' @return Path to data file.
 process_data <- function(data) {
   if (is.null(data)) {
-    path <- """"
+    path <- absolute_path(""."")
   } else if (is.character(data)) {
-    path <- data
+    path <- absolute_path(data)
   } else if (is.list(data) && !is.data.frame(data)) {
     path <- write_rdump(data)
   } else {

---FILE: R/path.R---
@@ -10,35 +10,56 @@
 #' @return The full file path to the CmdStan installation.
 #'
 cmdstan_path <- function() {
-  path <- repair_path(.cmdstanr$PATH)
+  path <- .cmdstanr$PATH
+  if (is.null(path)) {
+    stop(""CmdStan path has not been set yet. See ?set_cmdstan_path."",
+         call. = FALSE)
+  }
   if (substr(path, nchar(path), nchar(path)) == ""/"") {
     # remove training ""/"" (is this necessary?)
     path <- substr(path, 1, nchar(path) - 1)
   }
-  path
+
+  repair_path(path)
 }
 
 #' @rdname cmdstan_path
 #' @export
 #' @param path The full file path to the CmdStan installation as a string.
 set_cmdstan_path <- function(path) {
-  if (!dir.exists(path)) {
-    stop(""Directory does not exist."", call. = FALSE)
+  if (dir.exists(path)) {
+    .cmdstanr$PATH <- absolute_path(path)
+    message(""CmdStan path set to: "", path)
+  } else {
+    warning(""Path not set. Can't find directory: "", path, call. = FALSE)
   }
-  .cmdstanr$PATH <- path
   invisible(path)
 }
 
-# instantiate --------------------------------------------------
-.cmdstanr <- new.env(parent = emptyenv())
 
-# in .onLoad in zzz.R:
-# .cmdstanr$PATH <- Sys.getenv(""CMDSTAN"")
-# .cmdstanr$TEMP_DIR <- tempdir()
+# internal ----------------------------------------------------------------
 
+# initialize env and env vars
+.cmdstanr <- new.env(parent = emptyenv())
+.cmdstanr$PATH <- NULL
+.cmdstanr$TMP_DIR <- NULL
 
-# internal ----------------------------------------------------------------
 cmdstan_tempdir <- function() {
   .cmdstanr$TEMP_DIR
 }
 
+# called in .onLoad() in zzz.R:
+cmdstanr_initialize <- function() {
+  path <- Sys.getenv(""CMDSTAN"")
+  if (isTRUE(nzchar(path))) {
+    if (dir.exists(path)) {
+      .cmdstanr$PATH <- absolute_path(path)
+    } else {
+      warning(""Can't find directory specified by environment variable"",
+              "" 'CMDSTAN'. Path not set."", call. = FALSE)
+      .cmdstanr$PATH <- NULL
+    }
+  }
+
+  .cmdstanr$TEMP_DIR <- tempdir(check = TRUE)
+}

---FILE: R/utils.R---
@@ -18,8 +18,8 @@ os_is_windows <- function() {
 
 # paths and extensions ----------------------------------------------------
 
-# replace '\\' with '/' in a path
-# mostly for windows if CmdStan version is < 2.21
+# Replace `\\` with `/` in a path
+# Needed for windows if CmdStan version is < 2.21:
 # https://github.com/stan-dev/cmdstanr/issues/1#issuecomment-539118598
 repair_path <- function(path) {
   if (!length(path) || !is.character(path)) {
@@ -47,6 +47,15 @@ strip_ext <- function(file) {
   tools::file_path_sans_ext(file)
 }
 
+# If a file/dir exists return its absolute path
+# unlike tools::file_path_as_absolute() it doesn't error if can't be found
+absolute_path <- function(x) {
+  if (!file.exists(x)) {
+    return(x)
+  }
+  tools::file_path_as_absolute(x)
+}
+
 # Change extension from a file path
 change_ext <- function(file, ext) {
   out <- strip_ext(file)

---FILE: R/zzz.R---
@@ -2,9 +2,15 @@
   ver <- utils::packageVersion(""cmdstanr"")
   packageStartupMessage(""This is cmdstanr version "", ver)
   # packageStartupMessage(""- Online documentation and vignettes at mc-stan.org/cmdstanr"")
+  if (is.null(.cmdstanr$PATH)) {
+    packageStartupMessage(""- Use set_cmdstan_path() to set the path to CmdStan."")
+  } else {
+    packageStartupMessage(""- CmdStan path set to "", cmdstan_path(), """")
+  }
 }
 
 .onLoad <- function(...) {
-  .cmdstanr$PATH <- Sys.getenv(""CMDSTAN"")
-  .cmdstanr$TEMP_DIR <- tempdir(check = TRUE)
+  cmdstanr_initialize()
 }
+
+

---FILE: tests/testthat/test-cmdstan_path.R---
@@ -0,0 +1,33 @@
+
+Sys.unsetenv(""CMDSTAN"")
+.cmdstanr$PATH <- NULL
+
+test_that(""Setting path throws correct message"", {
+  expect_message(
+    set_cmdstan_path(testthat::test_path(""answers"")),
+    paste(""CmdStan path set to:"", testthat::test_path(""answers""))
+  )
+})
+
+test_that(""Setting and getting path throws correct warning"", {
+  expect_warning(
+    set_cmdstan_path(""BAD_PATH""),
+    ""Can't find directory""
+  )
+  expect_warning(
+    set_cmdstan_path(""BAD_PATH""),
+    ""Can't find directory""
+  )
+})
+
+test_that(""Setting path from env var throws correct warning"", {
+  Sys.setenv(CMDSTAN = ""BAD_PATH"")
+  expect_warning(
+    cmdstanr_initialize(),
+    ""Can't find directory specified by environment variable""
+  )
+  Sys.unsetenv(""CMDSTAN"")
+})
+
+.cmdstanr$PATH <- NULL
+

---FILE: tests/testthat/test-model.R---
@@ -1,6 +1,6 @@
 context(""CmdStanModel"")
 
-if (!nzchar(cmdstan_path())) {
+if (is.null(.cmdstanr$PATH)) {
   set_cmdstan_path(""/Users/jgabry/Documents/Stan/cmdstan-2.20.0"")
 }
 ",True,False,Environment / Configuration,6
stan-dev,cmdstanr,4610a9e8ee55296e06b809d01c70a3dfaadfda18,jgabry,jgabry@gmail.com,2019-10-07T18:04:40Z,jgabry,jgabry@gmail.com,2019-10-07T18:04:40Z,"currently error if metric is not NULL or one of allowed metrics

Specifying metric files is not yet enabled",R/args.R;tests/testthat/test-model.R,False,True,True,False,84,29,113,"---FILE: R/args.R---
@@ -51,7 +51,7 @@ CmdStanArgs <- R6::R6Class(
 
     validate = function() {
       # TODO: validate that can write to output directory
-      .validate_exe_file(self$exe_file)
+      validate_exe_file(self$exe_file)
 
       # at least 1 run id (chain id)
       checkmate::assert_integerish(self$run_ids,
@@ -64,10 +64,11 @@ CmdStanArgs <- R6::R6Class(
       checkmate::assert_file_exists(self$data_file, access = ""r"")
 
       num_runs <- length(self$run_ids)
-      .validate_init(self$init, num_runs)
-      .validate_seed(self$seed, num_runs)
-      self$init <- .maybe_recycle_init(self$init, num_runs)
-      self$seed <- .maybe_generate_seed(self$seed, num_runs)
+      validate_init(self$init, num_runs)
+      validate_seed(self$seed, num_runs)
+      self$init <- maybe_recycle_init(self$init, num_runs)
+      self$seed <- maybe_generate_seed(self$seed, num_runs)
+      invisible(self)
     },
 
     # create default basename for csv output file from model name and method
@@ -222,14 +223,8 @@ SampleArgs <- R6::R6Class(
 
       # TODO: implement other checks for metric from cmdstanpy:
       # https://github.com/stan-dev/cmdstanpy/blob/master/cmdstanpy/cmdstan_args.py#L130
-      if (length(self$metric) == 1) {
-        checkmate::assert_string(self$metric)
-        checkmate::assert_subset(self$metric,
-                                 empty.ok = FALSE,
-                                 choices = c(""unit_e"", ""diag_e"", ""dense_e""))
-      } else {
-        checkmate::assert_character(self$metric, len = num_runs, null.ok = TRUE)
-      }
+      validate_metric(self$metric, num_runs)
+      self$metric <- maybe_recycle_metric(self$metric, num_runs)
 
       invisible(self)
     },
@@ -351,7 +346,7 @@ FixedParamArgs <- R6::R6Class(
 #' @noRd
 #' @param exe_file Path to executable.
 #' @return Either throws an error or returns `invisible(TRUE)`
-.validate_exe_file <- function(exe_file) {
+validate_exe_file <- function(exe_file) {
   if (!length(exe_file) ||
       !nzchar(exe_file) ||
       !file.exists(exe_file)) {
@@ -370,7 +365,7 @@ FixedParamArgs <- R6::R6Class(
 #' @param init User's `init` argument.
 #' @param num_runs Number of CmdStan runs (number of chains if MCMC)
 #' @return Either throws an error or returns `invisible(TRUE)`.
-.validate_init <- function(init, num_runs) {
+validate_init <- function(init, num_runs) {
   if (is.null(init)) {
     return(invisible(TRUE))
   }
@@ -384,15 +379,30 @@ FixedParamArgs <- R6::R6Class(
   } else if (is.character(init)) {
     checkmate::assert_file_exists(init, access = ""r"")
     if (length(init) != num_runs) {
-      stop(""If 'init' is specified as a character vector "",
-           ""it one element per chain."",
+      stop(""If 'init' is specified as a character vector it must have"",
+           ""one element per chain."",
            call. = FALSE)
     }
   }
 
   invisible(TRUE)
 }
 
+#' Recycle init if numeric and length 1
+#' @noRd
+#' @param init Already validated `init` argument.
+#' @param num_runs Number of CmdStan runs.
+#' @return `init`, unless numeric and length 1, in which case `rep(init, num_runs)`.
+maybe_recycle_init <- function(init, num_runs) {
+  if (is.null(init) ||
+      is.character(init) ||
+      length(init) == num_runs) {
+    return(init)
+  }
+  rep(init, num_runs)
+}
+
+
 #' Validate seed
 #'
 #' `seed` must be `NULL`, a single positive integer, or one positive integer per
@@ -402,7 +412,7 @@ FixedParamArgs <- R6::R6Class(
 #' @param seed User's `seed` argument.
 #' @param num_runs Number of CmdStan runs (number of chains if MCMC)
 #' @return Either throws an error or returns `invisible(TRUE)`.
-.validate_seed <- function(seed, num_runs) {
+validate_seed <- function(seed, num_runs) {
   if (is.null(seed)) {
     return(invisible(TRUE))
   }
@@ -419,7 +429,7 @@ FixedParamArgs <- R6::R6Class(
 #' @param seed Already validated `seed` argument.
 #' @param num_runs Number of CmdStan runs.
 #' @return An integer vector of length `num_runs`.
-.maybe_generate_seed <- function(seed, num_runs) {
+maybe_generate_seed <- function(seed, num_runs) {
   if (is.null(seed)) {
     seed <- sample(.Machine$integer.max, num_runs)
   } else if (length(seed) == 1 && num_runs > 1) {
@@ -429,16 +439,60 @@ FixedParamArgs <- R6::R6Class(
   seed
 }
 
-#' Recycle init if numeric and length 1
+#' Validate metric
 #' @noRd
-#' @param init Already validated `init` argument.
+#' @param metric User's `metric` argument.
+#' @param num_runs Number of CmdStan runs (number of MCMC chains).
+#' @return Either throws an error or returns `invisible(TRUE)`.
+#'
+validate_metric <- function(metric, num_runs) {
+  if (is.null(metric)) {
+    return(invisible(TRUE))
+  }
+
+  checkmate::assert_character(metric, any.missing = FALSE, min.len = 1)
+  if (length(metric) > 1 ||
+      !metric %in% available_metrics()) {
+    stop(""'metric' must be one of {'diag_e', 'dense_e', 'unit_e'}."",
+         call. = FALSE)
+  }
+
+  # TODO: allow specifying metric files
+  # need to check if in the right format (see CmdStanPy implementation)
+  # if (length(metric) == 1) {
+  #   must_have_file <- !metric %in% available_metrics()
+  #   if (must_have_file) {
+  #     if (!checkmate::test_file_exists(metric, access = ""r"")) {
+  #       stop(""'metric' is not one of {'diag_e', 'dense_e', 'unit_e'} but "",
+  #            ""is also not a path to a readable file."", call. = FALSE)
+  #     }
+  #   }
+  # } else if (length(metric) != num_runs) {
+  #   stop(""'metric' must have length equal to one or the number of chains."",
+  #        call. = FALSE)
+  # } else {
+  #   checkmate::assert_file_exists(metric, access = ""r"")
+  # }
+
+  invisible(TRUE)
+}
+
+#' Recycle metric if not a file (i.e. is one of 'diag_e', 'dense_e', 'unit_e')
+#' @noRd
+#' @param metric Already validated `metric` argument.
 #' @param num_runs Number of CmdStan runs.
-#' @return `init`, unless numeric and length 1, in which case `rep(init, num_runs)`.
-.maybe_recycle_init <- function(init, num_runs) {
-  if (is.null(init) ||
-      is.character(init) ||
-      length(init) == num_runs) {
-    return(init)
+#' @return `metric`, unless a string of length 1 (and not a file path), in which
+#'   case `rep(metric, num_runs)`.
+maybe_recycle_metric <- function(metric, num_runs) {
+  if (is.null(metric) ||
+      length(metric) == num_runs ||
+      !metric %in% available_metrics()) {
+    return(metric)
   }
-  rep(init, num_runs)
+  rep(metric, num_runs)
 }
+
+available_metrics <- function() {
+  c(""unit_e"", ""diag_e"", ""dense_e"")
+}
+

---FILE: tests/testthat/test-model.R---
@@ -48,7 +48,8 @@ bad_arg_values <- list(
 bad_arg_values_2 <- list(
   init = ""NOT_A_FILE"",
   seed = 1:10,
-  stepsize = 1:10
+  stepsize = 1:10,
+  metric = c(""AA"", ""BB"", ""CC"")
 )
 
 # mod$compile()",True,False,Implementation / Logic,6
stan-dev,cmdstanr,a2aaa42c83bf94b95f41334373f462dc15c45f0c,jgabry,jgabry@gmail.com,2019-10-06T02:16:48Z,jgabry,jgabry@gmail.com,2019-10-06T02:16:48Z,fix r cmd check warnings,R/path.R;R/utils.R;man/cmdstan_path.Rd,False,True,True,False,3,3,6,"---FILE: R/path.R---
@@ -20,7 +20,7 @@ cmdstan_path <- function() {
 
 #' @rdname cmdstan_path
 #' @export
-#' @param full_path The full file path to the CmdStan installation as a string.
+#' @param path The full file path to the CmdStan installation as a string.
 set_cmdstan_path <- function(path) {
   if (!dir.exists(path)) {
     stop(""Directory does not exist."", call. = FALSE)

---FILE: R/utils.R---
@@ -121,7 +121,7 @@ read_optim_csv <- function(csv_file) {
 
   header <- full_csv[1:mark]
   x <- scan(csv_file, skip = mark + 1, sep = "","")
-  list(mle = setNames(x, col_names))
+  list(mle = stats::setNames(x, col_names))
 }
 
 

---FILE: man/cmdstan_path.Rd---
@@ -10,7 +10,7 @@ cmdstan_path()
 set_cmdstan_path(path)
 }
 \arguments{
-\item{full_path}{The full file path to the CmdStan installation as a string.}
+\item{path}{The full file path to the CmdStan installation as a string.}
 }
 \value{
 The full file path to the CmdStan installation.",True,False,Documentation / Formatting,6
stan-dev,cmdstanr,92a63350f6759229b33c68489d76f74f046b30d4,jgabry,jgabry@gmail.com,2019-10-06T02:03:01Z,jgabry,jgabry@gmail.com,2019-10-06T02:03:01Z,test for error messages from bad arguments,R/args.R;R/model.R;tests/testthat/test-model.R,False,True,True,False,103,58,161,"---FILE: R/args.R---
@@ -32,15 +32,15 @@ CmdStanArgs <- R6::R6Class(
                           method_args,
                           data_file = NULL,
                           seed = NULL,
-                          inits = NULL, # TODO: CmdStan uses init but CmdStanPy inits
+                          init = NULL,
                           refresh = NULL) {
 
       self$model_name <- model_name
       self$exe_file <- exe_file
       self$run_ids <- run_ids
       self$data_file <- data_file
       self$seed <- seed
-      self$inits <- inits
+      self$init <- init
       self$refresh <- refresh
       self$method_args <- method_args
 
@@ -50,7 +50,7 @@ CmdStanArgs <- R6::R6Class(
     },
 
     validate = function() {
-      # TODO: validate inits (see python implementation)
+      # TODO: validate init (see python implementation)
       # TODO: validate that can write to output directory
 
       if (!length(self$exe_file) || !nzchar(self$exe_file)) {
@@ -65,6 +65,9 @@ CmdStanArgs <- R6::R6Class(
                                    any.missing = FALSE,
                                    null.ok = FALSE)
 
+      checkmate::assert_integerish(self$refresh, lower = 0, null.ok = TRUE)
+      checkmate::assert_file_exists(self$data_file)
+
       # either no seed, 1 seed, or num_runs seeds (number of chains)
       checkmate::assert(
         combine = ""or"",
@@ -77,6 +80,7 @@ CmdStanArgs <- R6::R6Class(
                                     len = length(self$run_ids),
                                     null.ok = TRUE)
       )
+
       if (is.null(self$seed)) {
         self$seed <- sample(.Machine$integer.max, length(self$run_ids))
       } else if (length(self$seed) == 1 && length(self$run_ids) > 1) {
@@ -100,7 +104,7 @@ CmdStanArgs <- R6::R6Class(
         list(
           id = NULL,
           seed = NULL,
-          inits = NULL,
+          init = NULL,
           data = NULL,
           output = NULL
         )
@@ -119,8 +123,8 @@ CmdStanArgs <- R6::R6Class(
         args$seed <- c(""random"", paste0(""seed="", self$seed[idx]))
       }
 
-      if (!is.null(self$inits)) {
-        args$inits <- paste0(""init="", self$inits[idx])
+      if (!is.null(self$init)) {
+        args$init <- paste0(""init="", self$init[idx])
       }
 
       if (!is.null(self$data_file)) {
@@ -177,13 +181,12 @@ SampleArgs <- R6::R6Class(
       self$adapt_engaged <- adapt_engaged
       self$adapt_delta <- adapt_delta
 
-      if (!is.null(self$save_warmup)) {
-        self$save_warmup <- as.integer(self$save_warmup)
+      if (is.logical(self$adapt_engaged)) {
+        self$adapt_engaged <- as.integer(self$adapt_engaged)
       }
-      if (!is.null(self$adapt_engaged)) {
-        self$save_warmup <- as.integer(self$adapt_engaged)
+      if (is.logical(self$save_warmup)) {
+        self$save_warmup <- as.integer(self$save_warmup)
       }
-
       invisible(self)
     },
 
@@ -210,15 +213,15 @@ SampleArgs <- R6::R6Class(
                                    lower = 0,
                                    len = 1,
                                    null.ok = TRUE)
-      checkmate::assert_integer(self$save_warmup,
-                                lower = 0, upper = 1,
-                                len = 1,
-                                null.ok = TRUE)
+      checkmate::assert_integerish(self$save_warmup,
+                                   lower = 0, upper = 1,
+                                   len = 1,
+                                   null.ok = TRUE)
 
-      checkmate::assert_integer(self$adapt_engaged,
-                                lower = 0, upper = 1,
-                                len = 1,
-                                null.ok = TRUE)
+      checkmate::assert_integerish(self$adapt_engaged,
+                                   lower = 0, upper = 1,
+                                   len = 1,
+                                   null.ok = TRUE)
       checkmate::assert_numeric(self$adapt_delta,
                                 lower = 0, upper = 1,
                                 len = 1,
@@ -228,25 +231,25 @@ SampleArgs <- R6::R6Class(
                                    len = 1,
                                    null.ok = TRUE)
 
-      checkmate::assert(
-        combine = ""or"",
-        checkmate::check_numeric(self$stepsize,
-                                 lower = 0,
-                                 len = 1,
-                                 null.ok = TRUE),
-        checkmate::check_numeric(self$stepsize,
-                                 lower = 0,
+      if (length(self$stepsize) == 1) {
+        checkmate::assert_number(self$stepsize, lower = .Machine$double.eps)
+      } else {
+        checkmate::assert_numeric(self$stepsize,
+                                 lower = .Machine$double.eps,
                                  len = num_runs,
                                  null.ok = TRUE)
-      )
-      checkmate::assert(
-        combine = ""or"",
-        checkmate::check_string(self$metric, null.ok = TRUE),
-        checkmate::check_character(self$metric, len = num_runs,
-                                   null.ok = TRUE)
-      )
+      }
+
       # TODO: implement other checks for metric from cmdstanpy:
       # https://github.com/stan-dev/cmdstanpy/blob/master/cmdstanpy/cmdstan_args.py#L130
+      if (length(self$metric) == 1) {
+        checkmate::assert_string(self$metric)
+        checkmate::assert_subset(self$metric,
+                                 empty.ok = FALSE,
+                                 choices = c(""unit_e"", ""diag_e"", ""dense_e""))
+      } else {
+        checkmate::assert_character(self$metric, len = num_runs, null.ok = TRUE)
+      }
 
       invisible(self)
     },

---FILE: R/model.R---
@@ -118,16 +118,22 @@ CmdStanModel <- R6::R6Class(
                       save_warmup = FALSE, # TODO: document this
                       thin = NULL,
                       refresh = NULL,
-                      inits = NULL,
+                      init = NULL,
                       seed = NULL,
                       max_depth = NULL,
                       metric = NULL,
                       stepsize = NULL,
                       adapt_engaged = NULL,
                       adapt_delta = NULL) {
 
+      if (!is.null(init)) {
+        stop(""Initial values are not yet supported."", call. = FALSE)
+      }
+
       num_chains <- num_chains %||% 1
+      checkmate::assert_integerish(num_chains, lower = 1)
       chain_ids <- seq_len(num_chains)
+
       sample_args <- SampleArgs$new(
         num_warmup = num_warmup,
         num_samples = num_samples,
@@ -146,7 +152,7 @@ CmdStanModel <- R6::R6Class(
         run_ids = chain_ids,
         data_file = process_data(data),
         seed = seed,
-        inits = inits,
+        init = init,
         refresh = refresh
       )
 
@@ -167,7 +173,7 @@ CmdStanModel <- R6::R6Class(
     optimize = function(data = NULL,
                         seed = NULL,
                         refresh = NULL,
-                        inits = NULL,
+                        init = NULL,
                         algorithm = NULL,
                         init_alpha = NULL,
                         iter = NULL) {
@@ -186,7 +192,7 @@ CmdStanModel <- R6::R6Class(
         run_ids = 1,
         data_file = process_data(data),
         seed = seed,
-        inits = inits,
+        init = init,
         refresh = refresh
       )
 

---FILE: tests/testthat/test-model.R---
@@ -4,16 +4,51 @@ set_cmdstan_path(""/Users/jgabry/Documents/Stan/cmdstan-2.20.0"")
 my_stan_program <- file.path(cmdstan_path(), ""examples/bernoulli/bernoulli.stan"")
 my_data_file <- file.path(cmdstan_path(), ""examples/bernoulli/bernoulli.data.R"")
 my_data_list <- list(N = 10, y =c(0,1,0,0,0,0,0,0,0,1))
+mod <- cmdstan_model(stan_file = my_stan_program)
 
+# these are all valid
+ok_arg_values <- list(
+  data = my_data_list,
+  num_chains = 2,
+  num_warmup = 50,
+  num_samples = 100,
+  save_warmup = FALSE,
+  thin = 2,
+  refresh = 5,
+  init = NULL,
+  seed = 12345,
+  max_depth = 6,
+  metric = ""dense_e"",
+  stepsize = 1.1,
+  adapt_engaged = TRUE,
+  adapt_delta = 0.7
+)
 
-mod <- cmdstan_model(stan_file = my_stan_program)
+# using any one of these should cause an error
+bad_arg_values <- list(
+  data = ""NOT_A_FILE"",
+  num_chains = -1,
+  num_warmup = -1,
+  num_samples = -1,
+  save_warmup = ""NO"",
+  thin = 0,
+  refresh = -10,
+  # init = 17,
+  seed = -10,
+  max_depth = 0,
+  metric = ""NOT_A_METRIC"",
+  stepsize = 0,
+  adapt_engaged = ""NO"",
+  adapt_delta = 2
+)
 
 # mod$compile()
 
 test_that(""compile() method works"", {
   skip_on_cran()
   skip_on_travis()
-  expect_output(mod$compile(), ""Running make"")
+  out <- capture.output(mod$compile())
+  expect_output(print(out), ""Running make"")
 })
 
 test_that(""object initializes correctly"", {
@@ -44,21 +79,22 @@ test_that(""sample() method doesn't error with data file"", {
   expect_is(fit, ""CmdStanMCMC"")
 })
 
-# test_that(""sample() method handles arguments correctly"", {
-#   arg_values <- list(
-#     data = NULL,
-#     num_chains = NULL,
-#     num_warmup = NULL,
-#     num_samples = NULL,
-#     save_warmup = FALSE,
-#     thin = NULL,
-#     refresh = NULL,
-#     inits = NULL,
-#     seed = NULL,
-#     max_depth = NULL,
-#     metric = NULL,
-#     stepsize = NULL,
-#     adapt_engaged = NULL,
-#     adapt_delta = NULL
-#   )
-# })
+test_that(""sample() method runs when all arguments specified validly"", {
+  skip_on_cran()
+  skip_on_travis()
+  capture.output(fit <- do.call(mod$sample, ok_arg_values))
+  expect_is(fit, ""CmdStanMCMC"")
+})
+
+test_that(""sample() method throws errors for invalid arguments"", {
+  skip_on_cran()
+  skip_on_travis()
+
+  capture.output(mod$compile())
+  for (nm in names(bad_arg_values)) {
+    args <- ok_arg_values
+    args[[nm]] <- bad_arg_values[[nm]]
+    expect_error(do.call(mod$sample, args), regexp = nm)
+  }
+})
+",True,False,Implementation / Logic,6
stan-dev,cmdstanr,b55ebc0dd7537f45bff0304f7d89eaf730d9f8b6,jgabry,jgabry@gmail.com,2019-10-05T22:54:15Z,jgabry,jgabry@gmail.com,2019-10-05T22:54:15Z,fix tests,tests/testthat/test-model.R,False,True,True,False,4,4,8,"---FILE: tests/testthat/test-model.R---
@@ -19,8 +19,8 @@ test_that(""compile() method works"", {
 test_that(""object initializes correctly"", {
   skip_on_cran()
   skip_on_travis()
-  expect_equal(mod$exe_file, strip_ext(my_stan_program))
-  expect_equal(mod$stan_file, my_stan_program)
+  expect_equal(mod$exe_file(), strip_ext(my_stan_program))
+  expect_equal(mod$stan_file(), my_stan_program)
 })
 
 test_that(""code() and print() methods work"", {
@@ -34,14 +34,14 @@ test_that(""sample() method doesn't error with data list"", {
   skip_on_cran()
   skip_on_travis()
   capture.output(fit <- mod$sample(data = my_data_list, num_chains = 1))
-  expect_is(fit, ""CmdStanFit"")
+  expect_is(fit, ""CmdStanMCMC"")
 })
 
 test_that(""sample() method doesn't error with data file"", {
   skip_on_cran()
   skip_on_travis()
   capture.output(fit <- mod$sample(data = my_data_file, num_chains = 1))
-  expect_is(fit, ""CmdStanFit"")
+  expect_is(fit, ""CmdStanMCMC"")
 })
 
 # test_that(""sample() method handles arguments correctly"", {",True,False,Rendering / Conversion,3
stan-dev,cmdstanr,fc170ab8f8ef0dc68be15c664c315a42283a4cfd,Jonah Gabry,jgabry@gmail.com,2019-10-03T05:00:37Z,GitHub,noreply@github.com,2019-10-03T05:00:37Z,Fix typo in doc,R/model.R,False,True,True,False,1,1,2,"---FILE: R/model.R---
@@ -142,7 +142,7 @@ compile_stan_program <- function(stan_file) {
   cmdstan_ext(exe_file)
 }
 
-#' Either return Write data to a temporary `.data.R` file
+#' Write data to a temporary `.data.R` file if necessary
 #' @noRd
 #' @param data If not `NULL`, then either a path to a data file compatible with
 #'   CmdStan, or a named list of \R objects in the style that RStan uses.",True,False,Implementation / Logic,6
stan-dev,cmdstanr,143efad14798d163b445b12f0f69f2d8ce73fa7f,Jonah Gabry,jgabry@gmail.com,2019-10-03T04:59:18Z,GitHub,noreply@github.com,2019-10-03T04:59:18Z,Fix typo in comment,R/model.R,False,True,True,False,1,1,2,"---FILE: R/model.R---
@@ -91,7 +91,7 @@ CmdStanModel <- R6::R6Class(
       }
       data_file <- write_data(data)
       output_files <- sample_hmc_nuts(self$exe_file, data_file = data_file, ...)
-      CmdStanFit$new(output_files) # see stanfit.R
+      CmdStanFit$new(output_files) # see fit.R
     }
   )
 )",True,False,Implementation / Logic,3
