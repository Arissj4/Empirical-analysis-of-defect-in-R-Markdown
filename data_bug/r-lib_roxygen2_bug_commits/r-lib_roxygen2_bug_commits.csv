repo_owner,repo_name,commit_hash,author_name,author_email,author_date,committer_name,committer_email,committer_date,message,filenames,touches_rmd,touches_r,touches_r_or_rmd,is_merge,added,deleted,changed,diff
r-lib,roxygen2,864ed25502c11e5e7ee88dc96efc58b5a4466df8,Hadley Wickham,h.wickham@gmail.com,2025-09-03T19:12:55Z,GitHub,noreply@github.com,2025-09-03T19:12:55Z,"Update snapshots (#1722)

* Update snapshots

Since knitr now generates srcref locations in a different format

* Fix snapshots for markdown errors

Drop the traceback from knitr, because it is only
there in `R CMD check`, but not in `test()` and it
also seems quite fragile.

---------

Co-authored-by: G치bor Cs치rdi <csardi.gabor@gmail.com>",tests/testthat/_snaps/markdown-code.md;tests/testthat/_snaps/rd-include-rmd.md;tests/testthat/test-markdown-code.R;tests/testthat/test-rd-include-rmd.R,False,True,True,False,15,4,19,"---FILE: tests/testthat/_snaps/markdown-code.md---
@@ -15,7 +15,7 @@
       
     Message
       
-      Quitting from lines 1-1
+      Quitting from :1-1
       x <text>:4: @description failed to evaluate inline markdown code.
       Caused by error in `map_chr()`:
       i In index: 1.

---FILE: tests/testthat/_snaps/rd-include-rmd.md---
@@ -20,9 +20,9 @@
       
     Message
       
-      Quitting from lines 2-3 [unnamed-chunk-2] (<temp-path.Rmd>)
+      Quitting from <temp-path.Rmd>:1-3 [unnamed-chunk-2]
       
-      Quitting from lines 2-2 [unnamed-chunk-1] (<another-temp-path.Rmd>)
+      Quitting from <another-temp-path.Rmd>:1-2 [unnamed-chunk-1]
       x <text>:3: @includeRmd failed to evaluate '<temp-path.Rmd>'.
       Caused by error:
       ! Error

---FILE: tests/testthat/test-markdown-code.R---
@@ -133,7 +133,14 @@ test_that(""inline code gives useful warning"", {
   ""
 
   expect_snapshot(
-    out <- roc_proc_text(rd_roclet(), block)[[1]]
+    out <- roc_proc_text(rd_roclet(), block)[[1]],
+    transform = function(x) {
+      line <- grep(""~~~"", x)[1]
+      if (!is.na(line)) {
+        x <- x[1:(line-1)]
+      }
+      x
+    }
   )
   expect_equal(out$get_value(""description""), ""\\verb{r 1 + }"")
 })

---FILE: tests/testthat/test-rd-include-rmd.R---
@@ -297,6 +297,10 @@ test_that(""useful warnings"", {
     transform = function(x) {
       x <- gsub(path, ""<temp-path.Rmd>"", x, fixed = TRUE)
       x <- gsub(""file.*\\.Rmd"", ""<another-temp-path.Rmd>"", x)
+      line <- grep(""~~~"", x)[1]
+      if (!is.na(line)) {
+        x <- x[1:(line-1)]
+      }
       x
     }
   )"
r-lib,roxygen2,ace81d34c5c50101bc221c3465328d840d0fb7cc,Ma칢lle Salmon,maelle.salmon@yahoo.se,2025-04-22T17:09:54Z,GitHub,noreply@github.com,2025-04-22T17:09:54Z,"feat: add support for ROR in package documentation (#1699)

* feat: add support for ROR in package documentation

* fix: adapt the code to ORCID ID checking in R devel",DESCRIPTION;NEWS.md;R/object-package.R;man/roxygen2-package.Rd;tests/testthat/_snaps/object-package.md;tests/testthat/test-object-package.R,False,True,True,False,42,11,53,"---FILE: DESCRIPTION---
@@ -7,7 +7,8 @@ Authors@R: c(
     person(""Peter"", ""Danenberg"", , ""pcd@roxygen.org"", role = c(""aut"", ""cph"")),
     person(""G치bor"", ""Cs치rdi"", , ""csardi.gabor@gmail.com"", role = ""aut""),
     person(""Manuel"", ""Eugster"", role = c(""aut"", ""cph"")),
-    person(""Posit Software, PBC"", role = c(""cph"", ""fnd""))
+    person(""Posit Software, PBC"", role = c(""cph"", ""fnd""),
+           comment = c(ROR = ""03wc8by49""))
   )
 Description: Generate your Rd documentation, 'NAMESPACE' file, and
     collation field using specially formatted comments. Writing

---FILE: NEWS.md---
@@ -1,5 +1,7 @@
 # roxygen2 (development version)
 
+* Package documentation now converts ROR IDs into a useful link (#1698, @maelle).
+
 * The check for unexported S3 methods was improved, so it does not hang any more
   if a largish data object is in the package (#1593, @jranke).
 

---FILE: R/object-package.R---
@@ -66,6 +66,16 @@ author_desc <- function(x) {
       }
       x$comment <- x$comment[!names(x$comment) %in% ""ORCID""]
     }
+    if (has_name(x$comment, ""ROR"")) {
+      ror <- x$comment[[""ROR""]]
+
+      if (grepl(""https?://"", ror)) {
+        desc <- paste0(desc, "" (\\href{"", ror, ""}{ROR})"")
+      } else {
+        desc <- paste0(desc, "" (\\href{https://ror.org/"", ror, ""}{ROR})"")
+      }
+      x$comment <- x$comment[!names(x$comment) %in% ""ROR""]
+    }
 
     if (length(x$comment) > 0) {
       desc <- paste0(desc, "" ("", x$comment, "")"")

---FILE: man/roxygen2-package.Rd---
@@ -31,7 +31,7 @@ Authors:
 
 Other contributors:
 \itemize{
-  \item Posit Software, PBC [copyright holder, funder]
+  \item Posit Software, PBC (\href{https://ror.org/03wc8by49}{ROR}) [copyright holder, funder]
 }
 
 }

---FILE: tests/testthat/_snaps/object-package.md---
@@ -12,17 +12,30 @@
       [1] ""H W \\email{h@w.com} [contributor]""
     Code
       # ORCID comments
-      person_desc(comment = c(ORCID = ""1234""))
+      person_desc(comment = c(ORCID = ""0000-0003-4757-117X""))
     Output
-      [1] ""H W \\email{h@w.com} (\\href{https://orcid.org/1234}{ORCID})""
+      [1] ""H W \\email{h@w.com} (\\href{https://orcid.org/0000-0003-4757-117X}{ORCID})""
     Code
-      person_desc(comment = c(ORCID = ""https://orcid.org/1234""))
+      person_desc(comment = c(ORCID = ""https://orcid.org/0000-0003-4757-117X""))
     Output
-      [1] ""H W \\email{h@w.com} (\\href{https://orcid.org/1234}{ORCID})""
+      [1] ""H W \\email{h@w.com} (\\href{https://orcid.org/0000-0003-4757-117X}{ORCID})""
     Code
-      person_desc(comment = c(ORCID = ""1234"", ""extra""))
+      person_desc(comment = c(ORCID = ""0000-0003-4757-117X"", ""extra""))
     Output
-      [1] ""H W \\email{h@w.com} (\\href{https://orcid.org/1234}{ORCID}) (extra)""
+      [1] ""H W \\email{h@w.com} (\\href{https://orcid.org/0000-0003-4757-117X}{ORCID}) (extra)""
+    Code
+      # ROR comments
+      person_desc(comment = c(ROR = ""03wc8by49""))
+    Output
+      [1] ""H W \\email{h@w.com} (\\href{https://ror.org/03wc8by49}{ROR})""
+    Code
+      person_desc(comment = c(ROR = ""https://ror.org/03wc8by49""))
+    Output
+      [1] ""H W \\email{h@w.com} (\\href{https://ror.org/03wc8by49}{ROR})""
+    Code
+      person_desc(comment = c(ROR = ""03wc8by49"", ""extra""))
+    Output
+      [1] ""H W \\email{h@w.com} (\\href{https://ror.org/03wc8by49}{ROR}) (extra)""
 
 # useful message if Authors@R is corrupted
 

---FILE: tests/testthat/test-object-package.R---
@@ -12,9 +12,14 @@ test_that(""person turned into meaningful text"", {
     person_desc(role = ""ctb"")
 
     ""ORCID comments""
-    person_desc(comment = c(""ORCID"" = ""1234""))
-    person_desc(comment = c(""ORCID"" = ""https://orcid.org/1234""))
-    person_desc(comment = c(""ORCID"" = ""1234"", ""extra""))
+    person_desc(comment = c(""ORCID"" = ""0000-0003-4757-117X""))
+    person_desc(comment = c(""ORCID"" = ""https://orcid.org/0000-0003-4757-117X""))
+    person_desc(comment = c(""ORCID"" = ""0000-0003-4757-117X"", ""extra""))
+
+    ""ROR comments""
+    person_desc(comment = c(""ROR"" = ""03wc8by49""))
+    person_desc(comment = c(""ROR"" = ""https://ror.org/03wc8by49""))
+    person_desc(comment = c(""ROR"" = ""03wc8by49"", ""extra""))
   })
 })
 "
r-lib,roxygen2,9652d15221109917d46768e836eaf55e33c21633,Kirill M칲ller,krlmlr@users.noreply.github.com,2024-08-02T12:20:57Z,GitHub,noreply@github.com,2024-08-02T12:20:57Z,fix: Support multiline `@examplesIf` again (#1641),R/rd-examples.R;tests/testthat/_snaps/rd-examples.md;tests/testthat/test-rd-examples.R,False,True,True,False,8,4,12,"---FILE: R/rd-examples.R---
@@ -15,10 +15,12 @@ roxy_tag_parse.roxy_tag_examplesIf <- function(x) {
   )
 
   x$raw <- paste(
-    paste0(""\\dontshow{if ("", condition, "") withAutoprint(\\{ # examplesIf}""),
-    lines[-1],
-    ""\\dontshow{\\}) # examplesIf}"",
-    sep = ""\n""
+    c(
+      paste0(""\\dontshow{if ("", condition, "") withAutoprint(\\{ # examplesIf}""),
+      lines[-1],
+      ""\\dontshow{\\}) # examplesIf}""
+    ),
+    collapse = ""\n""
   )
 
   tag_examples(x)

---FILE: tests/testthat/_snaps/rd-examples.md---
@@ -29,6 +29,7 @@
     \dontshow{\}) # examplesIf}
     \dontshow{if (foobar()) withAutoprint(\{ # examplesIf}
     and-this
+    and-that
     \dontshow{\}) # examplesIf}
     } 
 

---FILE: tests/testthat/test-rd-examples.R---
@@ -79,6 +79,7 @@ test_that(""@examplesIf"", {
     #' maybe-run-this-code
     #' @examplesIf foobar()
     #' and-this
+    #' and-that
     NULL"")[[1]]
 
   expect_snapshot_output(out$get_section(""examples""))"
r-lib,roxygen2,7c12664dbbaddde1a06fb11ad883ccd3e63172ad,Johannes Ranke,jranke@uni-bremen.de,2024-07-10T04:45:15Z,GitHub,noreply@github.com,2024-07-10T04:45:15Z,"Improve check for unexported S3 methods (#1594)

Fixes #1593",NEWS.md;R/namespace.R,False,True,True,False,6,1,7,"---FILE: NEWS.md---
@@ -1,8 +1,12 @@
 # roxygen2 (development version)
 
+* The check for unexported S3 methods was improved, so it does not hang any more
+  if a largish data object is in the package (#1593, @jranke).
+
 * Custom [`@family`
   titles](https://roxygen2.r-lib.org/articles/index-crossref.html) now support
   Markdown syntax (#1608, @salim-b).
+
 # roxygen2 7.3.2
 
 * `@includeRmd` now additionally sets `options(cli.hyperlink = FALSE)` to make

---FILE: R/namespace.R---
@@ -398,8 +398,9 @@ warn_missing_s3_exports <- function(blocks, env) {
 
   s3blocks <- blocks[map_lgl(blocks, block_has_tags, c(""export"", ""exportS3Method""))]
   s3objects <- map(blocks, function(block) block$object$value)
+  s3functions <- Filter(is.function, s3objects)
 
-  undocumented <- methods[!methods %in% s3objects]
+  undocumented <- methods[!methods %in% s3functions]
   srcrefs <- map(undocumented, attr, ""srcref"")
 
   map2(undocumented, names(undocumented), function(fun, name) {"
r-lib,roxygen2,f5374ac73017862d4828bdcf4b6f1172e9e1ccdf,Henrik Bengtsson,henrik.bengtsson@gmail.com,2024-07-09T15:09:49Z,GitHub,noreply@github.com,2024-07-09T15:09:49Z,"FIX @exportS3method -> @exportS3Method (#1590)

Fixes #1585. Fixes #1591.",NEWS.md;R/namespace.R;tests/testthat/_snaps/namespace.md;tests/testthat/test-namespace.R;vignettes/namespace.Rmd,True,True,True,False,12,12,24,"---FILE: NEWS.md---
@@ -190,7 +190,7 @@
 
 * `@author`s are de-duplicated in merged documentation (@DanChaltiel, #1333).
 
-* `@exportS3method pkg::generic` now works when `pkg::generic` isn't 
+* `@exportS3Method pkg::generic` now works when `pkg::generic` isn't 
   imported by your package (#1085).
 
 * `@includeRmd` is now adapted to change in rmarkdown 2.12 regarding math 

---FILE: R/namespace.R---
@@ -396,7 +396,7 @@ warn_missing_s3_exports <- function(blocks, env) {
   funs <- Filter(is.function, objs)
   methods <- funs[map_lgl(names(funs), is_s3_method, env = env)]
 
-  s3blocks <- blocks[map_lgl(blocks, block_has_tags, c(""export"", ""exportS3method""))]
+  s3blocks <- blocks[map_lgl(blocks, block_has_tags, c(""export"", ""exportS3Method""))]
   s3objects <- map(blocks, function(block) block$object$value)
 
   undocumented <- methods[!methods %in% s3objects]
@@ -405,7 +405,7 @@ warn_missing_s3_exports <- function(blocks, env) {
   map2(undocumented, names(undocumented), function(fun, name) {
     warn_roxy_function(
       fun,
-      ""S3 method {.arg {name}} needs @export or @exportS3method tag""
+      ""S3 method {.arg {name}} needs @export or @exportS3Method tag""
     )
   })
 }

---FILE: tests/testthat/_snaps/namespace.md---
@@ -1,11 +1,11 @@
-# @exportS3method generates fully automatically
+# @exportS3Method generates fully automatically
 
     Code
       . <- roc_proc_text(namespace_roclet(), block)
     Message
       x <text>:2: @exportS3Method must be used with an known S3 method.
 
-# @exportS3method can extract class from generic
+# @exportS3Method can extract class from generic
 
     Code
       . <- roc_proc_text(namespace_roclet(), block)
@@ -97,13 +97,13 @@
     Code
       . <- roc_proc_text(namespace_roclet(), block)
     Message
-      x <text>:5: S3 method `mean.myclass` needs @export or @exportS3method tag.
-      x <text>:3: S3 method `foo.numeric` needs @export or @exportS3method tag.
+      x <text>:5: S3 method `mean.myclass` needs @export or @exportS3Method tag.
+      x <text>:3: S3 method `foo.numeric` needs @export or @exportS3Method tag.
 
 ---
 
     Code
       . <- roc_proc_text(namespace_roclet(), block)
     Message
-      x <text>:3: S3 method `foo.{` needs @export or @exportS3method tag.
+      x <text>:3: S3 method `foo.{` needs @export or @exportS3Method tag.
 

---FILE: tests/testthat/test-namespace.R---
@@ -86,7 +86,7 @@ test_that(""export handles non-syntactic names"", {
   expect_equal(out, ""S3method(\""foo-bar\"",integer)"")
 })
 
-test_that(""@exportS3method generates fully automatically"", {
+test_that(""@exportS3Method generates fully automatically"", {
   out <- roc_proc_text(namespace_roclet(),""
     #' @exportS3Method
     mean.foo <- function(x) 'foo'
@@ -100,15 +100,15 @@ test_that(""@exportS3method generates fully automatically"", {
   expect_snapshot(. <- roc_proc_text(namespace_roclet(), block))
 })
 
-test_that(""@exportS3methd can create literal directive"", {
+test_that(""@exportS3Method can create literal directive"", {
   out <- roc_proc_text(namespace_roclet(),
     ""#' @exportS3Method base::mean foo
     NULL
   "")
   expect_equal(out, ""S3method(base::mean,foo)"")
 })
 
-test_that(""@exportS3method can extract class from generic"", {
+test_that(""@exportS3Method can extract class from generic"", {
   out <- roc_proc_text(namespace_roclet(), ""
     #' @exportS3Method pkg::foo
     foo.bar <- function(x) 'foo'

---FILE: vignettes/namespace.Rmd---
@@ -20,7 +20,7 @@ This is a little frustrating at first, but soon becomes second-nature.
 ## Exports
 
 In order for your users to use a function[^1] in your package, you must **export** it.
-In most cases, you can just use the `@export` tag, and roxygen2 will automatically figure out which `NAMESPACE` directive (i.e. `export()`, `exportS3method()`, `exportClasses()`, or `exportMethods()`) you need.
+In most cases, you can just use the `@export` tag, and roxygen2 will automatically figure out which `NAMESPACE` directive (i.e. `export()`, `S3method()`, `exportClasses()`, or `exportMethods()`) you need.
 
 [^1]: Including S3 and S4 generics and methods.
 "
r-lib,roxygen2,7ae215c69d6f44dee0bf3b59aa97b75827ee20e5,Ari Lamstein,ari@lamsteinconsulting.com,2024-07-09T14:40:48Z,GitHub,noreply@github.com,2024-07-09T14:40:48Z,"Update namespace.Rmd (#1597)

Fix typo.",vignettes/namespace.Rmd,True,False,True,False,1,1,2,"---FILE: vignettes/namespace.Rmd---
@@ -20,7 +20,7 @@ This is a little frustrating at first, but soon becomes second-nature.
 ## Exports
 
 In order for your users to use a function[^1] in your package, you must **export** it.
-In most cases, you can just use the `@export` tag, and roxygen2 will automatically figure out which `NAMESPACE` directive (i.e. `export()`, `exportS3method()`, `exportClasses()`, or`exportMethods()`) you need.
+In most cases, you can just use the `@export` tag, and roxygen2 will automatically figure out which `NAMESPACE` directive (i.e. `export()`, `exportS3method()`, `exportClasses()`, or `exportMethods()`) you need.
 
 [^1]: Including S3 and S4 generics and methods.
 "
r-lib,roxygen2,5b7110da54dbf03c8ce2d1a352ca6ce0cd5bcdda,Kelli Johnson,kelli.johnson@noaa.gov,2024-07-09T14:34:28Z,GitHub,noreply@github.com,2024-07-09T14:34:28Z,"Fix 3 typos in @describeIn section (#1611)

of the Reusing documention vignette",vignettes/reuse.Rmd,True,False,True,False,3,3,6,"---FILE: vignettes/reuse.Rmd---
@@ -90,11 +90,11 @@ ln <- function(x) log(x, exp(1))
 
 An alternative to `@rdname` is `@describeIn`.
 It has a slightly different syntax because as well as a topic name, you also provide a brief description for the function, like `@describein topic one sentence description`.
-The primary difference between `@rdname` and `@describeIn`, is that `@describeIn` creates a new section containing a bulleted list all of each function, along with its description.
-It uses a number of heuristics to determine the heading of this section, depending on you're documenting related functions, methods for a generic, or methods for a class.
+The primary difference between `@rdname` and `@describeIn`, is that `@describeIn` creates a new section containing a bulleted list of each function, along with its description.
+It uses a number of heuristics to determine the heading of this section, depending on if you're documenting related functions, methods for a generic, or methods for a class.
 
 In general, I no longer recommend `@describeIn` because I don't think the heuristics it uses are as good as a thoughtful hand-crafted summary.
-If you're currently using `@describeIn`, you can general replace it with `@rdname`, as long as you give some thought to the multiple-function `@description`.
+If you're currently using `@describeIn`, you can generally replace it with `@rdname`, as long as you give some thought to the multiple-function `@description`.
 
 ### Order of includes
 "
r-lib,roxygen2,0027d4d46e921daf66261b620575f33a8f7ecb22,Hadley Wickham,h.wickham@gmail.com,2024-06-27T20:53:26Z,GitHub,noreply@github.com,2024-06-27T20:53:26Z,"Fix build failure due to knitr output change (#1630)

* Fix build failure due to knitr output change
* And `use_tidy_github_actions()`",.github/workflows/R-CMD-check.yaml;.github/workflows/pkgdown.yaml;.github/workflows/pr-commands.yaml;.github/workflows/test-coverage.yaml;DESCRIPTION;tests/testthat/_snaps/rd-include-rmd.md;tests/testthat/test-rd-include-rmd.R,False,True,True,False,43,21,64,"---FILE: .github/workflows/R-CMD-check.yaml---
@@ -12,6 +12,8 @@ on:
 
 name: R-CMD-check
 
+permissions: read-all
+
 jobs:
   R-CMD-check:
     runs-on: ${{ matrix.config.os }}
@@ -25,24 +27,22 @@ jobs:
           - {os: macos-latest,   r: 'release'}
 
           - {os: windows-latest, r: 'release'}
-          # Use 3.6 to trigger usage of RTools35
-          - {os: windows-latest, r: '3.6'}
           # use 4.1 to check with rtools40's older compiler
           - {os: windows-latest, r: '4.1'}
 
-          - {os: ubuntu-latest,   r: 'devel', http-user-agent: 'release'}
-          - {os: ubuntu-latest,   r: 'release'}
-          - {os: ubuntu-latest,   r: 'oldrel-1'}
-          - {os: ubuntu-latest,   r: 'oldrel-2'}
-          - {os: ubuntu-latest,   r: 'oldrel-3'}
-          - {os: ubuntu-latest,   r: 'oldrel-4'}
+          - {os: ubuntu-latest,  r: 'devel', http-user-agent: 'release'}
+          - {os: ubuntu-latest,  r: 'release'}
+          - {os: ubuntu-latest,  r: 'oldrel-1'}
+          - {os: ubuntu-latest,  r: 'oldrel-2'}
+          - {os: ubuntu-latest,  r: 'oldrel-3'}
+          - {os: ubuntu-latest,  r: 'oldrel-4'}
 
     env:
       GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
       R_KEEP_PKG_SOURCE: yes
 
     steps:
-      - uses: actions/checkout@v3
+      - uses: actions/checkout@v4
 
       - uses: r-lib/actions/setup-pandoc@v2
 
@@ -60,3 +60,4 @@ jobs:
       - uses: r-lib/actions/check-r-package@v2
         with:
           upload-snapshots: true
+          build_args: 'c(""--no-manual"",""--compact-vignettes=gs+qpdf"")'

---FILE: .github/workflows/pkgdown.yaml---
@@ -11,6 +11,8 @@ on:
 
 name: pkgdown
 
+permissions: read-all
+
 jobs:
   pkgdown:
     runs-on: ubuntu-latest
@@ -22,7 +24,7 @@ jobs:
     permissions:
       contents: write
     steps:
-      - uses: actions/checkout@v3
+      - uses: actions/checkout@v4
 
       - uses: r-lib/actions/setup-pandoc@v2
 
@@ -41,7 +43,7 @@ jobs:
 
       - name: Deploy to GitHub pages 游
         if: github.event_name != 'pull_request'
-        uses: JamesIves/github-pages-deploy-action@v4.4.1
+        uses: JamesIves/github-pages-deploy-action@v4.5.0
         with:
           clean: false
           branch: gh-pages

---FILE: .github/workflows/pr-commands.yaml---
@@ -6,6 +6,8 @@ on:
 
 name: Commands
 
+permissions: read-all
+
 jobs:
   document:
     if: ${{ github.event.issue.pull_request && (github.event.comment.author_association == 'MEMBER' || github.event.comment.author_association == 'OWNER') && startsWith(github.event.comment.body, '/document') }}
@@ -14,7 +16,7 @@ jobs:
     env:
       GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
     steps:
-      - uses: actions/checkout@v3
+      - uses: actions/checkout@v4
 
       - uses: r-lib/actions/pr-fetch@v2
         with:
@@ -51,7 +53,7 @@ jobs:
     env:
       GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
     steps:
-      - uses: actions/checkout@v3
+      - uses: actions/checkout@v4
 
       - uses: r-lib/actions/pr-fetch@v2
         with:

---FILE: .github/workflows/test-coverage.yaml---
@@ -8,43 +8,54 @@ on:
 
 name: test-coverage
 
+permissions: read-all
+
 jobs:
   test-coverage:
     runs-on: ubuntu-latest
     env:
       GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
 
     steps:
-      - uses: actions/checkout@v3
+      - uses: actions/checkout@v4
 
       - uses: r-lib/actions/setup-r@v2
         with:
           use-public-rspm: true
 
       - uses: r-lib/actions/setup-r-dependencies@v2
         with:
-          extra-packages: any::covr
+          extra-packages: any::covr, any::xml2
           needs: coverage
 
       - name: Test coverage
         run: |
-          covr::codecov(
+          cov <- covr::package_coverage(
             quiet = FALSE,
             clean = FALSE,
             install_path = file.path(normalizePath(Sys.getenv(""RUNNER_TEMP""), winslash = ""/""), ""package"")
           )
+          covr::to_cobertura(cov)
         shell: Rscript {0}
 
+      - uses: codecov/codecov-action@v4
+        with:
+          fail_ci_if_error: ${{ github.event_name != 'pull_request' && true || false }}
+          file: ./cobertura.xml
+          plugin: noop
+          disable_search: true
+          token: ${{ secrets.CODECOV_TOKEN }}
+
       - name: Show testthat output
         if: always()
         run: |
           ## --------------------------------------------------------------------
-          find ${{ runner.temp }}/package -name 'testthat.Rout*' -exec cat '{}' \; || true
+          find '${{ runner.temp }}/package' -name 'testthat.Rout*' -exec cat '{}' \; || true
         shell: bash
 
       - name: Upload test results
         if: failure()
-        uses: actions/upload-artifact@v3
+        uses: actions/upload-artifact@v4
         with:
           name: coverage-test-failures
           path: ${{ runner.temp }}/package

---FILE: DESCRIPTION---
@@ -53,4 +53,4 @@ Config/testthat/parallel: TRUE
 Encoding: UTF-8
 Language: en-GB
 Roxygen: list(markdown = TRUE, load = ""installed"")
-RoxygenNote: 7.3.0.9000
+RoxygenNote: 7.3.1.9000

---FILE: tests/testthat/_snaps/rd-include-rmd.md---
@@ -16,11 +16,13 @@
 
     Code
       . <- roc_proc_text(rd_roclet(), text)
+    Output
+      
     Message
       
       Quitting from lines 2-3 [unnamed-chunk-2] (<temp-path.Rmd>)
       
-      Quitting from lines 2-3 [unnamed-chunk-1] (<temp-path.Rmd>)
+      Quitting from lines 2-2 [unnamed-chunk-1] (<another-temp-path.Rmd>)
       x <text>:3: @includeRmd failed to evaluate '<temp-path.Rmd>'.
       Caused by error:
       ! Error

---FILE: tests/testthat/test-rd-include-rmd.R---
@@ -291,7 +291,11 @@ test_that(""useful warnings"", {
   )
   expect_snapshot(
     . <- roc_proc_text(rd_roclet(), text),
-    transform = function(x) gsub(path, ""<temp-path.Rmd>"", x, fixed =TRUE)
+    transform = function(x) {
+      x <- gsub(path, ""<temp-path.Rmd>"", x, fixed = TRUE)
+      x <- gsub(""file.*\\.Rmd"", ""<another-temp-path.Rmd>"", x)
+      x
+    }
   )
 })
 "
r-lib,roxygen2,036e74a0ff996403ea5006027eaebea16d25c377,Hadley Wickham,h.wickham@gmail.com,2024-01-22T19:14:18Z,GitHub,noreply@github.com,2024-01-22T19:14:18Z,"Correctly interpolate dangerous string into cli warning (#1576)

Fixes #1575",DESCRIPTION;NEWS.md;R/namespace.R;tests/testthat/_snaps/namespace.md;tests/testthat/test-namespace.R,False,True,True,False,38,15,53,"---FILE: DESCRIPTION---
@@ -53,4 +53,4 @@ Config/testthat/parallel: TRUE
 Encoding: UTF-8
 Language: en-GB
 Roxygen: list(markdown = TRUE, load = ""installed"")
-RoxygenNote: 7.2.3.9000
+RoxygenNote: 7.3.0.9000

---FILE: NEWS.md---
@@ -1,6 +1,9 @@
 # roxygen2 (development version)
 
+* S3 method export warning no longer fails if class contains `{` or `}` (#1575).
+
 * `@family` lists are now ordered more carefully, ""foo1"" comes after ""foo"" (#1563, @krlmlr).
+
 * Re-runs of `namespace_roclet()` fixed for packages using multi-line `@rawNamespace` directives (#1572, @MichaelChirico).
 
 * `@importFrom` works again for quoted non-syntactic names, e.g.

---FILE: R/namespace.R---
@@ -401,7 +401,11 @@ warn_missing_s3_exports <- function(blocks, env) {
 
   undocumented <- methods[!methods %in% s3objects]
   srcrefs <- map(undocumented, attr, ""srcref"")
-  messages <- paste0(""S3 method `"", names(undocumented) , ""` needs @export or @exportS3method tag"")
-  map2(undocumented, messages, warn_roxy_function)
-}
 
+  map2(undocumented, names(undocumented), function(fun, name) {
+    warn_roxy_function(
+      fun,
+      ""S3 method {.arg {name}} needs @export or @exportS3method tag""
+    )
+  })
+}

---FILE: tests/testthat/_snaps/namespace.md---
@@ -95,11 +95,15 @@
 # warns if S3 method not documented
 
     Code
-      roc_proc_text(namespace_roclet(),
-      ""\n      foo <- function(x) UseMethod('foo')\n      foo.numeric <- function(x) 1\n\n      mean.myclass <- function(x) 2\n    "")
+      . <- roc_proc_text(namespace_roclet(), block)
     Message
       x <text>:5: S3 method `mean.myclass` needs @export or @exportS3method tag.
       x <text>:3: S3 method `foo.numeric` needs @export or @exportS3method tag.
-    Output
-      character(0)
+
+---
+
+    Code
+      . <- roc_proc_text(namespace_roclet(), block)
+    Message
+      x <text>:3: S3 method `foo.{` needs @export or @exportS3method tag.
 

---FILE: tests/testthat/test-namespace.R---
@@ -472,19 +472,31 @@ test_that(""non-syntactic imports can use multiple quoting forms"", {
 # warn_missing_s3_exports -------------------------------------------------
 
 test_that(""warns if S3 method not documented"", {
-  expect_snapshot(
-    roc_proc_text(namespace_roclet(), ""
+  # Need to manually transform since the srcref is coming from the function;
+  # roc_proc_text() uses fake srcrefs for the blocks themselves
+  fix_srcref <- function(x) gsub(""file[a-z0-9]+"", ""<text>"", x)
+
+  block <- ""
       foo <- function(x) UseMethod('foo')
       foo.numeric <- function(x) 1
 
       mean.myclass <- function(x) 2
-    ""),
-    # Need to manually transform since the srcref is coming from the function;
-    # roc_proc_text() uses fake srcrefs for the blocks themselves
-    transform = function(x) gsub(""file[a-z0-9]+"", ""<text>"", x)
+    ""
+  expect_snapshot(
+    . <- roc_proc_text(namespace_roclet(), block),
+    transform = fix_srcref
   )
-})
 
+  # Works even if method contains {
+  block <- ""
+    foo <- function(x) UseMethod('foo')
+    `foo.{` <- function(x) 1
+  ""
+  expect_snapshot(
+    . <- roc_proc_text(namespace_roclet(), block),
+    transform = fix_srcref
+  )
+})
 
 test_that(""can suppress the warning"", {
   block <- """
r-lib,roxygen2,f52889c15febd8f68dbca8879f54cedcce9f8b06,Salim B,git@salim.space,2024-01-22T13:50:47Z,GitHub,noreply@github.com,2024-01-22T13:50:47Z,Fix typo (#1569),vignettes/rd-other.Rmd,True,False,True,False,1,1,2,"---FILE: vignettes/rd-other.Rmd---
@@ -57,7 +57,7 @@ Note the use of two additional tags that are particularly useful for documenting
 ## Packages
 
 As well as documenting every object inside the package, you can also document the package itself by documenting the special sentinel `""_PACKAGE""`.
-This automatically include information parsed from the `DESCRIPTION`, including title, description, list of authors, and useful URLs.
+This automatically includes information parsed from the `DESCRIPTION`, including title, description, list of authors, and useful URLs.
 
 We recommend placing package documentation in `{pkgname}-package.R`, and have `@keywords internal`.
 Use `usethis::use_package_doc()` to set up automatically."
r-lib,roxygen2,b5e882aaf56892acf0c362487bb928a75bf91df0,Michael Chirico,chiricom@google.com,2024-01-22T13:50:23Z,GitHub,noreply@github.com,2024-01-22T13:50:23Z,"Fix idempotency of roxygenize() for packages using multi-line @rawNamespace (#1573)

Fixes #1572",.gitignore;NEWS.md;R/namespace.R;tests/testthat/test-namespace.R;tests/testthat/testRawNamespace/DESCRIPTION;tests/testthat/testRawNamespace/NAMESPACE;tests/testthat/testRawNamespace/R/a.R,False,True,True,False,54,3,57,"---FILE: .gitignore---
@@ -2,6 +2,8 @@
 .Rproj.user
 /.Rhistory
 
+tests/testthat/testthat-problems.rds
+
 ## Qt Creator
 *.pro
 *.pro.user

---FILE: NEWS.md---
@@ -1,6 +1,7 @@
 # roxygen2 (development version)
 
 * `@family` lists are now ordered more carefully, ""foo1"" comes after ""foo"" (#1563, @krlmlr).
+* Re-runs of `namespace_roclet()` fixed for packages using multi-line `@rawNamespace` directives (#1572, @MichaelChirico).
 
 * `@importFrom` works again for quoted non-syntactic names, e.g.
   `@importFrom magrittr ""%>%""` or ``@importFrom rlang `:=` ``, after being broken

---FILE: R/namespace.R---
@@ -74,7 +74,7 @@ update_namespace_imports <- function(base_path) {
   }
 
   lines <- c(namespace_imports(base_path), namespace_exports(NAMESPACE))
-  results <- c(made_by(""#""), sort_c(unique(lines)))
+  results <- c(made_by(""#""), sort_c(unique(trimws(lines))))
   write_if_different(NAMESPACE, results, check = TRUE)
 
   invisible()
@@ -109,12 +109,15 @@ namespace_imports_blocks <- function(srcref) {
   }))
 }
 
+# NB: this is designed as the conjugate of namespace_imports(), so also
+#   includes @rawNamespace entries which may/may not also include import directives.
 namespace_exports <- function(path) {
   parsed <- as.list(parse(path, keep.source = TRUE))
 
   is_import_directive <- function(x) is_call(x, import_directives)
   export_lines <- attr(parsed, ""srcref"")[!map_lgl(parsed, is_import_directive)]
-  unlist(lapply(export_lines, as.character))
+  # Each multiline directives are a single element so they're sorted correctly
+  unlist(lapply(export_lines, function(x) paste(as.character(x), collapse = ""\n"")))
 }
 
 # NAMESPACE generation ----------------------------------------------------

---FILE: tests/testthat/test-namespace.R---
@@ -305,6 +305,17 @@ test_that(""rawNamespace inserted unchanged"", {
   expect_equal(out, ""xyz\n  abc"")
 })
 
+test_that(""rawNamespace does not break idempotency"", {
+  test_pkg <- test_path(""testRawNamespace"")
+  NAMESPACE <- file.path(test_pkg, ""NAMESPACE"")
+
+  lines_orig <- read_lines(NAMESPACE)
+
+  expect_no_error(roxygenize(test_pkg, namespace_roclet()))
+
+  # contents unchanged
+  expect_equal(read_lines(NAMESPACE), lines_orig)
+})
 
 # @evalNamespace ----------------------------------------------------------
 
@@ -391,7 +402,13 @@ test_that(""can extract non-imports from namespace preserving source"", {
     ""export(b)""
   )
   path <- withr::local_tempfile(lines = lines)
-  expect_equal(namespace_exports(path), lines[c(1:3, 5)])
+  expect_equal(
+    namespace_exports(path),
+    c(
+      paste(lines[1:3], collapse = ""\n""),
+      lines[5L]
+    )
+  )
 })
 
 test_that(""invalid imports generate correct declarations"", {

---FILE: tests/testthat/testRawNamespace/DESCRIPTION---
@@ -0,0 +1,9 @@
+Package: testRawNamespace
+Title: Check that re-running on multi-line @rawNamespace directive is OK
+License: GPL-2
+Description: testRawNamespace.
+Author: Hadley <hadley@rstudio.com>
+Maintainer: Hadley <hadley@rstudio.com>
+Encoding: UTF-8
+Version: 0.1
+RoxygenNote: 7.3.0.9000

---FILE: tests/testthat/testRawNamespace/NAMESPACE---
@@ -0,0 +1,10 @@
+# Generated by roxygen2: do not edit by hand
+
+
+if (TRUE) {
+  import(grDevices)
+} else {
+  import(methods)
+}
+import(graphics)
+import(utils)

---FILE: tests/testthat/testRawNamespace/R/a.R---
@@ -0,0 +1,9 @@
+#' @import graphics
+#' @rawNamespace
+#' if (TRUE) {
+#'   import(grDevices)
+#' } else {
+#'   import(methods)
+#' }
+#' @import utils
+NULL"
r-lib,roxygen2,a3e3908a9404e7c0b32e6a8be5fcb9cec5cbe8a7,Michael Chirico,michaelchirico4@gmail.com,2024-01-19T17:08:47Z,GitHub,noreply@github.com,2024-01-19T17:08:47Z,"Restore old behavior of @importFrom in some edge cases (#1574)

Fixes #1570

Co-authored-by: Hadley Wickham <h.wickham@gmail.com>",NEWS.md;R/namespace.R;R/utils.R;tests/testthat/_snaps/namespace.md;tests/testthat/test-namespace.R,False,True,True,False,54,17,71,"---FILE: NEWS.md---
@@ -2,6 +2,12 @@
 
 * `@family` lists are now ordered more carefully, ""foo1"" comes after ""foo"" (#1563, @krlmlr).
 
+* `@importFrom` works again for quoted non-syntactic names, e.g.
+  `@importFrom magrittr ""%>%""` or ``@importFrom rlang `:=` ``, after being broken
+  in 7.3.0 (#1570, @MichaelChirico). The unquoted form `@importFrom magrittr %>%`
+  continues to work. Relatedly, `@importFrom` directives not matching any known
+  functions (e.g. `@importFrom utils plot pdf`) produce valid NAMESPACE files again.
+
 # roxygen2 7.3.0
 
 ## New features

---FILE: R/namespace.R---
@@ -268,9 +268,13 @@ roxy_tag_ns.roxy_tag_importFrom <- function(x, block, env) {
   pkg <- x$val[1L]
   if (requireNamespace(pkg, quietly = TRUE)) {
     importing <- x$val[-1L]
-    unknown_idx <- !importing %in% getNamespaceExports(pkg)
+    # be sure to match '%>%', `%>%`, ""%>%"" all to %>% given by getNamespaceExports, #1570
+    unknown_idx <- !strip_quotes(importing) %in% getNamespaceExports(pkg)
     if (any(unknown_idx)) {
-      warn_roxy_tag(x, ""Excluding unknown {cli::qty(sum(unknown_idx))} export{?s} in from {.package {pkg}}: {.code {importing[unknown_idx]}}"")
+      warn_roxy_tag(x, ""Excluding unknown {cli::qty(sum(unknown_idx))} export{?s} from {.package {pkg}}: {.code {importing[unknown_idx]}}"")
+      if (all(unknown_idx)) {
+        return(NULL)
+      }
       x$val <- c(pkg, importing[!unknown_idx])
     }
   }

---FILE: R/utils.R---
@@ -179,3 +179,4 @@ auto_quote <- function(x) {
 
 is_syntactic <- function(x) make.names(x) == x
 has_quotes <- function(x) str_detect(x, ""^(`|'|\"").*\\1$"")
+strip_quotes <- function(x) str_replace(x, ""^(`|'|\"")(.*)\\1$"", ""\\2"")

---FILE: tests/testthat/_snaps/namespace.md---
@@ -78,24 +78,19 @@
     Message
       x <text>:2: @evalNamespace must evaluate to a character vector.
 
-# Invalid imports throw a helpful error
+# invalid imports generate helpful message
 
     Code
       out <- roc_proc_text(namespace_roclet(), block)
     Message
-      x <text>:2: @importFrom Excluding unknown export in from utils: `InvalidUtilsFunction`.
+      x <text>:2: @importFrom Excluding unknown export from utils: `InvalidUtilsFunction1`.
 
 ---
 
     Code
       out <- roc_proc_text(namespace_roclet(), block)
     Message
-      x <text>:2: @importFrom Excluding unknown exports in from utils: `InvalidUtilsFunction1` and `InvalidUtilsFunction2`.
-
----
-
-    Code
-      out <- roc_proc_text(namespace_roclet(), block)
+      x <text>:2: @importFrom Excluding unknown exports from utils: `InvalidUtilsFunction1` and `InvalidUtilsFunction2`.
 
 # warns if S3 method not documented
 

---FILE: tests/testthat/test-namespace.R---
@@ -394,32 +394,63 @@ test_that(""can extract non-imports from namespace preserving source"", {
   expect_equal(namespace_exports(path), lines[c(1:3, 5)])
 })
 
-test_that(""Invalid imports throw a helpful error"", {
+test_that(""invalid imports generate correct declarations"", {
+  # No matched functions --> no output
+  block <- ""
+    #' @importFrom utils InvalidUtilsFunction
+    NULL
+  ""
+  expect_message(out <- roc_proc_text(namespace_roclet(), block))
+  expect_equal(out, character())
+
+  # Matched functions --> only drop unmatched functions
   block <- ""
     #' @importFrom utils head InvalidUtilsFunction
     NULL
   ""
-  expect_snapshot(out <- roc_proc_text(namespace_roclet(), block))
+  expect_message(out <- roc_proc_text(namespace_roclet(), block))
   expect_equal(out, ""importFrom(utils,head)"")
+})
+
+test_that(""invalid imports generate helpful message"", {
+  block <- ""
+    #' @importFrom utils head InvalidUtilsFunction1
+    NULL
+  ""
+  expect_snapshot(out <- roc_proc_text(namespace_roclet(), block))
 
-  # pluralization
   block <- ""
     #' @importFrom utils head InvalidUtilsFunction1 InvalidUtilsFunction2
     NULL
   ""
   expect_snapshot(out <- roc_proc_text(namespace_roclet(), block))
-  expect_equal(out, ""importFrom(utils,head)"")
+})
 
-  # If the package is not available at roxygenize() run time, nothing we can do
+test_that(""nothing we can do if package isn't installed"", {
   block <- ""
     #' @importFrom AnUnknownUnavailablePackage Unchecked
     NULL
   ""
-  expect_snapshot(out <- roc_proc_text(namespace_roclet(), block))
+  expect_no_message(out <- roc_proc_text(namespace_roclet(), block))
   expect_equal(out, ""importFrom(AnUnknownUnavailablePackage,Unchecked)"")
-
 })
 
+test_that(""non-syntactic imports can use multiple quoting forms"", {
+  lines <- c(
+    ""#' @importFrom stringr %>%"",
+    ""#' @importFrom stringr `%>%`"",
+    ""#' @importFrom stringr '%>%'"",
+    ""#' @importFrom stringr \""%>%\"""",
+    ""NULL""
+  )
+
+  import <- expect_no_warning(roc_proc_text(namespace_roclet(), lines))
+  expect_equal(import, c(
+    ""importFrom(stringr,\""%>%\"")"",
+    ""importFrom(stringr,'%>%')"",
+    ""importFrom(stringr,`%>%`)""
+  ))
+})
 
 # warn_missing_s3_exports -------------------------------------------------
 "
r-lib,roxygen2,2a01d29f4b09ea114224b00260a0dd3c7089a857,Hadley Wickham,h.wickham@gmail.com,2024-01-11T21:11:22Z,Hadley Wickham,h.wickham@gmail.com,2024-01-11T21:11:22Z,Fix merge muck up,NEWS.md,False,False,False,False,4,0,4,"---FILE: NEWS.md---
@@ -1,3 +1,7 @@
+# withr (development version)
+
+* `@family` lists are now ordered more carefully, ""foo1"" comes after ""foo"" (#1563, @krlmlr).
+
 # roxygen2 7.3.0
 
 ## New features"
r-lib,roxygen2,7408879b4140875819fb85e08cdbd4d74a36fa6c,Hadley Wickham,h.wickham@gmail.com,2023-12-11T17:49:42Z,GitHub,noreply@github.com,2023-12-11T17:49:42Z,"Non-syntactic S4 classes don't need backticks (#1557)

Fixes documentation issue in odbc",NEWS.md;R/rd-usage.R;tests/testthat/test-rd-usage.R,False,True,True,False,5,3,8,"---FILE: NEWS.md---
@@ -1,5 +1,7 @@
 # roxygen2 (development version)
 
+* Generate correct usage for S4 methods with non-syntactic class names.
+
 * `@describeIn foo` now suggests that you might want `@rdname` instead 
   (#1493).
 

---FILE: R/rd-usage.R---
@@ -60,7 +60,7 @@ object_usage.s4generic <- function(x) {
 #' @export
 object_usage.s4method <- function(x) {
   s4method <- function(name) {
-    classes <- auto_backtick(as.character(x$value@defined))
+    classes <- as.character(x$value@defined)
     paste0(""\\S4method{"", name, ""}{"", paste0(classes, collapse = "",""), ""}"")
   }
   function_usage(x$value@generic, formals(x$value), s4method)

---FILE: tests/testthat/test-rd-usage.R---
@@ -251,13 +251,13 @@ test_that(""default usage correct for S4 methods with different args to generic"",
   )
 })
 
-test_that(""non-syntactic S4 class names are escaped in usage"", {
+test_that(""non-syntactic S4 class names are not escaped in usage"", {
   expect_equal(
     call_to_usage({
       setGeneric(""rhs"", function(x) standardGeneric(""rhs""))
       setMethod(""rhs"", ""<-"", function(x) x[[3]])
     }),
-    ""\\S4method{rhs}{`<-`}(x)""
+    ""\\S4method{rhs}{<-}(x)""
   )
 })
 "
r-lib,roxygen2,9e97a3cbf8ebd61ee2519913a3fd985950716068,Hadley Wickham,h.wickham@gmail.com,2023-11-22T14:09:11Z,GitHub,noreply@github.com,2023-11-22T14:09:11Z,"Support `@exportS3Method NULL` (#1551)

To suppress the S3 method warning message. Fixes #1550.",NEWS.md;R/namespace.R;tests/testthat/test-namespace.R;vignettes/namespace.Rmd,True,True,True,False,19,1,20,"---FILE: NEWS.md---
@@ -17,7 +17,8 @@
 * The NAMESPACE roclet now reports if you have S3 methods that are missing
   an `@export` tag. All S3 methods need to be `@export`ed (which confusingly
   really registers the method) even if the generic is not. This avoids rare,
-  but hard to debug, problems (#1175).
+  but hard to debug, problems (#1175). You can suppress the warning with
+  `@exportS3Method NULL` (#1550).
 
 * `@include` now gives an informative warning if you use a path that doesn't
   exist (#1497).

---FILE: R/namespace.R---
@@ -199,6 +199,10 @@ roxy_tag_parse.roxy_tag_exportS3Method <- function(x) {
 roxy_tag_ns.roxy_tag_exportS3Method <- function(x, block, env) {
   obj <- block$object
 
+  if (identical(x$val, ""NULL"")) {
+    return()
+  }
+
   if (identical(x$val, """")) {
     if (!inherits(obj, ""s3method"")) {
       warn_roxy_tag(x, ""must be used with an known S3 method"")

---FILE: tests/testthat/test-namespace.R---
@@ -437,6 +437,17 @@ test_that(""warns if S3 method not documented"", {
   )
 })
 
+
+test_that(""can suppress the warning"", {
+  block <- ""
+    #' @exportS3Method NULL
+    mean.myclass <- function(x) 1
+  ""
+  expect_silent(out <- roc_proc_text(namespace_roclet(), block))
+  expect_equal(out, character())
+})
+
+
 test_that(""doesn't warn for potential false postives"", {
   roc <- namespace_roclet()
   expect_no_warning({

---FILE: vignettes/namespace.Rmd---
@@ -72,6 +72,8 @@ bizarro.character <- function(x, ...) {
 }
 ```
 
+If you are exporting a method in some other way, you can use `@exportS3Method NULL` to suppress the warning.
+
 You have four options for documenting an S3 method:
 
 -   Don't document it; it's not required, and not needed for simple generics where the user won't care about the details."
r-lib,roxygen2,f4dc9b1971d65907e44dc7a5ce6619f6295ad93e,Hadley Wickham,h.wickham@gmail.com,2023-11-22T14:08:45Z,GitHub,noreply@github.com,2023-11-22T14:08:45Z,"Improve messages for two part tags (#1547)

And provide a helpful suggestion for `@describeIn`. Fixes #1493.",NEWS.md;R/rd-describe-in.R;R/rd-include-rmd.R;R/rd-inherit.R;R/rd-params.R;R/rd-s4.R;R/rd-template.R;R/tag-parser.R;tests/testthat/_snaps/rd-describe-in.md;tests/testthat/_snaps/rd-include-rmd.md;tests/testthat/_snaps/rd-inherit.md;tests/testthat/_snaps/rd-params.md;tests/testthat/_snaps/rd-s4.md;tests/testthat/_snaps/rd-template.md;tests/testthat/_snaps/tag-parser.md;tests/testthat/test-rd-describe-in.R;tests/testthat/test-rd-include-rmd.R;tests/testthat/test-rd-inherit.R;tests/testthat/test-rd-s4.R;tests/testthat/test-rd-template.R;tests/testthat/test-tag-parser.R,False,True,True,False,135,29,164,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* `@describeIn foo` now suggests that you might want `@rdname` instead 
+  (#1493).
+
 * `_PACKAGE` will no longer generate an alias for your package name if 
   a function of the same name exists (#1160).
 

---FILE: R/rd-describe-in.R---
@@ -1,6 +1,14 @@
 #' @export
 roxy_tag_parse.roxy_tag_describeIn <- function(x) {
-  tag_name_description(x)
+  if (!is.na(x$raw) && !str_detect(x$raw, ""[[:space:]]+"")) {
+    warn_roxy_tag(x, c(
+      ""requires a name and description"",
+      i = ""Did you want @rdname instead?""
+    ))
+    NULL
+  } else {
+    tag_two_part(x, ""a topic name"", ""a description"")
+  }
 }
 
 topic_add_describe_in <- function(topic, block, env) {

---FILE: R/rd-include-rmd.R---
@@ -5,13 +5,13 @@ roxy_tag_parse.roxy_tag_includeRmd <- function(x) {
     return()
   }
 
-  tag_two_part(x, ""path"", ""section"", required = FALSE, markdown = FALSE)
+  tag_two_part(x, ""a path"", ""a section"", required = FALSE, markdown = FALSE)
 }
 
 #' @export
 roxy_tag_rd.roxy_tag_includeRmd <- function(x, base_path, env) {
-  rmd <- rel_rmd <- x$val$path
-  section <- x$val$section
+  rmd <- rel_rmd <- x$val$name
+  section <- x$val$description
 
   if (!file.exists(rmd)) {
     warn_roxy_tag(x, ""Can't find Rmd {.path {rmd}}"")

---FILE: R/rd-inherit.R---
@@ -16,15 +16,17 @@ roxy_tag_rd.roxy_tag_inheritParams <- function(x, base_path, env) {
 
 #' @export
 roxy_tag_parse.roxy_tag_inheritDotParams <- function(x) {
-  tag_two_part(x, ""source"", ""args"", required = FALSE, markdown = FALSE)
+  tag_two_part(x, ""a source"", ""an argument list"", required = FALSE, markdown = FALSE)
 }
 #' @export
 roxy_tag_rd.roxy_tag_inheritDotParams <- function(x, base_path, env) {
-  rd_section_inherit_dot_params(x$val$source, x$val$args)
+  rd_section_inherit_dot_params(x$val$name, x$val$description)
 }
 
 #' @export
-roxy_tag_parse.roxy_tag_inheritSection <- function(x) tag_name_description(x)
+roxy_tag_parse.roxy_tag_inheritSection <- function(x) {
+  tag_two_part(x, ""a topic name"", ""a section title"")
+}
 #' @export
 roxy_tag_rd.roxy_tag_inheritSection <- function(x, base_path, env) {
   rd_section_inherit_section(x$val$name, x$val$description)

---FILE: R/rd-params.R---
@@ -1,6 +1,6 @@
 #' @export
 roxy_tag_parse.roxy_tag_param <- function(x) {
-  tag_name_description(x)
+  tag_two_part(x, ""an argument name"", ""a description"")
 }
 
 #' @export

---FILE: R/rd-s4.R---
@@ -1,5 +1,7 @@
 #' @export
-roxy_tag_parse.roxy_tag_field <- function(x) tag_name_description(x)
+roxy_tag_parse.roxy_tag_field <- function(x) {
+  tag_two_part(x, ""a field name"", ""a description"")
+}
 #' @export
 roxy_tag_rd.roxy_tag_field <- function(x, base_path, env) {
   value <- setNames(x$val$description, x$val$name)
@@ -11,7 +13,9 @@ format.rd_section_field <- function(x, ...) {
 }
 
 #' @export
-roxy_tag_parse.roxy_tag_slot <- function(x) tag_name_description(x)
+roxy_tag_parse.roxy_tag_slot <- function(x) {
+  tag_two_part(x, ""a slot name"", ""a description"")
+}
 #' @export
 roxy_tag_rd.roxy_tag_slot <- function(x, base_path, env) {
   value <- setNames(x$val$description, x$val$name)

---FILE: R/rd-template.R---
@@ -5,7 +5,7 @@ roxy_tag_parse.roxy_tag_template <- function(x) {
 
 #' @export
 roxy_tag_parse.roxy_tag_templateVar <- function(x) {
-  tag_name_description(x)
+  tag_two_part(x, ""a variable name"", ""a value"")
 }
 
 process_templates <- function(block, base_path) {

---FILE: R/tag-parser.R---
@@ -98,10 +98,14 @@ tag_name <- function(x) {
 #' @param markdown Should the second part be parsed as markdown?
 tag_two_part <- function(x, first, second, required = TRUE, markdown = TRUE) {
   if (str_trim(x$raw) == """") {
-    warn_roxy_tag(x, ""requires a value"")
+    if (!required) {
+      warn_roxy_tag(x, ""requires {first}"")
+    } else {
+      warn_roxy_tag(x, ""requires two parts: {first} and {second}"")
+    }
     NULL
   } else if (required && !str_detect(x$raw, ""[[:space:]]+"")) {
-    warn_roxy_tag(x, ""requires {first} and {second}"")
+    warn_roxy_tag(x, ""requires two parts: {first} and {second}"")
     NULL
   } else if (!rdComplete(x$raw, is_code = FALSE)) {
     warn_roxy_tag(x, ""has mismatched braces or quotes"")
@@ -118,15 +122,15 @@ tag_two_part <- function(x, first, second, required = TRUE, markdown = TRUE) {
       pieces[, 1],
       trim_docstring(pieces[,2])
     )
-    names(x$val) <- c(first, second)
+    names(x$val) <- c(""name"", ""description"")
     x
   }
 }
 
 #' @export
 #' @rdname tag_parsers
 tag_name_description <- function(x) {
-  tag_two_part(x, ""name"", ""description"")
+  tag_two_part(x, ""a name"", ""a description"")
 }
 
 #' @export

---FILE: tests/testthat/_snaps/rd-describe-in.md---
@@ -1,3 +1,11 @@
+# @describeIn suggests @rdname
+
+    Code
+      . <- roc_proc_text(rd_roclet(), block)
+    Message
+      x <text>:2: @describeIn requires a name and description.
+      i Did you want @rdname instead?
+
 # Multiple @describeIn functions combined into one
 
     Code

---FILE: tests/testthat/_snaps/rd-include-rmd.md---
@@ -1,3 +1,10 @@
+# invalid syntax gives useful warning
+
+    Code
+      . <- roc_proc_text(rd_roclet(), block)
+    Message
+      x <text>:2: @includeRmd requires a path.
+
 # useful warnings
 
     Code

---FILE: tests/testthat/_snaps/rd-inherit.md---
@@ -5,6 +5,14 @@
     ""sha1""}
     } 
 
+# invalid syntax gives useful warning
+
+    Code
+      . <- roc_proc_text(rd_roclet(), block)
+    Message
+      x <text>:2: @inheritDotParams requires a source.
+      x <text>:3: @inheritSection requires two parts: a topic name and a section title.
+
 # warns on unknown inherit type
 
     Code

---FILE: tests/testthat/_snaps/rd-params.md---
@@ -3,5 +3,5 @@
     Code
       . <- roc_proc_text(rd_roclet(), block)
     Message
-      x <text>:3: @param requires a value.
+      x <text>:3: @param requires two parts: an argument name and a description.
 

---FILE: tests/testthat/_snaps/rd-s4.md---
@@ -0,0 +1,8 @@
+# invalid syntax generates useful warning
+
+    Code
+      . <- roc_proc_text(rd_roclet(), block)
+    Message
+      x <text>:3: @field requires two parts: a field name and a description.
+      x <text>:4: @slot requires two parts: a slot name and a description.
+

---FILE: tests/testthat/_snaps/rd-template.md---
@@ -1,3 +1,10 @@
+# invalid syntax generates useful warning
+
+    Code
+      . <- roc_proc_text(rd_roclet(), block)
+    Message
+      x <text>:3: @templateVar requires two parts: a variable name and a value.
+
 # templates gives useful error if not found
 
     Code

---FILE: tests/testthat/_snaps/tag-parser.md---
@@ -19,18 +19,12 @@
       <message/rlang_message>
       Message:
       x test.R:1: @test requires a value.
-    Code
-      expect_parse_failure(tag_two_part(tag))
-    Output
-      <message/rlang_message>
-      Message:
-      x test.R:1: @test requires a value.
     Code
       expect_parse_failure(tag_name_description(tag))
     Output
       <message/rlang_message>
       Message:
-      x test.R:1: @test requires a value.
+      x test.R:1: @test requires two parts: a name and a description.
     Code
       expect_parse_failure(tag_code(tag))
     Output
@@ -146,12 +140,18 @@
 # tag_two_part() gives useful warnings
 
     Code
-      tag <- roxy_test_tag(""a"")
-      expect_parse_failure(tag_two_part(tag, ""name"", ""value""))
+      tag <- roxy_test_tag("""")
+      expect_parse_failure(tag_two_part(tag, ""a name"", ""a value"", required = FALSE))
+    Output
+      <message/rlang_message>
+      Message:
+      x test.R:1: @test requires a name.
+    Code
+      expect_parse_failure(tag_two_part(tag, ""a name"", ""a value""))
     Output
       <message/rlang_message>
       Message:
-      x test.R:1: @test requires name and value.
+      x test.R:1: @test requires two parts: a name and a value.
 
 # tag_words() gives useful warnings
 

---FILE: tests/testthat/test-rd-describe-in.R---
@@ -1,3 +1,11 @@
+test_that(""@describeIn suggests @rdname"", {
+  block <- ""
+    #' @describeIn foo
+    NULL
+  ""
+  expect_snapshot(. <- roc_proc_text(rd_roclet(), block))
+})
+
 test_that(""@describeIn generic destination captures s3 method source"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' Title
@@ -252,3 +260,4 @@ test_that(""complains about bad usage"", {
   ""
   expect_snapshot(. <- roc_proc_text(rd_roclet(), block))
 })
+

---FILE: tests/testthat/test-rd-include-rmd.R---
@@ -1,5 +1,13 @@
 skip_if_not_installed(""rmarkdown"")
 
+test_that(""invalid syntax gives useful warning"", {
+  block <- ""
+    #' @includeRmd
+    NULL
+  ""
+  expect_snapshot(. <- roc_proc_text(rd_roclet(), block))
+})
+
 test_that(""markdown file can be included"", {
   skip_if_not(rmarkdown::pandoc_available(""2.17""))
 

---FILE: tests/testthat/test-rd-inherit.R---
@@ -59,6 +59,15 @@ test_that(""relative links converted to absolute"", {
 
 # tag parsing -------------------------------------------------------------
 
+test_that(""invalid syntax gives useful warning"", {
+  block <- ""
+    #' @inheritDotParams
+    #' @inheritSection
+    NULL
+  ""
+  expect_snapshot(. <- roc_proc_text(rd_roclet(), block))
+})
+
 test_that(""warns on unknown inherit type"", {
   text <- ""
     #' @inherit fun blah

---FILE: tests/testthat/test-rd-s4.R---
@@ -1,3 +1,14 @@
+test_that(""invalid syntax generates useful warning"", {
+  block <- ""
+    #' A
+    #' @field
+    #' @slot
+    a <- function() {}
+  ""
+
+  expect_snapshot(. <- roc_proc_text(rd_roclet(), block))
+})
+
 test_that(""@fields creates a new section and lists fields"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' Important class.

---FILE: tests/testthat/test-rd-template.R---
@@ -1,3 +1,13 @@
+test_that(""invalid syntax generates useful warning"", {
+  block <- ""
+    #' A
+    #' @templateVar
+    a <- function() {}
+  ""
+
+  expect_snapshot(. <- roc_proc_text(rd_roclet(), block))
+})
+
 test_that(""can find template from name"", {
   base <- test_path(""templates/"")
 

---FILE: tests/testthat/test-tag-parser.R---
@@ -4,7 +4,6 @@ test_that(""tags containing only whitespace generate warning"", {
     expect_parse_failure(tag_value(tag))
     expect_parse_failure(tag_inherit(tag))
     expect_parse_failure(tag_name(tag))
-    expect_parse_failure(tag_two_part(tag))
     expect_parse_failure(tag_name_description(tag))
     expect_parse_failure(tag_code(tag))
     expect_parse_failure(tag_examples(tag))
@@ -54,8 +53,9 @@ test_that(""tag_name() checks for valid names"", {
 test_that(""tag_two_part() gives useful warnings"", {
   local_markdown()
   expect_snapshot({
-    tag <- roxy_test_tag(""a"")
-    expect_parse_failure(tag_two_part(tag, ""name"", ""value""))
+    tag <- roxy_test_tag("""")
+    expect_parse_failure(tag_two_part(tag, ""a name"", ""a value"", required = FALSE))
+    expect_parse_failure(tag_two_part(tag, ""a name"", ""a value""))
   })
 })
 "
r-lib,roxygen2,4b042dda6cca1dd71dacf4aa928c5e8129f8b408,Hadley Wickham,h.wickham@gmail.com,2023-11-22T13:15:07Z,GitHub,noreply@github.com,2023-11-22T13:15:07Z,"Don't add package name alias if used elsewhere (#1549)

Fixes #1160",NAMESPACE;NEWS.md;R/object-defaults.R;R/object-from-call.R;R/rd.R;R/roclet.R;man/roc_proc_text.Rd;tests/testthat/_snaps/object-from-call.md;tests/testthat/test-object-from-call.R;tests/testthat/test-rd.R,False,True,True,False,119,40,159,"---FILE: NAMESPACE---
@@ -36,6 +36,7 @@ S3method(format,rd_section_keyword)
 S3method(format,rd_section_minidesc)
 S3method(format,rd_section_name)
 S3method(format,rd_section_note)
+S3method(format,rd_section_package)
 S3method(format,rd_section_param)
 S3method(format,rd_section_rawRd)
 S3method(format,rd_section_rcmethods)
@@ -171,6 +172,7 @@ S3method(roxy_tag_parse,roxy_tag_useDynLib)
 S3method(roxy_tag_rd,default)
 S3method(roxy_tag_rd,roxy_tag_.formals)
 S3method(roxy_tag_rd,roxy_tag_.methods)
+S3method(roxy_tag_rd,roxy_tag_.package)
 S3method(roxy_tag_rd,roxy_tag_.reexport)
 S3method(roxy_tag_rd,roxy_tag_author)
 S3method(roxy_tag_rd,roxy_tag_backref)

---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* `_PACKAGE` will no longer generate an alias for your package name if 
+  a function of the same name exists (#1160).
+
 * `@exportS3Method` provides the needed metadata to generate correct usage
   for S3 methods, just like `@method` (#1202).
 

---FILE: R/object-defaults.R---
@@ -61,10 +61,10 @@ object_defaults.package <- function(x, block) {
   authors <- package_authors(desc$get_field(""Authors@R"", NULL))
 
   list(
+    roxy_generated_tag(block, "".package"", name),
     roxy_generated_tag(block, ""docType"", ""package""),
     roxy_generated_tag(block, ""name"", package_suffix(name)),
-    # ""NULL"" prevents addition of default aliases, see also #202
-    roxy_generated_tag(block, ""aliases"", paste(""NULL"", name, package_suffix(name))),
+    # default aliases are added in topics_add_package_alias()
     roxy_generated_tag(block, ""title"", paste0(name, "": "", title)),
     roxy_generated_tag(block, ""description"", description),
     roxy_generated_tag(block, ""seealso"", seealso),

---FILE: R/object-from-call.R---
@@ -104,7 +104,7 @@ parser_package <- function(file) {
     desc = desc::desc(file = pkg_path),
     path = pkg_path
   )
-  object(value, ""_PACKAGE"", type = ""package"")
+  object(value, NULL, type = ""package"")
 }
 
 parser_assignment <- function(call, env, block) {

---FILE: R/rd.R---
@@ -46,6 +46,7 @@ roclet_process.roclet_rd <- function(x, blocks, env, base_path) {
   topics$drop_invalid()
   topics_fix_params_order(topics)
   topics_add_default_description(topics)
+  topics_add_package_alias(topics)
 
   topics$topics
 }
@@ -209,6 +210,25 @@ topics_add_default_description <- function(topics) {
   invisible()
 }
 
+topics_add_package_alias <- function(topics) {
+  aliases <- unlist(topics$simple_values(""alias""), use.names = FALSE)
+
+  for (topic in topics$topics) {
+    if (!identical(topic$get_value(""docType""), ""package"")) {
+      next
+    }
+
+    package <- topic$get_value(""package"")
+    defaults <- c(package, package_suffix(package))
+
+    aliases <- union(setdiff(defaults, aliases), topic$get_value(""alias""))
+    topic$add(rd_section(""alias"", aliases), overwrite = TRUE)
+    break
+  }
+
+  invisible(NULL)
+}
+
 # Tag-wise processing -----------------------------------------------------
 
 #' Generate Rd output from a tag
@@ -241,6 +261,12 @@ roxy_tag_rd.roxy_tag_.formals <- function(x, base_path, env) {
 #' @export
 format.rd_section_formals <- function(x, ...) NULL
 
+#' @export
+roxy_tag_rd.roxy_tag_.package <- function(x, base_path, env) {
+  rd_section(""package"", x$val)
+}
+#' @export
+format.rd_section_package <- function(x, ...) NULL
 
 #' @export
 roxy_tag_parse.roxy_tag_method <- function(x) tag_words(x, 2, 2)

---FILE: R/roclet.R---
@@ -123,15 +123,20 @@ is.roclet <- function(x) inherits(x, ""roclet"")
 #'
 #' @param roclet Name of roclet to use for processing.
 #' @param input Source string
+#' @param wd Working directory
 #' @export
 #' @keywords internal
-roc_proc_text <- function(roclet, input) {
+roc_proc_text <- function(roclet, input, wd = NULL) {
   stopifnot(is.roclet(roclet))
 
   file <- tempfile()
   write_lines(input, file)
   on.exit(unlink(file))
 
+  if (!is.null(wd)) {
+    withr::local_dir(wd)
+  }
+
   env <- env_file(file)
   blocks <- parse_text(input, env = env)
   roclet_process(roclet, blocks, env = env, base_path = ""."")

---FILE: man/roc_proc_text.Rd---
@@ -4,12 +4,14 @@
 \alias{roc_proc_text}
 \title{Process roclet on string and capture results.}
 \usage{
-roc_proc_text(roclet, input)
+roc_proc_text(roclet, input, wd = NULL)
 }
 \arguments{
 \item{roclet}{Name of roclet to use for processing.}
 
 \item{input}{Source string}
+
+\item{wd}{Working directory}
 }
 \description{
 Useful for testing.

---FILE: tests/testthat/_snaps/object-from-call.md---
@@ -1,8 +1,8 @@
-# finds package description
+# recommends use of _PACKAGE
 
     Code
-      blocks <- parse_file(file.path(path, ""R/packages.R""))
+      out <- parse_text(block)[[1]]
     Message
-      x packages.R:2: `@docType ""package""` is deprecated.
+      x <text>:3: `@docType ""package""` is deprecated.
       i Please document ""_PACKAGE"" instead.
 

---FILE: tests/testthat/test-object-from-call.R---
@@ -6,26 +6,22 @@ test_that(""undocumentable things return null"", {
 
 # data / package -------------------------------------------------------
 
-test_that(""finds package description"", {
+test_that(""recommends use of _PACKAGE"", {
   path <- local_package_copy(test_path(""empty""))
-  write_lines(path = file.path(path, ""R/packages.R""), c(
-    ""#' @docType package
-    NULL""
-  ))
-  expect_snapshot(blocks <- parse_file(file.path(path, ""R/packages.R"")))
-
-  expect_s3_class(blocks[[1]]$object, ""package"")
-
-  expect_equal(
-    block_get_tag_value(blocks[[1]], ""aliases""),
-    ""NULL empty empty-package""
-  )
+
+  block <- ""
+    #' @docType package
+    NULL
+  ""
+  withr::with_dir(path, expect_snapshot(out <- parse_text(block)[[1]]))
+
+  expect_s3_class(out$object, ""package"")
+  expect_equal(out$object$value$desc$get_field(""Package""), ""empty"")
 })
 
 test_that(""finds package description"", {
   obj <- call_to_object(""_PACKAGE"", file = test_path(""testEagerData/R/a.r""))
   expect_s3_class(obj, ""package"")
-  expect_equal(obj$alias, ""_PACKAGE"")
   expect_equal(obj$value$desc$get_field(""Package""), ""testEagerData"")
 })
 

---FILE: tests/testthat/test-rd.R---
@@ -96,24 +96,15 @@ test_that(""@description NULL"", {
   expect_identical(out[[1]]$get_value(""description""), ""Title"")
 
   # But drop for package docs
-  path <- local_package_copy(test_path(""empty""))
-  desc::desc_set(
-    file = path,
-    Package = ""roxygendevtest"",
-    Title = ""Package Title"",
-    Description = ""Package description.""
-  )
-  withr::with_dir(
-    path,
-    out <- roc_proc_text(rd_roclet(), ""
-      #' Title
-      #'
-      #' @docType package
-      #' @description NULL
-      #' @name pkg
-      '_PACKAGE'
-    "")
-  )
+  block <- ""
+    #' Title
+    #'
+    #' @docType package
+    #' @description NULL
+    #' @name pkg
+    '_PACKAGE'
+  ""
+  out <- roc_proc_text(rd_roclet(), block, wd = test_path(""empty""))
   expect_null(out[[1]]$get_value(""description""))
 })
 
@@ -148,6 +139,60 @@ test_that(""@details NULL"", {
   expect_null(out[[1]]$get_value(""details""))
 })
 
+
+# package docs ------------------------------------------------------------
+
+
+test_that(""package docs don't get alias if function present"", {
+
+  block <- ""
+    #' Title
+    #'
+    '_PACKAGE'
+
+    #' Empty
+    empty <- function() {}
+  ""
+
+  out <- roc_proc_text(rd_roclet(), block, test_path(""empty""))[[1]]
+  expect_equal(out$get_value(""alias""), ""empty-package"")
+})
+
+test_that(""package docs preserve existing aliases"", {
+  block <- ""
+    #' Title
+    #' @aliases a b
+    #'
+    '_PACKAGE'
+  ""
+
+  out <- roc_proc_text(rd_roclet(), block, test_path(""empty""))[[1]]
+  expect_equal(out$get_value(""alias""), c(""empty"", ""empty-package"", ""a"", ""b""))
+
+  block <- paste0(block, ""
+    #' Empty
+    empty <- function() {}
+  "")
+  out <- roc_proc_text(rd_roclet(), block, test_path(""empty""))[[1]]
+  expect_equal(out$get_value(""alias""), c(""empty-package"", ""a"", ""b""))
+})
+
+test_that(""get correct alias even if user has overriden name"", {
+  block <- ""
+    #' Title
+    #' @name foo
+    #' @aliases bar
+    #'
+    '_PACKAGE'
+  ""
+
+  out <- roc_proc_text(rd_roclet(), block, test_path(""empty""))[[1]]
+  expect_equal(
+    out$get_value(""alias""),
+    c(""empty"", ""empty-package"", ""foo"", ""bar"")
+  )
+})
+
 # UTF-8 -------------------------------------------------------------------
 
 test_that(""can generate nonASCII document"", {"
r-lib,roxygen2,2297f33b963c10a0c44c8cf3295a7c9abc8f9952,Hadley Wickham,h.wickham@gmail.com,2023-11-21T22:42:19Z,GitHub,noreply@github.com,2023-11-21T22:42:19Z,"Derive S3 metadata from `@exportS3Method()` (#1546)

Fixes #1202",NEWS.md;R/namespace.R;R/object-from-call.R;tests/testthat/test-object-from-call.R;tests/testthat/test-object-s3.R,False,True,True,False,53,18,71,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* `@exportS3Method` provides the needed metadata to generate correct usage
+  for S3 methods, just like `@method` (#1202).
+
 * If you document a function from another package it is automatically 
   imported. Additionally, if you set `@rdname` or `@name` you can opt out 
   of the default `reexports` topic generation and provide your own docs 

---FILE: R/namespace.R---
@@ -207,7 +207,7 @@ roxy_tag_ns.roxy_tag_exportS3Method <- function(x, block, env) {
 
     method <- attr(obj$value, ""s3method"")
   } else if (length(x$val) == 1) {
-    if (!inherits(obj, ""function"")) {
+    if (!inherits(obj, ""function"") && !inherits(obj, ""s3method"")) {
       warn_roxy_tag(x, ""must be used with a function"")
       return()
     }

---FILE: R/object-from-call.R---
@@ -71,7 +71,7 @@ object_from_name <- function(name, env, block) {
   } else if (is.function(value)) {
     # Potential S3 methods/generics need metadata added
     method <- block_get_tag_value(block, ""method"")
-    value <- add_s3_metadata(value, name, env, method)
+    value <- add_s3_metadata(value, name, env, block)
     if (inherits(value, ""s3generic"")) {
       type <- ""s3generic""
     } else if (inherits(value, ""s3method"")) {
@@ -185,8 +185,7 @@ parser_setMethodS3 <- function(call, env, block) {
   class <- as.character(call[[3]])
   name <- paste(method, class, sep = ""."")
 
-  method <- block_get_tag_value(block, ""method"")
-  value <- add_s3_metadata(get(name, env), name, env, method)
+  value <- add_s3_metadata(get(name, env), name, env, block)
 
   object(value, name, ""s3method"")
 }
@@ -199,10 +198,19 @@ parser_setConstructorS3 <- function(call, env, block) {
 
 # helpers -----------------------------------------------------------------
 
-# @param override Either NULL to use default, or a character vector of length 2
-add_s3_metadata <- function(val, name, env, override = NULL) {
-  if (!is.null(override)) {
-    return(s3_method(val, override))
+add_s3_metadata <- function(val, name, env, block) {
+  if (block_has_tags(block, ""method"")) {
+    method <- block_get_tag_value(block, ""method"")
+    return(s3_method(val, method))
+  }
+
+  if (block_has_tags(block, ""exportS3Method"")) {
+    method <- block_get_tag_value(block, ""exportS3Method"")
+    if (length(method) == 1 && str_detect(method, ""::"")) {
+      generic <- strsplit(method, ""::"")[[1]][[2]]
+      class <- gsub(paste0(""^"", generic, ""\\.""), """", name)
+      return(s3_method(val, c(generic, class)))
+    }
   }
 
   if (is_s3_generic(name, env)) {

---FILE: tests/testthat/test-object-from-call.R---
@@ -127,6 +127,39 @@ test_that(""finds function created with delayed assignment"", {
   expect_s3_class(obj, ""function"")
 })
 
+# S3 ----------------------------------------------------------------------
+
+test_that(""can derive S3 metadata for base generics"", {
+  block <- ""
+    #' @export
+    mean.foo <- function(...) 1
+  ""
+  out <- parse_text(block)[[1]]
+
+  expect_equal(s3_method_info(out$object$value), c(""mean"", ""foo""))
+})
+
+test_that(""@method overrides auto-detection"", {
+  block <- ""
+    #' @export
+    #' @method all.equal data.frame
+    all.equal.data.frame <- function(...) 1
+  ""
+  out <- parse_text(block)[[1]]
+
+  expect_equal(s3_method_info(out$object$value), c(""all.equal"", ""data.frame""))
+})
+
+test_that(""exportS3Method registers S3 metadata"", {
+  block <- ""
+    #' @exportS3Method stats::median
+    median.foo <- function(...) 1
+  ""
+  out <- parse_text(block)[[1]]
+  expect_equal(s3_method_info(out$object$value), c(""median"", ""foo""))
+})
+
+
 # S4 ----------------------------------------------------------------------
 
 test_that(""finds S4 and RC classes"", {
@@ -184,6 +217,7 @@ test_that(""finds arguments when S4 method wrapped inside .local()"", {
   expect_named(formals(obj$value@.Data), c(""x"", ""foo"", ""...""))
 })
 
+
 # R.oo / R.methodsS3 ------------------------------------------------------
 
 test_that(""can define constructor with R.oo"", {

---FILE: tests/testthat/test-object-s3.R---
@@ -50,13 +50,3 @@ test_that(""user defined functions override primitives"", {
   expect_false(is_s3_generic(""c""))
   expect_false(is_s3_method(""c""))
 })
-
-test_that(""@method overrides auto-detection"", {
-  out <- parse_text(""
-    #' @export
-    #' @method all.equal data.frame
-    all.equal.data.frame <- function(...) 1
-  "")[[1]]
-
-  expect_equal(s3_method_info(out$object$value), c(""all.equal"", ""data.frame""))
-})"
r-lib,roxygen2,b494e23240ffb2ee955f0065b99fcdbf7e1a38b7,Hadley Wickham,h.wickham@gmail.com,2023-11-21T20:45:36Z,GitHub,noreply@github.com,2023-11-21T20:45:36Z,"Re-exports improvements (#1545)

* Automatically import the function
* Opt-out of default behaviour by setting `name` or `@rdname`.

Fixes #1408",NEWS.md;R/object-defaults.R;tests/testthat/test-object-defaults.R;tests/testthat/test-object-import.R,False,True,True,False,66,3,69,"---FILE: NEWS.md---
@@ -1,5 +1,10 @@
 # roxygen2 (development version)
 
+* If you document a function from another package it is automatically 
+  imported. Additionally, if you set `@rdname` or `@name` you can opt out 
+  of the default `reexports` topic generation and provide your own docs 
+  (#1408).
+
 * The NAMESPACE roclet now reports if you have S3 methods that are missing
   an `@export` tag. All S3 methods need to be `@export`ed (which confusingly
   really registers the method) even if the generic is not. This avoids rare,

---FILE: R/object-defaults.R---
@@ -74,7 +74,16 @@ object_defaults.package <- function(x, block) {
 
 #' @export
 object_defaults.import <- function(x, block) {
+
+  importFrom <- roxy_generated_tag(block, ""importFrom"", c(x$value$pkg, x$value$fun))
+
+  if (block_has_tags(block, c(""rdname"", ""name""))) {
+    obj <- object_from_name(x$value$fun, asNamespace(x$value$pkg), block)
+    return(c(list(importFrom), object_defaults(obj, block)))
+  }
+
   list(
+    importFrom,
     roxy_generated_tag(block, ""docType"", ""import""),
     roxy_generated_tag(block, ""name"", ""reexports""),
     roxy_generated_tag(block, ""keywords"", ""internal""),

---FILE: tests/testthat/test-object-defaults.R---
@@ -43,6 +43,50 @@ test_that(""@docType class automatically added to reference class objects"", {
   expect_equal(out$get_value(""docType""), ""class"")
 })
 
+
+# imports -----------------------------------------------------------------
+
+test_that(""only generates re-exports if no @name or @rdname"", {
+  block <- ""
+    #' @export
+    stats::median
+  ""
+  out <- roc_proc_text(rd_roclet(), block)[[1]]
+  expect_equal(out$get_value(""name""), ""reexports"")
+  expect_equal(out$get_value(""keyword""), ""internal"")
+
+  block <- ""
+    #' Title
+    #' @name stats-imports
+    #' @export
+    stats::median
+
+    #' @rdname stats-imports
+    stats::acf
+  ""
+  out <- roc_proc_text(rd_roclet(), block)[[1]]
+  expect_equal(out$get_value(""name"")[[1]], ""stats-imports"")
+  expect_equal(out$get_value(""alias""), c(""stats-imports"", ""median"", ""acf""))
+  expect_equal(out$get_value(""keyword""), NULL)
+})
+
+test_that(""imports are automatically imported"", {
+  block <- ""
+    #' @export
+    stats::median
+  ""
+  out <- roc_proc_text(namespace_roclet(), block)
+  expect_equal(out, c(""export(median)"", ""importFrom(stats,median)""))
+
+  block <- ""
+    #' @export
+    #' @name foo
+    stats::median
+  ""
+  out <- roc_proc_text(namespace_roclet(), block)
+  expect_equal(out, c(""export(median)"", ""importFrom(stats,median)""))
+})
+
 # packages -----------------------------------------------------------------
 
 test_that(""can create package documentation"", {

---FILE: tests/testthat/test-object-import.R---
@@ -1,16 +1,21 @@
 test_that(""exporting a call to :: produces re-exports documentation"", {
-  out <- roc_proc_text(rd_roclet(), ""
+  block <- ""
     #' @export
-    testthat::auto_test"")[[1]]
+    testthat::auto_test
+  ""
+  out <- roc_proc_text(rd_roclet(), block)[[1]]
 
   expect_equal(
     out$get_section(""reexport""),
     rd_section_reexport(""testthat"", ""auto_test"", ""auto_test"")
   )
   expect_equal(out$get_value(""title""), ""Objects exported from other packages"")
   expect_equal(out$get_value(""keyword""), ""internal"")
-
   expect_snapshot_output(cat(format(out)))
+
+  # And generates correct namespace definitions
+  out <- roc_proc_text(namespace_roclet(), block)
+  expect_equal(out, c(""export(auto_test)"", ""importFrom(testthat,auto_test)""))
 })
 
 test_that(""multiple re-exports are combined"", {"
r-lib,roxygen2,2d54bb2d920964547c88f7742e4e700cdf956568,Hadley Wickham,h.wickham@gmail.com,2023-11-21T19:44:41Z,Hadley Wickham,h.wickham@gmail.com,2023-11-21T19:44:41Z,"Add footnote clarifying `@rdname` destination

Fixes #1286",vignettes/reuse.Rmd,True,False,True,False,4,1,5,"---FILE: vignettes/reuse.Rmd---
@@ -37,10 +37,13 @@ Use it when all functions have the same (or very similar) arguments.
 
 ### `@rdname`
 
-Use `@rdname <destination>` to include multiple functions in the same page.
+Use `@rdname <destination>`[^1] to include multiple functions in the same page.
 Tags (e.g. `@title`, `@description`, `@examples`) will be combined, across blocks but often this yields text that is hard to understand.
 So we recommend that you make one block that contains the title, description, common parameters, examples and so on, and then only document individual parameters in the other blocks.
 
+[^1]: The destination is a topic name.
+    There's a one-to-one correspondence between topic names and `.Rd` files where a topic called `foo` will produce a file called `man/foo.Rd`.
+
 There are two basic ways to do that.
 You can create a standalone documentation block and then add the functions to it.
 This typically works best when you have a family of related functions and you want to link to that family from other functions (i.e. `trig` in the examples below)."
r-lib,roxygen2,7bd492f58964ad3bbebac5b6479b38fde0eaf45d,Hadley Wickham,h.wickham@gmail.com,2023-11-21T18:21:31Z,GitHub,noreply@github.com,2023-11-21T18:21:31Z,"Improve S3 method handling (#1534)

* Warn if S3 methods aren't ""exported"" and export a bunch of roxygen2 methods thus revealed. Fixes #1175
* Improve docs for method ""export"".  Fixes #1451",NAMESPACE;NEWS.md;R/block.R;R/namespace.R;R/parse.R;R/rd-usage.R;R/rd.R;R/tag.R;R/utils-warn.R;man/roxy_tag.Rd;tests/testthat/_snaps/namespace.md;tests/testthat/test-namespace.R;vignettes/namespace.Rmd,True,True,True,False,214,56,270,"---FILE: NAMESPACE---
@@ -77,6 +77,12 @@ S3method(object_name,s3generic)
 S3method(object_name,s3method)
 S3method(object_name,s4generic)
 S3method(object_name,s4method)
+S3method(object_usage,""function"")
+S3method(object_usage,data)
+S3method(object_usage,default)
+S3method(object_usage,s3method)
+S3method(object_usage,s4generic)
+S3method(object_usage,s4method)
 S3method(print,object)
 S3method(print,rd)
 S3method(print,rd_section)
@@ -162,6 +168,7 @@ S3method(roxy_tag_parse,roxy_tag_templateVar)
 S3method(roxy_tag_parse,roxy_tag_title)
 S3method(roxy_tag_parse,roxy_tag_usage)
 S3method(roxy_tag_parse,roxy_tag_useDynLib)
+S3method(roxy_tag_rd,default)
 S3method(roxy_tag_rd,roxy_tag_.formals)
 S3method(roxy_tag_rd,roxy_tag_.methods)
 S3method(roxy_tag_rd,roxy_tag_.reexport)

---FILE: NEWS.md---
@@ -1,5 +1,10 @@
 # roxygen2 (development version)
 
+* The NAMESPACE roclet now reports if you have S3 methods that are missing
+  an `@export` tag. All S3 methods need to be `@export`ed (which confusingly
+  really registers the method) even if the generic is not. This avoids rare,
+  but hard to debug, problems (#1175).
+
 * `@include` now gives an informative warning if you use a path that doesn't
   exist (#1497).
 

---FILE: R/block.R---
@@ -289,9 +289,3 @@ parse_description <- function(tags) {
 
   c(compact(list(title, description, details)), tags)
 }
-
-warn_roxy_block <- function(block, message, ...) {
-  message[[1]] <- paste0(link_to(block$file, block$line), "": "", message[[1]], ""."")
-  names(message)[[1]] <- ""x""
-  cli::cli_inform(message, ..., .envir = parent.frame())
-}

---FILE: R/namespace.R---
@@ -32,6 +32,8 @@ namespace_roclet <- function() {
 
 #' @export
 roclet_process.roclet_namespace <- function(x, blocks, env, base_path) {
+  warn_missing_s3_exports(blocks, env)
+
   blocks_to_ns(blocks, env)
 }
 
@@ -376,3 +378,20 @@ repeat_first_ignore_current <- function(name, x) {
     repeat_first(name, x)
   }
 }
+
+# missing s3 exports ------------------------------------------------------
+
+warn_missing_s3_exports <- function(blocks, env) {
+  objs <- as.list(env)
+  funs <- Filter(is.function, objs)
+  methods <- funs[map_lgl(names(funs), is_s3_method, env = env)]
+
+  s3blocks <- blocks[map_lgl(blocks, block_has_tags, c(""export"", ""exportS3method""))]
+  s3objects <- map(blocks, function(block) block$object$value)
+
+  undocumented <- methods[!methods %in% s3objects]
+  srcrefs <- map(undocumented, attr, ""srcref"")
+  messages <- paste0(""S3 method `"", names(undocumented) , ""` needs @export or @exportS3method tag"")
+  map2(undocumented, messages, warn_roxy_function)
+}
+

---FILE: R/parse.R---
@@ -67,7 +67,7 @@ env_file <- function(file) {
   env <- new.env(parent = parent.env(globalenv()))
   methods::setPackageName(""roxygen_devtest"", env)
 
-  sys.source(file, envir = env)
+  sys.source(file, envir = env, keep.source = TRUE)
   env
 }
 

---FILE: R/rd-usage.R---
@@ -26,20 +26,24 @@ object_usage <- function(x) {
   UseMethod(""object_usage"")
 }
 
+#' @export
 object_usage.default <- function(x) {
   NULL
 }
 
+#' @export
 object_usage.data <- function(x) {
   rd(x$alias)
 }
 
+#' @export
 object_usage.function <- function(x) {
   function_usage(x$alias, formals(x$value), identity)
 }
 
 object_usage.s3generic <- object_usage.function
 
+#' @export
 object_usage.s3method <- function(x) {
   method <- attr(x$value, ""s3method"")
   s3method <- function(name) {
@@ -48,10 +52,12 @@ object_usage.s3method <- function(x) {
   function_usage(method[1], formals(x$value), s3method)
 }
 
+#' @export
 object_usage.s4generic <- function(x) {
   function_usage(x$value@generic, formals(x$value), identity)
 }
 
+#' @export
 object_usage.s4method <- function(x) {
   s4method <- function(name) {
     classes <- auto_backtick(as.character(x$value@defined))

---FILE: R/rd.R---
@@ -226,6 +226,7 @@ roxy_tag_rd <- function(x, base_path, env) {
   UseMethod(""roxy_tag_rd"")
 }
 
+#' @export
 roxy_tag_rd.default <- function(x, base_path, env) {
 }
 

---FILE: R/tag.R---
@@ -116,23 +116,3 @@ roxy_tag_warning <- function(x, ...) {
   warning(message, call. = FALSE, immediate. = TRUE)
   NULL
 }
-
-#' @export
-#' @rdname roxy_tag
-warn_roxy_tag <- function(tag, message, ...) {
-  message[[1]] <- paste0(
-    link_to(tag$file, tag$line), "": {.strong @"", tag$tag, ""} "",
-    if (is.null(tag$raw)) (""(automatically generated) ""),
-    message[[1]], "".""
-  )
-  names(message)[[1]] <- ""x""
-  cli::cli_inform(message, ..., .envir = parent.frame())
-}
-
-link_to <- function(file, line) {
-  cli::style_hyperlink(
-    paste0(basename(file), "":"", line),
-    paste0(""file://"", file),
-    params = c(line = line, col = 1)
-  )
-}

---FILE: R/utils-warn.R---
@@ -0,0 +1,34 @@
+
+#' @export
+#' @rdname roxy_tag
+warn_roxy_tag <- function(tag, message, parent = NULL, envir = parent.frame()) {
+  tag_name <- cli::format_inline(""{.strong @{tag$tag}} "")
+  if (is.null(tag$raw)) tag_name <- paste(tag_name, ""(automatically generated) "")
+  message[[1]] <- paste0(tag_name, message[[1]])
+
+  warn_roxy(tag$file, tag$line, message, parent = parent, envir = envir)
+}
+
+warn_roxy_block <- function(block, message, parent = NULL, envir = parent.frame()) {
+  warn_roxy(block$file, block$line, message, parent = parent, envir = envir)
+}
+
+warn_roxy_function <- function(fun, message, parent = NULL, envir = parent.frame()) {
+  srcref <- attr(fun, ""srcref"")
+  file <- attr(srcref, ""srcfile"")$filename
+  line <- as.vector(srcref)[[1]]
+
+  warn_roxy(file, line, message, parent = parent, envir = envir)
+}
+
+warn_roxy <- function(file, line, message, parent = NULL, envir = parent.frame()) {
+  link <- cli::style_hyperlink(
+    paste0(basename(file), "":"", line),
+    paste0(""file://"", file),
+    params = c(line = line, col = 1)
+  )
+
+  message[[1]] <- paste0(link, "": "", message[[1]], ""."")
+  names(message)[[1]] <- ""x""
+  cli::cli_inform(message, parent = parent, .envir = envir)
+}

---FILE: man/roxy_tag.Rd---
@@ -1,5 +1,5 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/tag.R
+% Please edit documentation in R/tag.R, R/utils-warn.R
 \name{roxy_tag}
 \alias{roxy_tag}
 \alias{roxy_tag_parse}
@@ -13,7 +13,7 @@ roxy_tag_parse(x)
 
 roxy_tag_warning(x, ...)
 
-warn_roxy_tag(tag, message, ...)
+warn_roxy_tag(tag, message, parent = NULL, envir = parent.frame())
 }
 \arguments{
 \item{tag}{Tag name. Arguments starting with \code{.} are reserved for internal

---FILE: tests/testthat/_snaps/namespace.md---
@@ -99,3 +99,14 @@
     Code
       out <- roc_proc_text(namespace_roclet(), block)
 
+# warns if S3 method not documented
+
+    Code
+      roc_proc_text(namespace_roclet(),
+      ""\n      foo <- function(x) UseMethod('foo')\n      foo.numeric <- function(x) 1\n\n      mean.myclass <- function(x) 2\n    "")
+    Message
+      x <text>:5: S3 method `mean.myclass` needs @export or @exportS3method tag.
+      x <text>:3: S3 method `foo.numeric` needs @export or @exportS3method tag.
+    Output
+      character(0)
+

---FILE: tests/testthat/test-namespace.R---
@@ -419,3 +419,29 @@ test_that(""Invalid imports throw a helpful error"", {
   expect_equal(out, ""importFrom(AnUnknownUnavailablePackage,Unchecked)"")
 
 })
+
+
+# warn_missing_s3_exports -------------------------------------------------
+
+test_that(""warns if S3 method not documented"", {
+  expect_snapshot(
+    roc_proc_text(namespace_roclet(), ""
+      foo <- function(x) UseMethod('foo')
+      foo.numeric <- function(x) 1
+
+      mean.myclass <- function(x) 2
+    ""),
+    # Need to manually transform since the srcref is coming from the function;
+    # roc_proc_text() uses fake srcrefs for the blocks themselves
+    transform = function(x) gsub(""file[a-z0-9]+"", ""<text>"", x)
+  )
+})
+
+test_that(""doesn't warn for potential false postives"", {
+  roc <- namespace_roclet()
+  expect_no_warning({
+    roc_proc_text(roc, ""foo.numeric <- function(x) 1"")
+    roc_proc_text(roc, ""is.numeric <- function(x) 1"")
+    roc_proc_text(roc, ""as.numeric <- function(x) 1"")
+  })
+})

---FILE: vignettes/namespace.Rmd---
@@ -19,53 +19,118 @@ This is a little frustrating at first, but soon becomes second-nature.
 
 ## Exports
 
-For a function to be usable outside your package, you must **export** it.
-By default roxygen2 doesn't export anything from your package.
-If you want an object to be publicly available, you must explicitly tag it with `@export`.
+In order for your users to use a function[^1] in your package, you must **export** it.
+In most cases, you can just use the `@export` tag, and roxygen2 will automatically figure out which `NAMESPACE` directive (i.e. `export()`, `exportS3method()`, `exportClasses()`, or`exportMethods()`) you need.
 
-Use the following guidelines to decide what to export:
+[^1]: Including S3 and S4 generics and methods.
 
--   **Functions**: export functions that you want to make available.
-    Exported functions must be documented, and you must be cautious when changing their interface.
+Note that datasets should never be exported as they are not found in `NAMESPACE`.
+Instead, datasets will either be automatically exported if you set `LazyData: true` in your `DESCRIPTION`, or made available after calling `data()` if not.
 
--   **Datasets**: all datasets are publicly available.
-    They exist outside of the package namespace and must not be exported.
+### Functions
 
--   **S3 classes**: if you want others to be able to create instances of the class `@export` the constructor function.
+A function should be exported if it is user facing; it should not be exported if it's for internal use only.
+If you export a function, you must also document it, and since other people will use it, you need to be careful if you later change the function interface.
 
--   **S3 generics**: the generic is a function, so `@export` if you want it to be usable outside the package.
+```{r}
+#' Add two numbers together
+#' 
+#' @param x,y A pair of numbers.
+#' @export
+add <- function(x, y) {
+  x + y
+}
+```
 
--   **S3 methods**: every S3 method *must* be exported, even if the generic is not.
-    Otherwise, the S3 method table will not be generated correctly and internal generics will not find the correct method.
-    See below for instructions on how to export a method for a generic in a suggested package.
+### S3
 
--   **S4 classes**: export S4 classes if you want others to be able to extend them.
+An S3 generic works like a regular R function so export it following the advice above: if you want users to call it, export; otherwise, don't.
 
--   **S4 generics:** `@export` if you want the generic to be publicly usable.
+```{r}
+#' Take an object to bizarro world
+#' 
+#' @param x A vector.
+#' @export
+bizarro <- function(x, ...) {
+  UseMethod(""bizarro"")
+}
+```
 
--   **S4 methods**: you only need to `@export` methods for generics in other packages.
+While S3 methods are regular functions with a special naming scheme, their ""export"" works a bit differently.
+S3 methods are exported only in the sense that calling the generic with the appropriate class will call the method; a user can't directly access the method definition by typing its name.
+A more technically correctly term would be to say that the method is **registered** so that the generics can find it.
 
-### S3 methods for generics in suggested packages
+You must register, i.e. `@export`, every S3 method regardless of whether or not the generic is exported.
+roxygen2 will warn you if you have forgotten.
 
-`@exportS3Method` tag allows you to generate `S3method()` namespace directives.
-Its primary use is for ""delayed"" method registration, which allows you to define methods for generics found in suggested packages (R \>= 3.6).
-For example,
+```{r}
+#' @export
+bizarro.character <- function(x, ...) {
+  letters <- strsplit(x, """")
+  letters_rev <- lapply(letters, rev)
+  vapply(letters_rev, paste, collapse = """", FUN.VALUE = character(1))
+}
+```
+
+You have four options for documenting an S3 method:
+
+-   Don't document it; it's not required, and not needed for simple generics where the user won't care about the details.
+-   If the method is particularly complex or has many arguments that the generic does not, you can document it in its own file. In this case, just document it as if it's a function.
+-   You can use `@rdname` to document it with other methods for the generic. This is a good option if it's your generic, and you're providing a bunch of methods for different classes.
+-   You can use `@rdname` to document it with other methods for the class. This is typically the least appealing option because the different generics will have different arguments, leading to a cluttered and potentially confusing page.
+
+```{r}
+#' Take an object to bizarro world
+#' 
+#' @description
+#' This is an S3 generic. This package provides methods for the 
+#' following classes:
+#' 
+#' * `character`: reverses the order of the letters in each element of 
+#'    the vector.
+#' 
+#' @param x A vector.
+#' @export
+bizarro <- function(x, ...) {
+  UseMethod(""bizarro"")
+}
+
+#' @export
+#' @rdname bizarro
+bizarro.character <- function(x, ...) {
+  letters <- strsplit(x, """")
+  letters_rev <- lapply(letters, rev)
+  vapply(letters_rev, paste, collapse = """", FUN.VALUE = character(1))
+}
+```
+
+Typically, you will write methods for generics that are either defined in the current package or a package that is a hard dependency[^2] of your package.
+Sometimes, however, you will want to write a method for a suggested dependency.
+In this case, `@export` will not work because it assumes the generic is included or imported in your `NAMESPACE`. Instead, use `@exportS3Method`. This will use ""delayed"" method registration, which means the method will only be registered when the suggested package is loaded.
+
+[^2]: i.e. it is listed in either the `Imports` or `Depends` fields in your `DESCRIPTION`.
+
+To use `@exportS3Method` you must provide the package and generic name in the following format:
 
 ```{r}
 #' @exportS3Method pkg::generic
 generic.foo <- function(x, ...) {
 }
 ```
 
-will generate
+### S4
+
+-   **Classes**: export the class object if you want others to be able to extend it.
 
-    S3method(pkg::generic, foo)
+-   **Generics:** treat it like a function and `@export` if user facing.
 
-Which will cause the method to be registered only when pkg is loaded.
+-   **Methods**: you only need to `@export` a method, if the generic lives in another package.
+    Unlike S3, you must document S4 methods.
+    Because method details are often not that important, it's common to use `@rdname` to put the documentation for unimportant methods into a single topic with `@keywords internal`.
 
 ### Manual exports
 
-If `@export` does not automatically generate the correct directive when, you can use one of the tags below to exercise greater control:
+If `@export` does not automatically generate the correct `NAMESPACE` directive, you can use one of the tags below to exercise greater control:
 
 -   `@export foo` generates `export(foo)`
 -   `@exportS3Method generic method` generates `S3method(generic, method)`
@@ -74,8 +139,18 @@ If `@export` does not automatically generate the correct directive when, you can
 -   `@exportPattern foo` generates `exportPattern(foo)`
 
 For even more specialised cases you can use `@rawNamespace code` which inserts `code` literally into the `NAMESPACE`.
+This is useful if you need a conditional import or export, e.g.
+
+```{r}
+# From dplyr:
+#' @rawNamespace import(vctrs, except = data_frame)
+
+# From backports:
+#' @rawNamespace if (getRversion() < ""4.0.0"") export(stopifnot)
+```
+
 If you need to automate this, `@evalNamespace fun()` will evaluate `fun()` in the package environment and insert the results into `NAMESPACE`.
-Because `evalNamespace()` is run in the package environment, it can only generate exports, not imports.
+Note that because `evalNamespace()` is run in the package environment, it can only generate exports, not imports.
 
 ## Imports
 
@@ -85,15 +160,15 @@ The `NAMESPACE` also controls which functions from other packages are made avail
 
 If you are using just a few functions from another package, we recommending adding the package to the `Imports:` field of the `DESCRIPTION` file and calling the functions explicitly using `::`, e.g., `pkg::fun()`.
 
-```r
+``` r
 my_function <- function(x, y) {
   pkg::fun(x) * y
 }
 ```
 
 If the repetition of the package name becomes annoying you can `@importFrom` and drop the `::`:
 
-```r
+``` r
 #' @importFrom pkg fun 
 my_function <- function(x, y) {
   fun(x) * y"
r-lib,roxygen2,b8607815c68332f3922e7cd8961de3bc42c3d301,Hadley Wickham,h.wickham@gmail.com,2023-11-21T18:05:02Z,GitHub,noreply@github.com,2023-11-21T18:05:02Z,"Give informative warning for bad `@include` (#1544)

Fixes #1497",NEWS.md;R/collate.R;tests/testthat/_snaps/collate.md;tests/testthat/test-collate.R,False,True,True,False,39,1,40,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* `@include` now gives an informative warning if you use a path that doesn't
+  exist (#1497).
+
 * The `NAMESPACE` roclet once again regenerates imports _before_ loading 
   package code and parsing roxygen blocks. This has been the goal for a long 
   time (#372), but we accidentally broke it when adding support for code 

---FILE: R/collate.R---
@@ -53,7 +53,8 @@ update_collate <- function(base_path) {
 
 generate_collate <- function(base_path) {
   paths <- sort_c(dir(base_path, pattern = ""[.][Rr]$"", full.names = TRUE))
-  includes <- lapply(paths, function(x) intersect(find_includes(x), basename(paths)))
+
+  includes <- lapply(paths, find_and_filter_includes, paths = basename(paths))
   names(includes) <- paths
 
   n <- sum(map_int(includes, length))
@@ -72,6 +73,22 @@ generate_collate <- function(base_path) {
   topo$sort()
 }
 
+find_and_filter_includes <- function(path, paths) {
+  includes <- find_includes(path)
+
+  invalid <- setdiff(includes, paths)
+  if (length(invalid) > 0) {
+    for (include in invalid) {
+      path <- cli::style_hyperlink(basename(path), paste0(""file://"", path))
+      cli::cli_inform(c(
+        x = ""{path}: unknown path in `@include {invalid}`.""
+      ))
+    }
+  }
+
+  intersect(includes, paths)
+}
+
 base_path <- function(path, base) {
   path <- normalizePath(path, winslash = ""/"")
   base <- normalizePath(base, winslash = ""/"")

---FILE: tests/testthat/_snaps/collate.md---
@@ -16,3 +16,11 @@
       # Second run should be idempotent
       update_collate(path)
 
+# drops bad collect directives
+
+    Code
+      update_collate(""."")
+    Message
+      x a.R: unknown path in `@include foo`.
+      Updating collate directive in './DESCRIPTION'
+

---FILE: tests/testthat/test-collate.R---
@@ -31,6 +31,16 @@ test_that(""DESCRIPTION file is re-written only if collate changes"", {
   }, transform = function(x) gsub(path, ""<path>"", x, fixed = TRUE))
 })
 
+test_that(""drops bad collect directives"", {
+  path <- local_package_copy(test_path(""empty""))
+  write_lines(c(""#' @include foo"", ""NULL""), file.path(path, ""R"", ""a.R""))
+  write_lines(c(""#' @include a.R"", ""NULL""), file.path(path, ""R"", ""b.R""))
+  unlink(file.path(path, ""R/empty-package.R""))
+
+  withr::with_dir(path, expect_snapshot(update_collate(""."")))
+  expect_equal(desc::desc_get_collate(file = path), c(""a.R"", ""b.R""))
+})
+
 test_that(""can read from file name with utf-8 path"", {
   path <- withr::local_tempfile(
     pattern = ""Universit\u00e0-"","
r-lib,roxygen2,1ea43c9237e9d10bdf70ae023956396862f87d3c,Hadley Wickham,h.wickham@gmail.com,2023-11-21T17:50:08Z,GitHub,noreply@github.com,2023-11-21T17:50:08Z,"Special case imports code to run first (#1538)

This effectively makes the preprocess method irrelevant, but there's no much point in removing it since there are so few extension authors.

Fixes #1144",NAMESPACE;NEWS.md;R/namespace.R;R/roxygenize.R;tests/testthat/_snaps/namespace.md;tests/testthat/_snaps/roxygenize.md;tests/testthat/broken-namespace/DESCRIPTION;tests/testthat/broken-namespace/NAMESPACE;tests/testthat/broken-namespace/R/x.R;tests/testthat/test-namespace.R;tests/testthat/test-roxygenize.R,False,True,True,False,134,71,205,"---FILE: NAMESPACE---
@@ -88,7 +88,6 @@ S3method(roclet_output,roclet_namespace)
 S3method(roclet_output,roclet_rd)
 S3method(roclet_output,roclet_vignette)
 S3method(roclet_preprocess,default)
-S3method(roclet_preprocess,roclet_namespace)
 S3method(roclet_process,roclet_namespace)
 S3method(roclet_process,roclet_rd)
 S3method(roclet_process,roclet_vignette)

---FILE: NEWS.md---
@@ -1,5 +1,12 @@
 # roxygen2 (development version)
 
+* The `NAMESPACE` roclet once again regenerates imports _before_ loading 
+  package code and parsing roxygen blocks. This has been the goal for a long 
+  time (#372), but we accidentally broke it when adding support for code 
+  execution in markdown blocks. This resolves a family of problems where you
+  somehow bork your `NAMESPACE` and can't easily get out of it because you
+  can't re-document the package because your code doesn't reload.
+
 * `escape_examples()` is now exported (#1450).
 
 * `@docType package` now works more like documenting `""_PACKAGE""`, 

---FILE: R/namespace.R---
@@ -30,22 +30,6 @@ namespace_roclet <- function() {
   roclet(""namespace"")
 }
 
-#' @export
-roclet_preprocess.roclet_namespace <- function(x, blocks, base_path) {
-  lines <- blocks_to_ns(blocks, emptyenv(), import_only = TRUE)
-  NAMESPACE <- file.path(base_path, ""NAMESPACE"")
-
-  if (length(lines) == 0 && !made_by_roxygen(NAMESPACE)) {
-    return(x)
-  }
-
-  lines <- c(lines, namespace_exports(NAMESPACE))
-  results <- c(made_by(""#""), sort_c(unique(lines)))
-  write_if_different(NAMESPACE, results, check = TRUE)
-
-  invisible(x)
-}
-
 #' @export
 roclet_process.roclet_namespace <- function(x, blocks, env, base_path) {
   blocks_to_ns(blocks, env)
@@ -71,27 +55,87 @@ roclet_clean.roclet_namespace <- function(x, base_path) {
   }
 }
 
+# NAMESPACE updates -------------------------------------------------------
+
+import_directives <- c(
+  ""import"",
+  ""importFrom"",
+  ""importClassesFrom"",
+  ""importMethodsFrom"",
+  ""useDynLib""
+)
+
+update_namespace_imports <- function(base_path) {
+  NAMESPACE <- file.path(base_path, ""NAMESPACE"")
+  if (!made_by_roxygen(NAMESPACE) || !file.exists(NAMESPACE)) {
+    return(invisible())
+  }
+
+  lines <- c(namespace_imports(base_path), namespace_exports(NAMESPACE))
+  results <- c(made_by(""#""), sort_c(unique(lines)))
+  write_if_different(NAMESPACE, results, check = TRUE)
+
+  invisible()
+}
+
+# Here we hand roll parsing and tokenisation from roxygen2 primitives so
+# we can filter tags that we know don't require package code.
+namespace_imports <- function(base_path = ""."") {
+  paths <- package_files(base_path)
+  parsed <- lapply(paths, parse, keep.source = TRUE)
+  srcrefs <- lapply(parsed, utils::getSrcref)
+  blocks <- unlist(lapply(srcrefs, namespace_imports_blocks), recursive = FALSE)
+
+  blocks_to_ns(blocks, emptyenv())
+}
+
+namespace_imports_blocks <- function(srcref) {
+  comment_refs <- comments(srcref)
+  tokens <- lapply(comment_refs, tokenise_ref)
+
+  import_tags <- c(import_directives, ""rawNamespace"")
+  tokens_filtered <- lapply(tokens, function(tokens) {
+    tokens[map_lgl(tokens, function(x) x$tag %in% import_tags)]
+  })
+
+  compact(lapply(tokens_filtered, function(tokens) {
+    block_create(
+      call = NULL,
+      srcref = srcref(srcfile(""NAMESPACE""), rep(1, 4)),
+      tokens = tokens
+    )
+  }))
+}
+
+namespace_exports <- function(path) {
+  parsed <- as.list(parse(path, keep.source = TRUE))
+
+  is_import_directive <- function(x) is_call(x, import_directives)
+  export_lines <- attr(parsed, ""srcref"")[!map_lgl(parsed, is_import_directive)]
+  unlist(lapply(export_lines, as.character))
+}
+
 # NAMESPACE generation ----------------------------------------------------
 
-blocks_to_ns <- function(blocks, env, import_only = FALSE) {
-  lines <- map(blocks, block_to_ns, env = env, import_only = import_only)
+blocks_to_ns <- function(blocks, env) {
+  lines <- map(blocks, block_to_ns, env = env)
   lines <- unlist(lines) %||% character()
 
   sort_c(unique(lines))
 }
 
-block_to_ns <- function(block, env, import_only = FALSE) {
-  map(block$tags, roxy_tag_ns, block = block, env = env, import_only = import_only)
+block_to_ns <- function(block, env) {
+  map(block$tags, roxy_tag_ns, block = block, env = env)
 }
 
 # Namespace tag methods ---------------------------------------------------
 
-roxy_tag_ns <- function(x, block, env, import_only = FALSE) {
+roxy_tag_ns <- function(x, block, env) {
   UseMethod(""roxy_tag_ns"")
 }
 
 #' @export
-roxy_tag_ns.default <- function(x, block, env, import_only = FALSE) {
+roxy_tag_ns.default <- function(x, block, env) {
 
 }
 
@@ -100,11 +144,7 @@ roxy_tag_parse.roxy_tag_evalNamespace <- function(x) {
   tag_code(x)
 }
 #' @export
-roxy_tag_ns.roxy_tag_evalNamespace <- function(x, block, env, import_only = FALSE) {
-  if (import_only) {
-    return()
-  }
-
+roxy_tag_ns.roxy_tag_evalNamespace <- function(x, block, env) {
   roxy_tag_eval(x, env)
 }
 
@@ -113,11 +153,7 @@ roxy_tag_parse.roxy_tag_export <- function(x) {
   tag_words_line(x)
 }
 #' @export
-roxy_tag_ns.roxy_tag_export <- function(x, block, env, import_only = FALSE) {
-  if (import_only) {
-    return()
-  }
-
+roxy_tag_ns.roxy_tag_export <- function(x, block, env) {
   if (identical(x$val, """")) {
     # FIXME: check for empty exports (i.e. no name)
     default_export(block$object, block)
@@ -131,11 +167,7 @@ roxy_tag_parse.roxy_tag_exportClass <- function(x) {
   tag_words(x, 1)
 }
 #' @export
-roxy_tag_ns.roxy_tag_exportClass <- function(x, block, env, import_only = FALSE) {
-  if (import_only) {
-    return()
-  }
-
+roxy_tag_ns.roxy_tag_exportClass <- function(x, block, env) {
   export_class(x$val)
 }
 
@@ -144,10 +176,7 @@ roxy_tag_parse.roxy_tag_exportMethod <- function(x) {
   tag_words(x, min = 1)
 }
 #' @export
-roxy_tag_ns.roxy_tag_exportMethod <- function(x, block, env, import_only = FALSE) {
-  if (import_only) {
-    return()
-  }
+roxy_tag_ns.roxy_tag_exportMethod <- function(x, block, env) {
   export_s4_method(x$val)
 }
 
@@ -156,10 +185,7 @@ roxy_tag_parse.roxy_tag_exportPattern <- function(x) {
   tag_words(x, min = 1)
 }
 #' @export
-roxy_tag_ns.roxy_tag_exportPattern <- function(x, block, env, import_only = FALSE) {
-  if (import_only) {
-    return()
-  }
+roxy_tag_ns.roxy_tag_exportPattern <- function(x, block, env) {
   one_per_line(""exportPattern"", x$val)
 }
 
@@ -168,11 +194,7 @@ roxy_tag_parse.roxy_tag_exportS3Method <- function(x) {
   tag_words(x, min = 0, max = 2)
 }
 #' @export
-roxy_tag_ns.roxy_tag_exportS3Method <- function(x, block, env, import_only = FALSE) {
-  if (import_only) {
-    return()
-  }
-
+roxy_tag_ns.roxy_tag_exportS3Method <- function(x, block, env) {
   obj <- block$object
 
   if (identical(x$val, """")) {
@@ -219,7 +241,7 @@ roxy_tag_parse.roxy_tag_import <- function(x) {
   tag_words(x, min = 1)
 }
 #' @export
-roxy_tag_ns.roxy_tag_import <- function(x, block, env, import_only = FALSE) {
+roxy_tag_ns.roxy_tag_import <- function(x, block, env) {
   one_per_line_ignore_current(""import"", x$val)
 }
 
@@ -228,7 +250,7 @@ roxy_tag_parse.roxy_tag_importClassesFrom <- function(x) {
   tag_words(x, min = 2)
 }
 #' @export
-roxy_tag_ns.roxy_tag_importClassesFrom <- function(x, block, env, import_only = FALSE) {
+roxy_tag_ns.roxy_tag_importClassesFrom <- function(x, block, env) {
   repeat_first_ignore_current(""importClassesFrom"", x$val)
 }
 
@@ -237,7 +259,7 @@ roxy_tag_parse.roxy_tag_importFrom <- function(x) {
   tag_words(x, min = 2)
 }
 #' @export
-roxy_tag_ns.roxy_tag_importFrom <- function(x, block, env, import_only = FALSE) {
+roxy_tag_ns.roxy_tag_importFrom <- function(x, block, env) {
   pkg <- x$val[1L]
   if (requireNamespace(pkg, quietly = TRUE)) {
     importing <- x$val[-1L]
@@ -255,7 +277,7 @@ roxy_tag_parse.roxy_tag_importMethodsFrom <- function(x) {
   tag_words(x, min = 2)
 }
 #' @export
-roxy_tag_ns.roxy_tag_importMethodsFrom <- function(x, block, env, import_only = FALSE) {
+roxy_tag_ns.roxy_tag_importMethodsFrom <- function(x, block, env) {
   repeat_first_ignore_current(""importMethodsFrom"", x$val)
 }
 
@@ -264,7 +286,7 @@ roxy_tag_parse.roxy_tag_rawNamespace <- function(x) {
   tag_code(x)
 }
 #' @export
-roxy_tag_ns.roxy_tag_rawNamespace  <- function(x, block, env, import_only = FALSE) {
+roxy_tag_ns.roxy_tag_rawNamespace  <- function(x, block, env) {
   x$raw
 }
 
@@ -273,7 +295,7 @@ roxy_tag_parse.roxy_tag_useDynLib <- function(x) {
   tag_words(x, min = 1)
 }
 #' @export
-roxy_tag_ns.roxy_tag_useDynLib <- function(x, block, env, import_only = FALSE) {
+roxy_tag_ns.roxy_tag_useDynLib <- function(x, block, env) {
   if (length(x$val) == 1) {
     return(paste0(""useDynLib("", auto_quote(x$val), "")""))
   }
@@ -354,14 +376,3 @@ repeat_first_ignore_current <- function(name, x) {
     repeat_first(name, x)
   }
 }
-
-namespace_exports <- function(path) {
-  if (!file.exists(path)) {
-    return(character())
-  }
-
-  parsed <- as.list(parse(path, keep.source = TRUE))
-  is_import <- function(x) is_call(x, c(""import"", ""importFrom"", ""importClassesFrom"", ""importMethodsFrom"", ""useDynLib""))
-  export_lines <- attr(parsed, ""srcref"")[!map_lgl(parsed, is_import)]
-  unlist(lapply(export_lines, as.character))
-}

---FILE: R/roxygenize.R---
@@ -38,12 +38,15 @@ roxygenize <- function(package.dir = ""."",
   lapply(packages, loadNamespace)
 
   roclets <- roclets %||% roxy_meta_get(""roclets"")
-  # Special case collate: it doesn't need to execute code, and must be run
-  # first to ensure that code can be executed
+
+  # To load code, we need a up-to-date Collate field and NAMESPACE
   if (""collate"" %in% roclets) {
     update_collate(base_path)
     roclets <- setdiff(roclets, ""collate"")
   }
+  if (""namespace"" %in% roclets) {
+    update_namespace_imports(base_path)
+  }
 
   if (length(roclets) == 0)
     return(invisible())

---FILE: tests/testthat/_snaps/namespace.md---
@@ -35,6 +35,13 @@
     Message
       x <text>:2: @importFrom must have at least 2 words, not 1.
 
+# can regenerate NAMESPACE even if its broken
+
+    Code
+      update_namespace_imports(path)
+    Message
+      Writing 'NAMESPACE'
+
 # rawNamespace must be valid code
 
     Code

---FILE: tests/testthat/_snaps/roxygenize.md---
@@ -0,0 +1,9 @@
+# can regenerate NAMESPACE even if its broken
+
+    Code
+      roxygenise(path)
+    Message
+      Writing 'NAMESPACE'
+      i Loading brokenNamespace
+      Writing 'NAMESPACE'
+

---FILE: tests/testthat/broken-namespace/DESCRIPTION---
@@ -0,0 +1,3 @@
+Package: brokenNamespace
+Version: 1.0.0
+Encoding: UTF-8

---FILE: tests/testthat/broken-namespace/NAMESPACE---
@@ -0,0 +1,3 @@
+# Generated by roxygen2: do not edit by hand
+
+importFrom(stats,foo)

---FILE: tests/testthat/broken-namespace/R/x.R---
@@ -0,0 +1,5 @@
+#' @importFrom stats median
+NULL
+
+#' @export
+f <- function() {}

---FILE: tests/testthat/test-namespace.R---
@@ -271,10 +271,22 @@ test_that(""empty NAMESPACE generates zero-length vector"", {
   expect_equal(results, character())
 })
 
+test_that(""can regenerate NAMESPACE even if its broken"", {
+  path <- local_package_copy(test_path(""broken-namespace""))
+  expect_snapshot(update_namespace_imports(path))
+
+  expect_equal(
+    read_lines(file.path(path, ""NAMESPACE"")),
+    c(
+      ""# Generated by roxygen2: do not edit by hand"",
+      """",
+      ""importFrom(stats,median)""
+    )
+  )
+})
 
 # Raw ---------------------------------------------------------------------
 
-
 test_that(""rawNamespace must be valid code"", {
   block <- ""
     #' @rawNamespace a +

---FILE: tests/testthat/test-roxygenize.R---
@@ -0,0 +1,4 @@
+test_that(""can regenerate NAMESPACE even if its broken"", {
+  path <- local_package_copy(test_path(""broken-namespace""))
+  expect_snapshot(roxygenise(path))
+})"
r-lib,roxygen2,3c1bf324a3608370ca4193b1f2217a3020c6f813,Hadley Wickham,h.wickham@gmail.com,2023-11-21T14:55:59Z,GitHub,noreply@github.com,2023-11-21T14:55:59Z,"Export `escape_examples()` (#1543)

Fixes #1450",NAMESPACE;NEWS.md;R/rd-examples.R,False,True,True,False,4,0,4,"---FILE: NAMESPACE---
@@ -204,6 +204,7 @@ export(block_get_tags)
 export(block_has_tags)
 export(env_file)
 export(env_package)
+export(escape_examples)
 export(is_s3_generic)
 export(is_s3_method)
 export(load_installed)

---FILE: NEWS.md---
@@ -1,5 +1,7 @@
 # roxygen2 (development version)
 
+* `escape_examples()` is now exported (#1450).
+
 * `@docType package` now works more like documenting `""_PACKAGE""`, 
   creating a `{packagename}-package` alias and clearly suggesting that
   you should switch to `""_PACKAGE""` instead (#1491).

---FILE: R/rd-examples.R---
@@ -77,6 +77,7 @@ format.rd_section_examples <- function(x, ...) {
 #' by R core.
 #'
 #' @keywords internal
+#' @export
 #' @examples
 #' # In examples we automatically escape Rd comments (%):
 #' 100 %% 30"
r-lib,roxygen2,1cad9838cf7254996ddca6d05ffa1cc8c7cc3412,Hadley Wickham,h.wickham@gmail.com,2023-11-21T14:22:15Z,GitHub,noreply@github.com,2023-11-21T14:22:15Z,"Improve docs for inherit tags (#1541)

Fixes #1465",vignettes/reuse.Rmd,True,False,True,False,118,14,132,"---FILE: vignettes/reuse.Rmd---
@@ -21,7 +21,7 @@ roxygen2 provides several ways to avoid repeating yourself in code documentation
 
 -   Combine documentation for closely related functions into a single file with `@describeIn` or `@rdname`.
 
--   Inherit components from another topic with `@inheritParams`, `@inheritSection`, or `@inherit`.
+-   Automatically copy tags with `@inheritParams`, `@inheritSection`, or `@inherit`.
 
 -   Use functions to generate repeated text with inline R code.
 
@@ -110,27 +110,131 @@ add <- function(x, y) x + y
 times <- function(x, y) x * y
 ```
 
-## Inheriting documentation
+## Automatically copy tags
 
-You can inherit documentation from other topics in a few ways:
+If two or more functions share have similarities but are different or complex enough that you don't want to document them in a single file, you can use one of the four `@inherit` tags to automatically copy various components from another topic:
 
--   `@inheritParams source_function` inherits just the parameter documentation from `source_function()`.
+-   `@inheritParams foo` will copy `@param` contents from `foo`.
+-   `@inherit foo` will copy all supported components from `foo`.
+-   `@inheritSection foo {Section title}` will copy the `@section {Section title}` section from `foo`.
+-   `@inheritDotParams foo` will generate documentation for `` by copying the documentation for `foo()`'s arguments.
 
--   `@inherit source_function` will inherit all supported components from `source_function`.
+We think of this as ""inheritance"" rather than just copying, because anything you inherit can be overridden by a more specific definition in the documentation.
+This applies particularly to `@inheritParams` which allows you to copy the documentation for some parameters while documenting others directly.
+We'll focus on this first.
 
-    Alternatively, you can use (e.g.) `@inherit source_function return details` to just inherit the return value and details from `source_function()`.
-    Supported components are `r paste0(""\x60"", roxygen2:::inherit_components, ""\x60"", collapse = "", "")`.
+### Parameters
 
--   `@inheritSection source_function Section title` will inherit the single `@section` called ""Section title"" from `source_function()`.
+The oldest, and most frequently used, inherits tag is `@inheritParams`.
+It's particularly useful when multiple functions use the same argument name for the same task, as you can document the argument once, then inherit those docs elsewhere.
+For example, take the dplyr functions `arrange()`, `mutate()`, and `summarise()` which all have an argument called `.data`.
+`arrange()` is documented like so:
 
--   `@inheritDotParams` automatically generates parameter documentation for `...` for the common case where you pass `...` on to another function.
-    Because you often override some arguments, it comes with a flexible specification for argument selection:
+```{r}
+#' @param .data A data frame, data frame extension (e.g. a tibble), or a
+#'   lazy data frame (e.g. from dbplyr or dtplyr). See *Methods*, below, for
+#'   more details.
+#' @param ... <[`data-masking`][rlang::args_data_masking]> Variables, or
+#'   functions of variables. Use [desc()] to sort a variable in descending
+#'   order.
+arrange <- function(.data, ...) {}
+```
+
+Then `mutate()` and `summarise()` don't need to provide `@param .data` but can instead inherit the documentation from `arrange()`:
+
+```{r}
+#' @inheritParams arrange
+mutate <- function(.data, ...) {}
+
+#' @inheritParams arrange
+summarise <- function(.data, ...) {}
+```
+
+If this was all you wrote it wouldn't be quite right because `mutate()` and `summarise()` would also inherit the documentation for `...`, which has a different interpretation in these functions.
+So, for example, `mutate()` provides its own definition for `...`:
+
+```{r}
+#' @inheritParams arrange
+#' @param ... <[`data-masking`][rlang::args_data_masking]> Name-value pairs.
+#'   The name gives the name of the column in the output.
+#'
+#'   The value can be:
+#'
+#'   * A vector of length 1, which will be recycled to the correct length.
+#'   * A vector the same length as the current group (or the whole data frame
+#'     if ungrouped).
+#'   * `NULL`, to remove the column.
+#'   * A data frame or tibble, to create multiple columns in the output.
+mutate <- function(.data, ...) {}
+```
+
+Note that only the documentation for arguments with the same names are inherited.
+For example, `arrange()` also has a `.by_group` argument.
+Since no other function in dplyr has an argument with this name, its documentation will never be inherited.
+
+### Multiple parameters
+
+Sometimes you document two (or more) tightly coupled parameters together.
+For example, `dplyr::left_join()` has:
+
+```{r}
+#' @param x,y A pair of data frames, data frame extensions (e.g. a tibble), or
+#'   lazy data frames (e.g. from dbplyr or dtplyr). See *Methods*, below, for
+#'   more details.
+```
+
+When joint parameter documentation is inherited, it's all or nothing, i.e. if a function has `@inheritParams left_join` it will only inherit the documentation for `x` and `y` if it has both `x` and `y` arguments and neither is documented by the inheriting function.
+
+### The dot prefix
+
+Many tidyverse functions that accept named arguments in `...` also use a `.` prefix for their own arguments.
+This reduces the risk of an argument going to the wrong place.
+For example, `dplyr::mutate()` has `.by`, `.keep`, `.before`, and `.after` arguments, because if they didn't have that prefix, you wouldn't be able to create new variables called `by`, `keep`, `before`, or `after`.
+We call this pattern the [dot prefix](https://design.tidyverse.org/dots-prefix.html).
+
+This means that an argument with the same meaning can come in one of two forms: with and without the `.`.
+`@inheritParams` knows about this common pattern so ignores a `.` prefix when matching argument name.
+In other words, `.x` will inherit documentation for `x`, and `x` will inherit documentation from `.x`.
+
+### Inheriting other components
+
+You can use `@inherits foo` to inherit the documentation for every supported tag from another topic.
+Currently, `@inherits` supports inheriting the following tags: `r paste0(""\x60"", roxygen2:::inherit_components, ""\x60"", collapse = "", "")`.
+
+By supplying a space separated list of components after the function name, you can also choose to inherit only selected components.
+For example, `@inherit foo returns` would just inherit the `@returns` tag, and `@inherit foo seealso source` would inherit the `@seealso` and `@source` tags.
+
+`@inherit foo sections` will inherit *every* `@section` tag (which can also be specified in markdown by using the top-level heading spec, `#`).
+To inherit a *specific* section from another function, use `@inheritSection foo Section title`.
+For example, all the ""adverbs"" in purrr use `#' @inheritSection safely Adverbs` to inherit a standard section that provides advice on using an adverb in package code.
+
+### Documenting `...`
+
+When your function passes `...` on to another function, it can be useful to inline the documentation for some of the most common arguments.
+This technique is inspired by the documentation for `plot()`, where `...` can take any graphical parameter; `?plot` describes some of the most common arguments so that you don't have to look them up in `?par`.
+
+`@inheritDotParams` has two components: the function to inherit from and the arguments to inherit.
+Since you'll typically only want to document the most important arguments, `@inheritDotParams` comes with a flexible specification for argument selection inspired by `dplyr::select()`:
+
+-   `@inheritDotParams foo` takes all parameters from `foo()`.
+-   `@inheritDotParams foo a b e:h` takes parameters `a`, `b`, and all parameters between `e` and `h`.
+-   `@inheritDotParams foo -x -y` takes all parameters except for `x` and `y`.
+
+### Inheriting from other packages
+
+It's most common to inherit from other documentation topics within the current package, but roxygen2 also supports inheriting documentation from other packages by using `package::function` syntax, e.g.:
+
+-   `@inheritParams package::function`
+
+-   `@inherit package::function`
+
+-   `@inheritSection package::function Section title`
 
-    -   `@inheritDotParams foo` takes all parameters from `foo()`
-    -   `@inheritDotParams foo a b e:h` takes parameters `a`, `b`, and all parameters between `e` and `h`
-    -   `@inheritDotParams foo -x -y` takes all parameters except for `x` and `y`.
+-   `@inheritDotParams package::function`
 
-All of these tags also work to inherit documentation from functions in another package by using `pkg::source_function`.
+When inheriting documentation from another package bear in mind that you're now taking a fairly strong dependency on an external package, and to ensure every developer produces the same documentation you'll need to make sure that they all have the same version of the package installed.
+And if the package changes the name of the topic or section, your documentation will require an update.
+For those reasons, this technique is best used sparingly.
 
 ## Inline code
 "
r-lib,roxygen2,cbe7201cd67a0ccde628c2361c16210618cf9f81,Hadley Wickham,h.wickham@gmail.com,2023-11-21T14:08:32Z,GitHub,noreply@github.com,2023-11-21T14:08:32Z,"Unload packages loaded in tests (#1542)

Prevents issues with looking for dev docs",tests/testthat/test-namespace.R;tests/testthat/test-object-from-call.R;tests/testthat/test-rd.R;tests/testthat/testLazyData/DESCRIPTION,False,True,True,False,9,1,10,"---FILE: tests/testthat/test-namespace.R---
@@ -2,6 +2,7 @@ test_that(""end-to-end NAMESPACE generation works"", {
   path <- local_package_copy(test_path(""testNamespace""))
 
   suppressMessages(roxygenise(path))
+  withr::defer(pkgload::unload(""testNamespace""))
 
   ns <- read_lines(file.path(path, ""NAMESPACE""))
   expect_equal(ns, c(
@@ -262,6 +263,8 @@ test_that(""empty NAMESPACE generates zero-length vector"", {
   base_path <- test_path(""empty"")
 
   env <- pkgload::load_all(base_path, quiet = TRUE)$env
+  withr::defer(pkgload::unload(""empty""))
+
   blocks <- parse_package(base_path, env = env)
 
   results <- roclet_process(namespace_roclet(), blocks, env = env, base_path)

---FILE: tests/testthat/test-object-from-call.R---
@@ -43,13 +43,15 @@ test_that(""finds datasets given by name"", {
 test_that(""can document eager data"", {
   path <- local_package_copy(test_path('testEagerData'))
   suppressMessages(roxygenise(path))
+  withr::defer(pkgload::unload(""testEagerData""))
 
   expect_true(file.exists(file.path(path, ""man/a.Rd"")))
 })
 
 test_that(""can document lazy data"", {
   path <- local_package_copy(test_path('testLazyData'))
   suppressMessages(roxygenise(path))
+  withr::defer(pkgload::unload(""testLazyData""))
 
   expect_true(file.exists(file.path(path, ""man/a.Rd"")))
 })

---FILE: tests/testthat/test-rd.R---
@@ -152,6 +152,7 @@ test_that(""@details NULL"", {
 
 test_that(""can generate nonASCII document"", {
   path <- local_package_copy(test_path('testNonASCII'))
+  withr::defer(pkgload::unload(""testNonASCII""))
 
   expect_snapshot({
     roxygenise(path, roclets = ""rd"")
@@ -169,6 +170,7 @@ test_that(""can generate nonASCII document"", {
 
 test_that(""unicode escapes are ok"", {
   path <- local_package_copy(test_path('testUtf8Escape'))
+  withr::defer(pkgload::unload(""testUtf8Escape""))
 
   expect_snapshot({
     roxygenise(path, roclets = ""rd"")
@@ -187,6 +189,7 @@ test_that(""automatically deletes unused files"", {
   path <- local_package_copy(test_path(""empty""))
   dir.create(file.path(path, ""man""))
   suppressMessages(roxygenise(path))
+  withr::defer(pkgload::unload(""empty""))
 
   write_lines(made_by(""%""), file.path(path, ""man/test.Rd""))
   expect_snapshot(roxygenise(path))

---FILE: tests/testthat/testLazyData/DESCRIPTION---
@@ -1,4 +1,4 @@
-Package: testEagerData
+Package: testLazyData
 Title: Tools to make developing R code easier
 License: GPL-2
 Description:"
r-lib,roxygen2,912778b364ffb768ca556aa03e6f0ad321942093,Hadley Wickham,h.wickham@gmail.com,2023-11-21T13:32:23Z,GitHub,noreply@github.com,2023-11-21T13:32:23Z,"Make `@docType package` work more like `_PACKAGE` (#1535)

While recommending that you update to the newer syntax.

Fixes #1491",NEWS.md;R/object-from-call.R;tests/testthat/_snaps/object-from-call.md;tests/testthat/empty/DESCRIPTION;tests/testthat/test-object-from-call.R;tests/testthat/test-rd-backref.R,False,True,True,False,46,5,51,"---FILE: NEWS.md---
@@ -1,5 +1,9 @@
 # roxygen2 (development version)
 
+* `@docType package` now works more like documenting `""_PACKAGE""`, 
+  creating a `{packagename}-package` alias and clearly suggesting that
+  you should switch to `""_PACKAGE""` instead (#1491).
+
 * `URL` and `BugReports` fields in `DESCRIPTION` may now contain 
   percent-encoded URLs (@HenningLorenzen-ext-bayer, #1415).
 

---FILE: R/object-from-call.R---
@@ -1,7 +1,7 @@
 object_from_call <- function(call, env, block, file) {
   if (is.character(call)) {
     if (identical(call, ""_PACKAGE"")) {
-      parser_package(call, env, block, file)
+      parser_package(file)
     } else {
       parser_data(call, env, file)
     }
@@ -36,6 +36,18 @@ object_from_call <- function(call, env, block, file) {
       NULL
     )
   } else {
+    # Patch @docType package to ensure that it gets a default alias
+    # and other ""_PACKAGE"" features
+    if (block_has_tags(block, ""docType"")) {
+      docType <- block_get_tag_value(block, ""docType"")
+      if (docType == ""package"") {
+        warn_roxy_block(block, c(
+          '`@docType ""package""` is deprecated',
+          i = 'Please document ""_PACKAGE"" instead.'
+        ))
+        return(parser_package(file))
+      }
+    }
     NULL
   }
 }
@@ -85,14 +97,14 @@ parser_data <- function(call, env, block) {
   object(value, call, type = ""data"")
 }
 
-parser_package <- function(call, env, block, file) {
+parser_package <- function(file) {
 
   pkg_path <- dirname(dirname(file))
   value <- list(
     desc = desc::desc(file = pkg_path),
     path = pkg_path
   )
-  object(value, call, type = ""package"")
+  object(value, ""_PACKAGE"", type = ""package"")
 }
 
 parser_assignment <- function(call, env, block) {

---FILE: tests/testthat/_snaps/object-from-call.md---
@@ -0,0 +1,8 @@
+# finds package description
+
+    Code
+      blocks <- parse_file(file.path(path, ""R/packages.R""))
+    Message
+      x packages.R:2: `@docType ""package""` is deprecated.
+      i Please document ""_PACKAGE"" instead.
+

---FILE: tests/testthat/empty/DESCRIPTION---
@@ -1,3 +1,5 @@
 Package: empty
 Version: 1.0.0
 Encoding: UTF-8
+Title: Empty package
+Description: An empty package

---FILE: tests/testthat/test-object-from-call.R---
@@ -6,13 +6,30 @@ test_that(""undocumentable things return null"", {
 
 # data / package -------------------------------------------------------
 
+test_that(""finds package description"", {
+  path <- local_package_copy(test_path(""empty""))
+  write_lines(path = file.path(path, ""R/packages.R""), c(
+    ""#' @docType package
+    NULL""
+  ))
+  expect_snapshot(blocks <- parse_file(file.path(path, ""R/packages.R"")))
+
+  expect_s3_class(blocks[[1]]$object, ""package"")
+
+  expect_equal(
+    block_get_tag_value(blocks[[1]], ""aliases""),
+    ""NULL empty empty-package""
+  )
+})
+
 test_that(""finds package description"", {
   obj <- call_to_object(""_PACKAGE"", file = test_path(""testEagerData/R/a.r""))
   expect_s3_class(obj, ""package"")
   expect_equal(obj$alias, ""_PACKAGE"")
   expect_equal(obj$value$desc$get_field(""Package""), ""testEagerData"")
 })
 
+
 test_that(""finds datasets given by name"", {
   obj <- call_to_object({
     df <- data.frame(x = 1, y = 2)

---FILE: tests/testthat/test-rd-backref.R---
@@ -2,7 +2,6 @@ test_that(""Source reference is included as comment"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' @name a
     #' @title a
-    #' @docType package
     NULL"")[[1]]
 
   expect_match(out$get_rd(""backref""), ""^% Please edit documentation in "")
@@ -14,7 +13,6 @@ test_that(""Explicit @backref is included as comment"", {
     #' @title a
     #' @backref back/ref.file
     #' @backref root.file
-    #' @docType package
     NULL"")[[1]]
 
   expect_equal(out$get_value(""backref""), c(""back/ref.file"", ""root.file""))"
r-lib,roxygen2,30390aa81160b073a2e142c3581d0823268da510,Hadley Wickham,h.wickham@gmail.com,2023-11-21T13:13:48Z,GitHub,noreply@github.com,2023-11-21T13:13:48Z,"Various code quality improvements (#1540)

* Don't change working directory in `load_package_copy()`. Fixes #1539.
* Use `local_roxy_meta_set()` everywhere possible. Fixes #1536.
* Reconsider display of warnings. Fixes #1533.",R/block.R;R/options.R;R/roxygenize.R;R/tag.R;tests/testthat/_snaps/block.md;tests/testthat/_snaps/collate.md;tests/testthat/_snaps/markdown-code.md;tests/testthat/_snaps/markdown-link.md;tests/testthat/_snaps/markdown-state.md;tests/testthat/_snaps/markdown.md;tests/testthat/_snaps/namespace.md;tests/testthat/_snaps/rd-describe-in.md;tests/testthat/_snaps/rd-examples.md;tests/testthat/_snaps/rd-find-link-files.md;tests/testthat/_snaps/rd-include-rmd.md;tests/testthat/_snaps/rd-inherit.md;tests/testthat/_snaps/rd-markdown.md;tests/testthat/_snaps/rd-params.md;tests/testthat/_snaps/rd-r6.md;tests/testthat/_snaps/rd-raw.md;tests/testthat/_snaps/rd-section.md;tests/testthat/_snaps/rd.md;tests/testthat/_snaps/roxygenize-setup.md;tests/testthat/_snaps/tag-parser.md;tests/testthat/_snaps/tag.md;tests/testthat/helper-test.R;tests/testthat/test-block.R;tests/testthat/test-collate.R;tests/testthat/test-markdown-link.R;tests/testthat/test-markdown-state.R;tests/testthat/test-markdown.R;tests/testthat/test-namespace.R;tests/testthat/test-object-defaults.R;tests/testthat/test-object-from-call.R;tests/testthat/test-package_files.R;tests/testthat/test-rd-describe-in.R;tests/testthat/test-rd-examples.R;tests/testthat/test-rd-family.R;tests/testthat/test-rd-include-rmd.R;tests/testthat/test-rd-inherit.R;tests/testthat/test-rd-markdown.R;tests/testthat/test-rd-params.R;tests/testthat/test-rd-r6.R;tests/testthat/test-rd-section.R;tests/testthat/test-rd-usage.R;tests/testthat/test-rd.R;tests/testthat/test-roxygenize-setup.R;tests/testthat/test-tag-parser.R;tests/testthat/test-tag.R,False,True,True,False,664,565,1229,"---FILE: R/block.R---
@@ -208,8 +208,7 @@ parse_tags <- function(tokens) {
   # Set up evaluation environment for markdown
   pkgenv <- roxy_meta_get(""env"") %||% baseenv()
   evalenv <- new.env(parent = pkgenv)
-  roxy_meta_set(""evalenv"", evalenv)
-  on.exit(roxy_meta_set(""evalenv"", NULL), add = TRUE)
+  local_roxy_meta_set(""evalenv"", evalenv)
 
   markdown_activate(tokens)
 
@@ -292,6 +291,7 @@ parse_description <- function(tags) {
 }
 
 warn_roxy_block <- function(block, message, ...) {
-  message[[1]] <- paste0(link_to(block$file, block$line), "" "", message[[1]])
-  cli::cli_warn(message, ..., .envir = parent.frame())
+  message[[1]] <- paste0(link_to(block$file, block$line), "": "", message[[1]], ""."")
+  names(message)[[1]] <- ""x""
+  cli::cli_inform(message, ..., .envir = parent.frame())
 }

---FILE: R/options.R---
@@ -145,8 +145,6 @@ roxy_meta_load <- function(base_path = getwd()) {
 }
 
 local_roxy_meta_set <- function(key, value, envir = caller_env()) {
-  old_value <- roxy_meta_get(key)
+  old_value <- roxy_meta_set(key, value)
   withr::defer(roxy_meta_set(key, old_value), envir = envir)
-
-  roxy_meta_set(key, value)
 }

---FILE: R/roxygenize.R---
@@ -57,8 +57,7 @@ roxygenize <- function(package.dir = ""."",
   # Now load code
   load_code <- find_load_strategy(load_code)
   env <- load_code(base_path)
-  roxy_meta_set(""env"", env)
-  on.exit(roxy_meta_set(""env"", NULL), add = TRUE)
+  local_roxy_meta_set(""env"", env)
 
   # Tokenise each file
   blocks <- parse_package(base_path, env = NULL)

---FILE: R/tag.R---
@@ -121,17 +121,18 @@ roxy_tag_warning <- function(x, ...) {
 #' @rdname roxy_tag
 warn_roxy_tag <- function(tag, message, ...) {
   message[[1]] <- paste0(
-    link_to(tag$file, tag$line), "" @"", tag$tag, "" "",
+    link_to(tag$file, tag$line), "": {.strong @"", tag$tag, ""} "",
     if (is.null(tag$raw)) (""(automatically generated) ""),
-    message[[1]]
+    message[[1]], "".""
   )
-  cli::cli_warn(message, ..., .envir = parent.frame())
+  names(message)[[1]] <- ""x""
+  cli::cli_inform(message, ..., .envir = parent.frame())
 }
 
 link_to <- function(file, line) {
-  paste0(""["", cli::style_hyperlink(
+  cli::style_hyperlink(
     paste0(basename(file), "":"", line),
     paste0(""file://"", file),
     params = c(line = line, col = 1)
-  ), ""]"")
+  )
 }

---FILE: tests/testthat/_snaps/block.md---
@@ -1,33 +1,48 @@
 # has thoughtful print method
 
-    <roxy_block> [<text>:5]
-      $tag
-        [line:  1] @title 'This is a title' {parsed}
-        [line:  3] @param 'x,y A number' {parsed}
-        [line:  4] @export '' {parsed}
-        [line:  5] @usage '<generated>' {parsed}
-        [line:  5] @.formals '<generated>' {parsed}
-        [line:  5] @backref '<generated>' {parsed}
-      $call   f <- function(x, y) x + y
-      $object <function> 
-        $topic f
-        $alias f
+    Code
+      parse_text(text)[[1]]
+    Output
+      <roxy_block> [<text>:5]
+        $tag
+          [line:  1] @title 'This is a title' {parsed}
+          [line:  3] @param 'x,y A number' {parsed}
+          [line:  4] @export '' {parsed}
+          [line:  5] @usage '<generated>' {parsed}
+          [line:  5] @.formals '<generated>' {parsed}
+          [line:  5] @backref '<generated>' {parsed}
+        $call   f <- function(x, y) x + y
+        $object <function> 
+          $topic f
+          $alias f
 
 # errors are propagated
 
-    [<text>:5] @eval failed to evaluate
-    Caused by error in `foo()`:
-    ! Uhoh
+    Code
+      . <- roc_proc_text(rd_roclet(), block)
+    Message
+      x <text>:5: @eval failed to evaluate.
+      Caused by error in `foo()`:
+      ! Uhoh
 
 # must return non-NA string
 
-    [<text>:3] @eval must evaluate to a character vector
+    Code
+      . <- roc_proc_text(rd_roclet(), block)
+    Message
+      x <text>:3: @eval must evaluate to a character vector.
 
 ---
 
-    [<text>:3] @eval must not contain any missing values
+    Code
+      . <- roc_proc_text(rd_roclet(), block)
+    Message
+      x <text>:3: @eval must not contain any missing values.
 
 # warns about duplicate tags
 
-    [<text>:5] Block must contain only one @rdname
+    Code
+      . <- roc_proc_text(rd_roclet(), block)
+    Message
+      x <text>:5: Block must contain only one @rdname.
 

---FILE: tests/testthat/_snaps/collate.md---
@@ -9,10 +9,10 @@
 # DESCRIPTION file is re-written only if collate changes
 
     Code
-      update_collate(""."")
+      update_collate(path)
     Message
-      Updating collate directive in './DESCRIPTION'
+      Updating collate directive in '<path>/DESCRIPTION'
     Code
       # Second run should be idempotent
-      update_collate(""."")
+      update_collate(path)
 

---FILE: tests/testthat/_snaps/markdown-code.md---
@@ -2,9 +2,8 @@
 
     Code
       out <- roc_proc_text(rd_roclet(), block)[[1]]
-    Condition
-      Warning:
-      [<text>:4] @description failed to evaluate inline markdown code
+    Message
+      x <text>:4: @description failed to evaluate inline markdown code.
       Caused by error:
       ! multi-line `r ` markup is not supported
 
@@ -17,9 +16,7 @@
     Message
       
       Quitting from lines 1-1
-    Condition
-      Warning:
-      [<text>:4] @description failed to evaluate inline markdown code
+      x <text>:4: @description failed to evaluate inline markdown code.
       Caused by error in `map_chr()`:
       i In index: 1.
       Caused by error:

---FILE: tests/testthat/_snaps/markdown-link.md---
@@ -2,17 +2,15 @@
 
     Code
       markdown(""[`foo` bar][x]"", tag = tag)
-    Condition
-      Warning:
-      [foo.R:10] @title (automatically generated) markdown links must contain plain text
+    Message
+      x foo.R:10: @title (automatically generated) markdown links must contain plain text.
       i Problematic link: x
     Output
       [1] """"
     Code
       markdown(""[__baz__][x]"", tag = tag)
-    Condition
-      Warning:
-      [foo.R:10] @title (automatically generated) markdown links must contain plain text
+    Message
+      x foo.R:10: @title (automatically generated) markdown links must contain plain text.
       i Problematic link: x
     Output
       [1] """"
@@ -23,17 +21,18 @@
       out1 <- roc_proc_text(rd_roclet(),
       ""\n    #' Title\n    #'\n    #' See [11pkg::function()], [11pkg::object].\n    #' @md\n    foo <- function() {}"")[[
         1]]
-    Condition
-      Warning:
-      [<text>:4] @description refers to unavailable topic 11pkg::function
+    Message
+      x <text>:4: @description refers to unavailable topic 11pkg::function.
       Caused by error in `find.package()`:
       ! there is no package called '11pkg'
-      Warning:
-      [<text>:4] @description refers to unavailable topic 11pkg::object
+      x <text>:4: @description refers to unavailable topic 11pkg::object.
       Caused by error in `find.package()`:
       ! there is no package called '11pkg'
 
 ---
 
-    [<text>:4] @description refers to unavailable topic stringr::bar111
+    Code
+      out1 <- roc_proc_text(rd_roclet(), block)[[1]]
+    Message
+      x <text>:4: @description refers to unavailable topic stringr::bar111.
 

---FILE: tests/testthat/_snaps/markdown-state.md---
@@ -1,4 +1,7 @@
 # warning for both @md and @noMd
 
-    [<text>:5] @md conflicts with @noMd; turning markdown parsing off
+    Code
+      out1 <- roc_proc_text(rd_roclet(), block)
+    Message
+      x <text>:5: @md conflicts with @noMd; turning markdown parsing off.
 

---FILE: tests/testthat/_snaps/markdown.md---
@@ -76,14 +76,20 @@
 
 # unhandled markdown generates warning
 
-    [<text>:4] @description markdown translation failed
-    x block quotes are not currently supported
+    Code
+      . <- roc_proc_text(rd_roclet(), text)
+    Message
+      x <text>:4: @description markdown translation failed.
+      x block quotes are not currently supported
 
 # level 1 heading in markdown generates warning in some tags
 
-    [<text>:4] @seealso markdown translation failed
-    x Level 1 headings are not supported in @seealso
-    i Do you want to put the heading in @description or @details?
+    Code
+      . <- roc_proc_text(rd_roclet(), text)
+    Message
+      x <text>:4: @seealso markdown translation failed.
+      x Level 1 headings are not supported in @seealso
+      i Do you want to put the heading in @description or @details?
 
 # alternative knitr engines
 

---FILE: tests/testthat/_snaps/namespace.md---
@@ -1,48 +1,94 @@
 # @exportS3method generates fully automatically
 
-    [<text>:2] @exportS3Method must be used with an known S3 method
+    Code
+      . <- roc_proc_text(namespace_roclet(), block)
+    Message
+      x <text>:2: @exportS3Method must be used with an known S3 method.
 
 # @exportS3method can extract class from generic
 
-    [<text>:2] @exportS3Method must have form package::generic
+    Code
+      . <- roc_proc_text(namespace_roclet(), block)
+    Message
+      x <text>:2: @exportS3Method must have form package::generic.
 
 ---
 
-    [<text>:2] @exportS3Method must be used with a function
+    Code
+      . <- roc_proc_text(namespace_roclet(), block)
+    Message
+      x <text>:2: @exportS3Method must be used with a function.
 
 ---
 
-    [<text>:2] @exportS3Method doesn't match function name
-    x Expected to see ""foo"" to match ""pkg::foo""
-    i Function name is ""foo1.bar""
+    Code
+      . <- roc_proc_text(namespace_roclet(), block)
+    Message
+      x <text>:2: @exportS3Method doesn't match function name.
+      x Expected to see ""foo"" to match ""pkg::foo""
+      i Function name is ""foo1.bar""
 
 # poorly formed importFrom throws error
 
-    [<text>:2] @importFrom must have at least 2 words, not 1
+    Code
+      . <- roc_proc_text(namespace_roclet(), block)
+    Message
+      x <text>:2: @importFrom must have at least 2 words, not 1.
 
 # rawNamespace must be valid code
 
-    [<text>:2] @rawNamespace failed to parse
-    Caused by error in `parse()`:
-    ! <text>:2:0: unexpected end of input
-    1: a +
-       ^
+    Code
+      . <- roc_proc_text(namespace_roclet(), block)
+    Message
+      x <text>:2: @rawNamespace failed to parse.
+      Caused by error in `parse()`:
+      ! <text>:2:0: unexpected end of input
+      1: a +
+         ^
 
 # evalNamespace warns for bad code
 
-    [<text>:2] @evalNamespace failed to parse
-    Caused by error in `parse()`:
-    ! <text>:2:0: unexpected end of input
-    1: a +
-       ^
+    Code
+      . <- roc_proc_text(namespace_roclet(), block)
+    Message
+      x <text>:2: @evalNamespace failed to parse.
+      Caused by error in `parse()`:
+      ! <text>:2:0: unexpected end of input
+      1: a +
+         ^
 
 ---
 
-    [<text>:2] @evalNamespace failed to evaluate
-    Caused by error:
-    ! Uhoh
+    Code
+      . <- roc_proc_text(namespace_roclet(), block)
+    Message
+      x <text>:2: @evalNamespace failed to evaluate.
+      Caused by error:
+      ! Uhoh
 
 ---
 
-    [<text>:2] @evalNamespace must evaluate to a character vector
+    Code
+      . <- roc_proc_text(namespace_roclet(), block)
+    Message
+      x <text>:2: @evalNamespace must evaluate to a character vector.
+
+# Invalid imports throw a helpful error
+
+    Code
+      out <- roc_proc_text(namespace_roclet(), block)
+    Message
+      x <text>:2: @importFrom Excluding unknown export in from utils: `InvalidUtilsFunction`.
+
+---
+
+    Code
+      out <- roc_proc_text(namespace_roclet(), block)
+    Message
+      x <text>:2: @importFrom Excluding unknown exports in from utils: `InvalidUtilsFunction1` and `InvalidUtilsFunction2`.
+
+---
+
+    Code
+      out <- roc_proc_text(namespace_roclet(), block)
 

---FILE: tests/testthat/_snaps/rd-describe-in.md---
@@ -111,13 +111,22 @@
 
 # complains about bad usage
 
-    [<text>:6] @describeIn must be used with an object
+    Code
+      . <- roc_proc_text(rd_roclet(), block)
+    Message
+      x <text>:6: @describeIn must be used with an object.
 
 ---
 
-    [<text>:6] @describeIn can not be used with @name
+    Code
+      . <- roc_proc_text(rd_roclet(), block)
+    Message
+      x <text>:6: @describeIn can not be used with @name.
 
 ---
 
-    [<text>:6] @describeIn can not be used with @rdname
+    Code
+      . <- roc_proc_text(rd_roclet(), block)
+    Message
+      x <text>:6: @describeIn can not be used with @rdname.
 

---FILE: tests/testthat/_snaps/rd-examples.md---
@@ -8,12 +8,18 @@
 
 # @example gives warning if used instead of @examples
 
-    [<text>:4] @example must be a single line
-    i Do you want @examples?
+    Code
+      out <- roc_proc_text(rd_roclet(), block)[[1]]
+    Message
+      x <text>:4: @example must be a single line.
+      i Do you want @examples?
 
 # warns if path doesn't exist
 
-    [<text>:4] @example './this-path-doesnt-exist.R' doesn't exist
+    Code
+      . <- roc_proc_text(rd_roclet(), block)
+    Message
+      x <text>:4: @example './this-path-doesnt-exist.R' doesn't exist.
 
 # @examplesIf
 
@@ -28,9 +34,12 @@
 
 # @examplesIf warns about unparseable condition
 
-    [<text>:4] @examplesIf condition failed to parse
-    Caused by error in `parse()`:
-    ! <text>:2:0: unexpected end of input
-    1: 1 +
-       ^
+    Code
+      . <- roc_proc_text(rd_roclet(), block)
+    Message
+      x <text>:4: @examplesIf condition failed to parse.
+      Caused by error in `parse()`:
+      ! <text>:2:0: unexpected end of input
+      1: 1 +
+         ^
 

---FILE: tests/testthat/_snaps/rd-find-link-files.md---
@@ -3,18 +3,16 @@
     Code
       tag <- roxy_test_tag()
       find_topic_filename(""11papaya"", ""foo"", tag)
-    Condition
-      Warning:
-      [test.R:1] @test refers to unavailable topic 11papaya::foo
+    Message
+      x test.R:1: @test refers to unavailable topic 11papaya::foo.
       Caused by error in `find.package()`:
       ! there is no package called '11papaya'
     Output
       [1] ""foo""
     Code
       find_topic_filename(""stringr"", ""foofofofoo"", tag)
-    Condition
-      Warning:
-      [test.R:1] @test refers to unavailable topic stringr::foofofofoo
+    Message
+      x test.R:1: @test refers to unavailable topic stringr::foofofofoo.
     Output
       [1] ""foofofofoo""
 

---FILE: tests/testthat/_snaps/rd-include-rmd.md---
@@ -1,6 +1,9 @@
 # useful warnings
 
-    [<text>:3] @includeRmd Can't find Rmd 'path'
+    Code
+      . <- roc_proc_text(rd_roclet(), block)
+    Message
+      x <text>:3: @includeRmd Can't find Rmd 'path'.
 
 ---
 
@@ -11,9 +14,7 @@
       Quitting from lines 2-3 [unnamed-chunk-2] (<temp-path.Rmd>)
       
       Quitting from lines 2-3 [unnamed-chunk-1] (<temp-path.Rmd>)
-    Condition
-      Warning:
-      [<text>:3] @includeRmd failed to evaluate '<temp-path.Rmd>'
+      x <text>:3: @includeRmd failed to evaluate '<temp-path.Rmd>'.
       Caused by error:
       ! Error
 

---FILE: tests/testthat/_snaps/rd-inherit.md---
@@ -7,17 +7,38 @@
 
 # warns on unknown inherit type
 
-    [<text>:2] @inherit attempts to inherit from unknown type ""blah""
+    Code
+      parse_text(text)
+    Message
+      x <text>:2: @inherit attempts to inherit from unknown type ""blah"".
+    Output
+      [[1]]
+      <roxy_block> [<text>:3]
+        $tag
+          [line:  2] @inherit 'fun blah' {parsed}
+          [line:  3] @backref '<generated>' {parsed}
+        $call   NULL
+        $object NULL
+        
+      
 
 # warns if can't find section
 
-    @inheritSection failed in topic ""b"".
-    x Can't find section ""A"" in topic a.
+    Code
+      . <- roc_proc_text(rd_roclet(), code)
+    Condition
+      Warning:
+      @inheritSection failed in topic ""b"".
+      x Can't find section ""A"" in topic a.
 
 # warned if no params need documentation
 
-    @inheritParams failed in topic ""x"".
-    x All parameters are already documented; none remain to be inherited.
+    Code
+      . <- roc_proc_text(rd_roclet(), code)
+    Condition
+      Warning:
+      @inheritParams failed in topic ""x"".
+      x All parameters are already documented; none remain to be inherited.
 
 # can inherit all from single function
 

---FILE: tests/testthat/_snaps/rd-markdown.md---
@@ -1,4 +1,7 @@
 # @title warns about multiple paragraphs
 
-    [<text>:2] @title must be a single paragraph
+    Code
+      . <- roc_proc_text(rd_roclet(), block)
+    Message
+      x <text>:2: @title must be a single paragraph.
 

---FILE: tests/testthat/_snaps/rd-params.md---
@@ -0,0 +1,7 @@
+# empty @param generates warning
+
+    Code
+      . <- roc_proc_text(rd_roclet(), block)
+    Message
+      x <text>:3: @param requires a value.
+

---FILE: tests/testthat/_snaps/rd-r6.md---
@@ -2,17 +2,15 @@
 
     Code
       topic_add_r6_methods(rd, block, environment())
-    Condition
-      Warning:
-      [<text>:7] Undocumented R6 field: undocumented_field
+    Message
+      x <text>:7: Undocumented R6 field: undocumented_field.
 
 # warning if no method comes after the docs
 
     Code
       topic_add_r6_methods(rd, block, environment())
-    Condition
-      Warning:
-      [<text>:10] @description Cannot find matching R6 method
+    Message
+      x <text>:10: @description Cannot find matching R6 method.
 
 # class with no inherited methods
 
@@ -44,25 +42,16 @@
 
     Code
       res <- roclet_process(roc, blocks = blocks, env = env, base_path = test_path())
-    Condition
-      Warning:
-      [roxygen-block-3.R:13] Must use one @param for each argument
+    Message
+      x roxygen-block-3.R:13: Must use one @param for each argument.
       x $meth3(duplicate) is documented multiple times
-      Warning:
-      [roxygen-block-3.R:13] Must use one @param for each argument
+      x roxygen-block-3.R:13: Must use one @param for each argument.
       x $meth3(missing) is not documented
-      Warning:
-      [roxygen-block-3.R:13] Must use one @return per R6 method
-      Warning:
-      [roxygen-block-3.R:92] Undocumented R6 method: undocumented_method
-      Warning:
-      [roxygen-block-3.R:92] Undocumented R6 fields: field2 and undocumented_field
-      Warning:
-      [roxygen-block-3.R:92] R6 field documented multiple times: duplicatefield
-      Warning:
-      [roxygen-block-3.R:92] Unknown R6 field: nosuchfield
-      Warning:
-      [roxygen-block-3.R:92] Undocumented R6 active binding: undocumented_binding
-      Warning:
-      [roxygen-block-3.R:92] R6 active binding documented multiple times: duplicate_binding
+      x roxygen-block-3.R:13: Must use one @return per R6 method.
+      x roxygen-block-3.R:92: Undocumented R6 method: undocumented_method.
+      x roxygen-block-3.R:92: Undocumented R6 fields: field2 and undocumented_field.
+      x roxygen-block-3.R:92: R6 field documented multiple times: duplicatefield.
+      x roxygen-block-3.R:92: Unknown R6 field: nosuchfield.
+      x roxygen-block-3.R:92: Undocumented R6 active binding: undocumented_binding.
+      x roxygen-block-3.R:92: R6 active binding documented multiple times: duplicate_binding.
 

---FILE: tests/testthat/_snaps/rd-raw.md---
@@ -3,21 +3,21 @@
     Code
       expect_parse_failure(roxy_tag_eval(roxy_test_tag(val = 1)))
     Output
-      <warning/rlang_warning>
-      Warning:
-      [test.R:1] @test must evaluate to a character vector
+      <message/rlang_message>
+      Message:
+      x test.R:1: @test must evaluate to a character vector.
     Code
       expect_parse_failure(roxy_tag_eval(roxy_test_tag(val = NA_character_)))
     Output
-      <warning/rlang_warning>
-      Warning:
-      [test.R:1] @test must not contain any missing values
+      <message/rlang_message>
+      Message:
+      x test.R:1: @test must not contain any missing values.
     Code
       expect_parse_failure(roxy_tag_eval(roxy_test_tag(val = quote(stop(""Uhoh"")))))
     Output
-      <warning/rlang_warning>
-      Warning:
-      [test.R:1] @test failed to evaluate
+      <message/rlang_message>
+      Message:
+      x test.R:1: @test failed to evaluate.
       Caused by error:
       ! Uhoh
 

---FILE: tests/testthat/_snaps/rd-section.md---
@@ -1,5 +1,8 @@
 # warn if forgotten colon
 
-    [<text>:4] @section title spans multiple lines.
-    i Did you forget a colon (:) at the end of the title?
+    Code
+      . <- roc_proc_text(rd_roclet(), block)
+    Message
+      x <text>:4: @section title spans multiple lines..
+      i Did you forget a colon (:) at the end of the title?
 

---FILE: tests/testthat/_snaps/rd.md---
@@ -1,47 +1,56 @@
 # documenting unknown function requires name
 
-    [<text>:6] Block must have a @name
-    i Either document an existing object or manually specify with @name
+    Code
+      . <- roc_proc_text(rd_roclet(), block)
+    Message
+      x <text>:6: Block must have a @name.
+      i Either document an existing object or manually specify with @name
 
 # can't set description and re-export
 
-    [<text>:4] Block must not include a description when re-exporting a function
+    Code
+      out <- roc_proc_text(rd_roclet(), block)
+    Message
+      x <text>:4: Block must not include a description when re-exporting a function.
 
 # documenting NA gives useful error message (#194)
 
-    [<text>:3] Block must have a @name
-    i Either document an existing object or manually specify with @name
+    Code
+      . <- roc_proc_text(rd_roclet(), block)
+    Message
+      x <text>:3: Block must have a @name.
+      i Either document an existing object or manually specify with @name
 
 # can generate nonASCII document
 
     Code
-      roxygenise(roclets = ""rd"")
+      roxygenise(path, roclets = ""rd"")
     Message
       i Loading testNonASCII
       Writing 'printChineseMsg.Rd'
     Code
       # Second run should be idempotent
-      roxygenise(roclets = ""rd"")
+      roxygenise(path, roclets = ""rd"")
     Message
       i Loading testNonASCII
 
 # unicode escapes are ok
 
     Code
-      roxygenise(roclets = ""rd"")
+      roxygenise(path, roclets = ""rd"")
     Message
       i Loading testUtf8Escape
       Writing 'a.Rd'
     Code
       # Second run should be idempotent
-      roxygenise(roclets = ""rd"")
+      roxygenise(path, roclets = ""rd"")
     Message
       i Loading testUtf8Escape
 
 # automatically deletes unused files
 
     Code
-      roxygenise()
+      roxygenise(path)
     Message
       i Loading empty
       Deleting 'test.Rd'

---FILE: tests/testthat/_snaps/roxygenize-setup.md---
@@ -1,15 +1,15 @@
 # useful error if no DESCRIPTION
 
     Code
-      roxygen_setup()
+      roxygen_setup(path)
     Condition
       Error in `roxygen_setup()`:
-      ! `package.dir` ('.') does not contain a DESCRIPTION
+      ! `package.dir` ('<path>') does not contain a DESCRIPTION
 
 # informs about initial setup
 
     Code
-      roxygen_setup(cur_version = ""8.0.0"")
+      roxygen_setup(path, cur_version = ""8.0.0"")
     Message
       First time using roxygen2. Upgrading automatically...
       Setting `RoxygenNote` to ""8.0.0""
@@ -19,7 +19,7 @@
 # warns about non UTF-8 encoding
 
     Code
-      roxygen_setup(cur_version = ""8.0.0"")
+      roxygen_setup(path, cur_version = ""8.0.0"")
     Condition
       Warning:
       roxygen2 requires Encoding: ""UTF-8""
@@ -30,7 +30,7 @@
 # warns if roxygen version is too new
 
     Code
-      roxygen_setup(cur_version = ""8.0.0"")
+      roxygen_setup(path, cur_version = ""8.0.0"")
     Condition
       Warning:
       Installed roxygen2 is older than the version used with this package
@@ -41,7 +41,7 @@
 # informs about major changes in 7.0.0
 
     Code
-      roxygen_setup(cur_version = ""8.0.0"")
+      roxygen_setup(path, cur_version = ""8.0.0"")
     Message
       --------------------------------------------------------------------------------
       Changes in roxygen2 7.0.0:

---FILE: tests/testthat/_snaps/tag-parser.md---
@@ -4,216 +4,211 @@
       tag <- roxy_test_tag("" "")
       expect_parse_failure(tag_value(tag))
     Output
-      <warning/rlang_warning>
-      Warning:
-      [test.R:1] @test requires a value
+      <message/rlang_message>
+      Message:
+      x test.R:1: @test requires a value.
     Code
       expect_parse_failure(tag_inherit(tag))
     Output
-      <warning/rlang_warning>
-      Warning:
-      [test.R:1] @test requires a value
+      <message/rlang_message>
+      Message:
+      x test.R:1: @test requires a value.
     Code
       expect_parse_failure(tag_name(tag))
     Output
-      <warning/rlang_warning>
-      Warning:
-      [test.R:1] @test requires a value
+      <message/rlang_message>
+      Message:
+      x test.R:1: @test requires a value.
     Code
       expect_parse_failure(tag_two_part(tag))
     Output
-      <warning/rlang_warning>
-      Warning:
-      [test.R:1] @test requires a value
+      <message/rlang_message>
+      Message:
+      x test.R:1: @test requires a value.
     Code
       expect_parse_failure(tag_name_description(tag))
     Output
-      <warning/rlang_warning>
-      Warning:
-      [test.R:1] @test requires a value
+      <message/rlang_message>
+      Message:
+      x test.R:1: @test requires a value.
     Code
       expect_parse_failure(tag_code(tag))
     Output
-      <warning/rlang_warning>
-      Warning:
-      [test.R:1] @test requires a value
+      <message/rlang_message>
+      Message:
+      x test.R:1: @test requires a value.
     Code
       expect_parse_failure(tag_examples(tag))
     Output
-      <warning/rlang_warning>
-      Warning:
-      [test.R:1] @test requires a value
+      <message/rlang_message>
+      Message:
+      x test.R:1: @test requires a value.
     Code
       expect_parse_failure(tag_markdown(tag))
     Output
-      <warning/rlang_warning>
-      Warning:
-      [test.R:1] @test requires a value
+      <message/rlang_message>
+      Message:
+      x test.R:1: @test requires a value.
     Code
       expect_parse_failure(tag_markdown_with_sections(tag))
     Output
-      <warning/rlang_warning>
-      Warning:
-      [test.R:1] @test requires a value
+      <message/rlang_message>
+      Message:
+      x test.R:1: @test requires a value.
 
 # tags check for mismatched parents gives useful warnings
 
     Code
       tag <- roxy_test_tag(""a {"")
       expect_parse_failure(tag_value(tag))
     Output
-      <warning/rlang_warning>
-      Warning:
-      [test.R:1] @test has mismatched braces or quotes
+      <message/rlang_message>
+      Message:
+      x test.R:1: @test has mismatched braces or quotes.
     Code
       expect_parse_failure(tag_inherit(tag))
     Output
-      <warning/rlang_warning>
-      Warning:
-      [test.R:1] @test has mismatched braces or quotes
+      <message/rlang_message>
+      Message:
+      x test.R:1: @test has mismatched braces or quotes.
     Code
       expect_parse_failure(tag_name(tag))
     Output
-      <warning/rlang_warning>
-      Warning:
-      [test.R:1] @test has mismatched braces or quotes
+      <message/rlang_message>
+      Message:
+      x test.R:1: @test has mismatched braces or quotes.
     Code
       expect_parse_failure(tag_two_part(tag))
     Output
-      <warning/rlang_warning>
-      Warning:
-      [test.R:1] @test has mismatched braces or quotes
+      <message/rlang_message>
+      Message:
+      x test.R:1: @test has mismatched braces or quotes.
     Code
       expect_parse_failure(tag_words(tag))
     Output
-      <warning/rlang_warning>
-      Warning:
-      [test.R:1] @test has mismatched braces or quotes
+      <message/rlang_message>
+      Message:
+      x test.R:1: @test has mismatched braces or quotes.
     Code
       expect_parse_failure(tag_words_line(tag))
     Output
-      <warning/rlang_warning>
-      Warning:
-      [test.R:1] @test has mismatched braces or quotes
+      <message/rlang_message>
+      Message:
+      x test.R:1: @test has mismatched braces or quotes.
     Code
       expect_parse_failure(tag_examples(tag))
     Output
-      <warning/rlang_warning>
-      Warning:
-      [test.R:1] @test has mismatched braces or quotes
+      <message/rlang_message>
+      Message:
+      x test.R:1: @test has mismatched braces or quotes.
     Code
       # markdown tags return empty values
-      (expect_warning(tag_markdown(tag)))
+      tag_markdown(tag)
+    Message
+      x test.R:1: @test has mismatched braces or quotes.
     Output
-      <warning/rlang_warning>
-      Warning:
-      [test.R:1] @test has mismatched braces or quotes
+      [test.R:  1] @test 'a {' {parsed}
     Code
-      (expect_warning(tag_markdown_with_sections(tag)))
+      tag_markdown_with_sections(tag)
+    Message
+      x test.R:1: @test has mismatched braces or quotes.
     Output
-      <warning/rlang_warning>
-      Warning:
-      [test.R:1] @test has mismatched braces or quotes
+      [test.R:  1] @test 'a {' {parsed}
 
 ---
 
-    Code
-      markdown_on()
-    Output
-      [1] TRUE
     Code
       tag <- roxy_test_tag(""# one\ntwo\n# three\nfour {"")
-      (expect_warning(tag_markdown_with_sections(tag)))
+      tag_markdown_with_sections(tag)
+    Message
+      x test.R:1: @test has mismatched braces or quotes.
     Output
-      <warning/rlang_warning>
-      Warning:
-      [test.R:1] @test has mismatched braces or quotes
+      [test.R:  1] @test '# one...' {parsed}
 
 # tag_inhert checks for valid inherits
 
     Code
       tag <- roxy_test_tag(""foo params section"")
       . <- tag_inherit(tag)
-    Condition
-      Warning:
-      [test.R:1] @test attempts to inherit from unknown type ""section""
+    Message
+      x test.R:1: @test attempts to inherit from unknown type ""section"".
 
 # tag_name() checks for valid names
 
     Code
       tag <- roxy_test_tag(""a b c"")
       expect_parse_failure(tag_name(tag))
     Output
-      <warning/rlang_warning>
-      Warning:
-      [test.R:1] @test must have only one argument, not 2
+      <message/rlang_message>
+      Message:
+      x test.R:1: @test must have only one argument, not 2.
 
 # tag_two_part() gives useful warnings
 
     Code
       tag <- roxy_test_tag(""a"")
       expect_parse_failure(tag_two_part(tag, ""name"", ""value""))
     Output
-      <warning/rlang_warning>
-      Warning:
-      [test.R:1] @test requires name and value
+      <message/rlang_message>
+      Message:
+      x test.R:1: @test requires name and value.
 
 # tag_words() gives useful warnings
 
     Code
       tag <- roxy_test_tag(""a b"")
       expect_parse_failure(tag_words(tag, 3, 3))
     Output
-      <warning/rlang_warning>
-      Warning:
-      [test.R:1] @test must have at least 3 words, not 2
+      <message/rlang_message>
+      Message:
+      x test.R:1: @test must have at least 3 words, not 2.
     Code
       expect_parse_failure(tag_words(tag, 1, 1))
     Output
-      <warning/rlang_warning>
-      Warning:
-      [test.R:1] @test must have at most 1 word, not 2
+      <message/rlang_message>
+      Message:
+      x test.R:1: @test must have at most 1 word, not 2.
 
 # tag_words_line() gives useful warnings
 
     Code
       tag <- roxy_test_tag(""a\nb"")
       expect_parse_failure(tag_words_line(tag))
     Output
-      <warning/rlang_warning>
-      Warning:
-      [test.R:1] @test must be a single line, not 2
+      <message/rlang_message>
+      Message:
+      x test.R:1: @test must be a single line, not 2.
       i The first line is ""a""
     Code
       tag <- roxy_test_tag(""a\nb\n2"")
       expect_parse_failure(tag_words_line(tag))
     Output
-      <warning/rlang_warning>
-      Warning:
-      [test.R:1] @test must be a single line, not 3
+      <message/rlang_message>
+      Message:
+      x test.R:1: @test must be a single line, not 3.
       i The first line is ""a""
 
 # tag_toggle() gives useful warnings
 
     Code
       tag <- roxy_test_tag(""x"")
-      expect_parse_failure(tag_toggle(tag))
+      tag_toggle(tag)
+    Message
+      x test.R:1: @test must not be followed by any text.
     Output
-      <warning/rlang_warning>
-      Warning:
-      [test.R:1] @test must not be followed by any text
+      NULL
 
 # tag_code() gives useful warnings
 
     Code
       tag <- roxy_test_tag(""a + "")
-      expect_parse_failure(tag_code(tag))
-    Output
-      <warning/rlang_warning>
-      Warning:
-      [test.R:1] @test failed to parse
+      tag_code(tag)
+    Message
+      x test.R:1: @test failed to parse.
       Caused by error in `parse()`:
       ! <text>:2:0: unexpected end of input
       1: a + 
          ^
+    Output
+      NULL
 

---FILE: tests/testthat/_snaps/tag.md---
@@ -1,4 +1,15 @@
 # warn about unknown tags
 
-    [<text>:2] @unknown is not a known tag
+    Code
+      . <- roc_proc_text(rd_roclet(), block)
+    Message
+      x <text>:2: @unknown is not a known tag.
+
+# incomplete rd in prequel or tag raises issue
+
+    Code
+      out <- roc_proc_text(rd_roclet(), block)
+    Message
+      x <text>:2: @title has mismatched braces or quotes.
+      x <text>:3: @aliases has mismatched braces or quotes.
 

---FILE: tests/testthat/helper-test.R---
@@ -13,17 +13,21 @@ expect_equal_strings <- function(s1, s2, ignore_ws = TRUE) {
 }
 
 expect_parse_failure <- function(code)  {
-  (expect_warning(expect_null(code)))
+  (expect_condition(expect_null(code)))
 }
 
 local_package_copy <- function(path, env = caller_env(), set_version = TRUE) {
   temp_path <- withr::local_tempdir(.local_envir = env)
 
   file.copy(path, temp_path, recursive = TRUE)
-  withr::local_dir(file.path(temp_path, basename(path)), .local_envir = env)
+  pkg_path <- dir(temp_path, full.names = TRUE)[[1]]
+
   if (set_version) {
-    desc::desc_set(RoxygenNote = as.character(packageVersion(""roxygen2"")))
+    desc::desc_set(
+      file = pkg_path,
+      RoxygenNote = as.character(packageVersion(""roxygen2""))
+    )
   }
 
-  invisible()
+  normalizePath(pkg_path, winslash = ""/"")
 }

---FILE: tests/testthat/test-block.R---
@@ -9,8 +9,7 @@ test_that(""has thoughtful print method"", {
     #' @export
     f <- function(x, y) x + y
   ""
-  block <- parse_text(text)[[1]]
-  expect_snapshot_output(block)
+  expect_snapshot(parse_text(text)[[1]])
 })
 
 # description block -------------------------------------------------------
@@ -237,33 +236,30 @@ test_that(""evaluation occurs during parsing"", {
 })
 
 test_that(""errors are propagated"", {
-  expect_snapshot_warning(
-    roc_proc_text(rd_roclet(), ""
-      foo <- function() stop('Uhoh')
-      #' Title
-      #' @name foo
-      #' @eval foo()
-      NULL""
-    )
-  )
+  block <- ""
+    foo <- function() stop('Uhoh')
+    #' Title
+    #' @name foo
+    #' @eval foo()
+    NULL
+  ""
+  expect_snapshot(. <- roc_proc_text(rd_roclet(), block))
 })
 
 test_that(""must return non-NA string"", {
-  expect_snapshot_warning(
-    roc_proc_text(rd_roclet(), ""
-      foo <- function() NA
-      #' @eval foo()
-      NULL""
-    )
-  )
+  block <- ""
+    foo <- function() NA
+    #' @eval foo()
+    NULL
+  ""
+  expect_snapshot(. <- roc_proc_text(rd_roclet(), block))
 
-  expect_snapshot_warning(
-    roc_proc_text(rd_roclet(), ""
-      foo <- function() NA_character_
-      #' @eval foo()
-      NULL""
-    )
-  )
+  block <- ""
+    foo <- function() NA_character_
+    #' @eval foo()
+    NULL
+  ""
+  expect_snapshot(. <- roc_proc_text(rd_roclet(), block))
 })
 
 test_that(""also works with namespace roclet"", {
@@ -282,12 +278,11 @@ test_that(""also works with namespace roclet"", {
 
 
 test_that(""warns about duplicate tags"", {
-  expect_snapshot_warning({
-    roc_proc_text(rd_roclet(), ""
-      #' Foo
-      #' @rdname foo
-      #' @rdname bar
-      foo <- function() {}
-    "")
-  })
+  block <- ""
+    #' Foo
+    #' @rdname foo
+    #' @rdname bar
+    foo <- function() {}
+  ""
+  expect_snapshot(. <- roc_proc_text(rd_roclet(), block))
 })

---FILE: tests/testthat/test-collate.R---
@@ -15,20 +15,20 @@ test_that(""update_collate() checks that directory exists"", {
 })
 
 test_that(""Collate field unchanged when no @includes"", {
-  local_package_copy(test_path('testCollateNoIncludes'))
+  path <- local_package_copy(test_path('testCollateNoIncludes'))
 
-  update_collate(""."")
-  expect_equal(desc::desc_get_field(""Collate""), ""b.R a.R"")
+  update_collate(path)
+  expect_equal(desc::desc_get_field(""Collate"", file = path), ""b.R a.R"")
 })
 
 test_that(""DESCRIPTION file is re-written only if collate changes"", {
-  local_package_copy(test_path(""testCollateOverwrite""))
+  path <- local_package_copy(test_path(""testCollateOverwrite""))
 
   expect_snapshot({
-    update_collate(""."")
+    update_collate(path)
     ""Second run should be idempotent""
-    update_collate(""."")
-  })
+    update_collate(path)
+  }, transform = function(x) gsub(path, ""<path>"", x, fixed = TRUE))
 })
 
 test_that(""can read from file name with utf-8 path"", {

---FILE: tests/testthat/test-markdown-link.R---
@@ -139,14 +139,15 @@ test_that(""short and sweet links work"", {
     foo <- function() {}"")[[1]]
   expect_equivalent_rd(out1, out2)
 
-  expect_snapshot_warning(
-    out1 <- roc_proc_text(rd_roclet(), ""
+  block <- ""
     #' Title
     #'
     #' Description, see [name words][stringr::bar111].
     #' @md
-    foo <- function() {}"")[[1]]
-  )
+    foo <- function() {}
+  ""
+  expect_snapshot(out1 <- roc_proc_text(rd_roclet(), block)[[1]])
+
   out2 <- roc_proc_text(rd_roclet(), ""
     #' Title
     #'
@@ -453,8 +454,7 @@ test_that(""markup in link text"", {
 })
 
 test_that(""linking to self is unqualified"", {
-  old <- roxy_meta_set(""current_package"", ""myself"")
-  on.exit(roxy_meta_set(""current_package"", old), add = TRUE)
+  local_roxy_meta_set(""current_package"", ""myself"")
   rd <- markdown(""foo [myself::fun()] and [myself::obj] bar"")
   expect_equal(
     rd,

---FILE: tests/testthat/test-markdown-state.R---
@@ -21,8 +21,7 @@ test_that(""turning on/off markdown globally"", {
     ""Description with some `code` included. `More code.`""
   )
 
-  old <- roxy_meta_set(""markdown"", TRUE)
-  on.exit(roxy_meta_set(""markdown"", old))
+  local_roxy_meta_set(""markdown"", TRUE)
   out1 <- roc_proc_text(rd_roclet(), ""
     #' Title
     #'
@@ -57,8 +56,7 @@ test_that(""turning on/off markdown locally"", {
     ""Description with some \\code{code} included. \\verb{More code.}""
   )
 
-  old <- roxy_meta_set(""markdown"", TRUE)
-  on.exit(roxy_meta_set(""markdown"", old))
+  local_roxy_meta_set(""markdown"", TRUE)
   out1 <- roc_proc_text(rd_roclet(), ""
     #' Title
     #'
@@ -94,7 +92,7 @@ test_that(""warning for both @md and @noMd"", {
     foo <- function() {}
   ""
 
-  expect_snapshot_warning(out1 <- roc_proc_text(rd_roclet(), block))
+  expect_snapshot(out1 <- roc_proc_text(rd_roclet(), block))
   expect_equal(out1[[1]]$get_value(""description""), ""`code`"")
 
   # No translation even if markdown on generally

---FILE: tests/testthat/test-markdown.R---
@@ -463,7 +463,7 @@ test_that(""unhandled markdown generates warning"", {
     #' @name x
     NULL
   ""
-  expect_snapshot_warning(roc_proc_text(rd_roclet(), text))
+  expect_snapshot(. <- roc_proc_text(rd_roclet(), text))
 })
 
 test_that(""level 1 heading in markdown generates warning in some tags"", {
@@ -478,7 +478,7 @@ test_that(""level 1 heading in markdown generates warning in some tags"", {
     #' @name x
     NULL
   ""
-  expect_snapshot_warning(roc_proc_text(rd_roclet(), text))
+  expect_snapshot(. <- roc_proc_text(rd_roclet(), text))
 })
 
 test_that(""level >2 markdown headings work in @description"", {

---FILE: tests/testthat/test-namespace.R---
@@ -1,9 +1,9 @@
 test_that(""end-to-end NAMESPACE generation works"", {
-  local_package_copy(test_path(""testNamespace""))
+  path <- local_package_copy(test_path(""testNamespace""))
 
-  suppressMessages(roxygenise())
+  suppressMessages(roxygenise(path))
 
-  ns <- read_lines(""NAMESPACE"")
+  ns <- read_lines(file.path(path, ""NAMESPACE""))
   expect_equal(ns, c(
     ""# Generated by roxygen2: do not edit by hand"",
     """",
@@ -92,12 +92,11 @@ test_that(""@exportS3method generates fully automatically"", {
   "")
   expect_equal(out, ""S3method(mean,foo)"")
 
-  expect_snapshot_warning(
-    roc_proc_text(namespace_roclet(), ""
-      #' @exportS3Method
-      f <- function(x) 'foo'
-    "")
-  )
+  block <- ""
+    #' @exportS3Method
+    f <- function(x) 'foo'
+  ""
+  expect_snapshot(. <- roc_proc_text(namespace_roclet(), block))
 })
 
 test_that(""@exportS3methd can create literal directive"", {
@@ -119,19 +118,19 @@ test_that(""@exportS3method can extract class from generic"", {
     #' @exportS3Method pkg_foo
     foo.bar <- function(x) 'foo'
   ""
-  expect_snapshot_warning(roc_proc_text(namespace_roclet(), block))
+  expect_snapshot(. <- roc_proc_text(namespace_roclet(), block))
 
   block <- ""
     #' @exportS3Method pkg::foo
     foo1.bar <- 10
   ""
-  expect_snapshot_warning(roc_proc_text(namespace_roclet(), block))
+  expect_snapshot(. <- roc_proc_text(namespace_roclet(), block))
 
   block <- ""
     #' @exportS3Method pkg::foo
     foo1.bar <- function(x) 'foo'
   ""
-  expect_snapshot_warning(roc_proc_text(namespace_roclet(), block))
+  expect_snapshot(. <- roc_proc_text(namespace_roclet(), block))
 })
 
 test_that(""exportClass overrides default class name"", {
@@ -221,10 +220,11 @@ test_that(""import directives for current package are ignored"", {
 })
 
 test_that(""poorly formed importFrom throws error"", {
-  expect_snapshot_warning(roc_proc_text(namespace_roclet(), ""
+  block <- ""
     #' @importFrom test
     NULL
-  ""))
+  ""
+  expect_snapshot(. <- roc_proc_text(namespace_roclet(), block))
 })
 
 test_that(""multiline importFrom parsed correctly"", {
@@ -273,11 +273,11 @@ test_that(""empty NAMESPACE generates zero-length vector"", {
 
 
 test_that(""rawNamespace must be valid code"", {
-  expect_snapshot_warning(
-    roc_proc_text(namespace_roclet(), ""
-      #' @rawNamespace a +
-      NULL"")
-  )
+  block <- ""
+    #' @rawNamespace a +
+    NULL
+  ""
+  expect_snapshot(. <- roc_proc_text(namespace_roclet(), block))
 })
 
 test_that(""rawNamespace inserted unchanged"", {
@@ -294,29 +294,29 @@ test_that(""rawNamespace inserted unchanged"", {
 # @evalNamespace ----------------------------------------------------------
 
 test_that(""evalNamespace warns for bad code"", {
-  expect_snapshot_warning(
-    roc_proc_text(namespace_roclet(), ""
-      #' @evalNamespace a +
-      #' @name a
-      #' @title a
-      NULL"")
-  )
+  block <- ""
+    #' @evalNamespace a +
+    #' @name a
+    #' @title a
+    NULL
+  ""
+  expect_snapshot(. <- roc_proc_text(namespace_roclet(), block))
 
-  expect_snapshot_warning(
-    roc_proc_text(namespace_roclet(), ""
-      #' @evalNamespace stop('Uhoh')
-      #' @name a
-      #' @title a
-      NULL"")
-  )
+  block <- ""
+    #' @evalNamespace stop('Uhoh')
+    #' @name a
+    #' @title a
+    NULL
+  ""
+  expect_snapshot(. <- roc_proc_text(namespace_roclet(), block))
 
-  expect_snapshot_warning(
-    roc_proc_text(namespace_roclet(), ""
-      #' @evalNamespace 1
-      #' @name a
-      #' @title a
-      NULL"")
-  )
+  block <- ""
+    #' @evalNamespace 1
+    #' @name a
+    #' @title a
+    NULL
+  ""
+  expect_snapshot(. <- roc_proc_text(namespace_roclet(), block))
 })
 
 test_that(""evalNamespace code is inserted when its value is a string"", {
@@ -380,36 +380,27 @@ test_that(""can extract non-imports from namespace preserving source"", {
 })
 
 test_that(""Invalid imports throw a helpful error"", {
-  expect_warning(
-    expect_equal(
-      roc_proc_text(namespace_roclet(), ""
-        #' @importFrom utils head InvalidUtilsFunction
-        NULL
-      ""),
-      ""importFrom(utils,head)""
-    ),
-    ""Excluding unknown export"",
-    fixed = TRUE
-  )
+  block <- ""
+    #' @importFrom utils head InvalidUtilsFunction
+    NULL
+  ""
+  expect_snapshot(out <- roc_proc_text(namespace_roclet(), block))
+  expect_equal(out, ""importFrom(utils,head)"")
 
   # pluralization
-  expect_warning(
-    expect_equal(
-      roc_proc_text(namespace_roclet(), ""
-        #' @importFrom utils head InvalidUtilsFunction1 InvalidUtilsFunction2
-        NULL
-      ""),
-      ""importFrom(utils,head)""
-    ),
-    ""Excluding unknown exports""
-  )
+  block <- ""
+    #' @importFrom utils head InvalidUtilsFunction1 InvalidUtilsFunction2
+    NULL
+  ""
+  expect_snapshot(out <- roc_proc_text(namespace_roclet(), block))
+  expect_equal(out, ""importFrom(utils,head)"")
 
   # If the package is not available at roxygenize() run time, nothing we can do
-  expect_equal(
-    roc_proc_text(namespace_roclet(), ""
-      #' @importFrom AnUnknownUnavailablePackage Unchecked
-      NULL
-    ""),
-    ""importFrom(AnUnknownUnavailablePackage,Unchecked)""
-  )
+  block <- ""
+    #' @importFrom AnUnknownUnavailablePackage Unchecked
+    NULL
+  ""
+  expect_snapshot(out <- roc_proc_text(namespace_roclet(), block))
+  expect_equal(out, ""importFrom(AnUnknownUnavailablePackage,Unchecked)"")
+
 })

---FILE: tests/testthat/test-object-defaults.R---
@@ -46,8 +46,9 @@ test_that(""@docType class automatically added to reference class objects"", {
 # packages -----------------------------------------------------------------
 
 test_that(""can create package documentation"", {
-  local_package_copy(test_path(""empty""))
+  path <- local_package_copy(test_path(""empty""))
   desc::desc_set(
+    file = path,
     Package = ""roxygendevtest"",
     Title = ""Package Title"",
     Description = ""Package description.""
@@ -57,7 +58,10 @@ test_that(""can create package documentation"", {
     #' @details Details.
   '_PACKAGE'
   ""
-  blocks <- parse_text(block, env = new.env())
+  withr::with_dir(
+    path,
+    blocks <- parse_text(block, env = new.env())
+  )
   out <- roclet_process(rd_roclet(), blocks, env = new.env(), base_path = ""."")[[1]]
 
   expect_equal(out$get_value(""name""), ""roxygendevtest-package"")

---FILE: tests/testthat/test-object-from-call.R---
@@ -24,17 +24,17 @@ test_that(""finds datasets given by name"", {
 })
 
 test_that(""can document eager data"", {
-  local_package_copy(test_path('testEagerData'))
-  suppressMessages(roxygenise())
+  path <- local_package_copy(test_path('testEagerData'))
+  suppressMessages(roxygenise(path))
 
-  expect_true(file.exists(""man/a.Rd""))
+  expect_true(file.exists(file.path(path, ""man/a.Rd"")))
 })
 
 test_that(""can document lazy data"", {
-  local_package_copy(test_path('testLazyData'))
-  suppressMessages(roxygenise())
+  path <- local_package_copy(test_path('testLazyData'))
+  suppressMessages(roxygenise(path))
 
-  expect_true(file.exists(""man/a.Rd""))
+  expect_true(file.exists(file.path(path, ""man/a.Rd"")))
 })
 
 # imports -----------------------------------------------------------------

---FILE: tests/testthat/test-package_files.R---
@@ -6,14 +6,17 @@ test_that(""respects order in Collate (#790)"", {
 })
 
 test_that(""roxygen ignores files with matching pattern in .Rbuildignore"", {
-  local_package_copy(test_path(""testRbuildignore""))
+  path <- local_package_copy(test_path(""testRbuildignore""))
 
-  expect_equal(basename(package_files()), c(""a.R"", ""ignore_me.R""))
+  expect_equal(basename(package_files(path)), c(""a.R"", ""ignore_me.R""))
 
-  write_lines(""^R/ignore_me.R$"", "".Rbuildignore"")
-  expect_equal(basename(package_files()), ""a.R"")
+  write_lines(""^R/ignore_me.R$"", file.path(path, "".Rbuildignore""))
+  expect_equal(basename(package_files(path)), ""a.R"")
 
   # Continues to work even if empty lines or missing files
-  write_lines(c(""^R/ignore_me.R$"", """", "".nonexistentfile""), "".Rbuildignore"")
-  expect_equal(basename(package_files()), ""a.R"")
+  write_lines(
+    c(""^R/ignore_me.R$"", """", "".nonexistentfile""),
+    file.path(path, "".Rbuildignore"")
+  )
+  expect_equal(basename(package_files(path)), ""a.R"")
 })

---FILE: tests/testthat/test-rd-describe-in.R---
@@ -222,37 +222,33 @@ test_that(""s4 methods get nice label"", {
 })
 
 test_that(""complains about bad usage"", {
-  expect_snapshot_warning(
-    roc_proc_text(rd_roclet(), ""
-      #' bar
-      bar <- 100
-
-      #' @name bar
-      #' @describeIn foo shortcut for foo
-      NULL
-      ""
-    )
-  )
-  expect_snapshot_warning(
-    roc_proc_text(rd_roclet(), ""
-      #' bar
-      bar <- 100
-
-      #' @name bar
-      #' @describeIn foo shortcut for foo
-      foo <- 10
-      ""
-    )
-  )
-  expect_snapshot_warning(
-    roc_proc_text(rd_roclet(), ""
-      #' bar
-      bar <- 100
-
-      #' @rdname bar
-      #' @describeIn foo shortcut for foo
-      foo <- 10
-      ""
-    )
-  )
+  block <- ""
+    #' bar
+    bar <- 100
+
+    #' @name bar
+    #' @describeIn foo shortcut for foo
+    NULL
+  ""
+  expect_snapshot(. <- roc_proc_text(rd_roclet(), block))
+
+  block <- ""
+    #' bar
+    bar <- 100
+
+    #' @name bar
+    #' @describeIn foo shortcut for foo
+    foo <- 10
+  ""
+  expect_snapshot(. <- roc_proc_text(rd_roclet(), block))
+
+  block <- ""
+    #' bar
+    bar <- 100
+
+    #' @rdname bar
+    #' @describeIn foo shortcut for foo
+    foo <- 10
+  ""
+  expect_snapshot(. <- roc_proc_text(rd_roclet(), block))
 })

---FILE: tests/testthat/test-rd-examples.R---
@@ -49,27 +49,26 @@ test_that(""@example does not introduce extra empty lines"", {
 })
 
 test_that(""@example gives warning if used instead of @examples"", {
-  expect_snapshot_warning(
-    out <- roc_proc_text(rd_roclet(), ""
-      #' @name a
-      #' @title a
-      #' @example
-      #' a <- 1
-      #' a + b
-      NULL"")[[1]]
-  )
+  block <- ""
+    #' @name a
+    #' @title a
+    #' @example
+    #' a <- 1
+    #' a + b
+    NULL
+  ""
+  expect_snapshot(out <- roc_proc_text(rd_roclet(), block)[[1]])
   expect_null(out$get_value(""examples""))
 })
 
 test_that(""warns if path doesn't exist"", {
-  expect_snapshot_warning(
-    roc_proc_text(rd_roclet(), ""
-      #' @name a
-      #' @title a
-      #' @example this-path-doesnt-exist.R
-      NULL
-    "")
-  )
+  block <- ""
+    #' @name a
+    #' @title a
+    #' @example this-path-doesnt-exist.R
+    NULL
+  ""
+  expect_snapshot(. <- roc_proc_text(rd_roclet(), block))
 })
 
 test_that(""@examplesIf"", {
@@ -86,22 +85,25 @@ test_that(""@examplesIf"", {
 })
 
 test_that(""@examplesIf warns about unparseable condition"", {
-  expect_snapshot_warning(roc_proc_text(rd_roclet(), ""
+  block <- ""
     #' @name a
     #' @title a
     #' @examplesIf 1 +
     #' maybe-run-this-code
-    NULL""))
+    NULL
+  ""
+  expect_snapshot(. <- roc_proc_text(rd_roclet(), block))
 })
 
 test_that(""% in @examples escaped before matching braces test (#213)"", {
-  out <- roc_proc_text(rd_roclet(), ""
+  block <- ""
     #' @name a
     #' @title a
     #' @examples
     #' {a %% b}
-    NULL"")[[1]]
-
+    NULL
+  ""
+  out <- roc_proc_text(rd_roclet(), block)[[1]]
   expect_equal(out$get_value(""examples""), rd(""{a \\%\\% b}""))
 })
 

---FILE: tests/testthat/test-rd-family.R---
@@ -110,10 +110,7 @@ test_that(""family also included in concepts"", {
 
 test_that(""custom family prefixes can be set"", {
 
-  owd <- setwd(tempdir())
-  on.exit(setwd(owd), add = TRUE)
-
-  roxy_meta_set(""rd_family_title"", list(a = ""Custom prefix: ""))
+  local_roxy_meta_set(""rd_family_title"", list(a = ""Custom prefix: ""))
   out <- roc_proc_text(rd_roclet(), ""
     #' foo
     #' @family a

---FILE: tests/testthat/test-rd-include-rmd.R---
@@ -261,12 +261,12 @@ test_that(""order of sections is correct"", {
 test_that(""useful warnings"", {
   skip_if_not(rmarkdown::pandoc_available(""2.17""))
 
-  text <- ""
+  block <- ""
     #' Title
     #' @includeRmd path
     #' @name foobar
     NULL""
-  expect_snapshot_warning(roc_proc_text(rd_roclet(), text))
+  expect_snapshot(. <- roc_proc_text(rd_roclet(), block))
 
   path <- withr::local_tempfile(fileext = "".Rmd"", lines = c(
     ""```{r}"",

---FILE: tests/testthat/test-rd-inherit.R---
@@ -60,12 +60,11 @@ test_that(""relative links converted to absolute"", {
 # tag parsing -------------------------------------------------------------
 
 test_that(""warns on unknown inherit type"", {
-  expect_snapshot_warning(
-    parse_text(""
-      #' @inherit fun blah
-      NULL
-    "")
-  )
+  text <- ""
+    #' @inherit fun blah
+    NULL
+  ""
+  expect_snapshot(parse_text(text))
 })
 
 test_that(""no options gives default values"", {
@@ -270,7 +269,7 @@ test_that(""warns if can't find section"", {
     #' @inheritSection a A
     b <- function(y) {}
   ""
-  expect_snapshot_warning(roc_proc_text(rd_roclet(), code))
+  expect_snapshot(. <- roc_proc_text(rd_roclet(), code))
 })
 
 # Inherit parameters ------------------------------------------------------
@@ -470,7 +469,7 @@ test_that(""warned if no params need documentation"", {
     #' @inheritParams foo
     x <- function(x, y) {}
   ""
-  expect_snapshot_warning(roc_proc_text(rd_roclet(), code))
+  expect_snapshot(. <- roc_proc_text(rd_roclet(), code))
 })
 
 test_that(""argument order, also for incomplete documentation"", {

---FILE: tests/testthat/test-rd-markdown.R---
@@ -72,5 +72,5 @@ test_that(""@title warns about multiple paragraphs"", {
     #' Paragraph 2
     x <- list(a = 1, b = 2)
   ""
-  expect_snapshot_warning(roc_proc_text(rd_roclet(), block))
+  expect_snapshot(. <- roc_proc_text(rd_roclet(), block))
 })

---FILE: tests/testthat/test-rd-params.R---
@@ -19,14 +19,14 @@ test_that(""grouped args get spaces"", {
 })
 
 test_that(""empty @param generates warning"", {
-  expect_warning(
-    roc_proc_text(rd_roclet(), ""
+  block <- ""
     #' A
     #' @param
     #'
-    a <- function() {}""),
-    ""requires a value""
-  )
+    a <- function() {}
+  ""
+
+  expect_snapshot(. <- roc_proc_text(rd_roclet(), block))
 })
 
 test_that(""data objects don't get params"", {

---FILE: tests/testthat/test-rd-r6.R---
@@ -366,9 +366,7 @@ test_that(""r6 option"", {
         meth = function(arg) { }
       )
     )""
-  old <- roxy_meta_get(""r6"")
-  on.exit(roxy_meta_set(""r6"", old), add = TRUE)
-  roxy_meta_set(""r6"", FALSE)
+  local_roxy_meta_set(""r6"", FALSE)
 
   expect_silent(
     out <- roc_proc_text(rd_roclet(), text)

---FILE: tests/testthat/test-rd-section.R---
@@ -1,18 +1,17 @@
 test_that(""warn if forgotten colon"", {
-  expect_snapshot_warning(
-    roc_proc_text(rd_roclet(), ""
-      #' Foo
-      #'
-      #' @section Haz dox
-      #' Here.
-      #' There
-      foo <- function(x = '%') x
-    "")
-  )
+  block <- ""
+    #' Foo
+    #'
+    #' @section Haz dox
+    #' Here.
+    #' There
+    foo <- function(x = '%') x
+  ""
+  expect_snapshot(. <- roc_proc_text(rd_roclet(), block))
 })
 
 test_that(""@section-s with identical titles are merged"", {
-  out <- roc_proc_text(rd_roclet(), ""
+  block <- ""
     #' Foo
     #'
     #' @section Haz dox: Here.
@@ -25,7 +24,8 @@ test_that(""@section-s with identical titles are merged"", {
     #' @section Haz dox:
     #'   Got news.
     bar <- function(y = '%') y
-  "")[[1]]
+  ""
+  out <- roc_proc_text(rd_roclet(), block)[[1]]
 
   expect_equal(
     out$get_section(""section""),

---FILE: tests/testthat/test-rd-usage.R---
@@ -308,8 +308,7 @@ test_that(""new wrapping style doesn't change unexpectedly"", {
 })
 
 test_that(""old wrapping style doesn't change unexpectedly"", {
-  old <- roxy_meta_set(""old_usage"", TRUE)
-  on.exit(roxy_meta_set(""old_usage"", old))
+  local_roxy_meta_set(""old_usage"", TRUE)
 
   expect_snapshot_output({
     cat(call_to_usage({

---FILE: tests/testthat/test-rd.R---
@@ -37,37 +37,32 @@ test_that(""deleted objects not documented"", {
 })
 
 test_that(""documenting unknown function requires name"", {
-  expect_snapshot_warning(
-    roc_proc_text(rd_roclet(), ""
-      #' Virtual Class To Enforce Max Slot Length
-      setClass('A')
-
-      #' Validity function.
-      setValidity('A', function(object) TRUE)""
-    )
-  )
+  block <- ""
+    #' Virtual Class To Enforce Max Slot Length
+    setClass('A')
+
+    #' Validity function.
+    setValidity('A', function(object) TRUE)
+  ""
+  expect_snapshot(. <- roc_proc_text(rd_roclet(), block))
 })
 
 test_that(""can't set description and re-export"", {
-  expect_snapshot_warning(
-    out <- roc_proc_text(rd_roclet(), ""
+  block <- ""
       #' @description NOPE
       #' @export
       magrittr::`%>%`
-      "")
-  )
-
+      ""
+  expect_snapshot(out <- roc_proc_text(rd_roclet(), block))
   expect_length(out, 0)
 })
 
-
 test_that(""documenting NA gives useful error message (#194)"", {
-  expect_snapshot_warning(
-    roc_proc_text(rd_roclet(), ""
-      #' Missing value
-      NA""
-    )
-  )
+  block <- ""
+    #' Missing value
+    NA
+  ""
+  expect_snapshot(. <- roc_proc_text(rd_roclet(), block))
 })
 
 test_that(""@description NULL"", {
@@ -101,20 +96,24 @@ test_that(""@description NULL"", {
   expect_identical(out[[1]]$get_value(""description""), ""Title"")
 
   # But drop for package docs
-  local_package_copy(test_path(""empty""))
+  path <- local_package_copy(test_path(""empty""))
   desc::desc_set(
+    file = path,
     Package = ""roxygendevtest"",
     Title = ""Package Title"",
     Description = ""Package description.""
   )
-  out <- roc_proc_text(rd_roclet(), ""
-    #' Title
-    #'
-    #' @docType package
-    #' @description NULL
-    #' @name pkg
-    '_PACKAGE'
-  "")
+  withr::with_dir(
+    path,
+    out <- roc_proc_text(rd_roclet(), ""
+      #' Title
+      #'
+      #' @docType package
+      #' @description NULL
+      #' @name pkg
+      '_PACKAGE'
+    "")
+  )
   expect_null(out[[1]]$get_value(""description""))
 })
 
@@ -152,15 +151,15 @@ test_that(""@details NULL"", {
 # UTF-8 -------------------------------------------------------------------
 
 test_that(""can generate nonASCII document"", {
-  local_package_copy(test_path('testNonASCII'))
+  path <- local_package_copy(test_path('testNonASCII'))
 
   expect_snapshot({
-    roxygenise(roclets = ""rd"")
+    roxygenise(path, roclets = ""rd"")
     ""Second run should be idempotent""
-    roxygenise(roclets = ""rd"")
+    roxygenise(path, roclets = ""rd"")
   })
 
-  rd_path <- file.path(""man"", ""printChineseMsg.Rd"")
+  rd_path <- file.path(path, ""man"", ""printChineseMsg.Rd"")
   expect_true(file.exists(rd_path))
   rd <- read_lines(rd_path)
 
@@ -169,26 +168,26 @@ test_that(""can generate nonASCII document"", {
 })
 
 test_that(""unicode escapes are ok"", {
-  local_package_copy(test_path('testUtf8Escape'))
+  path <- local_package_copy(test_path('testUtf8Escape'))
 
   expect_snapshot({
-    roxygenise(roclets = ""rd"")
+    roxygenise(path, roclets = ""rd"")
     ""Second run should be idempotent""
-    roxygenise(roclets = ""rd"")
+    roxygenise(path, roclets = ""rd"")
   })
 
-  rd_path <- file.path(""man"", ""a.Rd"")
+  rd_path <- file.path(path, ""man"", ""a.Rd"")
   expect_true(file.exists(rd_path))
   rd <- read_lines(rd_path)
 
   expect_true(any(grepl(""7\u00b0C"", rd)))
 })
 
 test_that(""automatically deletes unused files"", {
-  local_package_copy(test_path(""empty""))
-  dir.create(""man"")
-  suppressMessages(roxygenise())
+  path <- local_package_copy(test_path(""empty""))
+  dir.create(file.path(path, ""man""))
+  suppressMessages(roxygenise(path))
 
-  write_lines(made_by(""%""), ""man/test.Rd"")
-  expect_snapshot(roxygenise())
+  write_lines(made_by(""%""), file.path(path, ""man/test.Rd""))
+  expect_snapshot(roxygenise(path))
 })

---FILE: tests/testthat/test-roxygenize-setup.R---
@@ -1,32 +1,36 @@
 test_that(""useful error if no DESCRIPTION"", {
-  local_package_copy(test_path(""no-desc""), set_version = FALSE)
+  path <- local_package_copy(test_path(""no-desc""), set_version = FALSE)
 
-  expect_snapshot(roxygen_setup(), error = TRUE)
+  expect_snapshot(
+    roxygen_setup(path),
+    error = TRUE,
+    transform = function(x) gsub(path, ""<path>"", x)
+  )
 })
 
 test_that(""informs about initial setup"", {
-  local_package_copy(test_path(""empty""), set_version = FALSE)
+  path <- local_package_copy(test_path(""empty""), set_version = FALSE)
 
-  expect_snapshot(roxygen_setup(cur_version = ""8.0.0""))
+  expect_snapshot(roxygen_setup(path, cur_version = ""8.0.0""))
 })
 
 test_that(""warns about non UTF-8 encoding"", {
-  local_package_copy(test_path(""empty""))
-  desc::desc_set(Encoding = ""latin1"", RoxygenNote = ""8.0.0"")
+  path <- local_package_copy(test_path(""empty""))
+  desc::desc_set(file = path, Encoding = ""latin1"", RoxygenNote = ""8.0.0"")
 
-  expect_snapshot(roxygen_setup(cur_version = ""8.0.0""))
+  expect_snapshot(roxygen_setup(path, cur_version = ""8.0.0""))
 })
 
 test_that(""warns if roxygen version is too new"", {
-  local_package_copy(test_path(""empty""))
-  desc::desc_set(RoxygenNote = ""10.0.0"")
+  path <- local_package_copy(test_path(""empty""))
+  desc::desc_set(file = path, RoxygenNote = ""10.0.0"")
 
-  expect_snapshot(roxygen_setup(cur_version = ""8.0.0""))
+  expect_snapshot(roxygen_setup(path, cur_version = ""8.0.0""))
 })
 
 test_that(""informs about major changes in 7.0.0"", {
-  local_package_copy(test_path(""empty""))
-  desc::desc_set(RoxygenNote = ""5.0.0"")
+  path <- local_package_copy(test_path(""empty""))
+  desc::desc_set(file = path, RoxygenNote = ""5.0.0"")
 
-  expect_snapshot(roxygen_setup(cur_version = ""8.0.0""))
+  expect_snapshot(roxygen_setup(path, cur_version = ""8.0.0""))
 })

---FILE: tests/testthat/test-tag-parser.R---
@@ -25,15 +25,15 @@ test_that(""tags check for mismatched parents gives useful warnings"", {
     expect_parse_failure(tag_examples(tag))
 
     ""markdown tags return empty values""
-    (expect_warning(tag_markdown(tag)))
-    (expect_warning(tag_markdown_with_sections(tag)))
+    tag_markdown(tag)
+    tag_markdown_with_sections(tag)
   })
 
   local_markdown()
+  markdown_on()
   expect_snapshot({
-    markdown_on()
     tag <- roxy_test_tag(""# one\ntwo\n# three\nfour {"")
-    (expect_warning(tag_markdown_with_sections(tag)))
+    tag_markdown_with_sections(tag)
   })
 })
 
@@ -80,13 +80,13 @@ test_that(""tag_words_line() gives useful warnings"", {
 test_that(""tag_toggle() gives useful warnings"", {
   expect_snapshot({
     tag <- roxy_test_tag(""x"")
-    expect_parse_failure(tag_toggle(tag))
+    tag_toggle(tag)
   })
 })
 
 test_that(""tag_code() gives useful warnings"", {
   expect_snapshot({
     tag <- roxy_test_tag(""a + "")
-    expect_parse_failure(tag_code(tag))
+    tag_code(tag)
   })
 })

---FILE: tests/testthat/test-tag.R---
@@ -3,9 +3,7 @@ test_that(""warn about unknown tags"", {
     #' @unknown
     foo <- function() {}
   ""
-  expect_snapshot_warning(
-    roc_proc_text(rd_roclet(), block)
-  )
+  expect_snapshot(. <- roc_proc_text(rd_roclet(), block))
 })
 
 # Test low-level behaviour ----------------------------------------------------
@@ -70,20 +68,13 @@ test_that(""braces in code must match"", {
 
 # Test that incomplete Rd is caught in Rd blocks -------------------------------
 
-test_that(""incomplete rd in tag raises error"", {
-  expect_warning(roc_proc_text(rd_roclet(), ""
-    #' Title
+test_that(""incomplete rd in prequel or tag raises issue"", {
+  block <- ""
+    #' Title {
     #' @aliases title{
-    x <- 1""), ""mismatched braces"")
-})
-
-test_that(""incomplete rd in prequel raises error"", {
-  expect_warning(
-    roc_proc_text(rd_roclet(), ""
-      #' Title {
-      x <- 1""
-    ),
-    ""mismatched braces""
-  )
+    x <- 1
+  ""
+  expect_snapshot(out <- roc_proc_text(rd_roclet(), block))
+  expect_equal(out[[1]]$get_value(""title""), """")
+  expect_equal(out[[1]]$get_value(""alias""), ""x"")
 })
-"
r-lib,roxygen2,335448d8fc7ecacce7ee140462dde4bb4f754689,Henning Lorenzen,89191115+HenningLorenzen-ext-bayer@users.noreply.github.com,2023-11-16T16:26:48Z,GitHub,noreply@github.com,2023-11-16T16:26:48Z,"Escape ""%"" etc. in URLs (#1416)

Fixes #1415",NEWS.md;R/object-package.R;tests/testthat/test-object-package.R,False,True,True,False,20,2,22,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* `URL` and `BugReports` fields in `DESCRIPTION` may now contain 
+  percent-encoded URLs (@HenningLorenzen-ext-bayer, #1415).
+
 * `@inherit` can now also inherit from `@format` (#1293). 
 
 * `@describeIn()` gives a more informative warning if you use it with an

---FILE: R/object-package.R---
@@ -1,15 +1,16 @@
 package_seealso <- function(URL, BugReports) {
   itemize(""Useful links:"", package_seealso_urls(URL, BugReports))
 }
+
 package_seealso_urls <- function(URL = NULL, BugReports = NULL) {
   if (!is.null(URL)) {
-    links <- paste0(""\\url{"", strsplit(URL, "",\\s+"")[[1]], ""}"")
+    links <- paste0(""\\url{"", escape(strsplit(URL, "",\\s+"")[[1]]), ""}"")
     links <- gsub(""\\url\\{https://doi.org/"", ""\\doi{"", links)
   } else {
     links <- character()
   }
   if (!is.null(BugReports)) {
-    links <- c(links, paste0(""Report bugs at \\url{"", BugReports, ""}""))
+    links <- c(links, paste0(""Report bugs at \\url{"", escape(BugReports), ""}""))
   }
 
   links

---FILE: tests/testthat/test-object-package.R---
@@ -25,6 +25,20 @@ test_that(""useful message if Authors@R is corrupted"", {
   })
 })
 
+test_that(""can convert quote percentage signs in urls"", {
+  expect_equal(
+    package_seealso_urls(""https://www.foo.bar/search?q=see%20also""),
+    ""\\url{https://www.foo.bar/search?q=see\\%20also}""
+  )
+
+  expect_equal(
+    package_seealso_urls(
+      BugReports = ""https://www.foo.bar/search?q=bug%20report""
+    ),
+    ""Report bugs at \\url{https://www.foo.bar/search?q=bug\\%20report}""
+  )
+})
+
 test_that(""can convert DOIs in url"", {
   expect_equal(
     package_seealso_urls(""https://doi.org/10.5281/zenodo.1485309""),"
r-lib,roxygen2,a5d9561b9f0e4d35a85048abbf95ffdaae9e4c9f,Hadley Wickham,h.wickham@gmail.com,2023-11-16T14:37:48Z,GitHub,noreply@github.com,2023-11-16T14:37:48Z,"Add format support to `@inherit` (#1531)

Fixes #1293",NEWS.md;R/collate.R;R/rd-inherit.R;R/tag-parser.R;inst/roxygen2-tags.yml;tests/testthat/test-rd-inherit.R,False,True,True,False,11,10,21,"---FILE: NEWS.md---
@@ -1,5 +1,7 @@
 # roxygen2 (development version)
 
+* `@inherit` can now also inherit from `@format` (#1293). 
+
 * `@describeIn()` gives a more informative warning if you use it with an
   unsupported type (#1490).
 

---FILE: R/collate.R---
@@ -53,7 +53,7 @@ update_collate <- function(base_path) {
 
 generate_collate <- function(base_path) {
   paths <- sort_c(dir(base_path, pattern = ""[.][Rr]$"", full.names = TRUE))
-  includes <- lapply(paths, find_includes)
+  includes <- lapply(paths, function(x) intersect(find_includes(x), basename(paths)))
   names(includes) <- paths
 
   n <- sum(map_int(includes, length))

---FILE: R/rd-inherit.R---
@@ -109,6 +109,7 @@ topics_process_inherit <- function(topics, env) {
   topics$topo_apply(inherits(""author""), inherit_field, ""author"")
   topics$topo_apply(inherits(""source""), inherit_field, ""source"")
   topics$topo_apply(inherits(""note""), inherit_field, ""note"")
+  topics$topo_apply(inherits(""note""), inherit_field, ""format"")
 
   # First inherit individual sections, then all sections.
   topics$topo_apply(function(x) x$inherits_section_from(), inherit_section)

---FILE: R/tag-parser.R---
@@ -32,7 +32,8 @@ tag_value <- function(x) {
 # Also recorded in tags.yml
 inherit_components <- c(
   ""params"", ""return"", ""title"", ""description"", ""details"", ""seealso"",
-  ""sections"", ""references"", ""examples"", ""author"", ""source"", ""note""
+  ""sections"", ""references"", ""examples"", ""author"", ""source"", ""note"",
+  ""format""
 )
 
 #' @export

---FILE: inst/roxygen2-tags.yml---
@@ -209,7 +209,8 @@
 
     Otherwise, specify individual components to inherit by picking one or
     more of `params`, `return`, `title`, `description`, `details`, `seealso`,
-    `sections`, `references`, `examples`, `author`, `source`, and `note`.
+    `sections`, `references`, `examples`, `author`, `source`, `note`,
+    and `format`.
   template: ' ${1:source} ${2:components}'
   vignette: reuse
   recommend: true

---FILE: tests/testthat/test-rd-inherit.R---
@@ -74,13 +74,7 @@ test_that(""no options gives default values"", {
     NULL
   "")[[1]]
 
-  expect_equal(
-    block_get_tag_value(block, ""inherit"")$fields,
-    c(
-      ""params"", ""return"", ""title"", ""description"", ""details"", ""seealso"",
-      ""sections"", ""references"", ""examples"", ""author"", ""source"", ""note""
-    )
-  )
+  expect_equal(block_get_tag_value(block, ""inherit"")$fields, inherit_components)
 })
 
 test_that(""some options overrides defaults"", {
@@ -707,6 +701,7 @@ test_that(""can inherit all from single function"", {
     #' @author Hadley
     #' @source my mind
     #' @note my note
+    #' @format my format
     #' @examples
     #' x <- 1
     foo <- function(x, y) {}
@@ -722,6 +717,7 @@ test_that(""can inherit all from single function"", {
   expect_equal(out$get_value(""examples""), rd(""x <- 1""))
   expect_equal(out$get_value(""author""), ""Hadley"")
   expect_equal(out$get_value(""source""), ""my mind"")
+  expect_equal(out$get_value(""format""), ""my format"")
   expect_equal(out$get_value(""note""), ""my note"")
 })
 "
r-lib,roxygen2,968b5b8f7d1304484f634dc2c4b243f873f0b864,Hadley Wickham,h.wickham@gmail.com,2023-11-15T21:41:54Z,Hadley Wickham,h.wickham@gmail.com,2023-11-15T21:41:54Z,"Check that object has a name

Fixes #1490",NEWS.md;R/rd-describe-in.R,False,True,True,False,7,0,7,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* `@describeIn()` gives a more informative warning if you use it with an
+  unsupported type (#1490).
+
 * A friendlier error is thrown when attempting to import non-existing
   functions with `@importFrom` (#1409, @MichaelChirico).
 * authors in `DESCRIPTION` can now have multiple email addresses (@jmbarbone, #1487).

---FILE: R/rd-describe-in.R---
@@ -21,6 +21,10 @@ topic_add_describe_in <- function(topic, block, env) {
     warn_roxy_tag(tag, ""can not be used with @rdname"")
     return()
   }
+  if (is.null(object_name(block$object))) {
+    warn_roxy_tag(tag, ""not supported with this object type"")
+    return()
+  }
 
   dest <- find_object(tag$val$name, env)
   metadata <- build_minidesc_metadata(block$object, dest)"
r-lib,roxygen2,a4afa00420480f2fb516b870d00b38798d67129b,Hadley Wickham,h.wickham@gmail.com,2023-11-15T21:30:26Z,Hadley Wickham,h.wickham@gmail.com,2023-11-15T21:30:26Z,"Warn again vignette_roclet()

Fixes #1445",R/vignette.R;man/vignette_roclet.Rd,False,True,True,False,12,4,16,"---FILE: R/vignette.R---
@@ -1,6 +1,10 @@
 #' Re-build outdated vignettes
 #'
-#' This rebuilds outdated vignettes with [tools::buildVignette].
+#' @description
+#' This roclet rebuilds outdated vignettes with [tools::buildVignette],
+#' but we no longer recommend it because we no longer recommend storing
+#' built vignettes in a package.
+#'
 #' By default, it will rebuild all vignettes if the source file is newer than
 #' the output pdf or html. (This means it will automatically re-build the
 #' vignette if you change the vignette source, but _not_ when you
@@ -11,6 +15,7 @@
 #' your package, add `--no-build-vignettes` to the ""Build Source Package""
 #' field in your project options.
 #'
+#' @keywords internal
 #' @export
 vignette_roclet <- function() {
   roclet(""vignette"")

---FILE: man/vignette_roclet.Rd---
@@ -7,15 +7,18 @@
 vignette_roclet()
 }
 \description{
-This rebuilds outdated vignettes with \link[tools:buildVignette]{tools::buildVignette}.
+This roclet rebuilds outdated vignettes with \link[tools:buildVignette]{tools::buildVignette},
+but we no longer recommend it because we no longer recommend storing
+built vignettes in a package.
+
 By default, it will rebuild all vignettes if the source file is newer than
 the output pdf or html. (This means it will automatically re-build the
 vignette if you change the vignette source, but \emph{not} when you
 change the R code). If you want finer control, add a Makefile to
 \verb{vignettes/} and roxygen2 will use that instead.
-}
-\details{
+
 To prevent RStudio from re-building the vignettes again when checking
 your package, add \code{--no-build-vignettes} to the ""Build Source Package""
 field in your project options.
 }
+\keyword{internal}"
r-lib,roxygen2,662f567e67676ca23c230f459d4aaad4b7756d3b,Hadley Wickham,h.wickham@gmail.com,2023-11-15T21:25:58Z,Hadley Wickham,h.wickham@gmail.com,2023-11-15T21:25:58Z,"Remove Rcpp example

And outdated info about links

Fixes #1459",vignettes/roxygen2.Rmd,True,False,True,False,0,51,51,"---FILE: vignettes/roxygen2.Rmd---
@@ -106,54 +106,3 @@ It then parses the file, converts it into HTML and displays it.
 These functions look for an Rd file in *installed* packages.
 This isn't very useful for package development, because you want to use the `.Rd` files in the *source* package.
 For this reason, we recommend that you use roxygen2 in conjunction with devtools: `devtools::load_all()` automatically adds shims so that `?` and friends will look in the development package.
-Note, however, that this preview does not work with intra-package links.
-To preview those, you'll need to install the package.
-If you use RStudio, the easiest way to do this is to click the ""Build & Reload button"".
-
-### Rcpp
-
-You can also use roxygen2 with Rcpp.
-Simply include roxygen2 comments in your C++ code (using `//` instead of `#`), and Rcpp will automatically carry the comments along into `RcppExports.R` where roxygen2 will find them.
-
-For example, dplyr has `between.cpp` which starts:
-
-``` cpp
-//' Do values in a numeric vector fall in specified range?
-//'
-//' This is a shortcut for `x >= left & x <= right`, implemented
-//' efficiently in C++ for local values, and translated to the
-//' appropriate SQL for remote tables.
-//'
-//' @param x A numeric vector of values.
-//' @param left,right Boundary values.
-//' @export
-//' @examples
-//' between(1:12, 7, 9)
-//'
-//' x <- rnorm(1e2)
-//' x[between(x, -1, 1)]
-// [[Rcpp::export(rng = false)]]
-Rcpp::LogicalVector between(Rcpp::NumericVector x, double left, double right) {
-}
-```
-
-This is automatically translated to the following R code in `RcppExports.R`:
-
-```{r, eval = FALSE}
-#' Do values in a numeric vector fall in specified range?
-#'
-#' This is a shortcut for `x >= left & x <= right`, implemented
-#' efficiently in C++ for local values, and translated to the
-#' appropriate SQL for remote tables.
-#'
-#' @param x A numeric vector of values.
-#' @param left,right Boundary values.
-#' @export
-#' @examples
-#' between(1:12, 7, 9)
-#'
-#' x <- rnorm(1e2)
-#' x[between(x, -1, 1)]
-between <- function(x, left, right) {
-}
-```"
r-lib,roxygen2,38166f0a97aeb57e2ddc695aa6dcddcdeb917e8c,Michael Chirico,michaelchirico4@gmail.com,2023-11-10T15:30:04Z,GitHub,noreply@github.com,2023-11-10T15:30:04Z,"Warn and exclude unknown `@importFrom` exports (#1458)

Fixes #1409",NEWS.md;R/namespace.R;tests/testthat/test-namespace.R,False,True,True,False,46,0,46,"---FILE: NEWS.md---
@@ -1,5 +1,7 @@
 # roxygen2 (development version)
 
+* A friendlier error is thrown when attempting to import non-existing
+  functions with `@importFrom` (#1409, @MichaelChirico).
 * authors in `DESCRIPTION` can now have multiple email addresses (@jmbarbone, #1487).
 
 * The `ROXYGEN_PKG` environment variable is now set up while roxygen

---FILE: R/namespace.R---
@@ -238,6 +238,15 @@ roxy_tag_parse.roxy_tag_importFrom <- function(x) {
 }
 #' @export
 roxy_tag_ns.roxy_tag_importFrom <- function(x, block, env, import_only = FALSE) {
+  pkg <- x$val[1L]
+  if (requireNamespace(pkg, quietly = TRUE)) {
+    importing <- x$val[-1L]
+    unknown_idx <- !importing %in% getNamespaceExports(pkg)
+    if (any(unknown_idx)) {
+      warn_roxy_tag(x, ""Excluding unknown {cli::qty(sum(unknown_idx))} export{?s} in from {.package {pkg}}: {.code {importing[unknown_idx]}}"")
+      x$val <- c(pkg, importing[!unknown_idx])
+    }
+  }
   repeat_first_ignore_current(""importFrom"", x$val)
 }
 

---FILE: tests/testthat/test-namespace.R---
@@ -378,3 +378,38 @@ test_that(""can extract non-imports from namespace preserving source"", {
   path <- withr::local_tempfile(lines = lines)
   expect_equal(namespace_exports(path), lines[c(1:3, 5)])
 })
+
+test_that(""Invalid imports throw a helpful error"", {
+  expect_warning(
+    expect_equal(
+      roc_proc_text(namespace_roclet(), ""
+        #' @importFrom utils head InvalidUtilsFunction
+        NULL
+      ""),
+      ""importFrom(utils,head)""
+    ),
+    ""Excluding unknown export"",
+    fixed = TRUE
+  )
+
+  # pluralization
+  expect_warning(
+    expect_equal(
+      roc_proc_text(namespace_roclet(), ""
+        #' @importFrom utils head InvalidUtilsFunction1 InvalidUtilsFunction2
+        NULL
+      ""),
+      ""importFrom(utils,head)""
+    ),
+    ""Excluding unknown exports""
+  )
+
+  # If the package is not available at roxygenize() run time, nothing we can do
+  expect_equal(
+    roc_proc_text(namespace_roclet(), ""
+      #' @importFrom AnUnknownUnavailablePackage Unchecked
+      NULL
+    ""),
+    ""importFrom(AnUnknownUnavailablePackage,Unchecked)""
+  )
+})"
r-lib,roxygen2,3d162cb1754b42da90901b150e9859f5c22eb6c9,Jordan Mark Barbone,jmbarbone@gmail.com,2023-11-06T15:46:39Z,GitHub,noreply@github.com,2023-11-06T15:46:39Z,"Allow multiple emails for authors (#1529)

Fixes #1487",NEWS.md;R/object-package.R;tests/testthat/test-object-package.R,False,True,True,False,11,1,12,"---FILE: NEWS.md---
@@ -1,5 +1,7 @@
 # roxygen2 (development version)
 
+* authors in `DESCRIPTION` can now have multiple email addresses (@jmbarbone, #1487).
+
 * The `ROXYGEN_PKG` environment variable is now set up while roxygen
   is running to the name of the package being documented (#1517).
 

---FILE: R/object-package.R---
@@ -51,7 +51,7 @@ author_desc <- function(x) {
   }
 
   if (!is.null(x$email)) {
-    desc <- paste0(desc, "" \\email{"", x$email, ""}"")
+    desc <- paste0(desc, "" \\email{"", paste(x$email, collapse = "", ""), ""}"")
   }
 
   if (!is.null(x$comment)) {

---FILE: tests/testthat/test-object-package.R---
@@ -75,3 +75,11 @@ test_that(""autolink several matching patterns"", {
     )
   )
 })
+
+test_that(""multiple email addresses for a person are acceptable #1487"", {
+  me <- person(""me"", email = c(""one@email.me"", ""two@email.me""))
+  expect_equal(
+    author_desc(unclass(me)[[1]]),
+    ""me \\email{one@email.me, two@email.me}""
+  )
+})"
r-lib,roxygen2,066c3a504ef94e9fcdf3a133706e59e184dfaa27,musvaage,112724366+musvaage@users.noreply.github.com,2023-11-02T16:39:51Z,GitHub,noreply@github.com,2023-11-02T16:39:51Z,Fix typos (#1486),.github/SUPPORT.md;src/parser2.cpp;tests/testthat/_snaps/rd-section.md;tests/testthat/_snaps/tag-parser.md;tests/testthat/test-rd-section.R;tests/testthat/test-rd-template.R;tests/testthat/test-tag-parser.R;vignettes/rd-formatting.Rmd,True,True,True,False,9,9,18,"---FILE: .github/SUPPORT.md---
@@ -42,7 +42,7 @@ roxygen2 issues can be tricky to create a minimal reprex for. There are two gene
     problem goes away. Once you've done that, sometimes you'll be able to 
     reduce the problem further to a call to `roc_proc_text()` as above. If not,
     you'll need to make your minimal package available somewhere on the internet
-    (preferrably github) and link to it in the issue. The more you can do to
+    (preferably github) and link to it in the issue. The more you can do to
     make the package as small as possible, the less time it'll take me to
     find the bug, and the more time I'll have to work on it.
 

---FILE: src/parser2.cpp---
@@ -117,7 +117,7 @@ cpp11::list tokenise_block(cpp11::strings lines, std::string file,
     RoxygenLine line((std::string(lines[i])));
 
     if (!line.consumeRoxygenComment()) {
-      // Incremenet curRow for non-roxygen comments at start of block
+      // Increment curRow for non-roxygen comments at start of block
       if (curVal.empty())
         curRow++;
       continue;

---FILE: tests/testthat/_snaps/rd-section.md---
@@ -1,4 +1,4 @@
-# warn if forgotton colom
+# warn if forgotten colon
 
     [<text>:4] @section title spans multiple lines.
     i Did you forget a colon (:) at the end of the title?

---FILE: tests/testthat/_snaps/tag-parser.md---
@@ -132,11 +132,11 @@
 # tag_inhert checks for valid inherits
 
     Code
-      tag <- roxy_test_tag(""foo params sction"")
+      tag <- roxy_test_tag(""foo params section"")
       . <- tag_inherit(tag)
     Condition
       Warning:
-      [test.R:1] @test attempts to inherit from unknown type ""sction""
+      [test.R:1] @test attempts to inherit from unknown type ""section""
 
 # tag_name() checks for valid names
 

---FILE: tests/testthat/test-rd-section.R---
@@ -1,4 +1,4 @@
-test_that(""warn if forgotton colom"", {
+test_that(""warn if forgotten colon"", {
   expect_snapshot_warning(
     roc_proc_text(rd_roclet(), ""
       #' Foo

---FILE: tests/testthat/test-rd-template.R---
@@ -6,7 +6,7 @@ test_that(""can find template from name"", {
     file.path(base, ""man-roxygen"", ""UCase.R"")
   )
 
-  # On case-insentive file systems, will find upper case version first
+  # On case-insensitive file systems, will find upper case version first
   expect_equal(
     tolower(template_find(base, ""lcase"")),
     tolower(file.path(base, ""man-roxygen"", ""lcase.r""))

---FILE: tests/testthat/test-tag-parser.R---
@@ -39,7 +39,7 @@ test_that(""tags check for mismatched parents gives useful warnings"", {
 
 test_that(""tag_inhert checks for valid inherits"", {
   expect_snapshot({
-    tag <- roxy_test_tag(""foo params sction"")
+    tag <- roxy_test_tag(""foo params section"")
     . <- tag_inherit(tag)
   })
 })

---FILE: vignettes/rd-formatting.Rmd---
@@ -302,7 +302,7 @@ Either avoid expensive computations, or turn on knitr caching with `cache = TRUE
 Make sure to omit the cache from the package with `usethis::use_build_ignore()`.
 
 Note that knitr will call the appropriate `print()` or (if available) `knitr::knit_print()` method on the result.
-This may geenrate markdown not supported by roxygen2.
+This may generate markdown not supported by roxygen2.
 If needed, override the automatic methods to have your R calls return your own markdown as a character vector, wrapped in `knitr::asis_output()`.
 
 ### Chunk options"
r-lib,roxygen2,ac948f95d8cc6b93e1662c53f2297401089a589f,Hadley Wickham,h.wickham@gmail.com,2023-11-02T13:14:15Z,Hadley Wickham,h.wickham@gmail.com,2023-11-02T13:14:15Z,"Fix copy and paste-0

Closes #1481",vignettes/rd.Rmd,True,False,True,False,1,1,2,"---FILE: vignettes/rd.Rmd---
@@ -129,7 +129,7 @@ This way, the code evaluating whether the example can be run is not shown to use
 
 Instead of including examples directly in the documentation, you can put them in separate files and use `@example path/relative/to/package/root` to insert them into the documentation.
 
-All functions must have a documented return value for initial CRAN submission.
+All functions must have examples for initial CRAN submission.
 
 ### Usage
 "
r-lib,roxygen2,c7a0727a8998822f799dad265e5d961b8897c3dc,John,johnbaums@gmail.com,2023-11-02T12:55:16Z,GitHub,noreply@github.com,2023-11-02T12:55:16Z,"Fix typo in vignette (#1483)

""mutiple"" corrected to ""multiple""",,False,False,False,False,0,0,0,
r-lib,roxygen2,029d28fc2b5976d88adbba5f8a87f0672bd4f732,Simon P. Couch,simonpatrickcouch@gmail.com,2023-11-02T12:54:47Z,GitHub,noreply@github.com,2023-11-02T12:54:47Z,fix typo in reference to vignettes (#1477),R/tag-metadata.R;man/tags-index-crossref.Rd;man/tags-namespace.Rd;man/tags-rd-formatting.Rd;man/tags-rd-other.Rd;man/tags-rd.Rd;man/tags-reuse.Rd,False,True,True,False,7,7,14,"---FILE: R/tag-metadata.R---
@@ -45,7 +45,7 @@ tags_rd <- function(type) {
     ""@aliases"",
     tags_rd_section(tags, ""aliases""),
     ""@description"",
-    paste0(""Learn full the details in in `vignette('"", type, ""')`.""),
+    paste0(""Learn the full details in `vignette('"", type, ""')`.""),
     """",
     if (any(tags$recommend)) c(
       ""Key tags:"",

---FILE: man/tags-index-crossref.Rd---
@@ -20,7 +20,7 @@
 #' @seealso [${1:func}()]
 }
 \description{
-Learn full the details in in \code{vignette('index-crossref')}.
+Learn the full details in \code{vignette('index-crossref')}.
 
 Key tags:
 \itemize{

---FILE: man/tags-namespace.Rd---
@@ -30,7 +30,7 @@
 #' @useDynLib ${1:package}
 }
 \description{
-Learn full the details in in \code{vignette('namespace')}.
+Learn the full details in \code{vignette('namespace')}.
 
 Key tags:
 \itemize{

---FILE: man/tags-rd-formatting.Rd---
@@ -12,7 +12,7 @@
 #' @section ${1:section title}:
 }
 \description{
-Learn full the details in in \code{vignette('rd-formatting')}.
+Learn the full details in \code{vignette('rd-formatting')}.
 
 Other less frequently used tags:
 \itemize{

---FILE: man/tags-rd-other.Rd---
@@ -16,7 +16,7 @@
 #' @source ${1:description}
 }
 \description{
-Learn full the details in in \code{vignette('rd-other')}.
+Learn the full details in \code{vignette('rd-other')}.
 
 Key tags:
 \itemize{

---FILE: man/tags-rd.Rd---
@@ -34,7 +34,7 @@
 #' @usage ${1:fun}(${2:arg1, arg2 = default, ...})
 }
 \description{
-Learn full the details in in \code{vignette('rd')}.
+Learn the full details in \code{vignette('rd')}.
 
 Key tags:
 \itemize{

---FILE: man/tags-reuse.Rd---
@@ -30,7 +30,7 @@
 #' @templateVar ${1:name} ${2:value}
 }
 \description{
-Learn full the details in in \code{vignette('reuse')}.
+Learn the full details in \code{vignette('reuse')}.
 
 Key tags:
 \itemize{"
r-lib,roxygen2,fe371e26581f3b2ef066802d51162f11e324ddee,Andy Teucher,andy.teucher@gmail.com,2023-11-02T12:53:23Z,GitHub,noreply@github.com,2023-11-02T12:53:23Z,Fix typo (#1461),vignettes/reuse.Rmd,True,False,True,False,1,1,2,"---FILE: vignettes/reuse.Rmd---
@@ -19,7 +19,7 @@ knitr::opts_chunk$set(
 
 roxygen2 provides several ways to avoid repeating yourself in code documentation, while assembling information from multiple places in one documentation file:
 
--   Combine documentation for closely related functions into a single file with `@describe` in or `@rdname`.
+-   Combine documentation for closely related functions into a single file with `@describeIn` or `@rdname`.
 
 -   Inherit components from another topic with `@inheritParams`, `@inheritSection`, or `@inherit`.
 "
r-lib,roxygen2,73f854fdbbf78b25d1306af38eb477f4577bf40f,Ma칢lle Salmon,maelle.salmon@yahoo.se,2023-11-02T12:53:08Z,GitHub,noreply@github.com,2023-11-02T12:53:08Z,typo fix (#1460),vignettes/index-crossref.Rmd,True,False,True,False,1,1,2,"---FILE: vignettes/index-crossref.Rmd---
@@ -37,7 +37,7 @@ A function can be a member of multiple families.
 
 By default `@family {family}`, will generate the see also text ""Other {family}:"", so the `@family` name should be plural (i.e., ""model building helpers"" not ""model building helper"").
 
-If you want to override default title, you can provide an `rd_family_title` element in a list stored in `man/roxygen/meta.R`:
+If you want to override the default title, you can provide an `rd_family_title` element in a list stored in `man/roxygen/meta.R`:
 
 ```{r, eval = FALSE}
 list("
r-lib,roxygen2,e78ee5ab18c761e9d5822cc548782bf34fd288be,Matthijs Berends,31037261+msberends@users.noreply.github.com,2023-11-02T12:52:50Z,GitHub,noreply@github.com,2023-11-02T12:52:50Z,Typo fixes (#1511),vignettes/reuse.Rmd,True,False,True,False,2,2,4,"---FILE: vignettes/reuse.Rmd---
@@ -37,7 +37,7 @@ Use it when all functions have the same (or very similar) arguments.
 
 ### `@describeIn`
 
-Use `@describeIn <destination> <description>` to document mutiple functions together.
+Use `@describeIn <destination> <description>` to document multiple functions together.
 It generates a new section named ""**Related functions and methods**"", further divided into subsections by the type of relationship between the source and the destination documentation.
 Each subsection contains a bulleted list describing the function with the specified `<description>`.
 
@@ -170,7 +170,7 @@ Note that the evaluation environment is deliberately a child of the package that
 
 ## Child documents
 
-You can use the same `.Rmd` or `.md` document in the documentation, `README.Rmd`, and vignettes but using child documents:
+You can use the same `.Rmd` or `.md` document in the documentation, `README.Rmd`, and vignettes by using child documents:
 
     ```{r child = ""common.Rmd""}`r ''`
     ```"
r-lib,roxygen2,a510ddd20fd44d0039e97a5e9e7a3628590f04f8,Hadley Wickham,h.wickham@gmail.com,2023-11-02T12:51:50Z,GitHub,noreply@github.com,2023-11-02T12:51:50Z,"Upkeep 2023-11 (#1524)

* Update snapshots
* Drop C++ specification
* Re-document
* Update logo + favicons
* Always use .R extension
* `usethis::use_mit_license()`
* Bump R requirement
* `usethis::use_tidy_github_actions()`
* More case issues",.github/workflows/pkgdown.yaml;.github/workflows/test-coverage.yaml;DESCRIPTION;LICENSE;LICENSE.md;README.md;man/figures/logo.png;man/roxygen2-package.Rd;pkgdown/favicon/apple-touch-icon-120x120.png;pkgdown/favicon/apple-touch-icon-152x152.png;pkgdown/favicon/apple-touch-icon-180x180.png;pkgdown/favicon/apple-touch-icon-60x60.png;pkgdown/favicon/apple-touch-icon-76x76.png;pkgdown/favicon/apple-touch-icon.png;pkgdown/favicon/favicon-16x16.png;pkgdown/favicon/favicon-32x32.png;pkgdown/favicon/favicon.ico;tests/testthat/_snaps/markdown-code.md;tests/testthat/_snaps/rd-include-rmd.md;tests/testthat/test-collate.R;tests/testthat/test-package_files.R;tests/testthat/testCollateNoIncludes/DESCRIPTION;tests/testthat/testCollateNoIncludes/R/a.R;tests/testthat/testCollateNoIncludes/R/b.R;tests/testthat/testCollateOverwrite/DESCRIPTION;tests/testthat/testCollateOverwrite/R/a.R;tests/testthat/testCollateOverwrite/R/a.r;tests/testthat/testCollateOverwrite/R/b.R;tests/testthat/testCollateParse/DESCRIPTION;tests/testthat/testCollateParse/R/b.R;tests/testthat/testCollateParse/R/c.R;tests/testthat/testEagerData/R/a.R;tests/testthat/testLazyData/R/a.R;tests/testthat/testNamespace/R/a.R;tests/testthat/testNonASCII/R/a.R;tests/testthat/testUtf8Escape/R/a.R,False,True,True,False,26,22,48,"---FILE: .github/workflows/pkgdown.yaml---
@@ -19,6 +19,8 @@ jobs:
       group: pkgdown-${{ github.event_name != 'pull_request' || github.run_id }}
     env:
       GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
+    permissions:
+      contents: write
     steps:
       - uses: actions/checkout@v3
 

---FILE: .github/workflows/test-coverage.yaml---
@@ -31,7 +31,7 @@ jobs:
           covr::codecov(
             quiet = FALSE,
             clean = FALSE,
-            install_path = file.path(Sys.getenv(""RUNNER_TEMP""), ""package"")
+            install_path = file.path(normalizePath(Sys.getenv(""RUNNER_TEMP""), winslash = ""/""), ""package"")
           )
         shell: Rscript {0}
 

---FILE: DESCRIPTION---
@@ -18,7 +18,7 @@ License: MIT + file LICENSE
 URL: https://roxygen2.r-lib.org/, https://github.com/r-lib/roxygen2
 BugReports: https://github.com/r-lib/roxygen2/issues
 Depends: 
-    R (>= 3.3)
+    R (>= 3.6)
 Imports: 
     brew,
     cli (>= 3.3.0),
@@ -51,5 +51,4 @@ Config/testthat/edition: 3
 Encoding: UTF-8
 Language: en-GB
 Roxygen: list(markdown = TRUE, load = ""installed"")
-RoxygenNote: 7.2.2.9000
-SystemRequirements: C++11
+RoxygenNote: 7.2.3.9000

---FILE: LICENSE---
@@ -1,2 +1,2 @@
-YEAR: 2020
+YEAR: 2023
 COPYRIGHT HOLDER: roxygen2 authors

---FILE: LICENSE.md---
@@ -1,6 +1,6 @@
 # MIT License
 
-Copyright (c) 2020 roxygen2 authors
+Copyright (c) 2023 roxygen2 authors
 
 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated documentation files (the ""Software""), to deal

---FILE: README.md---
@@ -1,8 +1,8 @@
-# roxygen2 <a href=""https://roxygen2.r-lib.org""><img src=""man/figures/logo.png"" align=""right"" height=""138"" /></a>
+# roxygen2 <a href=""https://roxygen2.r-lib.org""><img src=""man/figures/logo.png"" align=""right"" height=""138"" alt=""roxygen2 website"" /></a>
 
 <!-- badges: start -->
 [![CRAN status](https://www.r-pkg.org/badges/version/roxygen2)](https://CRAN.R-project.org/package=roxygen2)
-[![R-CMD-check](https://github.com/r-lib/roxygen2/workflows/R-CMD-check/badge.svg)](https://github.com/r-lib/roxygen2/actions)
+[![R-CMD-check](https://github.com/r-lib/roxygen2/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/r-lib/roxygen2/actions/workflows/R-CMD-check.yaml)
 [![Codecov test coverage](https://codecov.io/gh/r-lib/roxygen2/branch/main/graph/badge.svg)](https://app.codecov.io/gh/r-lib/roxygen2?branch=main)
 <!-- badges: end -->
 

---FILE: man/roxygen2-package.Rd---
@@ -20,7 +20,7 @@ Useful links:
 
 }
 \author{
-\strong{Maintainer}: Hadley Wickham \email{hadley@rstudio.com} (\href{https://orcid.org/0000-0003-4757-117X}{ORCID}) [copyright holder]
+\strong{Maintainer}: Hadley Wickham \email{hadley@posit.co} (\href{https://orcid.org/0000-0003-4757-117X}{ORCID}) [copyright holder]
 
 Authors:
 \itemize{
@@ -31,7 +31,7 @@ Authors:
 
 Other contributors:
 \itemize{
-  \item RStudio [copyright holder, funder]
+  \item Posit Software, PBC [copyright holder, funder]
 }
 
 }

---FILE: tests/testthat/_snaps/markdown-code.md---
@@ -15,7 +15,8 @@
     Output
       
     Message
-      Quitting from lines 1-1 () 
+      
+      Quitting from lines 1-1
     Condition
       Warning:
       [<text>:4] @description failed to evaluate inline markdown code

---FILE: tests/testthat/_snaps/rd-include-rmd.md---
@@ -7,8 +7,10 @@
     Code
       . <- roc_proc_text(rd_roclet(), text)
     Message
-      Quitting from lines 2-3 (<temp-path.Rmd>) 
-      Quitting from lines 2-3 (<temp-path.Rmd>) 
+      
+      Quitting from lines 2-3 [unnamed-chunk-2] (<temp-path.Rmd>)
+      
+      Quitting from lines 2-3 [unnamed-chunk-1] (<temp-path.Rmd>)
     Condition
       Warning:
       [<text>:3] @includeRmd failed to evaluate '<temp-path.Rmd>'

---FILE: tests/testthat/test-collate.R---
@@ -18,7 +18,7 @@ test_that(""Collate field unchanged when no @includes"", {
   local_package_copy(test_path('testCollateNoIncludes'))
 
   update_collate(""."")
-  expect_equal(desc::desc_get_field(""Collate""), ""b.r a.r"")
+  expect_equal(desc::desc_get_field(""Collate""), ""b.R a.R"")
 })
 
 test_that(""DESCRIPTION file is re-written only if collate changes"", {

---FILE: tests/testthat/test-package_files.R---
@@ -1,7 +1,7 @@
 test_that(""respects order in Collate (#790)"", {
   expect_equal(
     package_files('testCollateParse'),
-    normalizePath(c(""testCollateParse/R/b.r"", ""testCollateParse/R/c.r""))
+    normalizePath(c(""testCollateParse/R/b.R"", ""testCollateParse/R/c.R""))
   )
 })
 

---FILE: tests/testthat/testCollateNoIncludes/DESCRIPTION---
@@ -5,4 +5,4 @@ Description:
 Author: Geoff <geoff.lee99@gmail.com>
 Maintainer: Geoff <geoff.lee99@gmail.com>
 Version: 0.1
-Collate: b.r a.r
+Collate: b.R a.R

---FILE: tests/testthat/testCollateNoIncludes/R/a.R---
@@ -1,4 +1,4 @@
 # Manually edited the Collate field in the DESCRIPTION file so this *should*
-# run after b.r
+# run after b.R
 
 a <- 1

---FILE: tests/testthat/testCollateOverwrite/DESCRIPTION---
@@ -6,4 +6,4 @@ Author: Hadley <h.wickham@gmail.com>
 Maintainer: Hadley <h.wickham@gmail.com>
 Version: 0.1
 Collate:
-    'b.r'
+    'b.R'

---FILE: tests/testthat/testCollateOverwrite/R/a.R---
@@ -0,0 +1,2 @@
+#' @include b.R
+a <- 1

---FILE: tests/testthat/testCollateOverwrite/R/a.r---
@@ -1,2 +0,0 @@
-#' @include b.r
-a <- 1

---FILE: tests/testthat/testCollateParse/DESCRIPTION---
@@ -8,5 +8,5 @@ Author: Brodie Gaslam <brodie.gaslam@yahoo.com>
 Maintainer: Brodie Gaslam <brodie.gaslam@yahoo.com>
 Version: 0.1
 Collate:
-    'b.r'
-    'c.r'
+    'b.R'
+    'c.R'"
r-lib,roxygen2,a1d556dfd20790fc38ec08c2ccb32743ee0f0902,Hadley Wickham,h.wickham@gmail.com,2022-12-08T20:36:14Z,Hadley Wickham,h.wickham@gmail.com,2022-12-08T20:36:51Z,"Better error for mispecified inhertDotParams

Fixes #1438",R/select-args.R;tests/testthat/_snaps/rd-inherit.md;tests/testthat/_snaps/select-args.md;tests/testthat/test-rd-inherit.R;tests/testthat/test-select-args.R,False,True,True,False,42,11,53,"---FILE: R/select-args.R---
@@ -7,7 +7,10 @@ select_args_text <- function(fun, select = """", topic) {
       select_args(fun, parsed)
     },
     error = function(e) {
-      warn_roxy_tag(topic, ""failed to parse argument specification"", parent = e)
+      cli::cli_warn(
+        ""@inheritDotsParam failed in topic {.str {topic$get_name()}}."",
+        parent = e
+      )
       character()
     }
   )

---FILE: tests/testthat/_snaps/rd-inherit.md---
@@ -39,6 +39,16 @@
       }}
     } 
 
+# useful error for bad inherits
+
+    Code
+      . <- roc_proc_text(rd_roclet(), text)
+    Condition
+      Warning:
+      @inheritDotsParam failed in topic ""bar"".
+      Caused by error in `FUN()`:
+      ! object 'z' not found
+
 # useful warnings if can't find topics
 
     Code

---FILE: tests/testthat/_snaps/select-args.md---
@@ -1,31 +1,31 @@
 # warns on invalid input
 
     Code
-      select_args_text(sum, ""-xlab:"", tag)
+      select_args_text(sum, ""-xlab:"", topic)
     Condition
       Warning:
-      [test.R:1] @test failed to parse argument specification
+      @inheritDotsParam failed in topic ""test"".
       Caused by error in `parse()`:
       ! <text>:2:0: unexpected end of input
       1: -xlab:
          ^
     Output
       character(0)
     Code
-      select_args_text(sum, ""\""a\"""", tag)
+      select_args_text(sum, ""\""a\"""", topic)
     Condition
       Warning:
-      [test.R:1] @test failed to parse argument specification
+      @inheritDotsParam failed in topic ""test"".
       Caused by error in `select_check()`:
       ! Argument specification must evaluate to a numeric vector
       Problem in `""a""`
     Output
       character(0)
     Code
-      select_args_text(function(x, y, z) { }, ""-x:z"", tag)
+      select_args_text(function(x, y, z) { }, ""-x:z"", topic)
     Condition
       Warning:
-      [test.R:1] @test failed to parse argument specification
+      @inheritDotsParam failed in topic ""test"".
       Caused by error:
       ! Argument specification must be all positive or all negative, not a mixture
       i Problem in `-x:z`

---FILE: tests/testthat/test-rd-inherit.R---
@@ -675,6 +675,23 @@ test_that(""inheritDotParams does not add already-documented params"", {
   expect_match(dot_param, ""item{\\code{z}}{z description}"", fixed = TRUE)
 })
 
+test_that(""useful error for bad inherits"", {
+  text <- ""
+    #' Foo
+    #'
+    #' @param x x
+    #' @param y y
+    foo <- function(x, y) {}
+
+    #' Bar
+    #'
+    #' @inheritDotParams foo -z
+    bar <- function(...) {}
+  ""
+  expect_snapshot(. <- roc_proc_text(rd_roclet(), text))
+})
+
+
 # inherit everything ------------------------------------------------------
 
 test_that(""can inherit all from single function"", {

---FILE: tests/testthat/test-select-args.R---
@@ -1,10 +1,11 @@
 test_that(""warns on invalid input"", {
-  tag <- roxy_test_tag()
+  topic <- RoxyTopic$new()
+  topic$add(rd_section(""name"", ""test""))
 
   expect_snapshot({
-    select_args_text(sum, ""-xlab:"", tag)
-    select_args_text(sum, '""a""', tag)
-    select_args_text(function(x, y, z) {}, ""-x:z"", tag)
+    select_args_text(sum, ""-xlab:"", topic)
+    select_args_text(sum, '""a""', topic)
+    select_args_text(function(x, y, z) {}, ""-x:z"", topic)
   })
 })
 "
r-lib,roxygen2,e2ba56c925687a5c08e20656129f6f41bc9ce707,Bill Denney,billdenney@users.noreply.github.com,2022-12-08T17:59:46Z,GitHub,noreply@github.com,2022-12-08T17:59:46Z,Fix link to issues page (#1449),.github/SUPPORT.md,False,False,False,False,1,1,2,"---FILE: .github/SUPPORT.md---
@@ -57,7 +57,7 @@ Armed with your reprex, the next step is to figure out [where to ask](https://ww
     problem _is_ a bug or a feature request, you can easily return here and 
     report it. 
 
-Before opening a new issue, be sure to [search issues and pull requests](https://github.com/tidyverse/roxygen2/issues) to make sure the 
+Before opening a new issue, be sure to [search issues and pull requests](https://github.com/r-lib/roxygen2/issues) to make sure the 
 bug hasn't been reported and/or already fixed in the development version. By 
 default, the search will be pre-populated with `is:issue is:open`. You can 
 [edit the qualifiers](https://help.github.com/articles/searching-issues-and-pull-requests/) "
r-lib,roxygen2,49206ad11a90bc4f583a59c69c33d08641580da4,Hadley Wickham,h.wickham@gmail.com,2022-11-11T16:36:48Z,Hadley Wickham,h.wickham@gmail.com,2022-11-11T16:36:48Z,Fix duplicated argument docs,DESCRIPTION;NEWS.md;R/block.R;man/roxy_block.Rd,False,True,True,False,5,3,8,"---FILE: DESCRIPTION---
@@ -52,5 +52,5 @@ Config/testthat/edition: 3
 Encoding: UTF-8
 Language: en-GB
 Roxygen: list(markdown = TRUE, load = ""installed"")
-RoxygenNote: 7.2.0.9000
+RoxygenNote: 7.2.1.9000
 SystemRequirements: C++11

---FILE: NEWS.md---
@@ -3,6 +3,8 @@
 * `@includeRmd` calls `local_reproducible_output()` to make code run in
   included `.Rmd`s more consistent with other sources (#1431).
 
+* Fix duplicated argument in `roxy_block()` to avoid CRAN removal.
+
 # roxygen2 7.2.1
 
 ## Tags

---FILE: R/block.R---
@@ -17,7 +17,7 @@
 #' @param object Optionally, the object associated with the block, found
 #'   by inspecting/evaluating `call`.
 #' @param block A `roxy_block` to manipulate.
-#' @param tag,tags Either a single tag name, or a character vector of tag names.
+#' @param tag A single tag name.
 #' @export
 #' @keywords internal
 #' @examples

---FILE: man/roxy_block.Rd---
@@ -31,7 +31,7 @@ by inspecting/evaluating \code{call}.}
 
 \item{block}{A \code{roxy_block} to manipulate.}
 
-\item{tag, tags}{Either a single tag name, or a character vector of tag names.}
+\item{tag}{A single tag name.}
 }
 \description{
 A \code{roxy_block} represents a single roxygen2 block."
r-lib,roxygen2,327124cb554e0967a90204ade8085fcc783bcbb8,Jennifer (Jenny) Bryan,jenny.f.bryan@gmail.com,2022-10-18T15:44:11Z,GitHub,noreply@github.com,2022-10-18T15:44:11Z,Fix typo in vignette title (#1436),vignettes/index-crossref.Rmd,True,False,True,False,2,2,4,"---FILE: vignettes/index-crossref.Rmd---
@@ -1,12 +1,12 @@
 ---
-title: ""Indexing and cross-refernces""
+title: ""Indexing and cross-references""
 output: rmarkdown::html_vignette
 description: >
   Make it easier for users to find your functions
   by cross-referencing them and control their
   indexing.
 vignette: >
-  %\VignetteIndexEntry{Indexing and cross-refernces}
+  %\VignetteIndexEntry{Indexing and cross-references}
   %\VignetteEngine{knitr::rmarkdown}
   %\VignetteEncoding{UTF-8}
 ---"
r-lib,roxygen2,20e05ad5412b44d099414a02789485bc4db2c3a9,Hadley Wickham,h.wickham@gmail.com,2022-09-26T21:33:28Z,GitHub,noreply@github.com,2022-09-26T21:33:28Z,"Use local_reproducible_output() in includeRmd (#1431)

Fixes #130",NEWS.md;R/rd-include-rmd.R;tests/testthat/test-rd-include-rmd.R,False,True,True,False,19,0,19,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* `@includeRmd` calls `local_reproducible_output()` to make code run in
+  included `.Rmd`s more consistent with other sources (#1431).
+
 # roxygen2 7.2.1
 
 ## Tags

---FILE: R/rd-include-rmd.R---
@@ -49,6 +49,7 @@ roxy_tag_rd.roxy_tag_includeRmd <- function(x, base_path, env) {
   )
   cat(txt, file = rmd_path)
 
+  local_reproducible_output()
   tryCatch(
     rmarkdown::render(
       rmd_path,

---FILE: tests/testthat/test-rd-include-rmd.R---
@@ -282,3 +282,18 @@ test_that(""useful warnings"", {
     transform = function(x) gsub(""/[a-zA-Z0-9_/]+"", ""<temp-path>"", x)
   )
 })
+
+test_that(""sets width"", {
+  skip_if_not(rmarkdown::pandoc_available(""2.17""))
+
+  local_options(width = 123)
+  temp_rd <- withr::local_tempfile(lines = ""`r getOption('width')`"")
+
+  rox <- sprintf(""
+    #' Title
+    #' @includeRmd %s
+    #' @name foobar
+    NULL"", temp_rd)
+  out <- roc_proc_text(rd_roclet(), rox)[[1]]
+  expect_equal(out$get_value(""details""), ""80"")
+})"
r-lib,roxygen2,0acd6c9dba82b9a5df8c4af6e5e1f6fd49fe0bc3,Hadley Wickham,h.wickham@gmail.com,2022-08-12T14:52:54Z,Hadley Wickham,h.wickham@gmail.com,2022-08-12T16:00:46Z,More informative error if `@includeRmd` generates bad xml,R/rd-include-rmd.R;tests/testthat/_snaps/rd-include-rmd.md;tests/testthat/test-rd-include-rmd.R,False,True,True,False,34,7,41,"---FILE: R/rd-include-rmd.R---
@@ -10,7 +10,7 @@ roxy_tag_parse.roxy_tag_includeRmd <- function(x) {
 
 #' @export
 roxy_tag_rd.roxy_tag_includeRmd <- function(x, base_path, env) {
-  rmd <- x$val$path
+  rmd <- rel_rmd <- x$val$path
   section <- x$val$section
 
   if (!file.exists(rmd)) {
@@ -62,15 +62,21 @@ roxy_tag_rd.roxy_tag_includeRmd <- function(x, base_path, env) {
       envir = new_environment(parent = global_env())
     ),
     error = function(e) {
-      warn_roxy_tag(x, ""failed to evaluate Rmd"", parent = e)
+      warn_roxy_tag(x, ""failed to evaluate {.path {rel_rmd}}"", parent = e)
     }
   )
 
   if (!file.exists(md_path)) {
     return(NULL)
   }
 
-  value <- rmd_eval_rd(md_path, x)
+  tryCatch(
+    value <- rmd_eval_rd(md_path, x),
+    error =  function(e) {
+      warn_roxy_tag(x, ""failed to process result of {.path {rel_rmd}}"", parent = e)
+    }
+  )
+
   rd_section_markdown(section, value)
 }
 

---FILE: tests/testthat/_snaps/rd-include-rmd.md---
@@ -4,7 +4,25 @@
 
 ---
 
-    [<text>:3] @includeRmd failed to evaluate Rmd
-    Caused by error:
-    ! Error
+    Code
+      roc_proc_text(rd_roclet(), text)
+    Message
+      Quitting from lines 2-3 (<temp-path>.Rmd) 
+      Quitting from lines 2-3 (<temp-path>.Rmd) 
+    Condition
+      Warning:
+      [<text>:3] @includeRmd failed to evaluate '<temp-path>.Rmd'
+      Caused by error:
+      ! Error
+    Output
+      $foobar.Rd
+      % Generated by roxygen2: do not edit by hand
+      % Please edit documentation in ./<text>
+      \name{foobar}
+      \alias{foobar}
+      \title{Title}
+      \description{
+      Title
+      }
+      
 

---FILE: tests/testthat/test-rd-include-rmd.R---
@@ -277,5 +277,8 @@ test_that(""useful warnings"", {
     #' @name foobar
     NULL"", path
   )
-  expect_snapshot_warning(roc_proc_text(rd_roclet(), text))
+  expect_snapshot(
+    roc_proc_text(rd_roclet(), text),
+    transform = function(x) gsub(""/[a-zA-Z0-9/]+"", ""<temp-path>"", x)
+  )
 })"
r-lib,roxygen2,07e4d1d5d1f70a1ab79089e78de9fa58bd98cf76,Hadley Wickham,h.wickham@gmail.com,2022-07-16T19:56:05Z,GitHub,noreply@github.com,2022-07-16T19:56:05Z,"Improve `@describeIn` labelling (#1403)

Fixes #1370",NAMESPACE;NEWS.md;R/rd-describe-in.R;R/rd-usage.R;tests/testthat/_snaps/rd-describe-in.md;tests/testthat/test-rd-describe-in.R;tests/testthat/test-rd-usage.R,False,True,True,False,214,69,283,"---FILE: NAMESPACE---
@@ -71,6 +71,12 @@ S3method(object_defaults,s4class)
 S3method(object_defaults,s4generic)
 S3method(object_defaults,s4method)
 S3method(object_format,default)
+S3method(object_name,""function"")
+S3method(object_name,default)
+S3method(object_name,s3generic)
+S3method(object_name,s3method)
+S3method(object_name,s4generic)
+S3method(object_name,s4method)
 S3method(print,object)
 S3method(print,rd)
 S3method(print,rd_section)

---FILE: NEWS.md---
@@ -2,9 +2,10 @@
 
 * `@describeIn` can now be used to combine more types of functions
   (generics, methods and other functions) into a single topic.
-  The resulting section organises the functions by type (#1181).
-  Methods are recognized only if they extend the generic in the destination,
-  or if the destination can heuristically be identified as a constructor.
+  The resulting section organises the functions by type (#1181)
+  and displays methods like function calls. Methods are recognized only if 
+  they extend the generic in the destination,or if the destination can 
+  heuristically be identified as a constructor.
 
 * All built-in tags are now documented so that you can do (e.g.) `?""@param""`
   to get a basic description of `@param` and a pointer where to learn more 

---FILE: R/rd-describe-in.R---
@@ -26,7 +26,7 @@ topic_add_describe_in <- function(topic, block, env) {
   metadata <- build_minidesc_metadata(block$object, dest)
 
   topic$add(rd_section_minidesc(
-    name = block$object$topic,
+    name = object_name(block$object),
     desc = tag$val$description,
     extends = metadata$extends,
     generic = metadata$generic,
@@ -95,23 +95,17 @@ format.rd_section_minidesc <- function(x, ...) {
 }
 
 format_section <- function(df, type) {
-  if (type == ""class"") {
-    title <- paste0(
-      ""Methods for class \\code{"", escape(df$class[[1]]), ""}""
-    )
-  } else if (type == ""generic"") {
-    title <- paste0(
-      ""Methods for generic \\code{"", escape(df$generic[[1]]), ""()}""
-    )
-  } else {
-    title <- ""Related functions""
-  }
+  title <- switch(type,
+    class = ""Methods (by generic)"",
+    generic = ""Methods (by class)"",
+    ""Functions""
+  )
 
-  bullets <- paste0(""\\code{"", escape(df$name), ""}: "", df$desc)
+  bullets <- paste0(""\\code{"", df$name, ""}: "", df$desc, ""\n"")
   body <- paste0(
     ""\\itemize{\n"",
-    paste0(""  \\item "", bullets, ""\n"", collapse = """"),
-    ""}\n""
+    paste0(""\\item "", bullets, ""\n"", collapse = """"),
+    ""}""
   )
 
   paste0(""\\section{"", title, ""}{\n"", body, ""}"")
@@ -197,3 +191,49 @@ fits_constructor <- function(dest_name, src) {
 
   src_class == paste0(pkg_name, ""_"", dest_name)
 }
+
+
+
+object_name <- function(x) {
+  UseMethod(""object_name"")
+}
+#' @export
+object_name.default <- function(x) {
+  x$alias
+}
+#' @export
+object_name.function <- function(x) {
+  object_name_fun(x$alias, x)
+}
+#' @export
+object_name.s3generic <- object_name.function
+#' @export
+object_name.s3method <- function(x) {
+  method <- attr(x$value, ""s3method"")
+  as.character(function_usage(method[[1]], list(as.name(method[[2]]))))
+#
+#   name <- paste(, collapse = ""."")
+#   object_name_fun(name, x)
+}
+#' @export
+object_name.s4generic <- function(x) {
+  object_name_fun(x$value@generic, x)
+}
+#' @export
+object_name.s4method <- function(x) {
+  classes <- lapply(x$value@defined, as.name)
+  if (length(classes) == 1) {
+    names(classes) <- NULL
+  }
+  as.character(function_usage(x$value@generic, classes))
+}
+
+object_name_fun <- function(name, x, format_name = identity) {
+  if (is_replacement_fun(name) || is_infix_fun(name)) {
+    args <- formals(x$value)
+  } else {
+    args <- NULL
+  }
+
+  as.character(function_usage(name, args, format_name))
+}

---FILE: R/rd-usage.R---
@@ -79,7 +79,11 @@ function_usage <- function(name, formals, format_name = identity) {
   } else if (is_infix_fun(name) && identical(format_name, identity)) {
     # If infix, and regular function, munge format
     arg_names <- names(formals)
-    build_rd(arg_names[1], "" "", format_name(name), "" "", arg_names[2])
+    name <- format_name(name)
+    if (is_padded_infix_fun(name)) {
+      name <- paste0("" "", name, "" "")
+    }
+    build_rd(arg_names[1], name, arg_names[2])
   } else {
     if (identical(format_name, identity)) {
       name <- auto_backtick(name)
@@ -93,7 +97,21 @@ is_replacement_fun <- function(name) {
   str_detect(name, fixed(""<-""))
 }
 is_infix_fun <- function(name) {
-  str_detect(name, ""^%.*%$"")
+  ops <- c(
+    ""+"", ""-"", ""*"", ""^"", ""/"",
+    ""=="", "">"", ""<"", ""!="", ""<="", "">="",
+    ""&"", ""|"",
+    ""[["", ""["", ""$"", "":"", ""::"", "":::""
+  )
+  str_detect(name, ""^%.*%$"") || name %in% ops
+}
+is_padded_infix_fun <- function(name) {
+  ops <- c(
+    ""+"", ""-"", ""*"", ""/"",
+    ""=="", "">"", ""<"", ""!="", ""<="", "">="",
+    ""&"", ""|""
+  )
+  str_detect(name, ""^%.*%$"") || name %in% ops
 }
 
 usage_args <- function(args) {
@@ -112,8 +130,10 @@ usage_args <- function(args) {
 }
 
 args_string <- function(x, space = "" "") {
-  sep <- ifelse(x != """", paste0(space, ""="", space), """")
-  arg_names <- escape(auto_backtick(names(x)))
+  sep <- ifelse(names(x) != """" & x != """", paste0(space, ""="", space), """")
+
+  nms <- names2(x)
+  arg_names <- ifelse(nms == """", """", escape(auto_backtick(nms)))
   paste0(arg_names, sep, escape(x))
 }
 

---FILE: tests/testthat/_snaps/rd-describe-in.md---
@@ -3,64 +3,111 @@
     Code
       out$get_section(""minidesc"")
     Output
-      \section{Related functions}{
+      \section{Functions}{
       \itemize{
-        \item \code{square}: Square a number
-        \item \code{cube}: Cube a number
-      }
-      } 
+      \item \code{square()}: Square a number
+      
+      \item \code{cube()}: Cube a number
+      
+      }} 
 
 # multiple methods and others are combined into a generic
 
     Code
       out$get_section(""minidesc"")
     Output
-      \section{Methods for generic \code{zap()}}{
+      \section{Methods (by class)}{
       \itemize{
-        \item \code{zap.numeric}: method
-        \item \code{zap.character}: method
-      }
-      }
-      \section{Related functions}{
+      \item \code{zap(numeric)}: method
+      
+      \item \code{zap(character)}: method
+      
+      }}
+      \section{Functions}{
       \itemize{
-        \item \code{print.qux}: function (method for different generic)
-        \item \code{zap_helper}: function
-      }
-      } 
+      \item \code{print(qux)}: function (method for different generic)
+      
+      \item \code{zap_helper()}: function
+      
+      }} 
 
 # multiple methods and others are combined into a class constructor
 
     Code
       out$get_section(""minidesc"")
     Output
-      \section{Methods for class \code{foo}}{
+      \section{Methods (by generic)}{
       \itemize{
-        \item \code{print.foo}: method
-        \item \code{format.foo}: method
-      }
-      }
-      \section{Related functions}{
+      \item \code{print(foo)}: method
+      
+      \item \code{format(foo)}: method
+      
+      }}
+      \section{Functions}{
       \itemize{
-        \item \code{format.bar}: function (method for different class)
-        \item \code{is_foo}: function
-      }
-      } 
+      \item \code{format(bar)}: function (method for different class)
+      
+      \item \code{is_foo()}: function
+      
+      }} 
 
 ---
 
     Code
       out$get_section(""minidesc"")
     Output
-      \section{Methods for class \code{roxygen2_baz}}{
+      \section{Methods (by generic)}{
       \itemize{
-        \item \code{print.roxygen2_baz}: method
-      }
-      }
-      \section{Related functions}{
+      \item \code{print(roxygen2_baz)}: method
+      
+      }}
+      \section{Functions}{
       \itemize{
-        \item \code{format.quuz_baz}: function (method for another class)
-      }
-      } 
+      \item \code{format(quuz_baz)}: function (method for another class)
+      
+      }} 
+
+# infix and replacement names get nice label
+
+    Code
+      out$get_section(""minidesc"")
+    Output
+      \section{Functions}{
+      \itemize{
+      \item \code{x \%foo\% y}: infix
+      
+      \item \code{foo(x) <- value}: replacement for foo
+      
+      }} 
+
+# s4 methods get nice label
+
+    Code
+      out$get_section(""minidesc"")
+    Output
+      \section{Methods (by generic)}{
+      \itemize{
+      \item \code{m_id(foo1)}: function
+      
+      }}
+      \section{Functions}{
+      \itemize{
+      \item \code{m_id()}: generic
+      
+      }} 
+
+---
+
+    Code
+      out$get_section(""minidesc"")
+    Output
+      \section{Methods (by class)}{
+      \itemize{
+      \item \code{bar1(x = foo2, y = foo3)}: method1
+      
+      \item \code{bar1(x = foo3, y = foo2)}: method2
+      
+      }} 
 
 # complains about bad usage
 

---FILE: tests/testthat/test-rd-describe-in.R---
@@ -67,7 +67,7 @@ test_that(""@describeIn function destination captures function source"", {
     f2 <- function(x) 1
     "")[[1]]
 
-  expect_equal(out$get_value(""minidesc"")$name, ""f2"")
+  expect_equal(out$get_value(""minidesc"")$name, ""f2()"")
   expect_equal(out$get_value(""minidesc"")$extends, """")
   expect_equal(out$get_value(""minidesc"")$generic, """")
   expect_equal(out$get_value(""minidesc"")$class, """")
@@ -83,7 +83,7 @@ test_that(""@describeIn class captures function name with data"", {
     f2 <- function(x) 1
     "")[[1]]
 
-  expect_equal(out$get_value(""minidesc"")$name, ""f2"")
+  expect_equal(out$get_value(""minidesc"")$name, ""f2()"")
 })
 
 test_that(""@describeIn class captures function description"", {
@@ -177,16 +177,48 @@ test_that(""multiple methods and others are combined into a class constructor"", {
   expect_snapshot(out$get_section(""minidesc""))
 })
 
-test_that(""function names are escaped"", {
+test_that(""infix and replacement names get nice label"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' foo
     foo <- 100
 
-    #' @describeIn foo shortcut for foo
+    #' @describeIn foo infix
     `%foo%` <- function(x, y) foo(x, y)
+
+    #' @describeIn foo replacement for foo
+    `foo<-` <- function(x, value) 10
+
+    "")[[1]]
+  expect_snapshot(out$get_section(""minidesc""))
+})
+
+test_that(""s4 methods get nice label"", {
+  out <- roc_proc_text(rd_roclet(), ""
+      #' Class
+      #'
+      setClass('foo1', slots = c(id = 'character'))
+
+      #' @describeIn foo1 generic
+      setGeneric('m_id', function(x) standardGeneric('m_id'))
+
+      #' @describeIn foo1 function
+      setMethod('m_id', 'foo1', function(x) x@id)
     "")[[1]]
-  out
-  expect_match(out$get_rd(""minidesc""), ""\\\\%foo\\\\%"")
+  expect_snapshot(out$get_section(""minidesc""))
+
+  out <- roc_proc_text(rd_roclet(), ""
+    setClass('foo2')
+    setClass('foo3')
+
+    #' bar1
+    setGeneric('bar1', function(x, y) standardGeneric('bar1'))
+
+    #' @describeIn bar1 method1
+    setMethod('bar1', c('foo2', 'foo3'), function(x, y) 1)
+    #' @describeIn bar1 method2
+    setMethod('bar1', c('foo3', 'foo2'), function(x, y) 1)
+  "")[[1]]
+  expect_snapshot(out$get_section(""minidesc""))
 })
 
 test_that(""complains about bad usage"", {

---FILE: tests/testthat/test-rd-usage.R---
@@ -153,16 +153,15 @@ test_that(""default usage formats replacement functions correctly"", {
 })
 
 test_that(""default usage formats infix functions correctly"", {
-  expect_equal(
-    call_to_usage(""%.%"" <- function(a, b) {}),
-    ""a \\%.\\% b""
-  )
+  expect_equal(call_to_usage(""%.%"" <- function(a, b) {}), ""a \\%.\\% b"")
+  expect_equal(call_to_usage("":"" <- function(a, b) {}), ""a:b"")
+  expect_equal(call_to_usage(""+"" <- function(a, b) {}), ""a + b"")
 
   # even if it contains <-
-  expect_equal(
-    call_to_usage(""%<-%"" <- function(a, b) {}),
-    ""a \\%<-\\% b""
-  )
+  expect_equal(call_to_usage(""%<-%"" <- function(a, b) {}), ""a \\%<-\\% b"")
+
+  # defaults are ignored
+  expect_equal(call_to_usage("":"" <- function(a = 1, b = 2) {}), ""a:b"")
 })
 
 test_that(""default usage formats S3 methods correctly"", {"
r-lib,roxygen2,021fbefc2fd4903bf568fff536fa532520390e1d,Max Held,info@maxheld.de,2022-07-16T13:37:22Z,GitHub,noreply@github.com,2022-07-16T13:37:22Z,"Handle more types of `@describeIn` in one topic (#1182)

Fixes #1370.",NEWS.md;R/rd-describe-in.R;tests/testthat/_snaps/rd-describe-in.md;tests/testthat/test-rd-describe-in.R;vignettes/reuse.Rmd,True,True,True,False,332,165,497,"---FILE: NEWS.md---
@@ -1,5 +1,11 @@
 # roxygen2 (development version)
 
+* `@describeIn` can now be used to combine more types of functions
+  (generics, methods and other functions) into a single topic.
+  The resulting section organises the functions by type (#1181).
+  Methods are recognized only if they extend the generic in the destination,
+  or if the destination can heuristically be identified as a constructor.
+
 * All built-in tags are now documented so that you can do (e.g.) `?""@param""`
   to get a basic description of `@param` and a pointer where to learn more 
   (#1165).
@@ -42,8 +48,6 @@
 
 * Automated usage no longer mangles nbsp in default arguments (#1342).
 
-* Give useful error if `@describeIn` can't combine docs (#1366).
-
 * Code evaluated in inline markdown code chunks and `@eval`/`@evalRd`/
   `@evalNamespace` is now evaluated in an environment designed to be more
   reproducible and to suppress output that won't work in Rd (e.g. turning

---FILE: R/rd-describe-in.R---
@@ -23,58 +23,98 @@ topic_add_describe_in <- function(topic, block, env) {
   }
 
   dest <- find_object(tag$val$name, env)
-  label <- build_label(block$object, dest, block)
-  if (is.null(label))
-    return()
+  metadata <- build_minidesc_metadata(block$object, dest)
 
   topic$add(rd_section_minidesc(
-    label$type,
-    label$label,
-    tag$val$description
+    name = block$object$topic,
+    desc = tag$val$description,
+    extends = metadata$extends,
+    generic = metadata$generic,
+    class = metadata$class
   ))
   dest$topic
 }
 
 # Field -------------------------------------------------------------------
 
-rd_section_minidesc <- function(type, label, desc) {
-  stopifnot(is.character(type), is.character(label), is.character(desc))
-  stopifnot(length(desc) == length(label))
-
-  rd_section(""minidesc"", list(type = type, desc = desc, label = label))
+#' Record data for minidescription sections from `@describeIn`
+#'
+#' @param name name of the source function.
+#' @param desc description passed to `@describeIn`.
+#' @param extends how the source function extends the destination function:
+#' - `""generic""` if the source extends a (S3 or S4) generic in the destination,
+#' - `""class""` if the source extends an informal S3 or formal S4 constructor
+#'    in the destination.
+#'    For S3, there is always only *one* class.
+#'    For S4, the methods' signature is used instead, to cover multiple dispatch.
+#' - `""""` (default) otherwise.
+#' @param generic,class name of the generic and class that is being extended by
+#' the method, otherwise empty string (`""""`).
+#' @return a dataframe with one row for each `@describeIn`, wrapped inside
+#' `rd_section()`
+#' @noRd
+rd_section_minidesc <- function(name,
+                                desc,
+                                extends = c("""", ""generic"", ""class""),
+                                generic = """",
+                                class = """") {
+  stopifnot(is_string(name))
+  stopifnot(is_character(desc))
+  rlang::arg_match(extends)
+  stopifnot(is_string(generic))
+  stopifnot(is_string(class))
+
+  data <- data.frame(
+    name = name,
+    desc = desc,
+    extends = extends,
+    generic = generic,
+    class = class,
+    stringsAsFactors = FALSE
+  )
+  rd_section(""minidesc"", data)
 }
 
 #' @export
 merge.rd_section_minidesc <- function(x, y, ..., block) {
   stopifnot(identical(class(x), class(y)))
 
-  if (!identical(x$value$type, y$value$type)) {
-    warn_roxy_block(block, ""Don't know how to combine @describeIn types {.str {x$value$type}} and {.str {y$value$type}}"")
-    x
-  } else {
-    rd_section_minidesc(
-      x$value$type,
-      label = c(x$value$label, y$value$label),
-      desc = c(x$value$desc, y$value$desc)
-    )
-  }
+  rd_section(""minidesc"", rbind(x$value, y$value))
 }
 
+# Rd Output -------------------------------------------------------------------
+
 #' @export
 format.rd_section_minidesc <- function(x, ...) {
-  title <- switch(x$value$type,
-    generic = ""Methods (by class)"",
-    class = ""Methods (by generic)"",
-    ""function"" = ""Functions""
-  )
+  order <- intersect(c(""generic"", ""class"", """"), unique(x$value$extends))
+  by <- factor(x$value$extends, levels = order)
+  subsections <- split(x$value, by)
+  body <- purrr::map2_chr(subsections, names(subsections), format_section)
+
+  paste0(body, collapse = ""\n"")
+}
+
+format_section <- function(df, type) {
+  if (type == ""class"") {
+    title <- paste0(
+      ""Methods for class \\code{"", escape(df$class[[1]]), ""}""
+    )
+  } else if (type == ""generic"") {
+    title <- paste0(
+      ""Methods for generic \\code{"", escape(df$generic[[1]]), ""()}""
+    )
+  } else {
+    title <- ""Related functions""
+  }
 
-  paste0(
-    ""\\section{"", title, ""}{\n"",
+  bullets <- paste0(""\\code{"", escape(df$name), ""}: "", df$desc)
+  body <- paste0(
     ""\\itemize{\n"",
-    paste0(""\\item \\code{"", escape(x$value$label), ""}: "", x$value$desc,
-      collapse = ""\n\n""),
-    ""\n}}\n""
+    paste0(""  \\item "", bullets, ""\n"", collapse = """"),
+    ""}\n""
   )
+
+  paste0(""\\section{"", title, ""}{\n"", body, ""}"")
 }
 
 # Helpers -----------------------------------------------------------------
@@ -92,36 +132,68 @@ find_object <- function(name, env) {
   }
 }
 
-build_label <- function(src, dest, block) {
+#' Build metadata for how to present `@describeIn` tag
+#' @return list of character scalars named `extends`, `generic`, `class`.
+#' See rd_section_minidesc() for details.
+#' @noRd
+build_minidesc_metadata <- function(src, dest) {
   src_type <- class(src)[1]
   dest_type <- class(dest)[1]
-
-  if (dest_type == ""s4class"" && src_type == ""s4method"") {
-    # Label S4 methods in class with their generic
-    type <- ""class""
-    label <- as.character(src$value@generic)
-  } else if (dest_type == ""s4generic"" && src_type == ""s4method"") {
-    # Label S4 methods in generic with their signature
-    type <- ""generic""
-    sig <- src$value@defined
-    if (length(sig) == 1) {
-      label <- as.character(sig)
+  dest_name <- as.character(dest$topic)
+
+  if (src_type == ""s3method"") {
+    generic <- attr(src$value, ""s3method"")[1]
+    class <- attr(src$value, ""s3method"")[2]
+    if (dest_type == ""s3generic"" && generic == dest_name) {
+      # src method fits dest generic
+      extends <- ""generic""
+    } else if (fits_constructor(dest_name, src)) {
+      # src method fits informal dest constructor (heuristically)
+      extends <- ""class""
     } else {
-      label <- paste0(names(sig), "" = "", sig, collapse = "","")
+      extends <- """"
     }
-  } else if (dest_type == ""function"" && src_type == ""s3method"") {
-    # Assuming you document S3 methods in the class constructor
-    type <- ""class""
-    label <- attr(src$value, ""s3method"")[1]
-  } else if (dest_type == ""s3generic"" && src_type == ""s3method"") {
-    # Label S3 methods in generic with their class
-    type <- ""generic""
-    label <- attr(src$value, ""s3method"")[2]
+  } else if (src_type == ""s4method"") {
+    generic <- as.character(src$value@generic)
+    class <- sig2class(src$value@defined)
+    if (dest_type == ""s4generic"") {
+      # TODO must test whether src method fits dest generic
+      extends <- ""generic""
+    } else if (dest_type == ""s4class"") {
+      extends <- ""class""
+      # TODO must test whether src method fits dest constructor
+    } else {
+      extends <- """"
+    }
+  } else {
+    generic <- """"
+    class <- """"
+    extends <- """"
+  }
+  list(extends = extends, generic = generic, class = class)
+}
+
+# Turn S4 signature into a string
+sig2class <- function(sig) {
+  if (length(sig) == 1) {
+    as.character(sig)
   } else {
-    # Otherwise just fallback to function + topic
-    type <- ""function""
-    label <- src$topic
+    paste0(names(sig), "" = "", sig, collapse = "","")
   }
+}
+
+# Is destination is probably constructor for src?
+fits_constructor <- function(dest_name, src) {
+  src_class <- attr(src$value, ""s3method"")[2]
+
+  # simple case where class name is the same as the constructor name
+  if (src_class == dest_name) {
+    return(TRUE)
+  }
+
+  # more complex case where class name = package name + constructor name
+  evalenv <- roxy_meta_get(""env"") %||% parent.frame() # needed for tests
+  pkg_name <- utils::packageName(evalenv) %||% """"
 
-  list(type = type, label = label)
+  src_class == paste0(pkg_name, ""_"", dest_name)
 }

---FILE: tests/testthat/_snaps/rd-describe-in.md---
@@ -1,3 +1,67 @@
+# Multiple @describeIn functions combined into one
+
+    Code
+      out$get_section(""minidesc"")
+    Output
+      \section{Related functions}{
+      \itemize{
+        \item \code{square}: Square a number
+        \item \code{cube}: Cube a number
+      }
+      } 
+
+# multiple methods and others are combined into a generic
+
+    Code
+      out$get_section(""minidesc"")
+    Output
+      \section{Methods for generic \code{zap()}}{
+      \itemize{
+        \item \code{zap.numeric}: method
+        \item \code{zap.character}: method
+      }
+      }
+      \section{Related functions}{
+      \itemize{
+        \item \code{print.qux}: function (method for different generic)
+        \item \code{zap_helper}: function
+      }
+      } 
+
+# multiple methods and others are combined into a class constructor
+
+    Code
+      out$get_section(""minidesc"")
+    Output
+      \section{Methods for class \code{foo}}{
+      \itemize{
+        \item \code{print.foo}: method
+        \item \code{format.foo}: method
+      }
+      }
+      \section{Related functions}{
+      \itemize{
+        \item \code{format.bar}: function (method for different class)
+        \item \code{is_foo}: function
+      }
+      } 
+
+---
+
+    Code
+      out$get_section(""minidesc"")
+    Output
+      \section{Methods for class \code{roxygen2_baz}}{
+      \itemize{
+        \item \code{print.roxygen2_baz}: method
+      }
+      }
+      \section{Related functions}{
+      \itemize{
+        \item \code{format.quuz_baz}: function (method for another class)
+      }
+      } 
+
 # complains about bad usage
 
     [<text>:6] @describeIn must be used with an object
@@ -10,7 +74,3 @@
 
     [<text>:6] @describeIn can not be used with @rdname
 
-# useful error if can't combine
-
-    [<text>:9] Don't know how to combine @describeIn types ""function"" and ""class""
-

---FILE: tests/testthat/test-rd-describe-in.R---
@@ -1,4 +1,4 @@
-test_that(""@describeIn generic captures s3 method class"", {
+test_that(""@describeIn generic destination captures s3 method source"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' Title
     f <- function(x) UseMethod('f')
@@ -7,24 +7,27 @@ test_that(""@describeIn generic captures s3 method class"", {
     #'
     f.a <- function(x) 1
   "")[[1]]
-
-  expect_equal(out$get_value(""minidesc"")$type, ""generic"")
-  expect_equal(out$get_value(""minidesc"")$label, ""a"")
+  expect_equal(out$get_value(""minidesc"")$extends, ""generic"")
+  expect_equal(out$get_value(""minidesc"")$generic, ""f"")
+  expect_equal(out$get_value(""minidesc"")$class, ""a"")
 })
 
-test_that(""@describeIn generic captures s4 method class"", {
+test_that(""@describeIn generic destination captures s4 method source"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' Title
     setGeneric('f', function(x) standardGeneric('f'))
 
     #' @describeIn f Method for a
     setMethod(f, signature('a'), function(x) 1)
   "")[[1]]
+  out$get_value(""minidesc"")
 
-  expect_equal(out$get_value(""minidesc"")$label, ""a"")
+  expect_equal(out$get_value(""minidesc"")$extends, ""generic"")
+  expect_equal(out$get_value(""minidesc"")$generic, ""f"")
+  expect_equal(out$get_value(""minidesc"")$class, ""a"")
 })
 
-test_that(""@describeIn class captures s3 generic name"", {
+test_that(""@describeIn constructor destination captures s3 method source"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' Title
     boo <- function() structure(list(), class = 'boo')
@@ -34,10 +37,12 @@ test_that(""@describeIn class captures s3 generic name"", {
     mean.boo <- function(x) 1
     "")[[1]]
 
-  expect_equal(out$get_value(""minidesc"")$label, ""mean"")
+  expect_equal(out$get_value(""minidesc"")$extends, ""class"")
+  expect_equal(out$get_value(""minidesc"")$generic, ""mean"")
+  expect_equal(out$get_value(""minidesc"")$class, ""boo"")
 })
 
-test_that(""@describeIn class captures s4 generic name"", {
+test_that(""@describeIn constructor destination captures s4 method source"", {
   out <- roc_proc_text(rd_roclet(), ""
     setGeneric('mean')
 
@@ -47,63 +52,129 @@ test_that(""@describeIn class captures s4 generic name"", {
     #' @describeIn a mean method
     setMethod('mean', 'a', function(x) 1)
     "")[[1]]
+  out$get_value(""minidesc"")
+  expect_equal(out$get_value(""minidesc"")$extends, ""class"")
+  expect_equal(out$get_value(""minidesc"")$generic, ""mean"")
+  expect_equal(out$get_value(""minidesc"")$class, ""a"")
+})
+
+test_that(""@describeIn function destination captures function source"", {
+  out <- roc_proc_text(rd_roclet(), ""
+    #' Title
+    f <- function(x) 1
 
-  expect_equal(out$get_value(""minidesc"")$label, ""mean"")
+    #' @describeIn f A
+    f2 <- function(x) 1
+    "")[[1]]
+
+  expect_equal(out$get_value(""minidesc"")$name, ""f2"")
+  expect_equal(out$get_value(""minidesc"")$extends, """")
+  expect_equal(out$get_value(""minidesc"")$generic, """")
+  expect_equal(out$get_value(""minidesc"")$class, """")
 })
 
-test_that(""Multiple @describeIn generic combined into one"", {
+test_that(""@describeIn class captures function name with data"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' Title
-    f <- function(x) UseMethod('f')
+    #' @name f
+    NULL
 
     #' @describeIn f A
-    f.a <- function(x) 1
+    f2 <- function(x) 1
+    "")[[1]]
+
+  expect_equal(out$get_value(""minidesc"")$name, ""f2"")
+})
 
-    #' @describeIn f B
-    f.b <- function(x) 1
+test_that(""@describeIn class captures function description"", {
+  out <- roc_proc_text(rd_roclet(), ""
+  #' Title
+  f <- function(x) 1
+
+  #' @describeIn f A
+  f2 <- function(x) 1
   "")[[1]]
 
-  expect_equal(out$get_value(""minidesc"")$type, ""generic"")
-  expect_equal(out$get_value(""minidesc"")$label, c(""a"", ""b""))
-  expect_equal(out$get_value(""minidesc"")$desc, c(""A"", ""B""))
+  expect_equal(out$get_value(""minidesc"")$desc, ""A"")
 })
 
-
-test_that(""all other combinations fallback to function list"", {
+test_that(""Multiple @describeIn functions combined into one"", {
   out <- roc_proc_text(rd_roclet(), ""
-    #' Generic
-    foo <- function(x) UseMethod('foo')
+    #' Power
+    #' @param x base
+    #' @param exp exponent
+    power <- function(x, exp) x ^ exp
 
-    #' @describeIn foo related function
-    bar <- function(y) {}
-  "")[[1]]
+    #' @describeIn power Square a number
+    square <- function(x) power(x, 2)
+
+    #' @describeIn power Cube a number
+    cube <- function(x) power(x, 3)
+    ""
+  )[[1]]
 
-  expect_equal(out$get_value(""minidesc"")$type, ""function"")
+  expect_snapshot(out$get_section(""minidesc""))
 })
 
-test_that(""@describeIn class captures function name"", {
+test_that(""multiple methods and others are combined into a generic"", {
   out <- roc_proc_text(rd_roclet(), ""
-    #' Title
-    f <- function(x) 1
+    #' Zap generic
+    #'
+    #' @param x Object to zap.
+    zap <- function(x) UseMethod('zap')
 
-    #' @describeIn f A
-    f2 <- function(x) 1
-    "")[[1]]
+    #' @describeIn zap method
+    zap.numeric <- function(x) {}
+
+    #' @describeIn zap method
+    zap.character <- function(x) {}
+
+    #' @describeIn zap function (method for different generic)
+    print.qux <- function(x) {}
+
+    #' @describeIn zap function
+    zap_helper <- function(x) {}
+    ""
+  )[[1]]
 
-  expect_equal(out$get_value(""minidesc"")$label, ""f2"")
+  expect_snapshot(out$get_section(""minidesc""))
 })
 
-test_that(""@describeIn class captures function name with data"", {
+test_that(""multiple methods and others are combined into a class constructor"", {
   out <- roc_proc_text(rd_roclet(), ""
-    #' Title
-    #' @name f
-    NULL
+    #' Class constructor
+    #'
+    #' @param x x
+    foo <- function(x) {}
 
-    #' @describeIn f A
-    f2 <- function(x) 1
-    "")[[1]]
+    #' @describeIn foo method
+    print.foo <- function(x) {}
 
-  expect_equal(out$get_value(""minidesc"")$label, ""f2"")
+    #' @describeIn foo method
+    format.foo <- function(x) {}
+
+    #' @describeIn foo function (method for different class)
+    format.bar <- function(x) {}
+
+    #' @describeIn foo function
+    is_foo <- function(x) {}
+  "")[[1]]
+  expect_snapshot(out$get_section(""minidesc""))
+
+  # more complicated with disambiguated class name ""pkg_class""
+  out <- roc_proc_text(rd_roclet(), ""
+    #' Class constructor with disambiguated class
+    #'
+    #' @param x x
+    baz <- function(x) {}
+
+    #' @describeIn baz method
+    print.roxygen2_baz <- function(x) {}
+
+    #' @describeIn baz function (method for another class)
+    format.quuz_baz <- function(x) {}""
+  )[[1]]
+  expect_snapshot(out$get_section(""minidesc""))
 })
 
 test_that(""function names are escaped"", {
@@ -114,10 +185,10 @@ test_that(""function names are escaped"", {
     #' @describeIn foo shortcut for foo
     `%foo%` <- function(x, y) foo(x, y)
     "")[[1]]
+  out
   expect_match(out$get_rd(""minidesc""), ""\\\\%foo\\\\%"")
 })
 
-
 test_that(""complains about bad usage"", {
   expect_snapshot_warning(
     roc_proc_text(rd_roclet(), ""
@@ -153,19 +224,3 @@ test_that(""complains about bad usage"", {
     )
   )
 })
-
-test_that(""useful error if can't combine"", {
-  expect_snapshot_warning(
-    roc_proc_text(rd_roclet(), ""
-      #' Class
-      setClass('describeInfoo')
-
-      #' @describeIn describeInfoo generic
-      setGeneric('bar', function(x) standardGeneric('bar'))
-
-      #' @describeIn describeInfoo method
-      setMethod('bar','describeInfoo', function(x) 1)
-    "")
-  )
-
-})

---FILE: vignettes/reuse.Rmd---
@@ -37,62 +37,38 @@ Use it when all functions have the same (or very similar) arguments.
 
 ### `@describeIn`
 
-`@describeIn` is designed for the most common cases:
+Use `@describeIn <destination> <description>` to document mutiple functions together.
+It generates a new section named ""**Related functions and methods**"", further divided into subsections by the type of relationship between the source and the destination documentation.
+Each subsection contains a bulleted list describing the function with the specified `<description>`.
 
--   documenting methods in a generic
--   documenting methods in a class
--   documenting functions with the same (or similar arguments)
-
-It generates a new section, named either ""Methods (by class)"", ""Methods (by generic)"" or ""Functions"".
-The section contains a bulleted list describing each function, labelled so that you know what function or method it's talking about.
-Here's an example documenting an imaginary new generic:
+You can document several functions which perform slight variations of a task or which use different defaults in one documentation file:
 
 ```{r}
-#' Foo bar generic
-#'
-#' @param x Object to foo.
-foobar <- function(x) UseMethod(""x"")
+#' Power
+#' @param x base
+#' @param exp exponent
+power <- function(x, exp) x ^ exp
 
-#' @describeIn foobar Difference between the mean and the median
-foobar.numeric <- function(x) abs(mean(x) - median(x))
+#' @describeIn power Square a number
+square <- function(x) power(x, 2)
 
-#' @describeIn foobar First and last values pasted together in a string.
-foobar.character <- function(x) paste0(x[1], ""-"", x[length(x)])
+#' @describeIn power Cube a number
+cube <- function(x) power(x, 3)
 ```
 
-### `@rdname`
+In this case, both destination and source are ""normal"" functions, and you can use `<description>` to explain their differences.
 
-`@rdname` is a more general-purpose tool.
-It overrides the default file name generated by roxygen and merges documentation for multiple objects into one file.
-This gives you complete freedom to combine documentation however you see fit.
-There are two ways to use `@rdname`.
-You can add documentation to an existing function:
+`@describeIn` is also well suited to explain the relationships between functions making up an object oriented (OO) scheme using S3 or S4.
+In this case, roxygen will automatically detect whether a source function is a method and document the relationship to the relevant class or generic.
+Your new methods will be organised in one of two ways:
 
-```{r}
-#' Basic arithmetic
-#'
-#' @param x,y numeric vectors.
-add <- function(x, y) x + y
+1.  If your new method extends a generic in the `<destination>`, it will be listed in a section titled ""**Methods for generic `<destination>`**"".
+    The subsection will include all methods for your new generic, labelled by the class they cover.
 
-#' @rdname add
-times <- function(x, y) x * y
-```
+2.  If your new method extends another generic, for a class constructed in the destination, it will be listed in a subsection titled ""**Methods for class `<destination>`**"".
+    It will be labelled by the generic which the method extends.
 
-Or, you can create a dummy documentation file by documenting `NULL` and setting an informative `@name`.
-
-```{r}
-#' Basic arithmetic
-#'
-#' @param x,y numeric vectors.
-#' @name arith
-NULL
-
-#' @rdname arith
-add <- function(x, y) x + y
-
-#' @rdname arith
-times <- function(x, y) x * y
-```
+While you can mix and match (some) different types of functions with `@describeIn`, the output may quickly become disorienting for users if the functions are not tightly related.
 
 ### Order of includes
 "
r-lib,roxygen2,4fd1e890d0b0d09cf464ea5b48795eec435aff8b,Hadley Wickham,h.wickham@gmail.com,2022-07-15T18:46:06Z,GitHub,noreply@github.com,2022-07-15T18:46:06Z,"Store tag descriptions in inst/tags.yml (#1402)

Fixes #1375",DESCRIPTION;NAMESPACE;NEWS.md;R/tag-metadata.R;R/tag-parser.R;_pkgdown.yml;inst/roxygen2-tags.yml;man/load_options.Rd;man/tags-index-crossref.Rd;man/tags-namespace.Rd;man/tags-rd-formatting.Rd;man/tags-rd-other.Rd;man/tags-rd.Rd;man/tags-reuse.Rd;man/tags_list.Rd;tests/testthat/test-tag-metadata.R;vignettes/index-crossref.Rmd;vignettes/rd-formatting.Rmd;vignettes/rd-other.Rmd;vignettes/rd.Rmd;vignettes/reuse.Rmd,True,True,True,False,912,77,989,"---FILE: DESCRIPTION---
@@ -42,11 +42,12 @@ Suggests:
     R.oo,
     rmarkdown,
     testthat (>= 3.1.2),
+    yaml
 LinkingTo: 
     cpp11
 VignetteBuilder: 
     knitr
-Config/Needs/website: tidyverse/tidytemplate
+Config/Needs/website: r-lib/pkgdown, tidyverse/tidytemplate
 Config/testthat/edition: 3
 Encoding: UTF-8
 Language: en-GB

---FILE: NAMESPACE---
@@ -240,6 +240,8 @@ export(tag_two_part)
 export(tag_value)
 export(tag_words)
 export(tag_words_line)
+export(tags_list)
+export(tags_metadata)
 export(update_collate)
 export(vignette_roclet)
 export(warn_roxy_tag)

---FILE: NEWS.md---
@@ -1,5 +1,13 @@
 # roxygen2 (development version)
 
+* All built-in tags are now documented so that you can do (e.g.) `?""@param""`
+  to get a basic description of `@param` and a pointer where to learn more 
+  (#1165).
+
+* New `tags_list()` lists all tags defined by roxygen2 and
+  `tags_metadata()` provides some useful information about them for
+  use by (e.g.) IDEs (#1375).
+
 * roxygen2 now only only includes PDF figures generated via markdown in
   the PDF manual, and only includes SVG figures generated via markdown
   in the HTML manual (#1399).

---FILE: R/tag-metadata.R---
@@ -0,0 +1,102 @@
+#' Access metadata about built-in tags
+#'
+#' @export
+#' @keywords internal
+tags_list <- function(built_in = TRUE) {
+  if (isTRUE(built_in)) {
+    methods <- attr(methods('roxy_tag_parse'), ""info"")
+    methods <- methods[methods$from == ""roxygen2"", ]
+    methods <- rownames(methods)[-1]
+  } else {
+    # Needed since the info attribute doesn't seem to exist
+    # during R CMD check
+    methods <- as.character(methods('roxy_tag_parse'))[-1]
+  }
+  sort(sub('.*\\.roxy_tag_', '', methods))
+}
+
+#' @export
+#' @rdname tags_list
+tags_metadata <- function() {
+  check_installed(""yaml"")
+
+  meta <- yaml::read_yaml(yaml_path())
+  data.frame(
+    tag = map_chr(meta, ""name""),
+    description = map_chr(meta, ""description""),
+    # \n not useful outside of RStudio
+    template = sub(""\n"", """", map_chr(meta, ""template"")),
+    vignette = map_chr(meta, ""vignette"", .default = NA),
+    recommend = map_lgl(meta, ""recommend"", .default = FALSE),
+    stringsAsFactors = FALSE
+  )
+}
+
+yaml_path <- function() {
+  system.file(""roxygen2-tags.yml"", package = ""roxygen2"")
+}
+
+tags_rd <- function(type) {
+  tags <- tags_metadata()
+  tags <- tags[tags$vignette == type & !is.na(tags$vignette), ]
+
+  c(
+    paste0(""@name tags-"", type),
+    ""@aliases"",
+    tags_rd_section(tags, ""aliases""),
+    ""@description"",
+    paste0(""Learn full the details in in `vignette('"", type, ""')`.""),
+    """",
+    if (any(tags$recommend)) c(
+      ""Key tags:"",
+      tags_rd_section(tags[tags$recommend, ], ""description"")
+    ),
+    if (any(!tags$recommend)) c(
+      ""Other less frequently used tags:"",
+      """",
+      tags_rd_section(tags[!tags$recommend, ], ""description"")
+    ),
+    ""@usage"",
+    tags_rd_section(tags, ""usage"")
+  )
+}
+tags_rd_section <- function(tags, section) {
+  if (nrow(tags) == 0) return()
+
+  switch(section,
+    aliases = c(paste0(""  @"", tags$tag), ""  NULL""),
+    usage = paste0(""#' @"", tags$tag, tags$template),
+    description = paste0(""* `@"", tags$tag, tags$template, ""`: "", tags$description)
+  )
+}
+
+#' Tags for documenting functions
+#'
+#' @eval tags_rd(""rd"")
+NULL
+
+#' Tags for documenting datasets and classes
+#'
+#' @eval tags_rd(""rd-other"")
+NULL
+
+#' Tags that help you reuse documentation
+#'
+#' @eval tags_rd(""reuse"")
+NULL
+
+#' Tags for managing the `NAMESPACE`
+#'
+#' @eval tags_rd(""namespace"")
+NULL
+
+#' Tags related to markdown support
+#'
+#' @eval tags_rd(""rd-formatting"")
+NULL
+
+#' Tags for indexing and cross-references
+#'
+#' @eval tags_rd(""index-crossref"")
+NULL
+

---FILE: R/tag-parser.R---
@@ -29,6 +29,12 @@ tag_value <- function(x) {
   }
 }
 
+# Also recorded in tags.yml
+inherit_components <- c(
+  ""params"", ""return"", ""title"", ""description"", ""details"", ""seealso"",
+  ""sections"", ""references"", ""examples"", ""author"", ""source"", ""note""
+)
+
 #' @export
 #' @rdname tag_parsers
 tag_inherit <- function(x) {
@@ -42,9 +48,7 @@ tag_inherit <- function(x) {
     pieces <- str_split(str_trim(x$raw), ""\\s+"")[[1]]
     fields <- pieces[-1]
 
-    # Also recorded in `rd.Rmd`
-    all <- c(""params"", ""return"", ""title"", ""description"", ""details"", ""seealso"",
-      ""sections"", ""references"", ""examples"", ""author"", ""source"", ""note"")
+    all <- inherit_components
     if (length(fields) == 0) {
       fields <- all
     } else {

---FILE: _pkgdown.yml---
@@ -17,6 +17,10 @@ home:
     href: https://r-pkgs.org/man.html
 
 reference:
+- title: Tags
+  contents:
+  - starts_with(""tags"")
+
 - title: Roclets
   contents:
   - ends_with(""roclet"")
@@ -38,10 +42,10 @@ articles:
 - title: Documentation
   navbar: Documentation
   contents:
-  - roxygen2
   - rd
   - rd-other
   - reuse
+  - index-crossref
   - rd-formatting
 
 - title: NAMESPACE

---FILE: inst/roxygen2-tags.yml---
@@ -0,0 +1,413 @@
+- name: aliases
+  description: >
+    Add additional aliases to the topic. Use `NULL` to suppress
+    the default alias automatically generated by roxygen2.
+  template: ' {alias}'
+  vignette: index-crossref
+  recommend: true
+
+- name: author
+  description: >
+    Topic author(s), if different from the package author(s).
+  template: ' {author}'
+  recommend: true
+
+- name: backref
+  description: >
+    Manually override the backreference that points from the `.Rd` file back to
+    the source `.R` file. Only needed when generating code.
+  template: ' {path}'
+  vignette: index-crossref
+
+- name: concept
+  description: >
+    Add additional keywords or phrases to be included in the `help.search()`
+    index. Each `@concept` should be a single term or phrase.
+  template: ' {concept}'
+  vignette: index-crossref
+  recommend: true
+
+- name: describeIn
+  description: >
+    Document a function or method in the `destination` topic.
+  template: ' {destination} {description}'
+  vignette: reuse
+  recommend: true
+
+- name: description
+  description: >
+    A short description of the purpose of the function. Usually around
+    a paragraph, but can be longer if needed.
+  template: ""\n""
+  vignette: rd
+  recommend: true
+
+- name: details
+  description: >
+    Additional details about the function. Generally superseded by instead
+    using a level 1 heading.
+  template: ""\n""
+  vignette: rd
+
+- name: docType
+  description: >
+    Set documentation type. One of `data`, `package`, `class`, or `methods`.
+    Usually added automatically; for expert use only.
+  template: ' data|package|class|methods'
+
+- name: encoding
+  description: >
+    Override encoding of single `.Rd` file. No longer recommended since
+    all documentation should use UTF-8.
+  template: ' {encoding}'
+
+- name: eval
+  description: >
+    Evaluate arbitrary code in the package namespace and insert the results
+    back into the block. Should return a character vector of lines.
+  template: ' {r-code}'
+  vignette: reuse
+
+- name: evalNamespace
+  description: >
+    Evaluate arbitrary code in the package namespace and insert the results
+    into the `NAMESPACE`. Should return a character vector of directives.
+  template: ' {r-code}'
+  vignette: namespace
+
+- name: evalRd
+  description: >
+    Evaluate arbitrary code in the package namespace and insert the results
+    back as into the block. Should return a character vector of lines.
+  template: ' {r-code}'
+  vignette: reuse
+
+- name: example
+  description: >
+    Embed examples stored in another file.
+  template: ' {path}'
+  vignette: rd
+  recommend: true
+
+- name: examples
+  description: >
+    Executable R code that demonstrates how the function works. Code must run
+    without error.
+  template: ""\n""
+  vignette: rd
+  recommend: true
+
+- name: examplesIf
+  description: >
+    Run examples only when `condition` is `TRUE`.
+  template: "" {condition}\n""
+  vignette: rd
+  recommend: true
+
+- name: export
+  description: >
+    Export this function, method, generic, or class so it's available
+    outside of the package.
+  template: """"
+  vignette: namespace
+  recommend: true
+
+- name: exportClass
+  description: >
+    Export an S4 class. For expert use only; in most cases you should use
+    `@export` so roxygen2 can automatically generate the correct directive.
+  template: ' {class}'
+  vignette: namespace
+
+- name: exportMethod
+  description: >
+    Export S4 methods. For expert use only; in most cases you should use
+    `@export` so roxygen2 can automatically generate the correct directive.
+  template: ' {generic}'
+  vignette: namespace
+
+- name: exportPattern
+  description: >
+    Export all objects matching a regular expression.
+  template: ' {pattern}'
+  vignette: namespace
+
+- name: exportS3Method
+  description: >
+    Export an S3 method. Only needed when the method is for a generic from a
+    suggested package.
+  template: ' pkg::generic'
+  vignette: namespace
+  recommend: true
+
+- name: family
+  description: >
+    Generate `@seealso` entries to all other functions in `family name`.
+  template: ' {family name}'
+  vignette: index-crossref
+  recommend: true
+
+- name: field
+  description: >
+    Describe a R6 or refClass field.
+  template: ' {name} {description}'
+  vignette: rd-other
+  recommend: true
+
+- name: format
+  description: >
+    Describe the type/shape of a dataset. If the dataset is a data frame,
+    include a description of each column. If not supplied, will be
+    automatically generated by `object_format()`.
+  template: ' {description}'
+  vignette: rd-other
+  recommend: true
+
+- name: import
+  description: >
+    Import all functions from a package. Use with extreme care.
+  template: ' {package}'
+  vignette: namespace
+
+- name: importClassesFrom
+  description: >
+    Import S4 classes from another package.
+  template: ' {package} {class}'
+  vignette: namespace
+
+- name: importFrom
+  description: >
+    Import specific functions from a package.
+  template: ' {package} {function}'
+  vignette: namespace
+  recommend: true
+
+- name: importMethodsFrom
+  description: >
+    Import S4 methods from a package.
+  template: ' {package} {generic}'
+  vignette: namespace
+
+- name: include
+  description: >
+    Declare that `filename.R` must be loaded before the current file.
+  template: ' {filename.R}'
+  recommend: true
+
+- name: includeRmd
+  description: >
+    Insert the contents of an `.Rmd` into the current block. Superseded
+    in favour of using a code chunk with a child document.
+  template: ' {path}'
+  vignette: reuse
+
+- name: inherit
+  description: >
+    Inherit one or more documentation components from another topic.
+    If `components` is omitted, all supported components will be inherited.
+    Otherwise, specify individual components to inherit by picking one or
+    more of `params`, `return`, `title`, `description`, `details`, `seealso`,
+    `sections`, `references`, `examples`, `author`, `source`, and `note`.
+  template: ' {source} {components}'
+  vignette: reuse
+  recommend: true
+
+- name: inheritDotParams
+  description: >
+    Automatically generate documentation for `...` when you're passing dots
+    along to another function.
+  template: ' {source} {arg1 arg2 arg3}'
+  vignette: reuse
+  recommend: true
+
+- name: inheritParams
+  description: >
+    Inherit argument documentation from another function. Only inherits
+    documentation for arguments that aren't already documented locally.
+  template: ' {source}'
+  vignette: reuse
+  recommend: true
+
+- name: inheritSection
+  description: >
+    Inherit a specific named section from another topic.
+  template: ' {source} {section name}'
+  vignette: reuse
+  recommend: true
+
+- name: keywords
+  description: >
+    Add a standardised keyword, indexed by `help.search()`. These are generally
+    not useful apart from `@keyword internal` which flags the topic as internal
+    and removes from topic indexes.
+  template: ' {keyword}'
+  vignette: index-crossref
+  recommend: true
+
+- name: md
+  description: >
+    Force markdown processing for a block.
+  template: ''
+  vignette: rd-formatting
+
+- name: method
+  description: >
+    Force a function to be recognised as an S3 method. This affects the
+    default usage and the `NAMESPACE` directive produced by `@export`.
+    Only needed if automatic detection fails.
+  template: ' {generic} {class}'
+  vignette: rd-other
+  recommend: true
+
+- name: name
+  description: >
+    Define (or override the topic) name. Typically only needed for synthetic
+    topics where you are documenting `NULL`.
+  template: ' {name}'
+
+- name: noMd
+  description: >
+    Suppress markdown processing for a block.
+  template: ''
+  vignette: 'rd-formatting'
+
+- name: noRd
+  description: >
+    Suppress `.Rd` generation for a block. Use for documentation blocks that
+    should only be visible in the source code.
+  template: ''
+  vignette: 'rd'
+  recommend: true
+
+- name: note
+  description: >
+    Add an optional note. Now generally superseded by
+    using a level 1 markdown heading.
+  template: ""\n""
+
+- name: order
+  description: >
+    Override the default (lexigraphic) order in which multiple blocks
+    are combined into a single topic.
+  template: ' {number}'
+  vignette: reuse
+  recommend: true
+
+- name: param
+  description: >
+    Describe a function input. Should describe acceptable input types
+    and how it affects the output. `description` is usually one or two
+    sentences but can be as long as needed. Document multiple arguments
+    by separating their names with commas without spaces.
+  template: ' {name} {description}'
+  vignette: rd
+  recommend: true
+
+- name: rawNamespace
+  description: >
+    Insert literal text directly into the `NAMESPACE`.
+  template: ' {namespace directives}'
+  vignette: namespace
+
+- name: rawRd
+  description: >
+    Insert literal text directly into the `.Rd` file.
+  template: ' {rd}'
+  vignette: rd
+
+- name: rdname
+  description: >
+    Override the file name of generated `.Rd` file. Can be used to
+    combine multiple blocks into a single documentation topic.
+  template: ' {topic-name}'
+  vignette: reuse
+  recommend: true
+
+- name: references
+  description: >
+    Pointers to the related literature. Usually formatted like a bibliography.
+  template: ' {reference}'
+  vignette: index-crossref
+  recommend: true
+
+- name: return
+  description: >
+    Describe the function's output. Superseded in favour of `@returns`.
+  template: ' {description}'
+  vignette: rd
+
+- name: returns
+  description: >
+    Describe the function's output. Typically will be a 1-2 sentence
+    description of the output type, but might also include discussion
+    of important errors or warnings.
+  template: ' {description}'
+  vignette: rd
+  recommend: true
+
+- name: section
+  description: >
+    Add an arbitrary section to the documentation. Now generally superseded
+    in favour of using a level 1 heading.
+  template: "" {section title}:\n""
+  vignette: rd-formatting
+
+- name: seealso
+  description: >
+    Link to other related functions or urls. Usually a sentence or two, or
+    a bulleted list.
+  template: ' {[func1()], <url1>}'
+  vignette: index-crossref
+  recommend: true
+
+- name: slot
+  description: >
+    Describe the slot of an S4 class.
+  template: ' {name} {description}'
+  vignette: rd-other
+  recommend: true
+
+- name: source
+  description: >
+    Describe where the dataset came from. Provide a link to the original
+    source (if possible) and briefly describe any manipulation that you
+    performed when importing the data.
+  template: ' {description}'
+  vignette: rd-other
+  recommend: true
+
+- name: template
+  description: >
+    Use a roxygen2 template. Now superseded in favour of inline R code.
+  template: ' {path-to-template}'
+  vignette: reuse
+
+- name: templateVar
+  description: >
+    Define variables for use in a roxygen2 template.
+  template: ' {name} {value}'
+  vignette: reuse
+
+- name: title
+  description: >
+    A one-line description of the function shown in various indexes.
+    An explicit `@title` is not usually needed as by default it is taken from
+    the first paragraph in the roxygen block.
+  template: ' {title}'
+  vignette: rd
+  recommend: true
+
+- name: usage
+  description: >
+    Override the default usage generated by roxygen2. Only needed when
+    roxygen2 fails to correctly derive the usage of your function.
+  template: ' {function_call(arg1, arg2 = default, ...)}'
+  vignette: rd
+  recommend: true
+
+- name: useDynLib
+  description: >
+    Import compiled code from another package.
+  template: ' {package}'
+  vignette: namespace
+  recommend: true

---FILE: man/load_options.Rd---
@@ -36,7 +36,7 @@ Options in \code{man/roxygen/meta.R} override those present in \code{DESCRIPTION
 \item \code{knitr_chunk_options}: default chunk options used for knitr.
 \item \code{restrict_image_formats}: if \code{TRUE} then PDF images are only included in the
 PDF manual, and SVG images are only included in the HTML manual.
-(This only applies to images generated via markdown.)
+(This only applies to images supplied via markdown.)
 }
 }
 

---FILE: man/tags-index-crossref.Rd---
@@ -0,0 +1,38 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/tag-metadata.R
+\name{tags-index-crossref}
+\alias{@aliases}
+\alias{@backref}
+\alias{@concept}
+\alias{@family}
+\alias{@keywords}
+\alias{@references}
+\alias{@seealso}
+\title{Tags for indexing and cross-references}
+\usage{
+#' @aliases {alias}
+#' @backref {path}
+#' @concept {concept}
+#' @family {family name}
+#' @keywords {keyword}
+#' @references {reference}
+#' @seealso {[func1()], <url1>}
+}
+\description{
+Learn full the details in in \code{vignette('index-crossref')}.
+
+Key tags:
+\itemize{
+\item \verb{@aliases \{alias\}}: Add additional aliases to the topic. Use \code{NULL} to suppress the default alias automatically generated by roxygen2.
+\item \verb{@concept \{concept\}}: Add additional keywords or phrases to be included in the \code{help.search()} index. Each \verb{@concept} should be a single term or phrase.
+\item \verb{@family \{family name\}}: Generate \verb{@seealso} entries to all other functions in \verb{family name}.
+\item \verb{@keywords \{keyword\}}: Add a standardised keyword, indexed by \code{help.search()}. These are generally not useful apart from \verb{@keyword internal} which flags the topic as internal and removes from topic indexes.
+\item \verb{@references \{reference\}}: Pointers to the related literature. Usually formatted like a bibliography.
+\item \verb{@seealso \{[func1()], <url1>\}}: Link to other related functions or urls. Usually a sentence or two, or a bulleted list.
+}
+
+Other less frequently used tags:
+\itemize{
+\item \verb{@backref \{path\}}: Manually override the backreference that points from the \code{.Rd} file back to the source \code{.R} file. Only needed when generating code.
+}
+}

---FILE: man/tags-namespace.Rd---
@@ -0,0 +1,53 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/tag-metadata.R
+\name{tags-namespace}
+\alias{@evalNamespace}
+\alias{@export}
+\alias{@exportClass}
+\alias{@exportMethod}
+\alias{@exportPattern}
+\alias{@exportS3Method}
+\alias{@import}
+\alias{@importClassesFrom}
+\alias{@importFrom}
+\alias{@importMethodsFrom}
+\alias{@rawNamespace}
+\alias{@useDynLib}
+\title{Tags for managing the \code{NAMESPACE}}
+\usage{
+#' @evalNamespace {r-code}
+#' @export
+#' @exportClass {class}
+#' @exportMethod {generic}
+#' @exportPattern {pattern}
+#' @exportS3Method pkg::generic
+#' @import {package}
+#' @importClassesFrom {package} {class}
+#' @importFrom {package} {function}
+#' @importMethodsFrom {package} {generic}
+#' @rawNamespace {namespace directives}
+#' @useDynLib {package}
+}
+\description{
+Learn full the details in in \code{vignette('namespace')}.
+
+Key tags:
+\itemize{
+\item \verb{@export}: Export this function, method, generic, or class so it's available outside of the package.
+\item \verb{@exportS3Method pkg::generic}: Export an S3 method. Only needed when the method is for a generic from a suggested package.
+\item \verb{@importFrom \{package\} \{function\}}: Import specific functions from a package.
+\item \verb{@useDynLib \{package\}}: Import compiled code from another package.
+}
+
+Other less frequently used tags:
+\itemize{
+\item \verb{@evalNamespace \{r-code\}}: Evaluate arbitrary code in the package namespace and insert the results into the \code{NAMESPACE}. Should return a character vector of directives.
+\item \verb{@exportClass \{class\}}: Export an S4 class. For expert use only; in most cases you should use \verb{@export} so roxygen2 can automatically generate the correct directive.
+\item \verb{@exportMethod \{generic\}}: Export S4 methods. For expert use only; in most cases you should use \verb{@export} so roxygen2 can automatically generate the correct directive.
+\item \verb{@exportPattern \{pattern\}}: Export all objects matching a regular expression.
+\item \verb{@import \{package\}}: Import all functions from a package. Use with extreme care.
+\item \verb{@importClassesFrom \{package\} \{class\}}: Import S4 classes from another package.
+\item \verb{@importMethodsFrom \{package\} \{generic\}}: Import S4 methods from a package.
+\item \verb{@rawNamespace \{namespace directives\}}: Insert literal text directly into the \code{NAMESPACE}.
+}
+}

---FILE: man/tags-rd-formatting.Rd---
@@ -0,0 +1,22 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/tag-metadata.R
+\name{tags-rd-formatting}
+\alias{@md}
+\alias{@noMd}
+\alias{@section}
+\title{Tags related to markdown support}
+\usage{
+#' @md
+#' @noMd
+#' @section {section title}:
+}
+\description{
+Learn full the details in in \code{vignette('rd-formatting')}.
+
+Other less frequently used tags:
+\itemize{
+\item \verb{@md}: Force markdown processing for a block.
+\item \verb{@noMd}: Suppress markdown processing for a block.
+\item \verb{@section \{section title\}:}: Add an arbitrary section to the documentation. Now generally superseded in favour of using a level 1 heading.
+}
+}

---FILE: man/tags-rd-other.Rd---
@@ -0,0 +1,28 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/tag-metadata.R
+\name{tags-rd-other}
+\alias{@field}
+\alias{@format}
+\alias{@method}
+\alias{@slot}
+\alias{@source}
+\title{Tags for documenting datasets and classes}
+\usage{
+#' @field {name} {description}
+#' @format {description}
+#' @method {generic} {class}
+#' @slot {name} {description}
+#' @source {description}
+}
+\description{
+Learn full the details in in \code{vignette('rd-other')}.
+
+Key tags:
+\itemize{
+\item \verb{@field \{name\} \{description\}}: Describe a R6 or refClass field.
+\item \verb{@format \{description\}}: Describe the type/shape of a dataset. If the dataset is a data frame, include a description of each column. If not supplied, will be automatically generated by \code{object_format()}.
+\item \verb{@method \{generic\} \{class\}}: Force a function to be recognised as an S3 method. This affects the default usage and the \code{NAMESPACE} directive produced by \verb{@export}. Only needed if automatic detection fails.
+\item \verb{@slot \{name\} \{description\}}: Describe the slot of an S4 class.
+\item \verb{@source \{description\}}: Describe where the dataset came from. Provide a link to the original source (if possible) and briefly describe any manipulation that you performed when importing the data.
+}
+}

---FILE: man/tags-rd.Rd---
@@ -0,0 +1,53 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/tag-metadata.R
+\name{tags-rd}
+\alias{@description}
+\alias{@details}
+\alias{@example}
+\alias{@examples}
+\alias{@examplesIf}
+\alias{@noRd}
+\alias{@param}
+\alias{@rawRd}
+\alias{@return}
+\alias{@returns}
+\alias{@title}
+\alias{@usage}
+\title{Tags for documenting functions}
+\usage{
+#' @description
+#' @details
+#' @example {path}
+#' @examples
+#' @examplesIf {condition}
+#' @noRd
+#' @param {name} {description}
+#' @rawRd {rd}
+#' @return {description}
+#' @returns {description}
+#' @title {title}
+#' @usage {function_call(arg1, arg2 = default, ...)}
+}
+\description{
+Learn full the details in in \code{vignette('rd')}.
+
+Key tags:
+\itemize{
+\item \verb{@description}: A short description of the purpose of the function. Usually around a paragraph, but can be longer if needed.
+\item \verb{@example \{path\}}: Embed examples stored in another file.
+\item \verb{@examples}: Executable R code that demonstrates how the function works. Code must run without error.
+\item \verb{@examplesIf \{condition\}}: Run examples only when \code{condition} is \code{TRUE}.
+\item \verb{@noRd}: Suppress \code{.Rd} generation for a block. Use for documentation blocks that should only be visible in the source code.
+\item \verb{@param \{name\} \{description\}}: Describe a function input. Should describe acceptable input types and how it affects the output. \code{description} is usually one or two sentences but can be as long as needed. Document multiple arguments by separating their names with commas without spaces.
+\item \verb{@returns \{description\}}: Describe the function's output. Typically will be a 1-2 sentence description of the output type, but might also include discussion of important errors or warnings.
+\item \verb{@title \{title\}}: A one-line description of the function shown in various indexes. An explicit \verb{@title} is not usually needed as by default it is taken from the first paragraph in the roxygen block.
+\item \verb{@usage \{function_call(arg1, arg2 = default, ...)\}}: Override the default usage generated by roxygen2. Only needed when roxygen2 fails to correctly derive the usage of your function.
+}
+
+Other less frequently used tags:
+\itemize{
+\item \verb{@details}: Additional details about the function. Generally superseded by instead using a level 1 heading.
+\item \verb{@rawRd \{rd\}}: Insert literal text directly into the \code{.Rd} file.
+\item \verb{@return \{description\}}: Describe the function's output. Superseded in favour of \verb{@returns}.
+}
+}

---FILE: man/tags-reuse.Rd---
@@ -0,0 +1,53 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/tag-metadata.R
+\name{tags-reuse}
+\alias{@describeIn}
+\alias{@eval}
+\alias{@evalRd}
+\alias{@includeRmd}
+\alias{@inherit}
+\alias{@inheritDotParams}
+\alias{@inheritParams}
+\alias{@inheritSection}
+\alias{@order}
+\alias{@rdname}
+\alias{@template}
+\alias{@templateVar}
+\title{Tags that help you reuse documentation}
+\usage{
+#' @describeIn {destination} {description}
+#' @eval {r-code}
+#' @evalRd {r-code}
+#' @includeRmd {path}
+#' @inherit {source} {components}
+#' @inheritDotParams {source} {arg1 arg2 arg3}
+#' @inheritParams {source}
+#' @inheritSection {source} {section name}
+#' @order {number}
+#' @rdname {topic-name}
+#' @template {path-to-template}
+#' @templateVar {name} {value}
+}
+\description{
+Learn full the details in in \code{vignette('reuse')}.
+
+Key tags:
+\itemize{
+\item \verb{@describeIn \{destination\} \{description\}}: Document a function or method in the \code{destination} topic.
+\item \verb{@inherit \{source\} \{components\}}: Inherit one or more documentation components from another topic. If \code{components} is omitted, all supported components will be inherited. Otherwise, specify individual components to inherit by picking one or more of \code{params}, \code{return}, \code{title}, \code{description}, \code{details}, \code{seealso}, \code{sections}, \code{references}, \code{examples}, \code{author}, \code{source}, and \code{note}.
+\item \verb{@inheritDotParams \{source\} \{arg1 arg2 arg3\}}: Automatically generate documentation for \code{...} when you're passing dots along to another function.
+\item \verb{@inheritParams \{source\}}: Inherit argument documentation from another function. Only inherits documentation for arguments that aren't already documented locally.
+\item \verb{@inheritSection \{source\} \{section name\}}: Inherit a specific named section from another topic.
+\item \verb{@order \{number\}}: Override the default (lexigraphic) order in which multiple blocks are combined into a single topic.
+\item \verb{@rdname \{topic-name\}}: Override the file name of generated \code{.Rd} file. Can be used to combine multiple blocks into a single documentation topic.
+}
+
+Other less frequently used tags:
+\itemize{
+\item \verb{@eval \{r-code\}}: Evaluate arbitrary code in the package namespace and insert the results back into the block. Should return a character vector of lines.
+\item \verb{@evalRd \{r-code\}}: Evaluate arbitrary code in the package namespace and insert the results back as into the block. Should return a character vector of lines.
+\item \verb{@includeRmd \{path\}}: Insert the contents of an \code{.Rmd} into the current block. Superseded in favour of using a code chunk with a child document.
+\item \verb{@template \{path-to-template\}}: Use a roxygen2 template. Now superseded in favour of inline R code.
+\item \verb{@templateVar \{name\} \{value\}}: Define variables for use in a roxygen2 template.
+}
+}

---FILE: man/tags_list.Rd---
@@ -0,0 +1,15 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/tag-metadata.R
+\name{tags_list}
+\alias{tags_list}
+\alias{tags_metadata}
+\title{Access metadata about built-in tags}
+\usage{
+tags_list(built_in = TRUE)
+
+tags_metadata()
+}
+\description{
+Access metadata about built-in tags
+}
+\keyword{internal}

---FILE: tests/testthat/test-tag-metadata.R---
@@ -0,0 +1,3 @@
+test_that(""all exported tags included in tags.yml"", {
+  expect_setequal(tags_metadata()$tag, tags_list(FALSE))
+})

---FILE: vignettes/index-crossref.Rmd---
@@ -0,0 +1,87 @@
+---
+title: ""Indexing and cross-refernces""
+output: rmarkdown::html_vignette
+description: >
+  Make it easier for users to find your functions
+  by cross-referencing them and control their
+  indexing.
+vignette: >
+  %\VignetteIndexEntry{Indexing and cross-refernces}
+  %\VignetteEngine{knitr::rmarkdown}
+  %\VignetteEncoding{UTF-8}
+---
+
+```{r, include = FALSE}
+knitr::opts_chunk$set(
+  collapse = TRUE,
+  comment = ""#>""
+)
+```
+
+This vignette discusses tags that help users finding documentation through cross-references and indexes.
+
+## See also
+
+`@seealso` allows you to point to other useful resources, either on the web (using a url) or to related functions (with a function link like `[function_name()])`.
+For `sum()`, this might look like:
+
+```{r}
+#' @seealso [prod()] for products, [cumsum()] for cumulative sums, and
+#'   [colSums()]/[rowSums()] marginal sums over high-dimensional arrays.
+```
+
+## Family
+
+If you have a family of related functions, you can use `@family {family}` to cross-reference each function to every member of the family.
+A function can be a member of multiple families.
+
+By default `@family {family}`, will generate the see also text ""Other {family}:"", so the `@family` name should be plural (i.e., ""model building helpers"" not ""model building helper"").
+
+If you want to override default title, you can provide an `rd_family_title` element in a list stored in `man/roxygen/meta.R`:
+
+```{r, eval = FALSE}
+list(
+  rd_family_title = list(aggregations = ""Aggregation functions"")
+)
+```
+
+## References
+
+If the object you're documenting has connections to the scientific literature, use `@reference` to provide a citation.
+
+## Aliases
+
+`?` and `help()` look for topic aliases; `?foo` will find any topic that contains the `foo` alias.
+
+roxygen2 generates a default alias for you based on the object you're documenting.
+You can add additional aliases with `@aliases alias1 alias2 alias3` or remove default alias with `@aliases NULL`.
+
+## Search
+
+As well as looking in the aliases, `help.search()` and `???` also look in the `@title`, `@keywords`, and `@concept`s tags.
+
+-   `@keywords` adds standard keywords, which must be present in `file.path(R.home(""doc""), ""KEYWORDS"")`.
+
+-   `@concept` adds arbitrary key words or phrases.
+    Each `@concept` should contain a single word or phrase.
+
+Generally speaking, `@keywords` and `@concepts` are not terribly useful because most people find documentation using Google, not R's built-in search.
+
+There's one exception: `@keywords internal`.
+It's useful because it removes the function from the documentation index; it's useful for functions aimed primarily at other developers, not typical users of the package.
+
+## Back references
+
+The original source location is added as a comment to the second line of each generated `.Rd` file in the following form:
+
+    % Please edit documentation in ...
+
+`roxygen2` tries to capture all locations from which the documentation is assembled.
+For code that *generates* R code with Roxygen comments (e.g., the Rcpp package), the `@backref` tag is provided.
+This allows specifying the ""true"" source of the documentation, and will substitute the default list of source files.
+Use one tag per source file:
+
+```{r}
+#' @backref src/file.cpp
+#' @backref src/file.h
+```

---FILE: vignettes/rd-formatting.Rmd---
@@ -55,6 +55,8 @@ The most important details are described below.
 
 The usual Markdown heading markup creates sections and subsections.
 Top level headings (e.g. `# title`) create sections with the `\section{}` Rd tag.
+This largely supersedes use of the older `@section` tag.
+
 Top-level headings can only appear after the `@description` and `@details` tags.
 Since `@details` can appear multiple times in a block, you can always precede a '`#`' section with `@details`, if you want put it near the end of the block, after `@return` for example:
 
@@ -360,3 +362,4 @@ The commonmark parser does not require an empty line before lists, and this migh
 #' You can see more about this topic in the book cited below, on page
 #' 42. Clearly, the numbered list that starts here is not intentional.
 ```
+

---FILE: vignettes/rd-other.Rmd---
@@ -79,17 +79,17 @@ Some notes:
 ## S3
 
 -   S3 **generics** are regular functions, so document them as such.
-    If necessary, include a `@section` that provides additional details for developers implementing methods.
+    If necessary, include a section that provides additional details for developers implementing methods.
 
 -   S3 **classes** have no formal definition, so document the [constructor](https://adv-r.hadley.nz/s3.html#s3-constructor).
 
 -   It is your choice whether or not to document S3 **methods**.
     Generally, it's not necessary to document straightforward methods for common generics like `print()`.
     (You should, however, always `@export` S3 methods).
 
-    If your method is more complicated, you should document it by setting `@rdname`.
-    Typically you will document methods with their generic, so you'd document `foofy.data.frame` by setting `@rdname`.
-    In base R, you can find documentation for more complex methods like `?predict.lm`, `?predict.glm`, and `?anova.glm`.
+    If your method is more complicated, you should document it by setting `@rdname` or `@describeIn`.
+    For complicated methods, you might document in their own file (i.e. `@rdname generic.class`; for simpler methods you might document with the generic (i.e. `@describeIn generic)`.
+    Learn more about these tags in `vignette(""reuse"")`.
 
 -   Generally, roxygen2 will automatically figure out the generic that the method belongs to, and you should only need to use `@method` if there is ambiguity.
     For example, is `all.equal.data.frame()` the `equal.data.frame` method for `all()`, or the `data.frame` method for `all.equal()`?.
@@ -205,5 +205,3 @@ public = list(
   )
 )
 ```
-
-## 

---FILE: vignettes/rd.Rmd---
@@ -32,6 +32,9 @@ A block ends when it hits R code, usually a function or object assignment.
 Blocks ignore empty lines, including lines made up of non-roxygen comments.
 If you need to separate two blocks, use `NULL`.
 
+If you want to use roxygen2 documentation tags without generating an `.Rd` file, you can use `@noRd` to suppress file generation for a given topic. This is useful if you want to use roxygen2 conventions for documenting an internal function; only people reading the source doc will be able to read the docs.
+
+
 ## The introduction
 
 Each documentation block starts with some text which defines the title, the description, and the details.
@@ -133,66 +136,3 @@ All functions must have a documented return value for initial CRAN submission.
 In most case, the function usage (which appears beneath the description in the generates docs) will be automatically derived from the function specification.
 For the cases where it is not, please [file an issue](https://github.com/r-lib/roxygen2/issues) and use `@usage` to override the default with you want.
 If you want to suppress the usage altogether (which is sometimes useful for internal or deprecated functions), you can use `@usage NULL`.
-
-## Other tags
-
-### Cross-references
-
-There are two tags that make it easier for people to navigate your documentation: `@seealso` and `@family`.
-`@seealso` allows you to point to other useful resources, either on the web `<http://www.r-project.org>` or to other documentation with `[function_name()]`.
-If you have a family of related functions, you can use `@family {family}` to cross-reference each function to every other function within the family.
-A function can be a member of multiple families.
-
-For `sum()`, this might look like:
-
-```{r}
-#' @family aggregations
-#' @seealso [prod()] for products, [cumsum()] for cumulative sums, and
-#'   [colSums()]/[rowSums()] marginal sums over high-dimensional arrays.
-```
-
-By default `@family {family}`, will generate the see also text ""Other {family}:"", so the `@family` name should be plural (i.e., ""model building helpers"" not ""model building helper"").
-You can override the default title by providing a `rd_family_title` list in `man/roxygen/meta.R`:
-
-```{r, eval = FALSE}
-list(
-  rd_family_title = list(aggregations = ""Aggregation functions"")
-)
-```
-
-### Suppress documentation
-
-It's sometimes useful to include roxygen2 documentation tags without generating an `.Rd` file.
-You can use `@noRd` to suppress file generation for a given topic.
-
-### Indexing
-
-Three other tags make it easier for the user to find documentation within R's help system:
-
--   Aliases form the index that `?` searches.
-    Use `@aliases space separated aliases` to add additional aliases.
-
--   `@concept` add extra keywords that will be found with `help.search()`
-
--   Use `@keywords keyword1 keyword2 ...` to add standardised keywords.
-    Keywords are optional, but if present, must be taken from the predefined list found `file.path(R.home(""doc""), ""KEYWORDS"")`.
-
-Apart from `@keywords internal`, these tags are not very useful because most people find documentation using Google.
-`@keywords internal` is useful because it removes the function from the documentation index; it's useful for functions aimed primarily at other developers, not typical users of the package.
-
-### Back references
-
-The original source location is added as a comment to the second line of each generated `.Rd` file in the following form:
-
-    % Please edit documentation in ...
-
-`roxygen2` tries to capture all locations from which the documentation is assembled.
-For code that *generates* R code with Roxygen comments (e.g., the Rcpp package), the `@backref` tag is provided.
-This allows specifying the ""true"" source of the documentation, and will substitute the default list of source files.
-Use one tag per source file:
-
-```{r}
-#' @backref src/file.cpp
-#' @backref src/file.h
-```
-

---FILE: vignettes/reuse.Rmd---
@@ -117,12 +117,20 @@ You can inherit documentation from other topics in a few ways:
 
 -   `@inheritParams source_function` inherits just the parameter documentation from `source_function()`.
 
--   `@inherit source_function` will inherit parameters, return, references, description, details, sections, and see also from `source_function`.
+-   `@inherit source_function` will inherit all supported components from `source_function`.
 
--   `@inherit source_function return details` (e.g.) will inherit just return value and details from `source_function()`.
+    Alternatively, you can use (e.g.) `@inherit source_function return details` to just inherit the return value and details from `source_function()`.
+    Supported components are `r paste0(""\x60"", roxygen2:::inherit_components, ""\x60"", collapse = "", "")`.
 
 -   `@inheritSection source_function Section title` will inherit the single `@section` called ""Section title"" from `source_function()`.
 
+-   `@inheritDotParams` automatically generates parameter documentation for `...` for the common case where you pass `...` on to another function.
+    Because you often override some arguments, it comes with a flexible specification for argument selection:
+
+    -   `@inheritDotParams foo` takes all parameters from `foo()`
+    -   `@inheritDotParams foo a b e:h` takes parameters `a`, `b`, and all parameters between `e` and `h`
+    -   `@inheritDotParams foo -x -y` takes all parameters except for `x` and `y`.
+
 All of these tags also work to inherit documentation from functions in another package by using `pkg::source_function`.
 
 ## Inline code"
r-lib,roxygen2,3ddfd7f2e35c3a71d5705ab4f49e851cd8da306d,Hadley Wickham,h.wickham@gmail.com,2022-07-11T20:47:24Z,GitHub,noreply@github.com,2022-07-11T20:47:24Z,"Improve cache key (#1401)

By using fixed function, rather than one that's created each time the package is built.",R/markdown.R;vignettes/rd-formatting.Rmd,True,True,True,False,11,9,20,"---FILE: R/markdown.R---
@@ -156,20 +156,22 @@ eval_code_node <- function(node, env) {
   }
 
   chunk_opts <- utils::modifyList(
-    knitr_chunk_defaults,
+    knitr_chunk_defaults(),
     as.list(roxy_meta_get(""knitr_chunk_options"", NULL))
   )
 
   roxy_knit(text, env, chunk_opts)
 }
 
-knitr_chunk_defaults <- list(
-  error = FALSE,
-  fig.path = ""man/figures/"",
-  fig.process = function(path) basename(path),
-  comment = ""#>"",
-  collapse = TRUE
-)
+knitr_chunk_defaults <- function() {
+  list(
+    error = FALSE,
+    fig.path = ""man/figures/"",
+    fig.process = basename,
+    comment = ""#>"",
+    collapse = TRUE
+  )
+}
 
 str_set_all_pos <- function(text, pos, value, nodes) {
   # Cmark has a bug when reporting source positions for multi-line

---FILE: vignettes/rd-formatting.Rmd---
@@ -315,7 +315,7 @@ Code blocks support some knitr chunk options, e.g. to keep the output of several
 ```
 
 Some knitr chunk options are reset at the start of every code block, so if you want to change these, you'll have to specify them for every chunk.
-These are currently `r paste0(""\x60"", names(roxygen2:::knitr_chunk_defaults), ""\x60"")`.
+These are currently `r paste0(""\x60"", names(roxygen2:::knitr_chunk_defaults()), ""\x60"")`.
 
 Alternatively, you can set the `knitr_chunk_options` option to override these defaults, or add new chunk options that are used for the whole package.
 See `?load_options` for specifying roxygen2 options."
r-lib,roxygen2,43ca566293653f2cd3e71e05bb90f1e546b9811c,Hadley Wickham,h.wickham@gmail.com,2022-07-11T20:06:15Z,GitHub,noreply@github.com,2022-07-11T20:06:15Z,"Stricter check for namespaced references (#1400)

Fixes #1384",R/rd-find-link-files.R;R/rd-inherit.R;R/utils.R;tests/testthat/_snaps/rd-inherit.md;tests/testthat/test-rd-inherit.R;tests/testthat/test-utils.R,False,True,True,False,22,4,26,"---FILE: R/rd-find-link-files.R---
@@ -69,7 +69,7 @@ try_find_topic_in_package <- function(pkg, topic, tag) {
 }
 
 resolve_qualified_link <- function(topic) {
-  if (has_colons(topic)) {
+  if (is_namespaced(topic)) {
     target <- str_split_fixed(topic, ""::"", n = 2)
     file <- find_topic_in_package(target[1], target[2])
     paste0(target[1], "":"", file)

---FILE: R/rd-inherit.R---
@@ -420,7 +420,7 @@ tweak_links <- function(x, package) {
 # Find info in Rd or topic ------------------------------------------------
 
 get_rd <- function(name, topics, source) {
-  if (has_colons(name)) {
+  if (is_namespaced(name)) {
     # External package
     parsed <- parse_expr(name)
     pkg <- as.character(parsed[[2]])

---FILE: R/utils.R---
@@ -121,8 +121,11 @@ invert <- function(x) {
   tapply(as.character(stacked$ind), stacked$values, list)
 }
 
-has_colons <- function(x) {
-   grepl(""::"", x, fixed = TRUE)
+is_namespaced <- function(x) {
+  tryCatch({
+    expr <- parse_expr(x)
+    is_call(expr, ""::"", n = 2)
+  }, error = function(err) FALSE)
 }
 
 # Collapse the values associated with duplicated keys

---FILE: tests/testthat/_snaps/rd-inherit.md---
@@ -65,4 +65,12 @@
       x Can't find topic ""function"".
     Output
       NULL
+    Code
+      get_rd(""foo::bar()"", RoxyTopics$new(), source = ""source"")
+    Condition
+      Warning:
+      @inherits failed in topic ""source"".
+      x Can't find topic ""foo::bar()"".
+    Output
+      NULL
 

---FILE: tests/testthat/test-rd-inherit.R---
@@ -716,6 +716,7 @@ test_that(""useful warnings if can't find topics"", {
     get_rd(""base2::attach"", source = ""source"")
     get_rd(""base::function_not_found"", source = ""source"")
     get_rd(""function"", RoxyTopics$new(), source = ""source"")
+    get_rd(""foo::bar()"", RoxyTopics$new(), source = ""source"")
   })
 })
 

---FILE: tests/testthat/test-utils.R---
@@ -8,6 +8,12 @@ test_that(""nice_name protects against invalid characters"", {
   expect_equal(nice_name(""[.a""), ""sub-.a"")
 })
 
+test_that(""is_namespaced works as expected"", {
+  expect_true(is_namespaced(""a::b""))
+  expect_false(is_namespaced(""b::""))
+  expect_false(is_namespaced(""'::'""))
+})
+
 test_that(""write_if_different produces informative messages"", {
   dir <- withr::local_tempdir()
   path <- file.path(dir, ""test.R"")"
r-lib,roxygen2,79372caa959d5af0ae9685df1acc8a18f47ca899,Hadley Wickham,h.wickham@gmail.com,2022-07-11T02:03:13Z,Hadley Wickham,h.wickham@gmail.com,2022-07-11T02:03:20Z,"Update namespace vignette

Fixes #1373",vignettes/namespace.Rmd,True,False,True,False,35,76,111,"---FILE: vignettes/namespace.Rmd---
@@ -25,73 +25,65 @@ If you want an object to be publicly available, you must explicitly tag it with
 
 Use the following guidelines to decide what to export:
 
--   Functions: export functions that you want to make available.
+-   **Functions**: export functions that you want to make available.
     Exported functions must be documented, and you must be cautious when changing their interface.
 
--   Datasets: all datasets are publicly available.
-    They exist outside of the package namespace and should not be exported.
+-   **Datasets**: all datasets are publicly available.
+    They exist outside of the package namespace and must not be exported.
 
--   S3 classes: if you want others to be able to create instances of the class `@export` the constructor function.
+-   **S3 classes**: if you want others to be able to create instances of the class `@export` the constructor function.
 
--   S3 generics: the generic is a function, so `@export` if you want it to be usable outside the package.
+-   **S3 generics**: the generic is a function, so `@export` if you want it to be usable outside the package.
 
--   S3 methods: every S3 method *must* be exported, even if the generic is not.
+-   **S3 methods**: every S3 method *must* be exported, even if the generic is not.
     Otherwise, the S3 method table will not be generated correctly and internal generics will not find the correct method.
+    See below for instructions on how to export a method for a generic in a suggested package.
 
-    If you are providing a method for a generic defined in another package, you must also import that generic.
+-   **S4 classes**: export S4 classes if you want others to be able to extend them.
 
--   S4 classes: if you want others to be able to extend your class, `@export` it.
-    If you want others to create instances of your class, but not extend it, `@export` the constructor function, but not the class.
+-   **S4 generics:** `@export` if you want the generic to be publicly usable.
 
-    ``` r
-    # Can extend and create
-    #' @export
-    setClass(""A"")
+-   **S4 methods**: you only need to `@export` methods for generics in other packages.
 
-    # Can extend, but constructor not exported
-    #' @export
-    B <- setClass(""B"")
+### S3 methods for generics in suggested packages
 
-    # Can create, but not extend
-    #' @export C
-    C <- setClass(""C"")
+`@exportS3Method` tag allows you to generate `S3method()` namespace directives.
+Its primary use is for ""delayed"" method registration, which allows you to define methods for generics found in suggested packages (R \>= 3.6).
+For example,
 
-    # Can create and extend
-    #' @export D
-    #' @exportClass D
-    D <- setClass(""D"")
-    ```
+```{r}
+#' @exportS3Method pkg::generic
+generic.foo <- function(x, ...) {
+}
+```
 
--   S4 generics: `@export` if you want the generic to be publicly usable.
+will generate
 
--   S4 methods: you only need to `@export` methods for generics that you did not define.
+    S3method(pkg::generic, foo)
 
--   RC classes: the same principles apply as for S4 classes.
-    `@export` will only export the class.
+Which will cause the method to be registered only when pkg is loaded.
 
-### Specialised exports
+### Manual exports
 
-Generally, roxygen2 can generate the correct namespace directive when `@export`ing a specific object.
-However, you may want to override the defaults and exercise greater control.
-In this case, you can use the more specialised tags described below:
+If `@export` does not automatically generate the correct directive when, you can use one of the tags below to exercise greater control:
 
 -   `@export foo` generates `export(foo)`
+-   `@exportS3Method generic method` generates `S3method(generic, method)`
 -   `@exportClass foo` generates `exportClasses(foo)`
 -   `@exportMethod foo` generates `exportMethods(foo)`
 -   `@exportPattern foo` generates `exportPattern(foo)`
 
 For even more specialised cases you can use `@rawNamespace code` which inserts `code` literally into the `NAMESPACE`.
-If you need to automate this, `@evalNamespace foo()` will evaluate the `foo()` in the package environment and insert the results into `NAMESPACE`.
+If you need to automate this, `@evalNamespace fun()` will evaluate `fun()` in the package environment and insert the results into `NAMESPACE`.
 Because `evalNamespace()` is run in the package environment, it can only generate exports, not imports.
 
 ## Imports
 
 The `NAMESPACE` also controls which functions from other packages are made available to your package.
-Only unique directives are saved to the `NAMESPACE` file, so you can repeat them as needed to maintain a close link between the functions where they are needed and the namespace file.
 
-### Importing functions
+### Functions
 
-If you are using just a few functions from another package, the recommended option is to add the package name to the `Imports:` field of the `DESCRIPTION` file and call the functions explicitly using `::`, e.g., `pkg::fun()`.
+If you are using just a few functions from another package, we recommending adding the package to the `Imports:` field of the `DESCRIPTION` file and calling the functions explicitly using `::`, e.g., `pkg::fun()`.
 
 ```{r, eval = FALSE}
 my_function <- function(x, y) {
@@ -109,6 +101,7 @@ my_function <- function(x, y) {
 ```
 
 Imports affect every function in a package, so it's common to collect them in a central place, like `{packagename}-package.R`.
+This is automated by `usethis::use_import_from()`.
 
 ```{r}
 #' @importFrom pkg fun1 fun2
@@ -122,51 +115,17 @@ Note the use of `NULL` here: you must provide something for roxygen2 to document
 It is possible, but not generally recommended to import all functions from a package with `@import package`.
 This is risky if you import functions from more than one package, because while it might be ok today, in the future the packages might end up with a function having the same name, and your users will get a warning every time your package is loaded.
 
-### Beware
-
-Be careful when mixing `NAMESPACE` directives with regular code.
-The following example won't work because roxygen ignores empty lines in blocks.
-It will generate a namespace directive `import(zoo, Different name for calling zoo.)`, which will error.
-
-```{r}
-#' @import zoo
-
-#' Different name for calling zoo.
-#'
-#' @params ... passed to zoo.
-#' @return zoo object.
-#'
-#' @export 
-zoo2 <- function(...) zoo(...)
-```
-
-Instead you need to add an explicit `NULL`:
-
-```{r}
-#' @import zoo
-NULL
-
-#' Different name for calling zoo.
-#'
-#' @params ... passed to zoo.
-#' @return zoo object.
-#'
-#' @export 
-zoo2 <- function(...) zoo(...)
-```
-
 ### S3
 
-If you're adding a method to an S3 generic defined in another package, you must import it with `@importFrom pkg generic`.
-Otherwise roxygen2 can't tell that your function is a method, and will not document it correctly.
+S3 generics are just functions, so the same rules for functions apply.
+S3 methods always accompany the generic, so as long as you can access the generic (either implicitly or explicitly), the methods will also be available.
+In other words, you don't need to do anything special for S3 methods.
+As long as you've imported the generic, all the methods will also be available.
 
 ### S4
 
-If you are using S4 you may also need:
-
--   `@importClassesFrom package classa classb ...` to import selected S4 classes.
-
--   `@importMethodsFrom package methoda methodb ...` to import selected S4 methods.
+-   To use classes defined in another package, place`@importClassesFrom package ClassA ClassB ...`맕ext to the classes that inherit from the imported classes, or next to the methods that implement a generic for the imported classes.
+-   To use generics defined in another package, place`@importMethodsFrom package GenericA GenericB ...`맕ext to the methods that use the imported generics.
 
 ### Compiled code
 "
r-lib,roxygen2,5aa318a25ce87807693b13a912e825c78031942f,G치bor Cs치rdi,csardi.gabor@gmail.com,2022-07-11T02:03:06Z,GitHub,noreply@github.com,2022-07-11T02:03:06Z,"Override default knitr chunk options with roxy_meta (#1390)

Fixes #1240",NEWS.md;R/markdown.R;R/options.R;man/load_options.Rd;tests/testthat/test-markdown.R;vignettes/rd-formatting.Rmd,True,True,True,False,42,2,44,"---FILE: NEWS.md---
@@ -1,5 +1,10 @@
 # roxygen2 (development version)
 
+* The new `knitr_chunk_options` option (in the `Roxygen` entry of
+  `DESCRIPTION` or in `man/roxygen/meta.R`) is added to the knitr chunk
+  options that roxygen2 uses for markdown code blocks and inline
+  code (#1390).
+  
 * `@includeRmd` now gives better feedback when it fails (#1089).
 
 * `@export` will now export both the class and constructor function when

---FILE: R/markdown.R---
@@ -154,7 +154,13 @@ eval_code_node <- function(node, env) {
     # write knitr markup for fenced code
     text <- paste0(""```"", if (!is.na(lang)) lang, ""\n"", xml_text(node), ""```\n"")
   }
-  roxy_knit(text, env, knitr_chunk_defaults)
+
+  chunk_opts <- utils::modifyList(
+    knitr_chunk_defaults,
+    as.list(roxy_meta_get(""knitr_chunk_options"", NULL))
+  )
+
+  roxy_knit(text, env, chunk_opts)
 }
 
 knitr_chunk_defaults <- list(

---FILE: R/options.R---
@@ -28,6 +28,8 @@
 #' * `rd_family_title` `<list>`: overrides for `@family` titles. See the
 #'    _rd_ vignette for details: `vignette(""rd"", package = ""roxygen2"")`
 #'
+#' * `knitr_chunk_options`: default chunk options used for knitr.
+#'
 #' @section How to set:
 #' Either set in `DESCRIPTION`:
 #'
@@ -60,7 +62,8 @@ load_options <- function(base_path = ""."") {
     markdown = FALSE,
     r6 = TRUE,
     current_package = NA_character_,
-    rd_family_title = list()
+    rd_family_title = list(),
+    knitr_chunk_options = NULL
   )
 
   unknown_opts <- setdiff(names(opts), names(defaults))
@@ -136,3 +139,10 @@ roxy_meta_load <- function(base_path = getwd()) {
   env_bind(roxy_meta, !!!load_options(base_path))
 }
 
+local_roxy_meta_set <- function(key, value, envir = caller_env()) {
+  old_value <- roxy_meta_get(key)
+  withr::defer(roxy_meta_set(key, old_value), envir = envir)
+
+  roxy_meta_set(key, value)
+}
+

---FILE: man/load_options.Rd---
@@ -33,6 +33,7 @@ Options in \code{man/roxygen/meta.R} override those present in \code{DESCRIPTION
 \item \code{current_package} \verb{<string>} (read only): name of package being documented.
 \item \code{rd_family_title} \verb{<list>}: overrides for \verb{@family} titles. See the
 \emph{rd} vignette for details: \code{vignette(""rd"", package = ""roxygen2"")}
+\item \code{knitr_chunk_options}: default chunk options used for knitr.
 }
 }
 

---FILE: tests/testthat/test-markdown.R---
@@ -633,3 +633,18 @@ test_that(""alternative knitr engines"", {
     ""))
   )
 })
+
+test_that(""can override default options"", {
+  local_roxy_meta_set(""knitr_chunk_options"", list(comment = ""###""))
+
+  out <- roc_proc_text(rd_roclet(), ""
+    #' Title
+    #'
+    #' ```{r}
+    #' 1+1
+    #' ```
+    #' @md
+    foo <- function() { }
+  "")[[1]]
+  expect_match(out$get_section(""description"")$value, ""###"", fixed = TRUE)
+})

---FILE: vignettes/rd-formatting.Rmd---
@@ -317,6 +317,9 @@ Code blocks support some knitr chunk options, e.g. to keep the output of several
 Some knitr chunk options are reset at the start of every code block, so if you want to change these, you'll have to specify them for every chunk.
 These are currently `r paste0(""\x60"", names(roxygen2:::knitr_chunk_defaults), ""\x60"")`.
 
+Alternatively, you can set the `knitr_chunk_options` option to override these defaults, or add new chunk options that are used for the whole package.
+See `?load_options` for specifying roxygen2 options.
+
 ### Images
 
 Plots will create `.png` files in the `man/figures` directory with file names coming from the chunk name."
r-lib,roxygen2,b5bfe3167faf78e7c4262aaea8de25bc3be3ccf9,Hadley Wickham,h.wickham@gmail.com,2022-07-11T01:46:21Z,Hadley Wickham,h.wickham@gmail.com,2022-07-11T01:46:21Z,"Adjust advice on package doc alias

Fixes #1289",vignettes/rd-other.Rmd,True,False,True,False,1,1,2,"---FILE: vignettes/rd-other.Rmd---
@@ -72,7 +72,7 @@ Package documentation is a good place to put `# Package options` that documents
 Some notes:
 
 -   By default, aliases will be added so that both `?pkgname` and `package?pkgname` will find the package help.
-    If there's an existing function called `pkgname`, use `@aliases {pkgname}-package` to override the default.
+    If there's an existing function called `pkgname`, use `@aliases {pkgname}-package NULL` to override the default.
 
 -   Use `@references` to point to published material about the package that users might find helpful.
 "
r-lib,roxygen2,6a89d28a28a94e7e7786686e55d43ff05ceb3bca,Hadley Wickham,h.wickham@gmail.com,2022-07-11T01:45:09Z,GitHub,noreply@github.com,2022-07-11T01:45:09Z,"Better feedback for `@includeRmd` (#1397)

Fixes #1089",NEWS.md;R/rd-include-rmd.R;tests/testthat/_snaps/rd-include-rmd.md;tests/testthat/test-rd-include-rmd.R,False,True,True,False,60,9,69,"---FILE: NEWS.md---
@@ -1,5 +1,7 @@
 # roxygen2 (development version)
 
+* `@includeRmd` now gives better feedback when it fails (#1089).
+
 * `@export` will now export both the class and constructor function when
   applied to expressions like `foo <- setClass(""foo"")` (#1216).
 

---FILE: R/rd-include-rmd.R---
@@ -12,6 +12,12 @@ roxy_tag_parse.roxy_tag_includeRmd <- function(x) {
 roxy_tag_rd.roxy_tag_includeRmd <- function(x, base_path, env) {
   rmd <- x$val$path
   section <- x$val$section
+
+  if (!file.exists(rmd)) {
+    warn_roxy_tag(x, ""Can't find Rmd {.path {rmd}}"")
+    return(NULL)
+  }
+
   if (section == """") section <- ""details""
   stopifnot(is.character(rmd), length(rmd) == 1, !is.na(rmd))
 
@@ -43,18 +49,27 @@ roxy_tag_rd.roxy_tag_includeRmd <- function(x, base_path, env) {
   )
   cat(txt, file = rmd_path)
 
-  rmarkdown::render(
-    rmd_path,
-    output_format = ""github_document"",
-    output_options = c(
-      list(html_preview = FALSE),
-      if (utils::packageVersion(""rmarkdown"") >= ""2.12"") list(math_method = NULL)
+  tryCatch(
+    rmarkdown::render(
+      rmd_path,
+      output_format = ""github_document"",
+      output_options = c(
+        list(html_preview = FALSE),
+        if (utils::packageVersion(""rmarkdown"") >= ""2.12"") list(math_method = NULL)
+      ),
+      output_file = md_path,
+      quiet = TRUE,
+      envir = new_environment(parent = global_env())
     ),
-    output_file = md_path,
-    quiet = TRUE,
-    envir = new_environment(parent = global_env())
+    error = function(e) {
+      warn_roxy_tag(x, ""failed to evaluate Rmd"", parent = e)
+    }
   )
 
+  if (!file.exists(md_path)) {
+    return(NULL)
+  }
+
   value <- rmd_eval_rd(md_path, x)
   rd_section_markdown(section, value)
 }

---FILE: tests/testthat/_snaps/rd-include-rmd.md---
@@ -0,0 +1,10 @@
+# useful warnings
+
+    [<text>:3] @includeRmd Can't find Rmd 'path'
+
+---
+
+    [<text>:3] @includeRmd failed to evaluate Rmd
+    Caused by error:
+    ! Error
+

---FILE: tests/testthat/test-rd-include-rmd.R---
@@ -255,3 +255,27 @@ test_that(""order of sections is correct"", {
   out1 <- roc_proc_text(rd_roclet(), rox)[[1]]
   expect_match(format(out1), ""Rmd.*After.*After2"")
 })
+
+test_that(""useful warnings"", {
+  skip_if_not(rmarkdown::pandoc_available(""2.17""))
+
+  text <- ""
+    #' Title
+    #' @includeRmd path
+    #' @name foobar
+    NULL""
+  expect_snapshot_warning(roc_proc_text(rd_roclet(), text))
+
+  path <- withr::local_tempfile(fileext = "".Rmd"", lines = c(
+    ""```{r}"",
+    ""stop('Error')"",
+    ""```""
+  ))
+  text <- sprintf(""
+    #' Title
+    #' @includeRmd %s
+    #' @name foobar
+    NULL"", path
+  )
+  expect_snapshot_warning(roc_proc_text(rd_roclet(), text))
+})"
r-lib,roxygen2,0c3f4205c88cc897c5f05008b4564b4fefa78d9f,Hadley Wickham,h.wickham@gmail.com,2022-07-11T01:35:36Z,Hadley Wickham,h.wickham@gmail.com,2022-07-11T01:35:36Z,Fix R CMD check note,R/utils-rd.R,False,True,True,False,1,1,2,"---FILE: R/utils-rd.R---
@@ -104,7 +104,7 @@ make_as_character_rd <- function() {
 has_topic <- function(topic, package) {
   tryCatch(
     {
-      out <- inject(help(!!topic, !!package), global_env())
+      out <- exec(""help"", topic, package, .env = global_env())
       inherits(out, ""dev_topic"") ||
         (inherits(out, ""help_files_with_topic"") && length(out) == 1)
     },"
r-lib,roxygen2,309ce6520ab0f472fb2b2307c968977a30afa001,Hadley Wickham,h.wickham@gmail.com,2022-07-10T23:12:04Z,GitHub,noreply@github.com,2022-07-10T23:12:04Z,"Automatically export S4 constructor when appropriate (#1396)

Fixes #1216",NEWS.md;R/namespace.R;tests/testthat/test-namespace.R,False,True,True,False,17,2,19,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* `@export` will now export both the class and constructor function when
+  applied to expressions like `foo <- setClass(""foo"")` (#1216).
+
 * Generated HTML for code blocks never includes ""NA"" for language (#1251). 
 
 * Using a level 1 heading in the wrong tag now gives a more useful warning 

---FILE: R/namespace.R---
@@ -281,9 +281,16 @@ roxy_tag_ns.roxy_tag_useDynLib <- function(x, block, env, import_only = FALSE) {
 
 # Default export methods --------------------------------------------------
 
-default_export <- function(x, block) UseMethod(""default_export"")
+default_export <- function(x, block) {
+  UseMethod(""default_export"")
+}
 #' @export
-default_export.s4class   <- function(x, block) export_class(x$value@className)
+default_export.s4class   <- function(x, block) {
+  c(
+    if (!is.null(block$object$alias)) export(block$object$alias),
+    export_class(x$value@className)
+  )
+}
 #' @export
 default_export.s4generic <- function(x, block) export(x$value@generic)
 #' @export

---FILE: tests/testthat/test-namespace.R---
@@ -51,6 +51,11 @@ test_that(""export detects S4 class"", {
   expect_equal(out, 'exportClasses(a)')
 })
 
+test_that(""exports constructor function if created"", {
+  out <- roc_proc_text(namespace_roclet(), ""#' @export\na <- setClass('a')"")
+  expect_equal(out, c('export(a)', 'exportClasses(a)'))
+})
+
 test_that(""export detects S4 generic"", {
   out <- roc_proc_text(namespace_roclet(), ""
     #' @export"
r-lib,roxygen2,debc084926ee81ab2bf67783f62f58739acd66a3,Hadley Wickham,h.wickham@gmail.com,2022-07-10T22:49:36Z,GitHub,noreply@github.com,2022-07-10T22:49:36Z,"Don't propagate NA language (#1395)

Fixes #1251",NEWS.md;R/markdown.R;tests/testthat/test-markdown-code.R,False,True,True,False,19,3,22,"---FILE: NEWS.md---
@@ -1,5 +1,7 @@
 # roxygen2 (development version)
 
+* Generated HTML for code blocks never includes ""NA"" for language (#1251). 
+
 * Using a level 1 heading in the wrong tag now gives a more useful warning 
   (#1374).
 

---FILE: R/markdown.R---
@@ -150,8 +150,9 @@ eval_code_node <- function(node, env) {
     # write knitr markup for inline code
     text <- paste0(""`"", xml_text(node), ""`"")
   } else {
+    lang <- xml_attr(node, ""info"")
     # write knitr markup for fenced code
-    text <- paste0(""```"", xml_attr(node, ""info""), ""\n"", xml_text(node), ""```\n"")
+    text <- paste0(""```"", if (!is.na(lang)) lang, ""\n"", xml_text(node), ""```\n"")
   }
   roxy_knit(text, env, knitr_chunk_defaults)
 }
@@ -315,8 +316,8 @@ special <- c(
 )
 
 mdxml_code_block <- function(xml, state) {
-  info <- xml_attr(xml, ""info"")[1]
-  if (is.na(info) || nchar(info[1]) == 0) info <- NA_character_
+  info <- xml_attr(xml, ""info"", default = """")[1]
+  if (nchar(info[1]) == 0) info <- NA_character_
   paste0(
     ""\n\n"",
     ""\\if{html}{\\out{<div class=\""sourceCode"",

---FILE: tests/testthat/test-markdown-code.R---
@@ -230,3 +230,16 @@ test_that(""workaround for cmark sourcepos bug (#1353) works"", {
   expect_equal(out$get_section(""description"")$value, ""line1\npre 1 2 3 post"")
   expect_equal(out$get_section(""details"")$value, ""no workaround needed here"")
 })
+
+
+test_that(""doesn't generate NA language"", {
+  out <- roc_proc_text(rd_roclet(), ""
+  #' Title
+  #'
+  #' ```
+  #' r <- 1:10
+  #' ```
+  #' @md
+  foo <- function() {}"")[[1]]
+  expect_false(grepl(""NA"", out$get_section(""description"")$value))
+})"
r-lib,roxygen2,115714288c0287082a91511d993f051395d2d5b6,Hadley Wickham,h.wickham@gmail.com,2022-07-10T22:42:18Z,GitHub,noreply@github.com,2022-07-10T22:42:18Z,"Improve warning for level 1 headings in wrong tag (#1394)

Fixes #1374",NEWS.md;R/markdown.R;tests/testthat/_snaps/markdown.md;tests/testthat/test-markdown.R,False,True,True,False,17,5,22,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* Using a level 1 heading in the wrong tag now gives a more useful warning 
+  (#1374).
+
 * R6 only links to superclass docs if they're actually available (#1236).
 
 * You can now use alternative knitr engines in markdown code blocks (#1149).

---FILE: R/markdown.R---
@@ -433,8 +433,14 @@ escape_comment <- function(x) {
 mdxml_heading <- function(xml, state) {
   level <- xml_attr(xml, ""level"")
   if (! state$has_sections && level == 1) {
-    return(mdxml_unsupported(xml, state$tag, ""level 1 markdown headings""))
+    warn_roxy_tag(state$tag, c(
+      ""markdown translation failed"",
+      x = ""Level 1 headings are not supported in @{state$tag$tag}"",
+      i = ""Do you want to put the heading in @description or @details?""
+    ))
+    return(escape_comment(xml_text(xml)))
   }
+
   txt <- map_chr(xml_contents(xml), mdxml_node_to_rd, state)
   if (level == 1) {
     state$titles <- c(state$titles, paste(txt, collapse = """"))

---FILE: tests/testthat/_snaps/markdown.md---
@@ -57,6 +57,12 @@
     [<text>:4] @description markdown translation failed
     x block quotes are not currently supported
 
+# level 1 heading in markdown generates warning in some tags
+
+    [<text>:4] @seealso markdown translation failed
+    x Level 1 headings are not supported in @seealso
+    i Do you want to put the heading in @description or @details?
+
 # alternative knitr engines
 
     Code

---FILE: tests/testthat/test-markdown.R---
@@ -456,10 +456,7 @@ test_that(""level 1 heading in markdown generates warning in some tags"", {
     #' @name x
     NULL
   ""
-  expect_warning(
-    roc_proc_text(rd_roclet(), text),
-    ""level 1 markdown headings""
-  )
+  expect_snapshot_warning(roc_proc_text(rd_roclet(), text))
 })
 
 test_that(""level >2 markdown headings work in @description"", {"
r-lib,roxygen2,8860c3ca18e589f1daf05ad82bb5ff800ae673ef,Hadley Wickham,h.wickham@gmail.com,2022-07-10T21:19:48Z,GitHub,noreply@github.com,2022-07-10T21:19:48Z,"Only link to R6 superclass if available (#1393)

Fixes #1236. Closes #1274.",NEWS.md;R/rd-r6.R;R/utils-rd.R;tests/testthat/_snaps/rd-r6.md;tests/testthat/roxygen-block-3-B.Rd;tests/testthat/roxygen-block-3-C.Rd,False,True,True,False,15,6,21,"---FILE: NEWS.md---
@@ -1,5 +1,7 @@
 # roxygen2 (development version)
 
+* R6 only links to superclass docs if they're actually available (#1236).
+
 * You can now use alternative knitr engines in markdown code blocks (#1149).
 
 * Fix bug interpolating the results of indented inline RMarkdown (#1353).

---FILE: R/rd-r6.R---
@@ -99,7 +99,13 @@ r6_superclass <- function(block, r6data, env) {
   push(paste0(""\\section{"", title, ""}{""))
 
   pkgs <- super$classes$package[match(cls, super$classes$classname)]
-  path <- sprintf(""\\code{\\link[%s:%s]{%s::%s}}"", pkgs, cls, pkgs, cls)
+  has_topic <- purrr::map2_lgl(cls, pkgs, has_topic)
+
+  path <- ifelse(
+    has_topic,
+    sprintf(""\\code{\\link[%s:%s]{%s::%s}}"", pkgs, cls, pkgs, cls),
+    sprintf(""\\code{%s::%s}"", pkgs, cls)
+  )
   me <- sprintf(""\\code{%s}"", block$object$value$classname)
   push(paste(c(rev(path), me), collapse = "" -> ""))
 

---FILE: R/utils-rd.R---
@@ -104,8 +104,9 @@ make_as_character_rd <- function() {
 has_topic <- function(topic, package) {
   tryCatch(
     {
-      out <- utils::help((topic), package = (package))
-      length(out) == 1
+      out <- inject(help(!!topic, !!package), global_env())
+      inherits(out, ""dev_topic"") ||
+        (inherits(out, ""help_files_with_topic"") && length(out) == 1)
     },
     error = function(c) FALSE
   )

---FILE: tests/testthat/_snaps/rd-r6.md---
@@ -20,7 +20,7 @@
       cat(format(rd$get_section(""rawRd"")))
     Output
       \section{Super class}{
-      \code{\link[R_GlobalEnv:C1]{R_GlobalEnv::C1}} -> \code{C2}
+      \code{R_GlobalEnv::C1} -> \code{C2}
       }
       \section{Methods}{
       \subsection{Public methods}{

---FILE: tests/testthat/roxygen-block-3-B.Rd---
@@ -11,7 +11,7 @@ Class B Description.
 Class B details.
 }
 \section{Super class}{
-\code{\link[roxygen2:A]{roxygen2::A}} -> \code{B}
+\code{roxygen2::A} -> \code{B}
 }
 \section{Public fields}{
 \if{html}{\out{<div class=""r6-fields"">}}

---FILE: tests/testthat/roxygen-block-3-C.Rd---
@@ -11,7 +11,7 @@ Class C Description.
 Classs C details.
 }
 \section{Super classes}{
-\code{\link[roxygen2:A]{roxygen2::A}} -> \code{\link[roxygen2:B]{roxygen2::B}} -> \code{C}
+\code{roxygen2::A} -> \code{roxygen2::B} -> \code{C}
 }
 \section{Public fields}{
 \if{html}{\out{<div class=""r6-fields"">}}"
r-lib,roxygen2,c0b8e1fb848ea0eab13b09ecafaa43b9892487b6,Hadley Wickham,h.wickham@gmail.com,2022-07-10T20:50:00Z,Hadley Wickham,h.wickham@gmail.com,2022-07-10T20:52:55Z,"Improve `@param` style in vignettes

Fixes #1379",vignettes/rd-formatting.Rmd;vignettes/roxygen2.Rmd,True,False,True,False,23,34,57,"---FILE: vignettes/rd-formatting.Rmd---
@@ -38,7 +38,7 @@ Here is an example roxygen chunk that uses Markdown.
 #' that package to learn how to use roxygen.
 #'
 #' @param pkg package description, can be path or package name.  See
-#'   [as.package()] for more information
+#'   [as.package()] for more information.
 #' @param clean,reload Deprecated.
 #' @inheritParams roxygen2::roxygenise
 #' @seealso [roxygen2::roxygenize()], `browseVignettes(""roxygen2"")`
@@ -148,8 +148,8 @@ Regular Markdown lists are recognized and converted to `\enumerate{}` or `\itemi
 #' * An R color name, see `colors()`.
 #' * A 6- or 8-digit hexa color string, e.g. `#ff0000` means
 #'   red. Transparency (alpha channel) values are ignored.
-#' * A one-column matrix with three rows for the red, green
-#'   and blue channels, as returned by [grDevices::col2rgb()]
+#' * A one-column matrix with three rows for the red, green,
+#'   and blue channels, as returned by [grDevices::col2rgb()].
 ```
 
 Note that you do not have to leave an empty line before the list.

---FILE: vignettes/roxygen2.Rmd---
@@ -69,44 +69,33 @@ There are three steps in the transformation from roxygen comments in your source
 The process starts when you add specially formatted roxygen comments to your source file.
 Roxygen comments start with `#'` so you can continue to use regular comments for other purposes.
 
-```{r}
-#' Add together two numbers
+```{r, echo = FALSE}
+example <- ""#' Add together two numbers
 #'
-#' @param x A number
-#' @param y A number
-#' @return The sum of \code{x} and \code{y}
+#' @param x A number.
+#' @param y A number.
+#' @return A number.
 #' @examples
 #' add(1, 1)
 #' add(10, 1)
 add <- function(x, y) {
   x + y
 }
+""
+```
+
+```{r code=example}
 ```
 
 For the example above, this will generate `man/add.Rd` that looks like:
 
-    % Generated by roxygen2 (3.2.0): do not edit by hand
-    \name{add}
-    \alias{add}
-    \title{Add together two numbers}
-    \usage{
-    add(x, y)
-    }
-    \arguments{
-      \item{x}{A number}
-
-      \item{y}{A number}
-    }
-    \value{
-    The sum of \code{x} and \code{y}
-    }
-    \description{
-    Add together two numbers
-    }
-    \examples{
-    add(1, 1)
-    add(10, 1)
-    }
+```{r, echo=FALSE, results=""asis""}
+cat(
+  ""\x60\x60\x60rd\n"",
+  format(roxygen2::roc_proc_text(roxygen2::rd_roclet(), example)[[1]]),
+  ""\n\x60\x60\x60"", sep = """"
+)
+```
 
 Rd files are a special file format loosely based on LaTeX.
 You can read more about the Rd format in the [R extensions](https://cran.r-project.org/doc/manuals/R-exts.html#Rd-format) manual.
@@ -135,8 +124,8 @@ For example, dplyr has `between.cpp` which starts:
 //' efficiently in C++ for local values, and translated to the
 //' appropriate SQL for remote tables.
 //'
-//' @param x A numeric vector of values
-//' @param left,right Boundary values
+//' @param x A numeric vector of values.
+//' @param left,right Boundary values.
 //' @export
 //' @examples
 //' between(1:12, 7, 9)
@@ -157,8 +146,8 @@ This is automatically translated to the following R code in `RcppExports.R`:
 #' efficiently in C++ for local values, and translated to the
 #' appropriate SQL for remote tables.
 #'
-#' @param x A numeric vector of values
-#' @param left,right Boundary values
+#' @param x A numeric vector of values.
+#' @param left,right Boundary values.
 #' @export
 #' @examples
 #' between(1:12, 7, 9)"
r-lib,roxygen2,360143f1876e9a29b330793c1e2f23673c69dbfa,G치bor Cs치rdi,csardi.gabor@gmail.com,2022-07-10T20:43:26Z,GitHub,noreply@github.com,2022-07-10T20:43:26Z,"Allow alternative knitr engines (#1392)

Fixes #1149.",NEWS.md;R/markdown.R;man/markdown_pass1.Rd;tests/testthat/_snaps/markdown.md;tests/testthat/example.Rmd;tests/testthat/test-markdown.R,True,True,True,False,64,2,66,"---FILE: NEWS.md---
@@ -1,5 +1,7 @@
 # roxygen2 (development version)
 
+* You can now use alternative knitr engines in markdown code blocks (#1149).
+
 * Fix bug interpolating the results of indented inline RMarkdown (#1353).
 
 * R6 documentation no longer shows inherited methods if there aren't any 

---FILE: R/markdown.R---
@@ -52,6 +52,12 @@ markdown <- function(text, tag = NULL, sections = FALSE) {
 #' plot(1:10)
 #' ```
 #'
+#' Alternative knitr engines:
+#'
+#' ```{verbatim}
+#' #| file = ""tests/testthat/example.Rmd""
+#' ```
+#'
 #' Also see `vignette(""rd-formatting"")`.
 #'
 #' @param text Input text.
@@ -113,9 +119,9 @@ work_around_cmark_sourcepos_bug <- function(text, rcode_pos) {
 }
 
 is_markdown_code_node <- function(x) {
-  info <- str_sub(xml_attr(x, ""info""), 1, 3)
+  info <- xml_attr(x, ""info"")
   str_sub(xml_text(x), 1, 2) == ""r "" ||
-    (!is.na(info) && info %in% c(""{r "", ""{r}"", ""{r,""))
+    (!is.na(info) && grepl(""^[{][a-zA-z]+[}, ]"", info))
 }
 
 parse_md_pos <- function(text) {

---FILE: man/markdown_pass1.Rd---
@@ -53,5 +53,12 @@ Plots:
 \figure{test-figure-1.png}
 
 Also see \code{vignette(""rd-formatting"")}.
+
+\if{html}{\out{<div class=""sourceCode default"">}}\preformatted{```\{r\}
+# comment
+this <- 10
+is <- this + 10
+good <- this + is
+}\if{html}{\out{</div>}}
 }
 \keyword{internal}

---FILE: tests/testthat/_snaps/markdown.md---
@@ -57,3 +57,28 @@
     [<text>:4] @description markdown translation failed
     x block quotes are not currently supported
 
+# alternative knitr engines
+
+    Code
+      print(out1 <- roc_proc_text(rd_roclet(),
+      ""\n      #' Title\n      #'\n      #' Description.\n      #'\n      #' ```{verbatim}\n      #' #| file = testthat::test_path(\""example.Rmd\"")\n      #' ```\n      #' @md\n      #' @name x\n      NULL\n    ""))
+    Output
+      $x.Rd
+      % Generated by roxygen2: do not edit by hand
+      % Please edit documentation in ./<text>
+      \name{x}
+      \alias{x}
+      \title{Title}
+      \description{
+      Description.
+      }
+      \details{
+      \if{html}{\out{<div class=""sourceCode default"">}}\preformatted{```\{r\}
+      # comment
+      this <- 10
+      is <- this + 10
+      good <- this + is
+      }\if{html}{\out{</div>}}
+      }
+      
+

---FILE: tests/testthat/example.Rmd---
@@ -0,0 +1,5 @@
+```{r}
+# comment
+this <- 10
+is <- this + 10
+good <- this + is

---FILE: tests/testthat/test-markdown.R---
@@ -619,3 +619,20 @@ test_that(""markup in headings"", {
     )
   )
 })
+
+test_that(""alternative knitr engines"", {
+  expect_snapshot(
+    print(out1 <- roc_proc_text(rd_roclet(), ""
+      #' Title
+      #'
+      #' Description.
+      #'
+      #' ```{verbatim}
+      #' #| file = testthat::test_path(\""example.Rmd\"")
+      #' ```
+      #' @md
+      #' @name x
+      NULL
+    ""))
+  )
+})"
r-lib,roxygen2,5ead04a7c906163dbde37354124ced43174f9cb1,G치bor Cs치rdi,csardi.gabor@gmail.com,2022-07-10T20:42:50Z,GitHub,noreply@github.com,2022-07-10T20:42:50Z,"Work around cmark sourcepos indent bug (#1391)

Closes #1353.",NEWS.md;R/markdown.R;tests/testthat/test-markdown-code.R,False,True,True,False,56,2,58,"---FILE: NEWS.md---
@@ -1,5 +1,7 @@
 # roxygen2 (development version)
 
+* Fix bug interpolating the results of indented inline RMarkdown (#1353).
+
 * R6 documentation no longer shows inherited methods if there aren't any 
   (#1371).
 

---FILE: R/markdown.R---
@@ -71,10 +71,47 @@ markdown_pass1 <- function(text) {
   rcode_nodes <- keep(code_nodes, is_markdown_code_node)
   if (length(rcode_nodes) == 0) return(text)
   rcode_pos <- parse_md_pos(map_chr(rcode_nodes, xml_attr, ""sourcepos""))
+  rcode_pos <- work_around_cmark_sourcepos_bug(text, rcode_pos)
   out <- eval_code_nodes(rcode_nodes)
   str_set_all_pos(text, rcode_pos, out, rcode_nodes)
 }
 
+# Work around commonmark sourcepos bug for inline R code
+# https://github.com/r-lib/roxygen2/issues/1353
+work_around_cmark_sourcepos_bug <- function(text, rcode_pos) {
+  if (Sys.getenv(""ROXYGEN2_NO_SOURCEPOS_WORKAROUND"", """") != """") {
+    return(rcode_pos)
+  }
+
+  lines <- str_split(text, fixed(""\n""))[[1]]
+
+  for (l in seq_len(nrow(rcode_pos))) {
+    # Do not try to fix multi-line code, we error for that (below)
+    if (rcode_pos$start_line[l] != rcode_pos$end_line[l]) next
+    line <- lines[rcode_pos$start_line[l]]
+    start <- rcode_pos$start_column[l]
+
+    # Maybe correct? At some point this will be fixed upstream, hopefully.
+    if (str_sub(line, start - 1, start + 1) == ""`r "") next
+
+    # Maybe indented and we can shift it?
+    # It is possible that the shift that we try accidentally matches
+    # ""`r "", but it seems to be extremely unlikely. An example is this:
+    # #'       ``1`r `` `r 22*10`
+    # (seven spaces after the #', so an indent of six spaces. If we shift
+    # the real ""`r "" left by six characters, there happens to be another
+    # ""`r "" there.
+
+    indent <- nchar(str_extract(line, ""^[ ]+""))
+    if (str_sub(line, start - 1 + indent, start + 1 + indent) == ""`r "") {
+      rcode_pos$start_column[l] <- rcode_pos$start_column[l] + indent
+      rcode_pos$end_column[l] <- rcode_pos$end_column[l] + indent
+    }
+  }
+
+  rcode_pos
+}
+
 is_markdown_code_node <- function(x) {
   info <- str_sub(xml_attr(x, ""info""), 1, 3)
   str_sub(xml_text(x), 1, 2) == ""r "" ||
@@ -124,8 +161,7 @@ knitr_chunk_defaults <- list(
 str_set_all_pos <- function(text, pos, value, nodes) {
   # Cmark has a bug when reporting source positions for multi-line
   # code tags, and it does not count the indenting space in the
-  # continuation lines. However, the bug might get fixed later, so
-  # for now we just simply error for multi-line inline code.
+  # continuation lines: https://github.com/commonmark/cmark/issues/296
   types <- xml_name(nodes)
   if (any(types == ""code"" & pos$start_line != pos$end_line)) {
     cli::cli_abort(""multi-line `r ` markup is not supported"", call = NULL)

---FILE: tests/testthat/test-markdown-code.R---
@@ -214,3 +214,19 @@ test_that(""fragile tags in generated code"", {
   expect_silent(out2 <- markdown(""foo `r '\\\\out{<span></span>}'` bar""))
   expect_equal(out2, ""foo \\out{<span></span>} bar"")
 })
+
+test_that(""workaround for cmark sourcepos bug (#1353) works"", {
+  out <- roc_proc_text(rd_roclet(), ""
+    #' Title
+    #'
+    #' line1
+    #'    pre `r \""1\""` 2 `r 1+2` post
+    #'
+    #' no workaround needed `r 'here'`
+    #' @md
+    foo <- function() {}
+  "")[[1]]
+
+  expect_equal(out$get_section(""description"")$value, ""line1\npre 1 2 3 post"")
+  expect_equal(out$get_section(""details"")$value, ""no workaround needed here"")
+})"
r-lib,roxygen2,dd713e70676984843067e7917c7629576fa80f73,Hadley Wickham,h.wickham@gmail.com,2022-07-10T19:42:11Z,GitHub,noreply@github.com,2022-07-10T19:42:11Z,"Don't list inherited methods if there aren't any (#1387)

Fixes #1371",NEWS.md;R/rd-r6.R;tests/testthat/_snaps/rd-r6.md;tests/testthat/test-rd-r6.R,False,True,True,False,59,1,60,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* R6 documentation no longer shows inherited methods if there aren't any 
+  (#1371).
+
 * If you have a daily build of RStudio, the lists of changed Rd files are
   now clickable so you can immediately see the rendered development
   documentation (#1354).

---FILE: R/rd-r6.R---
@@ -258,9 +258,11 @@ r6_inherited_method_list <- function(block, r6data) {
   self <- r6data$self
   super_meth <- super_meth[! super_meth$name %in% self$name, ]
   super_meth <- super_meth[! duplicated(super_meth$name), ]
+  if (nrow(super_meth) == 0) {
+    return()
+  }
 
   super_meth <- super_meth[rev(seq_len(nrow(super_meth))), ]
-
   details <- paste0(
     ""<details"",
     if (nrow(super_meth) <= 5) "" open"",

---FILE: tests/testthat/_snaps/rd-r6.md---
@@ -14,6 +14,32 @@
       Warning:
       [<text>:10] @description Cannot find matching R6 method
 
+# class with no inherited methods
+
+    Code
+      cat(format(rd$get_section(""rawRd"")))
+    Output
+      \section{Super class}{
+      \code{\link[R_GlobalEnv:C1]{R_GlobalEnv::C1}} -> \code{C2}
+      }
+      \section{Methods}{
+      \subsection{Public methods}{
+      \itemize{
+      \item \href{#method-C2-meth1}{\code{C2$meth1()}}
+      }
+      }
+      \if{html}{\out{<hr>}}
+      \if{html}{\out{<a id=""method-C2-meth1""></a>}}
+      \if{latex}{\out{\hypertarget{method-C2-meth1}{}}}
+      \subsection{Method \code{meth1()}}{
+      method1
+      \subsection{Usage}{
+      \if{html}{\out{<div class=""r"">}}\preformatted{C2$meth1()}\if{html}{\out{</div>}}
+      }
+      
+      }
+      }
+
 # integration test
 
     Code

---FILE: tests/testthat/test-rd-r6.R---
@@ -296,6 +296,33 @@ test_that(""warning if no method comes after the docs"", {
   doc <- format(rd)
 })
 
+test_that(""class with no inherited methods"", {
+  text <- ""
+    C1 <- R6::R6Class('C1', cloneable = FALSE)
+
+    #' @title Title
+    #' @description Description.
+    #' @details Details.
+    C2 <- R6::R6Class('C2',
+      inherit = C1,
+      cloneable = FALSE,
+      public = list(
+        #' @description method1
+        meth1 = function() 1
+      )
+    )""
+
+  env <- new.env(parent = globalenv())
+
+  eval(parse(text = text, keep.source = TRUE), envir = env)
+  block <- parse_text(text, env = env)[[1]]
+  rd <- RoxyTopic$new()
+
+  topic_add_r6_methods(rd, block, env)
+  expect_snapshot(cat(format(rd$get_section(""rawRd""))))
+})
+
+
 test_that(""integration test"", {
 
   wd <- getwd()"
r-lib,roxygen2,8c1f460b0088e9e1c6af33280cd5ecf5197d42ef,Hadley Wickham,h.wickham@gmail.com,2022-07-10T02:43:09Z,GitHub,noreply@github.com,2022-07-10T02:43:09Z,"Hyperlink paths (#1388)

Fixes #1354",NEWS.md;R/rd.R;R/utils.R,False,True,True,False,17,2,19,"---FILE: NEWS.md---
@@ -1,5 +1,9 @@
 # roxygen2 (development version)
 
+* If you have a daily build of RStudio, the lists of changed Rd files are
+  now clickable so you can immediately see the rendered development
+  documentation (#1354).
+
 * Automated usage no longer mangles nbsp in default arguments (#1342).
 
 * Give useful error if `@describeIn` can't combine docs (#1366).

---FILE: R/rd.R---
@@ -58,9 +58,16 @@ roclet_output.roclet_rd <- function(x, results, base_path, ..., is_first = FALSE
   contents <- map_chr(results, format)
   paths <- file.path(man, names(results))
 
+  names <- unname(map_chr(results, ~ .$get_name()[[1]]))
+  if (length(names) > 0) {
+    hrefs <- paste0(""rstudio:run:help(`"", names, ""`)"")
+  } else {
+    hrefs <- character()
+  }
+
   # Always check for roxygen2 header before overwriting NAMESPACE (#436),
   # even when running for the first time
-  mapply(write_if_different, paths, contents, MoreArgs = list(check = TRUE))
+  mapply(write_if_different, paths, contents, href = hrefs)
 
   if (!is_first) {
     # Automatically delete any files in man directory that were generated

---FILE: R/utils.R---
@@ -61,7 +61,7 @@ nice_name <- function(x) {
   x
 }
 
-write_if_different <- function(path, contents, check = TRUE) {
+write_if_different <- function(path, contents, href = NULL, check = TRUE) {
   if (!file.exists(dirname(path))) {
     dir.create(dirname(path), showWarnings = FALSE)
   }
@@ -87,7 +87,11 @@ write_if_different <- function(path, contents, check = TRUE) {
     ))
     FALSE
   } else {
+    if (!is.null(href)) {
+      name <- cli::style_hyperlink(name, href)
+    }
     cli::cli_inform(""Writing {.path {name}}"")
+
     writeBin(charToRaw(contents), path)
     TRUE
   }"
r-lib,roxygen2,06d08884f81547207d7193b28ba603b66238390f,Hadley Wickham,h.wickham@gmail.com,2022-07-08T19:13:19Z,Hadley Wickham,h.wickham@gmail.com,2022-07-08T19:13:19Z,"Adjust news bullet

Fixes #1361",NEWS.md,False,False,False,False,2,1,3,"---FILE: NEWS.md---
@@ -73,7 +73,8 @@
       methods are applied (#1179). This change alters outputs and brings roxygen
       in line with console and R markdown behavior. `x <- ""foo""` no longer 
       inserts anything into the resulting documentation, but `x <- ""foo""; x` 
-      will.
+      will. This also means that returning a character vector will insert
+      commas between components, not newlines.
 
 * roxygen2 no longer generates invalid HTML (#1290).
 "
r-lib,roxygen2,420376407434755b8e23e6bff06a562a2376a7ea,Hadley Wickham,h.wickham@gmail.com,2022-07-07T17:59:48Z,GitHub,noreply@github.com,2022-07-07T17:59:48Z,"Only use nbsp for old style usage (#1383)

Fixes #1342. Closes #1343.",NEWS.md;R/rd-usage.R;tests/testthat/_snaps/rd-usage.md;tests/testthat/test-rd-usage.R,False,True,True,False,28,14,42,"---FILE: NEWS.md---
@@ -1,5 +1,7 @@
 # roxygen2 (development version)
 
+* Automated usage no longer mangles nbsp in default arguments (#1342).
+
 * Give useful error if `@describeIn` can't combine docs (#1366).
 
 * Code evaluated in inline markdown code chunks and `@eval`/`@evalRd`/

---FILE: R/rd-usage.R---
@@ -111,8 +111,8 @@ usage_args <- function(args) {
   map_chr(args, arg_to_text)
 }
 
-args_string <- function(x) {
-  sep <- ifelse(x != """", ""\u{A0}=\u{A0}"", """")
+args_string <- function(x, space = "" "") {
+  sep <- ifelse(x != """", paste0(space, ""="", space), """")
   arg_names <- escape(auto_backtick(names(x)))
   paste0(arg_names, sep, escape(x))
 }
@@ -127,24 +127,31 @@ args_call <- function(call, args) {
 #' @param suffix Optional suffix, used for replacement functions
 #' @noRd
 wrap_usage <- function(name, format_name, formals, suffix = NULL, width = 80L) {
-  args <- args_string(usage_args(formals))
+  if (roxy_meta_get(""old_usage"", FALSE)) {
+    # Use nbsp to keep argument name & default value on same line
+    args <- args_string(usage_args(formals), ""\u{A0}"")
+    x <- args_call(format_name(name), args)
+    out <- wrapUsage(x, width = as.integer(width), indent = 2)
+
+    out <- gsub(""\u{A0}"", "" "", out, useBytes = TRUE)
+    Encoding(out) <- ""UTF-8""
+
+    return(rd(paste0(out, suffix)))
+  }
 
-  # Do we need any wrapping?
+  args <- args_string(usage_args(formals))
   bare <- args_call(name, args)
+
   if (!str_detect(bare, ""\n"") && nchar(bare, type = ""width"") < width) {
+    # Don't need to wrap
     out <- args_call(format_name(name), args)
-  } else if (roxy_meta_get(""old_usage"", FALSE)) {
-    x <- args_call(format_name(name), args)
-    out <- wrapUsage(x, width = as.integer(width), indent = 2)
   } else {
+    # Wrap each argument and put on own line
     args <- paste0(""  "", args)
     args <- map_chr(args, wrapUsage, width = 90, indent = 4)
     out <- paste0(format_name(name), ""(\n"", paste0(args, collapse = "",\n""), ""\n)"")
   }
 
-  out <- gsub(""\u{A0}"", "" "", out, useBytes = TRUE)
-  Encoding(out) <- ""UTF-8""
-
   rd(paste0(out, suffix))
 }
 
@@ -153,5 +160,5 @@ wrap_usage <- function(name, format_name, formals, suffix = NULL, width = 80L) {
 # used for testing
 call_to_usage <- function(code, env = pkg_env()) {
   obj <- call_to_object(!!enexpr(code), env)
-  gsub(""\u{A0}"", "" "", as.character(object_usage(obj)))
+  as.character(object_usage(obj))
 }

---FILE: tests/testthat/_snaps/rd-usage.md---
@@ -27,8 +27,8 @@
       x,
       y,
       xy = ""abcdef"",
-      xyz = c(`word word word word` = ""abcdef"", `word word word` = ""abcdef"",
-        `word word word` = ""abcdef"", `word word word` = ""abcdef"")
+      xyz = c(`word word word word` = ""abcdef"", `word word word` = ""abcdef"", `word word word`
+        = ""abcdef"", `word word word` = ""abcdef"")
     ) 
     
     function_name(

---FILE: tests/testthat/test-rd-usage.R---
@@ -354,4 +354,9 @@ test_that(""old wrapping style doesn't change unexpectedly"", {
   })
 })
 
-
+test_that(""preserves non-breaking-space"", {
+   expect_equal(
+     call_to_usage(f <- function(a = ""\u{A0}"") {}),
+     'f(a = ""\u{A0}"")'
+   )
+})"
r-lib,roxygen2,50d0d9c7cf91790cf69c09297f2be07b92fc99fa,Hadley Wickham,h.wickham@gmail.com,2022-07-07T02:35:03Z,Hadley Wickham,h.wickham@gmail.com,2022-07-07T02:39:08Z,"Redocument RoxyTopic

And add default argument to reduce chances of revdep failure",R/topic.R;man/RoxyTopic.Rd,False,True,True,False,10,4,14,"---FILE: R/topic.R---
@@ -123,8 +123,9 @@ RoxyTopic <- R6::R6Class(""RoxyTopic"", public = list(
   #' another `RoxyTopic` object, all of its sections will be added;
   #' or an [rd_section] object;
   #' or a list of [rd_section] objects to add.
+  #' @param block Name of block to use in error messages.
 
-  add = function(x, block, overwrite = FALSE) {
+  add = function(x, block = ""???"", overwrite = FALSE) {
     if (inherits(x, ""RoxyTopic"")) {
       self$add(x$sections, block, overwrite = overwrite)
     } else if (inherits(x, ""rd_section"")) {
@@ -149,8 +150,9 @@ RoxyTopic <- R6::R6Class(""RoxyTopic"", public = list(
   #' Ensures that each type of name (as given by its name), only appears
   #' once in `self$sections`. This method if for internal use only.
   #' @param section [rd_section] object to add.
+  #' @param block Name of block to use in error messages.
 
-  add_section = function(section, block, overwrite = FALSE) {
+  add_section = function(section, block = ""???"", overwrite = FALSE) {
     if (is.null(section)) return()
     type <- section$type
     if (self$has_section(type) && !overwrite) {

---FILE: man/RoxyTopic.Rd---
@@ -204,7 +204,7 @@ A character vector of topic names.
 \subsection{Method \code{add()}}{
 Add one or more sections to the topic.
 \subsection{Usage}{
-\if{html}{\out{<div class=""r"">}}\preformatted{RoxyTopic$add(x, overwrite = FALSE)}\if{html}{\out{</div>}}
+\if{html}{\out{<div class=""r"">}}\preformatted{RoxyTopic$add(x, block = ""???"", overwrite = FALSE)}\if{html}{\out{</div>}}
 }
 
 \subsection{Arguments}{
@@ -215,6 +215,8 @@ another \code{RoxyTopic} object, all of its sections will be added;
 or an \link{rd_section} object;
 or a list of \link{rd_section} objects to add.}
 
+\item{\code{block}}{Name of block to use in error messages.}
+
 \item{\code{overwrite}}{Whether to overwrite an existing section. If \code{FALSE}
 then the two sections will be merged.}
 }
@@ -227,14 +229,16 @@ then the two sections will be merged.}
 \subsection{Method \code{add_section()}}{
 Add a section.
 \subsection{Usage}{
-\if{html}{\out{<div class=""r"">}}\preformatted{RoxyTopic$add_section(section, overwrite = FALSE)}\if{html}{\out{</div>}}
+\if{html}{\out{<div class=""r"">}}\preformatted{RoxyTopic$add_section(section, block = ""???"", overwrite = FALSE)}\if{html}{\out{</div>}}
 }
 
 \subsection{Arguments}{
 \if{html}{\out{<div class=""arguments"">}}
 \describe{
 \item{\code{section}}{\link{rd_section} object to add.}
 
+\item{\code{block}}{Name of block to use in error messages.}
+
 \item{\code{overwrite}}{Whether to overwrite an existing section. If \code{FALSE}
 then the two sections will be merged.}
 }"
r-lib,roxygen2,7b5437e80f31094b7c7449432e767ea2382a4d01,Hadley Wickham,h.wickham@gmail.com,2022-07-07T02:16:45Z,GitHub,noreply@github.com,2022-07-07T02:16:45Z,"Set tidyverse standard knitr options (#1382)

Fixes #1380. Fixes #1376",NEWS.md;R/markdown.R;man/markdown_pass1.Rd;tests/testthat/_snaps/markdown-code.md;tests/testthat/test-markdown-code.R,False,True,True,False,62,17,79,"---FILE: NEWS.md---
@@ -5,7 +5,8 @@
 * Code evaluated in inline markdown code chunks and `@eval`/`@evalRd`/
   `@evalNamespace` is now evaluated in an environment designed to be more
   reproducible and to suppress output that won't work in Rd (e.g. turning
-  off colour and unicode support in cli) (#1351).
+  off colour and unicode support in cli) (#1351). They now also set 
+  knitr options `comment = #>` (#1380) and `collapse = TRUE` (#1376).
 
 # roxygen2 7.2.0
 

---FILE: R/markdown.R---
@@ -116,7 +116,9 @@ eval_code_node <- function(node, env) {
 knitr_chunk_defaults <- list(
   error = FALSE,
   fig.path = ""man/figures/"",
-  fig.process = function(path) basename(path)
+  fig.process = function(path) basename(path),
+  comment = ""#>"",
+  collapse = TRUE
 )
 
 str_set_all_pos <- function(text, pos, value, nodes) {

---FILE: man/markdown_pass1.Rd---
@@ -33,20 +33,16 @@ The \code{iris} data set has 5 columns:
 
 \if{html}{\out{<div class=""sourceCode r"">}}\preformatted{# Code block demo
 x + 1
-}\if{html}{\out{</div>}}
-
-\if{html}{\out{<div class=""sourceCode"">}}\preformatted{## [1] 101
+#> [1] 101
 }\if{html}{\out{</div>}}
 
 Chunk options:
 
 \if{html}{\out{<div class=""sourceCode r"">}}\preformatted{names(mtcars)
 nrow(mtcars)
-}\if{html}{\out{</div>}}
-
-\if{html}{\out{<div class=""sourceCode"">}}\preformatted{##  [1] ""mpg""  ""cyl""  ""disp"" ""hp""   ""drat"" ""wt""   ""qsec"" ""vs""   ""am""   ""gear""
-## [11] ""carb""
-## [1] 32
+#>  [1] ""mpg""  ""cyl""  ""disp"" ""hp""   ""drat"" ""wt""   ""qsec"" ""vs""   ""am""   ""gear""
+#> [11] ""carb""
+#> [1] 32
 }\if{html}{\out{</div>}}
 
 Plots:

---FILE: tests/testthat/_snaps/markdown-code.md---
@@ -24,3 +24,28 @@
       1: 1 + 
          ^
 
+# interleaving fences and inline code
+
+    Code
+      cat(out1$get_value(""details""))
+    Output
+      Details 10
+      
+      \if{html}{\out{<div class=""sourceCode r"">}}\preformatted{y <- x + 10
+      y
+      #> [1] 20
+      }\if{html}{\out{</div>}}
+
+# preserves white space
+
+    Code
+      cat(out1$get_value(""details""))
+    Output
+      \if{html}{\out{<div class=""sourceCode r"">}}\preformatted{a <- 1
+      
+      b <- 2
+      }\if{html}{\out{</div>}}
+      
+      \if{html}{\out{<div class=""sourceCode r"">}}\preformatted{c <- 3
+      }\if{html}{\out{</div>}}
+

---FILE: tests/testthat/test-markdown-code.R---
@@ -5,7 +5,7 @@ test_that(""can eval inline code"", {
     #' @description Description `r 2 + 2`
     #' @md
     foo <- function() NULL
-    
+
   "")[[1]]
   expect_equal(out1$get_value(""title""), ""Title 2"")
   expect_equal(out1$get_value(""description""), ""Description 4"")
@@ -21,7 +21,7 @@ test_that(""can eval fenced code"", {
     #' ```
     #' @md
     foo <- function() NULL
-    
+
   "")[[1]]
   expect_match(out1$get_value(""details""), ""2"")
 })
@@ -35,7 +35,7 @@ test_that(""use same env within, but not across blocks"", {
     bar <- function() NULL
 
     #' Title
-    #' 
+    #'
     #' Description `r exists('baz', inherits = FALSE)`
     #' @md
     zap <- function() NULL
@@ -56,7 +56,7 @@ test_that(""appropriate knit print method for fenced and inline is applied"", {
   )
   out1 <- roc_proc_text(rd_roclet(), ""
     #' @title Title `r structure('default', class = 'foo')`
-    #' 
+    #'
     #' @details Details
     #'
     #' ```{r}
@@ -153,9 +153,30 @@ test_that(""interleaving fences and inline code"", {
     #' @name dummy
     NULL"")[[1]]
 
-  details <- out1$get_value(""details"")
-  expect_match(details, ""Details 10"", fixed = TRUE)
-  expect_match(details, ""## [1] 20"", fixed = TRUE)
+  expect_snapshot(cat(out1$get_value(""details"")))
+})
+
+test_that(""preserves white space"", {
+    out1 <- roc_proc_text(rd_roclet(), ""
+    #' Title
+    #'
+    #' @details
+    #'
+    #' ```{r}
+    #' a <- 1
+    #'
+    #' b <- 2
+    #' ```
+    #'
+    #' ```{r}
+    #' c <- 3
+    #' ```
+    #'
+    #' @md
+    #' @name dummy
+    NULL"")[[1]]
+
+  expect_snapshot(cat(out1$get_value(""details"")))
 })
 
 test_that(""fence options are used"", {"
r-lib,roxygen2,5613b8e1a7aa893ee4b3aba6f599aa0835b1aea4,Hadley Wickham,h.wickham@gmail.com,2022-07-07T00:38:05Z,Hadley Wickham,h.wickham@gmail.com,2022-07-07T00:38:05Z,"Document `@noRd`

Fixes #1367",vignettes/rd.Rmd,True,False,True,False,6,0,6,"---FILE: vignettes/rd.Rmd---
@@ -681,6 +681,11 @@ This warning originates in Pandoc, and it is harmless.
 
 ## Other tags
 
+### Suppress documentation
+
+It's sometimes useful to include roxygen2 documentation tags without generating an `.Rd` file.
+You can use `@noRd` to suppress file generation for a given topic.
+
 ### Indexing
 
 Three other tags make it easier for the user to find documentation within R's help system:
@@ -711,3 +716,4 @@ Use one tag per source file:
 #' @backref src/file.cpp
 #' @backref src/file.h
 ```
+"
r-lib,roxygen2,d76e9a457f8dee62d9ccdfd1e83de7ac6fc94010,Hadley Wickham,h.wickham@gmail.com,2022-07-06T19:30:36Z,Hadley Wickham,h.wickham@gmail.com,2022-07-06T19:30:36Z,"Better error message if `@describeIn` can't merge

Fixes #1366",NEWS.md;R/rd-describe-in.R;R/rd.R;R/topic.R;R/topics.R;tests/testthat/_snaps/rd-describe-in.md;tests/testthat/test-rd-describe-in.R,False,True,True,False,44,16,60,"---FILE: NEWS.md---
@@ -1,5 +1,7 @@
 # roxygen2 (development version)
 
+* Give useful error if `@describeIn` can't combine docs (#1366).
+
 * Code evaluated in inline markdown code chunks and `@eval`/`@evalRd`/
   `@evalNamespace` is now evaluated in an environment designed to be more
   reproducible and to suppress output that won't work in Rd (e.g. turning

---FILE: R/rd-describe-in.R---
@@ -45,14 +45,19 @@ rd_section_minidesc <- function(type, label, desc) {
 }
 
 #' @export
-merge.rd_section_minidesc <- function(x, y, ...) {
+merge.rd_section_minidesc <- function(x, y, ..., block) {
   stopifnot(identical(class(x), class(y)))
-  stopifnot(identical(x$value$type, y$value$type))
-  rd_section_minidesc(
-    x$value$type,
-    label = c(x$value$label, y$value$label),
-    desc = c(x$value$desc, y$value$desc)
-  )
+
+  if (!identical(x$value$type, y$value$type)) {
+    warn_roxy_block(block, ""Don't know how to combine @describeIn types {.str {x$value$type}} and {.str {y$value$type}}"")
+    x
+  } else {
+    rd_section_minidesc(
+      x$value$type,
+      label = c(x$value$label, y$value$label),
+      desc = c(x$value$desc, y$value$desc)
+    )
+  }
 }
 
 #' @export

---FILE: R/rd.R---
@@ -40,7 +40,7 @@ roclet_process.roclet_rd <- function(x, blocks, env, base_path) {
 
   for (block in blocks) {
     rd <- block_to_rd(block, base_path, env)
-    topics$add(rd)
+    topics$add(rd, block)
   }
   topics_process_family(topics, env)
   topics_process_inherit(topics, env)

---FILE: R/topic.R---
@@ -124,14 +124,14 @@ RoxyTopic <- R6::R6Class(""RoxyTopic"", public = list(
   #' or an [rd_section] object;
   #' or a list of [rd_section] objects to add.
 
-  add = function(x, overwrite = FALSE) {
+  add = function(x, block, overwrite = FALSE) {
     if (inherits(x, ""RoxyTopic"")) {
-      self$add(x$sections, overwrite = overwrite)
+      self$add(x$sections, block, overwrite = overwrite)
     } else if (inherits(x, ""rd_section"")) {
-      self$add_section(x, overwrite = overwrite)
+      self$add_section(x, block, overwrite = overwrite)
     } else if (is.list(x)) {
       for (section in x) {
-        self$add_section(section, overwrite = overwrite)
+        self$add_section(section, block, overwrite = overwrite)
       }
     } else if (is.null(x)) {
       # skip
@@ -150,11 +150,11 @@ RoxyTopic <- R6::R6Class(""RoxyTopic"", public = list(
   #' once in `self$sections`. This method if for internal use only.
   #' @param section [rd_section] object to add.
 
-  add_section = function(section, overwrite = FALSE) {
+  add_section = function(section, block, overwrite = FALSE) {
     if (is.null(section)) return()
     type <- section$type
     if (self$has_section(type) && !overwrite) {
-      section <- merge(self$get_section(type), section)
+      section <- merge(self$get_section(type), section, block = block)
     }
 
     self$sections[[type]] <- section

---FILE: R/topics.R---
@@ -3,14 +3,14 @@
 RoxyTopics <- R6::R6Class(""RoxyTopics"", public = list(
   topics = list(),
 
-  add = function(topic) {
+  add = function(topic, block) {
     if (is.null(topic))
       return()
     stopifnot(inherits(topic, ""RoxyTopic""))
 
     filename <- topic$filename
     if (filename %in% names(self$topics)) {
-      self$topics[[filename]]$add(topic)
+      self$topics[[filename]]$add(topic, block)
     } else {
       self$topics[[filename]] <- topic
     }

---FILE: tests/testthat/_snaps/rd-describe-in.md---
@@ -10,3 +10,7 @@
 
     [<text>:6] @describeIn can not be used with @rdname
 
+# useful error if can't combine
+
+    [<text>:9] Don't know how to combine @describeIn types ""function"" and ""class""
+

---FILE: tests/testthat/test-rd-describe-in.R---
@@ -153,3 +153,20 @@ test_that(""complains about bad usage"", {
     )
   )
 })
+
+test_that(""useful error if can't combine"", {
+
+  expect_snapshot_warning(
+    roc_proc_text(rd_roclet(), r""(
+      #' Class
+      setClass(""foo"")
+
+      #' @describeIn foo generic
+      setGeneric(""bar"", function(x) standardGeneric(""bar""))
+
+      #' @describeIn foo method
+      setMethod(""bar"",""foo"", function(x) 1)
+    )"")
+  )
+
+})"
r-lib,roxygen2,a3b76d05022b04609d415ca9063b47ab80d34dfa,Hadley Wickham,h.wickham@gmail.com,2022-07-06T19:07:33Z,Hadley Wickham,h.wickham@gmail.com,2022-07-06T19:07:33Z,"Tweak vignette names & organisation

Fixes #1372",_pkgdown.yml;vignettes/namespace.Rmd;vignettes/rd-formatting.Rmd;vignettes/rd.Rmd,True,False,True,False,30,16,46,"---FILE: _pkgdown.yml---
@@ -34,6 +34,20 @@ reference:
   - object_format
   - roclet_find
 
+articles:
+- title: roxygen2 tags
+  navbar: ~
+  contents:
+  - roxygen2
+  - rd
+  - rd-formatting
+  - namespace
+
+- title: developer
+  navbar: Developer
+  contents:
+  - extending
+
 news:
   releases:
   - text: ""Version 7.2.0""

---FILE: vignettes/namespace.Rmd---
@@ -1,8 +1,8 @@
 ---
-title: ""NAMESPACE tags""
+title: ""NAMESPACE""
 output: rmarkdown::html_vignette
 vignette: >
-  %\VignetteIndexEntry{NAMESPACE tags}
+  %\VignetteIndexEntry{NAMESPACE}
   %\VignetteEngine{knitr::rmarkdown}
   %\VignetteEncoding{UTF-8}
 ---

---FILE: vignettes/rd-formatting.Rmd---
@@ -1,8 +1,8 @@
 ---
-title: ""Rd formatting""
+title: ""Markdown formatting""
 output: rmarkdown::html_vignette
 vignette: >
-  %\VignetteIndexEntry{Rd formatting}
+  %\VignetteIndexEntry{Markdown formatting}
   %\VignetteEngine{knitr::rmarkdown}
   %\VignetteEncoding{UTF-8}
 ---
@@ -270,16 +270,16 @@ It is never appropriate to use backticks around the `ref` in this form.
 
 S3 and S4 class *not done yet*
 
-+--------------------+------------------------+----------------------------------+
-| Examples           | Help topic\            | Notes                            |
-|                    | for what?              |                                  |
-+:===================+:=======================+:=================================+
-| `[abc-class]`\     | an S4 class named\     | In Rd: `\linkS4class{abc}` or\   |
-| `[pkg::abc-class]` | ""abc"" in same package\ | `\link[pkg:abc-class]{pkg::abc}` |
-|                    | or in `pkg`            |                                  |
-+--------------------+------------------------+----------------------------------+
-| `[abc][abc-class]` | \*is this a thing?     | ??? `\link[=abc-class]{abc}`     |
-+--------------------+------------------------+----------------------------------+
++---------------------+------------------------+----------------------------------+
+| Examples            | Help topic\            | Notes                            |
+|                     | for what?              |                                  |
++:====================+:=======================+:=================================+
+| `[abc-class]`\      | an S4 class named\     | In Rd: `\linkS4class{abc}` or\   |
+| `[pkg::abc-class]`  | ""abc"" in same package\ | `\link[pkg:abc-class]{pkg::abc}` |
+|                     | or in `pkg`            |                                  |
++---------------------+------------------------+----------------------------------+
+| `[abc][abc-class]`  | \*is this a thing?     | ??? `\link[=abc-class]{abc}`     |
++---------------------+------------------------+----------------------------------+
 
 ## Images
 

---FILE: vignettes/rd.Rmd---
@@ -1,8 +1,8 @@
 ---
-title: ""Rd (documentation) tags""
+title: ""Documentation topics""
 output: rmarkdown::html_vignette
 vignette: >
-  %\VignetteIndexEntry{Rd (documentation) tags}
+  %\VignetteIndexEntry{Documentation topics}
   %\VignetteEngine{knitr::rmarkdown}
   %\VignetteEncoding{UTF-8}
 ---"
r-lib,roxygen2,d4040c5916f9f31682c7b996655fad609e5d56f4,Hadley Wickham,h.wickham@gmail.com,2022-05-25T13:57:10Z,GitHub,noreply@github.com,2022-05-25T13:57:10Z,"Make evaluation more reproducible (#1351)

And suppress various cli capabilities that you don't want inside docs

Fixes #1349",NEWS.md;R/markdown.R;R/rd-eval.R;R/rd-raw.R,False,True,True,False,33,5,38,"---FILE: NEWS.md---
@@ -1,5 +1,10 @@
 # roxygen2 (development version)
 
+* Code evaluated in inline markdown code chunks and `@eval`/`@evalRd`/
+  `@evalNamespace` is now evaluated in an environment designed to be more
+  reproducible and to suppress output that won't work in Rd (e.g. turning
+  off colour and unicode support in cli) (#1351).
+
 # roxygen2 7.2.0
 
 ## New features

---FILE: R/markdown.R---
@@ -96,7 +96,6 @@ eval_code_nodes <- function(nodes) {
   # This should only happen in our test cases
   if (is.null(evalenv)) evalenv <- new.env(parent = baseenv())
 
-  withr::local_options(width = 80)
   map_chr(nodes, eval_code_node, env = evalenv)
 }
 
@@ -111,9 +110,7 @@ eval_code_node <- function(node, env) {
     # write knitr markup for fenced code
     text <- paste0(""```"", xml_attr(node, ""info""), ""\n"", xml_text(node), ""```\n"")
   }
-  old_opts <- purrr::exec(opts_chunk$set, knitr_chunk_defaults)
-  withr::defer(purrr::exec(opts_chunk$set, old_opts))
-  knit(text = text, quiet = TRUE, envir = env)
+  roxy_knit(text, env, knitr_chunk_defaults)
 }
 
 knitr_chunk_defaults <- list(

---FILE: R/rd-eval.R---
@@ -0,0 +1,26 @@
+roxy_eval <- function(expr, env) {
+  local_reproducible_output()
+  eval(expr, env)
+}
+
+roxy_knit <- function(text, envir, options) {
+  old_opts <- purrr::exec(opts_chunk$set, options)
+  withr::defer(purrr::exec(opts_chunk$set, old_opts))
+
+  local_reproducible_output()
+  knit(text = text, quiet = TRUE, envir = envir)
+}
+
+# Simplified from testthat::local_reproducible_output
+local_reproducible_output <- function(.envir = parent.frame()) {
+  withr::local_options(
+    crayon.enabled = FALSE,
+    cli.unicode = FALSE,
+    cli.dynamic = FALSE,
+    rlang_interactive = FALSE,
+    width = 80,
+    .local_envir = .envir
+  )
+  withr::local_envvar(RSTUDIO = NA, .local_envir = .envir)
+  withr::local_collate(""C"", .local_envir = .envir)
+}

---FILE: R/rd-raw.R---
@@ -18,7 +18,7 @@ format.rd_section_rawRd <- function(x, ...) {
 
 roxy_tag_eval <- function(tag, env = new.env(parent = baseenv())) {
   tryCatch({
-    out <- eval(tag$val, envir = env)
+    out <- roxy_eval(tag$val, env)
 
     if (!is.character(out)) {
       warn_roxy_tag(tag, ""must evaluate to a character vector"")"
r-lib,roxygen2,467dac4a0e4f2ae10b689fb429665ba0405c2b49,Hadley Wickham,h.wickham@gmail.com,2022-04-27T22:26:54Z,Hadley Wickham,h.wickham@gmail.com,2022-04-27T22:26:54Z,Fix another parameter matching buglet,R/rd-inherit.R;tests/testthat/test-rd-inherit.R,False,True,True,False,2,1,3,"---FILE: R/rd-inherit.R---
@@ -176,7 +176,7 @@ match_param <- function(from, to) {
     return(NULL)
   }
 
-  c(to, to)[match(from, to_std)]
+  unique(c(to, to)[match(from, to_std)])
 }
 
 inherit_dot_params <- function(topic, topics, env) {

---FILE: tests/testthat/test-rd-inherit.R---
@@ -289,6 +289,7 @@ test_that(""match_params can ignore . prefix"", {
   expect_equal(match_param("".x"", c("".x"", "".y"", "".z"")), "".x"")
   expect_equal(match_param(c("".x"", ""y""), c("".x"", "".y"", "".z"")), c("".x"", "".y""))
   expect_equal(match_param(c("".x"", ""x""), c(""x"", "".x"")), c("".x"", ""x""))
+  expect_equal(match_param(c("".x"", ""x""), ""x""), ""x"")
 })
 
 test_that(""multiple @inheritParam tags gathers all params"", {"
r-lib,roxygen2,0694b176a0ed2c7c54d2162ed3be9205ccf26f78,Hadley Wickham,h.wickham@gmail.com,2022-04-27T22:23:03Z,Hadley Wickham,h.wickham@gmail.com,2022-04-27T22:23:03Z,"Unduplicate re-exports

Fixes #1339",R/object-import.R,False,True,True,False,1,1,2,"---FILE: R/object-import.R---
@@ -38,7 +38,7 @@ format.rd_section_reexport <- function(x, ...) {
       ifelse(pkg$file == pkg$fun, """", paste0("":"", pkg$file)),
       ""]{"", escape(pkg$fun), ""}}"",
       collapse = "", "")
-    paste0(""\\item{"", pkg$pkg, ""}{"", links, ""}"")
+    paste0(""\\item{"", pkg$pkg[[1]], ""}{"", links, ""}"")
   })
 
   paste0("
r-lib,roxygen2,8d6802e95348f14df9cb5ea190f6b87c667a480f,Hadley Wickham,h.wickham@gmail.com,2022-04-25T18:55:36Z,Hadley Wickham,h.wickham@gmail.com,2022-04-26T20:17:26Z,"Fix problem revealed by testthat

That I can't figure out a simple test case for :|",R/rd-inherit.R,False,True,True,False,1,1,2,"---FILE: R/rd-inherit.R---
@@ -178,7 +178,7 @@ inherit_dot_params <- function(topic, topics, env) {
   # Then pull out the ones we need
   docs <- lapply(inheritors$source, find_params, topics = topics)
   arg_matches <- function(args, docs) {
-    match <- map_lgl(docs, function(x) x$name %in% args)
+    match <- map_lgl(docs, function(x) all(x$name %in% args))
     matched <- docs[match]
     setNames(
       lapply(matched, ""[["", ""value""),"
r-lib,roxygen2,f4f72748b2519a697c5664257a703cc8435ce4c3,Hadley Wickham,h.wickham@gmail.com,2022-04-25T12:32:45Z,GitHub,noreply@github.com,2022-04-25T12:32:45Z,"Add hyperlink to errors (#1335)

Fixes #1323",DESCRIPTION;NEWS.md;R/block.R;R/tag.R,False,True,True,False,14,6,20,"---FILE: DESCRIPTION---
@@ -21,7 +21,7 @@ Depends:
     R (>= 3.3)
 Imports: 
     brew,
-    cli (>= 3.2.0.9000),
+    cli (>= 3.3.0),
     commonmark,
     desc (>= 1.2.0),
     digest,
@@ -53,5 +53,3 @@ Language: en-GB
 Roxygen: list(markdown = TRUE, load = ""installed"")
 RoxygenNote: 7.1.2.9000
 SystemRequirements: C++11
-Remotes:  
-    r-lib/cli

---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* If you have a daily build of RStudio, roxygen2 warnings will now include a 
+  clickable hyperlink that will take you directly to the problem (#1323).
+
 * Inline R code is now powered by knitr. Where available, (knit) print methods 
   are applied (#1179). This change alters outputs and brings roxygen in line
   with console and R markdown behavior. `x <- ""foo""` no longer inserts anything

---FILE: R/block.R---
@@ -291,6 +291,6 @@ parse_description <- function(tags) {
 }
 
 warn_roxy_block <- function(block, message, ...) {
-  message[[1]] <- paste0(""["", block$file, "":"", block$line, ""] "", message[[1]])
+  message[[1]] <- paste0(link_to(block$file, block$line), "" "", message[[1]])
   cli::cli_warn(message, ..., .envir = parent.frame())
 }

---FILE: R/tag.R---
@@ -121,10 +121,17 @@ roxy_tag_warning <- function(x, ...) {
 #' @rdname roxy_tag
 warn_roxy_tag <- function(tag, message, ...) {
   message[[1]] <- paste0(
-    ""["", tag$file, "":"", tag$line, ""] "",
-    ""@"", tag$tag, "" "",
+    link_to(tag$file, tag$line), "" @"", tag$tag, "" "",
     if (is.null(tag$raw)) (""(automatically generated) ""),
     message[[1]]
   )
   cli::cli_warn(message, ..., .envir = parent.frame())
 }
+
+link_to <- function(file, line) {
+  paste0(""["", cli::style_hyperlink(
+    paste0(basename(file), "":"", line),
+    paste0(""file://"", file),
+    params = c(line = line, col = 1)
+  ), ""]"")
+}"
r-lib,roxygen2,cab16394007dccd794b61432bdd3b25104accfdf,Dan Chaltiel,dan.chaltiel@gmail.com,2022-04-20T16:06:06Z,GitHub,noreply@github.com,2022-04-20T16:06:06Z,"Remove duplicated authors (#1333)

Fixes #1269",NAMESPACE;NEWS.md;R/rd-markdown.R;tests/testthat/test-rd-markdown.R,False,True,True,False,30,0,30,"---FILE: NAMESPACE---
@@ -47,6 +47,7 @@ S3method(format,rd_section_usage)
 S3method(format,rd_section_value)
 S3method(format,roxy_tag)
 S3method(merge,rd_section)
+S3method(merge,rd_section_author)
 S3method(merge,rd_section_inherit)
 S3method(merge,rd_section_inherit_dot_params)
 S3method(merge,rd_section_inherit_section)

---FILE: NEWS.md---
@@ -61,6 +61,8 @@
 
 * `@includeRmd` is now adapted to change in rmarkdown 2.12 regarding math support in `github_document()` (#1304).
 
+* Authors are now only counted only once if mentioned in merged documentations (@DanChaltiel #1333).
+
 # roxygen2 7.1.2
 
 * The new `@examplesIf` tag can be used to create conditional

---FILE: R/rd-markdown.R---
@@ -10,6 +10,13 @@ roxy_tag_rd.roxy_tag_author <- function(x, base_path, env) {
 format.rd_section_author <- function(x, ...) {
   format_collapse(x, ...)
 }
+#' @export
+merge.rd_section_author <- function(x, y, ...) {
+  stopifnot(identical(class(x), class(y)))
+  # Remove duplicated authors, e.g. when using @rdname
+  rd_section(x$type, unique(c(x$value, y$value)))
+}
+
 
 #' @export
 roxy_tag_parse.roxy_tag_format <- function(x) tag_markdown(x)

---FILE: tests/testthat/test-rd-markdown.R---
@@ -13,6 +13,26 @@ test_that(""generic keys produce expected output"", {
   expect_equal(out$get_value(""author""), ""test"")
 })
 
+
+test_that(""author duplicated get removed"", {
+  out <- roc_proc_text(rd_roclet(), ""
+    #' @name a
+    #' @title a
+    #' @author A
+    NULL
+
+    #' @name b
+    #' @rdname a
+    #' @author A
+    NULL
+
+    #' @name c
+    #' @rdname a
+    #' @author B
+    NULL"")[[1]]
+  expect_equal(out$get_value(""author""), c(""A"", ""B""))
+})
+
 test_that(""@format overrides defaults"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' Title"
r-lib,roxygen2,8279a159fea91838ba2c8208d01f928d99f55271,Max Held,info@maxheld.de,2022-04-18T12:45:10Z,GitHub,noreply@github.com,2022-04-18T12:45:10Z,"Apply knitr print method for inline r code (#1193)

Fixes #1179",NEWS.md;R/markdown.R;man/markdown_pass1.Rd;tests/testthat/_snaps/markdown-code.md;tests/testthat/test-markdown-code.R;vignettes/rd-formatting.Rmd,True,True,True,False,228,99,327,"---FILE: NEWS.md---
@@ -1,5 +1,9 @@
 # roxygen2 (development version)
 
+* Inline R code is now powered by knitr. Where available, (knit) print methods 
+  are applied (#1179). This change alters outputs and brings roxygen in line
+  with console and R markdown behavior. `x <- ""foo""` no longer inserts anything
+  into the resulting documentation, but `x <- ""foo""; x` will.
 * roxygen2 can once again read UTF-8 paths on windows (#1277).
 
 * `@exportS3method pkg::generic` now works even when `pkg::generic` isn't 

---FILE: R/markdown.R---
@@ -1,4 +1,3 @@
-
 markdown <- function(text, tag = NULL, sections = FALSE) {
   tag <- tag %||% list(file = NA, line = NA)
   expanded_text <- tryCatch(
@@ -27,7 +26,7 @@ markdown <- function(text, tag = NULL, sections = FALSE) {
 #' To insert the name of the current package: `r packageName()`.
 #'
 #' The `iris` data set has `r ncol(iris)` columns:
-#' `r paste0(""``"", colnames(iris), ""``"", collapse = "", "")`.
+#' `r paste0(""\x60\x60"", colnames(iris), ""\x60\x60"", collapse = "", "")`.
 #'
 #' ```{r}
 #' # Code block demo
@@ -46,10 +45,13 @@ markdown <- function(text, tag = NULL, sections = FALSE) {
 #' ```{r test-figure}
 #' plot(1:10)
 #' ```
-#'
+#' 
+#' Also see `vignette(""rd-formatting"")`.
+#' 
 #' @param text Input text.
-#' @return Text with the inline code expanded. A character vector of the
-#' same length as the input `text`.
+#' @return 
+#' Text with R code expanded. 
+#' A character vector of the same length as the input `text`.
 #'
 #' @importFrom xml2 xml_ns_strip xml_find_all xml_attr
 #' @importFrom purrr keep
@@ -95,20 +97,23 @@ eval_code_nodes <- function(nodes) {
 
 eval_code_node <- function(node, env) {
   if (xml_name(node) == ""code"") {
-    text <- str_replace(xml_text(node), ""^r "", """")
-    paste(eval(parse(text = text), envir = env), collapse = ""\n"")
-
+    # write knitr markup for inline code
+    text <- paste0(""`"", xml_text(node), ""`"")
   } else {
+    # write knitr markup for fenced code
     text <- paste0(""```"", xml_attr(node, ""info""), ""\n"", xml_text(node), ""```\n"")
-    opts_chunk$set(
-      error = FALSE,
-      fig.path = ""man/figures/"",
-      fig.process = function(path) basename(path)
-    )
-    knit(text = text, quiet = TRUE, envir = env)
   }
+  old_opts <- purrr::exec(opts_chunk$set, knitr_chunk_defaults)
+  withr::defer(purrr::exec(opts_chunk$set, old_opts))
+  knit(text = text, quiet = TRUE, envir = env)
 }
 
+knitr_chunk_defaults <- list(
+  error = FALSE,
+  fig.path = ""man/figures/"",
+  fig.process = function(path) basename(path)
+)
+
 str_set_all_pos <- function(text, pos, value, nodes) {
   # Cmark has a bug when reporting source positions for multi-line
   # code tags, and it does not count the indenting space in the

---FILE: man/markdown_pass1.Rd---
@@ -10,8 +10,8 @@ markdown_pass1(text)
 \item{text}{Input text.}
 }
 \value{
-Text with the inline code expanded. A character vector of the
-same length as the input \code{text}.
+Text with R code expanded.
+A character vector of the same length as the input \code{text}.
 }
 \description{
 Expand the embedded inline code
@@ -55,5 +55,7 @@ Plots:
 }\if{html}{\out{</div>}}
 
 \figure{test-figure-1.png}
+
+Also see \code{vignette(""rd-formatting"")}.
 }
 \keyword{internal}

---FILE: tests/testthat/_snaps/markdown-code.md---
@@ -12,6 +12,10 @@
 
     Code
       out <- roc_proc_text(rd_roclet(), block)[[1]]
+    Output
+      
+    Message
+      Quitting from lines 1-1 () 
     Condition
       Warning:
       [<text>:4] @description failed to evaluate inline markdown code

---FILE: tests/testthat/test-markdown-code.R---
@@ -1,33 +1,74 @@
-
-test_that(""can eval"", {
+test_that(""can eval inline code"", {
   out1 <- roc_proc_text(rd_roclet(), ""
+
     #' @title Title `r 1 + 1`
     #' @description Description `r 2 + 2`
     #' @md
-    foo <- function() {}"")[[1]]
-
+    foo <- function() NULL
+    
+  "")[[1]]
   expect_equal(out1$get_value(""title""), ""Title 2"")
   expect_equal(out1$get_value(""description""), ""Description 4"")
 })
 
-test_that(""uses the same env for a block, but not across blocks"", {
+test_that(""can eval fenced code"", {
   out1 <- roc_proc_text(rd_roclet(), ""
-    #' Title `r foobarxxx123 <- 420` `r foobarxxx123`
+
+    #' @title Title
+    #' @details Details
+    #' ```{r lorem}
+    #' 1+1
+    #' ```
+    #' @md
+    foo <- function() NULL
+    
+  "")[[1]]
+  expect_match(out1$get_value(""details""), ""2"")
+})
+
+test_that(""use same env within, but not across blocks"", {
+  example <- ""
+    #' Title `r baz <- 420` `r baz`
     #'
-    #' Description `r exists('foobarxxx123', inherits = FALSE)`
+    #' Description `r exists('baz', inherits = FALSE)`
     #' @md
-    #' @name dummy
-    NULL
+    bar <- function() NULL
+
+    #' Title
+    #' 
+    #' Description `r exists('baz', inherits = FALSE)`
+    #' @md
+    zap <- function() NULL
+  ""
+  out1 <- roc_proc_text(rd_roclet(), example)[[1]]
+  out2 <- roc_proc_text(rd_roclet(), example)[[2]]
+  expect_equal(out1$get_value(""title""), ""Title  420"")
+  expect_equal(out1$get_value(""description""), ""Description TRUE"")
+  expect_equal(out2$get_value(""description""), ""Description FALSE"")
+})
 
-    #' Title another
+test_that(""appropriate knit print method for fenced and inline is applied"", {
+  rlang::local_bindings(
+    knit_print.foo = function(x, inline = FALSE, ...) {
+      knitr::asis_output(ifelse(inline, ""inline"", ""fenced""))
+    },
+    .env = globalenv()
+  )
+  out1 <- roc_proc_text(rd_roclet(), ""
+    #' @title Title `r structure('default', class = 'foo')`
+    #' 
+    #' @details Details
+    #'
+    #' ```{r}
+    #' structure('default', class = 'foo')
+    #' ```
     #'
-    #' Description `r exists('foobarxxx123', inherits = FALSE)`
     #' @md
-    #' @name dummy2
-    NULL"")
-  expect_equal(out1$dummy.Rd$get_value(""title""), ""Title 420 420"")
-  expect_equal(out1$dummy.Rd$get_value(""description""), ""Description TRUE"")
-  expect_equal(out1$dummy2.Rd$get_value(""description""), ""Description FALSE"")
+    #' @name bar
+    NULL
+  "")
+  expect_match(out1$bar.Rd$get_value(""details""), ""fenced"", fixed = TRUE)
+  expect_match(out1$bar.Rd$get_value(""title""), ""inline"", fixed = TRUE)
 })
 
 test_that(""can create markdown markup"", {
@@ -40,12 +81,24 @@ test_that(""can create markdown markup"", {
 test_that(""can create markdown markup piecewise"", {
   expect_identical(
     markdown(
-      ""Description [`r paste0('https://url]')`](`r paste0('link text')`)""
+      ""Description [`r paste0('https://url')`](`r paste0('link text')`)""
     ),
-    ""Description \\link{https://url}](link text)""
+    ""Description \\link{https://url}(link text)""
   )
 })
 
+test_that(""can create escaped markdown markup"", {
+  # this workaround is recommended by @yihui
+  # ""proper"" escaping for inline knitr tracked in https://github.com/yihui/knitr/issues/1704
+  out1 <- roc_proc_text(rd_roclet(), ""
+    #' Title
+    #' Description `r paste0('\\x60', 'bar', '\\x60')`
+    #' @md
+    foo <- function() NULL
+  "")[[1]]
+  expect_match(out1$get_value(""title""), ""\\code{bar}"", fixed = TRUE)
+})
+
 test_that(""NULL creates no text"", {
   expect_identical(
     markdown(""Description --`r NULL`--""),
@@ -89,7 +142,7 @@ test_that(""interleaving fences and inline code"", {
   out1 <- roc_proc_text(rd_roclet(), ""
     #' Title
     #'
-    #' @details Details `r x <- 10`
+    #' @details Details `r x <- 10; x`
     #'
     #' ```{r}
     #' y <- x + 10

---FILE: vignettes/rd-formatting.Rmd---
@@ -106,8 +106,6 @@ Inline code is supported via backticks.
 #'   qualified with the ns prefix, i.e. if the element `bar` is defined ...
 ```
 
-You can also use this syntax to run custom R code and insert its output into the manual page. See section 'Dynamic R code' below.
-
 For blocks of code, put your code between triple backticks:
 
 ```r
@@ -275,94 +273,109 @@ Similarly to the knitr package, you can use the Markdown inline code markup or M
 
 ## Inline code
 
-To do this, prefix the code with `r `, i.e. the lowercase letter 'r' and a space character.
+To insert code inline, enclose it in `` `r ` ``.
 Roxygen will interpret the rest of the text within backticks as R code and evaluate it, and replace the backtick expression with its value.
 After all such substitutions, the text of the whole tag is interpreted as Markdown, as usual.
 
-For example, the following will insert the date and the R version of the roxygen run.
+A simple example:
 
-```r
-#' Roxygen created this manual page on `r ""\x60r Sys.Date()\x60""` using R version
-#' `r ""\x60r getRversion()\x60""`.
+```{r echo=FALSE}
+simple_inline <- ""#' @title Title `r 1 + 1`
+#' @description Description `r 2 + 2`
+#' @md
+foo <- function() NULL
+""
 ```
 
-The value of the R expression is converted to a character string, with `paste(collapse = ""\n"")`.
-So you don't explicitly need to convert to a character value, numeric values or any R object with an `as.character()` S3 method is fine.
-Also, you can insert multiple lines by returning a character vector.
-If you want to run R code without inserting any output, return an empty string or `NULL`.
-
-The value of the expression is inserted into the text of the tag without interpreting it, before the Markdown to `.Rd` conversion, so you can create Markdown markup dynamically:
-
-```r
-#' The `iris` data set has `r ""\x60r ncol(iris)\x60""` columns:
-#' `r ""\x60r paste0(\""\x60\x60\"", colnames(iris), \""\x60\x60\"", collapse = \"", \"")\x60""`.
+```{r code=simple_inline}
 ```
 
-Note that you need to escape backtick characters, if they appear in the R expression, by doubling them, like above.
-The result after the dynamic R code evaluation will be:
+will be turned into:
 
+```{r code = roxygen2:::markdown(simple_inline)}
 ```
-The `iris` data set has 5 columns:
-`Sepal.Length`, `Sepal.Width`, `Petal.Length`, `Petal.Width`, `Species`.
-```
-
-And the final result in the `.Rd` file will look as:
 
-```
-The \code{iris} data set has 5 columns:
-\code{Sepal.Length}, \code{Sepal.Width}, \code{Petal.Length}, \code{Petal.Width}, \code{Species}.
-```
+The resulting text, together with the whole tag is interpreted as markdown, as usual.
+This means that you can use R to dynamically write markdown.
+To markup something as code from within R, you must replace the inner backticks with the unicode hex code `""\x60""`, rather than an actual unicode backtick character.
 
-The R code is evaluated in a new environment that is the child of the package environment of the package you are documenting.
-This means that you can call (internal or exported) functions of the package.
-`packageName()` will also report the name of the package:
+The interpretation from the source all the way to the final Rd documentation goes through three steps.
+For example:
 
-```r
-#' To insert the name of the current package: `r ""\x60r packageName()\x60""`.
+```{r echo=FALSE}
+backtick <- ""#' Title
+#' Description `r paste0('\\x60', 'bar', '\\x60')`
+#' @md
+foo <- function() NULL
+""
 ```
 
-A new evaluation environment is created for each roxygen _block_.
-So the output of this code:
-
-```r
-#' @title ... `r ""\x60r myvar <- \""foo\""; NULL\x60""` `r ""\x60r myvar\x60""`
-#'
-#' @description ... `r ""\x60r myvar\x60""`
+```{r code = backtick}
 ```
 
-will be:
-
-```r
-#' @title ... foo
-#'
-#' @description ... foo
-```
-
-Currently the whole code expression must be on the same line, multi-line expressions are not supported.
+1. is run through knitr to evaluate R, yielding:
+    
+    ```{r code = roxygen2:::markdown_pass1(backtick)}
+    ```
+    
+2. is then run through roxygen's markdown engine, yielding:
+    
+    ```{r code = roxygen2:::markdown(backtick)}
+    ```
+    
+3. is finally turned into Rd documentation using roxygen, yielding:
+
+    ```{r, echo=FALSE, results=""asis""}
+    cat(
+      ""\x60\x60\x60rd\n"",
+      format(roxygen2:::roc_proc_text(roxygen2::rd_roclet(), backtick)[[1]]),
+      ""\n\x60\x60\x60""
+    )
+    ```
 
 ## Code blocks
 
-Markdown code blocks can be dynamic as well, if you use `r ""\x60\x60\x60{r}""` to start them, just like in knitr documents.
+To insert entire blocks of code, enclose them in ` ```{r} `, just like in knitr documents.
+They go through the same three steps described above for inline code.
 
-```r
-#' ```{r}
-#' # This block of code will be evaluated
-#' summary(iris)
+For example:
+
+```{r echo=FALSE}
+simple_fenced <- ""#' @title Title
+#' @details Details
+#' ```{r lorem}
+#' 1+1
 #' ```
+#' @md
+foo <- function() NULL
+""
+```
+
+```{r code=simple_fenced}
 ```
 
-Within a roxygen block, code blocks and inline code use the same evaluation environment, so variables created in one of them can be used in others.
+becomes:
 
-Code blocks support knitr chunk options, e.g. to keep the output of several expressions together, you can specify `results= ""hold""`:
+```{r, echo=FALSE, results=""asis""}
+cat(
+  ""\x60\x60\x60rd\n"",
+  format(roxygen2:::roc_proc_text(roxygen2::rd_roclet(), simple_fenced)[[1]]),
+  ""\n\x60\x60\x60""
+)
+```
+
+Code blocks support knitr chunk options, e.g. to keep the output of several expressions together, you can specify `results=""hold""`:
 
 ```r
-#' ```{r results = ""hold""}
+#' ```{r results=""hold""}
 #' names(mtcars)
 #' nrow(mtcars)
 #' ```
 ```
 
-Plots will create `.png` files in the `man/figures` directory. The file names are created from the chunk names:
+Plots will create `.png` files in the `man/figures` directory.
+Note that plots in `man/figures` may quickly increase the size of your package.
+The file names are created from the chunk names.
 
 ```r
 #' ```{r iris-pairs-plot}
@@ -371,18 +384,67 @@ Plots will create `.png` files in the `man/figures` directory. The file names ar
 #' ```
 ```
 
-Note that the generated `.png` files will be added to the package, and they can considerably increase the size of the package.
+## Details
+
+This feature is powered by the knitr package.
+
+This causes some limitations and differences to keep in mind:
+
+  * Inline and fenced code blocks from the same _roxygen block_ share the same evaluation environment. 
+    As a result, variables created in one code block can be reused in another one.
+    For example:
+    
+    ```{r include=FALSE}
+    code_envs <- ""#' Title `r baz <- 420` `r baz`
+    #'
+    #' Description `r exists('baz', inherits = FALSE)`
+    #' @md
+    bar <- function() NULL
+
+    #' Title
+    #' 
+    #' Description `r exists('baz', inherits = FALSE)`
+    #' @md
+    zap <- function() NULL
+    ""
+    ```
 
-Note that code block support is currently experimental, and somewhat limited.
-Some of the known limitations:
+    ```{r code=code_envs}
+    ```
+    
+    becomes:
+    
+    ```{r, echo=FALSE, results=""asis""}
+    cat(
+      ""\x60\x60\x60rd\n"",
+      format(roxygen2:::roc_proc_text(roxygen2::rd_roclet(), code_envs)[[1]]),
+      format(roxygen2:::roc_proc_text(roxygen2::rd_roclet(), code_envs)[[2]]),
+      ""\n\x60\x60\x60""
+    )
+    ```
+    Notice how inside the documentation for `zap()`, `baz` does not exist (""Description `FALSE`"").
 
-  * Because the code blocks are evaluated individually, they cannot refer to each other.
+  * The R code is evaluated in a new environment that is the child of the package environment of the package you are documenting.
+    This means that you can call (internal or exported) functions of the package.
+    For example, `packageName()` will report the name of the current package:
+
+    ```r
+    #' To insert the name of the current package: `packageName()`.
+    ```
+  * The code blocks are run every time you call `roxygenize()` (or `devtools::document()`) to generated the Rd files.
   * Some knitr chunk options are reset at the start of every code block, so if you want to change these, you'll have to specify them for every chunk.
-    These are currently `error`, `fig.path`, `fig.process`.
+    These are currently `r paste0(""\x60"", names(roxygen2:::knitr_chunk_defaults), ""\x60"")`.
   * Some knitr options might not create meaningful output.
   * The Markdown code runs every time you call `roxygenize()` (or `devtools::document()`) to generate the Rd files.
     This potentially makes `roxygenize()` (much) slower.
     You can turn on knitr caching as usual, but make sure to omit the cache from the package.
+  * knitr calls the appropriate `print()` or (if available) `knitr::knit_print()` methods on the result.
+    The resulting markdown from some of these methods may not be supported by roxygen's subset of markdown (see `vignette(""rd.Rmd"")`). 
+    You can always override the automatic methods, and have your R calls return
+    valid markdown as a character vector, wrapped in `knitr::asis_output()`. 
+
+Also recall that everything *outside* of inline or fenced code is *not* handled by rmarkdown, but by roxygen.
+Not all features from rmarkdown are available.
 
 # Roxygen and Rd tags *not* parsed as Markdown
 
@@ -520,4 +582,3 @@ tabular <- function(df, ...) {
 
 cat(tabular(mtcars[1:5, 1:5]))
 ```
-"
r-lib,roxygen2,ad941c77581f2e3e03c36d68f39e3f4fbf16a479,Hadley Wickham,h.wickham@gmail.com,2022-04-12T12:36:54Z,GitHub,noreply@github.com,2022-04-12T12:36:54Z,"Translate path to native encoding (#1325)

Fixes #1277",NEWS.md;src/parser2.cpp;tests/testthat/test-collate.R,False,True,True,False,12,1,13,"---FILE: NEWS.md---
@@ -1,5 +1,7 @@
 # roxygen2 (development version)
 
+* roxygen2 can once again read UTF-8 paths on windows (#1277).
+
 * `@exportS3method pkg::generic` now works even when `pkg::generic` isn't 
   imported by your package (#1085).
 

---FILE: src/parser2.cpp---
@@ -174,7 +174,8 @@ cpp11::list tokenise_block(cpp11::strings lines, std::string file,
 cpp11::strings find_includes(std::string path) {
   std::vector<std::string> includes;
 
-  std::ifstream file(path.c_str());
+  std::string path_native = Rf_translateChar(cpp11::r_string(path));
+  std::ifstream file(path_native.c_str());
   if (!file.good())
     cpp11::stop(""Failed to open %s"", path.c_str());
 

---FILE: tests/testthat/test-collate.R---
@@ -33,3 +33,11 @@ test_that(""DESCRIPTION file is re-written only if collate changes"", {
     update_collate(""."")
   })
 })
+
+test_that(""can read from file name with utf-8 path"", {
+  path <- withr::local_tempfile(
+    pattern = ""Universit\u00e0-"",
+    lines = c(""#' @include foo.R"", NULL)
+  )
+  expect_equal(find_includes(path), ""foo.R"")
+})"
r-lib,roxygen2,ab81f4061bc73d34a2cc1c783e1fbb4b513b4350,Hadley Wickham,h.wickham@gmail.com,2022-04-12T12:34:32Z,GitHub,noreply@github.com,2022-04-12T12:34:32Z,"Finish remainder of cli conversion (#1330)

Fixes #1154. Fixes #1207.

Includes some further refactoring of `local_package_copy()` to set `RoxygenVersion` automatically, and set the `Encoding` of the ""empty"" package.",R/field.R;R/load.R;R/markdown-escaping.R;R/markdown.R;R/object-from-call.R;R/object-package.R;R/object-r6.R;R/rd-family.R;R/rd-inherit.R;R/rd-template.R;R/rd.R;R/roclet.R;R/select-args.R;R/topic.R;R/topics.R;R/utils-io.R;R/utils.R;R/vignette.R;tests/testthat/_snaps/markdown-code.md;tests/testthat/_snaps/object-package.md;tests/testthat/_snaps/object-r6.md;tests/testthat/_snaps/rd-template.md;tests/testthat/_snaps/rd.md;tests/testthat/_snaps/select-args.md;tests/testthat/_snaps/topics.md;tests/testthat/empty/DESCRIPTION;tests/testthat/helper-test.R;tests/testthat/test-markdown-code.R;tests/testthat/test-markdown.R;tests/testthat/test-object-package.R;tests/testthat/test-object-r6.R;tests/testthat/test-rd-r6.R;tests/testthat/test-rd-template.R;tests/testthat/test-rd.R;tests/testthat/test-roxygenize-setup.R;tests/testthat/test-select-args.R;tests/testthat/test-topics.R;tests/testthat/test-utils-io.R;tests/testthat/testNonASCII/R/a.r,False,True,True,False,278,141,419,"---FILE: R/field.R---
@@ -39,7 +39,7 @@ print.rd_section <- function(x, ...) {
 
 #' @export
 format.rd_section <- function(x, ...) {
-  abort(paste0(""`format."", class(x)[[1]], ""` not found""))
+  cli::cli_abort(""`format.{class(x)[[1]]}` method not found"")
 }
 
 #' @export

---FILE: R/load.R---
@@ -82,18 +82,18 @@ find_load_strategy <- function(x, option = roxy_meta_get(""load"", ""pkgload"")) {
   if (is.null(x)) {
     x <- option
     if (!is.character(x) || length(x) != 1) {
-      abort(""roxygen2 `load` option must be a string"")
+      cli::cli_abort(""roxygen2 {.code load} option must be a string"")
     }
   } else {
     if (!is.character(x) || length(x) != 1) {
-      abort(""`load_code` must be a string or function"")
+      cli::cli_abort(""{.code load_code} must be a string or function"")
     }
   }
 
   switch(x,
     pkgload = load_pkgload,
     source = load_source,
     installed = load_installed,
-    abort(""Unknown value of `load` option"")
+    cli::cli_abort(""Unknown value of {.code load} option"")
   )
 }

---FILE: R/markdown-escaping.R---
@@ -186,7 +186,7 @@ str_sub_same <- function(str, repl, id) {
   repl <- repl[ order(repl$start), ]
 
   if (is.unsorted(repl$end) || is.unsorted(repl$argend)) {
-    stop(""Replacement intervals must not overlap"")
+    cli::cli_abort(""Replacement intervals must not overlap"", .internal = TRUE)
   }
 
   for (i in seq_len(nrow(repl))) {

---FILE: R/markdown.R---
@@ -1,14 +1,11 @@
 
 markdown <- function(text, tag = NULL, sections = FALSE) {
   tag <- tag %||% list(file = NA, line = NA)
-  tryCatch(
-    expanded_text <- markdown_pass1(text),
+  expanded_text <- tryCatch(
+    markdown_pass1(text),
     error = function(e) {
-      message <- paste0(
-        if (!is.na(tag$file)) paste0(""["", tag$file, "":"", tag$line, ""] ""),
-        ""@"", tag$tag, "" in inline code: "", e$message
-      )
-      stop(message, call. = FALSE)
+      warn_roxy_tag(tag, ""failed to evaluate inline markdown code"", parent = e)
+      text
     }
   )
   escaped_text <- escape_rd_for_md(expanded_text)
@@ -119,7 +116,7 @@ str_set_all_pos <- function(text, pos, value, nodes) {
   # for now we just simply error for multi-line inline code.
   types <- xml_name(nodes)
   if (any(types == ""code"" & pos$start_line != pos$end_line)) {
-    stop(""multi-line `r ` markup is not supported"")
+    cli::cli_abort(""multi-line `r ` markup is not supported"", call = NULL)
   }
 
   # Need to split the string, because of the potential multi-line

---FILE: R/object-from-call.R---
@@ -284,7 +284,7 @@ object_topic <- function(value, alias, type) {
     `function` = alias,
     package = alias,
     data = alias,
-    stop(""Unsupported type '"", type, ""'"", call. = FALSE)
+    cli::cli_abort(""Unsupported type {.str {type}}"", .internal = TRUE)
   )
 }
 

---FILE: R/object-package.R---
@@ -19,7 +19,7 @@ package_seealso_urls <- function(desc) {
 package_authors <- function(desc) {
   authors <- tryCatch(eval(parse(text = desc$`Authors@R` %||% """")),
     error = function(e) {
-      warning(e)
+      cli::cli_warn(""Failed to evaluate Authors@R."", parent = e)
       NULL
     }
   )
@@ -42,7 +42,7 @@ package_authors <- function(desc) {
 
 author_desc <- function(x) {
   if (inherits(x, ""person"")) {
-    stop(""person class must be stripped"", call. = FALSE)
+    cli::cli_abort(""Person class must be stripped"", .internal = FALSE)
   }
 
   desc <- paste0(x$given, collapse = "" "")

---FILE: R/object-r6.R---
@@ -45,13 +45,18 @@ extract_r6_methods <- function(x) {
     function(m) {
       ref <- utils::getSrcref(m)
       if (is.null(ref)) {
-        name <- x$classname %||% NA
-        stop(
-          ""R6 class "", if (!is.na(name)) paste0(""("", name, "") ""),
-          ""without source references. "",
-          ""If you use the `installed` load method in `DESCRIPTION`, then "",
-          ""try re-installing the package with option '--with-keep.source'. "",
-          ""E.g. `install.packages(..., INSTALL_OPTS = \""--with-keep.source\"")`.""
+        name <- x$classname %||% ""unknown""
+
+        cli::cli_abort(
+          c(
+            ""R6 class {.cls {name}} lacks source references."",
+            i = paste0(
+              ""If you are using the `installed` load method in `DESCRIPTION`, then "",
+              ""try re-installing the package with option '--with-keep.source', e.g. "",
+              ""{.code install.packages(..., INSTALL_OPTS = \""--with-keep.source\"")}.""
+            )
+          ),
+          call = NULL
         )
       }
       utils::getSrcLocation(ref)

---FILE: R/rd-family.R---
@@ -23,8 +23,7 @@ topics_process_family_prefix <- function(family) {
   # validate meta structure
   valid <- is.character(meta) || is.list(meta)
   if (!valid) {
-    message <- ""rd_family_title is set, but is not a named list / vector""
-    abort(message)
+    cli::cli_abort(""{.code rd_family_title} is set, but is not a named list / vector"")
   }
 
   # extract element

---FILE: R/rd-inherit.R---
@@ -173,7 +173,7 @@ inherit_dot_params <- function(topic, topics, env) {
 
   # Need to find formals for each source
   funs <- lapply(inheritors$source, function(x) eval(parse(text = x), envir = env))
-  args <- map2(funs, inheritors$args, select_args_text)
+  args <- map2(funs, inheritors$args, select_args_text, topic = topic)
 
   # Then pull out the ones we need
   docs <- lapply(inheritors$source, find_params, topics = topics)

---FILE: R/rd-template.R---
@@ -42,7 +42,9 @@ template_find <- function(base_path, template_name) {
   path_exists <- file.exists(path)
 
   if (!any(path_exists)) {
-    stop(""Can't find template '"", template_name, ""'"", call. = FALSE)
+    # This should really use warn_roxy_tag() but it's not worth refactoring
+    # for this rarely used feature
+    cli::cli_abort(""Can't find template {.str {template_name}}"", call = NULL)
   }
 
   path[path_exists][[1]]

---FILE: R/rd.R---
@@ -70,7 +70,7 @@ roclet_output.roclet_rd <- function(x, results, base_path, ..., is_first = FALSE
     old_paths <- old_paths[!file.info(old_paths)$isdir]
     old_roxygen <- Filter(made_by_roxygen, old_paths)
     if (length(old_roxygen) > 0) {
-      message(paste0(""Deleting "", basename(old_roxygen), collapse = ""\n""))
+      cli::cli_inform(""Deleting {.file {basename(old_roxygen)}}"")
       unlink(old_roxygen)
     }
   }
@@ -106,7 +106,7 @@ block_to_rd <- function(block, base_path, env) {
 #' @export
 
 block_to_rd.default <- function(block, ...) {
-  stop(""Internal roxygen error, unknown block type"")
+  cli::cli_abort(""Unknown block type"", .internal = TRUE)
 }
 
 #' @export

---FILE: R/roclet.R---
@@ -108,7 +108,7 @@ roclet_find <- function(x) {
   }
 
   if (!is.roclet(res)) {
-    stop(""Must return a roclet"", call. = FALSE)
+    cli::cli_abort(""Must return a roclet"")
   }
 
   res

---FILE: R/select-args.R---
@@ -1,16 +1,16 @@
-select_args_text <- function(fun, select = """") {
+select_args_text <- function(fun, select = """", topic) {
   pieces <- strsplit(select, "" +"")[[1]]
 
   tryCatch(
     {
       parsed <- lapply(pieces, function(x) parse(text = x)[[1]])
+      select_args(fun, parsed)
     },
     error = function(e) {
-      stop(""Failed to parse: '"", select, ""'"", call. = FALSE)
+      warn_roxy_tag(topic, ""failed to parse argument specification"", parent = e)
+      character()
     }
   )
-
-  select_args(fun, parsed)
 }
 
 # Figure out which arguments that the user wants given a function and
@@ -50,14 +50,24 @@ select_args <- function(fun, select = list()) {
 }
 
 select_check <- function(x, call) {
-  if (is.numeric(x) && (all(x > 0) || all(x < 0)))
-    return()
+  if (!is.numeric(x)) {
+    cli::cli_abort(c(
+      ""Argument specification must evaluate to a numeric vector"",
+      ""Problem in {.code {deparse(call)}}""
+    ))
+  }
 
-  stop(
-    ""Arguments must evaluate to all positive or negative numbers.\n"",
-    ""Problem: "", paste(deparse(call), collapse = """"),
-    call. = FALSE
-  )
+  if (!(all(x > 0) || all(x < 0))) {
+    cli::cli_abort(
+      c(
+        ""Argument specification must be all positive or all negative, not a mixture"",
+        i = ""Problem in {.code {deparse(call)}}""
+      ),
+      call = NULL
+    )
+  }
+
+  invisible()
 }
 
 select_sign <- function(x) {

---FILE: R/topic.R---
@@ -136,7 +136,10 @@ RoxyTopic <- R6::R6Class(""RoxyTopic"", public = list(
     } else if (is.null(x)) {
       # skip
     } else {
-      stop(""Don't know how to add object of type "", class(x)[1])
+      cli::cli_abort(
+        ""Don't know how to add object of type {.cls {class(x)[1]}}"",
+        .internal = TRUE
+      )
     }
     invisible()
   },

---FILE: R/topics.R---
@@ -22,7 +22,10 @@ RoxyTopics <- R6::R6Class(""RoxyTopics"", public = list(
   drop_invalid = function() {
     for (topic in names(self$topics)) {
       if (!self$topics[[topic]]$is_valid()) {
-        warning(topic, "" is missing name/title. Skipping"", call. = FALSE)
+        cli::cli_warn(c(
+          ""Skipping {.path {topic}}"",
+          i = ""File lacks name and/or title""
+        ))
         self$topics[[topic]] <- NULL
       }
     }

---FILE: R/utils-io.R---
@@ -1,5 +1,5 @@
-readLines <- function(...) stop(""Use read_lines!"")
-writeLines <- function(...) stop(""Use write_lines!"")
+readLines <- function(...) cli::cli_abort(""Use read_lines!"", .internal = TRUE)
+writeLines <- function(...) cli::cli_abort(""Use write_lines!"", .internal = TRUE)
 
 read_lines <- function(path, n = -1L) {
   base::readLines(path, n = n, encoding = ""UTF-8"", warn = FALSE)

---FILE: R/utils.R---
@@ -95,7 +95,7 @@ write_if_different <- function(path, contents, check = TRUE) {
 
 same_contents <- function(path, contents) {
   if (length(contents) != 1) {
-    stop(""Internal roxygen error: `contents` must be character(1)"")
+    cli::cli_abort(""`contents` must be character(1)"", .internal = TRUE)
   }
   if (!file.exists(path)) return(FALSE)
 

---FILE: R/vignette.R---
@@ -43,7 +43,7 @@ vign_outdated <- function(vign) {
 vign_update <- function(vign) {
   if (!vign_outdated(vign)) return(FALSE)
 
-  message(""Rebuilding "", basename(vign))
+  cli::cli_inform(""Rebuilding {.file {basename(vign)}}"")
   output <- tools::buildVignette(vign, dirname(vign), tangle = FALSE,
     clean = FALSE)
 
@@ -55,15 +55,15 @@ vign_update_all <- function(pkg_path) {
   if (!file.exists(vig_path)) return()
 
   if (file.exists(file.path(vig_path, ""Makefile""))) {
-    message(""Updating vignettes with make"")
+    cli::cli_inform(""Updating vignettes with make"")
 
     make <- Sys.getenv(""MAKE"", ""make"")
     old <- setwd(vig_path)
     on.exit(setwd(old), add = TRUE)
 
     system(make)
   } else {
-    message(""Updating vignettes"")
+    cli::cli_inform(""Updating vignettes"")
 
     vigs <- tools::pkgVignettes(dir = pkg_path)
     invisible(map_lgl(vigs$docs, vign_update))

---FILE: tests/testthat/_snaps/markdown-code.md---
@@ -1,26 +1,22 @@
-# various errors
+# multi-line inline code gives useful warning
 
     Code
-      roc_proc_text(rd_roclet(),
-      ""\n      #' Title\n      #'\n      #' Description --`r 1 +\n      #'   1`--\n      #' @md\n      #' @name dummy\n      NULL"")[[
-        1]]
+      out <- roc_proc_text(rd_roclet(), block)[[1]]
     Condition
-      Error:
-      ! [<text>:4] @description in inline code: multi-line `r ` markup is not supported
-    Code
-      roc_proc_text(rd_roclet(),
-      ""\n      #' Title\n      #'\n      #' Description --`r 1 + 'a'`--\n      #' @md\n      #' @name dummy\n      NULL"")[[
-        1]]
-    Condition
-      Error:
-      ! [<text>:4] @description in inline code: non-numeric argument to binary operator
+      Warning:
+      [<text>:4] @description failed to evaluate inline markdown code
+      Caused by error:
+      ! multi-line `r ` markup is not supported
+
+# inline code gives useful warning
+
     Code
-      roc_proc_text(rd_roclet(),
-      ""\n      #' Title\n      #'\n      #' Description --`r 1 + `--\n      #' @md\n      #' @name dummy\n      NULL"")[[
-        1]]
+      out <- roc_proc_text(rd_roclet(), block)[[1]]
     Condition
-      Error:
-      ! [<text>:4] @description in inline code: <text>:2:0: unexpected end of input
+      Warning:
+      [<text>:4] @description failed to evaluate inline markdown code
+      Caused by error in `parse()`:
+      ! <text>:2:0: unexpected end of input
       1: 1 + 
          ^
 

---FILE: tests/testthat/_snaps/object-package.md---
@@ -24,3 +24,26 @@
     Output
       [1] ""H W \\email{h@w.com} (\\href{https://orcid.org/1234}{ORCID}) (extra)""
 
+# useful message if Authors@R is corrupted
+
+    Code
+      package_authors(list(`Authors@R` = ""1 + ""))
+    Condition
+      Warning:
+      Failed to evaluate Authors@R.
+      Caused by error in `parse()`:
+      ! <text>:2:0: unexpected end of input
+      1: 1 + 
+         ^
+    Output
+      NULL
+    Code
+      package_authors(list(`Authors@R` = ""stop('Uhoh')""))
+    Condition
+      Warning:
+      Failed to evaluate Authors@R.
+      Caused by error:
+      ! Uhoh
+    Output
+      NULL
+

---FILE: tests/testthat/_snaps/object-r6.md---
@@ -0,0 +1,9 @@
+# extract_r6_data without source refs
+
+    Code
+      extract_r6_data(C)
+    Condition
+      Error:
+      ! R6 class <foo> lacks source references.
+      i If you are using the `installed` load method in `DESCRIPTION`, then try re-installing the package with option '--with-keep.source', e.g. `install.packages(..., INSTALL_OPTS = ""--with-keep.source"")`.
+

---FILE: tests/testthat/_snaps/rd-template.md---
@@ -0,0 +1,8 @@
+# templates gives useful error if not found
+
+    Code
+      roc_proc_text(rd_roclet(), block)
+    Condition
+      Error:
+      ! Can't find template ""doesn't-exist""
+

---FILE: tests/testthat/_snaps/rd.md---
@@ -40,3 +40,12 @@
     Message
       i Loading testUtf8Escape
 
+# automatically deletes unused files
+
+    Code
+      roxygenise()
+    Message
+      i Loading empty
+      
+      Deleting 'test.Rd'
+

---FILE: tests/testthat/_snaps/select-args.md---
@@ -0,0 +1,34 @@
+# warns on invalid input
+
+    Code
+      select_args_text(sum, ""-xlab:"", tag)
+    Condition
+      Warning:
+      [test.R:1] @test failed to parse argument specification
+      Caused by error in `parse()`:
+      ! <text>:2:0: unexpected end of input
+      1: -xlab:
+         ^
+    Output
+      character(0)
+    Code
+      select_args_text(sum, ""\""a\"""", tag)
+    Condition
+      Warning:
+      [test.R:1] @test failed to parse argument specification
+      Caused by error in `select_check()`:
+      ! Argument specification must evaluate to a numeric vector
+      Problem in `""a""`
+    Output
+      character(0)
+    Code
+      select_args_text(function(x, y, z) { }, ""-x:z"", tag)
+    Condition
+      Warning:
+      [test.R:1] @test failed to parse argument specification
+      Caused by error:
+      ! Argument specification must be all positive or all negative, not a mixture
+      i Problem in `-x:z`
+    Output
+      character(0)
+

---FILE: tests/testthat/_snaps/topics.md---
@@ -0,0 +1,11 @@
+# missing title generates useful message
+
+    Code
+      roc_proc_text(rd_roclet(), block)
+    Condition
+      Warning:
+      Skipping 'foo.Rd'
+      i File lacks name and/or title
+    Output
+      named list()
+

---FILE: tests/testthat/empty/DESCRIPTION---
@@ -1,2 +1,3 @@
 Package: empty
 Version: 1.0.0
+Encoding: UTF-8

---FILE: tests/testthat/helper-test.R---
@@ -16,9 +16,14 @@ expect_parse_failure <- function(code)  {
   (expect_warning(expect_null(code)))
 }
 
-local_package_copy <- function(path, env = caller_env()) {
+local_package_copy <- function(path, env = caller_env(), set_version = TRUE) {
   temp_path <- withr::local_tempdir(.local_envir = env)
 
   file.copy(path, temp_path, recursive = TRUE)
   withr::local_dir(file.path(temp_path, basename(path)), .local_envir = env)
+  if (set_version) {
+    desc::desc_set(RoxygenNote = as.character(packageVersion(""roxygen2"")))
+  }
+
+  invisible()
 }

---FILE: tests/testthat/test-markdown-code.R---
@@ -53,38 +53,36 @@ test_that(""NULL creates no text"", {
   )
 })
 
-test_that(""various errors"", {
-  expect_snapshot(error = TRUE, {
-
-    # multi-line inline code block
-    roc_proc_text(rd_roclet(), ""
-      #' Title
-      #'
-      #' Description --`r 1 +
-      #'   1`--
-      #' @md
-      #' @name dummy
-      NULL""
-      )[[1]]
-
-    # evaluation errors are reported nicely
-    roc_proc_text(rd_roclet(), ""
-      #' Title
-      #'
-      #' Description --`r 1 + 'a'`--
-      #' @md
-      #' @name dummy
-      NULL"")[[1]]
-
-    # parse errors are reported nicely
-    roc_proc_text(rd_roclet(), ""
-      #' Title
-      #'
-      #' Description --`r 1 + `--
-      #' @md
-      #' @name dummy
-      NULL"")[[1]]
-  })
+
+test_that(""multi-line inline code gives useful warning"", {
+  block <- ""
+    #' Title
+    #'
+    #' `r 1 +
+    #' 1`
+    #' @md
+    foo <- function() {}
+  ""
+
+  expect_snapshot(
+    out <- roc_proc_text(rd_roclet(), block)[[1]]
+  )
+  expect_equal(out$get_value(""description""), ""\\verb{r 1 + 1}"")
+})
+
+test_that(""inline code gives useful warning"", {
+  block <- ""
+    #' Title
+    #'
+    #' `r 1 + `
+    #' @md
+    foo <- function() {}
+  ""
+
+  expect_snapshot(
+    out <- roc_proc_text(rd_roclet(), block)[[1]]
+  )
+  expect_equal(out$get_value(""description""), ""\\verb{r 1 + }"")
 })
 
 test_that(""interleaving fences and inline code"", {

---FILE: tests/testthat/test-markdown.R---
@@ -1,4 +1,5 @@
 # code --------------------------------------------------------------------
+# see test-markdown-code.R for evaluated code
 
 test_that(""backticks are converted to \\code & \\verb"", {
   out1 <- roc_proc_text(rd_roclet(), ""

---FILE: tests/testthat/test-object-package.R---
@@ -18,6 +18,12 @@ test_that(""person turned into meaningful text"", {
   })
 })
 
+test_that(""useful message if Authors@R is corrupted"", {
+  expect_snapshot({
+    package_authors(list(`Authors@R` = ""1 + ""))
+    package_authors(list(`Authors@R` = ""stop('Uhoh')""))
+  })
+})
 
 test_that(""can convert DOIs in url"", {
   expect_equal(

---FILE: tests/testthat/test-object-r6.R---
@@ -0,0 +1,13 @@
+test_that(""extract_r6_data without source refs"", {
+  txt <- ""R6::R6Class('foo',
+     public = list(
+       field1 = NULL,
+       meth1 = function(Z) { },
+       meth2 = function(Z = 10, ...) { },
+       field2 = \""foobar\"",
+       meth3 = function() { }
+     )
+   )""
+  C <- eval(parse(text = txt, keep.source = FALSE))
+  expect_snapshot(extract_r6_data(C), error = TRUE)
+})

---FILE: tests/testthat/test-rd-r6.R---
@@ -1,19 +1,3 @@
-
-test_that(""extract_r6_data without source refs"", {
-  txt <-
-    ""R6::R6Class(
-       public = list(
-         field1 = NULL,
-         meth1 = function(Z) { },
-         meth2 = function(Z = 10, ...) { },
-         field2 = \""foobar\"",
-         meth3 = function() { }
-       )
-     )""
-  C <- eval(parse(text = txt, keep.source = FALSE))
-  expect_error(extract_r6_data(C), ""without source references"")
-})
-
 test_that(""extract_r6_methods"", {
   txt <-
     ""R6::R6Class(

---FILE: tests/testthat/test-rd-template.R---
@@ -23,6 +23,14 @@ test_that(""can find template from name"", {
   )
 })
 
+test_that(""templates gives useful error if not found"", {
+  block <- ""
+    #' @template doesn't-exist
+    x <- 10
+  ""
+  expect_snapshot(roc_proc_text(rd_roclet(), block), error = TRUE)
+})
+
 test_that(""templates replace variables with their values"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' @template values

---FILE: tests/testthat/test-rd.R---
@@ -158,7 +158,6 @@ test_that(""@details NULL"", {
 
 test_that(""can generate nonASCII document"", {
   local_package_copy(test_path('testNonASCII'))
-  desc::desc_set(RoxygenNote = as.character(packageVersion(""roxygen2"")))
 
   expect_snapshot({
     roxygenise(roclets = ""rd"")
@@ -176,7 +175,6 @@ test_that(""can generate nonASCII document"", {
 
 test_that(""unicode escapes are ok"", {
   local_package_copy(test_path('testUtf8Escape'))
-  desc::desc_set(RoxygenNote = as.character(packageVersion(""roxygen2"")))
 
   expect_snapshot({
     roxygenise(roclets = ""rd"")
@@ -191,17 +189,11 @@ test_that(""unicode escapes are ok"", {
   expect_true(any(grepl(""7\u00b0C"", rd)))
 })
 
-test_that(""write_lines writes unix-style line endings."", {
-  path <- test_path(""escapes.Rd"")
+test_that(""automatically deletes unused files"", {
+  local_package_copy(test_path(""empty""))
+  dir.create(""man"")
+  suppressMessages(roxygenise())
 
-  # skip if checked on windows with autocrlf = true
-  skip_if(detect_line_ending(path) == ""\r\n"")
-
-  temp_filename <- tempfile()
-  old_binary <- readBin(path, ""raw"", n = file.info(path)$size)
-  old_text <- read_lines(path)
-  write_lines(old_text, temp_filename)
-  on.exit(unlink(temp_filename), add = TRUE)
-  new_binary <- readBin(temp_filename, ""raw"", n = file.info(temp_filename)$size)
-  expect_identical(new_binary, old_binary)
+  write_lines(made_by(""%""), ""man/test.Rd"")
+  expect_snapshot(roxygenise())
 })

---FILE: tests/testthat/test-roxygenize-setup.R---
@@ -1,12 +1,11 @@
 test_that(""useful error if no DESCRIPTION"", {
-  local_package_copy(test_path(""no-desc""))
+  local_package_copy(test_path(""no-desc""), set_version = FALSE)
 
   expect_snapshot(roxygen_setup(), error = TRUE)
 })
 
 test_that(""informs about initial setup"", {
-  local_package_copy(test_path(""empty""))
-  desc::desc_set(Encoding = ""UTF-8"")
+  local_package_copy(test_path(""empty""), set_version = FALSE)
 
   expect_snapshot(roxygen_setup(cur_version = ""8.0.0""))
 })
@@ -20,14 +19,14 @@ test_that(""warns about non UTF-8 encoding"", {
 
 test_that(""warns if roxygen version is too new"", {
   local_package_copy(test_path(""empty""))
-  desc::desc_set(Encoding = ""UTF-8"", RoxygenNote = ""10.0.0"")
+  desc::desc_set(RoxygenNote = ""10.0.0"")
 
   expect_snapshot(roxygen_setup(cur_version = ""8.0.0""))
 })
 
 test_that(""informs about major changes in 7.0.0"", {
   local_package_copy(test_path(""empty""))
-  desc::desc_set(Encoding = ""UTF-8"", RoxygenNote = ""5.0.0"")
+  desc::desc_set(RoxygenNote = ""5.0.0"")
 
   expect_snapshot(roxygen_setup(cur_version = ""8.0.0""))
 })

---FILE: tests/testthat/test-select-args.R---
@@ -1,9 +1,11 @@
-test_that(""errors on invalid input"", {
-  expect_error(select_args_text(sum, ""-xlab:""), ""Failed to parse"")
-  expect_error(select_args_text(sum, '""a""'), ""numbers"")
+test_that(""warns on invalid input"", {
+  tag <- roxy_test_tag()
 
-  f <- function(x, y, z) {}
-  expect_error(select_args_text(f, ""-x:z""), ""numbers"")
+  expect_snapshot({
+    select_args_text(sum, ""-xlab:"", tag)
+    select_args_text(sum, '""a""', tag)
+    select_args_text(function(x, y, z) {}, ""-x:z"", tag)
+  })
 })
 
 test_that(""positive initial values starts from nothing"", {

---FILE: tests/testthat/test-topics.R---
@@ -0,0 +1,7 @@
+test_that(""missing title generates useful message"", {
+  block <- ""
+    #' @name foo
+    NULL
+  ""
+  expect_snapshot(roc_proc_text(rd_roclet(), block))
+})

---FILE: tests/testthat/test-utils-io.R---
@@ -62,3 +62,16 @@ test_that(""write_lines writes windows newlines for files with windows newlines,
   write_lines(""baz"", empty_file)
   expect_equal(readChar(empty_file, 100), ""baz\n"")
 })
+
+test_that(""write_lines writes unix-style line endings."", {
+  path <- test_path(""escapes.Rd"")
+  # skip if checked on windows with autocrlf = true
+  skip_if(detect_line_ending(path) == ""\r\n"")
+
+  temp <- withr::local_tempfile()
+  write_lines(read_lines(path), temp)
+
+  old_binary <- readBin(path, ""raw"", n = file.info(path)$size)
+  new_binary <- readBin(temp, ""raw"", n = file.info(temp)$size)
+  expect_equal(new_binary, old_binary)
+})

---FILE: tests/testthat/testNonASCII/R/a.r---
@@ -2,5 +2,4 @@
 #'
 #' @note 갬걈疸쇉둖
 printChineseMsg <- function() {
-  message(""갬僚슛TF8眄疸쇉둖駱蓂뷖"")
 }"
r-lib,roxygen2,03e4a644b3f63924645f866acaea4ca4b170c77a,Hadley Wickham,h.wickham@gmail.com,2022-04-09T14:31:49Z,GitHub,noreply@github.com,2022-04-09T14:31:49Z,"In `@exportS3method`, parse class name from function name (#1326)

Fixes #1085",NEWS.md;R/namespace.R;tests/testthat/_snaps/namespace.md;tests/testthat/test-namespace.R,False,True,True,False,81,20,101,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* `@exportS3method pkg::generic` now works even when `pkg::generic` isn't 
+  imported by your package (#1085).
+
 * Markdown code blocks are always wrapped in `<div class=""sourceCode"">`
   even if the language is unknown (#1234).
 

---FILE: R/namespace.R---
@@ -174,15 +174,39 @@ roxy_tag_ns.roxy_tag_exportS3Method <- function(x, block, env, import_only = FAL
   }
 
   obj <- block$object
-  if (length(x$val) < 2 && !inherits(obj, ""s3method"")) {
-    warn_roxy_tag(x, ""must be used with an S3 method when it has 0 or 1 values"")
-    return()
-  }
 
   if (identical(x$val, """")) {
+    if (!inherits(obj, ""s3method"")) {
+      warn_roxy_tag(x, ""must be used with an known S3 method"")
+      return()
+    }
+
     method <- attr(obj$value, ""s3method"")
   } else if (length(x$val) == 1) {
-    method <- c(x$val, attr(obj$value, ""s3method"")[[2]])
+    if (!inherits(obj, ""function"")) {
+      warn_roxy_tag(x, ""must be used with a function"")
+      return()
+    }
+
+    if (!str_detect(x$val, ""::"")) {
+      warn_roxy_tag(x, ""must have form package::generic"")
+      return()
+    }
+
+    generic <- str_split(x$val, ""::"")[[1]]
+    generic_re <- paste0(""^"", generic[[2]], ""\\."")
+
+    if (!str_detect(obj$alias, generic_re)) {
+      warn_roxy_tag(x, c(
+        ""doesn't match function name"",
+        x = ""Expected to see {.str {generic[[2]]}} to match {.str {x$val}}"",
+        i = ""Function name is {.str {obj$alias}}""
+      ))
+      return()
+    }
+
+    class <- str_remove(obj$alias, generic_re)
+    method <- c(x$val, class)
   } else {
     method <- x$val
   }

---FILE: tests/testthat/_snaps/namespace.md---
@@ -1,6 +1,20 @@
-# @exportS3method generatedsS3method()
+# @exportS3method generates fully automatically
 
-    [<text>:1] @exportS3Method must be used with an S3 method when it has 0 or 1 values
+    [<text>:2] @exportS3Method must be used with an known S3 method
+
+# @exportS3method can extract class from generic
+
+    [<text>:2] @exportS3Method must have form package::generic
+
+---
+
+    [<text>:2] @exportS3Method must be used with a function
+
+---
+
+    [<text>:2] @exportS3Method doesn't match function name
+    x Expected to see ""foo"" to match ""pkg::foo""
+    i Function name is ""foo1.bar""
 
 # poorly formed importFrom throws error
 

---FILE: tests/testthat/test-namespace.R---
@@ -75,33 +75,53 @@ test_that(""export handles non-syntactic names"", {
   expect_equal(out, ""S3method(\""foo-bar\"",integer)"")
 })
 
-test_that(""@exportS3method generatedsS3method()"", {
-  out <- roc_proc_text(namespace_roclet(),
-    ""#' @exportS3Method
+test_that(""@exportS3method generates fully automatically"", {
+  out <- roc_proc_text(namespace_roclet(),""
+    #' @exportS3Method
     mean.foo <- function(x) 'foo'
   "")
   expect_equal(out, ""S3method(mean,foo)"")
 
-  out <- roc_proc_text(namespace_roclet(),
-    ""#' @exportS3Method base::mean
-    mean.foo <- function(x) 'foo'
-  "")
-  expect_equal(out, ""S3method(base::mean,foo)"")
-
   expect_snapshot_warning(
-    roc_proc_text(namespace_roclet(),
-      ""#' @exportS3Method base::mean
-      NULL
+    roc_proc_text(namespace_roclet(), ""
+      #' @exportS3Method
+      f <- function(x) 'foo'
     "")
   )
+})
 
+test_that(""@exportS3methd can create literal directive"", {
   out <- roc_proc_text(namespace_roclet(),
     ""#' @exportS3Method base::mean foo
     NULL
   "")
   expect_equal(out, ""S3method(base::mean,foo)"")
+})
 
-
+test_that(""@exportS3method can extract class from generic"", {
+  out <- roc_proc_text(namespace_roclet(), ""
+    #' @exportS3Method pkg::foo
+    foo.bar <- function(x) 'foo'
+  "")
+  expect_equal(out, ""S3method(pkg::foo,bar)"")
+
+  block <- ""
+    #' @exportS3Method pkg_foo
+    foo.bar <- function(x) 'foo'
+  ""
+  expect_snapshot_warning(roc_proc_text(namespace_roclet(), block))
+
+  block <- ""
+    #' @exportS3Method pkg::foo
+    foo1.bar <- 10
+  ""
+  expect_snapshot_warning(roc_proc_text(namespace_roclet(), block))
+
+  block <- ""
+    #' @exportS3Method pkg::foo
+    foo1.bar <- function(x) 'foo'
+  ""
+  expect_snapshot_warning(roc_proc_text(namespace_roclet(), block))
 })
 
 test_that(""exportClass overrides default class name"", {"
r-lib,roxygen2,0ae4c595d0da7ec109e59c1d5d2cd72842d7665d,Hadley Wickham,h.wickham@gmail.com,2022-04-09T14:31:19Z,GitHub,noreply@github.com,2022-04-09T14:31:19Z,"Mention `@usage` (#1327)

Fixes #1302",vignettes/rd.Rmd,True,False,True,False,5,0,5,"---FILE: vignettes/rd.Rmd---
@@ -168,6 +168,10 @@ sum <- function(..., na.rm = TRUE) {}
 Indent the second and subsequent lines of a tag so that when scanning the documentation so it's easy to see where one tag ends and the next begins.
 Tags that always span multiple lines (like `@example`) should start on a new line and don't need to be indented.
 
+In most case, the function usage will be automatically derived from the function specification.
+For the cases where it is not, please [file an issue](https://github.com/r-lib/roxygen2/issues) and use `@usage` to override the default with you want.
+If you want to suppress the usage altogether (which is sometimes useful for internal or deprecated functions), you can use `@usage NULL`.
+
 ### S3
 
 -   S3 **generics** are regular functions, so document them as such.
@@ -707,3 +711,4 @@ Use one tag per source file:
 #' @backref src/file.cpp
 #' @backref src/file.h
 ```
+"
r-lib,roxygen2,e6bbc79a32f64f8c894c62dfb5a7dbb41b8b166a,Hadley Wickham,h.wickham@gmail.com,2022-04-09T14:28:52Z,GitHub,noreply@github.com,2022-04-09T14:28:52Z,"Always generate div.sourceCode (#1324)

Fixes #1234",NEWS.md;R/markdown.R;tests/testthat/_snaps/markdown.md;tests/testthat/test-markdown.R,False,True,True,False,9,11,20,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* Markdown code blocks are always wrapped in `<div class=""sourceCode"">`
+  even if the language is unknown (#1234).
+
 * roxygen2 no longer generates invalid HTML (#1290).
 
 * All warning messages have been reviewed to hopefully be more informative

---FILE: R/markdown.R---
@@ -268,11 +268,13 @@ mdxml_code_block <- function(xml, state) {
   if (is.na(info) || nchar(info[1]) == 0) info <- NA_character_
   paste0(
     ""\n\n"",
-    if (!is.na(info)) paste0(""\\if{html}{\\out{<div class=\""sourceCode "", info, ""\"">}}""),
+    ""\\if{html}{\\out{<div class=\""sourceCode"",
+      if (!is.na(info)) paste0("" "", info),
+    ""\"">}}"",
     ""\\preformatted{"",
     escape_verb(xml_text(xml)),
     ""}"",
-    if (!is.na(info)) ""\\if{html}{\\out{</div>}}""
+    ""\\if{html}{\\out{</div>}}""
   )
 }
 

---FILE: tests/testthat/_snaps/markdown.md---
@@ -2,8 +2,8 @@
 
     Before
     
-    \preformatted{x \%in\% 1:10
-    }
+    \if{html}{\out{<div class=""sourceCode"">}}\preformatted{x \%in\% 1:10
+    }\if{html}{\out{</div>}}
     
     After
 

---FILE: tests/testthat/test-markdown.R---
@@ -77,13 +77,6 @@ test_that(""special operators get \\code{}, not \\verb{}"", {
   expect_equal(markdown(""`if`""), ""\\code{if}"")
 })
 
-test_that(""code blocks escape %"", {
-  expect_equal(
-    markdown(""```\n1:10 %>% mean()\n```""),
-    ""\\preformatted{1:10 \\%>\\% mean()\n}""
-  )
-})
-
 test_that(""inline code works with < and >"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' `SELECT <name> FROM <table>`"
r-lib,roxygen2,ea7d27fb36438fb4a2ed8d51405a3d3a2bea955f,Hadley Wickham,h.wickham@gmail.com,2022-04-08T16:04:44Z,GitHub,noreply@github.com,2022-04-08T16:04:44Z,"Fixes for HTML 5 (#1319)

* Use style to float package logo
* Ensure \preformatted start paragraphs
* Generate pure HTML in R7 inherited methods summary
* Disambiguate methods with classname",R/markdown.R;R/object-defaults.R;R/object-r6.R;R/rd-r6.R;man/load.Rd;man/load_options.Rd;man/markdown_pass1.Rd;man/roxygen2-package.Rd;tests/testthat/_snaps/markdown.md;tests/testthat/roxygen-block-3-A.Rd;tests/testthat/roxygen-block-3-B.Rd;tests/testthat/roxygen-block-3-C.Rd;tests/testthat/test-markdown.R,False,True,True,False,136,110,246,"---FILE: R/markdown.R---
@@ -267,6 +267,7 @@ mdxml_code_block <- function(xml, state) {
   info <- xml_attr(xml, ""info"")[1]
   if (is.na(info) || nchar(info[1]) == 0) info <- NA_character_
   paste0(
+    ""\n\n"",
     if (!is.na(info)) paste0(""\\if{html}{\\out{<div class=\""sourceCode "", info, ""\"">}}""),
     ""\\preformatted{"",
     escape_verb(xml_text(xml)),

---FILE: R/object-defaults.R---
@@ -44,7 +44,7 @@ object_defaults.package <- function(x, block) {
   description <- package_url_parse(description)
   logo_path <- file.path(x$value$path, ""man"", ""figures"", ""logo.png"")
   if (file.exists(logo_path)) {
-    fig <- ""\\if{html}{\\figure{logo.png}{options: align='right' alt='logo' width='120'}}""
+    fig <- ""\\if{html}{\\figure{logo.png}{options: style='float: right' alt='logo' width='120'}}""
     description <- paste0(fig, ""\n\n"", description)
   }
 

---FILE: R/object-r6.R---
@@ -68,6 +68,7 @@ extract_r6_methods <- function(x) {
   methods <- data.frame(
     stringsAsFactors = FALSE,
     type = if (length(method_loc)) ""method"" else character(),
+    class = if (length(method_loc)) x$classname %||% NA_character_ else character(),
     name = unname(method_nms),
     file = unname(method_fnm),
     line = unname(method_loc),
@@ -91,6 +92,7 @@ add_default_method_data <- function(obj, methods) {
     rec <- data.frame(
       stringsAsFactors = FALSE,
       type = defaults[[mname]]$type %||% ""method"",
+      class = defaults[[mname]]$class %||% obj$classname %||% ""unknown"",
       name = defaults[[mname]]$name %||% mname,
       file = defaults[[mname]]$file %||% NA_character_,
       line = defaults[[mname]]$line %||% NA_integer_,
@@ -108,6 +110,7 @@ extract_r6_fields <- function(x) {
     stringsAsFactors = FALSE,
     type = rep(""field"", length(field_nms)),
     name = as.character(field_nms),
+    class = rep(x$classname %||% NA_character_, length(field_nms)),
     file = rep(NA, length(field_nms)),
     line = rep(NA, length(field_nms)),
     formals = I(replicate(length(field_nms), NULL))
@@ -120,6 +123,7 @@ extract_r6_bindings <- function(x) {
     stringsAsFactors = FALSE,
     type = if (length(bind_nms)) ""active"" else character(),
     name = as.character(bind_nms),
+    class = rep(x$classname %||% NA_character_, length(bind_nms)),
     file = rep(NA, length(bind_nms)),
     line = rep(NA, length(bind_nms)),
     formals = I(replicate(length(bind_nms), NULL))

---FILE: R/rd-r6.R---
@@ -238,7 +238,8 @@ r6_method_list <- function(block, methods) {
   c(""\\subsection{Public methods}{"",
     ""\\itemize{"",
     sprintf(
-      ""\\item \\href{#method-%s}{\\code{%s$%s()}}"",
+      ""\\item \\href{#method-%s-%s}{\\code{%s$%s()}}"",
+      methods$class,
       nms,
       block$object$alias,
       nms
@@ -261,43 +262,43 @@ r6_inherited_method_list <- function(block, r6data) {
   super_meth <- super_meth[rev(seq_len(nrow(super_meth))), ]
 
   details <- paste0(
-    ""<details "",
-    if (nrow(super_meth) <= 5) ""open "",
+    ""<details"",
+    if (nrow(super_meth) <= 5) "" open"",
     ""><summary>Inherited methods</summary>""
   )
 
-  c(""\\if{html}{"",
-    paste0(""\\out{"", details, ""}""),
-    ""\\itemize{"",
+  c(""\\if{html}{\\out{"", details,
+    ""<ul>"",
     sprintf(
       paste0(
-        ""\\item \\out{<span class=\""pkg-link\"" data-pkg=\""%s\"" "",
-        ""data-topic=\""%s\"" data-id=\""%s\"">}"",
-        ""\\href{../../%s/html/%s.html#method-%s}{\\code{%s::%s$%s()}}"",
-        ""\\out{</span>}""
+        ""<li>"",
+        ""<span class=\""pkg-link\"" data-pkg=\""%s\"" data-topic=\""%s\"" data-id=\""%s\"">"",
+        ""<a href='../../%s/html/%s.html#method-%s-%s'><code>%s::%s$%s()</code></a>"",
+        ""</li>""
       ),
       super_meth$package,
       super_meth$classname,
       super_meth$name,
       super_meth$package,
       super_meth$classname,
+      super_meth$classname,
       super_meth$name,
       super_meth$package,
       super_meth$classname,
       super_meth$name
     ),
-    ""}"",
-    ""\\out{</details>}"",
-    ""}""
+    ""</ul>"",
+    ""</details>"",
+    ""}}""
   )
 }
 
 r6_method_begin <- function(block, method) {
   nm <- r6_show_name(method$name)
   c(
     ""\\if{html}{\\out{<hr>}}"",
-    paste0(""\\if{html}{\\out{<a id=\""method-"", nm, ""\""></a>}}""),
-    paste0(""\\if{latex}{\\out{\\hypertarget{method-"", nm, ""}{}}}""),
+    paste0(""\\if{html}{\\out{<a id=\""method-"", method$class, ""-"", nm, ""\""></a>}}""),
+    paste0(""\\if{latex}{\\out{\\hypertarget{method-"", method$class, ""-"", nm, ""}{}}}""),
     paste0(""\\subsection{Method \\code{"", nm, ""()}}{"")
   )
 }

---FILE: man/load.Rd---
@@ -37,6 +37,8 @@ outside of roxygen2.
 
 You can change the default strategy for your function with roxygen2 \code{load}
 option. Override the default off \code{pkgload} to use the \code{source} or
-\code{installed} strategies:\preformatted{Roxygen: list(load = ""source"")
+\code{installed} strategies:
+
+\preformatted{Roxygen: list(load = ""source"")
 }
 }

---FILE: man/load_options.Rd---
@@ -38,10 +38,14 @@ Options in \code{man/roxygen/meta.R} override those present in \code{DESCRIPTION
 
 \section{How to set}{
 
-Either set in \code{DESCRIPTION}:\preformatted{Roxygen: list(markdown = TRUE, load = ""installed"")
+Either set in \code{DESCRIPTION}:
+
+\preformatted{Roxygen: list(markdown = TRUE, load = ""installed"")
 }
 
-Or if longer, you can put in \verb{/man/roxygen/meta.R}:\preformatted{list(
+Or if longer, you can put in \verb{/man/roxygen/meta.R}:
+
+\preformatted{list(
   markdown = TRUE,
   load = ""installed""
 )

---FILE: man/markdown_pass1.Rd---
@@ -29,19 +29,29 @@ function, and this is \code{TRUE}: TRUE.
 To insert the name of the current package: roxygen2.
 
 The \code{iris} data set has 5 columns:
-\code{Sepal.Length}, \code{Sepal.Width}, \code{Petal.Length}, \code{Petal.Width}, \code{Species}.\if{html}{\out{<div class=""sourceCode r"">}}\preformatted{# Code block demo
+\code{Sepal.Length}, \code{Sepal.Width}, \code{Petal.Length}, \code{Petal.Width}, \code{Species}.
+
+\if{html}{\out{<div class=""sourceCode r"">}}\preformatted{# Code block demo
 x + 1
-}\if{html}{\out{</div>}}\preformatted{## [1] 101
+}\if{html}{\out{</div>}}
+
+\preformatted{## [1] 101
 }
 
-Chunk options:\if{html}{\out{<div class=""sourceCode r"">}}\preformatted{names(mtcars)
+Chunk options:
+
+\if{html}{\out{<div class=""sourceCode r"">}}\preformatted{names(mtcars)
 nrow(mtcars)
-}\if{html}{\out{</div>}}\preformatted{##  [1] ""mpg""  ""cyl""  ""disp"" ""hp""   ""drat"" ""wt""   ""qsec"" ""vs""   ""am""   ""gear""
+}\if{html}{\out{</div>}}
+
+\preformatted{##  [1] ""mpg""  ""cyl""  ""disp"" ""hp""   ""drat"" ""wt""   ""qsec"" ""vs""   ""am""   ""gear""
 ## [11] ""carb""
 ## [1] 32
 }
 
-Plots:\if{html}{\out{<div class=""sourceCode r"">}}\preformatted{plot(1:10)
+Plots:
+
+\if{html}{\out{<div class=""sourceCode r"">}}\preformatted{plot(1:10)
 }\if{html}{\out{</div>}}
 
 \figure{test-figure-1.png}

---FILE: man/roxygen2-package.Rd---
@@ -6,7 +6,7 @@
 \alias{roxygen2-package}
 \title{roxygen2: In-Line Documentation for R}
 \description{
-\if{html}{\figure{logo.png}{options: align='right' alt='logo' width='120'}}
+\if{html}{\figure{logo.png}{options: style='float: right' alt='logo' width='120'}}
 
 Generate your Rd documentation, 'NAMESPACE' file, and collation field using specially formatted comments. Writing documentation in-line with code makes it easier to keep your documentation up-to-date as your requirements change. 'Roxygen2' is inspired by the 'Doxygen' system for C++.
 }

---FILE: tests/testthat/_snaps/markdown.md---
@@ -1,3 +1,21 @@
+# code blocks work
+
+    Before
+    
+    \preformatted{x \%in\% 1:10
+    }
+    
+    After
+
+# code block with language creates HTML tag
+
+    Before
+    
+    \if{html}{\out{<div class=""sourceCode r"">}}\preformatted{x \%in\% 1:10
+    }\if{html}{\out{</div>}}
+    
+    After
+
 # can convert table to Rd
 
     Code

---FILE: tests/testthat/roxygen-block-3-A.Rd---
@@ -49,15 +49,15 @@ Class A details
 \section{Methods}{
 \subsection{Public methods}{
 \itemize{
-\item \href{#method-meth1}{\code{A$meth1()}}
-\item \href{#method-meth2}{\code{A$meth2()}}
-\item \href{#method-meth3}{\code{A$meth3()}}
-\item \href{#method-clone}{\code{A$clone()}}
+\item \href{#method-A-meth1}{\code{A$meth1()}}
+\item \href{#method-A-meth2}{\code{A$meth2()}}
+\item \href{#method-A-meth3}{\code{A$meth3()}}
+\item \href{#method-A-clone}{\code{A$clone()}}
 }
 }
 \if{html}{\out{<hr>}}
-\if{html}{\out{<a id=""method-meth1""></a>}}
-\if{latex}{\out{\hypertarget{method-meth1}{}}}
+\if{html}{\out{<a id=""method-A-meth1""></a>}}
+\if{latex}{\out{\hypertarget{method-A-meth1}{}}}
 \subsection{Method \code{meth1()}}{
 A method 1.
 \subsection{Usage}{
@@ -81,8 +81,8 @@ A method 1.
 
 }
 \if{html}{\out{<hr>}}
-\if{html}{\out{<a id=""method-meth2""></a>}}
-\if{latex}{\out{\hypertarget{method-meth2}{}}}
+\if{html}{\out{<a id=""method-A-meth2""></a>}}
+\if{latex}{\out{\hypertarget{method-A-meth2}{}}}
 \subsection{Method \code{meth2()}}{
 Method 2 description.
 \subsection{Usage}{
@@ -112,8 +112,8 @@ Method 2 details.
 
 }
 \if{html}{\out{<hr>}}
-\if{html}{\out{<a id=""method-meth3""></a>}}
-\if{latex}{\out{\hypertarget{method-meth3}{}}}
+\if{html}{\out{<a id=""method-A-meth3""></a>}}
+\if{latex}{\out{\hypertarget{method-A-meth3}{}}}
 \subsection{Method \code{meth3()}}{
 \subsection{Usage}{
 \if{html}{\out{<div class=""r"">}}\preformatted{A$meth3(duplicate, missing)}\if{html}{\out{</div>}}
@@ -137,8 +137,8 @@ twice.
 }
 }
 \if{html}{\out{<hr>}}
-\if{html}{\out{<a id=""method-clone""></a>}}
-\if{latex}{\out{\hypertarget{method-clone}{}}}
+\if{html}{\out{<a id=""method-A-clone""></a>}}
+\if{latex}{\out{\hypertarget{method-A-clone}{}}}
 \subsection{Method \code{clone()}}{
 The objects of this class are cloneable with this method.
 \subsection{Usage}{

---FILE: tests/testthat/roxygen-block-3-B.Rd---
@@ -36,22 +36,22 @@ Class B details.
 \section{Methods}{
 \subsection{Public methods}{
 \itemize{
-\item \href{#method-meth1}{\code{B$meth1()}}
-\item \href{#method-meth4}{\code{B$meth4()}}
-\item \href{#method-clone}{\code{B$clone()}}
-}
-}
-\if{html}{
-\out{<details open ><summary>Inherited methods</summary>}
-\itemize{
-\item \out{<span class=""pkg-link"" data-pkg=""roxygen2"" data-topic=""A"" data-id=""meth2"">}\href{../../roxygen2/html/A.html#method-meth2}{\code{roxygen2::A$meth2()}}\out{</span>}
-\item \out{<span class=""pkg-link"" data-pkg=""roxygen2"" data-topic=""A"" data-id=""meth3"">}\href{../../roxygen2/html/A.html#method-meth3}{\code{roxygen2::A$meth3()}}\out{</span>}
-}
-\out{</details>}
-}
+\item \href{#method-B-meth1}{\code{B$meth1()}}
+\item \href{#method-B-meth4}{\code{B$meth4()}}
+\item \href{#method-B-clone}{\code{B$clone()}}
+}
+}
+\if{html}{\out{
+<details open><summary>Inherited methods</summary>
+<ul>
+<li><span class=""pkg-link"" data-pkg=""roxygen2"" data-topic=""A"" data-id=""meth2""><a href='../../roxygen2/html/A.html#method-A-meth2'><code>roxygen2::A$meth2()</code></a></li>
+<li><span class=""pkg-link"" data-pkg=""roxygen2"" data-topic=""A"" data-id=""meth3""><a href='../../roxygen2/html/A.html#method-A-meth3'><code>roxygen2::A$meth3()</code></a></li>
+</ul>
+</details>
+}}
 \if{html}{\out{<hr>}}
-\if{html}{\out{<a id=""method-meth1""></a>}}
-\if{latex}{\out{\hypertarget{method-meth1}{}}}
+\if{html}{\out{<a id=""method-B-meth1""></a>}}
+\if{latex}{\out{\hypertarget{method-B-meth1}{}}}
 \subsection{Method \code{meth1()}}{
 B method 1.
 \subsection{Usage}{
@@ -67,8 +67,8 @@ B method 1.
 }
 }
 \if{html}{\out{<hr>}}
-\if{html}{\out{<a id=""method-meth4""></a>}}
-\if{latex}{\out{\hypertarget{method-meth4}{}}}
+\if{html}{\out{<a id=""method-B-meth4""></a>}}
+\if{latex}{\out{\hypertarget{method-B-meth4}{}}}
 \subsection{Method \code{meth4()}}{
 A method 4.
 \subsection{Usage}{
@@ -77,8 +77,8 @@ A method 4.
 
 }
 \if{html}{\out{<hr>}}
-\if{html}{\out{<a id=""method-clone""></a>}}
-\if{latex}{\out{\hypertarget{method-clone}{}}}
+\if{html}{\out{<a id=""method-B-clone""></a>}}
+\if{latex}{\out{\hypertarget{method-B-clone}{}}}
 \subsection{Method \code{clone()}}{
 The objects of this class are cloneable with this method.
 \subsection{Usage}{

---FILE: tests/testthat/roxygen-block-3-C.Rd---
@@ -46,23 +46,23 @@ Classs C details.
 \section{Methods}{
 \subsection{Public methods}{
 \itemize{
-\item \href{#method-meth2}{\code{C$meth2()}}
-\item \href{#method-meth5}{\code{C$meth5()}}
-\item \href{#method-undocumented_method}{\code{C$undocumented_method()}}
-}
-}
-\if{html}{
-\out{<details open ><summary>Inherited methods</summary>}
-\itemize{
-\item \out{<span class=""pkg-link"" data-pkg=""roxygen2"" data-topic=""A"" data-id=""meth3"">}\href{../../roxygen2/html/A.html#method-meth3}{\code{roxygen2::A$meth3()}}\out{</span>}
-\item \out{<span class=""pkg-link"" data-pkg=""roxygen2"" data-topic=""B"" data-id=""meth1"">}\href{../../roxygen2/html/B.html#method-meth1}{\code{roxygen2::B$meth1()}}\out{</span>}
-\item \out{<span class=""pkg-link"" data-pkg=""roxygen2"" data-topic=""B"" data-id=""meth4"">}\href{../../roxygen2/html/B.html#method-meth4}{\code{roxygen2::B$meth4()}}\out{</span>}
-}
-\out{</details>}
-}
+\item \href{#method-C-meth2}{\code{C$meth2()}}
+\item \href{#method-C-meth5}{\code{C$meth5()}}
+\item \href{#method-C-undocumented_method}{\code{C$undocumented_method()}}
+}
+}
+\if{html}{\out{
+<details open><summary>Inherited methods</summary>
+<ul>
+<li><span class=""pkg-link"" data-pkg=""roxygen2"" data-topic=""A"" data-id=""meth3""><a href='../../roxygen2/html/A.html#method-A-meth3'><code>roxygen2::A$meth3()</code></a></li>
+<li><span class=""pkg-link"" data-pkg=""roxygen2"" data-topic=""B"" data-id=""meth1""><a href='../../roxygen2/html/B.html#method-B-meth1'><code>roxygen2::B$meth1()</code></a></li>
+<li><span class=""pkg-link"" data-pkg=""roxygen2"" data-topic=""B"" data-id=""meth4""><a href='../../roxygen2/html/B.html#method-B-meth4'><code>roxygen2::B$meth4()</code></a></li>
+</ul>
+</details>
+}}
 \if{html}{\out{<hr>}}
-\if{html}{\out{<a id=""method-meth2""></a>}}
-\if{latex}{\out{\hypertarget{method-meth2}{}}}
+\if{html}{\out{<a id=""method-C-meth2""></a>}}
+\if{latex}{\out{\hypertarget{method-C-meth2}{}}}
 \subsection{Method \code{meth2()}}{
 C method 2.
 \subsection{Usage}{
@@ -80,8 +80,8 @@ C method 2.
 }
 }
 \if{html}{\out{<hr>}}
-\if{html}{\out{<a id=""method-meth5""></a>}}
-\if{latex}{\out{\hypertarget{method-meth5}{}}}
+\if{html}{\out{<a id=""method-C-meth5""></a>}}
+\if{latex}{\out{\hypertarget{method-C-meth5}{}}}
 \subsection{Method \code{meth5()}}{
 C method 5.
 \subsection{Usage}{
@@ -90,8 +90,8 @@ C method 5.
 
 }
 \if{html}{\out{<hr>}}
-\if{html}{\out{<a id=""method-undocumented_method""></a>}}
-\if{latex}{\out{\hypertarget{method-undocumented_method}{}}}
+\if{html}{\out{<a id=""method-C-undocumented_method""></a>}}
+\if{latex}{\out{\hypertarget{method-C-undocumented_method}{}}}
 \subsection{Method \code{undocumented_method()}}{
 \subsection{Usage}{
 \if{html}{\out{<div class=""r"">}}\preformatted{C$undocumented_method()}\if{html}{\out{</div>}}

---FILE: tests/testthat/test-markdown.R---
@@ -19,60 +19,46 @@ test_that(""code blocks work"", {
   out1 <- roc_proc_text(rd_roclet(), ""
     #' Title
     #'
-    #' Description
-    #'
-    #' Details with a code block:
+    #' @description
+    #' Before
     #' ```
-    #' x <- 1:10 %>%
-    #'   multiply_by(10) %>%
-    #'   add(42)
+    #' x %in% 1:10
     #' ```
-    #' Normal text again.
+    #' After
     #' @md
     foo <- function() {}"")[[1]]
+  expect_snapshot_output(cat(out1$get_value(""description"")))
+
+  # And check that extra empty paragraphs don't affect the output
   out2 <- roc_proc_text(rd_roclet(), ""
     #' Title
     #'
-    #' Description
+    #' @description
+    #' Before
     #'
-    #' Details with a code block:\\preformatted{x <- 1:10 \\%>\\%
-    #'   multiply_by(10) \\%>\\%
-    #'   add(42)
-    #' }
+    #' ```
+    #' x %in% 1:10
+    #' ```
     #'
-    #' Normal text again.
+    #' After
+    #' @md
     foo <- function() {}"")[[1]]
-  expect_equivalent_rd(out1, out2)
+  expect_equal(out1$get_value(""description""), out2$get_value(""description""))
 })
 
 test_that(""code block with language creates HTML tag"", {
   out1 <- roc_proc_text(rd_roclet(), ""
     #' Title
     #'
-    #' Description
-    #'
-    #' Details with a code block:
+    #' @description
+    #' Before
     #' ```r
-    #' x <- 1:10 %>%
-    #'   multiply_by(10) %>%
-    #'   add(42)
+    #' x %in% 1:10
     #' ```
-    #' Normal text again.
+    #' After
     #' @md
     foo <- function() {}"")[[1]]
-  out2 <- roc_proc_text(rd_roclet(), ""
-    #' Title
-    #'
-    #' Description
-    #'
-    #' Details with a code block:\\if{html}{\\out{<div class=\""sourceCode r\"">}}\\preformatted{x <- 1:10 \\%>\\%
-    #'   multiply_by(10) \\%>\\%
-    #'   add(42)
-    #' }\\if{html}{\\out{</div>}}
-    #'
-    #' Normal text again.
-    foo <- function() {}"")[[1]]
-  expect_equivalent_rd(out1, out2)
+  expect_snapshot_output(cat(out1$get_value(""description"")))
 })
 
 test_that(""inline code escapes %"", {"
r-lib,roxygen2,4473f2a13799e30848c0b7d12219e1688e07db6d,Hadley Wickham,h.wickham@gmail.com,2022-04-08T16:03:06Z,Hadley Wickham,h.wickham@gmail.com,2022-04-08T16:03:06Z,Fix R CMD check NOTE,vignettes/namespace.Rmd,True,False,True,False,1,1,2,"---FILE: vignettes/namespace.Rmd---
@@ -89,7 +89,7 @@ The `NAMESPACE` also controls which functions from other packages are made avail
 
 If you are using just a few functions from another package, the recommended option is to add the package name to the `Imports:` field of the `DESCRIPTION` file and call the functions explicitly using `::`, e.g., `pkg::fun()`.
 
-```{r}
+```{r, eval = FALSE}
 my_function <- function(x, y) {
   pkg::fun(x) * y
 }"
r-lib,roxygen2,ab36f5a3cf3d06e07ba00635f30521a9e56e41e9,Hadley Wickham,h.wickham@gmail.com,2022-04-08T15:56:55Z,Hadley Wickham,h.wickham@gmail.com,2022-04-08T15:56:55Z,"Improve tag_words_line() warning

Fixes #1074",NEWS.md;R/tag-parser.R;tests/testthat/_snaps/tag-parser.md;tests/testthat/test-tag-parser.R,False,True,True,False,22,4,26,"---FILE: NEWS.md---
@@ -2,6 +2,8 @@
 
 * All warning messages have been reviewed to hopefully be more informative
   and actionable (#1317). `@title` now checks for multiple paragraphs.
+  `@export` gives a more informative warning if it contains too many lines. 
+  (#1074).
 
 * DOIs, arXiv links, and urls in the `Description` field of the `DESCRIPTION`
   are now converted to the appropriate Rd markup (@dieghernan, #1265, #1164).

---FILE: R/tag-parser.R---
@@ -152,10 +152,14 @@ tag_words_line <- function(x) {
   x$val <- str_trim(x$raw)
 
   n_lines <- str_count(x$val, ""\n"")
-    if (n_lines > 1) {
-    warn_roxy_tag(x, ""must only span a single line, not {n_lines}"")
+  if (n_lines >= 1) {
+    first_line <- str_split(x$val, ""\n"")[[1]][[1]]
+    warn_roxy_tag(x, c(
+      ""must be a single line, not {n_lines + 1}"",
+      i = ""The first line is {.str {first_line}}""
+    ))
     NULL
-  } else if (!rdComplete(x$val, is_code = FALSE)) {
+  } else if (!rdComplete(x$raw, is_code = FALSE)) {
     warn_roxy_tag(x, ""has mismatched braces or quotes"")
     NULL
   } else {

---FILE: tests/testthat/_snaps/tag-parser.md---
@@ -190,13 +190,22 @@
 
 # tag_words_line() gives useful warnings
 
+    Code
+      tag <- roxy_test_tag(""a\nb"")
+      expect_parse_failure(tag_words_line(tag))
+    Output
+      <warning/rlang_warning>
+      Warning:
+      [test.R:1] @test must be a single line, not 2
+      i The first line is ""a""
     Code
       tag <- roxy_test_tag(""a\nb\n2"")
       expect_parse_failure(tag_words_line(tag))
     Output
       <warning/rlang_warning>
       Warning:
-      [test.R:1] @test must only span a single line, not 2
+      [test.R:1] @test must be a single line, not 3
+      i The first line is ""a""
 
 # tag_toggle() gives useful warnings
 

---FILE: tests/testthat/test-tag-parser.R---
@@ -74,6 +74,9 @@ test_that(""tag_words() gives useful warnings"", {
 
 test_that(""tag_words_line() gives useful warnings"", {
   expect_snapshot({
+    tag <- roxy_test_tag(""a\nb"")
+    expect_parse_failure(tag_words_line(tag))
+
     tag <- roxy_test_tag(""a\nb\n2"")
     expect_parse_failure(tag_words_line(tag))
   })"
r-lib,roxygen2,b5ec35e31ee9317ca69e928a3ce15554e620893c,Hadley Wickham,h.wickham@gmail.com,2022-04-06T17:05:26Z,GitHub,noreply@github.com,2022-04-06T17:05:26Z,"Add if to TWOTAGs (#1320)

Fixes #1097.",R/utils-rd.R;tests/testthat/test-rd-inherit.R,False,True,True,False,3,5,8,"---FILE: R/utils-rd.R---
@@ -93,7 +93,7 @@ make_as_character_rd <- function() {
     return(fn)
   }
 
-  body[[idx]][[3]] <- call_modify(body[[idx]][[3]], ""\\href"", ""\\ifelse"")
+  body[[idx]][[3]] <- call_modify(body[[idx]][[3]], ""\\href"", ""\\ifelse"", ""\\if"")
   body(fn) <- body
   fn
 }

---FILE: tests/testthat/test-rd-inherit.R---
@@ -26,12 +26,10 @@ test_that(""\\links are transformed"", {
   expect_snapshot_output(out$get_section(""param""))
 })
 
-test_that(""href doesn't get extra parens"", {
+test_that(""markdown doesn't get get extra parens"", {
   expect_equal(rd2text(parse_rd(""\\href{a}{b}"")), ""\\href{a}{b}\n"")
-})
-
-test_that(""ifelse doesn't get extra parens"", {
   expect_equal(rd2text(parse_rd(""\\ifelse{a}{b}{c}"")), ""\\ifelse{a}{b}{c}\n"")
+  expect_equal(rd2text(parse_rd(""\\if{a}{b}"")), ""\\if{a}{b}\n"")
 })
 
 test_that(""relative links converted to absolute"", {"
r-lib,roxygen2,0ecdcdeb7b515ce27e0a3dbc2905e5d72a058d3c,Diego H,diego.hernangomezherrero@gmail.com,2022-04-06T11:28:35Z,GitHub,noreply@github.com,2022-04-06T11:28:35Z,"Improving package description auto-linking (#1315)

Fixes #1265. Fixes #1164.",NEWS.md;R/object-defaults.R;R/object-package.R;tests/testthat/test-object-package.R,False,True,True,False,77,0,77,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* DOIs, arXiv links, and urls in the `Description` field of the `DESCRIPTION`
+  are now converted to the appropriate Rd markup (@dieghernan, #1265, #1164).
+
 * Arguments containing syntactically significant whitespace (e.g anonymous
   functions) are now wrapped correctly (#1281).
 

---FILE: R/object-defaults.R---
@@ -41,6 +41,7 @@ object_defaults.package <- function(x) {
   desc <- x$value$desc
 
   description <- as.character(desc$Description)
+  description <- package_url_parse(description)
   logo_path <- file.path(x$value$path, ""man"", ""figures"", ""logo.png"")
   if (file.exists(logo_path)) {
     fig <- ""\\if{html}{\\figure{logo.png}{options: align='right' alt='logo' width='120'}}""

---FILE: R/object-package.R---
@@ -374,3 +374,32 @@ itemize <- function(header, x) {
     ""}\n""
   )
 }
+
+package_url_parse <- function(x) {
+  # <doi:XX.XXX> -> \doi{XX.XXX} to avoid CRAN Notes, etc.
+  x <- str_replace_all(x, ""<(doi|DOI):(.*?)>"", function(match) {
+    match <- str_remove_all(match, ""^<(doi|DOI):|>$"")
+    paste0(""\\doi{"", escape(match), ""}"")
+  })
+
+  # <http:XX.XXX> -> \url{http:XX.XXX}
+  x <- str_replace_all(x, ""<(http|https):\\/\\/(.*?)>"", function(match) {
+    match <- str_remove_all(match, ""^<|>$"")
+    paste0(""\\url{"", escape(match), ""}"")
+  })
+
+  # <arxiv:XXX> -> \href{https://arxiv.org/abs/XXX}{arXiv:XXX}
+  # https://github.com/wch/r-source/blob/trunk/src/library/tools/R/Rd2pdf.R#L149-L151
+  patt_arxiv <- ""<(arXiv:|arxiv:)([[:alnum:]/.-]+)([[:space:]]*\\[[^]]+\\])?>""
+  x <- str_replace_all(x, patt_arxiv, function(match) {
+    match <- str_remove_all(match, ""^<(arXiv:|arxiv:)|>$"")
+    # Special cases has <arxiv:id [code]>.
+    # See https://CRAN.R-project.org/package=ciccr
+    # Extract arxiv id, split by space
+    arxiv_id <- str_split_fixed(match, "" "", n = 2)[, 1]
+
+    paste0(""\\href{https://arxiv.org/abs/"", escape(arxiv_id), ""}{arXiv:"", match, ""}"")
+  })
+
+  x
+}

---FILE: tests/testthat/test-object-package.R---
@@ -25,3 +25,47 @@ test_that(""can convert DOIs in url"", {
     ""\\doi{10.5281/zenodo.1485309}""
   )
 })
+
+test_that(""can autolink urls on package Description"", {
+  expect_equal(
+    package_url_parse(""x <https://x.com> y""),
+    ""x \\url{https://x.com} y""
+  )
+  expect_equal(
+    package_url_parse(""x <https://x.com/%3C-%3E> y""),
+    ""x \\url{https://x.com/\\%3C-\\%3E} y""
+  )
+})
+
+test_that(""can autolink DOIs"", {
+  expect_equal(package_url_parse(""x <doi:abcdef> y""), ""x \\doi{abcdef} y"")
+  expect_equal(package_url_parse(""x <DOI:abcdef> y""), ""x \\doi{abcdef} y"")
+  expect_equal(package_url_parse(""x <DOI:%3C-%3E> y""), ""x \\doi{\\%3C-\\%3E} y"")
+})
+
+test_that(""can autolink arxiv"", {
+  expect_equal(
+    package_url_parse(""x <arXiv:abc> y""),
+    ""x \\href{https://arxiv.org/abs/abc}{arXiv:abc} y""
+  )
+  expect_equal(
+    package_url_parse(""x <arxiv:abc> y""),
+    ""x \\href{https://arxiv.org/abs/abc}{arXiv:abc} y""
+  )
+  expect_equal(
+    package_url_parse(""x <arxiv:abc [def]> y""),
+    ""x \\href{https://arxiv.org/abs/abc}{arXiv:abc [def]} y""
+  )
+})
+
+test_that(""autolink several matching patterns"", {
+  text <- ""url <http://a.com> doi <doi:xx> arxiv <arXiv:xx>""
+  expect_equal(
+    package_url_parse(text),
+    paste(
+      ""url \\url{http://a.com}"",
+      ""doi \\doi{xx}"",
+      ""arxiv \\href{https://arxiv.org/abs/xx}{arXiv:xx}""
+    )
+  )
+})"
r-lib,roxygen2,950bd02f4c91226057ee621c47fcdd0f82b7ca7e,Hadley Wickham,h.wickham@gmail.com,2022-04-06T11:25:28Z,GitHub,noreply@github.com,2022-04-06T11:25:28Z,"Improve wrapping (#1318)

* Teach splitByWhitespace() about backticks. Fixes #1257
* Correctly wrap arguments with newlines. Fixes #1281.",NEWS.md;R/rd-usage.R;src/wrapUsage.cpp;tests/testthat/_snaps/rd-usage.md;tests/testthat/test-rd-usage.R,False,True,True,False,38,2,40,"---FILE: NEWS.md---
@@ -1,5 +1,11 @@
 # roxygen2 (development version)
 
+* Arguments containing syntactically significant whitespace (e.g anonymous
+  functions) are now wrapped correctly (#1281).
+
+* Arguments containing non-syntactic values surrounded by back ticks are now 
+  wrapped correctly (#1257).
+  
 * DOIs in the `URL` field of the `DESCRIPTION` are now converted to Rd's special
   `\doi{}` tag (@ThierryO, #1296).
 

---FILE: R/rd-usage.R---
@@ -131,7 +131,7 @@ wrap_usage <- function(name, format_name, formals, suffix = NULL, width = 80L) {
 
   # Do we need any wrapping?
   bare <- args_call(name, args)
-  if (nchar(bare, type = ""width"") < width) {
+  if (!str_detect(bare, ""\n"") && nchar(bare, type = ""width"") < width) {
     out <- args_call(format_name(name), args)
   } else if (roxy_meta_get(""old_usage"", FALSE)) {
     x <- args_call(format_name(name), args)

---FILE: src/wrapUsage.cpp---
@@ -25,9 +25,10 @@ std::vector<std::string> splitByWhitespace(std::string string) {
       }
 
     } else if (*cur == ' ' || *cur == '\t' || *cur == '\n') {
+      if (*cur == '\n') acc += *cur; // newlines are significant whitespace
       out.push_back(acc);
       acc = """";
-    } else if (*cur == '""' || *cur == '\'') {
+    } else if (*cur == '""' || *cur == '\'' || *cur == '`') {
       in_string = *cur;
       acc += *cur;
     } else {

---FILE: tests/testthat/_snaps/rd-usage.md---
@@ -23,6 +23,21 @@
       c = ""aaaaaaaaaaaaaaaa""
     ) <- value 
     
+    function_name(
+      x,
+      y,
+      xy = ""abcdef"",
+      xyz = c(`word word word word` = ""abcdef"", `word word word` = ""abcdef"",
+        `word word word` = ""abcdef"", `word word word` = ""abcdef"")
+    ) 
+    
+    function_name(
+      f = function(x) {
+         1
+         2
+     }
+    ) 
+    
 
 # old wrapping style doesn't change unexpectedly
 

---FILE: tests/testthat/test-rd-usage.R---
@@ -291,6 +291,20 @@ test_that(""new wrapping style doesn't change unexpectedly"", {
           c = 'aaaaaaaaaaaaaaaa',
           value) {}
     }), ""\n\n"")
+
+    cat(call_to_usage({
+      function_name <- function(x, y, xy = ""abcdef"",
+       xyz = c(`word word word word` = ""abcdef"", `word word word` = ""abcdef"",
+               `word word word` = ""abcdef"", `word word word` = ""abcdef"")) {}
+    }), ""\n\n"")
+
+    cat(call_to_usage({
+      function_name <- function(
+        f = function(x) {
+          1
+          2
+      }) {}
+    }), ""\n\n"")
   })
 })
 "
r-lib,roxygen2,ee7d58dd57b97cdf52137abc283fe631a8193445,Thierry Onkelinx,ThierryO@users.noreply.github.com,2022-04-04T15:08:18Z,GitHub,noreply@github.com,2022-04-04T15:08:18Z,"Replace \url{} with \doi{} in package Rd when linking to DOI (#1297)

Fixes #1296",NEWS.md;R/object-package.R;tests/testthat/test-object-package.R,False,True,True,False,17,1,18,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* DOIs in the `URL` field of the `DESCRIPTION` are now converted to Rd's special
+  `\doi{}` tag (@ThierryO, #1296).
+
 * Curly braces in markdown links are now escaped (#1259).
 
 * `@inherit` and friends perform less aggressive link tweaking, eliminating

---FILE: R/object-package.R---
@@ -1,16 +1,21 @@
 package_seealso <- function(desc) {
+  itemize(""Useful links:"", package_seealso_urls(desc))
+}
+package_seealso_urls <- function(desc) {
   if (!is.null(desc$URL)) {
     links <- paste0(""\\url{"", strsplit(desc$URL, "",\\s+"")[[1]], ""}"")
+    links <- gsub(""\\url\\{https://doi.org/"", ""\\doi{"", links)
   } else {
     links <- character()
   }
   if (!is.null(desc$BugReports)) {
     links <- c(links, paste0(""Report bugs at \\url{"", desc$BugReports, ""}""))
   }
 
-  itemize(""Useful links:"", links)
+  links
 }
 
+
 package_authors <- function(desc) {
   authors <- tryCatch(eval(parse(text = desc$`Authors@R` %||% """")),
     error = function(e) {

---FILE: tests/testthat/test-object-package.R---
@@ -17,3 +17,11 @@ test_that(""person turned into meaningful text"", {
     person_desc(comment = c(""ORCID"" = ""1234"", ""extra""))
   })
 })
+
+
+test_that(""can convert DOIs in url"", {
+  expect_equal(
+    package_seealso_urls(list(URL = ""https://doi.org/10.5281/zenodo.1485309"")),
+    ""\\doi{10.5281/zenodo.1485309}""
+  )
+})"
r-lib,roxygen2,a801865315d414ba737a12eb7339eb433b916cd1,Hadley Wickham,h.wickham@gmail.com,2022-04-01T19:54:41Z,GitHub,noreply@github.com,2022-04-01T19:54:41Z,"Preserve NAMESPACE during pre-processing pass (#1313)

Now preserves all non-import directives.

Fixes #1254",DESCRIPTION;NEWS.md;R/namespace.R;tests/testthat/test-namespace.R,False,True,True,False,40,2,42,"---FILE: DESCRIPTION---
@@ -41,7 +41,8 @@ Suggests:
     R.methodsS3,
     R.oo,
     rmarkdown,
-    testthat (>= 3.1.2)
+    testthat (>= 3.1.2),
+    withr
 LinkingTo: 
     cpp11
 VignetteBuilder: 

---FILE: NEWS.md---
@@ -1,5 +1,9 @@
 # roxygen2 (development version)
 
+* The NAMESPACE roclet now preserves all existing non-import directives during
+  it's first pre-processing pass. This eliminates the ""NAMESPACE has changed""
+  messages and reduces the incidence of namespace borking (#1254).
+
 * `@inheritParams` now only inherits exact multiparameter matches, so if you're
   inheriting from a function with `@param x,y` you'll only get the parameter
   documentation if your function needs docs for both x and y (#950).

---FILE: R/namespace.R---
@@ -39,7 +39,8 @@ roclet_preprocess.roclet_namespace <- function(x, blocks, base_path) {
     return(x)
   }
 
-  results <- c(made_by(""#""), lines)
+  lines <- c(lines, namespace_exports(NAMESPACE))
+  results <- c(made_by(""#""), sort_c(unique(lines)))
   write_if_different(NAMESPACE, results, check = TRUE)
 
   invisible(x)
@@ -290,3 +291,14 @@ one_per_line <- function(name, x) {
 repeat_first <- function(name, x) {
   paste0(name, ""("", auto_quote(x[1]), "","", auto_quote(x[-1]), "")"")
 }
+
+namespace_exports <- function(path) {
+  if (!file.exists(path)) {
+    return(character())
+  }
+
+  parsed <- parse(path, keep.source = TRUE)
+  is_import <- function(x) is_call(x, c(""import"", ""importFrom"", ""importClassesFrom"", ""importMethodsFrom"", ""useDynLib""))
+  export_lines <- attr(parsed, ""srcref"")[!map_lgl(parsed, is_import)]
+  unlist(lapply(export_lines, as.character))
+}

---FILE: tests/testthat/test-namespace.R---
@@ -332,3 +332,24 @@ test_that(""auto_quote behaves as needed"", {
   expect_equal(auto_quote(""if""), '""if""') # quotes non-syntactic
   expect_equal(auto_quote(""'if'""), ""'if'"") # unless already quoted
 })
+
+test_that(""can extract non-imports from namespace preserving source"", {
+  path <- withr::local_tempfile(lines = c(
+    ""export(x)"",
+    ""import(y)""
+  ))
+  expect_equal(namespace_exports(path), ""export(x)"")
+
+  path <- withr::local_tempfile(lines = ""export(x, y, z)"")
+  expect_equal(namespace_exports(path), ""export(x, y, z)"")
+
+  lines <- c(
+    ""if (TRUE) {"",
+    ""  import(x, y, z)"",
+    ""}"",
+    ""import(a)"",
+    ""export(b)""
+  )
+  path <- withr::local_tempfile(lines = lines)
+  expect_equal(namespace_exports(path), lines[c(1:3, 5)])
+})"
r-lib,roxygen2,0c16c8fbecc40c84715fc3c8c35d3bfc743d3a0f,Hadley Wickham,h.wickham@gmail.com,2022-04-01T19:54:03Z,GitHub,noreply@github.com,2022-04-01T19:54:03Z,"Inherit group params exactly (#1316)

Fixes #950",NEWS.md;R/rd-inherit.R;tests/testthat/test-rd-inherit.R,False,True,True,False,71,64,135,"---FILE: NEWS.md---
@@ -1,5 +1,9 @@
 # roxygen2 (development version)
 
+* `@inheritParams` now only inherits exact multiparameter matches, so if you're
+  inheriting from a function with `@param x,y` you'll only get the parameter
+  documentation if your function needs docs for both x and y (#950).
+
 * All tags warn now if you only provide whitespace (#1228).
 
 * Add support for inheriting 'note' fields via `@inherit pkg::fun note` (@pat-s, #1218)

---FILE: R/rd-inherit.R---
@@ -141,26 +141,28 @@ inherit_params <- function(topic, topics) {
   }
 
   for (inheritor in inheritors) {
-    inherited <- find_params(inheritor, topics)
-
-    matches <- map_chr(missing, match_param, names(inherited))
-    new_match <- !is.na(matches)
-
-    if (!any(new_match)) {
-      # Can't warn here because @inherit inherits parameters
-      next
+    inherited_params <- find_params(inheritor, topics)
+
+    for (param in inherited_params) {
+      match <- match_param(param$name, missing)
+      if (all(!is.na(match))) {
+        param_val <- setNames(param$value, paste(match, collapse = "",""))
+        topic$add(rd_section(""param"", param_val))
+        missing <- setdiff(missing, match)
+      }
     }
-
-    topic$add(
-      rd_section(
-        ""param"",
-        setNames(inherited[matches[new_match]], missing[new_match])
-      )
-    )
-    missing <- missing[!new_match]
   }
 }
 
+# Ignore . prefix since it's sometimes necessary to add because a
+# function uses ...
+match_param <- function(needle, haystack) {
+  needle_std <- gsub(""^\\."", """", needle)
+  haystack_std <- gsub(""^\\."", """", haystack)
+
+  haystack[match(needle_std, haystack_std)]
+}
+
 inherit_dot_params <- function(topic, topics, env) {
   inheritors <- topic$get_value(""inherit_dot_params"")
   if (is.null(inheritors))
@@ -173,9 +175,12 @@ inherit_dot_params <- function(topic, topics, env) {
   # Then pull out the ones we need
   docs <- lapply(inheritors$source, find_params, topics = topics)
   arg_matches <- function(args, docs) {
-    doc_args <- str_split(names(docs), "", ?"")
-    match <- map_lgl(doc_args, function(x) x %in% args)
-    docs[match]
+    match <- map_lgl(docs, function(x) x$name %in% args)
+    matched <- docs[match]
+    setNames(
+      lapply(matched, ""[["", ""value""),
+      map_chr(matched, function(x) paste(x$name, collapse = "",""))
+    )
   }
   docs_selected <- unlist(map2(args, docs, arg_matches))
 
@@ -232,11 +237,10 @@ find_params <- function(name, topics) {
   param_names <- str_trim(names(params))
   param_names[param_names == ""\\dots""] <- ""...""
 
-  # Split up compound names on , (swallowing spaces) duplicating their contents
-  individual_names <- strsplit(param_names, "",\\s*"")
-  reps <- map_int(individual_names, length)
-
-  setNames(rep.int(params, reps), unlist(individual_names))
+  Map(list,
+    name = strsplit(param_names, "",\\s*""),
+    value = unlist(params)
+  )
 }
 
 topic_params <- function(x) UseMethod(""topic_params"")
@@ -392,26 +396,3 @@ get_rd_from_help <- function(package, alias) {
 
   internal_f(""utils"", "".getHelpFile"")(help)
 }
-
-
-# helpers -----------------------------------------------------------------
-
-# Returns matching parameter name in haystack
-match_param <- function(needle, haystack) {
-  if (needle %in% haystack) {
-    return(needle)
-  }
-
-  if (substr(needle, 1, 1) == ""."") {
-    if (needle %in% paste0(""."", haystack)) {
-      return(substr(needle, 2, nchar(needle)))
-    }
-  } else {
-    if (paste0(""."", needle) %in% haystack) {
-      return(paste0(""."", needle))
-    }
-  }
-
-  NA
-}
-

---FILE: tests/testthat/test-rd-inherit.R---
@@ -325,17 +325,48 @@ test_that(""multiple @inheritParam inherits from existing topics"", {
 })
 
 
-test_that(""@inheritParam can cope with multivariable argument definitions"", {
+test_that(""@inheritParam can inherit multivariable arguments"", {
   out <- roc_proc_text(rd_roclet(), ""
-                       #' My merge
-                       #'
-                       #' @inheritParams base::merge
-                       mymerge <- function(x, y) {}"")[[1]]
-  params <- out$get_value(""param"")
-  expect_equal(length(params), 2)
-  expect_equal(sort(names(params)), c(""x"", ""y""))
+    #' A
+    #' @param x,y X and Y
+    A <- function(x, y) {}
+
+    #' B
+    #'
+    #' @inheritParams A
+    B <- function(x, y) {}""
+  )[[2]]
+  expect_equal(out$get_value(""param""), c(""x,y"" = ""X and Y""))
+
+  # Even when the names only match without .
+  out <- roc_proc_text(rd_roclet(), ""
+    #' A
+    #' @param x,y X and Y
+    A <- function(x, y) {}
+
+    #' B
+    #'
+    #' @inheritParams A
+    B <- function(.x, .y) {}""
+  )[[2]]
+  expect_equal(out$get_value(""param""), c("".x,.y"" = ""X and Y""))
+})
+
+test_that(""@inheritParam only inherits exact multiparam matches"", {
+  out <- roc_proc_text(rd_roclet(), ""
+    #' A
+    #' @param x,y X and Y
+    A <- function(x, y) {}
+
+    #' B
+    #'
+    #' @inheritParams A
+    B <- function(x) {}""
+  )[[2]]
+  expect_equal(out$get_value(""param""), NULL)
 })
 
+
 test_that(""@inheritParam understands compound docs"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' Title
@@ -607,12 +638,3 @@ test_that(""can find section in existing docs"", {
   out <- find_sections(get_rd(""base::attach""))
   expect_equal(out$title, ""Good practice"")
 })
-
-# find_params -------------------------------------------------------------
-
-test_that(""find_params parses input"", {
-  params <- find_params(""utils::`?`"", NULL)
-  expect_equal(names(params), c(""topic"", ""type""))
-})
-
-"
r-lib,roxygen2,f473436c21d2f3b7841a1728523d2db3ac64d39d,Hadley Wickham,h.wickham@gmail.com,2022-03-31T20:22:09Z,GitHub,noreply@github.com,2022-03-31T20:22:09Z,"Check if trimmed tag value is empty (#1310)

Fixes #1228",NEWS.md;R/tag-parser.R;tests/testthat/test-tag-parser.R,False,True,True,False,30,6,36,"---FILE: NEWS.md---
@@ -1,5 +1,7 @@
 # roxygen2 (development version)
 
+* All tags warn now if you only provide whitespace (#1228).
+
 * Add support for inheriting 'note' fields via `@inherit pkg::fun note` (@pat-s, #1218)
 
 * Problems with the first tag in each block are now reported with the

---FILE: R/tag-parser.R---
@@ -17,7 +17,7 @@ NULL
 #' @export
 #' @rdname tag_parsers
 tag_value <- function(x) {
-  if (x$raw == """") {
+  if (str_trim(x$raw) == """") {
     roxy_tag_warning(x, ""requires a value"")
   } else if (!rdComplete(x$raw, is_code = FALSE)) {
     roxy_tag_warning(x, ""mismatched braces or quotes"")
@@ -30,7 +30,7 @@ tag_value <- function(x) {
 #' @export
 #' @rdname tag_parsers
 tag_inherit <- function(x) {
-  if (x$raw == """") {
+  if (str_trim(x$raw) == """") {
     roxy_tag_warning(x, ""requires a value"")
   } else if (!rdComplete(x$raw, is_code = FALSE)) {
     roxy_tag_warning(x, ""mismatched braces or quotes"")
@@ -64,7 +64,7 @@ tag_inherit <- function(x) {
 #' @export
 #' @rdname tag_parsers
 tag_name <- function(x) {
-  if (x$raw == """") {
+  if (str_trim(x$raw) == """") {
     roxy_tag_warning(x, ""requires a name"")
   } else if (!rdComplete(x$raw, is_code = FALSE)) {
     roxy_tag_warning(x, ""mismatched braces or quotes"")
@@ -161,7 +161,7 @@ tag_toggle <- function(x) {
 #' @export
 #' @rdname tag_parsers
 tag_code <- function(x) {
-  if (x$raw == """") {
+  if (str_trim(x$raw) == """") {
     roxy_tag_warning(x, ""requires a value"")
   } else {
     tryCatch({
@@ -178,7 +178,7 @@ tag_code <- function(x) {
 #' @export
 #' @rdname tag_parsers
 tag_examples <- function(x) {
-  if (x$raw == """") {
+  if (str_trim(x$raw) == """") {
     return(roxy_tag_warning(x, ""requires a value""))
   }
 
@@ -193,14 +193,18 @@ tag_examples <- function(x) {
 #' @export
 #' @rdname tag_parsers
 tag_markdown <- function(x) {
+  if (str_trim(x$raw) == """") {
+    return(roxy_tag_warning(x, ""requires a value""))
+  }
+
   x$val <- markdown_if_active(x$raw, x)
   x
 }
 
 #' @export
 #' @rdname tag_parsers
 tag_markdown_with_sections <- function(x) {
-  if (x$raw == """") {
+  if (str_trim(x$raw) == """") {
     return(roxy_tag_warning(x, ""requires a value""))
   }
 

---FILE: tests/testthat/test-tag-parser.R---
@@ -0,0 +1,18 @@
+test_that(""tags containing only whitespace generate warning"", {
+  tag <- roxy_tag(""foo"", "" "")
+
+  expect_parse_failure <- function(code)  {
+    expect_warning(out <- code, ""requires"")
+    expect_null(out)
+  }
+
+  expect_parse_failure(tag_value(tag))
+  expect_parse_failure(tag_inherit(tag))
+  expect_parse_failure(tag_name(tag))
+  expect_parse_failure(tag_two_part(tag))
+  expect_parse_failure(tag_name_description(tag))
+  expect_parse_failure(tag_code(tag))
+  expect_parse_failure(tag_examples(tag))
+  expect_parse_failure(tag_markdown(tag))
+  expect_parse_failure(tag_markdown_with_sections(tag))
+})"
r-lib,roxygen2,623c473ae3134bab75bd53b01b07b9345795507b,Patrick Schratz,patrick.schratz@gmail.com,2022-03-30T15:20:22Z,GitHub,noreply@github.com,2022-03-30T15:20:22Z,"Add support for inheriting 'note' fields (#1219)

Fixes #1218",NEWS.md;R/rd-inherit.R;R/tag-parser.R;tests/testthat/test-rd-inherit.R,False,True,True,False,7,2,9,"---FILE: NEWS.md---
@@ -1,5 +1,7 @@
 # roxygen2 (development version)
 
+* Add support for inheriting 'note' fields via `@inherit pkg::fun note` (@pat-s, #1218)
+
 * Problems with the first tag in each block are now reported with the
   correct line number (#1235).
 

---FILE: R/rd-inherit.R---
@@ -108,6 +108,7 @@ topics_process_inherit <- function(topics, env) {
   topics$topo_apply(inherits(""examples""), inherit_field, ""examples"")
   topics$topo_apply(inherits(""author""), inherit_field, ""author"")
   topics$topo_apply(inherits(""source""), inherit_field, ""source"")
+  topics$topo_apply(inherits(""note""), inherit_field, ""note"")
 
   # First inherit individual sections, then all sections.
   topics$topo_apply(function(x) x$inherits_section_from(), inherit_section)

---FILE: R/tag-parser.R---
@@ -40,7 +40,7 @@ tag_inherit <- function(x) {
 
     # Also recorded in `rd.Rmd`
     all <- c(""params"", ""return"", ""title"", ""description"", ""details"", ""seealso"",
-      ""sections"", ""references"", ""examples"", ""author"", ""source"")
+      ""sections"", ""references"", ""examples"", ""author"", ""source"", ""note"")
     if (length(fields) == 0) {
       fields <- all
     } else {

---FILE: tests/testthat/test-rd-inherit.R---
@@ -48,7 +48,7 @@ test_that(""no options gives default values"", {
     block_get_tag_value(block, ""inherit"")$fields,
     c(
       ""params"", ""return"", ""title"", ""description"", ""details"", ""seealso"",
-      ""sections"", ""references"", ""examples"", ""author"", ""source""
+      ""sections"", ""references"", ""examples"", ""author"", ""source"", ""note""
     )
   )
 })
@@ -575,6 +575,7 @@ test_that(""can inherit all from single function"", {
     #' @param y y
     #' @author Hadley
     #' @source my mind
+    #' @note my note
     #' @examples
     #' x <- 1
     foo <- function(x, y) {}
@@ -590,6 +591,7 @@ test_that(""can inherit all from single function"", {
   expect_equal(out$get_value(""examples""), rd(""x <- 1""))
   expect_equal(out$get_value(""author""), ""Hadley"")
   expect_equal(out$get_value(""source""), ""my mind"")
+  expect_equal(out$get_value(""note""), ""my note"")
 })
 
 "
r-lib,roxygen2,03e6913d3ff72472314eb25ae864cb5ab2d5291b,Salim B,salim@posteo.de,2022-03-30T14:47:38Z,GitHub,noreply@github.com,2022-03-30T14:47:38Z,Fix vignette section and improve capitalisation of nouns (#1232),vignettes/extending.Rmd;vignettes/rd-formatting.Rmd;vignettes/rd.Rmd;vignettes/roxygen2.Rmd,True,False,True,False,32,32,64,"---FILE: vignettes/extending.Rmd---
@@ -118,7 +118,7 @@ And generate Rd like this:
 The first step is to define a method for `roxy_tag_parse()` that describes how to parse the tag text.
 The name of the class will be `roxy_tag_{tag}`, which in this case is `roxy_tag_tip`.
 This function takes a `roxy_tag` as input, and it's job is to set `x$val` to a convenient parsed value that will be used later by the roclet.
-Here we want to process the text using markdown so we can just use `tag_markdown()`:
+Here we want to process the text using Markdown so we can just use `tag_markdown()`:
 
 ```{r}
 roxy_tag_parse.roxy_tag_tip <- function(x) {
@@ -149,7 +149,7 @@ block
 str(block$tags[[2]])
 ```
 
-(Here I explicitly turn markdown parsing on using `@md`; it's usually turned on for a package using roxygen options).
+(Here I explicitly turn Markdown parsing on using `@md`; it's usually turned on for a package using roxygen options).
 
 Next, we define a method for `roxy_tag_rd()`, which must create an `rd_section()`.
 We're going to create a new section called `tip`.

---FILE: vignettes/rd-formatting.Rmd---
@@ -13,25 +13,25 @@ knitr::opts_chunk$set(comment = ""#>"", collapse = TRUE)
 
 # Introduction
 
-Starting from version 6.0.0, roxygen supports markdown markup within most roxygen tags. Roxygen uses the [commonmark package](https://github.com/r-lib/commonmark), which is based on the CommonMark Reference Implementation to parse these tags. See <https://commonmark.org/help/> for more about the parser and the markdown language it supports. 
+Starting from version 6.0.0, roxygen supports Markdown markup within most roxygen tags. Roxygen uses the [commonmark package](https://github.com/r-lib/commonmark), which is based on the CommonMark Reference Implementation to parse these tags. See <https://commonmark.org/help/> for more about the parser and the markdown language it supports. 
 You can also still use the `.Rd` syntax, some of which we will present
 below in the [Rd syntax](#rd-syntax) section.
 
-# Turning on markdown support
+# Turning on Markdown support
 
-There are two ways to turn on markdown support for a package: globally, at the package level, and locally at the block level.
+There are two ways to turn on Markdown support for a package: globally, at the package level, and locally at the block level.
 
-To turn on markdown for the whole package, insert this entry into the `DESCRIPTION` file of the package:
+To turn on Markdown for the whole package, insert this entry into the `DESCRIPTION` file of the package:
 ```
 Roxygen: list(markdown = TRUE)
 ```
-The position of the entry in the file does not matter. After this, all Roxygen documentation will be parsed as markdown.
+The position of the entry in the file does not matter. After this, all Roxygen documentation will be parsed as Markdown.
 
-Alternatively, you can use the `@md` tag to turn on markdown support for a single documentation chunk. This is a good option to write any new documentation^[If you wish to convert the `.Rd` syntax in existing documentation to markdown, you can have a look at [roxygen2md](https://roxygen2md.r-lib.org/) package.] for existing packages in markdown.
+Alternatively, you can use the `@md` tag to turn on Markdown support for a single documentation chunk. This is a good option to write any new documentation^[If you wish to convert the `.Rd` syntax in existing documentation to markdown, you can have a look at [roxygen2md](https://roxygen2md.r-lib.org/) package.] for existing packages in markdown.
 
-There is also a new `@noMd` tag. Use this if you turned on markdown parsing globally, but need to avoid it for a single chunk. This tag is handy if the markdown parser interferes with more complex Rd syntax.
+There is also a new `@noMd` tag. Use this if you turned on Markdown parsing globally, but need to avoid it for a single chunk. This tag is handy if the Markdown parser interferes with more complex Rd syntax.
 
-Here is an example roxygen chunk that uses markdown.
+Here is an example roxygen chunk that uses Markdown.
 
 ```r
 #' Use roxygen to document a package
@@ -53,7 +53,7 @@ Here is an example roxygen chunk that uses markdown.
 
 ## Sections
 
-The usual markdown heading markup creates sections and subsections. Top level headings, i.e. '`#`' create sections, via the `\section{}` Rd tag. '`#`' may only appear after the `@description` and `@details` tags. Since `@details` can appear multiple times in a block, you can always precede a '`#`' section with `@details`, if you prefer to place it towards the end of the block, after `@return` for example:
+The usual Markdown heading markup creates sections and subsections. Top level headings, i.e. '`#`' create sections, via the `\section{}` Rd tag. '`#`' may only appear after the `@description` and `@details` tags. Since `@details` can appear multiple times in a block, you can always precede a '`#`' section with `@details`, if you prefer to place it towards the end of the block, after `@return` for example:
 
 ```r
 #' @details
@@ -154,7 +154,7 @@ Regular Markdown lists are recognized and converted to `\enumerate{}` or `\itemi
 
 Nested lists are also supported.
 
-Note that you do not have to leave an empty line before the list. This is different from some markdown parsers.
+Note that you do not have to leave an empty line before the list. This is different from some Markdown parsers.
 
 ## Tables
 
@@ -179,7 +179,7 @@ By default, columns are left-aligned. Use colons to generate right and center al
 Markdown hyperlinks work as usual:
 
 ```r
-#' See more about the markdown markup at the
+#' See more about the Markdown markup at the
 #' [Commonmark web site](http://commonmark.org/help)
 ```
 
@@ -271,13 +271,13 @@ Markdown syntax for inline images works. The image files must be in the `man/fig
 
 # Dynamic R code
 
-Similarly to the knitr package, you can use the markdown inline code markup or markdown code blocks to evaluate R code and insert its output into the manual page.
+Similarly to the knitr package, you can use the Markdown inline code markup or Markdown code blocks to evaluate R code and insert its output into the manual page.
 
 ## Inline code
 
 To do this, prefix the code with `r `, i.e. the lowercase letter 'r' and a space character.
 Roxygen will interpret the rest of the text within backticks as R code and evaluate it, and replace the backtick expression with its value.
-After all such substitutions, the text of the whole tag is interpreted as markdown, as usual.
+After all such substitutions, the text of the whole tag is interpreted as Markdown, as usual.
 
 For example, the following will insert the date and the R version of the roxygen run.
 
@@ -291,7 +291,7 @@ So you don't explicitly need to convert to a character value, numeric values or
 Also, you can insert multiple lines by returning a character vector.
 If you want to run R code without inserting any output, return an empty string or `NULL`.
 
-The value of the expression is inserted into the text of the tag without interpreting it, before the markdown to `.Rd` conversion, so you can create markdown markup dynamically:
+The value of the expression is inserted into the text of the tag without interpreting it, before the Markdown to `.Rd` conversion, so you can create Markdown markup dynamically:
 
 ```r
 #' The `iris` data set has `r ""\x60r ncol(iris)\x60""` columns:
@@ -380,21 +380,21 @@ Some of the known limitations:
   * Some knitr chunk options are reset at the start of every code block, so if you want to change these, you'll have to specify them for every chunk.
     These are currently `error`, `fig.path`, `fig.process`.
   * Some knitr options might not create meaningful output.
-  * The markdown code runs every time you call `roxygenize()` (or `devtools::document()`) to generate the Rd files.
+  * The Markdown code runs every time you call `roxygenize()` (or `devtools::document()`) to generate the Rd files.
     This potentially makes `roxygenize()` (much) slower.
     You can turn on knitr caching as usual, but make sure to omit the cache from the package.
 
-# Roxygen and Rd tags *not* parsed as markdown
+# Roxygen and Rd tags *not* parsed as Markdown
 
-Some of the roxygen tags are not parsed as markdown. Most of these are unlikely to contain text that needs markup, so this is not an important restriction. Tags without markdown support: `@aliases`, `@backref`, `@docType`, `@encoding`, `@evalRd`, `@example`, `@examples`, `@family`, `@inheritParams`, `@keywords`, `@method` `@name`, `@md`, `@noMd`, `@noRd`, `@rdname`, `@rawRd`, `@usage`.
+Some of the roxygen tags are not parsed as Markdown. Most of these are unlikely to contain text that needs markup, so this is not an important restriction. Tags without Markdown support: `@aliases`, `@backref`, `@docType`, `@encoding`, `@evalRd`, `@example`, `@examples`, `@family`, `@inheritParams`, `@keywords`, `@method` `@name`, `@md`, `@noMd`, `@noRd`, `@rdname`, `@rawRd`, `@usage`.
 
-When mixing `Rd` and markdown notation, most `Rd` tags may contain markdown markup, the ones that can *not* are: `r paste0(""\x60"", roxygen2:::escaped_for_md, ""\x60"", collapse = "", "")`.
+When mixing `Rd` and Markdown notation, most `Rd` tags may contain Markdown markup, the ones that can *not* are: `r paste0(""\x60"", roxygen2:::escaped_for_md, ""\x60"", collapse = "", "")`.
 
 # Possible problems
 
-## Mixing markdown and `Rd` markup
+## Mixing Markdown and `Rd` markup
 
-Note that turning on markdown does *not* turn off the standard `Rd` syntax. We suggest that you use the regular `Rd` tags in a markdown roxygen chunk only if necessary. The two parsers do occasionally interact, and the markdown parser can pick up and reformat Rd syntax, causing an error, or corrupted manuals.
+Note that turning on Markdown does *not* turn off the standard `Rd` syntax. We suggest that you use the regular `Rd` tags in a Markdown roxygen chunk only if necessary. The two parsers do occasionally interact, and the Markdown parser can pick up and reformat Rd syntax, causing an error, or corrupted manuals.
 
 ## Leading whitespace
 
@@ -417,7 +417,7 @@ Links to operators or objects that contain special characters, do not work curre
 
 Within roxygen tags, you can use `.Rd` syntax to format text. Below we show you examples of the most important `.Rd` markup commands. The full details are described in [R extensions](https://cran.r-project.org/doc/manuals/R-exts.html#Marking-text).
 Before roxygen version 6.0.0 this was the only supported syntax. Now all of
-the formatting described below can be achieved more easily with markdown syntax,
+the formatting described below can be achieved more easily with Markdown syntax,
 with the important exception of [mathematical expressions](https://cran.r-project.org/doc/manuals/R-exts.html#Mathematics).
 
 Note that `\` and `%` are special characters. To insert literals, escape with a backslash: `\\`, `\%`.

---FILE: vignettes/rd.Rmd---
@@ -15,7 +15,7 @@ knitr::opts_chunk$set(comment = ""#>"", collapse = TRUE)
 
 A roxygen __block__ is a sequence of lines starting with `#'` (optionally preceded by whitespace). Blocks gain additional structure through the use of __tags__ like `@tag details`. Tags must start at the beginning of a line, and the content of a tag extends to the start of the next tag (or the end of the block). 
 
-Text within roxygen blocks can be formatted using markdown or `Rd` commands; see `vignette(""rd-formatting"")` for details.
+Text within roxygen blocks can be formatted using Markdown or `Rd` commands; see `vignette(""rd-formatting"")` for details.
 
 ## The description block
 
@@ -349,7 +349,7 @@ Note the use of two additional tags that are particularly useful for documenting
 
 * `@format`, which gives an overview of the structure of the dataset.
   This should include a __definition list__ that describes each variable.
-  There's currently no way to generate this with markdown, so this is 
+  There's currently no way to generate this with Markdown, so this is 
   one of the few places you'll need to Rd markup directly.
 
 * `@source` where you got the data form, often a URL.
@@ -394,7 +394,7 @@ You can add arbitrary sections with the `@section` tag. This is a useful way of
 #' Do not operate heavy machinery within 8 hours of using this function.
 ```
 
-You can also create sections using the markdown syntax for headers. For example, the previously-defined section can be created with markdown headers like this:
+You can also create sections using the Markdown syntax for headers. For example, the previously-defined section can be created with Markdown headers like this:
 
 ```{r}
 #' @details # Warning
@@ -426,7 +426,7 @@ There is tension between the DRY (do not repeat yourself) principle of programmi
 
 * Document multiple functions in the same topic with `@describeIn` or `@rdname`.
 
-* Run arbitrary R code with the markdown markup for inline code, see section 'Dynamic R code' in `vignette(""rd-formatting"")`.
+* Run arbitrary R code with the Markdown markup for inline code, see section 'Dynamic R code' in `vignette(""rd-formatting"")`.
 
 * Run arbitrary R code with `@eval`.
 
@@ -635,7 +635,7 @@ All content in the Rmd file will go either in the details or in new top level se
 
 ### Links
 
-The included Rmd file can have roxygen markdown style links to other help topics. E.g. `[roxygen2::roxygenize()]` will link to the manual page of the `roxygenize` function in roxygen2. See `vignette(""rd-formatting"")` for details.
+The included Rmd file can have roxygen Markdown-style links to other help topics. E.g. `[roxygen2::roxygenize()]` will link to the manual page of the `roxygenize` function in roxygen2. See `vignette(""rd-formatting"")` for details.
 
 ### Caching and figures
 
@@ -652,17 +652,17 @@ The included Rmd file can have roxygen markdown style links to other help topics
 ```
 ````
 
-If the Rmd file has links to other help topics, then some care is needed, as those links while not work in Rmd files. A workaround is to specify external HTML links for them. These external locations will _not_ be used for `@includeRmd`, which always links them to the help topics in the manual. Example:
+If the Rmd file contains roxygen (Markdown-style) links to other help topics, then some care is needed, as those links will not work in Rmd files by default. A workaround is to specify external HTML links for them. These external locations will _not_ be used for `@includeRmd`, which instead always links to the help topics in the manual. Example:
 
 ```
 See also the [roxygen2::roxygenize()] function.
 
 [roxygen2::roxygenize()]: https://roxygen2.r-lib.org/reference/roxygenize.html
 ```
 
-This example will link to the supplied URLs in html / markdown files and it will link to the `roxygenize` help topic in the manual.
+This example will link to the supplied URLs in HTML / Markdown files and it will link to the `roxygenize` help topic in the manual.
 
-Note that if you add external link targets like these, then roxygen will emit a warning about these link references being defined multiple times (once externally, and once to the help topic). This warning originates in pandoc, and it is harmless.
+Note that if you add external link targets like these, then roxygen will emit a warning about these link references being defined multiple times (once externally, and once to the help topic). This warning originates in Pandoc, and it is harmless.
 
 ## Other tags
 

---FILE: vignettes/roxygen2.Rmd---
@@ -101,7 +101,7 @@ add(10, 1)
 
 Rd files are a special file format loosely based on LaTeX. You can read more about the Rd format in the [R extensions](https://cran.r-project.org/doc/manuals/R-exts.html#Rd-format) manual. With roxygen2, there are few reasons to know about Rd files, so here I'll avoid discussing them as much as possible, focussing instead on what you need to know about roxygen2.
 
-When you use `?x`, `help(""x"")` or `example(""x"")` R looks for an Rd file containing `\alias{x}`. It then parses the file, converts it into html and displays it. These functions look for an Rd file in _installed_ packages. This isn't very useful for package development, because you want to use the `.Rd` files in the _source_ package. For this reason, we recommend that you use roxygen2 in conjunction with devtools: `devtools::load_all()` automatically adds shims so that `?` and friends will look in the development package. Note, however, that this preview does not work with intra-package links. To preview those, you'll need to install the package. If you use RStudio, the easiest way to do this is to click the ""Build & Reload button"".
+When you use `?x`, `help(""x"")` or `example(""x"")` R looks for an Rd file containing `\alias{x}`. It then parses the file, converts it into HTML and displays it. These functions look for an Rd file in _installed_ packages. This isn't very useful for package development, because you want to use the `.Rd` files in the _source_ package. For this reason, we recommend that you use roxygen2 in conjunction with devtools: `devtools::load_all()` automatically adds shims so that `?` and friends will look in the development package. Note, however, that this preview does not work with intra-package links. To preview those, you'll need to install the package. If you use RStudio, the easiest way to do this is to click the ""Build & Reload button"".
 
 ### Rcpp
 "
r-lib,roxygen2,732af0d132de16be5141b97d3863b96f20040d77,Michael McCarthy,51542091+mccarthy-m-g@users.noreply.github.com,2022-03-30T13:47:41Z,GitHub,noreply@github.com,2022-03-30T13:47:41Z,Fix typo in vignette (#1237),vignettes/rd-formatting.Rmd,True,False,True,False,1,1,2,"---FILE: vignettes/rd-formatting.Rmd---
@@ -217,7 +217,7 @@ First we explore the simplest form: `[ref]`. The presence of trailing parenthese
 | ``[`pkg::thing`]`` | package or in `pkg`    | mean that it **is** typeset as code.\       |
 |                    |                        | Good for documenting a class.\              |
 |                    |                        | Produces Rd: `\code{\link{thing}}` or\      |
-|                    |                        | `\code{\link[pkg:thing]{pkg::thing}`}       |
+|                    |                        | `\code{\link[pkg:thing]{pkg::thing}}`       |
 +--------------------+------------------------+---------------------------------------------+
 
 Use the second form `[text][ref]` to link to the topic specified by `ref`, but with `text` as the link text."
r-lib,roxygen2,256c900cc09132fa95b56cfa81e563fc5a2a41c5,Hadley Wickham,h.wickham@gmail.com,2022-03-30T13:43:50Z,Hadley Wickham,h.wickham@gmail.com,2022-03-30T13:43:50Z,"Report correct line number for first tag in block

Fixes #1235",NEWS.md;src/parser2.cpp;tests/testthat/_snaps/markdown-code.md;tests/testthat/_snaps/markdown-link.md;tests/testthat/test-tokenize.R,False,True,True,False,31,10,41,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* Problems with the first tag in each block are now reported with the
+  correct line number (#1235).
+
 * `\ifelse{}{}{}` tags in external inherited documentation are now inserted 
   correctly (without additional `{}`) (#1062).
 

---FILE: src/parser2.cpp---
@@ -110,14 +110,18 @@ cpp11::list tokenise_block(cpp11::strings lines, std::string file,
   std::vector<std::string> tags, vals;
   std::vector<int> rows;
 
-  int curRow = 1;
+  int curRow = 0;
   std::string curTag(""""), curVal("""");
 
   for (int i = 0; i < lines.size(); ++i) {
     RoxygenLine line((std::string(lines[i])));
 
-    if (!line.consumeRoxygenComment())
+    if (!line.consumeRoxygenComment()) {
+      // Incremenet curRow for non-roxygen comments at start of block
+      if (curVal == """")
+        curRow++;
       continue;
+    }
 
     std::string tag;
     if (line.consumeTag(&tag)) {
@@ -129,7 +133,7 @@ cpp11::list tokenise_block(cpp11::strings lines, std::string file,
         vals.push_back(curVal);
       }
 
-      curRow = i + offset;
+      curRow = i;
       curTag.assign(tag);
       curVal.assign("""");
     }
@@ -153,7 +157,7 @@ cpp11::list tokenise_block(cpp11::strings lines, std::string file,
   for (R_xlen_t i = 0; i < n; ++i) {
     cpp11::writable::list x({
         ""file""_nm = file,
-        ""line""_nm = rows[i],
+        ""line""_nm = rows[i] + offset,
         ""tag""_nm = tags[i],
         ""raw""_nm = stripTrailingNewline(vals[i]),
         ""val""_nm = R_NilValue

---FILE: tests/testthat/_snaps/markdown-code.md---
@@ -6,21 +6,21 @@
         1]]
     Condition
       Error:
-      ! [<text>:3] @description in inline code: multi-line `r ` markup is not supported
+      ! [<text>:4] @description in inline code: multi-line `r ` markup is not supported
     Code
       roc_proc_text(rd_roclet(),
       ""\n      #' Title\n      #'\n      #' Description --`r 1 + 'a'`--\n      #' @md\n      #' @name dummy\n      NULL"")[[
         1]]
     Condition
       Error:
-      ! [<text>:3] @description in inline code: non-numeric argument to binary operator
+      ! [<text>:4] @description in inline code: non-numeric argument to binary operator
     Code
       roc_proc_text(rd_roclet(),
       ""\n      #' Title\n      #'\n      #' Description --`r 1 + `--\n      #' @md\n      #' @name dummy\n      NULL"")[[
         1]]
     Condition
       Error:
-      ! [<text>:3] @description in inline code: <text>:2:0: unexpected end of input
+      ! [<text>:4] @description in inline code: <text>:2:0: unexpected end of input
       1: 1 + 
          ^
 

---FILE: tests/testthat/_snaps/markdown-link.md---
@@ -6,13 +6,13 @@
         1]]
     Condition
       Warning:
-      [<text>:3] @description Link to unavailable package: 11pkg::function.
+      [<text>:4] @description Link to unavailable package: 11pkg::function.
       there is no package called '11pkg'
       Warning:
-      [<text>:3] @description Link to unavailable package: 11pkg::object.
+      [<text>:4] @description Link to unavailable package: 11pkg::object.
       there is no package called '11pkg'
 
 ---
 
-    [<text>:3] @description Link to unknown topic: stringr::bar111
+    [<text>:4] @description Link to unknown topic: stringr::bar111
 

---FILE: tests/testthat/test-tokenize.R---
@@ -146,4 +146,18 @@ test_that(""Line numbers are ok"", {
   block <- parse_text(text)[[1]]
   ls <- c(title = 1, description = 3, details = 5, param = 7, export = 10)
   check_line_nums(block, ls)
+
+  text <-
+    ""# 1
+     # 2
+     #' foo
+     #'
+     #' Description
+     # 6
+     # 7
+     #' @param x xyz
+     NULL""
+  block <- parse_text(text)[[1]]
+  ls <- c(title = 3, description = 5, param = 8)
+  check_line_nums(block, ls)
 })"
r-lib,roxygen2,2f5079a1ec465fd8c7fa52b7a6651045c7772dd8,Andreas Kersting,github@akersting.de,2022-03-29T20:22:53Z,GitHub,noreply@github.com,2022-03-29T20:22:53Z,"Strip extra { around inherited `\ifelse` (#1201)

Fixes #1062",NEWS.md;R/utils-rd.R;tests/testthat/test-utils-rd.R,False,True,True,False,9,2,11,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* `\ifelse{}{}{}` tags in external inherited documentation are now inserted 
+  correctly (without additional `{}`) (#1062).
+
 * `@includeRmd` is now adapted to change in rmarkdown 2.12 regarding math support in `github_document()` (#1304).
 
 # roxygen2 7.1.2

---FILE: R/utils-rd.R---
@@ -125,7 +125,7 @@ parse_rd <- function(x) {
 # Generated in .onLoad()
 as_character_rd <- NULL
 make_as_character_rd <- function() {
-  # ""as.character.Rd"" appears to be missing \href in TWOARGS
+  # ""as.character.Rd"" appears to a few commands in TWOARGS
   # this code hacks the body of the function to add it
   fn <- internal_f(""tools"", ""as.character.Rd"")
 
@@ -135,7 +135,7 @@ make_as_character_rd <- function() {
     return(fn)
   }
 
-  body[[idx]][[3]] <- call_modify(body[[idx]][[3]], ""\\href"")
+  body[[idx]][[3]] <- call_modify(body[[idx]][[3]], ""\\href"", ""\\ifelse"")
   body(fn) <- body
   fn
 }

---FILE: tests/testthat/test-utils-rd.R---
@@ -2,6 +2,10 @@ test_that(""href doesn't get extra parens"", {
   expect_equal(rd2text(parse_rd(""\\href{a}{b}"")), ""\\href{a}{b}\n"")
 })
 
+test_that(""ifelse doesn't get extra parens"", {
+  expect_equal(rd2text(parse_rd(""\\ifelse{a}{b}{c}"")), ""\\ifelse{a}{b}{c}\n"")
+})
+
 test_that(""has_topic() works as you'd expect"", {
   expect_equal(has_topic(""abbreviate"", ""base""), TRUE)
   expect_equal(has_topic(""abbreviateXXXX"", ""base""), FALSE)"
r-lib,roxygen2,29667cde279f6dddb248c02026577cc965882deb,Hadley Wickham,h.wickham@gmail.com,2021-09-07T20:49:59Z,Hadley Wickham,h.wickham@gmail.com,2021-09-07T20:49:59Z,"Convert from lappy() to for-loop

This fixes a problem where tests would fail when run with devtools::test(), but not when run interactively or in R CMD check. I also tried exporting all methods for internal generics, but that didn't help. I'm not sure what's going on here.",R/block.R,False,True,True,False,6,1,7,"---FILE: R/block.R---
@@ -209,7 +209,12 @@ parse_tags <- function(tokens) {
   markdown_activate(tokens)
 
   tokens <- parse_description(tokens)
-  compact(lapply(tokens, roxy_tag_parse))
+
+  out <- vector(""list"", length(tokens))
+  for (i in seq_along(tokens)) {
+    out[[i]] <- roxy_tag_parse(tokens[[i]])
+  }
+  compact(out)
 }
 
 #' @export"
r-lib,roxygen2,ad9f15e70c952caa94c6c31eca6de06add4a0d72,Ma칢lle Salmon,maelle.salmon@yahoo.se,2021-04-16T14:02:31Z,GitHub,noreply@github.com,2021-04-16T14:02:31Z,fix for cross-linking :-) (#1176),vignettes/rd.Rmd,True,False,True,False,1,1,2,"---FILE: vignettes/rd.Rmd---
@@ -612,7 +612,7 @@ All content in the Rmd file will go either in the details or in new top level se
 
 ### Links
 
-The included Rmd file can have roxygen markdown style links to other help topics. E.g. `[roxygen2::roxygenize()]` will link to the manual page of the `roxygenize` function in roxygen2. See `vignette(""rd-formatting.Rmd"")` for details.
+The included Rmd file can have roxygen markdown style links to other help topics. E.g. `[roxygen2::roxygenize()]` will link to the manual page of the `roxygenize` function in roxygen2. See `vignette(""rd-formatting"")` for details.
 
 ### Caching and figures
 "
r-lib,roxygen2,047bb535ac7358306aa03110f0928c7815f4e4f8,Marco Colombo,mar.colombo13@gmail.com,2021-04-16T14:01:17Z,GitHub,noreply@github.com,2021-04-16T14:01:17Z,Fix suggestion for overriding the default load strategy. (#1194),R/load.R;man/load.Rd,False,True,True,False,2,2,4,"---FILE: R/load.R---
@@ -25,7 +25,7 @@
 #' `installed` strategies:
 #'
 #' ```
-#' RoxygenNote: list(load = ""source"")
+#' Roxygen: list(load = ""source"")
 #' ```
 #' @name load
 #' @param path Path to source package

---FILE: man/load.Rd---
@@ -37,6 +37,6 @@ outside of roxygen2.
 
 You can change the default strategy for your function with roxygen2 \code{load}
 option. Override the default off \code{pkgload} to use the \code{source} or
-\code{installed} strategies:\preformatted{RoxygenNote: list(load = ""source"")
+\code{installed} strategies:\preformatted{Roxygen: list(load = ""source"")
 }
 }"
r-lib,roxygen2,707056f941374f0a796c667ebb4e669ac3913070,Neal Richardson,neal.p.richardson@gmail.com,2021-04-16T13:57:53Z,GitHub,noreply@github.com,2021-04-16T13:57:53Z,Fix news typo (#1208),NEWS.md,False,False,False,False,1,1,2,"---FILE: NEWS.md---
@@ -3,7 +3,7 @@
 * Percent signs in markdown link targets, e.g. `[text](https://foo/ba%20r)`
   are now handled correctly (#1209).
 
-* The new `@exmaplesIf` tag can be used to create conditional
+* The new `@examplesIf` tag can be used to create conditional
   examples. These examples only run if a specified condition
   holds (#962).
 "
r-lib,roxygen2,65ce976e5a4310138e515401e0785890df60485f,Hadley Wickham,h.wickham@gmail.com,2020-06-26T17:48:49Z,Hadley Wickham,h.wickham@gmail.com,2020-06-26T17:48:49Z,"Sort in C locale

Fixes #1077",NEWS.md;R/object-import.R;R/object-r6.R;R/util-locale.R,False,True,True,False,6,3,9,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* R6 methods and re-exported functions are always sorted in the C locale;
+  this ensures they're always sorted the same way in every environment (#1077).
+
 * When processing cross package markdown links (e.g. `[pkg::fun()]`),
   roxygen2 now looks up the file it needs to link to, instead of linking to
   the topic, to avoid ""Non-file package-anchored links"" `R CMD check` warnings.

---FILE: R/object-import.R---
@@ -19,7 +19,7 @@ merge.rd_section_reexport <- function(x, y, ...) {
 format.rd_section_reexport <- function(x, ...) {
   pkgs <- split(x$value$fun, x$value$pkg)
   pkg_links <- map2(names(pkgs), pkgs, function(pkg, funs) {
-    funs <- sort(funs)
+    funs <- sort_c(funs)
     files <- map_chr(
       funs,
       try_find_topic_in_package,

---FILE: R/object-r6.R---
@@ -150,7 +150,7 @@ extract_r6_super_data <- function(x) {
     c(""method"", ""field"", ""active""),
     c(length(method_nms), length(field_nms), length(active_nms))
   )
-  rsort <- function(x) sort(x, decreasing = TRUE)
+  rsort <- function(x) sort_c(x, decreasing = TRUE)
   names <-c(rsort(method_nms), rsort(field_nms), rsort(active_nms))
   mth <- rbind(
     data.frame(

---FILE: R/util-locale.R---
@@ -11,4 +11,4 @@ with_collate <- function(locale, code) {
   force(code)
 }
 
-sort_c <- function(x) with_collate(""C"", sort(x))
+sort_c <- function(x, ...) with_collate(""C"", sort(x, ...))"
r-lib,roxygen2,65330c56893ea2165e825e423a7c212eb23d312a,G치bor Cs치rdi,csardi.gabor@gmail.com,2020-06-26T17:44:18Z,GitHub,noreply@github.com,2020-06-26T17:44:18Z,"Link to files, not topics (#1109)

Fixes #1108",NEWS.md;R/markdown-link.R;R/object-import.R;R/rd-find-link-files.R;R/rd-inherit.R;R/utils-rd.R;man/figures/test-figure-1.png;man/markdown_pass1.Rd;tests/testthat/test-markdown-link.R;tests/testthat/test-object-import.R,False,True,True,False,173,25,198,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* When processing cross package markdown links (e.g. `[pkg::fun()]`),
+  roxygen2 now looks up the file it needs to link to, instead of linking to
+  the topic, to avoid ""Non-file package-anchored links"" `R CMD check` warnings.
 * roxygen2 now supports inline markdown code and code chunks inside
   Rd tags. In particular in `\out{}` (#1115).
 

---FILE: R/markdown-link.R---
@@ -4,20 +4,23 @@
 #' spaces between the closing and opening bracket in the `[text][ref]`
 #' form.
 #'
+#' Starting from R 4.0.2-ish, explicit cross-package links to topics are not
+#' allowed, so for each such linked topic, we look up the linked file.
+#'
 #' These are the link references we add:
 #' ```
 #' MARKDOWN           LINK TEXT  CODE RD
 #' --------           ---------  ---- --
 #' [fun()]            fun()       T   \\link[=fun]{fun()}
 #' [obj]              obj         F   \\link{obj}
-#' [pkg::fun()]       pkg::fun()  T   \\link[pkg:fun]{pkg::fun()}
-#' [pkg::obj]         pkg::obj    F   \\link[pkg:obj]{pkg::obj}
+#' [pkg::fun()]       pkg::fun()  T   \\link[pkg:file]{pkg::fun()}
+#' [pkg::obj]         pkg::obj    F   \\link[pkg:file]{pkg::obj}
 #' [text][fun()]      text        F   \\link[=fun]{text}
 #' [text][obj]        text        F   \\link[=obj]{text}
-#' [text][pkg::fun()] text        F   \\link[pkg:fun]{text}
-#' [text][pkg::obj]   text        F   \\link[pkg:obj]{text}
+#' [text][pkg::fun()] text        F   \\link[pkg:file]{text}
+#' [text][pkg::obj]   text        F   \\link[pkg:file]{text}
 #' [s4-class]         s4          F   \\linkS4class{s4}
-#' [pkg::s4-class]    pkg::s4     F   \\link[pkg:s4-class]{pkg::s4}
+#' [pkg::s4-class]    pkg::s4     F   \\link[pkg:file]{pkg::s4}
 #' ```
 #'
 #' The reference links will always look like `R:ref` for `[ref]` and
@@ -111,16 +114,20 @@ parse_link <- function(destination, contents, state) {
   ## `obj` is fun or obj (fun is without parens)
   ## `s4` is TRUE if we link to an S4 class (i.e. have -class suffix)
   ## `noclass` is fun with -class removed
+  ## `file` is the file name of the linked topic.
 
+  thispkg <- roxy_meta_get(""current_package"") %||% """"
   is_code <- is_code || (grepl(""[(][)]$"", destination) && ! has_link_text)
   pkg <- str_match(destination, ""^(.*)::"")[1,2]
   pkg <- gsub(""%"", ""\\\\%"", pkg)
+  if (!is.na(pkg) && pkg == thispkg) pkg <- NA_character_
   fun <- utils::tail(strsplit(destination, ""::"", fixed = TRUE)[[1]], 1)
   fun <- gsub(""%"", ""\\\\%"", fun)
   is_fun <- grepl(""[(][)]$"", fun)
   obj <- sub(""[(][)]$"", """", fun)
   s4 <- str_detect(destination, ""-class$"")
   noclass <- str_match(fun, ""^(.*)-class$"")[1,2]
+  file <- find_topic_filename(pkg, obj, state$tag)
 
   ## To understand this, look at the RD column of the table above
   if (!has_link_text) {
@@ -130,7 +137,7 @@ parse_link <- function(destination, contents, state) {
       if (is_fun || ! is.na(pkg)) ""["",
       if (is_fun && is.na(pkg)) ""="",
       if (! is.na(pkg)) paste0(pkg, "":""),
-      if (is_fun || ! is.na(pkg)) paste0(obj, ""]""),
+      if (is_fun || ! is.na(pkg)) paste0(if (is.na(pkg)) obj else file, ""]""),
       ""{"",
       if (!is.na(pkg)) paste0(pkg, ""::""),
       if (s4) noclass else fun,
@@ -146,7 +153,7 @@ parse_link <- function(destination, contents, state) {
         if (is_code) ""\\code{"",
         ""\\link["",
         if (is.na(pkg)) ""="" else paste0(pkg, "":""),
-        obj,
+        if (is.na(pkg)) obj else file,
         ""]{""
       ),
       contents,

---FILE: R/object-import.R---
@@ -19,7 +19,17 @@ merge.rd_section_reexport <- function(x, y, ...) {
 format.rd_section_reexport <- function(x, ...) {
   pkgs <- split(x$value$fun, x$value$pkg)
   pkg_links <- map2(names(pkgs), pkgs, function(pkg, funs) {
-    links <- paste0(""\\code{\\link["", pkg, ""]{"", escape(sort(funs)), ""}}"",
+    funs <- sort(funs)
+    files <- map_chr(
+      funs,
+      try_find_topic_in_package,
+      pkg = pkg,
+      where = "" in re-export""
+    )
+    links <- paste0(
+      ""\\code{\\link["", pkg,
+      ifelse(files == funs, """", paste0("":"", files)),
+      ""]{"", escape(funs), ""}}"",
       collapse = "", "")
     paste0(""\\item{"", pkg, ""}{"", links, ""}"")
   })

---FILE: R/rd-find-link-files.R---
@@ -0,0 +1,92 @@
+
+#' Find the Rd file of a topic
+#'
+#' @param pkg Package to search in, or `NA` if no package was specified.
+#'   If the same as the dev package, then we treat it as `NA`.
+#' @param topic Topic to search for. This is the escaped, so it is `""\%\%""` and
+#'   not `""%%""`.
+#' @param tag The roxy tag object that contains the link. We use this for
+#'   better warnings, that include the file name and line number (of the tag).
+#' @return String. File name to link to.
+#'
+#' @details
+#' If `pkg` is `NA` or the package being documented, we'll just leave the
+#' topic alone.
+#'
+#' If `pkg` is not `NA` and not the package being documented (the _dev_
+#' package), then we need to be able to find the Rd file. If we can't, that's
+#' a warning and the link is left untouched. This typically happens when the
+#' linked package is not installed or cannot be loaded.
+#'
+#' @noRd
+
+find_topic_filename <- function(pkg, topic, tag = NULL) {
+  if (is.na(pkg) || identical(roxy_meta_get(""current_package""), pkg)) {
+    topic
+  } else {
+    try_find_topic_in_package(pkg, topic, tag = tag)
+  }
+}
+
+#' Find a help topic in a package
+#'
+#' This is used by both `find_topic_filename()` and
+#' `format.rd_section_reexport()` that creates the re-exports page. The error
+#' messages are different for the two, so errors are not handled here.
+#'
+#' @param pkg Package name. This cannot be `NA`.
+#' @inheritParams find_topic_filename
+#' @return File name if the topic was found, `NA` if the package could be
+#'   searched, but the topic was not found. Errors if the package cannot be
+#'   searched. (Because it is not installed or cannot be loaded, etc.)
+#'
+#' @noRd
+
+find_topic_in_package <- function(pkg, topic) {
+  # This is needed because we have the escaped text here, and parse_Rd will
+  # un-escape it properly.
+  on.exit(close(con), add = TRUE)
+  con <- textConnection(topic)
+  raw_topic <- str_trim(tools::parse_Rd(con)[[1]][1])
+  basename(utils::help((raw_topic), (pkg))[1])
+}
+
+try_find_topic_in_package <- function(pkg, topic, where = """", tag = NULL) {
+  path <- tryCatch(
+    find_topic_in_package(pkg, topic),
+    error = function(err) {
+      msg <- paste0(
+        ""Link to unavailable package"", where, "": "", pkg, ""::"",
+        topic, "". "", err$message
+      )
+      if (is.null(tag)) {
+        roxy_warning(msg)
+      } else {
+        roxy_tag_warning(tag, msg)
+      }
+      topic
+    }
+  )
+
+  if (is.na(path)) {
+    msg <- paste0(""Link to unknown topic"", where, "": "", pkg, ""::"", topic)
+    if (is.null(tag)) {
+      roxy_warning(msg)
+    } else {
+      roxy_tag_warning(tag, msg)
+    }
+    topic
+  } else {
+    path
+  }
+}
+
+resolve_qualified_link <- function(topic) {
+  if (has_colons(topic)) {
+    target <- str_split_fixed(topic, ""::"", n = 2)
+    file <- find_topic_in_package(target[1], target[2])
+    paste0(target[1], "":"", file)
+  } else {
+    paste0(""="", topic)
+  }
+}

---FILE: R/rd-inherit.R---
@@ -186,7 +186,7 @@ inherit_dot_params <- function(topic, topics, env) {
   # Build the Rd
   # (1) Link to function(s) that was inherited from
   src <- inheritors$source
-  dest <- ifelse(has_colons(src), gsub(""::"", "":"", src), paste0(""="", src))
+  dest <- map_chr(src, resolve_qualified_link)
   from <- paste0(""\\code{\\link["", dest, ""]{"", src, ""}}"", collapse = "", "")
 
   # (2) Show each inherited argument

---FILE: R/utils-rd.R---
@@ -88,8 +88,18 @@ tweak_links <- function(x, package) {
           topic <- substr(opt, 2, nchar(opt))
 
           if (has_topic(topic, package)) {
-            attr(x, ""Rd_option"") <- structure(paste0(package, "":"", topic), Rd_tag = ""TEXT"")
+            file <- find_topic_in_package(package, topic)
+            attr(x, ""Rd_option"") <- structure(paste0(package, "":"", file), Rd_tag = ""TEXT"")
           }
+        } else if (grepl("":"", opt)) {
+          # need to fix the link to point to a file
+          target <- str_split_fixed(opt, "":"", n = 2)
+          file <- try_find_topic_in_package(
+            target[1],
+            target[2],
+            where = "" in inherited text""
+          )
+          attr(x, ""Rd_option"") <- structure(paste0(target[1], "":"", file), Rd_tag = ""TEXT"")
         }
       }
     } else if (length(x) > 0) {

---FILE: man/markdown_pass1.Rd---
@@ -36,8 +36,7 @@ x + 1
 
 Chunk options:\if{html}{\out{<div class=""r"">}}\preformatted{names(mtcars)
 nrow(mtcars)
-}\if{html}{\out{</div>}}\preformatted{##  [1] ""mpg""  ""cyl""  ""disp"" ""hp""   ""drat"" ""wt""   ""qsec"" ""vs""   ""am""   ""gear""
-## [11] ""carb""
+}\if{html}{\out{</div>}}\preformatted{##  [1] ""mpg""  ""cyl""  ""disp"" ""hp""   ""drat"" ""wt""   ""qsec"" ""vs""   ""am""   ""gear"" ""carb""
 ## [1] 32
 }
 

---FILE: tests/testthat/test-markdown-link.R---
@@ -51,7 +51,7 @@ test_that(""% in links are escaped"", {
   expect_equal(markdown(""[x][%%]""), ""\\link[=\\%\\%]{x}"")
   expect_equal(markdown(""[%][x]""), ""\\link[=x]{\\%}"")
   expect_equal(markdown(""[%%]""), ""\\link{\\%\\%}"")
-  expect_equal(markdown(""[foo::%%]""), ""\\link[foo:\\%\\%]{foo::\\%\\%}"")
+  expect_equal(markdown(""[base::%%]""), ""\\link[base:Arithmetic]{base::\\%\\%}"")
 })
 
 test_that(""commonmark picks up the various link references"", {
@@ -94,16 +94,19 @@ test_that(""short and sweet links work"", {
     foo <- function() {}"")[[1]]
   expect_equivalent_rd(out1, out2)
 
-  out1 <- roc_proc_text(rd_roclet(), ""
+  expect_warning(
+    out1 <- roc_proc_text(rd_roclet(), ""
     #' Title
     #'
-    #' See [pkg::function()], [pkg::object].
+    #' See [11pkg::function()], [11pkg::object].
     #' @md
-    foo <- function() {}"")[[1]]
+    foo <- function() {}"")[[1]],
+    ""Link to unavailable package""
+  )
   out2 <- roc_proc_text(rd_roclet(), ""
     #' Title
     #'
-    #' See \\code{\\link[pkg:function]{pkg::function()}}, \\link[pkg:object]{pkg::object}.
+    #' See \\code{\\link[11pkg:function]{11pkg::function()}}, \\link[11pkg:object]{11pkg::object}.
     foo <- function() {}"")[[1]]
   expect_equivalent_rd(out1, out2)
 
@@ -120,16 +123,19 @@ test_that(""short and sweet links work"", {
     foo <- function() {}"")[[1]]
   expect_equivalent_rd(out1, out2)
 
-  out1 <- roc_proc_text(rd_roclet(), ""
+  expect_warning(
+    out1 <- roc_proc_text(rd_roclet(), ""
     #' Title
     #'
-    #' Description, see [name words][pkg::bar].
+    #' Description, see [name words][stringr::bar111].
     #' @md
-    foo <- function() {}"")[[1]]
+    foo <- function() {}"")[[1]],
+    ""Link to unknown topic: stringr::bar111""
+  )
   out2 <- roc_proc_text(rd_roclet(), ""
     #' Title
     #'
-    #' Description, see \\link[pkg:bar]{name words}.
+    #' Description, see \\link[stringr:bar111]{name words}.
     foo <- function() {}"")[[1]]
   expect_equivalent_rd(out1, out2)
 
@@ -243,7 +249,7 @@ test_that(""another markdown link bug is fixed"", {
 
 test_that(""markdown code as link text is rendered as code"", {
 
-  out1 <- roc_proc_text(rd_roclet(), ""
+  suppressWarnings(out1 <- roc_proc_text(rd_roclet(), ""
     #' Title
     #'
     #' Description, see [`name`][dest],
@@ -253,7 +259,7 @@ test_that(""markdown code as link text is rendered as code"", {
     #' [`terms`][terms.object],
     #' [`abc`][abc-class].
     #' @md
-    foo <- function() {}"")[[1]]
+    foo <- function() {}"")[[1]])
   out2 <- roc_proc_text(rd_roclet(), ""
     #' Title
     #'
@@ -366,12 +372,12 @@ test_that(""links to S4 classes are OK"", {
     foo <- function() {}"")[[1]]
   expect_equivalent_rd(out1, out2)
 
-  out1 <- roc_proc_text(rd_roclet(), ""
+  suppressWarnings(out1 <- roc_proc_text(rd_roclet(), ""
     #' Title
     #'
     #' Description, see [pkg::linktos4-class] as well.
     #' @md
-    foo <- function() {}"")[[1]]
+    foo <- function() {}"")[[1]])
   out2 <- roc_proc_text(rd_roclet(), ""
     #' Title
     #'
@@ -430,3 +436,13 @@ test_that(""markup in link text"", {
     foo <- function() {}"")[[1]]
   expect_equivalent_rd(out1, out2)
 })
+
+test_that(""linking to self is unqualified"", {
+  old <- roxy_meta_set(""current_package"", ""myself"")
+  on.exit(roxy_meta_set(""current_package"", old), add = TRUE)
+  rd <- markdown(""foo [myself::fun()] and [myself::obj] bar"")
+  expect_equal(
+    rd,
+    ""foo \\code{\\link[=fun]{fun()}} and \\link{obj} bar""
+  )
+})

---FILE: tests/testthat/test-object-import.R---
@@ -51,3 +51,14 @@ test_that(""can't set description and re-export"", {
 
   expect_length(out, 0)
 })
+
+test_that(""warnings for unknown packages and objects"", {
+  expect_warning(
+    format(rd_section_reexport(""11papaya"", ""fun"")),
+    ""[uU]navailable package in re-export""
+  )
+  expect_warning(
+    format(rd_section_reexport(""stringr"", ""12345543221"")),
+    ""[uU]nknown topic in re-export""
+  )
+})"
r-lib,roxygen2,fb3c45a4577d5a6013f31ab00102c2d71813760c,Salim B,salim@posteo.de,2020-06-26T17:42:15Z,GitHub,noreply@github.com,2020-06-26T17:42:15Z,Fix `rd_family_title` option (#1078),DESCRIPTION;R/options.R;man/load_options.Rd;vignettes/rd.Rmd,True,True,True,False,11,5,16,"---FILE: DESCRIPTION---
@@ -59,5 +59,5 @@ VignetteBuilder:
     knitr
 Encoding: UTF-8
 Roxygen: list(markdown = TRUE, load = ""installed"")
-RoxygenNote: 7.1.0
+RoxygenNote: 7.1.0.9000
 Language: en-GB

---FILE: R/options.R---
@@ -25,6 +25,9 @@
 #'
 #' * `current_package` `<string>` (read only): name of package being documented.
 #'
+#' * `rd_family_title` `<list>`: overrides for `@family` titles. See the
+#'    _rd_ vignette for details: `vignette(""rd"", package = ""roxygen2"")`
+#'
 #' @section How to set:
 #' Either set in `DESCRIPTION`:
 #'
@@ -56,7 +59,8 @@ load_options <- function(base_path = ""."") {
     old_usage = FALSE,
     markdown = FALSE,
     r6 = TRUE,
-    current_package = NA_character_
+    current_package = NA_character_,
+    rd_family_title = list()
   )
 
   unknown_opts <- setdiff(names(opts), names(defaults))
@@ -109,7 +113,7 @@ load_options_meta <- function(base_path = ""."", path = ""man/roxygen/meta.R"") {
   value
 }
 
-# Global binding mangaemnet -----------------------------------------------
+# Global binding management -----------------------------------------------
 
 roxy_meta <- new_environment()
 

---FILE: man/load_options.Rd---
@@ -31,6 +31,8 @@ Options in \code{man/roxygen/meta.R} override those present in \code{DESCRIPTION
 \item \code{markdown} \verb{<flag>}: translate markdown syntax to Rd?
 \item \code{r6} \verb{<flag>}: document R6 classes?
 \item \code{current_package} \verb{<string>} (read only): name of package being documented.
+\item \code{rd_family_title} \verb{<list>}: overrides for \verb{@family} titles. See the
+\emph{rd} vignette for details: \code{vignette(""rd"", package = ""roxygen2"")}
 }
 }
 

---FILE: vignettes/rd.Rmd---
@@ -424,8 +424,8 @@ For `sum()`, this might look like:
 By default  `@family {family}`, will generate the see also text ""Other {family}:"", so the `@family` name should be plural (i.e., ""model building helpers"" not ""model building helper""). You can override the default title by providing a `rd_family_title` list in `man/roxygen/meta.R`:
 
 ```{r, eval = FALSE}
-rd_family_title <- list(
-  aggregations = ""Aggregation functions""
+list(
+  rd_family_title = list(aggregations = ""Aggregation functions"")
 )
 ```
 "
r-lib,roxygen2,52ae8cabe2c0bbeb76dea77c607752c5a8694022,Max Held,info@maxheld.de,2020-06-26T17:38:26Z,GitHub,noreply@github.com,2020-06-26T17:38:26Z,"fix small typos, disambiguate path (#1094)",vignettes/rd.Rmd,True,False,True,False,1,1,2,"---FILE: vignettes/rd.Rmd---
@@ -591,7 +591,7 @@ Note that templates are parsed a little differently to regular blocks, so you'll
 
 ## Including external `.Rmd`/`.md` files
 
-Starting from roxygen2 7.0.0, you can use `@includeRmd path/to/file.Rmdname` to include an external `.Rmd` or `.md` document into a manual page (the path is relative package root directory). You can include the same file in multiple documentation files, and for the first time, share content across documentation and vignettes.
+Starting from roxygen2 7.0.0, you can use `@includeRmd path/to/file.Rmd` to include an external `.Rmd` or `.md` document into a manual page (the path is relative from the source package root directory). You can include the same file in multiple documentation files, and for the first time, share content across documentation and vignettes.
 
 ### Sections
 "
r-lib,roxygen2,a8a694d085a125897f0d2ec738799839beb308ff,Salim B,salim@posteo.de,2020-06-26T17:35:06Z,GitHub,noreply@github.com,2020-06-26T17:35:06Z,"Fix typos (#1114)

* Fix typo

* Fix another typo",vignettes/rd.Rmd,True,False,True,False,2,2,4,"---FILE: vignettes/rd.Rmd---
@@ -359,7 +359,7 @@ Some notes:
 * `usethis::use_package_doc()` will generate a basic template to get 
   you started.
 
-* Use `@references` point to published material about the package that
+* Use `@references` to point to published material about the package that
   users might find helpful.
 
 ## Sections
@@ -616,7 +616,7 @@ The included Rmd file can have roxygen markdown style links to other help topics
 
 ### Caching and figures
 
-`@includeRmd` tries to set up knits to support caching in the Rmd file. It sets the cache path to the default knitr cache path of the included Rmd file (i.e. `foo/bar/file_cache/` for `foo/bar/file.Rmd`), so if you do not change the cache path within the Rmd itself, then everything should work out of the box. You should add these cache paths to `.gitignore` and `.Rbuildignore`.
+`@includeRmd` tries to set up knitr to support caching in the Rmd file. It sets the cache path to the default knitr cache path of the included Rmd file (i.e. `foo/bar/file_cache/` for `foo/bar/file.Rmd`), so if you do not change the cache path within the Rmd itself, then everything should work out of the box. You should add these cache paths to `.gitignore` and `.Rbuildignore`.
 
 `@includeRmd` also sets the knitr figure path of the (`fig.path`) to the default figure path of the included Rmd. Overriding this default is unlikely to work.
 "
r-lib,roxygen2,6f081b756a463b5ae67f30a3cde70c8bf365e807,G치bor Cs치rdi,csardi.gabor@gmail.com,2020-06-25T11:47:19Z,GitHub,noreply@github.com,2020-06-25T11:47:19Z,Fix interactions of dynamic code and fragile tags (#1116),NEWS.md;R/markdown.R;tests/testthat/test-markdown-code.R;tests/testthat/testNamespace/DESCRIPTION,False,True,True,False,28,6,34,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* roxygen2 now supports inline markdown code and code chunks inside
+  Rd tags. In particular in `\out{}` (#1115).
+
 # roxygen2 7.1.0
 
 ## New features

---FILE: R/markdown.R---
@@ -1,5 +1,6 @@
 
 markdown <- function(text, tag = NULL, sections = FALSE) {
+  tag <- tag %||% list(file = NA, line = NA)
   tryCatch(
     expanded_text <- markdown_pass1(text),
     error = function(e) {
@@ -10,7 +11,8 @@ markdown <- function(text, tag = NULL, sections = FALSE) {
       stop(message, call. = FALSE)
     }
   )
-  markdown_pass2(expanded_text, tag = tag, sections = sections)
+  escaped_text <- escape_rd_for_md(expanded_text)
+  markdown_pass2(escaped_text, tag = tag, sections = sections)
 }
 
 #' Expand the embedded inline code
@@ -59,14 +61,13 @@ markdown <- function(text, tag = NULL, sections = FALSE) {
 
 markdown_pass1 <- function(text) {
   text <- paste(text, collapse = ""\n"")
-  esc_text <- escape_rd_for_md(text)
-  mdxml <- xml_ns_strip(md_to_mdxml(esc_text, sourcepos = TRUE))
+  mdxml <- xml_ns_strip(md_to_mdxml(text, sourcepos = TRUE))
   code_nodes <- xml_find_all(mdxml, "".//code | .//code_block"")
   rcode_nodes <- keep(code_nodes, is_markdown_code_node)
-  if (length(rcode_nodes) == 0) return(esc_text)
+  if (length(rcode_nodes) == 0) return(text)
   rcode_pos <- parse_md_pos(map_chr(rcode_nodes, xml_attr, ""sourcepos""))
   out <- eval_code_nodes(rcode_nodes)
-  str_set_all_pos(esc_text, rcode_pos, out, rcode_nodes)
+  str_set_all_pos(text, rcode_pos, out, rcode_nodes)
 }
 
 is_markdown_code_node <- function(x) {

---FILE: tests/testthat/test-markdown-code.R---
@@ -124,3 +124,21 @@ test_that(""fence options are used"", {
   details <- out1$get_value(""details"")
   expect_false(grepl(""Error"", details))
 })
+
+test_that(""dynamic code in fragile tags still runs"", {
+  out <- markdown(""foo \\out{`r 1+1`} bar"")
+  expect_equal(out, ""foo \\out{2} bar"")
+})
+
+test_that(""fragile tags in dynamic code are left alone"", {
+  out <- markdown(""foo `r substr('\\\\out{xxx}', 2, 4)` bar"")
+  expect_equal(out, ""foo out bar"")
+})
+
+test_that(""fragile tags in generated code"", {
+  out <- markdown(""foo `r '\\\\out{*1*}'` bar"")
+  expect_equal(out, ""foo \\out{*1*} bar"")
+
+  expect_silent(out2 <- markdown(""foo `r '\\\\out{<span></span>}'` bar""))
+  expect_equal(out2, ""foo \\out{<span></span>} bar"")
+})

---FILE: tests/testthat/testNamespace/DESCRIPTION---
@@ -6,4 +6,4 @@ Author: Hadley <hadley@rstudio.com>
 Maintainer: Hadley <hadley@rstudio.com>
 Encoding: UTF-8
 Version: 0.1
-RoxygenNote: 7.0.2.9000
+RoxygenNote: 7.1.0.9000"
r-lib,roxygen2,e0921307ad7dc9cee0938a42e2baa63c7f7b238e,Hadley Wickham,h.wickham@gmail.com,2020-03-10T21:16:24Z,GitHub,noreply@github.com,2020-03-10T21:16:24Z,"Add new packgaes meta field (#1059)

Fixes #1013",NEWS.md;R/options.R;R/roxygenize.R;man/load_options.Rd,False,True,True,False,77,4,81,"---FILE: NEWS.md---
@@ -31,6 +31,15 @@
 * Empty annotations (alternate text) for figures added via markdown are now
   omitted. This caused issues when generating pkgdown web sites (#1051).
 
+* Roxygen metadata can now have a `packages` element, giving a character vector 
+  of package names to load. This makes it easier to use extension package that 
+  provide new tags for existing roclets (#1013). See `?load_options` for
+  more details.
+  
+    ```yaml
+    Roxygen: list(markdown = TRUE, packages = ""roxygenlabs"")
+    ```
+
 * `@evalNamespace()` works again (#1022).
 
 * `@description NULL` and `@details NULL` no longer fail; instead, these tags 

---FILE: R/options.R---
@@ -1,12 +1,46 @@
 #' Load roxygen2 options
 #'
+#' @description
 #' Options can be stored in the `Roxygen` field of the `DESCRIPTION`, or
 #' in `man/roxygen/meta.R`. In either case, the code is parsed and evaluated
 #' in a child of the base environment. Call `roxy_meta_get()` to access
 #' current option values from within tag and roclet methods.
 #'
 #' Options in `man/roxygen/meta.R` override those present in `DESCRIPTION`.
 #'
+#' @section Possible options:
+#'
+#' * `roclets` `<character>`: giving names of roclets to run. See
+#'    [roclet_find()] for details.
+#'
+#' * `packages` `<character>`: packages to load that implement new tags.
+#'
+#' * `load` `<string>`: how to load R code. See [load] for details.
+#'
+#' * `old_usage` `<flag>`: use old style usage formatting?
+#'
+#' * `markdown` `<flag>`: translate markdown syntax to Rd?
+#'
+#' * `r6` `<flag>`: document R6 classes?
+#'
+#' * `current_package` `<string>` (read only): name of package being documented.
+#'
+#' @section How to set:
+#' Either set in `DESCRIPTION`:
+#'
+#' ```
+#' Roxygen: list(markdown = TRUE, load = ""installed"")
+#' ```
+#'
+#' Or if longer, you can put in `/man/roxygen/meta.R`:
+#'
+#' ```
+#' list(
+#'   markdown = TRUE,
+#'   load = ""installed""
+#' )
+#' ```
+#'
 #' @param base_path Path to package.
 #' @export
 #' @keywords internal
@@ -17,11 +51,12 @@ load_options <- function(base_path = ""."") {
 
   defaults <- list(
     roclets = c(""collate"", ""namespace"", ""rd""),
+    packages = character(),
     load = ""pkgload"",
     old_usage = FALSE,
     markdown = FALSE,
     r6 = TRUE,
-    package = NA_character_
+    current_package = NA_character_
   )
 
   unknown_opts <- setdiff(names(opts), names(defaults))
@@ -46,7 +81,7 @@ load_options_description <- function(base_path = ""."") {
     opts <- eval(parse(text = desc_opts), child_env(baseenv()))
   }
 
-  opts$package <- dcf[[1, 2]]
+  opts$current_package <- dcf[[1, 2]]
   opts
 }
 

---FILE: R/roxygenize.R---
@@ -40,6 +40,10 @@ roxygenize <- function(package.dir = ""."",
 
   roxy_meta_load(base_path)
 
+  # Load required packages for method registration
+  packages <- roxy_meta_get(""packages"")
+  lapply(packages, requireNamespace, quietly = TRUE)
+
   roclets <- roclets %||% roxy_meta_get(""roclets"")
   # Special case collate: it doesn't need to execute code, and must be run
   # first to ensure that code can be executed

---FILE: man/load_options.Rd---
@@ -17,8 +17,33 @@ Options can be stored in the \code{Roxygen} field of the \code{DESCRIPTION}, or
 in \code{man/roxygen/meta.R}. In either case, the code is parsed and evaluated
 in a child of the base environment. Call \code{roxy_meta_get()} to access
 current option values from within tag and roclet methods.
-}
-\details{
+
 Options in \code{man/roxygen/meta.R} override those present in \code{DESCRIPTION}.
 }
+\section{Possible options}{
+
+\itemize{
+\item \code{roclets} \verb{<character>}: giving names of roclets to run. See
+\code{\link[=roclet_find]{roclet_find()}} for details.
+\item \code{packages} \verb{<character>}: packages to load that implement new tags.
+\item \code{load} \verb{<string>}: how to load R code. See \link{load} for details.
+\item \code{old_usage} \verb{<flag>}: use old style usage formatting?
+\item \code{markdown} \verb{<flag>}: translate markdown syntax to Rd?
+\item \code{r6} \verb{<flag>}: document R6 classes?
+\item \code{current_package} \verb{<string>} (read only): name of package being documented.
+}
+}
+
+\section{How to set}{
+
+Either set in \code{DESCRIPTION}:\preformatted{Roxygen: list(markdown = TRUE, load = ""installed"")
+}
+
+Or if longer, you can put in \verb{/man/roxygen/meta.R}:\preformatted{list(
+  markdown = TRUE,
+  load = ""installed""
+)
+}
+}
+
 \keyword{internal}"
r-lib,roxygen2,b87007009df35178b5dfbeae209af07f373113e8,Hadley Wickham,h.wickham@gmail.com,2020-03-10T19:29:21Z,Hadley Wickham,h.wickham@gmail.com,2020-03-10T19:30:51Z,"Fix author_desc() comment stripping

And improve testing situation",R/object-package.R;tests/testthat/test-object-package-author.txt;tests/testthat/test-object-package.R,False,True,True,False,33,26,59,"---FILE: R/object-package.R---
@@ -36,6 +36,10 @@ package_authors <- function(desc) {
 }
 
 author_desc <- function(x) {
+  if (inherits(x, ""person"")) {
+    stop(""person class must be stripped"", call. = FALSE)
+  }
+
   desc <- paste0(x$given, collapse = "" "")
 
   if (!is.null(x$family)) {
@@ -55,7 +59,7 @@ author_desc <- function(x) {
       } else {
         desc <- paste0(desc, "" (\\href{https://orcid.org/"", orcid, ""}{ORCID})"")
       }
-      x$comment <- x$comment[setdiff(x$comment, ""ORCID"")]
+      x$comment <- x$comment[!names(x$comment) %in% ""ORCID""]
     }
 
     if (length(x$comment) > 0) {

---FILE: tests/testthat/test-object-package-author.txt---
@@ -1,8 +1,18 @@
-> hw1 <- person(""H"", ""W"", , ""h@w.com"", ""aut"", c(ORCID = ""1234""))
-> author_desc(hw1)
+> # Multiple given/family names
+> person_desc(c(""First"", ""Second""), c(""Family1"", ""Family2""))
+[1] ""First Second Family1 Family2 \\email{h@w.com}""
+
+> # Multiple roles
+> person_desc(role = ""ctb"")
+[1] ""H W \\email{h@w.com} [contributor]""
+
+> # ORCID comments
+> person_desc(comment = c(ORCID = ""1234""))
 [1] ""H W \\email{h@w.com} (\\href{https://orcid.org/1234}{ORCID})""
 
-> hw2 <- person(""H"", ""W"", , ""h@w.com"", ""aut"", c(ORCID = ""https://orcid.org/1234""))
-> author_desc(hw2)
+> person_desc(comment = c(ORCID = ""https://orcid.org/1234""))
 [1] ""H W \\email{h@w.com} (\\href{https://orcid.org/1234}{ORCID})""
 
+> person_desc(comment = c(ORCID = ""1234"", ""extra""))
+[1] ""H W \\email{h@w.com} (\\href{https://orcid.org/1234}{ORCID}) (extra)""
+

---FILE: tests/testthat/test-object-package.R---
@@ -1,26 +1,19 @@
-test_that(""author with more than one given/family name "", {
-  expect_equal(
-    author_desc(
-      person(
-        given = c(""First"", ""Second""),
-        family = c(""Family1"", ""Family2""),
-        email = ""first.second.family@email.tld""
-      )
-    ),
-    paste(
-      ""First Second"",
-      ""Family1 Family2"",
-      ""\\email{first.second.family@email.tld}""
-    )
-  )
-})
-
 test_that(""person turned into meaningful text"", {
+  person_desc <- function(given = ""H"", family = ""W"", email = ""h@w.com"", role = ""aut"", comment = NULL) {
+    out <- person(given = given, family = family, email = email, role = role, comment = comment)
+    author_desc(unclass(out)[[1]])
+  }
+
   verify_output(test_path(""test-object-package-author.txt""), {
-    hw1 <- person(""H"", ""W"", , ""h@w.com"", ""aut"", c(""ORCID"" = ""1234""))
-    author_desc(hw1)
+    ""Multiple given/family names""
+    person_desc(c(""First"", ""Second""), c(""Family1"", ""Family2""))
+
+    ""Multiple roles""
+    person_desc(role = ""ctb"")
 
-    hw2 <- person(""H"", ""W"", , ""h@w.com"", ""aut"", c(""ORCID"" = ""https://orcid.org/1234""))
-    author_desc(hw2)
+    ""ORCID comments""
+    person_desc(comment = c(""ORCID"" = ""1234""))
+    person_desc(comment = c(""ORCID"" = ""https://orcid.org/1234""))
+    person_desc(comment = c(""ORCID"" = ""1234"", ""extra""))
   })
 })"
r-lib,roxygen2,e86cebf914331f580cc96c3f26a6cd203f82b1be,Metin Yazici,stradivariusboul@gmail.com,2020-03-10T18:41:50Z,GitHub,noreply@github.com,2020-03-10T18:41:50Z,"Fix small typos in the introduction vignette (#1005)

RCpp -> Rcpp
hand written -> handwritten",vignettes/roxygen2.Rmd,True,False,True,False,1,1,2,"---FILE: vignettes/roxygen2.Rmd---
@@ -46,7 +46,7 @@ There are three main ways to run roxygen:
 
 * `Ctrl + Shift + D`, if you're using RStudio.
 
-You can mix hand written Rd and roxygen2; roxygen2 will never overwrite a file it didn't create. 
+You can mix handwritten Rd and roxygen2; roxygen2 will never overwrite a file it didn't create. 
 
 ## Basic process
 "
r-lib,roxygen2,357d856f6ccdb96b7a95b42bf747cf10e2a26fb3,Hadley Wickham,h.wickham@gmail.com,2020-03-10T18:03:51Z,GitHub,noreply@github.com,2020-03-10T18:03:51Z,"Support documenting delayedAssign() (#1058)

Fixes #1041",NEWS.md;R/object-from-call.R;tests/testthat/test-object-from-call.R,False,True,True,False,16,0,16,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* Can now document objects created with `delayedAssign()` by forcing
+  evaluation at documentation time (#1041)
+
 * `evalNamespace()` works again (#1022).
 
 * roxygen2 now keeps using Windows (CR LF) line endings for files that

---FILE: R/object-from-call.R---
@@ -12,6 +12,7 @@ object_from_call <- function(call, env, block, file) {
       ""="" = ,
       ""<-"" = ,
       ""<<-"" = parser_assignment(call, env, block),
+      ""delayedAssign"" = parser_delayedAssign(call, env, block),
       ""::"" = parser_import(call, env, block),
 
       ""methods::setClass"" = ,
@@ -111,6 +112,11 @@ parser_assignment <- function(call, env, block) {
   object_from_name(name, env, block)
 }
 
+parser_delayedAssign <- function(call, env, block) {
+  name <- as.character(call$x)
+  object_from_name(name, env, block)
+}
+
 parser_setClass <- function(call, env, block) {
   name <- as.character(call$Class)
   value <- methods::getClass(name, where = env)

---FILE: tests/testthat/test-object-from-call.R---
@@ -112,6 +112,13 @@ test_that(""ignored compound assignment"", {
   expect_null(obj)
 })
 
+test_that(""finds function created with delayed assignment"", {
+  obj <- call_to_object({
+    delayedAssign(""foo"", function(x, y, z) {})
+  })
+  expect_s3_class(obj, ""function"")
+})
+
 # S4 ----------------------------------------------------------------------
 
 test_that(""finds S4 and RC classes"", {"
r-lib,roxygen2,ee93506dbb81b5105f6f12385549cffac025a6a3,Hadley Wickham,h.wickham@gmail.com,2020-03-10T15:32:30Z,Hadley Wickham,h.wickham@gmail.com,2020-03-10T15:32:39Z,"Don't run evalNamespace in roclet_preprocess

Fixes #1022",NEWS.md;R/namespace.R;man/figures/test-figure-1.png;tests/testthat/test-namespace.R;tests/testthat/testNamespace/DESCRIPTION;tests/testthat/testNamespace/NAMESPACE;tests/testthat/testNamespace/R/a.r;vignettes/namespace.Rmd,True,True,True,False,34,3,37,"---FILE: NEWS.md---
@@ -1,5 +1,7 @@
 # roxygen2 (development version)
 
+* `evalNamespace()` works again (#1022).
+
 * roxygen2 now keeps using Windows (CR LF) line endings for files that
   already have CR LF line endings, and uses LF for new files (#989).
 

---FILE: R/namespace.R---
@@ -32,8 +32,7 @@ namespace_roclet <- function() {
 
 #' @export
 roclet_preprocess.roclet_namespace <- function(x, blocks, base_path) {
-
-  lines <- blocks_to_ns(blocks, env, import_only = TRUE)
+  lines <- blocks_to_ns(blocks, emptyenv(), import_only = TRUE)
   NAMESPACE <- file.path(base_path, ""NAMESPACE"")
 
   if (length(lines) == 0 && !made_by_roxygen(NAMESPACE)) {
@@ -101,6 +100,10 @@ roxy_tag_parse.roxy_tag_evalNamespace <- function(x) {
 }
 #' @export
 roxy_tag_ns.roxy_tag_evalNamespace <- function(x, block, env, import_only = FALSE) {
+  if (import_only) {
+    return()
+  }
+
   roxy_tag_eval(x, env)
 }
 

---FILE: tests/testthat/test-namespace.R---
@@ -1,3 +1,10 @@
+test_that(""end-to-end NAMESPACE generation works"", {
+  expect_output(roxygenise(test_path(""testNamespace""), ""namespace"", clean = TRUE))
+
+  ns <- read_lines(test_path(""testNamespace/NAMESPACE""))
+  expect_length(ns, 4)
+})
+
 # @export -----------------------------------------------------------------
 
 test_that(""export quote object name appropriate"", {

---FILE: tests/testthat/testNamespace/DESCRIPTION---
@@ -0,0 +1,9 @@
+Package: testNamespace
+Title: Check that utf8 escapes are round tripped ok
+License: GPL-2
+Description:
+Author: Hadley <hadley@rstudio.com>
+Maintainer: Hadley <hadley@rstudio.com>
+Encoding: UTF-8
+Version: 0.1
+RoxygenNote: 7.0.2.9000

---FILE: tests/testthat/testNamespace/NAMESPACE---
@@ -0,0 +1,4 @@
+# Generated by roxygen2: do not edit by hand
+
+export(f)
+export(g)

---FILE: tests/testthat/testNamespace/R/a.r---
@@ -0,0 +1,6 @@
+#' @export
+f <- function(x) x
+
+
+#' @evalNamespace ""export(g)""
+g <- function() 1

---FILE: vignettes/namespace.Rmd---
@@ -79,7 +79,7 @@ Generally, roxygen2 can generate the correct namespace directive when `@export`i
 * `@exportMethod foo` generates `exportMethods(foo)`
 * `@exportPattern foo` generates `exportPattern(foo)`
 
-For even more specialised cases you can use `@rawNamespace code` which inserts `code` literally into the `NAMESPACE`. If you need to automate this, `@evalNamespace foo()` will evaluate the `foo()` in the package environment and insert the results into `NAMESPACE`.
+For even more specialised cases you can use `@rawNamespace code` which inserts `code` literally into the `NAMESPACE`. If you need to automate this, `@evalNamespace foo()` will evaluate the `foo()` in the package environment and insert the results into `NAMESPACE`. Because `evalNamespace()` is run in the package environment, it can only generate exports, not imports.
 
 ## Imports
 "
r-lib,roxygen2,d79cb53965a02d033fa9186196036328ce70ff17,Hadley Wickham,h.wickham@gmail.com,2020-03-09T22:27:56Z,Hadley Wickham,h.wickham@gmail.com,2020-03-09T22:29:35Z,"Tweak wrapping

Fixes #929",src/wrapUsage.cpp,False,False,False,False,3,2,5,"---FILE: src/wrapUsage.cpp---
@@ -52,15 +52,16 @@ std::string wrapUsage(std::string string, int width = 80, int indent = 2) {
   for (int i = 0; i < n; ++i) {
     int piece_width = pieces[i].size();
 
-    if (piece_width + cur_width < width) {
+    // Need to include space for a space
+    if (piece_width + cur_width + 1 < width) {
       cur_width += piece_width;
       if (i != 0) {
         out += "" "";
         cur_width++;
       }
     } else {
       cur_width = piece_width + indent;
-      out += ""\n"" + std::string(indent, ' ') ;
+      out += ""\n"" + std::string(indent, ' ');
     }
     out += pieces[i];
   }"
r-lib,roxygen2,b4ddce109bf38552d5414ef117087b7685707b9d,Hugo Gruson,hugo.gruson@protonmail.com,2020-03-07T07:53:36Z,Hugo Gruson,hugo.gruson@protonmail.com,2020-03-07T07:53:36Z,Fix typos,NEWS.md;vignettes/rd-formatting.Rmd,True,False,True,False,3,3,6,"---FILE: NEWS.md---
@@ -210,7 +210,7 @@ You can override the default either by calling (e.g.) `roxygenise(load_code = ""s
   released 2014-05-02, over 5 years ago.
 
 * Using the old `wrap` option will now trigger a warning, as hasn't worked
-  for quite some time. Supress the error by deleting the option from your
+  for quite some time. Suppress the error by deleting the option from your
   `DESCRIPTION`.
 
 ### Extending roxygen2

---FILE: vignettes/rd-formatting.Rmd---
@@ -285,9 +285,9 @@ For example, the following will insert the date and the R version of the roxygen
 ```
 
 The value of the R expression is converted to a character string, with `paste(collapse = ""\n"")`.
-So you don't need expicitly convert to a character value, numeric values or any R object with an `as.character()` S3 method is fine.
+So you don't need explicitly convert to a character value, numeric values or any R object with an `as.character()` S3 method is fine.
 Also, you can insert multiple lines by returning a character vector.
-If you want to run R code without inseringt any output, return an empty string or `NULL`.
+If you want to run R code without inserting any output, return an empty string or `NULL`.
 
 The value of the expression is inserted into the text of the tag without interpreting it, before the markdown to `.Rd` conversion, so you can create markdown markup dynamically:
 "
r-lib,roxygen2,01682a99f7be6ee6747ddc82194a1118b4961ee1,G치bor Cs치rdi,csardi.gabor@gmail.com,2020-03-06T13:21:35Z,G치bor Cs치rdi,csardi.gabor@gmail.com,2020-03-06T13:23:25Z,"Fix \figure{} output from md when alternate text is empty

Then we need to leave out the second \figure{} argument,
according to WRE. This fixes pkgdown on roxygen2.

Closes #1051.",NEWS.md;R/markdown.R;man/markdown_pass1.Rd,False,True,True,False,9,2,11,"---FILE: NEWS.md---
@@ -13,6 +13,10 @@
 
 * Multiple `@format` tags are now combined (#1015).
 
+* roxygen2 now omits empty annotations (alternate text) for figures added
+  via markdown. This caused issues when generating pkgdown web sites
+  (#1051).
+
 # roxygen2 7.0.2
 
 * `\example{}` escaping has been improved (again!) so that special escapes 

---FILE: R/markdown.R---
@@ -348,7 +348,10 @@ mdxml_link_text <- function(xml_contents, state) {
 mdxml_image = function(xml) {
   dest <- xml_attr(xml, ""destination"")
   title <- xml_attr(xml, ""title"")
-  paste0(""\\figure{"", dest, ""}{"", title, ""}"")
+  paste0(
+    ""\\figure{"", dest, ""}"",
+    if (nchar(title)) paste0(""{"", title, ""}"")
+  )
 }
 
 escape_comment <- function(x) {

---FILE: man/markdown_pass1.Rd---
@@ -44,6 +44,6 @@ nrow(mtcars)
 Plots:\if{html}{\out{<div class=""r"">}}\preformatted{plot(1:10)
 }\if{html}{\out{</div>}}
 
-\figure{test-figure-1.png}{}
+\figure{test-figure-1.png}
 }
 \keyword{internal}"
r-lib,roxygen2,3d0c7f74a44b898a1dbf3620b4d6f0430223c27a,Hadley Wickham,h.wickham@gmail.com,2020-03-06T13:18:37Z,GitHub,noreply@github.com,2020-03-06T13:18:37Z,"Combine multiple format tags (#1049)

Fixes #1015",NEWS.md;R/rd-markdown.R;tests/testthat/test-rd-markdown.R,False,True,True,False,4,4,8,"---FILE: NEWS.md---
@@ -11,6 +11,8 @@
 * roxygen2 now adds hyperlinks to R6 methods in the PDF manual as well,
   (#1006).
 
+* Multiple `@format` tags are now combined (#1015).
+
 # roxygen2 7.0.2
 
 * `\example{}` escaping has been improved (again!) so that special escapes 

---FILE: R/rd-markdown.R---
@@ -19,7 +19,7 @@ roxy_tag_rd.roxy_tag_format <- function(x, base_path, env) {
 }
 #' @export
 format.rd_section_format <- function(x, ...) {
-  format_first(x, ...)
+  format_collapse(x, ...)
 }
 
 #' @export

---FILE: tests/testthat/test-rd-markdown.R---
@@ -32,7 +32,6 @@ test_that(""@format NULL suppresses default usage"", {
     #' Title
     #'
     #' @format NULL
-    #'
     x <- list(a = 1, b = 2)"")[[1]]
 
   expect_equal(out$get_value(""format""), NULL)
@@ -42,10 +41,9 @@ test_that(""@format not escaped"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' Title
     #' @format %
-    #'
     x <- list(a = 1, b = 2)"")[[1]]
 
   expect_equal(out$get_value(""format""), ""%"")
-  expect_equal(out$get_rd(""format""), ""\\format{%}"")
+  expect_equal(out$get_rd(""format""), ""\\format{\n%\n}"")
 })
 "
r-lib,roxygen2,e98a2b46b4eab31393c6749a4d235145a66a882c,G치bor Cs치rdi,csardi.gabor@gmail.com,2020-03-06T12:48:25Z,G치bor Cs치rdi,csardi.gabor@gmail.com,2020-03-06T12:48:25Z,"Fix object format test case for R 4.x

Matrices now inherit from ""array"", so that
is included in the output.

Closes #1052.",tests/testthat/test-object-format-r4.txt;tests/testthat/test-object-format.R,False,True,True,False,21,1,22,"---FILE: tests/testthat/test-object-format-r4.txt---
@@ -0,0 +1,15 @@
+> call_to_format(x <- list(a = 1, b = 2))
+[1] ""An object of class \\code{list} of length 2.""
+
+> call_to_format(x <- ordered(letters[1:5]))
+[1] ""An object of class \\code{ordered} (inherits from \\code{factor}) of length 5.""
+
+> call_to_format(x <- diag(10))
+[1] ""An object of class \\code{matrix} (inherits from \\code{array}) with 10 rows and 10 columns.""
+
+> call_to_format(x <- array(1:27, dim = c(3, 3, 3)))
+[1] ""An object of class \\code{array} of dimension 3 x 3 x 3.""
+
+> call_to_format(x <- data.frame(a = 1, b = 2))
+[1] ""An object of class \\code{data.frame} with 1 rows and 2 columns.""
+

---FILE: tests/testthat/test-object-format.R---
@@ -1,5 +1,10 @@
 test_that(""format has nice defaults for bare vectors"", {
-  verify_output(test_path(""test-object-format.txt""), {
+  if (getRversion() >= ""4.0.0"") {
+    txt <- ""test-object-format-r4.txt""
+  } else {
+    txt <- ""test-object-format.txt""
+  }
+  verify_output(test_path(txt), {
     call_to_format(x <- list(a = 1, b = 2))
     call_to_format(x <- ordered(letters[1:5]))
     call_to_format(x <- diag(10))"
r-lib,roxygen2,a06c84d15a7791a6f61d7be5715123c00496236e,G치bor Cs치rdi,csardi.gabor@gmail.com,2020-03-06T11:15:34Z,G치bor Cs치rdi,csardi.gabor@gmail.com,2020-03-06T11:15:34Z,Improve error msg for R class without srcrefs,R/object-r6.R,False,True,True,False,10,1,11,"---FILE: R/object-r6.R---
@@ -44,7 +44,16 @@ extract_r6_methods <- function(x) {
     x$public_methods[method_nms],
     function(m) {
       ref <- utils::getSrcref(m)
-      if (is.null(ref)) stop(""R6 class without source references. Try re-installing with installation option '--with-keep.source'."")
+      if (is.null(ref)) {
+        name <- x$classname %||% NA
+        stop(
+          ""R6 class "", if (!is.na(name)) paste0(""("", name, "") ""),
+          ""without source references. "",
+          ""If you use the `installed` load method in `DESCRIPTION`, then "",
+          ""try re-installing the package with option '--with-keep.source'. "",
+          ""E.g. `install.packages(..., INSTALL_OPTS = \""--with-keep.source\"")`.""
+        )
+      }
       utils::getSrcLocation(ref)
     }
   )"
r-lib,roxygen2,26fb9339c03d02e092f580e1745a02aa4c13aa05,G치bor Cs치rdi,csardi.gabor@gmail.com,2019-12-12T22:19:28Z,G치bor Cs치rdi,csardi.gabor@gmail.com,2020-03-06T10:45:27Z,"Fix internal R6 links in LaTeX / PDF

Closes #1006.",NEWS.md;R/rd-r6.R;man/RoxyTopic.Rd;tests/testthat/roxygen-block-3-A.Rd;tests/testthat/roxygen-block-3-B.Rd;tests/testthat/roxygen-block-3-C.Rd,False,True,True,False,26,0,26,"---FILE: NEWS.md---
@@ -8,6 +8,9 @@
   package level documentation, where it can be used to suppress the
   auto-generated Description section (#1008).
 
+* roxygen2 now adds hyperlinks to R6 methods in the PDF manual as well,
+  (#1006).
+
 # roxygen2 7.0.2
 
 * `\example{}` escaping has been improved (again!) so that special escapes 

---FILE: R/rd-r6.R---
@@ -280,6 +280,7 @@ r6_method_begin <- function(block, method) {
   c(
     ""\\if{html}{\\out{<hr>}}"",
     paste0(""\\if{html}{\\out{<a id=\""method-"", nm, ""\""></a>}}""),
+    paste0(""\\if{latex}{\\out{\\hypertarget{method-"", nm, ""}{}}}""),
     paste0(""\\subsection{Method \\code{"", nm, ""()}}{"")
   )
 }

---FILE: man/RoxyTopic.Rd---
@@ -36,6 +36,7 @@ A \code{RoxyTopic} object corresponds to a generated \code{.Rd} file.
 }
 \if{html}{\out{<hr>}}
 \if{html}{\out{<a id=""method-format""></a>}}
+\if{latex}{\out{\hypertarget{method-format}{}}}
 \subsection{Method \code{format()}}{
 Format the \code{.Rd} file. It considers the sections in
 particular order, even though Rd tools will reorder them again.
@@ -57,6 +58,7 @@ Character string.
 }
 \if{html}{\out{<hr>}}
 \if{html}{\out{<a id=""method-is_valid""></a>}}
+\if{latex}{\out{\hypertarget{method-is_valid}{}}}
 \subsection{Method \code{is_valid()}}{
 Check if an \code{.Rd} file is valid
 \subsection{Usage}{
@@ -69,6 +71,7 @@ Logical flag, \code{TRUE} for valid \code{.Rd} files
 }
 \if{html}{\out{<hr>}}
 \if{html}{\out{<a id=""method-has_section""></a>}}
+\if{latex}{\out{\hypertarget{method-has_section}{}}}
 \subsection{Method \code{has_section()}}{
 Check if an \code{.Rd} file has a certain section.
 \subsection{Usage}{
@@ -88,6 +91,7 @@ Logical flag.
 }
 \if{html}{\out{<hr>}}
 \if{html}{\out{<a id=""method-get_section""></a>}}
+\if{latex}{\out{\hypertarget{method-get_section}{}}}
 \subsection{Method \code{get_section()}}{
 Query a section.
 \subsection{Usage}{
@@ -108,6 +112,7 @@ if the topic has no such section.
 }
 \if{html}{\out{<hr>}}
 \if{html}{\out{<a id=""method-get_value""></a>}}
+\if{latex}{\out{\hypertarget{method-get_value}{}}}
 \subsection{Method \code{get_value()}}{
 Query the value of a section. This is the value of
 the \link{rd_section} object.
@@ -128,6 +133,7 @@ Value.
 }
 \if{html}{\out{<hr>}}
 \if{html}{\out{<a id=""method-get_rd""></a>}}
+\if{latex}{\out{\hypertarget{method-get_rd}{}}}
 \subsection{Method \code{get_rd()}}{
 Get the Rd code of a section.
 \subsection{Usage}{
@@ -147,6 +153,7 @@ Character vector, one element per line.
 }
 \if{html}{\out{<hr>}}
 \if{html}{\out{<a id=""method-get_name""></a>}}
+\if{latex}{\out{\hypertarget{method-get_name}{}}}
 \subsection{Method \code{get_name()}}{
 Get the value of the \code{name} section. This is the name
 of the Rd topic.
@@ -160,6 +167,7 @@ Character scalar.
 }
 \if{html}{\out{<hr>}}
 \if{html}{\out{<a id=""method-inherits_from""></a>}}
+\if{latex}{\out{\hypertarget{method-inherits_from}{}}}
 \subsection{Method \code{inherits_from()}}{
 Query the topics this topic inherits \code{type} from.
 \subsection{Usage}{
@@ -179,6 +187,7 @@ A character vector of topic names.
 }
 \if{html}{\out{<hr>}}
 \if{html}{\out{<a id=""method-inherits_section_from""></a>}}
+\if{latex}{\out{\hypertarget{method-inherits_section_from}{}}}
 \subsection{Method \code{inherits_section_from()}}{
 Query the topics this topic inherits sections from.
 \subsection{Usage}{
@@ -191,6 +200,7 @@ A character vector of topic names.
 }
 \if{html}{\out{<hr>}}
 \if{html}{\out{<a id=""method-add""></a>}}
+\if{latex}{\out{\hypertarget{method-add}{}}}
 \subsection{Method \code{add()}}{
 Add one or more sections to the topic.
 \subsection{Usage}{
@@ -213,6 +223,7 @@ then the two sections will be merged.}
 }
 \if{html}{\out{<hr>}}
 \if{html}{\out{<a id=""method-add_section""></a>}}
+\if{latex}{\out{\hypertarget{method-add_section}{}}}
 \subsection{Method \code{add_section()}}{
 Add a section.
 \subsection{Usage}{
@@ -237,6 +248,7 @@ once in \code{self$sections}. This method if for internal use only.
 }
 \if{html}{\out{<hr>}}
 \if{html}{\out{<a id=""method-clone""></a>}}
+\if{latex}{\out{\hypertarget{method-clone}{}}}
 \subsection{Method \code{clone()}}{
 The objects of this class are cloneable with this method.
 \subsection{Usage}{

---FILE: tests/testthat/roxygen-block-3-A.Rd---
@@ -57,6 +57,7 @@ Class A details
 }
 \if{html}{\out{<hr>}}
 \if{html}{\out{<a id=""method-meth1""></a>}}
+\if{latex}{\out{\hypertarget{method-meth1}{}}}
 \subsection{Method \code{meth1()}}{
 A method 1.
 \subsection{Usage}{
@@ -81,6 +82,7 @@ A method 1.
 }
 \if{html}{\out{<hr>}}
 \if{html}{\out{<a id=""method-meth2""></a>}}
+\if{latex}{\out{\hypertarget{method-meth2}{}}}
 \subsection{Method \code{meth2()}}{
 Method 2 description.
 \subsection{Usage}{
@@ -111,6 +113,7 @@ Method 2 details.
 }
 \if{html}{\out{<hr>}}
 \if{html}{\out{<a id=""method-meth3""></a>}}
+\if{latex}{\out{\hypertarget{method-meth3}{}}}
 \subsection{Method \code{meth3()}}{
 \subsection{Usage}{
 \if{html}{\out{<div class=""r"">}}\preformatted{A$meth3(duplicate, missing)}\if{html}{\out{</div>}}
@@ -135,6 +138,7 @@ twice.
 }
 \if{html}{\out{<hr>}}
 \if{html}{\out{<a id=""method-clone""></a>}}
+\if{latex}{\out{\hypertarget{method-clone}{}}}
 \subsection{Method \code{clone()}}{
 The objects of this class are cloneable with this method.
 \subsection{Usage}{

---FILE: tests/testthat/roxygen-block-3-B.Rd---
@@ -51,6 +51,7 @@ Class B details.
 }
 \if{html}{\out{<hr>}}
 \if{html}{\out{<a id=""method-meth1""></a>}}
+\if{latex}{\out{\hypertarget{method-meth1}{}}}
 \subsection{Method \code{meth1()}}{
 B method 1.
 \subsection{Usage}{
@@ -67,6 +68,7 @@ B method 1.
 }
 \if{html}{\out{<hr>}}
 \if{html}{\out{<a id=""method-meth4""></a>}}
+\if{latex}{\out{\hypertarget{method-meth4}{}}}
 \subsection{Method \code{meth4()}}{
 A method 4.
 \subsection{Usage}{
@@ -76,6 +78,7 @@ A method 4.
 }
 \if{html}{\out{<hr>}}
 \if{html}{\out{<a id=""method-clone""></a>}}
+\if{latex}{\out{\hypertarget{method-clone}{}}}
 \subsection{Method \code{clone()}}{
 The objects of this class are cloneable with this method.
 \subsection{Usage}{

---FILE: tests/testthat/roxygen-block-3-C.Rd---
@@ -62,6 +62,7 @@ Classs C details.
 }
 \if{html}{\out{<hr>}}
 \if{html}{\out{<a id=""method-meth2""></a>}}
+\if{latex}{\out{\hypertarget{method-meth2}{}}}
 \subsection{Method \code{meth2()}}{
 C method 2.
 \subsection{Usage}{
@@ -80,6 +81,7 @@ C method 2.
 }
 \if{html}{\out{<hr>}}
 \if{html}{\out{<a id=""method-meth5""></a>}}
+\if{latex}{\out{\hypertarget{method-meth5}{}}}
 \subsection{Method \code{meth5()}}{
 C method 5.
 \subsection{Usage}{
@@ -89,6 +91,7 @@ C method 5.
 }
 \if{html}{\out{<hr>}}
 \if{html}{\out{<a id=""method-undocumented_method""></a>}}
+\if{latex}{\out{\hypertarget{method-undocumented_method}{}}}
 \subsection{Method \code{undocumented_method()}}{
 \subsection{Usage}{
 \if{html}{\out{<div class=""r"">}}\preformatted{C$undocumented_method()}\if{html}{\out{</div>}}"
r-lib,roxygen2,8ce5015ae674b947888861603bdcea644e62f97d,G치bor Cs치rdi,csardi.gabor@gmail.com,2019-12-13T16:46:43Z,G치bor Cs치rdi,csardi.gabor@gmail.com,2020-03-06T10:15:49Z,"Fix crash when @description or @details are NULL

Now they are ignored, except for `@description NULL` in
package level documentation, where it can be used to suppress the
auto-generated Description section

Closes #1008.",NEWS.md;R/rd.R;R/topic.R;tests/testthat/test-rd.R,False,True,True,False,87,1,88,"---FILE: NEWS.md---
@@ -3,6 +3,11 @@
 * roxygen2 now keeps using Windows (CR LF) line endings for files that
   already have CR LF line endings, and uses LF for new files (#989).
 
+* roxygen2 now does not fail for `@description NULL` and `@details NULL`.
+  Instead, these tags are ignored, except for `@description NULL` in
+  package level documentation, where it can be used to suppress the
+  auto-generated Description section (#1008).
+
 # roxygen2 7.0.2
 
 * `\example{}` escaping has been improved (again!) so that special escapes 

---FILE: R/rd.R---
@@ -191,7 +191,8 @@ topics_add_default_description <- function(topics) {
       next
 
     # rexport manually generates a own description, so don't need to
-    if (!topic$has_section(""reexport"")) {
+    if (!topic$has_section(""reexport"") &&
+        !identical(topic$get_value(""docType""), ""package"")) {
       topic$add(rd_section(""description"", topic$get_value(""title"")))
     }
   }

---FILE: R/topic.R---
@@ -148,6 +148,7 @@ RoxyTopic <- R6::R6Class(""RoxyTopic"", public = list(
   #' @param section [rd_section] object to add.
 
   add_section = function(section, overwrite = FALSE) {
+    if (is.null(section)) return()
     type <- section$type
     if (self$has_section(type) && !overwrite) {
       section <- merge(self$get_section(type), section)

---FILE: tests/testthat/test-rd.R---
@@ -59,6 +59,85 @@ test_that(""documenting NA gives useful error message (#194)"", {
   )
 })
 
+test_that(""@description NULL"", {
+  # Just ignore in this case
+  out <- roxygen2::roc_proc_text(roxygen2::rd_roclet(), ""
+    #' Title
+    #'
+    #' @description NULL
+    #' @format NULL
+    foobar <- 1:10
+  "")
+  expect_identical(out[[1]]$get_value(""description""), ""Title"")
+
+  # Still ignore
+  out <- roxygen2::roc_proc_text(roxygen2::rd_roclet(), ""
+    #' Title
+    #' @description NULL
+    #' @description desc
+    #' @format NULL
+    foobar <- 1:10
+  "")
+  expect_identical(out[[1]]$get_value(""description""), ""desc"")
+
+  # Still ignore for objects as well
+  out <- roxygen2::roc_proc_text(roxygen2::rd_roclet(), ""
+    #' Title
+    #' @description NULL
+    #' @format NULL
+    foobar <- 1:10
+  "")
+  expect_identical(out[[1]]$get_value(""description""), ""Title"")
+
+  # But drop for package docs
+  with_mock(
+    `roxygen2::read.description` = function(...)
+      list(Package = ""roxygen_devtest"",
+           Title = ""Package Title"",
+           Description = ""Package description.""),
+    out <- roxygen2::roc_proc_text(roxygen2::rd_roclet(), ""
+      #' Title
+      #'
+      #' @docType package
+      #' @description NULL
+      #' @name pkg
+      '_PACKAGE'
+    "")
+  )
+  expect_null(out[[1]]$get_value(""description""))
+})
+
+test_that(""@details NULL"", {
+  # Just ignore in this case
+  out <- roxygen2::roc_proc_text(roxygen2::rd_roclet(), ""
+    #' Title
+    #'
+    #' @details NULL
+    #' @format NULL
+    foobar <- 1:10
+  "")
+  expect_null(out[[1]]$get_value(""details""))
+
+  # Still ignore
+  out <- roxygen2::roc_proc_text(roxygen2::rd_roclet(), ""
+    #' Title
+    #' @details NULL
+    #' @details desc
+    #' @format NULL
+    foobar <- 1:10
+  "")
+  expect_identical(out[[1]]$get_value(""details""), ""desc"")
+
+  # Still ignore for objects as well
+  out <- roxygen2::roc_proc_text(roxygen2::rd_roclet(), ""
+    #' Title
+    #' @details NULL
+    #' @format NULL
+    foobar <- 1:10
+  "")
+  expect_null(out[[1]]$get_value(""details""))
+})
+
 # UTF-8 -------------------------------------------------------------------
 
 test_that(""can generate nonASCII document"", {"
r-lib,roxygen2,32fd6ff6059f61fd60c29fd62060df6035118d11,Hadley Wickham,h.wickham@gmail.com,2020-03-06T00:01:25Z,Hadley Wickham,h.wickham@gmail.com,2020-03-06T00:01:35Z,"Switch to github actions

Fixes #1050",.github/workflows/R-CMD-check.yaml;.github/workflows/pkgdown.yaml;.travis.yml;README.md;appveyor.yml;azure-pipelines.yml;codecov.yml,False,False,False,False,125,74,199,"---FILE: .github/workflows/R-CMD-check.yaml---
@@ -0,0 +1,86 @@
+on:
+  push:
+    branches:
+      - master
+  pull_request:
+    branches:
+      - master
+
+name: R-CMD-check
+
+jobs:
+  R-CMD-check:
+    runs-on: ${{ matrix.config.os }}
+
+    name: ${{ matrix.config.os }} (${{ matrix.config.r }})
+
+    strategy:
+      fail-fast: false
+      matrix:
+        config:
+          - {os: windows-latest, r: '3.6'}
+          - {os: macOS-latest, r: '3.6'}
+          - {os: macOS-latest, r: 'devel'}
+          - {os: ubuntu-16.04, r: '3.2', cran: ""https://demo.rstudiopm.com/all/__linux__/xenial/latest""}
+          - {os: ubuntu-16.04, r: '3.3', cran: ""https://demo.rstudiopm.com/all/__linux__/xenial/latest""}
+          - {os: ubuntu-16.04, r: '3.4', cran: ""https://demo.rstudiopm.com/all/__linux__/xenial/latest""}
+          - {os: ubuntu-16.04, r: '3.5', cran: ""https://demo.rstudiopm.com/all/__linux__/xenial/latest""}
+          - {os: ubuntu-16.04, r: '3.6', cran: ""https://demo.rstudiopm.com/all/__linux__/xenial/latest""}
+
+    env:
+      R_REMOTES_NO_ERRORS_FROM_WARNINGS: true
+      CRAN: ${{ matrix.config.cran }}
+
+    steps:
+      - uses: actions/checkout@v2
+
+      - uses: r-lib/actions/setup-r@master
+        with:
+          r-version: ${{ matrix.config.r }}
+
+      - uses: r-lib/actions/setup-pandoc@master
+
+      - name: Query dependencies
+        run: |
+          install.packages('remotes')
+          saveRDS(remotes::dev_package_deps(dependencies = TRUE), ""depends.Rds"", version = 2)
+        shell: Rscript {0}
+
+      - name: Cache R packages
+        if: runner.os != 'Windows'
+        uses: actions/cache@v1
+        with:
+          path: ${{ env.R_LIBS_USER }}
+          key: ${{ runner.os }}-r-${{ matrix.config.r }}-${{ hashFiles('depends.Rds') }}
+          restore-keys: ${{ runner.os }}-r-${{ matrix.config.r }}-
+
+      - name: Install system dependencies
+        if: runner.os == 'Linux'
+        env:
+          RHUB_PLATFORM: linux-x86_64-ubuntu-gcc
+        run: |
+          Rscript -e ""remotes::install_github('r-hub/sysreqs')""
+          sysreqs=$(Rscript -e ""cat(sysreqs::sysreq_commands('DESCRIPTION'))"")
+          sudo -s eval ""$sysreqs""
+
+      - name: Install dependencies
+        run: |
+          remotes::install_deps(dependencies = TRUE)
+          remotes::install_cran(""rcmdcheck"")
+        shell: Rscript {0}
+
+      - name: Check
+        run: rcmdcheck::rcmdcheck(args = ""--no-manual"", error_on = ""warning"", check_dir = ""check"")
+        shell: Rscript {0}
+
+      - name: Upload check results
+        if: failure()
+        uses: actions/upload-artifact@master
+        with:
+          name: ${{ runner.os }}-r${{ matrix.config.r }}-results
+          path: check
+
+      - name: Test coverage
+        if: matrix.config.os == 'macOS-latest' && matrix.config.r == '3.6'
+        run: covr::codecov(token = ""${{secrets.CODECOV_TOKEN}}"")
+        shell: Rscript {0}

---FILE: .github/workflows/pkgdown.yaml---
@@ -0,0 +1,24 @@
+on:
+  push:
+    branches: master
+
+name: Pkgdown
+
+jobs:
+  pkgdown:
+    runs-on: macOS-latest
+    steps:
+      - uses: actions/checkout@v2
+      - uses: r-lib/actions/setup-r@master
+      - uses: r-lib/actions/setup-pandoc@master
+      - name: Install dependencies
+        run: |
+          install.packages(""remotes"")
+          remotes::install_deps(dependencies = TRUE)
+          remotes::install_dev(""pkgdown"")
+        shell: Rscript {0}
+      - name: Install package
+        run: R CMD INSTALL .
+      - name: Deploy package
+        run: pkgdown::deploy_to_branch(new_process = FALSE)
+        shell: Rscript {0}

---FILE: .travis.yml---
@@ -1,13 +0,0 @@
-# R for travis: see documentation at https://docs.travis-ci.com/user/languages/r
-
-language: R
-cache: packages
-
-matrix:
-  include:
-  - r: release
-    before_cache: Rscript -e 'remotes::install_cran(""pkgdown"")'
-    deploy:
-      provider: script
-      script: Rscript -e 'pkgdown::deploy_site_github()'
-      skip_cleanup: true

---FILE: README.md---
@@ -2,14 +2,13 @@
 
 <!-- badges: start -->
 [![CRAN status](https://www.r-pkg.org/badges/version/roxygen2)](https://CRAN.R-project.org/package=roxygen2)
-[![Azure pipelines build status](https://img.shields.io/azure-devops/build/r-lib/roxygen2/8)](https://dev.azure.com/r-lib/roxygen2/_build/latest?definitionId=1&branchName=master)
-[![Azure pipelines test status](https://img.shields.io/azure-devops/tests/r-lib/roxygen2/8?color=brightgreen&compact_message)](https://dev.azure.com/r-lib/roxygen2/_build/latest?definitionId=1&branchName=master)
-[![Azure pipelines coverage status](https://img.shields.io/azure-devops/coverage/r-lib/roxygen2/8)](https://dev.azure.com/r-lib/roxygen2/_build/latest?definitionId=1&branchName=master)
+[![R build status](https://github.com/r-lib/roxygen2/workflows/R-CMD-check/badge.svg)](https://github.com/r-lib/roxygen2/actions)
+[![Codecov test coverage](https://codecov.io/gh/r-lib/roxygen2/branch/master/graph/badge.svg)](https://codecov.io/gh/r-lib/roxygen2?branch=master)
 <!-- badges: end -->
 
 The premise of roxygen2 is simple: describe your functions in comments next to their definitions and roxygen2 will process your source code and comments to automatically generate `.Rd` files in `man/`, `NAMESPACE`, and, if needed, the `Collate` field in `DESCRIPTION`.
 
-## Installation
+## Installation 
 
 ```R
 # Install devtools from CRAN

---FILE: appveyor.yml---
@@ -1,45 +0,0 @@
-# DO NOT CHANGE the ""init"" and ""install"" sections below
-
-# Download script file from GitHub
-init:
-  ps: |
-        $ErrorActionPreference = ""Stop""
-        Invoke-WebRequest http://raw.github.com/krlmlr/r-appveyor/master/scripts/appveyor-tool.ps1 -OutFile ""..\appveyor-tool.ps1""
-        Import-Module '..\appveyor-tool.ps1'
-
-install:
-  ps: Bootstrap
-
-cache:
-  - C:\RLibrary
-
-# Adapt as necessary starting from here
-
-build_script:
-  - travis-tool.sh install_deps
-
-test_script:
-  - travis-tool.sh run_tests
-
-on_failure:
-  - 7z a failure.zip *.Rcheck\*
-  - appveyor PushArtifact failure.zip
-
-artifacts:
-  - path: '*.Rcheck\**\*.log'
-    name: Logs
-
-  - path: '*.Rcheck\**\*.out'
-    name: Logs
-
-  - path: '*.Rcheck\**\*.fail'
-    name: Logs
-
-  - path: '*.Rcheck\**\*.Rout'
-    name: Logs
-
-  - path: '\*_*.tar.gz'
-    name: Bits
-
-  - path: '\*_*.zip'
-    name: Bits

---FILE: azure-pipelines.yml---
@@ -1,12 +0,0 @@
-# R package
-# Test an R package
-
-resources:
-  repositories:
-    - repository: r-azure-pipelines
-      type: github
-      name: r-lib/r-azure-pipelines
-      endpoint: r-lib
-
-jobs:
-  - template: azure-tidyverse.yml@r-azure-pipelines

---FILE: codecov.yml---
@@ -0,0 +1,12 @@
+comment: false
+
+coverage:
+  status:
+    project:
+      default:
+        target: auto
+        threshold: 1%
+    patch:
+      default:
+        target: auto
+        threshold: 1%"
r-lib,roxygen2,c16ee07ba97587039048dec3647196baa1a6d979,G치bor Cs치rdi,csardi.gabor@gmail.com,2020-01-09T11:42:38Z,G치bor Cs치rdi,csardi.gabor@gmail.com,2020-03-05T16:10:48Z,Fix plot in code blocks,NAMESPACE;R/markdown.R;man/figures/test-figure-1.png;man/markdown_pass1.Rd,False,True,True,False,36,2,38,"---FILE: NAMESPACE---
@@ -241,6 +241,7 @@ import(stringr)
 importFrom(R6,R6Class)
 importFrom(Rcpp,sourceCpp)
 importFrom(knitr,knit)
+importFrom(knitr,opts_chunk)
 importFrom(purrr,keep)
 importFrom(purrr,map)
 importFrom(purrr,map2)

---FILE: R/markdown.R---
@@ -35,6 +35,19 @@ markdown <- function(text, tag = NULL, sections = FALSE) {
 #' x + 1
 #' ```
 #'
+#' Chunk options:
+#'
+#' ```{r results = ""hold""}
+#' names(mtcars)
+#' nrow(mtcars)
+#' ```
+#'
+#' Plots:
+#'
+#' ```{r test-figure}
+#' plot(1:10)
+#' ```
+#'
 #' @param text Input text.
 #' @return Text with the inline code expanded. A character vector of the
 #' same length as the input `text`.
@@ -77,15 +90,23 @@ eval_code_nodes <- function(nodes) {
   # This should only happen in our test cases
   if (is.null(evalenv)) evalenv <- new.env(parent = baseenv())
   map_chr(nodes, eval_code_node, env = evalenv)
-}  
-  
+}
+
+#' @importFrom xml2 xml_name
+#' @importFrom knitr knit opts_chunk
+
 eval_code_node <- function(node, env) {
   if (xml_name(node) == ""code"") {
     text <- str_replace(xml_text(node), ""^r "", """")
     paste(eval(parse(text = text), envir = env), collapse = ""\n"")
 
   } else {
     text <- paste0(""```"", xml_attr(node, ""info""), ""\n"", xml_text(node), ""```\n"")
+    opts_chunk$set(
+      error = FALSE,
+      fig.path = ""man/figures/"",
+      fig.process = function(path) basename(path)
+    )
     knit(text = text, quiet = TRUE, envir = env)
   }
 }

---FILE: man/markdown_pass1.Rd---
@@ -33,5 +33,17 @@ The \code{iris} data set has 5 columns:
 x + 1
 }\if{html}{\out{</div>}}\preformatted{## [1] 101
 }
+
+Chunk options:\if{html}{\out{<div class=""r"">}}\preformatted{names(mtcars)
+nrow(mtcars)
+}\if{html}{\out{</div>}}\preformatted{##  [1] ""mpg""  ""cyl""  ""disp"" ""hp""   ""drat"" ""wt""   ""qsec"" ""vs""   ""am""   ""gear""
+## [11] ""carb""
+## [1] 32
+}
+
+Plots:\if{html}{\out{<div class=""r"">}}\preformatted{plot(1:10)
+}\if{html}{\out{</div>}}
+
+\figure{test-figure-1.png}{}
 }
 \keyword{internal}"
r-lib,roxygen2,b6f39945e3087e215a22632c76631dd65f6a622c,Bill Denney,wdenney@humanpredictions.com,2020-02-17T16:01:21Z,Bill Denney,wdenney@humanpredictions.com,2020-02-17T16:01:21Z,Fix typo in namespace vignette,vignettes/namespace.Rmd,True,False,True,False,1,1,2,"---FILE: vignettes/namespace.Rmd---
@@ -37,7 +37,7 @@ Use the following guidelines to decide what to export:
   generics will not find the correct method.
   
     If you are providing a method for a generic defined in another package,
-    you must also import that generate.
+    you must also import that generic.
 
 * S4 classes: if you want others to be able to extend your class, `@export` it.
   If you want others to create instances of your class, but not extend it,"
r-lib,roxygen2,1099e61d18e932a2717a14873d72391885cacb1a,G치bor Cs치rdi,csardi.gabor@gmail.com,2020-02-10T19:39:34Z,G치bor Cs치rdi,csardi.gabor@gmail.com,2020-02-10T19:39:34Z,Add NEWS for line ending fixes,NEWS.md,False,False,False,False,3,0,3,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* roxygen2 now keeps using Windows (CR LF) line endings for files that
+  already have CR LF line endings, and uses LF for new files (#989).
+
 # roxygen2 7.0.2
 
 * `\example{}` escaping has been improved (again!) so that special escapes "
r-lib,roxygen2,af934dc41c7e1e367276afaf86b121ae64094669,G치bor Cs치rdi,csardi.gabor@gmail.com,2020-02-10T16:23:07Z,G치bor Cs치rdi,csardi.gabor@gmail.com,2020-02-10T16:23:07Z,"Fix enc2utf8 in write_if_different

We need to do it before we check for same_contents().",R/utils.R,False,True,True,False,2,2,4,"---FILE: R/utils.R---
@@ -80,7 +80,7 @@ write_if_different <- function(path, contents, check = TRUE) {
   }
 
   contents <- paste0(paste0(contents, collapse = line_ending), line_ending)
-  contents <- gsub(""\r?\n"", line_ending, contents)
+  contents <- enc2utf8(gsub(""\r?\n"", line_ending, contents))
   if (same_contents(path, contents)) return(FALSE)
 
   name <- basename(path)
@@ -89,7 +89,7 @@ write_if_different <- function(path, contents, check = TRUE) {
     FALSE
   } else {
     cat(sprintf('Writing %s\n', name))
-    writeBin(charToRaw(enc2utf8(contents)), path)
+    writeBin(charToRaw(contents), path)
     TRUE
   }
 }"
r-lib,roxygen2,1e33a161d9e748eef0b0c51bec423beeff97d403,Gabor Csardi,csardi.gabor@gmail.com,2020-02-10T13:41:22Z,Gabor Csardi,csardi.gabor@gmail.com,2020-02-10T13:55:12Z,"Refactor writing Win/Unix line endings

We need to move the detection of line endings
upstream a bit, to be able to tell if the
newly generated contents is different from the
current one, in write_if_different().

This means that we need to paste() the contents
together in write_if_different(). Consequently,
we might as well remove the paste()-ing from
same_contents(), as write_if_different() always
calls it with the paste()-d contents.

Also, if we paste() already upstream, then
we might as well use writeBin() to write out
the contents, instead of write_lines(), especially
because write_lines() would add an extra empty line.
write_lines() is still kept, and used in some
code paths, and it can also do EOL-detection,
although this feature is not used currently.

Another benefit of this refactoring is that we
also move enc2utf8() upstream, this should clearly
happen before we check if the new contents is
different.

Added test cases as well.

Fixes #989, supersedes #1003.",R/utils-io.R;R/utils.R;tests/testthat/test-utils.R,False,True,True,False,55,8,63,"---FILE: R/utils-io.R---
@@ -5,11 +5,13 @@ read_lines <- function(path, n = -1L) {
   base::readLines(path, n = n, encoding = ""UTF-8"", warn = FALSE)
 }
 
-write_lines <- function(text, path) {
-  if (has_windows_le(path)) {
-    line_ending <- ""\r\n""
-  } else {
-    line_ending <- ""\n""
+write_lines <- function(text, path, line_ending = NULL) {
+  if (is.null(line_ending)) {
+    if (has_windows_le(path)) {
+      line_ending <- ""\r\n""
+    } else {
+      line_ending <- ""\n""
+    }
   }
 
   # we need to convert any embedded newlines as well

---FILE: R/utils.R---
@@ -73,6 +73,14 @@ write_if_different <- function(path, contents, check = TRUE) {
     return(FALSE)
   }
 
+  if (has_windows_le(path)) {
+    line_ending <- ""\r\n""
+  } else {
+    line_ending <- ""\n""
+  }
+
+  contents <- paste0(paste0(contents, collapse = line_ending), line_ending)
+  contents <- gsub(""\r?\n"", line_ending, contents)
   if (same_contents(path, contents)) return(FALSE)
 
   name <- basename(path)
@@ -81,16 +89,14 @@ write_if_different <- function(path, contents, check = TRUE) {
     FALSE
   } else {
     cat(sprintf('Writing %s\n', name))
-    write_lines(contents, path)
+    writeBin(charToRaw(enc2utf8(contents)), path)
     TRUE
   }
 }
 
 same_contents <- function(path, contents) {
   if (!file.exists(path)) return(FALSE)
 
-  contents <- paste0(paste0(contents, collapse = ""\n""), ""\n"")
-
   text_hash <- digest::digest(contents, serialize = FALSE)
 
   path <- normalizePath(path, mustWork = TRUE)

---FILE: tests/testthat/test-utils.R---
@@ -10,4 +10,43 @@ test_that(""nice_name protects against invalid characters"", {
   expect_equal(nice_name(""[.a""), ""sub-.a"")
 })
 
+test_that(""write_if_different and end of line"", {
+  cnt_unix <- c(""foo\nbar\nbaz"", ""foobar"")
+  cnt_win  <- c(""foo\r\nbar\r\nbaz"", ""foobar"")
+  cnt_mix  <- c(""foo\nbar\r\nbaz"", ""foobar"")
 
+  tmp <- tempfile(""roxy-"", fileext = "".Rd"")
+  on.exit(unlink(tmp), add = TRUE)
+
+  # do not change unix le
+  write_lines(cnt_unix, tmp, line_ending = ""\n"")
+  expect_silent(write_if_different(tmp, cnt_unix, check = FALSE))
+  expect_silent(write_if_different(tmp, cnt_win,  check = FALSE))
+  expect_silent(write_if_different(tmp, cnt_mix,  check = FALSE))
+
+  # do not change windows le
+  write_lines(cnt_win, tmp, line_ending = ""\r\n"")
+  expect_silent(write_if_different(tmp, cnt_unix, check = FALSE))
+  expect_silent(write_if_different(tmp, cnt_win,  check = FALSE))
+  expect_silent(write_if_different(tmp, cnt_mix,  check = FALSE))
+
+  # change mixed le to windows
+  tmp_win <- tempfile(""roxy-"", fileext = "".Rd"")
+  on.exit(unlink(tmp_win), add = TRUE)
+  write_lines(cnt_win, tmp_win, line_ending = ""\r\n"")
+
+  # write_lines changes line endings, so we use writeBin to create a file with mixed
+  # line endings
+  raw_mix <- charToRaw(paste0(paste0(cnt_mix, collapse = ""\r\n""), ""\r\n""))
+  writeBin(raw_mix, tmp)
+  expect_output(write_if_different(tmp, cnt_unix, check = FALSE), ""Writing "")
+  expect_identical(readBin(tmp, ""raw"", 100), readBin(tmp_win, ""raw"", 100))
+
+  writeBin(raw_mix, tmp)
+  expect_output(write_if_different(tmp, cnt_win, check = FALSE), ""Writing "")
+  expect_identical(readBin(tmp, ""raw"", 100), readBin(tmp_win, ""raw"", 100))
+
+  writeBin(raw_mix, tmp)
+  expect_output(write_if_different(tmp, cnt_mix, check = FALSE), ""Writing "")
+  expect_identical(readBin(tmp, ""raw"", 100), readBin(tmp_win, ""raw"", 100))
+})"
r-lib,roxygen2,b551ccaaee936894618c998f98de0d290f88e466,G치bor Cs치rdi,csardi.gabor@gmail.com,2020-01-21T17:28:58Z,G치bor Cs치rdi,csardi.gabor@gmail.com,2020-01-21T17:28:58Z,Use verify_output() for testing errors in inline code,tests/testthat/markdown-code-errors.txt;tests/testthat/test-markdown-code.R,False,True,True,False,28,17,45,"---FILE: tests/testthat/markdown-code-errors.txt---
@@ -0,0 +1,17 @@
+> roc_proc_text(rd_roclet(),
++ ""\n      #' Title\n      #'\n      #' Description --`r 1 +\n      #'   1`--\n      #' @md\n      #' @name dummy\n      NULL"")[[
++   1]]
+Error: [<text>:3] @description in inline code: multi-line `r ` markup is not supported
+
+> roc_proc_text(rd_roclet(),
++ ""\n      #' Title\n      #'\n      #' Description --`r 1 + 'a'`--\n      #' @md\n      #' @name dummy\n      NULL"")[[
++   1]]
+Error: [<text>:3] @description in inline code: non-numeric argument to binary operator
+
+> roc_proc_text(rd_roclet(),
++ ""\n      #' Title\n      #'\n      #' Description --`r 1 + `--\n      #' @md\n      #' @name dummy\n      NULL"")[[
++   1]]
+Error: [<text>:3] @description in inline code: <text>:2:0: unexpected end of input
+1: 1 + 
+   ^
+

---FILE: tests/testthat/test-markdown-code.R---
@@ -45,42 +45,36 @@ test_that(""NULL creates no text"", {
   )
 })
 
-test_that(""multi-line inline code block errors"", {
-  expect_error(
+test_that(""various errors"", {
+  verify_output(test_path(""markdown-code-errors.txt""), {
+
+    # multi-line inline code block
     roc_proc_text(rd_roclet(), ""
       #' Title
       #'
       #' Description --`r 1 +
       #'   1`--
       #' @md
       #' @name dummy
-      NULL"")[[1]],
-    ""in inline code: multi-line `r ` markup is not supported""
-  )
-})
+      NULL""
+      )[[1]]
 
-test_that(""evaluation errors are reported nicely"", {
-  expect_error(
+    # evaluation errors are reported nicely
     roc_proc_text(rd_roclet(), ""
       #' Title
       #'
       #' Description --`r 1 + 'a'`--
       #' @md
       #' @name dummy
-      NULL"")[[1]],
-    ""in inline code: non-numeric argument to binary operator""
-  )
-})
+      NULL"")[[1]]
 
-test_that(""pase errors are reported nicely"", {
-  expect_error(
+    # parse errors are reported nicely
     roc_proc_text(rd_roclet(), ""
       #' Title
       #'
       #' Description --`r 1 + `--
       #' @md
       #' @name dummy
-      NULL"")[[1]],
-    ""in inline code:.*unexpected end of input""
-  )
+      NULL"")[[1]]
+  })
 })"
r-lib,roxygen2,b20d473de765588a230895d27039db11ccbf2409,G치bor Cs치rdi,csardi.gabor@gmail.com,2020-01-21T16:56:34Z,G치bor Cs치rdi,csardi.gabor@gmail.com,2020-01-21T16:56:34Z,Fix typo in test cases,tests/testthat/test-markdown-code.R,False,True,True,False,1,1,2,"---FILE: tests/testthat/test-markdown-code.R---
@@ -22,7 +22,7 @@ test_that(""uses the same env for a tag, but does not reuse envs"", {
   expect_equal(out1$get_value(""description""), ""Description FALSE"")
 })
 
-test_that(""can create markdown markdup"", {
+test_that(""can create markdown markup"", {
   out1 <- roc_proc_text(rd_roclet(), ""
     #' Title
     #'"
r-lib,roxygen2,f2570014a3ab1d874cdb849d0d4a0c0554ef6083,G치bor Cs치rdi,csardi.gabor@gmail.com,2020-01-07T17:37:42Z,G치bor Cs치rdi,csardi.gabor@gmail.com,2020-01-07T18:07:50Z,"Inline code: error on multi-line code

Because cmark is buggy and reports bad code
locations for them.",R/markdown.R,False,True,True,False,19,2,21,"---FILE: R/markdown.R---
@@ -1,6 +1,15 @@
 
 markdown <- function(text, tag = NULL, sections = FALSE) {
-  expanded_text <- markdown_pass1(text)
+  tryCatch(
+    expanded_text <- markdown_pass1(text),
+    error = function(e) {
+      message <- paste0(
+        if (!is.na(tag$file)) paste0(""["", tag$file, "":"", tag$line, ""] ""),
+        ""@"", tag$tag, "" in inline code: "", e$message
+      )
+      stop(message, call. = FALSE)
+    }
+  )
   markdown_pass2(expanded_text, tag = tag, sections = sections)
 }
 
@@ -59,7 +68,15 @@ eval_code_nodes <- function(text) {
 }
 
 str_set_all_pos <- function(text, pos, value) {
-  # Need to collapse the string, because of the potential multi-line
+  # Cmark has a bug when reporting source positions for multi-line
+  # code tags, and it does not count the indenting space in the
+  # continuation lines. However, the bug might get fixed later, so
+  # for now we just simply error for multi-line inline code.
+  if (any(pos$start_line != pos$end_line)) {
+    stop(""multi-line `r ` markup is not supported"")
+  }
+
+  # Need to split the string, because of the potential multi-line
   # code tags, and then also recode the positions
   lens <- nchar(str_split(text, fixed(""\n""))[[1]])
   shifts <- c(0, cumsum(lens + 1L))"
r-lib,roxygen2,fadb188ebc3b637126dc6b05fe9fcaef85c08500,James Lamb,jaylamb20@gmail.com,2020-01-07T02:42:20Z,James Lamb,jaylamb20@gmail.com,2020-01-07T02:42:20Z,clarified error message for R6 objects without source references,R/object-r6.R,False,True,True,False,1,1,2,"---FILE: R/object-r6.R---
@@ -44,7 +44,7 @@ extract_r6_methods <- function(x) {
     x$public_methods[method_nms],
     function(m) {
       ref <- utils::getSrcref(m)
-      if (is.null(ref)) stop(""R6 class without source references"")
+      if (is.null(ref)) stop(""R6 class without source references. Try re-installing with installation option '--with-keep.source'."")
       utils::getSrcLocation(ref)
     }
   )"
r-lib,roxygen2,23d6f3f7c7f75fb176c717185316496ee07f82d6,Russ Hyde,russHyde@users.noreply.github.com,2019-12-18T13:37:57Z,GitHub,noreply@github.com,2019-12-18T13:37:57Z,fix typo,vignettes/namespace.Rmd,True,False,True,False,1,1,2,"---FILE: vignettes/namespace.Rmd---
@@ -37,7 +37,7 @@ Use the following guidelines to decide what to export:
   generics will not find the correct method.
   
     If you are providing a method for a generic defined in another package,
-    you must also import that generate.
+    you must also import that generic.
 
 * S4 classes: if you want others to be able to extend your class, `@export` it.
   If you want others to create instances of your class, but not extend it,"
r-lib,roxygen2,618763676beec2aead0ef9d4cae6ba7644b2300c,Hadley Wickham,h.wickham@gmail.com,2019-11-26T22:58:37Z,GitHub,noreply@github.com,2019-11-26T22:58:37Z,"Improve escaping algorithm (#992)

Use a C++ state machine to escape `%` and key escapes inside of strings

Fixes #990",DESCRIPTION;NEWS.md;R/RcppExports.R;R/rd-examples.R;man/escape_examples.Rd;src/RcppExports.cpp;src/escapeExamples.cpp,False,True,True,False,107,39,146,"---FILE: DESCRIPTION---
@@ -59,5 +59,5 @@ VignetteBuilder:
     knitr
 Encoding: UTF-8
 Roxygen: list(markdown = TRUE, load = ""installed"")
-RoxygenNote: 7.0.0.9000
+RoxygenNote: 7.0.1.9000
 Language: en-GB

---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* `\example{}` escaping has been improved (again!) so that special escapes 
+  within strings are correctly escaped (#990).
+
 # roxygen2 7.0.1
 
 * `@includeRmd` has now an optional second argument, the top level section

---FILE: R/RcppExports.R---
@@ -1,6 +1,10 @@
 # Generated by using Rcpp::compileAttributes() -> do not edit by hand
 # Generator token: 10BE3573-1514-4C36-9D1C-5A225CD40393
 
+escapeExamples <- function(x) {
+    .Call(`_roxygen2_escapeExamples`, x)
+}
+
 findEndOfTag <- function(string, is_code = FALSE) {
     .Call(`_roxygen2_findEndOfTag`, string, is_code)
 }

---FILE: R/rd-examples.R---
@@ -41,39 +41,38 @@ format.rd_section_examples <- function(x, ...) {
 #'
 #' This documentation topic is used primarily for testing and to record
 #' our understanding of the `\example{}` escaping rules.
+#' See <https://developer.r-project.org/parseRd.pdf> for the details provided
+#' by R core.
 #'
 #' @keywords internal
 #' @examples
-#' # The only thing that must be escaped in examples is Rd comments:
+#' # In examples we automatically escape Rd comments (%):
 #' 100 %% 30
 #' # even if they are in strings
 #' ""50%""
 #'
-#' # Otherwise, backslashes and braces can be left as is
-#' ""\""""
-#' ""{""
-#' # It looks like you could use Rd tags in comments, but these are
-#' # not actually parsed
-#' 1 # \link{mean}
+#' # and \\ and \v inside of strings and symbols
+#' ""\v"" # vertical tab
+#' ""\\""
+#' # but not comments: \l \v
 #'
-#' # The only place that a backslash can occur in R code is as part of
-#' # an infix operator or in a non-syntactic name. If you do either of those
-#' # things, you'll need to escape it yourself.
-#' `%\\\\%` <- function(x, y) x + y
-#' 10 %\\% 20
+#' # other string escapes are left as is
+#' ""\""""
+#' ""\n""
 #'
-#' # You must escape braces if they are unbalanced, which typically
-#' # only occurs in \dontshow{}:
+#' # Otherwise, backslashes and parentheses are left as is. This
+#' # means that you need to escape unbalanced parentheses, which typically only
+#' # occur in \dontshow{}:
 #' \dontshow{if (FALSE) \{ }
 #' print(""Hello"")
 #' \dontshow{ \} }
 #'
-#' # Otherwise, you _can_ escape them, but there's little point.
-#' # The following two lines are equivalent
-#' f <- function() { NULL }
-#' f <- function() \{ NULL \}
+#' # You also need to escape backslashes in infix operators and comments
+#' # (this is generally rare)
+#' `%\\%` <- function(x, y) x + y
+#' 10 %\\% 20
+#' # \\\\ (renders as two backslashes)
 escape_examples <- function(x) {
   x <- paste0(x, collapse = ""\n"")
-  x <- gsub(""%"", ""\\%"", x, fixed = TRUE, useBytes = TRUE)
-  rd(x)
+  rd(escapeExamples(x))
 }

---FILE: man/escape_examples.Rd---
@@ -9,35 +9,35 @@ escape_examples(x)
 \description{
 This documentation topic is used primarily for testing and to record
 our understanding of the \verb{\\example\{\}} escaping rules.
+See \url{https://developer.r-project.org/parseRd.pdf} for the details provided
+by R core.
 }
 \examples{
-# The only thing that must be escaped in examples is Rd comments:
+# In examples we automatically escape Rd comments (\%):
 100 \%\% 30
 # even if they are in strings
 ""50\%""
 
-# Otherwise, backslashes and braces can be left as is
-""\""""
-""{""
-# It looks like you could use Rd tags in comments, but these are
-# not actually parsed
-1 # \link{mean}
+# and \\ and \v inside of strings and symbols
+""\\v"" # vertical tab
+""\\\\""
+# but not comments: \l \v
 
-# The only place that a backslash can occur in R code is as part of
-# an infix operator or in a non-syntactic name. If you do either of those
-# things, you'll need to escape it yourself.
-`\%\\\\\%` <- function(x, y) x + y
-10 \%\\\% 20
+# other string escapes are left as is
+""\""""
+""\n""
 
-# You must escape braces if they are unbalanced, which typically
-# only occurs in \dontshow{}:
+# Otherwise, backslashes and parentheses are left as is. This
+# means that you need to escape unbalanced parentheses, which typically only
+# occur in \dontshow{}:
 \dontshow{if (FALSE) \{ }
 print(""Hello"")
 \dontshow{ \} }
 
-# Otherwise, you _can_ escape them, but there's little point.
-# The following two lines are equivalent
-f <- function() { NULL }
-f <- function() \{ NULL \}
+# You also need to escape backslashes in infix operators and comments
+# (this is generally rare)
+`\%\\\\\%` <- function(x, y) x + y
+10 \%\\\% 20
+# \\\\ (renders as two backslashes)
 }
 \keyword{internal}

---FILE: src/RcppExports.cpp---
@@ -5,6 +5,17 @@
 
 using namespace Rcpp;
 
+// escapeExamples
+std::string escapeExamples(std::string x);
+RcppExport SEXP _roxygen2_escapeExamples(SEXP xSEXP) {
+BEGIN_RCPP
+    Rcpp::RObject rcpp_result_gen;
+    Rcpp::RNGScope rcpp_rngScope_gen;
+    Rcpp::traits::input_parameter< std::string >::type x(xSEXP);
+    rcpp_result_gen = Rcpp::wrap(escapeExamples(x));
+    return rcpp_result_gen;
+END_RCPP
+}
 // findEndOfTag
 int findEndOfTag(std::string string, bool is_code);
 RcppExport SEXP _roxygen2_findEndOfTag(SEXP stringSEXP, SEXP is_codeSEXP) {
@@ -79,6 +90,7 @@ END_RCPP
 }
 
 static const R_CallMethodDef CallEntries[] = {
+    {""_roxygen2_escapeExamples"", (DL_FUNC) &_roxygen2_escapeExamples, 1},
     {""_roxygen2_findEndOfTag"", (DL_FUNC) &_roxygen2_findEndOfTag, 2},
     {""_roxygen2_rdComplete"", (DL_FUNC) &_roxygen2_rdComplete, 2},
     {""_roxygen2_leadingSpaces"", (DL_FUNC) &_roxygen2_leadingSpaces, 1},

---FILE: src/escapeExamples.cpp---
@@ -0,0 +1,50 @@
+#include <Rcpp.h>
+using namespace Rcpp;
+
+// [[Rcpp::export]]
+std::string escapeExamples(std::string x) {
+  std::string out;
+  out.reserve(x.length() * 1.1);
+
+  char in_string = '\0';
+  bool in_escape = false;
+  bool in_comment = false;
+
+  std::string::const_iterator cur, end = x.end();
+  for (cur = x.begin(); cur != end; cur++) {
+    if (in_comment) { // inside comment
+      if (*cur == '\n') {
+        in_comment = false;
+      }
+    } else if (in_string == '\0') { // regular code
+      if (*cur == '#') {
+        in_comment = true;
+      } else if (*cur == '\'' || *cur == '""' || *cur == '`') {
+        in_string = *cur;
+      }
+    } else { // inside string/symbol
+      if (in_escape) {
+        in_escape = false;
+        if (*cur == 'l' || *cur == 'v') {
+          out += '\\';
+        } else if (*cur == '\\') {
+          out += ""\\\\"";
+        }
+      } else {
+        if (*cur == in_string) {
+          in_string = '\0';
+        } else if (*cur == '\\') {
+          in_escape = true;
+        }
+      }
+    }
+
+    if (*cur == '%') {
+      out += '\\';
+    }
+
+    out += *cur;
+  }
+
+  return out;
+}"
r-lib,roxygen2,2a19c8bf18620cc87879a48de002f074c691f343,Hadley Wickham,h.wickham@gmail.com,2019-11-21T21:52:49Z,GitHub,noreply@github.com,2019-11-21T21:52:49Z,"Simplify escape_examples() (#986)

Fixes #967",NEWS.md;R/rd-examples.R;man/escape_examples.Rd;tests/testthat/test-rd-examples.R,False,True,True,False,87,69,156,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* Example escaping has been considerably simplified (#967), and is now 
+  documented in `escape_example()`.
+
 * Markdown tables with cells that contain multiple elements (e.g. text and code)
   are now rendered correctly (#985).
 

---FILE: R/rd-examples.R---
@@ -37,29 +37,43 @@ format.rd_section_examples <- function(x, ...) {
   rd_macro(x$type, value, space = TRUE)
 }
 
-# We take out the \dontshow{} etc. commands, because these should be
-# left as is, to allow the user to escape braces for example:
-# #' @examples
-# #' \\dontshow{ \{ }
-# #' # Hidden!
-# #' \\dontshow{ \} }
-#
-# Otherwise, it works like escape, but unescapes special rd example commands.
-# Also unescapes quotes because they must already be in strings and hence
-# don't need an additional layer of quoting.
+#' Escape examples
+#'
+#' This documentation topic is used primarily for testing and to record
+#' our understanding of the `\example{}` escaping rules.
+#'
+#' @keywords internal
+#' @examples
+#' # The only thing that must be escaped in examples is Rd comments:
+#' 100 %% 30
+#' # even if they are in strings
+#' ""50%""
+#'
+#' # Otherwise, backslashes and braces can be left as is
+#' ""\""""
+#' ""{""
+#' # It looks like you could use Rd tags in comments, but these are
+#' # not actually parsed
+#' 1 # \link{mean}
+#'
+#' # The only place that a backslash can occur in R code is as part of
+#' # an infix operator or in a non-syntactic name. If you do either of those
+#' # things, you'll need to escape it yourself.
+#' `%\\\\%` <- function(x, y) x + y
+#' 10 %\\% 20
+#'
+#' # You must escape braces if they are unbalanced, which typically
+#' # only occurs in \dontshow{}:
+#' \dontshow{if (FALSE) \{ }
+#' print(""Hello"")
+#' \dontshow{ \} }
+#'
+#' # Otherwise, you _can_ escape them, but there's little point.
+#' # The following two lines are equivalent
+#' f <- function() { NULL }
+#' f <- function() \{ NULL \}
 escape_examples <- function(x) {
-  x <- paste(x, collapse = ""\n"")
-  ex_tags <- c(""\\dontshow"", ""\\dontrun"", ""\\donttest"", ""\\testonly"")
-  rd_tags <- find_fragile_rd_tags(x, ex_tags)
-  x <- x0 <- protect_rd_tags(x, rd_tags)
-
-  attr(x, ""roxygen-markdown-subst"") <- NULL
-  x <- gsub(""\\"", ""\\\\"", x, fixed = TRUE, useBytes = TRUE)
-  x <- gsub(""\\\\dont"", ""\\dont"", x, fixed = TRUE)
-  x <- gsub(""\\\\'"", ""\\'"", x, fixed = TRUE)
-  x <- gsub('\\\\""', '\\""', x, fixed = TRUE)
-
-  x1 <- rd(unescape_rd_for_md(x, x0))
-  x2 <- gsub(""%"", ""\\%"", x1, fixed = TRUE, useBytes = TRUE)
-  rd(x2)
+  x <- paste0(x, collapse = ""\n"")
+  x <- gsub(""%"", ""\\%"", x, fixed = TRUE, useBytes = TRUE)
+  rd(x)
 }

---FILE: man/escape_examples.Rd---
@@ -0,0 +1,43 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/rd-examples.R
+\name{escape_examples}
+\alias{escape_examples}
+\title{Escape examples}
+\usage{
+escape_examples(x)
+}
+\description{
+This documentation topic is used primarily for testing and to record
+our understanding of the \verb{\\example\{\}} escaping rules.
+}
+\examples{
+# The only thing that must be escaped in examples is Rd comments:
+100 \%\% 30
+# even if they are in strings
+""50\%""
+
+# Otherwise, backslashes and braces can be left as is
+""\""""
+""{""
+# It looks like you could use Rd tags in comments, but these are
+# not actually parsed
+1 # \link{mean}
+
+# The only place that a backslash can occur in R code is as part of
+# an infix operator or in a non-syntactic name. If you do either of those
+# things, you'll need to escape it yourself.
+`\%\\\\\%` <- function(x, y) x + y
+10 \%\\\% 20
+
+# You must escape braces if they are unbalanced, which typically
+# only occurs in \dontshow{}:
+\dontshow{if (FALSE) \{ }
+print(""Hello"")
+\dontshow{ \} }
+
+# Otherwise, you _can_ escape them, but there's little point.
+# The following two lines are equivalent
+f <- function() { NULL }
+f <- function() \{ NULL \}
+}
+\keyword{internal}

---FILE: tests/testthat/test-rd-examples.R---
@@ -90,54 +90,12 @@ test_that(""% in @examples escaped before matching braces test (#213)"", {
 
 # escapes ------------------------------------------------------------------
 
-test_that(""% and \\ in @example escaped"", {
-  expect_equal(escape_examples(""x %*% y # \\x""), rd(""x \\%*\\% y # \\\\x""))
-})
-
-test_that(""escapes within strings are not double escaped"", {
+test_that(""only % escaped in @examples"", {
+  expect_equal(escape_examples(""x %*% y""), rd(""x \\%*\\% y""))
+  expect_equal(escape_examples(""# \\x""), rd(""# \\x""))
   expect_equal(escape_examples(""'34.00\\'""), rd(""'34.00\\'""))
 })
 
-test_that(""\\dontrun etc. is not escaped much #1"", {
-  expect_equal(escape_examples(""\\dontrun{x <- 1}""), rd(""\\dontrun{x <- 1}""))
-
-  expect_equal(
-    escape_examples(""\\dontrun{ \\{ x <- 1 \\} }""),
-    rd(""\\dontrun{ \\{ x <- 1 \\} }"")
-  )
-})
-
-test_that(""\\dontrun etc. is not escaped much #2"", {
-  out <- roc_proc_text(rd_roclet(), ""
-    #' @name a
-    #' @title a
-    #' @examples
-    #' \\dontshow{ \\{ }
-    #' # Hidden!
-    #' \\dontshow{ \\} }
-    NULL"")[[1]]
-
-  verify_output(test_path(""test-rd-examples-dontrun-escape.txt""), {
-    out$get_section(""examples"")
-  })
-})
-
-test_that(""but % is still escaped in \\dontrun"", {
-  out <- roc_proc_text(rd_roclet(), ""
-    #' Title
-    #' @examples
-    #' mtcars %>% identity()
-    #'
-    #' \\dontrun{
-    #' mtcars %>% identity()
-    #' }
-    foo <- function() {}"")[[1]]
-
-  verify_output(test_path(""test-rd-examples-dontrun-escape-2.txt""), {
-    out$get_section(""examples"")
-  })
-})
-
 test_that(""multi-line macros in @example"", {
   # https://github.com/r-lib/roxygen2/issues/974
   out <- roxygen2:::roc_proc_text(roxygen2:::rd_roclet(), """
r-lib,roxygen2,d9fba9bb124f1763886822a6e516c1b3d027c7e0,Hadley Wickham,h.wickham@gmail.com,2019-11-21T16:36:44Z,Hadley Wickham,h.wickham@gmail.com,2019-11-21T16:36:44Z,"Better strategy for rendering tables

Fixes #985",NAMESPACE;NEWS.md;R/markdown.R;tests/testthat/test-markdown-table.txt;tests/testthat/test-markdown.R,False,True,True,False,56,17,73,"---FILE: NAMESPACE---
@@ -253,6 +253,7 @@ importFrom(utils,tail)
 importFrom(xml2,xml_attr)
 importFrom(xml2,xml_children)
 importFrom(xml2,xml_contents)
+importFrom(xml2,xml_find_all)
 importFrom(xml2,xml_name)
 importFrom(xml2,xml_text)
 importFrom(xml2,xml_type)

---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* Markdown tables with cells that contain multiple elements (e.g. text and code)
+  are now rendered correctly (#985).
+
 * `@includeRmd` has now an optional second argument, the top level section
   the included file will go to. It defaults to the details section (#970).
 

---FILE: R/markdown.R---
@@ -31,7 +31,7 @@ mdxml_children_to_rd <- function(xml, state) {
   paste0(out, collapse = """")
 }
 
-#' @importFrom xml2 xml_name xml_type xml_text xml_contents xml_attr xml_children
+#' @importFrom xml2 xml_name xml_type xml_text xml_contents xml_attr xml_children xml_find_all
 mdxml_node_to_rd <- function(xml, state) {
   if (!inherits(xml, ""xml_node"") ||
       ! xml_type(xml) %in% c(""text"", ""element"")) {
@@ -135,10 +135,11 @@ mdxml_table <- function(xml, state) {
   head <- xml_children(xml)[[1]]
   align <- substr(xml_attr(xml_children(head), ""align"", default = ""left""), 1, 1)
 
-  rows <- xml_children(xml)
-  rows <- map(rows, xml_children)
-  rows_rd <- map(rows, ~ map_chr(xml_children(.x), mdxml_node_to_rd, state = state))
-  rows_rd <- map_chr(rows_rd, paste0, collapse = "" \\tab "")
+  rows <- xml_find_all(xml, ""d1:table_row|d1:table_header"")
+  cells <- map(rows, xml_find_all, ""d1:table_cell"")
+
+  cells_rd <- map(cells, ~ map(.x, mdxml_children_to_rd, state = state))
+  rows_rd <- map_chr(cells_rd, paste0, collapse = "" \\tab "")
 
   paste0(""\\tabular{"", paste(align, collapse = """"), ""}{\n"",
     paste(""  "", rows_rd, ""\\cr\n"", collapse = """"),

---FILE: tests/testthat/test-markdown-table.txt---
@@ -1,11 +1,32 @@
-> cat(markdown(
-+   ""\n| x   | y   |\n| --- | --- |\n| 1   | 2   |\n\n| x   | y   |\n| :-: | --: |\n| 1   | 2   |\n    ""))
+> for (table in tables) {
++   cat_line(table)
++   cat_line(markdown(table))
++   cat_line()
++ }
+
+| x   | y   |
+| --- | --- |
+| 1   | 2   |
 \tabular{ll}{
    x \tab y \cr
    1 \tab 2 \cr
 }
+
+| x   | y   |
+| :-: | --: |
+| 1   | 2   |
 \tabular{cr}{
    x \tab y \cr
    1 \tab 2 \cr
 }
 
+| x     | y         |
+| ----- | --------- |
+| 1 _2_ | 3 *4* `5` |
+  
+\tabular{ll}{
+   x \tab y \cr
+   1 \emph{2} \tab 3 \emph{4} \code{5} \cr
+}
+
+

---FILE: tests/testthat/test-markdown.R---
@@ -228,17 +228,30 @@ test_that(""nested lists are OK"", {
 
 
 test_that(""can convert table to Rd"", {
+  txt <- ""
+    | x   | y   |
+    | --- | --- |
+    | 1   | 2   |
+
+    | x   | y   |
+    | :-: | --: |
+    | 1   | 2   |
+
+    | x     | y         |
+    | ----- | --------- |
+    | 1 _2_ | 3 *4* `5` |
+  ""
+  txt <- gsub(""\n    "", ""\n"", txt)
+  tables <- strsplit(txt, ""\n\n"")[[1]]
+
   verify_output(
-    test_path(""test-markdown-table.txt""),
-    cat(markdown(""
-| x   | y   |
-| --- | --- |
-| 1   | 2   |
-
-| x   | y   |
-| :-: | --: |
-| 1   | 2   |
-    ""))
+    test_path(""test-markdown-table.txt""), {
+      for (table in tables) {
+        cat_line(table)
+        cat_line(markdown(table))
+        cat_line()
+      }
+    }
   )
 })
 "
r-lib,roxygen2,cdc81dd2224854f8d9825bf1ccecff191ed6cb00,Hadley Wickham,h.wickham@gmail.com,2019-11-21T14:04:08Z,Hadley Wickham,h.wickham@gmail.com,2019-11-21T14:04:21Z,"Require latest purrr

Fixes #966",DESCRIPTION,False,False,False,False,1,1,2,"---FILE: DESCRIPTION---
@@ -37,7 +37,7 @@ Imports:
     digest,
     methods,
     pkgload (>= 1.0.2),
-    purrr,
+    purrr (>= 0.3.3),
     R6 (>= 2.1.2),
     Rcpp (>= 0.11.0),
     rlang,"
r-lib,roxygen2,80a6a58f5c56058cf9d2f77e418ab9626e86192a,G치bor Cs치rdi,csardi.gabor@gmail.com,2019-11-21T13:00:04Z,Hadley Wickham,h.wickham@gmail.com,2019-11-21T13:00:04Z,"Fix multi-line macros in @example files (#983)

Closes #974.",R/rd-examples.R;tests/testthat/Rd-example-4.txt;tests/testthat/test-rd-examples.R,False,True,True,False,20,1,21,"---FILE: R/rd-examples.R---
@@ -48,6 +48,7 @@ format.rd_section_examples <- function(x, ...) {
 # Also unescapes quotes because they must already be in strings and hence
 # don't need an additional layer of quoting.
 escape_examples <- function(x) {
+  x <- paste(x, collapse = ""\n"")
   ex_tags <- c(""\\dontshow"", ""\\dontrun"", ""\\donttest"", ""\\testonly"")
   rd_tags <- find_fragile_rd_tags(x, ex_tags)
   x <- x0 <- protect_rd_tags(x, rd_tags)

---FILE: tests/testthat/Rd-example-4.txt---
@@ -0,0 +1,3 @@
+\dontrun{
+1 + 1
+}

---FILE: tests/testthat/test-rd-examples.R---
@@ -47,7 +47,7 @@ test_that(""@example does not introduce extra empty lines"", {
     #' @example Rd-example-3.R
     NULL"")[[1]]
 
-  expect_length(out$get_value(""examples""), 2L)
+  expect_equal(str_count(out$get_value(""examples""), ""\n""), 1L)
 })
 
 test_that(""@example gives warning if used instead of @examples"", {
@@ -137,3 +137,18 @@ test_that(""but % is still escaped in \\dontrun"", {
     out$get_section(""examples"")
   })
 })
+
+test_that(""multi-line macros in @example"", {
+  # https://github.com/r-lib/roxygen2/issues/974
+  out <- roxygen2:::roc_proc_text(roxygen2:::rd_roclet(), ""
+    #' @name a
+    #' @title a
+    #'
+    #' @example Rd-example-4.txt
+    NULL"")[[1]]
+
+  expect_equal(
+    format(out$get_section(""examples"")),
+    ""\\examples{\n\\dontrun{\n1 + 1\n}\n}""
+  )
+})"
r-lib,roxygen2,6e5bd7f6b4f727a68bfe97b85d8e9e469e6fc494,G치bor Cs치rdi,csardi.gabor@gmail.com,2019-11-21T12:59:26Z,Hadley Wickham,h.wickham@gmail.com,2019-11-21T12:59:26Z,"Fix escaping % in \dontrun{} etc. in examples (#981)

Closes #965.",R/rd-examples.R;tests/testthat/test-rd-examples-dontrun-escape-2.txt;tests/testthat/test-rd-examples-dontrun-escape.txt;tests/testthat/test-rd-examples.R,False,True,True,False,32,5,37,"---FILE: R/rd-examples.R---
@@ -53,10 +53,12 @@ escape_examples <- function(x) {
   x <- x0 <- protect_rd_tags(x, rd_tags)
 
   attr(x, ""roxygen-markdown-subst"") <- NULL
-  x <- escape(x)
+  x <- gsub(""\\"", ""\\\\"", x, fixed = TRUE, useBytes = TRUE)
   x <- gsub(""\\\\dont"", ""\\dont"", x, fixed = TRUE)
   x <- gsub(""\\\\'"", ""\\'"", x, fixed = TRUE)
   x <- gsub('\\\\""', '\\""', x, fixed = TRUE)
 
-  rd(unescape_rd_for_md(x, x0))
+  x1 <- rd(unescape_rd_for_md(x, x0))
+  x2 <- gsub(""%"", ""\\%"", x1, fixed = TRUE, useBytes = TRUE)
+  rd(x2)
 }

---FILE: tests/testthat/test-rd-examples-dontrun-escape-2.txt---
@@ -0,0 +1,9 @@
+> out$get_section(""examples"")
+\examples{
+mtcars \%>\% identity()
+
+\dontrun{
+mtcars \%>\% identity()
+}
+} 
+

---FILE: tests/testthat/test-rd-examples.R---
@@ -98,7 +98,7 @@ test_that(""escapes within strings are not double escaped"", {
   expect_equal(escape_examples(""'34.00\\'""), rd(""'34.00\\'""))
 })
 
-test_that(""\\dontrun etc. is not escaped #1"", {
+test_that(""\\dontrun etc. is not escaped much #1"", {
   expect_equal(escape_examples(""\\dontrun{x <- 1}""), rd(""\\dontrun{x <- 1}""))
 
   expect_equal(
@@ -107,7 +107,7 @@ test_that(""\\dontrun etc. is not escaped #1"", {
   )
 })
 
-test_that(""\\dontrun etc. is not escaped #2"", {
+test_that(""\\dontrun etc. is not escaped much #2"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' @name a
     #' @title a
@@ -117,7 +117,23 @@ test_that(""\\dontrun etc. is not escaped #2"", {
     #' \\dontshow{ \\} }
     NULL"")[[1]]
 
-  verify_output(test_path(""test-rd-examples-dotrun-escape.txt""), {
+  verify_output(test_path(""test-rd-examples-dontrun-escape.txt""), {
+    out$get_section(""examples"")
+  })
+})
+
+test_that(""but % is still escaped in \\dontrun"", {
+  out <- roc_proc_text(rd_roclet(), ""
+    #' Title
+    #' @examples
+    #' mtcars %>% identity()
+    #'
+    #' \\dontrun{
+    #' mtcars %>% identity()
+    #' }
+    foo <- function() {}"")[[1]]
+
+  verify_output(test_path(""test-rd-examples-dontrun-escape-2.txt""), {
     out$get_section(""examples"")
   })
 })"
r-lib,roxygen2,60731911d0b97c0f31e3562794fde71d13a13111,Hadley Wickham,h.wickham@gmail.com,2019-11-21T12:58:05Z,GitHub,noreply@github.com,2019-11-21T12:58:05Z,"Also tweak_links() of the form \link[=topic]{text} (#980)

Fixes #979",NEWS.md;R/utils-rd.R;tests/testthat/test-utils-rd.R,False,True,True,False,18,2,20,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* Links of the form `\link[=topic]{text}` are now automatically converted to
+  `\link[pkg:topic]{text}` when inherited from other packages (#979)
+
 * Autogenerated function usage for S3/S4 methods is no longer double-escaped 
   (#976).
 

---FILE: R/utils-rd.R---
@@ -78,8 +78,19 @@ tweak_links <- function(x, package) {
 
   if (is.list(x)) {
     if (!is.null(tag) && tag == ""\\link"") {
-      if (is.null(attr(x, ""Rd_option"")) && has_topic(x[[1]], package)) {
-        attr(x, ""Rd_option"") <- structure(package, Rd_tag = ""TEXT"")
+      opt <- attr(x, ""Rd_option"")
+      if (is.null(opt)) {
+        if (has_topic(x[[1]], package)) {
+          attr(x, ""Rd_option"") <- structure(package, Rd_tag = ""TEXT"")
+        }
+      } else {
+        if (is.character(opt) && length(opt) == 1 && substr(opt, 1, 1) == ""="") {
+          topic <- substr(opt, 2, nchar(opt))
+
+          if (has_topic(topic, package)) {
+            attr(x, ""Rd_option"") <- structure(paste0(package, "":"", topic), Rd_tag = ""TEXT"")
+          }
+        }
       }
     } else if (length(x) > 0) {
       x[] <- map(x, tweak_links, package = package)

---FILE: tests/testthat/test-utils-rd.R---
@@ -12,7 +12,9 @@ test_that(""has_topic() works as you'd expect"", {
 test_that(""can tweak links to point to new package"", {
   rd1 <- tweak_links(parse_rd(""\\link{abbreviate}""), package = ""base"")
   rd2 <- tweak_links(parse_rd(""\\link[base]{abbreviate}""), package = ""base"")
+  rd3 <- tweak_links(parse_rd(""\\link[=abbreviate]{abbr}""), package = ""base"")
 
   expect_equal(rd2text(rd1), ""\\link[base]{abbreviate}\n"")
   expect_equal(rd2text(rd2), ""\\link[base]{abbreviate}\n"")
+  expect_equal(rd2text(rd3), ""\\link[base:abbreviate]{abbr}\n"")
 })"
r-lib,roxygen2,ee061b343fecd77470ed02fbc94c15ee66f770ab,Hadley Wickham,h.wickham@gmail.com,2019-11-20T23:41:20Z,Hadley Wickham,h.wickham@gmail.com,2019-11-20T23:41:20Z,"Don't double escape method usage

Fixes #976",NEWS.md;R/rd-usage.R;tests/testthat/test-rd-usage.R,False,True,True,False,17,2,19,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* Autogenerated function usage for S3/S4 methods is no longer double-escaped 
+  (#976).
+
 * `@includeRmd` chunks are now evaluated in a child of the global 
   environment (#972).
 

---FILE: R/rd-usage.R---
@@ -43,7 +43,7 @@ object_usage.s3generic <- object_usage.function
 object_usage.s3method <- function(x) {
   method <- attr(x$value, ""s3method"")
   s3method <- function(name) {
-    build_rd(""\\method{"", name, ""}{"", auto_backtick(method[2]), ""}"")
+    paste0(""\\method{"", name, ""}{"", auto_backtick(method[2]), ""}"")
   }
   function_usage(method[1], formals(x$value), s3method)
 }
@@ -55,7 +55,7 @@ object_usage.s4generic <- function(x) {
 object_usage.s4method <- function(x) {
   s4method <- function(name) {
     classes <- auto_backtick(as.character(x$value@defined))
-    build_rd(""\\S4method{"", name, ""}{"", paste0(classes, collapse = "",""), ""}"")
+    paste0(""\\S4method{"", name, ""}{"", paste0(classes, collapse = "",""), ""}"")
   }
   function_usage(x$value@generic, formals(x$value), s4method)
 }

---FILE: tests/testthat/test-rd-usage.R---
@@ -178,6 +178,10 @@ test_that(""default usage formats S3 methods correctly"", {
     call_to_usage(""+.foo"" <- function(x, b) {}),
     ""\\method{+}{foo}(x, b)""
   )
+  expect_equal(
+    call_to_usage(""%%.foo"" <- function(x, b) {}),
+    ""\\method{\\%\\%}{foo}(x, b)""
+  )
   expect_equal(
     call_to_usage(""[<-.foo"" <- function(x, value) {}),
     ""\\method{[}{foo}(x) <- value""
@@ -217,6 +221,14 @@ test_that(""default usage correct for S4 methods"", {
     }),
     ""\\S4method{[}{Foo}(x, i, j, ...) <- value""
   )
+
+  expect_equal(
+    call_to_usage({
+      setGeneric(""%&&%"", function(x, y) standardGeneric(""%&&%""))
+      setMethod(""%&&%"", signature(""logical"", ""logical""), function(x, y) {})
+    }),
+    ""\\S4method{\\%&&\\%}{logical,logical}(x, y)""
+  )
 })
 
 test_that(""default usage correct for S4 methods with different args to generic"", {"
r-lib,roxygen2,cfadace258e33f9e4d0bcdd81ce50b2f6c5c6783,Hadley Wickham,h.wickham@gmail.com,2019-11-20T23:26:24Z,Hadley Wickham,h.wickham@gmail.com,2019-11-20T23:26:24Z,"Render in child of global env

Fixes #972",NEWS.md;R/rd-include-rmd.R,False,True,True,False,5,1,6,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* `@includeRmd` chunks are now evaluated in a child of the global 
+  environment (#972).
+
 * Internal `has_topic()` helper has a better implementation; this means that
   you're less likely to get package names spuriously introduced into links when
   inheriting documentation from other packages (#973).

---FILE: R/rd-include-rmd.R---
@@ -45,7 +45,8 @@ roxy_tag_rd.roxy_tag_includeRmd <- function(x, base_path, env) {
     rmd_path,
     output_format = rmarkdown::github_document(),
     output_file = md_path,
-    quiet = TRUE
+    quiet = TRUE,
+    envir = new_environment(parent = global_env())
   )
 
   value <- rmd_eval_rd(md_path, x)"
r-lib,roxygen2,334ce0c2d7afef7747e33b582e8a1b458411ca30,Hadley Wickham,h.wickham@gmail.com,2019-11-20T23:05:38Z,Hadley Wickham,h.wickham@gmail.com,2019-11-20T23:05:38Z,"Better implementation of has_topic()

Fixes #973",NEWS.md;R/utils-rd.R;tests/testthat/test-utils-rd.R,False,True,True,False,17,6,23,"---FILE: NEWS.md---
@@ -1,5 +1,9 @@
 # roxygen2 (development version)
 
+* Internal `has_topic()` helper has a better implementation; this means that
+  you're less likely to get package names spuriously introduced into links when
+  inheriting documentation from other packages (#973).
+
 * Operator and other special syntax (e.g. `function`, `if`) in markdown code 
   blocks are now converted to `\code{}` rather than `\verb{}` (#971)
 

---FILE: R/utils-rd.R---
@@ -122,8 +122,8 @@ make_as_character_rd <- function() {
 has_topic <- function(topic, package) {
   tryCatch(
     {
-      utils::help((topic), package = (package))
-      TRUE
+      out <- utils::help((topic), package = (package))
+      length(out) == 1
     },
     error = function(c) FALSE
   )

---FILE: tests/testthat/test-utils-rd.R---
@@ -2,10 +2,17 @@ test_that(""href doesn't get extra parens"", {
   expect_equal(rd2text(parse_rd(""\\href{a}{b}"")), ""\\href{a}{b}\n"")
 })
 
+test_that(""has_topic() works as you'd expect"", {
+  expect_equal(has_topic(""abbreviate"", ""base""), TRUE)
+  expect_equal(has_topic(""abbreviateXXXX"", ""base""), FALSE)
+
+  expect_equal(has_topic(""foo"", ""PACKAGEDOESNOTEXIST""), FALSE)
+})
+
 test_that(""can tweak links to point to new package"", {
-  rd1 <- tweak_links(parse_rd(""\\link{roclet}""), package = ""roxygen2"")
-  rd2 <- tweak_links(parse_rd(""\\link[roxygen2]{roclet}""), package = ""roxygen2"")
+  rd1 <- tweak_links(parse_rd(""\\link{abbreviate}""), package = ""base"")
+  rd2 <- tweak_links(parse_rd(""\\link[base]{abbreviate}""), package = ""base"")
 
-  expect_equal(rd2text(rd1), ""\\link[roxygen2]{roclet}\n"")
-  expect_equal(rd2text(rd2), ""\\link[roxygen2]{roclet}\n"")
+  expect_equal(rd2text(rd1), ""\\link[base]{abbreviate}\n"")
+  expect_equal(rd2text(rd2), ""\\link[base]{abbreviate}\n"")
 })"
r-lib,roxygen2,56724854a96ab6a8c9e0784b8775968e805c9eb7,Hadley Wickham,h.wickham@gmail.com,2019-11-20T22:50:00Z,Hadley Wickham,h.wickham@gmail.com,2019-11-20T22:50:00Z,"Allow operators and other special syntax in \code{}

Fixes #971",DESCRIPTION;NEWS.md;R/markdown.R;man/markdown-internals.Rd;tests/testthat/test-markdown-link.R;tests/testthat/test-markdown.R,False,True,True,False,19,4,23,"---FILE: DESCRIPTION---
@@ -59,5 +59,5 @@ VignetteBuilder:
     knitr
 Encoding: UTF-8
 Roxygen: list(markdown = TRUE, load = ""installed"")
-RoxygenNote: 6.1.99.9001
+RoxygenNote: 7.0.0.9000
 Language: en-GB

---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* Operator and other special syntax (e.g. `function`, `if`) in markdown code 
+  blocks are now converted to `\code{}` rather than `\verb{}` (#971)
+
 # roxygen2 7.0.0
 
 ## New features

---FILE: R/markdown.R---
@@ -90,13 +90,20 @@ mdxml_code <- function(xml, tag) {
 
   # See escaping details at
   # https://cran.rstudio.com/doc/manuals/r-devel/R-exts.html#Insertions
-  if (can_parse(code)) {
+  if (can_parse(code) || code %in% special) {
     paste0(""\\code{"", gsub(""%"", ""\\\\%"", code), ""}"")
   } else {
     paste0(""\\verb{"", escape_verb(code), ""}"")
   }
 }
 
+special <- c(
+  ""-"", "":"", ""::"", "":::"", ""!"", ""!="", ""("", ""["", ""[["", ""@"",
+  ""*"", ""/"", ""&"", ""&&"", ""%*%"", ""%/%"", ""%%"", ""%in%"", ""%o%"", ""%x%"",
+  ""^"", ""+"", ""<"", ""<="", ""="", ""=="", "">"", "">="", ""|"", ""||"", ""~"", ""$"",
+  ""for"", ""function"", ""if"", ""repeat"", ""while""
+)
+
 mdxml_code_block <- function(xml, state) {
   info <- xml_attr(xml, ""info"")[1]
   if (is.na(info) || nchar(info[1]) == 0) info <- NA_character_

---FILE: man/markdown-internals.Rd---
@@ -43,7 +43,7 @@ The list of protected Rd tags is in \code{escaped_for_md}.
 
 Some Rd macros are treated specially:
 \itemize{
-\item For \verb{if}, markdown is only allowed in the second argument.
+\item For \code{if}, markdown is only allowed in the second argument.
 \item For \code{ifelse} markdown is allowed in the second and third arguments.
 }
 

---FILE: tests/testthat/test-markdown-link.R---
@@ -24,7 +24,7 @@ test_that(""proper link references are added"", {
 test_that(""can not have [ inside of link"", {
   expect_equal(
     markdown(""`[[`. [subset()]""),
-    ""\\verb{[[}. \\code{\\link[=subset]{subset()}}""
+    ""\\code{[[}. \\code{\\link[=subset]{subset()}}""
   )
 })
 

---FILE: tests/testthat/test-markdown.R---
@@ -78,6 +78,7 @@ test_that(""code block with language creates HTML tag"", {
 test_that(""inline code escapes %"", {
   expect_equal(markdown(""`5%`""), ""\\verb{5\\%}"")
   expect_equal(markdown(""`'5%'`""), ""\\code{'5\\%'}"")
+  expect_equal(markdown(""`%*%`""), ""\\code{\\%*\\%}"")
 })
 
 test_that(""inline verbatim escapes Rd special chars"", {
@@ -86,6 +87,10 @@ test_that(""inline verbatim escapes Rd special chars"", {
   expect_equal(markdown(""`\\`""), ""\\verb{\\\\}"")
 })
 
+test_that(""special operators get \\code{}, not \\verb{}"", {
+  expect_equal(markdown(""`if`""), ""\\code{if}"")
+})
+
 test_that(""code blocks escape %"", {
   expect_equal(
     markdown(""```\n1:10 %>% mean()\n```""),"
r-lib,roxygen2,62c3835913f28b56ee68acb8685e222d27c2c250,Jim Hester,james.f.hester@gmail.com,2019-11-20T22:26:08Z,Hadley Wickham,h.wickham@gmail.com,2019-11-20T22:26:08Z,"Fix partial match of contents (#977)

I believe this list value should be named `content`, rather than
`contents` to match the existing code",R/rd-inherit.R,False,True,True,False,1,1,2,"---FILE: R/rd-inherit.R---
@@ -312,7 +312,7 @@ find_sections <- function(topic) {
     titles <- map_chr(map(tag, 1), rd2text)
     contents <- map_chr(map(tag, 2), rd2text)
 
-    list(title = titles, contents = contents)
+    list(title = titles, content = contents)
   } else {
     topic$get_value(""section"")
   }"
r-lib,roxygen2,d0946db873c06c96152faee2076d91f6e2a115f8,Hadley Wickham,h.wickham@gmail.com,2019-11-05T21:26:51Z,Hadley Wickham,h.wickham@gmail.com,2019-11-05T21:26:51Z,Fix another bad url,vignettes/roxygen2.Rmd,True,False,True,False,1,1,2,"---FILE: vignettes/roxygen2.Rmd---
@@ -26,7 +26,7 @@ As well as generating `.Rd` files, roxygen will also create a `NAMESPACE` for yo
 
 This vignette provides a high-level description of roxygen2 and how the three main components work. The other vignettes provide more detail on the most important individual components:
 
-* [Generating .Rd files](rd.html) and [text formatting](formatting.html)
+* [Generating .Rd files](rd.html) and [text formatting](rd-formatting.html)
   describe how to generate function documentation via `.Rd` files
 
 * [Managing your `NAMESPACE`](namespace.html) describes how to generate"
r-lib,roxygen2,31a53ccffc2d29619db9ceda71769222fd7893d1,Hadley Wickham,h.wickham@gmail.com,2019-11-05T17:11:53Z,Hadley Wickham,h.wickham@gmail.com,2019-11-05T17:12:27Z,"Standardise quoting/backticking

* Namespace always uses quotes (Fixes #930)
* Usage always uses backticks
* Usage escapes % (Fixes #940)",NAMESPACE;R/namespace.R;R/rd-usage.R;R/utils.R;tests/testthat/test-namespace.R;tests/testthat/test-rd-usage.R,False,True,True,False,51,27,78,"---FILE: NAMESPACE---
@@ -4,7 +4,7 @@ S3method(block_to_rd,default)
 S3method(block_to_rd,roxy_block)
 S3method(block_to_rd,roxy_block_r6class)
 S3method(c,rd)
-S3method(default_export,NULL)
+S3method(default_export,""NULL"")
 S3method(default_export,default)
 S3method(default_export,rcclass)
 S3method(default_export,s3method)

---FILE: R/namespace.R---
@@ -263,7 +263,7 @@ default_export.s4generic <- function(x, block) export(x$value@generic)
 #' @export
 default_export.s4method  <- function(x, block) export_s4_method(x$value@generic)
 #' @export
-default_export.s3method  <- function(x, block) export_s3_method(attr(x$value, ""s3method""))
+default_export.s3method  <- function(x, block) export_s3_method(auto_quote(attr(x$value, ""s3method"")))
 #' @export
 default_export.rcclass   <- function(x, block) export_class(x$value@className)
 #' @export
@@ -277,13 +277,13 @@ export           <- function(x) one_per_line(""export"", x)
 export_class     <- function(x) one_per_line(""exportClasses"", x)
 export_s4_method <- function(x) one_per_line(""exportMethods"", x)
 export_s3_method <- function(x) {
-  args <- paste0(auto_backtick(x), collapse = "","")
+  args <- paste0(x, collapse = "","")
   paste0(""S3method("", args, "")"")
 }
 
 one_per_line <- function(name, x) {
-  paste0(name, ""("", auto_backtick(x), "")"")
+  paste0(name, ""("", auto_quote(x), "")"")
 }
 repeat_first <- function(name, x) {
-  paste0(name, ""("", auto_backtick(x[1]), "","", auto_backtick(x[-1]), "")"")
+  paste0(name, ""("", auto_quote(x[1]), "","", auto_quote(x[-1]), "")"")
 }

---FILE: R/rd-usage.R---
@@ -69,6 +69,10 @@ object_usage.s4method <- function(x) {
 function_usage <- function(name, formals, format_name = identity) {
   if (is_replacement_fun(name) && !is_infix_fun(name)) {
     name <- str_replace(name, fixed(""<-""), """")
+    if (identical(format_name, identity)) {
+      name <- auto_backtick(name)
+    }
+    name <- gsub(""%"", ""\\%"", name, fixed = TRUE)
     formals$value <- NULL
 
     wrap_usage(name, format_name, formals, suffix = "" <- value"")
@@ -77,6 +81,10 @@ function_usage <- function(name, formals, format_name = identity) {
     arg_names <- names(formals)
     build_rd(arg_names[1], "" "", format_name(name), "" "", arg_names[2])
   } else {
+    if (identical(format_name, identity)) {
+      name <- auto_backtick(name)
+    }
+    name <- gsub(""%"", ""\\%"", name, fixed = TRUE)
     wrap_usage(name, format_name, formals)
   }
 }
@@ -119,11 +127,6 @@ args_call <- function(call, args) {
 #' @param suffix Optional suffix, used for replacement functions
 #' @noRd
 wrap_usage <- function(name, format_name, formals, suffix = NULL, width = 80L) {
-  # Quote non-syntactic names if no special formatting
-  if (identical(format_name, identity)) {
-    name <- auto_quote(name)
-  }
-
   args <- args_string(usage_args(formals))
 
   # Do we need any wrapping?

---FILE: R/utils.R---
@@ -158,17 +158,17 @@ uuid <- function(nchar = 8) {
 }
 
 # quoting -----------------------------------------------------------------
-is_parseable <- function(x) map_lgl(x, can_parse)
 auto_backtick <- function(x) {
-  needs_backtick <- !is_parseable(x)
+  needs_backtick <- !has_quotes(x) & !is_syntactic(x)
   x[needs_backtick] <- encodeString(x[needs_backtick], quote = ""`"")
   x
 }
 
-is_syntactic <- function(x) make.names(x) == x
-has_quotes <- function(x) str_detect(x, ""^('|\"").*\\1$"")
 auto_quote <- function(x) {
   needs_quotes <- !has_quotes(x) & !is_syntactic(x)
   x[needs_quotes] <- encodeString(x[needs_quotes], quote = '""')
   x
 }
+
+is_syntactic <- function(x) make.names(x) == x
+has_quotes <- function(x) str_detect(x, ""^(`|'|\"").*\\1$"")

---FILE: tests/testthat/test-namespace.R---
@@ -5,10 +5,10 @@ test_that(""export quote object name appropriate"", {
   expect_equal(out, 'export(a)')
 
   out <- roc_proc_text(namespace_roclet(), ""#' @export\n`+` <- function(){}"")
-  expect_equal(out, 'export(`+`)')
+  expect_equal(out, 'export(""+"")')
 
   out <- roc_proc_text(namespace_roclet(), ""#' @export\n`\\`` <- function(){}"")
-  expect_equal(out, 'export(`\\``)')
+  expect_equal(out, 'export(""`"")')
 })
 
 test_that(""export parameter overrides default"", {
@@ -51,6 +51,21 @@ test_that(""export detects S3 method"", {
   expect_equal(out, 'S3method(mean,foo)')
 })
 
+test_that(""export handles non-syntactic names"", {
+  out <- roc_proc_text(namespace_roclet(),  ""
+    #' @export
+    `mean.foo-bar` <- function(x) 'foo'
+  "")
+  expect_equal(out, ""S3method(mean,\""foo-bar\"")"")
+
+  out <- roc_proc_text(namespace_roclet(),  ""
+    `foo-bar` <- function(x) UseMethod('foo-bar')
+    #' @export
+    `foo-bar.integer` <- function(x) 'foo'
+  "")
+  expect_equal(out, ""S3method(\""foo-bar\"",integer)"")
+})
+
 test_that(""@exportS3method generatedsS3method()"", {
   out <- roc_proc_text(namespace_roclet(),
     ""#' @exportS3Method
@@ -98,7 +113,7 @@ test_that(""export method escapes if needed"", {
     setGeneric('x<-', function(x, value) standardGeneric('x<-'))
     #' @export\n
     setMethod('x<-', 'a', function(x, value) value)"")
-  expect_equal(out, 'exportMethods(`x<-`)')
+  expect_equal(out, 'exportMethods(""x<-"")')
 })
 
 test_that(""export uses name if no object present"", {

---FILE: tests/testthat/test-rd-usage.R---
@@ -77,16 +77,6 @@ test_that(""% and \\ not escaped in manual usage"", {
   expect_equal(out$get_rd(""usage""), '\\usage{\n%\\\n}')
 })
 
-test_that(""non-syntactic names are quoted"", {
-
-  out <- roc_proc_text(rd_roclet(), ""
-    #' Title.
-    'a b' <- function(x) x"")[[1]]
-
-  expect_equal(out$get_value(""usage""), rd('""a b""(x)'))
-})
-
-
 test_that(""Special vars removed in rc methods usage"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' Class Blob
@@ -126,6 +116,22 @@ test_that(""backticks retained when needed"", {
     call_to_usage(f <- function(`_a`) {}),
     ""f(`_a`)""
   )
+
+  expect_equal(
+    call_to_usage(`-f` <- function(x) {}),
+    ""`-f`(x)""
+  )
+})
+
+test_that(""% escaped when not in infix function"", {
+  expect_equal(
+    call_to_usage(`%foo%bar` <- function(x, table) {}),
+    ""`\\%foo\\%bar`(x, table)""
+  )
+  expect_equal(
+    call_to_usage(`%foo%bar<-` <- function(x, value) {}),
+    ""`\\%foo\\%bar`(x) <- value""
+  )
 })
 
 test_that(""default usage formats data correctly"", {"
r-lib,roxygen2,8e45c640e3640161a5ca9d86cfb1809c175447e9,G치bor Cs치rdi,csardi.gabor@gmail.com,2019-11-05T16:36:18Z,GitHub,noreply@github.com,2019-11-05T16:36:18Z,"Do not escape within \dontshow etc in \examples (#958)

* Add failing tests for escaping \dontshow etc in examples

* Fix (non)escaping dontshow etc in examples

Closes #954.",R/rd-examples.R;tests/testthat/test-rd-examples-dotrun-escape.txt;tests/testthat/test-rd-examples.R,False,True,True,False,43,3,46,"---FILE: R/rd-examples.R---
@@ -37,13 +37,26 @@ format.rd_section_examples <- function(x, ...) {
   rd_macro(x$type, value, space = TRUE)
 }
 
-# Works like escape, but unescapes special rd example commands.
+# We take out the \dontshow{} etc. commands, because these should be
+# left as is, to allow the user to escape braces for example:
+# #' @examples
+# #' \\dontshow{ \{ }
+# #' # Hidden!
+# #' \\dontshow{ \} }
+#
+# Otherwise, it works like escape, but unescapes special rd example commands.
 # Also unescapes quotes because they must already be in strings and hence
 # don't need an additional layer of quoting.
 escape_examples <- function(x) {
+  ex_tags <- c(""\\dontshow"", ""\\dontrun"", ""\\donttest"", ""\\testonly"")
+  rd_tags <- find_fragile_rd_tags(x, ex_tags)
+  x <- x0 <- protect_rd_tags(x, rd_tags)
+
+  attr(x, ""roxygen-markdown-subst"") <- NULL
   x <- escape(x)
   x <- gsub(""\\\\dont"", ""\\dont"", x, fixed = TRUE)
   x <- gsub(""\\\\'"", ""\\'"", x, fixed = TRUE)
   x <- gsub('\\\\""', '\\""', x, fixed = TRUE)
-  x
+
+  rd(unescape_rd_for_md(x, x0))
 }

---FILE: tests/testthat/test-rd-examples-dotrun-escape.txt---
@@ -0,0 +1,7 @@
+> out$get_section(""examples"")
+\examples{
+\dontshow{ \{ }
+# Hidden!
+\dontshow{ \} }
+} 
+

---FILE: tests/testthat/test-rd-examples.R---
@@ -98,6 +98,26 @@ test_that(""escapes within strings are not double escaped"", {
   expect_equal(escape_examples(""'34.00\\'""), rd(""'34.00\\'""))
 })
 
-test_that(""\\dontrun is not escaped"", {
+test_that(""\\dontrun etc. is not escaped #1"", {
   expect_equal(escape_examples(""\\dontrun{x <- 1}""), rd(""\\dontrun{x <- 1}""))
+
+  expect_equal(
+    escape_examples(""\\dontrun{ \\{ x <- 1 \\} }""),
+    rd(""\\dontrun{ \\{ x <- 1 \\} }"")
+  )
+})
+
+test_that(""\\dontrun etc. is not escaped #2"", {
+  out <- roc_proc_text(rd_roclet(), ""
+    #' @name a
+    #' @title a
+    #' @examples
+    #' \\dontshow{ \\{ }
+    #' # Hidden!
+    #' \\dontshow{ \\} }
+    NULL"")[[1]]
+
+  verify_output(test_path(""test-rd-examples-dotrun-escape.txt""), {
+    out$get_section(""examples"")
+  })
 })"
r-lib,roxygen2,7a09fe39a1f0a9caf56c5fb2d4e09afc589a7db5,Hadley Wickham,h.wickham@gmail.com,2019-11-05T16:30:24Z,Hadley Wickham,h.wickham@gmail.com,2019-11-05T16:30:24Z,"More on documenting S3 methods

Fixes #944",vignettes/rd.Rmd,True,False,True,False,13,9,22,"---FILE: vignettes/rd.Rmd---
@@ -162,15 +162,19 @@ Indent the second and subsequent lines of a tag so that when scanning the docume
 
 * It is your choice whether or not to document S3 __methods__. Generally, it's
   not necessary to document straightforward methods for common generics like 
-  `print()`. If your method is more complicated, you should document it 
-  so people know what the parameters do. In base R, you can find documentation 
-  for more complex methods like `?predict.lm`, `?predict.glm`, and `?anova.glm`.
-
-  Generally, roxygen2 will automatically figure the generic associated with an 
-  S3 method. It should only fail if the generic and class are ambiguous. For 
-  example is `all.equal.data.frame()` the `equal.data.frame` method for `all()`, 
-  or the `data.frame` method for `all.equal()`?. If this happens to you, 
-  disambiguate with (e.g.) `@method all.equal data.frame`.
+  `print()`. (You should, however, always `@export` S3 methods).
+  
+  If your method is more complicated, you should document it by setting 
+  `@rdname`. Typically you will document methods with their generic, so you'd
+  document `foofy.data.frame` by setting `@rdname`. In base R, you can find 
+  documentation for more complex methods like `?predict.lm`, `?predict.glm`, 
+  and `?anova.glm`.
+
+  Generally, roxygen2 will automatically figure out the generic that the method
+  belongs to, and you should only need to use `@method` if there is ambiguity.
+  For example, is `all.equal.data.frame()` the `equal.data.frame` method for 
+  `all()`, or the `data.frame` method for `all.equal()`?. If this happens to 
+  you, disambiguate with (e.g.) `@method all.equal data.frame`.
 
 ### S4
 "
r-lib,roxygen2,f84c3a6b52bcd706e2726a96d9aa33c7b81a068c,Hadley Wickham,h.wickham@gmail.com,2019-11-05T16:26:19Z,Hadley Wickham,h.wickham@gmail.com,2019-11-05T16:26:19Z,"Alias `@returns` to `@return`

Fixes #952",NAMESPACE;NEWS.md;R/rd-markdown.R;R/tag-parser.R,False,True,True,False,9,1,10,"---FILE: NAMESPACE---
@@ -142,6 +142,7 @@ S3method(roxy_tag_parse,roxy_tag_rawRd)
 S3method(roxy_tag_parse,roxy_tag_rdname)
 S3method(roxy_tag_parse,roxy_tag_references)
 S3method(roxy_tag_parse,roxy_tag_return)
+S3method(roxy_tag_parse,roxy_tag_returns)
 S3method(roxy_tag_parse,roxy_tag_section)
 S3method(roxy_tag_parse,roxy_tag_seealso)
 S3method(roxy_tag_parse,roxy_tag_slot)
@@ -178,6 +179,7 @@ S3method(roxy_tag_rd,roxy_tag_param)
 S3method(roxy_tag_rd,roxy_tag_rawRd)
 S3method(roxy_tag_rd,roxy_tag_references)
 S3method(roxy_tag_rd,roxy_tag_return)
+S3method(roxy_tag_rd,roxy_tag_returns)
 S3method(roxy_tag_rd,roxy_tag_section)
 S3method(roxy_tag_rd,roxy_tag_seealso)
 S3method(roxy_tag_rd,roxy_tag_slot)

---FILE: NEWS.md---
@@ -48,6 +48,8 @@
     S3method(generic, class)
     ```
 
+*  New `@returns` works the same way as `@return` (#952).
+
 ### R6
 
 roxygen2 now supports documentation for R6 classes (#922).

---FILE: R/rd-markdown.R---
@@ -47,10 +47,14 @@ format.rd_section_references <- function(x, ...) {
 #' @export
 roxy_tag_parse.roxy_tag_return <- function(x) tag_markdown(x)
 #' @export
+roxy_tag_parse.roxy_tag_returns <- roxy_tag_parse.roxy_tag_return
+#' @export
 roxy_tag_rd.roxy_tag_return <- function(x, base_path, env) {
   rd_section(""value"", x$val)
 }
 #' @export
+roxy_tag_rd.roxy_tag_returns <- roxy_tag_rd.roxy_tag_return
+#' @export
 format.rd_section_value <- function(x, ...) {
   format_collapse(x, ...)
 }

---FILE: R/tag-parser.R---
@@ -9,7 +9,7 @@
 #' either call one of the functions here, or directly set `x$val`.
 #'
 #' @param x A [roxy_tag] object to parse
-#' @return A [roxy_tag] object with the `val` field set to the parsed value.
+#' @returns A [roxy_tag] object with the `val` field set to the parsed value.
 #' @name tag_parsers
 #' @keywords internal
 NULL"
r-lib,roxygen2,459181730230b4a751359949198eecd45aa365cf,G치bor Cs치rdi,csardi.gabor@gmail.com,2019-11-05T09:58:13Z,G치bor Cs치rdi,csardi.gabor@gmail.com,2019-11-05T09:58:13Z,Fix typos in test names,tests/testthat/test-rd-r6.R,False,True,True,False,4,4,8,"---FILE: tests/testthat/test-rd-r6.R---
@@ -169,7 +169,7 @@ test_that(""r6_active_bindings"", {
   expect_true(any(grepl(""code{bind2}}{Active 2."", doc, fixed = TRUE)))
 })
 
-test_that(""R56 edge cases, class without methods"", {
+test_that(""R6 edge cases, class without methods"", {
   text <- ""
     #' @title Title
     #' @description Description.
@@ -195,7 +195,7 @@ test_that(""R56 edge cases, class without methods"", {
   expect_false(grepl(""method"", format(rd), ignore.case = TRUE))
 })
 
-test_that(""R56 edge cases, class without (documented) fields"", {
+test_that(""R6 edge cases, class without (documented) fields"", {
   text <- ""
     #' @title Title
     #' @description Description.
@@ -238,7 +238,7 @@ test_that(""R56 edge cases, class without (documented) fields"", {
   expect_false(grepl(""field"", format(rd), ignore.case = TRUE))
 })
 
-test_that(""R56 edge cases, class without active bindings"", {
+test_that(""R6 edge cases, class without active bindings"", {
   text <- ""
     #' @title Title
     #' @description Description.
@@ -260,7 +260,7 @@ test_that(""R56 edge cases, class without active bindings"", {
   expect_false(grepl(""active"", format(rd), ignore.case = TRUE))
 })
 
-test_that(""R56 edge cases, class without anything"", {
+test_that(""R6 edge cases, class without anything"", {
   text <- ""
     #' @title Title
     #' @description Description."
r-lib,roxygen2,b88f2a0d88138db80df213abbacd795ec8d121a2,Hadley Wickham,h.wickham@gmail.com,2019-10-04T13:20:11Z,Hadley Wickham,h.wickham@gmail.com,2019-10-04T13:20:39Z,"Fix typo in usage width

Fixes #929",R/rd-usage.R,False,True,True,False,1,1,2,"---FILE: R/rd-usage.R---
@@ -135,7 +135,7 @@ wrap_usage <- function(name, format_name, formals, suffix = NULL, width = 80L) {
     out <- wrapUsage(x, width = as.integer(width))
   } else {
     args <- paste0(""  "", args)
-    args <- map_chr(args, wrapUsage, width = 95, indent = 4)
+    args <- map_chr(args, wrapUsage, width = 90, indent = 4)
     out <- paste0(format_name(name), ""(\n"", paste0(args, collapse = "",\n""), ""\n)"")
   }
 "
r-lib,roxygen2,ce78fd9feb1cb1424fac0d76f226fee6a79bd9cf,Jeroen Ooms,jeroenooms@gmail.com,2019-10-04T12:56:31Z,Hadley Wickham,h.wickham@gmail.com,2019-10-04T12:56:31Z,Fix typos found with spelling::spell_check_package() (#928),DESCRIPTION;NEWS.md;R/roxygenize.R;R/tag-parser.R;R/topic.R;man/RoxyTopic.Rd;man/roxygenize.Rd;man/tag_parsers.Rd;vignettes/extending.Rmd;vignettes/namespace.Rmd;vignettes/rd.Rmd,True,True,True,False,32,31,63,"---FILE: DESCRIPTION---
@@ -60,3 +60,4 @@ VignetteBuilder:
 Encoding: UTF-8
 Roxygen: list(markdown = TRUE, load = ""installed"")
 RoxygenNote: 6.1.99.9001
+Language: en-GB

---FILE: NEWS.md---
@@ -85,7 +85,7 @@ See `vignette(""rd"")` for details.
   Similarly in external links: `See [*this web page*](https://...)` (#919).
 
 * Use of unsupported markdown features (blockquotes, headings, inline HTML, 
-  and horizontal rules) now gnerate more informative error messages (#804).
+  and horizontal rules) now generate more informative error messages (#804).
 
 ### Default usage
 
@@ -122,7 +122,7 @@ roxygen2 now provides three strategies for loading your code (#822):
 
 * `load_pkgload()`, the default, uses [pkgload](https://www.github.com/r-lib/pkgload). 
   Compared to the previous release, this now automatically recompiles your 
-  pacakge if needed.
+  package if needed.
 
 * `load_source()` attaches required packages and `source()`s code in `R/`. 
   This is a cruder simulation of package loading than using pkgload (and hence
@@ -182,7 +182,7 @@ If you have previously made a new roclet, the major changes are:
     been removed.
 
 * `rd_section()` and `roxy_tag_rd()` are now exported so that you can more 
-  easily extend `rd_roclet()` with your own tags that genereate output in
+  easily extend `rd_roclet()` with your own tags that generate output in
   `.Rd` files.
 
 * `global_options` is no longer passed to all roclet methods. Instead use 
@@ -205,7 +205,7 @@ A big thanks goes to @mikldk for starting on the vignette and motivating me to m
 * Files generated on Windows systems now retain their existing line endings, or use 
   unix-style line endings for new files (@jonthegeek, @jimhester, #840).
   
-* roxygen2 now recgonises fully qualified S4 functions like 
+* roxygen2 now recognises fully qualified S4 functions like 
   `methods::setGeneric()`, `methods::setClass()` and `methods::setMethod()`
   (#880).
 
@@ -246,7 +246,7 @@ A big thanks goes to @mikldk for starting on the vignette and motivating me to m
 * `@inheritDotParams` automatically ignores arguments that can't be inherited
   through `...` because they are used by the current function (@mjskay, #885).
   
-* `@inheritDotParams` includes link to function and wraps paramters
+* `@inheritDotParams` includes link to function and wraps parameters
   in `\code{}` (@halldc, #842)
 
 * `@inheritDotParams` are now permitted (@gustavdelius, #767).
@@ -279,10 +279,10 @@ A big thanks goes to @mikldk for starting on the vignette and motivating me to m
 ## New features
 
 * The `NAMESPACE` roclet now works in two passes - it first generates the
-  `NAMESPACE` containing only import directives becaues this can be generated
+  `NAMESPACE` containing only import directives because this can be generated
   without evaluating the code in the package. This alleviates a problem
   where it was previously possible to get into a state that you could only
-  get out of by carefully editting the `NAMESPACE` by hand (#372).
+  get out of by carefully editing the `NAMESPACE` by hand (#372).
 
 * `@evalRd foo()` evaluates `foo()` defined in the package namespace and inserts
   the results into the current block (#645). The code should return a character
@@ -306,7 +306,7 @@ A big thanks goes to @mikldk for starting on the vignette and motivating me to m
 
 * `roxygenise()` uses `pkgload::load_all()` instead of a home grown solution
   to simulate package loading (this is needed because roxygen2 uses run-time
-  information to generate the documetation). This should reduce S4 related
+  information to generate the documentation). This should reduce S4 related
   problems and ensures that `devtools::document()` and `roxygenise()` always
   have exactly the same behaviour (#568, #595).
 
@@ -486,7 +486,7 @@ A big thanks goes to @mikldk for starting on the vignette and motivating me to m
 
 * You can now document `setClassUnion()`s (#514).
 
-* The default alias for S4 method now re-addeds trailing ANY signatures
+* The default alias for S4 method now re-adds trailing ANY signatures
   that are sometimes dropped (#460).
 
 * Back references are now wrapped over multiple lines, if long
@@ -557,7 +557,7 @@ A big thanks goes to @mikldk for starting on the vignette and motivating me to m
     ```
 
     All imported-and-re-exported functions will be documented in the same
-    file (`rexports.Rd`), containing a brief descrption and links to the
+    file (`rexports.Rd`), containing a brief description and links to the
     original documentation (#376).
 
 *   You can more easily generate package documentation by documenting the
@@ -611,7 +611,7 @@ A big thanks goes to @mikldk for starting on the vignette and motivating me to m
 * `@examples` no longer complains about non-matching braces inside
   strings (#329).
 
-* `@family` now cross-links each manual page only once, instread of linking
+* `@family` now cross-links each manual page only once, instead of linking
   to all aliases (@gaborcsardi, #283, #367).
 
 * The special `@include` parser has also been rewritten in C++, giving

---FILE: R/roxygenize.R---
@@ -1,7 +1,7 @@
 #' Process a package with the Rd, namespace and collate roclets.
 #'
 #' This is the workhorse function that uses roclets, the built-in document
-#' tranformation functions, to build all documentation for a package. See
+#' transformation functions, to build all documentation for a package. See
 #' the documentation for the individual roclets, [rd_roclet()],
 #' [namespace_roclet()], and for [update_collate()],
 #' for more details.

---FILE: R/tag-parser.R---
@@ -8,7 +8,7 @@
 #' To create a new `@mytag` define `roxy_tag_parse.roxy_tag_mytag()`. It should
 #' either call one of the functions here, or directly set `x$val`.
 #'
-#' @param x A [roxy_tag] object to parss
+#' @param x A [roxy_tag] object to parse
 #' @return A [roxy_tag] object with the `val` field set to the parsed value.
 #' @name tag_parsers
 #' @keywords internal

---FILE: R/topic.R---
@@ -20,7 +20,7 @@ RoxyTopic <- R6::R6Class(""RoxyTopic"", public = list(
   filename = """",
 
   #' @description Format the `.Rd` file. It considers the sections in
-  #' particular order, even though Rd tools will reoder them again.
+  #' particular order, even though Rd tools will reorder them again.
   #'
   #' @param ... Passed to the `format()` methods of the [rd_section()]
   #' objects, the sections.
@@ -90,7 +90,7 @@ RoxyTopic <- R6::R6Class(""RoxyTopic"", public = list(
 
   #' @description Query the topics this topic inherits `type` from.
   #' @return A character vector of topic names.
-  
+
   inherits_from = function(type) {
     if (!self$has_section(""inherit"")) {
       return(character())
@@ -107,9 +107,9 @@ RoxyTopic <- R6::R6Class(""RoxyTopic"", public = list(
     sources
   },
 
-  #' @description Query the topix this topic inherits sections from.
+  #' @description Query the topics this topic inherits sections from.
   #' @return A character vector of topic names.
-  
+
   inherits_section_from = function() {
     if (!self$has_section(""inherit_section"")) {
       return(character())
@@ -123,7 +123,7 @@ RoxyTopic <- R6::R6Class(""RoxyTopic"", public = list(
   #' another `RoxyTopic` object, all of its sections will be added;
   #' or an [rd_section] object;
   #' or a list of [rd_section] objects to add.
-  
+
   add = function(x, overwrite = FALSE) {
     if (inherits(x, ""RoxyTopic"")) {
       self$add(x$sections, overwrite = overwrite)
@@ -142,11 +142,11 @@ RoxyTopic <- R6::R6Class(""RoxyTopic"", public = list(
   },
 
   #' @description Add a section.
-  #' @details 
+  #' @details
   #' Ensures that each type of name (as given by its name), only appears
   #' once in `self$sections`. This method if for internal use only.
   #' @param section [rd_section] object to add.
-  
+
   add_section = function(section, overwrite = FALSE) {
     type <- section$type
     if (self$has_section(type) && !overwrite) {

---FILE: man/RoxyTopic.Rd---
@@ -37,7 +37,7 @@ A \code{RoxyTopic} object corresponds to a generated \code{.Rd} file.
 \if{html}{\out{<a id=""method-format""></a>}}
 \subsection{Method \code{format()}}{
 Format the \code{.Rd} file. It considers the sections in
-particular order, even though Rd tools will reoder them again.
+particular order, even though Rd tools will reorder them again.
 \subsection{Usage}{
 \if{html}{\out{<div class=""r"">}}\preformatted{RoxyTopic$format(...)}\if{html}{\out{</div>}}
 }
@@ -179,7 +179,7 @@ A character vector of topic names.
 \if{html}{\out{<hr>}}
 \if{html}{\out{<a id=""method-inherits_section_from""></a>}}
 \subsection{Method \code{inherits_section_from()}}{
-Query the topix this topic inherits sections from.
+Query the topics this topic inherits sections from.
 \subsection{Usage}{
 \if{html}{\out{<div class=""r"">}}\preformatted{RoxyTopic$inherits_section_from()}\if{html}{\out{</div>}}
 }

---FILE: man/roxygenize.Rd---
@@ -30,7 +30,7 @@ created by roxygen before running each roclet.}
 }
 \description{
 This is the workhorse function that uses roclets, the built-in document
-tranformation functions, to build all documentation for a package. See
+transformation functions, to build all documentation for a package. See
 the documentation for the individual roclets, \code{\link[=rd_roclet]{rd_roclet()}},
 \code{\link[=namespace_roclet]{namespace_roclet()}}, and for \code{\link[=update_collate]{update_collate()}},
 for more details.

---FILE: man/tag_parsers.Rd---
@@ -41,7 +41,7 @@ tag_markdown(x)
 tag_markdown_with_sections(x)
 }
 \arguments{
-\item{x}{A \link{roxy_tag} object to parss}
+\item{x}{A \link{roxy_tag} object to parse}
 
 \item{first, second}{Name of first and second parts of two part tags}
 

---FILE: vignettes/extending.Rmd---
@@ -42,7 +42,7 @@ It has the following fields:
 * `tag`: the name of the tag.
 
 * `raw`: the raw contents of the tag (i.e. everything from the end of 
-  this tag to the begining of the net).
+  this tag to the beginning of the net).
   
 * `val`: the parsed value, which we'll come back to shortly.
 

---FILE: vignettes/namespace.Rmd---
@@ -15,7 +15,7 @@ The package `NAMESPACE` is one of the most confusing parts of building a package
 
 ## Exports
 
-For a function to be usable outside of your package, you must __export__ it. By default roxygen2 doesn't export anything from your package. If you want an object to be publically available, you must explicitly tag it with `@export`.
+For a function to be usable outside of your package, you must __export__ it. By default roxygen2 doesn't export anything from your package. If you want an object to be publicly available, you must explicitly tag it with `@export`.
 
 Use the following guidelines to decide what to export:
 
@@ -72,7 +72,7 @@ Use the following guidelines to decide what to export:
 
 ### Specialised exports
 
-Generally, roxygen2 can genereate the correct namespace directive when `@export`ing a specific object. However, you may want to override the defaults and exercise greater control. In this case you can use the more specialised tags described below:
+Generally, roxygen2 can generate the correct namespace directive when `@export`ing a specific object. However, you may want to override the defaults and exercise greater control. In this case you can use the more specialised tags described below:
 
 * `@export foo` generates `export(foo)`
 * `@exportClass foo` generates `exportClasses(foo)`

---FILE: vignettes/rd.Rmd---
@@ -13,7 +13,7 @@ knitr::opts_chunk$set(comment = ""#>"", collapse = TRUE)
 
 ## Basics
 
-A roxygen __block__ is a sequence of lines starting with `#'` (optionally preceeded by whitespace). Blocks gain additional structure through the use of __tags__ like `@tag details`. Tags must start at the beginning of a line, and the content of a tag extends to the start of the next tag (or the end of the block). 
+A roxygen __block__ is a sequence of lines starting with `#'` (optionally preceded by whitespace). Blocks gain additional structure through the use of __tags__ like `@tag details`. Tags must start at the beginning of a line, and the content of a tag extends to the start of the next tag (or the end of the block). 
 
 Text within roxygen blocks can be formatted using markdown or `Rd` commands; see `vignette(""rd-formatting"")` for details.
 
@@ -340,7 +340,7 @@ Package documentation is a good place to put `@section Package options:` that do
 Some notes:
 
 * Package documentation will automatically include information parsed from the
-  `DESCRIPTION`, includoing title, description, list of authors, and useful
+  `DESCRIPTION`, including title, description, list of authors, and useful
   URLs.
 
 * By default, aliases will be added so that both `?pkgname` and 
@@ -387,7 +387,7 @@ There is a tension between the DRY (do not repeat yourself) principle of program
 
 * Document multiple functions in the same topic with `@describeIn` or `@rdname`.
 
-* Run arbtirary R code with `@eval`.
+* Run arbitrary R code with `@eval`.
 
 * Create reusable templates with `@template` and `@templateVar`.
 
@@ -633,7 +633,7 @@ Three other tags make it easier for the user to find documentation within R's he
     Keywords are optional, but if present, must be taken from the 
     predefined list found `file.path(R.home(""doc""), ""KEYWORDS""))`.
 
-Apart from `@keywords internal`, these tags are not very useful because most people find documentation using goole. `@keywords internal` is useful because it removes the function from the documentation index; it's useful for functions aimed primarily at other developers, not typical users of the package.
+Apart from `@keywords internal`, these tags are not very useful because most people find documentation using Google. `@keywords internal` is useful because it removes the function from the documentation index; it's useful for functions aimed primarily at other developers, not typical users of the package.
 
 ### Back references
 "
r-lib,roxygen2,109de43eb5b5bd1208316993ed8b1518898aadf0,Hadley Wickham,h.wickham@gmail.com,2019-10-04T11:12:10Z,Hadley Wickham,h.wickham@gmail.com,2019-10-04T11:12:10Z,"Only add package to link if package has topic

Fixes #925",R/utils-rd.R;tests/testthat/test-utils-rd.R,False,True,True,False,15,5,20,"---FILE: R/utils-rd.R---
@@ -78,7 +78,7 @@ tweak_links <- function(x, package) {
 
   if (is.list(x)) {
     if (!is.null(tag) && tag == ""\\link"") {
-      if (is.null(attr(x, ""Rd_option""))) {
+      if (is.null(attr(x, ""Rd_option"")) && has_topic(x[[1]], package)) {
         attr(x, ""Rd_option"") <- structure(package, Rd_tag = ""TEXT"")
       }
     } else if (length(x) > 0) {
@@ -118,3 +118,13 @@ make_as_character_rd <- function() {
   body(fn) <- body
   fn
 }
+
+has_topic <- function(topic, package) {
+  tryCatch(
+    {
+      help((topic), package = (package))
+      TRUE
+    },
+    error = function(c) FALSE
+  )
+}

---FILE: tests/testthat/test-utils-rd.R---
@@ -3,9 +3,9 @@ test_that(""href doesn't get extra parens"", {
 })
 
 test_that(""can tweak links to point to new package"", {
-  rd1 <- tweak_links(parse_rd(""\\link{foo}""), package = ""bar"")
-  rd2 <- tweak_links(parse_rd(""\\link[baz]{foo}""), package = ""bar"")
+  rd1 <- tweak_links(parse_rd(""\\link{roclet}""), package = ""roxygen2"")
+  rd2 <- tweak_links(parse_rd(""\\link[roxygen2]{roclet}""), package = ""roxygen2"")
 
-  expect_equal(rd2text(rd1), ""\\link[bar]{foo}\n"")
-  expect_equal(rd2text(rd2), ""\\link[baz]{foo}\n"")
+  expect_equal(rd2text(rd1), ""\\link[roxygen2]{roclet}\n"")
+  expect_equal(rd2text(rd2), ""\\link[roxygen2]{roclet}\n"")
 })"
r-lib,roxygen2,28e42c8aa8cd657d165bf6b253723ad09b55fcbe,G치bor Cs치rdi,csardi.gabor@gmail.com,2019-10-03T21:37:46Z,Hadley Wickham,h.wickham@gmail.com,2019-10-03T21:37:46Z,"Markdown improvements (#919)

* Support inline and block HTML in @includeRmd

* Allow markup in markdown headings

* Allow markup within markdown link text

* Fix HTML block test case with older pandoc

* Keep markdown code block language info in Rd HTML

* Add NEWS for formatting in markdown link text",NEWS.md;R/markdown-link.R;R/markdown.R;tests/testthat/test-markdown-link.R;tests/testthat/test-markdown.R;tests/testthat/test-rd-includermd.R,False,True,True,False,198,21,219,"---FILE: NEWS.md---
@@ -80,6 +80,10 @@ See `vignette(""rd"")` for details.
 * Rd comments (`%`) are automatically escaped. You will need to replace any
   existing uses of `\%` with `%` (#879).
 
+* Markdown links can now contain formatting. E.g. in
+  `See [*Formatting*][formatting]` the link text will be emphasised.
+  Similarly in external links: `See [*this web page*](https://...)` (#919).
+
 * Use of unsupported markdown features (blockquotes, headings, inline HTML, 
   and horizontal rules) now gnerate more informative error messages (#804).
 

---FILE: R/markdown-link.R---
@@ -82,7 +82,7 @@ add_linkrefs_to_md <- function(text) {
 #' @noRd
 #' @importFrom xml2 xml_name
 
-parse_link <- function(destination, contents) {
+parse_link <- function(destination, contents, state) {
 
   ## Not a [] or [][] type link, remove prefix if it is
   if (! grepl(""^R:"", destination)) return(NULL)
@@ -139,7 +139,7 @@ parse_link <- function(destination, contents) {
     )
 
   } else {
-    contents <- mdxml_link_text(contents)
+    contents <- mdxml_link_text(contents, state)
 
     list(
       paste0(

---FILE: R/markdown.R---
@@ -33,7 +33,8 @@ mdxml_children_to_rd <- function(xml, state) {
 
 #' @importFrom xml2 xml_name xml_type xml_text xml_contents xml_attr xml_children
 mdxml_node_to_rd <- function(xml, state) {
-  if (!inherits(xml, ""xml_node"") || xml_type(xml) != ""element"") {
+  if (!inherits(xml, ""xml_node"") ||
+      ! xml_type(xml) %in% c(""text"", ""element"")) {
     roxy_tag_warning(state$tag, ""Internal markdown translation failure"")
     return("""")
   }
@@ -47,25 +48,26 @@ mdxml_node_to_rd <- function(xml, state) {
     text = escape_comment(xml_text(xml)),
     emph = paste0(""\\emph{"", mdxml_children_to_rd(xml, state), ""}""),
     strong = paste0(""\\strong{"", mdxml_children_to_rd(xml, state), ""}""),
-    softbreak = ""\n"",
-    linebreak = ""\n"",
+    softbreak = mdxml_break(state),
+    linebreak = mdxml_break(state),
 
     code = mdxml_code(xml, state),
-    code_block = paste0(""\\preformatted{"", escape_verb(xml_text(xml)), ""}""),
+    code_block = mdxml_code_block(xml, state),
 
     table = mdxml_table(xml, state),
     list = mdxml_list(xml, state),
     item = mdxml_item(xml, state),
-    link = mdxml_link(xml),
+    link = mdxml_link(xml, state),
     image = mdxml_image(xml),
+    heading = mdxml_heading(xml, state),
 
     # Only supported when including Rmds
-    heading = mdxml_heading(xml, state),
+    html_block = mdxml_html_block(xml, state),
+    html_inline = mdxml_html_inline(xml, state),
 
     # Not supported
     block_quote = mdxml_unsupported(xml, state$tag, ""block quotes""),
     hrule = mdxml_unsupported(xml, state$tag, ""horizontal rules""),
-    html_inline = mdxml_unsupported(xml, state$tag, ""inline HTML""),
     mdxml_unknown(xml, state$tag)
   )
 }
@@ -79,6 +81,10 @@ mdxml_unsupported <- function(xml, tag, feature) {
   escape_comment(xml_text(xml))
 }
 
+mdxml_break <- function(state) {
+  if (isTRUE(state$inlink)) "" "" else ""\n""
+}
+
 mdxml_code <- function(xml, tag) {
   code <- xml_text(xml)
 
@@ -91,6 +97,18 @@ mdxml_code <- function(xml, tag) {
   }
 }
 
+mdxml_code_block <- function(xml, state) {
+  info <- xml_attr(xml, ""info"")[1]
+  if (is.na(info) || nchar(info[1]) == 0) info <- NA_character_
+  paste0(
+    if (!is.na(info)) paste0(""\\if{html}{\\out{<div class=\"""", info, ""\"">}}""),
+    ""\\preformatted{"",
+    escape_verb(xml_text(xml)),
+    ""}"",
+    if (!is.na(info)) ""\\if{html}{\\out{</div>}}""
+  )
+}
+
 can_parse <- function(x) {
   tryCatch({
     parse_expr(x)
@@ -147,29 +165,32 @@ mdxml_item <- function(xml, state) {
   paste0(""\n\\item "", cnts)
 }
 
-mdxml_link <- function(xml) {
+mdxml_link <- function(xml, state) {
   ## Hyperlink, this can also be a link to a function
   dest <- xml_attr(xml, ""destination"")
   contents <- xml_contents(xml)
 
-  link <- parse_link(dest, contents)
+  link <- parse_link(dest, contents, state)
 
   if (!is.null(link)) {
     paste0(link, collapse = """")
   } else if (dest == """" || dest == xml_text(xml)) {
     paste0(""\\url{"", escape_comment(xml_text(xml)), ""}"")
   } else {
-    paste0(""\\href{"", dest, ""}{"", mdxml_link_text(contents), ""}"")
+    paste0(""\\href{"", dest, ""}{"", mdxml_link_text(contents, state), ""}"")
   }
 }
 
-# Newlines in markdown get converted to softbreaks/linebreaks by
-# markdown_xml(), which then get interpreted as empty strings by
-# xml_text(). So we preserve newlines as spaces.
-mdxml_link_text <- function(xml_contents) {
-  text <- xml_text(xml_contents)
-  text[xml_name(xml_contents) %in% c(""linebreak"", ""softbreak"")] <- "" ""
-  escape_comment(paste0(text, collapse = """"))
+mdxml_link_text <- function(xml_contents, state) {
+  # Newlines in markdown get converted to softbreaks/linebreaks by
+  # markdown_xml(), which then get interpreted as empty strings by
+  # xml_text(). So we preserve newlines as spaces.
+  inlink <- state$inlink
+  on.exit(state$inlink <- inlink, add = TRUE)
+  state$inlink <- TRUE
+
+  text <- map_chr(xml_contents, mdxml_node_to_rd, state)
+  paste0(text, collapse = """")
 }
 
 mdxml_image = function(xml) {
@@ -187,17 +208,40 @@ mdxml_heading <- function(xml, state) {
   if (! state$has_sections && level == 1) {
     return(mdxml_unsupported(xml, state$tag, ""level 1 markdown headings""))
   }
+  txt <- map_chr(xml_contents(xml), mdxml_node_to_rd, state)
   head <- paste0(
     mdxml_close_sections(state, level),
     ""\n"",
     if (level == 1) paste0(state$section_tag, ""\\section{""),
     if (level > 1) ""\\subsection{"",
-    xml_text(xml),
+    paste(txt, collapse = """"),
     ""}{"")
   state$section <- c(state$section, level)
   head
 }
 
+mdxml_html_block <- function(xml, state) {
+  if (state$tag$tag != ""includeRmd"") {
+    return(mdxml_unsupported(xml, state$tag, ""HTML blocks""))
+  }
+  paste0(
+    ""\\if{html}{\\out{\n"",
+    gsub(""}"", ""\\}"", xml_text(xml), fixed = TRUE),
+    ""}}\n""
+  )
+}
+
+mdxml_html_inline <- function(xml, state) {
+  if (state$tag$tag != ""includeRmd"") {
+    return(mdxml_unsupported(xml, state$tag, ""inline HTML""))
+  }
+  paste0(
+    ""\\if{html}{\\out{"",
+    gsub(""}"", ""\\}"", xml_text(xml), fixed = TRUE),
+    ""}}""
+  )
+}
+
 #' @importFrom utils head tail
 
 mdxml_close_sections <- function(state, upto = 1L) {

---FILE: tests/testthat/test-markdown-link.R---
@@ -414,3 +414,19 @@ test_that(""linebreak in 'text' of [text][foo] turns into single space"", {
 
 })
 
+test_that(""markup in link text"", {
+  out1 <- roc_proc_text(rd_roclet(), ""
+    #' Title
+    #'
+    #' Description, see [`code link text`][func].
+    #' And also [`code as well`](https://external.com).
+    #' @md
+    foo <- function() {}"")[[1]]
+  out2 <- roc_proc_text(rd_roclet(), ""
+    #' Title
+    #'
+    #' Description, see \\code{\\link[=func]{code link text}}.
+    #' And also \\href{https://external.com}{\\verb{code as well}}.
+    foo <- function() {}"")[[1]]
+  expect_equivalent_rd(out1, out2)
+})

---FILE: tests/testthat/test-markdown.R---
@@ -22,7 +22,7 @@ test_that(""code blocks work"", {
     #' Description
     #'
     #' Details with a code block:
-    #' ```r
+    #' ```
     #' x <- 1:10 %>%
     #'   multiply_by(10) %>%
     #'   add(42)
@@ -45,6 +45,36 @@ test_that(""code blocks work"", {
   expect_equivalent_rd(out1, out2)
 })
 
+test_that(""code block with language creates HTML tag"", {
+  out1 <- roc_proc_text(rd_roclet(), ""
+    #' Title
+    #'
+    #' Description
+    #'
+    #' Details with a code block:
+    #' ```r
+    #' x <- 1:10 %>%
+    #'   multiply_by(10) %>%
+    #'   add(42)
+    #' ```
+    #' Normal text again.
+    #' @md
+    foo <- function() {}"")[[1]]
+  out2 <- roc_proc_text(rd_roclet(), ""
+    #' Title
+    #'
+    #' Description
+    #'
+    #' Details with a code block:\\if{html}{\\out{<div class=\""r\"">}}\\preformatted{x <- 1:10 \\%>\\%
+    #'   multiply_by(10) \\%>\\%
+    #'   add(42)
+    #' }\\if{html}{\\out{</div>}}
+    #'
+    #' Normal text again.
+    foo <- function() {}"")[[1]]
+  expect_equivalent_rd(out1, out2)
+})
+
 test_that(""inline code escapes %"", {
   expect_equal(markdown(""`5%`""), ""\\verb{5\\%}"")
   expect_equal(markdown(""`'5%'`""), ""\\code{'5\\%'}"")
@@ -569,3 +599,34 @@ test_that(""markdown() on empty input"", {
   expect_identical(markdown(""  ""), """")
   expect_identical(markdown(""\n""), """")
 })
+
+test_that(""markup in headings"", {
+  text1 <- ""
+    #' Title
+    #'
+    #' Description.
+    #'
+    #' @details
+    #' Leading text goes into details.
+    #' # Section with `code`
+    #' ## Subsection with **strong**
+    #' Yes.
+    #' @md
+    #' @name x
+    NULL
+  ""
+  out1 <- roc_proc_text(rd_roclet(), text1)[[1]]
+  expect_equal(
+    out1$get_value(""rawRd""),
+    paste(
+      sep = ""\n"",
+      ""\\section{Section with \\code{code}}{"",
+      ""\\subsection{Subsection with \\strong{strong}}{"",
+      """",
+      ""Yes."",
+      ""}"",
+      """",
+      ""}""
+      )
+  )
+})

---FILE: tests/testthat/test-rd-includermd.R---
@@ -151,3 +151,55 @@ test_that(""empty Rmd"", {
   cat(""\n"", sep = """", file = tmp)
   expect_equal(rmd_eval_rd(tmp, tag), """")
 })
+
+test_that(""inline html"", {
+  skip_if_not(rmarkdown::pandoc_available())
+
+  tmp <- tempfile(fileext = "".md"")
+  on.exit(unlink(tmp, recursive = TRUE), add = TRUE)
+  cat(sep = ""\n"", file = tmp,
+    ""Text at the front"",
+    """",
+    """",
+    ""## Subsection in details"",
+    """",
+    ""Some subsection text with <span>inline html</span>."")
+  rox <- sprintf(""
+    #' Title
+    #' @includeRmd %s
+    #' @name foobar
+    NULL"", tmp)
+  out1 <- roc_proc_text(rd_roclet(), rox)[[1]]
+  exp_details <- paste0(
+    ""Text at the front"",
+    ""\\subsection{Subsection in details}{"",
+    ""Some subsection text with "",
+    ""\\if{html}{\\out{<span>}}inline html\\if{html}{\\out{</span>}}.\n}""
+  )
+  expect_equal_strings(out1$get_value(""details""), exp_details)
+})
+
+test_that(""html block"", {
+  skip_if_not(rmarkdown::pandoc_available())
+
+  tmp <- tempfile(fileext = "".md"")
+  on.exit(unlink(tmp, recursive = TRUE), add = TRUE)
+  cat(sep = ""\n"", file = tmp,
+    ""Text at the front"",
+    """",
+    ""<a id=\""test\""></a>"",
+    """",
+    ""Text"")
+  rox <- sprintf(""
+    #' Title
+    #' @includeRmd %s
+    #' @name foobar
+    NULL"", tmp)
+  out1 <- roc_proc_text(rd_roclet(), rox)[[1]]
+  exp_details <- paste0(
+    ""Text at the front"",
+    ""\\if{html}{\\out{<a id=\""test\"">}}\\if{html}{\\out{</a>}}"",
+    ""Text""
+  )
+  expect_equal_strings(out1$get_value(""details""), exp_details)
+})"
r-lib,roxygen2,55273568fac4201089b1b3cc17bbd33ac1205acb,G치bor Cs치rdi,csardi.gabor@gmail.com,2019-10-03T08:44:11Z,G치bor Cs치rdi,csardi.gabor@gmail.com,2019-10-03T13:22:21Z,"Improve superclass information

* Fix shadowed method detection in method list.
* Fix class order in hierarchy.
* Order methods according to class hierarchy in
  method list.",R/object-r6.R;R/rd-r6.R,False,True,True,False,7,4,11,"---FILE: R/object-r6.R---
@@ -101,7 +101,8 @@ extract_r6_super_data <- function(x) {
     c(""method"", ""field"", ""active""),
     c(length(method_nms), length(field_nms), length(active_nms))
   )
-  names <-c(sort(method_nms), sort(field_nms), sort(active_nms))
+  rsort <- function(x) sort(x, decreasing = TRUE)
+  names <-c(rsort(method_nms), rsort(field_nms), rsort(active_nms))
   mth <- rbind(
     data.frame(
       stringsAsFactors = FALSE,

---FILE: R/rd-r6.R---
@@ -75,7 +75,7 @@ r6_superclass <- function(block, r6data, env) {
   pkgs <- super$classes$package[match(cls, super$classes$classname)]
   path <- sprintf(""\\code{\\link[%s:%s]{%s::%s}}"", pkgs, cls, pkgs, cls)
   me <- sprintf(""\\code{%s}"", block$object$value$classname)
-  push(paste(c(path, me), collapse = "" -> ""))
+  push(paste(c(rev(path), me), collapse = "" -> ""))
 
   push(""}"")
 
@@ -244,8 +244,10 @@ r6_inherited_method_list <- function(block, r6data) {
   # drop methods that were shadowed in a subclass
   super_meth <- super$members[super$members$type == ""method"", ]
   self <- r6data$self
-  super <- super_meth[! super_meth$name %in% self$name, ]
-  super <- super_meth[! duplicated(super_meth$name), ]
+  super_meth <- super_meth[! super_meth$name %in% self$name, ]
+  super_meth <- super_meth[! duplicated(super_meth$name), ]
+
+  super_meth <- super_meth[rev(seq_len(nrow(super_meth))), ]
 
   c(""\\if{html}{\\subsection{Inherited methods}{"",
     ""\\itemize{"","
r-lib,roxygen2,9a8a94eaa6d81301c5af730453fed2ce2f698bac,G치bor Cs치rdi,csardi.gabor@gmail.com,2019-09-30T13:51:23Z,G치bor Cs치rdi,csardi.gabor@gmail.com,2019-10-03T13:22:20Z,"Leave out @param from an R6 block, but inherit them into methods

The prefix (i.e. _not_ inline) docs may contain @param tags,
that the methods automatically inherit, if needed. The methods
can also override these arguments, in which case they won't be
inherited. These @param tags will be left out from the man page
of the class otherwise.

If you want to document a function on the same page as the class,
e.g. a factory function, then include its arguments in a
separate block, the block of the function.

This is experimental, and might still change. One drawback is that
we cannot inherit currently from or into the method docs, but
we can probably fix this later.",R/rd-r6.R,False,True,True,False,38,13,51,"---FILE: R/rd-r6.R---
@@ -38,9 +38,12 @@ topic_add_r6_methods <- function(rd, block, env) {
 
   block$tags[del] <- NULL
 
-  # Now do the main tags first
+  # Now do the main tags first. We leave out the param tags, those are
+  # for the methods
   for (tag in block$tags) {
-    rd$add(roxy_tag_rd(tag, env = env, base_path = base_path))
+    if (tag$tag != ""param"") {
+      rd$add(roxy_tag_rd(tag, env = env, base_path = base_path))
+    }
   }
 
   # We need to add the whole thing as a big section.
@@ -187,32 +190,54 @@ r6_method_details <- function(block, method) {
 
 r6_method_params <- function(block, method) {
   par <- purrr::keep(method$tags[[1]], function(t) t$tag == ""param"")
-  nms <- map_chr(par, c(""val"", ""name""))
-  nms <- gsub("","", "", "", nms)
+  nms <- gsub("","", "", "", map_chr(par, c(""val"", ""name"")))
 
   # Each arg should appear exactly once
   mnames <- str_trim(unlist(strsplit(nms, "","")))
+  dup <- unique(mnames[duplicated(mnames)])
+  for (m in dup) {
+    msg <- sprintf(
+      ""Argument `%s` documented multiple times for R6 method `%s` at %s:%i"",
+      m, method$name, method$file, method$line)
+    warning(msg, call. = FALSE, immediate. = TRUE)
+  }
+
+  # Now add the missing ones from the class
   fnames <- names(method$formals[[1]])
   miss <- setdiff(fnames, mnames)
-  for (m in miss) {
+  is_in_cls <- map_lgl(
+    block$tags,
+    function(t) {
+      !is.na(t$line) && t$line < block$line && t$tag == ""param"" &&
+        t$val$name %in% miss
+    }
+  )
+  par <- c(par, block$tags[is_in_cls])
+
+  # Check if anything is missing
+  nms <- gsub("","", "", "", map_chr(par, c(""val"", ""name"")))
+  mnames <- str_trim(unlist(strsplit(nms, "","")))
+  miss <- setdiff(fnames, mnames)
+    for (m in miss) {
     msg <- sprintf(
       ""Undocumented argument for R6 method `%s()` at %s:%i: `%s`"",
       method$name, method$file, method$line, m
     )
     warning(msg, call. = FALSE, immediate. = TRUE)
   }
 
-  dup <- unique(mnames[duplicated(mnames)])
-  for (m in dup) {
-    msg <- sprintf(
-      ""Argument `%s` documented multiple times for R6 method `%s` at %s:%i"",
-      m, method$name, method$file, method$line)
-    warning(msg, call. = FALSE, immediate. = TRUE)
-  }
-
   if (length(par) == 0) return()
 
+  # Order them according to formals
+  firstnames <- str_trim(
+    map_chr(strsplit(map_chr(par, c(""val"", ""name"")), "",""), 1)
+  )
+  par <- par[order(match(firstnames, fnames))]
+
   val <- map_chr(par, c(""val"", ""description""))
+  nms <- gsub("","", "", "", map_chr(par, c(""val"", ""name"")))
+
+  # Ready to go
   c(
     ""\\subsection{Arguments}{"",
     ""\\if{html}{\\out{<div class=\""arguments\"">}}"","
r-lib,roxygen2,c26b1a560ef3d7dd65f4b3f4a8d71b693acad9af,Hadley Wickham,h.wickham@gmail.com,2019-10-01T21:39:26Z,Hadley Wickham,h.wickham@gmail.com,2019-10-01T21:39:26Z,"Add missing $value

And add regression test

Fixes #921",R/object-import.R;tests/testthat/test-object-import.R;tests/testthat/test-object-import.txt,False,True,True,False,20,1,21,"---FILE: R/object-import.R---
@@ -17,7 +17,7 @@ merge.rd_section_reexport <- function(x, y, ...) {
 }
 #' @export
 format.rd_section_reexport <- function(x, ...) {
-  pkgs <- split(x$fun, x$pkg)
+  pkgs <- split(x$value$fun, x$value$pkg)
   pkg_links <- map2(names(pkgs), pkgs, function(pkg, funs) {
     links <- paste0(""\\code{\\link["", pkg, ""]{"", escape(sort(funs)), ""}}"",
       collapse = "", "")

---FILE: tests/testthat/test-object-import.R---
@@ -9,6 +9,8 @@ test_that(""exporting a call to :: produces re-exports documentation"", {
   )
   expect_equal(out$get_value(""title""), ""Objects exported from other packages"")
   expect_equal(out$get_value(""keyword""), ""internal"")
+
+  verify_output(test_path(""test-object-import.txt""), cat(format(out)))
 })
 
 test_that(""multiple re-exports are combined"", {

---FILE: tests/testthat/test-object-import.txt---
@@ -0,0 +1,17 @@
+> cat(format(out))
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in ./<text>
+\docType{import}
+\name{reexports}
+\alias{reexports}
+\alias{auto_test}
+\title{Objects exported from other packages}
+\keyword{internal}
+\description{
+These objects are imported from other packages. Follow the links
+below to see their documentation.
+
+\describe{
+  \item{testthat}{\code{\link[testthat]{auto_test}}}
+}}
+"
r-lib,roxygen2,297761b16b30ad79a0e61eccc2d75dc68902cdd3,Hadley Wickham,h.wickham@gmail.com,2019-10-01T21:37:15Z,Hadley Wickham,h.wickham@gmail.com,2019-10-01T21:37:15Z,"Render markdown tables

Fixes #920",NEWS.md;R/markdown-link.R;R/markdown.R;man/markdown-test.Rd;tests/testthat/test-markdown-table.txt;tests/testthat/test-markdown.R;vignettes/rd-formatting.Rmd,True,True,True,False,86,1,87,"---FILE: NEWS.md---
@@ -1,5 +1,15 @@
 # roxygen2 (development version)
 
+* Markdown tables are now converted to the Rd `\tabular{}` command (#290).
+  roxygen2 supports the [GFM table syntax](https://github.github.com/gfm/#tables-extension-)
+  which looks like:
+  
+    ```md
+    | foo | bar |
+    | --- | --- |
+    | baz | bim |
+    ```
+
 * `global_options` is no longer passed to all roclet methods. Instead use 
   `roxy_meta_get()` to retrieve values stored in the options (#918).
 

---FILE: R/markdown-link.R---
@@ -170,6 +170,13 @@ parse_link <- function(destination, contents) {
 #'
 #' In another package: [and this one][devtools::document].
 #'
+#' This is a table:
+#'
+#' | __foo__ | __bar__ |
+#' | :-- | --: |
+#' | 1   | 2   |
+#' | 100 | 200 |
+#'
 #' @name markdown-test
 #' @keywords internal
 NULL

---FILE: R/markdown.R---
@@ -12,7 +12,7 @@ markdown <- function(text, tag = NULL, sections = FALSE) {
 }
 
 md_to_mdxml <- function(x) {
-  md <- commonmark::markdown_xml(x, hardbreaks = TRUE)
+  md <- commonmark::markdown_xml(x, hardbreaks = TRUE, extensions = ""table"")
   xml2::read_xml(md)
 }
 
@@ -53,6 +53,7 @@ mdxml_node_to_rd <- function(xml, state) {
     code = mdxml_code(xml, state),
     code_block = paste0(""\\preformatted{"", escape_verb(xml_text(xml)), ""}""),
 
+    table = mdxml_table(xml, state),
     list = mdxml_list(xml, state),
     item = mdxml_item(xml, state),
     link = mdxml_link(xml),
@@ -105,6 +106,20 @@ escape_verb <- function(x) {
   x
 }
 
+mdxml_table <- function(xml, state) {
+  head <- xml_children(xml)[[1]]
+  align <- substr(xml_attr(xml_children(head), ""align"", default = ""left""), 1, 1)
+
+  rows <- xml_children(xml)
+  rows <- map(rows, xml_children)
+  rows_rd <- map(rows, ~ map_chr(xml_children(.x), mdxml_node_to_rd, state = state))
+  rows_rd <- map_chr(rows_rd, paste0, collapse = "" \\tab "")
+
+  paste0(""\\tabular{"", paste(align, collapse = """"), ""}{\n"",
+    paste(""  "", rows_rd, ""\\cr\n"", collapse = """"),
+  ""}\n"")
+}
+
 # A list, either bulleted or numbered
 mdxml_list <- function(xml, state) {
   type <- xml_attr(xml, ""type"")

---FILE: man/markdown-test.Rd---
@@ -16,5 +16,11 @@ Link with link text: \link[=roxygenize]{this great function},
 \code{\link[=roxygenize]{roxygenize}}, or \link[=roxygenize]{that great function}.
 
 In another package: \link[devtools:document]{and this one}.
+
+This is a table:\tabular{lr}{
+   \strong{foo} \tab \strong{bar} \cr
+   1 \tab 2 \cr
+   100 \tab 200 \cr
+}
 }
 \keyword{internal}

---FILE: tests/testthat/test-markdown-table.txt---
@@ -0,0 +1,11 @@
+> cat(markdown(
++   ""\n| x   | y   |\n| --- | --- |\n| 1   | 2   |\n\n| x   | y   |\n| :-: | --: |\n| 1   | 2   |\n    ""))
+\tabular{ll}{
+   x \tab y \cr
+   1 \tab 2 \cr
+}
+\tabular{cr}{
+   x \tab y \cr
+   1 \tab 2 \cr
+}
+

---FILE: tests/testthat/test-markdown.R---
@@ -189,6 +189,24 @@ test_that(""nested lists are OK"", {
 })
 
 
+# tables ------------------------------------------------------------------
+
+
+test_that(""can convert table to Rd"", {
+  verify_output(
+    test_path(""test-markdown-table.txt""),
+    cat(markdown(""
+| x   | y   |
+| --- | --- |
+| 1   | 2   |
+
+| x   | y   |
+| :-: | --: |
+| 1   | 2   |
+    ""))
+  )
+})
+
 # inline formatting -------------------------------------------------------
 
 test_that(""emphasis works"", {

---FILE: vignettes/rd-formatting.Rmd---
@@ -151,6 +151,24 @@ Nested lists are also supported.
 
 Note that you do not have leave an empty line before the list. This is different from some markdown parsers.
 
+## Tables
+
+Use [GFM table formatting](https://github.github.com/gfm/#tables-extension-):
+
+```r
+| foo | bar |
+| --- | --- |
+| baz | bim |
+```
+
+By default, columns are left-aligned. Use colons to generate right and center aligned columns:
+
+```r
+| left | center | right |
+| :--- | :----: | ----: |
+| 1    | 2      | 3     |
+```
+
 ## Links
 
 Markdown hyperlinks work as usual:"
r-lib,roxygen2,ef699cc48bda48f4df2632d87147b1602b67e8a3,Hadley Wickham,h.wickham@gmail.com,2019-10-01T20:07:32Z,Hadley Wickham,h.wickham@gmail.com,2019-10-01T20:08:04Z,"Unify options and meta

Fixes #918",NAMESPACE;NEWS.md;R/block.R;R/load.R;R/markdown-state.R;R/meta.R;R/namespace.R;R/object-usage.R;R/options.R;R/parse.R;R/rd-template.R;R/rd.R;R/roclet.R;R/roxygenize.R;R/tokenize.R;R/vignette.R;man/load_options.Rd;man/parse_package.Rd;man/roc_proc_text.Rd;man/roclet.Rd;tests/testthat/test-load.R;tests/testthat/test-markdown-state.R;tests/testthat/test-meta.R;tests/testthat/test-object-usage.R;vignettes/extending.Rmd,True,True,True,False,130,286,416,"---FILE: NAMESPACE---
@@ -205,6 +205,7 @@ export(roclet_preprocess)
 export(roclet_process)
 export(roclet_tags)
 export(roxy_block)
+export(roxy_meta_get)
 export(roxy_tag)
 export(roxy_tag_parse)
 export(roxy_tag_rd)

---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* `global_options` is no longer passed to all roclet methods. Instead use 
+  `roxy_meta_get()` to retrieve values stored in the options (#918).
+
 * `@description` and `@detail` tags automatically generated from the leading
   description block now have correct line numbers (#917).
 

---FILE: R/block.R---
@@ -73,10 +73,9 @@ print.roxy_block <- function(x, ...) {
   cat_line(""  "", obj[-1])
 }
 
-block_create <- function(tokens, call, srcref,
-                         global_options = list()) {
+block_create <- function(tokens, call, srcref) {
 
-  tags <- parse_tags(tokens, global_options = global_options)
+  tags <- parse_tags(tokens)
   if (length(tags) == 0) return()
 
   roxy_block(tags,
@@ -86,18 +85,13 @@ block_create <- function(tokens, call, srcref,
   )
 }
 
-block_set_env <- function(block, env,
-                          global_options = list()
-                          ) {
-
-  block <- block_evaluate(block, env, global_options = global_options)
+block_set_env <- function(block, env) {
+  block <- block_evaluate(block, env)
   block <- block_find_object(block, env)
   block
 }
 
-block_evaluate <- function(block, env,
-                           global_options = list()
-                           ) {
+block_evaluate <- function(block, env) {
 
   tags <- block_get_tags(block, ""eval"")
   if (length(tags) == 0) {
@@ -119,7 +113,7 @@ block_evaluate <- function(block, env,
     file = block$file,
     offset = block$line
   )
-  tags <- lapply(tokens, parse_tags, global_options = global_options)
+  tags <- lapply(tokens, parse_tags)
 
   # Interpolate results back into original locations
   block_replace_tags(block, ""eval"", tags)
@@ -199,8 +193,8 @@ block_replace_tags <- function(block, tags, values) {
 
 # parsing -----------------------------------------------------------------
 
-parse_tags <- function(tokens, global_options = list()) {
-  markdown_activate(tokens, global_options = global_options)
+parse_tags <- function(tokens) {
+  markdown_activate(tokens)
 
   tokens <- parse_description(tokens)
   compact(lapply(tokens, roxy_tag_parse))

---FILE: R/load.R---
@@ -74,13 +74,13 @@ sys_source <- function(file, envir = baseenv()) {
 
 # Helpers -----------------------------------------------------------------
 
-find_load_strategy <- function(x, options) {
+find_load_strategy <- function(x, option = roxy_meta_get(""load"", ""pkgload"")) {
   if (is.function(x)) {
     return(x)
   }
 
   if (is.null(x)) {
-    x <- options$load
+    x <- option
     if (!is.character(x) || length(x) != 1) {
       abort(""roxygen2 `load` option must be a string"")
     }

---FILE: R/markdown-state.R---
@@ -4,9 +4,6 @@ roxy_tag_parse.roxy_tag_md <- function(x) tag_toggle(x)
 #' @export
 roxy_tag_parse.roxy_tag_noMd <- function(x) tag_toggle(x)
 
-## If not specified in DESCRIPTION
-markdown_global_default <- FALSE
-
 ## Hacky global switch - this uses the fact that blocks are parsed
 ## one after the another, and that we set markdown on/off before each
 ## block
@@ -19,10 +16,8 @@ markdown_on <- function(value = NULL) {
   return(isTRUE(markdown_env$`markdown-support`))
 }
 
-markdown_activate <- function(tags, global_options = list()) {
+markdown_activate <- function(tags) {
   ## markdown on/off based on global flag and presence of @md & @nomd
-  ## we need to use markdown_global_default as well, because global_options
-  ## can be NULL, e.g. if called from parse_text()
 
   names <- purrr::map_chr(tags, ""tag"")
   has_md <- ""md"" %in% names
@@ -32,7 +27,7 @@ markdown_activate <- function(tags, global_options = list()) {
     roxy_tag_warning(tags[[1]], ""Both @md and @noMd, no markdown parsing"")
   }
 
-  md <- global_options$markdown %||% markdown_global_default
+  md <- roxy_meta_get(""markdown"", FALSE)
   if (has_md) md <- TRUE
   if (has_nomd) md <- FALSE
 

---FILE: R/meta.R---
@@ -1,72 +0,0 @@
-
-.roxygen_meta <- new.env(parent = emptyenv())
-
-roxy_meta_get <- function(key = NULL, default = NULL) {
-
-  if (is.null(key))
-    return(as.list(.roxygen_meta))
-
-  if (!is.character(key) || length(key) != 1)
-    abort(""name must be NULL or a length one character vector"")
-
-  .roxygen_meta[[key]] %||% default
-
-}
-
-roxy_meta_set <- function(key, value = NULL) {
-  if (is.list(key) && is.null(value))
-    list2env(key, envir = .roxygen_meta)
-  else if (is.character(key))
-    assign(key, value, envir = .roxygen_meta)
-  else
-    abort(""unexpected key / value pair in roxy_meta_set"")
-}
-
-roxy_meta_clear <- function() {
-  rm(
-    list = ls(.roxygen_meta, all.names = TRUE),
-    envir = .roxygen_meta
-  )
-}
-
-roxy_meta_load <- function(base_path = getwd()) {
-
-  meta_dir <- file.path(base_path, ""man/roxygen"")
-  if (!utils::file_test(""-d"", meta_dir))
-    return(FALSE)
-
-  pattern <- ""^meta[.][Rr]""
-  meta_files <- list.files(meta_dir, pattern = pattern, full.names = TRUE)
-  if (length(meta_files) == 0)
-    return(FALSE)
-
-  if (length(meta_files) > 1) {
-    abort(""Multiple 'man/roxygen/meta.R' files found"")
-  }
-
-  parsed <- tryCatch(
-    parse(meta_files),
-    error = function(cnd) {
-      message <- ""Parse of 'man/roxygen/meta.R' failed""
-      abort(message, parent = cnd)
-    }
-  )
-
-  result <- tryCatch(
-    eval(parsed, envir = baseenv()),
-    error = function(cnd) {
-      message <- ""Evaluation of 'man/roxygen/meta.R' failed""
-      abort(message, parent = result)
-    }
-  )
-
-  if (!is.list(result)) {
-    message <- ""Evaluation of 'man/roxygen/meta.R' did not return a list""
-    abort(message)
-  }
-
-  roxy_meta_clear()
-  list2env(result, envir = .roxygen_meta)
-  TRUE
-
-}

---FILE: R/namespace.R---
@@ -31,10 +31,7 @@ namespace_roclet <- function() {
 }
 
 #' @export
-roclet_preprocess.roclet_namespace <- function(x,
-                                               blocks,
-                                               base_path,
-                                               global_options = list()) {
+roclet_preprocess.roclet_namespace <- function(x, blocks, base_path) {
 
   lines <- blocks_to_ns(blocks, env, import_only = TRUE)
   NAMESPACE <- file.path(base_path, ""NAMESPACE"")
@@ -50,15 +47,10 @@ roclet_preprocess.roclet_namespace <- function(x,
 }
 
 #' @export
-roclet_process.roclet_namespace <- function(x,
-                                            blocks,
-                                            env,
-                                            base_path,
-                                            global_options = list()) {
+roclet_process.roclet_namespace <- function(x, blocks, env, base_path) {
   blocks_to_ns(blocks, env)
 }
 
-
 #' @export
 roclet_output.roclet_namespace <- function(x, results, base_path, ...) {
   NAMESPACE <- file.path(base_path, ""NAMESPACE"")

---FILE: R/object-usage.R---
@@ -4,11 +4,11 @@ roxy_tag_parse.roxy_tag_usage <- function(x) {
 }
 
 # Prefer explicit \code{@@usage} to a \code{@@formals} list.
-topic_add_usage <- function(topic, block, old_usage = FALSE) {
+topic_add_usage <- function(topic, block) {
   tag <- block_get_tag(block, ""usage"")
 
   if (is.null(tag)) {
-    usage <- object_usage(block$object, old_usage = old_usage)
+    usage <- object_usage(block$object)
   } else if (tag$val == ""NULL"") {
     usage <- NULL
   } else {
@@ -26,42 +26,42 @@ format.rd_section_usage <- function(x, ...) {
 
 # object_usage ------------------------------------------------------------
 
-object_usage <- function(x, old_usage = FALSE) {
+object_usage <- function(x) {
   UseMethod(""object_usage"")
 }
 
-object_usage.default <- function(x, old_usage = FALSE) {
+object_usage.default <- function(x) {
   NULL
 }
 
-object_usage.data <- function(x, old_usage = FALSE) {
+object_usage.data <- function(x) {
   rd(x$alias)
 }
 
-object_usage.function <- function(x, old_usage = FALSE) {
-  function_usage(x$alias, formals(x$value), identity, old_usage = old_usage)
+object_usage.function <- function(x) {
+  function_usage(x$alias, formals(x$value), identity)
 }
 
 object_usage.s3generic <- object_usage.function
 
-object_usage.s3method <- function(x, old_usage = FALSE) {
+object_usage.s3method <- function(x) {
   method <- attr(x$value, ""s3method"")
   s3method <- function(name) {
     build_rd(""\\method{"", name, ""}{"", auto_backtick(method[2]), ""}"")
   }
-  function_usage(method[1], formals(x$value), s3method, old_usage = old_usage)
+  function_usage(method[1], formals(x$value), s3method)
 }
 
-object_usage.s4generic <- function(x, old_usage = FALSE) {
-  function_usage(x$value@generic, formals(x$value), identity, old_usage = old_usage)
+object_usage.s4generic <- function(x) {
+  function_usage(x$value@generic, formals(x$value), identity)
 }
 
-object_usage.s4method <- function(x, old_usage = FALSE) {
+object_usage.s4method <- function(x) {
   s4method <- function(name) {
     classes <- auto_backtick(as.character(x$value@defined))
     build_rd(""\\S4method{"", name, ""}{"", paste0(classes, collapse = "",""), ""}"")
   }
-  function_usage(x$value@generic, formals(x$value), s4method, old_usage = old_usage)
+  function_usage(x$value@generic, formals(x$value), s4method)
 }
 
 # Function usage ----------------------------------------------------------
@@ -70,18 +70,18 @@ object_usage.s4method <- function(x, old_usage = FALSE) {
 # replacement, infix, regular
 # function, s3 method, s4 method, data
 
-function_usage <- function(name, formals, format_name = identity, old_usage = FALSE) {
+function_usage <- function(name, formals, format_name = identity) {
   if (is_replacement_fun(name) && !is_infix_fun(name)) {
     name <- str_replace(name, fixed(""<-""), """")
     formals$value <- NULL
 
-    wrap_usage(name, format_name, formals, suffix = "" <- value"", old_usage = old_usage)
+    wrap_usage(name, format_name, formals, suffix = "" <- value"")
   } else if (is_infix_fun(name) && identical(format_name, identity)) {
     # If infix, and regular function, munge format
     arg_names <- names(formals)
     build_rd(arg_names[1], "" "", format_name(name), "" "", arg_names[2])
   } else {
-    wrap_usage(name, format_name, formals, old_usage = old_usage)
+    wrap_usage(name, format_name, formals)
   }
 }
 
@@ -122,7 +122,7 @@ args_call <- function(call, args) {
 #' @param formals List of function formals
 #' @param suffix Optional suffix, used for replacement functions
 #' @noRd
-wrap_usage <- function(name, format_name, formals, suffix = NULL, width = 80L, old_usage = FALSE) {
+wrap_usage <- function(name, format_name, formals, suffix = NULL, width = 80L) {
   # Quote non-syntactic names if no special formatting
   if (identical(format_name, identity)) {
     name <- auto_quote(name)
@@ -134,7 +134,7 @@ wrap_usage <- function(name, format_name, formals, suffix = NULL, width = 80L, o
   bare <- args_call(name, args)
   if (nchar(bare, type = ""width"") < width) {
     out <- args_call(format_name(name), args)
-  } else if (old_usage) {
+  } else if (roxy_meta_get(""old_usage"", FALSE)) {
     x <- args_call(format_name(name), args)
     out <- wrapUsage(x, width = as.integer(width))
   } else {
@@ -152,7 +152,7 @@ wrap_usage <- function(name, format_name, formals, suffix = NULL, width = 80L, o
 # helpers -----------------------------------------------------------------
 
 # used for testing
-call_to_usage <- function(code, old_usage = FALSE, env = pkg_env()) {
+call_to_usage <- function(code, env = pkg_env()) {
   obj <- call_to_object(!!enexpr(code), env)
-  gsub(""\u{A0}"", "" "", as.character(object_usage(obj, old_usage = old_usage)))
+  gsub(""\u{A0}"", "" "", as.character(object_usage(obj)))
 }

---FILE: R/options.R---
@@ -2,9 +2,10 @@
 #'
 #' Options can be stored in the `Roxygen` field of the `DESCRIPTION`, or
 #' in `man/roxygen/meta.R`. In either case, the code is parsed and evaluated
-#' in a child of the base environment.
+#' in a child of the base environment. Call `roxy_meta_get()` to access
+#' current option values from within tag and roclet methods.
 #'
-#' Options in `man/roxygen/meta.R` override those present `DESCRIPTION`.
+#' Options in `man/roxygen/meta.R` override those present in `DESCRIPTION`.
 #'
 #' @param base_path Path to package.
 #' @export
@@ -16,9 +17,9 @@ load_options <- function(base_path = ""."") {
 
   defaults <- list(
     roclets = c(""collate"", ""namespace"", ""rd""),
-    markdown = markdown_global_default,
+    load = ""pkgload"",
     old_usage = FALSE,
-    load = ""pkgload""
+    markdown = FALSE
   )
 
   unknown_opts <- setdiff(names(opts), names(defaults))
@@ -66,3 +67,27 @@ load_options_meta <- function(base_path = ""."", path = ""man/roxygen/meta.R"") {
 
   value
 }
+
+# Global binding mangaemnet -----------------------------------------------
+
+roxy_meta <- new_environment()
+
+#' @export
+#' @rdname load_options
+roxy_meta_get <- function(key = NULL, default = NULL) {
+  env_get(roxy_meta, key, default = default)
+}
+
+roxy_meta_set <- function(key, value = NULL) {
+  env_poke(roxy_meta, key, value)
+}
+
+roxy_meta_clear <- function() {
+  env_unbind(roxy_meta, env_names(roxy_meta))
+}
+
+roxy_meta_load <- function(base_path = getwd()) {
+  roxy_meta_clear()
+  env_bind(roxy_meta, !!!load_options(base_path))
+}
+

---FILE: R/parse.R---
@@ -15,28 +15,18 @@
 #'    You can also set to `NULL` if you only want to get the tokenized code
 #'    blocks only. This suppresses evaluation of `@eval` tags, and will not
 #'    find the code object associated with each block.
-#' @param global_options A list of global options:
-#'  * `markdown`` Logical value indicating whether to parse Markdown tags.
 #' @return A list of roxy_block objects
 #' @export
 #' @keywords internal
-parse_package <- function(path = ""."",
-                          env = env_package(path),
-                          global_options = list()
-                          ) {
+parse_package <- function(path = ""."", env = env_package(path)) {
 
   files <- package_files(path)
-  list_of_blocks <- lapply(files, tokenize_file,
-    global_options = global_options
-  )
+  list_of_blocks <- lapply(files, tokenize_file)
 
   blocks <- purrr::flatten(list_of_blocks)
 
   if (!is.null(env)) {
-    blocks <- lapply(blocks, block_set_env,
-      env = env,
-      global_options = global_options
-    )
+    blocks <- lapply(blocks, block_set_env, env = env)
   }
 
   blocks <- order_blocks(blocks)
@@ -47,19 +37,12 @@ parse_package <- function(path = ""."",
 #' @rdname parse_package
 parse_file <- function(file,
                        env = env_file(file),
-                       global_options = list(),
                        srcref_path = NULL) {
 
-  blocks <- tokenize_file(file,
-    global_options = global_options,
-    srcref_path = srcref_path
-  )
+  blocks <- tokenize_file(file, srcref_path = srcref_path)
 
   if (!is.null(env)) {
-    blocks <- lapply(blocks, block_set_env,
-      env = env,
-      global_options = global_options
-    )
+    blocks <- lapply(blocks, block_set_env, env = env)
   }
 
   blocks <- order_blocks(blocks)
@@ -68,20 +51,13 @@ parse_file <- function(file,
 
 #' @export
 #' @rdname parse_package
-parse_text <- function(text,
-                       env = env_file(file),
-                       global_options = list()) {
+parse_text <- function(text, env = env_file(file)) {
 
   file <- tempfile()
   write_lines(text, file)
   on.exit(unlink(file))
 
-  blocks <- parse_file(
-    file,
-    env = env,
-    global_options = global_options,
-    srcref_path = ""<text>""
-  )
+  blocks <- parse_file(file, env = env, srcref_path = ""<text>"")
   blocks <- order_blocks(blocks)
   blocks
 }

---FILE: R/rd-template.R---
@@ -8,7 +8,7 @@ roxy_tag_parse.roxy_tag_templateVar <- function(x) {
   tag_name_description(x)
 }
 
-process_templates <- function(block, base_path, global_options = list()) {
+process_templates <- function(block, base_path) {
   tags <- block_get_tags(block, ""template"")
   if (length(tags) == 0)
     return(block)
@@ -25,7 +25,7 @@ process_templates <- function(block, base_path, global_options = list()) {
 
   results <- lapply(paths, template_eval, vars = list2env(vars))
   tokens <- lapply(results, tokenise_block, file = ""TEMPLATE"", offset = 0L)
-  tags <- lapply(tokens, parse_tags, global_options = global_options)
+  tags <- lapply(tokens, parse_tags)
 
   # Insert templates back in the location where they came from
   block_replace_tags(block, ""template"", tags)

---FILE: R/rd.R---
@@ -33,17 +33,13 @@ rd_roclet_description <- function() {
 }
 
 #' @export
-roclet_process.roclet_rd <- function(x,
-                                     blocks,
-                                     env,
-                                     base_path,
-                                     global_options = list()) {
+roclet_process.roclet_rd <- function(x, blocks, env, base_path) {
 
   # Convert each block into a topic, indexed by filename
   topics <- RoxyTopics$new()
 
   for (block in blocks) {
-    rd <- block_to_rd(block, base_path, env, global_options)
+    rd <- block_to_rd(block, base_path, env)
     topics$add(rd)
   }
   topics_process_family(topics, env)
@@ -104,9 +100,9 @@ needs_doc <- function(block) {
 
 # Tag processing functions ------------------------------------------------
 
-block_to_rd <- function(block, base_path, env, global_options = list()) {
+block_to_rd <- function(block, base_path, env) {
   # Must start by processing templates
-  block <- process_templates(block, base_path, global_options)
+  block <- process_templates(block, base_path)
 
   if (!needs_doc(block)) {
     return()
@@ -124,7 +120,7 @@ block_to_rd <- function(block, base_path, env, global_options = list()) {
     rd$add(roxy_tag_rd(tag, env = env, base_path = base_path))
   }
 
-  topic_add_usage(rd, block, old_usage = global_options$old_usage)
+  topic_add_usage(rd, block)
 
   if (rd$has_section(""description"") && rd$has_section(""reexport"")) {
     roxy_tag_warning(block$tags[[1]], ""Can't use description when re-exporting"")

---FILE: R/roclet.R---
@@ -28,7 +28,6 @@
 #' @param blocks A list of [roxy_block] objects.
 #' @param results Value returned from your `roclet_process()` method.
 #' @param base_path Path to root of source package.
-#' @param global_options List of roxygen2 options.
 #' @param env Package environment.
 #' @keywords internal
 #' @name roclet
@@ -42,18 +41,18 @@ roclet <- function(subclass, ...) {
 
 #' @export
 #' @rdname roclet
-roclet_preprocess <- function(x, blocks, base_path, global_options = list()) {
+roclet_preprocess <- function(x, blocks, base_path) {
   UseMethod(""roclet_preprocess"")
 }
 
 #' @export
-roclet_preprocess.default <- function(x, blocks, base_path, global_options = list()) {
+roclet_preprocess.default <- function(x, blocks, base_path) {
   x
 }
 
 #' @export
 #' @rdname roclet
-roclet_process <- function(x, blocks, env, base_path, global_options = list()) {
+roclet_process <- function(x, blocks, env, base_path) {
   UseMethod(""roclet_process"")
 }
 
@@ -123,19 +122,16 @@ is.roclet <- function(x) inherits(x, ""roclet"")
 #'
 #' @param roclet Name of roclet to use for processing.
 #' @param input Source string
-#' @param global_options List of global options
 #' @export
 #' @keywords internal
-roc_proc_text <- function(roclet,
-                          input,
-                          global_options = list()) {
+roc_proc_text <- function(roclet, input) {
   stopifnot(is.roclet(roclet))
 
   file <- tempfile()
   write_lines(input, file)
   on.exit(unlink(file))
 
   env <- env_file(file)
-  blocks <- parse_text(input, env = env, global_options)
-  roclet_process(roclet, blocks, env = env, base_path = ""."", global_options)
+  blocks <- parse_text(input, env = env)
+  roclet_process(roclet, blocks, env = env, base_path = ""."")
 }

---FILE: R/roxygenize.R---
@@ -39,9 +39,8 @@ roxygenize <- function(package.dir = ""."",
   }
 
   roxy_meta_load(base_path)
-  options <- load_options(base_path)
-  roclets <- roclets %||% options$roclets
 
+  roclets <- roclets %||% roxy_meta_get(""roclets"")
   # Special case collate: it doesn't need to execute code, and must be run
   # first to ensure that code can be executed
   if (""collate"" %in% roclets) {
@@ -55,34 +54,26 @@ roxygenize <- function(package.dir = ""."",
   roclets <- lapply(roclets, roclet_find)
 
   # Tokenise each file
-  blocks <- parse_package(base_path,
-    env = NULL,
-    global_options = options
-  )
+  blocks <- parse_package(base_path, env = NULL)
 
   if (clean) {
     purrr::walk(roclets, roclet_clean, base_path = base_path)
   }
 
   roclets <- lapply(roclets, roclet_preprocess,
     blocks = blocks,
-    global_options = options,
     base_path = base_path
   )
 
   # Now load code
-  load_code <- find_load_strategy(load_code, options)
+  load_code <- find_load_strategy(load_code)
   env <- load_code(base_path)
-  blocks <- lapply(blocks, block_set_env,
-    env = env,
-    global_options = options
-  )
+  blocks <- lapply(blocks, block_set_env, env = env)
 
   results <- lapply(roclets, roclet_process,
     blocks = blocks,
     env = env,
-    base_path = base_path,
-    global_options = options
+    base_path = base_path
   )
 
   out <- purrr::map2(

---FILE: R/tokenize.R---
@@ -1,8 +1,5 @@
 # Returns list of roxy_blocks
-tokenize_file <- function(file,
-                          global_options = list(),
-                          srcref_path = NULL
-                          ) {
+tokenize_file <- function(file, srcref_path = NULL) {
   lines <- read_lines(file)
 
   parsed <- parse(
@@ -26,8 +23,7 @@ tokenize_file <- function(file,
       srcref = refs[has_tokens],
       tokens = tokens[has_tokens]
     ),
-    block_create,
-    global_options = global_options
+    block_create
   )
   purrr::compact(blocks)
 }

---FILE: R/vignette.R---
@@ -18,8 +18,7 @@ vignette_roclet <- function() {
 }
 
 #' @export
-roclet_process.roclet_vignette <- function(x, blocks, env, base_path,
-                                           global_options = list()) {
+roclet_process.roclet_vignette <- function(x, blocks, env, base_path) {
 }
 
 #' @export

---FILE: man/load_options.Rd---
@@ -2,19 +2,23 @@
 % Please edit documentation in R/options.R
 \name{load_options}
 \alias{load_options}
+\alias{roxy_meta_get}
 \title{Load roxygen2 options}
 \usage{
 load_options(base_path = ""."")
+
+roxy_meta_get(key = NULL, default = NULL)
 }
 \arguments{
 \item{base_path}{Path to package.}
 }
 \description{
 Options can be stored in the \code{Roxygen} field of the \code{DESCRIPTION}, or
 in \code{man/roxygen/meta.R}. In either case, the code is parsed and evaluated
-in a child of the base environment.
+in a child of the base environment. Call \code{roxy_meta_get()} to access
+current option values from within tag and roclet methods.
 }
 \details{
-Options in \code{man/roxygen/meta.R} override those present \code{DESCRIPTION}.
+Options in \code{man/roxygen/meta.R} override those present in \code{DESCRIPTION}.
 }
 \keyword{internal}

---FILE: man/parse_package.Rd---
@@ -8,16 +8,11 @@
 \alias{env_package}
 \title{Parse a package, file, or inline code}
 \usage{
-parse_package(path = ""."", env = env_package(path), global_options = list())
+parse_package(path = ""."", env = env_package(path))
 
-parse_file(
-  file,
-  env = env_file(file),
-  global_options = list(),
-  srcref_path = NULL
-)
+parse_file(file, env = env_file(file), srcref_path = NULL)
 
-parse_text(text, env = env_file(file), global_options = list())
+parse_text(text, env = env_file(file))
 
 env_file(file)
 
@@ -34,11 +29,6 @@ for real code you'll need to generate the environment yourself.
 You can also set to \code{NULL} if you only want to get the tokenized code
 blocks only. This suppresses evaluation of \verb{@eval} tags, and will not
 find the code object associated with each block.}
-
-\item{global_options}{A list of global options:
-\itemize{
-\item `markdown`` Logical value indicating whether to parse Markdown tags.
-}}
 }
 \value{
 A list of roxy_block objects

---FILE: man/roc_proc_text.Rd---
@@ -4,14 +4,12 @@
 \alias{roc_proc_text}
 \title{Process roclet on string and capture results.}
 \usage{
-roc_proc_text(roclet, input, global_options = list())
+roc_proc_text(roclet, input)
 }
 \arguments{
 \item{roclet}{Name of roclet to use for processing.}
 
 \item{input}{Source string}
-
-\item{global_options}{List of global options}
 }
 \description{
 Useful for testing.

---FILE: man/roclet.Rd---
@@ -11,9 +11,9 @@
 \usage{
 roclet(subclass, ...)
 
-roclet_preprocess(x, blocks, base_path, global_options = list())
+roclet_preprocess(x, blocks, base_path)
 
-roclet_process(x, blocks, env, base_path, global_options = list())
+roclet_process(x, blocks, env, base_path)
 
 roclet_output(x, results, base_path, ...)
 
@@ -30,8 +30,6 @@ roclet_tags(x)
 
 \item{base_path}{Path to root of source package.}
 
-\item{global_options}{List of roxygen2 options.}
-
 \item{env}{Package environment.}
 }
 \description{

---FILE: tests/testthat/test-load.R---
@@ -28,7 +28,7 @@ test_that(""look up string"", {
 })
 
 test_that(""NULL uses option"", {
-  expect_equal(find_load_strategy(NULL, list(load = ""installed"")), load_installed)
+  expect_equal(find_load_strategy(NULL, ""installed""), load_installed)
 })
 
 test_that(""informative errors for bad inputs"", {

---FILE: tests/testthat/test-markdown-state.R---
@@ -11,8 +11,7 @@ test_that(""markdown is off by default"", {
 })
 
 test_that(""turning on/off markdown globally"", {
-  ## off
-  out1 <- roc_proc_text(rd_roclet(), global_options = list(markdown = FALSE), ""
+  out1 <- roc_proc_text(rd_roclet(), ""
     #' Title
     #'
     #' Description with some `code` included. `More code.`
@@ -22,8 +21,9 @@ test_that(""turning on/off markdown globally"", {
     ""Description with some `code` included. `More code.`""
   )
 
-  ## on
-  out1 <- roc_proc_text(rd_roclet(), global_options = list(markdown = TRUE), ""
+  old <- roxy_meta_set(""markdown"", TRUE)
+  on.exit(roxy_meta_set(""markdown"", old))
+  out1 <- roc_proc_text(rd_roclet(), ""
     #' Title
     #'
     #' Description with some `code` included. `More code.`
@@ -35,8 +35,7 @@ test_that(""turning on/off markdown globally"", {
 })
 
 test_that(""turning on/off markdown locally"", {
-  ## off / off
-  out1 <- roc_proc_text(rd_roclet(), global_options = list(markdown = FALSE), ""
+  out1 <- roc_proc_text(rd_roclet(), ""
     #' Title
     #'
     #' Description with some `code` included. `More code.`
@@ -47,8 +46,7 @@ test_that(""turning on/off markdown locally"", {
     ""Description with some `code` included. `More code.`""
   )
 
-  ## off / on
-  out1 <- roc_proc_text(rd_roclet(), global_options = list(markdown = FALSE), ""
+  out1 <- roc_proc_text(rd_roclet(), ""
     #' Title
     #'
     #' Description with some `code` included. `More code.`
@@ -59,8 +57,9 @@ test_that(""turning on/off markdown locally"", {
     ""Description with some \\code{code} included. \\verb{More code.}""
   )
 
-  ## on / off
-  out1 <- roc_proc_text(rd_roclet(), global_options = list(markdown = TRUE), ""
+  old <- roxy_meta_set(""markdown"", TRUE)
+  on.exit(roxy_meta_set(""markdown"", old))
+  out1 <- roc_proc_text(rd_roclet(), ""
     #' Title
     #'
     #' Description with some `code` included. `More code.`
@@ -72,7 +71,7 @@ test_that(""turning on/off markdown locally"", {
   )
 
   ## on / on
-  out1 <- roc_proc_text(rd_roclet(), global_options = list(markdown = TRUE), ""
+  out1 <- roc_proc_text(rd_roclet(), ""
     #' Title
     #'
     #' Description with some `code` included. `More code.`
@@ -101,23 +100,10 @@ test_that(""warning for both @md and @noMd"", {
     ""Description with some `code` included. `More code.`""
   )
 
+  old <- roxy_meta_set(""markdown"", TRUE)
+  on.exit(roxy_meta_set(""markdown"", old))
   expect_warning(
-    out1 <- roc_proc_text(rd_roclet(), global_options = list(markdown = FALSE), ""
-      #' Title
-      #'
-      #' Description with some `code` included. `More code.`
-      #' @md
-      #' @noMd
-      foo <- function() {}"")[[1]],
-    ""Both @md and @noMd, no markdown parsing""
-  )
-  expect_equal(
-    out1$get_value(""description""),
-    ""Description with some `code` included. `More code.`""
-  )
-
-  expect_warning(
-    out1 <- roc_proc_text(rd_roclet(), global_options = list(markdown = TRUE), ""
+    out1 <- roc_proc_text(rd_roclet(), ""
       #' Title
       #'
       #' Description with some `code` included. `More code.`

---FILE: tests/testthat/test-meta.R---
@@ -1,27 +0,0 @@
-test_that(""evaluation of 'man/roxygen/meta.R' must return a list"", {
-
-  tmpdir <- tempfile(""roxygen-meta-"")
-  on.exit(unlink(tmpdir), add = TRUE)
-
-  metafile <- file.path(tmpdir, ""man/roxygen/meta.R"")
-  dir.create(dirname(metafile), recursive = TRUE)
-
-  # save + restore existing meta
-  meta <- roxy_meta_get()
-  on.exit({roxy_meta_clear(); roxy_meta_set(meta)}, add = TRUE)
-
-  # return FALSE when no metafile exists
-  expect_false(roxy_meta_load(tmpdir))
-
-  # error when doesn't return a list
-  write_lines(""42"", metafile)
-  expect_error(roxy_meta_load(tmpdir))
-
-  # TRUE when a list is returned
-  write_lines(""list(alpha = 1)"", metafile)
-  expect_true(roxy_meta_load(tmpdir))
-
-  # can access meta now
-  expect_equal(roxy_meta_get(""alpha""), 1)
-
-})

---FILE: tests/testthat/test-object-usage.R---
@@ -163,31 +163,34 @@ test_that(""new wrapping style doesn't change unexpectedly"", {
 })
 
 test_that(""old wrapping style doesn't change unexpectedly"", {
+  old <- roxy_meta_set(""old_usage"", TRUE)
+  on.exit(roxy_meta_set(""old_usage"", old))
+
   expect_known_output(file = test_path(""test-object-usage-wrap-old.txt""), {
     cat(call_to_usage({
       f <- function(a = '                                    a',
                     b = '                                    b',
                     c = '                                    c',
                     d = '                                    d') {}
-    }, old_usage = TRUE), ""\n\n"")
+    }), ""\n\n"")
 
     cat(call_to_usage({
       f <- function(a = c('abcdef', 'abcdef', 'abcdef', 'abcdef', 'abcdef',
                     'abcdef', 'abcdef', 'abcdef', 'abcdef', 'abcdef')) {}
-    }, old_usage = TRUE), ""\n\n"")
+    }), ""\n\n"")
 
     cat(call_to_usage({
       mean.reallyratherquitelongclassname <-
         function(reallyreatherquitelongargument = 'reallyratherquitelongvalue_____________________') {}
-    }, old_usage = TRUE), ""\n\n"")
+    }), ""\n\n"")
 
     cat(call_to_usage({
       `long_replacement_fun<-` <- function(x,
           a = 'aaaaaaaaaaaaaaaa',
           b = 'aaaaaaaaaaaaaaaa',
           c = 'aaaaaaaaaaaaaaaa',
           value) {}
-    }, old_usage = TRUE), ""\n\n"")
+    }), ""\n\n"")
 
     # breaking works after escapes (#265)
     cat(call_to_usage({
@@ -201,7 +204,7 @@ test_that(""old wrapping style doesn't change unexpectedly"", {
         xxxxxxxxxxxxxxxxxx6,
         xxxxxxxxxxxxxxxxxx7
       ) {}
-    }, old_usage = TRUE), ""\n\n"")
+    }), ""\n\n"")
   })
 })
 

---FILE: vignettes/extending.Rmd---
@@ -279,7 +279,7 @@ There are two methods that almost every roclet will use:
 For this roclet, we'll have `roclet_process()` collect all the memo tags into a named list:
 
 ```{r}
-roclet_process.roclet_memo <- function(x, blocks, env, base_path, global_options = list()) {
+roclet_process.roclet_memo <- function(x, blocks, env, base_path) {
   results <- list()
   
   for (block in blocks) {"
r-lib,roxygen2,0d9bace8772569be6405a0617aa7a331f33b2cc2,Hadley Wickham,h.wickham@gmail.com,2019-10-01T16:08:48Z,Hadley Wickham,h.wickham@gmail.com,2019-10-01T16:08:48Z,"Correctly offset line numbers in tags generated by parse_description()

Fixes #917",NEWS.md;R/block.R;tests/testthat/test-block.R,False,True,True,False,47,3,50,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* `@description` and `@detail` tags automatically generated from the leading
+  description block now have correct line numbers (#917).
+
 * `rd_section()` and `roxy_tag_rd()` are now exported so that you can more 
   easily extend `rd_roclet()` with your own tags that genereate output in
   `.Rd` files.

---FILE: R/block.R---
@@ -236,13 +236,16 @@ parse_description <- function(tags) {
   tag_names <- tag_names[-1]
 
   paragraphs <- str_split(intro$val, fixed('\n\n'))[[1]]
+  lines <- str_count(paragraphs, ""\n"") + rep(2, length(paragraphs))
+  offsets <- c(0, cumsum(lines))
 
   # 1st paragraph = title (unless has @title)
   if (""title"" %in% tag_names) {
     title <- NULL
   } else if (length(paragraphs) > 0) {
-    title <- roxy_tag(""title"", paragraphs[1], NULL, intro$file, intro$line)
+    title <- roxy_tag(""title"", paragraphs[1], NULL, intro$file, intro$line + offsets[[1]])
     paragraphs <- paragraphs[-1]
+    offsets <- offsets[-1]
   } else {
     title <- roxy_tag(""title"", """", NULL, intro$file, intro$line)
   }
@@ -251,8 +254,9 @@ parse_description <- function(tags) {
   if (""description"" %in% tag_names || length(paragraphs) == 0) {
     description <- NULL
   } else if (length(paragraphs) > 0) {
-    description <- roxy_tag(""description"", paragraphs[1], NULL, intro$file, intro$line)
+    description <- roxy_tag(""description"", paragraphs[1], NULL, intro$file, intro$line + offsets[[1]])
     paragraphs <- paragraphs[-1]
+    offsets <- offsets[-1]
   }
 
   # Every thing else = details, combined with @details
@@ -267,7 +271,7 @@ parse_description <- function(tags) {
       details_para <- paste(c(details_para, explicit_details), collapse = ""\n\n"")
     }
 
-    details <- roxy_tag(""details"", details_para, NULL, intro$file, intro$line)
+    details <- roxy_tag(""details"", details_para, NULL, intro$file, intro$line + offsets[[1]])
   } else {
     details <- NULL
   }

---FILE: tests/testthat/test-block.R---
@@ -187,6 +187,43 @@ test_that(""description block preserves whitespace"", {
 })
 
 
+test_that(""line numbers offset correctly"", {
+  out <- parse_text(
+    ""#' Title
+    #'
+    #' Line 3
+    #' Line 4
+    #' Line 5
+    #'
+    #' Line 7
+    #' Line 8
+    f <- function() {}
+    ""
+  )[[1]]
+
+  expect_equal(out$tags[[1]]$line, 1)
+  expect_equal(out$tags[[2]]$line, 3)
+  expect_equal(out$tags[[3]]$line, 7)
+})
+
+test_that(""even with explicit title/description"", {
+  out <- parse_text(
+    ""#' Line 1
+    #' Line 2
+    #' Line 3
+    #'
+    #' Line 5
+    #' Line 6
+    #' @title This is a title
+    f <- function() {}
+    ""
+  )[[1]]
+
+  expect_equal(out$tags[[1]]$line, 1)
+  expect_equal(out$tags[[2]]$line, 5)
+  expect_equal(out$tags[[3]]$line, 7)
+})
+
 # evaluate ----------------------------------------------------------------
 
 test_that(""evaluation occurs during parsing"", {"
r-lib,roxygen2,0b0261cfbd32ebd9a65a8084276c57f7f8629ec5,G치bor Cs치rdi,csardi.gabor@gmail.com,2019-09-30T19:28:11Z,Hadley Wickham,h.wickham@gmail.com,2019-09-30T19:28:11Z,"Fix line numbers in the tokenizer (#924)

Closes #923.",src/parser2.cpp;tests/testthat/test-block-print.txt;tests/testthat/test-block.R;tests/testthat/test-tokenize.R,False,True,True,False,64,7,71,"---FILE: src/parser2.cpp---
@@ -106,7 +106,7 @@ List tokenise_block(CharacterVector lines, std::string file = """",
   std::vector<std::string> tags, vals;
   std::vector<int> rows;
 
-  int curRow = 0;
+  int curRow = 1;
   std::string curTag(""""), curVal("""");
 
   for (int i = 0; i < lines.size(); ++i) {
@@ -147,7 +147,7 @@ List tokenise_block(CharacterVector lines, std::string file = """",
   for (int i = 0; i < n; ++i) {
     out[i] = List::create(
       _[""file""] = file,
-      _[""line""] = rows[i] + 1,
+      _[""line""] = rows[i],
       _[""tag""] = tags[i],
       // Rcpp::String() necessary to tag string as UTF-8
       _[""raw""] = Rcpp::String(stripTrailingNewline(vals[i])),

---FILE: tests/testthat/test-block-print.txt---
@@ -1,9 +1,9 @@
 > block
-<roxy_block> [<text>:6]
+<roxy_block> [<text>:5]
   $tag
     [line:  1] @title 'This is a title' {parsed}
-    [line:  5] @param 'x,y A number' {parsed}
-    [line:  6] @export '' {parsed}
+    [line:  3] @param 'x,y A number' {parsed}
+    [line:  4] @export '' {parsed}
     [????:???] @.formals '<generated>' {parsed}
     [????:???] @backref '<text>' {parsed}
   $call   f <- function(x, y) x + y

---FILE: tests/testthat/test-block.R---
@@ -2,8 +2,8 @@
 # object ------------------------------------------------------------------
 
 test_that(""has thoughtful print method"", {
-  text <- ""
-    #' This is a title
+  text <-
+    ""#' This is a title
     #'
     #' @param x,y A number
     #' @export

---FILE: tests/testthat/test-tokenize.R---
@@ -90,3 +90,60 @@ test_that(""Inline comments do not extend past the closing brace"", {
   expect_null(out$get_value(""seealso""))
 })
 
+test_that(""Line numbers are ok"", {
+
+  check_line_nums <- function(block, lines) {
+    for (t in names(lines)) {
+      expect_equal(block_get_tag(block, t)$line, lines[[t]], info = t)
+    }
+  }
+
+  text <-
+    ""#' @title
+     #' Foo
+     #'
+     #' @description
+     #' Description
+     #'
+     #' @details
+     #' Details
+     #'
+     #' @param x xyz
+     #' @export
+     NULL""
+  block <- roxygen2::parse_text(text)[[1]]
+  ls <- c(title = 1, description = 4, details = 7, param = 10, export = 11)
+  check_line_nums(block, ls)
+
+  text <-
+    ""#' @title Foo
+     #'
+     #' @description Description
+     #'
+     #' @details Details
+     #'
+     #' @param x xy
+     #' z
+     #'
+     #' @export
+     NULL""
+  block <- roxygen2::parse_text(text)[[1]]
+  ls <- c(title = 1, description = 3, details = 5, param = 7, export = 10)
+  check_line_nums(block, ls)
+
+  text <-
+    ""#' @title Foo
+     #'
+     #' @description Description
+     #'
+     #' @details Details
+     # not - a - roxy - comment
+     #' @param x xy
+     #' z
+     quote(neither - is -
+     #' @export
+     this)""
+  block <- roxygen2::parse_text(text)[[1]]
+  ls <- c(title = 1, description = 3, details = 5, param = 7, export = 10)
+  check_line_nums(block, ls)
+})"
r-lib,roxygen2,29db38fb823fcfe9cf2ad05f885bf20dfa1c964b,Hadley Wickham,h.wickham@gmail.com,2019-09-20T19:37:23Z,Hadley Wickham,h.wickham@gmail.com,2019-09-20T19:37:23Z,"Revamp operation of rd and namespace roclets.

At the heart of both roclets is now a loop that processes each tag in turn, calling `roxy_tag_rd()` or `roxy_tag_ns()`. This makes it easier to closely connected the parsing and processing tag, making the pieces easier to understand.

Other changes:

* `@docType package` no longer adds `-package` alias as this broke
   encapsulation and was only mildly useful.

* .rexports, .formals, and .methods all now work by defining internal
  tags in object_defaults.

Fixes #915",NAMESPACE;NEWS.md;R/namespace.R;R/object-defaults.R;R/rd-examples.R;R/rd-include-rmd.R;R/rd-inherit.R;R/rd.R;R/tag.R;R/topic.R;man/roclet.Rd;man/roxy_tag.Rd;tests/testthat/test-block-print.txt;tests/testthat/test-rd-doctype.R,False,True,True,False,510,394,904,"---FILE: NAMESPACE---
@@ -51,6 +51,7 @@ S3method(merge,roxy_field_minidesc)
 S3method(merge,roxy_field_param)
 S3method(merge,roxy_field_reexport)
 S3method(merge,roxy_field_section)
+S3method(object_defaults,""function"")
 S3method(object_defaults,data)
 S3method(object_defaults,default)
 S3method(object_defaults,import)
@@ -74,6 +75,19 @@ S3method(roclet_preprocess,roclet_namespace)
 S3method(roclet_process,roclet_namespace)
 S3method(roclet_process,roclet_rd)
 S3method(roclet_process,roclet_vignette)
+S3method(roxy_tag_ns,default)
+S3method(roxy_tag_ns,roxy_tag_evalNamespace)
+S3method(roxy_tag_ns,roxy_tag_export)
+S3method(roxy_tag_ns,roxy_tag_exportClass)
+S3method(roxy_tag_ns,roxy_tag_exportMethod)
+S3method(roxy_tag_ns,roxy_tag_exportPattern)
+S3method(roxy_tag_ns,roxy_tag_exportS3Method)
+S3method(roxy_tag_ns,roxy_tag_import)
+S3method(roxy_tag_ns,roxy_tag_importClassesFrom)
+S3method(roxy_tag_ns,roxy_tag_importFrom)
+S3method(roxy_tag_ns,roxy_tag_importMethodsFrom)
+S3method(roxy_tag_ns,roxy_tag_rawNamespace)
+S3method(roxy_tag_ns,roxy_tag_useDynLib)
 S3method(roxy_tag_parse,default)
 S3method(roxy_tag_parse,roxy_tag_aliases)
 S3method(roxy_tag_parse,roxy_tag_author)
@@ -130,6 +144,38 @@ S3method(roxy_tag_parse,roxy_tag_templateVar)
 S3method(roxy_tag_parse,roxy_tag_title)
 S3method(roxy_tag_parse,roxy_tag_usage)
 S3method(roxy_tag_parse,roxy_tag_useDynLib)
+S3method(roxy_tag_rd,roxy_tag_.formals)
+S3method(roxy_tag_rd,roxy_tag_.methods)
+S3method(roxy_tag_rd,roxy_tag_.reexport)
+S3method(roxy_tag_rd,roxy_tag_author)
+S3method(roxy_tag_rd,roxy_tag_backref)
+S3method(roxy_tag_rd,roxy_tag_concept)
+S3method(roxy_tag_rd,roxy_tag_description)
+S3method(roxy_tag_rd,roxy_tag_details)
+S3method(roxy_tag_rd,roxy_tag_docType)
+S3method(roxy_tag_rd,roxy_tag_encoding)
+S3method(roxy_tag_rd,roxy_tag_evalRd)
+S3method(roxy_tag_rd,roxy_tag_example)
+S3method(roxy_tag_rd,roxy_tag_examples)
+S3method(roxy_tag_rd,roxy_tag_family)
+S3method(roxy_tag_rd,roxy_tag_field)
+S3method(roxy_tag_rd,roxy_tag_format)
+S3method(roxy_tag_rd,roxy_tag_includeRmd)
+S3method(roxy_tag_rd,roxy_tag_inherit)
+S3method(roxy_tag_rd,roxy_tag_inheritDotParams)
+S3method(roxy_tag_rd,roxy_tag_inheritParams)
+S3method(roxy_tag_rd,roxy_tag_inheritSection)
+S3method(roxy_tag_rd,roxy_tag_keywords)
+S3method(roxy_tag_rd,roxy_tag_note)
+S3method(roxy_tag_rd,roxy_tag_param)
+S3method(roxy_tag_rd,roxy_tag_rawRd)
+S3method(roxy_tag_rd,roxy_tag_references)
+S3method(roxy_tag_rd,roxy_tag_return)
+S3method(roxy_tag_rd,roxy_tag_section)
+S3method(roxy_tag_rd,roxy_tag_seealso)
+S3method(roxy_tag_rd,roxy_tag_slot)
+S3method(roxy_tag_rd,roxy_tag_source)
+S3method(roxy_tag_rd,roxy_tag_title)
 export(block_get_tag)
 export(block_get_tag_value)
 export(block_get_tags)

---FILE: NEWS.md---
@@ -1,5 +1,9 @@
 # roxygen2 (development version)
 
+* Using `@docType package` no longer automatically adds `-name`. Instead 
+  document `_PACKAGE` to get all the defaults for package documentation.
+  (Removing this feature allowed for simplification of the code.)
+
 * `roclet_tags()` is no longer used; instead define a `roxy_tag_parse()` method.
   If you tag is `@mytag`, then the class name associated with it is
   `roxy_tag_mytag` so the method should be call `roxy_tag_parse.roxy_tag_mytag()`.

---FILE: R/namespace.R---
@@ -1,22 +1,3 @@
-# Processed first
-ns_tags_import <- c(
-  ""import"",
-  ""importFrom"",
-  ""importClassesFrom"",
-  ""importMethodsFrom"",
-  ""useDynLib"",
-  ""rawNamespace""
-)
-ns_tags <- c(
-  ns_tags_import,
-  ""evalNamespace"",
-  ""export"",
-  ""exportClass"",
-  ""exportMethod"",
-  ""exportS3Method"",
-  ""exportPattern""
-)
-
 #' Roclet: make `NAMESPACE`
 #'
 #' @description
@@ -55,15 +36,15 @@ roclet_preprocess.roclet_namespace <- function(x,
                                                base_path,
                                                global_options = list()) {
 
-  lines <- blocks_to_ns(blocks, env, tag_set = ns_tags_import)
+  lines <- blocks_to_ns(blocks, env, import_only = TRUE)
   NAMESPACE <- file.path(base_path, ""NAMESPACE"")
 
   if (length(lines) == 0 && !made_by_roxygen(NAMESPACE)) {
     return(x)
   }
 
   results <- c(made_by(""#""), lines)
-  write_if_different(NAMESPACE, results, check = FALSE)
+  write_if_different(NAMESPACE, results, check = TRUE)
 
   invisible(x)
 }
@@ -77,30 +58,6 @@ roclet_process.roclet_namespace <- function(x,
   blocks_to_ns(blocks, env)
 }
 
-#' @export
-roxy_tag_parse.roxy_tag_evalNamespace <- function(x) tag_code(x)
-#' @export
-roxy_tag_parse.roxy_tag_export <- function(x) tag_words_line(x)
-#' @export
-roxy_tag_parse.roxy_tag_exportClass <- function(x) tag_words(x, 1)
-#' @export
-roxy_tag_parse.roxy_tag_exportS3Method <- function(x) tag_words(x, min = 0, max = 2)
-#' @export
-roxy_tag_parse.roxy_tag_exportMethod <- function(x) tag_words(x, min = 1)
-#' @export
-roxy_tag_parse.roxy_tag_exportPattern <- function(x) tag_words(x, min = 1)
-#' @export
-roxy_tag_parse.roxy_tag_import <- function(x) tag_words(x, min = 1)
-#' @export
-roxy_tag_parse.roxy_tag_importClassesFrom <- function(x) tag_words(x, min = 2)
-#' @export
-roxy_tag_parse.roxy_tag_importFrom <- function(x) tag_words(x, min = 2)
-#' @export
-roxy_tag_parse.roxy_tag_importMethodsFrom <- function(x) tag_words(x, min = 2)
-#' @export
-roxy_tag_parse.roxy_tag_rawNamespace <- function(x) tag_code(x)
-#' @export
-roxy_tag_parse.roxy_tag_useDynLib <- function(x) tag_words(x, min = 1)
 
 #' @export
 roclet_output.roclet_namespace <- function(x, results, base_path, ...) {
@@ -124,86 +81,185 @@ roclet_clean.roclet_namespace <- function(x, base_path) {
 
 # NAMESPACE generation ----------------------------------------------------
 
-blocks_to_ns <- function(blocks, env, tag_set = ns_tags) {
-  lines <- map(blocks, block_to_ns, env = env, tag_set = tag_set)
+blocks_to_ns <- function(blocks, env, import_only = FALSE) {
+  lines <- map(blocks, block_to_ns, env = env, import_only = import_only)
   lines <- unlist(lines) %||% character()
 
   sort_c(unique(lines))
 }
 
-block_to_ns <- function(block, env, tag_set = ns_tags) {
-  tags <- block_get_tags(block, tag_set)
+block_to_ns <- function(block, env, import_only = FALSE) {
+  map(block$tags, roxy_tag_ns, block = block, env = env, import_only = import_only)
+}
+
+# Namespace tag methods ---------------------------------------------------
 
-  map(tags, function(tag) {
-    exec(paste0(""ns_"", tag$tag), tag, block, env)
-  })
+roxy_tag_ns <- function(x, block, env, import_only = FALSE) {
+  UseMethod(""roxy_tag_ns"")
 }
 
-ns_export <- function(tag, block, env) {
-  if (identical(tag$val, """")) {
+#' @export
+roxy_tag_ns.default <- function(x, block, env, import_only = FALSE) {
+
+}
+
+#' @export
+roxy_tag_parse.roxy_tag_evalNamespace <- function(x) {
+  tag_code(x)
+}
+#' @export
+roxy_tag_ns.roxy_tag_evalNamespace <- function(x, block, env, import_only = FALSE) {
+  roxy_tag_eval(x, env)
+}
+
+#' @export
+roxy_tag_parse.roxy_tag_export <- function(x) {
+  tag_words_line(x)
+}
+#' @export
+roxy_tag_ns.roxy_tag_export <- function(x, block, env, import_only = FALSE) {
+  if (import_only) {
+    return()
+  }
+
+  if (identical(x$val, """")) {
     # FIXME: check for empty exports (i.e. no name)
     default_export(block$object, block)
   } else {
-    export(tag$val)
+    export(x$val)
   }
 }
 
-ns_exportClass       <- function(tag, block, env) export_class(tag$val)
-ns_exportMethod      <- function(tag, block, env) export_s4_method(tag$val)
-ns_exportPattern     <- function(tag, block, env) one_per_line(""exportPattern"", tag$val)
-ns_import            <- function(tag, block, env) one_per_line(""import"", tag$val)
-ns_importFrom        <- function(tag, block, env) repeat_first(""importFrom"", tag$val)
-ns_importClassesFrom <- function(tag, block, env) repeat_first(""importClassesFrom"", tag$val)
-ns_importMethodsFrom <- function(tag, block, env) repeat_first(""importMethodsFrom"", tag$val)
+#' @export
+roxy_tag_parse.roxy_tag_exportClass <- function(x) {
+  tag_words(x, 1)
+}
+#' @export
+roxy_tag_ns.roxy_tag_exportClass <- function(x, block, env, import_only = FALSE) {
+  if (import_only) {
+    return()
+  }
 
-ns_exportS3Method    <- function(tag, block, env) {
-  obj <- block$object
+  export_class(x$val)
+}
+
+#' @export
+roxy_tag_parse.roxy_tag_exportMethod <- function(x) {
+  tag_words(x, min = 1)
+}
+#' @export
+roxy_tag_ns.roxy_tag_exportMethod <- function(x, block, env, import_only = FALSE) {
+  if (import_only) {
+    return()
+  }
+  export_s4_method(x$val)
+}
 
-  if (length(tag$val) < 2 && !inherits(obj, ""s3method"")) {
-    roxy_tag_warning(tag,
+#' @export
+roxy_tag_parse.roxy_tag_exportPattern <- function(x) {
+  tag_words(x, min = 1)
+}
+#' @export
+roxy_tag_ns.roxy_tag_exportPattern <- function(x, block, env, import_only = FALSE) {
+  if (import_only) {
+    return()
+  }
+  one_per_line(""exportPattern"", x$val)
+}
+
+#' @export
+roxy_tag_parse.roxy_tag_exportS3Method <- function(x) {
+  tag_words(x, min = 0, max = 2)
+}
+#' @export
+roxy_tag_ns.roxy_tag_exportS3Method <- function(x, block, env, import_only = FALSE) {
+  if (import_only) {
+    return()
+  }
+
+  obj <- block$object
+  if (length(x$val) < 2 && !inherits(obj, ""s3method"")) {
+    roxy_tag_warning(x,
       ""`@exportS3Method` and `@exportS3Method generic` must be used with an S3 method""
     )
     return()
   }
 
-  if (identical(tag$val, """")) {
+  if (identical(x$val, """")) {
     method <- attr(obj$value, ""s3method"")
-  } else if (length(tag$val) == 1) {
-    method <- c(tag$val, attr(obj$value, ""s3method"")[[2]])
+  } else if (length(x$val) == 1) {
+    method <- c(x$val, attr(obj$value, ""s3method"")[[2]])
   } else {
-    method <- tag$val
+    method <- x$val
   }
 
   export_s3_method(method)
 }
 
-ns_useDynLib         <- function(tag, block, env) {
-  if (length(tag$val) == 1) {
-    return(paste0(""useDynLib("", auto_quote(tag$val), "")""))
+#' @export
+roxy_tag_parse.roxy_tag_import <- function(x) {
+  tag_words(x, min = 1)
+}
+#' @export
+roxy_tag_ns.roxy_tag_import <- function(x, block, env, import_only = FALSE) {
+  one_per_line(""import"", x$val)
+}
+
+#' @export
+roxy_tag_parse.roxy_tag_importClassesFrom <- function(x) {
+  tag_words(x, min = 2)
+}
+#' @export
+roxy_tag_ns.roxy_tag_importClassesFrom <- function(x, block, env, import_only = FALSE) {
+  repeat_first(""importClassesFrom"", x$val)
+}
+
+#' @export
+roxy_tag_parse.roxy_tag_importFrom <- function(x) {
+  tag_words(x, min = 2)
+}
+#' @export
+roxy_tag_ns.roxy_tag_importFrom <- function(x, block, env, import_only = FALSE) {
+  repeat_first(""importFrom"", x$val)
+}
+
+#' @export
+roxy_tag_parse.roxy_tag_importMethodsFrom <- function(x) {
+  tag_words(x, min = 2)
+}
+#' @export
+roxy_tag_ns.roxy_tag_importMethodsFrom <- function(x, block, env, import_only = FALSE) {
+  repeat_first(""importMethodsFrom"", x$val)
+}
+
+#' @export
+roxy_tag_parse.roxy_tag_rawNamespace <- function(x) {
+  tag_code(x)
+}
+#' @export
+roxy_tag_ns.roxy_tag_rawNamespace  <- function(x, block, env, import_only = FALSE) {
+  x$val
+}
+
+#' @export
+roxy_tag_parse.roxy_tag_useDynLib <- function(x) {
+  tag_words(x, min = 1)
+}
+#' @export
+roxy_tag_ns.roxy_tag_useDynLib <- function(x, block, env, import_only = FALSE) {
+  if (length(x$val) == 1) {
+    return(paste0(""useDynLib("", auto_quote(x$val), "")""))
   }
 
-  if (any(grepl("","", tag$val))) {
+  if (any(grepl("","", x$val))) {
     # If there's a comma in list, don't quote output. This makes it possible
     # for roxygen2 to support other NAMESPACE forms not otherwise mapped
-    args <- paste0(tag$val, collapse = "" "")
+    args <- paste0(x$val, collapse = "" "")
     paste0(""useDynLib("", args, "")"")
   } else {
-    repeat_first(""useDynLib"", tag$val)
+    repeat_first(""useDynLib"", x$val)
   }
 }
-ns_rawNamespace  <- function(tag, block, env) tag$val
-ns_evalNamespace <- function(tag, block, env) {
-  roxy_tag_eval(tag, env)
-}
-
-# Functions used by both default_export and ns_* functions
-export           <- function(x) one_per_line(""export"", x)
-export_class     <- function(x) one_per_line(""exportClasses"", x)
-export_s4_method <- function(x) one_per_line(""exportMethods"", x)
-export_s3_method <- function(x) {
-  args <- paste0(auto_backtick(x), collapse = "","")
-  paste0(""S3method("", args, "")"")
-}
 
 # Default export methods --------------------------------------------------
 
@@ -223,9 +279,16 @@ default_export.default   <- function(x, block) export(x$alias)
 #' @export
 default_export.NULL      <- function(x, block) export(block_get_tag_value(block, ""name""))
 
-
 # Helpers -----------------------------------------------------------------
 
+export           <- function(x) one_per_line(""export"", x)
+export_class     <- function(x) one_per_line(""exportClasses"", x)
+export_s4_method <- function(x) one_per_line(""exportMethods"", x)
+export_s3_method <- function(x) {
+  args <- paste0(auto_backtick(x), collapse = "","")
+  paste0(""S3method("", args, "")"")
+}
+
 one_per_line <- function(name, x) {
   paste0(name, ""("", auto_backtick(x), "")"")
 }

---FILE: R/object-defaults.R---
@@ -3,6 +3,14 @@ object_defaults <- function(x) UseMethod(""object_defaults"")
 #' @export
 object_defaults.default <- function(x) list()
 
+#' @exportS3Method object_defaults ""function""
+object_defaults.function <- function(x) {
+  # Used in process_inherit_params()
+  list(
+    roxy_tag("".formals"", NULL, names(formals(x$value)))
+  )
+}
+
 #' @export
 object_defaults.data <- function(x) {
   str_out <- rd(object_format(x$value))
@@ -44,7 +52,7 @@ object_defaults.import <- function(x) {
     roxy_tag(""name"", NULL, ""reexports""),
     roxy_tag(""keywords"", NULL, ""internal""),
     roxy_tag(""title"", NULL, ""Objects exported from other packages""),
-    roxy_tag("".reexport"", NULL, roxy_field_reexport(x$value$pkg, x$value$fun))
+    roxy_tag("".reexport"", NULL, list(pkg = x$value$pkg, fun = x$value$fun))
   )
 }
 
@@ -58,7 +66,9 @@ object_defaults.s4class <- function(x) {
 #' @export
 object_defaults.rcclass <- function(x) {
   list(
-    roxy_tag(""docType"", NULL, ""class"")
+    roxy_tag(""docType"", NULL, ""class""),
+    if (!is.null(x$methods))
+      roxy_tag("".methods"", NULL, x$methods)
   )
 }
 
@@ -68,3 +78,10 @@ object_defaults.s4method <- function(x) {
     roxy_tag(""docType"", NULL, ""class"")
   )
 }
+
+# Helpers -----------------------------------------------------------------
+
+package_suffix <- function(name) {
+  paste0(name, ""-package"")
+}
+

---FILE: R/rd-examples.R---
@@ -1,32 +1,34 @@
-topic_add_examples <- function(topic, block, base_path) {
-  tags <- block_get_tags(block, c(""examples"", ""example""))
+#' @export
+roxy_tag_parse.roxy_tag_example <- function(x) {
+  x <- tag_value(x)
 
-  for (tag in tags) {
-    if (tag$tag == ""examples"") {
-      example <- tag$val
-    } else {
-      example <- read_example_from_path(tag, base_path)
-    }
-    topic$add_simple_field(""examples"", example)
-  }
-}
-
-read_example_from_path <- function(tag, base_path) {
-  path <- str_trim(tag$val)
-  nl <- str_count(path, ""\n"")
+  nl <- str_count(x$val, ""\n"")
   if (any(nl) > 0) {
-    roxy_tag_warning(tag, ""spans multiple lines. Do you want @examples?"")
+    roxy_tag_warning(x, ""spans multiple lines. Do you want @examples?"")
     return()
   }
 
-  path <- file.path(base_path, path)
+  x
+}
+#' @export
+roxy_tag_rd.roxy_tag_example <- function(x, topic, base_path, env) {
+  path <- file.path(base_path, x$val)
   if (!file.exists(path)) {
-    roxy_tag_warning(tag, ""'"", path, ""' doesn't exist"")
+    roxy_tag_warning(x, ""'"", path, ""' doesn't exist"")
     return()
   }
 
   code <- read_lines(path)
-  escape_examples(code)
+  topic$add_simple_field(""examples"", escape_examples(code))
+}
+
+#' @export
+roxy_tag_parse.roxy_tag_examples <- function(x) {
+  tag_examples(x)
+}
+#' @export
+roxy_tag_rd.roxy_tag_examples <- function(x, topic, base_path, env) {
+  topic$add_simple_field(""examples"", x$val)
 }
 
 # Works like escape, but unescapes special rd example commands.

---FILE: R/rd-include-rmd.R---
@@ -1,5 +1,4 @@
-
-block_include_rmd <- function(tag, block, base_path) {
+roxy_tag_include_rmd <- function(tag, base_path) {
   rmd <- tag$val
   stopifnot(is.character(rmd), length(rmd) == 1, !is.na(rmd))
 

---FILE: R/rd-inherit.R---
@@ -1,3 +1,39 @@
+#' @export
+roxy_tag_parse.roxy_tag_inherit <- function(x) tag_inherit(x)
+#' @export
+roxy_tag_rd.roxy_tag_inherit <- function(x, topic, base_path, env) {
+  field <- roxy_field_inherit(x$val$source, list(x$val$fields))
+  topic$add_field(field)
+}
+
+#' @export
+roxy_tag_parse.roxy_tag_inheritParams <- function(x) tag_value(x)
+#' @export
+roxy_tag_rd.roxy_tag_inheritParams <- function(x, topic, base_path, env) {
+  field <- roxy_field_inherit(x$val, list(""params""))
+  topic$add_field(field)
+}
+
+#' @export
+roxy_tag_parse.roxy_tag_inheritDotParams <- function(x) {
+  tag_two_part(x, ""source"", ""args"", required = FALSE, markdown = FALSE)
+}
+#' @export
+roxy_tag_rd.roxy_tag_inheritDotParams <- function(x, topic, base_path, env) {
+  field <- roxy_field_inherit_dot_params(x$val$source, x$val$args)
+  topic$add_field(field)
+}
+
+#' @export
+roxy_tag_parse.roxy_tag_inheritSection <- function(x) tag_name_description(x)
+#' @export
+roxy_tag_rd.roxy_tag_inheritSection <- function(x, topic, base_path, env) {
+  field <- roxy_field_inherit_section(x$val$name, x$val$description)
+  topic$add_field(field)
+}
+
+# Process inheritance -----------------------------------------------------
+
 topics_process_inherit <- function(topics, env) {
   inherits <- function(type) {
     function(x) x$inherits_from(type)

---FILE: R/rd.R---
@@ -118,32 +118,13 @@ block_to_rd <- function(block, base_path, env, global_options = list()) {
     return()
   }
 
-  # Note that order of operations here doesn't matter: fields are
-  # ordered by RoxyFile$format()
   rd <- RoxyTopic$new()
   topic_add_name_aliases(rd, block, name)
-
-  # Some fields added directly by roxygen internals
-  tags <- Filter(roxy_tag_is_field, block$tags)
-  for (tag in tags) {
-    rd$add(tag$val)
+  for (tag in block$tags) {
+    roxy_tag_rd(tag, rd, env = env, base_path = base_path)
   }
 
-  topic_add_backref(rd, block)
-  topic_add_doc_type(rd, block)
-  topic_add_eval_rd(rd, block, env)
-  topic_add_include_rmd(rd, block, base_path)
-  topic_add_examples(rd, block, base_path)
-  topic_add_fields(rd, block)
-  topic_add_inherit(rd, block)
-  topic_add_keyword(rd, block)
-  topic_add_methods(rd, block)
-  topic_add_params(rd, block)
-  topic_add_simple_tags(rd, block)
-  topic_add_sections(rd, block)
-  topic_add_slots(rd, block)
   topic_add_usage(rd, block, old_usage = global_options$old_usage)
-  topic_add_value(rd, block)
 
   if (rd$has_field(""description"") && rd$has_field(""reexport"")) {
     roxy_tag_warning(block$tags[[1]], ""Can't use description when re-exporting"")
@@ -157,87 +138,7 @@ block_to_rd <- function(block, base_path, env, global_options = list()) {
   rd
 }
 
-#' @export
-roxy_tag_parse.roxy_tag_aliases <- function(x) tag_value(x)
-#' @export
-roxy_tag_parse.roxy_tag_author <- function(x) tag_markdown(x)
-#' @export
-roxy_tag_parse.roxy_tag_backref <- function(x) tag_value(x)
-#' @export
-roxy_tag_parse.roxy_tag_concept <- function(x) tag_markdown(x)
-#' @export
-roxy_tag_parse.roxy_tag_describeIn <- function(x) tag_name_description(x)
-#' @export
-roxy_tag_parse.roxy_tag_description <- function(x) tag_markdown_with_sections(x)
-#' @export
-roxy_tag_parse.roxy_tag_details <- function(x) tag_markdown_with_sections(x)
-#' @export
-roxy_tag_parse.roxy_tag_docType <- function(x) tag_name(x)
-#' @export
-roxy_tag_parse.roxy_tag_encoding <- function(x) tag_value(x)
-#' @export
-roxy_tag_parse.roxy_tag_evalRd <- function(x) tag_code(x)
-#' @export
-roxy_tag_parse.roxy_tag_example <- function(x) tag_value(x)
-#' @export
-roxy_tag_parse.roxy_tag_examples <- function(x) tag_examples(x)
-#' @export
-roxy_tag_parse.roxy_tag_family <- function(x) tag_value(x)
-#' @export
-roxy_tag_parse.roxy_tag_field <- function(x) tag_name_description(x)
-#' @export
-roxy_tag_parse.roxy_tag_format <- function(x) tag_markdown(x)
-#' @export
-roxy_tag_parse.roxy_tag_includeRmd <- function(x) tag_value(x)
-#' @export
-roxy_tag_parse.roxy_tag_inherit <- function(x) tag_inherit(x)
-#' @export
-roxy_tag_parse.roxy_tag_inheritParams <- function(x) tag_value(x)
-#' @export
-roxy_tag_parse.roxy_tag_inheritDotParams <- function(x) tag_two_part(x, ""source"", ""args"", required = FALSE, markdown = FALSE)
-#' @export
-roxy_tag_parse.roxy_tag_inheritSection <- function(x) tag_name_description(x)
-#' @export
-roxy_tag_parse.roxy_tag_keywords <- function(x) tag_value(x)
-#' @export
-roxy_tag_parse.roxy_tag_method <- function(x) tag_words(x, 2, 2)
-#' @export
-roxy_tag_parse.roxy_tag_name <- function(x) tag_value(x)
-#' @export
-roxy_tag_parse.roxy_tag_md <- function(x) tag_toggle(x)
-#' @export
-roxy_tag_parse.roxy_tag_noMd <- function(x) tag_toggle(x)
-#' @export
-roxy_tag_parse.roxy_tag_noRd <- function(x) tag_toggle(x)
-#' @export
-roxy_tag_parse.roxy_tag_note <- function(x) tag_markdown(x)
-#' @export
-roxy_tag_parse.roxy_tag_param <- function(x) tag_name_description(x)
-#' @export
-roxy_tag_parse.roxy_tag_rdname <- function(x) tag_value(x)
-#' @export
-roxy_tag_parse.roxy_tag_rawRd <- function(x) tag_value(x)
-#' @export
-roxy_tag_parse.roxy_tag_references <- function(x) tag_markdown(x)
-#' @export
-roxy_tag_parse.roxy_tag_return <- function(x) tag_markdown(x)
-#' @export
-roxy_tag_parse.roxy_tag_section <- function(x) tag_markdown(x)
-#' @export
-roxy_tag_parse.roxy_tag_seealso <- function(x) tag_markdown(x)
-#' @export
-roxy_tag_parse.roxy_tag_slot <- function(x) tag_name_description(x)
-#' @export
-roxy_tag_parse.roxy_tag_source <- function(x) tag_markdown(x)
-#' @export
-roxy_tag_parse.roxy_tag_template <- function(x) tag_value(x)
-#' @export
-roxy_tag_parse.roxy_tag_templateVar <- function(x) tag_name_description(x)
-#' @export
-roxy_tag_parse.roxy_tag_title <- function(x) tag_markdown(x)
-#' @export
-roxy_tag_parse.roxy_tag_usage <- function(x) tag_value(x)
-
+# Special cases -----------------------------------------------------------
 
 topics_add_default_description <- function(topics) {
   for (topic in topics$topics) {
@@ -253,45 +154,6 @@ topics_add_default_description <- function(topics) {
   invisible()
 }
 
-
-topic_add_backref <- function(topic, block) {
-  tags <- block_get_tags(block, ""backref"")
-  for (tag in tags) {
-    topic$add_simple_field(""backref"", tag$val)
-  }
-}
-
-# Simple tags can be converted directly to fields
-topic_add_simple_tags <- function(topic, block) {
-  simple_tags <- block_get_tags(block,
-    c(
-      ""author"", ""concept"", ""description"", ""details"", ""encoding"", ""family"",
-      ""format"", ""note"", ""rawRd"", ""references"",
-      ""seealso"", ""source"", ""title""
-    )
-  )
-
-  for (tag in simple_tags) {
-    if (length(tag$val) && nchar(tag$val[[1]])) {
-      topic$add_simple_field(tag$tag, tag$val[[1]])
-    }
-    for (extra in tag$val[-1]) {
-      topic$add_simple_field(""rawRd"", extra)
-    }
-  }
-}
-
-topic_add_params <- function(topic, block) {
-  # Used in process_inherit_params()
-  value <- block$object$value
-  if (is.function(value)) {
-    formals <- formals(value)
-    topic$add_simple_field(""formals"", names(formals))
-  }
-
-  process_def_tag(topic, block, ""param"")
-}
-
 topic_add_name_aliases <- function(topic, block, name) {
   tags <- block_get_tags(block, ""aliases"")
 
@@ -314,16 +176,48 @@ topic_add_name_aliases <- function(topic, block, name) {
   topic$add_simple_field(""alias"", aliases)
 }
 
+# Prefer explicit \code{@@usage} to a \code{@@formals} list.
+topic_add_usage <- function(topic, block, old_usage = FALSE) {
+  tag <- block_get_tag(block, ""usage"")
 
-topic_add_methods <- function(topic, block) {
-  obj <- block$object
-  if (!inherits(obj, ""rcclass"")) return()
+  if (is.null(tag)) {
+    usage <- object_usage(block$object, old_usage = old_usage)
+  } else if (tag$val == ""NULL"") {
+    usage <- NULL
+  } else {
+    # Treat user input as already escaped, otherwise they have no way
+    # to enter \S4method etc.
+    usage <- rd(tag$val)
+  }
+  topic$add_simple_field(""usage"", usage)
+}
+
+# Tag-wise processing -----------------------------------------------------
+
+roxy_tag_rd <- function(x, topic, base_path, env) {
+  UseMethod(""roxy_tag_rd"")
+}
+
+roxy_tag_rd.default <- function(x, topic, base_path, env) {
+}
+
+
+# Internal tags -----------------------------------------------------------
+
+#' @export
+roxy_tag_rd.roxy_tag_.reexport <- function(x, topic, base_path, env) {
+  topic$add(roxy_field_reexport(x$val$pkg, x$val$fun))
+}
 
-  methods <- obj$methods
-  if (is.null(obj$methods)) return()
+#' @export
+roxy_tag_rd.roxy_tag_.formals <- function(x, topic, base_path, env) {
+  topic$add_simple_field(""formals"", x$val)
+}
 
-  desc <- lapply(methods, function(x) docstring(x$value@.Data))
-  usage <- map_chr(methods, function(x) {
+#' @export
+roxy_tag_rd.roxy_tag_.methods <- function(x, topic, base_path, env) {
+  desc <- lapply(x$val, function(x) docstring(x$value@.Data))
+  usage <- map_chr(x$val, function(x) {
     function_usage(x$value@name, formals(x$value@.Data))
   })
 
@@ -334,148 +228,216 @@ topic_add_methods <- function(topic, block) {
   topic$add_simple_field(""rcmethods"", setNames(desc, usage))
 }
 
-topic_add_inherit <- function(topic, block) {
-  tags <- block_get_tags(block, ""inherit"")
-  for (tag in tags) {
-    field <- roxy_field_inherit(tag$val$source, list(tag$val$fields))
-    topic$add_field(field)
-  }
+# Regular tags ------------------------------------------------------------
 
-  tags <- block_get_tags(block, ""inheritParams"")
-  for (tag in tags) {
-    field <- roxy_field_inherit(tag$val, list(""params""))
-    topic$add_field(field)
-  }
+#' @export
+roxy_tag_parse.roxy_tag_aliases <- function(x) tag_value(x)
 
-  tags <- block_get_tags(block, ""inheritSection"")
-  for (tag in tags) {
-    field <- roxy_field_inherit_section(tag$val$name, tag$val$description)
-    topic$add_field(field)
-  }
+#' @export
+roxy_tag_parse.roxy_tag_author <- function(x) tag_markdown(x)
+#' @export
+roxy_tag_rd.roxy_tag_author <- function(x, topic, base_path, env) {
+  topic$add_markdown_field(x$tag, x$val)
+}
 
-  tags <- block_get_tags(block, ""inheritDotParams"")
-  for (tag in tags) {
-    field <- roxy_field_inherit_dot_params(tag$val$source, tag$val$args)
-    topic$add_field(field)
-  }
+#' @export
+roxy_tag_parse.roxy_tag_backref <- function(x) tag_value(x)
+#' @export
+roxy_tag_rd.roxy_tag_backref <- function(x, topic, base_path, env) {
+  topic$add_simple_field(""backref"", x$val)
 }
 
+#' @export
+roxy_tag_parse.roxy_tag_concept <- function(x) tag_markdown(x)
+#' @export
+roxy_tag_rd.roxy_tag_concept <- function(x, topic, base_path, env) {
+  topic$add_markdown_field(x$tag, x$val)
+}
 
-topic_add_value <- function(topic, block) {
-  tags <- block_get_tags(block, ""return"")
+#' @export
+roxy_tag_parse.roxy_tag_describeIn <- function(x) tag_name_description(x)
 
-  for (tag in tags) {
-    topic$add_simple_field(""value"", tag$val)
-  }
+#' @export
+roxy_tag_parse.roxy_tag_description <- function(x) tag_markdown_with_sections(x)
+#' @export
+roxy_tag_rd.roxy_tag_description <- function(x, topic, base_path, env) {
+  topic$add_markdown_field(x$tag, x$val)
 }
 
-topic_add_keyword <- function(topic, block) {
-  tags <- block_get_tags(block, ""keywords"")
-
-  vals <- map_chr(tags, ""val"")
-  keywords <- unlist(str_split(vals, ""\\s+""))
+#' @export
+roxy_tag_parse.roxy_tag_details <- function(x) tag_markdown_with_sections(x)
+#' @export
+roxy_tag_rd.roxy_tag_details <- function(x, topic, base_path, env) {
+  topic$add_markdown_field(x$tag, x$val)
+}
 
-  topic$add_simple_field(""keyword"", keywords)
+#' @export
+roxy_tag_parse.roxy_tag_docType <- function(x) tag_name(x)
+#' @export
+roxy_tag_rd.roxy_tag_docType <- function(x, topic, base_path, env) {
+  topic$add_simple_field(""docType"", x$val)
 }
 
-# Prefer explicit \code{@@usage} to a \code{@@formals} list.
-topic_add_usage <- function(topic, block, old_usage = FALSE) {
-  tag <- block_get_tag(block, ""usage"")
+#' @export
+roxy_tag_parse.roxy_tag_encoding <- function(x) tag_value(x)
+#' @export
+roxy_tag_rd.roxy_tag_encoding <- function(x, topic, base_path, env) {
+  topic$add_markdown_field(x$tag, x$val)
+}
 
-  if (is.null(tag)) {
-    usage <- object_usage(block$object, old_usage = old_usage)
-  } else if (tag$val == ""NULL"") {
-    usage <- NULL
-  } else {
-    # Treat user input as already escaped, otherwise they have no way
-    # to enter \S4method etc.
-    usage <- rd(tag$val)
-  }
-  topic$add_simple_field(""usage"", usage)
+#' @export
+roxy_tag_parse.roxy_tag_evalRd <- function(x) tag_code(x)
+#' @export
+roxy_tag_rd.roxy_tag_evalRd <- function(x, topic, base_path, env) {
+  topic$add_simple_field(""rawRd"", roxy_tag_eval(x, env))
 }
 
-topic_add_slots <- function(topic, block) {
-  process_def_tag(topic, block, ""slot"")
+#' @export
+roxy_tag_parse.roxy_tag_family <- function(x) tag_value(x)
+#' @export
+roxy_tag_rd.roxy_tag_family <- function(x, topic, base_path, env) {
+  topic$add_markdown_field(x$tag, x$val)
 }
 
-topic_add_fields <- function(topic, block) {
-  process_def_tag(topic, block, ""field"")
+#' @export
+roxy_tag_parse.roxy_tag_field <- function(x) tag_name_description(x)
+#' @export
+roxy_tag_rd.roxy_tag_field <- function(x, topic, base_path, env) {
+  value <- setNames(x$val$description, x$val$name)
+  topic$add_simple_field(x$tag, value)
 }
 
-topic_add_eval_rd <- function(topic, block, env) {
-  tags <- block_get_tags(block, ""evalRd"")
+#' @export
+roxy_tag_parse.roxy_tag_format <- function(x) tag_markdown(x)
+#' @export
+roxy_tag_rd.roxy_tag_format <- function(x, topic, base_path, env) {
+  topic$add_markdown_field(x$tag, x$val)
+}
 
-  for (tag in tags) {
-    out <- roxy_tag_eval(tag, env)
-    topic$add_simple_field(""rawRd"", out)
+#' @export
+roxy_tag_parse.roxy_tag_includeRmd <- function(x) {
+  if (!is_installed(""rmarkdown"")) {
+    roxy_tag_warning(x, ""Needs the rmarkdown package"")
+    return()
   }
+
+  tag_value(x)
+}
+#' @export
+roxy_tag_rd.roxy_tag_includeRmd <- function(x, topic, base_path, env) {
+  topic$add_markdown_field(""details"", roxy_tag_include_rmd(x, base_path))
+}
+
+#' @export
+roxy_tag_parse.roxy_tag_keywords <- function(x) tag_value(x)
+#' @export
+roxy_tag_rd.roxy_tag_keywords <- function(x, topic, base_path, env) {
+  topic$add_simple_field(""keyword"", str_split(x$val, ""\\s+"")[[1]])
 }
 
-topic_add_include_rmd <- function(topic, block, base_path) {
-  tags <- block_get_tags(block, ""includeRmd"")
+#' @export
+roxy_tag_parse.roxy_tag_method <- function(x) tag_words(x, 2, 2)
 
-  for (tag in tags) {
-    if (!is_installed(""rmarkdown"")) {
-      roxy_tag_warning(tag, ""Needs the rmarkdown package"")
-    }
-    out <- block_include_rmd(tag, block, base_path)
-    if (!is.null(out[[1]])) {
-      topic$add_simple_field(""details"", out[[1]])
-    }
-    lapply(out[-1], function(s) {
-      topic$add_simple_field(""rawRd"", s)
-    })
-  }
+#' @export
+roxy_tag_parse.roxy_tag_name <- function(x) tag_value(x)
+
+#' @export
+roxy_tag_parse.roxy_tag_md <- function(x) tag_toggle(x)
+
+#' @export
+roxy_tag_parse.roxy_tag_noMd <- function(x) tag_toggle(x)
+
+#' @export
+roxy_tag_parse.roxy_tag_noRd <- function(x) tag_toggle(x)
+
+#' @export
+roxy_tag_parse.roxy_tag_note <- function(x) tag_markdown(x)
+#' @export
+roxy_tag_rd.roxy_tag_note <- function(x, topic, base_path, env) {
+  topic$add_markdown_field(x$tag, x$val)
 }
 
-topic_add_sections <- function(topic, block) {
-  tags <- block_get_tags(block, ""section"")
+#' @export
+roxy_tag_parse.roxy_tag_param <- function(x) tag_name_description(x)
+#' @export
+roxy_tag_rd.roxy_tag_param <- function(x, topic, base_path, env) {
+  value <- setNames(x$val$description, x$val$name)
+  topic$add_simple_field(x$tag, value)
+}
 
-  for (tag in tags) {
-    pieces <- str_split(tag$val, "":"", n = 2)[[1]]
+#' @export
+roxy_tag_parse.roxy_tag_rdname <- function(x) tag_value(x)
 
-    title <- str_split(pieces[1], ""\n"")[[1]]
-    if (length(title) > 1) {
-      roxy_tag_warning(tag,
-        ""Section title spans multiple lines: \n"", ""@section "", title[1]
-      )
-      return()
-    }
+#' @export
+roxy_tag_parse.roxy_tag_rawRd <- function(x) tag_value(x)
+#' @export
+roxy_tag_rd.roxy_tag_rawRd <- function(x, topic, base_path, env) {
+  topic$add_markdown_field(x$tag, x$val)
+}
 
-    topic$add_field(roxy_field_section(pieces[1], pieces[2]))
-  }
+#' @export
+roxy_tag_parse.roxy_tag_references <- function(x) tag_markdown(x)
+#' @export
+roxy_tag_rd.roxy_tag_references <- function(x, topic, base_path, env) {
+  topic$add_markdown_field(x$tag, x$val)
 }
 
-topic_add_doc_type <- function(topic, block) {
-  tag <- block_get_tag(block, ""docType"")
-  if (is.null(tag)) {
+#' @export
+roxy_tag_parse.roxy_tag_return <- function(x) tag_markdown(x)
+#' @export
+roxy_tag_rd.roxy_tag_return <- function(x, topic, base_path, env) {
+  topic$add_simple_field(""value"", x$val)
+}
+
+#' @export
+roxy_tag_parse.roxy_tag_section <- function(x) tag_markdown(x)
+#' @export
+roxy_tag_rd.roxy_tag_section <- function(x, topic, base_path, env) {
+  pieces <- str_split(x$val, "":"", n = 2)[[1]]
+  title <- str_split(pieces[1], ""\n"")[[1]]
+
+  if (length(title) > 1) {
+    roxy_tag_warning(x, ""Section title spans multiple lines"")
     return()
   }
 
-  topic$add_simple_field(""docType"", tag$val)
+  topic$add_field(roxy_field_section(pieces[1], pieces[2]))
+}
 
-  if (tag$val == ""package"") {
-    name <- block_get_tag(block, ""name"")
-    if (!str_detect(name$val, ""-package"")) {
-      topic$add_simple_field(""alias"", package_suffix(name$val))
-    }
-  }
+#' @export
+roxy_tag_parse.roxy_tag_seealso <- function(x) tag_markdown(x)
+#' @export
+roxy_tag_rd.roxy_tag_seealso <- function(x, topic, base_path, env) {
+  topic$add_markdown_field(x$tag, x$val)
 }
 
-package_suffix <- function(name) {
-  paste0(name, ""-package"")
+#' @export
+roxy_tag_parse.roxy_tag_slot <- function(x) tag_name_description(x)
+#' @export
+roxy_tag_rd.roxy_tag_slot <- function(x, topic, base_path, env) {
+  value <- setNames(x$val$description, x$val$name)
+  topic$add_simple_field(x$tag, value)
 }
 
-# Name + description tags ------------------------------------------------------
+#' @export
+roxy_tag_parse.roxy_tag_source <- function(x) tag_markdown(x)
+#' @export
+roxy_tag_rd.roxy_tag_source <- function(x, topic, base_path, env) {
+  topic$add_markdown_field(x$tag, x$val)
+}
 
-process_def_tag <- function(topic, block, tag) {
-  tags <- block_get_tags(block, tag)
-  if (length(tags) == 0) {
-    return()
-  }
+#' @export
+roxy_tag_parse.roxy_tag_template <- function(x) tag_value(x)
 
-  desc <- str_trim(map_chr(tags, c(""val"", ""description"")))
-  names(desc) <- map_chr(tags, c(""val"", ""name""))
+#' @export
+roxy_tag_parse.roxy_tag_templateVar <- function(x) tag_name_description(x)
 
-  topic$add_simple_field(tag, desc)
+#' @export
+roxy_tag_parse.roxy_tag_title <- function(x) tag_markdown(x)
+#' @export
+roxy_tag_rd.roxy_tag_title <- function(x, topic, base_path, env) {
+  topic$add_markdown_field(x$tag, x$val)
 }
+
+#' @export
+roxy_tag_parse.roxy_tag_usage <- function(x) tag_value(x)

---FILE: R/tag.R---
@@ -9,7 +9,8 @@
 #'
 #' @keywords internal
 #' @export
-#' @param tag Tag name
+#' @param tag Tag name. Arguments starting with `.` are reserved for internal
+#'   usage.
 #' @param raw Raw tag value, a string.
 #' @param val Parsed tag value, typically a character vector, but sometimes
 #'   a list. Usually filled in by `tag_parsers`
@@ -61,7 +62,7 @@ format.roxy_tag <- function(x, ..., file = NULL) {
       raw <- x$raw
     }
   } else {
-    raw <- ""<generated by roxygen2>""
+    raw <- ""<generated>""
   }
 
   parsed <- if (is.null(x$val)) ""{unparsed}"" else ""{parsed}""
@@ -88,10 +89,6 @@ roxy_tag_warning <- function(x, ...) {
   NULL
 }
 
-roxy_tag_is_field <- function(tag) {
-  inherits(tag$val, ""roxy_field"")
-}
-
 roxy_tag_eval <- function(tag, env) {
   tryCatch({
     expr <- parse(text = tag$val)

---FILE: R/topic.R---
@@ -81,6 +81,16 @@ RoxyTopic <- R6::R6Class(""RoxyTopic"", public = list(
     invisible()
   },
 
+  add_markdown_field = function(name, values) {
+    if (length(values) && nchar(values[[1]])) {
+      self$add_simple_field(name, values[[1]])
+    }
+    # Any additional components are sections
+    for (extra in values[-1]) {
+      self$add_simple_field(""rawRd"", extra)
+    }
+  },
+
   add = function(x, overwrite = FALSE) {
     if (inherits(x, ""RoxyTopic"")) {
       self$add(x$fields, overwrite = overwrite)

---FILE: man/roclet.Rd---
@@ -26,13 +26,13 @@ roclet_tags(x)
 
 \item{blocks}{A list of \link{roxy_block} objects.}
 
+\item{results}{Value returned from your \code{roclet_process()} method.}
+
 \item{base_path}{Path to root of source package.}
 
 \item{global_options}{List of roxygen2 options.}
 
 \item{env}{Package environment.}
-
-\item{results}{Value returned from your \code{roclet_process()} method.}
 }
 \description{
 To create a new roclet, you will need to create a constructor function

---FILE: man/roxy_tag.Rd---
@@ -13,7 +13,8 @@ roxy_tag_parse(x)
 roxy_tag_warning(x, ...)
 }
 \arguments{
-\item{tag}{Tag name}
+\item{tag}{Tag name. Arguments starting with \code{.} are reserved for internal
+usage.}
 
 \item{raw}{Raw tag value, a string.}
 

---FILE: tests/testthat/test-block-print.txt---
@@ -4,6 +4,7 @@
     [line:  1] @title 'This is a title' {parsed}
     [line:  5] @param 'x,y A number' {parsed}
     [line:  6] @export '' {parsed}
+    [????:???] @.formals '<generated>' {parsed}
     [????:???] @backref '<text>' {parsed}
   $call   f <- function(x, y) x + y
   $object <function> 

---FILE: tests/testthat/test-rd-doctype.R---
@@ -1,27 +1,5 @@
 context(""Rd: docType"")
 
-# Package --------------------------------------------------------------------
-
-test_that(""@docType package automatically adds package alias when needed"", {
-  out <- roc_proc_text(rd_roclet(), ""
-    #' @name a
-    #' @title a
-    #' @docType package
-    NULL
-
-    #' @name a-package
-    #' @title a
-    #' @docType package
-    NULL"")
-
-  alias_1 <- get_tag(out[[1]], ""alias"")$values
-  expect_equal(alias_1, c(""a"", ""a-package""))
-
-  alias_2 <- get_tag(out[[2]], ""alias"")$values
-  expect_equal(alias_2, c(""a-package""))
-})
-
-
 # Data --------------------------------------------------------------------
 
 test_that(""@docType data automatically adds sensible defaults"", {"
r-lib,roxygen2,8c82a079e8d333ed62ecadabfc6b726b8947baf0,Hadley Wickham,h.wickham@gmail.com,2019-09-20T13:36:51Z,Hadley Wickham,h.wickham@gmail.com,2019-09-20T13:40:14Z,"Massive refactoring of roxy_block() data structure

* roxy_block() is now a list, containing a list of roxy_tags()
  Exported interface for getting multiple tags, a single tag, and
  a single value.

* roxy_tag() now distinguishes between raw and parsed values

* Both get massively improved print methods

* block_warning() has been removed in favour of using more specific
  roxy_tag_waning() everywhere

* Multiple uses of `@usage` now get a warning (due to use of consistent
  wrapper)

Fixes #664",NAMESPACE;NEWS.md;R/block.R;R/field.R;R/markdown.R;R/namespace.R;R/object-defaults.R;R/object-from-call.R;R/object-import.R;R/parse.R;R/rd-describe-in.R;R/rd-examples.R;R/rd-template.R;R/rd.R;R/roclet.R;R/tag-parser.R;R/tag.R;R/tokenize.R;R/topic.R;R/utils.R;man/parse_package.Rd;man/roc_proc_text.Rd;man/roclet.Rd;man/roxy_block.Rd;man/roxy_tag.Rd;man/tag_parsers.Rd;src/parser2.cpp;tests/testthat/test-block-print.txt;tests/testthat/test-block.R;tests/testthat/test-namespace.R;tests/testthat/test-object-s3.R;tests/testthat/test-rd-examples.R;tests/testthat/test-rd-inherit.R;tests/testthat/test-rd-param.R;tests/testthat/test-rd-raw.R;tests/testthat/test-tag.R;tests/testthat/test-tokenize.R;vignettes/extending.Rmd,True,True,True,False,965,907,1872,"---FILE: NAMESPACE---
@@ -8,6 +8,7 @@ S3method(default_export,s3method)
 S3method(default_export,s4class)
 S3method(default_export,s4generic)
 S3method(default_export,s4method)
+S3method(format,object)
 S3method(format,roxy_field)
 S3method(format,roxy_field_alias)
 S3method(format,roxy_field_author)
@@ -41,6 +42,7 @@ S3method(format,roxy_field_source)
 S3method(format,roxy_field_title)
 S3method(format,roxy_field_usage)
 S3method(format,roxy_field_value)
+S3method(format,roxy_tag)
 S3method(merge,roxy_field)
 S3method(merge,roxy_field_inherit)
 S3method(merge,roxy_field_inherit_dot_params)
@@ -75,6 +77,10 @@ S3method(roclet_process,roclet_vignette)
 S3method(roclet_tags,roclet_namespace)
 S3method(roclet_tags,roclet_rd)
 S3method(roclet_tags,roclet_vignette)
+export(block_get_tag)
+export(block_get_tag_value)
+export(block_get_tags)
+export(block_has_tags)
 export(env_file)
 export(env_package)
 export(is_s3_generic)
@@ -98,6 +104,7 @@ export(roclet_output)
 export(roclet_preprocess)
 export(roclet_process)
 export(roclet_tags)
+export(roxy_block)
 export(roxy_tag)
 export(roxy_tag_warning)
 export(roxygenise)

---FILE: NEWS.md---
@@ -1,5 +1,20 @@
 # roxygen2 (development version)
 
+* The internal `roxy_tag()` gains a new field: `raw`. This now always contains
+  the raw string value parsed from the file. `val` is only set after the tag
+  has been parsed.
+
+* The internal data structure used to represent blocks has been overhauled.
+  It is now documented and stable - see `roxy_block()` for details. If you're
+  one of the few people who have written a roxygen2 extension, this will
+  break your code - but the documentation, object structure, and print methods 
+  are now much better that I hope it's not too annoying! You can also
+  learn more in the new `vignette(""extending"")` - a bit thanks to @mikldk
+  for getting this started (#882).
+
+* You now get a warning if you use multiple `@usage` statements. Previously,
+  the first was used without a warning
+
 * Functions documented in `reexports` are now sorted alphabetically by
   package (#765).
 

---FILE: R/block.R---
@@ -1,48 +1,78 @@
+#' Blocks
+#'
+#' @description
+#' A `roxy_block` represents a single roxygen2 block.
+#'
+#' The `block_*` functions provide a few helpers for common operations:
+#' * `block_has_tag(blocks, tags)`: does `block` contain any of these `tags`?
+#' * `block_get_tags(block, tags)`: get all instances of `tags`
+#' * `block_get_tag(block, tag)`: get single tag. Returns `NULL` if 0,
+#'    throws warning if more than 1.
+#' * `block_get_tag_value(block, tag)`: gets `val` field from single tag.
+#'
+#' @param tags A list of [roxy_tag]s.
+#' @param file,line Location of the `call` (i.e. the line after the last
+#'   line of the block).
+#' @param call Expression associated with block.
+#' @param object Optionally, the object associated with the block, found
+#'   by inspecting/evaluating `call`.
+#' @param block A `roxy_block` to manipulate.
+#' @param tag,tags Either a single tag name, or a character vector of tag names.
+#' @export
+#' @keywords internal
+#' @examples
+#' # The easiest way to see the structure of a roxy_block is to create one
+#' # using parse_text:
+#' text <- ""
+#'   #' This is a title
+#'   #'
+#'   #' @param x,y A number
+#'   #' @export
+#'   f <- function(x, y) x + y
+#' ""
+#'
+#' # parse_text() returns a list of blocks, so I extract the first
+#' block <- parse_text(text)[[1]]
+#' block
 roxy_block <- function(tags,
-                       filename,
-                       location,
+                       file,
+                       line,
                        call,
                        object = NULL) {
   stopifnot(is.list(tags))
-  stopifnot(is.character(filename))
-  stopifnot(is.vector(location))
+  stopifnot(is.character(file), length(file) == 1)
+  stopifnot(is.integer(line), length(line) == 1)
 
   structure(
-    tags,
-    filename = filename,
-    location = location,
-    call = call,
-    object = object,
+    list(
+      tags = tags,
+      file = file,
+      line = line,
+      call = call,
+      object = object
+    ),
     class = ""roxy_block""
   )
 }
 
-roxy_block_copy <- function(block, tags) {
-  roxy_block(
-    tags,
-    filename = attr(block, ""filename""),
-    location = attr(block, ""location""),
-    call = attr(block, ""call""),
-    object = attr(block, ""object"")
-  )
-}
-
 is_roxy_block <- function(x) inherits(x, ""roxy_block"")
 
 #' @export
 print.roxy_block <- function(x, ...) {
-  call <- deparse(attr(x, ""call""), nlines = 2)
+  call <- deparse(x$call, nlines = 2)
   if (length(call) == 2) {
     call <- paste0(call[[1]], "" ..."")
   }
-
-  cat_line(""<roxy_block> @ "", block_location(x))
-  cat_line(""  Tags: "", paste0(names(x), collapse = "", ""))
-  cat_line(""  Call: "", call)
-  cat_line(""  Obj ? "", !is.null(attr(x, ""object"")))
+  obj <- format(x$object)
+
+  cat_line(""<roxy_block> ["", basename(x$file), "":"", x$line, ""]"")
+  cat_line(""  $tag"")
+  cat_line(""    "", map_chr(x$tags, format, file = x$file))
+  cat_line(""  $call   "", call)
+  cat_line(""  $object "", obj[[1]])
+  cat_line(""  "", obj[-1])
 }
 
-# Creates roxy_block from list of raw tags ,
 block_create <- function(tokens, call, srcref,
                          registry = list(),
                          global_options = list()) {
@@ -54,8 +84,8 @@ block_create <- function(tokens, call, srcref,
   if (length(tags) == 0) return()
 
   roxy_block(tags,
-    filename = attr(srcref, ""srcfile"")$filename,
-    location = as.vector(srcref),
+    file = attr(srcref, ""srcfile"")$filename,
+    line = as.vector(srcref)[[1]],
     call = call
   )
 }
@@ -75,17 +105,13 @@ block_evaluate <- function(block, env,
                            global_options = list()
                            ) {
 
-  is_eval <- names(block) == ""eval""
-  eval <- block[is_eval]
-  if (length(eval) == 0)
+  tags <- block_get_tags(block, ""eval"")
+  if (length(tags) == 0) {
     return(block)
+  }
 
   # Evaluate
-  results <- lapply(eval, block_eval,
-    block = block,
-    env = env,
-    tag_name = ""@eval""
-  )
+  results <- lapply(tags, roxy_tag_eval, env = env)
   results <- lapply(results, function(x) {
     if (is.null(x)) {
       character()
@@ -96,72 +122,97 @@ block_evaluate <- function(block, env,
 
   # Tokenise and parse
   tokens <- lapply(results, tokenise_block,
-    file = attr(block, ""filename""),
-    offset = attr(block, ""location"")[[1]]
+    file = block$file,
+    offset = block$line
   )
   tags <- lapply(tokens, parse_tags,
     registry = registry,
     global_options = global_options
   )
 
   # Interpolate results back into original locations
-  out <- lapply(block, list)
-  out[is_eval] <- tags
-  names(out)[is_eval] <- """"
-
-  roxy_block_copy(block, compact(unlist(out, recursive = FALSE)))
+  block_replace_tags(block, ""eval"", tags)
 }
 
 block_find_object <- function(block, env) {
   stopifnot(is_roxy_block(block))
 
   object <- object_from_call(
-    call = attr(block, ""call""),
+    call = block$call,
     env = env,
     block = block,
-    file = attr(block, ""filename"")
+    file = block$file
   )
-  attr(block, ""object"") <- object
+  block$object <- object
 
   # Add in defaults generated from the object
   defaults <- object_defaults(object)
+  defaults <- c(defaults, list(roxy_tag(""backref"", block$file, block$file)))
 
-  for (tag in names(defaults)) {
-    if (tag %in% names(block))
-      next
-
-    block[[tag]] <- defaults[[tag]]
-  }
+  default_tags <- map_chr(defaults, ""tag"")
+  defaults <- defaults[!default_tags %in% block_tags(block)]
 
+  block$tags <- c(block$tags, defaults)
   block
 }
 
-block_location <- function(block) {
-  if (is.null(block)) {
+# block accessors ---------------------------------------------------------
+
+block_tags <- function(block) {
+  map_chr(block$tags, ""tag"")
+}
+
+#' @export
+#' @rdname roxy_block
+block_has_tags <- function(block, tags) {
+  any(block_tags(block) %in% tags)
+}
+
+#' @export
+#' @rdname roxy_block
+block_get_tags <- function(block, tags) {
+  block$tags[block_tags(block) %in% tags]
+}
+
+#' @export
+#' @rdname roxy_block
+block_get_tag <- function(block, tag) {
+  matches <- which(block_tags(block) %in% tag)
+  n <- length(matches)
+  if (n == 0) {
     NULL
+  } else if (n == 1) {
+    block$tags[[matches]]
   } else {
-    paste0(basename(attr(block, ""filename"")), "":"", attr(block, ""location"")[[1]])
+    roxy_tag_warning(block$tags[[matches[[2]]]], ""May only use one @"", tag, "" per block"")
+    block$tags[[matches[[1]]]]
   }
 }
 
-block_warning <- function(block, ...) {
-  warning(
-    block_location(block), "": "", ...,
-    call. = FALSE,
-    immediate. = TRUE
-  )
-  NULL
+#' @export
+#' @rdname roxy_block
+block_get_tag_value <- function(block, tag) {
+  block_get_tag(block, tag)$val
+}
+
+block_replace_tags <- function(block, tags, values) {
+  indx <- which(block_tags(block) %in% tags)
+  stopifnot(length(indx) == length(values))
+
+  tags <- lapply(block$tags, list)
+  tags[indx] <- values
+
+  block$tags <- compact(unlist(tags, recursive = FALSE))
+  block
 }
 
+# parsing -----------------------------------------------------------------
+
 parse_tags <- function(tokens, registry = list(), global_options = list()) {
   markdown_activate(tokens, global_options = global_options)
 
   tokens <- parse_description(tokens)
-  tags <- compact(lapply(tokens, parse_tag, registry = registry))
-
-  # Convert to existing named list format - this isn't ideal, but
-  # it's what roxygen already uses
-  set_names(map(tags, ""val""), map_chr(tags, ""tag""))
+  compact(lapply(tokens, parse_tag, registry = registry))
 }
 
 parse_tag <- function(x, registry) {
@@ -191,7 +242,7 @@ parse_description <- function(tags) {
   }
 
   intro <- tags[[1]]
-  intro$val <- str_trim(intro$val)
+  intro$val <- str_trim(intro$raw)
   if (intro$val == """") {
     return(tags[-1])
   }
@@ -205,17 +256,17 @@ parse_description <- function(tags) {
   if (""title"" %in% tag_names) {
     title <- NULL
   } else if (length(paragraphs) > 0) {
-    title <- roxy_tag(""title"", paragraphs[1], intro$file, intro$line)
+    title <- roxy_tag(""title"", paragraphs[1], NULL, intro$file, intro$line)
     paragraphs <- paragraphs[-1]
   } else {
-    title <- roxy_tag(""title"", """", intro$file, intro$line)
+    title <- roxy_tag(""title"", """", NULL, intro$file, intro$line)
   }
 
   # 2nd paragraph = description (unless has @description)
   if (""description"" %in% tag_names || length(paragraphs) == 0) {
     description <- NULL
   } else if (length(paragraphs) > 0) {
-    description <- roxy_tag(""description"", paragraphs[1], intro$file, intro$line)
+    description <- roxy_tag(""description"", paragraphs[1], NULL, intro$file, intro$line)
     paragraphs <- paragraphs[-1]
   }
 
@@ -226,12 +277,12 @@ parse_description <- function(tags) {
     # Find explicit @details tags
     didx <- which(tag_names == ""details"")
     if (length(didx) > 0) {
-      explicit_details <- map_chr(tags[didx], ""val"")
+      explicit_details <- map_chr(tags[didx], ""raw"")
       tags <- tags[-didx]
       details_para <- paste(c(details_para, explicit_details), collapse = ""\n\n"")
     }
 
-    details <- roxy_tag(""details"", details_para, intro$file, intro$line)
+    details <- roxy_tag(""details"", details_para, NULL, intro$file, intro$line)
   } else {
     details <- NULL
   }

---FILE: R/field.R---
@@ -19,8 +19,6 @@ roxy_field <- function(field, ...) {
   )
 }
 
-is_roxy_field <- function(x) inherits(x, ""roxy_field"")
-
 #' @export
 print.roxy_field <- function(x, ...) {
   cat(format(x, wrap = FALSE), ""\n"")

---FILE: R/markdown.R---
@@ -1,11 +1,3 @@
-markdown_if_active <- function(text, tag, sections = FALSE) {
-  if (markdown_on()) {
-    markdown(text, tag, sections)
-  } else {
-    text
-  }
-}
-
 markdown <- function(text, tag = NULL, sections = FALSE) {
   esc_text <- escape_rd_for_md(text)
   esc_text_linkrefs <- add_linkrefs_to_md(esc_text)

---FILE: R/namespace.R---
@@ -56,11 +56,10 @@ roclet_preprocess.roclet_namespace <- function(x,
                                                base_path,
                                                global_options = list()) {
 
-  lines <- unlist(lapply(blocks, block_to_ns, tag_set = ns_tags_import)) %||% character()
-  lines <- sort_c(unique(lines))
-
+  lines <- blocks_to_ns(blocks, env, tag_set = ns_tags_import)
   NAMESPACE <- file.path(base_path, ""NAMESPACE"")
-  if (purrr::is_empty(lines) && !made_by_roxygen(NAMESPACE)) {
+
+  if (length(lines) == 0 && !made_by_roxygen(NAMESPACE)) {
     return(x)
   }
 
@@ -70,17 +69,13 @@ roclet_preprocess.roclet_namespace <- function(x,
   invisible(x)
 }
 
-
 #' @export
 roclet_process.roclet_namespace <- function(x,
                                             blocks,
                                             env,
                                             base_path,
                                             global_options = list()) {
-
-  ns <- unlist(lapply(blocks, block_to_ns, env = env)) %||%
-    character()
-  sort_c(unique(ns))
+  blocks_to_ns(blocks, env)
 }
 
 #' @export
@@ -101,22 +96,6 @@ roclet_tags.roclet_namespace <- function(x) {
   )
 }
 
-block_to_ns <- function(block, env, tag_set = ns_tags) {
-  tags <- intersect(names(block), tag_set)
-  lapply(tags, ns_process_tag, block = block, env = env)
-}
-
-ns_process_tag <- function(tag_name, block, env) {
-  f <- if (tag_name == ""evalNamespace"") {
-    function(tag, block) ns_evalNamespace(tag, block, env)
-  } else {
-    get(paste0(""ns_"", tag_name), mode = ""function"")
-  }
-  tags <- block[names(block) == tag_name]
-
-  lapply(tags, f, block = block)
-}
-
 #' @export
 roclet_output.roclet_namespace <- function(x, results, base_path, ...) {
   NAMESPACE <- file.path(base_path, ""NAMESPACE"")
@@ -137,78 +116,78 @@ roclet_clean.roclet_namespace <- function(x, base_path) {
   }
 }
 
-# Functions that take complete block and return NAMESPACE lines
-ns_export <- function(tag, block) {
-  if (identical(tag, """")) {
+# NAMESPACE generation ----------------------------------------------------
+
+blocks_to_ns <- function(blocks, env, tag_set = ns_tags) {
+  lines <- map(blocks, block_to_ns, env = env, tag_set = tag_set)
+  lines <- unlist(lines) %||% character()
+
+  sort_c(unique(lines))
+}
+
+block_to_ns <- function(block, env, tag_set = ns_tags) {
+  tags <- block_get_tags(block, tag_set)
+
+  map(tags, function(tag) {
+    exec(paste0(""ns_"", tag$tag), tag, block, env)
+  })
+}
+
+ns_export <- function(tag, block, env) {
+  if (identical(tag$val, """")) {
     # FIXME: check for empty exports (i.e. no name)
-    default_export(attr(block, ""object""), block)
+    default_export(block$object, block)
   } else {
-    export(tag)
+    export(tag$val)
   }
 }
-default_export <- function(x, block) UseMethod(""default_export"")
-#' @export
-default_export.s4class   <- function(x, block) export_class(x$value@className)
-#' @export
-default_export.s4generic <- function(x, block) export(x$value@generic)
-#' @export
-default_export.s4method  <- function(x, block) export_s4_method(x$value@generic)
-#' @export
-default_export.s3method  <- function(x, block) export_s3_method(attr(x$value, ""s3method""))
-#' @export
-default_export.rcclass   <- function(x, block) export_class(x$value@className)
-#' @export
-default_export.default   <- function(x, block) export(x$alias)
-#' @export
-default_export.NULL      <- function(x, block) export(block$name)
 
-ns_exportClass       <- function(tag, block) export_class(tag)
-ns_exportMethod      <- function(tag, block) export_s4_method(tag)
-ns_exportPattern     <- function(tag, block) one_per_line(""exportPattern"", tag)
-ns_import            <- function(tag, block) one_per_line(""import"", tag)
-ns_importFrom        <- function(tag, block) repeat_first(""importFrom"", tag)
-ns_importClassesFrom <- function(tag, block) repeat_first(""importClassesFrom"", tag)
-ns_importMethodsFrom <- function(tag, block) repeat_first(""importMethodsFrom"", tag)
+ns_exportClass       <- function(tag, block, env) export_class(tag$val)
+ns_exportMethod      <- function(tag, block, env) export_s4_method(tag$val)
+ns_exportPattern     <- function(tag, block, env) one_per_line(""exportPattern"", tag$val)
+ns_import            <- function(tag, block, env) one_per_line(""import"", tag$val)
+ns_importFrom        <- function(tag, block, env) repeat_first(""importFrom"", tag$val)
+ns_importClassesFrom <- function(tag, block, env) repeat_first(""importClassesFrom"", tag$val)
+ns_importMethodsFrom <- function(tag, block, env) repeat_first(""importMethodsFrom"", tag$val)
 
-ns_exportS3Method    <- function(tag, block) {
-  obj <- attr(block, ""object"")
+ns_exportS3Method    <- function(tag, block, env) {
+  obj <- block$object
 
-  if (length(tag) < 2 && !inherits(obj, ""s3method"")) {
-    block_warning(block,
+  if (length(tag$val) < 2 && !inherits(obj, ""s3method"")) {
+    roxy_tag_warning(tag,
       ""`@exportS3Method` and `@exportS3Method generic` must be used with an S3 method""
     )
     return()
   }
 
-  if (identical(tag, """")) {
+  if (identical(tag$val, """")) {
     method <- attr(obj$value, ""s3method"")
-  } else if (length(tag) == 1) {
-    method <- c(tag, attr(obj$value, ""s3method"")[[2]])
+  } else if (length(tag$val) == 1) {
+    method <- c(tag$val, attr(obj$value, ""s3method"")[[2]])
   } else {
-    method <- tag
+    method <- tag$val
   }
 
   export_s3_method(method)
 }
 
-
-ns_useDynLib         <- function(tag, block) {
-  if (length(tag) == 1) {
-    return(paste0(""useDynLib("", auto_quote(tag), "")""))
+ns_useDynLib         <- function(tag, block, env) {
+  if (length(tag$val) == 1) {
+    return(paste0(""useDynLib("", auto_quote(tag$val), "")""))
   }
 
-  if (any(grepl("","", tag))) {
+  if (any(grepl("","", tag$val))) {
     # If there's a comma in list, don't quote output. This makes it possible
     # for roxygen2 to support other NAMESPACE forms not otherwise mapped
-    args <- paste0(tag, collapse = "" "")
+    args <- paste0(tag$val, collapse = "" "")
     paste0(""useDynLib("", args, "")"")
   } else {
-    repeat_first(""useDynLib"", tag)
+    repeat_first(""useDynLib"", tag$val)
   }
 }
-ns_rawNamespace  <- function(tag, block) tag
+ns_rawNamespace  <- function(tag, block, env) tag$val
 ns_evalNamespace <- function(tag, block, env) {
-  block_eval(tag, block, env, ""@evalNamespace"")
+  roxy_tag_eval(tag, env)
 }
 
 # Functions used by both default_export and ns_* functions
@@ -220,6 +199,25 @@ export_s3_method <- function(x) {
   paste0(""S3method("", args, "")"")
 }
 
+# Default export methods --------------------------------------------------
+
+default_export <- function(x, block) UseMethod(""default_export"")
+#' @export
+default_export.s4class   <- function(x, block) export_class(x$value@className)
+#' @export
+default_export.s4generic <- function(x, block) export(x$value@generic)
+#' @export
+default_export.s4method  <- function(x, block) export_s4_method(x$value@generic)
+#' @export
+default_export.s3method  <- function(x, block) export_s3_method(attr(x$value, ""s3method""))
+#' @export
+default_export.rcclass   <- function(x, block) export_class(x$value@className)
+#' @export
+default_export.default   <- function(x, block) export(x$alias)
+#' @export
+default_export.NULL      <- function(x, block) export(block_get_tag_value(block, ""name""))
+
+
 # Helpers -----------------------------------------------------------------
 
 one_per_line <- function(name, x) {

---FILE: R/object-defaults.R---
@@ -8,9 +8,9 @@ object_defaults.data <- function(x) {
   str_out <- rd(object_format(x$value))
 
   list(
-    docType = ""data"",
-    format = str_out,
-    keywords = ""datasets""
+    roxy_tag(""docType"", NULL, ""data""),
+    roxy_tag(""format"", NULL, str_out),
+    roxy_tag(""keywords"", NULL, ""datasets"")
   )
 }
 
@@ -26,34 +26,45 @@ object_defaults.package <- function(x) {
   }
 
   list(
-    docType = ""package"",
-    name = package_suffix(desc$Package),
+    roxy_tag(""docType"", NULL, ""package""),
+    roxy_tag(""name"", NULL, package_suffix(desc$Package)),
     # ""NULL"" prevents addition of default aliases, see also #202
-    aliases = paste(""NULL"", desc$Package, package_suffix(desc$Package)),
-    title = paste0(desc$Package, "": "", desc$Title),
-    description = description,
-    seealso = package_seealso(desc),
-    author = package_authors(desc)
+    roxy_tag(""aliases"", NULL, paste(""NULL"", desc$Package, package_suffix(desc$Package))),
+    roxy_tag(""title"", NULL, paste0(desc$Package, "": "", desc$Title)),
+    roxy_tag(""description"", NULL, description),
+    roxy_tag(""seealso"", NULL, package_seealso(desc)),
+    roxy_tag(""author"", NULL, package_authors(desc))
+  )
+}
+
+#' @export
+object_defaults.import <- function(x) {
+  list(
+    roxy_tag(""docType"", NULL, ""import""),
+    roxy_tag(""name"", NULL, ""reexports""),
+    roxy_tag(""keywords"", NULL, ""internal""),
+    roxy_tag(""title"", NULL, ""Objects exported from other packages""),
+    roxy_tag("".reexport"", NULL, roxy_field_reexport(x$value$pkg, x$value$fun))
   )
 }
 
 #' @export
 object_defaults.s4class <- function(x) {
   list(
-    docType = ""class""
+    roxy_tag(""docType"", NULL, ""class"")
   )
 }
 
 #' @export
 object_defaults.rcclass <- function(x) {
   list(
-    docType = ""class""
+    roxy_tag(""docType"", NULL, ""class"")
   )
 }
 
 #' @export
 object_defaults.s4method <- function(x) {
   list(
-    docType = ""methods""
+    roxy_tag(""docType"", NULL, ""class"")
   )
 }

---FILE: R/object-from-call.R---
@@ -55,7 +55,7 @@ object_from_name <- function(name, env, block) {
     type <- ""s4generic""
   } else if (is.function(value)) {
     # Potential S3 methods/generics need metadata added
-    method <- unlist(block$method, use.names = FALSE)
+    method <- block_get_tag_value(block, ""method"")
     value <- add_s3_metadata(value, name, env, method)
     if (inherits(value, ""s3generic"")) {
       type <- ""s3generic""
@@ -166,7 +166,7 @@ parser_setMethodS3 <- function(call, env, block) {
   class <- as.character(call[[3]])
   name <- paste(method, class, sep = ""."")
 
-  method <- unlist(block$method, use.names = FALSE)
+  method <- block_get_tag_value(block, ""method"")
   value <- add_s3_metadata(get(name, env), name, env, method)
 
   object(value, name, ""s3method"")
@@ -249,13 +249,19 @@ object <- function(value, alias, type) {
 }
 
 #' @export
-print.object <- function(x, ...) {
-  cat(""<"", class(x)[1], ""> "", x$name,
-    if (!is.null(x$alias)) paste0("" ("", x$alias, "")""), ""\n"",
-    sep = """"
+format.object <- function(x, ...) {
+  c(
+    paste0(""<"", class(x)[1], ""> "", x$name),
+    paste0(""  $topic "", x$topic),
+    if (!is.null(x$alias)) paste0(""  $alias "", x$alias)
   )
 }
 
+#' @export
+print.object <- function(x, ...) {
+  cat_line(format(x, ...))
+}
+
 object_topic <- function(value, alias, type) {
   switch(type,
     s4method = paste0(value@generic, "","", paste0(value@defined, collapse = "",""), ""-method""),

---FILE: R/object-import.R---
@@ -1,14 +1,3 @@
-#' @export
-object_defaults.import <- function(x) {
-  list(
-    docType = ""import"",
-    name = ""reexports"",
-    keywords = ""internal"",
-    title = ""Objects exported from other packages"",
-    .reexport = roxy_field_reexport(x$value$pkg, x$value$fun)
-  )
-}
-
 # Re-export ----------------------------------------------------------------
 
 roxy_field_reexport <- function(pkg, fun) {

---FILE: R/parse.R---
@@ -56,11 +56,13 @@ parse_package <- function(path = ""."",
 parse_file <- function(file,
                        env = env_file(file),
                        registry = default_tags(),
-                       global_options = list()) {
+                       global_options = list(),
+                       srcref_path = NULL) {
 
   blocks <- tokenize_file(file,
     registry = registry,
-    global_options = global_options
+    global_options = global_options,
+    srcref_path = srcref_path
   )
 
   if (!is.null(env)) {
@@ -90,7 +92,8 @@ parse_text <- function(text,
     file,
     env = env,
     registry = registry,
-    global_options = global_options
+    global_options = global_options,
+    srcref_path = ""<text>""
   )
   blocks <- order_blocks(blocks)
   blocks
@@ -116,14 +119,11 @@ env_package <- function(path) {
 
 order_blocks <- function(blocks) {
   block_order <- function(x) {
-    if (!""order"" %in% names(x)) {
-      Inf
-    } else {
-      ord <- x[names(x) == ""order""]
-      if (length(ord) > 1) {
-        ord <- ord[[length(ord)]]
-      }
+    if (block_has_tags(x, ""order"")) {
+      ord <- block_get_tag_value(x, ""order"")
       as.double(ord)
+    } else {
+      Inf
     }
   }
 

---FILE: R/rd-describe-in.R---
@@ -1,34 +1,31 @@
 topic_add_describe_in <- function(topic, block, env) {
-  tags <- block_tags(block, ""describeIn"")
-  if (length(tags) == 0)
-    return(NULL)
-
-  if (length(tags) > 1) {
-    block_warning(block, ""May only use one @describeIn per block"")
+  tag <- block_get_tag(block, ""describeIn"")
+  if (is.null(tag)) {
     return()
   }
-  if (is.null(attr(block, ""object""))) {
-    block_warning(block, ""@describeIn must be used with an object"")
+
+  if (is.null(block$object)) {
+    roxy_tag_warning(tag, ""must be used with an object"")
     return()
   }
-  if (any(names(block) == ""name"")) {
-    block_warning(block, ""@describeIn can not be used with @name"")
+  if (block_has_tags(block,  ""name"")) {
+    roxy_tag_warning(tag, ""can not be used with @name"")
     return()
   }
-  if (any(names(block) == ""rdname"")) {
-    block_warning(block, ""@describeIn can not be used with @rdname"")
+  if (block_has_tags(block, ""rdname"")) {
+    roxy_tag_warning(tag, ""can not be used with @rdname"")
     return()
   }
 
-  dest <- find_object(tags$describeIn$name, env)
-  label <- build_label(attr(block, ""object""), dest, block)
+  dest <- find_object(tag$val$name, env)
+  label <- build_label(block$object, dest, block)
   if (is.null(label))
     return()
 
   topic$add(roxy_field_minidesc(
     label$type,
     label$label,
-    tags$describeIn$description
+    tag$val$description
   ))
   dest$topic
 }

---FILE: R/rd-examples.R---
@@ -1,26 +1,27 @@
 topic_add_examples <- function(topic, block, base_path) {
-  examples <- block_tags(block, c(""examples"", ""example""))
+  tags <- block_get_tags(block, c(""examples"", ""example""))
 
-  for (i in seq_along(examples)) {
-    if (names(examples)[[i]] == ""examples"") {
-      example <- examples[[i]]
+  for (tag in tags) {
+    if (tag$tag == ""examples"") {
+      example <- tag$val
     } else {
-      example <- read_example_from_path(str_trim(examples[[i]]), base_path, block = block)
+      example <- read_example_from_path(tag, base_path)
     }
     topic$add_simple_field(""examples"", example)
   }
 }
 
-read_example_from_path <- function(path, base_path, block = NULL) {
+read_example_from_path <- function(tag, base_path) {
+  path <- str_trim(tag$val)
   nl <- str_count(path, ""\n"")
   if (any(nl) > 0) {
-    block_warning(block, ""@example spans multiple lines. Do you want @examples?"")
+    roxy_tag_warning(tag, ""spans multiple lines. Do you want @examples?"")
     return()
   }
 
   path <- file.path(base_path, path)
   if (!file.exists(path)) {
-    block_warning(block, ""@example "", path, "" doesn't exist"")
+    roxy_tag_warning(tag, ""'"", path, ""' doesn't exist"")
     return()
   }
 

---FILE: R/rd-template.R---
@@ -18,28 +18,27 @@ template_eval <- function(template_path, vars) {
 }
 
 process_templates <- function(block, base_path, global_options = list()) {
-  template_locs <- names(block) == ""template""
-  template_tags <- block[template_locs]
-  if (length(template_tags) == 0)
+  tags <- block_get_tags(block, ""template"")
+  if (length(tags) == 0)
     return(block)
 
-  templates <- unlist(template_tags, use.names = FALSE)
+  templates <- map_chr(tags, ""val"")
   paths <- map_chr(templates, template_find, base_path = base_path)
 
-  var_tags <- block[names(block) == ""templateVar""]
-  vars <- set_names(map(var_tags, ""description""), map_chr(var_tags, ""name""))
+  var_tags <- block_get_tags(block, ""templateVar"")
+  vars <- set_names(
+    map(var_tags, c(""val"", ""description"")),
+    map_chr(var_tags, c(""val"", ""name""))
+  )
   vars <- lapply(vars, utils::type.convert, as.is = TRUE)
 
   results <- lapply(paths, template_eval, vars = list2env(vars))
   tokens <- lapply(results, tokenise_block, file = ""TEMPLATE"", offset = 0L)
-
-  # Insert templates back in the location where they came from
-  tags <- lapply(block, list)
-  tags[template_locs] <- lapply(tokens, parse_tags,
+  tags <- lapply(tokens, parse_tags,
     registry = roclet_tags.roclet_rd(list()),
     global_options = global_options
   )
-  names(tags)[template_locs] <- """"
 
-  roxy_block_copy(block, unlist(tags, recursive = FALSE))
+  # Insert templates back in the location where they came from
+  block_replace_tags(block, ""template"", tags)
 }

---FILE: R/rd.R---
@@ -126,9 +126,9 @@ block_to_rd <- function(block, base_path, env, global_options = list()) {
     return()
   }
 
-  name <- block$name %||% attr(block, ""object"")$topic
+  name <- block_get_tag(block, ""name"")$val %||% block$object$topic
   if (is.null(name)) {
-    block_warning(block, ""Missing name"")
+    roxy_tag_warning(block$tags[[1]], ""Missing name"")
     return()
   }
 
@@ -138,8 +138,10 @@ block_to_rd <- function(block, base_path, env, global_options = list()) {
   topic_add_name_aliases(rd, block, name)
 
   # Some fields added directly by roxygen internals
-  fields <- Filter(is_roxy_field, block)
-  rd$add(fields)
+  tags <- Filter(roxy_tag_is_field, block$tags)
+  for (tag in tags) {
+    rd$add(tag$val)
+  }
 
   topic_add_backref(rd, block)
   topic_add_doc_type(rd, block)
@@ -158,13 +160,12 @@ block_to_rd <- function(block, base_path, env, global_options = list()) {
   topic_add_value(rd, block)
 
   if (rd$has_field(""description"") && rd$has_field(""reexport"")) {
-    block_warning(block, ""Can't use description when re-exporting"")
+    roxy_tag_warning(block$tags[[1]], ""Can't use description when re-exporting"")
     return()
   }
 
   describe_rdname <- topic_add_describe_in(rd, block, env)
-
-  filename <- describe_rdname %||% block$rdname %||% nice_name(name)
+  filename <- describe_rdname %||% block_get_tag(block, ""rdname"")$val %||% nice_name(name)
   rd$filename <- paste0(filename, "".Rd"")
 
   rd
@@ -204,58 +205,51 @@ roclet_clean.roclet_rd <- function(x, base_path) {
   unlink(purrr::keep(rd, made_by_roxygen))
 }
 
-block_tags <- function(x, tag) {
-  x[names(x) %in% tag]
-}
-
+# Does this block get an Rd file?
 needs_doc <- function(block) {
-  # Does this block get an Rd file?
-  if (any(names(block) == ""noRd"")) {
+  if (block_has_tags(block, ""noRd"")) {
     return(FALSE)
   }
 
-  key_tags <- c(""description"", ""param"", ""return"", ""title"", ""example"",
+  block_has_tags(block, c(
+    ""description"", ""param"", ""return"", ""title"", ""example"",
     ""examples"", ""name"", ""rdname"", ""usage"", ""details"", ""introduction"",
     ""inherit"", ""describeIn"")
-
-  any(names(block) %in% key_tags)
+  )
 }
 
 # Tag processing functions ------------------------------------------------
 
 topic_add_backref <- function(topic, block) {
-  backrefs <- block_tags(block, ""backref"") %||% attr(block, ""filename"")
-
-  for (backref in backrefs) {
-    topic$add_simple_field(""backref"", backref)
+  tags <- block_get_tags(block, ""backref"")
+  for (tag in tags) {
+    topic$add_simple_field(""backref"", tag$val)
   }
 }
 
 # Simple tags can be converted directly to fields
 topic_add_simple_tags <- function(topic, block) {
-  simple_tags <- c(
-    ""author"", ""concept"", ""description"", ""details"", ""encoding"", ""family"",
-    ""format"", ""note"", ""rawRd"", ""references"",
-    ""seealso"", ""source"", ""title""
+  simple_tags <- block_get_tags(block,
+    c(
+      ""author"", ""concept"", ""description"", ""details"", ""encoding"", ""family"",
+      ""format"", ""note"", ""rawRd"", ""references"",
+      ""seealso"", ""source"", ""title""
+    )
   )
 
-  is_simple <- names(block) %in% simple_tags
-  tag_values <- block[is_simple]
-  tag_names <- names(block)[is_simple]
-
-  for (i in seq_along(tag_values)) {
-    if (length(tag_values[[i]]) && nchar(tag_values[[i]][[1]])) {
-      topic$add_simple_field(tag_names[[i]], tag_values[[i]][[1]])
+  for (tag in simple_tags) {
+    if (length(tag$val) && nchar(tag$val[[1]])) {
+      topic$add_simple_field(tag$tag, tag$val[[1]])
     }
-    for (sec in tag_values[[i]][-1]) {
-      topic$add_simple_field(""rawRd"", sec)
+    for (extra in tag$val[-1]) {
+      topic$add_simple_field(""rawRd"", extra)
     }
   }
 }
 
 topic_add_params <- function(topic, block) {
   # Used in process_inherit_params()
-  value <- attr(block, ""object"")$value
+  value <- block$object$value
   if (is.function(value)) {
     formals <- formals(value)
     topic$add_simple_field(""formals"", names(formals))
@@ -265,19 +259,20 @@ topic_add_params <- function(topic, block) {
 }
 
 topic_add_name_aliases <- function(topic, block, name) {
-  tags <- block_tags(block, ""aliases"")
+  tags <- block_get_tags(block, ""aliases"")
 
   if (length(tags) == 0) {
     aliases <- character()
   } else {
-    aliases <- str_split(str_trim(unlist(tags, use.names = FALSE)), ""\\s+"")[[1]]
+    vals <- map_chr(tags, ""val"")
+    aliases <- unlist(str_split(vals, ""\\s+""))
   }
 
   if (any(aliases == ""NULL"")) {
     # Don't add default aliases
-    aliases <- aliases[aliases != ""NULL""]
+    aliases <- setdiff(aliases, ""NULL"")
   } else {
-    aliases <- c(name, attr(block, ""object"")$alias, aliases)
+    aliases <- c(name, block$object$alias, aliases)
   }
   aliases <- unique(aliases)
 
@@ -287,7 +282,7 @@ topic_add_name_aliases <- function(topic, block, name) {
 
 
 topic_add_methods <- function(topic, block) {
-  obj <- attr(block, ""object"")
+  obj <- block$object
   if (!inherits(obj, ""rcclass"")) return()
 
   methods <- obj$methods
@@ -306,57 +301,61 @@ topic_add_methods <- function(topic, block) {
 }
 
 topic_add_inherit <- function(topic, block) {
-  tags <- block_tags(block, ""inherit"")
+  tags <- block_get_tags(block, ""inherit"")
   for (tag in tags) {
-    field <- roxy_field_inherit(tag$source, list(tag$fields))
+    field <- roxy_field_inherit(tag$val$source, list(tag$val$fields))
     topic$add_field(field)
   }
 
-  tags <- block_tags(block, ""inheritParams"")
+  tags <- block_get_tags(block, ""inheritParams"")
   for (tag in tags) {
-    field <- roxy_field_inherit(tag, list(""params""))
+    field <- roxy_field_inherit(tag$val, list(""params""))
     topic$add_field(field)
   }
 
-  tags <- block_tags(block, ""inheritSection"")
+  tags <- block_get_tags(block, ""inheritSection"")
   for (tag in tags) {
-    field <- roxy_field_inherit_section(tag$name, tag$description)
+    field <- roxy_field_inherit_section(tag$val$name, tag$val$description)
     topic$add_field(field)
   }
 
-  tags <- block_tags(block, ""inheritDotParams"")
+  tags <- block_get_tags(block, ""inheritDotParams"")
   for (tag in tags) {
-    field <- roxy_field_inherit_dot_params(tag$source, tag$args)
+    field <- roxy_field_inherit_dot_params(tag$val$source, tag$val$args)
     topic$add_field(field)
   }
 }
 
 
 topic_add_value <- function(topic, block) {
-  tags <- block_tags(block, ""return"")
+  tags <- block_get_tags(block, ""return"")
 
   for (tag in tags) {
-    topic$add_simple_field(""value"", tag)
+    topic$add_simple_field(""value"", tag$val)
   }
 }
 
 topic_add_keyword <- function(topic, block) {
-  tags <- block_tags(block, ""keywords"")
-  keywords <- unlist(str_split(str_trim(tags), ""\\s+""))
+  tags <- block_get_tags(block, ""keywords"")
+
+  vals <- map_chr(tags, ""val"")
+  keywords <- unlist(str_split(vals, ""\\s+""))
 
   topic$add_simple_field(""keyword"", keywords)
 }
 
 # Prefer explicit \code{@@usage} to a \code{@@formals} list.
 topic_add_usage <- function(topic, block, old_usage = FALSE) {
-  if (is.null(block$usage)) {
-    usage <- object_usage(attr(block, ""object""), old_usage = old_usage)
-  } else if (block$usage == ""NULL"") {
+  tag <- block_get_tag(block, ""usage"")
+
+  if (is.null(tag)) {
+    usage <- object_usage(block$object, old_usage = old_usage)
+  } else if (tag$val == ""NULL"") {
     usage <- NULL
   } else {
     # Treat user input as already escaped, otherwise they have no way
     # to enter \S4method etc.
-    usage <- rd(block$usage)
+    usage <- rd(tag$val)
   }
   topic$add_simple_field(""usage"", usage)
 }
@@ -370,26 +369,18 @@ topic_add_fields <- function(topic, block) {
 }
 
 topic_add_eval_rd <- function(topic, block, env) {
-  tags <- block_tags(block, ""evalRd"")
+  tags <- block_get_tags(block, ""evalRd"")
 
   for (tag in tags) {
-    out <- block_eval(tag, block, env, ""@evalRd"")
-    if (!is.null(out)) {
-      topic$add_simple_field(""rawRd"", out)
-    }
+    out <- roxy_tag_eval(tag, env)
+    topic$add_simple_field(""rawRd"", out)
   }
 }
 
 topic_add_include_rmd <- function(topic, block, base_path) {
-  rmds <- block_tags(block, ""includeRmd"")
-
-  for (rmd in rmds) {
-    tag <- roxy_tag(
-      ""includeRmd"",
-      rmd,
-      attr(block, ""filename""),
-      attr(block, ""location"")[[1]]
-    )
+  tags <- block_get_tags(block, ""includeRmd"")
+
+  for (tag in tags) {
     if (!is_installed(""rmarkdown"")) {
       roxy_tag_warning(tag, ""Needs the rmarkdown package"")
     }
@@ -404,58 +395,53 @@ topic_add_include_rmd <- function(topic, block, base_path) {
 }
 
 topic_add_sections <- function(topic, block) {
-  sections <- block_tags(block, ""section"")
+  tags <- block_get_tags(block, ""section"")
 
-  for (section in sections) {
-    pieces <- str_split(section, "":"", n = 2)[[1]]
+  for (tag in tags) {
+    pieces <- str_split(tag$val, "":"", n = 2)[[1]]
 
     title <- str_split(pieces[1], ""\n"")[[1]]
     if (length(title) > 1) {
-      return(block_warning(
-        block,
+      roxy_tag_warning(tag,
         ""Section title spans multiple lines: \n"", ""@section "", title[1]
-      ))
+      )
+      return()
     }
 
     topic$add_field(roxy_field_section(pieces[1], pieces[2]))
   }
 }
 
 topic_add_doc_type <- function(topic, block) {
-  doctype <- block$docType
-  if (is.null(doctype)) return()
+  tag <- block_get_tag(block, ""docType"")
+  if (is.null(tag)) {
+    return()
+  }
 
-  topic$add_simple_field(""docType"", doctype)
+  topic$add_simple_field(""docType"", tag$val)
 
-  if (doctype == ""package"") {
-    name <- block$name
-    if (!str_detect(name, ""-package"")) {
-      topic$add_simple_field(""alias"", package_suffix(name))
+  if (tag$val == ""package"") {
+    name <- block_get_tag(block, ""name"")
+    if (!str_detect(name$val, ""-package"")) {
+      topic$add_simple_field(""alias"", package_suffix(name$val))
     }
   }
-
 }
 
 package_suffix <- function(name) {
   paste0(name, ""-package"")
 }
 
-process_tag <- function(block, tag, f = roxy_field, ...) {
-  matches <- block[names(block) == tag]
-  if (length(matches) == 0) return()
-
-  lapply(matches, function(p) f(tag, p, ...))
-}
-
 # Name + description tags ------------------------------------------------------
 
-
 process_def_tag <- function(topic, block, tag) {
-  tags <- block[names(block) == tag]
-  if (length(tags) == 0) return()
+  tags <- block_get_tags(block, tag)
+  if (length(tags) == 0) {
+    return()
+  }
 
-  desc <- str_trim(sapply(tags, ""[["", ""description""))
-  names(desc) <- sapply(tags, ""[["", ""name"")
+  desc <- str_trim(map_chr(tags, c(""val"", ""description"")))
+  names(desc) <- map_chr(tags, c(""val"", ""name""))
 
   topic$add_simple_field(tag, desc)
 }

---FILE: R/roclet.R---
@@ -6,7 +6,7 @@
 #' @section Methods:
 #'
 #' * `roclet_tags()`: return named list, where names give recognised tags and
-#'   values give tag parsing function. See [roxy_tag] for built-in options.
+#'   values give tag parsing function. See [roxy_tag] for built-in parsers.
 #'
 #' * `roclet_preprocess()` is called after blocks have been parsed but before
 #'   code has been evaluated. This should only be needed if your roclet affects
@@ -22,6 +22,12 @@
 #' * `roclet_clean()` called when `roxygenise(clean = TRUE)`. Should remove
 #'   any files created by the roclet.
 #'
+#' @param x A `roclet` object.
+#' @param blocks A list of [roxy_block] objects.
+#' @param results Value returned from your `roclet_process()` method.
+#' @param base_path Path to root of source package.
+#' @param global_options List of roxygen2 options.
+#' @param env Package environment.
 #' @keywords internal
 #' @name roclet
 NULL
@@ -32,19 +38,12 @@ roclet <- function(subclass, ...) {
   structure(list(...), class = c(paste0(""roclet_"", subclass), ""roclet""))
 }
 
-#' @export
-#' @rdname roclet
-roclet_output <- function(x, results, base_path, ...) {
-  UseMethod(""roclet_output"", x)
-}
-
 #' @export
 #' @rdname roclet
 roclet_tags <- function(x) {
   UseMethod(""roclet_tags"")
 }
 
-
 #' @export
 #' @rdname roclet
 roclet_preprocess <- function(x, blocks, base_path, global_options = list()) {
@@ -62,6 +61,12 @@ roclet_process <- function(x, blocks, env, base_path, global_options = list()) {
   UseMethod(""roclet_process"")
 }
 
+#' @export
+#' @rdname roclet
+roclet_output <- function(x, results, base_path, ...) {
+  UseMethod(""roclet_output"", x)
+}
+
 #' @export
 #' @rdname roclet
 roclet_clean <- function(x, base_path) {
@@ -120,10 +125,16 @@ is.roclet <- function(x) inherits(x, ""roclet"")
 #' @param global_options List of global options
 #' @export
 #' @keywords internal
-roc_proc_text <- function(roclet, input, registry = default_tags(),
+roc_proc_text <- function(roclet,
+                          input,
+                          registry = NULL,
                           global_options = list()) {
   stopifnot(is.roclet(roclet))
 
+  if (is.null(registry)) {
+    registry <- c(default_tags(), roclet_tags(roclet))
+  }
+
   file <- tempfile()
   write_lines(input, file)
   on.exit(unlink(file))

---FILE: R/tag-parser.R---
@@ -0,0 +1,233 @@
+#' Parse tags
+#'
+#' These functions parse the `raw` tag value, convert a string into a richer R
+#' object and storing it in `val`, or provide an informative warning and
+#' returning `NULL`. Two exceptions to the rule are `tag_words()` and
+#' `tag_two_part()`, which are tag parsing generator functions.
+#'
+#' @param x A [roxy_tag] object to parss
+#' @return A [roxy_tag] object with the `val` field set to the parsed value.
+#' @name tag_parsers
+#' @keywords internal
+NULL
+
+#' @export
+#' @rdname tag_parsers
+tag_value <- function(x) {
+  if (x$raw == """") {
+    roxy_tag_warning(x, ""requires a value"")
+  } else if (!rdComplete(x$raw)) {
+    roxy_tag_warning(x, ""mismatched braces or quotes"")
+  } else {
+    x$val <- str_trim(x$raw)
+    x
+  }
+}
+
+#' @export
+#' @rdname tag_parsers
+tag_inherit <- function(x) {
+  if (x$raw == """") {
+    roxy_tag_warning(x, ""requires a value"")
+  } else if (!rdComplete(x$raw)) {
+    roxy_tag_warning(x, ""mismatched braces or quotes"")
+  } else {
+    pieces <- str_split(str_trim(x$raw), ""\\s+"")[[1]]
+    fields <- pieces[-1]
+
+    # Also recorded in `rd.Rmd`
+    all <- c(""params"", ""return"", ""title"", ""description"", ""details"", ""seealso"",
+      ""sections"", ""references"", ""examples"", ""author"", ""source"")
+    if (length(fields) == 0) {
+      fields <- all
+    } else {
+      unknown <- setdiff(fields, all)
+      if (length(unknown) > 0) {
+        types <- paste0(unknown, collapse = "", "")
+        roxy_tag_warning(x, ""Unknown inherit type: "", types)
+        fields <- intersect(fields, all)
+      }
+    }
+
+    x$val <- list(
+      source = pieces[1],
+      fields = fields
+    )
+
+    x
+  }
+}
+
+#' @export
+#' @rdname tag_parsers
+tag_name <- function(x) {
+  if (x$raw == """") {
+    roxy_tag_warning(""requires a name"")
+  } else if (!rdComplete(x$raw)) {
+    roxy_tag_warning(""mismatched braces or quotes"")
+  } else if (str_count(x$raw, ""\\s+"") > 1) {
+    roxy_tag_warning(""should have only a single argument"")
+  } else {
+    x$val <- str_trim(x$raw)
+    x
+  }
+}
+
+#' @export
+#' @rdname tag_parsers
+#' @param first,second Name of first and second parts of two part tags
+#' @param required Is the second part required (TRUE) or can it be blank
+#'   (FALSE)?
+#' @param markdown Should the second part be parsed as markdown?
+tag_two_part <- function(first, second, required = TRUE, markdown = TRUE) {
+  force(required)
+  force(markdown)
+
+  function(x) {
+    if (str_trim(x$raw) == """") {
+      roxy_tag_warning(x, ""requires a value"")
+    } else if (required && !str_detect(x$raw, ""[[:space:]]+"")) {
+      roxy_tag_warning(x, ""requires "", first, "" and "", second)
+    } else if (!rdComplete(x$raw)) {
+      roxy_tag_warning(x, ""mismatched braces or quotes"")
+    } else {
+      pieces <- str_split_fixed(str_trim(x$raw), ""[[:space:]]+"", 2)
+
+      if (markdown) {
+        pieces[,2] <- markdown_if_active(pieces[,2], x)
+      }
+
+      x$val <- list(
+        pieces[, 1],
+        trim_docstring(pieces[,2])
+      )
+      names(x$val) <- c(first, second)
+      x
+    }
+  }
+}
+
+#' @export
+#' @rdname tag_parsers
+tag_name_description <- tag_two_part(""name"", ""description"")
+
+#' @export
+#' @rdname tag_parsers
+#' @param min,max Minimum and maximum number of words
+tag_words <- function(min = 0, max = Inf) {
+  function(x) {
+    if (!rdComplete(x$raw)) {
+      return(roxy_tag_warning(x, ""mismatched braces or quotes""))
+    }
+
+    words <- str_split(str_trim(x$raw), ""\\s+"")[[1]]
+    if (length(words) < min) {
+      roxy_tag_warning(x,  "" needs at least "", min, "" words"")
+    } else if (length(words) > max) {
+      roxy_tag_warning(x,  "" can have at most "", max, "" words"")
+    }
+
+    x$val <- words
+    x
+  }
+}
+
+#' @export
+#' @rdname tag_parsers
+tag_words_line <- function(x) {
+  x$val <- str_trim(x$raw)
+
+  if (str_detect(x$val, ""\n"")) {
+    roxy_tag_warning(x, ""may only span a single line"")
+  } else if (!rdComplete(x$val)) {
+    roxy_tag_warning(x, ""mismatched braces or quotes"")
+  } else {
+    x$val <- str_split(x$val, ""\\s+"")[[1]]
+    x
+  }
+}
+
+#' @export
+#' @rdname tag_parsers
+tag_toggle <- function(x) {
+  x$val <- str_trim(x$raw)
+
+  if (x$val != """") {
+    roxy_tag_warning(x, ""has no parameters"")
+  } else {
+    x
+  }
+}
+
+#' @export
+#' @rdname tag_parsers
+tag_code <- function(x) {
+  if (x$raw == """") {
+    roxy_tag_warning(x, ""requires a value"")
+  } else {
+    tryCatch({
+      parse(text = x$raw)
+    }, error = function(e) {
+      roxy_tag_warning(x, ""code failed to parse.\n"", e$message)
+    })
+
+    x$val <- x$raw
+    x
+  }
+}
+
+# Examples need special parsing because escaping rules are different
+#' @export
+#' @rdname tag_parsers
+tag_examples <- function(x) {
+  if (x$raw == """") {
+    return(roxy_tag_warning(x, ""requires a value""))
+  }
+
+  x$val <- escape_examples(gsub(""^\n"", """", x$raw))
+  if (!rdComplete(x$val, TRUE)) {
+    roxy_tag_warning(x, ""mismatched braces or quotes"")
+  } else {
+    x
+  }
+}
+
+#' @export
+#' @rdname tag_parsers
+tag_markdown <- function(x) {
+  x$val <- markdown_if_active(x$raw, x)
+  x
+}
+
+#' @export
+#' @rdname tag_parsers
+tag_markdown_with_sections <- function(x) {
+  if (x$raw == """") {
+    return(roxy_tag_warning(x, ""requires a value""))
+  }
+
+  x$val <- markdown_if_active(x$raw, x, sections = TRUE)
+  for (i in seq_along(x$val)) {
+    if (!rdComplete(x$val[i])) {
+      roxy_tag_warning(x, ""mismatched braces or quotes"")
+      x$val[i] <- """"
+    } else {
+      x$val[i] <- str_trim(x$val[i])
+    }
+  }
+
+  x
+}
+
+markdown_if_active <- function(text, tag, sections = FALSE) {
+  if (markdown_on()) {
+    markdown(text, tag, sections)
+  } else {
+    if (!rdComplete(text)) {
+      roxy_tag_warning(tag, ""mismatched braces or quotes"")
+      """"
+    } else {
+      str_trim(text)
+    }
+  }
+}

---FILE: R/tag.R---
@@ -1,26 +1,21 @@
-#' Parsing tags.
+#' `roxy_tag` S3 constructor
 #'
-#' `roxy_tag` constructs a tag object, and `roxy_tag_warning` makes
-#' an informative warning using the location information stored in the tag.
-#' The remainder of the tag functions parse the tag value, convert a string
-#' into a richer R object, or providing informative warnings and returning
-#' valid if the value is invalid.
-#'
-#' Two exceptions to the rule are `tag_words` and `tag_two_part`, which are
-#' tag parsing generator functions.
+#' `roxy_tag()` is the constructor for tag objects.
+#' `roxy_tag_warning()` generates a warning that gives the location of the tag.
 #'
 #' @keywords internal
 #' @export
 #' @param tag Tag name
-#' @param val Tag value. When read from the file, this will be a string,
-#'   but after parsing can be a more complicated structure (typically
-#'   a character vector, but sometimes a list).
+#' @param raw Raw tag value, a string.
+#' @param val Parsed tag value, typically a character vector, but sometimes
+#'   a list. Usually filled in by `tag_parsers`
 #' @param file,line Location of the tag
-roxy_tag <- function(tag, val, file = """", line = 0) {
+roxy_tag <- function(tag, raw, val = NULL, file = NA_character_, line = NA_integer_) {
   structure(
     list(
       file = file,
       line = line,
+      raw = raw,
       tag = tag,
       val = val
     ),
@@ -31,231 +26,69 @@ roxy_tag <- function(tag, val, file = """", line = 0) {
 is.roxy_tag <- function(x) inherits(x, ""roxy_tag"")
 
 #' @export
-print.roxy_tag <- function(x, ...) {
-  cat(""["", x$file, "":"", x$line, ""] @"", x$tag, "" "", encodeString(x$val), ""\n"",
-    sep = """")
-}
-
-make_tag_message <- function(x, message) {
-  paste0(
-    ""@"",
-    x$tag,
-    if (x$file != """") paste0("" ["", x$file, ""#"", x$line, ""]""),
-    "": "",
-    message
-  )
-}
-
-#' @export
-#' @rdname roxy_tag
-roxy_tag_warning <- function(x, ...) {
-  warning(make_tag_message(x, paste0(...)), call. = FALSE, immediate. = TRUE)
-  NULL
-}
-
-
-#' @export
-#' @rdname roxy_tag
-tag_value <- function(x) {
-  if (x$val == """") {
-    roxy_tag_warning(x, ""requires a value"")
-  } else if (!rdComplete(x$val)) {
-    roxy_tag_warning(x, ""mismatched braces or quotes"")
+format.roxy_tag <- function(x, ..., file = NULL) {
+  if (identical(x$file, file)) {
+    file <- ""line""
+  } else if (is.na(x$file)) {
+    file <- ""????""
   } else {
-    x$val <- str_trim(x$val)
-    x
+    file <- basename(x$file)
   }
-}
+  line <- if (is.na(x$line)) ""???"" else format(x$line, width = 3)
 
-#' @export
-#' @rdname roxy_tag
-tag_inherit <- function(x) {
-  if (x$val == """") {
-    roxy_tag_warning(x, ""requires a value"")
-  } else if (!rdComplete(x$val)) {
-    roxy_tag_warning(x, ""mismatched braces or quotes"")
-  } else {
-    pieces <- str_split(str_trim(x$val), ""\\s+"")[[1]]
-    fields <- pieces[-1]
+  loc <- paste0(""["", file, "":"", line, ""]"")
 
-    # Also recorded in `rd.Rmd`
-    all <- c(""params"", ""return"", ""title"", ""description"", ""details"", ""seealso"",
-      ""sections"", ""references"", ""examples"", ""author"", ""source"")
-    if (length(fields) == 0) {
-      fields <- all
+  if (!is.null(x$raw)) {
+    if (nchar(x$raw) > 50) {
+      raw <-  paste0(substr(x$raw, 1, 47), ""..."")
     } else {
-      unknown <- setdiff(fields, all)
-      if (length(unknown) > 0) {
-        types <- paste0(unknown, collapse = "", "")
-        roxy_tag_warning(x, ""Unknown inherit type: "", types)
-        fields <- intersect(fields, all)
-      }
-    }
-
-    x$val <- list(
-      source = pieces[1],
-      fields = fields
-    )
-
-    x
-  }
-}
-
-#' @export
-#' @rdname roxy_tag
-tag_name <- function(x) {
-  if (x$val == """") {
-    roxy_tag_warning(""requires a name"")
-  } else if (!rdComplete(x$val)) {
-    roxy_tag_warning(""mismatched braces or quotes"")
-  } else if (str_count(x$val, ""\\s+"") > 1) {
-    roxy_tag_warning(""should have only a single argument"")
-  } else {
-    x$val <- str_trim(x$val)
-    x
-  }
-}
-
-#' @export
-#' @rdname roxy_tag
-#' @param first,second Name of first and second parts of two part tags
-#' @param required Is the second part required (TRUE) or can it be blank
-#'   (FALSE)?
-#' @param markdown Should the second part be parsed as markdown?
-tag_two_part <- function(first, second, required = TRUE, markdown = TRUE) {
-  force(required)
-  force(markdown)
-
-  function(x) {
-    if (str_trim(x$val) == """") {
-      roxy_tag_warning(x, ""requires a value"")
-    } else if (required && !str_detect(x$val, ""[[:space:]]+"")) {
-      roxy_tag_warning(x, ""requires "", first, "" and "", second)
-    } else if (!rdComplete(x$val)) {
-      roxy_tag_warning(x, ""mismatched braces or quotes"")
-    } else {
-      pieces <- str_split_fixed(str_trim(x$val), ""[[:space:]]+"", 2)
-
-      if (markdown) {
-        pieces[,2] <- markdown_if_active(pieces[,2], x)
-      }
-
-      x$val <- list(
-        pieces[, 1],
-        trim_docstring(pieces[,2])
-      )
-      names(x$val) <- c(first, second)
-      x
-    }
-  }
-}
-
-#' @export
-#' @rdname roxy_tag
-tag_name_description <- tag_two_part(""name"", ""description"")
-
-#' @export
-#' @rdname roxy_tag
-#' @param min,max Minimum and maximum number of words
-tag_words <- function(min = 0, max = Inf) {
-  function(x) {
-    if (!rdComplete(x$val)) {
-      return(roxy_tag_warning(x, ""mismatched braces or quotes""))
-    }
-
-    words <- str_split(str_trim(x$val), ""\\s+"")[[1]]
-    if (length(words) < min) {
-      roxy_tag_warning(x,  "" needs at least "", min, "" words"")
-    } else if (length(words) > max) {
-      roxy_tag_warning(x,  "" can have at most "", max, "" words"")
+      raw <- x$raw
     }
-
-    x$val <- words
-    x
-  }
-}
-
-#' @export
-#' @rdname roxy_tag
-tag_words_line <- function(x) {
-  x$val <- str_trim(x$val)
-
-  if (str_detect(x$val, ""\n"")) {
-    roxy_tag_warning(x, ""may only span a single line"")
-  } else if (!rdComplete(x$val)) {
-    roxy_tag_warning(x, ""mismatched braces or quotes"")
   } else {
-    x$val <- str_split(x$val, ""\\s+"")[[1]]
-    x
+    raw <- ""<generated by roxygen2>""
   }
-}
 
-#' @export
-#' @rdname roxy_tag
-tag_toggle <- function(x) {
-  x$val <- str_trim(x$val)
+  parsed <- if (is.null(x$val)) ""{unparsed}"" else ""{parsed}""
 
-  if (x$val != """") {
-    roxy_tag_warning(x, ""has no parameters"")
-  } else {
-    x
-  }
+  paste0(loc, "" @"", x$tag, "" '"", raw, ""' "", parsed)
 }
 
 #' @export
-#' @rdname roxy_tag
-tag_code <- function(x) {
-  if (x$val == """") {
-    roxy_tag_warning(x, ""requires a value"")
-  } else {
-    tryCatch({
-      parse(text = x$val)
-      x
-    }, error = function(e) {
-      roxy_tag_warning(x, ""code failed to parse.\n"", e$message)
-    })
-  }
+print.roxy_tag <- function(x, ...) {
+  cat_line(format(x, ...))
 }
 
-# Examples need special parsing because escaping rules are different
 #' @export
 #' @rdname roxy_tag
-tag_examples <- function(x) {
-  if (x$val == """") {
-    return(roxy_tag_warning(x, ""requires a value""))
-  }
+roxy_tag_warning <- function(x, ...) {
+  message <- paste0(
+    if (!is.na(x$file)) paste0(""["", x$file, "":"", x$line, ""] ""),
+    ""@"", x$tag, "" "",
+    ...,
+    collapse = "" ""
+  )
 
-  x$val <- escape_examples(gsub(""^\n"", """", x$val))
-  if (!rdComplete(x$val, TRUE)) {
-    roxy_tag_warning(x, ""mismatched braces or quotes"")
-  } else {
-    x
-  }
+  warning(message, call. = FALSE, immediate. = TRUE)
+  NULL
 }
 
-#' @export
-#' @rdname roxy_tag
-tag_markdown <- function(x) {
-  x$val <- markdown_if_active(x$val, x)
-  tag_value(x)
+roxy_tag_is_field <- function(tag) {
+  inherits(tag$val, ""roxy_field"")
 }
 
-#' @export
-#' @rdname roxy_tag
-tag_markdown_with_sections <- function(x) {
-  if (x$val == """") {
-    return(roxy_tag_warning(x, ""requires a value""))
-  }
+roxy_tag_eval <- function(tag, env) {
+  tryCatch({
+    expr <- parse(text = tag$val)
+    out <- eval(expr, envir = env)
 
-  x$val <- markdown_if_active(x$val, x, sections = TRUE)
-  for (i in seq_along(x$val)) {
-    if (!rdComplete(x$val[i])) {
-      roxy_tag_warning(x, ""mismatched braces or quotes"")
-      x$val[i] <- """"
+    if (!is.character(out)) {
+      roxy_tag_warning(tag, ""did not evaluate to a string"")
+    } else if (anyNA(out)) {
+      roxy_tag_warning(tag, ""result contained NA"")
     } else {
-      x$val[i] <- str_trim(x$val[i])
+      out
     }
-  }
-
-  x
+  }, error = function(e) {
+    roxy_tag_warning(tag, ""failed with error:\n"", e$message)
+  })
 }

---FILE: R/tokenize.R---
@@ -1,14 +1,15 @@
 # Returns list of roxy_blocks
 tokenize_file <- function(file,
                           registry = list(),
-                          global_options = list()
+                          global_options = list(),
+                          srcref_path = NULL
                           ) {
   lines <- read_lines(file)
 
   parsed <- parse(
     text = lines,
     keep.source = TRUE,
-    srcfile = srcfilecopy(file, lines, isFile = TRUE)
+    srcfile = srcfilecopy(srcref_path %||% file, lines, isFile = TRUE)
   )
   if (length(parsed) == 0)
     return(list())

---FILE: R/topic.R---
@@ -66,7 +66,6 @@ RoxyTopic <- R6::R6Class(""RoxyTopic"", public = list(
     if (is.null(field))
       return()
 
-    stopifnot(is_roxy_field(field))
     field_name <- field$field
     if (self$has_field(field_name) && !overwrite) {
       field <- merge(self$get_field(field_name), field)

---FILE: R/utils.R---
@@ -101,24 +101,6 @@ compact <- function(x) {
   x[!map_lgl(x, is.null)]
 }
 
-block_eval <- function(tag, block, env, tag_name) {
-  tryCatch({
-    expr <- parse(text = tag)
-    out <- eval(expr, envir = env)
-
-    if (!is.character(out)) {
-      block_warning(block, tag_name, "" did not evaluate to a string"")
-    } else if (anyNA(out)) {
-      block_warning(block, tag_name, "" result contained NA"")
-    } else {
-      out
-    }
-  }, error = function(e) {
-    block_warning(block, tag_name, "" failed with error:\n"", e$message)
-  })
-}
-
-
 # Parse DESCRIPTION into convenient format
 read.description <- function(file) {
   dcf <- desc::desc(file = file)
@@ -127,7 +109,6 @@ read.description <- function(file) {
   purrr::map(purrr::set_names(fields), ~ dcf$get_field(.x))
 }
 
-
 invert <- function(x) {
   if (length(x) == 0) return()
   stacked <- utils::stack(x)
@@ -154,7 +135,7 @@ collapse <- function(key, value, fun, ...) {
 }
 
 cat_line <- function(...) {
-  cat(..., ""\n"", sep = """")
+  cat(paste0(..., ""\n"", collapse = """"))
 }
 
 tag_aliases <- function(f) {

---FILE: man/parse_package.Rd---
@@ -19,7 +19,8 @@ parse_file(
   file,
   env = env_file(file),
   registry = default_tags(),
-  global_options = list()
+  global_options = list(),
+  srcref_path = NULL
 )
 
 parse_text(

---FILE: man/roc_proc_text.Rd---
@@ -4,12 +4,7 @@
 \alias{roc_proc_text}
 \title{Process roclet on string and capture results.}
 \usage{
-roc_proc_text(
-  roclet,
-  input,
-  registry = default_tags(),
-  global_options = list()
-)
+roc_proc_text(roclet, input, registry = NULL, global_options = list())
 }
 \arguments{
 \item{roclet}{Name of roclet to use for processing.}

---FILE: man/roclet.Rd---
@@ -2,25 +2,38 @@
 % Please edit documentation in R/roclet.R
 \name{roclet}
 \alias{roclet}
-\alias{roclet_output}
 \alias{roclet_tags}
 \alias{roclet_preprocess}
 \alias{roclet_process}
+\alias{roclet_output}
 \alias{roclet_clean}
 \title{Build a new roclet.}
 \usage{
 roclet(subclass, ...)
 
-roclet_output(x, results, base_path, ...)
-
 roclet_tags(x)
 
 roclet_preprocess(x, blocks, base_path, global_options = list())
 
 roclet_process(x, blocks, env, base_path, global_options = list())
 
+roclet_output(x, results, base_path, ...)
+
 roclet_clean(x, base_path)
 }
+\arguments{
+\item{x}{A \code{roclet} object.}
+
+\item{blocks}{A list of \link{roxy_block} objects.}
+
+\item{base_path}{Path to root of source package.}
+
+\item{global_options}{List of roxygen2 options.}
+
+\item{env}{Package environment.}
+
+\item{results}{Value returned from your \code{roclet_process()} method.}
+}
 \description{
 To create a new roclet, you will need to create a constructor function
 that wraps \code{roclet}, and then implement the methods described below.
@@ -29,7 +42,7 @@ that wraps \code{roclet}, and then implement the methods described below.
 
 \itemize{
 \item \code{roclet_tags()}: return named list, where names give recognised tags and
-values give tag parsing function. See \link{roxy_tag} for built-in options.
+values give tag parsing function. See \link{roxy_tag} for built-in parsers.
 \item \code{roclet_preprocess()} is called after blocks have been parsed but before
 code has been evaluated. This should only be needed if your roclet affects
 how code will evaluated. Should return a roclet.

---FILE: man/roxy_block.Rd---
@@ -0,0 +1,63 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/block.R
+\name{roxy_block}
+\alias{roxy_block}
+\alias{block_has_tags}
+\alias{block_get_tags}
+\alias{block_get_tag}
+\alias{block_get_tag_value}
+\title{Blocks}
+\usage{
+roxy_block(tags, file, line, call, object = NULL)
+
+block_has_tags(block, tags)
+
+block_get_tags(block, tags)
+
+block_get_tag(block, tag)
+
+block_get_tag_value(block, tag)
+}
+\arguments{
+\item{tags}{A list of \link{roxy_tag}s.}
+
+\item{file, line}{Location of the \code{call} (i.e. the line after the last
+line of the block).}
+
+\item{call}{Expression associated with block.}
+
+\item{object}{Optionally, the object associated with the block, found
+by inspecting/evaluating \code{call}.}
+
+\item{block}{A \code{roxy_block} to manipulate.}
+
+\item{tag, tags}{Either a single tag name, or a character vector of tag names.}
+}
+\description{
+A \code{roxy_block} represents a single roxygen2 block.
+
+The \verb{block_*} functions provide a few helpers for common operations:
+\itemize{
+\item \code{block_has_tag(blocks, tags)}: does \code{block} contain any of these \code{tags}?
+\item \code{block_get_tags(block, tags)}: get all instances of \code{tags}
+\item \code{block_get_tag(block, tag)}: get single tag. Returns \code{NULL} if 0,
+throws warning if more than 1.
+\item \code{block_get_tag_value(block, tag)}: gets \code{val} field from single tag.
+}
+}
+\examples{
+# The easiest way to see the structure of a roxy_block is to create one
+# using parse_text:
+text <- ""
+  #' This is a title
+  #'
+  #' @param x,y A number
+  #' @export
+  f <- function(x, y) x + y
+""
+
+# parse_text() returns a list of blocks, so I extract the first
+block <- parse_text(text)[[1]]
+block
+}
+\keyword{internal}

---FILE: man/roxy_tag.Rd---
@@ -3,75 +3,24 @@
 \name{roxy_tag}
 \alias{roxy_tag}
 \alias{roxy_tag_warning}
-\alias{tag_value}
-\alias{tag_inherit}
-\alias{tag_name}
-\alias{tag_two_part}
-\alias{tag_name_description}
-\alias{tag_words}
-\alias{tag_words_line}
-\alias{tag_toggle}
-\alias{tag_code}
-\alias{tag_examples}
-\alias{tag_markdown}
-\alias{tag_markdown_with_sections}
-\title{Parsing tags.}
+\title{\code{roxy_tag} S3 constructor}
 \usage{
-roxy_tag(tag, val, file = """", line = 0)
+roxy_tag(tag, raw, val = NULL, file = NA_character_, line = NA_integer_)
 
 roxy_tag_warning(x, ...)
-
-tag_value(x)
-
-tag_inherit(x)
-
-tag_name(x)
-
-tag_two_part(first, second, required = TRUE, markdown = TRUE)
-
-tag_name_description(x)
-
-tag_words(min = 0, max = Inf)
-
-tag_words_line(x)
-
-tag_toggle(x)
-
-tag_code(x)
-
-tag_examples(x)
-
-tag_markdown(x)
-
-tag_markdown_with_sections(x)
 }
 \arguments{
 \item{tag}{Tag name}
 
-\item{val}{Tag value. When read from the file, this will be a string,
-but after parsing can be a more complicated structure (typically
-a character vector, but sometimes a list).}
-
-\item{file, line}{Location of the tag}
+\item{raw}{Raw tag value, a string.}
 
-\item{first, second}{Name of first and second parts of two part tags}
+\item{val}{Parsed tag value, typically a character vector, but sometimes
+a list. Usually filled in by \code{tag_parsers}}
 
-\item{required}{Is the second part required (TRUE) or can it be blank
-(FALSE)?}
-
-\item{markdown}{Should the second part be parsed as markdown?}
-
-\item{min, max}{Minimum and maximum number of words}
+\item{file, line}{Location of the tag}
 }
 \description{
-\code{roxy_tag} constructs a tag object, and \code{roxy_tag_warning} makes
-an informative warning using the location information stored in the tag.
-The remainder of the tag functions parse the tag value, convert a string
-into a richer R object, or providing informative warnings and returning
-valid if the value is invalid.
-}
-\details{
-Two exceptions to the rule are \code{tag_words} and \code{tag_two_part}, which are
-tag parsing generator functions.
+\code{roxy_tag()} is the constructor for tag objects.
+\code{roxy_tag_warning()} generates a warning that gives the location of the tag.
 }
 \keyword{internal}

---FILE: man/tag_parsers.Rd---
@@ -0,0 +1,64 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/tag-parser.R
+\name{tag_parsers}
+\alias{tag_parsers}
+\alias{tag_value}
+\alias{tag_inherit}
+\alias{tag_name}
+\alias{tag_two_part}
+\alias{tag_name_description}
+\alias{tag_words}
+\alias{tag_words_line}
+\alias{tag_toggle}
+\alias{tag_code}
+\alias{tag_examples}
+\alias{tag_markdown}
+\alias{tag_markdown_with_sections}
+\title{Parse tags}
+\usage{
+tag_value(x)
+
+tag_inherit(x)
+
+tag_name(x)
+
+tag_two_part(first, second, required = TRUE, markdown = TRUE)
+
+tag_name_description(x)
+
+tag_words(min = 0, max = Inf)
+
+tag_words_line(x)
+
+tag_toggle(x)
+
+tag_code(x)
+
+tag_examples(x)
+
+tag_markdown(x)
+
+tag_markdown_with_sections(x)
+}
+\arguments{
+\item{x}{A \link{roxy_tag} object to parss}
+
+\item{first, second}{Name of first and second parts of two part tags}
+
+\item{required}{Is the second part required (TRUE) or can it be blank
+(FALSE)?}
+
+\item{markdown}{Should the second part be parsed as markdown?}
+
+\item{min, max}{Minimum and maximum number of words}
+}
+\value{
+A \link{roxy_tag} object with the \code{val} field set to the parsed value.
+}
+\description{
+These functions parse the \code{raw} tag value, convert a string into a richer R
+object and storing it in \code{val}, or provide an informative warning and
+returning \code{NULL}. Two exceptions to the rule are \code{tag_words()} and
+\code{tag_two_part()}, which are tag parsing generator functions.
+}
+\keyword{internal}

---FILE: src/parser2.cpp---
@@ -150,7 +150,8 @@ List tokenise_block(CharacterVector lines, std::string file = """",
       _[""line""] = rows[i] + 1,
       _[""tag""] = tags[i],
       // Rcpp::String() necessary to tag string as UTF-8
-      _[""val""] = Rcpp::String(stripTrailingNewline(vals[i]))
+      _[""raw""] = Rcpp::String(stripTrailingNewline(vals[i])),
+      _[""val""] = R_NilValue
     );
     out[i].attr(""class"") = ""roxy_tag"";
   }

---FILE: tests/testthat/test-block-print.txt---
@@ -0,0 +1,12 @@
+> block
+<roxy_block> [<text>:6]
+  $tag
+    [line:  1] @title 'This is a title' {parsed}
+    [line:  5] @param 'x,y A number' {parsed}
+    [line:  6] @export '' {parsed}
+    [????:???] @backref '<text>' {parsed}
+  $call   f <- function(x, y) x + y
+  $object <function> 
+    $topic f
+    $alias f
+

---FILE: tests/testthat/test-block.R---
@@ -1,3 +1,18 @@
+
+# object ------------------------------------------------------------------
+
+test_that(""has thoughtful print method"", {
+  text <- ""
+    #' This is a title
+    #'
+    #' @param x,y A number
+    #' @export
+    f <- function(x, y) x + y
+  ""
+  block <- parse_text(text)[[1]]
+  verify_output(test_path(""test-block-print.txt""), block)
+})
+
 # description block -------------------------------------------------------
 
 test_that(""title and description taken from first line if only one"", {
@@ -166,8 +181,8 @@ test_that(""description block preserves whitespace"", {
     ""
   )[[1]]
 
-  expect_equal(out$description, ""Line 1\n  Line 2"")
-  expect_equal(out$details, ""Line 1\n  Line 2"")
+  expect_equal(block_get_tag_value(out, ""description""), ""Line 1\n  Line 2"")
+  expect_equal(block_get_tag_value(out, ""details""), ""Line 1\n  Line 2"")
 })
 
 
@@ -190,7 +205,7 @@ test_that(""errors are propagated"", {
       #' @eval foo()
       NULL""
     ),
-    ""@eval failed with error""
+    ""failed with error""
   )
 })
 
@@ -201,7 +216,7 @@ test_that(""must return non-NA string"", {
       #' @eval foo()
       NULL""
     ),
-    ""@eval did not evaluate to a string""
+    ""did not evaluate to a string""
   )
 
   expect_warning(
@@ -210,11 +225,10 @@ test_that(""must return non-NA string"", {
       #' @eval foo()
       NULL""
     ),
-    ""@eval result contained NA""
+    ""result contained NA""
   )
 })
 
-
 test_that(""also works with namespace roclet"", {
   out <- roc_proc_text(namespace_roclet(), ""
     foo <- function() '@export a'

---FILE: tests/testthat/test-namespace.R---
@@ -112,9 +112,6 @@ test_that(""export uses name if no object present"", {
   expect_equal(out, 'export(x)')
 })
 
-
-
-
 test_that(""default export uses exportClass for RC objects"", {
   out <- roc_proc_text(namespace_roclet(), ""
     #' Title
@@ -245,7 +242,7 @@ test_that(""evalNamespace generates warning when code raises error"", {
       #' @name a
       #' @title a
       NULL""),
-    ""@evalNamespace failed with error""  # From block_eval
+    ""failed with error""  # From block_eval
   )
 })
 
@@ -258,7 +255,7 @@ test_that(""evalNamespace generates warning when code doesn't eval to string"", {
       #' @name a
       #' @title a
       NULL""),
-    ""@evalNamespace did not evaluate to a string""  # From block_eval
+    ""did not evaluate to a string""  # From block_eval
   )
 
   # NA_character_ not allowed
@@ -269,7 +266,7 @@ test_that(""evalNamespace generates warning when code doesn't eval to string"", {
       #' @name a
       #' @title a
       NULL""),
-    ""@evalNamespace result contained NA""  # From block_eval
+    ""result contained NA""  # From block_eval
   )
 })
 

---FILE: tests/testthat/test-object-s3.R---
@@ -58,5 +58,5 @@ test_that(""@method overrides auto-detection"", {
     all.equal.data.frame <- function(...) 1
   "")[[1]]
 
-  expect_equal(s3_method_info(attr(out, ""object"")$value), c(""all.equal"", ""data.frame""))
+  expect_equal(s3_method_info(out$object$value), c(""all.equal"", ""data.frame""))
 })

---FILE: tests/testthat/test-rd-examples.R---
@@ -62,7 +62,7 @@ test_that(""@example gives warning if used instead of @examples"", {
       #' a <- 1
       #' a + b
       NULL"")[[1]],
-    ""@example spans multiple lines""
+    ""spans multiple lines""
   )
 
   expect_null(get_tag(out, ""examples"")$values, NULL)

---FILE: tests/testthat/test-rd-inherit.R---
@@ -53,7 +53,7 @@ test_that(""no options gives default values"", {
   "")[[1]]
 
   expect_equal(
-    block$inherit$fields,
+    block_get_tag_value(block, ""inherit"")$fields,
     c(
       ""params"", ""return"", ""title"", ""description"", ""details"", ""seealso"",
       ""sections"", ""references"", ""examples"", ""author"", ""source""
@@ -67,7 +67,7 @@ test_that(""some options overrides defaults"", {
     NULL
   "")[[1]]
 
-  expect_equal(block$inherit$fields, ""return"")
+  expect_equal(block_get_tag_value(block, ""inherit"")$fields, ""return"")
 })
 
 

---FILE: tests/testthat/test-rd-param.R---
@@ -69,23 +69,6 @@ test_that(""argument order for multi-parameter documentation"", {
   expect_equal(get_tag(out[[""b.Rd""]], ""param"")$values, c(`x,z`=""X,Z"", y=""Y"", w=""W""))
 })
 
-test_that(""argument order for multiple usage statements"", {
-  out <- roc_proc_text(rd_roclet(), ""
-    #' A.
-    #'
-    #' @usage a(x, w)
-    #' @usage a(x, y)
-    #' @usage a(x, z)
-    #' @param x X
-    #' @param w W
-    #' @param y Y
-    #' @param z Z
-    a <- function(x, y, z, w) {}
-    "")
-
-  expect_equal(get_tag(out[[""a.Rd""]], ""param"")$values, c(x=""X"", y=""Y"", z=""Z"", w=""W""))
-})
-
 test_that(""argument order for @rdfile"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' A

---FILE: tests/testthat/test-rd-raw.R---
@@ -29,7 +29,7 @@ test_that(""error-ful evalRd generates warning"", {
       #' @name a
       #' @title a
       NULL""),
-    ""@evalRd failed with error""
+    ""failed with error""
   )
 })
 

---FILE: tests/testthat/test-tag.R---
@@ -68,8 +68,12 @@ test_that(""incomplete rd in tag raises error"", {
 })
 
 test_that(""incomplete rd in prequel raises error"", {
-  expect_warning(roc_proc_text(rd_roclet(), ""
-    #' Title {
-    x <- 1""), ""mismatched braces"")
+  expect_warning(
+    roc_proc_text(rd_roclet(), ""
+      #' Title {
+      x <- 1""
+    ),
+    ""mismatched braces""
+  )
 })
 

---FILE: tests/testthat/test-tokenize.R---
@@ -5,15 +5,15 @@ test_that(""parses into tag and value"", {
   expect_equal(length(x), 1)
 
   expect_equal(x[[1]]$tag, ""xyz"")
-  expect_equal(x[[1]]$val, ""abc"")
+  expect_equal(x[[1]]$raw, ""abc"")
 })
 
 test_that(""description block gets empty tag"", {
   x <- tokenise_block(""#' abc"")
   expect_equal(length(x), 1)
 
   expect_equal(x[[1]]$tag, """")
-  expect_equal(x[[1]]$val, ""abc"")
+  expect_equal(x[[1]]$raw, ""abc"")
 })
 
 test_that(""multi line tags collapsed into one"", {
@@ -22,7 +22,7 @@ test_that(""multi line tags collapsed into one"", {
     ""#'   def""
   ))
   expect_equal(length(x), 1)
-  expect_equal(x[[1]]$val, ""abc\n  def"")
+  expect_equal(x[[1]]$raw, ""abc\n  def"")
 })
 
 test_that(""description block gets empty tag when followed by tag"", {
@@ -33,10 +33,10 @@ test_that(""description block gets empty tag when followed by tag"", {
   expect_equal(length(x), 2)
 
   expect_equal(x[[1]]$tag, """")
-  expect_equal(x[[1]]$val, ""abc"")
+  expect_equal(x[[1]]$raw, ""abc"")
 
   expect_equal(x[[2]]$tag, ""xyz"")
-  expect_equal(x[[2]]$val, ""abc"")
+  expect_equal(x[[2]]$raw, ""abc"")
 })
 
 test_that(""leading whitespace is ignored"", {
@@ -53,7 +53,7 @@ test_that(""need one or more #"", {
 })
 
 test_that(""@@ becomes @"", {
-  expect_equal(tokenise_block(""#' @tag @@"")[[1]]$val, ""@"")
+  expect_equal(tokenise_block(""#' @tag @@"")[[1]]$raw, ""@"")
 })
 
 # Inline comments ---------------------------------------------------------
@@ -89,3 +89,4 @@ test_that(""Inline comments do not extend past the closing brace"", {
     }; #' @seealso somewhere"")[[1]]
   expect_null(get_tag(out, ""seealso""))
 })
+

---FILE: vignettes/extending.Rmd---
@@ -9,212 +9,92 @@ vignette: >
 
 ```{r, include = FALSE}
 knitr::opts_chunk$set(comment = ""#>"", collapse = TRUE)
-library(roxygen2)
 ```
 
 ## Basics
 
-Roxygen is extensible with user-defined roclets. 
-It means that you can take advantage of Roxygen's parser in various ways. 
-It is not a general tool for static analysis as only so-called 'blocks' are parsed, i.e. 
-comment blocks that has the `#'` line prefix. 
-On the other hand, the parser carries along information on the corresponding code 
-which then can be used.
-Thus, as we will demonstrate first, you can exploit the parser and use the information in blocks 
-and corresponding code. 
+Roxygen is extensible with user-defined __roclets__. 
+It means that you can take advantage of Roxygen's parser and extend it with your own `@tags`.
 
-Another option is to introduce custom tags similar to e.g. `@title`, `@param` etc. tags. 
-We will cover this in the end of this vignette.
+Note that's not currently possible to extend an existing roclet, so you need to create your own if you want to add new features. This restriction may be relaxed in the future.
 
-It is worth noting that it is not possible for a user to extend 
-included roclets (e.g. the `rd` roclet) to allow for new tags. 
-It is necessary to write a new roclet that can be used together with or instead of e.g. 
-the included `rd` roclet.
+```{r setup}
+library(roxygen2)
+```
 
-## Roclets
+## Key data structures
 
-Running a roclet consists of multiple parts as documented in `?roclet`. 
-Very briefly, a roclet can implement a number of functions (please refer to `?roclet` for details):
+Before we talk about creating your own roclets, we need to first discuss two important data structures that power roxygen: blocks and tags.
 
-* `roclet_tags()`: named list of tags whose values are tag parsing functions (optional to implement)
-* `roclet_preprocess()`: called after blocks have been parsed but before code has been evaluated (optional to implement)
-* `roclet_process()`: called after `@eval` tag has been processed (main functionality)
-* `roclet_output()`: produces files on disk based on the result from `roclet_process()` (output functionality)
+### Tags
 
-Depending on the roclet, there may be some work in managing files, ensuring that no existing files are over-written, deleted etc. That must be handled, too. 
-Be sure not to change or delete something that you did not create with the explicit 
-disclaimer that the content can be modified or deleted. 
-Roxy does this by the header (first line of the file) containing ""`Generated by roxygen2: do not edit by hand`"".
-
-A roclet will use a list of tag parsers to process the written documentation. 
-Internally, roxygen creates a `roxy_tag()` which is then passed on to the 
-tag parser specified.
+A tag (a list with S3 class `roxy_tag`) represents a single tag. 
+It contains:
 
-### Custom roclets
+* `tag`: the name of the tag.
 
-This example will list the functions with inconsistent parameter documentation, e.g. missing `@param`s or too many `@param`s. 
-This is caught when `R` is checking a package, but sometimes it is nice to catch is before that. 
-The check will be a lot more simplistic than the one from `R` check, but the idea is to illustrate Roxygen's functionality.
+* `raw`: the raw contents of the tag (i.e. everything from the end of 
+  this tag to the begining of the net).
+  
+* `val`: the parsed value, which we'll come back to shortly.
 
-Other examples of such functionality is to display 
-functions with most lines (to avoid too long functions), 
-functions with most parameters, 
-inconsistent parameter naming and so on.
+* `file` and `line`: the location of the tag in the package. Used
+  with `roxy_tag_warning()` to produce informative error messages.
 
-Let us focus on a block like this:
+You _can_ construct tag objects by hand with `roxy_tag()`:
 
 ```{r}
-txt1 <- ""
-#' Summing two numbers
-#'
-#' @param x A number
-#' @param y Another number
-f <- function(x, y) {
-  x + y
-}""
+roxy_tag(""name"", ""Hadley"")
+str(roxy_tag(""name"", ""Hadley""))
 ```
 
-The output from the `rd` roclet will be:
+However, you should rarely need to do so, because you'll typically have them given to you in a block object
 
-```{r}
-roc_proc_text(rd_roclet(), txt1)
-```
+## Blocks
 
-Say that we forgot to document the `y` parameter:
+A block (a list with S3 class `roxy_block`) represents a single roxygen block. It contains:
 
-```{r}
-txt2 <- ""
-#' Summing two numbers
-#'
-#' @param x A number
-f <- function(x, y) {
-  x + y
-}""
-```
+* `tags`: a list of `roxy_tags`.
+* `call`: the R code associated with the block (usually a function call).
+* `file` and `line`: the location of the R code.
+* `object`: the evaluated R object associated with the code.
 
-The output from the `rd` roclet will be:
+The easiest way to see the basic structure of a `roxy_block()` is to generate one by parsing a roxygen block:
 
 ```{r}
-roc_proc_text(rd_roclet(), txt2)
-```
-
-That is in principle fine. But we do not discover that `y` is missing a `@param` (until checking the package). 
-Thus, we make a roclet to help us catch this earlier. 
-The input argument `blocks` to `roclet_process()` is a list of blocks. 
-Below, we show the block from `txt2` to give you an idea of its structure:
-
-```
-List of 2
- $ title: chr ""Summing two numbers""
- $ param:List of 2
-  ..$ name       : chr ""x""
-  ..$ description: chr ""A number""
- - attr(*, ""filename"")= chr ""/tmp/RtmpZx52lH/file2498288d1e88""
- - attr(*, ""location"")= int [1:8] 5 1 7 1 1 1 5 7
- - attr(*, ""call"")= language f <- function(x, y) {     x + y ...
- - attr(*, ""class"")= chr ""roxy_block""
- - attr(*, ""object"")=List of 3
-  ..$ alias  : chr ""f""
-  ..$ value  :function (x, y)  
-  ..$ methods: NULL
-  ..- attr(*, ""class"")= chr [1:2] ""function"" ""object""
+text <- ""
+  #' This is a title
+  #'
+  #' @param x,y A number
+  #' @export
+  f <- function(x, y) x + y
+""
+
+# parse_text() returns a list of blocks, so I extract the first
+block <- parse_text(text)[[1]]
+block
 ```
 
-Now, we can implement the roclet:
-
-```{r}
-param_roclet <- function() {
-  roxygen2::roclet(""param"")
-}
-
-roclet_process.roclet_param <- function(x, blocks, env, base_path, global_options = list()) {
-  warns <- list()
-  
-  for (block in blocks) {
-    block_obj <- attr(block, ""object"")
-    
-    if (!is(block_obj, ""function"")) {
-      next
-    }
-    
-    fun_args <- formalArgs(block_obj$value)
-    block_params <- block[names(block) == ""param""]
-    block_params_names <- sort(unname(sapply(block_params, function(x) x$name), force = TRUE))
-  
-    if (!isTRUE(all.equal(fun_args, block_params_names))) {
-      func_name <- block_obj$alias
-      
-      missing_params <- setdiff(fun_args, block_params_names)
-      toomany_params <- setdiff(block_params_names, fun_args)
-      msg <- """"
-      if (length(missing_params) > 0) {
-        msg <- paste0(msg, ""\n    - Missing @param's: "", paste0(missing_params, collapse = "", ""))
-      }
-      if (length(toomany_params) > 0) {
-        msg <- paste0(msg, ""\n    + Too many @param's: "", paste0(toomany_params, collapse = "", ""))
-      }
-
-      warn <- paste0(""Function '"", func_name, ""' with title '"", block$title, ""': "", msg)
-      warns <- c(warns, warn)
-    }
-  }
-  
-  return(warns)
-}
-
-roc_proc_text(param_roclet(), txt2)
-```
+## Roclets
 
-Notice here that the roclet is only processed. 
-The output is not made. 
-To specify the output functionality you must implement a `roclet_output.roclet_param()` method.
-It would probably go something like:
+To create your own
 
-```{r}
-roclet_output.roclet_param <- function(x, results, base_path, ...) {
-  if (length(results) == 0L) {
-    return(invisible(NULL))
-  }
-  
-  cat(""Functions with @param inconsistency:\n"")
-  cat(paste0(""  * "", results, collapse = ""\n""), sep = """")
-  
-  return(invisible(NULL))
-}
-```
+Running a roclet consists of multiple parts as documented in `?roclet`. 
+Very briefly, a roclet can implement a number of functions (please refer to `?roclet` for details):
 
-We can now make complete examples of three different cases:
+* `roclet_tags()`: named list of tags whose values are tag parsing functions (optional to implement)
+* `roclet_preprocess()`: called after blocks have been parsed but before code has been evaluated (optional to implement)
+* `roclet_process()`: called after `@eval` tag has been processed (main functionality)
+* `roclet_output()`: produces files on disk based on the result from `roclet_process()` (output functionality)
 
-```{r}
-# All good:
-roclet_output(param_roclet(), roc_proc_text(param_roclet(), ""
-#' Summing two numbers
-#'
-#' @param x A number
-#' @param y Another number
-f <- function(x, y) {
-  x + y
-}""))
-# Missing documentation of 'y' parameter
-roclet_output(param_roclet(), roc_proc_text(param_roclet(), ""
-#' Summing two numbers
-#'
-#' @param x A number
-f <- function(x, y) {
-  x + y
-}""))
-# Additional documentation for 'z' parameter
-roclet_output(param_roclet(), roc_proc_text(param_roclet(), ""
-#' Summing two numbers
-#'
-#' @param x A number
-#' @param y Another number
-#' @param z A third parameter
-f <- function(x, y) {
-  x + y
-}""))
-```
+Depending on the roclet, there may be some work in managing files, ensuring that no existing files are over-written, deleted etc. That must be handled, too. 
+Be sure not to change or delete something that you did not create with the explicit 
+disclaimer that the content can be modified or deleted. 
+Roxy does this by the header (first line of the file) containing ""`Generated by roxygen2: do not edit by hand`"".
 
+A roclet will use a list of tag parsers to process the written documentation. 
+Internally, roxygen creates a `roxy_tag()` which is then passed on to the 
+tag parser specified.
 
 ### Custom tags
 
@@ -235,78 +115,51 @@ As an example:
 
 The idea is that all memos with the same headline are grouped together.
 
-```{r}
+```{r, eval = FALSE}
 memo_roclet <- function() {
   roxygen2::roclet(""memo"")
 }
 
 # Based on roxygen2:::tag_name_description
 tag_memo <- function(x) {
-  #print(x)
-  #print(str(x))
-  
-  # Check syntax
   stopifnot(grepl(""^\\[.*\\].*$"", x$val))
   
-  memo_parsed <- stringi::stri_match(str = x$val, regex = ""\\[(.*)\\](.*)"")
-  
-  header <- memo_parsed[1L, 2L]
-  msg <- memo_parsed[1L, 3L]
-  
-  x$val <- list(header = header, msg = msg)
-  
-  return(x)
+  parsed <- stringi::stri_match(str = x$val, regex = ""\\[(.*)\\](.*)"")[1, ]
+
+  x$val <- list(
+    header = parsed[[2]], 
+    message = parsed[[3]]
+  )
+  x
 }
 
 roclet_tags.roclet_memo <- function(x) {
   list(memo = tag_memo)
 }
 
 roclet_process.roclet_memo <- function(x, blocks, env, base_path, global_options = list()) {
-  memos <- list()
-  
-  print(str(blocks))
+  results <- list()
   
   for (block in blocks) {
-    block_memos <- block[names(block) == ""memo""]
-    print(str(block_memos))
-    
-    if (length(block_memos) == 0L) {
-      next
-    }
-    
-    for (m in block_memos) {
-      extra <- """"
-      
-      if (!is.null(attr(block, ""object"")) && 
-          !is.null(attr(block, ""object"")$alias) &&
-          !is.null(attr(block, ""filename""))) {
-        extra <- paste0("" @ '"", attr(block, ""object"")$alias, ""' ["", attr(block, ""filename""), ""]"")
-      }
-      
-      msg <- paste0(m$msg, extra)
-      memos[[m$header]] <- c(memos[[m$header]], msg)
+    tags <- block_get_tags(block, ""memo"")
+
+    for (tag in tags) {
+      msg <- paste0(""["", tag$file, "":"", tag$line, ""] "", tag$val$message)
+      results[[tag$val$header]] <- c(results[[tag$val$header]], msg)
     }
-    
   }
   
-  return(memos)
+  results
 }
 
 roclet_output.roclet_memo <- function(x, results, base_path, ...) {
-  if (length(results) == 0L) {
-    return(invisible(NULL))
+  for (header in names(results)) {
+    messages <- results[[header]]
+    cat(paste0(header, "": "", ""\n""))
+    cat(paste0("" * "", messages, ""\n"", collapse = """"))
   }
-  
-  cat(""Memos:\n"")
-  
-  for (i in seq_along(results)) {
-    cat(""  "", names(results)[i], "":\n"", sep = """")
-    cat(paste0(""    - "", results[[i]], collapse = ""\n""), sep = """")
-    cat(""\n"")
-  }
-  
-  return(invisible(NULL))
+
+  invisible(NULL)
 }
 
 results <- roc_proc_text(memo_roclet(), ""
@@ -320,7 +173,7 @@ f <- function(x, y) {
 g <- function(x, y) {
   # ...
 }
-"", registry = roclet_tags.roclet_memo())
+"")
 roclet_output(memo_roclet(), results)
 ```
 "
r-lib,roxygen2,357e0420b8c157361a6083ca44ba16df181d8b74,Hadley Wickham,h.wickham@gmail.com,2019-09-19T16:55:34Z,Hadley Wickham,h.wickham@gmail.com,2019-09-19T16:55:34Z,"Sort re-exported functions

Fixes #765",NEWS.md;R/object-import.R,False,True,True,False,4,1,5,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* Functions documented in `reexports` are now sorted alphabetically by
+  package (#765).
+
 * `@inheritParams` ignores leading dots when comparing argument names (#862).
 
 * roxygen2 now provides three strategies for loading your code:

---FILE: R/object-import.R---
@@ -28,7 +28,7 @@ merge.roxy_field_reexport <- function(x, y, ...) {
 format.roxy_field_reexport <- function(x, ...) {
   pkgs <- split(x$fun, x$pkg)
   pkg_links <- map2(names(pkgs), pkgs, function(pkg, funs) {
-    links <- paste0(""\\code{\\link["", pkg, ""]{"", escape(funs), ""}}"",
+    links <- paste0(""\\code{\\link["", pkg, ""]{"", escape(sort(funs)), ""}}"",
       collapse = "", "")
     paste0(""\\item{"", pkg, ""}{"", links, ""}"")
   })"
r-lib,roxygen2,3f03cd583ace4e9f0ade9dcd20c1ec0cc265abe5,Hadley Wickham,h.wickham@gmail.com,2019-09-19T16:10:36Z,Hadley Wickham,h.wickham@gmail.com,2019-09-19T16:10:36Z,"Ignore leading dots when comparing arg names

Fixes #862",NEWS.md;R/rd-inherit.R;tests/testthat/test-rd-inherit.R,False,True,True,False,61,4,65,"---FILE: NEWS.md---
@@ -1,5 +1,7 @@
 # roxygen2 (development version)
 
+* `@inheritParams` ignores leading dots when comparing argument names (#862).
+
 * roxygen2 now provides three strategies for loading your code:
 
     * `load_pkgload()` uses pkgload.

---FILE: R/rd-inherit.R---
@@ -47,14 +47,18 @@ inherit_params <- function(topic, topics) {
   for (inheritor in inheritors) {
     inherited <- find_params(inheritor, topics)
 
-    to_add <- intersect(missing, names(inherited))
-    if (length(to_add) == 0) {
+    matches <- map_chr(missing, match_param, names(inherited))
+    new_match <- !is.na(matches)
+
+    if (!any(new_match)) {
       # Can't warn here because @inherit inherits parameters
       next
     }
 
-    topic$add_simple_field(""param"", inherited[to_add])
-    missing <- setdiff(missing, to_add)
+    topic$add_simple_field(""param"",
+      setNames(inherited[matches[new_match]], missing[new_match])
+    )
+    missing <- missing[!new_match]
   }
 }
 
@@ -289,3 +293,26 @@ get_rd_from_help <- function(package, alias) {
 
   internal_f(""utils"", "".getHelpFile"")(help)
 }
+
+
+# helpers -----------------------------------------------------------------
+
+# Returns matching parameter name in haystack
+match_param <- function(needle, haystack) {
+  if (needle %in% haystack) {
+    return(needle)
+  }
+
+  if (substr(needle, 1, 1) == ""."") {
+    if (needle %in% paste0(""."", haystack)) {
+      return(substr(needle, 2, nchar(needle)))
+    }
+  } else {
+    if (paste0(""."", needle) %in% haystack) {
+      return(paste0(""."", needle))
+    }
+  }
+
+  NA
+}
+

---FILE: tests/testthat/test-rd-inherit.R---
@@ -272,6 +272,34 @@ test_that(""multiple @inheritParam tags gathers all params"", {
   expect_equal(params[[""y""]], ""Y"")
 })
 
+test_that(""multiple @inheritParam tags gathers all params"", {
+  out <- roc_proc_text(rd_roclet(), ""
+    #' A.
+    #'
+    #' @param x X
+    a <- function(x) {}
+
+
+    #' B
+    #'
+    #' @param .y Y
+    b <- function(.y) {}
+
+    #' C
+    #'
+    #' @inheritParams a
+    #' @inheritParams b
+    c <- function(.x, y) {}
+    "")
+
+  params <- get_tag(out[[""c.Rd""]], ""param"")$values
+  expect_equal(length(params), 2)
+
+  expect_equal(params[["".x""]], ""X"")
+  expect_equal(params[[""y""]], ""Y"")
+})
+
+
 test_that(""@inheritParams can inherit from inherited params"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' C"
r-lib,roxygen2,81b27fc2a6d845e9de86eaf71a74e3ec11975ef4,Hadley Wickham,h.wickham@gmail.com,2019-09-19T15:22:06Z,GitHub,noreply@github.com,2019-09-19T15:22:06Z,"Expose three code loading strategies (#914)

Fixes #822",DESCRIPTION;NAMESPACE;NEWS.md;R/load.R;R/options.R;R/parse.R;R/roxygenize.R;man/load.Rd;man/roxygenize.Rd;tests/testthat/test-load.R,False,True,True,False,217,35,252,"---FILE: DESCRIPTION---
@@ -1,6 +1,6 @@
 Package: roxygen2
 Title: In-Line Documentation for R
-Version: 6.1.99.9000
+Version: 6.1.99.9001
 Authors@R: 
     c(person(given = ""Hadley"",
              family = ""Wickham"",
@@ -58,5 +58,5 @@ LinkingTo:
 VignetteBuilder: 
     knitr
 Encoding: UTF-8
-Roxygen: list(markdown = TRUE)
-RoxygenNote: 6.1.99.9000
+Roxygen: list(markdown = TRUE, load = ""installed"")
+RoxygenNote: 6.1.99.9001

---FILE: NAMESPACE---
@@ -79,7 +79,10 @@ export(env_file)
 export(env_package)
 export(is_s3_generic)
 export(is_s3_method)
+export(load_installed)
 export(load_options)
+export(load_pkgload)
+export(load_source)
 export(namespace_roclet)
 export(object)
 export(object_format)

---FILE: NEWS.md---
@@ -1,5 +1,18 @@
 # roxygen2 (development version)
 
+* roxygen2 now provides three strategies for loading your code:
+
+    * `load_pkgload()` uses pkgload.
+    * `load_installed()` assumes you have installed the package.
+    * `load_source()` attaches required packages and `source()`s code in `R/`.
+    
+    If the code loading strategy in roxygen2 6.1.0 and above has caused 
+    you grief, you can revert to the old strategy by using 
+    `Roxygen: list(load = ""source"")` (#822).
+    
+    Compared to the previous release, the default pkgload strategy now will 
+    recompile `src/` if needed.
+
 * New `@order n` tag controls the order in which blocks are processed. You can
   use it to override the usual ordering which proceeds in from the top of 
   each file to the bottom. `@order 1` will be processed before `@order 2`, 

---FILE: R/load.R---
@@ -0,0 +1,99 @@
+#' Load package code
+#'
+#' @description
+#' roxygen2 is a dynamic documentation system, which means it works with the
+#' objects inside your package, not just the source code used to create them.
+#' These functions offer various ways of loading your package to suit various
+#' constraints:
+#'
+#' * `load_pkgload()` uses `pkgload::load_all()` to simulate package loading
+#'   as closely as we know how. It offers high fidelity handling of code that
+#'   uses S4, but requires that the package be compiled.
+#'
+#' * `load_source()` simulates package loading by attaching packages listed in
+#'   `Depends` and `Imports`, then sources all files in the `R/` directory.
+#'   This was the default strategy used in roxygen2 6.0.0 and earlier;
+#'   it's primary advantage is that it does not need compilation.
+#'
+#' * `load_installed()` uses the installed version of the package. Use this
+#'   strategy if you have installed a development version of the package
+#'   already. This is the highest fidelity strategy, but requires work
+#'   outside of roxygen2.
+#'
+#' You can change the default strategy for your function with roxygen2 `load`
+#' option. Override the default off `pkgload` to use the `source` or
+#' `installed` strategies:
+#'
+#' ```
+#' RoxygenNote: list(load = ""source"")
+#' ```
+#' @name load
+#' @param path Path to source package
+NULL
+
+#' @rdname load
+#' @export
+load_pkgload <- function(path) {
+  pkgload::load_all(path, helpers = FALSE, attach_testthat = FALSE)$env
+}
+
+#' @rdname load
+#' @export
+load_installed <- function(path) {
+  package <- desc::desc_get_field(""Package"", file = path)
+  asNamespace(package)
+}
+
+#' @rdname load
+#' @export
+load_source <- function(path) {
+  # Create environment
+  env <- new.env(parent = globalenv())
+  methods::setPackageName(""roxygen_devtest"", env)
+
+  # Attach dependencies
+  deps <- desc::desc_get_deps(path)
+  pkgs <- deps$package[
+    deps$type %in% c(""Depends"", ""Imports"") & deps$package != ""R""
+  ]
+  lapply(pkgs, require, character.only = TRUE)
+
+  # Source files
+  lapply(package_files(path), sys_source, envir = env)
+
+  env
+}
+
+sys_source <- function(file, envir = baseenv()) {
+  exprs <- parse(text = read_lines(file))
+  for (expr in exprs) {
+    eval(expr, envir = envir)
+  }
+  invisible()
+}
+
+# Helpers -----------------------------------------------------------------
+
+find_load_strategy <- function(x, options) {
+  if (is.function(x)) {
+    return(x)
+  }
+
+  if (is.null(x)) {
+    x <- options$load
+    if (!is.character(x) || length(x) != 1) {
+      abort(""roxygen2 `load` option must be a string"")
+    }
+  } else {
+    if (!is.character(x) || length(x) != 1) {
+      abort(""`load_code` must be a string or function"")
+    }
+  }
+
+  switch(x,
+    pkgload = load_pkgload,
+    source = load_source,
+    installed = load_installed,
+    abort(""Unknown value of `load` option"")
+  )
+}

---FILE: R/options.R---
@@ -18,7 +18,8 @@ load_options <- function(base_path = ""."") {
     wrap = FALSE,
     roclets = c(""collate"", ""namespace"", ""rd""),
     markdown = markdown_global_default,
-    old_usage = FALSE
+    old_usage = FALSE,
+    load = ""pkgload""
   )
 
   unknown_opts <- setdiff(names(opts), names(defaults))

---FILE: R/parse.R---
@@ -109,14 +109,9 @@ env_file <- function(file) {
 #' @export
 #' @rdname parse_package
 env_package <- function(path) {
-  pkgload::load_all(path,
-    compile = FALSE,
-    helpers = FALSE,
-    attach_testthat = FALSE
-  )$env
+  load_pkgload(path)
 }
 
-
 # helpers -----------------------------------------------------------------
 
 order_blocks <- function(blocks) {

---FILE: R/roxygenize.R---
@@ -8,25 +8,26 @@
 #'
 #' Note that roxygen2 is a dynamic documentation system: it works by
 #' inspecting loaded objects in the package. This means that you must
-#' be able to load the package in order to document it.
+#' be able to load the package in order to document it: see [load] for
+#' details.
 #'
 #' @param package.dir Location of package top level directory. Default is
 #'   working directory.
 #' @param roclets Character vector of roclet names to use with package.
-#'   This defaults to `NULL`, which will use the `roclets` fields in
-#'   the list provided in the `Roxygen` DESCRIPTION field. If none are
-#'   specified, defaults to `c(""collate"", ""namespace"", ""rd"")`.
+#'   The default, `NULL`, uses the roxygen `roclets` option,
+#'   which defaults to `c(""collate"", ""namespace"", ""rd"")`.
 #' @param load_code A function used to load all the R code in the package
-#'   directory. It is called with the path to the package, and it should return
-#'   an environment containing all the sourced code.
+#'   directory. The default, `NULL`, uses the strategy defined by
+#'   the `load` roxygen option, which defaults to [load_pkgload()].
+#'   See [load] for more details.
 #' @param clean If `TRUE`, roxygen will delete all files previously
 #'   created by roxygen before running each roclet.
 #' @return `NULL`
 #' @export
 #' @importFrom stats setNames
 roxygenize <- function(package.dir = ""."",
                        roclets = NULL,
-                       load_code = env_package,
+                       load_code = NULL,
                        clean = FALSE) {
 
   base_path <- normalizePath(package.dir)
@@ -72,6 +73,7 @@ roxygenize <- function(package.dir = ""."",
   )
 
   # Now load code
+  load_code <- find_load_strategy(load_code, options)
   env <- load_code(base_path)
   blocks <- lapply(blocks, block_set_env,
     env = env,

---FILE: man/load.Rd---
@@ -0,0 +1,42 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/load.R
+\name{load}
+\alias{load}
+\alias{load_pkgload}
+\alias{load_installed}
+\alias{load_source}
+\title{Load package code}
+\usage{
+load_pkgload(path)
+
+load_installed(path)
+
+load_source(path)
+}
+\arguments{
+\item{path}{Path to source package}
+}
+\description{
+roxygen2 is a dynamic documentation system, which means it works with the
+objects inside your package, not just the source code used to create them.
+These functions offer various ways of loading your package to suit various
+constraints:
+\itemize{
+\item \code{load_pkgload()} uses \code{pkgload::load_all()} to simulate package loading
+as closely as we know how. It offers high fidelity handling of code that
+uses S4, but requires that the package be compiled.
+\item \code{load_source()} simulates package loading by attaching packages listed in
+\code{Depends} and \code{Imports}, then sources all files in the \verb{R/} directory.
+This was the default strategy used in roxygen2 6.0.0 and earlier;
+it's primary advantage is that it does not need compilation.
+\item \code{load_installed()} uses the installed version of the package. Use this
+strategy if you have installed a development version of the package
+already. This is the highest fidelity strategy, but requires work
+outside of roxygen2.
+}
+
+You can change the default strategy for your function with roxygen2 \code{load}
+option. Override the default off \code{pkgload} to use the \code{source} or
+\code{installed} strategies:\preformatted{RoxygenNote: list(load = ""source"")
+}
+}

---FILE: man/roxygenize.Rd---
@@ -5,32 +5,22 @@
 \alias{roxygenise}
 \title{Process a package with the Rd, namespace and collate roclets.}
 \usage{
-roxygenize(
-  package.dir = ""."",
-  roclets = NULL,
-  load_code = env_package,
-  clean = FALSE
-)
+roxygenize(package.dir = ""."", roclets = NULL, load_code = NULL, clean = FALSE)
 
-roxygenise(
-  package.dir = ""."",
-  roclets = NULL,
-  load_code = env_package,
-  clean = FALSE
-)
+roxygenise(package.dir = ""."", roclets = NULL, load_code = NULL, clean = FALSE)
 }
 \arguments{
 \item{package.dir}{Location of package top level directory. Default is
 working directory.}
 
 \item{roclets}{Character vector of roclet names to use with package.
-This defaults to \code{NULL}, which will use the \code{roclets} fields in
-the list provided in the \code{Roxygen} DESCRIPTION field. If none are
-specified, defaults to \code{c(""collate"", ""namespace"", ""rd"")}.}
+The default, \code{NULL}, uses the roxygen \code{roclets} option,
+which defaults to \code{c(""collate"", ""namespace"", ""rd"")}.}
 
 \item{load_code}{A function used to load all the R code in the package
-directory. It is called with the path to the package, and it should return
-an environment containing all the sourced code.}
+directory. The default, \code{NULL}, uses the strategy defined by
+the \code{load} roxygen option, which defaults to \code{\link[=load_pkgload]{load_pkgload()}}.
+See \link{load} for more details.}
 
 \item{clean}{If \code{TRUE}, roxygen will delete all files previously
 created by roxygen before running each roclet.}
@@ -48,5 +38,6 @@ for more details.
 \details{
 Note that roxygen2 is a dynamic documentation system: it works by
 inspecting loaded objects in the package. This means that you must
-be able to load the package in order to document it.
+be able to load the package in order to document it: see \link{load} for
+details.
 }

---FILE: tests/testthat/test-load.R---
@@ -0,0 +1,36 @@
+test_that(""load_installed retrieves installed package"", {
+  env <- load_installed(test_path(""../..""))
+  expect_identical(env, asNamespace(""roxygen2""))
+})
+
+test_that(""can load simple package with load_pkgload()"", {
+  env <- load_pkgload(test_path(""testRbuildignore""))
+  expect_equal(env_get(env, ""a""), 1)
+})
+
+test_that(""can load simple package with load_source()"", {
+  env <- load_source(test_path(""testRbuildignore""))
+  expect_equal(env_get(env, ""a""), 1)
+})
+
+# find_load_strategy ------------------------------------------------------
+
+test_that(""function returned as is"", {
+  expect_equal(find_load_strategy(load_installed), load_installed)
+})
+
+test_that(""look up string"", {
+  expect_equal(find_load_strategy(""installed""), load_installed)
+  expect_equal(find_load_strategy(""pkgload""), load_pkgload)
+  expect_equal(find_load_strategy(""source""), load_source)
+  expect_error(find_load_strategy(""blahblahb""), ""Unknown value"")
+})
+
+test_that(""NULL uses option"", {
+  expect_equal(find_load_strategy(NULL, list(load = ""installed"")), load_installed)
+})
+
+test_that(""informative errors for bad inputs"", {
+  expect_error(find_load_strategy(1), ""string or function"")
+  expect_error(find_load_strategy(NULL, list()), ""string"")
+})"
r-lib,roxygen2,735f6455fe1b1f8570fd36c99fedf3bd9a0f7655,Mikkel Meyer Andersen,mikldk@users.noreply.github.com,2019-09-18T12:41:55Z,Hadley Wickham,h.wickham@gmail.com,2019-09-18T12:41:55Z,"Start on extension vignette (#913)

Fixes #882",vignettes/extending.Rmd,True,False,True,False,327,0,327,"---FILE: vignettes/extending.Rmd---
@@ -0,0 +1,327 @@
+---
+title: ""Extending roxygen2""
+output: rmarkdown::html_vignette
+vignette: >
+  %\VignetteIndexEntry{Extending roxygen2}
+  %\VignetteEngine{knitr::rmarkdown}
+  %\VignetteEncoding{UTF-8}
+---
+
+```{r, include = FALSE}
+knitr::opts_chunk$set(comment = ""#>"", collapse = TRUE)
+library(roxygen2)
+```
+
+## Basics
+
+Roxygen is extensible with user-defined roclets. 
+It means that you can take advantage of Roxygen's parser in various ways. 
+It is not a general tool for static analysis as only so-called 'blocks' are parsed, i.e. 
+comment blocks that has the `#'` line prefix. 
+On the other hand, the parser carries along information on the corresponding code 
+which then can be used.
+Thus, as we will demonstrate first, you can exploit the parser and use the information in blocks 
+and corresponding code. 
+
+Another option is to introduce custom tags similar to e.g. `@title`, `@param` etc. tags. 
+We will cover this in the end of this vignette.
+
+It is worth noting that it is not possible for a user to extend 
+included roclets (e.g. the `rd` roclet) to allow for new tags. 
+It is necessary to write a new roclet that can be used together with or instead of e.g. 
+the included `rd` roclet.
+
+## Roclets
+
+Running a roclet consists of multiple parts as documented in `?roclet`. 
+Very briefly, a roclet can implement a number of functions (please refer to `?roclet` for details):
+
+* `roclet_tags()`: named list of tags whose values are tag parsing functions (optional to implement)
+* `roclet_preprocess()`: called after blocks have been parsed but before code has been evaluated (optional to implement)
+* `roclet_process()`: called after `@eval` tag has been processed (main functionality)
+* `roclet_output()`: produces files on disk based on the result from `roclet_process()` (output functionality)
+
+Depending on the roclet, there may be some work in managing files, ensuring that no existing files are over-written, deleted etc. That must be handled, too. 
+Be sure not to change or delete something that you did not create with the explicit 
+disclaimer that the content can be modified or deleted. 
+Roxy does this by the header (first line of the file) containing ""`Generated by roxygen2: do not edit by hand`"".
+
+A roclet will use a list of tag parsers to process the written documentation. 
+Internally, roxygen creates a `roxy_tag()` which is then passed on to the 
+tag parser specified.
+
+### Custom roclets
+
+This example will list the functions with inconsistent parameter documentation, e.g. missing `@param`s or too many `@param`s. 
+This is caught when `R` is checking a package, but sometimes it is nice to catch is before that. 
+The check will be a lot more simplistic than the one from `R` check, but the idea is to illustrate Roxygen's functionality.
+
+Other examples of such functionality is to display 
+functions with most lines (to avoid too long functions), 
+functions with most parameters, 
+inconsistent parameter naming and so on.
+
+Let us focus on a block like this:
+
+```{r}
+txt1 <- ""
+#' Summing two numbers
+#'
+#' @param x A number
+#' @param y Another number
+f <- function(x, y) {
+  x + y
+}""
+```
+
+The output from the `rd` roclet will be:
+
+```{r}
+roc_proc_text(rd_roclet(), txt1)
+```
+
+Say that we forgot to document the `y` parameter:
+
+```{r}
+txt2 <- ""
+#' Summing two numbers
+#'
+#' @param x A number
+f <- function(x, y) {
+  x + y
+}""
+```
+
+The output from the `rd` roclet will be:
+
+```{r}
+roc_proc_text(rd_roclet(), txt2)
+```
+
+That is in principle fine. But we do not discover that `y` is missing a `@param` (until checking the package). 
+Thus, we make a roclet to help us catch this earlier. 
+The input argument `blocks` to `roclet_process()` is a list of blocks. 
+Below, we show the block from `txt2` to give you an idea of its structure:
+
+```
+List of 2
+ $ title: chr ""Summing two numbers""
+ $ param:List of 2
+  ..$ name       : chr ""x""
+  ..$ description: chr ""A number""
+ - attr(*, ""filename"")= chr ""/tmp/RtmpZx52lH/file2498288d1e88""
+ - attr(*, ""location"")= int [1:8] 5 1 7 1 1 1 5 7
+ - attr(*, ""call"")= language f <- function(x, y) {     x + y ...
+ - attr(*, ""class"")= chr ""roxy_block""
+ - attr(*, ""object"")=List of 3
+  ..$ alias  : chr ""f""
+  ..$ value  :function (x, y)  
+  ..$ methods: NULL
+  ..- attr(*, ""class"")= chr [1:2] ""function"" ""object""
+```
+
+Now, we can implement the roclet:
+
+```{r}
+param_roclet <- function() {
+  roxygen2::roclet(""param"")
+}
+
+roclet_process.roclet_param <- function(x, blocks, env, base_path, global_options = list()) {
+  warns <- list()
+  
+  for (block in blocks) {
+    block_obj <- attr(block, ""object"")
+    
+    if (!is(block_obj, ""function"")) {
+      next
+    }
+    
+    fun_args <- formalArgs(block_obj$value)
+    block_params <- block[names(block) == ""param""]
+    block_params_names <- sort(unname(sapply(block_params, function(x) x$name), force = TRUE))
+  
+    if (!isTRUE(all.equal(fun_args, block_params_names))) {
+      func_name <- block_obj$alias
+      
+      missing_params <- setdiff(fun_args, block_params_names)
+      toomany_params <- setdiff(block_params_names, fun_args)
+      msg <- """"
+      if (length(missing_params) > 0) {
+        msg <- paste0(msg, ""\n    - Missing @param's: "", paste0(missing_params, collapse = "", ""))
+      }
+      if (length(toomany_params) > 0) {
+        msg <- paste0(msg, ""\n    + Too many @param's: "", paste0(toomany_params, collapse = "", ""))
+      }
+
+      warn <- paste0(""Function '"", func_name, ""' with title '"", block$title, ""': "", msg)
+      warns <- c(warns, warn)
+    }
+  }
+  
+  return(warns)
+}
+
+roc_proc_text(param_roclet(), txt2)
+```
+
+Notice here that the roclet is only processed. 
+The output is not made. 
+To specify the output functionality you must implement a `roclet_output.roclet_param()` method.
+It would probably go something like:
+
+```{r}
+roclet_output.roclet_param <- function(x, results, base_path, ...) {
+  if (length(results) == 0L) {
+    return(invisible(NULL))
+  }
+  
+  cat(""Functions with @param inconsistency:\n"")
+  cat(paste0(""  * "", results, collapse = ""\n""), sep = """")
+  
+  return(invisible(NULL))
+}
+```
+
+We can now make complete examples of three different cases:
+
+```{r}
+# All good:
+roclet_output(param_roclet(), roc_proc_text(param_roclet(), ""
+#' Summing two numbers
+#'
+#' @param x A number
+#' @param y Another number
+f <- function(x, y) {
+  x + y
+}""))
+# Missing documentation of 'y' parameter
+roclet_output(param_roclet(), roc_proc_text(param_roclet(), ""
+#' Summing two numbers
+#'
+#' @param x A number
+f <- function(x, y) {
+  x + y
+}""))
+# Additional documentation for 'z' parameter
+roclet_output(param_roclet(), roc_proc_text(param_roclet(), ""
+#' Summing two numbers
+#'
+#' @param x A number
+#' @param y Another number
+#' @param z A third parameter
+f <- function(x, y) {
+  x + y
+}""))
+```
+
+
+### Custom tags
+
+In this example we will make a new `@memo` tag to enable printing the memos at the console when the roclet runs.
+As you will see, testing a complete workflow of a roclet can be a bit cumbersome. 
+
+We choose that the `@memo` has this syntax:
+
+```
+@memo [Headline] Description
+```
+
+As an example:
+
+```
+@memo [EFFICIENCY] Currently brute-force; find better algorithm.
+```
+
+The idea is that all memos with the same headline are grouped together.
+
+```{r}
+memo_roclet <- function() {
+  roxygen2::roclet(""memo"")
+}
+
+# Based on roxygen2:::tag_name_description
+tag_memo <- function(x) {
+  #print(x)
+  #print(str(x))
+  
+  # Check syntax
+  stopifnot(grepl(""^\\[.*\\].*$"", x$val))
+  
+  memo_parsed <- stringi::stri_match(str = x$val, regex = ""\\[(.*)\\](.*)"")
+  
+  header <- memo_parsed[1L, 2L]
+  msg <- memo_parsed[1L, 3L]
+  
+  x$val <- list(header = header, msg = msg)
+  
+  return(x)
+}
+
+roclet_tags.roclet_memo <- function(x) {
+  list(memo = tag_memo)
+}
+
+roclet_process.roclet_memo <- function(x, blocks, env, base_path, global_options = list()) {
+  memos <- list()
+  
+  print(str(blocks))
+  
+  for (block in blocks) {
+    block_memos <- block[names(block) == ""memo""]
+    print(str(block_memos))
+    
+    if (length(block_memos) == 0L) {
+      next
+    }
+    
+    for (m in block_memos) {
+      extra <- """"
+      
+      if (!is.null(attr(block, ""object"")) && 
+          !is.null(attr(block, ""object"")$alias) &&
+          !is.null(attr(block, ""filename""))) {
+        extra <- paste0("" @ '"", attr(block, ""object"")$alias, ""' ["", attr(block, ""filename""), ""]"")
+      }
+      
+      msg <- paste0(m$msg, extra)
+      memos[[m$header]] <- c(memos[[m$header]], msg)
+    }
+    
+  }
+  
+  return(memos)
+}
+
+roclet_output.roclet_memo <- function(x, results, base_path, ...) {
+  if (length(results) == 0L) {
+    return(invisible(NULL))
+  }
+  
+  cat(""Memos:\n"")
+  
+  for (i in seq_along(results)) {
+    cat(""  "", names(results)[i], "":\n"", sep = """")
+    cat(paste0(""    - "", results[[i]], collapse = ""\n""), sep = """")
+    cat(""\n"")
+  }
+  
+  return(invisible(NULL))
+}
+
+results <- roc_proc_text(memo_roclet(), ""
+#' @memo [TBI] Remember to implement this!
+#' @memo [API] Check best API
+f <- function(x, y) {
+  # ...
+}
+
+#' @memo [API] Consider passing z option
+g <- function(x, y) {
+  # ...
+}
+"", registry = roclet_tags.roclet_memo())
+roclet_output(memo_roclet(), results)
+```
+
+"
r-lib,roxygen2,718af1191966460d66ed58082804271df8037c27,Hadley Wickham,h.wickham@gmail.com,2019-09-17T22:34:04Z,Hadley Wickham,h.wickham@gmail.com,2019-09-17T22:34:04Z,"New `@order` tag to override default ordering

Fixes #863",NEWS.md;R/block.R;R/parse.R;tests/testthat/test-parse.R;vignettes/rd.Rmd,True,True,True,False,65,1,66,"---FILE: NEWS.md---
@@ -1,5 +1,10 @@
 # roxygen2 (development version)
 
+* New `@order n` tag controls the order in which blocks are processed. You can
+  use it to override the usual ordering which proceeds in from the top of 
+  each file to the bottom. `@order 1` will be processed before `@order 2`, 
+  and before any blocks that don't have an explicit order set (#863).
+
 * `@example` and `@examples` are interwoven in the order in which they
   appear (#868).
 

---FILE: R/block.R---
@@ -171,6 +171,8 @@ parse_tag <- function(x, registry) {
     tag_code(x)
   } else if (identical(x$tag, ""include"")) {
     tag_value(x)
+  } else if (identical(x$tag, ""order"")) {
+    tag_value(x)
   } else if (x$tag %in% ls(registry)) {
     registry[[x$tag]](x)
   } else {

---FILE: R/parse.R---
@@ -47,6 +47,7 @@ parse_package <- function(path = ""."",
     )
   }
 
+  blocks <- order_blocks(blocks)
   blocks
 }
 
@@ -70,6 +71,7 @@ parse_file <- function(file,
     )
   }
 
+  blocks <- order_blocks(blocks)
   blocks
 }
 
@@ -84,12 +86,14 @@ parse_text <- function(text,
   write_lines(text, file)
   on.exit(unlink(file))
 
-  parse_file(
+  blocks <- parse_file(
     file,
     env = env,
     registry = registry,
     global_options = global_options
   )
+  blocks <- order_blocks(blocks)
+  blocks
 }
 
 #' @export
@@ -111,3 +115,23 @@ env_package <- function(path) {
     attach_testthat = FALSE
   )$env
 }
+
+
+# helpers -----------------------------------------------------------------
+
+order_blocks <- function(blocks) {
+  block_order <- function(x) {
+    if (!""order"" %in% names(x)) {
+      Inf
+    } else {
+      ord <- x[names(x) == ""order""]
+      if (length(ord) > 1) {
+        ord <- ord[[length(ord)]]
+      }
+      as.double(ord)
+    }
+  }
+
+  ord <- vapply(blocks, block_order, double(1))
+  blocks[order(ord)]
+}

---FILE: tests/testthat/test-parse.R---
@@ -0,0 +1,19 @@
+test_that(""can control processing order with @order"", {
+  out <- roc_proc_text(rd_roclet(), ""
+    #' @rdname bar
+    #' @details 2
+    #' @order 2
+    foo <- function() {}
+
+    #' @rdname bar
+    #' @details 1
+    #' @order 1
+    bar <- function() {}
+
+    #' @title Title
+    #' @name bar
+    NULL
+  "")[[1]]
+
+  expect_equal(get_tag(out, ""details"")$values, c(""1"", ""2""))
+})

---FILE: vignettes/rd.Rmd---
@@ -402,6 +402,20 @@ add <- function(x, y) x + y
 times <- function(x, y) x * y
 ```
 
+### Order of includes
+
+By default, roxygen blocks are processed in the order in which they appear in the file. When you're combining multiple files, this can sometimes cause the function usage to appear in a suboptimal order. You can override the default ordering with `@order`. For example, the following the block would place `times` first in `arith.Rd` because 1 comes before 2.
+
+```{r}
+#' @rdname arith
+#' @order 2
+add <- function(x, y) x + y
+
+#' @rdname arith
+#' @order 1
+times <- function(x, y) x * y
+```
+
 ### Evaluating arbitrary code
 
 A new and powerful technique is the `@eval` tag. It evaluates code and treatments the result as if it was a literal roxygen tags. This makes it possible to eliminate duplication by writing functions. The code will be evaluated in the package environment and should yield a character vector of roxygen comments (but without the leading `#'`)."
r-lib,roxygen2,69ef7f082d557fb8ab30d5009ed5d16e8ff3fa42,Hadley Wickham,h.wickham@gmail.com,2019-09-17T21:44:56Z,Hadley Wickham,h.wickham@gmail.com,2019-09-17T21:44:56Z,"Interweave `@example` and `@examples`

Fixes #868",NEWS.md;R/rd-examples.R;tests/testthat/test-rd-examples-interleave.txt;tests/testthat/test-rd-examples.R,False,True,True,False,37,28,65,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* `@example` and `@examples` are interwoven in the order in which they
+  appear (#868).
+
 * `@inheritDotParams` automatically ignores arguments that can't be inherited
   through `...` because they are used by the current function (@mjskay, #885).
 

---FILE: R/rd-examples.R---
@@ -1,33 +1,31 @@
-
-# If \code{@@examples} is provided, use that; otherwise, concatenate
-# the files pointed to by each \code{@@example}.
 topic_add_examples <- function(topic, block, base_path) {
-  examples <- block_tags(block, ""examples"")
-  for (example in examples) {
-    topic$add_simple_field(""examples"", example)
-  }
-
-  paths <- str_trim(unlist(block_tags(block, ""example"")))
-  paths <- file.path(base_path, paths)
-
-  for (path in paths) {
-    # Check that haven't accidentally used example instead of examples
-    nl <- str_count(path, ""\n"")
-    if (any(nl) > 0) {
-      block_warning(block, ""@example spans multiple lines. Do you want @examples?"")
-      next
-    }
+  examples <- block_tags(block, c(""examples"", ""example""))
 
-    if (!file.exists(path)) {
-      block_warning(block, ""@example "", path, "" doesn't exist"")
-      next
+  for (i in seq_along(examples)) {
+    if (names(examples)[[i]] == ""examples"") {
+      example <- examples[[i]]
+    } else {
+      example <- read_example_from_path(str_trim(examples[[i]]), base_path, block = block)
     }
+    topic$add_simple_field(""examples"", example)
+  }
+}
 
-    code <- read_lines(path)
-    examples <- escape_examples(code)
+read_example_from_path <- function(path, base_path, block = NULL) {
+  nl <- str_count(path, ""\n"")
+  if (any(nl) > 0) {
+    block_warning(block, ""@example spans multiple lines. Do you want @examples?"")
+    return()
+  }
 
-    topic$add_simple_field(""examples"", examples)
+  path <- file.path(base_path, path)
+  if (!file.exists(path)) {
+    block_warning(block, ""@example "", path, "" doesn't exist"")
+    return()
   }
+
+  code <- read_lines(path)
+  escape_examples(code)
 }
 
 # Works like escape, but unescapes special rd example commands.

---FILE: tests/testthat/test-rd-examples-interleave.txt---
@@ -0,0 +1,7 @@
+> get_tag(out, ""examples"")
+\examples{
+example <- 'example1'
+a <- 2
+example <- 'example2'
+} 
+

---FILE: tests/testthat/test-rd-examples.R---
@@ -27,17 +27,18 @@ test_that(""@examples captures examples"", {
   expect_match(examples, fixed(""a <- 2""), all = FALSE)
 })
 
-test_that(""@examples and @example combine"", {
+test_that(""@examples and @example interleave"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' @name a
     #' @title a
     #' @example Rd-example-1.R
     #' @examples a <- 2
+    #' @example Rd-example-2.R
     NULL"")[[1]]
 
-  examples <- get_tag(out, ""examples"")$values
-  expect_match(examples, fixed(""example <- 'example1'""), all = FALSE)
-  expect_match(examples, fixed(""a <- 2""), all = FALSE)
+  verify_output(test_path(""test-rd-examples-interleave.txt""), {
+    get_tag(out, ""examples"")
+  })
 })
 
 test_that(""@example does not introduce extra empty lines"", {"
r-lib,roxygen2,57e3649886b54aa2025cc6b556a687da074a5c57,Hadley Wickham,h.wickham@gmail.com,2019-09-17T21:33:40Z,Hadley Wickham,h.wickham@gmail.com,2019-09-17T21:33:52Z,"Don't double escape escaped quotes in strings

Fixes #873",NEWS.md;R/markdown-escaping.R;R/rd-examples.R;R/rd.R;R/utils-rd.R;man/double_escape_md.Rd;tests/testthat/test-rd-examples.R,False,True,True,False,60,37,97,"---FILE: NEWS.md---
@@ -3,6 +3,9 @@
 * `@inheritDotParams` automatically ignores arguments that can't be inherited
   through `...` because they are used by the current function (@mjskay, #885).
 
+* Escaped `'` and `""` in strings in examples are no longer double escaped 
+  (#873).
+
 * The default formatting for function usage that spans multiple lines has
   now changed. Previously it was wrapped to produce the fewest number of
   lines, e.g.:

---FILE: R/markdown-escaping.R---
@@ -237,7 +237,10 @@ make_random_string <- function(length = 32) {
 #' @param text Input text.
 #' @return Double-escaped text.
 #' @keywords internal
-
+#' @examples
+#' ""%"" # percent
+#' ""\"""" # double quote
+#' '\'' # single quote
 double_escape_md <- function(text) {
   text <- gsub(""\\"", ""\\\\"", text, fixed = TRUE)
 

---FILE: R/rd-examples.R---
@@ -0,0 +1,42 @@
+
+# If \code{@@examples} is provided, use that; otherwise, concatenate
+# the files pointed to by each \code{@@example}.
+topic_add_examples <- function(topic, block, base_path) {
+  examples <- block_tags(block, ""examples"")
+  for (example in examples) {
+    topic$add_simple_field(""examples"", example)
+  }
+
+  paths <- str_trim(unlist(block_tags(block, ""example"")))
+  paths <- file.path(base_path, paths)
+
+  for (path in paths) {
+    # Check that haven't accidentally used example instead of examples
+    nl <- str_count(path, ""\n"")
+    if (any(nl) > 0) {
+      block_warning(block, ""@example spans multiple lines. Do you want @examples?"")
+      next
+    }
+
+    if (!file.exists(path)) {
+      block_warning(block, ""@example "", path, "" doesn't exist"")
+      next
+    }
+
+    code <- read_lines(path)
+    examples <- escape_examples(code)
+
+    topic$add_simple_field(""examples"", examples)
+  }
+}
+
+# Works like escape, but unescapes special rd example commands.
+# Also unescapes quotes because they must already be in strings and hence
+# don't need an additional layer of quoting.
+escape_examples <- function(x) {
+  x <- escape(x)
+  x <- gsub(""\\\\dont"", ""\\dont"", x, fixed = TRUE)
+  x <- gsub(""\\\\'"", ""\\'"", x, fixed = TRUE)
+  x <- gsub('\\\\""', '\\""', x, fixed = TRUE)
+  x
+}

---FILE: R/rd.R---
@@ -369,37 +369,6 @@ topic_add_fields <- function(topic, block) {
   process_def_tag(topic, block, ""field"")
 }
 
-# If \code{@@examples} is provided, use that; otherwise, concatenate
-# the files pointed to by each \code{@@example}.
-topic_add_examples <- function(topic, block, base_path) {
-  examples <- block_tags(block, ""examples"")
-  for (example in examples) {
-    topic$add_simple_field(""examples"", example)
-  }
-
-  paths <- str_trim(unlist(block_tags(block, ""example"")))
-  paths <- file.path(base_path, paths)
-
-  for (path in paths) {
-    # Check that haven't accidentally used example instead of examples
-    nl <- str_count(path, ""\n"")
-    if (any(nl) > 0) {
-      block_warning(block, ""@example spans multiple lines. Do you want @examples?"")
-      next
-    }
-
-    if (!file.exists(path)) {
-      block_warning(block, ""@example "", path, "" doesn't exist"")
-      next
-    }
-
-    code <- read_lines(path)
-    examples <- escape_examples(code)
-
-    topic$add_simple_field(""examples"", examples)
-  }
-}
-
 topic_add_eval_rd <- function(topic, block, env) {
   tags <- block_tags(block, ""evalRd"")
 

---FILE: R/utils-rd.R---
@@ -29,11 +29,6 @@ escape.character <- function(x) {
   rd(x2)
 }
 
-# Works like escape, but unescapes special rd example commands
-escape_examples <- function(x) {
-  gsub(""\\\\dont"", ""\\dont"", escape(x))
-}
-
 # Works like paste, but automatically escapes all input variables,
 # but not literal strings
 build_rd <- function(..., collapse = NULL, sep = """") {

---FILE: man/double_escape_md.Rd---
@@ -26,4 +26,9 @@ Each of the following bullets should look the same when rendered:
 [ this isn't a link ]
 \[ neither is this \]
 }
+\examples{
+""\%"" # percent
+""\"""" # double quote
+'\'' # single quote
+}
 \keyword{internal}

---FILE: tests/testthat/test-rd-examples.R---
@@ -126,3 +126,9 @@ test_that(""multiple examples (#470)"", {
   examples <- get_tag(out, ""examples"")$values
   expect_equal(examples, rd(c(""TRUE"", ""FALSE"")))
 })
+
+# escapes ------------------------------------------------------------------
+
+test_that(""escapes within strings are not double escaped"", {
+  expect_equal(escape_examples(""'34.00\\'""), rd(""'34.00\\'""))
+})"
r-lib,roxygen2,359b12dc047a667e1475d1a36821d0cfee73821f,Matthew Kay,matthew.kay@gmail.com,2019-09-17T21:22:29Z,Hadley Wickham,h.wickham@gmail.com,2019-09-17T21:22:29Z,"Omit already documented params from `@inheritDotParams` (#886)

Fixes #885",NEWS.md;R/rd-inherit.R;tests/testthat/test-rd-inherit.R,False,True,True,False,37,0,37,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* `@inheritDotParams` automatically ignores arguments that can't be inherited
+  through `...` because they are used by the current function (@mjskay, #885).
+
 * The default formatting for function usage that spans multiple lines has
   now changed. Previously it was wrapped to produce the fewest number of
   lines, e.g.:

---FILE: R/rd-inherit.R---
@@ -76,6 +76,11 @@ inherit_dot_params <- function(topic, topics, env) {
   }
   docs_selected <- unlist(map2(args, docs, arg_matches))
 
+  # Only document params under ""..."" that aren't otherwise documented
+  documented <- get_documented_params(topic)
+  non_documented_params <- setdiff(names(docs_selected), documented)
+  docs_selected <- docs_selected[non_documented_params]
+
   # Build the Rd
   # (1) Link to function(s) that was inherited from
   src <- inheritors$source

---FILE: tests/testthat/test-rd-inherit.R---
@@ -521,6 +521,35 @@ test_that(""can inherit dots from several functions"", {
   )
 })
 
+test_that(""inheritDotParams does not add already-documented params"", {
+  out <- roc_proc_text(rd_roclet(), ""
+    #' Wrapper around original
+    #'
+    #' @inherit original
+    #' @inheritDotParams original
+    #' @param y some more specific description
+    #' @export
+    wrapper <- function(x = 'some_value', y = 'some other value', ...) {
+      original(x = x, y = y, ...)
+    }
+
+    #' Original function
+    #'
+    #' @param x x description
+    #' @param y y description
+    #' @param z z description
+    #' @export
+    original <- function(x, y, z, ...) {}
+  "")[[1]]
+
+  params <- out$get_field(""param"")$values
+  dot_param <- params[[""...""]]
+  expect_named(params, c(""x"", ""y"", ""...""))
+  expect_false(grepl(""item{x}{x description}"", dot_param, fixed = TRUE))
+  expect_false(grepl(""item{y}{y description}"", dot_param, fixed = TRUE))
+  expect_match(dot_param, ""item{\\code{z}}{z description}"", fixed = TRUE)
+})
+
 # inherit everything ------------------------------------------------------
 
 test_that(""can inherit all from single function"", {"
r-lib,roxygen2,496101821544b095c80071c5cde71edd8cf4600a,Hadley Wickham,h.wickham@gmail.com,2019-09-17T21:20:36Z,Hadley Wickham,h.wickham@gmail.com,2019-09-17T21:20:36Z,"One argument per line in usage

Fixes #820",NEWS.md;R/object-usage.R;R/options.R;R/rd.R;R/utils-rd.R;man/parse_package.Rd;man/roc_proc_text.Rd;man/roxygenize.Rd;tests/testthat/test-object-usage-wrap-new.txt;tests/testthat/test-object-usage-wrap-old.txt;tests/testthat/test-object-usage.R;tests/testthat/test-rd-usage.R,False,True,True,False,236,129,365,"---FILE: NEWS.md---
@@ -1,5 +1,32 @@
 # roxygen2 (development version)
 
+* The default formatting for function usage that spans multiple lines has
+  now changed. Previously it was wrapped to produce the fewest number of
+  lines, e.g.:
+  
+    ```R
+    parse_package(path = ""."", env = env_package(path), 
+      registry = default_tags(), global_options = list())
+    ```
+    
+    Now it is wrapped so that each argument gets its own line (#820):
+    
+    ```R
+    parse_package(
+      path = ""."",
+      env = env_package(path),
+      registry = default_tags(),
+      global_options = list()
+    )
+    ```
+    
+    If you prefer the old behaviour you can put the following in your
+    `DESCRIPTION`:
+    
+    ```
+    Roxygen: list(old_usage = TRUE)
+    ```
+
 * `@inheritDotParams` includes link to function and wraps paramters
   in `\code{}` (@halldc, #842)
 

---FILE: R/object-usage.R---
@@ -1,39 +1,39 @@
-object_usage <- function(x) {
+object_usage <- function(x, old_usage = FALSE) {
   UseMethod(""object_usage"")
 }
 
-object_usage.default <- function(x) {
+object_usage.default <- function(x, old_usage = FALSE) {
   NULL
 }
 
-object_usage.data <- function(x) {
+object_usage.data <- function(x, old_usage = FALSE) {
   rd(x$alias)
 }
 
-object_usage.function <- function(x) {
-  function_usage(x$alias, formals(x$value), identity)
+object_usage.function <- function(x, old_usage = FALSE) {
+  function_usage(x$alias, formals(x$value), identity, old_usage = old_usage)
 }
 
 object_usage.s3generic <- object_usage.function
 
-object_usage.s3method <- function(x) {
+object_usage.s3method <- function(x, old_usage = FALSE) {
   method <- attr(x$value, ""s3method"")
   s3method <- function(name) {
     build_rd(""\\method{"", name, ""}{"", auto_backtick(method[2]), ""}"")
   }
-  function_usage(method[1], formals(x$value), s3method)
+  function_usage(method[1], formals(x$value), s3method, old_usage = old_usage)
 }
 
-object_usage.s4generic <- function(x) {
-  function_usage(x$value@generic, formals(x$value), identity)
+object_usage.s4generic <- function(x, old_usage = FALSE) {
+  function_usage(x$value@generic, formals(x$value), identity, old_usage = old_usage)
 }
 
-object_usage.s4method <- function(x) {
+object_usage.s4method <- function(x, old_usage = FALSE) {
   s4method <- function(name) {
     classes <- auto_backtick(as.character(x$value@defined))
     build_rd(""\\S4method{"", name, ""}{"", paste0(classes, collapse = "",""), ""}"")
   }
-  function_usage(x$value@generic, formals(x$value), s4method)
+  function_usage(x$value@generic, formals(x$value), s4method, old_usage = old_usage)
 }
 
 # Function usage ----------------------------------------------------------
@@ -42,26 +42,18 @@ object_usage.s4method <- function(x) {
 # replacement, infix, regular
 # function, s3 method, s4 method, data
 
-function_usage <- function(name, formals, format_name = identity) {
-  arglist <- args_string(usage_args(formals))
+function_usage <- function(name, formals, format_name = identity, old_usage = FALSE) {
   if (is_replacement_fun(name) && !is_infix_fun(name)) {
     name <- str_replace(name, fixed(""<-""), """")
     formals$value <- NULL
 
-    arglist <- args_string(usage_args(formals))
-    build_rd(format_name(name), ""("", arglist, "")\u{A0}<-\u{A0}value"")
+    wrap_usage(name, format_name, formals, suffix = "" <- value"", old_usage = old_usage)
   } else if (is_infix_fun(name) && identical(format_name, identity)) {
     # If infix, and regular function, munge format
     arg_names <- names(formals)
-
     build_rd(arg_names[1], "" "", format_name(name), "" "", arg_names[2])
   } else {
-    # Quote non-syntactic names if no special formatting
-    if (identical(format_name, identity)) {
-      name <- auto_quote(name)
-    }
-
-    build_rd(format_name(name), ""("", arglist, "")"")
+    wrap_usage(name, format_name, formals, old_usage = old_usage)
   }
 }
 
@@ -89,28 +81,50 @@ usage_args <- function(args) {
 
 args_string <- function(x) {
   sep <- ifelse(x != """", ""\u{A0}=\u{A0}"", """")
-  arg_names <- auto_backtick(names(x))
-  paste0(arg_names, sep, x, collapse = "", "")
+  arg_names <- escape(auto_backtick(names(x)))
+  paste0(arg_names, sep, escape(x))
+}
+
+args_call <- function(call, args) {
+  paste0(call, ""("", paste0(args, collapse = "", ""), "")"")
 }
 
-# wrapping ----------------------------------------------------------------
+#' @param name Function name
+#' @param format_name Single argument that returns formatted function name
+#' @param formals List of function formals
+#' @param suffix Optional suffix, used for replacement functions
+#' @noRd
+wrap_usage <- function(name, format_name, formals, suffix = NULL, width = 80L, old_usage = FALSE) {
+  # Quote non-syntactic names if no special formatting
+  if (identical(format_name, identity)) {
+    name <- auto_quote(name)
+  }
+
+  args <- args_string(usage_args(formals))
 
-wrap_usage <- function(x, width = 80L) {
-  if (is.null(x)) {
-    return(NULL)
+  # Do we need any wrapping?
+  bare <- args_call(name, args)
+  if (nchar(bare, type = ""width"") < width) {
+    out <- args_call(format_name(name), args)
+  } else if (old_usage) {
+    x <- args_call(format_name(name), args)
+    out <- wrapUsage(x, width = as.integer(width))
+  } else {
+    args <- paste0(""  "", args)
+    args <- map_chr(args, wrapUsage, width = 95, indent = 4)
+    out <- paste0(format_name(name), ""(\n"", paste0(args, collapse = "",\n""), ""\n)"")
   }
 
-  y <- wrapUsage(x, width = as.integer(width))
-  y <- gsub(""\u{A0}"", "" "", y, useBytes = TRUE)
-  Encoding(y) <- ""UTF-8""
-  class(y) <- class(x)
-  y
+  out <- gsub(""\u{A0}"", "" "", out, useBytes = TRUE)
+  Encoding(out) <- ""UTF-8""
+
+  rd(paste0(out, suffix))
 }
 
 # helpers -----------------------------------------------------------------
 
 # used for testing
-call_to_usage <- function(code, env = pkg_env()) {
+call_to_usage <- function(code, old_usage = FALSE, env = pkg_env()) {
   obj <- call_to_object(!!enexpr(code), env)
-  gsub(""\u{A0}"", "" "", as.character(object_usage(obj)))
+  gsub(""\u{A0}"", "" "", as.character(object_usage(obj, old_usage = old_usage)))
 }

---FILE: R/options.R---
@@ -17,7 +17,8 @@ load_options <- function(base_path = ""."") {
   defaults <- list(
     wrap = FALSE,
     roclets = c(""collate"", ""namespace"", ""rd""),
-    markdown = markdown_global_default
+    markdown = markdown_global_default,
+    old_usage = FALSE
   )
 
   unknown_opts <- setdiff(names(opts), names(defaults))

---FILE: R/rd.R---
@@ -154,7 +154,7 @@ block_to_rd <- function(block, base_path, env, global_options = list()) {
   topic_add_simple_tags(rd, block)
   topic_add_sections(rd, block)
   topic_add_slots(rd, block)
-  topic_add_usage(rd, block)
+  topic_add_usage(rd, block, old_usage = global_options$old_usage)
   topic_add_value(rd, block)
 
   if (rd$has_field(""description"") && rd$has_field(""reexport"")) {
@@ -295,8 +295,7 @@ topic_add_methods <- function(topic, block) {
 
   desc <- lapply(methods, function(x) docstring(x$value@.Data))
   usage <- map_chr(methods, function(x) {
-    usage <- function_usage(x$value@name, formals(x$value@.Data))
-    as.character(wrap_usage(usage))
+    function_usage(x$value@name, formals(x$value@.Data))
   })
 
   has_docs <- !map_lgl(desc, is.null)
@@ -349,9 +348,9 @@ topic_add_keyword <- function(topic, block) {
 }
 
 # Prefer explicit \code{@@usage} to a \code{@@formals} list.
-topic_add_usage <- function(topic, block) {
+topic_add_usage <- function(topic, block, old_usage = FALSE) {
   if (is.null(block$usage)) {
-    usage <- wrap_usage(object_usage(attr(block, ""object"")), width = 75L)
+    usage <- object_usage(attr(block, ""object""), old_usage = old_usage)
   } else if (block$usage == ""NULL"") {
     usage <- NULL
   } else {

---FILE: R/utils-rd.R---
@@ -17,6 +17,7 @@ print.rd <- function(x, ...) {
 }
 
 escape <- function(x) UseMethod(""escape"")
+escape.NULL <- function(x) NULL
 escape.rd <- function(x) x
 escape.character <- function(x) {
   # wrap_usage uses \u{A0}, the unicode non-breaking space, which

---FILE: man/parse_package.Rd---
@@ -8,14 +8,26 @@
 \alias{env_package}
 \title{Parse a package, file, or inline code}
 \usage{
-parse_package(path = ""."", env = env_package(path),
-  registry = default_tags(), global_options = list())
+parse_package(
+  path = ""."",
+  env = env_package(path),
+  registry = default_tags(),
+  global_options = list()
+)
 
-parse_file(file, env = env_file(file), registry = default_tags(),
-  global_options = list())
+parse_file(
+  file,
+  env = env_file(file),
+  registry = default_tags(),
+  global_options = list()
+)
 
-parse_text(text, env = env_file(file), registry = default_tags(),
-  global_options = list())
+parse_text(
+  text,
+  env = env_file(file),
+  registry = default_tags(),
+  global_options = list()
+)
 
 env_file(file)
 

---FILE: man/roc_proc_text.Rd---
@@ -4,8 +4,12 @@
 \alias{roc_proc_text}
 \title{Process roclet on string and capture results.}
 \usage{
-roc_proc_text(roclet, input, registry = default_tags(),
-  global_options = list())
+roc_proc_text(
+  roclet,
+  input,
+  registry = default_tags(),
+  global_options = list()
+)
 }
 \arguments{
 \item{roclet}{Name of roclet to use for processing.}

---FILE: man/roxygenize.Rd---
@@ -5,11 +5,19 @@
 \alias{roxygenise}
 \title{Process a package with the Rd, namespace and collate roclets.}
 \usage{
-roxygenize(package.dir = ""."", roclets = NULL,
-  load_code = env_package, clean = FALSE)
+roxygenize(
+  package.dir = ""."",
+  roclets = NULL,
+  load_code = env_package,
+  clean = FALSE
+)
 
-roxygenise(package.dir = ""."", roclets = NULL,
-  load_code = env_package, clean = FALSE)
+roxygenise(
+  package.dir = ""."",
+  roclets = NULL,
+  load_code = env_package,
+  clean = FALSE
+)
 }
 \arguments{
 \item{package.dir}{Location of package top level directory. Default is

---FILE: tests/testthat/test-object-usage-wrap-new.txt---
@@ -0,0 +1,23 @@
+f(
+  a = ""                                    a"",
+  b = ""                                    b"",
+  c = ""                                    c"",
+  d = ""                                    d""
+) 
+
+f(
+  a = c(""abcdef"", ""abcdef"", ""abcdef"", ""abcdef"", ""abcdef"", ""abcdef"", ""abcdef"", ""abcdef"",
+    ""abcdef"", ""abcdef"")
+) 
+
+\method{mean}{reallyratherquitelongclassname}(
+  reallyreatherquitelongargument = ""reallyratherquitelongvalue_____________________""
+) 
+
+long_replacement_fun(
+  x,
+  a = ""aaaaaaaaaaaaaaaa"",
+  b = ""aaaaaaaaaaaaaaaa"",
+  c = ""aaaaaaaaaaaaaaaa""
+) <- value 
+

---FILE: tests/testthat/test-object-usage-wrap-old.txt---
@@ -0,0 +1,18 @@
+f(a = ""                                    a"",
+  b = ""                                    b"",
+  c = ""                                    c"",
+  d = ""                                    d"") 
+
+f(a = c(""abcdef"", ""abcdef"", ""abcdef"", ""abcdef"", ""abcdef"", ""abcdef"", ""abcdef"",
+  ""abcdef"", ""abcdef"", ""abcdef"")) 
+
+
+  \method{mean}{reallyratherquitelongclassname}(reallyreatherquitelongargument = ""reallyratherquitelongvalue_____________________"") 
+
+long_replacement_fun(x, a = ""aaaaaaaaaaaaaaaa"", b = ""aaaaaaaaaaaaaaaa"",
+  c = ""aaaaaaaaaaaaaaaa"") <- value 
+
+f(xxxxxxxxxxxxxxxxxx1, xxxxxxxxxxxxxxxxxx2, xxxxxxxxxxxxxxxxxx3, x = ""\\""'"",
+  xxxxxxxxxxxxxxxxxx4, xxxxxxxxxxxxxxxxxx5, xxxxxxxxxxxxxxxxxx6,
+  xxxxxxxxxxxxxxxxxx7) 
+

---FILE: tests/testthat/test-object-usage.R---
@@ -129,3 +129,79 @@ test_that(""non-syntactic S4 class names are escaped in usage"", {
     ""\\S4method{rhs}{`<-`}(x)""
   )
 })
+
+
+# Wrapping --------------------------------------------------------------------
+
+test_that(""new wrapping style doesn't change unexpectedly"", {
+  expect_known_output(file = test_path(""test-object-usage-wrap-new.txt""), {
+    cat(call_to_usage({
+      f <- function(a = '                                    a',
+                    b = '                                    b',
+                    c = '                                    c',
+                    d = '                                    d') {}
+    }), ""\n\n"")
+
+    cat(call_to_usage({
+      f <- function(a = c('abcdef', 'abcdef', 'abcdef', 'abcdef', 'abcdef',
+                    'abcdef', 'abcdef', 'abcdef', 'abcdef', 'abcdef')) {}
+    }), ""\n\n"")
+
+    cat(call_to_usage({
+      mean.reallyratherquitelongclassname <-
+        function(reallyreatherquitelongargument = 'reallyratherquitelongvalue_____________________') {}
+    }), ""\n\n"")
+
+    cat(call_to_usage({
+      `long_replacement_fun<-` <- function(x,
+          a = 'aaaaaaaaaaaaaaaa',
+          b = 'aaaaaaaaaaaaaaaa',
+          c = 'aaaaaaaaaaaaaaaa',
+          value) {}
+    }), ""\n\n"")
+  })
+})
+
+test_that(""old wrapping style doesn't change unexpectedly"", {
+  expect_known_output(file = test_path(""test-object-usage-wrap-old.txt""), {
+    cat(call_to_usage({
+      f <- function(a = '                                    a',
+                    b = '                                    b',
+                    c = '                                    c',
+                    d = '                                    d') {}
+    }, old_usage = TRUE), ""\n\n"")
+
+    cat(call_to_usage({
+      f <- function(a = c('abcdef', 'abcdef', 'abcdef', 'abcdef', 'abcdef',
+                    'abcdef', 'abcdef', 'abcdef', 'abcdef', 'abcdef')) {}
+    }, old_usage = TRUE), ""\n\n"")
+
+    cat(call_to_usage({
+      mean.reallyratherquitelongclassname <-
+        function(reallyreatherquitelongargument = 'reallyratherquitelongvalue_____________________') {}
+    }, old_usage = TRUE), ""\n\n"")
+
+    cat(call_to_usage({
+      `long_replacement_fun<-` <- function(x,
+          a = 'aaaaaaaaaaaaaaaa',
+          b = 'aaaaaaaaaaaaaaaa',
+          c = 'aaaaaaaaaaaaaaaa',
+          value) {}
+    }, old_usage = TRUE), ""\n\n"")
+
+    # breaking works after escapes (#265)
+    cat(call_to_usage({
+      f <- function(
+        xxxxxxxxxxxxxxxxxx1,
+        xxxxxxxxxxxxxxxxxx2,
+        xxxxxxxxxxxxxxxxxx3,
+        x = ""\""'"",
+        xxxxxxxxxxxxxxxxxx4,
+        xxxxxxxxxxxxxxxxxx5,
+        xxxxxxxxxxxxxxxxxx6,
+        xxxxxxxxxxxxxxxxxx7
+      ) {}
+    }, old_usage = TRUE), ""\n\n"")
+  })
+})
+

---FILE: tests/testthat/test-rd-usage.R---
@@ -113,79 +113,3 @@ test_that(""Special vars removed in rc methods usage"", {
   methods <- get_tag(out, ""rcmethods"")$values
   expect_equal(methods, list(""draw(x = 1)"" = ""2""))
 })
-
-# Wrapping --------------------------------------------------------------------
-
-test_that(""long usages protected from incorrect breakage"", {
-  out <- roc_proc_text(rd_roclet(), ""
-    #' Function long usage
-    f <- function(a = '                                    a',
-                  b = '                                    b',
-                  c = '                                    c',
-                  d = '                                    d') 1"")[[1]]
-
-  usage <- format(get_tag(out, ""usage""))
-  expect_equal(str_count(usage, ""\n""), 5)
-})
-
-test_that(""argument vectors split on whitespace"", {
-  out <- roc_proc_text(rd_roclet(), ""
-    #' Function long usage
-    f <- function(a = c('abcdef', 'abcdef', 'abcdef', 'abcdef', 'abcdef',
-                  'abcdef', 'abcdef', 'abcdef'))  1"")[[1]]
-
-  usage <- get_tag(out, ""usage"")[[2]]
-  expect_equal(str_count(usage, ""\n""), 1)
-})
-
-test_that(""\\method not split inappropriately"", {
-  out <- roc_proc_text(rd_roclet(), ""
-    #' Function long usage
-    mean.reallyratherquitelongclassname <-
-      function(reallyquitelongargument = 'reallyratherquitelongvalue') 1
-  "")[[1]]
-  usage <- format(get_tag(out, ""usage""))
-  expect_match(usage, ""\\{mean\\}\\{reallyratherquitelongclassname\\}"")
-})
-
-test_that(""long usages protected from incorrect breakage"", {
-  out <- roc_proc_text(rd_roclet(), ""
-    #' Function long usage
-    f <- function(a = '                                    a',
-    b = '                                    b',
-    c = '                                    c',
-    d = '                                    d') 1"")[[1]]
-
-  usage <- format(get_tag(out, ""usage""))
-  expect_equal(str_count(usage, ""\n""), 5)
-})
-
-test_that(""breaking works after escapes (#265)"", {
-
-  out <- roc_proc_text(rd_roclet(), ""
-    #' Long args
-    f <- function(
-      xxxxxxxxxxxxxxxxxx1,
-      xxxxxxxxxxxxxxxxxx2,
-      xxxxxxxxxxxxxxxxxx3,
-      x = \""\\\""'\"",
-      xxxxxxxxxxxxxxxxxx4,
-      xxxxxxxxxxxxxxxxxx5,
-      xxxxxxxxxxxxxxxxxx6,
-      xxxxxxxxxxxxxxxxxx7
-  ){}"")[[1]]
-  usage <- format(get_tag(out, ""usage""))
-  expect_equal(str_count(usage, ""\n""), 4)
-})
-
-test_that(""replacement funs get non-breaking spaces"", {
-  out <- roc_proc_text(rd_roclet(), ""
-    #' Function long usage
-    `long_replacement_fun<-` <- function(x,
-        a = 'aaaaaaaaaaaaaaaa',
-        b = 'aaaaaaaaaaaaaaaa',
-        value) {}
-  "")[[1]]
-  usage <- format(get_tag(out, ""usage""))
-  expect_match(usage, "" <- "")
-})"
r-lib,roxygen2,3d680ade05ee30951156f39d1ff35b46e76b05c0,G치bor Cs치rdi,csardi.gabor@gmail.com,2019-09-17T16:04:57Z,Hadley Wickham,h.wickham@gmail.com,2019-09-17T16:04:57Z,"Do not parse @inheritDotParams as md (#910)

Fixes #909.",R/rd.R;R/tag.R;man/roxy_tag.Rd,False,True,True,False,14,13,27,"---FILE: R/rd.R---
@@ -54,7 +54,8 @@ roclet_tags.roclet_rd <- function(x) {
     includeRmd = tag_value,
     inherit = tag_inherit,
     inheritParams = tag_value,
-    inheritDotParams = tag_two_part(""source"", ""args"", required = FALSE),
+    inheritDotParams =
+      tag_two_part(""source"", ""args"", required = FALSE, markdown = FALSE),
     inheritSection = tag_name_description,
     keywords = tag_value,
     method = tag_words(2, 2),

---FILE: R/tag.R---
@@ -121,16 +121,10 @@ tag_name <- function(x) {
 #' @param first,second Name of first and second parts of two part tags
 #' @param required Is the second part required (TRUE) or can it be blank
 #'   (FALSE)?
-tag_two_part <- function(first, second, required = TRUE) {
-
-  ## For now we parse only the second part as markdown, because
-  ## * for all current use cases, coming from tag_name_description
-  ##   (describeIn, field, inheritSection, param, slot, templateVar),
-  ##   this is the right thing to do, and
-  ## * if the two-part tag generally consists of a name and a
-  ##   description, then this is a sensible default.
-  ## In the future we might need extra arguments to this function to
-  ## override this behavior
+#' @param markdown Should the second part be parsed as markdown?
+tag_two_part <- function(first, second, required = TRUE, markdown = TRUE) {
+  force(required)
+  force(markdown)
 
   function(x) {
     if (str_trim(x$val) == """") {
@@ -142,9 +136,13 @@ tag_two_part <- function(first, second, required = TRUE) {
     } else {
       pieces <- str_split_fixed(str_trim(x$val), ""[[:space:]]+"", 2)
 
+      if (markdown) {
+        pieces[,2] <- markdown_if_active(pieces[,2], x)
+      }
+
       x$val <- list(
         pieces[, 1],
-        trim_docstring(markdown_if_active(pieces[, 2], x))
+        trim_docstring(pieces[,2])
       )
       names(x$val) <- c(first, second)
       x

---FILE: man/roxy_tag.Rd---
@@ -27,7 +27,7 @@ tag_inherit(x)
 
 tag_name(x)
 
-tag_two_part(first, second, required = TRUE)
+tag_two_part(first, second, required = TRUE, markdown = TRUE)
 
 tag_name_description(x)
 
@@ -59,6 +59,8 @@ a character vector, but sometimes a list).}
 \item{required}{Is the second part required (TRUE) or can it be blank
 (FALSE)?}
 
+\item{markdown}{Should the second part be parsed as markdown?}
+
 \item{min, max}{Minimum and maximum number of words}
 }
 \description{"
r-lib,roxygen2,667948483d36666957f7553fb7d68c4ed09340a8,David Hall,41926798+halldc@users.noreply.github.com,2019-09-13T21:35:33Z,Hadley Wickham,h.wickham@gmail.com,2019-09-13T21:35:33Z,"Improve formatting of inheritDotParams (#842)

Fixes #730",NEWS.md;R/field.R;R/rd-inherit.R;tests/testthat/test-rd-inherit-dots-inherit.txt;tests/testthat/test-rd-inherit-dots-multi.txt;tests/testthat/test-rd-inherit-dots.txt;tests/testthat/test-rd-inherit-link.txt;tests/testthat/test-rd-inherit.R,False,True,True,False,68,25,93,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* `@inheritDotParams` includes link to function and wraps paramters
+  in `\code{}` (@halldc, #842)
+
 * Allow multiple `@inheritDotParams` (@gustavdelius, #767).
 
 * Avoid multiple `...` arguments when using `@inheritDotParams`

---FILE: R/field.R---
@@ -23,7 +23,7 @@ is_roxy_field <- function(x) inherits(x, ""roxy_field"")
 
 #' @export
 print.roxy_field <- function(x, ...) {
-  cat(format(x), ""\n"")
+  cat(format(x, wrap = FALSE), ""\n"")
 }
 
 #' @export

---FILE: R/rd-inherit.R---
@@ -76,16 +76,22 @@ inherit_dot_params <- function(topic, topics, env) {
   }
   docs_selected <- unlist(map2(args, docs, arg_matches))
 
-  # Build the arg string
-  from <- paste0(""\\code{"", inheritors$source, ""}"", collapse = "", "")
-  args <- paste0(""  \\item{"", names(docs_selected), ""}{"", docs_selected, ""}"",
-    collapse = ""\n"")
+  # Build the Rd
+  # (1) Link to function(s) that was inherited from
+  src <- inheritors$source
+  dest <- ifelse(has_colons(src), gsub(""::"", "":"", src), paste0(""="", src))
+  from <- paste0(""\\code{\\link["", dest, ""]{"", src, ""}}"", collapse = "", "")
+
+  # (2) Show each inherited argument
+  arg_names <- paste0(""\\code{"", names(docs_selected), ""}"")
+  args <- paste0(""    \\item{"", arg_names, ""}{"", docs_selected, ""}"", collapse = ""\n"")
 
   rd <- paste0(
-    ""Arguments passed on to "", from, ""\n"",
-    ""\\describe{\n"",
+    ""\n"",
+    ""  Arguments passed on to "", from, ""\n"",
+    ""  \\describe{\n"",
     args, ""\n"",
-    ""}""
+    ""  }""
   )
   topic$add_simple_field(""param"", c(""..."" = rd))
 }

---FILE: tests/testthat/test-rd-inherit-dots-inherit.txt---
@@ -0,0 +1,12 @@
+> out$get_field(""param"")
+\arguments{
+\item{x}{x}
+
+\item{...}{
+  Arguments passed on to \code{\link[=baz]{baz}}
+  \describe{
+    \item{\code{y}}{y}
+    \item{\code{z}}{z}
+  }}
+} 
+

---FILE: tests/testthat/test-rd-inherit-dots-multi.txt---
@@ -0,0 +1,11 @@
+> out$get_field(""param"")
+\arguments{
+\item{...}{
+  Arguments passed on to \code{\link[=foo]{foo}}, \code{\link[=bar]{bar}}
+  \describe{
+    \item{\code{x}}{x}
+    \item{\code{y}}{y1}
+    \item{\code{z}}{z}
+  }}
+} 
+

---FILE: tests/testthat/test-rd-inherit-dots.txt---
@@ -0,0 +1,10 @@
+> out$get_field(""param"")
+\arguments{
+\item{...}{
+  Arguments passed on to \code{\link[=foo]{foo}}
+  \describe{
+    \item{\code{x}}{x}
+    \item{\code{y}}{y}
+  }}
+} 
+

---FILE: tests/testthat/test-rd-inherit-link.txt---
@@ -1,7 +1,7 @@
 > # \link{} should include [digest]
 > out$get_field(""param"")
 \arguments{
-  \item{algo}{The hashing algoritm to be used by
-  \code{\link[digest]{digest}}. Defaults to ""sha1""}
+\item{algo}{The hashing algoritm to be used by \code{\link[digest]{digest}}. Defaults to
+""sha1""}
 } 
 

---FILE: tests/testthat/test-rd-inherit.R---
@@ -461,10 +461,10 @@ test_that(""can inherit all from single function"", {
     bar <- function(...) {}
   "")[[2]]
 
-  params <- out$get_field(""param"")$values
-  expect_named(params, ""..."")
-  expect_match(params, ""Arguments passed on to \\code{foo}"", fixed = TRUE)
-  expect_match(params, ""\\item{x}{x}"", fixed = TRUE)
+  verify_output(
+    test_path(""test-rd-inherit-dots.txt""),
+    out$get_field(""param"")
+  )
 })
 
 test_that(""does not produce multiple ... args"", {
@@ -487,37 +487,38 @@ test_that(""does not produce multiple ... args"", {
     #' @param z z
     baz <- function(y, z) {}
   "")[[1]]
-  params <- out$get_field(""param"")$values
-  expect_length(params, 2)
-  expect_match(params[1], ""x"")
-  expect_match(params[2], ""Arguments passed on to \\code{baz}"", fixed = TRUE)
+
+  verify_output(
+    test_path(""test-rd-inherit-dots-inherit.txt""),
+    out$get_field(""param"")
+  )
 })
 
 test_that(""can inherit dots from several functions"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' Foo
     #'
     #' @param x x
-    #' @param y y
+    #' @param y y1
     foo <- function(x, y) {}
 
     #' Bar
     #'
+    #' @param y y2
     #' @param z z
     bar <- function(z) {}
 
     #' Foobar
     #'
-    #' @inheritDotParams foo -y
+    #' @inheritDotParams foo
     #' @inheritDotParams bar
     foobar <- function(...) {}
   "")[[3]]
 
-  params <- out$get_field(""param"")$values
-  expect_named(params, ""..."")
-  expect_match(params, ""Arguments passed on to \\code{foo}, \\code{bar}"",
-               fixed = TRUE)
-  expect_match(params, ""\\item{x}{x}\n  \\item{z}{z}"", fixed = TRUE)
+  verify_output(
+    test_path(""test-rd-inherit-dots-multi.txt""),
+    out$get_field(""param"")
+  )
 })
 
 # inherit everything ------------------------------------------------------"
r-lib,roxygen2,9bd9f4a261efd271fefb9d3baf068018fed7c3fd,Gustav W Delius,gustav.delius@york.ac.uk,2019-09-13T21:11:54Z,Hadley Wickham,h.wickham@gmail.com,2019-09-13T21:11:54Z,"Fixes for @inheritDocParams (#854)

Fixes #767. Fixes #857.",NAMESPACE;NEWS.md;R/field.R;tests/testthat/test-rd-inherit.R,False,True,True,False,70,1,71,"---FILE: NAMESPACE---
@@ -46,6 +46,7 @@ S3method(merge,roxy_field_inherit)
 S3method(merge,roxy_field_inherit_dot_params)
 S3method(merge,roxy_field_inherit_section)
 S3method(merge,roxy_field_minidesc)
+S3method(merge,roxy_field_param)
 S3method(merge,roxy_field_reexport)
 S3method(merge,roxy_field_section)
 S3method(object_defaults,data)

---FILE: NEWS.md---
@@ -1,5 +1,10 @@
 # roxygen2 (development version)
 
+* Allow multiple `@inheritDotParams` (@gustavdelius, #767).
+
+* Avoid multiple `...` arguments when using `@inheritDotParams`
+  (@gustavdelius, #857).
+
 * `@family` automatically adds `()` when linking to functions (#815).
 
 * Headings are now allowed in markdown text. Subheadings, i.e. headings

---FILE: R/field.R---
@@ -37,6 +37,16 @@ merge.roxy_field <- function(x, y, ...) {
   roxy_field_simple(x$field, c(x$values, y$values))
 }
 
+#' @export
+merge.roxy_field_param <- function(x, y, ...) {
+  stopifnot(identical(class(x), class(y)))
+  # When parameters appear in both x and y, keep values from y
+  # This happens for example when inherit_dot_params adds a ""..."" param after
+  # inherit_params has done the same.
+  to_add <- setdiff(names(x$values), names(y$values))
+  roxy_field_simple(x$field, c(x$values[to_add], y$values))
+}
+
 
 # Comment fields -----------------------------------------------------------------------
 
@@ -285,7 +295,7 @@ format.roxy_field_inherit_dot_params <- format_null
 #' @export
 merge.roxy_field_inherit_dot_params <- function(x, y, ...) {
   stopifnot(identical(class(x), class(y)))
-  roxy_field_inherit_section(c(x$source, y$source), c(x$args, y$args))
+  roxy_field_inherit_dot_params(c(x$source, y$source), c(x$args, y$args))
 }
 
 # Sections ----------------------------------------------------------------

---FILE: tests/testthat/test-rd-inherit.R---
@@ -467,6 +467,59 @@ test_that(""can inherit all from single function"", {
   expect_match(params, ""\\item{x}{x}"", fixed = TRUE)
 })
 
+test_that(""does not produce multiple ... args"", {
+  out <- roc_proc_text(rd_roclet(), ""
+    #' Foo
+    #'
+    #' @inheritParams bar
+    #' @inheritDotParams baz
+    foo <- function(x, ...) {}
+
+    #' Bar
+    #'
+    #' @param x x
+    #' @param ... dots
+    bar <- function(x, ...) {}
+
+    #' Baz
+    #'
+    #' @param y y
+    #' @param z z
+    baz <- function(y, z) {}
+  "")[[1]]
+  params <- out$get_field(""param"")$values
+  expect_length(params, 2)
+  expect_match(params[1], ""x"")
+  expect_match(params[2], ""Arguments passed on to \\code{baz}"", fixed = TRUE)
+})
+
+test_that(""can inherit dots from several functions"", {
+  out <- roc_proc_text(rd_roclet(), ""
+    #' Foo
+    #'
+    #' @param x x
+    #' @param y y
+    foo <- function(x, y) {}
+
+    #' Bar
+    #'
+    #' @param z z
+    bar <- function(z) {}
+
+    #' Foobar
+    #'
+    #' @inheritDotParams foo -y
+    #' @inheritDotParams bar
+    foobar <- function(...) {}
+  "")[[3]]
+
+  params <- out$get_field(""param"")$values
+  expect_named(params, ""..."")
+  expect_match(params, ""Arguments passed on to \\code{foo}, \\code{bar}"",
+               fixed = TRUE)
+  expect_match(params, ""\\item{x}{x}\n  \\item{z}{z}"", fixed = TRUE)
+})
+
 # inherit everything ------------------------------------------------------
 
 test_that(""can inherit all from single function"", {"
r-lib,roxygen2,f28b184a07dd42421ba2741c594baf13a882396a,Hadley Wickham,h.wickham@gmail.com,2019-09-13T20:39:17Z,Hadley Wickham,h.wickham@gmail.com,2019-09-13T20:39:17Z,"Add () when `@family` links to functions

Fixes #815",NEWS.md;R/rd-family.R;R/rd.R;man/namespace_roclet.Rd;man/rd_roclet.Rd;man/vignette_roclet.Rd;tests/testthat/test-rd-family.R,False,True,True,False,33,13,46,"---FILE: NEWS.md---
@@ -1,9 +1,12 @@
 # roxygen2 (development version)
 
-* Subheadings, i.e. headings of level 2 and above, are now allowed in
-  markdown text. They generate subsections within the roxygen tag
-  (within `@description`, `@details`, `@return`, etc.) `##` creates a
-  subsection, `###` a sub-subsection, etc. Headings can be nested (#907).
+* `@family` automatically adds `()` when linking to functions (#815).
+
+* Headings are now allowed in markdown text. Subheadings, i.e. headings
+  with level 2 and above, generate subsections within roxygen tags
+  (e.g. within `@description`, `@details`, `@return`, etc.) `##` creates a
+  subsection, `###` a sub-subsection, etc. Level 1 headings generate
+  separate sections in the manual page (#907, #908).
 
 * `\link{foo}` links in external inherited documentation are automatically
   transformed to `\link{package}{foo}` so that they work in the generated

---FILE: R/rd-family.R---
@@ -23,7 +23,7 @@ topics_process_family_prefix <- function(family) {
 
 }
 
-topics_process_family <- function(topics) {
+topics_process_family <- function(topics, env) {
   family_index <- invert(topics$simple_values(""family""))
   aliases <- topics$simple_values(""alias"")
 
@@ -40,7 +40,9 @@ topics_process_family <- function(topics) {
         next
 
       by_file <- map_chr(aliases[others], function(x) {
-        paste0(""\\code{\\link{"", escape(x[1]), ""}}"")
+        obj <- find_object(x[1], env)
+        suffix <- if (is.function(obj$value)) ""()"" else """"
+        paste0(""\\code{\\link{"", escape(x[1]), ""}"", suffix, ""}"")
       })
       links <- paste(sort_c(by_file), collapse = "", "")
 

---FILE: R/rd.R---
@@ -93,7 +93,7 @@ roclet_process.roclet_rd <- function(x,
     rd <- block_to_rd(block, base_path, env, global_options)
     topics$add(rd)
   }
-  topics_process_family(topics)
+  topics_process_family(topics, env)
   topics_process_inherit(topics, env)
   topics$drop_invalid()
   topics_fix_params_order(topics)

---FILE: man/namespace_roclet.Rd---
@@ -44,7 +44,7 @@ foofy <- function(x, y, z) {
 NULL
 }
 \seealso{
-Other roclets: \code{\link{rd_roclet}},
-  \code{\link{vignette_roclet}}
+Other roclets: \code{\link{rd_roclet}()},
+  \code{\link{vignette_roclet}()}
 }
 \concept{roclets}

---FILE: man/rd_roclet.Rd---
@@ -71,7 +71,7 @@ str_length <- function(x) {
 }
 }
 \seealso{
-Other roclets: \code{\link{namespace_roclet}},
-  \code{\link{vignette_roclet}}
+Other roclets: \code{\link{namespace_roclet}()},
+  \code{\link{vignette_roclet}()}
 }
 \concept{roclets}

---FILE: man/vignette_roclet.Rd---
@@ -20,7 +20,7 @@ your package, add \code{--no-build-vignettes} to the ""Build Source Package""
 field in your project options.
 }
 \seealso{
-Other roclets: \code{\link{namespace_roclet}},
-  \code{\link{rd_roclet}}
+Other roclets: \code{\link{namespace_roclet}()},
+  \code{\link{rd_roclet}()}
 }
 \concept{roclets}

---FILE: tests/testthat/test-rd-family.R---
@@ -86,6 +86,21 @@ test_that(""families listed in same order as input"", {
   expect_match(seealso[2], ""^Other a"")
 })
 
+test_that(""only functions get () suffix"", {
+  out <- roc_proc_text(rd_roclet(), ""
+    #' foo
+    #' @family a
+    foo <- function() {}
+
+    #' bar
+    #' @family a
+    bar <- 1:10
+  "")
+
+  expect_equal(get_tag(out[[1]], ""seealso"")$values, ""Other a: \\code{\\link{bar}}"")
+  expect_equal(get_tag(out[[2]], ""seealso"")$values, ""Other a: \\code{\\link{foo}()}"")
+})
+
 test_that(""family also included in concepts"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' foo"
r-lib,roxygen2,40cb4a6e8b149b4bbcc13bd7c674c222c26161aa,Hadley Wickham,h.wickham@gmail.com,2019-09-12T22:36:56Z,Hadley Wickham,h.wickham@gmail.com,2019-09-12T22:36:56Z,"Fix exportS3Method

Thanks @bastistician",R/namespace.R,False,True,True,False,1,1,2,"---FILE: R/namespace.R---
@@ -175,7 +175,7 @@ ns_exportS3Method    <- function(tag, block) {
 
   if (length(tag) < 2 && !inherits(obj, ""s3method"")) {
     block_warning(block,
-      ""`@exportS3method` and `@exportS3method generic` must be used with an S3 method""
+      ""`@exportS3Method` and `@exportS3Method generic` must be used with an S3 method""
     )
     return()
   }"
r-lib,roxygen2,e3be91d2e4becd39471b7c4f90c47ebce8a5c0d0,Hadley Wickham,h.wickham@gmail.com,2019-09-12T21:43:01Z,Hadley Wickham,h.wickham@gmail.com,2019-09-12T21:43:01Z,"Typo fix

Fixes #844",vignettes/rd-formatting.Rmd,True,False,True,False,1,1,2,"---FILE: vignettes/rd-formatting.Rmd---
@@ -318,7 +318,7 @@ To the web:
 
 Standard LaTeX (with no extensions):
 
-* `\eqn{a + b}`: inline eqution
+* `\eqn{a + b}`: inline equation
 
 * `\deqn{a + b}`: display (block) equation
 "
r-lib,roxygen2,11201ae4738bd15088eb5cf250a7aa137a7b5a43,Hadley Wickham,h.wickham@gmail.com,2019-09-12T21:25:13Z,Hadley Wickham,h.wickham@gmail.com,2019-09-12T21:25:13Z,Focus regression test,tests/testthat/test-rd-inherit-link.txt;tests/testthat/test-rd-inherit.R,False,True,True,False,7,16,23,"---FILE: tests/testthat/test-rd-inherit-link.txt---
@@ -1,17 +1,7 @@
-> print(out)
-% Generated by roxygen2: do not edit by hand
-% Please edit documentation in ./test
-\name{wrapper}
-\alias{wrapper}
-\title{Title}
-\usage{
-wrapper(algo)
-}
+> # \link{} should include [digest]
+> out$get_field(""param"")
 \arguments{
   \item{algo}{The hashing algoritm to be used by
   \code{\link[digest]{digest}}. Defaults to ""sha1""}
-}
-\description{
-Title
-}
+} 
 

---FILE: tests/testthat/test-rd-inherit.R---
@@ -22,14 +22,15 @@ test_that(""\\links are transformed"", {
     #' Title
     #'
     #' @inheritParams digest::sha1
-    #' @backref test
     wrapper <- function(algo) {}""
   )[[1]]
 
-  # \links{} should be transformed to include [digest]
   verify_output(
     test_path(""test-rd-inherit-link.txt""),
-    print(out)
+    {
+      ""\\link{} should include [digest]""
+      out$get_field(""param"")
+    }
   )
 })
 "
r-lib,roxygen2,87eba5894b5efb1692629a3264c74974ce38a2b7,Hadley Wickham,h.wickham@gmail.com,2019-09-12T21:22:33Z,Hadley Wickham,h.wickham@gmail.com,2019-09-12T21:22:33Z,"Tweak inherited links to include package name

Fixes #635",NEWS.md;R/rd-inherit.R;R/utils-rd.R;tests/testthat/test-rd-inherit-link.txt;tests/testthat/test-rd-inherit.R;tests/testthat/test-utils-rd.R,False,True,True,False,61,1,62,"---FILE: NEWS.md---
@@ -1,5 +1,9 @@
 # roxygen2 (development version)
 
+* `\link{foo}` links in external inherited documentation are automatically
+  transformed to `\link{package}{foo}` so that they work in the generated
+  documented (#635).
+
 * `\href{}` links in external inherited documentation are now inserted 
   correctly (without additional `{}`) (#778).
 

---FILE: R/rd-inherit.R---
@@ -253,7 +253,7 @@ get_rd <- function(name, topics) {
     pkg <- as.character(parsed[[2]])
     fun <- as.character(parsed[[3]])
 
-    get_rd_from_help(pkg, fun)
+    tweak_links(get_rd_from_help(pkg, fun), package = pkg)
   } else {
     # Current package
     rd_name <- topics$find_filename(name)

---FILE: R/utils-rd.R---
@@ -77,6 +77,21 @@ rd2text <- function(x) {
   paste(chr, collapse = """")
 }
 
+tweak_links <- function(x, package) {
+  tag <- attr(x, ""Rd_tag"")
+
+  if (is.list(x)) {
+    if (!is.null(tag) && tag == ""\\link"") {
+      if (is.null(attr(x, ""Rd_option""))) {
+        attr(x, ""Rd_option"") <- structure(package, Rd_tag = ""TEXT"")
+      }
+    } else if (length(x) > 0) {
+      x[] <- map(x, tweak_links, package = package)
+    }
+  }
+
+  x
+}
 
 # helpers -----------------------------------------------------------------
 

---FILE: tests/testthat/test-rd-inherit-link.txt---
@@ -0,0 +1,17 @@
+> print(out)
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in ./test
+\name{wrapper}
+\alias{wrapper}
+\title{Title}
+\usage{
+wrapper(algo)
+}
+\arguments{
+  \item{algo}{The hashing algoritm to be used by
+  \code{\link[digest]{digest}}. Defaults to ""sha1""}
+}
+\description{
+Title
+}
+

---FILE: tests/testthat/test-rd-inherit.R---
@@ -17,6 +17,22 @@ test_that(""can round-trip Rd"", {
   )
 })
 
+test_that(""\\links are transformed"", {
+  out <- roc_proc_text(rd_roclet(), ""
+    #' Title
+    #'
+    #' @inheritParams digest::sha1
+    #' @backref test
+    wrapper <- function(algo) {}""
+  )[[1]]
+
+  # \links{} should be transformed to include [digest]
+  verify_output(
+    test_path(""test-rd-inherit-link.txt""),
+    print(out)
+  )
+})
+
 # tag parsing -------------------------------------------------------------
 
 test_that(""warns on unknown inherit type"", {

---FILE: tests/testthat/test-utils-rd.R---
@@ -1,3 +1,11 @@
 test_that(""href doesn't get extra parens"", {
   expect_equal(rd2text(parse_rd(""\\href{a}{b}"")), ""\\href{a}{b}\n"")
 })
+
+test_that(""can tweak links to point to new package"", {
+  rd1 <- tweak_links(parse_rd(""\\link{foo}""), package = ""bar"")
+  rd2 <- tweak_links(parse_rd(""\\link[baz]{foo}""), package = ""bar"")
+
+  expect_equal(rd2text(rd1), ""\\link[bar]{foo}\n"")
+  expect_equal(rd2text(rd2), ""\\link[baz]{foo}\n"")
+})"
r-lib,roxygen2,e1d3930ecf92ea4a46512776e2b6509f3c619f52,Hadley Wickham,h.wickham@gmail.com,2019-09-12T20:50:10Z,Hadley Wickham,h.wickham@gmail.com,2019-09-12T20:50:36Z,"Monkeypatch as.character.Rd to fix \href{} rendering

Fixes #778",NEWS.md;R/utils-rd.R;R/zzz.R;tests/testthat/test-utils-rd.R,False,True,True,False,40,1,41,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* `\href{}` links in external inherited documentation are now inserted 
+  correctly (without additional `{}`) (#778).
+
 * White space is automatically trimmed off the `RoxygenNote` field when 
   comparing the installed version of roxygen2 to the version used to 
   generate the documentation (#802).

---FILE: R/utils-rd.R---
@@ -73,7 +73,37 @@ get_tags <- function(rd, tag) {
 }
 
 rd2text <- function(x) {
-  chr <- as.character(structure(x, class = ""Rd""), deparse = TRUE)
+  chr <- as_character_rd(structure(x, class = ""Rd""), deparse = TRUE)
   paste(chr, collapse = """")
 }
 
+
+# helpers -----------------------------------------------------------------
+
+parse_rd <- function(x) {
+  con <- textConnection(x)
+  on.exit(close(con), add = TRUE)
+
+  tryCatch(
+    tools::parse_Rd(con, fragment = TRUE, encoding = ""UTF-8""),
+    warning = function(cnd) NULL
+  )
+}
+
+# Generated in .onLoad()
+as_character_rd <- NULL
+make_as_character_rd <- function() {
+  # ""as.character.Rd"" appears to be missing \href in TWOARGS
+  # this code hacks the body of the function to add it
+  fn <- internal_f(""tools"", ""as.character.Rd"")
+
+  body <- body(fn)
+  idx <- purrr::detect_index(body, ~ is_call(.x, ""<-"", 2) && is_symbol(.x[[2]], ""TWOARG""))
+  if (idx == 0) {
+    return(fn)
+  }
+
+  body[[idx]][[3]] <- call_modify(body[[idx]][[3]], ""\\href"")
+  body(fn) <- body
+  fn
+}

---FILE: R/zzz.R---
@@ -0,0 +1,3 @@
+.onLoad <- function(...) {
+  as_character_rd <<- make_as_character_rd()
+}

---FILE: tests/testthat/test-utils-rd.R---
@@ -0,0 +1,3 @@
+test_that(""href doesn't get extra parens"", {
+  expect_equal(rd2text(parse_rd(""\\href{a}{b}"")), ""\\href{a}{b}\n"")
+})"
r-lib,roxygen2,7a8da921c1a4c8030f52771fb37202c4d6467a0d,G치bor Cs치rdi,csardi.gabor@gmail.com,2019-09-12T20:45:57Z,Hadley Wickham,h.wickham@gmail.com,2019-09-12T20:45:57Z,"Support including (R)md files into a manual page (#902)

Fixes #669. Fixes #696. Fixes #799.",.Rbuildignore;.gitignore;DESCRIPTION;NAMESPACE;NEWS.md;R/markdown-link.R;R/markdown.R;R/rd-include-rmd.R;R/rd.R;R/utils.R;man/rd_roclet.Rd;man/roxygen2-package.Rd;tests/testthat/helper-test.R;tests/testthat/test-rd-includermd.R;vignettes/rd.Rmd,True,True,True,False,386,35,421,"---FILE: .Rbuildignore---
@@ -15,3 +15,7 @@
 ^pkgdown$
 ^\.covrignore$
 ^azure-pipelines\.yml$
+^\.Rprofile$
+^r-packages$
+^doc$
+^Meta$

---FILE: .gitignore---
@@ -9,3 +9,7 @@ inst/doc
 revdep/checks
 revdep/library
 docs/
+/r-packages
+/.Rprofile
+doc
+Meta

---FILE: DESCRIPTION---
@@ -11,6 +11,10 @@ Authors@R:
              family = ""Danenberg"",
              role = c(""aut"", ""cph""),
              email = ""pcd@roxygen.org""),
+      person(given = ""G치bor"",
+             family = ""Cs치rdi"",
+             role = c(""aut""),
+             email = ""csardi.gabor@gmail.com""),
       person(given = ""Manuel"",
              family = ""Eugster"",
              role = c(""aut"", ""cph"")),

---FILE: NAMESPACE---
@@ -123,6 +123,8 @@ importFrom(purrr,map_lgl)
 importFrom(stats,setNames)
 importFrom(utils,URLdecode)
 importFrom(utils,URLencode)
+importFrom(utils,head)
+importFrom(utils,tail)
 importFrom(xml2,xml_attr)
 importFrom(xml2,xml_children)
 importFrom(xml2,xml_contents)

---FILE: NEWS.md---
@@ -34,6 +34,11 @@
 * Support `@S3method` has been removed. It was deprecated in roxygen2 4.0.0
   released 2014-05-02, over 5 years ago.
 
+* `@includeRmd` converts an `.Rmd`/`.md` file to Rd and includes it in the
+  manual page. This allows sharing text between vignettes, the `README.Rmd`
+  file and the manual. See the ""Rd (documentation) tags"" vignette for
+  details (#902).
+
 * Rd comments (`%`) are automatically escaped in markdown text. This is 
   a backward incompatible check that will require that you replace
   existing uses of `\%` with `%` (#879).

---FILE: R/markdown-link.R---
@@ -38,8 +38,7 @@
 #' @noRd
 #' @importFrom utils URLencode URLdecode
 
-add_linkrefs_to_md <- function(text) {
-
+get_md_linkrefs <- function(text) {
   refs <- str_match_all(
     text,
     regex(
@@ -53,21 +52,24 @@ add_linkrefs_to_md <- function(text) {
     )
   )[[1]]
 
-  if (length(refs) == 0) return(text)
+  if (length(refs) == 0) {
+    return(character())
+  }
 
   ## For the [fun] form the link text is the same as the destination.
   # Need to check both NA and """" for different versions of stringr
   refs[, 3] <- ifelse(is.na(refs[,3]) | refs[,3] == """", refs[, 2], refs[,3])
 
   refs3encoded <- map_chr(refs[,3], URLencode)
-  ref_text <- paste0(""["", refs[, 3], ""]: "", ""R:"", refs3encoded)
+  paste0(""["", refs[, 3], ""]: "", ""R:"", refs3encoded)
+}
 
-  paste0(
-    text,
-    ""\n\n"",
-    paste(ref_text, collapse = ""\n""),
-    ""\n""
-  )
+add_linkrefs_to_md <- function(text) {
+  ref_lines <- get_md_linkrefs(text)
+  if (length(ref_lines) == 0)
+    return(text)
+  ref_text <- paste0(ref_lines, collapse = ""\n"")
+  paste0(text, ""\n\n"", ref_text, ""\n"")
 }
 
 #' Parse a MarkDown link, to see if we should create an Rd link

---FILE: R/markdown.R---
@@ -11,54 +11,67 @@ markdown <- function(text, tag = NULL) {
   esc_text_linkrefs <- add_linkrefs_to_md(esc_text)
 
   mdxml <- md_to_mdxml(esc_text_linkrefs)
-  rd <- mdxml_children_to_rd(mdxml, tag)
+  state <- new.env(parent = emptyenv())
+  state$tag <- tag
+  rd <- mdxml_children_to_rd_top(mdxml, state)
 
-  unescape_rd_for_md(str_trim(rd), esc_text)
+  unescape_rd_for_md(str_trim(rd$main), esc_text)
 }
 
 md_to_mdxml <- function(x) {
   md <- commonmark::markdown_xml(x, hardbreaks = TRUE)
   xml2::read_xml(md)
 }
 
-mdxml_children_to_rd <- function(xml, tag) {
-  out <- map_chr(xml_children(xml), mdxml_node_to_rd, tag)
+mdxml_children_to_rd_top <- function(xml, state) {
+  state$section_tag <- uuid()
+  out <- map_chr(xml_children(xml), mdxml_node_to_rd, state)
+  out <- c(out, mdxml_close_sections(state))
+  rd <- paste0(out, collapse = """")
+  secs <- strsplit(rd, state$section_tag, fixed = TRUE)[[1]]
+  list(main = secs[[1]], sections = secs[-1])
+}
+
+mdxml_children_to_rd <- function(xml, state) {
+  out <- map_chr(xml_children(xml), mdxml_node_to_rd, state)
   paste0(out, collapse = """")
 }
 
 #' @importFrom xml2 xml_name xml_type xml_text xml_contents xml_attr xml_children
-mdxml_node_to_rd <- function(xml, tag) {
+mdxml_node_to_rd <- function(xml, state) {
   if (!inherits(xml, ""xml_node"") || xml_type(xml) != ""element"") {
-    roxy_tag_warning(tag, ""Internal markdown translation failure"")
+    roxy_tag_warning(state$tag, ""Internal markdown translation failure"")
     return("""")
   }
 
   switch(xml_name(xml),
     html = ,
     document = ,
-    unknown = mdxml_children_to_rd(xml, tag),
+    unknown = mdxml_children_to_rd(xml, state),
 
-    paragraph = paste0(""\n\n"", mdxml_children_to_rd(xml, tag)),
+    paragraph = paste0(""\n\n"", mdxml_children_to_rd(xml, state)),
     text = escape_comment(xml_text(xml)),
-    emph = paste0(""\\emph{"", mdxml_children_to_rd(xml, tag), ""}""),
-    strong = paste0(""\\strong{"", mdxml_children_to_rd(xml, tag), ""}""),
+    emph = paste0(""\\emph{"", mdxml_children_to_rd(xml, state), ""}""),
+    strong = paste0(""\\strong{"", mdxml_children_to_rd(xml, state), ""}""),
     softbreak = ""\n"",
     linebreak = ""\n"",
 
-    code = mdxml_code(xml, tag),
+    code = mdxml_code(xml, state),
     code_block = paste0(""\\preformatted{"", escape_verb(xml_text(xml)), ""}""),
 
-    list = mdxml_list(xml, tag),
-    item = mdxml_item(xml, tag),
+    list = mdxml_list(xml, state),
+    item = mdxml_item(xml, state),
     link = mdxml_link(xml),
     image = mdxml_image(xml),
 
+    # Only supported when including Rmds
+    heading = mdxml_heading(xml, state),
+
     # Not supported
-    heading = mdxml_unsupported(xml, tag, ""markdown headings""),
-    block_quote = mdxml_unsupported(xml, tag, ""block quotes""),
-    hrule = mdxml_unsupported(xml, tag, ""horizontal rules""),
-    html_inline = mdxml_unsupported(xml, tag, ""inline HTML""),
-    mdxml_unknown(xml, tag)
+    block_quote = mdxml_unsupported(xml, state$tag, ""block quotes""),
+    hrule = mdxml_unsupported(xml, state$tag, ""horizontal rules""),
+    html_inline = mdxml_unsupported(xml, state$tag, ""inline HTML""),
+    mdxml_unknown(xml, state$tag)
   )
 }
 
@@ -99,28 +112,28 @@ escape_verb <- function(x) {
 }
 
 # A list, either bulleted or numbered
-mdxml_list <- function(xml, tag) {
+mdxml_list <- function(xml, state) {
   type <- xml_attr(xml, ""type"")
   if (type == ""ordered"") {
-    paste0(""\n\\enumerate{"", mdxml_children_to_rd(xml, tag), ""\n}"")
+    paste0(""\n\\enumerate{"", mdxml_children_to_rd(xml, state), ""\n}"")
   } else {
-    paste0(""\n\\itemize{"", mdxml_children_to_rd(xml, tag), ""\n}"")
+    paste0(""\n\\itemize{"", mdxml_children_to_rd(xml, state), ""\n}"")
   }
 }
 
-mdxml_item <- function(xml, tag) {
+mdxml_item <- function(xml, state) {
   ## A single item within a list. We remove the first paragraph
   ## tag, to avoid an empty line at the beginning of the first item.
   children <- xml_children(xml)
   if (length(children) == 0) {
     cnts <- """"
   } else if (xml_name(children[[1]]) == ""paragraph"") {
     cnts <- paste0(
-      mdxml_children_to_rd(children[[1]], tag),
-      paste0(map_chr(children[-1], mdxml_node_to_rd, tag), collapse = """")
+      mdxml_children_to_rd(children[[1]], state),
+      paste0(map_chr(children[-1], mdxml_node_to_rd, state), collapse = """")
     )
   } else {
-    cnts <- mdxml_children_to_rd(xml, tag)
+    cnts <- mdxml_children_to_rd(xml, state)
   }
   paste0(""\n\\item "", cnts)
 }
@@ -159,3 +172,31 @@ mdxml_image = function(xml) {
 escape_comment <- function(x) {
   gsub(""%"", ""\\%"", x, fixed = TRUE)
 }
+
+mdxml_heading <- function(xml, state) {
+  if (state$tag$tag != ""@includeRmd"") {
+    return(mdxml_unsupported(xml, state$tag, ""markdown headings""))
+  }
+  level <- xml_attr(xml, ""level"")
+  head <- paste0(
+    mdxml_close_sections(state, level),
+    ""\n"",
+    if (level == 1) paste0(state$section_tag, ""\\section{""),
+    if (level > 1) ""\\subsection{"",
+    xml_text(xml),
+    ""}{"")
+  state$section <- c(state$section, level)
+  head
+}
+
+#' @importFrom utils head tail
+
+mdxml_close_sections <- function(state, upto = 1L) {
+  hmy <- 0L
+  while (length(state$section) && tail(state$section, 1) >= upto) {
+    hmy <- hmy + 1L
+    state$section <- head(state$section, -1L)
+  }
+
+  paste0(rep(""\n}\n"", hmy), collapse = """")
+}

---FILE: R/rd-include-rmd.R---
@@ -0,0 +1,59 @@
+
+block_include_rmd <- function(tag, block, base_path) {
+  rmd <- tag$val
+  stopifnot(is.character(rmd), length(rmd) == 1, !is.na(rmd))
+
+  rmd_path <- tempfile(fileext = "".Rmd"")
+  md_path <- tempfile(fileext = "".md"")
+  on.exit(unlink(c(rmd_path, md_path), recursive = TRUE), add = TRUE)
+
+  wd <- getwd()
+  setwd(base_path)
+  on.exit(setwd(wd), add = TRUE)
+
+  # This will create an absolute path
+  rmd <- normalizePath(rmd)
+
+  cache_path <- paste0(sub(""\\.Rmd$"", """", rmd), ""_cache/"")
+  fig_path <- file.path(dirname(rmd), ""figure/"")
+  linkrefs <- rmd_linkrefs_from_file(rmd)
+  opts <- c(
+    root.dir = dirname(rmd),
+    cache.path = cache_path,
+    fig.path = fig_path,
+    child = rmd
+  )
+  optss <- paste0(names(opts), ""="", encodeString(opts, quote = '""'))
+  txt <- sprintf(
+    ""```{r %s}\n```\n\n%s\n"",
+    paste(optss, collapse = "",""),
+    linkrefs
+  )
+  cat(txt, file = rmd_path)
+
+  rmarkdown::render(
+    rmd_path,
+    output_format = rmarkdown::github_document(),
+    output_file = md_path,
+    quiet = TRUE
+  )
+
+  rmd_eval_rd(md_path, tag)
+}
+
+rmd_linkrefs_from_file <- function(path) {
+  lines <- read_lines(path)
+  txt <- paste(lines, collapse = ""\n"")
+  paste(get_md_linkrefs(txt), collapse = ""\n"")
+}
+
+rmd_eval_rd <- function(path, tag) {
+  mdtxt <- paste(read_lines(path), collapse = ""\n"")
+  mdesc <- add_linkrefs_to_md(mdtxt)
+  mdx <- commonmark::markdown_xml(mdesc, hardbreaks = TRUE)
+  mdxml <- xml2::read_xml(mdx)
+  state <- new.env(parent = emptyenv())
+  state$tag <- tag
+  rd <- mdxml_children_to_rd_top(mdxml, state = state)
+  rd
+}

---FILE: R/rd.R---
@@ -51,6 +51,7 @@ roclet_tags.roclet_rd <- function(x) {
     family = tag_value,
     field = tag_name_description,
     format = tag_markdown,
+    includeRmd = tag_value,
     inherit = tag_inherit,
     inheritParams = tag_value,
     inheritDotParams = tag_two_part(""source"", ""args"", required = FALSE),
@@ -142,6 +143,7 @@ block_to_rd <- function(block, base_path, env, global_options = list()) {
   topic_add_backref(rd, block)
   topic_add_doc_type(rd, block)
   topic_add_eval_rd(rd, block, env)
+  topic_add_include_rmd(rd, block, base_path)
   topic_add_examples(rd, block, base_path)
   topic_add_fields(rd, block)
   topic_add_inherit(rd, block)
@@ -404,6 +406,29 @@ topic_add_eval_rd <- function(topic, block, env) {
   }
 }
 
+topic_add_include_rmd <- function(topic, block, base_path) {
+  rmds <- block_tags(block, ""includeRmd"")
+
+  for (rmd in rmds) {
+    tag <- roxy_tag(
+      ""@includeRmd"",
+      rmd,
+      attr(block, ""filename""),
+      attr(block, ""location"")[[1]]
+    )
+    if (!is_installed(""rmarkdown"")) {
+      roxy_tag_warning(tag, ""Needs the rmarkdown package"")
+    }
+    out <- block_include_rmd(tag, block, base_path)
+    if (!is.null(out$main)) {
+      topic$add_simple_field(""details"", out$main)
+    }
+    lapply(out$sections, function(s) {
+      topic$add_simple_field(""rawRd"", s)
+    })
+  }
+}
+
 topic_add_sections <- function(topic, block) {
   sections <- block_tags(block, ""section"")
 

---FILE: R/utils.R---
@@ -167,6 +167,13 @@ pkg_env <- function() {
   env
 }
 
+uuid <- function(nchar = 8) {
+  paste(
+    sample(c(letters, LETTERS, 0:9), nchar, replace = TRUE),
+    collapse = """"
+  )
+}
+
 # quoting -----------------------------------------------------------------
 is_parseable <- function(x) map_lgl(x, can_parse)
 auto_backtick <- function(x) {

---FILE: man/rd_roclet.Rd---
@@ -17,6 +17,7 @@
 \alias{@family}
 \alias{@field}
 \alias{@format}
+\alias{@includeRmd}
 \alias{@inherit}
 \alias{@inheritParams}
 \alias{@inheritDotParams}

---FILE: man/roxygen2-package.Rd---
@@ -37,6 +37,7 @@ Useful links:
 Authors:
 \itemize{
   \item Peter Danenberg \email{pcd@roxygen.org} [copyright holder]
+  \item G치bor Cs치rdi \email{csardi.gabor@gmail.com}
   \item Manuel Eugster [copyright holder]
 }
 

---FILE: tests/testthat/helper-test.R---
@@ -3,3 +3,11 @@ expect_equivalent_rd <- function(out1, out2) {
   out2$fields$backref <- NULL
   expect_equal(out1, out2)
 }
+
+expect_equal_strings <- function(s1, s2, ignore_ws = TRUE) {
+  if (ignore_ws) {
+    s1 <- gsub(""\\s"", """", s1, perl = TRUE)
+    s2 <- gsub(""\\s"", """", s2, perl = TRUE)
+  }
+  expect_equal(s1, s2)
+}

---FILE: tests/testthat/test-rd-includermd.R---
@@ -0,0 +1,139 @@
+test_that(""markdown file can be included"", {
+  skip_if_not(rmarkdown::pandoc_available())
+
+  tmp <- tempfile(fileext = "".md"")
+  on.exit(unlink(tmp, recursive = TRUE), add = TRUE)
+  cat(""List:\n\n* item1\n* item2\n\nInline `code` and _emphasis_.\n"",
+      file = tmp)
+  rox <- sprintf(""
+    #' Title
+    #' @includeRmd %s
+    #' @name foobar
+    NULL"", tmp)
+  out1 <- roc_proc_text(rd_roclet(), rox)[[1]]
+  out1$fields$details$values <- str_trim(out1$fields$details$values)
+  out2 <- roc_proc_text(rd_roclet(), ""
+    #' @details
+    #'
+    #'
+    #' List:
+    #' \\itemize{
+    #' \\item item1
+    #' \\item item2
+    #' }
+    #'
+    #' Inline \\code{code} and \\emph{emphasis}.
+    #' @title Title
+    #' @name foobar
+    NULL"")[[1]]
+  expect_equivalent_rd(out1, out2)
+})
+
+test_that(""markdown with headers"", {
+  skip_if_not(rmarkdown::pandoc_available())
+
+  tmp <- tempfile(fileext = "".md"")
+  on.exit(unlink(tmp, recursive = TRUE), add = TRUE)
+  cat(sep = ""\n"", file = tmp,
+    ""Text at the front"",
+    """",
+    ""# Header 1"",
+    """",
+    ""## Header 2"",
+    """",
+    ""Text"",
+    """",
+    ""## Header 22"",
+    """",
+    ""# Header 11"",
+    """",
+    ""Text again"")
+  rox <- sprintf(""
+    #' Title
+    #' @includeRmd %s
+    #' @name foobar
+    NULL"", tmp)
+  out1 <- roc_proc_text(rd_roclet(), rox)[[1]]
+  exp_details <- ""Text at the front""
+  exp_secs <- c(paste0(
+    ""\\section{Header 1}{"",
+    ""\\subsection{Header 2}{Text}"",
+    ""\\subsection{Header 22}{}"",
+    ""}""),
+    ""\\section{Header 11}{Text again}""
+  )
+  expect_equal_strings(out1$fields$details$values, exp_details)
+  expect_equal_strings(out1$fields$rawRd$values, exp_secs)
+})
+
+test_that(""subsection within details"", {
+  skip_if_not(rmarkdown::pandoc_available())
+
+  tmp <- tempfile(fileext = "".md"")
+  on.exit(unlink(tmp, recursive = TRUE), add = TRUE)
+  cat(sep = ""\n"", file = tmp,
+    ""Text at the front"",
+    """",
+    """",
+    ""## Subsection in details"",
+    """",
+    ""Some subsection text"")
+  rox <- sprintf(""
+    #' Title
+    #' @includeRmd %s
+    #' @name foobar
+    NULL"", tmp)
+  out1 <- roc_proc_text(rd_roclet(), rox)[[1]]
+  exp_details <- paste0(
+    ""Text at the front"",
+    ""\\subsection{Subsection in details}{ Some subsection text }""
+  )
+  expect_equal_strings(out1$fields$details$values, exp_details)
+})
+
+test_that(""links to functions"", {
+  skip_if_not(rmarkdown::pandoc_available())
+
+  tmp <- tempfile(fileext = "".md"")
+  on.exit(unlink(tmp, recursive = TRUE), add = TRUE)
+  cat(sep = ""\n"", file = tmp,
+    ""This is a link: [roxygenize()]."",
+    ""Another one: [stringr::str_length()]""
+  )
+  rox <- sprintf(""
+    #' Title
+    #' @includeRmd %s
+    #' @name foobar
+    NULL"", tmp)
+  out1 <- roc_proc_text(rd_roclet(), rox)[[1]]
+  exp_details <- paste0(
+    ""This is a link: \\code{\\link[=roxygenize]{roxygenize()}}."",
+    ""Another one:\n\\code{\\link[stringr:str_length]{stringr::str_length()}}""
+  )
+  expect_equal_strings(out1$fields$details$values, exp_details)
+})
+
+test_that(""links to functions, with anchors"", {
+  skip_if_not(rmarkdown::pandoc_available())
+
+  tmp <- tempfile(fileext = "".md"")
+  on.exit(unlink(tmp, recursive = TRUE), add = TRUE)
+  cat(sep = ""\n"", file = tmp,
+    ""This is a link: [roxygenize()]."",
+    ""Another one: [stringr::str_length()]"",
+    """",
+    ""[roxygenize()]: https://roxygen2.r-lib.org/reference/roxygenize.html"",
+    ""[stringr::str_length()]: https://stringr.tidyverse.org/reference/str_length.html""
+  )
+  rox <- sprintf(""
+    #' Title
+    #' @includeRmd %s
+    #' @name foobar
+    NULL"", tmp)
+  out1 <- roc_proc_text(rd_roclet(), rox)[[1]]
+  exp_details <- paste0(
+    ""This is a link: \\code{\\link[=roxygenize]{roxygenize()}}."",
+    ""Another one:\n\\code{\\link[stringr:str_length]{stringr::str_length()}}""
+  )
+  expect_equal_strings(out1$fields$details$values, exp_details)
+})

---FILE: vignettes/rd.Rmd---
@@ -469,6 +469,55 @@ You can make templates more flexible by using template variables defined with `@
 
 Note that templates are parsed a little differently to regular blocks, so you'll need to explicitly set the title, description and details with `@title`, `@description` and `@details`.
 
+## Including external `.Rmd`/`.md` files
+
+Starting from roxygen2 7.0.0, you can use `@includeRmd path/to/file.Rmdname` to include an external `.Rmd` or `.md` document into a manual page (the path is relative package root directory). You can include the same file in multiple documentation files, and for the first time, share content across documentation and vignettes.
+
+### Sections
+
+`@includeRmd` supports headings in the external Rmd. The rules are as follows:
+
+*   All text before the first level 1 heading (i.e. `#`), is added to the 
+    details section.
+
+*   Level 1 headings generate their own section (`\section{}`).
+
+*   Other headings (level 2 and so on) create subsections (`\subsection{}`)
+    within the section they appear in.
+
+All content in the Rmd file will go either in the details or in new top level sections. It is currently not possible to document function arguments, return values, etc. in external Rmd documents.
+
+### Links
+
+The included Rmd file can have roxygen markdown style links to other help topics. E.g. `[roxygen2::roxygenize()]` will link to the manual page of the `roxygenize` function in roxygen2. See `vignette(""rd-formatting.Rmd"")` for details.
+
+### Caching and figures
+
+`@includeRmd` tries to set up knits to support caching in the Rmd file. It sets the cache path to the default knitr cache path of the included Rmd file (i.e. `foo/bar/file_cache/` for `foo/bar/file.Rmd`), so if you do not change the cache path within the Rmd itself, then everything should work out of the box. You should add these cache paths to `.gitignore` and `.Rbuildignore`.
+
+`@includeRmd` also sets the knitr figure path of the (`fig.path`) to the default figure path of the included Rmd. Overriding this default is unlikely to work.
+
+### Sharing text between vignettes and the manual
+
+`@includeRmd` helps avoiding repetition, as you can use the same `.Rmd` or `.md`  document in the manual and also in the `README.md` file or in vignettes. One way to include an Rmd file in another one is to use child documents:
+
+````
+```{r child = ""common.Rmd""}`r ''`
+```
+````
+
+If the Rmd file has links to other help topics, then some care is needed, as those links while not work in Rmd files. A workaround is to specify external HTML links for them. These external locations will _not_ be used for `@includeRmd`, which always links them to the help topics in the manual. Example:
+
+```
+See also the [roxygen2::roxygenize()] function.
+
+[roxygen2::roxygenize()]: https://roxygen2.r-lib.org/reference/roxygenize.html
+```
+
+This example will link to the supplied URLs in html / markdown files and it will link to the `roxygenize` help topic in the manual.
+
+Note that if you add external link targets like these, then roxygen will emit a warning about these link references being defined multiple times (once externally, and once to the help topic). This warning originates in pandoc, and it is harmless.
+
 ## Other tags
 
 ### Indexing"
r-lib,roxygen2,e44341300768daa20729a473685a1da29c804745,Hadley Wickham,h.wickham@gmail.com,2019-09-12T19:21:14Z,Hadley Wickham,h.wickham@gmail.com,2019-09-12T19:21:14Z,"Trim white space off RoxygenNote

Fixes #802",NEWS.md;R/safety.R,False,True,True,False,5,1,6,"---FILE: NEWS.md---
@@ -1,5 +1,9 @@
 # roxygen2 (development version)
 
+* White space is automatically trimmed off the `RoxygenNote` field when 
+  comparing the installed version of roxygen2 to the version used to 
+  generate the documentation (#802).
+
 * New `@exportS3Method` tag allows you to generate `S3method()` namespace
   directives (note the different in capitalisation) (#796). Its primary use is 
   for ""delayed"" method registration which allows you to define methods for 

---FILE: R/safety.R---
@@ -44,7 +44,7 @@ update_roxygen_version <- function(base_path) {
   desc_path <- file.path(base_path, ""DESCRIPTION"")
 
   cur <- as.character(utils::packageVersion(""roxygen2""))
-  prev <- desc::desc_get(""RoxygenNote"", file = desc_path)[[1]]
+  prev <- stringr::str_trim(desc::desc_get(""RoxygenNote"", file = desc_path)[[1]])
 
   if (!is.na(cur) && !is.na(prev) && package_version(cur) < package_version(prev)) {
     warning(""Version of roxygen2 last used with this package is "", prev, "". "","
r-lib,roxygen2,f6632fff25326158b5c8c00c2946d4abec95cdb3,Hadley Wickham,h.wickham@gmail.com,2019-09-12T18:54:48Z,GitHub,noreply@github.com,2019-09-12T18:54:48Z,"Add authors and source to inherits (#895)

Fixes #740",R/rd-inherit.R;R/tag.R;tests/testthat/test-rd-inherit.R,False,True,True,False,9,2,11,"---FILE: R/rd-inherit.R---
@@ -11,6 +11,8 @@ topics_process_inherit <- function(topics, env) {
   topics$topo_apply(inherits(""seealso""), inherit_field, ""seealso"")
   topics$topo_apply(inherits(""references""), inherit_field, ""references"")
   topics$topo_apply(inherits(""examples""), inherit_field, ""examples"")
+  topics$topo_apply(inherits(""author""), inherit_field, ""author"")
+  topics$topo_apply(inherits(""source""), inherit_field, ""source"")
 
   # First inherit individual sections, then all sections.
   topics$topo_apply(function(x) x$inherits_section_from(), inherit_section)

---FILE: R/tag.R---
@@ -78,8 +78,9 @@ tag_inherit <- function(x) {
     pieces <- str_split(str_trim(x$val), ""\\s+"")[[1]]
     fields <- pieces[-1]
 
+    # Also recorded in `rd.Rmd`
     all <- c(""params"", ""return"", ""title"", ""description"", ""details"", ""seealso"",
-      ""sections"", ""references"", ""examples"")
+      ""sections"", ""references"", ""examples"", ""author"", ""source"")
     if (length(fields) == 0) {
       fields <- all
     } else {

---FILE: tests/testthat/test-rd-inherit.R---
@@ -39,7 +39,7 @@ test_that(""no options gives default values"", {
     block$inherit$fields,
     c(
       ""params"", ""return"", ""title"", ""description"", ""details"", ""seealso"",
-      ""sections"", ""references"", ""examples""
+      ""sections"", ""references"", ""examples"", ""author"", ""source""
     )
   )
 })
@@ -462,6 +462,8 @@ test_that(""can inherit all from single function"", {
     #'
     #' @param x x
     #' @param y y
+    #' @author Hadley
+    #' @source my mind
     #' @examples
     #' x <- 1
     foo <- function(x, y) {}
@@ -476,6 +478,8 @@ test_that(""can inherit all from single function"", {
   expect_equal(out$get_field(""description"")$values, ""Description"")
   expect_equal(out$get_field(""details"")$values, ""Details"")
   expect_equal(out$get_field(""examples"")$values, rd(""x <- 1""))
+  expect_equal(out$get_field(""author"")$values, ""Hadley"")
+  expect_equal(out$get_field(""source"")$values, ""my mind"")
 })
 
 "
r-lib,roxygen2,843432ddc05bc2dabc9b5b22c1ae7de507a00508,Hadley Wickham,h.wickham@gmail.com,2019-09-12T16:21:26Z,Hadley Wickham,h.wickham@gmail.com,2019-09-12T16:21:26Z,"Implement @exportS3Method

This allows you to generate arbitary S3method() directives, which is particularly important for delayed method registration.

Fixes #796",NAMESPACE;NEWS.md;R/namespace.R;R/utils.R;man/namespace_roclet.Rd;tests/testthat/test-namespace.R,False,True,True,False,97,26,123,"---FILE: NAMESPACE---
@@ -1,7 +1,7 @@
 # Generated by roxygen2: do not edit by hand
 
 S3method(c,rd)
-S3method(default_export,""NULL"")
+S3method(default_export,NULL)
 S3method(default_export,default)
 S3method(default_export,rcclass)
 S3method(default_export,s3method)

---FILE: NEWS.md---
@@ -1,5 +1,32 @@
 # roxygen2 (development version)
 
+* New `@exportS3Method` tag allows you to generate `S3method()` namespace
+  directives (note the different in capitalisation) (#796). Its primary use is 
+  for ""delayed"" method registration which allows you to define methods for 
+  generics found in suggested packages. This is only available in R 3.6 and 
+  greater, and looks like this:
+    
+    ```R
+    #' @exportS3Method package::generic
+    generic.foo <- function(x, ...) {
+    
+    }
+    ```
+    
+    (See [`vctrs::s3_register()`](https://vctrs.r-lib.org/reference/s3_register.html)
+    you need a version that works for earlier versions of R).
+    
+    You can also use it to generate arbitrary `S3method()` directions by 
+    providing two values:
+    
+    ```R
+    #' @exportS3Method generic class
+    NULL
+    ```
+
+* `namespace_roclet()` now uses `` ` `` to escape non-syntactic function 
+  names, rather than `'`.
+
 * Support `@S3method` has been removed. It was deprecated in roxygen2 4.0.0
   released 2014-05-02, over 5 years ago.
 

---FILE: R/namespace.R---
@@ -13,6 +13,7 @@ ns_tags <- c(
   ""export"",
   ""exportClass"",
   ""exportMethod"",
+  ""exportS3Method"",
   ""exportPattern""
 )
 
@@ -88,6 +89,7 @@ roclet_tags.roclet_namespace <- function(x) {
     evalNamespace = tag_code,
     export = tag_words_line,
     exportClass = tag_words(1),
+    exportS3Method = tag_words(min = 0, max = 2),
     exportMethod = tag_words(1),
     exportPattern = tag_words(1),
     import = tag_words(1),
@@ -167,6 +169,29 @@ ns_import            <- function(tag, block) one_per_line(""import"", tag)
 ns_importFrom        <- function(tag, block) repeat_first(""importFrom"", tag)
 ns_importClassesFrom <- function(tag, block) repeat_first(""importClassesFrom"", tag)
 ns_importMethodsFrom <- function(tag, block) repeat_first(""importMethodsFrom"", tag)
+
+ns_exportS3Method    <- function(tag, block) {
+  obj <- attr(block, ""object"")
+
+  if (length(tag) < 2 && !inherits(obj, ""s3method"")) {
+    block_warning(block,
+      ""`@exportS3method` and `@exportS3method generic` must be used with an S3 method""
+    )
+    return()
+  }
+
+  if (identical(tag, """")) {
+    method <- attr(obj$value, ""s3method"")
+  } else if (length(tag) == 1) {
+    method <- c(tag, attr(obj$value, ""s3method"")[[2]])
+  } else {
+    method <- tag
+  }
+
+  export_s3_method(method)
+}
+
+
 ns_useDynLib         <- function(tag, block) {
   if (length(tag) == 1) {
     return(paste0(""useDynLib("", auto_quote(tag), "")""))
@@ -191,15 +216,15 @@ export           <- function(x) one_per_line(""export"", x)
 export_class     <- function(x) one_per_line(""exportClasses"", x)
 export_s4_method <- function(x) one_per_line(""exportMethods"", x)
 export_s3_method <- function(x) {
-  args <- paste0(auto_quote(x), collapse = "","")
+  args <- paste0(auto_backtick(x), collapse = "","")
   paste0(""S3method("", args, "")"")
 }
 
 # Helpers -----------------------------------------------------------------
 
 one_per_line <- function(name, x) {
-  paste0(name, ""("", auto_quote(x), "")"")
+  paste0(name, ""("", auto_backtick(x), "")"")
 }
 repeat_first <- function(name, x) {
-  paste0(name, ""("", auto_quote(x[1]), "","", auto_quote(x[-1]), "")"")
+  paste0(name, ""("", auto_backtick(x[1]), "","", auto_backtick(x[-1]), "")"")
 }

---FILE: R/utils.R---
@@ -168,15 +168,15 @@ pkg_env <- function() {
 }
 
 # quoting -----------------------------------------------------------------
-is_syntactic <- function(x) make.names(x) == x
-has_quotes <- function(x) str_detect(x, ""^('|\"").*\\1$"")
-
+is_parseable <- function(x) map_lgl(x, can_parse)
 auto_backtick <- function(x) {
-  needs_backtick <- !is_syntactic(x)
+  needs_backtick <- !is_parseable(x)
   x[needs_backtick] <- encodeString(x[needs_backtick], quote = ""`"")
   x
 }
 
+is_syntactic <- function(x) make.names(x) == x
+has_quotes <- function(x) str_detect(x, ""^('|\"").*\\1$"")
 auto_quote <- function(x) {
   needs_quotes <- !has_quotes(x) & !is_syntactic(x)
   x[needs_quotes] <- encodeString(x[needs_quotes], quote = '""')

---FILE: man/namespace_roclet.Rd---
@@ -5,6 +5,7 @@
 \alias{@evalNamespace}
 \alias{@export}
 \alias{@exportClass}
+\alias{@exportS3Method}
 \alias{@exportMethod}
 \alias{@exportPattern}
 \alias{@import}

---FILE: tests/testthat/test-namespace.R---
@@ -1,26 +1,14 @@
 # @export -----------------------------------------------------------------
 
-test_that(""export detects object name"", {
+test_that(""export quote object name appropriate"", {
   out <- roc_proc_text(namespace_roclet(), ""#' @export\na <- function(){}"")
   expect_equal(out, 'export(a)')
-})
 
-test_that(""export escapes quotes name if needed"", {
-  out <- roc_proc_text(namespace_roclet(), ""#' @export\n'a<-' <- function(){}"")
-  expect_equal(out, 'export(""a<-"")')
-})
+  out <- roc_proc_text(namespace_roclet(), ""#' @export\n`+` <- function(){}"")
+  expect_equal(out, 'export(`+`)')
 
-test_that(""export escapes tricky names"", {
-  out <- roc_proc_text(namespace_roclet(), ""#' @export\n`%||%` <- function(){}"")
-  expect_equal(out, 'export(""%||%"")')
-  out <- roc_proc_text(namespace_roclet(), ""#' @export\n`%'%` <- function(){}"")
-  expect_equal(out, 'export(""%\'%"")')
-  out <- roc_proc_text(namespace_roclet(), ""#' @export\n`%\""%` <- function(){}"")
-  expect_equal(out, 'export(""%\\""%"")')
-  out <- roc_proc_text(namespace_roclet(), ""#' @export\n`%\""%` <- function(){}"")
-  expect_equal(out, 'export(""%\\""%"")')
-  out <- roc_proc_text(namespace_roclet(), ""#' @export\n`%\\\\%` <- function(){}"")
-  expect_equal(out, 'export(""%\\\\%"")')
+  out <- roc_proc_text(namespace_roclet(), ""#' @export\n`\\`` <- function(){}"")
+  expect_equal(out, 'export(`\\``)')
 })
 
 test_that(""export parameter overrides default"", {
@@ -63,6 +51,36 @@ test_that(""export detects S3 method"", {
   expect_equal(out, 'S3method(mean,foo)')
 })
 
+test_that(""@exportS3method generatedsS3method()"", {
+  out <- roc_proc_text(namespace_roclet(),
+    ""#' @exportS3Method
+    mean.foo <- function(x) 'foo'
+  "")
+  expect_equal(out, ""S3method(mean,foo)"")
+
+  out <- roc_proc_text(namespace_roclet(),
+    ""#' @exportS3Method base::mean
+    mean.foo <- function(x) 'foo'
+  "")
+  expect_equal(out, ""S3method(base::mean,foo)"")
+
+  expect_warning(
+    roc_proc_text(namespace_roclet(),
+      ""#' @exportS3Method base::mean
+      NULL
+    ""),
+    ""an S3 method""
+  )
+
+  out <- roc_proc_text(namespace_roclet(),
+    ""#' @exportS3Method base::mean foo
+    NULL
+  "")
+  expect_equal(out, ""S3method(base::mean,foo)"")
+
+
+})
+
 test_that(""exportClass overrides default class name"", {
   out <- roc_proc_text(namespace_roclet(), ""#' @exportClass b\nsetClass('a')"")
   expect_equal(out, 'exportClasses(b)')
@@ -80,7 +98,7 @@ test_that(""export method escapes if needed"", {
     setGeneric('x<-', function(x, value) standardGeneric('x<-'))
     #' @export\n
     setMethod('x<-', 'a', function(x, value) value)"")
-  expect_equal(out, 'exportMethods(""x<-"")')
+  expect_equal(out, 'exportMethods(`x<-`)')
 })
 
 test_that(""export uses name if no object present"", {"
r-lib,roxygen2,40f848bb7089a4c93dc04c869a1de0754c207ed9,Hadley Wickham,h.wickham@gmail.com,2019-09-12T14:41:35Z,GitHub,noreply@github.com,2019-09-12T14:41:35Z,"Escape Rd comments in markdown (#904)

Providing detailed message when you upgrade

Fixes #879",DESCRIPTION;NEWS.md;R/markdown-escaping.R;R/markdown-link.R;R/markdown.R;R/safety.R;man/double_escape_md.Rd;tests/testthat/test-markdown.R,False,True,True,False,67,35,102,"---FILE: DESCRIPTION---
@@ -1,6 +1,6 @@
 Package: roxygen2
 Title: In-Line Documentation for R
-Version: 6.1.1.9000
+Version: 6.1.99.9000
 Authors@R: 
     c(person(given = ""Hadley"",
              family = ""Wickham"",
@@ -55,4 +55,4 @@ VignetteBuilder:
     knitr
 Encoding: UTF-8
 Roxygen: list(markdown = TRUE)
-RoxygenNote: 6.1.1.9000
+RoxygenNote: 6.1.99.9000

---FILE: NEWS.md---
@@ -1,5 +1,9 @@
 # roxygen2 (development version)
 
+* Rd comments (`%`) are automatically escaped in markdown text. This is 
+  a backward incompatible check that will require that you replace
+  existing uses of `\%` with `%` (#879).
+
 * `@describeIn` can now be used with any combination of function types 
   (#666, #848).
 

---FILE: R/markdown-escaping.R---
@@ -220,15 +220,29 @@ make_random_string <- function(length = 32) {
   )
 }
 
-#' Escape \\% and \\$ and \\_ once more, because commonmark
-#' removes the escaping. We do this everywhere currently.
+#' Check markdown escaping
+#'
+#' This is a regression test for Markdown escaping.
+#'
+#' @details
+#' Each of the following bullets should look the same when rendered:
+#'
+#' * Double escapes: \\, \\%, \\$, \\_
+#' * Backticks: `\`, `\%`, `\$`, `\_`
+#' * `\verb{}`: \verb{\\}, \verb{\\%}, \verb{\$}, \verb{\_}
+#'
+#' \[ this isn't a link \]
+#' \\[ neither is this \\]
 #'
 #' @param text Input text.
 #' @return Double-escaped text.
+#' @keywords internal
 
 double_escape_md <- function(text) {
-  text <- gsub(""\\%"", ""\\\\%"", text, fixed = TRUE)
-  text <- gsub(""\\_"", ""\\\\_"", text, fixed = TRUE)
-  text <- gsub(""\\$"", ""\\\\$"", text, fixed = TRUE)
+  text <- gsub(""\\"", ""\\\\"", text, fixed = TRUE)
+
+  # De-dup escaping used to avoid [] creating a link
+  text <- gsub(""\\\\["", ""\\["", text, fixed = TRUE)
+  text <- gsub(""\\\\]"", ""\\]"", text, fixed = TRUE)
   text
 }

---FILE: R/markdown-link.R---
@@ -137,7 +137,7 @@ parse_link <- function(destination, contents) {
     )
 
   } else {
-    contents <- gsub(""%"", ""\\\\%"", mdxml_link_text(contents))
+    contents <- mdxml_link_text(contents)
 
     list(
       paste0(

---FILE: R/markdown.R---
@@ -39,7 +39,7 @@ mdxml_node_to_rd <- function(xml, tag) {
     unknown = mdxml_children_to_rd(xml, tag),
 
     paragraph = paste0(""\n\n"", mdxml_children_to_rd(xml, tag)),
-    text = xml_text(xml),
+    text = escape_comment(xml_text(xml)),
     emph = paste0(""\\emph{"", mdxml_children_to_rd(xml, tag), ""}""),
     strong = paste0(""\\strong{"", mdxml_children_to_rd(xml, tag), ""}""),
     softbreak = ""\n"",
@@ -64,11 +64,11 @@ mdxml_node_to_rd <- function(xml, tag) {
 
 mdxml_unknown <- function(xml, tag) {
   roxy_tag_warning(tag, ""Unknown xml node: "", xml_name(xml))
-  xml_text(xml)
+  escape_comment(xml_text(xml))
 }
 mdxml_unsupported <- function(xml, tag, feature) {
   roxy_tag_warning(tag, ""Use of "", feature, "" is not currently supported"")
-  xml_text(xml)
+  escape_comment(xml_text(xml))
 }
 
 mdxml_code <- function(xml, tag) {
@@ -91,7 +91,7 @@ can_parse <- function(x) {
 }
 
 escape_verb <- function(x) {
-  x <- gsub(""\\"", ""\\\\"", x, fixed = TRUE)
+  # Don't need to escape \\ because that's already handled in double_escape_md()
   x <- gsub(""%"", ""\\%"", x, fixed = TRUE)
   x <- gsub(""{"", ""\\{"", x, fixed = TRUE)
   x <- gsub(""}"", ""\\}"", x, fixed = TRUE)
@@ -135,7 +135,7 @@ mdxml_link <- function(xml) {
   if (!is.null(link)) {
     paste0(link, collapse = """")
   } else if (dest == """" || dest == xml_text(xml)) {
-    paste0(""\\url{"", xml_text(xml), ""}"")
+    paste0(""\\url{"", escape_comment(xml_text(xml)), ""}"")
   } else {
     paste0(""\\href{"", dest, ""}{"", mdxml_link_text(contents), ""}"")
   }
@@ -147,11 +147,15 @@ mdxml_link <- function(xml) {
 mdxml_link_text <- function(xml_contents) {
   text <- xml_text(xml_contents)
   text[xml_name(xml_contents) %in% c(""linebreak"", ""softbreak"")] <- "" ""
-  paste0(text, collapse = """")
+  escape_comment(paste0(text, collapse = """"))
 }
 
 mdxml_image = function(xml) {
   dest <- xml_attr(xml, ""destination"")
   title <- xml_attr(xml, ""title"")
   paste0(""\\figure{"", dest, ""}{"", title, ""}"")
 }
+
+escape_comment <- function(x) {
+  gsub(""%"", ""\\%"", x, fixed = TRUE)
+}

---FILE: R/safety.R---
@@ -51,6 +51,21 @@ update_roxygen_version <- function(base_path) {
       "" You only have version "", cur, call. = FALSE, immediate. = TRUE)
   } else if (!identical(cur, prev)) {
     message(""Updating roxygen version in "", desc_path)
+    upgrade_7_0_0(cur)
     desc::desc_set(RoxygenNote = cur, file = desc_path)
   }
 }
+
+upgrade_7_0_0 <- function(cur_version) {
+  if (numeric_version(cur_version) > ""6.1.99"") {
+    return()
+  }
+  rule <- paste0(paste(rep(""-"", options('width')), collapse = """"))
+  inform(c(
+    rule,
+    ""Changes in roxygen2 7.0.0:"",
+    ""* `%` is now escaped automatically in Markdown mode."",
+    ""Please carefully check .Rd files for changes"",
+    rule
+  ))
+}

---FILE: man/double_escape_md.Rd---
@@ -2,8 +2,7 @@
 % Please edit documentation in R/markdown-escaping.R
 \name{double_escape_md}
 \alias{double_escape_md}
-\title{Escape \% and \$ and \_ once more, because commonmark
-removes the escaping. We do this everywhere currently.}
+\title{Check markdown escaping}
 \usage{
 double_escape_md(text)
 }
@@ -14,6 +13,17 @@ double_escape_md(text)
 Double-escaped text.
 }
 \description{
-Escape \% and \$ and \_ once more, because commonmark
-removes the escaping. We do this everywhere currently.
+This is a regression test for Markdown escaping.
 }
+\details{
+Each of the following bullets should look the same when rendered:
+\itemize{
+\item Double escapes: \\, \\\%, \\$, \\_
+\item Backticks: \verb{\\}, \verb{\\\%}, \verb{\\$}, \verb{\\_}
+\item \verb{\verb{}}: \verb{\\}, \verb{\\\%}, \verb{\$}, \verb{\_}
+}
+
+[ this isn't a link ]
+\[ neither is this \]
+}
+\keyword{internal}

---FILE: tests/testthat/test-markdown.R---
@@ -347,23 +347,8 @@ So far so good. \\preformatted{ *these are not
   expect_equal(get_tag(out1, ""description"")[[2]], desc1)
 })
 
-test_that(""% and $ and _ are not unescaped"", {
-  out1 <- roc_proc_text(rd_roclet(), ""
-    #' Title
-    #'
-    #' Description. It has some \\% and \\$ and also \\_.
-    #'
-    #' @param foo Item with \\% characters: \\%. And also \\$ and \\_.
-    foo <- function(foo) {}"")[[1]]
-  out2 <- roc_proc_text(rd_roclet(), ""
-    #' Title
-    #'
-    #' Description. It has some \\% and \\$ and also \\_.
-    #'
-    #' @param foo Item with \\% characters: \\%. And also \\$ and \\_.
-    #' @md
-    foo <- function(foo) {}"")[[1]]
-  expect_equivalent_rd(out1, out2)
+test_that(""% is automatically escaped"", {
+  expect_equal(markdown(""5%""), ""5\\%"")
 })
 
 test_that(""Escaping is kept"", {"
r-lib,roxygen2,805a7ad3ce7411d343bbaeda187fb54a45fe4d30,Hadley Wickham,h.wickham@gmail.com,2019-09-12T14:29:16Z,Hadley Wickham,h.wickham@gmail.com,2019-09-12T14:29:16Z,"Provide `@describeIn` fallback

Fixes #666. Fixes #848.",NEWS.md;R/rd-describe-in.R;tests/testthat/test-rd-describe-in.R;vignettes/rd.Rmd,True,True,True,False,23,6,29,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* `@describeIn` can now be used with any combination of function types 
+  (#666, #848).
+
 * Convert markdown code (``` `` ```) to either `\code{}` or `\verb{}` 
   depending on whether it not it parses as R code. This should make it 
   easier to include arbitrary ""code"" snippets in documentation without

---FILE: R/rd-describe-in.R---
@@ -71,13 +71,10 @@ build_label <- function(src, dest, block) {
     # Label S3 methods in generic with their class
     type <- ""generic""
     label <- attr(src$value, ""s3method"")[2]
-  } else if (dest_type %in% c(""function"", ""data"") && src_type == ""function"") {
-    # Multiple functions in one Rd labelled with function names
+  } else {
+    # Otherwise just fallback to function + topic
     type <- ""function""
     label <- src$topic
-  } else {
-    block_warning(block, ""Don't know how to describe "", src_type, "" in "", dest_type)
-    return(NULL)
   }
 
   list(type = type, label = label)

---FILE: tests/testthat/test-rd-describe-in.R---
@@ -70,6 +70,19 @@ test_that(""Multiple @describeIn generic combined into one"", {
   expect_equal(get_tag(out, ""minidesc"")$desc, c(""A"", ""B""))
 })
 
+
+test_that(""all other combinations fallback to function list"", {
+  out <- roc_proc_text(rd_roclet(), ""
+    #' Generic
+    foo <- function(x) UseMethod('foo')
+
+    #' @describeIn foo related function
+    bar <- function(y) {}
+  "")[[1]]
+
+  expect_equal(get_tag(out, ""minidesc"")$type, ""function"")
+})
+
 test_that(""@describeIn class captures function name"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' Title

---FILE: vignettes/rd.Rmd---
@@ -349,6 +349,8 @@ You can also inherit documentation from functions provided by another package by
 
 You can document multiple functions in the same file by using either `@rdname` or `@describeIn` tag. It뗩 a technique best used with care: documenting too many functions in one place leads to confusion. Use it when all functions have the same (or very similar) arguments.
 
+#### `@describeIn`
+
 `@describeIn` is designed for the most common cases:
 
 * documenting methods in a generic
@@ -370,7 +372,9 @@ foobar.numeric <- function(x) abs(mean(x) - median(x))
 foobar.character <- function(x) paste0(x[1], ""-"", x[length(x)])
 ```
 
-An alternative to `@describeIn` is `@rdname`.  It overrides the default file name generated by roxygen and merges documentation for multiple objects into one file. This gives you complete freedom to combine documentation however you see fit. There are two ways to use `@rdname`. You can add documentation to an existing function:
+#### `@rdname`
+
+`@rdname` is a more general purpose tool. It overrides the default file name generated by roxygen and merges documentation for multiple objects into one file. This gives you complete freedom to combine documentation however you see fit. There are two ways to use `@rdname`. You can add documentation to an existing function:
 
 ```{r}
 #' Basic arithmetic"
r-lib,roxygen2,f952d350d3b8c60788d50700e13b680a833c1204,Hadley Wickham,h.wickham@gmail.com,2019-09-11T21:32:16Z,Hadley Wickham,h.wickham@gmail.com,2019-09-11T21:32:16Z,"Backtick non-syntactic S3 classes

Fixes #906",R/object-usage.R;tests/testthat/test-object-usage.R,False,True,True,False,13,5,18,"---FILE: R/object-usage.R---
@@ -19,7 +19,7 @@ object_usage.s3generic <- object_usage.function
 object_usage.s3method <- function(x) {
   method <- attr(x$value, ""s3method"")
   s3method <- function(name) {
-    build_rd(""\\method{"", name, ""}{"", method[2], ""}"")
+    build_rd(""\\method{"", name, ""}{"", auto_backtick(method[2]), ""}"")
   }
   function_usage(method[1], formals(x$value), s3method)
 }
@@ -30,10 +30,7 @@ object_usage.s4generic <- function(x) {
 
 object_usage.s4method <- function(x) {
   s4method <- function(name) {
-    classes <- as.character(x$value@defined)
-    needs_backtick <- !is.syntactic(classes)
-    classes[needs_backtick] <- paste0(""`"", classes[needs_backtick], ""`"")
-
+    classes <- auto_backtick(as.character(x$value@defined))
     build_rd(""\\S4method{"", name, ""}{"", paste0(classes, collapse = "",""), ""}"")
   }
   function_usage(x$value@generic, formals(x$value), s4method)
@@ -122,3 +119,10 @@ call_to_usage <- function(code, env = pkg_env()) {
   obj <- call_to_object(!!enexpr(code), env)
   gsub(""\u{A0}"", "" "", as.character(object_usage(obj)))
 }
+
+
+auto_backtick <- function(x) {
+  needs_backtick <- !is.syntactic(x)
+  x[needs_backtick] <- paste0(""`"", x[needs_backtick], ""`"")
+  x
+}

---FILE: tests/testthat/test-object-usage.R---
@@ -59,6 +59,10 @@ test_that(""default usage formats S3 methods correctly"", {
     call_to_usage(mean.foo <- function(x) {}),
     ""\\method{mean}{foo}(x)""
   )
+  expect_equal(
+    call_to_usage(mean.function <- function(x) {}),
+    ""\\method{mean}{`function`}(x)""
+  )
   expect_equal(
     call_to_usage(""+.foo"" <- function(x, b) {}),
     ""\\method{+}{foo}(x, b)"""
r-lib,roxygen2,732ec141f491f6ab0e063a266e9fafb7a10c7e7a,Hadley Wickham,h.wickham@gmail.com,2019-09-11T21:20:32Z,GitHub,noreply@github.com,2019-09-11T21:20:32Z,"Conditionally generate \verb{} instead of \code{} (#903)

Fixes #654",NEWS.md;R/markdown.R;man/markdown-internals.Rd;man/parse_package.Rd;man/roclet.Rd;man/update_collate.Rd;man/vignette_roclet.Rd;tests/testthat/test-markdown-link.R;tests/testthat/test-markdown-state.R;tests/testthat/test-markdown.R,False,True,True,False,73,38,111,"---FILE: NEWS.md---
@@ -1,5 +1,10 @@
 # roxygen2 (development version)
 
+* Convert markdown code (``` `` ```) to either `\code{}` or `\verb{}` 
+  depending on whether it not it parses as R code. This should make it 
+  easier to include arbitrary ""code"" snippets in documentation without
+  causing Rd failures (#654).
+
 * Inherting for a function with no arguments no longer throws a confusing
   error message (#898)
 

---FILE: R/markdown.R---
@@ -38,15 +38,16 @@ mdxml_node_to_rd <- function(xml, tag) {
     document = ,
     unknown = mdxml_children_to_rd(xml, tag),
 
-    code_block = paste0(""\\preformatted{"", gsub(""%"", ""\\\\%"", xml_text(xml)), ""}""),
     paragraph = paste0(""\n\n"", mdxml_children_to_rd(xml, tag)),
     text = xml_text(xml),
-    code = paste0(""\\code{"", gsub(""%"", ""\\\\%"", xml_text(xml)), ""}""),
     emph = paste0(""\\emph{"", mdxml_children_to_rd(xml, tag), ""}""),
     strong = paste0(""\\strong{"", mdxml_children_to_rd(xml, tag), ""}""),
     softbreak = ""\n"",
     linebreak = ""\n"",
 
+    code = mdxml_code(xml, tag),
+    code_block = paste0(""\\preformatted{"", escape_verb(xml_text(xml)), ""}""),
+
     list = mdxml_list(xml, tag),
     item = mdxml_item(xml, tag),
     link = mdxml_link(xml),
@@ -70,6 +71,32 @@ mdxml_unsupported <- function(xml, tag, feature) {
   xml_text(xml)
 }
 
+mdxml_code <- function(xml, tag) {
+  code <- xml_text(xml)
+
+  # See escaping details at
+  # https://cran.rstudio.com/doc/manuals/r-devel/R-exts.html#Insertions
+  if (can_parse(code)) {
+    paste0(""\\code{"", gsub(""%"", ""\\\\%"", code), ""}"")
+  } else {
+    paste0(""\\verb{"", escape_verb(code), ""}"")
+  }
+}
+
+can_parse <- function(x) {
+  tryCatch({
+    parse_expr(x)
+    TRUE
+  }, error = function(x) FALSE)
+}
+
+escape_verb <- function(x) {
+  x <- gsub(""\\"", ""\\\\"", x, fixed = TRUE)
+  x <- gsub(""%"", ""\\%"", x, fixed = TRUE)
+  x <- gsub(""{"", ""\\{"", x, fixed = TRUE)
+  x <- gsub(""}"", ""\\}"", x, fixed = TRUE)
+  x
+}
 
 # A list, either bulleted or numbered
 mdxml_list <- function(xml, tag) {

---FILE: man/markdown-internals.Rd---
@@ -43,13 +43,13 @@ The list of protected Rd tags is in \code{escaped_for_md}.
 
 Some Rd macros are treated specially:
 \itemize{
-\item For \code{if}, markdown is only allowed in the second argument.
+\item For \verb{if}, markdown is only allowed in the second argument.
 \item For \code{ifelse} markdown is allowed in the second and third arguments.
 }
 
 See also \code{roclet-rd.R} for the list of tags that
 uses the markdown-enabled parser. Some tags, e.g.
-\code{@aliases}, \code{@backref}, etc. only use the
+\verb{@aliases}, \verb{@backref}, etc. only use the
 standard Roxygen parser.
 }
 \keyword{internal}

---FILE: man/parse_package.Rd---
@@ -30,7 +30,7 @@ the input code. The defaults will do this for you in a test environment:
 for real code you'll need to generate the environment yourself.
 
 You can also set to \code{NULL} if you only want to get the tokenized code
-blocks only. This suppresses evaluation of \code{@eval} tags, and will not
+blocks only. This suppresses evaluation of \verb{@eval} tags, and will not
 find the code object associated with each block.}
 
 \item{registry}{A roclet tag registry: this is a named list where the

---FILE: man/roclet.Rd---
@@ -34,7 +34,7 @@ values give tag parsing function. See \link{roxy_tag} for built-in options.
 code has been evaluated. This should only be needed if your roclet affects
 how code will evaluated. Should return a roclet.
 \item \code{roclet_process()} called after blocks have been evaluated; i.e. the
-\code{@eval} tag has been processed, and the object associated with each block
+\verb{@eval} tag has been processed, and the object associated with each block
 has been determined.
 \item \code{roclet_output()} is given the output from \code{roclet_process()} and should
 produce files on disk.

---FILE: man/update_collate.Rd---
@@ -16,7 +16,7 @@ alphabet puts letters in the same order, so you can't rely on alphabetic
 ordering if you need one file loaded before another. (This usually doesn't
 matter but is important for S4, where you need to make sure that classes are
 loaded before subclasses and generics are defined before methods.).
-You can override the default alphabetical ordering with \code{@include before.R},
+You can override the default alphabetical ordering with \verb{@include before.R},
 which specify that \code{before.R} must be loaded before the current file.
 
 Generally, you will not need to run this function yourself; it should be
@@ -28,9 +28,9 @@ collation order.
 This is not a roclet because roclets need the values of objects in a package,
 and those values can not be generated unless you've sourced the files,
 and you can't source the files unless you know the correct order.
-If there are no \code{@include} tags, roxygen2 will leave collate as is.
+If there are no \verb{@include} tags, roxygen2 will leave collate as is.
 This makes it easier to use roxygen2 with an existing collate directive,
-but if you remove all your \code{@include} tags, you'll need to also
+but if you remove all your \verb{@include} tags, you'll need to also
 manually delete the collate field.
 }
 

---FILE: man/vignette_roclet.Rd---
@@ -12,7 +12,7 @@ By default, it will rebuild all vignettes if the source file is newer than
 the output pdf or html. (This means it will automatically re-build the
 vignette if you change the vignette source, but \emph{not} when you
 change the R code). If you want finer control, add a Makefile to
-\code{vignettes/} and roxygen2 will use that instead.
+\verb{vignettes/} and roxygen2 will use that instead.
 }
 \details{
 To prevent RStudio from re-building the vignettes again when checking

---FILE: tests/testthat/test-markdown-link.R---
@@ -24,7 +24,7 @@ test_that(""proper link references are added"", {
 test_that(""can not have [ inside of link"", {
   expect_equal(
     markdown(""`[[`. [subset()]""),
-    ""\\code{[[}. \\code{\\link[=subset]{subset()}}""
+    ""\\verb{[[}. \\code{\\link[=subset]{subset()}}""
   )
 })
 
@@ -298,9 +298,9 @@ test_that(""[] is not picked up in code"", {
   out2 <- roc_proc_text(rd_roclet(), ""
     #' Title
     #'
-    #' @param connect_args \\code{[named list]}\\cr Connection arguments
-    #' Description, see \\code{[foobar]}.
-    #' Also \\code{[this_too]}.
+    #' @param connect_args \\verb{[named list]}\\cr Connection arguments
+    #' Description, see \\verb{[foobar]}.
+    #' Also \\verb{[this_too]}.
     foo <- function() {}"")[[1]]
   expect_equivalent_rd(out1, out2)
 })

---FILE: tests/testthat/test-markdown-state.R---
@@ -30,7 +30,7 @@ test_that(""turning on/off markdown globally"", {
     foo <- function() {}"")[[1]]
   expect_equal(
     get_tag(out1, ""description"")$values,
-    ""Description with some \\code{code} included. \\code{More code.}""
+    ""Description with some \\code{code} included. \\verb{More code.}""
   )
 })
 
@@ -56,7 +56,7 @@ test_that(""turning on/off markdown locally"", {
     foo <- function() {}"")[[1]]
   expect_equal(
     get_tag(out1, ""description"")$values,
-    ""Description with some \\code{code} included. \\code{More code.}""
+    ""Description with some \\code{code} included. \\verb{More code.}""
   )
 
   ## on / off
@@ -80,7 +80,7 @@ test_that(""turning on/off markdown locally"", {
     foo <- function() {}"")[[1]]
   expect_equal(
     get_tag(out1, ""description"")$values,
-    ""Description with some \\code{code} included. \\code{More code.}""
+    ""Description with some \\code{code} included. \\verb{More code.}""
   )
 
 })

---FILE: tests/testthat/test-markdown.R---
@@ -1,4 +1,6 @@
-test_that(""backticks are converted to \\code"", {
+# code --------------------------------------------------------------------
+
+test_that(""backticks are converted to \\code & \\verb"", {
   out1 <- roc_proc_text(rd_roclet(), ""
     #' Title
     #'
@@ -8,7 +10,7 @@ test_that(""backticks are converted to \\code"", {
   out2 <- roc_proc_text(rd_roclet(), ""
     #' Title
     #'
-    #' Description with some \\code{code} included. \\code{More code.}
+    #' Description with some \\code{code} included. \\verb{More code.}
     foo <- function() {}"")[[1]]
   expect_equivalent_rd(out1, out2)
 })
@@ -44,26 +46,21 @@ test_that(""code blocks work"", {
 })
 
 test_that(""inline code escapes %"", {
-  out <- roc_proc_text(rd_roclet(), ""
-    #' `0.5%`
-    #' @md
-    f <- function() 1
-  "")[[1]]
+  expect_equal(markdown(""`5%`""), ""\\verb{5\\%}"")
+  expect_equal(markdown(""`'5%'`""), ""\\code{'5\\%'}"")
+})
 
-  expect_equal(out$get_field(""title"")$values, ""\\code{0.5\\%}"")
+test_that(""inline verbatim escapes Rd special chars"", {
+  expect_equal(markdown(""`{`""), ""\\verb{\\{}"")
+  expect_equal(markdown(""`}`""), ""\\verb{\\}}"")
+  expect_equal(markdown(""`\\`""), ""\\verb{\\\\}"")
 })
 
 test_that(""code blocks escape %"", {
-  out <- roc_proc_text(rd_roclet(), ""
-    #' ```
-    #' 1:10 %>% mean()
-    #' ```
-    #'
-    #' @md
-    f <- function() 1
-  "")[[1]]
-
-  expect_equal(out$get_field(""title"")$values, ""\\preformatted{1:10 \\%>\\% mean()\n}"")
+  expect_equal(
+    markdown(""```\n1:10 %>% mean()\n```""),
+    ""\\preformatted{1:10 \\%>\\% mean()\n}""
+  )
 })
 
 test_that(""inline code works with < and >"", {
@@ -73,9 +70,12 @@ test_that(""inline code works with < and >"", {
     f <- function() 1
   "")[[1]]
 
-  expect_equal(out$get_field(""title"")$values, ""\\code{SELECT <name> FROM <table>}"")
+  expect_equal(out$get_field(""title"")$values, ""\\verb{SELECT <name> FROM <table>}"")
 })
 
+
+# lists -------------------------------------------------------------------
+
 test_that(""itemized lists work"", {
   out1 <- roc_proc_text(rd_roclet(), ""
     #' Title
@@ -188,6 +188,9 @@ test_that(""nested lists are OK"", {
   expect_equivalent_rd(out1, out2)
 })
 
+
+# inline formatting -------------------------------------------------------
+
 test_that(""emphasis works"", {
   out1 <- roc_proc_text(rd_roclet(), ""
     #' Title
@@ -394,8 +397,8 @@ test_that(""Do not pick up `` in arguments \\item #519"", {
     #'
     #' Description.
     #'
-    #' @param `_arg1` should not be code. But \\code{this should}.
-    #' @param `_arg2` should not be code, either. \\code{But this.}
+    #' @param `_arg1` should not be code. But \\verb{this should}.
+    #' @param `_arg2` should not be code, either. \\verb{But this.}
     #'
     foo <- function(`_arg1`, `_arg2`) {}"")[[1]]
   expect_equivalent_rd(out1, out2)"
r-lib,roxygen2,a7a77198ca7abb47d1294c46308fb1bdeeed727e,Hadley Wickham,h.wickham@gmail.com,2019-09-11T21:19:05Z,Hadley Wickham,h.wickham@gmail.com,2019-09-11T21:19:05Z,"Fix badge urls

And remove travis + codecov",README.md,False,False,False,False,3,5,8,"---FILE: README.md---
@@ -2,11 +2,9 @@
 
 <!-- badges: start -->
 [![CRAN status](https://www.r-pkg.org/badges/version/roxygen2)](https://CRAN.R-project.org/package=roxygen2)
-[![Travis build status](https://travis-ci.org/r-lib/roxygen2.svg?branch=master)](https://travis-ci.org/r-lib/roxygen2)
-[![Codecov test coverage](https://codecov.io/gh/r-lib/roxygen2/branch/master/graph/badge.svg)](https://codecov.io/gh/r-lib/roxygen2?branch=master)
-[![Azure pipelines build status](https://img.shields.io/azure-devops/build/r-lib/roxygen2/2)](https://dev.azure.com/r-lib/roxygen2/_build/latest?definitionId=1&branchName=master)
-[![Azure pipelines test status](https://img.shields.io/azure-devops/tests/r-lib/roxygen2/2?color=brightgreen&compact_message)](https://dev.azure.com/r-lib/roxygen2/_build/latest?definitionId=1&branchName=master)
-[![Azure pipelines coverage status](https://img.shields.io/azure-devops/coverage/r-lib/roxygen2/2)](https://dev.azure.com/r-lib/roxygen2/_build/latest?definitionId=1&branchName=master)
+[![Azure pipelines build status](https://img.shields.io/azure-devops/build/r-lib/roxygen2/8)](https://dev.azure.com/r-lib/roxygen2/_build/latest?definitionId=1&branchName=master)
+[![Azure pipelines test status](https://img.shields.io/azure-devops/tests/r-lib/roxygen2/8?color=brightgreen&compact_message)](https://dev.azure.com/r-lib/roxygen2/_build/latest?definitionId=1&branchName=master)
+[![Azure pipelines coverage status](https://img.shields.io/azure-devops/coverage/r-lib/roxygen2/8)](https://dev.azure.com/r-lib/roxygen2/_build/latest?definitionId=1&branchName=master)
 <!-- badges: end -->
 
 The premise of roxygen2 is simple: describe your functions in comments next to their definitions and roxygen2 will process your source code and comments to automatically generate `.Rd` files in `man/`, `NAMESPACE`, and, if needed, the `Collate` field in `DESCRIPTION`."
r-lib,roxygen2,eb3af3c67e994ea6d2ea514f81e5b9756c65a7c9,Hadley Wickham,h.wickham@gmail.com,2019-09-11T15:27:50Z,Hadley Wickham,h.wickham@gmail.com,2019-09-11T15:27:50Z,"Skip test if file has windows line endings

To fix failure on Azure, which checks out files with autocrlf = TRUE",tests/testthat/test-rd.R,False,True,True,False,4,0,4,"---FILE: tests/testthat/test-rd.R---
@@ -171,6 +171,10 @@ test_that(""unicode escapes are ok"", {
 
 test_that(""write_lines writes unix-style line endings."", {
   path <- test_path(""escapes.Rd"")
+
+  # skip if checked on windows with autocrlf = true
+  skip_if(has_windows_le(path))
+
   temp_filename <- tempfile()
   old_binary <- readBin(path, ""raw"", n = file.info(path)$size)
   old_text <- read_lines(path)"
r-lib,roxygen2,0dce0cd20a63ccd54dcf6231308b217c48de8b1c,Hadley Wickham,h.wickham@gmail.com,2019-09-10T22:55:52Z,Hadley Wickham,h.wickham@gmail.com,2019-09-10T22:55:52Z,"Check for presence of arguments when inheriting

Fixes #898",NEWS.md;R/rd-inherit.R,False,True,True,False,8,2,10,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* Inherting for a function with no arguments no longer throws a confusing
+  error message (#898)
+
 * As well as storing roxygen options in the `Roxygen` field of the 
   `DESCRIPTION` you can now also store them in `man/roxygen/meta.R` (#889).
 

---FILE: R/rd-inherit.R---
@@ -125,8 +125,11 @@ find_params <- function(name, topics) {
 
 topic_params <- function(x) UseMethod(""topic_params"")
 topic_params.Rd <- function(x) {
-  arguments <- get_tags(x, ""\\arguments"")[[1]]
-  items <- get_tags(arguments, ""\\item"")
+  arguments <- get_tags(x, ""\\arguments"")
+  if (length(arguments) != 1) {
+    return(list())
+  }
+  items <- get_tags(arguments[[1]], ""\\item"")
 
   values <- map_chr(items, function(x) rd2text(x[[2]]))
   params <- map_chr(items, function(x) rd2text(x[[1]]))"
r-lib,roxygen2,803c4667c6b6d46b2c30d631ef6add441ecde34c,Hadley Wickham,h.wickham@gmail.com,2019-09-10T18:17:36Z,Hadley Wickham,h.wickham@gmail.com,2019-09-10T18:17:36Z,"Look in man/roxygen/meta.R for options

Fixes #889",NEWS.md;R/options.R;R/roxygenize.R;man/load_options.Rd;tests/testthat/test-options.R;tests/testthat/test-options/DESCRIPTION;tests/testthat/test-options/man/roxygen/meta.R;tests/testthat/test-options/meta-character.R;tests/testthat/test-options/meta-error.R,False,True,True,False,102,34,136,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* As well as storing roxygen options in the `Roxygen` field of the 
+  `DESCRIPTION` you can now also store them in `man/roxygen/meta.R` (#889).
+
 * roxygen now looks for templates in `man/roxygen/templates` (#888).
 
 * Files generated on Windows systems now retain their existing line endings, or use 

---FILE: R/options.R---
@@ -0,0 +1,67 @@
+#' Load roxygen2 options
+#'
+#' Options can be stored in the `Roxygen` field of the `DESCRIPTION`, or
+#' in `man/roxygen/meta.R`. In either case, the code is parsed and evaluated
+#' in a child of the base environment.
+#'
+#' Options in `man/roxygen/meta.R` override those present `DESCRIPTION`.
+#'
+#' @param base_path Path to package.
+#' @export
+#' @keywords internal
+load_options <- function(base_path = ""."") {
+  desc <- load_options_description(base_path)
+  meta <- load_options_meta(base_path)
+  opts <- utils::modifyList(desc, meta)
+
+  defaults <- list(
+    wrap = FALSE,
+    roclets = c(""collate"", ""namespace"", ""rd""),
+    markdown = markdown_global_default
+  )
+
+  unknown_opts <- setdiff(names(opts), names(defaults))
+  if (length(unknown_opts) > 0) {
+    warn(paste0(
+      ""Unknown Roxygen options "", paste(unknown_opts, collapse = "", ""), "".\n"",
+      ""Supported options: "", paste(names(defaults), collapse = "", "")
+    ))
+  }
+
+  utils::modifyList(defaults, opts)
+}
+
+load_options_description <- function(base_path = ""."") {
+  desc_path <- file.path(base_path, ""DESCRIPTION"")
+  desc_opts <- read.dcf(desc_path, fields = ""Roxygen"")[[1, 1]]
+
+  if (is.na(desc_opts)) {
+    list()
+  } else {
+    eval(parse(text = desc_opts), child_env(baseenv()))
+  }
+}
+
+load_options_meta <- function(base_path = ""."", path = ""man/roxygen/meta.R"") {
+  # Only look for .R for consistency with style advice
+  meta_path <- file.path(base_path, path)
+
+  if (!file.exists(meta_path)) {
+    return(list())
+  }
+
+  value <- tryCatch(
+    source(meta_path, local = child_env(baseenv()))$value,
+    error = function(err) {
+      warn(""Failed to source `man/roxygen/meta.R`"")
+      list()
+    }
+  )
+
+  if (!is.list(value)) {
+    warn(""`man/roxygen/meta.R` must yield a named list"")
+    return(list())
+  }
+
+  value
+}

---FILE: R/roxygenize.R---
@@ -99,37 +99,6 @@ roxygenize <- function(package.dir = ""."",
 #' @export
 roxygenise <- roxygenize
 
-#' Load options from DESCRIPTION.
-#'
-#' @param base_path Path to package.
-#' @export
-#' @keywords internal
-load_options <- function(base_path = ""."") {
-  desc_path <- file.path(base_path, ""DESCRIPTION"")
-  desc_opts <- read.dcf(desc_path, fields = ""Roxygen"")[[1, 1]]
-
-  if (is.na(desc_opts)) {
-    opts <- list()
-  } else {
-    opts <- eval(parse(text = desc_opts))
-  }
-
-  defaults <- list(
-    wrap = FALSE,
-    roclets = c(""collate"", ""namespace"", ""rd""),
-    markdown = markdown_global_default
-  )
-
-  unknown_opts <- setdiff(names(opts), names(defaults))
-  if (length(unknown_opts) > 0) {
-    warning(""Unknown Roxygen options "", paste(unknown_opts, collapse = "", ""),
-            "".\nSupported options: "", paste(names(defaults), collapse = "", ""))
-  }
-
-  utils::modifyList(defaults, opts)
-}
-
-
 roxygen_setup <- function(base_path) {
   is_first <- first_time(base_path)
   if (is_first) {

---FILE: man/load_options.Rd---
@@ -1,15 +1,20 @@
 % Generated by roxygen2: do not edit by hand
-% Please edit documentation in R/roxygenize.R
+% Please edit documentation in R/options.R
 \name{load_options}
 \alias{load_options}
-\title{Load options from DESCRIPTION.}
+\title{Load roxygen2 options}
 \usage{
 load_options(base_path = ""."")
 }
 \arguments{
 \item{base_path}{Path to package.}
 }
 \description{
-Load options from DESCRIPTION.
+Options can be stored in the \code{Roxygen} field of the \code{DESCRIPTION}, or
+in \code{man/roxygen/meta.R}. In either case, the code is parsed and evaluated
+in a child of the base environment.
+}
+\details{
+Options in \code{man/roxygen/meta.R} override those present \code{DESCRIPTION}.
 }
 \keyword{internal}

---FILE: tests/testthat/test-options.R---
@@ -0,0 +1,18 @@
+test_that(""merged options from can load options from DESCRIPTION"", {
+  opts <- load_options(test_path(""test-options""))
+  expect_equal(opts$wrap, TRUE) # from DESCRIPTION
+  expect_equal(opts$markdown, TRUE) # from meta.R
+})
+
+test_that(""warns on invalid meta.R files"", {
+
+  expect_warning(
+    load_options_meta(test_path(""test-options""), ""meta-error.R""),
+    ""Failed to source""
+  )
+
+  expect_warning(
+    load_options_meta(test_path(""test-options""), ""meta-character.R""),
+    ""yield a named list""
+  )
+})

---FILE: tests/testthat/test-options/DESCRIPTION---
@@ -0,0 +1 @@
+Roxygen: list(wrap = TRUE)

---FILE: tests/testthat/test-options/man/roxygen/meta.R---
@@ -0,0 +1,3 @@
+list(
+  markdown = TRUE
+)

---FILE: tests/testthat/test-options/meta-character.R---
@@ -0,0 +1 @@
+""a""

---FILE: tests/testthat/test-options/meta-error.R---
@@ -0,0 +1 @@
+stop(""This is an error!"")"
r-lib,roxygen2,87eab9af2fb6af78ff2ed08e435eece90e3fab59,Hadley Wickham,h.wickham@gmail.com,2019-09-10T15:52:32Z,Hadley Wickham,h.wickham@gmail.com,2019-09-10T15:52:32Z,"Also look for templates in man/roxygen/templates

Fixes #888",NEWS.md;R/rd-template.R;tests/testthat/man-roxygen/reg.ex.R;tests/testthat/templates/man-roxygen/UCase.R;tests/testthat/templates/man-roxygen/lcase.r;tests/testthat/templates/man/roxygen/templates/new-path.R;tests/testthat/test-rd-template.R,False,True,True,False,30,27,57,"---FILE: NEWS.md---
@@ -1,5 +1,7 @@
 # roxygen2 (development version)
 
+* roxygen now looks for templates in `man/roxygen/templates` (#888).
+
 * Files generated on Windows systems now retain their existing line endings, or use 
   unix-style line endings for new files (@jonthegeek, @jimhester, #840).
   

---FILE: R/rd-template.R---
@@ -1,12 +1,16 @@
 template_find <- function(base_path, template_name) {
-  path <- file.path(base_path, ""man-roxygen"", paste0(template_name, ""."", c(""R"", ""r"")))
+  file_name <- paste0(template_name, ""."", c(""R"", ""r""))
+  path <- c(
+    file.path(base_path, ""man-roxygen"", file_name),
+    file.path(base_path, ""man"", ""roxygen"", ""templates"", file_name)
+  )
   path_exists <- file.exists(path)
 
   if (!any(path_exists)) {
     stop(""Can't find template '"", template_name, ""'"", call. = FALSE)
   }
 
-  path[path_exists][1]
+  path[path_exists][[1]]
 }
 
 template_eval <- function(template_path, vars) {

---FILE: tests/testthat/templates/man/roxygen/templates/new-path.R---
@@ -0,0 +1,2 @@
+#' <%= x %>
+#' @param <%= y %> <%= z %>

---FILE: tests/testthat/test-rd-template.R---
@@ -1,43 +1,38 @@
 context(""Rd: template"")
 
-test_that(""template_find finds files with .r and .R extension, and fails to find missing files"", {
-  my.tempdir <- "".""
-  my.mandir <- file.path(my.tempdir, ""man-roxygen"")
-  my.ucase <- file.path(my.mandir, ""UCase.R"")
-  my.regex <- file.path(my.mandir, ""reg.ex.R"")
-  my.lcase <- file.path(my.mandir, ""lcase.r"")
+test_that(""can find template from name"", {
+  base <- test_path(""templates/"")
 
-  expect_equal(template_find(my.tempdir, ""UCase""), my.ucase)
-  expect_error(template_find(my.tempdir, ""Case""))
-  expect_error(template_find(my.tempdir, ""UCas""))
-  expect_equal(template_find(my.tempdir, ""reg.ex""), my.regex)
-  expect_error(template_find(my.tempdir, ""reggex""))
-  expect_error(template_find(my.tempdir, ""nada""))
+  expect_equal(
+    template_find(base, ""UCase""),
+    file.path(base, ""man-roxygen"", ""UCase.R"")
+  )
 
   # On case-insentive file systems, will find upper case version first
-  expect_equal(tolower(template_find(my.tempdir, ""lcase"")), tolower(my.lcase))
-})
+  expect_equal(
+    tolower(template_find(base, ""lcase"")),
+    tolower(file.path(base, ""man-roxygen"", ""lcase.r""))
+  )
 
-test_that(""templates replace variables with their values"", {
-  out <- roc_proc_text(rd_roclet(), ""
-    #' @template values
-    #' @templateVar x a
-    #' @templateVar y b
-    #' @templateVar z c
-    x <- 10"")[[1]]
+  expect_equal(
+    template_find(base, ""new-path""),
+    file.path(base, ""man"" , ""roxygen"", ""templates"", ""new-path.R"")
+  )
 
-  expect_equal(get_tag(out, ""title"")$values, ""a"")
-  expect_equal(get_tag(out, ""param"")$values, c(b = ""c""))
+  expect_error(
+    template_find(base, ""missing""),
+    ""Can't find template""
+  )
 })
 
-test_that(""allow empty line after @template"", {
+test_that(""templates replace variables with their values"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' @template values
-    #'
     #' @templateVar x a
     #' @templateVar y b
     #' @templateVar z c
     x <- 10"")[[1]]
 
   expect_equal(get_tag(out, ""title"")$values, ""a"")
+  expect_equal(get_tag(out, ""param"")$values, c(b = ""c""))
 })"
r-lib,roxygen2,a4abe1d3e8aab96838ec56c927c876cdd99f5ca3,Hadley Wickham,h.wickham@gmail.com,2019-08-22T17:05:27Z,Hadley Wickham,h.wickham@gmail.com,2019-08-22T17:05:27Z,"Warn if `@inheritParams` used when not needed

Fixes #836",NEWS.md;R/rd-inherit.R;R/topic.R;tests/testthat/test-rd-inherit.R,False,True,True,False,30,4,34,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* `@inheritParams` warns if there are no parameters that require 
+  documentation (#836).
+
 * roxygen2 now recgonises fully qualified S4 functions like 
   `methods::setGeneric()`, `methods::setClass()` and `methods::setMethod()`
   (#880).

---FILE: R/rd-inherit.R---
@@ -26,19 +26,28 @@ topics_process_inherit <- function(topics, env) {
 # Inherit parameters -----------------------------------------------------------
 
 inherit_params <- function(topic, topics) {
+  inheritors <- topic$inherits_from(""params"")
+  if (length(inheritors) == 0) {
+    return()
+  }
+
   documented <- get_documented_params(topic)
   needed <- topic$get_field(""formals"")$values
-
   missing <- setdiff(needed, documented)
   if (length(missing) == 0) {
+    warn(paste0(
+      ""Topic '"", topic$get_name(), ""': "",
+      ""no parameters to inherit with @inheritParams""
+    ))
     return()
   }
 
-  for (inheritor in topic$inherits_from(""params"")) {
+  for (inheritor in inheritors) {
     inherited <- find_params(inheritor, topics)
 
     to_add <- intersect(missing, names(inherited))
     if (length(to_add) == 0) {
+      # Can't warn here because @inherit inherits parameters
       next
     }
 

---FILE: R/topic.R---
@@ -32,6 +32,10 @@ RoxyTopic <- R6::R6Class(""RoxyTopic"", public = list(
     self$fields[[field_name]]
   },
 
+  get_name = function() {
+    self$get_field(""name"")$values
+  },
+
   inherits_from = function(type) {
     if (!self$has_field(""inherit"")) {
       return(character())

---FILE: tests/testthat/test-rd-inherit.R---
@@ -310,13 +310,23 @@ test_that(""@inheritParam understands compound docs"", {
     #' Title
     #'
     #' @inheritParams x
-    #' @param x y
     #' @param y y
     y <- function(x, y) {}"")[[2]]
   params <- get_tag(out, ""param"")$values
-  expect_equal(params, c(x = ""y"", y = ""y""))
+  expect_equal(params, c(x = ""x"", y = ""y""))
 })
 
+test_that(""warned if no params need documentation"", {
+  code <- ""
+    #' Title
+    #'
+    #' @param x x
+    #' @param y x
+    #' @inheritParams foo
+    x <- function(x, y) {}
+  ""
+  expect_warning(roc_proc_text(rd_roclet(), code), ""no parameters to inherit"")
+})
 
 test_that(""argument order, also for incomplete documentation"", {
   out <- roc_proc_text(rd_roclet(), """
r-lib,roxygen2,c15f2651d58f69928d7e5159702b128857035886,Hadley Wickham,h.wickham@gmail.com,2019-08-22T16:28:39Z,Hadley Wickham,h.wickham@gmail.com,2019-08-22T16:28:43Z,"Use purrr!

Fixes #897",NAMESPACE;R/block.R;R/collate.R;R/field.R;R/markdown-escaping.R;R/markdown-link.R;R/markdown.R;R/object-package.R;R/object-usage.R;R/rd-family.R;R/rd-inherit.R;R/rd-template.R;R/rd.R;R/roxygen.R;R/safety.R;R/topic.R;R/topo-sort.R;R/utils.R;R/vignette.R;vignettes/rd-formatting.Rmd,True,True,True,False,46,58,104,"---FILE: NAMESPACE---
@@ -124,6 +124,11 @@ import(rlang)
 import(stringr)
 importFrom(R6,R6Class)
 importFrom(Rcpp,sourceCpp)
+importFrom(purrr,map)
+importFrom(purrr,map2)
+importFrom(purrr,map_chr)
+importFrom(purrr,map_int)
+importFrom(purrr,map_lgl)
 importFrom(stats,setNames)
 importFrom(utils,URLdecode)
 importFrom(utils,URLencode)

---FILE: R/block.R---
@@ -161,9 +161,7 @@ parse_tags <- function(tokens, registry = list(), global_options = list()) {
 
   # Convert to existing named list format - this isn't ideal, but
   # it's what roxygen already uses
-  vals <- lapply(tags, `[[`, ""val"")
-  names <- vapply(tags, `[[`, ""tag"", FUN.VALUE = character(1))
-  setNames(vals, names)
+  set_names(map(tags, ""val""), map_chr(tags, ""tag""))
 }
 
 parse_tag <- function(x, registry) {
@@ -226,8 +224,7 @@ parse_description <- function(tags) {
     # Find explicit @details tags
     didx <- which(tag_names == ""details"")
     if (length(didx) > 0) {
-      explicit_details <- vapply(tags[didx], `[[`, ""val"",
-        FUN.VALUE = character(1))
+      explicit_details <- map_chr(tags[didx], ""val"")
       tags <- tags[-didx]
       details_para <- paste(c(details_para, explicit_details), collapse = ""\n\n"")
     }

---FILE: R/collate.R---
@@ -52,7 +52,7 @@ generate_collate <- function(base_path) {
   includes <- lapply(paths, find_includes)
   names(includes) <- paths
 
-  n <- sum(vapply(includes, length, integer(1)))
+  n <- sum(map_int(includes, length))
   if (n == 0) return()
 
   topo <- TopoSort$new()

---FILE: R/field.R---
@@ -64,8 +64,7 @@ format_rd <- function(x, ..., sort = TRUE) {
     x$values <- sort_c(x$values)
   }
 
-  vapply(x$values, rd_macro, field = x$field,
-    FUN.VALUE = character(1), USE.NAMES = FALSE)
+  map_chr(x$values, rd_macro, field = x$field)
 }
 #' @export
 format.roxy_field_keyword <- format_rd
@@ -246,7 +245,7 @@ merge.roxy_field_reexport <- function(x, y, ...) {
 #' @export
 format.roxy_field_reexport <- function(x, ...) {
   pkgs <- split(x$fun, x$pkg)
-  pkg_links <- Map(pkg = names(pkgs), funs = pkgs, function(pkg, funs) {
+  pkg_links <- map2(names(pkgs), pkgs, function(pkg, funs) {
     links <- paste0(""\\code{\\link["", pkg, ""]{"", escape(funs), ""}}"",
       collapse = "", "")
     paste0(""\\item{"", pkg, ""}{"", links, ""}"")

---FILE: R/markdown-escaping.R---
@@ -84,14 +84,9 @@ find_fragile_rd_tags <- function(text, fragile) {
   ftags <- tags[ tags$tag %in% fragile, ]
 
   ## Remove embedded ones
-  keep <- vapply(
-    seq_len(nrow(ftags)),
-    function(i) {
-      sum(ftags$start <= ftags$start[i] &
-            ftags$argend >= ftags$argend[i]) == 1
-    },
-    TRUE
-  )
+  keep <- map_lgl(seq_len(nrow(ftags)), function(i) {
+    sum(ftags$start <= ftags$start[i] & ftags$argend >= ftags$argend[i]) == 1
+  })
 
   ftags <- ftags[keep, ]
 
@@ -119,14 +114,10 @@ find_all_rd_tags <- function(text) {
 
   ## Find the end of the argument list for each tag. Note that
   ## tags might be embedded into the arguments of other tags.
-  tags$argend <- vapply(
-    seq_len(nrow(tags)),
-    function(i) {
+  tags$argend <- map_int(seq_len(nrow(tags)), function(i) {
       tag_plus <- str_sub(text, tags$end[i], text_len)
       findEndOfTag(tag_plus, is_code = FALSE) + tags$end[i]
-    },
-    1L
-  )
+  })
 
   tags
 }

---FILE: R/markdown-link.R---
@@ -59,7 +59,7 @@ add_linkrefs_to_md <- function(text) {
   # Need to check both NA and """" for different versions of stringr
   refs[, 3] <- ifelse(is.na(refs[,3]) | refs[,3] == """", refs[, 2], refs[,3])
 
-  refs3encoded <- vapply(refs[,3], URLencode, """")
+  refs3encoded <- map_chr(refs[,3], URLencode)
   ref_text <- paste0(""["", refs[, 3], ""]: "", ""R:"", refs3encoded)
 
   paste0(

---FILE: R/markdown.R---
@@ -22,7 +22,7 @@ md_to_mdxml <- function(x) {
 }
 
 mdxml_children_to_rd <- function(xml, tag) {
-  out <- vapply(xml_children(xml), mdxml_node_to_rd, tag = tag, character(1))
+  out <- map_chr(xml_children(xml), mdxml_node_to_rd, tag)
   paste0(out, collapse = """")
 }
 
@@ -90,7 +90,7 @@ mdxml_item <- function(xml, tag) {
   } else if (xml_name(children[[1]]) == ""paragraph"") {
     cnts <- paste0(
       mdxml_children_to_rd(children[[1]], tag),
-      paste0(vapply(children[-1], mdxml_node_to_rd, tag = tag, character(1)), collapse = """")
+      paste0(map_chr(children[-1], mdxml_node_to_rd, tag), collapse = """")
     )
   } else {
     cnts <- mdxml_children_to_rd(xml, tag)

---FILE: R/object-package.R---
@@ -21,8 +21,8 @@ package_authors <- function(desc) {
   if (is.null(authors))
     return()
 
-  desc <- vapply(unclass(authors), author_desc, character(1))
-  type <- vapply(unclass(authors), author_type, character(1))
+  desc <- map_chr(unclass(authors), author_desc)
+  type <- map_chr(unclass(authors), author_type)
   by_type <- split(desc, type)
 
   paste(

---FILE: R/object-usage.R---
@@ -90,7 +90,7 @@ usage_args <- function(args) {
 
     text
   }
-  vapply(args, arg_to_text, character(1))
+  map_chr(args, arg_to_text)
 }
 
 args_string <- function(x) {

---FILE: R/rd-family.R---
@@ -39,9 +39,9 @@ topics_process_family <- function(topics) {
       if (length(others) < 1)
         next
 
-      by_file <- vapply(aliases[others], function(x) {
+      by_file <- map_chr(aliases[others], function(x) {
         paste0(""\\code{\\link{"", escape(x[1]), ""}}"")
-      }, FUN.VALUE = character(1))
+      })
       links <- paste(sort_c(by_file), collapse = "", "")
 
       seealso <- topics_process_family_prefix(family)

---FILE: R/rd-inherit.R---
@@ -54,16 +54,16 @@ inherit_dot_params <- function(topic, topics, env) {
 
   # Need to find formals for each source
   funs <- lapply(inheritors$source, function(x) eval(parse(text = x), envir = env))
-  args <- Map(select_args_text, funs, inheritors$args)
+  args <- map2(funs, inheritors$args, select_args_text)
 
   # Then pull out the ones we need
   docs <- lapply(inheritors$source, find_params, topics = topics)
   arg_matches <- function(args, docs) {
     doc_args <- str_split(names(docs), "", ?"")
-    match <- vapply(doc_args, function(x) x %in% args, logical(1))
+    match <- map_lgl(doc_args, function(x) x %in% args)
     docs[match]
   }
-  docs_selected <- unlist(Map(arg_matches, args, docs))
+  docs_selected <- unlist(map2(args, docs, arg_matches))
 
   # Build the arg string
   from <- paste0(""\\code{"", inheritors$source, ""}"", collapse = "", "")
@@ -85,7 +85,7 @@ get_documented_params <- function(topic, only_first = FALSE) {
   if (length(documented) > 0) {
     documented <- strsplit(documented, "","")
     if (only_first)
-      documented <- vapply(documented, `[[`, character(1), 1L)
+      documented <- map_chr(documented, 1)
     else
       documented <- unlist(documented)
   }
@@ -109,7 +109,7 @@ find_params <- function(name, topics) {
 
   # Split up compound names on , (swallowing spaces) duplicating their contents
   individual_names <- strsplit(param_names, "",\\s*"")
-  reps <- vapply(individual_names, length, integer(1))
+  reps <- map_int(individual_names, length)
 
   setNames(rep.int(params, reps), unlist(individual_names))
 }
@@ -119,8 +119,8 @@ topic_params.Rd <- function(x) {
   arguments <- get_tags(x, ""\\arguments"")[[1]]
   items <- get_tags(arguments, ""\\item"")
 
-  values <- vapply(items, function(x) rd2text(x[[2]]), character(1))
-  params <- vapply(items, function(x) rd2text(x[[1]]), character(1))
+  values <- map_chr(items, function(x) rd2text(x[[2]]))
+  params <- map_chr(items, function(x) rd2text(x[[1]]))
 
   setNames(values, params)
 }
@@ -182,8 +182,8 @@ find_sections <- function(topic) {
   if (inherits(topic, ""Rd"")) {
     tag <- get_tags(topic, ""\\section"")
 
-    titles <- vapply(lapply(tag, `[[`, 1), rd2text, character(1))
-    contents <- vapply(lapply(tag, `[[`, 2), rd2text, character(1))
+    titles <- map_chr(map(tag, 1), rd2text)
+    contents <- map_chr(map(tag, 2), rd2text)
 
     roxy_field_section(titles, contents)
   } else {

---FILE: R/rd-template.R---
@@ -20,12 +20,10 @@ process_templates <- function(block, base_path, global_options = list()) {
     return(block)
 
   templates <- unlist(template_tags, use.names = FALSE)
-  paths <- vapply(templates, template_find, base_path = base_path,
-    FUN.VALUE = character(1), USE.NAMES = FALSE)
+  paths <- map_chr(templates, template_find, base_path = base_path)
 
   var_tags <- block[names(block) == ""templateVar""]
-  vars <- lapply(var_tags, ""[["", ""description"")
-  names(vars) <- vapply(var_tags, ""[["", ""name"", FUN.VALUE = character(1))
+  vars <- set_names(map(var_tags, ""description""), map_chr(var_tags, ""name""))
   vars <- lapply(vars, utils::type.convert, as.is = TRUE)
 
   results <- lapply(paths, template_eval, vars = list2env(vars))

---FILE: R/rd.R---
@@ -171,7 +171,7 @@ block_to_rd <- function(block, base_path, env, global_options = list()) {
 roclet_output.roclet_rd <- function(x, results, base_path, ..., is_first = FALSE) {
   man <- normalizePath(file.path(base_path, ""man""))
 
-  contents <- vapply(results, format, wrap = FALSE, FUN.VALUE = character(1))
+  contents <- map_chr(results, format, wrap = FALSE)
   paths <- file.path(man, names(results))
 
   # Always check for roxygen2 header before overwriting NAMESPACE (#436),
@@ -198,9 +198,7 @@ roclet_output.roclet_rd <- function(x, results, base_path, ..., is_first = FALSE
 roclet_clean.roclet_rd <- function(x, base_path) {
   rd <- dir(file.path(base_path, ""man""), full.names = TRUE)
   rd <- rd[!file.info(rd)$isdir]
-  made_by_me <- vapply(rd, made_by_roxygen, logical(1))
-
-  unlink(rd[made_by_me])
+  unlink(purrr::keep(rd, made_by_roxygen))
 }
 
 block_tags <- function(x, tag) {
@@ -288,12 +286,12 @@ topic_add_methods <- function(topic, block) {
   if (is.null(obj$methods)) return()
 
   desc <- lapply(methods, function(x) docstring(x$value@.Data))
-  usage <- vapply(methods, function(x) {
+  usage <- map_chr(methods, function(x) {
     usage <- function_usage(x$value@name, formals(x$value@.Data))
     as.character(wrap_string(usage))
-  }, character(1))
+  })
 
-  has_docs <- !vapply(desc, is.null, logical(1))
+  has_docs <- !map_lgl(desc, is.null)
   desc <- desc[has_docs]
   usage <- usage[has_docs]
 

---FILE: R/roxygen.R---
@@ -11,6 +11,7 @@
 #' @keywords internal
 #' @importFrom Rcpp sourceCpp
 #' @importFrom R6 R6Class
+#' @importFrom purrr map map_int map_chr map_lgl map2
 #' @import rlang
 ""_PACKAGE""
 

---FILE: R/safety.R---
@@ -18,7 +18,7 @@ first_time <- function(path) {
     generated <- c(generated, namespace)
   }
 
-  roxy <- vapply(generated, made_by_roxygen, logical(1))
+  roxy <- map_lgl(generated, made_by_roxygen)
   all(!roxy)
 }
 

---FILE: R/topic.R---
@@ -39,7 +39,7 @@ RoxyTopic <- R6::R6Class(""RoxyTopic"", public = list(
 
     inherit <- self$get_field(""inherit"")
 
-    inherits_field <- vapply(inherit$fields, function(x) type %in% x, logical(1))
+    inherits_field <- map_lgl(inherit$fields, function(x) type %in% x)
     sources <- inherit$source[inherits_field]
 
     if (""NULL"" %in% sources)

---FILE: R/topo-sort.R---
@@ -33,7 +33,7 @@ TopoSort <- R6::R6Class(""TopoSort"", public = list(
         visit(vertex)
       }
     }
-    vapply(sorted, function(x) x$name, character(1))
+    map_chr(sorted, ""name"")
   }
 ))
 

---FILE: R/utils.R---
@@ -125,8 +125,7 @@ ignore_files <- function(rfiles, path) {
 }
 
 compact <- function(x) {
-  null <- vapply(x, is.null, logical(1))
-  x[!null]
+  x[!map_lgl(x, is.null)]
 }
 
 block_eval <- function(tag, block, env, tag_name) {

---FILE: R/vignette.R---
@@ -72,7 +72,7 @@ vign_update_all <- function(pkg_path) {
     message(""Updating vignettes"")
 
     vigs <- tools::pkgVignettes(dir = pkg_path)
-    invisible(vapply(vigs$docs, vign_update, logical(1)))
+    invisible(map_lgl(vigs$docs, vign_update))
   }
 }
 

---FILE: vignettes/rd-formatting.Rmd---
@@ -338,7 +338,7 @@ tabular <- function(df, ...) {
   stopifnot(is.data.frame(df))
 
   align <- function(x) if (is.numeric(x)) ""r"" else ""l""
-  col_align <- vapply(df, align, character(1))
+  col_align <- purrr::map_chr(df, align)
 
   cols <- lapply(df, format, ...)
   contents <- do.call(""paste"","
r-lib,roxygen2,2b33fa3df7794befb2554a48a7654b8566f93f53,Hadley Wickham,h.wickham@gmail.com,2019-08-22T16:14:55Z,Hadley Wickham,h.wickham@gmail.com,2019-08-22T16:14:55Z,"Reorganise functions for finding Rd contents

Improve and test warnings for various failure modes",R/rd-inherit.R;R/utils-rd.R;tests/testthat/test-rd-inherit.R,False,True,True,False,44,41,85,"---FILE: R/rd-inherit.R---
@@ -95,7 +95,7 @@ get_documented_params <- function(topic, only_first = FALSE) {
 }
 
 find_params <- function(name, topics) {
-  topic <- check_topic(name, topics)
+  topic <- get_rd(name, topics)
   if (is.null(topic)) {
     return()
   }
@@ -135,7 +135,7 @@ inherit_sections <- function(topic, topics) {
   current_secs <- topic$get_field(""section"")$title
 
   for (inheritor in topic$inherits_from(""sections"")) {
-    inheritor <- check_topic(inheritor, topics)
+    inheritor <- get_rd(inheritor, topics)
     if (is.null(inheritor)) {
       return()
     }
@@ -157,7 +157,7 @@ inherit_section <- function(topic, topics) {
   titles <- sections$title
 
   for (i in seq_along(sources)) {
-    inheritor <- check_topic(sources[[i]], topics)
+    inheritor <- get_rd(sources[[i]], topics)
     if (is.null(inheritor)) {
       return()
     }
@@ -201,7 +201,7 @@ inherit_field <- function(topic, topics, rd_name, roxy_name = rd_name) {
 
   # Otherwise, try each try function listed in inherits
   for (inherit_from in topic$inherits_from(roxy_name)) {
-    inherit_topic <- check_topic(inherit_from, topics)
+    inherit_topic <- get_rd(inherit_from, topics)
     if (is.null(inherit_topic)) {
       next
     }
@@ -230,36 +230,37 @@ find_field <- function(topic, field_name) {
   }
 }
 
-
 # Find info in Rd or topic ------------------------------------------------
 
-find_topic <- function(name, topics) {
+get_rd <- function(name, topics) {
   if (has_colons(name)) {
-    tryCatch({
-      parsed <- parse(text = name)[[1]]
-      pkg <- as.character(parsed[[2]])
-      fun <- as.character(parsed[[3]])
-
-      get_rd(fun, pkg)
-    }, error = function(e) {
-      NULL
-    })
+    # External package
+    parsed <- parse_expr(name)
+    pkg <- as.character(parsed[[2]])
+    fun <- as.character(parsed[[3]])
+
+    get_rd_from_help(pkg, fun)
   } else {
-    # Reference within this package
+    # Current package
     rd_name <- topics$find_filename(name)
+    if (identical(rd_name, NA_character_)) {
+      warn(paste0(""Can't find help topic '"", name, ""' in current package""))
+    }
     topics$get(rd_name)
   }
 }
 
-check_topic <- function(name, topic) {
-  topic <- find_topic(name, topic)
-  if (is.null(topic)) {
-    warning(
-      ""Failed to find topic '"", name, ""'"",
-      call. = FALSE,
-      immediate. = TRUE
-    )
+get_rd_from_help <- function(package, alias) {
+  if (!is_installed(package)) {
+    warn(paste0(""Can't find package '"", package, ""'""))
+    return()
+  }
+
+  help <- eval(expr(help(!!alias, !!package)))
+  if (length(help) == 0) {
+    warn(paste0(""Can't find help topic '"", alias, ""' in '"", package, ""' package""))
+    return()
   }
 
-  topic
+  internal_f(""utils"", "".getHelpFile"")(help)
 }

---FILE: R/utils-rd.R---
@@ -68,14 +68,6 @@ rd_macro <- function(field, ..., space = FALSE) {
 
 # Input -------------------------------------------------------------------
 
-get_rd <- function(topic, package = NULL) {
-  help_call <- substitute(help(t, p), list(t = topic, p = package))
-  top <- eval(help_call)
-  if (length(top) == 0) return(NULL)
-
-  internal_f(""utils"", "".getHelpFile"")(top)
-}
-
 get_tags <- function(rd, tag) {
   Filter(function(x) identical(attr(x, ""Rd_tag""), tag), rd)
 }

---FILE: tests/testthat/test-rd-inherit.R---
@@ -226,14 +226,6 @@ test_that(""can inherit single section"", {
   expect_equal(section$content, ""1"")
 })
 
-
-test_that(""can find section in existing docs"", {
-  out <- find_sections(find_topic(""base::attach""))
-
-  expect_s3_class(out, ""roxy_field_section"")
-  expect_equal(out$title, ""Good practice"")
-})
-
 # Inherit parameters ------------------------------------------------------
 
 test_that(""multiple @inheritParam tags gathers all params"", {
@@ -475,3 +467,21 @@ test_that(""can inherit all from single function"", {
   expect_equal(out$get_field(""details"")$values, ""Details"")
   expect_equal(out$get_field(""examples"")$values, rd(""x <- 1""))
 })
+
+
+# get_rd() -----------------------------------------------------------------
+
+test_that(""useful warnings if can't find topics"", {
+  expect_warning(get_rd(""base2::attach""), ""Can't find package"")
+  expect_warning(get_rd(""base::function_not_found""), ""Can't find help topic"")
+  expect_warning(get_rd(""function"", RoxyTopics$new()), ""Can't find help topic"")
+})
+
+test_that(""can find section in existing docs"", {
+  out <- find_sections(get_rd(""base::attach""))
+
+  expect_s3_class(out, ""roxy_field_section"")
+  expect_equal(out$title, ""Good practice"")
+})
+
+"
r-lib,roxygen2,4ed1d8df7736dd1e64f91627aa99330e3ad433c3,Hadley Wickham,h.wickham@gmail.com,2019-08-22T13:01:13Z,Hadley Wickham,h.wickham@gmail.com,2019-08-22T13:01:13Z,"Parse fully qualified methods functions

Fixes #880",NEWS.md;R/object-from-call.R;tests/testthat/test-object-from-call.R,False,True,True,False,28,5,33,"---FILE: NEWS.md---
@@ -1,5 +1,9 @@
 # roxygen2 (development version)
 
+* roxygen2 now recgonises fully qualified S4 functions like 
+  `methods::setGeneric()`, `methods::setClass()` and `methods::setMethod()`
+  (#880).
+
 * Use of unsupported markdown features (blockquotes, headings, inline HTML, 
   and horizontal rules) now gets a more informative error message (#804).
 

---FILE: R/object-from-call.R---
@@ -12,9 +12,15 @@ object_from_call <- function(call, env, block, file) {
   if (!is.call(call)) return()
 
   call <- standardise_call(call, env)
-  name <- as.character(call[[1]])
 
-  if (length(name) > 1) return(NULL)
+  name <- call[[1]]
+  if (is_symbol(call[[1]])) {
+    name <- as.character(call[[1]])
+  } else if (is_call(call[[1]], ""::"", n = 2) && is_symbol(call[[1]][[2]], ""methods"")) {
+    name <- as.character(call[[1]][[3]])
+  } else {
+    return(NULL)
+  }
 
   # Dispatch to registered srcref parsers based on function name
   parser <- find_parser(name)
@@ -178,9 +184,8 @@ extract_method_fun <- function(x) {
   fun <- x@.Data
 
   method_body <- body(fun)
-  if (!is_call(method_body)) return(fun)
-  if (length(method_body) == 0) return(fun)
-  if (!identical(method_body[[1]], quote(`{`))) return(fun)
+  if (!is_call(method_body, ""{"")) return(fun)
+  if (length(method_body) < 2) return(fun)
 
   first_line <- method_body[[2]]
   if (!is_call(first_line, name = ""<-"", n = 2)) return(fun)

---FILE: tests/testthat/test-object-from-call.R---
@@ -1,3 +1,17 @@
+test_that(""finds correct parser even when namespaced"", {
+  env <- pkg_env()
+  setClass(""Foo"", where = env)
+  setGeneric(""bar"", function(x) standardGeneric(""bar""), where = env)
+
+  call <- quote(
+    methods::setMethod('bar', 'Foo', function(x) {})
+  )
+  eval(call, envir = env)
+
+  obj <- object_from_call(call, env, block = NULL, file = NULL)
+  expect_s3_class(obj, ""s4method"")
+})
+
 test_that(""finds arguments when S4 method wrapped inside .local()"", {
   env <- pkg_env()
   setClass(""Foo"", where = env)"
r-lib,roxygen2,a7f38b7ec794b58378ceb828bec64ba6b6fd675e,Hadley Wickham,h.wickham@gmail.com,2019-08-22T12:44:01Z,Hadley Wickham,h.wickham@gmail.com,2019-08-22T12:44:01Z,"Don't strip whitespace in intro block

Fixes #789",R/block.R;tests/testthat/test-block.R,False,True,True,False,18,1,19,"---FILE: R/block.R---
@@ -199,7 +199,7 @@ parse_description <- function(tags) {
   tags <- tags[-1]
   tag_names <- tag_names[-1]
 
-  paragraphs <- str_trim(str_split(intro$val, fixed('\n\n'))[[1]])
+  paragraphs <- str_split(intro$val, fixed('\n\n'))[[1]]
 
   # 1st paragraph = title (unless has @title)
   if (""title"" %in% tag_names) {

---FILE: tests/testthat/test-block.R---
@@ -9,3 +9,20 @@ test_that(""empty description block is silently removed"", {
     NA
   )
 })
+
+test_that(""description block preserves whitespace"", {
+  out <- parse_text(""
+    #' Title
+    #'
+    #' Line 1
+    #'   Line 2
+    #'
+    #' Line 1
+    #'   Line 2
+    f <- function() {}
+    ""
+  )[[1]]
+
+  expect_equal(out$description, ""Line 1\n  Line 2"")
+  expect_equal(out$details, ""Line 1\n  Line 2"")
+})"
r-lib,roxygen2,8c8c567492d38cef74154837639c7124bdbc9923,Hadley Wickham,h.wickham@gmail.com,2019-08-22T12:10:26Z,Hadley Wickham,h.wickham@gmail.com,2019-08-22T12:10:26Z,"Re-enable document keyboard shortcut

Now that I have fix for devtools (https://github.com/r-lib/devtools/pull/2092)",roxygen.Rproj,False,False,False,False,1,0,1,"---FILE: roxygen.Rproj---
@@ -18,3 +18,4 @@ StripTrailingWhitespace: Yes
 BuildType: Package
 PackageUseDevtools: Yes
 PackageInstallArgs: --no-multiarch --with-keep.source
+PackageRoxygenize: rd,collate,namespace"
r-lib,roxygen2,4c7ef65ce794dc7ea346b2eefd7bca9b4eb3d403,Hadley Wickham,h.wickham@gmail.com,2019-08-22T12:00:16Z,Hadley Wickham,h.wickham@gmail.com,2019-08-22T12:00:16Z,"Mention Rcpp

Fixes #686",vignettes/roxygen2.Rmd,True,False,True,False,48,0,48,"---FILE: vignettes/roxygen2.Rmd---
@@ -102,3 +102,51 @@ add(10, 1)
 Rd files are a special file format loosely based on LaTeX. You can read more about the Rd format in the [R extensions](https://cran.r-project.org/doc/manuals/R-exts.html#Rd-format) manual. With roxygen2, there are few reasons to know about Rd files, so here I'll avoid discussing them as much as possible, focussing instead on what you need to know about roxygen2.
 
 When you use `?x`, `help(""x"")` or `example(""x"")` R looks for an Rd file containing `\alias{x}`. It then parses the file, converts it into html and displays it. These functions look for an Rd file in _installed_ packages. This isn't very useful for package development, because you want to use the `.Rd` files in the _source_ package. For this reason, we recommend that you use roxygen2 in conjunction with devtools: `devtools::load_all()` automatically adds shims so that `?` and friends will look in the development package. Note, however, that this preview does not work with intra-package links. To preview those, you'll need to install the package. If you use RStudio, the easiest way to do this is to click the ""Build & Reload button"".
+
+### RCpp
+
+You can also use roxygen2 with Rcpp. Simply include roxygen2 comments in your C++ code (using `//` instead of `#`), and Rcpp will automatically carry the comments along into `RcppExports.R` where roxygen2 will find them. 
+
+For example, dplyr has `between.cpp` which starts:
+
+```cpp
+//' Do values in a numeric vector fall in specified range?
+//'
+//' This is a shortcut for `x >= left & x <= right`, implemented
+//' efficiently in C++ for local values, and translated to the
+//' appropriate SQL for remote tables.
+//'
+//' @param x A numeric vector of values
+//' @param left,right Boundary values
+//' @export
+//' @examples
+//' between(1:12, 7, 9)
+//'
+//' x <- rnorm(1e2)
+//' x[between(x, -1, 1)]
+// [[Rcpp::export(rng = false)]]
+Rcpp::LogicalVector between(Rcpp::NumericVector x, double left, double right) {
+}
+```
+
+This is automatically translated to the following R code in `RcppExports.R`:
+
+```{r, eval = FALSE}
+#' Do values in a numeric vector fall in specified range?
+#'
+#' This is a shortcut for `x >= left & x <= right`, implemented
+#' efficiently in C++ for local values, and translated to the
+#' appropriate SQL for remote tables.
+#'
+#' @param x A numeric vector of values
+#' @param left,right Boundary values
+#' @export
+#' @examples
+#' between(1:12, 7, 9)
+#'
+#' x <- rnorm(1e2)
+#' x[between(x, -1, 1)]
+between <- function(x, left, right) {
+}
+```
+"
r-lib,roxygen2,844e14aa81152e1220cc481d5b6e125e4a9161a6,Hadley Wickham,h.wickham@gmail.com,2019-08-22T12:00:02Z,Hadley Wickham,h.wickham@gmail.com,2019-08-22T12:00:02Z,"Better warning for unsupported rmarkdown features

Fixes #804",NEWS.md;R/markdown.R;tests/testthat/test-markdown.R,False,True,True,False,13,5,18,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* Use of unsupported markdown features (blockquotes, headings, inline HTML, 
+  and horizontal rules) now gets a more informative error message (#804).
+
 * `tag_markdown_restricted()` has been removed because it did exactly the
   same think as `tag_markdown()`.
 

---FILE: R/markdown.R---
@@ -53,10 +53,10 @@ mdxml_node_to_rd <- function(xml, tag) {
     image = mdxml_image(xml),
 
     # Not supported
-    header = ,
-    block_quote = ,
-    hrule = ,
-    html_inline = ,
+    heading = mdxml_unsupported(xml, tag, ""markdown headings""),
+    block_quote = mdxml_unsupported(xml, tag, ""block quotes""),
+    hrule = mdxml_unsupported(xml, tag, ""horizontal rules""),
+    html_inline = mdxml_unsupported(xml, tag, ""inline HTML""),
     mdxml_unknown(xml, tag)
   )
 }
@@ -65,6 +65,11 @@ mdxml_unknown <- function(xml, tag) {
   roxy_tag_warning(tag, ""Unknown xml node: "", xml_name(xml))
   xml_text(xml)
 }
+mdxml_unsupported <- function(xml, tag, feature) {
+  roxy_tag_warning(tag, ""Use of "", feature, "" is not currently supported"")
+  xml_text(xml)
+}
+
 
 # A list, either bulleted or numbered
 mdxml_list <- function(xml, tag) {

---FILE: tests/testthat/test-markdown.R---
@@ -433,5 +433,5 @@ test_that(""unhandled markdown generates warning"", {
     #' @name x
     NULL
   ""
-  expect_warning(roc_proc_text(rd_roclet(), text), ""heading"")
+  expect_warning(roc_proc_text(rd_roclet(), text), ""markdown headings"")
 })"
r-lib,roxygen2,2373703958af6b7f7f22d494aa3479431375bc82,Hadley Wickham,h.wickham@gmail.com,2019-08-13T15:26:07Z,Hadley Wickham,h.wickham@gmail.com,2019-08-13T15:26:07Z,"Note about package aliases

Fixes #861",vignettes/rd.Rmd,True,False,True,False,5,3,8,"---FILE: vignettes/rd.Rmd---
@@ -234,9 +234,11 @@ Some notes:
 
 * Like for datasets, there isn't a object that we can document directly. Use
   `""_PACKAGE""` to indicate that you are creating the package's documentation.
-  This will automatically add the correct aliases so that both `?pkgname`
-  and `package?pkgname` will find the package help. This also works if there's
-  already a function called `pkgname()`.
+  
+* By default, aliases will be added so that both `?pkgname` and 
+  `package?pkgname` will find the package help. If there's an existing function
+  called `pkgname`, override the default aliases with 
+  `@aliases {pkgname}-package`
 
 * Use `@references` point to published material about the package that
   users might find helpful."
r-lib,roxygen2,124af7ab08daa7c2019ffbb29434125b31d879c4,Hadley Wickham,h.wickham@gmail.com,2019-08-13T15:17:50Z,Hadley Wickham,h.wickham@gmail.com,2019-08-13T15:17:50Z,"More details on @eval and @evalRd

Fixes #761",vignettes/rd.Rmd,True,False,True,False,57,1,58,"---FILE: vignettes/rd.Rmd---
@@ -382,7 +382,63 @@ times <- function(x, y) x * y
 
 ### Evaluating arbitrary code
 
-A new and powerful technique is the `@eval` tag. It evaluates code and treatments the result as if it was a literal roxygen tags. This makes it possible to eliminate duplication by writing functions.
+A new and powerful technique is the `@eval` tag. It evaluates code and treatments the result as if it was a literal roxygen tags. This makes it possible to eliminate duplication by writing functions. The code will be evaluated in the package environment and should yield a character vector of roxygen comments (but without the leading `#'`).
+
+
+For example, this code + roxygen block:
+
+```{r}
+my_params <- function() {
+  c(
+    ""@param x An integer vector"",
+    ""@param y A character vector""
+  )
+}
+
+#' A title
+#' 
+#' @eval my_params()
+#' @export
+foo <- function(x, y) {
+}
+```
+
+Is equivalent to:
+
+```{r}
+#' A title
+#' 
+#' @param x An integer vector
+#' @param y A character vector
+#' @export
+foo <- function(x, y) {
+}
+```
+
+A related function is `@evalRd`. It works in the same way as `@eval` (i.e. it's evaluated in the package environment) but rather than yielding roxygen comments that are processed as if they had been typed directly, it yields top-level Rd code that is inserted directly into the generated `.Rd` file. It is primarily useful if you want to generate Rd structure that is not currently supported by roxygen2.
+
+For example, this block:
+
+```{r}
+my_note <- function(x) {
+  paste0(""\\note{"", paste0(x, ""\n"", collapse =""""), ""}"")
+}
+
+#' @evalRd my_note(
+#'   ""This is the first line"",
+#'   ""This is the second line""
+#' )
+NULL
+```
+
+Would generate this Rd:
+
+```latex
+\note{
+This is the first line
+This is the second line
+}
+```
 
 ### Roxygen templates
 "
r-lib,roxygen2,a5a0f2b01bb9e8f81bc6d65ed9c866f9c93d45f9,Hadley Wickham,h.wickham@gmail.com,2019-08-12T21:48:14Z,Hadley Wickham,h.wickham@gmail.com,2019-08-12T21:48:14Z,"Make it more clear what inheritSection inherits

Fixes #722",vignettes/rd.Rmd,True,False,True,False,1,1,2,"---FILE: vignettes/rd.Rmd---
@@ -366,7 +366,7 @@ You can inherit documentation from other functions in a few ways:
   from `source_function()`.
 
 * `@inheritSection source_function Section title` will inherit the single 
-  section called ""Section title"" from `source_function()`.
+  `@section` called ""Section title"" from `source_function()`.
   
 All of these work recursively so you can inherit documentation from a function that has inherited it from elsewhere.
 "
r-lib,roxygen2,ada1f2fffc54bfed66b1e2f34ba50b28ce23698a,Hadley Wickham,h.wickham@gmail.com,2019-08-12T21:47:00Z,Hadley Wickham,h.wickham@gmail.com,2019-08-12T21:47:00Z,"Nicely format ORCIDs

Fixes #721",DESCRIPTION;NEWS.md;R/object-package.R;man/roxygen2-package.Rd,False,True,True,False,13,3,16,"---FILE: DESCRIPTION---
@@ -5,7 +5,8 @@ Authors@R:
     c(person(given = ""Hadley"",
              family = ""Wickham"",
              role = c(""aut"", ""cre"", ""cph""),
-             email = ""hadley@rstudio.com""),
+             email = ""hadley@rstudio.com"",
+             comment = c(""ORCID"" = ""0000-0003-4757-117X"")),
       person(given = ""Peter"",
              family = ""Danenberg"",
              role = c(""aut"", ""cph""),

---FILE: NEWS.md---
@@ -1,5 +1,7 @@
 # roxygen2 (development version)
 
+* Package documentation now converts ORCIDs into a useful link (#721).
+
 * Empty roxygen2 lines at the start of a block are now silently removed (#710).
 
 * S4 methods that generate `.local()` wrapper no longer error with obscure

---FILE: R/object-package.R---
@@ -47,7 +47,14 @@ author_desc <- function(x) {
   }
 
   if (!is.null(x$comment)) {
-    desc <- paste0(desc, "" ("", x$comment, "")"")
+    if (has_name(x$comment, ""ORCID"")) {
+      desc <- paste0(desc, "" (\\href{https://orcid.org/"", x$comment[[""ORCID""]], ""}{ORCID})"")
+      x$comment <- x$comment[setdiff(x$comments, ""ORCID"")]
+    }
+
+    if (length(x$comment) > 0) {
+      desc <- paste0(desc, "" ("", x$comment, "")"")
+    }
   }
 
   extra_roles <- setdiff(x$role, c(""cre"", ""aut""))

---FILE: man/roxygen2-package.Rd---
@@ -32,7 +32,7 @@ Useful links:
 
 }
 \author{
-\strong{Maintainer}: Hadley Wickham \email{hadley@rstudio.com} [copyright holder]
+\strong{Maintainer}: Hadley Wickham \email{hadley@rstudio.com} (\href{https://orcid.org/0000-0003-4757-117X}{ORCID}) [copyright holder]
 
 Authors:
 \itemize{"
r-lib,roxygen2,df5f71aeafa3eb40c5fb06bef214139f57181d91,Hadley Wickham,h.wickham@gmail.com,2019-08-12T21:37:39Z,Hadley Wickham,h.wickham@gmail.com,2019-08-12T21:37:39Z,"Silently remove empty description blocks

Fixes #710",NEWS.md;R/block.R;tests/testthat/test-block.R,False,True,True,False,17,0,17,"---FILE: NEWS.md---
@@ -1,5 +1,7 @@
 # roxygen2 (development version)
 
+* Empty roxygen2 lines at the start of a block are now silently removed (#710).
+
 * S4 methods that generate `.local()` wrapper no longer error with obscure
   error message (#847).
 

---FILE: R/block.R---
@@ -192,6 +192,10 @@ parse_description <- function(tags) {
 
   intro <- tags[[1]]
   intro$val <- str_trim(intro$val)
+  if (intro$val == """") {
+    return(tags[-1])
+  }
+
   tags <- tags[-1]
   tag_names <- tag_names[-1]
 

---FILE: tests/testthat/test-block.R---
@@ -0,0 +1,11 @@
+test_that(""empty description block is silently removed"", {
+  expect_warning(
+    roc_proc_text(rd_roclet(), ""
+      #'
+      #'
+      f <- function() {}
+      ""
+    ),
+    NA
+  )
+})"
r-lib,roxygen2,8c7fc134263045d86a779f90ac8f759e206fd8b9,Hadley Wickham,h.wickham@gmail.com,2019-08-12T21:04:15Z,Hadley Wickham,h.wickham@gmail.com,2019-08-12T21:05:12Z,"Fix S4 .local wrapper extraction

I guess this never worked :shrug:

Fixes #847",NEWS.md;R/object-from-call.R;R/object.R;tests/testthat/test-object-from-call.R,False,True,True,False,46,27,73,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 (development version)
 
+* S4 methods that generate `.local()` wrapper no longer error with obscure
+  error message (#847).
+
 * `@param` containing only whitespce gets a clear warning message (#869).
 
 * A new system for providing custom roxygen2 metadata is now available. When

---FILE: R/object-from-call.R---
@@ -158,3 +158,34 @@ parser_setConstructorS3 <- function(call, env, block) {
   value <- standardise_obj(name, get(name, env), env, block)
   object(value, name)
 }
+
+
+# helpers -----------------------------------------------------------------
+
+# When a generic has ... and a method adds new arguments, the S4 method
+# wraps the definition inside another function which has the same arguments
+# as the generic. This function figures out if that's the case, and extracts
+# the original function if so.
+#
+# It's based on expression processing based on the structure of the
+# constructed method which looks like:
+#
+# function (x, ...) {
+#   .local <- function (x, ..., y = 7) {}
+#   .local(x, ...)
+# }
+extract_method_fun <- function(x) {
+  fun <- x@.Data
+
+  method_body <- body(fun)
+  if (!is_call(method_body)) return(fun)
+  if (length(method_body) == 0) return(fun)
+  if (!identical(method_body[[1]], quote(`{`))) return(fun)
+
+  first_line <- method_body[[2]]
+  if (!is_call(first_line, name = ""<-"", n = 2)) return(fun)
+  if (!identical(first_line[[2]], quote(`.local`))) return(fun)
+
+  eval(first_line[[3]])
+}
+

---FILE: R/object.R---
@@ -49,33 +49,6 @@ is_generator <- function(x) {
   methods::is(x, ""refObjectGenerator"") || methods::is(x, ""classGeneratorFunction"")
 }
 
-# When a generic has ... and a method adds new arguments, the S4 method
-# wraps the definition inside another function which has the same arguments
-# as the generic. This function figures out if that's the case, and extracts
-# the original function if so.
-#
-# It's based on expression processing based on the structure of the
-# constructed method which looks like:
-#
-# function (x, ...) {
-#   .local <- function (x, ..., y = 7) {}
-#   .local(x, ...)
-# }
-extract_method_fun <- function(x) {
-  fun <- x@.Data
-
-  method_body <- body(fun)
-  if (!is.call(method_body)) return(fun)
-  if (!identical(method_body[[1]], quote(`{`))) return(fun)
-
-  first_line <- method_body[[2]]
-  if (!is.call(first_line)) return(fun)
-  if (!identical(first_line[[1]], quote(`<-`))) return(fun)
-  if (!identical(first_line[[2]], quote(`.local`))) return(fun)
-
-  first_line[[3]]
-}
-
 # Consistent naming scheme for R object classes --------------------------------
 # (s3/s4/rc x generic/class/method, function, data)
 

---FILE: tests/testthat/test-object-from-call.R---
@@ -0,0 +1,12 @@
+test_that(""finds arguments when S4 method wrapped inside .local()"", {
+  env <- pkg_env()
+  setClass(""Foo"", where = env)
+  call <- quote(
+    setMethod('subset', 'Foo', function(x, foo, ...) {})
+  )
+  eval(call, envir = env)
+
+  obj <- object_from_call(call, env, block = NULL, file = NULL)
+  expect_s3_class(obj, ""s4method"")
+  expect_named(formals(obj$value@.Data), c(""x"", ""foo"", ""...""))
+})"
r-lib,roxygen2,059bd677b8843c9aa81d3a4bb1d6158db232eb56,Hadley Wickham,h.wickham@gmail.com,2019-08-12T20:55:42Z,Hadley Wickham,h.wickham@gmail.com,2019-08-12T21:05:12Z,"Don't roxygenise self

(Since it crashes R, due to some subtle code re-loading bug)",roxygen.Rproj,False,False,False,False,0,1,1,"---FILE: roxygen.Rproj---
@@ -18,4 +18,3 @@ StripTrailingWhitespace: Yes
 BuildType: Package
 PackageUseDevtools: Yes
 PackageInstallArgs: --no-multiarch --with-keep.source
-PackageRoxygenize: rd,collate,namespace"
r-lib,roxygen2,13e2062ba22c6411cdf0a72db541422b6bb6f45c,Hadley Wickham,h.wickham@gmail.com,2019-08-08T19:31:51Z,Hadley Wickham,h.wickham@gmail.com,2019-08-08T19:31:51Z,Fix release article,vignettes/releases/roxygen2-6.0.0.Rmd,True,False,True,False,1,2,3,"---FILE: vignettes/releases/roxygen2-6.0.0.Rmd---
@@ -7,13 +7,12 @@ knitr::opts_chunk$set(
   comment = ""#>"", 
   collapse = TRUE
 )
-library(readr)
 ```
 
 roxygen2 6.0.0 is now available on CRAN. roxygen2 helps you document your packages by turning specially formatted inline comments into R's standard Rd format. It automates everything that can be automated, and provides helpers for sharing documentation between topics. Learn more at <http://r-pkgs.had.co.nz/man.html>. Install the latest version with:
 
 ```{r, eval = FALSE}
-install.packages(""readr"")
+install.packages(""roxygen2"")
 ```
 
 There are two headline features in this version of roxygen2:"
r-lib,roxygen2,0724206a167f0ab8a3feb6d892cb1688ac9cec4a,Hadley Wickham,h.wickham@gmail.com,2019-07-25T21:02:08Z,Hadley Wickham,h.wickham@gmail.com,2019-07-25T21:02:08Z,"Check for @param containing only whitespace

Fixes #869",NEWS.md;R/tag.R;tests/testthat/test-rd-param.R,False,True,True,False,13,1,14,"---FILE: NEWS.md---
@@ -1,5 +1,7 @@
 # roxygen2 (development version)
 
+* `@param` containing only whitespce gets a clear warning message (#869).
+
 * A new system for providing custom roxygen2 metadata is now available. When
   `roxygenise()` is called, if a file ""man/roxygen/meta.R"" exists, it will be
   evaluated. Its evaluation should produce an R list, mapping roxygen option

---FILE: R/tag.R---
@@ -132,7 +132,7 @@ tag_two_part <- function(first, second, required = TRUE) {
   ## override this behavior
 
   function(x) {
-    if (x$val == """") {
+    if (str_trim(x$val) == """") {
       roxy_tag_warning(x, ""requires a value"")
     } else if (required && !str_detect(x$val, ""[[:space:]]+"")) {
       roxy_tag_warning(x, ""requires "", first, "" and "", second)

---FILE: tests/testthat/test-rd-param.R---
@@ -22,6 +22,16 @@ test_that(""grouped args get spaces"", {
   expect_match(format(args), ""a, z"")
 })
 
+test_that(""empty @param generates warning"", {
+  expect_warning(
+    roc_proc_text(rd_roclet(), ""
+    #' A
+    #' @param
+    #'
+    a <- function() {}""),
+    ""requires a value""
+  )
+})
 
 test_that(""data objects don't get params"", {
   out <- roc_proc_text(rd_roclet(), """
r-lib,roxygen2,50ff745187d03aea265301b4cb81c785a4a7d7f2,Hadley Wickham,h.wickham@gmail.com,2019-07-25T20:52:50Z,Hadley Wickham,h.wickham@gmail.com,2019-07-25T20:53:00Z,"Add support with roxygen2 specific reprex advice

Fixes #881",.Rbuildignore;.github/.gitignore;.github/SUPPORT.md,False,False,False,False,71,0,71,"---FILE: .Rbuildignore---
@@ -11,3 +11,4 @@
 ^revdep$
 ^codecov\.yml$
 ^appveyor\.yml$
+^\.github$

---FILE: .github/.gitignore---
@@ -0,0 +1 @@
+*.html

---FILE: .github/SUPPORT.md---
@@ -0,0 +1,69 @@
+# Getting help with roxygen2
+
+Thanks for using roxygen2. Before filing an issue, there are a few places
+to explore and pieces to put together to make the process as smooth as possible.
+
+## Making a reprex
+
+Start by making a minimal **repr**oducible **ex**ample using the 
+[reprex](https://reprex.tidyverse.org/) package. If you haven't heard of or used 
+reprex before, you're in for a treat! Seriously, reprex will make all of your 
+R-question-asking endeavors easier (which is a pretty insane ROI for the five to 
+ten minutes it'll take you to learn what it's all about). For additional reprex
+pointers, check out the [Get help!](https://www.tidyverse.org/help/) section of
+the tidyverse site.
+
+roxygen2 issues can be tricky to create a minimal reprex for. There are two general techniques that can help:
+
+*   If you know the source of the problem, you can often recreate it using a 
+    `roc_proc_text()` and text snippet:
+
+    ```R
+    library(roxygen2)
+    roc_proc_text(rd_roclet(), ""
+      #' Title
+      #' @param
+      #'
+      #' @export
+      foo <- function() {}""
+    )
+    #> Error in FUN(X[[i]], ...): subscript out of bounds
+    ```
+    
+    It's really helpful if you can spend a little time reducing the text
+    to the absolute minimum. Make sure you delete the body of the function
+    (since roxygen2 never looks at it), and try each roxygen2 tag in turn.
+    Only leave a tag in if you've confirmed it's definitely part of the 
+    problem.
+    
+*   Issues that involve multiple files or that don't give useful error messages
+    are harder to track down. In these cases, sometimes your best option is
+    to create a copy of your package, and progressively delete files until the
+    problem goes away. Once you've done that, sometimes you'll be able to 
+    reduce the problem further to a call to `roc_proc_text()` as above. If not,
+    you'll need to make your minimal package available somewhere on the internet
+    (preferrably github) and link to it in the issue. The more you can do to
+    make the package as small as possible, the less time it'll take me to
+    find the bug, and the more time I'll have to work on it.
+
+## Where to ask
+
+Armed with your reprex, the next step is to figure out [where to ask](https://www.tidyverse.org/help/#where-to-ask). 
+
+  * If it's a question: start with [community.rstudio.com](https://community.rstudio.com/), 
+    and/or StackOverflow. There are more people there to answer questions.  
+  * If it's a bug: you're in the right place, file an issue.  
+  * If you're not sure: let the community help you figure it out! If your 
+    problem _is_ a bug or a feature request, you can easily return here and 
+    report it. 
+
+Before opening a new issue, be sure to [search issues and pull requests](https://github.com/tidyverse/roxygen2/issues) to make sure the 
+bug hasn't been reported and/or already fixed in the development version. By 
+default, the search will be pre-populated with `is:issue is:open`. You can 
+[edit the qualifiers](https://help.github.com/articles/searching-issues-and-pull-requests/) 
+(e.g. `is:pr`, `is:closed`) as needed. For example, you'd simply
+remove `is:open` to search _all_ issues in the repo, open or closed.
+
+## General advice
+
+To be as efficient as possible, development of tidyverse packages tends to be very bursty. Nothing happens for a long time, until a sufficient quantity of issues accumulates, and then there뗩 a burst of intense activity as we focus our efforts. That makes development more efficient because it avoids expensive context switching between problems. This process makes a good reprex particularly important because it might be multiple months between your initial report and when we start working on it. If you can뗪 reproduce the bug, we can뗪 fix it!"
r-lib,roxygen2,d44780ecbd3a6e6e7ff7b01009c91475514345b4,Michael McLaren,m.mclaren42@gmail.com,2019-06-29T16:53:18Z,GitHub,noreply@github.com,2019-06-29T16:53:18Z,"Update Rd vignette to refer to Markdown vignette

Fixes #871",vignettes/rd.Rmd,True,False,True,False,3,3,6,"---FILE: vignettes/rd.Rmd---
@@ -97,15 +97,15 @@ This introductory block is broken up as follows:
 *  The third and subsequent paragraphs go into the __details__: this is a
    (often long) section that comes after the argument description and should 
    provide any other important details of how the function operates. The 
-   details are optional..
+   details are optional.
 
-Note that you can use markdown formatting within roxygen blocks, as long as you have the following in the `DESCRIPTION`:
+Text within roxygen blocks can be formatted using `.Rd` syntax; see [formatting](formatting.html) for examples and [R extensions](https://cran.r-project.org/doc/manuals/R-exts.html#Marking-text) for full details. You can also use Markdown formatting within roxygen blocks, as long as you have the following in the `DESCRIPTION`:
 
 ```
 Roxygen: list(markdown = TRUE)
 ```
 
-We'll discuss that more in [formatting](formatting.html). Also note the wrapping of the roxygen block. You should make sure that your comments are less than ~80 columns wide.
+We'll discuss that more in [Markdown](markdown.html). Also note the wrapping of the roxygen block. You should make sure that your comments are less than ~80 columns wide.
 
 ## Object specifics
 "
r-lib,roxygen2,9adcc8ecb874a802e6947bcd0bd65ff771704a43,hadley,h.wickham@gmail.com,2018-11-02T15:33:07Z,hadley,h.wickham@gmail.com,2018-11-02T15:33:07Z,"Don't recompile C source code

Fixes #784",DESCRIPTION;NEWS.md;R/parse.R,False,True,True,False,8,2,10,"---FILE: DESCRIPTION---
@@ -22,7 +22,7 @@ Imports:
     desc (>= 1.2.0),
     digest,
     methods,
-    pkgload,
+    pkgload (>= 1.0.2),
     purrr,
     R6 (>= 2.1.2),
     Rcpp (>= 0.11.0),

---FILE: NEWS.md---
@@ -1,5 +1,7 @@
 # roxygen2 6.1.0.9000
 
+* `roxygenise()` no longer recompiles packages containing src code (#784).
+
 * Correctly parse multi-line DESCRIPTION collate directives (@brodieG, #790).
 
 * `roxygenize()` now stops with an informative error message when run in a

---FILE: R/parse.R---
@@ -105,5 +105,9 @@ env_file <- function(file) {
 #' @export
 #' @rdname parse_package
 env_package <- function(path) {
-  pkgload::load_all(path)$env
+  pkgload::load_all(path,
+    compile = FALSE,
+    helpers = FALSE,
+    attach_testthat = FALSE
+  )$env
 }"
r-lib,roxygen2,a2ea4684820b37871afabd09ac28d29057cf6c70,G치bor Cs치rdi,csardi.gabor@gmail.com,2018-10-23T14:02:48Z,Hadley Wickham,h.wickham@gmail.com,2018-10-23T14:02:48Z,"Fix MD link test case (#811)

Closes #809. Do not regex match XML, that
was a bad idea.",tests/testthat/test-rd-markdown-links.R,False,True,True,False,16,24,40,"---FILE: tests/testthat/test-rd-markdown-links.R---
@@ -71,33 +71,25 @@ test_that(""% in links are escaped"", {
 
 test_that(""commonmark picks up the various link references"", {
   cases <- list(
-    c(""foo [func()] bar"",
-      ""<link destination=\""R:func\\(\\)\"" title=\""\"">\\s*<text>func\\(\\)</text>""),
-    c(""foo [obj] bar"",
-      ""<link destination=\""R:obj\"" title=\""\"">\\s*<text>obj</text>""),
-    c(""foo [text][func()] bar"",
-      ""<link destination=\""R:func\\(\\)\"" title=\""\"">\\s*<text>text</text>""),
-    c(""foo [text][obj] bar"",
-      ""<link destination=\""R:obj\"" title=\""\"">\\s*<text>text</text>""),
-    c(""foo [pkg::func()] bar"",
-      ""<link destination=\""R:pkg::func\\(\\)\"" title=\""\"">\\s*<text>pkg::func\\(\\)</text>""),
-    c(""foo [pkg::obj] bar"",
-      ""<link destination=\""R:pkg::obj\"" title=\""\"">\\s*<text>pkg::obj</text>""),
-    c(""foo [text][pkg::func()] bar"",
-      ""<link destination=\""R:pkg::func\\(\\)\"" title=\""\"">\\s*<text>text</text>""),
-    c(""foo [text][pkg::obj] bar"",
-      ""<link destination=\""R:pkg::obj\"" title=\""\"">\\s*<text>text</text>""),
-    c(""foo [linktos4-class] bar"",
-      ""<link destination=\""R:linktos4-class\"" title=\""\"">\\s*<text>linktos4-class</text>""),
-    c(""foo [pkg::s4-class] bar"",
-      ""<link destination=\""R:pkg::s4-class\"" title=\""\"">\\s*<text>pkg::s4-class</text>"")
+    list(""foo [func()] bar"",            c(""R:func()"", ""func()"")),
+    list(""foo [obj] bar"",               c(""R:obj"", ""obj"")),
+    list(""foo [text][func()] bar"",      c(""R:func()"", ""text"")),
+    list(""foo [text][obj] bar"",         c(""R:obj"", ""text"")),
+    list(""foo [pkg::func()] bar"",       c(""R:pkg::func()"", ""pkg::func()"")),
+    list(""foo [pkg::obj] bar"",          c(""R:pkg::obj"", ""pkg::obj"")),
+    list(""foo [text][pkg::func()] bar"", c(""R:pkg::func()"", ""text"")),
+    list(""foo [text][pkg::obj] bar"",    c(""R:pkg::obj"", ""text"")),
+    list(""foo [linktos4-cl] bar"",       c(""R:linktos4-cl"", ""linktos4-cl"")),
+    list(""foo [pkg::s4-cl] bar"",        c(""R:pkg::s4-cl"", ""pkg::s4-cl""))
   )
 
   for (i in seq_along(cases)) {
-    expect_match(
-      commonmark::markdown_xml(add_linkrefs_to_md(cases[[i]][1])),
-      cases[[i]][2]
-    )
+    x <- commonmark::markdown_xml(add_linkrefs_to_md(cases[[i]][[1]]))
+    xdoc <- xml2::xml_ns_strip(xml2::read_xml(x))
+    link <- xml2::xml_find_first(xdoc, ""//link"")
+    expect_equal(xml2::xml_attr(link, ""destination""), cases[[i]][[2]][1])
+    text <- xml2::xml_find_first(link, ""./text"")
+    expect_equal(xml2::xml_text(text), cases[[i]][[2]][2], info = i)
   }
 })
 "
r-lib,roxygen2,7a643326ad236b9576ee925fc9f56da043fbf7c6,G치bor Cs치rdi,csardi.gabor@gmail.com,2018-10-23T14:01:47Z,Hadley Wickham,h.wickham@gmail.com,2018-10-23T14:01:47Z,"Fix warnings in collate tests (#812)

Getting the `Collate` now checks that the files actually
exist, and warns if they don't. So we add dummy files to
the test case.

Fixes issue reported here:
https://github.com/klutometis/roxygen/commit/cc34200a598d02850020c874fdd0d6a82747f28e#commitcomment-31002481",tests/testthat/test-collate.R;tests/testthat/testCollateParse/R/b.r;tests/testthat/testCollateParse/R/c.r,False,True,True,False,5,1,6,"---FILE: tests/testthat/test-collate.R---
@@ -50,6 +50,6 @@ test_that(""DESCRIPTION file is re-written only if collate changes"", {
 test_that(""Collate with one file name per line (#790)"", {
   expect_equal(
     package_files('testCollateParse'),
-    c(""testCollateParse/R/b.r"", ""testCollateParse/R/c.r"")
+    normalizePath(c(""testCollateParse/R/b.r"", ""testCollateParse/R/c.r""))
   )
 })

---FILE: tests/testthat/testCollateParse/R/b.r---
@@ -0,0 +1,2 @@
+
+b <- function() { }

---FILE: tests/testthat/testCollateParse/R/c.r---
@@ -0,0 +1,2 @@
+
+c <- function() { }"
r-lib,roxygen2,cc34200a598d02850020c874fdd0d6a82747f28e,Brodie Gaslam,brodieG@users.noreply.github.com,2018-09-12T12:18:02Z,Hadley Wickham,h.wickham@gmail.com,2018-09-12T12:18:02Z,"Use 'desc::desc_get_collate' directly (#791)

Fixes #790. Fixes #785. Fixes #760.",NEWS.md;R/source.R;tests/testthat/test-collate.R;tests/testthat/testCollateParse/DESCRIPTION,False,True,True,False,23,14,37,"---FILE: NEWS.md---
@@ -1,9 +1,11 @@
 # roxygen2 6.1.0.9000
 
+* Correctly parse multi-line DESCRIPTION collate directives (@brodieG, #790).
+
 * `roxygenize()` now stops with an informative error message when run in a
   directory that's not the package root (@mikmart, #704).
 
-* roxygen2 now specifically imports desc >= 1.2.0 (@crsh, #773, #777, #779)
+* roxygen2 now specifically imports desc >= 1.2.0 (@crsh, #773, #777, #779).
 
 # roxygen2 6.1.0
 

---FILE: R/source.R---
@@ -1,20 +1,10 @@
 package_files <- function(path) {
-  desc <- read_pkg_description(path)
-
   all <- normalizePath(r_files(path))
 
-  collate <- scan(text = desc$Collate %||% """", what = """", sep = "" "",
-    quiet = TRUE)
+  collate <- desc::desc_get_collate(file = file.path(path, ""DESCRIPTION""))
 
-  collate <- normalizePath(file.path(path, 'R', collate))
+  collate <- normalizePath(file.path(path, ""R"", collate))
 
   rfiles <- c(collate, setdiff(all, collate))
   ignore_files(rfiles, path)
 }
-
-read_pkg_description <- function(path) {
-  desc_path <- file.path(path, ""DESCRIPTION"")
-  if (!file.exists(desc_path)) stop(""Can't find DESCRIPTION"")
-
-  read.description(desc_path)
-}

---FILE: tests/testthat/test-collate.R---
@@ -47,4 +47,9 @@ test_that(""DESCRIPTION file is re-written only if collate changes"", {
 
  })
 
-
+test_that(""Collate with one file name per line (#790)"", {
+  expect_equal(
+    package_files('testCollateParse'),
+    c(""testCollateParse/R/b.r"", ""testCollateParse/R/c.r"")
+  )
+})

---FILE: tests/testthat/testCollateParse/DESCRIPTION---
@@ -0,0 +1,12 @@
+Package: testCollateParse
+Title: Tools to make developing R code easier
+License: GPL-2
+Description: A test to make sure collate field is parsed correctly when it has
+    a file name per line and is indented (#790).  This package only has a
+    DESCRIPTION file.
+Author: Brodie Gaslam <brodie.gaslam@yahoo.com>
+Maintainer: Brodie Gaslam <brodie.gaslam@yahoo.com>
+Version: 0.1
+Collate:
+    'b.r'
+    'c.r'"
r-lib,roxygen2,acb6ef7e3d97320adf0d5f5540cd7416be3fbce9,Mikko Marttila,mikmart@mikkomarttila.com,2018-09-10T21:48:28Z,Hadley Wickham,h.wickham@gmail.com,2018-09-10T21:48:28Z,"Stop roxygenize() quickly if DESCRIPTION not found (#704) (#756)

Fixes #704",NEWS.md;R/safety.R;tests/testthat/no-desc/NAMESPACE;tests/testthat/no-desc/R/no-description.R;tests/testthat/test-safety.R,False,True,True,False,26,0,26,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 6.1.0.9000
 
+* `roxygenize()` now stops with an informative error message when run in a
+  directory that's not the package root (@mikmart, #704).
+
 * roxygen2 now specifically imports desc >= 1.2.0 (@crsh, #773, #777, #779)
 
 # roxygen2 6.1.0

---FILE: R/safety.R---
@@ -1,4 +1,15 @@
 first_time <- function(path) {
+  description <- file.path(path, ""DESCRIPTION"")
+  if (!file.exists(description)) {
+    stop(
+      ""`package.dir` must include a DESCRIPTION file:\n"",
+      ""  * \"""", path, ""\"" does not.\n"",
+      ""Did you call `roxygenize()` in a directory "",
+      ""that is not the package root?"",
+      call. = FALSE
+    )
+  }
+
   generated <- dir(file.path(path, ""man""), full.names = TRUE)
   generated <- generated[!file.info(generated)$isdir]
 

---FILE: tests/testthat/no-desc/NAMESPACE---
@@ -0,0 +1 @@
+exportPattern(""^[[:alpha:]]+"")

---FILE: tests/testthat/no-desc/R/no-description.R---
@@ -0,0 +1 @@
+NULL

---FILE: tests/testthat/test-safety.R---
@@ -0,0 +1,10 @@
+context(""Safety"")
+
+test_that(""roxygenize stops without side effects if no DESCRIPTION found"", {
+  path <- test_path(""no-desc"")
+  namespace <- file.path(path, ""NAMESPACE"")
+
+  expect_error(roxygenize(path), ""must include a DESCRIPTION file"")
+  expect_equal(list.files(path), c(""NAMESPACE"", ""R""))
+  expect_false(made_by_roxygen(namespace))
+})"
r-lib,roxygen2,7032ed1ce5dd0a63a90de0a07a9ded0d8e1cc056,Frederik Aust,frederik.aust@uni-koeln.de,2018-08-21T13:06:36Z,Hadley Wickham,h.wickham@gmail.com,2018-08-21T13:06:36Z,"Specify version of desc package (#773)

Require desc 1.2.0

Fixes #777. Fixes #779.",DESCRIPTION;NEWS.md,False,False,False,False,3,1,4,"---FILE: DESCRIPTION---
@@ -19,7 +19,7 @@ Depends:
 Imports: 
     brew,
     commonmark,
-    desc,
+    desc (>= 1.2.0),
     digest,
     methods,
     pkgload,

---FILE: NEWS.md---
@@ -1,5 +1,7 @@
 # roxygen2 6.1.0.9000
 
+* roxygen2 now specifically imports desc >= 1.2.0 (@crsh, #773, #777, #779)
+
 # roxygen2 6.1.0
 
 ## New features"
r-lib,roxygen2,df88ae18552d6b93169784712f83986e2fcfc7f6,Maximilian Held,info@maxheld.de,2018-07-30T09:11:38Z,G치bor Cs치rdi,csardi.gabor@gmail.com,2018-07-30T09:11:38Z,fix some docs typos (#764),vignettes/rd.Rmd,True,False,True,False,3,3,6,"---FILE: vignettes/rd.Rmd---
@@ -66,7 +66,7 @@ add(10, 1)
 
 Rd files are a special file format loosely based on LaTeX. You can read more about the Rd format in the [R extensions](https://cran.r-project.org/doc/manuals/R-exts.html#Rd-format) manual. With roxygen2, there are few reasons to know about Rd files, so here I'll avoid discussing them as much as possible, focussing instead on what you need to know about roxygen2.
 
-When you use `?x`, `help(""x"")` or `example(""x"")` R looks for an Rd file containing `\alias{x}`. It then parses the file, converts it into html and displays it. These functions look for an Rd file in _installed_ packages. This isn't very useful for package development, because you want to use the `.Rd` files in the _source_ package. For this reason, we recommend that you use roxygen2 in conjunction with devtools:  `dwevtools::load_all()` automatically adds shims so that `?` and friends will look in the development package. Note, however, that this preview does not work with intra-package links. To preview those, you'll need to install the package. If you use RStudio, the easiest way to do this is to click the ""Build & Reload button"".
+When you use `?x`, `help(""x"")` or `example(""x"")` R looks for an Rd file containing `\alias{x}`. It then parses the file, converts it into html and displays it. These functions look for an Rd file in _installed_ packages. This isn't very useful for package development, because you want to use the `.Rd` files in the _source_ package. For this reason, we recommend that you use roxygen2 in conjunction with devtools: `devtools::load_all()` automatically adds shims so that `?` and friends will look in the development package. Note, however, that this preview does not work with intra-package links. To preview those, you'll need to install the package. If you use RStudio, the easiest way to do this is to click the ""Build & Reload button"".
 
 ## Basics
 
@@ -109,7 +109,7 @@ We'll discuss that more in [formatting](formatting.html). Also note the wrapping
 
 ## Object specifics
 
-Further details of roxygen2 depend on what you're documenting. You use use __tags__ like `@tag details`. Tags must start at the beginning of a line, and the content of a tag extends to the start of the next tag (or the end of the block). The following sections describe the most commonly used tags for functions, S3, S4, and RC objects and data set.
+Further details of roxygen2 depend on what you're documenting. You use __tags__ like `@tag details`. Tags must start at the beginning of a line, and the content of a tag extends to the start of the next tag (or the end of the block). The following sections describe the most commonly used tags for functions, S3, S4, and RC objects and data set.
 
 ### Functions
 
@@ -270,7 +270,7 @@ Package documentation should be placed in `pkgname.R`. Here's an example:
 ""_PACKAGE""
 ```
 
-I recommend using `@keyword internals` for package documentation.
+I recommend using `@keywords internal` for package documentation.
 
 Some notes:
 "
r-lib,roxygen2,4068897f02d53d8239d5dbfaa9c67911d67fb203,Jennifer (Jenny) Bryan,jenny.f.bryan@gmail.com,2018-07-24T22:53:32Z,Hadley Wickham,h.wickham@gmail.com,2018-07-24T22:53:32Z,Fix whitespace in more links (#760),NEWS.md;R/markdown.R;tests/testthat/test-rd-markdown-links.R,False,True,True,False,41,7,48,"---FILE: NEWS.md---
@@ -110,7 +110,8 @@
     * Code in link text is now properly rendered as code (#620, @egnha).
 
     * Whitespace between words in link text is now preserved as single
-      space (#628, @egnha).
+      space for links of the form `[text][fcn]` and `[text](URL)`
+      (#628, #754, #760, @egnha and @jennybc).
 
     * `%` in inline code (#640), code blocks (@nteetor, #699) and
       links (#724) is now automatically escaped.

---FILE: R/markdown.R---
@@ -209,7 +209,7 @@ markdown_tags <- list(
     } else if (dest == """" || dest == xml_text(xml)) {
       list(""\\url{"", xml_text(xml), ""}"")
     } else {
-      list(""\\href{"", dest, ""}{"", xml_href_text(xml), ""}"")
+      list(""\\href{"", dest, ""}{"", xml_link_text(contents), ""}"")
     }
   },
 
@@ -231,10 +231,9 @@ ws_to_empty <- function(x) {
 ## markdown_xml(), which then get interpreted as empty strings by
 ## xml_text(). So we preserve newlines as spaces.
 
-xml_href_text <- function(xml) {
-  cnts <- xml_contents(xml)
-  text <- xml_text(cnts)
-  text[xml_name(cnts) %in% c(""linebreak"", ""softbreak"")] <- "" ""
+xml_link_text <- function(xml_contents) {
+  text <- xml_text(xml_contents)
+  text[xml_name(xml_contents) %in% c(""linebreak"", ""softbreak"")] <- "" ""
   text
 }
 
@@ -377,7 +376,7 @@ parse_link <- function(destination, contents) {
     )
 
   } else {
-    contents <- gsub(""%"", ""\\\\%"", xml2::xml_text(contents))
+    contents <- gsub(""%"", ""\\\\%"", xml_link_text(contents))
 
     list(
       paste0(

---FILE: tests/testthat/test-rd-markdown-links.R---
@@ -403,3 +403,37 @@ test_that(""links to S4 classes are OK"", {
   expect_equivalent_rd(out1, out2)
 
 })
+
+test_that(""linebreak in 'text' of [text][foo] turns into single space"", {
+
+  out1 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Link
+    #' text [broken
+    #' across lines][fcn] preserve
+    #' whitespace, even when
+    #' [broken across
+    #' several
+    #' lines][fcn],
+    #' or with varying
+    #' [amounts \
+    #'   of  \
+    #' interspersed   \
+    #'   whitespace][fcn].
+    #' @md
+    foo <- function() {}"")[[1]]
+  out2 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Link
+    #' text \\link[=fcn]{broken across lines} preserve
+    #' whitespace, even when
+    #' \\link[=fcn]{broken across several lines},
+    #' or with varying
+    #' \\link[=fcn]{amounts of interspersed whitespace}.
+    foo <- function() {}"")[[1]]
+  expect_equivalent_rd(out1, out2)
+
+})
+"
r-lib,roxygen2,55b51b55b95c761609bd78096b341c43a58597a4,Jim Hester,james.f.hester@gmail.com,2018-06-30T14:32:44Z,Hadley Wickham,h.wickham@gmail.com,2018-06-30T14:32:44Z,"Use desc package in read.description (#731)

This ensures we have better support for non ASCII encodings

Fixes #727",R/utils.R;tests/testthat/test-rd-package.R;tests/testthat/testNonASCII/DESCRIPTION,False,True,True,False,9,5,14,"---FILE: R/utils.R---
@@ -149,10 +149,10 @@ block_eval <- function(tag, block, env, tag_name) {
 
 # Parse DESCRIPTION into convenient format
 read.description <- function(file) {
-  dcf <- read.dcf(file, keep.white = ""Authors@R"")
+  dcf <- desc::desc(file = file)
 
-  dcf_list <- setNames(as.list(dcf[1, ]), colnames(dcf))
-  lapply(dcf_list, str_trim)
+  fields <- dcf$fields()
+  purrr::map(purrr::set_names(fields), ~ dcf$get_field(.x))
 }
 
 

---FILE: tests/testthat/test-rd-package.R---
@@ -18,3 +18,7 @@ test_that(""can create package documentation"", {
   expect_equal(get_tag(out, ""docType"")$values, ""package"")
   expect_equal(get_tag(out, ""details"")$values, ""Details."")
 })
+
+test_that(""Can read UTF-8 DESCRIPTIONS"", {
+  expect_equal(read.description(""testNonASCII/DESCRIPTION"")$Author, ""Shr\U00EBktan <shrektan@126.com>"")
+})

---FILE: tests/testthat/testNonASCII/DESCRIPTION---
@@ -2,7 +2,7 @@ Package: testNonASCII
 Title: Test no change to Collate when there are no @includes
 License: GPL-2
 Description:
-Author: Shrektan <shrektan@126.com>
-Maintainer: Shrektan <shrektan@126.com>
+Author: Shr칢ktan <shrektan@126.com>
+Maintainer: Shr칢ktan <shrektan@126.com>
 Encoding: UTF-8
 Version: 0.1"
r-lib,roxygen2,8deca7e6c0cbc2a5186a780f568f4caa10453daa,John Eismeier,32205350+jeis2497052@users.noreply.github.com,2018-06-29T17:55:00Z,Hadley Wickham,h.wickham@gmail.com,2018-06-29T17:55:00Z,Propose fix some typos (#752),NEWS.md;R/field.R;R/markdown.R;R/object-s3.R;R/tokenize.R;man/is_s3_generic.Rd;tests/testthat/test-rd.R;vignettes/rd.Rmd,True,True,True,False,90,90,180,"---FILE: NEWS.md---
@@ -2,22 +2,22 @@
 
 ## New features
 
-* The NAMESPACE roclet nows works in two passes - it first generates the 
+* The NAMESPACE roclet nows works in two passes - it first generates the
   a NAMESPACE containing only import directives becaues this can be generated
   without evaluating the code in the package. This alleviates a problem
   where it was previously possible to get into a state that you could only
   get out of by carefully editting the NAMESPACE by hand (#372).
 
 * `@eval foo()` evaluates `foo()` defined in the package namespace and inserts
-  the results into the current block (#645). The code should return a character 
+  the results into the current block (#645). The code should return a character
   vector with one entry for each line (and they should not start with `#'`).
-  
+
     There are two small limitations to the current implementation:
-    
+
     1. The generated roxygen will not affect the `@md`/`@noMd` status
     2. `@evalRd` does not work inside templates.
 
-* `@evalNamespace` does for `NAMESPACE` what `@evalRd` does for Rd files: 
+* `@evalNamespace` does for `NAMESPACE` what `@evalRd` does for Rd files:
   you give it R code that produces a literal entry in `NAMESPACE` when
   run. This should make it easier to export functions that are generated by
   other functions in your package (#531, @egnha).
@@ -28,8 +28,8 @@
   The vignette still needs more work so pull requests are greatly appreciated
   (#650).
 
-* `roxygenise()` uses `pkgload::load_all()` instead of a home grown solution 
-  to simulate package loading (this is needed because roxygen2 uses run-time 
+* `roxygenise()` uses `pkgload::load_all()` instead of a home grown solution
+  to simulate package loading (this is needed because roxygen2 uses run-time
   information to generate the documetation). This should reduce S4 related
   problems and ensures that `devtools::document()` and `roxygenise()` always
   have exactly the same behaviour (#568, #595).
@@ -39,14 +39,14 @@
 
 ## Extension API
 
-* [API] Roxygen blocks now have an official structure as encoded in 
+* [API] Roxygen blocks now have an official structure as encoded in
   `roxy_block()`. It is a named list containing the tags with attributes
   providing other metadata.
 
-* [API] The `parsed` argument to `roclet_process()` have been replaced with 
+* [API] The `parsed` argument to `roclet_process()` have been replaced with
   separate `blocks` and `env` arguments.
 
-* New `roclet_preprocess()` generic makes it possible for roclets to perform 
+* New `roclet_preprocess()` generic makes it possible for roclets to perform
   actions before code is evaluated.
 
 * `parse_package()`, `parse_file()` and `parse_code()` provide an exported API
@@ -65,8 +65,8 @@
 
 * `@concept` now generates one `\concept` per tag (#611).
 
-* The default `@description` (i.e. the title) is now added much later in the 
-  process. That means that `@inherit description` now works when you have 
+* The default `@description` (i.e. the title) is now added much later in the
+  process. That means that `@inherit description` now works when you have
   specified a title for the inheritor (#629) and the default description
   is slightly nicer when merging multiple blocks.
 
@@ -75,16 +75,16 @@
 * Stricter regular expression ensures only files ending with `.R` or `.r` are
   parsed for roxygen comments (#625).
 
-* Objects with names starting with a dot are now by default documented in 
-  files with prefix 'dot-'.  
+* Objects with names starting with a dot are now by default documented in
+  files with prefix 'dot-'.
 
 * Roclets can now access global options as designed. This allows templates to
   use markdown formatting if set globally (#594).
 
-* The mechanism for extracting inherited Rd does a better job of 
+* The mechanism for extracting inherited Rd does a better job of
   preserving escapes (#624)
 
-* You can now autogenerate package documentation even if you don't have 
+* You can now autogenerate package documentation even if you don't have
   `Authors@R` (#606).
 
 * Multiple given and/or family names are now supported in the
@@ -103,25 +103,25 @@
 * Improvements to markdown translation:
 
     * Code in link text is now properly rendered as code (#620, @egnha).
-    
+
     * Whitespace between words in link text is now preserved as single
       space (#628, @egnha).
-  
-    * `%` in inline code (#640), code blocks (@nteetor, #699) and 
+
+    * `%` in inline code (#640), code blocks (@nteetor, #699) and
       links (#724) is now automatically escaped.
-    
-    * Parsing of markdown links has been tweaked to reduce false positives 
-      (#555). If you still get a false positive, you can now put `\\` in front 
-      of the `[` to avoid it being converted to a link (#720). Links can no 
+
+    * Parsing of markdown links has been tweaked to reduce false positives
+      (#555). If you still get a false positive, you can now put `\\` in front
+      of the `[` to avoid it being converted to a link (#720). Links can no
       longer be followed by `{` to avoid spurious matches to Rd commands like
       `\Sexpr{}`.
-      
+
     * Unsupported markdown features now generate a mildly helpful warning
       instead of throwing an utterly useless error (#560).
 
 # roxygen2 6.0.1
 
-* Allowing empty lines in .Rbuildignore. Previously, empty lines caused all 
+* Allowing empty lines in .Rbuildignore. Previously, empty lines caused all
   files to be ignored. (#572, @jakob-r)
 
 * Automatically generating a usage section for an infix function containing ""<-""
@@ -140,49 +140,49 @@
 
 ## Improved inheritance
 
-* New `@inheritDotParams` allows you to automatically generate parameter 
-  documentation for `...` for the common case where you pass `...` on to 
-  another function (#512). Because you often override some arguments, it 
+* New `@inheritDotParams` allows you to automatically generate parameter
+  documentation for `...` for the common case where you pass `...` on to
+  another function (#512). Because you often override some arguments, it
   comes with a flexible specification for argument selection:
-  
+
     * `@inheritDotParams foo` takes all parameters from `foo()`
-    * `@inheritDotParams foo a b e:h` takes parameters `a`, `b`, and all 
+    * `@inheritDotParams foo a b e:h` takes parameters `a`, `b`, and all
        parameters between `e` and `h`
     * `@inheritDotParams foo -x -y` takes all parameters except for `x` and `y`.
-    
+
     The documentation generated is similar to the style used in `?plot`
     and will eventually be incorporated in to RStudio's autocomplete.
 
 * New `@inherit` generalises `@inheritParams`, and allows to you inherit
   parameters, return, references, title, description, details, sections, and
   seealso.  The default `@inherit my_fun` will inherit all, you can document
-  an object entirely by specifying only the `@inherit` tag.  Alternatively, 
+  an object entirely by specifying only the `@inherit` tag.  Alternatively,
   you can select specific tags to inherit with `@inherit my_fun return params`
   (#384).
 
-* New `@inheritSection fun title` allows you to inherit the contents of 
+* New `@inheritSection fun title` allows you to inherit the contents of
   a single section from another topic (#513).
 
 * `@inheritParams` now works recursively, so that you can inherit parameters
-  from a function that inherited its paramters from somewhere else.  It
+  from a function that inherited its parameters from somewhere else.  It
   also better handles `\dots` as an alias for `...` (#504).
 
 ## Minor improvements and bug fixes
 
 ### Tags
 
-* `@aliases` are no longer sorted alphabetically, but instead match the 
+* `@aliases` are no longer sorted alphabetically, but instead match the
   order of their usage. This gives you more control in pkgdown.
 
 * `@describeIn` now escapes special characters in function names (#450).
 
-* `@family` see alsos are added in the same order they appear, not 
-  alphabetically (#315). Fixed an issue where `.`s were sometimes added 
+* `@family` see alsos are added in the same order they appear, not
+  alphabetically (#315). Fixed an issue where `.`s were sometimes added
   between words within a `@family` tag (#477, @kevinushey).
 
 * `@author` is rendered after `@seealso`.
 
-* `@example` gives a nice warning message if you accidentally use it instead 
+* `@example` gives a nice warning message if you accidentally use it instead
   of `@examples` (#494). Multiple `@examples` sections are merged (#472, @krlmlr).
 
 * Roxygen will no longer write out topics that don't have a name or title,
@@ -197,7 +197,7 @@
 * Ensure that `functions` with S3 class are still treated as functions (#455).
 
 * S3 method declarations via `R.methodS3::setMethodS3()` and function
-  declarations via `R.oo::setConstructorS3()` are now supported 
+  declarations via `R.oo::setConstructorS3()` are now supported
   (@HenrikBengtsson, #525).
 
 ### S4
@@ -217,7 +217,7 @@
   from the `Authors@R` field (#527). It now works from `roxygenise()`; before
   it only worked from `devtools::document()` (#439, @krlmlr).
 
-* Manually created `NAMESPACE` or documentation files are never overwritten, 
+* Manually created `NAMESPACE` or documentation files are never overwritten,
   even if using `roxygen2` for the first time (@krlmlr, #436).
 
 * Changes to DESCRIPTION (i.e. `Collate:` and `RoxygenNote`) now use
@@ -232,7 +232,7 @@
 * The usage of replacement functions uses non-breaking spaces so that `<-`
   will never get put on its own line (#484).
 
-* Roxygen now parses nonASCII documentation correctly (as long as UTF-8 
+* Roxygen now parses nonASCII documentation correctly (as long as UTF-8
   encoded or specified Encoding in DESCRIPTION) (#532, @shrektan),
   and ignores files listed in `.Rbuildignore` (#446, @fmichonneau).
 
@@ -241,7 +241,7 @@
 * Deprecated `register.preref.parser()` and `register.preref.parsers()`
   have been removed. `register_tags()` has also been removed in favour of
   a new `roclet_tags()` generic.
-  
+
 * `roclet()` (the constructor), `roclet_tags()`, `roclet_process()`
   `roclet_output()`, `roc_clean()` and now exported making it possible
   to create roclets in other packages.  Helper functions `roxy_tag()` and
@@ -266,93 +266,93 @@
   field in the `DESCRIPTION` (#338). This will be the last time an roxygen2
   upgrade changes every file in `man/`.
 
-*   You can now easily re-export functions that you've imported from another 
+*   You can now easily re-export functions that you've imported from another
     package:
 
     ```R
     #' @export
     magrittr::`%>%`
     ```
-    
+
     All imported-and-re-exported functions will be documented in the same
-    file (`rexports.Rd`), containing a brief descrption and links to the 
+    file (`rexports.Rd`), containing a brief descrption and links to the
     original documentation (#376).
 
-*   You can more easily generate package documentation by documenting the 
+*   You can more easily generate package documentation by documenting the
     special string ""_PACKAGE"" (@krlmlr, #349):
-    
+
     ```R
     #' @details Details
-    ""_PACKAGE"" 
+    ""_PACKAGE""
     ```
-    
+
     The title and description will be automatically filled in from the
     `DESCRIPTION`.
 
-* New tags `@rawRd` and `@rawNamespace` allow you to insert raw (unescaped) 
+* New tags `@rawRd` and `@rawNamespace` allow you to insert raw (unescaped)
   in Rd and the `NAMESPACE` (this is useful for conditional imports).
-  `@evalRd()` is similar, but instead of literal Rd, you give it R code that 
-  produces literal Rd code when run. This should make it easier to experiment 
-  with new types of output (#385). 
+  `@evalRd()` is similar, but instead of literal Rd, you give it R code that
+  produces literal Rd code when run. This should make it easier to experiment
+  with new types of output (#385).
 
 * Roxygen2 now parses the source code files in the order specified in the
-  `Collate` field in `DESCRIPTION`. This improves the ordering of the generated 
-  documentation when using `@describeIn` and/or `@rdname` split across several 
+  `Collate` field in `DESCRIPTION`. This improves the ordering of the generated
+  documentation when using `@describeIn` and/or `@rdname` split across several
   `.R` files, as often happens when working with S4 (#323, #324).
 
 ## Minor features and bug fixes
 
-* The contents of documented functions are now also parsed for roxygen comments. 
-  This allows, e.g., documenting a parameter's type close to where this type is 
-  checked, or documenting implementation details close to the source, and 
-  simplifies future extensions such as the documentation of R6 classes 
+* The contents of documented functions are now also parsed for roxygen comments.
+  This allows, e.g., documenting a parameter's type close to where this type is
+  checked, or documenting implementation details close to the source, and
+  simplifies future extensions such as the documentation of R6 classes
   (#397, @krlmlr).
 
 * Data objects get a simpler default `@format` that describes only the
-  object's class and dimensions.  The former default, generated by generated by 
-  `str()`, didn't usually produce useful output and was quite slow. The new S3 
-  generic `default_data_format()` generates the format and can be overridden to 
+  object's class and dimensions.  The former default, generated by generated by
+  `str()`, didn't usually produce useful output and was quite slow. The new S3
+  generic `default_data_format()` generates the format and can be overridden to
   generate a custom format (#410, @krlmlr).
 
-* The roxygen parsers has been completely rewritten in C++ (#295). This gives a 
+* The roxygen parsers has been completely rewritten in C++ (#295). This gives a
   nice performance boost and gives:
 
-  * Better error messages: you now get the exact the line number of the 
+  * Better error messages: you now get the exact the line number of the
     tag, not just the start of the block.
-    
+
   * The parser has been simplified a little: tags now must always start
     on a new line. This is recommended practice anyway, and it means
     that escaping inline `@` (with `@@`) is now optional. (#235)
-    
+
   * Unknown tags now emit a warning, rather than an error.
 
-* `@examples` no longer complains about non-matching braces inside 
+* `@examples` no longer complains about non-matching braces inside
   strings (#329).
 
 * `@family` now cross-links each manual page only once, instread of linking
   to all aliases (@gaborcsardi, #283, #367).
 
 * The special `@include` parser has also been rewritten in C++, giving
-  a performance boost for larger packages (#401). This is particularly 
+  a performance boost for larger packages (#401). This is particularly
   important because it's also called from `devtools::load_all()`.
-  Additionally, a space before `@include` is no longer necessary 
+  Additionally, a space before `@include` is no longer necessary
   (@krlmlr, #342).
 
-* `@inheritParams foo::bar` ensures that `%` remains escaped (#313). 
+* `@inheritParams foo::bar` ensures that `%` remains escaped (#313).
 
 * If you document multiple arguments with one `@param`, (e.g. `@param a,b,c`)
-  each parameter will get a space after it so it can be wrapped in the 
+  each parameter will get a space after it so it can be wrapped in the
   generated Rd file (#373).
 
-* `@section`s with identical titles are now merged together, just like 
-  `@description` and `@details`. This is useful in conjunction with the 
+* `@section`s with identical titles are now merged together, just like
+  `@description` and `@details`. This is useful in conjunction with the
   `@rdname` tag. (@krlmlr, #300).
 
-* Automatic `@usage` is now correctly generated for functions with string 
+* Automatic `@usage` is now correctly generated for functions with string
   arguments containing `""\""""` (#265).
 
 * `load_options()` is now exported so `devtools::document()` doesn't have to
-  run `update_collate()` twice (#395). 
+  run `update_collate()` twice (#395).
 
 * `update_collate()` only rewrites the `Collate` entry in the DESCRIPTION file
   when it changes (#325, #723).
@@ -364,16 +364,16 @@
 
 ## Internal changes
 
-* `register.preref.parser()` and `register.preref.parsers()`  have been 
+* `register.preref.parser()` and `register.preref.parsers()`  have been
   deprecated - please use `register_tags()` instead.
 
-* Parser callbacks registered with `register_tags()` are now called for fields 
+* Parser callbacks registered with `register_tags()` are now called for fields
   parsed from the ""introduction"" (the text before the first tag)
   (@gaborcsardi, #370).
 
 # roxygen2 4.1.1
 
-* Formatting of the `Authors@R` field in the DESCRIPTION file is now retained 
+* Formatting of the `Authors@R` field in the DESCRIPTION file is now retained
   (@jranke, #330).
 
 * The collate roclet falls back to `base::strwrap()` when generating the
@@ -385,7 +385,7 @@
 
 * An off-by-one error in the C++ Roxygen preparser was fixed.
 
-* The new `@backref` tag makes it possible to override the sourceref for 
+* The new `@backref` tag makes it possible to override the sourceref for
   R code generators like `Rcpp` (@krlmlr, #291, #294).
 
 # roxygen2 4.1.0
@@ -416,7 +416,7 @@
 * If you don't use `@exports` or other namespace directives, your namespace
   file will not be touched (#276).
 
-* Methods no longer automatically attempt to inherit parameters from 
+* Methods no longer automatically attempt to inherit parameters from
   their generic. It's too fraught with difficulty (#261).
 
 * Roxygen now understands what to do with `setReplaceMethod()` (#266).
@@ -430,12 +430,12 @@
 
 # roxygen2 4.0.1
 
-* Explicit `updateRoxygen()` is no longer needed - `roxygenize()` does the 
+* Explicit `updateRoxygen()` is no longer needed - `roxygenize()` does the
   right thing the first time it is run.
 
 * Exporting a S4 generic works (#246).
 
-* `roxygenise()` no longer complains about absense of `wrap` field because it's
+* `roxygenise()` no longer complains about absence of `wrap` field because it's
   so unlikely that anyone wants the old behaviour (#245).
 
 # roxygen2 4.0.0
@@ -532,7 +532,7 @@ Roxygen2 4.0.0 is a major update to roxygen2 that makes provides enhanced error
 * Non-syntactic class names (like `<-`) are now escaped in the usage
   section of S4 methods (#205).
 
-* Eliminated two more cases where wrapping occured even when `wrap = FALSE`.
+* Eliminated two more cases where wrapping occurred even when `wrap = FALSE`.
 
 # roxygen2 3.1.0
 

---FILE: R/field.R---
@@ -77,7 +77,7 @@ format.roxy_field_alias <- function(x, ...) {
 #' @export
 format.roxy_field_concept <- format_rd
 
-# Fields that keep the first occurence -----------------------------------------
+# Fields that keep the first occurrence -----------------------------------------
 format_first <- function(x, ...) {
   rd_macro(x$field, x$values[1])
 }

---FILE: R/markdown.R---
@@ -15,7 +15,7 @@ markdown_on <- function(value = NULL) {
 }
 
 markdown_activate <- function(tags, global_options = list()) {
-  ## markdown on/off based on global flag and presense of @md & @nomd
+  ## markdown on/off based on global flag and presence of @md & @nomd
   ## we need to use markdown_global_default as well, because global_options
   ## can be NULL, e.g. if called from parse_text()
 

---FILE: R/object-s3.R---
@@ -9,7 +9,7 @@
 #' and then checks if any of them actually is a generic.
 #'
 #' @param name Name of function.
-#' @param env Base environment in which to look for function defintion.
+#' @param env Base environment in which to look for function definition.
 #' @export
 is_s3_generic <- function(name, env = parent.frame()) {
   if (name == """") return(FALSE)

---FILE: R/tokenize.R---
@@ -41,7 +41,7 @@ tokenise_ref <- function(x) {
   )
 }
 
-# For each src ref, find the comment block preceeding it
+# For each src ref, find the comment block preceding it
 comments <- function(refs) {
   srcfile <- attr(refs[[1]], ""srcfile"")
 

---FILE: man/is_s3_generic.Rd---
@@ -12,7 +12,7 @@ is_s3_method(name, env = parent.frame())
 \arguments{
 \item{name}{Name of function.}
 
-\item{env}{Base environment in which to look for function defintion.}
+\item{env}{Base environment in which to look for function definition.}
 }
 \description{
 \code{is_s3_generic} compares name to \code{.knownS3Generics} and

---FILE: tests/testthat/test-rd.R---
@@ -74,7 +74,7 @@ test_that(""deleted objects not documented"", {
 test_that(""documenting unknown function requires name"", {
   expect_warning(
     roc_proc_text(rd_roclet(), ""
-      #' Virtual Class To Enforce Max Slot Lenght
+      #' Virtual Class To Enforce Max Slot Length
       #'
       #' @export
       setClass('A')

---FILE: vignettes/rd.Rmd---
@@ -148,7 +148,7 @@ Functions are the mostly commonly documented objects. Most functions use three t
     `\donttest{}`| x         | x      |
 
     Instead of including examples directly in the documentation, you can
-    put them in separate files and use `@example path/relative/to/packge/root`
+    put them in separate files and use `@example path/relative/to/package/root`
     to insert them into the documentation.
 
 *   `@return description` describes the output from the function. This is"
r-lib,roxygen2,c9385df59dc5e70638b469c59cf0ab938b9b4797,hadley,h.wickham@gmail.com,2018-06-28T21:50:42Z,hadley,h.wickham@gmail.com,2018-06-28T21:50:42Z,"Escape % in links

Fixes #724",NEWS.md;R/markdown.R;tests/testthat/test-rd-markdown-links.R,False,True,True,False,16,1,17,"---FILE: NEWS.md---
@@ -107,7 +107,8 @@
     * Whitespace between words in link text is now preserved as single
       space (#628, @egnha).
   
-    * `%` in inline code blocks is now automatically escaped (#640).
+    * `%` in inline code blocks (#640) and links (#724) is now automatically 
+      escaped.
     
     * Parsing of markdown links has been tweaked to reduce false positives 
       (#555). If you still get a false positive, you can now put `\\` in front 

---FILE: R/markdown.R---
@@ -352,7 +352,9 @@ parse_link <- function(destination, contents) {
 
   is_code <- is_code || (grepl(""[(][)]$"", destination) && ! has_link_text)
   pkg <- str_match(destination, ""^(.*)::"")[1,2]
+  pkg <- gsub(""%"", ""\\\\%"", pkg)
   fun <- utils::tail(strsplit(destination, ""::"", fixed = TRUE)[[1]], 1)
+  fun <- gsub(""%"", ""\\\\%"", fun)
   is_fun <- grepl(""[(][)]$"", fun)
   obj <- sub(""[(][)]$"", """", fun)
   s4 <- str_detect(destination, ""-class$"")
@@ -375,6 +377,8 @@ parse_link <- function(destination, contents) {
     )
 
   } else {
+    contents <- gsub(""%"", ""\\\\%"", xml2::xml_text(contents))
+
     list(
       paste0(
         if (is_code) ""\\code{"",

---FILE: tests/testthat/test-rd-markdown-links.R---
@@ -59,6 +59,16 @@ test_that(""\\Sexpr with options not converted to links"", {
    )
 })
 
+test_that(""% in links are escaped"", {
+  md <- markdown_on(TRUE)
+  on.exit(markdown_on(md))
+
+  expect_equal(full_markdown(""[x][%%]""), ""\\link[=\\%\\%]{x}"")
+  expect_equal(full_markdown(""[%][x]""), ""\\link[=x]{\\%}"")
+  expect_equal(full_markdown(""[%%]""), ""\\link{\\%\\%}"")
+  expect_equal(full_markdown(""[foo::%%]""), ""\\link[foo:\\%\\%]{foo::\\%\\%}"")
+})
+
 test_that(""commonmark picks up the various link references"", {
   cases <- list(
     c(""foo [func()] bar"","
r-lib,roxygen2,52cdeb66b47d9ed7bd0db2629ca298c22858c9fb,hadley,h.wickham@gmail.com,2018-06-28T21:22:06Z,hadley,h.wickham@gmail.com,2018-06-28T21:22:06Z,"Handle unsupport markdown more gracefully

Fixes #560",NEWS.md;R/markdown.R;tests/testthat/test-rd-markdown.R,False,True,True,False,25,1,26,"---FILE: NEWS.md---
@@ -114,6 +114,9 @@
       of the `[` to avoid it being converted to a link (#720). Links can no 
       longer be followed by `{` to avoid spurious matches to Rd commands like
       `\Sexpr{}`.
+      
+    * Unsupported markdown features now generate a mildly helpful warning
+      instead of throwing an utterly useless error (#560).
 
 # roxygen2 6.0.1
 

---FILE: R/markdown.R---
@@ -85,7 +85,14 @@ markdown_rparse <- function(xml, markdown_tags) {
 
   ## generic node
   if (is(xml, ""xml_node"") && xml_type(xml) == ""element"") {
-    return(markdown_rparse(markdown_tags[[ xml_name(xml) ]](xml), markdown_tags = markdown_tags))
+    parser <- markdown_tags[[ xml_name(xml) ]]
+
+    if (is.null(parser)) {
+      warning(""Unknown xml node: "", xml_name(xml), call. = FALSE)
+      return(xml_text(xml))
+    }
+
+    return(markdown_rparse(parser(xml), markdown_tags = markdown_tags))
   }
 
   warning(""Unknown xml object"")

---FILE: tests/testthat/test-rd-markdown.R---
@@ -405,3 +405,17 @@ test_that(""Do not pick up `` in arguments \\item #519"", {
     foo <- function(`_arg1`, `_arg2`) {}"")[[1]]
   expect_equivalent_rd(out1, out2)
 })
+
+test_that(""unhandled markdown generates warning"", {
+  text <- ""
+    #' Title
+    #'
+    #' ## Heading
+    #'
+    #' Blabla
+    #' @md
+    #' @name x
+    NULL
+  ""
+  expect_warning(roc_proc_text(rd_roclet(), text), ""heading"")
+})"
r-lib,roxygen2,25226f2a18cb421eaa0df1e27b15a15f6bea4ffb,hadley,h.wickham@gmail.com,2018-06-28T21:11:54Z,hadley,h.wickham@gmail.com,2018-06-28T21:11:54Z,"Forbid links to be followed by {

Fixes #682",NEWS.md;R/markdown.R;tests/testthat/test-rd-markdown-links.R,False,True,True,False,11,2,13,"---FILE: NEWS.md---
@@ -111,7 +111,9 @@
     
     * Parsing of markdown links has been tweaked to reduce false positives 
       (#555). If you still get a false positive, you can now put `\\` in front 
-      of the `[` to avoid it being converted to a link (#720).
+      of the `[` to avoid it being converted to a link (#720). Links can no 
+      longer be followed by `{` to avoid spurious matches to Rd commands like
+      `\Sexpr{}`.
 
 # roxygen2 6.0.1
 

---FILE: R/markdown.R---
@@ -281,7 +281,7 @@ add_linkrefs_to_md <- function(text) {
         (?<=[^\\]\\\\]|^)       # must not be preceded by ] or \
         \\[([^\\]\\[]+)\\]      # match anything inside of []
         (?:\\[([^\\]\\[]+)\\])? # match optional second pair of []
-        (?=[^\\[]|$)            # must not be followed by [
+        (?=[^\\[{]|$)            # must not be followed by [ or {
       ""
     )
   )[[1]]

---FILE: tests/testthat/test-rd-markdown-links.R---
@@ -43,6 +43,13 @@ test_that(""can escape [ to avoid spurious links"", {
   )
 })
 
+test_that(""\\Sexpr with options not converted to links"", {
+   expect_equal(
+     md_link_html(""\\Sepxr[results=rd]{runif(1)}""),
+     ""<p>\\Sepxr[results=rd]{runif(1)}</p>\n""
+   )
+})
+
 test_that(""commonmark picks up the various link references"", {
   cases <- list(
     c(""foo [func()] bar"","
r-lib,roxygen2,9bcefb6bca6013e9577b821c4b65c39c7a570027,hadley,h.wickham@gmail.com,2018-06-28T21:06:17Z,hadley,h.wickham@gmail.com,2018-06-28T21:09:32Z,"Respect escapes when passing links

Fixes #720",NEWS.md;R/markdown.R;tests/testthat/test-rd-markdown-links.R,False,True,True,False,15,2,17,"---FILE: NEWS.md---
@@ -110,7 +110,8 @@
     * `%` in inline code blocks is now automatically escaped (#640).
     
     * Parsing of markdown links has been tweaked to reduce false positives 
-      (#555)
+      (#555). If you still get a false positive, you can now put `\\` in front 
+      of the `[` to avoid it being converted to a link (#720).
 
 # roxygen2 6.0.1
 

---FILE: R/markdown.R---
@@ -278,7 +278,7 @@ add_linkrefs_to_md <- function(text) {
     regex(
       comments = TRUE,
       ""
-        (?<=[^\\]]|^)           # must not be preceded by ]
+        (?<=[^\\]\\\\]|^)       # must not be preceded by ] or \
         \\[([^\\]\\[]+)\\]      # match anything inside of []
         (?:\\[([^\\]\\[]+)\\])? # match optional second pair of []
         (?=[^\\[]|$)            # must not be followed by [

---FILE: tests/testthat/test-rd-markdown-links.R---
@@ -31,6 +31,18 @@ test_that(""can not have [ inside of link"", {
   )
 })
 
+test_that(""can escape [ to avoid spurious links"", {
+  expect_equal(
+    md_link_html(""\\[test\\]""),
+    ""<p>[test]</p>\n""
+  )
+
+  expect_equal(
+    md_link_html(""\\[ [test] \\]""),
+    ""<p>[ <a href=\""R:test\"">test</a> ]</p>\n"",
+  )
+})
+
 test_that(""commonmark picks up the various link references"", {
   cases <- list(
     c(""foo [func()] bar"","
r-lib,roxygen2,ddd8f71dcc9439ee2ad1c6a18f95f2b884e34789,hadley,h.wickham@gmail.com,2018-06-28T20:59:39Z,hadley,h.wickham@gmail.com,2018-06-28T21:02:10Z,"Improve md link parsing

By prohibiting [ inside of links; fixes #555.",NEWS.md;R/markdown.R;tests/testthat/test-rd-markdown-links.R,False,True,True,False,20,4,24,"---FILE: NEWS.md---
@@ -108,6 +108,9 @@
       space (#628, @egnha).
   
     * `%` in inline code blocks is now automatically escaped (#640).
+    
+    * Parsing of markdown links has been tweaked to reduce false positives 
+      (#555)
 
 # roxygen2 6.0.1
 

---FILE: R/markdown.R---
@@ -278,10 +278,10 @@ add_linkrefs_to_md <- function(text) {
     regex(
       comments = TRUE,
       ""
-        (?<=[^\\]]|^)        # must not be preceded by ]
-        \\[([^\\]]+)\\]      # match anything inside of []
-        (?:\\[([^\\]]+)\\])? # match optional second pair of []
-        (?=[^\\[]|$)         # must not be followed by [
+        (?<=[^\\]]|^)           # must not be preceded by ]
+        \\[([^\\]\\[]+)\\]      # match anything inside of []
+        (?:\\[([^\\]\\[]+)\\])? # match optional second pair of []
+        (?=[^\\[]|$)            # must not be followed by [
       ""
     )
   )[[1]]
@@ -303,6 +303,12 @@ add_linkrefs_to_md <- function(text) {
   )
 }
 
+# Helper designed primarily for testing
+
+md_link_html <- function(x) {
+  commonmark::markdown_html(add_linkrefs_to_md(x))
+}
+
 #' Parse a MarkDown link, to see if we should create an Rd link
 #'
 #' See the table above.

---FILE: tests/testthat/test-rd-markdown-links.R---
@@ -24,6 +24,13 @@ test_that(""proper link references are added"", {
   }
 })
 
+test_that(""can not have [ inside of link"", {
+  expect_equal(
+    md_link_html(""`[[`. [subset()]""),
+    ""<p><code>[[</code>. <a href=\""R:subset()\"">subset()</a></p>\n""
+  )
+})
+
 test_that(""commonmark picks up the various link references"", {
   cases <- list(
     c(""foo [func()] bar"","
r-lib,roxygen2,e79f76993ccc4e348e08d8ba2851784d246d0960,martin-mfg,2026226+martin-mfg@users.noreply.github.com,2018-06-28T19:24:22Z,Hadley Wickham,h.wickham@gmail.com,2018-06-28T19:24:22Z,"Fix link target, mention additional link style (#689)",vignettes/formatting.Rmd,True,False,True,False,3,1,4,"---FILE: vignettes/formatting.Rmd---
@@ -33,10 +33,12 @@ To other documentation:
 
 * `\code{\link{function}}`: function in this package
 
-* `\code{\link[MASS]{stats}}`: function in another package
+* `\code{\link[MASS]{abbey}}`: function in another package
 
 * `\link[=dest]{name}`: link to dest, but show name
 
+* `\code{\link[MASS:abbey]{name}}`: link to function in another package, but show name.
+
 * `\linkS4class{abc}`: link to an S4 class
 
 To the web:"
r-lib,roxygen2,2a5d9b7e8c6587e9e374fe687caa5bdd7e3155eb,Kirill M칲ller,krlmlr@users.noreply.github.com,2018-06-28T19:18:46Z,Hadley Wickham,h.wickham@gmail.com,2018-06-28T19:18:46Z,fix partial matching (#711),tests/testthat/test-parse.R;tests/testthat/test-rd-alias.R;tests/testthat/test-reexport.R,False,True,True,False,5,5,10,"---FILE: tests/testthat/test-parse.R---
@@ -21,7 +21,7 @@ test_that(""Inline comments just before the closing brace are allowed"", {
 
       #' @seealso somewhere
     }"")[[1]]
-  expect_equal(get_tag(out, ""seealso"")$value, ""somewhere"")
+  expect_equal(get_tag(out, ""seealso"")$values, ""somewhere"")
 })
 
 test_that(""Inline comments do not extend past the closing brace"", {

---FILE: tests/testthat/test-rd-alias.R---
@@ -64,7 +64,7 @@ test_that(""refclass with assignment gets both aliases"", {
     B3 <- setRefClass('B3')
   "")[[1]]
 
-  expect_equal(get_tag(out, ""alias"")$value, c(""B3-class"", ""B3""))
+  expect_equal(get_tag(out, ""alias"")$values, c(""B3-class"", ""B3""))
 })
 
 
@@ -74,5 +74,5 @@ test_that(""refclass gets -class alias"", {
     setRefClass('B2')
   "")[[1]]
 
-  expect_equal(get_tag(out, ""alias"")$value, ""B2-class"")
+  expect_equal(get_tag(out, ""alias"")$values, ""B2-class"")
 })

---FILE: tests/testthat/test-reexport.R---
@@ -11,11 +11,11 @@ test_that(""exporting a call to :: produces re-exports documentation"", {
   )
 
   expect_equal(
-    out$get_field(""title"")$value,
+    out$get_field(""title"")$values,
     ""Objects exported from other packages""
   )
 
-  expect_equal(out$get_field(""keyword"")$value, ""internal"")
+  expect_equal(out$get_field(""keyword"")$values, ""internal"")
 })
 
 test_that(""multiple re-exports are combined"", {"
r-lib,roxygen2,b33425534fa7800576e84211cc4b3437133b495f,hadley,h.wickham@gmail.com,2018-06-28T18:55:33Z,hadley,h.wickham@gmail.com,2018-06-28T18:55:33Z,"Make version mismatch warning immediate

Fixes #738",R/safety.R,False,True,True,False,1,1,2,"---FILE: R/safety.R---
@@ -46,7 +46,7 @@ update_roxygen_version <- function(base_path) {
 
   if (!is.na(cur) && !is.na(prev) && package_version(cur) < package_version(prev)) {
     warning(""Version of roxygen2 last used with this package is "", prev, "". "",
-      "" You only have version "", cur, call. = FALSE)
+      "" You only have version "", cur, call. = FALSE, immediate. = TRUE)
   } else if (!identical(cur, prev)) {
     message(""Updating roxygen version in "", desc_path)
     desc::desc_set(RoxygenNote = cur, file = desc_path)"
r-lib,roxygen2,c545c6a40ce50f307a47f24e90c2d55e7705ca20,hadley,h.wickham@gmail.com,2018-06-28T18:40:05Z,hadley,h.wickham@gmail.com,2018-06-28T18:40:56Z,"Note that text is special

Fixes #709",R/safety.R,False,True,True,False,2,0,2,"---FILE: R/safety.R---
@@ -33,6 +33,8 @@ check_made_by <- function(first) {
 }
 
 made_by <- function(comment) {
+  # This text is used by IDE to display a special warning. DO NOT CHANGE
+  # without consulting the IDE team
   paste0(comment, "" Generated by roxygen2: do not edit by hand\n"")
 }
 "
r-lib,roxygen2,02f0331eeb23d2cb779cad477f7623bae6828d21,Jennifer (Jenny) Bryan,jenny.f.bryan@gmail.com,2018-06-28T18:33:53Z,Hadley Wickham,h.wickham@gmail.com,2018-06-28T18:33:53Z,"Fix docs re: auto-hyperlinking of URLs (#694)

Fixes #693",vignettes/markdown.Rmd,True,False,True,False,2,2,4,"---FILE: vignettes/markdown.Rmd---
@@ -135,10 +135,10 @@ Markdown hyperlinks work as usual:
 #' [Commonmark web site](http://commonmark.org/help)
 ```
 
-URLs are also automatically converted to hyperlinks:
+URLs inside angle brackets are also automatically converted to hyperlinks:
 
 ```r
-#' The main R web site is at https://r-project.org.
+#' The main R web site is at <https://r-project.org>.
 ```
 
 Markdown notation can be used to create links to other manual pages. There are six kinds of links:"
r-lib,roxygen2,1f8be37b618982630a99f650e4e046fa0b9632ec,hadley,h.wickham@gmail.com,2017-10-01T18:44:28Z,hadley,h.wickham@gmail.com,2017-10-01T18:44:28Z,"Re-exports also generates \description

* Don't set default description if rexports present
* Throw an error if both used

Fixes #657",R/rd.R;tests/testthat/test-reexport.R,False,True,True,False,33,1,34,"---FILE: R/rd.R---
@@ -92,7 +92,10 @@ topics_add_default_description <- function(topics) {
     if (length(topic$get_field(""description"")) > 0)
       next
 
-    topic$add_simple_field(""description"", topic$get_field(""title"")$values)
+    # rexport manually generates a own description, so don't need to
+    if (!topic$has_field(""reexport"")) {
+      topic$add_simple_field(""description"", topic$get_field(""title"")$values)
+    }
   }
 
   invisible()
@@ -137,6 +140,11 @@ block_to_rd <- function(block, base_path, env, global_options = list()) {
   topic_add_usage(rd, block)
   topic_add_value(rd, block)
 
+  if (rd$has_field(""description"") && rd$has_field(""reexport"")) {
+    block_warning(block, ""Can't use description when re-exporting"")
+    return()
+  }
+
   describe_rdname <- topic_add_describe_in(rd, block, env)
 
   filename <- describe_rdname %||% block$rdname %||% nice_name(name)

---FILE: tests/testthat/test-reexport.R---
@@ -32,3 +32,27 @@ test_that(""multiple re-exports are combined"", {
     roxy_field_reexport(c(""testthat"", ""testthat""), c(""expect_lt"", ""expect_gt""))
   )
 })
+
+test_that(""description generated correctly"", {
+  roc <- rd_roclet()
+  out <- roc_proc_text(rd_roclet(), ""
+    #' @importFrom magrittr %>%
+    #' @export
+    magrittr::`%>%`
+    "")[[1]]
+
+  expect_null(out$get_field(""description""))
+})
+
+test_that(""can't set description and re-export"", {
+  expect_warning(
+    out <- roc_proc_text(rd_roclet(), ""
+      #' @description NOPE
+      #' @export
+      magrittr::`%>%`
+      ""),
+    ""Can't use description when re-exporting""
+  )
+
+  expect_length(out, 0)
+})"
r-lib,roxygen2,3b1ef665594bbca8517d42dd4f33d3fa980c6369,Jim Hester,james.f.hester@gmail.com,2017-08-22T18:22:58Z,hadley,h.wickham@gmail.com,2017-08-23T17:56:18Z,Fix encodings for windows,R/object-usage.R;R/utils-io.R,False,True,True,False,3,9,12,"---FILE: R/object-usage.R---
@@ -84,7 +84,7 @@ usage_args <- function(args) {
   }
   arg_to_text <- function(arg) {
     if (is.missing.arg(arg)) return("""")
-    text <- deparse(arg, backtick = TRUE, width.cutoff = 500L)
+    text <- enc2utf8(deparse(arg, backtick = TRUE, width.cutoff = 500L))
     text <- paste0(text, collapse = ""\n"")
     Encoding(text) <- ""UTF-8""
 

---FILE: R/utils-io.R---
@@ -2,15 +2,9 @@ readLines <- function(...) stop(""Use read_lines!"")
 writeLines <- function(...) stop(""Use write_lines!"")
 
 read_lines <- function(path, n = -1L) {
-  con <- file(path, open = ""r"", encoding = ""utf-8"")
-  on.exit(close(con))
-
-  base::readLines(con, n = n, warn = FALSE)
+  base::readLines(path, n = n, encoding = ""UTF-8"", warn = FALSE)
 }
 
 write_lines <- function(text, path) {
-  con <- file(path, open = ""w"", encoding = ""utf-8"")
-  on.exit(close(con))
-
-  base::writeLines(text, con, useBytes = TRUE)
+  base::writeLines(enc2utf8(text), path, useBytes = TRUE)
 }"
r-lib,roxygen2,7887556fd62678df5cb26454f0754fec91437221,hadley,h.wickham@gmail.com,2017-08-17T16:10:45Z,hadley,h.wickham@gmail.com,2017-08-23T17:56:18Z,"Always read and write in UTF-8

* Helpers read_lines and write_lines do the right thing
* readLines() and writeLines() through errors to prevent accidental re-use in the future
* Warn if package encoding is not utf-8

Fixes #564. Fixes #592",DESCRIPTION;NEWS.md;R/enc.R;R/parse.R;R/rd.R;R/roclet.R;R/roxygenize.R;R/safety.R;R/tokenize.R;R/utils-io.R;R/utils.R;tests/testthat/test-Rbuildignore.R;tests/testthat/test-nonASCII.R;tests/testthat/test-utf8.R;tests/testthat/testEagerData/DESCRIPTION;tests/testthat/testLazyData/DESCRIPTION;tests/testthat/testNonASCII/DESCRIPTION;tests/testthat/testNonASCII/R/a.r;tests/testthat/testUtf8Escape/DESCRIPTION;tests/testthat/testUtf8Escape/R/a.r,False,True,True,False,92,51,143,"---FILE: DESCRIPTION---
@@ -39,6 +39,7 @@ Suggests:
 LinkingTo: 
     Rcpp
 VignetteBuilder: knitr
+Encoding: UTF-8
 Roxygen: list(markdown = TRUE)
 RoxygenNote: 6.0.1.9000
 Remotes: 

---FILE: NEWS.md---
@@ -81,6 +81,10 @@
 * If a package logo exists (`man/figures/logo.png`) it will be automatically
   included in generated package docs (#609).
 
+* roxygen2 now always reads and writes using UTF-8 encoding. If used with a
+  package that does not have `Encoding: UTF-8` in the DESCRIPTION, you'll
+  now get a warning (#564, #592).
+
 * Usage for data objects now correctly generated, avoiding double escaping
   other components of usage (#562).
 

---FILE: R/enc.R---
@@ -1,8 +0,0 @@
-read_lines_enc <- function(path, file_encoding = ""UTF-8"", n = -1L, ok = TRUE, skipNul = FALSE) {
-  con <- file(path, encoding = file_encoding)
-  on.exit(close(con), add = TRUE)
-
-  lines <- readLines(con, warn = FALSE, n = n, ok = ok, skipNul = skipNul)
-  Encoding(lines) <- ""UTF-8""
-  lines
-}

---FILE: R/parse.R---
@@ -30,13 +30,11 @@ parse_package <- function(path = ""."",
                           registry = default_tags(),
                           global_options = list()
                           ) {
-  desc <- read_pkg_description(path)
 
   files <- package_files(path)
   list_of_blocks <- lapply(files, tokenize_file,
     registry = registry,
-    global_options = global_options,
-    file_encoding = desc$Encoding %||% ""UTF-8""
+    global_options = global_options
   )
 
   blocks <- purrr::flatten(list_of_blocks)
@@ -83,7 +81,7 @@ parse_text <- function(text,
                        global_options = list()) {
 
   file <- tempfile()
-  writeLines(text, file)
+  write_lines(text, file)
   on.exit(unlink(file))
 
   parse_file(

---FILE: R/rd.R---
@@ -366,7 +366,7 @@ topic_add_examples <- function(topic, block, base_path) {
       next
     }
 
-    code <- readLines(path)
+    code <- read_lines(path)
     examples <- escape_examples(code)
 
     topic$add_simple_field(""examples"", examples)

---FILE: R/roclet.R---
@@ -125,7 +125,7 @@ roc_proc_text <- function(roclet, input, registry = default_tags(),
   stopifnot(is.roclet(roclet))
 
   file <- tempfile()
-  writeLines(input, file)
+  write_lines(input, file)
   on.exit(unlink(file))
 
   env <- env_file(file)

---FILE: R/roxygenize.R---
@@ -32,6 +32,11 @@ roxygenize <- function(package.dir = ""."",
   base_path <- normalizePath(package.dir)
   is_first <- roxygen_setup(base_path)
 
+  encoding <- desc::desc_get(""Encoding"", file = base_path)[[1]]
+  if (!identical(encoding, ""UTF-8"")) {
+    warning(""roxygen2 requires Encoding: UTF-8"", call. = FALSE)
+  }
+
   options <- load_options(base_path)
   roclets <- roclets %||% options$roclets
 

---FILE: R/safety.R---
@@ -14,17 +14,17 @@ first_time <- function(path) {
 made_by_roxygen <- function(path) {
   if (!file.exists(path)) return(TRUE)
 
-  first <- readLines(path, n = 1)
+  first <- read_lines(path, n = 1)
   check_made_by(first)
 }
 
 add_made_by_roxygen <- function(path, comment) {
   if (!file.exists(path)) stop(""Can't find "", path, call. = FALSE)
 
-  lines <- readLines(path, warn = FALSE)
+  lines <- read_lines(path)
   if (check_made_by(lines[1])) return()
 
-  writeLines(c(made_by(comment), lines), path)
+  write_lines(c(made_by(comment), lines), path)
 }
 
 check_made_by <- function(first) {

---FILE: R/tokenize.R---
@@ -1,10 +1,9 @@
 # Returns list of roxy_blocks
 tokenize_file <- function(file,
                           registry = list(),
-                          global_options = list(),
-                          file_encoding = ""UTF-8""
+                          global_options = list()
                           ) {
-  lines <- read_lines_enc(file, file_encoding = file_encoding)
+  lines <- read_lines(file)
 
   parsed <- parse(
     text = lines,

---FILE: R/utils-io.R---
@@ -0,0 +1,16 @@
+readLines <- function(...) stop(""Use read_lines!"")
+writeLines <- function(...) stop(""Use write_lines!"")
+
+read_lines <- function(path, n = -1L) {
+  con <- file(path, open = ""r"", encoding = ""utf-8"")
+  on.exit(close(con))
+
+  base::readLines(con, n = n, warn = FALSE)
+}
+
+write_lines <- function(text, path) {
+  con <- file(path, open = ""w"", encoding = ""utf-8"")
+  on.exit(close(con))
+
+  base::writeLines(text, con)
+}

---FILE: R/utils.R---
@@ -80,7 +80,7 @@ write_if_different <- function(path, contents, check = TRUE) {
     FALSE
   } else {
     cat(sprintf('Writing %s\n', name))
-    writeLines(contents, path, useBytes = TRUE)
+    write_lines(contents, path)
     TRUE
   }
 }
@@ -113,7 +113,7 @@ ignore_files <- function(rfiles, path) {
   rfiles_relative <- sub(""^[/]*"", """", rfiles_relative)
 
   # Remove any files that match any perl-compatible regexp
-  patterns <- readLines(rbuildignore, warn = FALSE)
+  patterns <- read_lines(rbuildignore)
   patterns <- patterns[patterns != """"]
   if (length(patterns) == 0L) {
     return(rfiles)

---FILE: tests/testthat/test-Rbuildignore.R---
@@ -6,15 +6,14 @@ test_that(""roxygen ignores files with matching pattern in .Rbuildignore"", {
 
   expect_equal(basename(package_files(test_pkg)), c(""a.R"", ""ignore_me.R""))
 
-  #writeLines(""^R/ignore_me.R$"", file.path(test_pkg, "".Rbuildignore""))
-  writeChar(""^R/ignore_me.R$\n"", file.path(test_pkg, "".Rbuildignore""), eos = NULL)
+  write_lines(""^R/ignore_me.R$\n"", file.path(test_pkg, "".Rbuildignore""))
   expect_equal(basename(package_files(test_pkg)), ""a.R"")
 })
 
 test_that(""roxygen works with empty lines in .Rbuildignore"", {
   test_pkg <- temp_copy_pkg(test_path(""testRbuildignore""))
   on.exit(unlink(test_pkg, recursive = TRUE))
 
-  writeChar(""^R/ignore_me.R$\n\n.nonexistentfile"", file.path(test_pkg, "".Rbuildignore""), eos = NULL)
+  write_lines(""^R/ignore_me.R$\n\n.nonexistentfile"", file.path(test_pkg, "".Rbuildignore""))
   expect_equal(basename(package_files(test_pkg)), ""a.R"")
 })

---FILE: tests/testthat/test-nonASCII.R---
@@ -1,19 +0,0 @@
-context(""nonASCII"")
-
-test_that(""can generate nonASCII document"", {
-  test_pkg <- temp_copy_pkg('testNonASCII')
-  on.exit(unlink(test_pkg, recursive = TRUE), add = TRUE)
-
-  expect_output(roxygenise(test_pkg, roclets = ""rd""), ""printChineseMsg[.]Rd"")
-  expect_true(file.exists(file.path(test_pkg, ""man"", ""printChineseMsg.Rd"")))
-
-  cnChar <- read_lines_enc(file.path(test_pkg, ""man"", ""printChineseMsg.Rd""))
-
-  # Because the parse in testthat::test don't specify encoding to UTF-8 as well,
-  # so we have to use unicode escapes.
-  expect_true(any(grepl(""\u6211\u7231\u4e2d\u6587"", cnChar)))
-  expect_true(any(grepl(""\u4e2d\u6587\u6ce8\u91ca"", cnChar)))
-
-  # No output on second run
-  expect_output(roxygenise(test_pkg, roclets = ""rd""), NA)
-})

---FILE: tests/testthat/test-utf8.R---
@@ -0,0 +1,35 @@
+context(""nonASCII"")
+
+test_that(""can generate nonASCII document"", {
+  test_pkg <- temp_copy_pkg(test_path('testNonASCII'))
+  on.exit(unlink(test_pkg, recursive = TRUE), add = TRUE)
+
+  expect_output(roxygenise(test_pkg, roclets = ""rd""), ""printChineseMsg[.]Rd"")
+
+  rd_path <- file.path(test_pkg, ""man"", ""printChineseMsg.Rd"")
+  expect_true(file.exists(rd_path))
+  rd <- read_lines(rd_path)
+
+  expect_true(any(grepl(""\u6211\u7231\u4e2d\u6587"", rd)))
+  expect_true(any(grepl(""\u4e2d\u6587\u6ce8\u91ca"", rd)))
+
+  # Shouldn't change again
+  expect_output(roxygenise(test_pkg, roclets = ""rd""), NA)
+})
+
+
+test_that(""unicode escapes are ok"", {
+  test_pkg <- temp_copy_pkg(test_path('testUtf8Escape'))
+  on.exit(unlink(test_pkg, recursive = TRUE), add = TRUE)
+
+  expect_output(roxygenise(test_pkg, roclets = ""rd""), ""a[.]Rd"")
+
+  rd_path <- file.path(test_pkg, ""man"", ""a.Rd"")
+  expect_true(file.exists(rd_path))
+  rd <- read_lines(rd_path)
+
+  expect_true(any(grepl(""7\u00b0C"", rd)))
+
+  # Shouldn't change again
+  expect_output(roxygenise(test_pkg, roclets = ""rd""), NA)
+})

---FILE: tests/testthat/testEagerData/DESCRIPTION---
@@ -5,3 +5,4 @@ Description:
 Author: Hadley <h.wickham@gmail.com>
 Maintainer: Hadley <h.wickham@gmail.com>
 Version: 0.1
+Encoding: UTF-8

---FILE: tests/testthat/testLazyData/DESCRIPTION---
@@ -6,3 +6,4 @@ Author: Hadley <h.wickham@gmail.com>
 Maintainer: Hadley <h.wickham@gmail.com>
 Version: 0.1
 LazyData: TRUE
+Encoding: UTF-8

---FILE: tests/testthat/testNonASCII/DESCRIPTION---
@@ -4,5 +4,5 @@ License: GPL-2
 Description:
 Author: Shrektan <shrektan@126.com>
 Maintainer: Shrektan <shrektan@126.com>
-Encoding: GB2312
+Encoding: UTF-8
 Version: 0.1

---FILE: tests/testthat/testNonASCII/R/a.r---
@@ -1,9 +1,6 @@
-# This script is intended to be saved in GB2312 to test if non UTF-8 encoding is
-# supported.
-
-#' 涌쬂찧涌쬂찧뮖찧涌
+#' 疸쇉둖柳뻘
 #'
-#' @note 涌훯涌쬂찧涌쬂찧캬涌
+#' @note 갬걈疸쇉둖
 printChineseMsg <- function() {
-  message(""涌쬂찧涌쬂찧GB2312涌쬂찧涌쬂찧涌쬂찧涌쫬涌쬂찧涌"")
+  message(""갬僚슛TF8眄疸쇉둖駱蓂뷖"")
 }

---FILE: tests/testthat/testUtf8Escape/DESCRIPTION---
@@ -0,0 +1,8 @@
+Package: testUtf8Escape
+Title: Check that utf8 escapes are round tripped ok
+License: GPL-2
+Description:
+Author: Hadley <hadley@rstudio.com>
+Maintainer: Hadley <hadley@rstudio.com>
+Encoding: UTF-8
+Version: 0.1

---FILE: tests/testthat/testUtf8Escape/R/a.r---
@@ -0,0 +1,4 @@
+#' Title
+#'
+#' @param b Some label
+a <- function(b = '7춿C') 1"
r-lib,roxygen2,c3ab0d38708833c22b15ae0895bd8978e422a6e1,hadley,h.wickham@gmail.com,2017-08-22T00:37:49Z,hadley,h.wickham@gmail.com,2017-08-22T12:39:13Z,"Updates to Rd vignette

Fixes #650",NEWS.md;vignettes/rd.Rmd,True,False,True,False,139,158,297,"---FILE: NEWS.md---
@@ -1,5 +1,9 @@
 # roxygen2 6.0.1.9000
 
+* `vignette(""rd"")` received a thorough updating for current best-practice.
+  The vignette still needs more work so pull requests are greatly appreciated
+  (#650).
+
 * Tags (including `@alias`) are now de-duplicated and consistently sorted.
   This reduces spurious diffs (#586, @flying-sheep).
 

---FILE: vignettes/rd.Rmd---
@@ -1,7 +1,6 @@
 ---
 title: ""Generating Rd files""
 author: ""Hadley Wickham""
-date: ""`r Sys.Date()`""
 output: rmarkdown::html_vignette
 vignette: >
   %\VignetteIndexEntry{Generating Rd files}
@@ -65,89 +64,54 @@ add(10, 1)
 }
 ```
 
-Rd files are a special file format loosely based on LaTeX. You can read more about the Rd format in the [R extensions](https://cran.r-project.org/doc/manuals/R-exts.html#Rd-format) manual. I'll avoid discussing Rd files as much as possible, focussing instead on what you need to know about roxygen2.
+Rd files are a special file format loosely based on LaTeX. You can read more about the Rd format in the [R extensions](https://cran.r-project.org/doc/manuals/R-exts.html#Rd-format) manual. With roxygen2, there are few reasons to know about Rd files, so here I'll avoid discussing them as much as possible, focussing instead on what you need to know about roxygen2.
 
-When you use `?x`, `help(""x"")` or `example(""x"")` R looks for an Rd file containing `\alias{x}`. It then parses the file, converts it into html and displays it.
+When you use `?x`, `help(""x"")` or `example(""x"")` R looks for an Rd file containing `\alias{x}`. It then parses the file, converts it into html and displays it. These functions look for an Rd file in _installed_ packages. This isn't very useful for package development, because you want to use the `.Rd` files in the _source_ package. For this reason, we recommend that you use roxygen2 in conjunction with devtools:  `dwevtools::load_all()` automatically adds shims so that `?` and friends will look in the development package. Note, however, that this preview does not work with intra-package links. To preview those, you'll need to install the package. If you use RStudio, the easiest way to do this is to click the ""Build & Reload button"".
 
-All of these functions look for an Rd file in _installed_ packages. This isn't very useful for package development, because you want to use the `.Rd` files in the _source_ package. `devtools` provides two helpful functions for this scenario: `dev_help()` and `dev_example()`. They behave similarly to `help()` and `example()` but look in source packages you've loaded with `load_all()`, not installed packages you've loaded with `library()`.
+## Basics
 
-## Basic documentation
-
-Roxygen comments start with `#'` and include tags like `@tag details`. Tags break the documentation up into pieces, and the content of a tag extends from the end of tag name to the start of the next tag (or the end of the block). Because `@` has a special meaning in roxygen, you need to write `@@` to add a literal `@` to the documentation.
-
-Each documentation block starts with some text. The first sentence becomes the title of the documentation. That's what you see when you look at `help(package = mypackage)` and is shown at the top of each help file. It should fit on one line, be written in sentence case, and end in a full stop. The second paragraph is the description: this comes first in the documentation and should briefly describe what the function does. The third and subsequent paragraphs go into the details: this is a (often long) section that comes after the argument description and should provide any other important details of how the function operates.
-
-Here's an example showing what the documentation for `sum()` might look like if it had been written with roxygen:
+Roxygen comments start with `#'`. Each documentation block starts with some text which defines the title, the description, and the detais. Here's an example showing what the documentation for `sum()` might look like if it had been written with roxygen:
 
 ```{r}
 #' Sum of vector elements.
 #'
-#' \code{sum} returns the sum of all the values present in its arguments.
+#' `sum` returns the sum of all the values present in its arguments.
 #'
 #' This is a generic function: methods can be defined for it directly
-#' or via the \code{\link{Summary}} group generic. For this to work properly,
-#' the arguments \code{...} should be unnamed, and dispatch is on the
+#' or via the [Summary()] group generic. For this to work properly,
+#' the arguments `...` should be unnamed, and dispatch is on the
 #' first argument.
 sum <- function(..., na.rm = TRUE) {}
 ```
 
-`\code{}` and `\link{}` are `.Rd` formatting commands which you'll learn more about in [formatting](formatting.html). Also notice the wrapping of the roxygen block. You should make sure that your comments are less than ~80 columns wide.
-
-The following documentation produces the same help file as above, but uses explicit tags. You only need explicit tags if you want to the title or description to span multiple paragraphs (a bad idea), or want to omit the description (in which case roxygen will use the title for the description, since it's a required documentation component).
-
-```{r}
-#' @title Sum of vector elements.
-#'
-#' @description
-#' \code{sum} returns the sum of all the values present in its arguments.
-#'
-#' @details
-#' This is a generic function: methods can be defined for it directly
-#' or via the \code{\link{Summary}} group generic. For this to work properly,
-#' the arguments \code{...} should be unnamed, and dispatch is on the
-#' first argument.
-sum <- function(..., na.rm = TRUE) {}
-```
-
-All objects must have a title and description. Details are optional.
-
-### Enhancing navigation.
-
-There are two tags that make it easier for people to navigate around your documentation: `@seealso` and `@family`. 
-
-`@seealso` allows you to point to other useful resources, either on the web `\url{http://www.r-project.org}`, or to other documentation with `\code{\link{functioname}}`. 
+This introductory block is broken up as follows:
 
-If you have a family of related functions, you can use the `@family <family>` tag to automatically add appropriate lists and interlinks to the `@seealso` section. Because it will appear as ""Other <family>:"", the `@family` name should be plural (i.e., ""model building helpers"" not ""model building helper""). You can make a function a member of multiple families by repeating the @family tag for each additional family. These will then get separate headings in the __seealso__ section.
+*  The first sentence is the __title__: that's what you see when you look at 
+   `help(package = mypackage)` and is shown at the top of each help file. It 
+   should generally fit on one line, be written in sentence case, and not end 
+   in a full stop. 
+  
+*  The second paragraph is the __description__: this comes first in the 
+   documentation and should briefly describe what the function does. 
+   
+*  The third and subsequent paragraphs go into the __details__: this is a
+   (often long) section that comes after the argument description and should 
+   provide any other important details of how the function operates. The 
+   details are optional..
 
-For sum, these components might look like:
+Note that you can use markdown formatting within roxygen blocks, as long as you have the following in the `DESCRIPTION`:
 
-```{r}
-#' @family aggregate functions
-#' @seealso \code{\link{prod}} for products, \code{\link{cumsum}} for
-#'  cumulative sums, and \code{\link{colSums}}/\code{\link{rowSums}}
-#'  marginal sums over high-dimensional arrays.
+```
+Roxygen: list(markdown = TRUE)
 ```
 
-Three other tags make it easier for the user to find documentation:
-
-* `@aliases space separated aliases` to add additional aliases, through
-  which the user can find the documentation with `?`.
-
-* `@concept` to add extra keywords that will be found with `help.search()`
+We'll discuss that more in [formatting](formatting.html). Also note the wrapping of the roxygen block. You should make sure that your comments are less than ~80 columns wide.
 
-* `@keywords keyword1 keyword2 ...` to add standardised keywords. Keywords are
-  optional, but if present, must be taken from the predefined list replicated
-  in the [keywords vignette](rdkeywords.html). Keywords are not very useful,
-  except for `@keywords internal`. Using the internal keyword removes all functions
-  in the associated `.Rd` file from the documentation index and disables some of
-  their automated tests.
-  A common use case is to both export a function (using `@export`) and marking it as
-  internal. That way, advanced users can access a function that new users would be confused
-  about if they were to see it in the index.
+## Object specifics
 
-You use other tags based on the type of object that you're documenting. The following sections describe the most commonly used tags for functions, S3, S4 and RC objects and data.
+Further details of roxygen2 depend on what you're documenting. You use use __tags__ like `@tag details`. Tags must start at the beginning of a line, and the content of a tag extends to the start of the next tag (or the end of the block). The following sections describe the most commonly used tags for functions, S3, S4, and RC objects and data set.
 
-## Documenting functions
+### Functions
 
 Functions are the mostly commonly documented objects. Most functions use three tags:
 
@@ -197,24 +161,24 @@ We could use these new tags to improve our documentation of `sum()` as follows:
 ```{r}
 #' Sum of vector elements.
 #'
-#' \code{sum} returns the sum of all the values present in its arguments.
+#' `sum()` returns the sum of all the values present in its arguments.
 #'
 #' This is a generic function: methods can be defined for it directly
-#' or via the \code{\link{Summary}} group generic. For this to work properly,
-#' the arguments \code{...} should be unnamed, and dispatch is on the
+#' or via the [Summary] group generic. For this to work properly,
+#' the arguments `...` should be unnamed, and dispatch is on the
 #' first argument.
 #'
 #' @param ... Numeric, complex, or logical vectors.
-#' @param na.rm A logical scalar. Should missing values (including NaN)
+#' @param na.rm A logical scalar. Should missing values (including `NaN`)
 #'   be removed?
 #' @return If all inputs are integer and logical, then the output
-#'   will be an integer. If integer overflow
-#'   \url{http://en.wikipedia.org/wiki/Integer_overflow} occurs, the output
+#'   will be an integer. If integer overflow 
+#'   (<http://en.wikipedia.org/wiki/Integer_overflow>) occurs, the output
 #'   will be NA with a warning. Otherwise it will be a length-one numeric or
 #'   complex vector.
 #'
 #'   Zero-length vectors have sum 0 by definition. See
-#'   \url{http://en.wikipedia.org/wiki/Empty_sum} for more details.
+#'   <http://en.wikipedia.org/wiki/Empty_sum> for more details.
 #' @examples
 #' sum(1:10)
 #' sum(1:5, 6:10)
@@ -231,20 +195,14 @@ sum <- function(..., na.rm = TRUE) {}
 
 Indent the second and subsequent lines of a tag so that when scanning the documentation so it's easy to see where one tag ends and the next begins. Tags that always span multiple lines (like `@example`) should start on a new line and don't need to be indented.
 
-## Documenting classes, generics and methods
-
-Documenting classes, generics and methods are relatively straightforward, but there are some variations based on the object system. The following sections give the details for the S3, S4 and RC object systems.
-
 ### S3
 
 S3 __generics__ are regular functions, so document them as such. S3 __classes__ have no formal definition, so document the constructor function. It is your choice whether or not to document S3 __methods__. You don't need to document methods for simple generics like `print()`. If your method is more complicated, you should document it so people know what the parameters do. In base R, you can find documentation for more complex methods like `predict.lm()`, `predict.glm()`, and `anova.glm()`.
 
-Older versions of roxygen required explicit `@method generic class` tags for all S3 methods. From 3.0.0 this is no longer needed as and roxygen2 will figure it out automatically. If you are upgrading, make sure to remove these old tags. Automatic method detection will only fail if the generic and class are ambiguous. For example is `all.equal.data.frame()` the `equal.data.frame` method for `all`, or the `data.frame` method for `all.equal`?. If this happens, you can disambiguate with (e.g.) `@method all.equal data.frame`.
+Generally, roxygen2 will automatically figure the generic associated with an S3 method. It  should only fail if the generic and class are ambiguous. For example is `all.equal.data.frame()` the `equal.data.frame` method for `all`, or the `data.frame` method for `all.equal`?. If this happens, you can disambiguate with (e.g.) `@method all.equal data.frame`.
 
 ### S4
 
-Older versions of roxygen2 required explicit `@usage`, `@alias` and `@docType` to correctly document S4 objects, but from version 3.0.0 on roxygen2 generates correct metadata automatically. If you're upgrading from a previous version, make sure to remove these old tags.
-
 S4 __generics__ are also functions, so document them as such. Document __S4 classes__ by adding a roxygen block before `setClass()`. Use `@slot` to document the slots of the class. Here's a simple example:
 
 ```{r}
@@ -269,36 +227,13 @@ S4 __methods__ are a little more complicated. Unlike S3, all S4 methods must be
 
 Use either `@rdname` or `@describeIn` to control where method documentation goes. See the next section for more details.
 
-### RC
-
-RC is different to S3 and S4 because methods are associated with classes, not generics. RC also has a special convention for documenting methods: the docstring. This makes documenting RC simpler than S4 because you only need one roxygen block per class.
-
-```{r}
-#' A Reference Class to represent a bank account.
-#'
-#' @field balance A length-one numeric vector
-Account <- setRefClass(""Account"",
-  fields = list(balance = ""numeric""),
-  methods = list(
-    withdraw = function(x) {
-      ""Withdraw money from account. Allows overdrafts""
-      balance <<- balance - x
-    }
-  )
-)
-```
-
-Methods with doc strings will be included in the ""Methods"" section of the class documentation. Each documented method will be listed with an automatically generated usage statement and its doc string.
-
-## Documenting datasets
+### Datasets
 
 Datasets are usually stored as `.rdata` files in `data/` and not as regular R objects in the package. This means you need to document them slightly differently: instead of documenting the data directly, you quote the dataset's name.
 
 There are two additional tags that are useful for documenting datasets:
 
 * `@format`, which gives an overview of the structure of the dataset.
-  If you omit this, roxygen will automatically add something based on the
-  first line of `str()` output
 
 * `@source` where you got the data form, often a `\url{}`.
 
@@ -310,37 +245,33 @@ To show how everything fits together, the example below is an excerpt from the r
 #' A dataset containing the prices and other attributes of almost 54,000
 #' diamonds. The variables are as follows:
 #'
-#' \itemize{
-#'   \item price. price in US dollars (\$326--\$18,823)
-#'   \item carat. weight of the diamond (0.2--5.01)
-#'   ...
-#' }
+#' * `price`: price in US dollars (\$326--\$18,823)
+#' * `carat`: weight of the diamond (0.2--5.01)
+#' * ...
 #'
 #' @format A data frame with 53940 rows and 10 variables
-#' @source \url{http://www.diamondse.info/}
+#' @source <http://www.diamondse.info/>
 ""diamonds""
 ```
 
-## Documenting packages
+### Packages
 
 As well as documenting every exported object in the package, you should also document the package itself. Relatively few packages do this, but it's an extremely useful because instead of just listing functions like `help(package = pkgname)` it organises them and shows the user where to get started.
 
-Package documentation should describe the overall purpose of the package and point out the most important functions. It should not contain a verbatim list of functions or a copy of `DESCRIPTION` (although, to help you get started, the title and description are inherited from `DESCRIPTION` by default). This file is for human reading, so pick the most important elements of your package.
+Package documentation should describe the overall purpose of the package and point out the most important functions. The title and desription are automatically inherited from the `DESCRIPTION`, so generally you should only need to supply additional details in `@details`
 
 Package documentation should be placed in `pkgname.R`. Here's an example:
 
 ```{r}
-#' Generate R documentation from inline comments.
-#'
-#' Roxygen2 allows you to write documentation in comment blocks co-located
-#' with code.
-#'
-#' The only function you're likely to need from \pkg{roxygen2} is
-#' \code{\link{roxygenize}}. Otherwise refer to the vignettes to see
-#' how to format the documentation.
+#' @details
+#' The only function you're likely to need from roxygen2 is [roxygenize()]. 
+#' Otherwise refer to the vignettes to see how to format the documentation.
+#' @keywords internal
 ""_PACKAGE""
 ```
 
+I recommend using `@keyword internals` for package documentation.
+
 Some notes:
 
 * Like for datasets, there isn't a object that we can document directly. Use
@@ -354,21 +285,70 @@ Some notes:
 
 Package documentation is a good place to list all `options()` that a package understands and to document their behaviour. Put in a section called ""Package options"", as described below.
 
+## Sections
+
+You can add arbitrary sections to the documentation for any object with the `@section` tag. This is a useful way of breaking a long details section into multiple chunks with useful headings. Section titles should be in sentence case and must be followed by a colon. Titles may only take one line.
+
+```{r}
+#' @section Warning:
+#' Do not operate heavy machinery within 8 hours of using this function.
+```
+
+To add a subsection, you must use the `Rd` `\subsection{}` command, as follows:
+
+```{r}
+#' @section Warning:
+#' You must not call this function unless ...
+#'
+#' \subsection{Exceptions}{
+#'    Apart from the following special cases...
+#' }
+```
+
+Sections with identical titles will be merged.
+This is especially useful in conjunction with the `@rdname` tag:
+
+```{r}
+#' Basic arithmetic
+#'
+#' @param x,y numeric vectors.
+#' @section Neutral elements:
+#'   Addition: 0.
+add <- function(x, y) x + y
+
+#' @rdname add
+#' @section Neutral elements:
+#'   Multiplication: 1.
+times <- function(x, y) x * y
+```
+
+For very long documentation files, you might consider using a vignette instead.
+
 ## Do repeat yourself
 
 There is a tension between the DRY (do not repeat yourself) principle of programming and the need for documentation to be self-contained. It's frustrating to have to navigate through multiple help files in order to pull together all the pieces you need. Roxygen2 provides three ways to avoid repeating yourself in code documentation, while assembling information from multiple places in one documentation file:
 
-* create reusable templates with `@template` and `@templateVar`
-* reuse parameter documentation with `@inheritParams`
-* document multiple functions in the same place with `@describeIn` or `@rdname`
+* Cross-link documentation files with `@seealso` and `@family`.
+* Reuse parameter documentation with `@inherit`, `@inheritParams`, and `@inheritSections`.
+* Document multiple functions in the same place with `@describeIn` or `@rdname`.
+* Run arbtirary R code with `@eval`.
+* Create reusable templates with `@template` and `@templateVar`.
 
-### Roxygen templates
+### Cross-references
 
-Roxygen templates are R files that contain only roxygen comments and that live in the `man-roxygen` directory. Use `@template file-name` (without extension) to insert the contents of a template into the current documentation.
+There are two tags that make it easier for people to navigate around your documentation: `@seealso` and `@family`. 
 
-You can make templates more flexible by using template variables defined with `@templateVar name value`. Template files are run with brew, so you can retrieve values (or execute any other arbitrary R code) with `<%= name %>`.
+`@seealso` allows you to point to other useful resources, either on the web `<http://www.r-project.org>` or to other documentation with `[functioname()]`. 
 
-Note that templates are parsed a little differently to regular blocks, so you'll need to explicitly set the title, description and details with `@title`, `@description` and `@details`.
+If you have a family of related functions, you can use the `@family <family>` tag to automatically add appropriate lists and interlinks to the `@seealso` section. Because it will appear as ""Other <family>:"", the `@family` name should be plural (i.e., ""model building helpers"" not ""model building helper""). You can make a function a member of multiple families by repeating the @family tag for each additional family. These will then get separate headings in the __seealso__ section.
+
+For sum, these components might look like:
+
+```{r}
+#' @family aggregate functions
+#' @seealso [prod()] for products, [cumsum()] for cumulative sums, and
+#'   [colSums()]/[rowSums()] marginal sums over high-dimensional arrays.
+```
 
 ### Inheriting documentation from other topics
 
@@ -380,6 +360,9 @@ You can inherit documentation from other functions in a few ways:
 * `@inherit source_function return details` will inherit selected components 
   from `source_function()`
 
+* `@inheritParams source_function` inherits just the parameter documentation 
+  from `source_function()`.
+
 * `@inheritSection source_function Section title` will inherit the single 
   section called ""Section title"" from `source_function()`.
   
@@ -389,7 +372,7 @@ You can also inherit documentation from functions provided by another package by
 
 ### Documenting multiple functions in the same file
 
-You can document multiple functions in the same file by using either `@rdname` or `@describeIn` tag. It뗩 a technique best used with caution: documenting too many functions in one place leads to confusion. Use it when all functions have the same (or very similar) arguments.
+You can document multiple functions in the same file by using either `@rdname` or `@describeIn` tag. It뗩 a technique best used with care: documenting too many functions in one place leads to confusion. Use it when all functions have the same (or very similar) arguments.
 
 `@describeIn` is designed for the most common cases:
 
@@ -440,45 +423,40 @@ add <- function(x, y) x + y
 times <- function(x, y) x * y
 ```
 
-## Sections
+### Evaluating arbitrary code
 
-You can add arbitrary sections to the documentation for any object with the `@section` tag. This is a useful way of breaking a long details section into multiple chunks with useful headings. Section titles should be in sentence case and must be followed by a colon. Titles may only take one line.
+A new and powerful technique is the `@eval` tag. It evaluates code and treatments the result as if it was a literal roxygen tags. This makes it possible to eliminate duplication by writing functions.
 
-```{r}
-#' @section Warning:
-#' Do not operate heavy machinery within 8 hours of using this function.
-```
+### Roxygen templates
 
-To add a subsection, you must use the `Rd` `\subsection{}` command, as follows:
+Roxygen templates are R files that contain only roxygen comments and that live in the `man-roxygen` directory. Use `@template file-name` (without extension) to insert the contents of a template into the current documentation.
 
-```{r}
-#' @section Warning:
-#' You must not call this function unless ...
-#'
-#' \subsection{Exceptions}{
-#'    Apart from the following special cases...
-#' }
-```
+You can make templates more flexible by using template variables defined with `@templateVar name value`. Template files are run with brew, so you can retrieve values (or execute any other arbitrary R code) with `<%= name %>`.
 
-Sections with identical titles will be merged.
-This is especially useful in conjunction with the `@rdname` tag:
+Note that templates are parsed a little differently to regular blocks, so you'll need to explicitly set the title, description and details with `@title`, `@description` and `@details`.
 
-```{r}
-#' Basic arithmetic
-#'
-#' @param x,y numeric vectors.
-#' @section Neutral elements:
-#'   Addition: 0.
-add <- function(x, y) x + y
+## Other tags
 
-#' @rdname add
-#' @section Neutral elements:
-#'   Multiplication: 1.
-times <- function(x, y) x * y
-```
+### Title, description, details
 
+You can also use explicit `@title`, `@description`, and `@details` tags. This is unnecessary unless you want to have a multi-paragraph description.
 
-## Back references
+### Keywords
+
+Ues `@keywords keyword1 keyword2 ...` to add standardised keywords. Keywords are optional, but if present, must be taken from the predefined list replicated in the [keywords vignette](rdkeywords.html).
+
+Keywords are not very useful, except for `@keywords internal`. Using the internal keyword removes the function from the documentation index and is useful for functions aimed primarily at other developers, not typically users of the package.
+
+### Indexing
+
+Three other tags make it easier for the user to find documentation:
+
+*   Aliases form the index that `?` searches. Use 
+    `@aliases space separated aliases` to add additional aliases.
+    
+*   `@concept` add extra keywords that will be found with `help.search()`
+
+### Back references
 
 The original source location is added as a comment
 to the second line of each generated `.Rd` file in the following form:
@@ -489,9 +467,8 @@ to the second line of each generated `.Rd` file in the following form:
 
 `roxygen2` tries to capture all locations from which the documentation is assembled.
 For code that *generates* R code with Roxygen comments (e.g., the `Rcpp` package),
-the `@backref` tag is provided.
-This allows specifying the ""true"" source of the documentation,
-and will substitute the default list of source files.
+the `@backref` tag is provided. This allows specifying the ""true"" source of the documentation, and will substitute the default list of source files. 
+
 Use one tag per source file:
 
 ```{r}"
r-lib,roxygen2,7143c3fff0a95d8bf353a7cb53a0e40610802bbd,Luca Weihs,astronomicalcuriosity@gmail.com,2017-08-21T21:41:36Z,Hadley Wickham,h.wickham@gmail.com,2017-08-21T21:41:36Z,Fixing a bug that broke parsing of R.methodsS3::setMethodS3 and R.oo::setConstructorS3. This bug was introduced in code review of pull request #525 (the arguments to a call to standardise_obj were incorrectly changed). (#639),R/object-from-call.R,False,True,True,False,2,2,4,"---FILE: R/object-from-call.R---
@@ -148,13 +148,13 @@ parser_setMethodS3 <- function(call, env, block) {
   method <- as.character(call[[2]])
   class <- as.character(call[[3]])
   name <- paste(method, class, sep=""."")
-  value <- standardise_obj(get(name, env), value, env, block)
+  value <- standardise_obj(name, get(name, env), env, block)
   object(value, name)
 }
 
 parser_setConstructorS3 <- function(call, env, block) {
   # R.oo::setConstructorS3(name, ...)
   name <- as.character(call[[2]])
-  value <- standardise_obj(get(name, env), value, env, block)
+  value <- standardise_obj(name, get(name, env), env, block)
   object(value, name)
 }"
r-lib,roxygen2,7b14686b8940870f229d067d4e05f1e2e21bdb5b,dpritchLibre,dpritch@live.unc.edu,2017-08-21T20:31:25Z,Hadley Wickham,h.wickham@gmail.com,2017-08-21T20:31:25Z,"Modify ignore_files() for empty .Rbuildignore (#646)

* Modify ignore_files() for empty .Rbuildignore

If the .Rbuildignore file is empty, or more generally if all of the lines in the
file are empty, then the `ignore_files` function in utils.R (line 106) will
throw an error rather than simply returning its first argument to the function,
`rfiles`, which is the desired behavior.  In more detail, if the .Rbuildignore
file is empty, then on line 117

  patterns <- patterns[patterns != """"]

returns a length-0 vector, which in turn causes

  matches <- lapply(patterns, grepl, rfiles_relative, perl = TRUE)

to return a length-0 list, which in turn causes

  matches <- Reduce(""|"", matches)

to return NULL.  This causes the !matches expression in

  rfiles[!matches]

to throw an error.  The proposed modification simply checks whether
patterns[patterns != """"] is a length-0 vector, and if so returns the first
argument to the function, `rfiles`.

* Remove unneeded branch in ignore_files()

Removed the branch call that came from an else statement that came after an
`if (condition) return(val)` statement.

* Update news to include PR #647

* Modify NEWS.md spaces to prevent merge conflict

There were trailing spaces in the upstream branch in NEWS.md that were nuked in
the previoud commit.  This commit reverts those changes so that the PR doesn't
cause a merge conflict.",NEWS.md;R/utils.R,False,True,True,False,6,1,7,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 6.0.1.9000
 
+* Ensure that an empty .Rbuildignore file is handled properly.  Previously, this
+  situation would cause an undesired error to be thrown (#576).
+
 * The NAMESPACE roclet nows works in two passes - it first generates the 
   a NAMESPACE containing only import directives becaues this can be generated
   without evaluating the code in the package. This alleviates a problem

---FILE: R/utils.R---
@@ -115,12 +115,14 @@ ignore_files <- function(rfiles, path) {
   # Remove any files that match any perl-compatible regexp
   patterns <- readLines(rbuildignore, warn = FALSE)
   patterns <- patterns[patterns != """"]
+  if (length(patterns) == 0L) {
+    return(rfiles)
+  }
   matches <- lapply(patterns, grepl, rfiles_relative, perl = TRUE)
   matches <- Reduce(""|"", matches)
   rfiles[!matches]
 }
 
-
 compact <- function(x) {
   null <- vapply(x, is.null, logical(1))
   x[!null]"
r-lib,roxygen2,eb7aa68110d28c826d1a602fa43ae8c547d34925,hadley,h.wickham@gmail.com,2017-08-21T20:28:29Z,hadley,h.wickham@gmail.com,2017-08-21T20:28:29Z,"Implement roclet_preprocess.namespace_rd

Fixes #372.",NEWS.md;R/namespace.R;R/roxygenize.R;man/namespace_roclet.Rd,False,True,True,False,88,31,119,"---FILE: NEWS.md---
@@ -1,5 +1,11 @@
 # roxygen2 6.0.1.9000
 
+* The NAMESPACE roclet nows works in two passes - it first generates the 
+  a NAMESPACE containing only import directives becaues this can be generated
+  without evaluating the code in the package. This alleviates a problem
+  where it was previously possible to get into a state that you could only
+  get out of by carefully editting the NAMESPACE by hand (#372).
+
 * New `roclet_preprocess` generic makes it possible for roclets to perform 
   actions before code is evaluated.
 

---FILE: R/namespace.R---
@@ -1,12 +1,16 @@
-ns_tags <- c('evalNamespace', 'export', 'exportClass', 'exportMethod',
-  'exportPattern', 'rawNamespace', 'S3method', 'import', 'importFrom',
-  'importClassesFrom', 'importMethodsFrom', 'useDynLib')
+ns_tags_import <- c('import', 'importFrom', 'importClassesFrom', 'importMethodsFrom', 'useDynLib', 'rawNamespace')
+ns_tags_export <- c('export', 'exportClass', 'exportMethod', 'exportPattern', 'S3method')
+ns_tags <- c(ns_tags_import, ns_tags_export, 'evalNamespace')
 
 #' Roclet: make NAMESPACE.
 #'
 #' This roclet automates the production of a `NAMESPACE` file,
 #' see Writing R Extensions.
 #' (<https://cran.r-project.org/doc/manuals/R-exts.pdf>) for details.
+#' The `NAMESPACE` is generated in two passes: the first generates only
+#' import directives (because this can be computed without evaluating package
+#' code), and the second generates everything (after the packaege has been
+#' loaded).
 #'
 #' @family roclets
 #' @export
@@ -18,6 +22,27 @@ namespace_roclet <- function() {
   roclet(""namespace"")
 }
 
+#' @export
+roclet_preprocess.roclet_namespace <- function(x,
+                                               blocks,
+                                               base_path,
+                                               global_options = list()) {
+
+  lines <- unlist(lapply(blocks, block_to_ns, tag_set = ns_tags_import)) %||% character()
+  lines <- sort_c(unique(lines))
+
+  NAMESPACE <- file.path(base_path, ""NAMESPACE"")
+  if (purrr::is_empty(lines) && !made_by_roxygen(NAMESPACE)) {
+    return(x)
+  }
+
+  results <- c(made_by(""#""), lines)
+  write_if_different(NAMESPACE, results, check = FALSE)
+
+  invisible(x)
+}
+
+
 #' @export
 roclet_process.roclet_namespace <- function(x,
                                             blocks,
@@ -48,8 +73,8 @@ roclet_tags.roclet_namespace <- function(x) {
   )
 }
 
-block_to_ns <- function(block, env) {
-  tags <- intersect(names(block), ns_tags)
+block_to_ns <- function(block, env, tag_set = ns_tags) {
+  tags <- intersect(names(block), tag_set)
   lapply(tags, ns_process_tag, block = block, env = env)
 }
 

---FILE: R/roxygenize.R---
@@ -29,15 +29,8 @@ roxygenize <- function(package.dir = ""."",
                        load_code = env_package,
                        clean = FALSE) {
 
-  is_first <- first_time(package.dir)
-  if (is_first) {
-    message(""First time using roxygen2. Upgrading automatically..."")
-  }
-
   base_path <- normalizePath(package.dir)
-  man_path <- file.path(base_path, ""man"")
-  dir.create(man_path, recursive = TRUE, showWarnings = FALSE)
-  update_roxygen_version(base_path)
+  is_first <- roxygen_setup(base_path)
 
   options <- load_options(base_path)
   roclets <- roclets %||% options$roclets
@@ -54,31 +47,46 @@ roxygenize <- function(package.dir = ""."",
 
   roclets <- lapply(roclets, roclet_find)
 
-  # Generate registry of all roclet tags
-  tags <- c(lapply(roclets, roclet_tags), list(list(include = tag_value)))
-  registry <- unlist(tags, recursive = FALSE)
+  # Tokenise each file
+  registry <- purrr::flatten(lapply(roclets, roclet_tags))
+  blocks <- parse_package(base_path,
+    env = NULL,
+    registry = registry,
+    global_options = options
+  )
+
+  if (clean) {
+    purrr::walk(roclets, roclet_clean, base_path = base_path)
+  }
 
+  roclets <- lapply(roclets, roclet_preprocess,
+    blocks = blocks,
+    global_options = options,
+    base_path = base_path
+  )
+
+  # Now load code
   env <- load_code(base_path)
-  blocks <- parse_package(base_path,
+  blocks <- lapply(blocks, block_set_env,
     env = env,
     registry = registry,
     global_options = options
   )
 
-  roc_out <- function(roc) {
-    if (clean) {
-      roclet_clean(roc, base_path)
-    }
-    results <- roclet_process(
-      roc,
-      blocks = blocks,
-      env = env,
-      base_path = base_path,
-      global_options = options
-    )
-    roclet_output(roc, results, base_path, is_first = is_first)
-  }
-  invisible(unlist(lapply(roclets, roc_out)))
+  results <- lapply(roclets, roclet_process,
+    blocks = blocks,
+    env = env,
+    base_path = base_path,
+    global_options = options
+  )
+
+  out <- purrr::map2(
+    roclets, results,
+    roclet_output,
+    base_path = base_path,
+    is_first = is_first
+  )
+  invisible(out)
 }
 
 #' @rdname roxygenize
@@ -114,3 +122,17 @@ load_options <- function(base_path = ""."") {
 
   utils::modifyList(defaults, opts)
 }
+
+
+roxygen_setup <- function(base_path) {
+  is_first <- first_time(base_path)
+  if (is_first) {
+    message(""First time using roxygen2. Upgrading automatically..."")
+  }
+
+  man_path <- file.path(base_path, ""man"")
+  dir.create(man_path, recursive = TRUE, showWarnings = FALSE)
+  update_roxygen_version(base_path)
+
+  is_first
+}

---FILE: man/namespace_roclet.Rd---
@@ -22,6 +22,10 @@ namespace_roclet()
 This roclet automates the production of a \code{NAMESPACE} file,
 see Writing R Extensions.
 (\url{https://cran.r-project.org/doc/manuals/R-exts.pdf}) for details.
+The \code{NAMESPACE} is generated in two passes: the first generates only
+import directives (because this can be computed without evaluating package
+code), and the second generates everything (after the packaege has been
+loaded).
 }
 \seealso{
 \code{vignette(""namespace"", package = ""roxygen2"")}"
r-lib,roxygen2,664bbf15a0eb4daee45e74bbe7e862fc7e05bae5,Hadley Wickham,h.wickham@gmail.com,2017-08-18T18:22:48Z,GitHub,noreply@github.com,2017-08-18T18:22:48Z,"Implement @eval (#652)

Fixes #645",NEWS.md;R/markdown.R;R/object-defaults.R;R/parse.R;R/rd.R;R/utils.R;man/rd_roclet.Rd;tests/testthat/test-eval.R;tests/testthat/test-namespace.R,False,True,True,False,163,39,202,"---FILE: NEWS.md---
@@ -1,5 +1,14 @@
 # roxygen2 6.0.1.9000
 
+* `@eval foo()` evaluates `foo()` defined in the package namespace and inserts
+  the results into the current block (#645). The code should return a character 
+  vector with one entry for each line (and they should not start with `#'`).
+  
+    There are two small limitations to the current implementation:
+    
+    1. The generated roxygen will not affect the `@md`/`@noMd` status
+    2. `@evalRd` does not work inside templates.
+
 * `@concept` now generates one `\concept` per tag (#611).
 
 * `@family` automatically adds its value to concepts (#611).

---FILE: R/markdown.R---
@@ -14,6 +14,28 @@ markdown_on <- function(value = NULL) {
   return(isTRUE(markdown_env$`markdown-support`))
 }
 
+markdown_activate <- function(tags, file, offset, global_options = list()) {
+  ## markdown on/off based on global flag and presense of @md & @nomd
+  ## we need to use markdown_global_default as well, because global_options
+  ## can be NULL, e.g. if called from parse_text()
+
+  names <- vapply(tags, `[[`, ""tag"", FUN.VALUE = character(1))
+  has_md <- ""md"" %in% names
+  has_nomd <- ""noMd"" %in% names
+  if (has_md && has_nomd) {
+    warning(
+      ""Both @md and @noMd, no markdown parsing, in block at "",
+      file, "":"", offset
+    )
+  }
+
+  md <- global_options$markdown %||% markdown_global_default
+  if (has_md) md <- TRUE
+  if (has_nomd) md <- FALSE
+
+  markdown_on(md)
+}
+
 restricted_markdown <- function(rest) {
   markdown(rest, markdown_tags_restricted)
 }

---FILE: R/object-defaults.R---
@@ -1,5 +1,5 @@
 # Combine a block with defaults generated from the object
-add_defaults <- function(block) {
+block_add_defaults <- function(block) {
   defaults <- object_defaults(block$object)
 
   for (tag in names(defaults)) {

---FILE: R/parse.R---
@@ -67,7 +67,10 @@ parse_text <- function(text, registry = default_tags(), global_options = list())
   list(env = env, blocks = blocks)
 }
 
-parse_blocks <- function(file, env, registry, global_options = list(), fileEncoding = ""UTF-8"") {
+parse_blocks <- function(file, env, registry = list(), global_options = list(), fileEncoding = ""UTF-8"") {
+
+  # Manaully add eval tag to registry - it's always active
+  registry$eval <- tag_code
 
   lines <- read_lines_enc(file, file_encoding = fileEncoding)
   parsed <- parse(text = lines, keep.source = TRUE, srcfile = srcfilecopy(file, lines, isFile = TRUE))
@@ -88,7 +91,8 @@ parse_blocks <- function(file, env, registry, global_options = list(), fileEncod
 
     block$object <- object_from_call(call, env, block, file)
     block$srcref <- list(filename = file, lloc = as.vector(ref))
-    add_defaults(block)
+    block <- block_evaluate(block, env, registry = registry)
+    block_add_defaults(block)
   }
 
   Map(extract, parsed, refs, comment_refs)
@@ -99,27 +103,13 @@ parse_block <- function(x, file, env, registry, offset = x[[1]], global_options
   if (length(tags) == 0)
     return()
 
-  ## markdown on/off based on global flag and presense of @md & @nomd
-  ## we need to use markdown_global_default as well, because global_options
-  ## can be NULL, e.g. if called from parse_text()
-
-  names <- vapply(tags, `[[`, ""tag"", FUN.VALUE = character(1))
-  has_md <- ""md"" %in% names
-  has_nomd <- ""noMd"" %in% names
-
-  md <- global_options$markdown %||% markdown_global_default
-  if (has_md) md <- TRUE
-  if (has_nomd) md <- FALSE
-  markdown_on(md)
-
-  if (has_md && has_nomd) {
-    warning(
-      ""Both @md and @noMd, no markdown parsing, in block at "",
-      file, "":"", offset
-    )
-  }
+  markdown_activate(tags, file, offset, global_options)
 
   tags <- parse_description(tags)
+  parse_tags(tags, registry = registry)
+}
+
+parse_tags <- function(tags, registry) {
   tags <- compact(lapply(tags, parse_tag, registry = registry))
 
   # Convert to existing named list format - this isn't ideal, but
@@ -132,11 +122,46 @@ parse_block <- function(x, file, env, registry, offset = x[[1]], global_options
 parse_tag <- function(x, registry) {
   stopifnot(is.roxy_tag(x))
 
-  if (!(x$tag %in% ls(registry))) {
-    return(roxy_tag_warning(x, ""unknown tag""))
+  if (x$tag %in% ls(registry)) {
+    registry[[x$tag]](x)
+  } else {
+    roxy_tag_warning(x, ""unknown tag"")
   }
+}
+
+block_evaluate <- function(block, env, registry) {
+  is_eval <- names(block) == ""eval""
+  eval <- block[is_eval]
+  if (length(eval) == 0)
+    return(block)
+
+  # Evaluate
+  results <- lapply(eval, block_eval,
+    block = block,
+    env = env,
+    tag_name = ""@eval""
+  )
+  results <- lapply(results, function(x) {
+    if (is.null(x)) {
+      character()
+    } else {
+      paste0(""#' "", x)
+    }
+  })
+
+  # Tokenise and parse
+  tokens <- lapply(results, tokenise_block,
+    file = block$srcref$filename,
+    offset = block$srcref$lloc[[1]]
+  )
+  tags <- lapply(tokens, parse_tags, registry = registry)
+
+  # Interpolate results back into original locations
+  out <- lapply(block, list)
+  out[is_eval] <- tags
+  names(out)[is_eval] <- """"
 
-  registry[[x$tag]](x)
+  compact(unlist(out, recursive = FALSE))
 }
 
 parse_description <- function(tags) {

---FILE: R/rd.R---
@@ -5,12 +5,21 @@ NULL
 #'
 #' @family roclets
 #' @template rd
+#' @eval rd_roclet_description()
 #' @seealso `vignette(""rd"", package = ""roxygen2"")`
 #' @export
 rd_roclet <- function() {
   roclet(""rd"")
 }
 
+rd_roclet_description <- function() {
+  c(
+    ""@description"",
+    ""Generally you will not call this function directly"",
+    ""but will instead use roxygenise() specifying the rd roclet""
+  )
+}
+
 #' @export
 roclet_tags.roclet_rd <- function(x) {
   list(
@@ -369,7 +378,7 @@ topic_add_eval_rd <- function(topic, block, env) {
   for (tag in tags) {
     out <- block_eval(tag, block, env, ""@evalRd"")
     if (!is.null(out)) {
-      topic$add_simple_field(""rawRd"", as.character(out))
+      topic$add_simple_field(""rawRd"", out)
     }
   }
 }

---FILE: R/utils.R---
@@ -131,8 +131,10 @@ block_eval <- function(tag, block, env, tag_name) {
     expr <- parse(text = tag)
     out <- eval(expr, envir = env)
 
-    if (!is.character(out) || length(out) != 1L || is.na(out)) {
+    if (!is.character(out)) {
       block_warning(block, tag_name, "" did not evaluate to a string"")
+    } else if (anyNA(out)) {
+      block_warning(block, tag_name, "" result contained NA"")
     } else {
       out
     }

---FILE: man/rd_roclet.Rd---
@@ -9,6 +9,9 @@ rd_roclet()
 \description{
 This roclet is the workhorse of \code{roxygen}, producing the Rd files that
 document that functions in your package.
+
+Generally you will not call this function directly
+but will instead use roxygenise() specifying the rd roclet
 }
 \seealso{
 \code{vignette(""rd"", package = ""roxygen2"")}

---FILE: tests/testthat/test-eval.R---
@@ -0,0 +1,54 @@
+context(""eval"")
+
+test_that(""evaluation occurs during parsing"", {
+  out <- roc_proc_text(rd_roclet(), ""
+    foo <- function() c('@name a', '@title a')
+    #' @eval foo()
+    NULL"")[[1]]
+
+  expect_equal(out$get_field(""title"")$values, ""a"")
+  expect_equal(out$filename, ""a.Rd"")
+})
+
+test_that(""errors are propagated"", {
+  expect_warning(
+    roc_proc_text(rd_roclet(), ""
+      foo <- function() stop('Uhoh')
+      #' @eval foo()
+      NULL""
+    ),
+    ""@eval failed with error""
+  )
+})
+
+test_that(""must return non-NA string"", {
+  expect_warning(
+    roc_proc_text(rd_roclet(), ""
+      foo <- function() NA
+      #' @eval foo()
+      NULL""
+    ),
+    ""@eval did not evaluate to a string""
+  )
+
+  expect_warning(
+    roc_proc_text(rd_roclet(), ""
+      foo <- function() NA_character_
+      #' @eval foo()
+      NULL""
+    ),
+    ""@eval result contained NA""
+  )
+})
+
+
+test_that(""also works with namespace roclet"", {
+  out <- roc_proc_text(namespace_roclet(), ""
+    foo <- function() '@export a'
+    #' @eval foo()
+    #' @name a
+    #' @title a
+    NULL"")
+
+  expect_equal(out, ""export(a)"")
+})

---FILE: tests/testthat/test-namespace.R---
@@ -249,17 +249,6 @@ test_that(""evalNamespace generates warning when code doesn't eval to string"", {
     ""@evalNamespace did not evaluate to a string""  # From block_eval
   )
 
-  # Not scalar
-  expect_warning(
-    roc_proc_text(namespace_roclet(), ""
-      nms <- letters[1:3]
-      #' @evalNamespace paste('export(', nms, ')', sep = ',')
-      #' @name a
-      #' @title a
-      NULL""),
-    ""@evalNamespace did not evaluate to a string""  # From block_eval
-  )
-
   # NA_character_ not allowed
   expect_warning(
     roc_proc_text(namespace_roclet(), ""
@@ -268,7 +257,7 @@ test_that(""evalNamespace generates warning when code doesn't eval to string"", {
       #' @name a
       #' @title a
       NULL""),
-    ""@evalNamespace did not evaluate to a string""  # From block_eval
+    ""@evalNamespace result contained NA""  # From block_eval
   )
 })
 
@@ -290,3 +279,14 @@ test_that(""evalNamespace code is inserted when its value is a string"", {
   expect_equal(out1, ""export(a,b,c)"")
   expect_equal(out2, ""export(a,b,c)"")
 })
+
+test_that(""evalNamspace can yield a vector"", {
+  out <- roc_proc_text(namespace_roclet(), ""
+    nms <- letters[1:2]
+    #' @evalNamespace paste0('export(', nms, ')')
+    #' @name a
+    #' @title a
+    NULL"")
+
+  expect_equal(out, c(""export(a)"", ""export(b)""))
+})"
r-lib,roxygen2,2b527688ad019d35311a72a49cbf112006aa2b4e,hadley,h.wickham@gmail.com,2017-08-18T14:54:19Z,hadley,h.wickham@gmail.com,2017-08-18T14:54:19Z,"Better concepts

Fixes #611",NEWS.md;R/field.R;R/rd-family.R;man/namespace_roclet.Rd;man/rd_roclet.Rd;man/vignette_roclet.Rd;tests/testthat/test-rd-family.R;tests/testthat/test-rd.R,False,True,True,False,34,4,38,"---FILE: NEWS.md---
@@ -1,5 +1,9 @@
 # roxygen2 6.0.1.9000
 
+* `@concept` now generates one `\concept` per tag (#611).
+
+* `@family` automatically adds its value to concepts (#611).
+
 * Stricter regular expression ensures only files ending with `.R` or `.r` are
   parsed for roxygen comments (#625).
 

---FILE: R/field.R---
@@ -73,6 +73,8 @@ format.roxy_field_alias <- function(x, ...) {
   x$values <- str_replace_all(x$values, fixed(""%""), ""\\%"")
   format_rd(x, ..., sort = FALSE)
 }
+#' @export
+format.roxy_field_concept <- format_rd
 
 # Fields that keep the first occurence -----------------------------------------
 format_first <- function(x, ...) {
@@ -104,8 +106,6 @@ format_collapse <- function(x, ..., indent = 0, exdent = 0, wrap = TRUE) {
 #' @export
 format.roxy_field_author <- format_collapse
 #' @export
-format.roxy_field_concept <- format_collapse
-#' @export
 format.roxy_field_description <- format_collapse
 #' @export
 format.roxy_field_details <- format_collapse

---FILE: R/rd-family.R---
@@ -8,6 +8,7 @@ topics_process_family <- function(topics) {
 
     for (family in families) {
       related <- family_index[[family]]
+      topic$add_simple_field(""concept"", family)
 
       others <- setdiff(related, topic_name)
       if (length(others) < 1)

---FILE: man/namespace_roclet.Rd---
@@ -29,3 +29,4 @@ see Writing R Extensions.
 Other roclets: \code{\link{rd_roclet}},
   \code{\link{vignette_roclet}}
 }
+\concept{roclets}

---FILE: man/rd_roclet.Rd---
@@ -16,3 +16,4 @@ document that functions in your package.
 Other roclets: \code{\link{namespace_roclet}},
   \code{\link{vignette_roclet}}
 }
+\concept{roclets}

---FILE: man/vignette_roclet.Rd---
@@ -23,3 +23,4 @@ field in your project options.
 Other roclets: \code{\link{namespace_roclet}},
   \code{\link{rd_roclet}}
 }
+\concept{roclets}

---FILE: tests/testthat/test-rd-family.R---
@@ -85,3 +85,13 @@ test_that(""families listed in same order as input"", {
   expect_match(seealso[1], ""^Other b"")
   expect_match(seealso[2], ""^Other a"")
 })
+
+test_that(""family also included in concepts"", {
+  out <- roc_proc_text(rd_roclet(), ""
+    #' foo
+    #' @family a
+    foo <- function() {}
+  "")[[1]]
+
+  expect_equal(out$get_field(""concept"")$values, ""a"")
+})

---FILE: tests/testthat/test-rd.R---
@@ -17,18 +17,30 @@ test_that(""generic keys produce expected output"", {
     #' @note test
     #' @author test
     #' @seealso test
-    #' @concept test
     #' @encoding test
     #' @name a
     NULL"")[[1]]
   expect_equal(get_tag(out, ""references"")$values, ""test"")
   expect_equal(get_tag(out, ""note"")$values, ""test"")
   expect_equal(get_tag(out, ""seealso"")$values, ""test"")
-  expect_equal(get_tag(out, ""concept"")$values, ""test"")
   expect_equal(get_tag(out, ""encoding"")$values, ""test"")
   expect_equal(get_tag(out, ""author"")$values, ""test"")
 })
 
+test_that(""one line per concept"", {
+  out <- roc_proc_text(rd_roclet(), ""
+    #' @title a
+    #' @name a
+    #' @concept test1
+    #' @concept test2
+    NULL"")[[1]]
+
+  field <- out$get_field(""concept"")
+
+  expect_equal(field$values, c(""test1"", ""test2""))
+  expect_equal(format(field), c(""\\concept{test1}"", ""\\concept{test2}""))
+})
+
 test_that(""@noRd inhibits documentation"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' Would be title"
r-lib,roxygen2,202fafa208c6caa0f4cfb43e5bbe87b82d375bdf,hadley,h.wickham@gmail.com,2017-08-18T12:31:17Z,hadley,h.wickham@gmail.com,2017-08-18T12:31:17Z,"Stricter regexp for .r,.R files

Fixes #625",NEWS.md;R/utils.R,False,True,True,False,4,1,5,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 6.0.1.9000
 
+* Stricter regular expression ensures only files ending with `.R` or `.r` are
+  parsed for roxygen comments (#625).
+
 * `%` in inline code blocks in markdown is now automatically escaped
   (#640).
 

---FILE: R/utils.R---
@@ -100,7 +100,7 @@ same_contents <- function(path, contents) {
 }
 
 r_files <- function(path) {
-  sort_c(dir(file.path(path, ""R""), ""[.Rr]$"", full.names = TRUE))
+  sort_c(dir(file.path(path, ""R""), ""\\.[Rr]$"", full.names = TRUE))
 }
 
 ignore_files <- function(rfiles, path) {"
r-lib,roxygen2,7c87da228458c8ba4792de58ca49f64601a76e1e,hadley,h.wickham@gmail.com,2017-08-17T21:55:51Z,hadley,h.wickham@gmail.com,2017-08-17T21:55:51Z,"Escape Rd comments in inline code

Fixes #640",NEWS.md;R/markdown.R;tests/testthat/test-rd-markdown.R,False,True,True,False,14,1,15,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 6.0.1.9000
 
+* `%` in inline code blocks in markdown is now automatically escaped
+  (#640).
+
 * Roclets can now access global options as designed. This allows templates to
   use markdown formatting if set globally (#594).
 

---FILE: R/markdown.R---
@@ -152,7 +152,7 @@ markdown_tags <- list(
   },
 
   code = function(xml) {
-    list(""\\code{"", xml_contents(xml), ""}"")
+    list(""\\code{"", gsub(""%"", ""\\\\%"", xml_contents(xml)), ""}"")
   },
 
   html_inline = function(xml) {

---FILE: tests/testthat/test-rd-markdown.R---
@@ -58,6 +58,16 @@ test_that(""code blocks work"", {
   expect_equivalent_rd(out1, out2)
 })
 
+test_that(""inline code escapes %"", {
+  out <- roc_proc_text(rd_roclet(), ""
+    #' `0.5%`
+    #' @md
+    f <- function() 1
+  "")[[1]]
+
+  expect_equal(out$get_field(""title"")$values, ""\\code{0.5\\%}"")
+})
+
 test_that(""itemized lists work"", {
   out1 <- roc_proc_text(roc, ""
     #' Title"
r-lib,roxygen2,66df310d517c66d074ca9580ff6bc6acb27ee387,hadley,h.wickham@gmail.com,2017-08-17T21:47:16Z,hadley,h.wickham@gmail.com,2017-08-17T21:47:16Z,Quote template name in error message,R/rd-template.R,False,True,True,False,1,1,2,"---FILE: R/rd-template.R---
@@ -3,7 +3,7 @@ template_find <- function(base_path, template_name) {
   path_exists <- file.exists(path)
 
   if (!any(path_exists)) {
-    stop(""Can not find template "", template_name, call. = FALSE)
+    stop(""Can't find template '"", template_name, ""'"", call. = FALSE)
   }
 
   path[path_exists][1]"
r-lib,roxygen2,3f6837eeea68595122d8c9ac8ebb16b64521ee0b,hadley,h.wickham@gmail.com,2017-08-17T21:47:03Z,hadley,h.wickham@gmail.com,2017-08-17T21:47:08Z,"Pass global options to roclet_process

Fixes #594",NEWS.md;R/roxygenize.R,False,True,True,False,9,1,10,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 6.0.1.9000
 
+* Roclets can now access global options as designed. This allows templates to
+  use markdown formatting if set globally (#594).
+
 * `@inherits` can now inherits examples (#588).
 
 * The default description (i.e. the title) is now added much later in the 

---FILE: R/roxygenize.R---
@@ -68,7 +68,12 @@ roxygenize <- function(package.dir = ""."",
     if (clean) {
       roclet_clean(roc, base_path)
     }
-    results <- roclet_process(roc, parsed, base_path)
+    results <- roclet_process(
+      roc,
+      parsed = parsed,
+      base_path = base_path,
+      global_options = options
+    )
     roclet_output(roc, results, base_path, is_first = is_first)
   }
   invisible(unlist(lapply(roclets, roc_out)))"
r-lib,roxygen2,8259871389aaf2c335a9620a175c0a6c3295fb56,hadley,h.wickham@gmail.com,2017-08-17T21:32:58Z,hadley,h.wickham@gmail.com,2017-08-17T21:32:58Z,"Inherit examples

Fixes #588",NEWS.md;R/rd-inherit.R;R/tag.R;tests/testthat/test-Rd-inherit.R,False,True,True,False,9,3,12,"---FILE: NEWS.md---
@@ -1,5 +1,7 @@
 # roxygen2 6.0.1.9000
 
+* `@inherits` can now inherits examples (#588).
+
 * The default description (i.e. the title) is now added much later in the 
   process. That means that `@inherit description` now works when you have 
   specified a title for the inheritor (#629) and the default description

---FILE: R/rd-inherit.R---
@@ -10,6 +10,7 @@ topics_process_inherit <- function(topics, env) {
   topics$topo_apply(inherits(""details""), inherit_field, ""details"")
   topics$topo_apply(inherits(""seealso""), inherit_field, ""seealso"")
   topics$topo_apply(inherits(""references""), inherit_field, ""references"")
+  topics$topo_apply(inherits(""examples""), inherit_field, ""examples"")
 
   # First inherit individual sections, then all sections.
   topics$topo_apply(function(x) x$inherits_section_from(), inherit_section)

---FILE: R/tag.R---
@@ -79,7 +79,7 @@ tag_inherit <- function(x) {
     fields <- pieces[-1]
 
     all <- c(""params"", ""return"", ""title"", ""description"", ""details"", ""seealso"",
-      ""sections"", ""references"")
+      ""sections"", ""references"", ""examples"")
     if (length(fields) == 0) {
       fields <- all
     } else {

---FILE: tests/testthat/test-Rd-inherit.R---
@@ -39,8 +39,8 @@ test_that(""no options gives default values"", {
   expect_equal(
     block$inherit$fields,
     c(
-      ""params"", ""return"", ""title"", ""description"", ""details"", ""seealso"", ""sections"",
-      ""references""
+      ""params"", ""return"", ""title"", ""description"", ""details"", ""seealso"",
+      ""sections"", ""references"", ""examples""
     )
   )
 })
@@ -462,6 +462,8 @@ test_that(""can inherit all from single function"", {
     #'
     #' @param x x
     #' @param y y
+    #' @examples
+    #' x <- 1
     foo <- function(x, y) {}
 
     #' @inherit foo
@@ -473,4 +475,5 @@ test_that(""can inherit all from single function"", {
   expect_equal(out$get_field(""title"")$values, ""Foo"")
   expect_equal(out$get_field(""description"")$values, ""Description"")
   expect_equal(out$get_field(""details"")$values, ""Details"")
+  expect_equal(out$get_field(""examples"")$values, rd(""x <- 1""))
 })"
r-lib,roxygen2,827b9f8f62647238dc2c75ff52cab69d2d79105d,hadley,h.wickham@gmail.com,2017-08-17T21:14:16Z,hadley,h.wickham@gmail.com,2017-08-17T21:14:16Z,"Set default description after all blocks processed

Fixes #629",NEWS.md;R/markdown-escaping.R;R/parse.R;R/rd.R;tests/testthat/test-Rd-inherit.R;tests/testthat/test-rd-introduction.R;tests/testthat/test-rd-raw.R,False,True,True,False,40,10,50,"---FILE: NEWS.md---
@@ -1,5 +1,10 @@
 # roxygen2 6.0.1.9000
 
+* The default description (i.e. the title) is now added much later in the 
+  process. That means that `@inherit description` now works when you have 
+  specified a title for the inheritor (#629) and the default description
+  is slightly nicer when merging multiple blocks.
+
 * The mechanism for extracting inherited Rd does a better job of 
   preserving escapes (#624)
 

---FILE: R/markdown-escaping.R---
@@ -46,6 +46,7 @@ escaped_for_md <- paste0(""\\"", c(
   ""testonly"", ""url"", ""var"", ""verb""
 ))
 
+#' @description
 #' It puts back the protected fragile Rd commands into
 #' the text after the markdown parsing.
 #'

---FILE: R/parse.R---
@@ -120,14 +120,11 @@ parse_description <- function(tags) {
   }
 
   # 2nd paragraph = description (unless has @description)
-  if (""description"" %in% tag_names) {
+  if (""description"" %in% tag_names || length(paragraphs) == 0) {
     description <- NULL
   } else if (length(paragraphs) > 0) {
     description <- roxy_tag(""description"", paragraphs[1], intro$file, intro$line)
     paragraphs <- paragraphs[-1]
-  } else {
-    # Description is required, so if missing description, repeat title.
-    description <- roxy_tag(""description"", title$val, intro$file, intro$line)
   }
 
   # Every thing else = details, combined with @details

---FILE: R/rd.R---
@@ -75,10 +75,23 @@ roclet_process.roclet_rd <- function(x, parsed, base_path,
   topics_process_inherit(topics, parsed$env)
   topics$drop_invalid()
   topics_fix_params_order(topics)
+  topics_add_default_description(topics)
 
   topics$topics
 }
 
+topics_add_default_description <- function(topics) {
+  for (topic in topics$topics) {
+    if (length(topic$get_field(""description"")) > 0)
+      next
+
+    topic$add_simple_field(""description"", topic$get_field(""title"")$values)
+  }
+
+  invisible()
+}
+
+
 block_to_rd <- function(block, base_path, env, global_options = list()) {
   # Must start by processing templates
   block <- process_templates(block, base_path, global_options)

---FILE: tests/testthat/test-Rd-inherit.R---
@@ -147,7 +147,7 @@ test_that(""can inherit description from roxygen topic"", {
   expect_equal(out$get_field(""description"")$values, ""B"")
 })
 
-test_that(""won't inherit description if already set through title"", {
+test_that(""inherits description if omitted"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' A.
     #'
@@ -161,7 +161,7 @@ test_that(""won't inherit description if already set through title"", {
     b <- function(y) {}
   "")[[2]]
 
-  expect_equal(out$get_field(""description"")$values, ""C"")
+  expect_equal(out$get_field(""description"")$values, ""B"")
 })
 
 test_that(""can inherit details from roxygen topic"", {

---FILE: tests/testthat/test-rd-introduction.R---
@@ -2,11 +2,25 @@ context(""Rd: introduction"")
 
 test_that(""title and description taken from first line if only one"", {
   out <- roc_proc_text(rd_roclet(), ""
-    #' description
+    #' title
     #' @name a
     NULL"")[[1]]
-  expect_equal(get_tag(out, ""description"")$values, ""description"")
-  expect_equal(get_tag(out, ""title"")$values, ""description"")
+  expect_equal(get_tag(out, ""description"")$values, ""title"")
+  expect_equal(get_tag(out, ""title"")$values, ""title"")
+})
+
+test_that(""description taken from multiple titles if merged"", {
+  out <- roc_proc_text(rd_roclet(), ""
+    #' T1
+    #' @name a
+    NULL
+
+    #' T2
+    #' @name a
+    NULL
+    "")[[1]]
+  expect_equal(get_tag(out, ""title"")$values, c(""T1"", ""T2""))
+  expect_equal(get_tag(out, ""description"")$values, c(""T1"", ""T2""))
 })
 
 test_that(""title, description and details extracted correctly"", {

---FILE: tests/testthat/test-rd-raw.R---
@@ -8,7 +8,7 @@ test_that(""rawRd inserted unchanged"", {
     NULL"")[[1]]
 
   lines <- strsplit(format(out), ""\n"")[[1]]
-  expect_equal(lines[[6]], ""#this is a comment"")
+  expect_equal(lines[[9]], ""#this is a comment"")
 })
 
 test_that(""evalRd must be valid code"", {"
r-lib,roxygen2,2edf4811fefc80132a267446aec77296e71aba39,hadley,h.wickham@gmail.com,2017-08-17T20:41:47Z,hadley,h.wickham@gmail.com,2017-08-17T20:41:47Z,"Use deparse = TRUE when converting Rd to text

Fixes #624",NEWS.md;R/utils-rd.R;tests/testthat/escapes.Rd;tests/testthat/test-Rd-inherit.R,False,True,True,False,29,5,34,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 6.0.1.9000
 
+* The mechanism for extracting inherited Rd does a better job of 
+  preserving escapes (#624)
+
 * You can now autogenerate package documentation even if you don't have 
   `Authors@R` (#606).
 

---FILE: R/utils-rd.R---
@@ -81,10 +81,7 @@ get_tags <- function(rd, tag) {
 }
 
 rd2text <- function(x) {
-  chr <- as.character(structure(x, class = ""Rd""))
-  str <- paste(chr, collapse = """")
-
-  # re-escape comments
-  gsub(""%"", ""\\%"", str, fixed = TRUE)
+  chr <- as.character(structure(x, class = ""Rd""), deparse = TRUE)
+  paste(chr, collapse = """")
 }
 

---FILE: tests/testthat/escapes.Rd---
@@ -0,0 +1,7 @@
+\name{x}
+\alias{x}
+\title{title}
+\description{
+% Comment
+\code{\\}
+}

---FILE: tests/testthat/test-Rd-inherit.R---
@@ -1,5 +1,22 @@
 context(""Rd: inherit"")
 
+
+# Rd parsing --------------------------------------------------------------
+
+test_that(""can round-trip Rd"", {
+  rd <- tools::parse_Rd(test_path(""escapes.Rd""))
+
+  field <- find_field(rd, ""description"")
+  lines <- strsplit(field, ""\n"")[[1]]
+  expect_equal(
+    lines,
+    c(
+      ""% Comment"",   # Latex comments shouldn't be escaped
+      ""\\code{\\\\}"" # Backslashes in code should be
+    )
+  )
+})
+
 # tag parsing -------------------------------------------------------------
 
 test_that(""warns on unknown inherit type"", {"
r-lib,roxygen2,9cc24c7db45680b4a9ff235d8f8ac0430e36c365,hadley,h.wickham@gmail.com,2017-08-17T18:54:44Z,hadley,h.wickham@gmail.com,2017-08-17T18:54:44Z,"parse(text = NULL) requires user input

Fixes #606",NEWS.md;R/object-package.R,False,True,True,False,4,1,5,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 6.0.1.9000
 
+* You can now autogenerate package documentation even if you don't have 
+  `Authors@R` (#606).
+
 * If a package logo exists (`man/figures/logo.png`) it will be automatically
   included in generated package docs (#609).
 

---FILE: R/object-package.R---
@@ -12,7 +12,7 @@ package_seealso <- function(desc) {
 }
 
 package_authors <- function(desc) {
-  authors <- tryCatch(eval(parse(text = desc$`Authors@R`)),
+  authors <- tryCatch(eval(parse(text = desc$`Authors@R` %||% """")),
     error = function(e) {
       warning(e)
       NULL"
r-lib,roxygen2,08d17e79919149f80106376abe2fb0ed0af712f6,hadley,h.wickham@gmail.com,2017-08-17T18:48:11Z,hadley,h.wickham@gmail.com,2017-08-17T18:48:11Z,"Automatically include package logo if available

Fixes #609",NEWS.md;R/object-defaults.R;R/object-from-call.R;R/roxygen.R;man/roxygen2-package.Rd,False,True,True,False,20,6,26,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 6.0.1.9000
 
+* If a package logo exists (`man/figures/logo.png`) it will be automatically
+  included in generated package docs (#609).
+
 * Usage for data objects now correctly generated, avoiding double escaping
   other components of usage (#562).
 

---FILE: R/object-defaults.R---
@@ -42,13 +42,20 @@ object_defaults.import <- function(x) {
 object_defaults.package <- function(x) {
   desc <- x$value$desc
 
+  description <- as.character(desc$Description)
+  logo_path <- file.path(x$value$path, ""man"", ""figures"", ""logo.png"")
+  if (file.exists(logo_path)) {
+    fig <- ""\\if{html}{\\figure{logo.png}{options: align='right'}}""
+    description <- paste0(fig, ""\n\n"", description)
+  }
+
   list(
     docType = ""package"",
     name = package_suffix(desc$Package),
     # ""NULL"" prevents addition of default aliases, see also #202
     aliases = paste(""NULL"", desc$Package, package_suffix(desc$Package)),
     title = paste0(desc$Package, "": "", desc$Title),
-    description = as.character(desc$Description),
+    description = description,
     seealso = package_seealso(desc),
     author = package_authors(desc)
   )

---FILE: R/object-from-call.R---
@@ -40,7 +40,13 @@ find_data_for_package <- function(env, file) {
   pkg_path <- dirname(dirname(file))
   desc <- read.description(file.path(pkg_path, ""DESCRIPTION""))
 
-  structure(list(desc = desc), class = ""package"")
+  structure(
+    list(
+      desc = desc,
+      path = pkg_path
+    ),
+    class = ""package""
+  )
 }
 
 # Find namespace associated with environment

---FILE: R/roxygen.R---
@@ -4,8 +4,6 @@
 #' documentation, and `vignette(""namespace"", package = ""roxygen2"")` for
 #' generating the namespace specification.
 #'
-#' ![](logo.png)
-#'
 #' If you have existing Rd files, check out the `Rd2roxygen` package
 #' for a convenient way of converting Rd files to roxygen comments.
 #'

---FILE: man/roxygen2-package.Rd---
@@ -6,6 +6,8 @@
 \alias{roxygen2-package}
 \title{roxygen2: In-Line Documentation for R}
 \description{
+\if{html}{\figure{logo.png}{options: align='right'}}
+
 Generate your Rd documentation, 'NAMESPACE' file, and collation
 field using specially formatted comments. Writing documentation in-line
 with code makes it easier to keep your documentation up-to-date as your
@@ -17,8 +19,6 @@ of the package, \code{vignette(""rd"", package = ""roxygen2"")} for generating
 documentation, and \code{vignette(""namespace"", package = ""roxygen2"")} for
 generating the namespace specification.
 
-\figure{logo.png}{}
-
 If you have existing Rd files, check out the \code{Rd2roxygen} package
 for a convenient way of converting Rd files to roxygen comments.
 }"
r-lib,roxygen2,ee5f63d7091ac3df62decc34f1fb59f6dc0e82d7,Eugene Ha,eha@posteo.de,2017-08-17T16:09:32Z,Hadley Wickham,h.wickham@gmail.com,2017-08-17T16:09:32Z,"Preserve whitespace between words in markdown link text (#630) 

Fixes #628",NEWS.md;R/markdown.R;tests/testthat/test-rd-markdown-links.R,False,True,True,False,45,1,46,"---FILE: NEWS.md---
@@ -10,6 +10,9 @@
 
 * Markdown code as link text is now properly rendered as code (#620, @egnha).
 
+* Whitespace between words in Markdown link text is now preserved as single
+  space (#628, @egnha).
+
 * `roxygenise()` uses `pkgload::load_all()` instead of a home grown solution 
   to simulate package loading (this is needed because roxygen2 uses run-time 
   information to generate the documetation). This should reduce S4 related

---FILE: R/markdown.R---
@@ -182,7 +182,7 @@ markdown_tags <- list(
     } else if (dest == """" || dest == xml_text(xml)) {
       list(""\\url{"", xml_text(xml), ""}"")
     } else {
-      list(""\\href{"", dest, ""}{"", xml_text(xml), ""}"")
+      list(""\\href{"", dest, ""}{"", xml_href_text(xml), ""}"")
     }
   },
 
@@ -200,6 +200,17 @@ ws_to_empty <- function(x) {
   sub(""^\\s*$"", """", x)
 }
 
+## Newlines in markdown get converted to softbreaks/linebreaks by
+## markdown_xml(), which then get interpreted as empty strings by
+## xml_text(). So we preserve newlines as spaces.
+
+xml_href_text <- function(xml) {
+  cnts <- xml_contents(xml)
+  text <- xml_text(cnts)
+  text[xml_name(cnts) %in% c(""linebreak"", ""softbreak"")] <- "" ""
+  text
+}
+
 #' Add link reference definitions for functions to a markdown text.
 #'
 #' We find the `[text][ref]` and the `[ref]` forms. There must be no

---FILE: tests/testthat/test-rd-markdown-links.R---
@@ -297,6 +297,36 @@ test_that(""[]() links are still fine"", {
     #' Description, see \\href{http://www.someurl.com}{some thing}.
     foo <- function() {}"")[[1]]
   expect_equivalent_rd(out1, out2)
+
+  out1 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Link
+    #' text [broken
+    #' across lines](http://www.someurl.com) preserve
+    #' whitespace, even when
+    #' [broken across
+    #' several
+    #' lines](http://www.someurl.com),
+    #' or with varying
+    #' [amounts \
+    #'   of  \
+    #' interspersed   \
+    #'   whitespace](http://www.someurl.com).
+    #' @md
+    foo <- function() {}"")[[1]]
+  out2 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Link
+    #' text \\href{http://www.someurl.com}{broken across lines} preserve
+    #' whitespace, even when
+    #' \\href{http://www.someurl.com}{broken across several lines},
+    #' or with varying
+    #' \\href{http://www.someurl.com}{amounts of interspersed whitespace}.
+    foo <- function() {}"")[[1]]
+  expect_equivalent_rd(out1, out2)
+
 })
 
 test_that(""links to S4 classes are OK"", {"
r-lib,roxygen2,c262d08e2ac8b132ac93e4bebd08c51ae010fbc5,hadley,h.wickham@gmail.com,2017-08-17T15:20:15Z,hadley,h.wickham@gmail.com,2017-08-17T15:20:15Z,"object_usage should always return rd objects

Fixes #562",NEWS.md;R/object-usage.R;tests/testthat/test-rd-usage.R,False,True,True,False,13,2,15,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 6.0.1.9000
 
+* Usage for data objects now correctly generated, avoiding double escaping
+  other components of usage (#562).
+
 * New tag `@evalNamespace` does for `NAMESPACE` what `@evalRd` does for Rd
   files: you give it R code that produces a literal entry in `NAMESPACE` when
   run. This should make it easier to export functions that are generated by

---FILE: R/object-usage.R---
@@ -6,7 +6,7 @@ object_usage.default <- function(x) NULL
 
 object_usage.NULL <- function(x) NULL
 
-object_usage.data <- function(x) x$alias
+object_usage.data <- function(x) rd(x$alias)
 
 object_usage.function <- function(x) {
   function_usage(x$alias, formals(x$value), identity)

---FILE: tests/testthat/test-rd-usage.R---
@@ -58,6 +58,15 @@ test_that(""default usage correct for S3 methods"", {
   expect_equal(get_tag(out[[3]], ""usage"")$values, rd(""\\method{[}{foo}(x) <- value""))
 })
 
+test_that(""usage correct for non-function objects"", {
+  out <- roc_proc_text(rd_roclet(), ""
+    #' Title
+    #'
+    hello <- 1
+  "")[[1]]
+
+  expect_equal(get_tag(out, ""usage"")$values, rd(""hello""))
+})
 
 test_that(""default usage correct for S4 methods"", {
   env <- pkg_env()
@@ -129,7 +138,6 @@ test_that(""backticks retained when needed"", {
   expect_equal(as.character(get_tag(out, ""usage"")$values), ""f(`_x`)"")
 })
 
-
 # @usage -----------------------------------------------------------------------
 
 test_that(""@usage overrides default"", {"
r-lib,roxygen2,bd0875cc547ce390363eb0792e5212d9326fd4e2,hadley,h.wickham@gmail.com,2017-08-17T14:53:02Z,hadley,h.wickham@gmail.com,2017-08-17T14:53:20Z,"Use pkgload

Fixes #568. Fixes #595.",DESCRIPTION;NEWS.md;R/source.R;man/source_package.Rd;roxygen.Rproj;tests/testthat/empty/DESCRIPTION;tests/testthat/test-namespace.R,False,True,True,False,15,59,74,"---FILE: DESCRIPTION---
@@ -22,6 +22,7 @@ Imports:
     desc,
     digest,
     methods,
+    pkgload,
     R6 (>= 2.1.2),
     Rcpp (>= 0.11.0),
     stringi,
@@ -39,3 +40,5 @@ LinkingTo:
 VignetteBuilder: knitr
 Roxygen: list(markdown = TRUE)
 RoxygenNote: 6.0.1.9000
+Remotes: 
+    r-lib/pkgload

---FILE: NEWS.md---
@@ -7,6 +7,12 @@
 
 * Markdown code as link text is now properly rendered as code (#620, @egnha).
 
+* `roxygenise()` uses `pkgload::load_all()` instead of a home grown solution 
+  to simulate package loading (this is needed because roxygen2 uses run-time 
+  information to generate the documetation). This should reduce S4 related
+  problems and ensures that `devtools::document()` and `roxygenise()` always
+  have exactly the same behaviour (#568, #595).
+
 # roxygen2 6.0.1
 
 * Allowing empty lines in .Rbuildignore. Previously, empty lines caused all 

---FILE: R/source.R---
@@ -1,63 +1,13 @@
 #' Source all files in a package.
 #'
-#' This is a simple attempt to load code in a package used by
-#' [roxygenize]. It will work with simple packages, but fail if
-#' there are compiled files, data files, etc. In that case, it's better to
-#' use [devtools::document].
+#' This is a wrapper around [pkgload::load_all]
 #'
 #' @param path Path to a package.
 #' @return An environment, into which all R files in the directory were
 #'   sourced.
 #' @keywords internal
 source_package <- function(path) {
-  r_path <- file.path(path, ""R"")
-  if (!file.exists(r_path)) stop(""Can't find R/ directory"", call. = FALSE)
-
-  old_dir <- setwd(r_path)
-  on.exit(setwd(old_dir))
-
-  env <- new.env(parent = globalenv())
-  methods::setPackageName(""roxygen_devtest"", env)
-
-  load_pkg_dependencies(path)
-
-  desc <- read_pkg_description(path)
-  paths <- package_files(path)
-  lapply(paths, sys_source, envir = env, fileEncoding = desc$Encoding %||% ""UTF-8"")
-
-  env
-}
-
-sys_source <- function(file, envir = baseenv(), fileEncoding = ""UTF-8"") {
-  exprs <- parse(text = read_lines_enc(file, file_encoding = fileEncoding))
-  for (expr in exprs) {
-    eval(expr, envir = envir)
-  }
-  invisible()
-}
-
-# Assume that the package has already been loaded by other means
-# (e.g. build and reload)
-loaded_package <- function(path) {
-  desc <- file.path(path, ""DESCRIPTION"")
-  stopifnot(file.exists(desc))
-
-  package <- read.dcf(desc, fields = ""Package"")[[1, 1]]
-  asNamespace(package)
-}
-
-
-
-load_pkg_dependencies <- function(path) {
-  desc <- read_pkg_description(path)
-
-  pkgs <- paste(c(desc$Depends, desc$Imports), collapse = "", "")
-  if (pkgs == """") return()
-
-  pkgs <- str_replace_all(pkgs, ""\\(.*?\\)"", """")
-  pkgs <- str_split(pkgs, "","")[[1]]
-  pkgs <- str_trim(pkgs)
-  lapply(pkgs[pkgs != ""R""], require, character.only = TRUE)
+  pkgload::load_all(path)$env
 }
 
 package_files <- function(path) {

---FILE: man/source_package.Rd---
@@ -14,9 +14,6 @@ An environment, into which all R files in the directory were
 sourced.
 }
 \description{
-This is a simple attempt to load code in a package used by
-\link{roxygenize}. It will work with simple packages, but fail if
-there are compiled files, data files, etc. In that case, it's better to
-use \link[devtools:document]{devtools::document}.
+This is a wrapper around \link[pkgload:load_all]{pkgload::load_all}
 }
 \keyword{internal}

---FILE: roxygen.Rproj---
@@ -3,7 +3,6 @@ Version: 1.0
 RestoreWorkspace: Default
 SaveWorkspace: Default
 AlwaysSaveHistory: Default
-QuitChildProcessesOnExit: Default
 
 EnableCodeIndexing: Yes
 UseSpacesForTab: Yes

---FILE: tests/testthat/empty/DESCRIPTION---
@@ -1 +1,2 @@
-Name: empty
+Package: empty
+Version: 1.0.0

---FILE: tests/testthat/test-namespace.R---
@@ -182,7 +182,7 @@ test_that(""useDynLib doesn't quote if comma present"", {
 })
 
 test_that(""empty NAMESPACE generates zero-length vector"", {
-  base_path <- normalizePath(""empty"")
+  base_path <- test_path(""empty"")
   parsed <- parse_package(base_path, source_package, registry = list())
 
   results <- roclet_process(namespace_roclet(), parsed, base_path)"
r-lib,roxygen2,ef252d6ff1fc36419970e82aa0469e9d4559a910,Eugene Ha,eha@posteo.de,2017-08-17T12:35:24Z,Hadley Wickham,h.wickham@gmail.com,2017-08-17T12:35:24Z,"Implement @evalNamespace (#596)

Fixes #531",NEWS.md;R/namespace.R;man/namespace_roclet.Rd;tests/testthat/test-namespace.R,False,True,True,False,116,11,127,"---FILE: NEWS.md---
@@ -1,5 +1,10 @@
 # roxygen2 6.0.1.9000
 
+* New tag `@evalNamespace` does for `NAMESPACE` what `@evalRd` does for Rd
+  files: you give it R code that produces a literal entry in `NAMESPACE` when
+  run. This should make it easier to export functions that are generated by
+  other functions in your package (#531, @egnha).
+
 * Markdown code as link text is now properly rendered as code (#620, @egnha).
 
 # roxygen2 6.0.1

---FILE: R/namespace.R---
@@ -1,6 +1,6 @@
-ns_tags <- c('export', 'exportClass', 'exportMethod', 'exportPattern',
-  'rawNamespace', 'S3method', 'import', 'importFrom', 'importClassesFrom',
-  'importMethodsFrom', 'useDynLib')
+ns_tags <- c('evalNamespace', 'export', 'exportClass', 'exportMethod',
+  'exportPattern', 'rawNamespace', 'S3method', 'import', 'importFrom',
+  'importClassesFrom', 'importMethodsFrom', 'useDynLib')
 
 #' Roclet: make NAMESPACE.
 #'
@@ -11,22 +11,25 @@ ns_tags <- c('export', 'exportClass', 'exportMethod', 'exportPattern',
 #' @family roclets
 #' @export
 #' @seealso `vignette(""namespace"", package = ""roxygen2"")`
-#' @aliases export exportClass exportMethod S3method import importFrom
-#'   importClassesFrom importMethodsFrom rawNamespace useDynLib
+#' @aliases export exportClass exportMethod exportPattern
+#'   import importFrom importClassesFrom importMethodsFrom
+#'   evalNamespace rawNamespace S3method useDynLib
 namespace_roclet <- function() {
   roclet(""namespace"")
 }
 
 #' @export
 roclet_process.roclet_namespace <- function(x, parsed, base_path,
                                             global_options = list()) {
-  ns <- unlist(lapply(parsed$blocks, block_to_ns)) %||% character()
+  ns <- unlist(lapply(parsed$blocks, block_to_ns, env = parsed$env)) %||%
+    character()
   sort_c(unique(ns))
 }
 
 #' @export
 roclet_tags.roclet_namespace <- function(x) {
   list(
+    evalNamespace = tag_code,
     export = tag_words_line,
     exportClass = tag_words(1),
     exportMethod = tag_words(1),
@@ -41,13 +44,17 @@ roclet_tags.roclet_namespace <- function(x) {
   )
 }
 
-block_to_ns <- function(block) {
+block_to_ns <- function(block, env) {
   tags <- intersect(names(block), ns_tags)
-  lapply(tags, ns_process_tag, block = block)
+  lapply(tags, ns_process_tag, block = block, env = env)
 }
 
-ns_process_tag <- function(tag_name, block) {
-  f <- get(paste0(""ns_"", tag_name), mode = ""function"")
+ns_process_tag <- function(tag_name, block, env) {
+  f <- if (tag_name == ""evalNamespace"") {
+    function(tag, block) ns_evalNamespace(tag, block, env)
+  } else {
+    get(paste0(""ns_"", tag_name), mode = ""function"")
+  }
   tags <- block[names(block) == tag_name]
 
   lapply(tags, f, block = block)
@@ -123,7 +130,21 @@ ns_useDynLib         <- function(tag, block) {
     repeat_first(""useDynLib"", tag)
   }
 }
-ns_rawNamespace       <- function(tag, block) tag
+ns_rawNamespace  <- function(tag, block) tag
+ns_evalNamespace <- function(tag, block, env) {
+  tryCatch({
+    expr <- parse(text = tag)
+    out <- eval(expr, envir = env)
+
+    if (!is.character(out) || length(out) != 1L || is.na(out)) {
+      stop(""code didn't return a string: "", out, call. = FALSE)
+    }
+
+    out
+  }, error = function(e) {
+    block_warning(block, ""@evalNamespace failed with error: "", e$message)
+  })
+}
 
 # Functions used by both default_export and ns_* functions
 export           <- function(x) one_per_line(""export"", x)

---FILE: man/namespace_roclet.Rd---
@@ -2,6 +2,7 @@
 % Please edit documentation in R/namespace.R
 \name{namespace_roclet}
 \alias{namespace_roclet}
+\alias{evalNamespace}
 \alias{export}
 \alias{exportClass}
 \alias{exportMethod}

---FILE: tests/testthat/test-namespace.R---
@@ -212,3 +212,81 @@ test_that(""rawNamespace inserted unchanged"", {
   expect_equal(out, ""xyz\n  abc"")
 })
 
+
+# @evalNamespace ----------------------------------------------------------
+
+test_that(""evalNamespace generates warning when code is invalid"", {
+  expect_warning(
+    roc_proc_text(namespace_roclet(), ""
+      #' @evalNamespace a +
+      #' @name a
+      #' @title a
+      NULL""),
+    ""code failed to parse""  # Message generated by tag_code
+  )
+})
+
+test_that(""evalNamespace generates warning when code raises error"", {
+  expect_warning(
+    roc_proc_text(namespace_roclet(), ""
+      #' @evalNamespace stop('!')
+      #' @name a
+      #' @title a
+      NULL""),
+    ""@evalNamespace failed with error""  # Message generated by ns_evalNamespace
+  )
+})
+
+test_that(""evalNamespace generates warning when code doesn't eval to string"", {
+  # Not character
+  expect_warning(
+    roc_proc_text(namespace_roclet(), ""
+      z <- 10
+      #' @evalNamespace z * 2
+      #' @name a
+      #' @title a
+      NULL""),
+    ""code didn't return a string""  # Message generated by ns_evalNamespace
+  )
+
+  # Not scalar
+  expect_warning(
+    roc_proc_text(namespace_roclet(), ""
+      nms <- letters[1:3]
+      #' @evalNamespace paste('export(', nms, ')', sep = ',')
+      #' @name a
+      #' @title a
+      NULL""),
+    ""code didn't return a string""
+  )
+
+  # NA_character_ not allowed
+  expect_warning(
+    roc_proc_text(namespace_roclet(), ""
+      nms <- NA_character_
+      #' @evalNamespace nms
+      #' @name a
+      #' @title a
+      NULL""),
+    ""code didn't return a string""
+  )
+})
+
+test_that(""evalNamespace code is inserted when its value is a string"", {
+  out1 <- roc_proc_text(namespace_roclet(), ""
+    nms <- paste(letters[1:3], collapse = ',')
+    #' @evalNamespace sprintf('export(%s)', nms)
+    #' @name a
+    #' @title a
+    NULL"")
+  out2 <- roc_proc_text(namespace_roclet(), ""
+    nms <- paste(letters[1:3], collapse = ',')
+    #' @evalNamespace sprintf('export(%s)',
+    #'                        nms)
+    #' @name a
+    #' @title a
+    NULL"")
+
+  expect_equal(out1, ""export(a,b,c)"")
+  expect_equal(out2, ""export(a,b,c)"")
+})"
r-lib,roxygen2,e2ed231a17644fb85b73a1d31bb1c84cb3bb7893,brodieG,brodieG@users.noreply.github.com,2017-08-16T16:30:49Z,Hadley Wickham,h.wickham@gmail.com,2017-08-16T16:30:49Z,"Fix minor typo (#637)

currupted -> corrupted",vignettes/markdown.Rmd,True,False,True,False,1,1,2,"---FILE: vignettes/markdown.Rmd---
@@ -188,7 +188,7 @@ When mixing `Rd` and markdown notation, most `Rd` tags may contain markdown mark
 
 ## Mixing markdown and `Rd` markup
 
-Note that turning on markdown does *not* turn off the standard `Rd` syntax. We suggest that you use the regular `Rd` tags in a markdown roxygen chunk only if necessary. The two parsers do occasionally interact, and the markdown parser can pick up and reformat Rd syntax, causing an error, or currupted manuals.
+Note that turning on markdown does *not* turn off the standard `Rd` syntax. We suggest that you use the regular `Rd` tags in a markdown roxygen chunk only if necessary. The two parsers do occasionally interact, and the markdown parser can pick up and reformat Rd syntax, causing an error, or corrupted manuals.
 
 ## Leading whitespace
 "
r-lib,roxygen2,35050aeded0609c1e9b5583869add272843474dc,Eugene Ha,eha@posteo.de,2017-08-16T16:26:58Z,Hadley Wickham,h.wickham@gmail.com,2017-08-16T16:26:58Z,"Bug fix: render Markdown-code link text as code (#620) (#622)

* Add closing } for code in MD link text (#620)

* Add fix #620 to dummy-page test

* Test that MD code as link text is rendered as code

* Entry for bug fix #620

* Subheading removed",NEWS.md;R/markdown.R;man/markdown-test.Rd;tests/testthat/test-rd-markdown-links.R,False,True,True,False,39,10,49,"---FILE: NEWS.md---
@@ -1,5 +1,7 @@
 # roxygen2 6.0.1.9000
 
+* Markdown code as link text is now properly rendered as code (#620, @egnha).
+
 # roxygen2 6.0.1
 
 * Allowing empty lines in .Rbuildignore. Previously, empty lines caused all 

---FILE: R/markdown.R---
@@ -325,7 +325,7 @@ parse_link <- function(destination, contents) {
       if (!is.na(pkg)) paste0(pkg, ""::""),
       if (s4) noclass else fun,
       ""}"",
-      if (is_code) ""}""
+      if (is_code) ""}"" else """"
     )
 
   } else {
@@ -338,7 +338,8 @@ parse_link <- function(destination, contents) {
         ""]{""
       ),
       contents,
-      ""}""
+      ""}"",
+      if (is_code) ""}"" else """"
     )
   }
 }
@@ -365,8 +366,8 @@ is_empty_xml <- function(x) {
 #' Link to another package, function: [devtools::document()].
 #' Link to another package, non-function: [devtools::document].
 #'
-#' Link with link text:  [this great function][roxygenize()] or
-#' [that great function][roxygenize].
+#' Link with link text: [this great function][roxygenize()],
+#' [`roxygenize`][roxygenize()], or [that great function][roxygenize].
 #'
 #' In another package: [and this one][devtools::document].
 #'

---FILE: man/markdown-test.Rd---
@@ -12,8 +12,8 @@ Link to an object: \link{roxygenize} (we just treat it like an object here.
 Link to another package, function: \code{\link[devtools:document]{devtools::document()}}.
 Link to another package, non-function: \link[devtools:document]{devtools::document}.
 
-Link with link text:  \link[=roxygenize]{this great function} or
-\link[=roxygenize]{that great function}.
+Link with link text: \link[=roxygenize]{this great function},
+\code{\link[=roxygenize]{roxygenize}}, or \link[=roxygenize]{that great function}.
 
 In another package: \link[devtools:document]{and this one}.
 }

---FILE: tests/testthat/test-rd-markdown-links.R---
@@ -169,8 +169,8 @@ test_that(""a weird markdown link bug is fixed"", {
     #' Link to another package, function: [devtools::document()].
     #' Link to another package, non-function: [devtools::document].
     #'
-    #' Link with link text:  [this great function][roxygenize()] or
-    #' [that great function][roxygenize].
+    #' Link with link text: [this great function][roxygenize()],
+    #' [`roxygenize`][roxygenize()], or [that great function][roxygenize].
     #'
     #' In another package: [and this one][devtools::document].
     #'
@@ -188,8 +188,8 @@ test_that(""a weird markdown link bug is fixed"", {
     #' Link to another package, function: \\code{\\link[devtools:document]{devtools::document()}}.
     #' Link to another package, non-function: \\link[devtools:document]{devtools::document}.
     #'
-    #' Link with link text:  \\link[=roxygenize]{this great function} or
-    #' \\link[=roxygenize]{that great function}.
+    #' Link with link text: \\link[=roxygenize]{this great function},
+    #' \\code{\\link[=roxygenize]{roxygenize}}, or \\link[=roxygenize]{that great function}.
     #'
     #' In another package: \\link[devtools:document]{and this one}.
     #'
@@ -219,6 +219,32 @@ test_that(""another markdown link bug is fixed"", {
   expect_equivalent_rd(out1, out2)
 })
 
+test_that(""markdown code as link text is rendered as code"", {
+
+  out1 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Description, see [`name`][dest],
+    #' [`function`][function()],
+    #' [`filter`][stats::filter()],
+    #' [`bar`][pkg::bar],
+    #' [`terms`][terms.object],
+    #' [`abc`][abc-class].
+    #' @md
+    foo <- function() {}"")[[1]]
+  out2 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Description, see \\code{\\link[=dest]{name}},
+    #' \\code{\\link[=function]{function}},
+    #' \\code{\\link[stats:filter]{filter}},
+    #' \\code{\\link[pkg:bar]{bar}},
+    #' \\code{\\link[=terms.object]{terms}},
+    #' \\code{\\link[=abc-class]{abc}}.
+    foo <- function() {}"")[[1]]
+  expect_equivalent_rd(out1, out2)
+})
+
 test_that(""non-code link in backticks works"", {
 
   out1 <- roc_proc_text(roc, """
r-lib,roxygen2,befd63e4180d8bc1f41cde4da193006262730b26,hadley,h.wickham@gmail.com,2017-08-16T14:54:39Z,hadley,h.wickham@gmail.com,2017-08-16T14:59:15Z,"Update travis & codecov standards

Fixes #582",.travis.yml;DESCRIPTION;codecov.yml,False,False,False,False,20,5,25,"---FILE: .travis.yml---
@@ -1,11 +1,15 @@
-language: r
+# R for travis: see documentation at https://docs.travis-ci.com/user/languages/r
+
+language: R
 sudo: false
 cache: packages
 
 r:
- - oldrel
- - release
- - devel
+- 3.1
+- 3.2
+- oldrel
+- release
+- devel
 
 after_success:
   - Rscript -e 'covr::codecov()'

---FILE: DESCRIPTION---
@@ -15,7 +15,7 @@ License: GPL (>= 2)
 URL: https://github.com/klutometis/roxygen
 BugReports: https://github.com/klutometis/roxygen/issues
 Depends: 
-    R (>= 3.0.2)
+    R (>= 3.1)
 Imports: 
     brew,
     commonmark,

---FILE: codecov.yml---
@@ -1 +1,12 @@
 comment: false
+
+coverage:
+  status:
+    project:
+      default:
+        target: auto
+        threshold: 10%
+    patch:
+      default:
+        target: auto
+        threshold: 10%"
r-lib,roxygen2,eebaa9cc2a9ed9552533f814ed8c0002288b7674,ximeg,ximeg@users.noreply.github.com,2017-05-03T13:38:01Z,Hadley Wickham,h.wickham@gmail.com,2017-05-03T13:38:01Z,"Fixed type: ""roxyen2"" -> ""roxygen2"" (#619)",vignettes/rd.Rmd,True,False,True,False,1,1,2,"---FILE: vignettes/rd.Rmd---
@@ -243,7 +243,7 @@ Older versions of roxygen required explicit `@method generic class` tags for all
 
 ### S4
 
-Older versions of roxyen2 required explicit `@usage`, `@alias` and `@docType` to correctly document S4 objects, but from version 3.0.0 on roxygen2 generates correct metadata automatically. If you're upgrading from a previous version, make sure to remove these old tags.
+Older versions of roxygen2 required explicit `@usage`, `@alias` and `@docType` to correctly document S4 objects, but from version 3.0.0 on roxygen2 generates correct metadata automatically. If you're upgrading from a previous version, make sure to remove these old tags.
 
 S4 __generics__ are also functions, so document them as such. Document __S4 classes__ by adding a roxygen block before `setClass()`. Use `@slot` to document the slots of the class. Here's a simple example:
 "
r-lib,roxygen2,e37ebfc498ff97173788bbb84097bb12f0b1c7b8,Sebastian Meyer,seb.meyer@fau.de,2017-02-02T13:23:12Z,Hadley Wickham,h.wickham@gmail.com,2017-02-02T13:23:12Z,"Fix typo (#573)

Complementing 1dff87fba52419eb857a4d8f20636167ac3c24fe",NEWS.md,False,False,False,False,1,1,2,"---FILE: NEWS.md---
@@ -19,7 +19,7 @@
 
 ## Improved inheritance
 
-* New `@inheritDocParams` allows you to automatically generate parameter 
+* New `@inheritDotParams` allows you to automatically generate parameter 
   documentation for `...` for the common case where you pass `...` on to 
   another function (#512). Because you often override some arguments, it 
   comes with a flexible specification for argument selection:"
r-lib,roxygen2,c70dec5dec55628fc7f5788a0c59ba07b9d933c1,Jakob Richter,code@jakob-r.de,2017-02-02T00:01:03Z,Hadley Wickham,h.wickham@gmail.com,2017-02-02T00:01:03Z,".Rbuildignore can contain empty lines (#570)

Fixes #572",NEWS.md;R/utils.R;tests/testthat/test-Rbuildignore.R,False,True,True,False,12,0,12,"---FILE: NEWS.md---
@@ -3,6 +3,9 @@
 * Automatically generating a usage section for an infix function containing ""<-""
   no longer removes ""<-"" from the function name (#554).
 
+* Allowing empty lines in .Rbuildignore. Previously, empty lines caused all 
+  files to be ignored. (#572, @jakob-r)
+
 # roxygen2 6.0.0
 
 ## Markdown

---FILE: R/utils.R---
@@ -114,6 +114,7 @@ ignore_files <- function(rfiles, path) {
 
   # Remove any files that match any perl-compatible regexp
   patterns <- readLines(rbuildignore, warn = FALSE)
+  patterns <- patterns[patterns != """"]
   matches <- lapply(patterns, grepl, rfiles_relative, perl = TRUE)
   matches <- Reduce(""|"", matches)
   rfiles[!matches]

---FILE: tests/testthat/test-Rbuildignore.R---
@@ -10,3 +10,11 @@ test_that(""roxygen ignores files with matching pattern in .Rbuildignore"", {
   writeChar(""^R/ignore_me.R$\n"", file.path(test_pkg, "".Rbuildignore""), eos = NULL)
   expect_equal(basename(package_files(test_pkg)), ""a.R"")
 })
+
+test_that(""roxygen works with empty lines in .Rbuildignore"", {
+  test_pkg <- temp_copy_pkg(test_path(""testRbuildignore""))
+  on.exit(unlink(test_pkg, recursive = TRUE))
+
+  writeChar(""^R/ignore_me.R$\n\n.nonexistentfile"", file.path(test_pkg, "".Rbuildignore""), eos = NULL)
+  expect_equal(basename(package_files(test_pkg)), ""a.R"")
+})"
r-lib,roxygen2,5f8ee8aeaa3b41b5036103b7003eb022201aa1c2,hadley,h.wickham@gmail.com,2017-01-31T16:51:12Z,hadley,h.wickham@gmail.com,2017-01-31T16:51:12Z,Bump version and fix news,DESCRIPTION;NEWS.md,False,False,False,False,6,4,10,"---FILE: DESCRIPTION---
@@ -4,7 +4,7 @@ Description: Generate your Rd documentation, 'NAMESPACE' file, and collation
     field using specially formatted comments. Writing documentation in-line
     with code makes it easier to keep your documentation up-to-date as your
     requirements change. 'Roxygen2' is inspired by the 'Doxygen' system for C++.
-Version: 6.0.0
+Version: 6.0.0.9000
 License: GPL (>= 2)
 Authors@R: c(
     person(""Hadley"", ""Wickham"",, ""hadley@rstudio.com"", c(""aut"", ""cre"", ""cph"")),

---FILE: NEWS.md---
@@ -1,3 +1,8 @@
+# roxygen2 6.0.0.9000
+
+* Automatically generating a usage section for an infix function containing ""<-""
+  no longer removes ""<-"" from the function name (#554).
+
 # roxygen2 6.0.0
 
 ## Markdown
@@ -106,9 +111,6 @@
 * Roxygen now parses nonASCII documentation correctly (as long as UTF-8 
   encoded or specified Encoding in DESCRIPTION) (#532, @shrektan),
   and ignores files listed in `.Rbuildignore` (#446, @fmichonneau).
-  
-* Automatically generating a usage section for an infix function containing ""<-""
-  no longer removes ""<-"" from the function name (#554).
 
 ## Extending roxygen2
 "
r-lib,roxygen2,857547e342c81adbfc16ecc0b9d0fa17b9cf2626,hadley,h.wickham@gmail.com,2017-01-30T17:13:52Z,hadley,h.wickham@gmail.com,2017-01-30T17:13:52Z,CRAN check fixes,DESCRIPTION;README.md,False,False,False,False,2,2,4,"---FILE: DESCRIPTION---
@@ -3,7 +3,7 @@ Title: In-Line Documentation for R
 Description: Generate your Rd documentation, 'NAMESPACE' file, and collation 
     field using specially formatted comments. Writing documentation in-line
     with code makes it easier to keep your documentation up-to-date as your
-    requirements change. Roxygen2 is inspired by the 'Doxygen' system for C++.
+    requirements change. 'Roxygen2' is inspired by the 'Doxygen' system for C++.
 Version: 5.0.1.9000
 License: GPL (>= 2)
 Authors@R: c(

---FILE: README.md---
@@ -2,7 +2,7 @@
 
 [![Build Status](https://travis-ci.org/klutometis/roxygen.png)](https://travis-ci.org/klutometis/roxygen)
 [![AppVeyor Build Status](https://ci.appveyor.com/api/projects/status/github/klutometis/roxygen?branch=master&svg=true)](https://ci.appveyor.com/project/klutometis/roxygen)
-[![CRAN_Status_Badge](http://www.r-pkg.org/badges/version/roxygen2)](http://cran.r-project.org/package=roxygen2)
+[![CRAN_Status_Badge](http://www.r-pkg.org/badges/version/roxygen2)](https://cran.r-project.org/package=roxygen2)
 [![Coverage Status](https://img.shields.io/codecov/c/github/klutometis/roxygen/master.svg)](https://codecov.io/github/klutometis/roxygen?branch=master)
 
 > all' hileth', Hephaiste; didou d'areten te kai olbon.*"
r-lib,roxygen2,6c26d86ecedc7906da556f67d87812efb6a52443,Nate Teetor,nathanteetor@gmail.com,2017-01-30T17:10:45Z,Hadley Wickham,h.wickham@gmail.com,2017-01-30T17:10:45Z,"fixed usage section for infix functions containing <- (#569)

* fixed usage for infix with <-; fixes #554

* added NEWS bullet for #554",NEWS.md;R/object-usage.R;tests/testthat/test-rd-usage.R,False,True,True,False,12,1,13,"---FILE: NEWS.md---
@@ -106,6 +106,9 @@
 * Roxygen now parses nonASCII documentation correctly (as long as UTF-8 
   encoded or specified Encoding in DESCRIPTION) (#532, @shrektan),
   and ignores files listed in `.Rbuildignore` (#446, @fmichonneau).
+  
+* Automatically generating a usage section for an infix function containing ""<-""
+  no longer removes ""<-"" from the function name (#554).
 
 ## Extending roxygen2
 

---FILE: R/object-usage.R---
@@ -50,7 +50,7 @@ object_usage.rcclass <- function(x) NULL
 
 function_usage <- function(name, formals, format_name = identity) {
   arglist <- args_string(usage_args(formals))
-  if (is_replacement_fun(name)) {
+  if (is_replacement_fun(name) && !is_infix_fun(name)) {
     name <- str_replace(name, fixed(""<-""), """")
     formals$value <- NULL
 

---FILE: tests/testthat/test-rd-usage.R---
@@ -33,6 +33,14 @@ test_that(""default usage correct for infix functions"", {
   expect_equal(get_tag(out, ""usage"")$values, rd(""a \\%.\\% b""))
 })
 
+test_that(""default usage correct of infix functions containing \""<-\"""", {
+  out <- roc_proc_text(rd_roclet(), ""
+    #' Infix fun containing <-
+    '%<-%' <- function(a, b) 1"")[[1]]
+
+  expect_equal(get_tag(out, ""usage"")$values, rd(""a \\%<-\\% b""))
+})
+
 test_that(""default usage correct for S3 methods"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' Regular"
r-lib,roxygen2,c1a1e2520daec3bc1cf39559169ae0ed344f11c5,Kirill M칲ller,krlmlr@users.noreply.github.com,2017-01-25T17:44:30Z,Hadley Wickham,h.wickham@gmail.com,2017-01-25T17:44:30Z,"Fix Windows problems (#565)

* fix Windows tests

* use \r\n only on Windows

* avoid using devtools::document()

* don't warn

* use read_lines_enc()

* use AppVeyor

* refine test

* oops

* add comment",.Rbuildignore;R/enc.R;R/parse.R;R/source.R;R/utils.R;appveyor.yml;src/parser2.cpp;tests/testthat/test-Rbuildignore.R;tests/testthat/test-nonASCII.R,False,True,True,False,80,17,97,"---FILE: .Rbuildignore---
@@ -8,3 +8,4 @@
 ^roxygen.pro.user$
 ^revdep$
 ^codecov\.yml$
+^appveyor\.yml$

---FILE: R/enc.R---
@@ -0,0 +1,8 @@
+read_lines_enc <- function(path, file_encoding = ""UTF-8"", n = -1L, ok = TRUE, skipNul = FALSE) {
+  con <- file(path, encoding = file_encoding)
+  on.exit(close(con), add = TRUE)
+
+  lines <- readLines(con, warn = FALSE, n = n, ok = ok, skipNul = skipNul)
+  Encoding(lines) <- ""UTF-8""
+  lines
+}

---FILE: R/parse.R---
@@ -27,9 +27,8 @@ parse_text <- function(text, registry = default_tags(), global_options = list())
 
 parse_blocks <- function(file, env, registry, global_options = list(), fileEncoding = ""UTF-8"") {
 
-  con <- file(file, encoding = fileEncoding)
-  on.exit(close(con), add = TRUE)
-  parsed <- parse(con, keep.source = TRUE, srcfile = srcfile(file, encoding = fileEncoding))
+  lines <- read_lines_enc(file, file_encoding = fileEncoding)
+  parsed <- parse(text = lines, keep.source = TRUE, srcfile = srcfilecopy(file, lines, isFile = TRUE))
   if (length(parsed) == 0) return()
 
   refs <- utils::getSrcref(parsed)

---FILE: R/source.R---
@@ -29,7 +29,11 @@ source_package <- function(path) {
 }
 
 sys_source <- function(file, envir = baseenv(), fileEncoding = ""UTF-8"") {
-  source(file, encoding = fileEncoding, keep.source = FALSE, local = envir)
+  exprs <- parse(text = read_lines_enc(file, file_encoding = fileEncoding))
+  for (expr in exprs) {
+    eval(expr, envir = envir)
+  }
+  invisible()
 }
 
 # Assume that the package has already been loaded by other means

---FILE: R/utils.R---
@@ -80,9 +80,7 @@ write_if_different <- function(path, contents, check = TRUE) {
     FALSE
   } else {
     cat(sprintf('Writing %s\n', name))
-    con <- file(path, encoding = ""UTF-8"")
-    on.exit(close(con), add = TRUE)
-    writeLines(contents, con)
+    writeLines(contents, path, useBytes = TRUE)
     TRUE
   }
 }
@@ -91,6 +89,9 @@ same_contents <- function(path, contents) {
   if (!file.exists(path)) return(FALSE)
 
   contents <- paste0(paste0(contents, collapse = ""\n""), ""\n"")
+  if (.Platform$OS.type == ""windows"") {
+    contents <- gsub(""\n"", ""\r\n"", contents, fixed = TRUE)
+  }
 
   text_hash <- digest::digest(contents, serialize = FALSE)
   file_hash <- digest::digest(file = path)
@@ -108,7 +109,7 @@ ignore_files <- function(rfiles, path) {
     return(rfiles)
 
   # Strip leading directory and slashes
-  rfiles_relative <- sub(normalizePath(path), """", normalizePath(rfiles), fixed = TRUE)
+  rfiles_relative <- sub(normalizePath(path, winslash = ""/""), """", normalizePath(rfiles, winslash = ""/""), fixed = TRUE)
   rfiles_relative <- sub(""^[/]*"", """", rfiles_relative)
 
   # Remove any files that match any perl-compatible regexp

---FILE: appveyor.yml---
@@ -0,0 +1,45 @@
+# DO NOT CHANGE the ""init"" and ""install"" sections below
+
+# Download script file from GitHub
+init:
+  ps: |
+        $ErrorActionPreference = ""Stop""
+        Invoke-WebRequest http://raw.github.com/krlmlr/r-appveyor/master/scripts/appveyor-tool.ps1 -OutFile ""..\appveyor-tool.ps1""
+        Import-Module '..\appveyor-tool.ps1'
+
+install:
+  ps: Bootstrap
+
+cache:
+  - C:\RLibrary
+
+# Adapt as necessary starting from here
+
+build_script:
+  - travis-tool.sh install_deps
+
+test_script:
+  - travis-tool.sh run_tests
+
+on_failure:
+  - 7z a failure.zip *.Rcheck\*
+  - appveyor PushArtifact failure.zip
+
+artifacts:
+  - path: '*.Rcheck\**\*.log'
+    name: Logs
+
+  - path: '*.Rcheck\**\*.out'
+    name: Logs
+
+  - path: '*.Rcheck\**\*.fail'
+    name: Logs
+
+  - path: '*.Rcheck\**\*.Rout'
+    name: Logs
+
+  - path: '\*_*.tar.gz'
+    name: Bits
+
+  - path: '\*_*.zip'
+    name: Bits

---FILE: src/parser2.cpp---
@@ -149,7 +149,8 @@ List tokenise_block(CharacterVector lines, std::string file = """",
       _[""file""] = file,
       _[""line""] = rows[i] + 1,
       _[""tag""] = tags[i],
-      _[""val""] = stripTrailingNewline(vals[i])
+      // Rcpp::String() necessary to tag string as UTF-8
+      _[""val""] = Rcpp::String(stripTrailingNewline(vals[i]))
     );
     out[i].attr(""class"") = ""roxy_tag"";
   }

---FILE: tests/testthat/test-Rbuildignore.R---
@@ -1,11 +1,12 @@
 context(""Rbuildignore"")
 
 test_that(""roxygen ignores files with matching pattern in .Rbuildignore"", {
-    test_pkg <- temp_copy_pkg(test_path(""testRbuildignore""))
-    on.exit(unlink(test_pkg, recursive = TRUE))
+  test_pkg <- temp_copy_pkg(test_path(""testRbuildignore""))
+  on.exit(unlink(test_pkg, recursive = TRUE))
 
-    expect_equal(basename(package_files(test_pkg)), c(""a.R"", ""ignore_me.R""))
+  expect_equal(basename(package_files(test_pkg)), c(""a.R"", ""ignore_me.R""))
 
-    writeLines(""^R/ignore_me.R$"", file.path(test_pkg, "".Rbuildignore""))
-    expect_equal(basename(package_files(test_pkg)), ""a.R"")
+  #writeLines(""^R/ignore_me.R$"", file.path(test_pkg, "".Rbuildignore""))
+  writeChar(""^R/ignore_me.R$\n"", file.path(test_pkg, "".Rbuildignore""), eos = NULL)
+  expect_equal(basename(package_files(test_pkg)), ""a.R"")
 })

---FILE: tests/testthat/test-nonASCII.R---
@@ -2,15 +2,18 @@ context(""nonASCII"")
 
 test_that(""can generate nonASCII document"", {
   test_pkg <- temp_copy_pkg('testNonASCII')
-  on.exit(unlink(test_pkg, recursive = TRUE))
+  on.exit(unlink(test_pkg, recursive = TRUE), add = TRUE)
 
-  expect_output(roxygenize(test_pkg), ""printChineseMsg[.]Rd"")
+  expect_output(roxygenise(test_pkg, roclets = ""rd""), ""printChineseMsg[.]Rd"")
   expect_true(file.exists(file.path(test_pkg, ""man"", ""printChineseMsg.Rd"")))
 
-  cnChar <- readLines(file.path(test_pkg, ""man"", ""printChineseMsg.Rd""), encoding = ""UTF-8"")
+  cnChar <- read_lines_enc(file.path(test_pkg, ""man"", ""printChineseMsg.Rd""))
 
   # Because the parse in testthat::test don't specify encoding to UTF-8 as well,
   # so we have to use unicode escapes.
   expect_true(any(grepl(""\u6211\u7231\u4e2d\u6587"", cnChar)))
   expect_true(any(grepl(""\u4e2d\u6587\u6ce8\u91ca"", cnChar)))
+
+  # No output on second run
+  expect_output(roxygenise(test_pkg, roclets = ""rd""), NA)
 })"
r-lib,roxygen2,2bd1b79c30b7b972e621771ed482b52fc1b517be,yutannihilation,yutani.ini@gmail.com,2017-01-18T14:53:23Z,Hadley Wickham,h.wickham@gmail.com,2017-01-18T14:53:23Z,fix a typo (#563),vignettes/rd.Rmd,True,False,True,False,1,1,2,"---FILE: vignettes/rd.Rmd---
@@ -345,7 +345,7 @@ Some notes:
 
 * Like for datasets, there isn't a object that we can document directly. Use
   `""_PACKAGE""` to indicate that you are creating the package's documentation.
-  This will automatically add the corect aliases so that both `?pkgname`
+  This will automatically add the correct aliases so that both `?pkgname`
   and `package?pkgname` will find the package help. This also works if there's
   already a function called `pkgname()`.
 "
r-lib,roxygen2,d3dccc77d6c3a4a08836d69c759f7812f5b4a59c,hadley,h.wickham@gmail.com,2017-01-06T16:26:38Z,hadley,h.wickham@gmail.com,2017-01-06T16:26:49Z,"Strip windows slashes too

Fixes #556",R/utils.R,False,True,True,False,2,2,4,"---FILE: R/utils.R---
@@ -107,9 +107,9 @@ ignore_files <- function(rfiles, path) {
   if (!file.exists(rbuildignore))
     return(rfiles)
 
-  # Strip leading directory and /
+  # Strip leading directory and slashes
   rfiles <- sub(normalizePath(path), """", normalizePath(rfiles), fixed = TRUE)
-  rfiles <- sub(""^/*"", """", rfiles)
+  rfiles <- sub(""^[/\\]*"", """", rfiles)
 
   # Remove any files that match any perl-compatible regexp
   patterns <- readLines(rbuildignore, warn = FALSE)"
r-lib,roxygen2,4437a704dd9b30669e78bfdb4a8b5c3511c53592,Francois Michonneau,francois.michonneau@gmail.com,2016-01-30T21:32:25Z,hadley,h.wickham@gmail.com,2016-12-29T23:25:58Z,"Ignore files listed in .Rbuildignore

Fixes #446. Closes #451",NEWS.md;R/source.R;R/utils.R;tests/testthat/test-Rbuildignore.R;tests/testthat/testRbuildignore/DESCRIPTION;tests/testthat/testRbuildignore/R/a.R;tests/testthat/testRbuildignore/R/ignore_me.R,False,True,True,False,57,2,59,"---FILE: NEWS.md---
@@ -99,6 +99,8 @@
   (as long as UTF-8 encoded or specified Encoding in DESCRIPTION)
   (#532, @shrektan).
 
+* Roxygen ignore files that are listed in `.Rbuildignore` (#446, @fmichonneau)
+
 ## Extension
 
 * Deprecated `register.preref.parser()` and `register.preref.parsers()`

---FILE: R/source.R---
@@ -60,12 +60,14 @@ package_files <- function(path) {
   desc <- read_pkg_description(path)
 
   all <- normalizePath(r_files(path))
+
   collate <- scan(text = desc$Collate %||% """", what = """", sep = "" "",
     quiet = TRUE)
 
   collate <- normalizePath(file.path(path, 'R', collate))
 
-  c(collate, setdiff(all, collate))
+  rfiles <- c(collate, setdiff(all, collate))
+  ignore_files(rfiles, path)
 }
 
 read_pkg_description <- function(path) {
@@ -74,4 +76,3 @@ read_pkg_description <- function(path) {
 
   read.description(desc_path)
 }
-

---FILE: R/utils.R---
@@ -102,6 +102,30 @@ r_files <- function(path) {
   sort_c(dir(file.path(path, ""R""), ""[.Rr]$"", full.names = TRUE))
 }
 
+ignore_files <- function(rfiles, path) {
+    rbuildignore <- file.path(path, "".Rbuildignore"")
+    if (!file.exists(rbuildignore))
+        return(rfiles)
+
+    rbuildignore_patterns <- readLines(rbuildignore, warn = FALSE)
+    ## We need to apply the regular expressions from .Rbuildignore
+    ## on the top-level directory, so we need to remove everything
+    ## leading up to the path. `normalizePath` ensures that the
+    ## path is properly expanded.
+    relative_rfiles <- sub(normalizePath(path), """", normalizePath(rfiles))
+    ## If user adds trailing / when specifying path, we need to remove it.
+    relative_rfiles <- sub(paste0(""^("", .Platform$file.sep, ""|/)*""), """",
+                           relative_rfiles)
+    ## Figure out if any of the regular expressions matches files
+    ## in R/ Use perl=TRUE as R-exts manual says that patterns
+    ## should be perl-like regular expressions
+    idx_rfiles_to_ignore <- lapply(rbuildignore_patterns,
+                                   grepl, relative_rfiles, perl = TRUE)
+    idx_rfiles_to_ignore <- Reduce(""|"", idx_rfiles_to_ignore)
+    rfiles[!idx_rfiles_to_ignore]
+}
+
+
 compact <- function(x) {
   null <- vapply(x, is.null, logical(1))
   x[!null]

---FILE: tests/testthat/test-Rbuildignore.R---
@@ -0,0 +1,15 @@
+context(""Rbuildignore"")
+
+test_that(""roxygen ignores files with matching pattern in .Rbuildignore"", {
+    test_pkg <- temp_copy_pkg(""testRbuildignore"")
+    on.exit(unlink(test_pkg, recursive = TRUE))
+
+    no_rbuildignore_file <- package_files(test_pkg)
+
+    writeLines(""^R/ignore_me.R$"", file.path(test_pkg, "".Rbuildignore""))
+    with_rbuildignore_file <- package_files(test_pkg)
+
+    expect_equal(basename(no_rbuildignore_file), c(""a.R"", ""ignore_me.R""))
+    expect_equal(basename(with_rbuildignore_file), ""a.R"")
+
+})

---FILE: tests/testthat/testRbuildignore/DESCRIPTION---
@@ -0,0 +1,7 @@
+Package: testRbuildignore
+Title: Tools to make developing R code easier
+License: GPL-2
+Description:
+Author: Francois <francois.michonneau@gmail.com>
+Maintainer: Francois <francois.michonneau@gmail.com>
+Version: 0.1

---FILE: tests/testthat/testRbuildignore/R/a.R---
@@ -0,0 +1,3 @@
+#' function a
+#'
+a <- 1

---FILE: tests/testthat/testRbuildignore/R/ignore_me.R---
@@ -0,0 +1,3 @@
+#' Ignore me, I'm not ready
+#'
+ignore_me <- ""ignore me"""
r-lib,roxygen2,ffc59696ab94e295ceb09cc208f71d86e3271729,Maximilian Held,info@maxheld.de,2016-12-15T04:22:26Z,Hadley Wickham,h.wickham@gmail.com,2016-12-15T04:22:26Z,fix small typo (#541),vignettes/rd.Rmd,True,False,True,False,1,1,2,"---FILE: vignettes/rd.Rmd---
@@ -117,7 +117,7 @@ There are two tags that make it easier for people to navigate around your docume
 
 `@seealso` allows you to point to other useful resources, either on the web `\url{http://www.r-project.org}`, or to other documentation with `\code{\link{functioname}}`. 
 
-If you have a family of related functions, you can use the `@family <family>` tag to automatically add appropriate lists and interlinks to the `@seealso` section. Because it will appear as ""Other <family>:"", the `@family` name should be plural (i.e., ""model building helpers"" not ""model building helper""). You can make a function a member of multiple families by repeating the @family tag for each additional family. These will then get seaprate headings in the __seealso__ section.
+If you have a family of related functions, you can use the `@family <family>` tag to automatically add appropriate lists and interlinks to the `@seealso` section. Because it will appear as ""Other <family>:"", the `@family` name should be plural (i.e., ""model building helpers"" not ""model building helper""). You can make a function a member of multiple families by repeating the @family tag for each additional family. These will then get separate headings in the __seealso__ section.
 
 For sum, these components might look like:
 "
r-lib,roxygen2,6225d7a675dce5ea54cf0e542c3e33fead7832d2,Jim Hester,james.f.hester@gmail.com,2016-12-07T18:21:30Z,Hadley Wickham,h.wickham@gmail.com,2016-12-07T18:21:30Z,"Do not add extra newlines at the end of Rd files (#543)

Fixes #542",NEWS.md;R/field.R;R/topic.R;R/utils-rd.R;man/double_escape_md.Rd;man/is_s3_generic.Rd;man/load_options.Rd;man/markdown-internals.Rd;man/markdown-test.Rd;man/namespace_roclet.Rd;man/object.Rd;man/object_format.Rd;man/rd_roclet.Rd;man/roc_proc_text.Rd;man/roclet.Rd;man/roclet_find.Rd;man/roxy_tag.Rd;man/roxygen2-package.Rd;man/roxygenize.Rd;man/source_package.Rd;man/update_collate.Rd;man/vignette_roclet.Rd;tests/testthat/test-object-format.R;tests/testthat/test-rd-alias.R;tests/testthat/test-rd-name.R;tests/testthat/test-rd-usage.R,False,True,True,False,16,32,48,"---FILE: NEWS.md---
@@ -1,5 +1,7 @@
 # roxygen2 5.0.1.9000
 
+* Extra newlines are no longer added at the end of .Rd files (#542, @jimhester).
+
 * `@aliases` are no longer sorted in alphabetical order, but will instead
   match the order of the usage. This gives you more control in pkgdown.
 

---FILE: R/field.R---
@@ -53,7 +53,7 @@ format.roxy_field_backref <- function(x, ...) {
     whitespace_only = TRUE
   )
 
-  paste0(paste0(lines, collapse = ""\n""), ""\n"")
+  paste0(paste0(lines, collapse = ""\n""))
 }
 
 # Fields that repeat multiple times --------------------------------------------

---FILE: R/topic.R---
@@ -15,7 +15,7 @@ RoxyTopic <- R6::R6Class(""RoxyTopic"", public = list(
     formatted <- lapply(fields, format, ...)
     paste0(
       made_by(""%""),
-      paste0(unlist(formatted), collapse = """")
+      paste0(unlist(formatted), collapse = ""\n"")
     )
   },
 

---FILE: R/utils-rd.R---
@@ -62,7 +62,7 @@ rd_macro <- function(field, ..., space = FALSE) {
     values <- str_trim(c(...))
   }
 
-  paste0(""\\"", field, paste0(""{"", values, ""}"", collapse = """"), ""\n"")
+  paste0(""\\"", field, paste0(""{"", values, ""}"", collapse = """"))
 }
 
 

---FILE: man/double_escape_md.Rd---
@@ -17,4 +17,3 @@ Double-escaped text.
 Escape \% and \$ and \_ once more, because commonmark
 removes the escaping. We do this everywhere currently.
 }
-

---FILE: man/is_s3_generic.Rd---
@@ -22,4 +22,3 @@ calls \code{\link[=UseMethod]{UseMethod()}}.
 \code{is_s3_method} builds names of all possible generics for that function
 and then checks if any of them actually is a generic.
 }
-

---FILE: man/load_options.Rd---
@@ -13,4 +13,3 @@ load_options(base_path = ""."")
 Load options from DESCRIPTION.
 }
 \keyword{internal}
-

---FILE: man/markdown-internals.Rd---
@@ -53,4 +53,3 @@ uses the markdown-enabled parser. Some tags, e.g.
 standard Roxygen parser.
 }
 \keyword{internal}
-

---FILE: man/markdown-test.Rd---
@@ -18,4 +18,3 @@ Link with link text:  \link[=roxygenize]{this great function} or
 In another package: \link[devtools:document]{and this one}.
 }
 \keyword{internal}
-

---FILE: man/namespace_roclet.Rd---
@@ -25,4 +25,3 @@ see Writing R Extensions.
 Other roclets: \code{\link{rd_roclet}},
   \code{\link{vignette_roclet}}
 }
-

---FILE: man/object.Rd---
@@ -17,4 +17,3 @@ These objects are usually created by the parsers, but it is also
 useful to generate them by hand for testing.
 }
 \keyword{internal}
-

---FILE: man/object_format.Rd---
@@ -17,4 +17,3 @@ This function is called to generate the default ""Format"" section for each
 data object.  The default implementation will return the class and dimension
 information.
 }
-

---FILE: man/rd_roclet.Rd---
@@ -16,4 +16,3 @@ document that functions in your package.
 Other roclets: \code{\link{namespace_roclet}},
   \code{\link{vignette_roclet}}
 }
-

---FILE: man/roc_proc_text.Rd---
@@ -20,4 +20,3 @@ roc_proc_text(roclet, input, registry = default_tags(),
 Useful for testing.
 }
 \keyword{internal}
-

---FILE: man/roclet.Rd---
@@ -25,4 +25,3 @@ that wraps \code{roclet}, and then implement methods for
 \code{roclet_tags}, \code{roclet_process}, \code{roclet_output}, and \code{roclet_clean}.
 }
 \keyword{internal}
-

---FILE: man/roclet_find.Rd---
@@ -27,4 +27,3 @@ roclet_find(""roxygen2::rd_roclet"")
 # to call the function
 roclet_find(""roxygen2::rd_roclet()"")
 }
-

---FILE: man/roxy_tag.Rd---
@@ -73,4 +73,3 @@ Two exceptions to the rule are \code{tag_words} and \code{tag_two_part}, which a
 tag parsing generator functions.
 }
 \keyword{internal}
-

---FILE: man/roxygen2-package.Rd---
@@ -43,4 +43,3 @@ Other contributors:
 }
 
 }
-

---FILE: man/roxygenize.Rd---
@@ -46,4 +46,3 @@ loading that works if you only have R files in your package. For more
 complicated packages, I recommend using \code{devtools::document} which
 does a much better job at simulating package install and load.
 }
-

---FILE: man/source_package.Rd---
@@ -20,4 +20,3 @@ there are compiled files, data files, etc. In that case, it's better to
 use \link[devtools:document]{devtools::document}.
 }
 \keyword{internal}
-

---FILE: man/update_collate.Rd---
@@ -38,4 +38,3 @@ NULL
   update_collate(""my_package"")
 }
 }
-

---FILE: man/vignette_roclet.Rd---
@@ -23,4 +23,3 @@ field in your project options.
 Other roclets: \code{\link{namespace_roclet}},
   \code{\link{rd_roclet}}
 }
-

---FILE: tests/testthat/test-object-format.R---
@@ -81,5 +81,5 @@ test_that(""@format not escaped"", {
     x <- list(a = 1, b = 2)"")[[1]]
 
   expect_equal(get_tag(out, ""format"")$values, ""%"")
-  expect_equal(format(get_tag(out, ""format"")), ""\\format{%}\n"")
+  expect_equal(format(get_tag(out, ""format"")), ""\\format{%}"")
 })

---FILE: tests/testthat/test-rd-alias.R---
@@ -24,8 +24,8 @@ test_that(""aliases escaped, not quoted"", {
     NULL"")[[1]]
   alias1 <- format(get_tag(out1, ""alias""))
   alias2 <- format(get_tag(out2, ""alias""))
-  expect_equal(alias1, c(""\\alias{\\%a\\%}\n"", ""\\alias{a}\n""))
-  expect_equal(alias2, c(""\\alias{a}\n"", ""\\alias{\\%a\\%}\n""))
+  expect_equal(alias1, c(""\\alias{\\%a\\%}"", ""\\alias{a}""))
+  expect_equal(alias2, c(""\\alias{a}"", ""\\alias{\\%a\\%}""))
 })
 
 test_that(""can use NULL to suppress default aliases"", {

---FILE: tests/testthat/test-rd-name.R---
@@ -35,7 +35,7 @@ test_that(""names escaped, not quoted"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' Title
     '%a%' <- function(x, y) x + y"")[[1]]
-  expect_equal(format(get_tag(out, ""name"")), ""\\name{\\%a\\%}\n"")
+  expect_equal(format(get_tag(out, ""name"")), ""\\name{\\%a\\%}"")
 })
 
 test_that(""quoted names captured from assignment"", {

---FILE: tests/testthat/test-rd-usage.R---
@@ -162,7 +162,7 @@ test_that(""quoted topics have usage statements"", {
     rd(""f(a = 1, b = 2, c = a + b)""))
 
   expect_equal(format(get_tag(out, ""usage"")),
-    ""\\usage{\nf(a = 1, b = 2, c = a + b)\n}\n""
+    ""\\usage{\nf(a = 1, b = 2, c = a + b)\n}""
   )
 
 })
@@ -188,7 +188,7 @@ test_that(""default usage not double escaped"", {
   "")[[1]]
 
   expect_equal(format(get_tag(out, ""usage"")),
-    ""\\usage{\n\\method{mean}{foo}(x)\n}\n"")
+    ""\\usage{\n\\method{mean}{foo}(x)\n}"")
 })
 
 test_that(""% and \\ are escaped in usage"", {
@@ -197,7 +197,7 @@ test_that(""% and \\ are escaped in usage"", {
     a <- function(a='%\\\\') {}"")[[1]]
   expect_equal(get_tag(out, ""usage"")$values, escape('a(a = ""%\\\\"")'))
   expect_equal(format(get_tag(out, ""usage"")),
-    ""\\usage{\na(a = \""\\%\\\\\\\\\"")\n}\n"")
+    ""\\usage{\na(a = \""\\%\\\\\\\\\"")\n}"")
 })
 
 test_that(""% and \\ not escaped in manual usage"", {
@@ -207,7 +207,7 @@ test_that(""% and \\ not escaped in manual usage"", {
     a <- function(a) {}
   "")[[1]]
   expect_equal(get_tag(out, ""usage"")$values, rd('%\\'))
-  expect_equal(format(get_tag(out, ""usage"")), '\\usage{\n%\\\n}\n')
+  expect_equal(format(get_tag(out, ""usage"")), '\\usage{\n%\\\n}')
 })
 
 test_that(""non-syntactic names are quoted"", {
@@ -246,7 +246,7 @@ test_that(""long usages protected from incorrect breakage"", {
                   d = '                                    d') 1"")[[1]]
 
   usage <- format(get_tag(out, ""usage""))
-  expect_equal(str_count(usage, ""\n""), 6)
+  expect_equal(str_count(usage, ""\n""), 5)
 })
 
 test_that(""argument vectors split on whitespace"", {
@@ -278,7 +278,7 @@ test_that(""long usages protected from incorrect breakage"", {
     d = '                                    d') 1"")[[1]]
 
   usage <- format(get_tag(out, ""usage""))
-  expect_equal(str_count(usage, ""\n""), 6)
+  expect_equal(str_count(usage, ""\n""), 5)
 })
 
 test_that(""breaking works after escapes (#265)"", {
@@ -296,7 +296,7 @@ test_that(""breaking works after escapes (#265)"", {
       xxxxxxxxxxxxxxxxxx7
   ){}"")[[1]]
   usage <- format(get_tag(out, ""usage""))
-  expect_equal(str_count(usage, ""\n""), 5)
+  expect_equal(str_count(usage, ""\n""), 4)
 })
 
 test_that(""replacement funs get non-breaking spaces"", {"
r-lib,roxygen2,051a13cbed622841b1855b344f49bde01ac00380,hadley,h.wickham@gmail.com,2016-10-19T18:02:32Z,hadley,h.wickham@gmail.com,2016-10-19T18:26:37Z,"Fill in more info in _PACKAGE

Fixes #527",DESCRIPTION;NEWS.md;R/object-defaults.R;R/object-package.R;R/roxygen.R;man/roxygen2-package.Rd;tests/testthat/test-rd-package.R,False,True,True,False,148,34,182,"---FILE: DESCRIPTION---
@@ -1,8 +1,9 @@
 Package: roxygen2
-Title: In-Source Documentation for R
-Description: A 'Doxygen'-like in-source documentation system
-    for Rd, collation, and 'NAMESPACE' files.
-URL: https://github.com/klutometis/roxygen
+Title: In-Line Documentation for R
+Description: Generate your Rd documentation, 'NAMESPACE' file, and collation 
+    field using specially formatted comments. Writing documentation in-line
+    with code makes it easier to keep your documentation up-to-date as your
+    requirements change. Roxygen2 is inspired by the 'Doxygen' system for C++.
 Version: 5.0.1.9000
 License: GPL (>= 2)
 Authors@R: c(
@@ -34,3 +35,5 @@ VignetteBuilder: knitr
 LinkingTo: Rcpp
 Roxygen: list(markdown = TRUE)
 RoxygenNote: 5.0.1.9000
+URL: https://github.com/klutometis/roxygen
+BugReports: https://github.com/klutometis/roxygen/issues

---FILE: NEWS.md---
@@ -1,5 +1,9 @@
 # roxygen2 5.0.1.9000
 
+* `""_PACKAGE""` documentation now generates a default `@seealso` combining
+  the `URL` and `BugReport` fields, and a default `@author` field generated
+  from the `Authors@R` field (#527).
+
 * S3 method declarations via setMethodS3() of R.methodS3 and function
   declarations via setConstructorS3() of R.oo are now supported
   (@HenrikBengtsson, #525).

---FILE: R/object-defaults.R---
@@ -41,13 +41,16 @@ object_defaults.import <- function(x) {
 #' @export
 object_defaults.package <- function(x) {
   desc <- x$value$desc
+
   list(
     docType = ""package"",
-    title = as.character(desc$Title),
-    description = as.character(desc$Description),
+    name = package_suffix(desc$Package),
     # ""NULL"" prevents addition of default aliases, see also #202
     aliases = paste(""NULL"", desc$Package, package_suffix(desc$Package)),
-    name = package_suffix(desc$Package)
+    title = paste0(desc$Package, "": "", desc$Title),
+    description = as.character(desc$Description),
+    seealso = package_seealso(desc),
+    author = package_authors(desc)
   )
 }
 

---FILE: R/object-package.R---
@@ -0,0 +1,95 @@
+package_seealso <- function(desc) {
+  if (!is.null(desc$URL)) {
+    links <- paste0(""\\url{"", strsplit(desc$URL, "",\\s+""), ""}"")
+  } else {
+    links <- character()
+  }
+  if (!is.null(desc$BugReports)) {
+    links <- c(links, paste0(""Report bugs at \\url{"", desc$BugReports, ""}\n""))
+  }
+
+  paste0(
+    ""Useful links:\n"",
+    ""\n"",
+    ""\\itemize{\n"",
+    paste0(""\\item "", links, ""\n"", collapse = """"),
+    ""}\n""
+  )
+}
+
+package_authors <- function(desc) {
+  authors <- tryCatch(eval(parse(text = desc$`Authors@R`)),
+    error = function(e) {
+      warning(e)
+      NULL
+    }
+  )
+  if (is.null(authors))
+    return()
+
+  desc <- vapply(unclass(authors), author_desc, character(1))
+  type <- vapply(unclass(authors), author_type, character(1))
+
+  by_type <- split(desc, type)
+
+  paste0(
+    ""\\strong{Maintainer}: "", by_type$cre[[1]], ""\n\n"",
+    itemize(""Other authors:"", by_type$aut), ""\n"",
+    itemize(""Other contributers:"", by_type$other)
+  )
+}
+
+itemize <- function(header, x) {
+  if (length(x) == 0)
+    return()
+
+  paste0(
+    header, ""\n"",
+    ""\\itemize{\n"",
+    paste0(""  \\item "", x, ""\n"", collapse = """"),
+    ""}\n""
+  )
+}
+
+author_desc <- function(x) {
+  desc <- x$given
+
+  if (!is.null(x$family)) {
+    desc <- paste0(desc, "" "", x$family)
+  }
+
+  if (!is.null(x$email)) {
+    desc <- paste0(desc, "" \\email{"", x$email, ""}"")
+  }
+
+  extra_roles <- setdiff(x$role, c(""cre"", ""aut""))
+  if (length(extra_roles) > 0) {
+    desc <- paste0(
+      desc, "" ("", paste0(role_lookup[extra_roles], collapse = "", ""), "")""
+    )
+  }
+
+  desc
+}
+
+author_type <- function(x) {
+  if (""cre"" %in% x$role) {
+    ""cre""
+  } else if (""aut"" %in% x$role) {
+    ""aut""
+  } else {
+    ""other""
+  }
+}
+
+role_lookup <- c(
+  ""aut"" = ""Author"",
+  ""com"" = ""Compiler"",
+  ""ctb"" = ""Contributor"",
+  ""cph"" = ""Copyright holder"",
+  ""cre"" = ""Maintainer"",
+  ""ctr"" = ""Contractor"",
+  ""dtc"" = ""Data contributor"",
+  ""ths"" = ""Thesis advisor"",
+  ""trl"" = ""Translator""
+)

---FILE: R/roxygen.R---
@@ -1,19 +1,12 @@
 #' @details
+#' See \code{vignette(""roxygen2"", package = ""roxygen2"")} for an overview
+#' of the package, \code{vignette(""rd"", package = ""roxygen2"")} for generating
+#' documentation, and \code{vignette(""namespace"", package = ""roxygen2"")} for
+#' generating the namespace specification.
+#'
 #' If you have existing Rd files, check out the \code{Rd2roxygen} package
 #' for a convenient way of converting Rd files to roxygen comments.
 #'
-#' @author
-#' Hadley Wickham \email{h.wickham@@gmail.com},
-#' Peter Danenberg \email{pcd@@roxygen.org},
-#' Manuel Eugster \email{Manuel.Eugster@@stat.uni-muenchen.de}
-#'
-#' Maintainer: Hadley Wickham \email{h.wickham@@gmail.com}
 #' @useDynLib roxygen2
 #' @importFrom Rcpp sourceCpp
-#' @examples
-#' \dontrun{roxygenize('pkg')}
-#' @seealso See \code{vignette(""roxygen2"", package = ""roxygen2"")} for an overview
-#'   of the package, \code{vignette(""rd"", package = ""roxygen2"")} for generating
-#'   documentation, and \code{vignette(""namespace"", package = ""roxygen2"")} for
-#'   generating the namespace specification.
 ""_PACKAGE""

---FILE: man/roxygen2-package.Rd---
@@ -4,29 +4,45 @@
 \name{roxygen2-package}
 \alias{roxygen2}
 \alias{roxygen2-package}
-\title{In-Source Documentation for R}
+\title{roxygen2: In-Line Documentation for R}
 \description{
-A 'Doxygen'-like in-source documentation system
-for Rd, collation, and 'NAMESPACE' files.
+Generate your Rd documentation, 'NAMESPACE' file, and collation
+field using specially formatted comments. Writing documentation in-line
+with code makes it easier to keep your documentation up-to-date as your
+requirements change. Roxygen2 is inspired by the 'Doxygen' system for C++.
 }
 \details{
+See \code{vignette(""roxygen2"", package = ""roxygen2"")} for an overview
+of the package, \code{vignette(""rd"", package = ""roxygen2"")} for generating
+documentation, and \code{vignette(""namespace"", package = ""roxygen2"")} for
+generating the namespace specification.
+
 If you have existing Rd files, check out the \code{Rd2roxygen} package
 for a convenient way of converting Rd files to roxygen comments.
 }
-\examples{
-\dontrun{roxygenize('pkg')}
-}
 \author{
-Hadley Wickham \email{h.wickham@gmail.com},
-Peter Danenberg \email{pcd@roxygen.org},
-Manuel Eugster \email{Manuel.Eugster@stat.uni-muenchen.de}
+\strong{Maintainer}: Hadley Wickham \email{hadley@rstudio.com} (Copyright holder)
+
+Other authors:
+\itemize{
+  \item Peter Danenberg \email{pcd@roxygen.org} (Copyright holder)
+  \item Manuel Eugster (Copyright holder)
+}
+
+Other contributers:
+\itemize{
+  \item RStudio (Copyright holder)
+}
 
-Maintainer: Hadley Wickham \email{h.wickham@gmail.com}
 }
 \seealso{
-See \code{vignette(""roxygen2"", package = ""roxygen2"")} for an overview
-of the package, \code{vignette(""rd"", package = ""roxygen2"")} for generating
-documentation, and \code{vignette(""namespace"", package = ""roxygen2"")} for
-generating the namespace specification.
+Useful links:
+
+\itemize{
+\item \url{https://github.com/klutometis/roxygen}
+\item Report bugs at \url{https://github.com/klutometis/roxygen/issues}
+
+}
+
 }
 

---FILE: tests/testthat/test-rd-package.R---
@@ -13,7 +13,7 @@ test_that(""can create package documentation"", {
   expect_equal(get_tag(out, ""name"")$values, ""roxygen_devtest-package"")
   expect_equal(get_tag(out, ""alias"")$values, c(""roxygen_devtest"",
                                                ""roxygen_devtest-package""))
-  expect_equal(get_tag(out, ""title"")$values, ""Package Title"")
+  expect_equal(get_tag(out, ""title"")$values, ""roxygen_devtest: Package Title"")
   expect_equal(get_tag(out, ""description"")$values, ""Package description."")
   expect_equal(get_tag(out, ""docType"")$values, ""package"")
   expect_equal(get_tag(out, ""details"")$values, ""Details."")"
r-lib,roxygen2,1dff87fba52419eb857a4d8f20636167ac3c24fe,hadley,h.wickham@gmail.com,2016-10-02T14:03:45Z,hadley,h.wickham@gmail.com,2016-10-02T14:03:45Z,"Fix typos in news

cc @privefl",NEWS.md,False,False,False,False,2,2,4,"---FILE: NEWS.md---
@@ -8,9 +8,9 @@
   comes with a flexible specification for argument selection:
   
     * `@inheritDotParams foo` takes all parameters from `foo()`
-    * `@inheritDocParams a b e:h` takes parameters `a`, `b`, and all 
+    * `@inheritDotParams foo a b e:h` takes parameters `a`, `b`, and all 
        parameters between `e` and `h`
-    * `@inheritDocParams -x -y` takes all parameters except for `x` and `y`.
+    * `@inheritDotParams foo -x -y` takes all parameters except for `x` and `y`.
     
     The documentation generated is similar to the style used in `?plot`
     and will eventually be incorporated in to RStudio's autocomplete."
r-lib,roxygen2,fc65f1fbad90a08a912e3b970fff780421570686,G치bor Cs치rdi,csardi.gabor@gmail.com,2016-09-22T13:47:46Z,Hadley Wickham,h.wickham@gmail.com,2016-09-22T13:47:46Z,"Global option for markdown (#515)

* Global options from Roxygen: in DESCRIPTION, for #507

Also add the @noMd tag.

* Test cases for turning markdown on/off globally

* Turn on markdown for roxygen2 itself

* Update markdown vignette for new global option & @noMd

* Fix wrong entry in NEWS file

* Add relevant issues to NEWS file, markdown entry

* markdown NEWS: mention global flag, @md @noMd",DESCRIPTION;NEWS.md;R/collate.R;R/markdown-escaping.R;R/markdown.R;R/namespace.R;R/object-format.R;R/object-s3.R;R/parse.R;R/rd-template.R;R/rd.R;R/roclet.R;R/roxygenize.R;R/source.R;R/tag.R;R/vignette.R;man/double_escape_md.Rd;man/roc_proc_text.Rd;man/roclet.Rd;man/roxygen2-package.Rd;tests/testthat/test-rd-markdown-on-off.R;vignettes/markdown.Rmd;vignettes/markdown.html;vignettes/markdown.md,True,True,True,False,446,243,689,"---FILE: DESCRIPTION---
@@ -32,4 +32,5 @@ Suggests:
     covr
 VignetteBuilder: knitr
 LinkingTo: Rcpp
+Roxygen: list(markdown = TRUE)
 RoxygenNote: 5.0.1.9000

---FILE: NEWS.md---
@@ -92,11 +92,12 @@
 
 * Exported `roxy_tag()`, `roxy_tag_warning()` and 
 
-# roxygen2 5.0.1
-
 * Most fields can now be written using Markdown markup instead of the
-  traditional Rd language. See the 'markdown' vignette for details
-  (#364, #431), by @gaborcsardi
+  traditional Rd language. You can turn on Markdown globally by adding
+  `Roxygen: list(markdown = TRUE)` to `DESCRIPTION`. The `@md` / `@noMd`
+  tags turn Markdown parsing on / off for the given block. See the
+  'markdown' vignette for more details (#364, #431, #499, #506, #507),
+  by @gaborcsardi
 
 # roxygen2 5.0.1
 

---FILE: R/collate.R---
@@ -16,7 +16,6 @@
 #' and you can't source the files unless you know the correct order.
 #'
 #' @param base_path Path to package directory.
-#' @md
 #' @examples
 #' #' `example-a.R', `example-b.R' and `example-c.R' reside
 #' #' in the `example' directory, with dependencies

---FILE: R/markdown-escaping.R---
@@ -20,7 +20,6 @@
 #' `@aliases`, `@backref`, etc. only use the
 #' standard Roxygen parser.
 #'
-#' @md
 #' @param text Input text. Potentially contains Rd and/or
 #'   markdown markup.
 #' @return For `escape_rd_for_md`:
@@ -54,7 +53,6 @@ escaped_for_md <- paste0(""\\"", c(
 #' @param esc_text The original escaped text from
 #'   [escape_rd_for_md()].
 #' @return For `unescape_rd_for_md`: Rd text.
-#' @md
 #' @rdname markdown-internals
 unescape_rd_for_md <- function(rd_text, esc_text) {
   id <- attr(esc_text, ""roxygen-markdown-subst"")$id

---FILE: R/markdown.R---
@@ -1,5 +1,10 @@
-# Hacky global switch - will be eliminated when we turn md on for
-# all
+
+## If not specified in DESCRIPTION
+markdown_global_default <- FALSE
+
+## Hacky global switch - this uses the fact that blocks are parsed
+## one after the another, and that we set markdown on/off before each
+## block
 
 markdown_env <- new.env(parent = emptyenv())
 markdown_on <- function(value = NULL) {
@@ -258,7 +263,6 @@ add_linkrefs_to_md <- function(text) {
 #' @param destination string constant, the ""url"" of the link
 #' @param contents An XML node, containing the contents of the link.
 #'
-#' @md
 #' @noRd
 #' @importFrom xml2 xml_name
 
@@ -355,7 +359,6 @@ is_empty_xml <- function(x) {
 #'
 #' In another package: [and this one][devtools::document].
 #'
-#' @md
 #' @name markdown-test
 #' @keywords internal
 NULL

---FILE: R/namespace.R---
@@ -9,7 +9,6 @@ ns_tags <- c('export', 'exportClass', 'exportMethod', 'exportPattern',
 #' (<http://cran.r-project.org/doc/manuals/R-exts.pdf>) for details.
 #'
 #' @family roclets
-#' @md
 #' @export
 #' @seealso `vignette(""namespace"", package = ""roxygen2"")`
 #' @aliases export exportClass exportMethod S3method import importFrom
@@ -19,7 +18,8 @@ namespace_roclet <- function() {
 }
 
 #' @export
-roclet_process.roclet_namespace <- function(x, parsed, base_path) {
+roclet_process.roclet_namespace <- function(x, parsed, base_path,
+                                            global_options = list()) {
   ns <- unlist(lapply(parsed$blocks, block_to_ns)) %||% character()
   sort_c(unique(ns))
 }

---FILE: R/object-format.R---
@@ -6,7 +6,6 @@
 #'
 #' @param x A data object
 #' @return A `character` value with valid `Rd` syntax, or `NULL`.
-#' @md
 #' @export
 object_format <- function(x) {
   UseMethod(""object_format"")

---FILE: R/object-s3.R---
@@ -8,7 +8,6 @@
 #' `is_s3_method` builds names of all possible generics for that function
 #' and then checks if any of them actually is a generic.
 #'
-#' @md
 #' @param name Name of function.
 #' @param env Base environment in which to look for function defintion.
 #' @export

---FILE: R/parse.R---
@@ -1,14 +1,15 @@
-parse_package <- function(base_path, load_code, registry) {
+parse_package <- function(base_path, load_code, registry, global_options = list()) {
   env <- load_code(base_path)
 
   files <- package_files(base_path)
-  parsed <- lapply(files, parse_blocks, env = env, registry = registry)
+  parsed <- lapply(files, parse_blocks, env = env, registry = registry,
+                   global_options = global_options)
   blocks <- unlist(parsed, recursive = FALSE)
 
   list(env = env, blocks = blocks)
 }
 
-parse_text <- function(text, registry = default_tags()) {
+parse_text <- function(text, registry = default_tags(), global_options = list()) {
   file <- tempfile()
   writeLines(text, file)
   on.exit(unlink(file))
@@ -17,20 +18,22 @@ parse_text <- function(text, registry = default_tags()) {
   methods::setPackageName(""roxygen_devtest"", env)
 
   sys.source(file, envir = env)
-  blocks <- parse_blocks(file, env, registry = registry)
+  blocks <- parse_blocks(file, env, registry = registry,
+                         global_options = global_options)
 
   list(env = env, blocks = blocks)
 }
 
-parse_blocks <- function(file, env, registry) {
+parse_blocks <- function(file, env, registry, global_options = list()) {
   parsed <- parse(file = file, keep.source = TRUE)
   if (length(parsed) == 0) return()
 
   refs <- utils::getSrcref(parsed)
   comment_refs <- comments(refs)
 
   extract <- function(call, ref, comment_ref) {
-    block <- parse_block(comment_ref, file, registry)
+    block <- parse_block(comment_ref, file, registry,
+                         global_options = global_options)
     if (length(block) == 0) return()
 
     block$object <- object_from_call(call, env, block, file)
@@ -41,13 +44,30 @@ parse_blocks <- function(file, env, registry) {
   Map(extract, parsed, refs, comment_refs)
 }
 
-parse_block <- function(x, file, registry, offset = x[[1]]) {
+parse_block <- function(x, file, registry, offset = x[[1]], global_options = list()) {
   tags <- tokenise_block(as.character(x), file = basename(file), offset = offset)
   if (length(tags) == 0)
     return()
 
-  ## Switch markdown on/off if md absent/present
-  markdown_on(""md"" %in% vapply(tags, ""[["", """", ""tag""))
+  ## markdown on/off based on global flag and presense of @md & @nomd
+  ## we need to use markdown_global_default as well, because global_options
+  ## can be NULL, e.g. if called from parse_text()
+
+  names <- vapply(tags, `[[`, ""tag"", FUN.VALUE = character(1))
+  has_md <- ""md"" %in% names
+  has_nomd <- ""noMd"" %in% names
+
+  md <- global_options$markdown %||% markdown_global_default
+  if (has_md) md <- TRUE
+  if (has_nomd) md <- FALSE
+  markdown_on(md)
+
+  if (has_md && has_nomd) {
+    warning(
+      ""Both @md and @noMd, no markdown parsing, in block at "",
+      file, "":"", offset
+    )
+  }
 
   tags <- parse_description(tags)
   tags <- compact(lapply(tags, parse_tag, registry = registry))

---FILE: R/rd-template.R---
@@ -13,7 +13,7 @@ template_eval <- function(template_path, vars) {
   utils::capture.output(brew::brew(template_path, envir = vars))
 }
 
-process_templates <- function(block, base_path) {
+process_templates <- function(block, base_path, global_options = list()) {
   template_locs <- names(block) == ""template""
   template_tags <- block[template_locs]
   if (length(template_tags) == 0) return(block)
@@ -32,7 +32,8 @@ process_templates <- function(block, base_path) {
   # Insert templates back in the location where they came from
   block_pieces <- lapply(block, list)
   block_pieces[template_locs] <- lapply(results, parse_block,
-    file = ""TEMPLATE"", registry = roclet_tags.roclet_rd(list()), offset = 0L)
+    file = ""TEMPLATE"", registry = roclet_tags.roclet_rd(list()), offset = 0L,
+    global_options = global_options)
   names(block_pieces)[template_locs] <- """"
 
   unlist(block_pieces, recursive = FALSE)

---FILE: R/rd.R---
@@ -39,6 +39,7 @@ roclet_tags.roclet_rd <- function(x) {
     method = tag_words(2, 2),
     name = tag_value,
     md = tag_toggle,
+    noMd = tag_toggle,
     noRd = tag_toggle,
     note = tag_markdown,
     param = tag_name_description,
@@ -58,15 +59,16 @@ roclet_tags.roclet_rd <- function(x) {
 }
 
 #' @export
-roclet_process.roclet_rd <- function(x, parsed, base_path) {
+roclet_process.roclet_rd <- function(x, parsed, base_path,
+                                     global_options = list()) {
   # Convert each block into a topic, indexed by filename
   topics <- RoxyTopics$new()
 
   for (block in parsed$blocks) {
     if (length(block) == 0)
       next
 
-    rd <- block_to_rd(block, base_path, parsed$env)
+    rd <- block_to_rd(block, base_path, parsed$env, global_options)
     topics$add(rd)
   }
   topics$drop_invalid()
@@ -77,9 +79,9 @@ roclet_process.roclet_rd <- function(x, parsed, base_path) {
   topics$topics
 }
 
-block_to_rd <- function(block, base_path, env) {
+block_to_rd <- function(block, base_path, env, global_options = list()) {
   # Must start by processing templates
-  block <- process_templates(block, base_path)
+  block <- process_templates(block, base_path, global_options)
 
   if (!needs_doc(block)) {
     return()

---FILE: R/roclet.R---
@@ -6,7 +6,6 @@
 #'
 #' @keywords internal
 #' @name roclet
-#' @md
 NULL
 
 #' @export
@@ -29,7 +28,7 @@ roclet_tags <- function(x) {
 
 #' @export
 #' @rdname roclet
-roclet_process <- function(x, parsed, base_path) {
+roclet_process <- function(x, parsed, base_path, global_options = list()) {
   UseMethod(""roclet_process"")
 }
 
@@ -88,13 +87,15 @@ is.roclet <- function(x) inherits(x, ""roclet"")
 #' @param roclet Name of roclet to use for processing.
 #' @param input Source string
 #' @param registry Named list of tag parsers
+#' @param global_options List of global options
 #' @export
 #' @keywords internal
-roc_proc_text <- function(roclet, input, registry = default_tags()) {
+roc_proc_text <- function(roclet, input, registry = default_tags(),
+                          global_options = list()) {
   stopifnot(is.roclet(roclet))
 
-  parsed <- parse_text(input, registry = registry)
-  roclet_process(roclet, parsed, base_path = ""."")
+  parsed <- parse_text(input, registry = registry, global_options)
+  roclet_process(roclet, parsed, base_path = ""."", global_options)
 }
 
 default_tags <- function() {

---FILE: R/roxygenize.R---
@@ -62,7 +62,7 @@ roxygenize <- function(package.dir = ""."",
   tags <- c(lapply(roclets, roclet_tags), list(list(include = tag_value)))
   registry <- unlist(tags, recursive = FALSE)
 
-  parsed <- parse_package(base_path, load_code, registry)
+  parsed <- parse_package(base_path, load_code, registry, options)
 
   roc_out <- function(roc) {
     if (clean) {
@@ -95,7 +95,8 @@ load_options <- function(base_path = ""."") {
 
   defaults <- list(
     wrap = FALSE,
-    roclets = c(""collate"", ""namespace"", ""rd"")
+    roclets = c(""collate"", ""namespace"", ""rd""),
+    markdown = markdown_global_default
   )
 
   unknown_opts <- setdiff(names(opts), names(defaults))

---FILE: R/source.R---
@@ -9,7 +9,6 @@
 #' @return An environment, into which all R files in the directory were
 #'   sourced.
 #' @keywords internal
-#' @md
 source_package <- function(path) {
   r_path <- file.path(path, ""R"")
   if (!file.exists(r_path)) stop(""Can't find R/ directory"", call. = FALSE)

---FILE: R/tag.R---
@@ -10,7 +10,6 @@
 #' tag parsing generator functions.
 #'
 #' @keywords internal
-#' @md
 #' @export
 #' @param tag Tag name
 #' @param val Tag value. When read from the file, this will be a string,

---FILE: R/vignette.R---
@@ -11,15 +11,15 @@
 #' your package, add `--no-build-vignettes` to the ""Build Source Package""
 #' field in your project options.
 #'
-#' @md
 #' @family roclets
 #' @export
 vignette_roclet <- function() {
   roclet(""vignette"")
 }
 
 #' @export
-roclet_process.roclet_vignette <- function(x, parsed, base_path) {
+roclet_process.roclet_vignette <- function(x, parsed, base_path,
+                                           global_options = list()) {
 }
 
 #' @export

---FILE: man/double_escape_md.Rd---
@@ -2,7 +2,7 @@
 % Please edit documentation in R/markdown-escaping.R
 \name{double_escape_md}
 \alias{double_escape_md}
-\title{Escape \\% and \\$ and \\_ once more, because commonmark
+\title{Escape \% and \$ and \_ once more, because commonmark
 removes the escaping. We do this everywhere currently.}
 \usage{
 double_escape_md(text)
@@ -14,7 +14,7 @@ double_escape_md(text)
 Double-escaped text.
 }
 \description{
-Escape \\% and \\$ and \\_ once more, because commonmark
+Escape \% and \$ and \_ once more, because commonmark
 removes the escaping. We do this everywhere currently.
 }
 

---FILE: man/roc_proc_text.Rd---
@@ -4,14 +4,17 @@
 \alias{roc_proc_text}
 \title{Process roclet on string and capture results.}
 \usage{
-roc_proc_text(roclet, input, registry = default_tags())
+roc_proc_text(roclet, input, registry = default_tags(),
+  global_options = list())
 }
 \arguments{
 \item{roclet}{Name of roclet to use for processing.}
 
 \item{input}{Source string}
 
 \item{registry}{Named list of tag parsers}
+
+\item{global_options}{List of global options}
 }
 \description{
 Useful for testing.

---FILE: man/roclet.Rd---
@@ -14,7 +14,7 @@ roclet_output(x, results, base_path, ...)
 
 roclet_tags(x)
 
-roclet_process(x, parsed, base_path)
+roclet_process(x, parsed, base_path, global_options)
 
 roclet_clean(x, base_path)
 }

---FILE: man/roxygen2-package.Rd---
@@ -25,8 +25,8 @@ Maintainer: Hadley Wickham \email{h.wickham@gmail.com}
 }
 \seealso{
 See \code{vignette(""roxygen2"", package = ""roxygen2"")} for an overview
-  of the package, \code{vignette(""rd"", package = ""roxygen2"")} for generating
-  documentation, and \code{vignette(""namespace"", package = ""roxygen2"")} for
-  generating the namespace specification.
+of the package, \code{vignette(""rd"", package = ""roxygen2"")} for generating
+documentation, and \code{vignette(""namespace"", package = ""roxygen2"")} for
+generating the namespace specification.
 }
 

---FILE: tests/testthat/test-rd-markdown-on-off.R---
@@ -0,0 +1,126 @@
+context(""Rd: turning markdown on/off"")
+roc <- rd_roclet()
+
+test_that(""turning on/off markdown globally"", {
+  ## off
+  out1 <- roc_proc_text(roc, global_options = list(markdown = FALSE), ""
+    #' Title
+    #'
+    #' Description with some `code` included. `More code.`
+    foo <- function() {}"")[[1]]
+  expect_equal(
+    get_tag(out1, ""description"")$values,
+    ""Description with some `code` included. `More code.`""
+  )
+
+  ## on
+  out1 <- roc_proc_text(roc, global_options = list(markdown = TRUE), ""
+    #' Title
+    #'
+    #' Description with some `code` included. `More code.`
+    foo <- function() {}"")[[1]]
+  expect_equal(
+    get_tag(out1, ""description"")$values,
+    ""Description with some \\code{code} included. \\code{More code.}""
+  )
+})
+
+test_that(""turning on/off markdown locally"", {
+  ## off / off
+  out1 <- roc_proc_text(roc, global_options = list(markdown = FALSE), ""
+    #' Title
+    #'
+    #' Description with some `code` included. `More code.`
+    #' @noMd
+    foo <- function() {}"")[[1]]
+  expect_equal(
+    get_tag(out1, ""description"")$values,
+    ""Description with some `code` included. `More code.`""
+  )
+
+  ## off / on
+  out1 <- roc_proc_text(roc, global_options = list(markdown = FALSE), ""
+    #' Title
+    #'
+    #' Description with some `code` included. `More code.`
+    #' @md
+    foo <- function() {}"")[[1]]
+  expect_equal(
+    get_tag(out1, ""description"")$values,
+    ""Description with some \\code{code} included. \\code{More code.}""
+  )
+
+  ## on / off
+  out1 <- roc_proc_text(roc, global_options = list(markdown = TRUE), ""
+    #' Title
+    #'
+    #' Description with some `code` included. `More code.`
+    #' @noMd
+    foo <- function() {}"")[[1]]
+  expect_equal(
+    get_tag(out1, ""description"")$values,
+    ""Description with some `code` included. `More code.`""
+  )
+
+  ## on / on
+  out1 <- roc_proc_text(roc, global_options = list(markdown = TRUE), ""
+    #' Title
+    #'
+    #' Description with some `code` included. `More code.`
+    #' @md
+    foo <- function() {}"")[[1]]
+  expect_equal(
+    get_tag(out1, ""description"")$values,
+    ""Description with some \\code{code} included. \\code{More code.}""
+  )
+
+})
+
+test_that(""warning for both @md and @noMd"", {
+
+  expect_warning(
+    out1 <- roc_proc_text(roc, ""
+      #' Title
+      #'
+      #' Description with some `code` included. `More code.`
+      #' @md
+      #' @noMd
+      foo <- function() {}"")[[1]],
+    ""Both @md and @noMd, no markdown parsing""
+  )
+  expect_equal(
+    get_tag(out1, ""description"")$values,
+    ""Description with some `code` included. `More code.`""
+  )
+
+  expect_warning(
+    out1 <- roc_proc_text(roc, global_options = list(markdown = FALSE), ""
+      #' Title
+      #'
+      #' Description with some `code` included. `More code.`
+      #' @md
+      #' @noMd
+      foo <- function() {}"")[[1]],
+    ""Both @md and @noMd, no markdown parsing""
+  )
+  expect_equal(
+    get_tag(out1, ""description"")$values,
+    ""Description with some `code` included. `More code.`""
+  )
+
+  expect_warning(
+    out1 <- roc_proc_text(roc, global_options = list(markdown = TRUE), ""
+      #' Title
+      #'
+      #' Description with some `code` included. `More code.`
+      #' @md
+      #' @noMd
+      foo <- function() {}"")[[1]],
+    ""Both @md and @noMd, no markdown parsing""
+  )
+  expect_equal(
+    get_tag(out1, ""description"")$values,
+    ""Description with some `code` included. `More code.`""
+  )
+
+})

---FILE: vignettes/markdown.Rmd---
@@ -19,7 +19,17 @@ Starting from version 6.0.0, roxygen supports markdown markup within most roxyge
 
 # Turning on markdown support
 
-Currently you have to turn on markdown formatting manually for each roxygen chunk. You can do this by using the `@md` tag anywhere in the chunk. In the future roxygen will provide a global switch that turns on markdown formatting for the whole package. (And also a `@noMd` to turn it off, optionally.)
+There are two ways to turn on markdown support for a package: globally, at the package level, and locally at the block level.
+
+To turn on markdown for the whole package, insert this entry into the `DESCRIPTION` file of the package:
+```
+Roxygen: list(markdown = TRUE)
+```
+The position of the entry in the file does not matter. After this, all Roxygen documentation will be parsed as markdown.
+
+Alternatively, you can use the `@md` tag to turn on markdown support for a single documentation chunk. This is a good option to write any new documentation for existing packages in markdown.
+
+There is also a new `@noMd` tag. Use this if you turned on markdown parsing globally, but need to avoid it for a single chunk. This tag is handy if the markdown parser interferes with more complex Rd syntax.
 
 Here is an example roxygen chunk that uses markdown.
 
@@ -168,7 +178,7 @@ The parser recognizes the markdown notation for embedded images. The image files
 
 # Roxygen and Rd tags *not* parsed as markdown
 
-Some of the roxygen tags are not parsed as markdown. Most of these are unlikely to contain text that needs markup, so this is not an important restriction. Tags without markdown support: `@aliases`, `@backref`, `@docType`, `@encoding`, `@evalRd`, `@example`, `@examples`, `@family`, `@inheritParams`, `@keywords`, `@method` `@name`, `@md`, `@noRd`, `@rdname`, `@rawRd`, `@usage`.
+Some of the roxygen tags are not parsed as markdown. Most of these are unlikely to contain text that needs markup, so this is not an important restriction. Tags without markdown support: `@aliases`, `@backref`, `@docType`, `@encoding`, `@evalRd`, `@example`, `@examples`, `@family`, `@inheritParams`, `@keywords`, `@method` `@name`, `@md`, `@noMd`, `@noRd`, `@rdname`, `@rawRd`, `@usage`.
 
 When mixing `Rd` and markdown notation, most `Rd` tags may contain markdown markup, the ones that can *not* are: `r paste0(""\x60"", roxygen2:::escaped_for_md, ""\x60"", collapse = "", "")`.
 

---FILE: vignettes/markdown.html---
@@ -1,190 +1,221 @@
----
-title: ""Write R Documentation in Markdown""
-author: ""G치bor Cs치rdi""
-date: ""2016-09-18""
-output: rmarkdown::html_vignette
-vignette: >
-  %\VignetteIndexEntry{Write R Documentation in Markdown}
-  %\VignetteEngine{knitr::rmarkdown}
-  %\VignetteEncoding{UTF-8}
----
-
-
-
-# Introduction
-
-Starting from version 6.0.0, roxygen supports markdown markup within most roxygen tags. Roxygen uses the `commonmark` package, which is based on the CommonMark Reference Implementation to parse these tags. See http://commonmark.org/help/ for more about the parser and the markdown language it supports.
-
-# Turning on markdown support
-
-Currently you have to turn on markdown formatting manually for each roxygen chunk. You can do this by using the `@md` tag anywhere in the chunk. In the future roxygen will provide a global switch that turns on markdown formatting for the whole package. (And also a `@noMd` to turn it off, optionally.)
-
-Here is an example roxygen chunk that uses markdown.
-
-```r
-#' Use roxygen to document a package.
-#'
-#' This function is a wrapper for the [roxygen2::roxygenize()] function from
-#' the `roxygen2` package. See the documentation and vignettes of
-#' that package to learn how to use roxygen.
-#'
-#' @param pkg package description, can be path or package name.  See
-#'   [as.package()] for more information
-#' @param clean,reload Deprecated.
-#' @inheritParams roxygen2::roxygenise
-#' @seealso [roxygen2::roxygenize()], `browseVignettes(""roxygen2"")`
-#' @export
-#' @md
-```
-
-# Syntax
-
-## Emphasis
-
-*Emphasis* and **strong** (bold) text are supported. For emphasis, put the text between asterisks or underline characters. For strong text, use two asterisks at both sides.
-
-```r
-#' See `::is_falsy` for the definition of what is _falsy_
-#' and what is _truthy_.
-```
-
-```r
-#' @references
-#' Robert E Tarjan and Mihalis Yannakakis. (1984). Simple
-
-#' linear-time algorithms to test chordality of graphs, test acyclicity
-#' of hypergraphs, and selectively reduce acyclic hypergraphs.
-#' *SIAM Journal of Computation* **13**, 566-579.
-```
-
-## Code
-
-Inline code is supported via backticks.
-
-```r
-#' @param ns Optionally, a named vector giving prefix-url pairs, as
-#'   produced by `xml_ns`. If provided, all names will be explicitly
-#'   qualified with the ns prefix, i.e. if the element `bar` is defined ...
-```
-
-For blocks of code, put your code between triple backticks:
-
-```r
-#' ```
-#' pkg <- make_packages(
-#'   foo1 = { f <- function() print(""hello!"") ; d <- 1:10 },
-#'   foo2 = { f <- function() print(""hello again!"") ; d <- 11:20 }
-#' )
-#' foo1::f()
-#' foo2::f()
-#' foo1::d
-#' foo2::d
-#' dispose_packages(pkg)
-#' ```
-```
-
-Note that this is not needed in `@examples`, since its contents is formatted as R code,
-anyway.
-
-## Lists
-
-Regular Markdown lists are recognized and converted to `\enumerate{}` or `\itemize{}` lists:
-
-```r
-#' There are two ways to use this function:
-#' 1. If its first argument is not named, then it returns a function
-#'    that can be used to color strings.
-#' 1. If its first argument is named, then it also creates a
-#'    style with the given name. This style can be used in
-#'    `style`. One can still use the return value
-#'    of the function, to create a style function.
-```
-
-```r
-#' The style (the `...` argument) can be anything of the
-#' following:
-#' * An R color name, see `colors()`.
-#' * A 6- or 8-digit hexa color string, e.g. `#ff0000` means
-#'   red. Transparency (alpha channel) values are ignored.
-#' * A one-column matrix with three rows for the red, green
-#'   and blue channels, as returned by [grDevices::col2rgb()]
-```
-
-Nested lists are also supported.
-
-Note that you do not have leave an empty line before the list. This is different from some markdown parsers.
-
-## Links
-
-Markdown hyperlinks work as usual:
-
-```r
-#' See more about the markdown markup at the
-#' [Commonmark web site](http://commonmark.org/help)
-```
-
-URLs are also automatically converted to hyperlinks:
-
-```r
-#' The main R web site is at https://r-project.org.
-```
-
-Markdown notation can be used to create links to other manual pages. There are six kinds of links:
-
-1. Link to another function in the same package: `[func()]`. These
-   links will be typeset as code, and they are equavalent to
-   `\code{\link[=func]{func()}`.
-2. Link to a (non-function) object, class, data set, etc. in the same
-   same package: `[object]`. These links that *not* typeset as code,
-   so if you want them as code, enclose them in backticks (inside the
-   brackets).
-3. Link to a function from another package: `[pkg::func()]`. These links
-   will be typeset as code.
-4. Link to a (non-function) object in another package: `[pkg::object]`.
-   These links will not be typeset as code.
-5. Link to an object in the same package, with a different link text:
-   `[link text][object]`. Here `object` can be a function, but the link
-   text is not typeset as code.
-6. Link to an object in another package, with different link text:
-   `[link text][pkg:object]`. This is not typeset as code.
-
-S3/S4 classes can be linked the same way:
-
-```r
-#' * [terms][terms.object] becomes \link[=terms.object]{terms}
-#' * [abc][abc-class] becomes \link[=abc-class]{abc}
-```
-
-## Images
-
-The parser recognizes the markdown notation for embedded images. The image files must in the  `man/figures` directory:
-
-```r
-#' Here is an example plot:
-#' ![](example-plot.jpg ""Example Plot Title"")
-```
-
-# Roxygen and Rd tags *not* parsed as markdown
-
-Some of the roxygen tags are not parsed as markdown. Most of these are unlikely to contain text that needs markup, so this is not an important restriction. Tags without markdown support: `@aliases`, `@backref`, `@docType`, `@encoding`, `@evalRd`, `@example`, `@examples`, `@family`, `@inheritParams`, `@keywords`, `@method` `@name`, `@md`, `@noRd`, `@rdname`, `@rawRd`, `@usage`.
-
-When mixing `Rd` and markdown notation, most `Rd` tags may contain markdown markup, the ones that can *not* are: `\acronym`, `\code`, `\command`, `\CRANpkg`, `\deqn`, `\doi`, `\dontrun`, `\dontshow`, `\donttest`, `\email`, `\env`, `\eqn`, `\figure`, `\file`, `\if`, `\ifelse`, `\kbd`, `\link`, `\linkS4class`, `\method`, `\newcommand`, `\option`, `\out`, `\packageAuthor`, `\packageDescription`, `\packageDESCRIPTION`, `\packageIndices`, `\packageMaintainer`, `\packageTitle`, `\pkg`, `\PR`, `\preformatted`, `\renewcommand`, `\S3method`, `\S4method`, `\samp`, `\special`, `\testonly`, `\url`, `\var`, `\verb`.
-
-# Possible problems
-
-## Mixing markdown and `Rd` markup
-
-Note that turning on markdown does *not* turn off the standard `Rd` syntax. We suggest that you use the regular `Rd` tags in a markdown roxygen chunk only if necessary. The two parsers do occasionally interact, and the markdown parser can pick up and reformat Rd syntax, causing an error, or currupted manuals.
-
-## Leading whitespace
-
-Leading whitespace is interpreted by the commonmark parser, whereas it is ignored by the `Rd` parser (except in `\preformatted{}`). Make sure that you only include leading whitespace intentionally, for example for nested lists.
-
-## Spurious lists
-
-The Commonmark parser does not require an empty line before lists, and this might lead to unintended lists if a line starts with a number followed by a dot, or with an asterisk followed by whitespace:
-
-```r
-#' You can see more about this topic in the book cited below, on page
-#' 42. Clearly, the numbered list that starts here is not intentional.
-```
+<!DOCTYPE html>
+
+<html xmlns=""http://www.w3.org/1999/xhtml"">
+
+<head>
+
+<meta charset=""utf-8"">
+<meta http-equiv=""Content-Type"" content=""text/html; charset=utf-8"" />
+<meta name=""generator"" content=""pandoc"" />
+
+<meta name=""viewport"" content=""width=device-width, initial-scale=1"">
+
+<meta name=""author"" content=""G치bor Cs치rdi"" />
+
+<meta name=""date"" content=""2016-09-22"" />
+
+<title>Write R Documentation in Markdown</title>
+
+
+
+<style type=""text/css"">code{white-space: pre;}</style>
+<style type=""text/css"">
+div.sourceCode { overflow-x: auto; }
+table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
+  margin: 0; padding: 0; vertical-align: baseline; border: none; }
+table.sourceCode { width: 100%; line-height: 100%; }
+td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
+td.sourceCode { padding-left: 5px; }
+code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
+code > span.dt { color: #902000; } /* DataType */
+code > span.dv { color: #40a070; } /* DecVal */
+code > span.bn { color: #40a070; } /* BaseN */
+code > span.fl { color: #40a070; } /* Float */
+code > span.ch { color: #4070a0; } /* Char */
+code > span.st { color: #4070a0; } /* String */
+code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
+code > span.ot { color: #007020; } /* Other */
+code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
+code > span.fu { color: #06287e; } /* Function */
+code > span.er { color: #ff0000; font-weight: bold; } /* Error */
+code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
+code > span.cn { color: #880000; } /* Constant */
+code > span.sc { color: #4070a0; } /* SpecialChar */
+code > span.vs { color: #4070a0; } /* VerbatimString */
+code > span.ss { color: #bb6688; } /* SpecialString */
+code > span.im { } /* Import */
+code > span.va { color: #19177c; } /* Variable */
+code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
+code > span.op { color: #666666; } /* Operator */
+code > span.bu { } /* BuiltIn */
+code > span.ex { } /* Extension */
+code > span.pp { color: #bc7a00; } /* Preprocessor */
+code > span.at { color: #7d9029; } /* Attribute */
+code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
+code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
+code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
+code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
+</style>
+
+
+
+<link href=""data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A"" rel=""stylesheet"" type=""text/css"" />
+
+</head>
+
+<body>
+
+
+
+
+<h1 class=""title toc-ignore"">Write R Documentation in Markdown</h1>
+<h4 class=""author""><em>G치bor Cs치rdi</em></h4>
+<h4 class=""date""><em>2016-09-22</em></h4>
+
+
+
+<div id=""introduction"" class=""section level1"">
+<h1>Introduction</h1>
+<p>Starting from version 6.0.0, roxygen supports markdown markup within most roxygen tags. Roxygen uses the <code>commonmark</code> package, which is based on the CommonMark Reference Implementation to parse these tags. See <a href=""http://commonmark.org/help/"" class=""uri"">http://commonmark.org/help/</a> for more about the parser and the markdown language it supports.</p>
+</div>
+<div id=""turning-on-markdown-support"" class=""section level1"">
+<h1>Turning on markdown support</h1>
+<p>There are two ways to turn on markdown support for a package: globally, at the package level, and locally at the block level.</p>
+<p>To turn on markdown for the whole package, insert this entry into the <code>DESCRIPTION</code> file of the package:</p>
+<pre><code>Roxygen: list(markdown = TRUE)</code></pre>
+<p>The position of the entry in the file does not matter. After this, all Roxygen documentation will be parsed as markdown.</p>
+<p>Alternatively, you can use the <code>@md</code> tag to turn on markdown support for a single documentation chunk. This is a good option to write any new documentation for existing packages in markdown.</p>
+<p>There is also a new <code>@noMd</code> tag. Use this if you turned on markdown parsing globally, but need to avoid it for a single chunk. This tag is handy if the markdown parser interferes with more complex Rd syntax.</p>
+<p>Here is an example roxygen chunk that uses markdown.</p>
+<div class=""sourceCode""><pre class=""sourceCode r""><code class=""sourceCode r""><span class=""co"">#' Use roxygen to document a package.</span>
+<span class=""co"">#'</span>
+<span class=""co"">#' This function is a wrapper for the [roxygen2::roxygenize()] function from</span>
+<span class=""co"">#' the `roxygen2` package. See the documentation and vignettes of</span>
+<span class=""co"">#' that package to learn how to use roxygen.</span>
+<span class=""co"">#'</span>
+<span class=""co"">#' @param pkg package description, can be path or package name.  See</span>
+<span class=""co"">#'   [as.package()] for more information</span>
+<span class=""co"">#' @param clean,reload Deprecated.</span>
+<span class=""co"">#' @inheritParams roxygen2::roxygenise</span>
+<span class=""co"">#' @seealso [roxygen2::roxygenize()], `browseVignettes(&quot;roxygen2&quot;)`</span>
+<span class=""co"">#' @export</span>
+<span class=""co"">#' @md</span></code></pre></div>
+</div>
+<div id=""syntax"" class=""section level1"">
+<h1>Syntax</h1>
+<div id=""emphasis"" class=""section level2"">
+<h2>Emphasis</h2>
+<p><em>Emphasis</em> and <strong>strong</strong> (bold) text are supported. For emphasis, put the text between asterisks or underline characters. For strong text, use two asterisks at both sides.</p>
+<div class=""sourceCode""><pre class=""sourceCode r""><code class=""sourceCode r""><span class=""co"">#' See `::is_falsy` for the definition of what is _falsy_</span>
+<span class=""co"">#' and what is _truthy_.</span></code></pre></div>
+<div class=""sourceCode""><pre class=""sourceCode r""><code class=""sourceCode r""><span class=""co"">#' @references</span>
+<span class=""co"">#' Robert E Tarjan and Mihalis Yannakakis. (1984). Simple</span>
+
+<span class=""co"">#' linear-time algorithms to test chordality of graphs, test acyclicity</span>
+<span class=""co"">#' of hypergraphs, and selectively reduce acyclic hypergraphs.</span>
+<span class=""co"">#' *SIAM Journal of Computation* **13**, 566-579.</span></code></pre></div>
+</div>
+<div id=""code"" class=""section level2"">
+<h2>Code</h2>
+<p>Inline code is supported via backticks.</p>
+<div class=""sourceCode""><pre class=""sourceCode r""><code class=""sourceCode r""><span class=""co"">#' @param ns Optionally, a named vector giving prefix-url pairs, as</span>
+<span class=""co"">#'   produced by `xml_ns`. If provided, all names will be explicitly</span>
+<span class=""co"">#'   qualified with the ns prefix, i.e. if the element `bar` is defined ...</span></code></pre></div>
+<p>For blocks of code, put your code between triple backticks:</p>
+<div class=""sourceCode""><pre class=""sourceCode r""><code class=""sourceCode r""><span class=""co"">#' ```</span>
+<span class=""co"">#' pkg &lt;- make_packages(</span>
+<span class=""co"">#'   foo1 = { f &lt;- function() print(&quot;hello!&quot;) ; d &lt;- 1:10 },</span>
+<span class=""co"">#'   foo2 = { f &lt;- function() print(&quot;hello again!&quot;) ; d &lt;- 11:20 }</span>
+<span class=""co"">#' )</span>
+<span class=""co"">#' foo1::f()</span>
+<span class=""co"">#' foo2::f()</span>
+<span class=""co"">#' foo1::d</span>
+<span class=""co"">#' foo2::d</span>
+<span class=""co"">#' dispose_packages(pkg)</span>
+<span class=""co"">#' ```</span></code></pre></div>
+<p>Note that this is not needed in <code>@examples</code>, since its contents is formatted as R code, anyway.</p>
+</div>
+<div id=""lists"" class=""section level2"">
+<h2>Lists</h2>
+<p>Regular Markdown lists are recognized and converted to <code>\enumerate{}</code> or <code>\itemize{}</code> lists:</p>
+<div class=""sourceCode""><pre class=""sourceCode r""><code class=""sourceCode r""><span class=""co"">#' There are two ways to use this function:</span>
+<span class=""co"">#' 1. If its first argument is not named, then it returns a function</span>
+<span class=""co"">#'    that can be used to color strings.</span>
+<span class=""co"">#' 1. If its first argument is named, then it also creates a</span>
+<span class=""co"">#'    style with the given name. This style can be used in</span>
+<span class=""co"">#'    `style`. One can still use the return value</span>
+<span class=""co"">#'    of the function, to create a style function.</span></code></pre></div>
+<div class=""sourceCode""><pre class=""sourceCode r""><code class=""sourceCode r""><span class=""co"">#' The style (the `...` argument) can be anything of the</span>
+<span class=""co"">#' following:</span>
+<span class=""co"">#' * An R color name, see `colors()`.</span>
+<span class=""co"">#' * A 6- or 8-digit hexa color string, e.g. `#ff0000` means</span>
+<span class=""co"">#'   red. Transparency (alpha channel) values are ignored.</span>
+<span class=""co"">#' * A one-column matrix with three rows for the red, green</span>
+<span class=""co"">#'   and blue channels, as returned by [grDevices::col2rgb()]</span></code></pre></div>
+<p>Nested lists are also supported.</p>
+<p>Note that you do not have leave an empty line before the list. This is different from some markdown parsers.</p>
+</div>
+<div id=""links"" class=""section level2"">
+<h2>Links</h2>
+<p>Markdown hyperlinks work as usual:</p>
+<div class=""sourceCode""><pre class=""sourceCode r""><code class=""sourceCode r""><span class=""co"">#' See more about the markdown markup at the</span>
+<span class=""co"">#' [Commonmark web site](http://commonmark.org/help)</span></code></pre></div>
+<p>URLs are also automatically converted to hyperlinks:</p>
+<div class=""sourceCode""><pre class=""sourceCode r""><code class=""sourceCode r""><span class=""co"">#' The main R web site is at https://r-project.org.</span></code></pre></div>
+<p>Markdown notation can be used to create links to other manual pages. There are six kinds of links:</p>
+<ol style=""list-style-type: decimal"">
+<li>Link to another function in the same package: <code>[func()]</code>. These links will be typeset as code, and they are equavalent to <code>\code{\link[=func]{func()}</code>.</li>
+<li>Link to a (non-function) object, class, data set, etc. in the same same package: <code>[object]</code>. These links that <em>not</em> typeset as code, so if you want them as code, enclose them in backticks (inside the brackets).</li>
+<li>Link to a function from another package: <code>[pkg::func()]</code>. These links will be typeset as code.</li>
+<li>Link to a (non-function) object in another package: <code>[pkg::object]</code>. These links will not be typeset as code.</li>
+<li>Link to an object in the same package, with a different link text: <code>[link text][object]</code>. Here <code>object</code> can be a function, but the link text is not typeset as code.</li>
+<li>Link to an object in another package, with different link text: <code>[link text][pkg:object]</code>. This is not typeset as code.</li>
+</ol>
+<p>S3/S4 classes can be linked the same way:</p>
+<div class=""sourceCode""><pre class=""sourceCode r""><code class=""sourceCode r""><span class=""co"">#' * [terms][terms.object] becomes \link[=terms.object]{terms}</span>
+<span class=""co"">#' * [abc][abc-class] becomes \link[=abc-class]{abc}</span></code></pre></div>
+</div>
+<div id=""images"" class=""section level2"">
+<h2>Images</h2>
+<p>The parser recognizes the markdown notation for embedded images. The image files must in the <code>man/figures</code> directory:</p>
+<div class=""sourceCode""><pre class=""sourceCode r""><code class=""sourceCode r""><span class=""co"">#' Here is an example plot:</span>
+<span class=""co"">#' ![](example-plot.jpg &quot;Example Plot Title&quot;)</span></code></pre></div>
+</div>
+</div>
+<div id=""roxygen-and-rd-tags-not-parsed-as-markdown"" class=""section level1"">
+<h1>Roxygen and Rd tags <em>not</em> parsed as markdown</h1>
+<p>Some of the roxygen tags are not parsed as markdown. Most of these are unlikely to contain text that needs markup, so this is not an important restriction. Tags without markdown support: <code>@aliases</code>, <code>@backref</code>, <code>@docType</code>, <code>@encoding</code>, <code>@evalRd</code>, <code>@example</code>, <code>@examples</code>, <code>@family</code>, <code>@inheritParams</code>, <code>@keywords</code>, <code>@method</code> <code>@name</code>, <code>@md</code>, <code>@noMd</code>, <code>@noRd</code>, <code>@rdname</code>, <code>@rawRd</code>, <code>@usage</code>.</p>
+<p>When mixing <code>Rd</code> and markdown notation, most <code>Rd</code> tags may contain markdown markup, the ones that can <em>not</em> are: <code>\acronym</code>, <code>\code</code>, <code>\command</code>, <code>\CRANpkg</code>, <code>\deqn</code>, <code>\doi</code>, <code>\dontrun</code>, <code>\dontshow</code>, <code>\donttest</code>, <code>\email</code>, <code>\env</code>, <code>\eqn</code>, <code>\figure</code>, <code>\file</code>, <code>\if</code>, <code>\ifelse</code>, <code>\kbd</code>, <code>\link</code>, <code>\linkS4class</code>, <code>\method</code>, <code>\newcommand</code>, <code>\option</code>, <code>\out</code>, <code>\packageAuthor</code>, <code>\packageDescription</code>, <code>\packageDESCRIPTION</code>, <code>\packageIndices</code>, <code>\packageMaintainer</code>, <code>\packageTitle</code>, <code>\pkg</code>, <code>\PR</code>, <code>\preformatted</code>, <code>\renewcommand</code>, <code>\S3method</code>, <code>\S4method</code>, <code>\samp</code>, <code>\special</code>, <code>\testonly</code>, <code>\url</code>, <code>\var</code>, <code>\verb</code>.</p>
+</div>
+<div id=""possible-problems"" class=""section level1"">
+<h1>Possible problems</h1>
+<div id=""mixing-markdown-and-rd-markup"" class=""section level2"">
+<h2>Mixing markdown and <code>Rd</code> markup</h2>
+<p>Note that turning on markdown does <em>not</em> turn off the standard <code>Rd</code> syntax. We suggest that you use the regular <code>Rd</code> tags in a markdown roxygen chunk only if necessary. The two parsers do occasionally interact, and the markdown parser can pick up and reformat Rd syntax, causing an error, or currupted manuals.</p>
+</div>
+<div id=""leading-whitespace"" class=""section level2"">
+<h2>Leading whitespace</h2>
+<p>Leading whitespace is interpreted by the commonmark parser, whereas it is ignored by the <code>Rd</code> parser (except in <code>\preformatted{}</code>). Make sure that you only include leading whitespace intentionally, for example for nested lists.</p>
+</div>
+<div id=""spurious-lists"" class=""section level2"">
+<h2>Spurious lists</h2>
+<p>The Commonmark parser does not require an empty line before lists, and this might lead to unintended lists if a line starts with a number followed by a dot, or with an asterisk followed by whitespace:</p>
+<div class=""sourceCode""><pre class=""sourceCode r""><code class=""sourceCode r""><span class=""co"">#' You can see more about this topic in the book cited below, on page</span>
+<span class=""co"">#' 42. Clearly, the numbered list that starts here is not intentional.</span></code></pre></div>
+</div>
+</div>
+
+
+
+<!-- dynamically load mathjax for compatibility with self-contained -->
+<script>
+  (function () {
+    var script = document.createElement(""script"");
+    script.type = ""text/javascript"";
+    script.src  = ""https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"";
+    document.getElementsByTagName(""head"")[0].appendChild(script);
+  })();
+</script>
+
+</body>
+</html>

---FILE: vignettes/markdown.md---
@@ -1,7 +1,7 @@
 ---
 title: ""Write R Documentation in Markdown""
 author: ""G치bor Cs치rdi""
-date: ""2016-09-18""
+date: ""2016-09-22""
 output: rmarkdown::html_vignette
 vignette: >
   %\VignetteIndexEntry{Write R Documentation in Markdown}
@@ -17,7 +17,17 @@ Starting from version 6.0.0, roxygen supports markdown markup within most roxyge
 
 # Turning on markdown support
 
-Currently you have to turn on markdown formatting manually for each roxygen chunk. You can do this by using the `@md` tag anywhere in the chunk. In the future roxygen will provide a global switch that turns on markdown formatting for the whole package. (And also a `@noMd` to turn it off, optionally.)
+There are two ways to turn on markdown support for a package: globally, at the package level, and locally at the block level.
+
+To turn on markdown for the whole package, insert this entry into the `DESCRIPTION` file of the package:
+```
+Roxygen: list(markdown = TRUE)
+```
+The position of the entry in the file does not matter. After this, all Roxygen documentation will be parsed as markdown.
+
+Alternatively, you can use the `@md` tag to turn on markdown support for a single documentation chunk. This is a good option to write any new documentation for existing packages in markdown.
+
+There is also a new `@noMd` tag. Use this if you turned on markdown parsing globally, but need to avoid it for a single chunk. This tag is handy if the markdown parser interferes with more complex Rd syntax.
 
 Here is an example roxygen chunk that uses markdown.
 
@@ -166,7 +176,7 @@ The parser recognizes the markdown notation for embedded images. The image files
 
 # Roxygen and Rd tags *not* parsed as markdown
 
-Some of the roxygen tags are not parsed as markdown. Most of these are unlikely to contain text that needs markup, so this is not an important restriction. Tags without markdown support: `@aliases`, `@backref`, `@docType`, `@encoding`, `@evalRd`, `@example`, `@examples`, `@family`, `@inheritParams`, `@keywords`, `@method` `@name`, `@md`, `@noRd`, `@rdname`, `@rawRd`, `@usage`.
+Some of the roxygen tags are not parsed as markdown. Most of these are unlikely to contain text that needs markup, so this is not an important restriction. Tags without markdown support: `@aliases`, `@backref`, `@docType`, `@encoding`, `@evalRd`, `@example`, `@examples`, `@family`, `@inheritParams`, `@keywords`, `@method` `@name`, `@md`, `@noMd`, `@noRd`, `@rdname`, `@rawRd`, `@usage`.
 
 When mixing `Rd` and markdown notation, most `Rd` tags may contain markdown markup, the ones that can *not* are: `\acronym`, `\code`, `\command`, `\CRANpkg`, `\deqn`, `\doi`, `\dontrun`, `\dontshow`, `\donttest`, `\email`, `\env`, `\eqn`, `\figure`, `\file`, `\if`, `\ifelse`, `\kbd`, `\link`, `\linkS4class`, `\method`, `\newcommand`, `\option`, `\out`, `\packageAuthor`, `\packageDescription`, `\packageDESCRIPTION`, `\packageIndices`, `\packageMaintainer`, `\packageTitle`, `\pkg`, `\PR`, `\preformatted`, `\renewcommand`, `\S3method`, `\S4method`, `\samp`, `\special`, `\testonly`, `\url`, `\var`, `\verb`.
 "
r-lib,roxygen2,be633d737d9d543c383fbbed4edb3384650d7020,hadley,h.wickham@gmail.com,2016-09-21T18:53:52Z,hadley,h.wickham@gmail.com,2016-09-21T18:53:52Z,"Add parser for setClassUnion

Fixes #514",NEWS.md;R/object-from-call.R;tests/testthat/test-object-s4.R,False,True,True,False,19,1,20,"---FILE: NEWS.md---
@@ -1,5 +1,7 @@
 # roxygen2 5.0.1.9000
 
+* You can now document `setClassUnion()`s (#514).
+
 * New `@inheritDocParams` allows you to automatically generate parameter 
   documentation for `...` for the common case where you pass `...` on to 
   another function (#512). Because you often override some arguments, it 

---FILE: R/object-from-call.R---
@@ -93,6 +93,13 @@ parser_setClass <- function(call, env, block) {
   object(value)
 }
 
+parser_setClassUnion <- function(call, env, block) {
+  name <- as.character(call$name)
+  value <- methods::getClass(name, where = env)
+
+  object(value)
+}
+
 parser_setRefClass <- function(call, env, block) {
   name <- as.character(call$Class)
   value <- methods::getClass(name, where = env)

---FILE: tests/testthat/test-object-s4.R---
@@ -20,6 +20,16 @@ test_that(""class captured from assignment"", {
   expect_equal(out$object$alias, ""B"")
 })
 
+test_that(""class captured from setClassUnion"", {
+  out <- parse_text(""
+    #' Title
+    setClassUnion('numberish', c('numeric', 'logical'))
+  "")$blocks[[1]]
+
+  expect_is(out$object, ""s4class"")
+  expect_equal(out$object$alias, NULL)
+})
+
 test_that(""class captured from setRefClass"", {
   out <- parse_text(""
     #' Title
@@ -40,7 +50,6 @@ test_that(""class captured from assignment of setRefClass"", {
   expect_equal(out$object$alias, ""B"")
 })
 
-
 test_that(""setMethod equivalent to setReplaceMethod"", {
   out <- parse_text(""
     setGeneric('foo<-', function(x, value) standardGeneric('foo<-'))"
r-lib,roxygen2,ba70629ea094bbbcaf5a7de5a2fa867e511d7f6d,hadley,h.wickham@gmail.com,2016-09-21T18:48:20Z,hadley,h.wickham@gmail.com,2016-09-21T18:48:20Z,"Implement `@inheritDotParams`

Fixes #512",NAMESPACE;NEWS.md;R/field.R;R/rd-inherit.R;R/rd.R;R/topics.R;tests/testthat/test-Rd-inherit.R,False,True,True,False,103,2,105,"---FILE: NAMESPACE---
@@ -23,6 +23,7 @@ S3method(format,roxy_field_field)
 S3method(format,roxy_field_formals)
 S3method(format,roxy_field_format)
 S3method(format,roxy_field_inherit)
+S3method(format,roxy_field_inherit_dot_params)
 S3method(format,roxy_field_inherit_section)
 S3method(format,roxy_field_keyword)
 S3method(format,roxy_field_minidesc)
@@ -42,6 +43,7 @@ S3method(format,roxy_field_usage)
 S3method(format,roxy_field_value)
 S3method(merge,roxy_field)
 S3method(merge,roxy_field_inherit)
+S3method(merge,roxy_field_inherit_dot_params)
 S3method(merge,roxy_field_inherit_section)
 S3method(merge,roxy_field_minidesc)
 S3method(merge,roxy_field_reexport)

---FILE: NEWS.md---
@@ -1,5 +1,18 @@
 # roxygen2 5.0.1.9000
 
+* New `@inheritDocParams` allows you to automatically generate parameter 
+  documentation for `...` for the common case where you pass `...` on to 
+  another function (#512). Because you often override some arguments, it 
+  comes with a flexible specification for argument selection:
+  
+    * `@inheritDotParams foo` takes all parameters from `foo()`
+    * `@inheritDocParams a b e:h` takes parameters `a`, `b`, and all 
+       parameters between `e` and `h`
+    * `@inheritDocParams -x -y` takes all parameters except for `x` and `y`.
+    
+    The documentation generated is similar to the style used in `?plot`
+    and will eventually be incorporated in to RStudio's autocomplete.
+
 * New `@inherit` generalises `@inheritParams`, and allows to you inherit
   parameters, return, references, description, details, sections, and seealso. 
   The default `@inherit my_fun` will inherit all, or you can select specific 

---FILE: R/field.R---
@@ -303,6 +303,22 @@ merge.roxy_field_inherit_section <- function(x, y, ...) {
 }
 
 
+roxy_field_inherit_dot_params <- function(source, args) {
+  stopifnot(is.character(source), is.character(args))
+  stopifnot(length(source) == length(args))
+
+  roxy_field(""inherit_dot_params"", source = source, args = args)
+}
+
+#' @export
+format.roxy_field_inherit_dot_params <- format_null
+
+#' @export
+merge.roxy_field_inherit_dot_params <- function(x, y, ...) {
+  stopifnot(identical(class(x), class(y)))
+  roxy_field_inherit_section(c(x$source, y$source), c(x$args, y$args))
+}
+
 # Sections ----------------------------------------------------------------
 
 roxy_field_section <- function(title, content) {

---FILE: R/rd-inherit.R---
@@ -1,4 +1,4 @@
-topics_process_inherit <- function(topics) {
+topics_process_inherit <- function(topics, env) {
   inherits <- function(type) {
     function(x) x$inherits_from(type)
   }
@@ -15,6 +15,8 @@ topics_process_inherit <- function(topics) {
   topics$topo_apply(inherits(""sections""), inherit_sections)
 
   topics$topo_apply(inherits(""params""), inherit_params)
+  # Can't inherit ... into ... so can do in any order
+  topics$apply(inherit_dot_params, env = env)
 
   invisible()
 }
@@ -43,6 +45,39 @@ inherit_params <- function(topic, topics) {
   }
 }
 
+inherit_dot_params <- function(topic, topics, env) {
+  inheritors <- topic$get_field(""inherit_dot_params"")
+  if (is.null(inheritors))
+    return()
+
+  # Need to find formals for each source
+  funs <- lapply(inheritors$source, function(x) eval(parse(text = x), envir = env))
+  args <- Map(select_args_text, funs, inheritors$args)
+
+  # Then pull out the ones we need
+  docs <- lapply(inheritors$source, find_params, topics = topics)
+  arg_matches <- function(args, docs) {
+    doc_args <- str_split(names(docs), "", ?"")
+    match <- vapply(doc_args, function(x) x %in% args, logical(1))
+    docs[match]
+  }
+  docs_selected <- unlist(Map(arg_matches, args, docs))
+
+  # Build the arg string
+  from <- paste0(""\\code{"", inheritors$source, ""}"", collapse = "", "")
+  args <- paste0(""  \\item{"", names(docs_selected), ""}{"", docs_selected, ""}"",
+    collapse = ""\n"")
+
+  rd <- paste0(
+    ""Arguments passed on to "", from, ""\n"",
+    ""\\describe{\n"",
+    args, ""\n"",
+    ""}""
+  )
+  topic$add_simple_field(""param"", c(""..."" = rd))
+}
+
+
 get_documented_params <- function(topic, only_first = FALSE) {
   documented <- names(topic$get_field(""param"")$values)
   if (length(documented) > 0) {

---FILE: R/rd.R---
@@ -33,6 +33,7 @@ roclet_tags.roclet_rd <- function(x) {
     format = tag_markdown,
     inherit = tag_inherit,
     inheritParams = tag_value,
+    inheritDotParams = tag_two_part(""source"", ""args"", required = FALSE),
     inheritSection = tag_name_description,
     keywords = tag_value,
     method = tag_words(2, 2),
@@ -70,7 +71,7 @@ roclet_process.roclet_rd <- function(x, parsed, base_path) {
   }
   topics$drop_invalid()
   topics_process_family(topics)
-  topics_process_inherit(topics)
+  topics_process_inherit(topics, parsed$env)
   topics_fix_params_order(topics)
 
   topics$topics
@@ -273,6 +274,11 @@ topic_add_inherit <- function(topic, block) {
     topic$add_field(field)
   }
 
+  tags <- block_tags(block, ""inheritDotParams"")
+  for (tag in tags) {
+    field <- roxy_field_inherit_dot_params(tag$source, tag$args)
+    topic$add_field(field)
+  }
 }
 
 

---FILE: R/topics.R---
@@ -77,6 +77,13 @@ RoxyTopics <- R6::R6Class(""RoxyTopics"", public = list(
     invisible()
   },
 
+  apply = function(fun, ...) {
+    for (topic in self$topics) {
+      fun(topic, self, ...)
+    }
+    invisible()
+  },
+
   # Extract values for simple fields
   simple_values = function(field) {
     fields <- lapply(self$topics, function(rd) rd$get_field(field))

---FILE: tests/testthat/test-Rd-inherit.R---
@@ -410,3 +410,25 @@ test_that(""inherit params ... named \\dots"", {
   )
 
 })
+
+# inheritDotParams --------------------------------------------------------
+
+test_that(""can inherit all from single function"", {
+  out <- roc_proc_text(rd_roclet(), ""
+    #' Foo
+    #'
+    #' @param x x
+    #' @param y y
+    foo <- function(x, y) {}
+
+    #' Bar
+    #'
+    #' @inheritDotParams foo
+    bar <- function(...) {}
+  "")[[2]]
+
+  params <- out$get_field(""param"")$values
+  expect_named(params, ""..."")
+  expect_match(params, ""Arguments passed on to \\code{foo}"", fixed = TRUE)
+  expect_match(params, ""\\item{x}{x}"", fixed = TRUE)
+})"
r-lib,roxygen2,bb7d7de42b2ca42236f1703c662ba6300b231937,hadley,h.wickham@gmail.com,2016-09-21T13:56:43Z,hadley,h.wickham@gmail.com,2016-09-21T13:59:46Z,"Alias \dots to ... in more places

Fixes #504",NEWS.md;R/rd-inherit.R;tests/testthat/test-Rd-inherit.R,False,True,True,False,26,1,27,"---FILE: NEWS.md---
@@ -9,7 +9,8 @@
   a single section from another topic (#513).
 
 * `@inheritParams` now works recursively, so that you can inherit parameters
-  from a function that inherited its paramters from somewhere else. 
+  from a function that inherited its paramters from somewhere else.  It
+  also better handles `\dots` as an alias for `...` (#504).
 
 * Back references are now wrapped over multiple lines, if long
   (#493, @LiNk-NY).

---FILE: R/rd-inherit.R---
@@ -53,6 +53,7 @@ get_documented_params <- function(topic, only_first = FALSE) {
       documented <- unlist(documented)
   }
 
+  documented[documented == ""\\dots""] <- ""...""
   documented
 }
 

---FILE: tests/testthat/test-Rd-inherit.R---
@@ -387,3 +387,26 @@ test_that(""argument order with @inheritParam"", {
   expect_equal(get_tag(out[[""c1.Rd""]], ""param"")$values, c(x=""C"", y=""Y""))
   expect_equal(get_tag(out[[""c2.Rd""]], ""param"")$values, c(x=""C"", y=""Y""))
 })
+
+
+test_that(""inherit params ... named \\dots"", {
+  out <- roc_proc_text(rd_roclet(), ""
+    #' Foo
+    #'
+    #' @param x x
+    #' @param \\dots foo
+    foo <- function(x, ...) {}
+
+    #' Bar
+    #'
+    #' @inheritParams foo
+    #' @param \\dots bar
+    bar <- function(x=1, ...) {}
+  "")[[2]]
+
+  expect_equal(
+    out$get_field(""param"")$values,
+    c(x = ""x"", ""\\dots"" = ""bar"")
+  )
+
+})"
r-lib,roxygen2,7120d12c80982b271e178ef3055264e3ea2675a9,hadley,h.wickham@gmail.com,2016-09-20T18:46:14Z,hadley,h.wickham@gmail.com,2016-09-20T18:46:14Z,"Warn if roxygen2 out of date

Fixes #508",R/safety.R,False,True,True,False,7,4,11,"---FILE: R/safety.R---
@@ -39,11 +39,14 @@ made_by <- function(comment) {
 update_roxygen_version <- function(base_path) {
   desc_path <- file.path(base_path, ""DESCRIPTION"")
 
-  new <- as.character(utils::packageVersion(""roxygen2""))
-  old <- desc::desc_get(""RoxygenNote"", file = desc_path)[[1]]
+  cur <- as.character(utils::packageVersion(""roxygen2""))
+  prev <- desc::desc_get(""RoxygenNote"", file = desc_path)[[1]]
 
-  if (!identical(old, new)) {
+  if (!is.na(cur) && !is.na(prev) && package_version(cur) < package_version(prev)) {
+    warning(""Version of roxygen2 last used with this package is "", prev, "". "",
+      "" You only have version "", cur, call. = FALSE)
+  } else if (!identical(cur, prev)) {
     message(""Updating roxygen version in "", desc_path)
-    desc::desc_set(RoxygenNote = new, file = desc_path)
+    desc::desc_set(RoxygenNote = cur, file = desc_path)
   }
 }"
r-lib,roxygen2,e42b966a146c58479fe8d8a76364b4554e3c7b6e,hadley,h.wickham@gmail.com,2016-09-20T18:35:43Z,hadley,h.wickham@gmail.com,2016-09-20T18:35:49Z,"Inherit individual sections

Fixes #513",NAMESPACE;NEWS.md;R/field.R;R/rd-inherit.R;R/rd.R;R/topic.R;tests/testthat/test-Rd-inherit.R,False,True,True,False,83,1,84,"---FILE: NAMESPACE---
@@ -23,6 +23,7 @@ S3method(format,roxy_field_field)
 S3method(format,roxy_field_formals)
 S3method(format,roxy_field_format)
 S3method(format,roxy_field_inherit)
+S3method(format,roxy_field_inherit_section)
 S3method(format,roxy_field_keyword)
 S3method(format,roxy_field_minidesc)
 S3method(format,roxy_field_name)
@@ -41,6 +42,7 @@ S3method(format,roxy_field_usage)
 S3method(format,roxy_field_value)
 S3method(merge,roxy_field)
 S3method(merge,roxy_field_inherit)
+S3method(merge,roxy_field_inherit_section)
 S3method(merge,roxy_field_minidesc)
 S3method(merge,roxy_field_reexport)
 S3method(merge,roxy_field_section)

---FILE: NEWS.md---
@@ -5,6 +5,9 @@
   `@inherit my_fun` will inherit all, or you can select specific tags to 
   inherit with `@inherit my_fun return params` (#384).
 
+* New `@inheritSection fun title` allows you to inherit the contents of 
+  a single section from another topic (#513).
+
 * `@inheritParams` now works recursively, so that you can inherit parameters
   from a function that inherited its paramters from somewhere else. 
 

---FILE: R/field.R---
@@ -286,6 +286,23 @@ merge.roxy_field_inherit <- function(x, y, ...) {
 }
 
 
+roxy_field_inherit_section <- function(source, title) {
+  stopifnot(is.character(source), is.character(title))
+  stopifnot(length(source) == length(title))
+
+  roxy_field(""inherit_section"", source = source, title = title)
+}
+
+#' @export
+format.roxy_field_inherit_section <- format_null
+
+#' @export
+merge.roxy_field_inherit_section <- function(x, y, ...) {
+  stopifnot(identical(class(x), class(y)))
+  roxy_field_inherit_section(c(x$source, y$source), c(x$title, y$title))
+}
+
+
 # Sections ----------------------------------------------------------------
 
 roxy_field_section <- function(title, content) {

---FILE: R/rd-inherit.R---
@@ -9,6 +9,8 @@ topics_process_inherit <- function(topics) {
   topics$topo_apply(inherits(""details""), inherit_field, ""details"")
   topics$topo_apply(inherits(""seealso""), inherit_field, ""seealso"")
 
+  # First inherit individual sections, then all sections.
+  topics$topo_apply(function(x) x$inherits_section_from(), inherit_section)
   topics$topo_apply(inherits(""sections""), inherit_sections)
 
   topics$topo_apply(inherits(""params""), inherit_params)
@@ -110,6 +112,30 @@ inherit_sections <- function(topic, topics) {
   }
 }
 
+inherit_section <- function(topic, topics) {
+  sections <- topic$get_field(""inherit_section"")
+  sources <- sections$source
+  titles <- sections$title
+
+  for (i in seq_along(sources)) {
+    inheritor <- check_topic(sources[[i]], topics)
+    if (is.null(inheritor)) {
+      return()
+    }
+
+    new_section <- find_sections(inheritor)
+    selected <- new_section$title %in% titles[[i]]
+
+    if (sum(selected) != 1) {
+      warning(""Can't find section '"", titles[[i]], ""'"", call. = FALSE)
+    }
+
+    topic$add_field(
+      roxy_field_section(new_section$title[selected], new_section$content[selected])
+    )
+  }
+}
+
 find_sections <- function(topic) {
   if (inherits(topic, ""Rd"")) {
     tag <- get_tags(topic, ""\\section"")

---FILE: R/rd.R---
@@ -33,6 +33,7 @@ roclet_tags.roclet_rd <- function(x) {
     format = tag_markdown,
     inherit = tag_inherit,
     inheritParams = tag_value,
+    inheritSection = tag_name_description,
     keywords = tag_value,
     method = tag_words(2, 2),
     name = tag_value,
@@ -265,6 +266,13 @@ topic_add_inherit <- function(topic, block) {
     field <- roxy_field_inherit(tag, list(""params""))
     topic$add_field(field)
   }
+
+  tags <- block_tags(block, ""inheritSection"")
+  for (tag in tags) {
+    field <- roxy_field_inherit_section(tag$name, tag$description)
+    topic$add_field(field)
+  }
+
 }
 
 

---FILE: R/topic.R---
@@ -48,6 +48,14 @@ RoxyTopic <- R6::R6Class(""RoxyTopic"", public = list(
     sources
   },
 
+  inherits_section_from = function() {
+    if (!self$has_field(""inherit_section"")) {
+      return(character())
+    }
+
+    self$get_field(""inherit_section"")$source
+  },
+
   # Ensures that each type of name (as given by its name), only appears
   # once in self$fields
   add_field = function(field, overwrite = FALSE) {

---FILE: tests/testthat/test-Rd-inherit.R---
@@ -92,7 +92,6 @@ test_that(""can inherit return value from external function"", {
 
 # Inherit seealso ---------------------------------------------------------
 
-
 test_that(""can inherit return values from roxygen topic"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' A.
@@ -191,6 +190,25 @@ test_that(""inherits missing sections"", {
   expect_equal(section$content, c(""2"", ""1""))
 })
 
+test_that(""can inherit single section"", {
+    out <- roc_proc_text(rd_roclet(), ""
+    #' A.
+    #' @section A:1
+    #' @section B:1
+    a <- function(x) {}
+
+    #' D
+    #'
+    #' @inheritSection a B
+    b <- function(y) {}
+  "")[[2]]
+
+  section <- out$get_field(""section"")
+  expect_equal(section$title, ""B"")
+  expect_equal(section$content, ""1"")
+})
+
+
 test_that(""can find section in existing docs"", {
   out <- find_sections(find_topic(""base::attach""))
 "
r-lib,roxygen2,c5f3a3a7a68f4940c0445860d67bdc34087e215b,G치bor Cs치rdi,csardi.gabor@gmail.com,2016-09-08T23:35:45Z,Hadley Wickham,h.wickham@gmail.com,2016-09-08T23:35:45Z,"Markdown: <...> -> \url{...}, not \href{...}{...} (#501)

Fixes #500",R/markdown.R;man/namespace_roclet.Rd;tests/testthat/test-rd-markdown.R,False,True,True,False,6,4,10,"---FILE: R/markdown.R---
@@ -173,10 +173,10 @@ markdown_tags <- list(
 
     if (!is.null(link)) {
       link
-    } else if (dest == """") {
-      list(""\\url{"", xml_contents(xml), ""}"")
+    } else if (dest == """" || dest == xml_text(xml)) {
+      list(""\\url{"", xml_text(xml), ""}"")
     } else {
-      list(""\\href{"", dest, ""}{"", xml_contents(xml), ""}"")
+      list(""\\href{"", dest, ""}{"", xml_text(xml), ""}"")
     }
   },
 

---FILE: man/namespace_roclet.Rd---
@@ -17,7 +17,7 @@ namespace_roclet()
 \description{
 This roclet automates the production of a \code{NAMESPACE} file,
 see Writing R Extensions.
-(\href{http://cran.r-project.org/doc/manuals/R-exts.pdf}{http://cran.r-project.org/doc/manuals/R-exts.pdf}) for details.
+(\url{http://cran.r-project.org/doc/manuals/R-exts.pdf}) for details.
 }
 \seealso{
 \code{vignette(""namespace"", package = ""roxygen2"")}

---FILE: tests/testthat/test-rd-markdown.R---
@@ -290,13 +290,15 @@ test_that(""markdown links are converted"", {
     #'
     #' Description, see [http://acme.com]() for details.
     #' And here is a named link: [igraph](http://igraph.org).
+    #' Here is another kind of link: <https://log.r-hub.io>.
     #' @md
     foo <- function() {}"")[[1]]
   out2 <- roc_proc_text(roc, ""
     #' Title
     #'
     #' Description, see \\url{http://acme.com} for details.
     #' And here is a named link: \\href{http://igraph.org}{igraph}.
+    #' Here is another kind of link: \\url{https://log.r-hub.io}.
     foo <- function() {}"")[[1]]
   expect_equal(get_tag(out1, ""description""), get_tag(out2, ""description""))
 })"
r-lib,roxygen2,bbe66b9503d65c29ac1f75060f5bb992a6d786e2,hadley,h.wickham@gmail.com,2016-08-31T14:26:08Z,hadley,h.wickham@gmail.com,2016-08-31T14:26:08Z,"Tidy up rd input/output utils

Fixes #497",DESCRIPTION;NAMESPACE;R/rd-parse.R;R/utils-rd.R,False,True,True,False,44,51,95,"---FILE: DESCRIPTION---
@@ -11,9 +11,9 @@ Authors@R: c(
     person(""Manuel"", ""Eugster"", role = c(""aut"", ""cph"")),
     person(""RStudio"", role = ""cph"")
     )
-Depends: 
+Depends:
     R (>= 3.0.2)
-Imports: 
+Imports:
     stringr (>= 0.5),
     stringi,
     brew,
@@ -24,15 +24,16 @@ Imports:
     desc,
     commonmark,
     xml2
-Suggests: 
+Suggests:
     testthat (>= 0.8.0),
     knitr,
     devtools,
     rmarkdown,
     covr
 VignetteBuilder: knitr
 LinkingTo: Rcpp
-Collate:     'RcppExports.R'
+Collate:
+    'RcppExports.R'
     'tag-parsers.R'
     'tag-registry.R'
     'collate.R'
@@ -50,10 +51,8 @@ Collate:     'RcppExports.R'
     'object.R'
     'parse.R'
     'rd-describe-in.R'
-    'rd-escape.R'
     'rd-family.R'
     'rd-params.R'
-    'rd-parse.R'
     'rd-template.R'
     'rd.R'
     'roclet.R'
@@ -65,6 +64,7 @@ Collate:     'RcppExports.R'
     'topic.R'
     'topo-sort.R'
     'util-locale.R'
+    'utils-rd.R'
     'utils.R'
     'vignette.R'
 RoxygenNote: 5.0.1.9000

---FILE: NAMESPACE---
@@ -10,8 +10,6 @@ S3method(default_export,s3method)
 S3method(default_export,s4class)
 S3method(default_export,s4generic)
 S3method(default_export,s4method)
-S3method(escape,character)
-S3method(escape,rd)
 S3method(format,roxy_field)
 S3method(format,roxy_field_alias)
 S3method(format,roxy_field_author)

---FILE: R/rd-parse.R---
@@ -1,32 +0,0 @@
-get_rd <- function(topic, package = NULL) {
-  help_call <- substitute(help(t, p), list(t = topic, p = package))
-  top <- eval(help_call)
-  if (length(top) == 0) return(NULL)
-
-  internal_f(""utils"", "".getHelpFile"")(top)
-}
-
-get_tags <- function(rd, tag) {
-  rd_tag <- function(x) attr(x, ""Rd_tag"")
-
-  Filter(function(x) rd_tag(x) == tag, rd)
-}
-
-rd2rd <- function(x) {
-  chr <- internal_f(""tools"", ""as.character.Rd"")(x)
-  paste(unlist(chr), collapse = """")
-}
-
-# rd_arguments(get_rd(""mean""))
-rd_arguments <- function(rd) {
-  arguments <- get_tags(rd, ""\\arguments"")[[1]]
-  items <- get_tags(arguments, ""\\item"")
-
-  values <- lapply(items, function(x) rd2rd(x[[2]]))
-  # Everything else seems to be escaped already, apart from comments
-  values <- lapply(values, function(x) gsub(""%"", ""\\%"", x, fixed = TRUE))
-
-  params <- vapply(items, function(x) rd2rd(x[[1]]), character(1))
-
-  setNames(values, params)
-}

---FILE: R/utils-rd.R---
@@ -1,11 +1,13 @@
+# Output ------------------------------------------------------------------
+
 # A simple object to represent rd escaped text.
 rd <- function(x) {
   structure(x, class = ""rd"")
 }
 
 #' @export
 c.rd <- function(...) {
-  rd(unlist(lapply(list(...), escape), use.names = FALSE))
+  rd(NextMethod())
 }
 
 #' @export
@@ -15,9 +17,7 @@ print.rd <- function(x, ...) {
 }
 
 escape <- function(x) UseMethod(""escape"")
-#' @export
 escape.rd <- function(x) x
-#' @export
 escape.character <- function(x) {
   # wrap_string uses \u{A0}, the unicode non-breaking space, which
   # is not necessarily valid in windows locales. useBytes is a quick
@@ -33,14 +33,6 @@ escape_examples <- function(x) {
   gsub(""\\\\dont"", ""\\dont"", escape(x))
 }
 
-escape_preformatted <- function(x) {
-  x1 <- escape(x)
-  x2 <- gsub(""{"", ""\\{"", x1, fixed = TRUE)
-  x3 <- gsub(""}"", ""\\}"", x2, fixed = TRUE)
-
-  rd(x3)
-}
-
 # Works like paste, but automatically escapes all input variables,
 # but not literal strings
 build_rd <- function(..., collapse = NULL, sep = """") {
@@ -72,3 +64,38 @@ rd_macro <- function(field, ..., space = FALSE) {
 
   paste0(""\\"", field, paste0(""{"", values, ""}"", collapse = """"), ""\n"")
 }
+
+
+# Input -------------------------------------------------------------------
+
+get_rd <- function(topic, package = NULL) {
+  help_call <- substitute(help(t, p), list(t = topic, p = package))
+  top <- eval(help_call)
+  if (length(top) == 0) return(NULL)
+
+  internal_f(""utils"", "".getHelpFile"")(top)
+}
+
+# rd_arguments(get_rd(""mean""))
+rd_arguments <- function(rd) {
+  arguments <- get_tags(rd, ""\\arguments"")[[1]]
+  items <- get_tags(arguments, ""\\item"")
+
+  values <- vapply(items, function(x) rd2text(x[[2]]), character(1))
+  params <- vapply(items, function(x) rd2text(x[[1]]), character(1))
+
+  setNames(values, params)
+}
+
+get_tags <- function(rd, tag) {
+  Filter(function(x) identical(attr(x, ""Rd_tag""), tag), rd)
+}
+
+rd2text <- function(x) {
+  chr <- as.character(structure(x, class = ""Rd""))
+  str <- paste(chr, collapse = """")
+
+  # re-escape comments
+  gsub(""%"", ""\\%"", str, fixed = TRUE)
+}
+"
r-lib,roxygen2,3b4ff989ea304635643777bca0c47df4062da703,hadley,h.wickham@gmail.com,2016-08-30T20:39:07Z,hadley,h.wickham@gmail.com,2016-08-30T20:39:07Z,Fix think-o,R/rd.R,False,True,True,False,1,1,2,"---FILE: R/rd.R---
@@ -260,7 +260,7 @@ topic_add_value <- function(topic, block) {
   tags <- block_tags(block, ""return"")
 
   for (tag in tags) {
-    topic$add_field(roxy_field(""value"", topic))
+    topic$add_field(roxy_field(""value"", tag))
   }
 }
 "
r-lib,roxygen2,b1644e98be0576201ecb68386cc2306a98c9947b,hadley,h.wickham@gmail.com,2016-08-30T18:25:02Z,hadley,h.wickham@gmail.com,2016-08-30T18:25:02Z,"Extract out topic_add_eval_rd

And improve error handling",R/rd.R;tests/testthat/test-raw.R,False,True,True,False,27,6,33,"---FILE: R/rd.R---
@@ -102,6 +102,7 @@ block_to_rd <- function(block, base_path, env) {
 
   topic_add_backref(rd, block)
   topic_add_doc_type(rd, block)
+  topic_add_eval_rd(rd, block, env)
   topic_add_examples(rd, block, base_path)
   topic_add_fields(rd, block)
   topic_add_methods(rd, block)
@@ -110,11 +111,6 @@ block_to_rd <- function(block, base_path, env) {
   topic_add_slots(rd, block)
   topic_add_usage(rd, block)
 
-  rd$add(process_tag(block, ""evalRd"", function(tag, param) {
-    expr <- parse(text = param)
-    out <- eval(expr, envir = env)
-    roxy_field(""rawRd"", as.character(out))
-  }))
   rd$add(process_tag(block, ""return"", function(tag, param) {
     roxy_field(""value"", param)
   }))
@@ -317,6 +313,20 @@ topic_add_examples <- function(topic, block, base_path) {
   }
 }
 
+topic_add_eval_rd <- function(topic, block, env) {
+  tags <- block_tags(block, ""evalRd"")
+
+  for (tag in tags) {
+    tryCatch({
+      expr <- parse(text = tag)
+      out <- eval(expr, envir = env)
+      topic$add_field(roxy_field(""rawRd"", as.character(out)))
+    }, error = function(e) {
+      block_warning(block, ""@evalRd failed with error: "", e$message)
+    })
+  }
+}
+
 process_section <- function(key, value, block) {
   pieces <- str_split_fixed(value, "":"", n = 2)[1, ]
 

---FILE: tests/testthat/test-raw.R---
@@ -22,7 +22,18 @@ test_that(""evalRd must be valid code"", {
   )
 })
 
-test_that(""rawRd inserted unchanged"", {
+test_that(""error-ful evalRd generates warning"", {
+  expect_warning(
+    roc_proc_text(rd_roclet(), ""
+      #' @evalRd stop('!')
+      #' @name a
+      #' @title a
+      NULL""),
+    ""@evalRd failed with error""
+  )
+})
+
+test_that(""evalRd inserted unchanged"", {
   out <- roc_proc_text(rd_roclet(), ""
     z <- 10
     #' @evalRd z * 2"
r-lib,roxygen2,3dfd4b8b66be82a2bc407b311d4653be7ef343b6,G치bor Cs치rdi,csardi.gabor@gmail.com,2016-08-29T22:44:04Z,Hadley Wickham,h.wickham@gmail.com,2016-08-29T22:44:04Z,"Markdown, take 2 (#496)

* Parse markdown within fields

* If \preformatted, then keep leading whitespace

Leading whitespace is usually removed by commonmark,
unless we are in ```, or in a list, etc.

* Support Markdown style links to functions, etc.

* Fix NEWS.md file

* Test case for Markdown & Rd interplay

This breaks currently, but it should pass once we ignore
\preformatted when parsing markdown.

* @keywords is not parsed as markdown

* Escape fragile Rd tags before markdown processing

* Support @noMd

* Fix NEWS file, move new entry up

* @method is not parsed as markdown

* Fix for inline_html -> html_inline commonmark tag name change

* Fix list items without contents

* Don't let commonmark unescape \\%, \\_, \\$

We double-escape them before running the markdown parser.

* Markdown: don't escape leading ws, \preformatted is protected

Ideally we should keep leading ws in general, because that's what
Roxygen currently does. But it is also tricky, because the
ws might be followed by an ordered or unordered list, or a >
for a block quote, etc.

The parsed XML does not have the ws any more, so we need to
handle it before the markdown run.

* Markdown opt-in instead of opt-out

So we have an @md tag now, instead of @noMd.

* Test that markdown is off by default

* Remove two skipped markdown tests

We'll add them back once we'll have a @noMd tag.

* Need to import methods::is

* Update internal markdown docs",DESCRIPTION;NAMESPACE;NEWS.md;R/RcppExports.R;R/markdown-escaping.R;R/markdown.R;R/parse-preref.R;R/roclet-rd.R;man/double_escape_md.Rd;man/markdown-internals.Rd;src/RcppExports.cpp;src/isComplete.cpp;tests/testthat/test-markdown-escaping.R;tests/testthat/test-markdown.R;vignettes/markdown.R;vignettes/markdown.Rmd;vignettes/markdown.html;vignettes/markdown.md,True,True,True,False,1491,18,1509,"---FILE: DESCRIPTION---
@@ -21,7 +21,9 @@ Imports:
     methods,
     Rcpp (>= 0.11.0),
     R6,
-    desc
+    desc,
+    commonmark,
+    xml2
 Suggests:
     testthat (>= 0.8.0),
     knitr,
@@ -37,6 +39,8 @@ Collate:
     'default-data-format.R'
     'family.R'
     'inherit-params.R'
+    'markdown-escaping.R'
+    'markdown.R'
     'minidesc.R'
     'object-defaults.R'
     'object-from-call.R'

---FILE: NAMESPACE---
@@ -107,5 +107,14 @@ export(update_collate)
 export(vignette_roclet)
 import(stringr)
 importFrom(Rcpp,sourceCpp)
+importFrom(commonmark,markdown_xml)
+importFrom(methods,is)
 importFrom(stats,setNames)
+importFrom(xml2,read_xml)
+importFrom(xml2,xml_attr)
+importFrom(xml2,xml_children)
+importFrom(xml2,xml_contents)
+importFrom(xml2,xml_name)
+importFrom(xml2,xml_text)
+importFrom(xml2,xml_type)
 useDynLib(roxygen2)

---FILE: NEWS.md---
@@ -36,6 +36,12 @@
 
 # roxygen2 5.0.1
 
+* Most fields can now be written using Markdown markup instead of the
+  traditional Rd language. See the 'markdown' vignette for details
+  (#364, #431), by @gaborcsardi
+
+# roxygen2 5.0.1
+
 * Use `ls()`, not `names()` to list elements of environment: fixes R 3.1.0
   incompatibility (#422, @kevinushey).
 

---FILE: R/RcppExports.R---
@@ -1,6 +1,10 @@
 # This file was generated by Rcpp::compileAttributes
 # Generator token: 10BE3573-1514-4C36-9D1C-5A225CD40393
 
+findEndOfTag <- function(string, is_code = FALSE) {
+    .Call('roxygen2_findEndOfTag', PACKAGE = 'roxygen2', string, is_code)
+}
+
 rdComplete <- function(string, is_code = FALSE) {
     .Call('roxygen2_rdComplete', PACKAGE = 'roxygen2', string, is_code)
 }

---FILE: R/markdown-escaping.R---
@@ -0,0 +1,251 @@
+
+#' Escape Rd markup, to avoid interpreting it as markdown
+#'
+#' This is needed, if we want to stay compatible with
+#' existing markup, even if markdown mode is switched on.
+#' Fragile Rd tags (tags that may contain markup that
+#' can be picked up by the markdown parser), are replaced
+#' by placeholders. After the markdown to Rd conversion
+#' is done, the original text is put back in place of the
+#' placeholders.
+#'
+#' The list of protected Rd tags is in \code{escaped_for_md}.
+#'
+#' Some Rd macros are treated specially: \itemize{
+#' \item For \code{if}, markdown is only allowed in the
+#'   second argument.
+#' \item For \code{ifelse} markdown is allowed in the
+#'   second and third arguments.
+#' }
+#'
+#' See also \code{roclet-rd.R} for the list of tags that
+#' uses the markdown-enabled parser. Some tags, e.g.
+#' \code{@aliases}, \code{@backref}, etc. only use the
+#' standard Roxygen parser.
+#'
+#' @param text Input text. Potentially contains Rd and/or
+#'   markdown markup.
+#' @return For \code{escape_rd_for_md}:
+#'   A \dQuote{safe} version of the input text, where
+#'   each fragile Rd tag is replaced by a placeholder. The
+#'   original text is added as an attribute for each placeholder.
+#'
+#' @rdname markdown-internals
+#' @keywords internal
+
+escape_rd_for_md <- function(text) {
+  rd_tags <- find_fragile_rd_tags(text, escaped_for_md)
+  protected <- protect_rd_tags(text, rd_tags)
+  double_escape_md(protected)
+}
+
+escaped_for_md <- paste0(""\\"", c(
+  ""acronym"", ""code"", ""command"", ""CRANpkg"", ""deqn"", ""doi"", ""dontrun"",
+  ""dontshow"", ""donttest"", ""email"", ""env"", ""eqn"", ""figure"", ""file"",
+  ""if"", ""ifelse"", ""kbd"", ""link"", ""linkS4class"", ""method"",
+  ""newcommand"", ""option"", ""out"", ""packageAuthor"",
+  ""packageDescription"", ""packageDESCRIPTION"", ""packageIndices"",
+  ""packageMaintainer"", ""packageTitle"", ""pkg"", ""PR"", ""preformatted"",
+  ""renewcommand"", ""S3method"", ""S4method"", ""samp"", ""special"",
+  ""testonly"", ""url"", ""var"", ""verb""
+))
+
+#' The pair of \code{\link{escape_rd_for_md}}.
+#'
+#' It puts back the protected fragile Rd commands into
+#' the text after the markdown parsing.
+#'
+#' @param rd_text The markdown parsed and interpreted text.
+#' @param esc_text The original escaped text from
+#'   \code{\link{escape_rd_for_md}}.
+#' @return For \code{unescape_rd_for_md}: Rd text.
+#'
+#' @rdname markdown-internals
+#' @keywords internal
+
+unescape_rd_for_md <- function(rd_text, esc_text) {
+  id <- attr(esc_text, ""roxygen-markdown-subst"")$id
+  tags <- attr(esc_text, ""roxygen-markdown-subst"")$tags
+
+  for (i in seq_len(nrow(tags))) {
+    ph <- paste0(id, ""-"", i, ""-"")
+    rd_text <- sub(ph, tags$text[i], rd_text, fixed = TRUE)
+  }
+
+  rd_text
+}
+
+#' Find all fragile tags (int the supplied list) in the text
+#'
+#' Ignore the tags that are embedded into a fragile tag.
+#'
+#' @param text Input text, character scalar.
+#' @param fragile Character vector of fragile tags to find.
+#' @return Data frame of fragile tags, with columns:
+#'   \code{tag}, \code{start}, \code{end}, \code{argend},
+#'   \code{text}.
+#'
+#' @noRd
+
+find_fragile_rd_tags <- function(text, fragile) {
+  tags <- find_all_rd_tags(text)
+  ftags <- tags[ tags$tag %in% fragile, ]
+
+  ## Remove embedded ones
+  keep <- vapply(
+    seq_len(nrow(ftags)),
+    function(i) {
+      sum(ftags$start <= ftags$start[i] &
+            ftags$argend >= ftags$argend[i]) == 1
+    },
+    TRUE
+  )
+
+  ftags <- ftags[keep, ]
+
+  if (nrow(ftags)) {
+    ftags$text <- str_sub(text, ftags$start, ftags$argend)
+  }
+
+  ftags
+}
+
+#' Find all (complete) Rd tags in a string
+#'
+#' Complete means that we include the argument(s) as well.
+#'
+#' @param text Input text, character scalar.
+#'
+#' @noRd
+
+find_all_rd_tags <- function(text) {
+
+  text_len <- nchar(text)
+
+  ## Find the tag names
+  tags <- find_all_tag_names(text)
+
+  ## Find the end of the argument list for each tag. Note that
+  ## tags might be embedded into the arguments of other tags.
+  tags$argend <- vapply(
+    seq_len(nrow(tags)),
+    function(i) {
+      tag_plus <- str_sub(text, tags$end[i], text_len)
+      findEndOfTag(tag_plus, is_code = FALSE) + tags$end[i]
+    },
+    1L
+  )
+
+  tags
+}
+
+#' Find all tag names in a string
+#'
+#' Note that we also protect these tags within code, strings
+#' and comments, for now. We'll see if this causes any
+#' problems.
+#'
+#' @param text Input text, scalar.
+#' @return Data frame, with columns: \code{tag}, \code{start},
+#'   \code{end}.
+#'
+#' @noRd
+
+find_all_tag_names <- function(text) {
+  ## Find the tags without arguments first
+  tag_pos <- str_locate_all(text, ""\\\\[a-zA-Z][a-zA-Z0-9]*"")[[1]]
+
+  data.frame(
+    stringsAsFactors = FALSE,
+    tag = str_sub(text, tag_pos[, ""start""], tag_pos[, ""end""]),
+    as.data.frame(tag_pos)
+  )
+}
+
+#' Replace fragile Rd tags with placeholders
+#'
+#' @param text The text, character scalar.
+#' @param rd_tags Fragile Rd tags, in a data frame,
+#'   as returned by \code{find_fragile_rd_tags}.
+#' @return Text, after the substitution. The original
+#'   text is added as an attribute.
+#'
+#' @noRd
+
+protect_rd_tags <- function(text, rd_tags) {
+  id <- make_random_string()
+
+  text <- str_sub_same(text, rd_tags, id)
+
+  attr(text, ""roxygen-markdown-subst"") <-
+    list(tags = rd_tags, id = id)
+
+  text
+}
+
+#' Replace parts of the same string
+#'
+#' It assumes that the intervals to be replaced do not
+#' overlap. Gives an error otherwise.
+#'
+#' @param str String scalar.
+#' @param repl Data frame with columns: \code{start}, \code{end},
+#'   \code{argend}, \code{text}.
+#' @param id Placeholder string.
+#' @return Input string with the replacements performed.
+#'   Note that all replacements are performed in parallel,
+#'   at least conceptually.
+#'
+#' @noRd
+
+str_sub_same <- function(str, repl, id) {
+  repl <- repl[ order(repl$start), ]
+
+  if (is.unsorted(repl$end) || is.unsorted(repl$argend)) {
+    stop(""Replacement intervals must not overlap"")
+  }
+
+  for (i in seq_len(nrow(repl))) {
+    ## The trailing - is needed, to distinguish between -1 and -10
+    new_text <- paste0(id, ""-"", i, ""-"")
+    str_sub(str, repl$start[i], repl$argend[i]) <- new_text
+
+    ## Need to shift other coordinates (we shift everything,
+    ## it is just simpler).
+    inc <- nchar(new_text) - (repl$argend[i] - repl$start[i] + 1)
+    repl$start <- repl$start + inc
+    repl$end <- repl$end + inc
+    repl$argend <- repl$argend + inc
+  }
+
+  str
+}
+
+#' Make a random string
+#'
+#' We use this as the placeholder, to make sure that the
+#' placeholder does not appear in the text.
+#'
+#' @return String scalar
+#'
+#' @noRd
+
+make_random_string <- function(length = 32) {
+  paste(
+    sample(c(LETTERS, letters, 0:9), length, replace = TRUE),
+    collapse = """"
+  )
+}
+
+#' Escape \\% and \\$ and \\_ once more, because commonmark
+#' removes the escaping. We do this everywhere currently.
+#'
+#' @param text Input text.
+#' @return Double-escaped text.
+
+double_escape_md <- function(text) {
+  text <- gsub(""\\%"", ""\\\\%"", text, fixed = TRUE)
+  text <- gsub(""\\_"", ""\\\\_"", text, fixed = TRUE)
+  text <- gsub(""\\$"", ""\\\\$"", text, fixed = TRUE)
+  text
+}

---FILE: R/markdown.R---
@@ -0,0 +1,258 @@
+
+markdown_on <- function(value = NULL) {
+  if (! is.null(value)) {
+    assign(""markdown-support"", isTRUE(value), envir = tags)
+  }
+  return(isTRUE(tags$`markdown-support`))
+}
+
+restricted_markdown <- function(rest) {
+  markdown(rest, markdown_tags_restricted)
+}
+
+full_markdown <- function(rest) {
+  markdown(rest, markdown_tags)
+}
+
+#' @importFrom commonmark markdown_xml
+#' @importFrom xml2 read_xml
+
+markdown <- function(text, markdown_tags) {
+  if (!markdown_on()) return(text)
+  esc_text <- escape_rd_for_md(text)
+  md <- markdown_xml(esc_text, hardbreaks = TRUE)
+  xml <- read_xml(md)
+  rd_text <- str_trim(markdown_rparse(xml, markdown_tags))
+  unescape_rd_for_md(rd_text, esc_text)
+}
+
+#' @importFrom xml2 xml_name xml_type xml_text xml_contents xml_attr
+#'   xml_children
+#' @importFrom methods is
+
+markdown_rparse <- function(xml, markdown_tags) {
+
+  ## We have a string, a list of things, or XML stuff
+
+  ## Strings are simply returned
+  if (is.character(xml)) return(paste(xml, collapse = """"))
+
+  ## List is iterated over
+  if (is(xml, ""list"")) {
+    return(paste(vapply(xml, markdown_rparse, """", markdown_tags = markdown_tags),
+                 collapse = """"))
+  }
+
+  ## Otherwise it is XML stuff, node set
+  if (is(xml, ""xml_nodeset"")) {
+    return(paste(vapply(xml, markdown_rparse, """", markdown_tags = markdown_tags),
+                 collapse = """"))
+  }
+
+  ## text node, only keep if not entirely whitespace
+  if (is(xml, ""xml_node"") && xml_type(xml) == ""text"") {
+    return(ws_to_empty(xml_text(xml)))
+  }
+
+  ## generic node
+  if (is(xml, ""xml_node"") && xml_type(xml) == ""element"") {
+    return(markdown_rparse(markdown_tags[[ xml_name(xml) ]](xml), markdown_tags = markdown_tags))
+  }
+
+  warning(""Unknown xml object"")
+}
+
+markdown_tags <- list(
+
+  unknown = function(xml) {
+    ## Just ignore the tag, keep the contents
+    xml_contents(xml)
+  },
+
+  document = function(xml) {
+    ## Keep the contents only, tag does nothing
+    xml_contents(xml)
+  },
+
+  block_quote = function(xml) {
+    ## Cannot really format this in Rd, so we just leave it
+    xml_contents(xml)
+  },
+
+  list = function(xml) {
+    ## A list, either bulleted or numbered
+    type <- xml_attr(xml, ""type"")
+    if (type == ""ordered"") {
+      list(""\n\\enumerate{"", xml_contents(xml), ""\n}"")
+    } else {
+      list(""\n\\itemize{"", xml_contents(xml), ""\n}"")
+    }
+  },
+
+  item = function(xml) {
+    ## A single item within a list. We remove the first paragraph
+    ## tag, to avoid an empty line at the beginning of the first item.
+    cnts <- xml_children(xml)
+    if (length(cnts) == 0) {
+      cnts <- """"
+    } else if (xml_name(cnts[[1]]) == ""paragraph"") {
+      cnts <- list(xml_contents(cnts[[1]]), cnts[-1])
+    }
+    list(""\n\\item "", cnts)
+  },
+
+  code_block = function(xml) {
+    ## Large block of code
+    list(""\\preformatted{"", xml_contents(xml), ""}"")
+  },
+
+  html = function(xml) {
+    ## Not sure what to do with this, we'll just leave it
+    xml_contents(xml)
+  },
+
+  paragraph = function(xml) {
+    ## Paragraph
+    list(""\n\n"", xml_contents(xml))
+  },
+
+  header = function(xml) {
+    ## Not sure what this is, ignore it for now.
+    xml_contents(xml)
+  },
+
+  hrule = function(xml) {
+    ## We cannot have horizontal rules, will just start a new
+    ## paragraph instead.
+    ""\n\n""
+  },
+
+  text = function(xml) {
+    ## Just ordinary text, leave it as it is.
+    xml_text(xml)
+  },
+
+  softbreak = function(xml) {
+    ## Inserted line break (?).
+    ""\n""
+  },
+
+  linebreak = function(xml) {
+    ## Original line break (?).
+    ""\n""
+  },
+
+  code = function(xml) {
+    list(""\\code{"", xml_contents(xml), ""}"")
+  },
+
+  html_inline = function(xml) {
+    ## Will just ignore this for now.
+    xml_contents(xml)
+  },
+
+  emph = function(xml) {
+    ## Emphasized text.
+    list(""\\emph{"", xml_contents(xml), ""}"")
+  },
+
+  strong = function(xml) {
+    ## Bold text.
+    list(""\\strong{"", xml_contents(xml), ""}"")
+  },
+
+  link = function(xml) {
+    ## Hyperlink, this can also be a link to a function
+    dest <- xml_attr(xml, ""destination"")
+    contents <- xml_contents(xml)
+
+    link <- parse_link(dest, contents)
+
+    if (!is.null(link)) {
+      link
+    } else if (dest == """") {
+      list(""\\url{"", xml_contents(xml), ""}"")
+    } else {
+      list(""\\href{"", dest, ""}{"", xml_contents(xml), ""}"")
+    }
+  },
+
+  image = function(xml) {
+    dest <- xml_attr(xml, ""destination"")
+    title <- xml_attr(xml, ""title"")
+    paste0(""\\figure{"", dest, ""}{"", title, ""}"")
+  }
+
+)
+
+markdown_tags_restricted <- markdown_tags
+
+ws_to_empty <- function(x) {
+  sub(""^\\s*$"", """", x)
+}
+
+## Parse a MarkDown link, to see if we should create an Rd link
+##
+## * [](::function) becomes \code{\link{function}}
+## * [](pkg::function) becomes \code{\link[pkg]{function}}
+## * [name](::=dest) becomes \link[=dest]{name}
+## * [name](pkg::bar) becomes \link[pkg:bar]{name}
+##
+## S3/S4 classes are also supported
+## * [terms](::=terms.object) becomes \link[=terms.object]{terms}
+## * [abc](::=abc-class) becomes \link[=abc-class]{abc}
+##
+## These actually do not require any special treatment from the
+## parser, they are included in the four cases above.
+
+parse_link <- function(destination, contents) {
+
+  ## destination must contain :: exactly once, otherwise it is not an Rd link
+  if (!contains_once(destination, ""::"", fixed = TRUE)) return(NULL)
+
+  ## if contents is a `code tag`, then we need to move this outside
+  ## of the link, Rd does not like \link{\code{}}, only \code{\link{}}
+  pre <- post <- """"
+  if (length(contents) == 3 &&
+      xml_name(contents[[1]]) == ""text"" &&
+      xml_name(contents[[2]]) == ""code"" &&
+      xml_name(contents[[3]]) == ""text"") {
+    pre <- paste0(ws_to_empty(xml_text(contents[[1]])), ""\\code{"")
+    post <- paste0(""}"", ws_to_empty(xml_text(contents[[3]])))
+    contents <- xml_contents(contents[[2]])
+  }
+
+  split_contents <- strsplit(destination, ""::"", fixed = TRUE)[[1]]
+  pkg <- split_contents[1]
+  func <- split_contents[2]
+
+  if (is_empty_xml(contents) && pkg == """") {
+    ## [](::function) -> \code{\link{function}}
+    paste0(""\\code{\\link{"", func, ""}}"")
+
+  } else if (is_empty_xml(contents)) {
+    ## [](pkg::function) -> \code{\link[pkg]{function}}
+    paste0(""\\code{\\link["", pkg, ""]{"", func, ""}}"")
+
+  } else if (pkg == """") {
+    ## [name](::=dest) -> \link[=dest]{name}
+    list(pre, paste0(""\\link["", func, ""]{""), contents, ""}"", post)
+
+  } else {
+    ## [name](pkg::bar) -> \link[pkg:bar]{name}
+    list(pre, paste0(""\\link["", pkg, "":"", func, ""]{""), contents, ""}"", post)
+  }
+}
+
+## Check if a string contains a pattern exactly once. Overlapping
+## patterns do not count.
+
+contains_once <- function(x, pattern, ...) {
+  length(strsplit(x = x, split = pattern, ...)[[1]]) == 2
+}
+
+#' @importFrom methods is
+
+is_empty_xml <- function(x) {
+  is(x, ""xml_nodeset"") && length(x) == 0
+}

---FILE: R/parse-preref.R---
@@ -3,6 +3,9 @@ parse_preref <- function(x, file, offset = x[[1]]) {
   if (length(tags) == 0)
     return()
 
+  ## Switch markdown on/off if md absent/present
+  markdown_on(""md"" %in% vapply(tags, ""[["", """", ""tag""))
+
   tags <- parse_description(tags)
   tags <- compact(lapply(tags, parse_tag))
 
@@ -74,6 +77,16 @@ parse_description <- function(tags) {
 
 # Individual tag parsers --------------------------------------------------
 
+parse.value.markdown <- function(x) {
+  x$val <- full_markdown(x$val)
+  parse.value(x)
+}
+
+parse.value.restricted.markdown <- function(x) {
+  x$val <- restricted_markdown(x$val)
+  parse.value(x)
+}
+
 # TODO: move into own file tag-parsers.R
 # TODO: consistent naming scheme `parse.value` -> `tag_value`
 # TODO: separate tag info and value into two arguments?
@@ -147,7 +160,13 @@ parse.words.line <- function(x) {
   }
 }
 
-parse.name.description <- function(x) {
+parse.name.description.nomarkdown <- function(x) {
+  parse.name.description(x, markdown = FALSE)
+}
+
+parse.name.description <- function(x, markdown = TRUE) {
+  if (markdown) x$val <- full_markdown(x$val)
+  
   if (x$val == """") {
     tag_warning(x, ""requires a value"")
   } else if (!str_detect(x$val, ""[[:space:]]+"")) {

---FILE: R/roclet-rd.R---
@@ -4,36 +4,37 @@ NULL
 
 register_tags(
   aliases = parse.value,
-  author = parse.value,
+  author = parse.value.markdown,
   backref = parse.value,
-  concept = parse.value,
+  concept = parse.value.markdown,
   describeIn = parse.name.description,
-  description = parse.value,
-  details = parse.value,
+  description = parse.value.markdown,
+  details = parse.value.markdown,
   docType = parse.name,
   encoding = parse.value,
   evalRd = parse.code,
   example = parse.value,
   examples = parse.examples,
   family = parse.value,
   field = parse.name.description,
-  format = parse.value,
+  format = parse.value.markdown,
   inheritParams = parse.value,
   keywords = parse.value,
-  method = parse.name.description,
+  method = parse.name.description.nomarkdown,
   name = parse.value,
+  md = parse.toggle,
   noRd = parse.toggle,
-  note = parse.value,
+  note = parse.value.markdown,
   param = parse.name.description,
   rdname = parse.value,
   rawRd = parse.value,
-  references = parse.value,
-  return = parse.value,
-  section = parse.value,
-  seealso = parse.value,
+  references = parse.value.markdown,
+  return = parse.value.markdown,
+  section = parse.value.markdown,
+  seealso = parse.value.markdown,
   slot = parse.name.description,
-  source = parse.value,
-  title = parse.value,
+  source = parse.value.markdown,
+  title = parse.value.restricted.markdown,
   usage = parse.value
 )
 

---FILE: man/double_escape_md.Rd---
@@ -0,0 +1,20 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/markdown-escaping.R
+\name{double_escape_md}
+\alias{double_escape_md}
+\title{Escape \\% and \\$ and \\_ once more, because commonmark
+removes the escaping. We do this everywhere currently.}
+\usage{
+double_escape_md(text)
+}
+\arguments{
+\item{text}{Input text.}
+}
+\value{
+Double-escaped text.
+}
+\description{
+Escape \\% and \\$ and \\_ once more, because commonmark
+removes the escaping. We do this everywhere currently.
+}
+

---FILE: man/markdown-internals.Rd---
@@ -0,0 +1,57 @@
+% Generated by roxygen2: do not edit by hand
+% Please edit documentation in R/markdown-escaping.R
+\name{escape_rd_for_md}
+\alias{escape_rd_for_md}
+\alias{unescape_rd_for_md}
+\title{Escape Rd markup, to avoid interpreting it as markdown}
+\usage{
+escape_rd_for_md(text)
+
+unescape_rd_for_md(rd_text, esc_text)
+}
+\arguments{
+\item{text}{Input text. Potentially contains Rd and/or
+markdown markup.}
+
+\item{rd_text}{The markdown parsed and interpreted text.}
+
+\item{esc_text}{The original escaped text from
+\code{\link{escape_rd_for_md}}.}
+}
+\value{
+For \code{escape_rd_for_md}:
+  A \dQuote{safe} version of the input text, where
+  each fragile Rd tag is replaced by a placeholder. The
+  original text is added as an attribute for each placeholder.
+
+For \code{unescape_rd_for_md}: Rd text.
+}
+\description{
+This is needed, if we want to stay compatible with
+existing markup, even if markdown mode is switched on.
+Fragile Rd tags (tags that may contain markup that
+can be picked up by the markdown parser), are replaced
+by placeholders. After the markdown to Rd conversion
+is done, the original text is put back in place of the
+placeholders.
+
+It puts back the protected fragile Rd commands into
+the text after the markdown parsing.
+}
+\details{
+The list of protected Rd tags is in \code{escaped_for_md}.
+
+Some Rd macros are treated specially: \itemize{
+\item For \code{if}, markdown is only allowed in the
+  second argument.
+\item For \code{ifelse} markdown is allowed in the
+  second and third arguments.
+}
+
+See also \code{roclet-rd.R} for the list of tags that
+uses the markdown-enabled parser. Some tags, e.g.
+\code{@aliases}, \code{@backref}, etc. only use the
+standard Roxygen parser.
+}
+\keyword{internal}
+

---FILE: src/RcppExports.cpp---
@@ -5,6 +5,18 @@
 
 using namespace Rcpp;
 
+// findEndOfTag
+int findEndOfTag(std::string string, bool is_code);
+RcppExport SEXP roxygen2_findEndOfTag(SEXP stringSEXP, SEXP is_codeSEXP) {
+BEGIN_RCPP
+    Rcpp::RObject __result;
+    Rcpp::RNGScope __rngScope;
+    Rcpp::traits::input_parameter< std::string >::type string(stringSEXP);
+    Rcpp::traits::input_parameter< bool >::type is_code(is_codeSEXP);
+    __result = Rcpp::wrap(findEndOfTag(string, is_code));
+    return __result;
+END_RCPP
+}
 // rdComplete
 bool rdComplete(std::string string, bool is_code);
 RcppExport SEXP roxygen2_rdComplete(SEXP stringSEXP, SEXP is_codeSEXP) {

---FILE: src/isComplete.cpp---
@@ -4,8 +4,15 @@ using namespace Rcpp;
 // From http://developer.r-project.org/parseRd.pdf:  The characters \, %, {,
 // and } have special meaning in almost all parts of an Rd file. In code,
 // strings must also match, except in comments.
-// [[Rcpp::export]]
-bool rdComplete(std::string string, bool is_code = false) {
+
+// The two functions are very similar, so we use a common
+// implementation and select the functionality via the
+// mode argument:
+// mode == 0: rdComplete
+// mode == 1: findEndOfTag
+
+int roxygen_parse_tag(std::string string, bool is_code = false,
+		      int mode = 0) {
   int n = string.length();
 
   char in_string = '\0';
@@ -58,7 +65,31 @@ bool rdComplete(std::string string, bool is_code = false) {
       }
     }
 
+    if (mode == 1) {
+      bool complete = braces == 0 && !in_escape && !in_string;
+      if (complete && i + 1 < n && string[i + 1] != '{') {
+	return i;
+      }
+    }
+
   }
 
-  return braces == 0 && !in_escape && !in_string;
+  bool complete = braces == 0 && !in_escape && !in_string;
+
+  if (mode == 0) {
+    if (complete) return 1; else return 0;
+
+  } else {
+    if (complete) return n - 1; else return -1;
+  }
+}
+
+// [[Rcpp::export]]
+int findEndOfTag(std::string string, bool is_code = false) {
+  return roxygen_parse_tag(string, is_code, 1);
+}
+
+// [[Rcpp::export]]
+bool rdComplete(std::string string, bool is_code = false) {
+  return roxygen_parse_tag(string, is_code, 0) == 1 ? true : false;
 }

---FILE: tests/testthat/test-markdown-escaping.R---
@@ -0,0 +1,119 @@
+
+context(""Markdown escaping"")
+
+tag_df <- function(tag, start, end, argend = NULL) {
+  df <- data.frame(
+    stringsAsFactors = FALSE,
+    tag = tag, start = start, end = end
+  )
+  if (!is.null(argend)) df$argend <- argend
+  df
+}
+
+test_that(""find_all_tag_names"", {
+
+  text <- ""blah blah \\mytag blah blah""
+  expect_equal(
+    find_all_tag_names(text),
+    tag_df(""\\mytag"", 11, 16)
+  )
+})
+
+test_that(""find_all_rd_tags"", {
+
+  cases <- list(
+    ## No tags
+    list("""", character(), numeric(), numeric(), numeric()),
+    list(""nothing to see here"",
+         character(), numeric(), numeric(), numeric()),
+    list(""\nstill\nnothing\n"",
+         character(), numeric(), numeric(), numeric()),
+
+    ## One tag
+    list(""blah blah \\mytag blah blah"", ""\\mytag"", 11, 16, 16),
+    list(""blah blah \\mytag{arg1} blah blah"",
+         ""\\mytag"", 11, 16, 22),
+    list(""blah blah \\mytag{arg1}{arg2} blah blah"",
+         ""\\mytag"", 11, 16, 28),
+    list(""blah\\mytag"", ""\\mytag"", 5, 10, 10),
+    list(""blah \\mytag"", ""\\mytag"", 6, 11, 11),
+    list(""blah\\mytag{arg}"", ""\\mytag"", 5, 10, 15),
+    list(""\\mytag hoohoo"", ""\\mytag"", 1, 6, 6),
+    list(""\\mytag"", ""\\mytag"", 1, 6, 6),
+    list(""\\mytag{arg}"", ""\\mytag"", 1, 6, 11),
+    list(""blah \\mytag\nblah blah"", ""\\mytag"", 6, 11, 11),
+
+    ## Multiple tags
+    list(""blah \\tag1 \\tag2{arg} blah"", c(""\\tag1"", ""\\tag2""),
+         c(6, 12), c(10, 16), c(10, 21)),
+    list(""blah \\tag1{ \\tag2{arg} } blah"", c(""\\tag1"", ""\\tag2""),
+         c(6, 13), c(10, 17), c(24, 22)),
+    list(""blah \\tag1{\n\\tag2{arg}\n} blah"", c(""\\tag1"", ""\\tag2""),
+         c(6, 13), c(10, 17), c(24, 22))
+  )
+
+  for (case in cases) {
+    expect_equal(
+      find_all_rd_tags(case[[1]]),
+      do.call(tag_df, case[-1]),
+      info = case[[1]]
+    )
+  } 
+ 
+})
+
+test_that(""find_fragile_rd_tags"", {
+
+  fragile <- c(""\\frag"", ""\\frag1"", ""\\frag2"")
+  
+  cases <- list(
+    list(""This is \\frag{here}, \\this{arg} not"", ""\\frag""),
+    list(""Embedded \\frag{ into \\frag1{arg} plus }"", ""\\frag""),
+    list(
+      ""blah \\cmd{ \\frag{arg} \\frag{arg} } \\frag2 blah"", 
+      c(""\\frag"", ""\\frag"", ""\\frag2"")
+    )
+  )
+
+  for (case in cases) {
+    expect_equal(
+      find_fragile_rd_tags(case[[1]], fragile)$tag,
+      case[[2]],
+      info = case[[1]]
+    )
+  }
+  
+})
+
+
+test_that(""str_sub_same"", {
+
+  expect_equal(
+    str_sub_same(
+      ""123456789ab"",
+      data.frame(start = c(1,6), end = c(2,10), argend = c(2,10)),
+      ""xxx""
+    ),
+    ""xxx-1-345xxx-2-b""
+  )
+
+  expect_equal(
+    str_sub_same(
+      ""123456789ab"",
+      data.frame(start = c(1,8), end = c(7,10), argend = c(7,10)),
+      ""xxx""
+    ),
+    ""xxx-1-xxx-2-b"",
+  )
+
+  expect_equal(
+    str_sub_same(
+      ""123456789ab"",
+      data.frame(start = numeric(), end = numeric(),
+                 argend = numeric()),
+      ""xxx""
+    ),
+    ""123456789ab""
+  )
+
+})

---FILE: tests/testthat/test-markdown.R---
@@ -0,0 +1,469 @@
+context(""Markdown markup"")
+roc <- rd_roclet()
+
+test_that(""markdown is off by default"", {
+  out1 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Description with some `code` included. `More code.`
+    foo <- function() {}"")[[1]]
+  expect_equal(
+    get_tag(out1, ""description"")$values,
+    ""Description with some `code` included. `More code.`""
+  )
+})
+
+test_that(""backticks are converted to \\code"", {
+  out1 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Description with some `code` included. `More code.`
+    #' @md
+    foo <- function() {}"")[[1]]
+  out2 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Description with some \\code{code} included. \\code{More code.}
+    foo <- function() {}"")[[1]]
+  expect_equal(get_tag(out1, ""description""), get_tag(out2, ""description""))
+})
+
+test_that(""code blocks work"", {
+  out1 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Description
+    #'
+    #' Details with a code block:
+    #' ```r
+    #' x <- 1:10 %>%
+    #'   multiply_by(10) %>%
+    #'   add(42)
+    #' ```
+    #' Normal text again.
+    #' @md
+    foo <- function() {}"")[[1]]
+  out2 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Description
+    #'
+    #' Details with a code block:\\preformatted{x <- 1:10 %>%
+    #'   multiply_by(10) %>%
+    #'   add(42)
+    #' }
+    #'
+    #' Normal text again.
+    foo <- function() {}"")[[1]]
+  expect_equal(get_tag(out1, ""details""), get_tag(out2, ""details""))
+})
+
+test_that(""itemized lists work"", {
+  out1 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Description with some
+    #' * itemized
+    #' * list
+    #'
+    #' And then another one:
+    #' * item 1
+    #' * item 2
+    #' * item 3
+    #' @md
+    foo <- function() {}"")[[1]]
+  out2 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Description with some
+    #' \\itemize{
+    #' \\item itemized
+    #' \\item list
+    #' }
+    #'
+    #' And then another one:
+    #' \\itemize{
+    #' \\item item 1
+    #' \\item item 2
+    #' \\item item 3
+    #' }
+    foo <- function() {}"")[[1]]
+  expect_equal(get_tag(out1, ""description""), get_tag(out2, ""description""))
+  expect_equal(get_tag(out1, ""details""), get_tag(out2, ""details""))
+})
+
+test_that(""numbered lists work"", {
+  out1 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Description with some
+    #' 1. numbered
+    #' 2. list
+    #'
+    #' And then another one:
+    #' 1. item 1
+    #' 1. item 2
+    #' 1. item 3
+    #' @md
+    foo <- function() {}"")[[1]]
+  out2 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Description with some
+    #' \\enumerate{
+    #' \\item numbered
+    #' \\item list
+    #' }
+    #'
+    #' And then another one:
+    #' \\enumerate{
+    #' \\item item 1
+    #' \\item item 2
+    #' \\item item 3
+    #' }
+    foo <- function() {}"")[[1]]
+  expect_equal(get_tag(out1, ""description""), get_tag(out2, ""description""))
+  expect_equal(get_tag(out1, ""details""), get_tag(out2, ""details""))
+})
+
+test_that(""nested lists are OK"", {
+  out1 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Description with some
+    #' 1. numbered
+    #'    * itemized
+    #'    * sublist
+    #' 2. list
+    #'
+    #' And then another one:
+    #' * item 1
+    #' * item 2
+    #'    * sublist
+    #'    * within
+    #' * item 3
+    #' @md
+    foo <- function() {}"")[[1]]
+  out2 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Description with some
+    #' \\enumerate{
+    #' \\item numbered
+    #'   \\itemize{
+    #'      \\item itemized
+    #'      \\item sublist
+    #'   }
+    #' \\item list
+    #' }
+    #'
+    #' And then another one:
+    #' \\itemize{
+    #' \\item item 1
+    #' \\item item 2
+    #'    \\itemize{
+    #'      \\item sublist
+    #'      \\item within
+    #'    }
+    #' \\item item 3
+    #' }
+    #' @md
+    foo <- function() {}"")[[1]]
+  expect_equal(get_tag(out1, ""description""), get_tag(out2, ""description""))
+  expect_equal(get_tag(out1, ""details""), get_tag(out2, ""details""))
+
+})
+
+test_that(""emphasis works"", {
+  out1 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Description with some _emphasis_ included. _More emph._
+    #' @md
+    foo <- function() {}"")[[1]]
+  out2 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Description with some \\emph{emphasis} included. \\emph{More emph.}
+    foo <- function() {}"")[[1]]
+  expect_equal(get_tag(out1, ""description""), get_tag(out2, ""description""))
+})
+
+test_that(""strong (bold) text works"", {
+  out1 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Description with some **bold** included. **More bold.**
+    #' @md
+    foo <- function() {}"")[[1]]
+  out2 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Description with some \\strong{bold} included. \\strong{More bold.}
+    foo <- function() {}"")[[1]]
+  expect_equal(get_tag(out1, ""description""), get_tag(out2, ""description""))
+})
+
+test_that(""links work"", {
+  out1 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Description, see [](::function).
+    #' @md
+    foo <- function() {}"")[[1]]
+  out2 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Description, see \\code{\\link{function}}.
+    foo <- function() {}"")[[1]]
+  expect_equal(get_tag(out1, ""description""), get_tag(out2, ""description""))
+
+  out1 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Description, see [](pkg::function).
+    #' @md
+    foo <- function() {}"")[[1]]
+  out2 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Description, see \\code{\\link[pkg]{function}}.
+    foo <- function() {}"")[[1]]
+  expect_equal(get_tag(out1, ""description""), get_tag(out2, ""description""))
+
+  out1 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Description, see [name](::=dest).
+    #' @md
+    foo <- function() {}"")[[1]]
+  out2 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Description, see \\link[=dest]{name}.
+    foo <- function() {}"")[[1]]
+  expect_equal(get_tag(out1, ""description""), get_tag(out2, ""description""))
+
+  out1 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Description, see [name](pkg::bar).
+    #' @md
+    foo <- function() {}"")[[1]]
+  out2 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Description, see \\link[pkg:bar]{name}.
+    foo <- function() {}"")[[1]]
+  expect_equal(get_tag(out1, ""description""), get_tag(out2, ""description""))
+
+  out1 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Description, see [terms](::=terms.object).
+    #' @md
+    foo <- function() {}"")[[1]]
+  out2 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Description, see \\link[=terms.object]{terms}.
+    foo <- function() {}"")[[1]]
+  expect_equal(get_tag(out1, ""description""), get_tag(out2, ""description""))
+
+  out1 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Description, see [abc](::=abc-class).
+    #' @md
+    foo <- function() {}"")[[1]]
+  out2 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Description, see \\link[=abc-class]{abc}.
+    foo <- function() {}"")[[1]]
+  expect_equal(get_tag(out1, ""description""), get_tag(out2, ""description""))
+})
+
+test_that(""markdown links are converted"", {
+  out1 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Description, see [http://acme.com]() for details.
+    #' And here is a named link: [igraph](http://igraph.org).
+    #' @md
+    foo <- function() {}"")[[1]]
+  out2 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Description, see \\url{http://acme.com} for details.
+    #' And here is a named link: \\href{http://igraph.org}{igraph}.
+    foo <- function() {}"")[[1]]
+  expect_equal(get_tag(out1, ""description""), get_tag(out2, ""description""))
+})
+
+test_that(""images are recognized"", {
+  out1 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Description
+    #'
+    #' Details with a plot: ![](example.jpg \""Plot title\"")
+    #' @md
+    foo <- function() {}"")[[1]]
+  out2 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Description
+    #'
+    #' Details with a plot: \\figure{example.jpg}{Plot title}
+    foo <- function() {}"")[[1]]
+  expect_equal(get_tag(out1, ""description""), get_tag(out2, ""description""))
+})
+
+test_that(""markdown is parsed in all fields where it is supported"", {
+  out1 <- roc_proc_text(roc, ""
+    #' @title Title **with bold**
+    #'
+    #' @description Description **with bold**
+    #'
+    #' @details Details **with bold**
+    #'
+    #' @references References **with bold**
+    #'
+    #' @concept Concept **with bold**
+    #'
+    #' @note Note **with bold**
+    #'
+    #' @seealso See also **with bold**
+    #'
+    #' @keywords Keywords **with bold**
+    #'
+    #' @return Return **with bold**
+    #'
+    #' @author Author **with bold**
+    #'
+    #' @section Foobar:
+    #' With some **bold text**.
+    #'
+    #' @format Format **with bold**
+    #'
+    #' @source Source **with bold**
+    #'
+    #' @param param Param **with bold**
+    #'
+    #' @slot slot Slot **with bold**
+    #'
+    #' @field field Field **with bold**
+    #'
+    #' @method method Method **with bold**
+    #' @md
+    foo <- function() {}"")[[1]]
+  out2 <- roc_proc_text(roc, ""
+    #' @title Title \\strong{with bold}
+    #'
+    #' @description Description \\strong{with bold}
+    #'
+    #' @details Details \\strong{with bold}
+    #'
+    #' @references References \\strong{with bold}
+    #'
+    #' @concept Concept \\strong{with bold}
+    #'
+    #' @note Note \\strong{with bold}
+    #'
+    #' @seealso See also \\strong{with bold}
+    #'
+    #' @keywords Keywords \\strong{with bold}
+    #'
+    #' @return Return \\strong{with bold}
+    #'
+    #' @author Author \\strong{with bold}
+    #'
+    #' @section Foobar:
+    #' With some \\strong{bold text}.
+    #'
+    #' @format Format \\strong{with bold}
+    #'
+    #' @source Source \\strong{with bold}
+    #'
+    #' @param param Param \\strong{with bold}
+    #'
+    #' @slot slot Slot \\strong{with bold}
+    #'
+    #' @field field Field \\strong{with bold}
+    #'
+    #' @method method Method \\strong{with bold}
+    foo <- function() {}"")[[1]]
+  expect_equal(get_tag(out1, ""title""), get_tag(out2, ""title""))
+  expect_equal(get_tag(out1, ""description""), get_tag(out2, ""description""))
+  expect_equal(get_tag(out1, ""details""), get_tag(out2, ""details""))
+  expect_equal(get_tag(out1, ""references""), get_tag(out2, ""references""))
+  expect_equal(get_tag(out1, ""concept""), get_tag(out2, ""concept""))
+  expect_equal(get_tag(out1, ""note""), get_tag(out2, ""note""))
+  expect_equal(get_tag(out1, ""seealso""), get_tag(out2, ""seealso""))
+  expect_equal(get_tag(out1, ""keywords""), get_tag(out2, ""keywords""))
+  expect_equal(get_tag(out1, ""return""), get_tag(out2, ""return""))
+  expect_equal(get_tag(out1, ""author""), get_tag(out2, ""author""))
+  expect_equal(get_tag(out1, ""section""), get_tag(out2, ""section""))
+  expect_equal(get_tag(out1, ""format""), get_tag(out2, ""format""))
+  expect_equal(get_tag(out1, ""source""), get_tag(out2, ""source""))
+  expect_equal(get_tag(out1, ""param""), get_tag(out2, ""param""))
+  expect_equal(get_tag(out1, ""slot""), get_tag(out2, ""slot""))
+  expect_equal(get_tag(out1, ""field""), get_tag(out2, ""field""))
+  expect_equal(get_tag(out1, ""method""), get_tag(out2, ""method""))
+})
+
+
+test_that(""markdown emphasis is ok"", {
+  out1 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Description with some *keywords* included.
+    #' So far so good. \\preformatted{ *these are not
+    #'   emphasised*. Or are they?
+    #' }
+    #' @md
+    foo <- function() {}"")[[1]]
+  desc1 <- ""Description with some \\emph{keywords} included.
+So far so good. \\preformatted{ *these are not
+  emphasised*. Or are they?
+}""
+  expect_equal(get_tag(out1, ""description"")[[2]], desc1)
+})
+
+test_that(""% and $ and _ are not unescaped"", {
+
+  out1 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Description. It has some \\% and \\$ and also \\_.
+    #'
+    #' @param foo Item with \\% characters: \\%. And also \\$ and \\_.
+    foo <- function(foo) {}"")[[1]]
+  out2 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Description. It has some \\% and \\$ and also \\_.
+    #'
+    #' @param foo Item with \\% characters: \\%. And also \\$ and \\_.
+    #' @md
+    foo <- function(foo) {}"")[[1]]
+  expect_equal(get_tag(out1, ""description""), get_tag(out2, ""description""))
+  expect_equal(get_tag(out1, ""param""), get_tag(out2, ""param""))
+})
+
+test_that(""Escaping is kept"", {
+
+  out1 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Description. It has \\rd \\commands.
+    #' @md
+    foo <- function() {}"")[[1]]
+  out2 <- roc_proc_text(roc, ""
+    #' Title
+    #'
+    #' Description. It has \\rd \\commands.
+    foo <- function() {}"")[[1]]
+  expect_equal(get_tag(out1, ""description""), get_tag(out2, ""description""))
+})

---FILE: vignettes/markdown.R---
@@ -0,0 +1,7 @@
+## ---- echo = FALSE, message = FALSE--------------------------------------
+knitr::opts_chunk$set(
+  comment = ""#>"",
+  error = FALSE,
+  tidy = FALSE
+)
+

---FILE: vignettes/markdown.Rmd---
@@ -0,0 +1,17 @@
+<!--
+%\VignetteEngine{knitr::knitr}
+%\VignetteIndexEntry{Write R documentation in Markdown}
+-->
+
+```{r, echo = FALSE, message = FALSE}
+knitr::opts_chunk$set(
+  comment = ""#>"",
+  error = FALSE,
+  tidy = FALSE
+)
+```
+
+# Write R documentation in Markdown
+
+This is a vignette to be written once we know what exactly the Markdown
+support will cover.

---FILE: vignettes/markdown.html---
@@ -0,0 +1,178 @@
+<!DOCTYPE html>
+<html>
+<head>
+<meta http-equiv=""Content-Type"" content=""text/html; charset=utf-8""/>
+
+<title>Write R documentation in Markdown</title>
+
+<script type=""text/javascript"">
+window.onload = function() {
+  var imgs = document.getElementsByTagName('img'), i, img;
+  for (i = 0; i < imgs.length; i++) {
+    img = imgs[i];
+    // center an image if it is the only element of its parent
+    if (img.parentElement.childElementCount === 1)
+      img.parentElement.style.textAlign = 'center';
+  }
+};
+</script>
+
+
+
+
+
+<style type=""text/css"">
+body, td {
+   font-family: sans-serif;
+   background-color: white;
+   font-size: 13px;
+}
+
+body {
+  max-width: 800px;
+  margin: auto;
+  padding: 1em;
+  line-height: 20px;
+}
+
+tt, code, pre {
+   font-family: 'DejaVu Sans Mono', 'Droid Sans Mono', 'Lucida Console', Consolas, Monaco, monospace;
+}
+
+h1 {
+   font-size:2.2em;
+}
+
+h2 {
+   font-size:1.8em;
+}
+
+h3 {
+   font-size:1.4em;
+}
+
+h4 {
+   font-size:1.0em;
+}
+
+h5 {
+   font-size:0.9em;
+}
+
+h6 {
+   font-size:0.8em;
+}
+
+a:visited {
+   color: rgb(50%, 0%, 50%);
+}
+
+pre, img {
+  max-width: 100%;
+}
+pre {
+  overflow-x: auto;
+}
+pre code {
+   display: block; padding: 0.5em;
+}
+
+code {
+  font-size: 92%;
+  border: 1px solid #ccc;
+}
+
+code[class] {
+  background-color: #F8F8F8;
+}
+
+table, td, th {
+  border: none;
+}
+
+blockquote {
+   color:#666666;
+   margin:0;
+   padding-left: 1em;
+   border-left: 0.5em #EEE solid;
+}
+
+hr {
+   height: 0px;
+   border-bottom: none;
+   border-top-width: thin;
+   border-top-style: dotted;
+   border-top-color: #999999;
+}
+
+@media print {
+   * {
+      background: transparent !important;
+      color: black !important;
+      filter:none !important;
+      -ms-filter: none !important;
+   }
+
+   body {
+      font-size:12pt;
+      max-width:100%;
+   }
+
+   a, a:visited {
+      text-decoration: underline;
+   }
+
+   hr {
+      visibility: hidden;
+      page-break-before: always;
+   }
+
+   pre, blockquote {
+      padding-right: 1em;
+      page-break-inside: avoid;
+   }
+
+   tr, img {
+      page-break-inside: avoid;
+   }
+
+   img {
+      max-width: 100% !important;
+   }
+
+   @page :left {
+      margin: 15mm 20mm 15mm 10mm;
+   }
+
+   @page :right {
+      margin: 15mm 10mm 15mm 20mm;
+   }
+
+   p, h2, h3 {
+      orphans: 3; widows: 3;
+   }
+
+   h2, h3 {
+      page-break-after: avoid;
+   }
+}
+</style>
+
+
+
+</head>
+
+<body>
+<!--
+%\VignetteEngine{knitr::knitr}
+%\VignetteIndexEntry{Write R documentation in Markdown}
+-->
+
+<h1>Write R documentation in Markdown</h1>
+
+<p>This is a vignette to be written once we know what exactly the Markdown
+support will cover.</p>
+
+</body>
+
+</html>

---FILE: vignettes/markdown.md---
@@ -0,0 +1,11 @@
+<!--
+%\VignetteEngine{knitr::knitr}
+%\VignetteIndexEntry{Write R documentation in Markdown}
+-->
+
+
+
+# Write R documentation in Markdown
+
+This is a vignette to be written once we know what exactly the Markdown
+support will cover."
r-lib,roxygen2,1e2aae4f3159e4edb3f82e8726d3ff583c897cbd,Gregory Jefferis,jefferis@gmail.com,2016-08-29T22:35:25Z,Hadley Wickham,h.wickham@gmail.com,2016-08-29T22:35:25Z,"Fix @inheritParams for multi parameter lines (#445)

By trimming whitespace. Fixes #444",R/inherit-params.R;tests/testthat/test-param.R,False,True,True,False,14,2,16,"---FILE: R/inherit-params.R---
@@ -71,8 +71,8 @@ find_params <- function(inheritor, topics, name_lookup) {
   param_names <- str_trim(names(params))
   param_names[param_names == ""\\dots""] <- ""...""
 
-  # Split up compound names on , duplicating their contents
-  individual_names <- strsplit(param_names, "","")
+  # Split up compound names on , (swallowing spaces) duplicating their contents
+  individual_names <- strsplit(param_names, "",\\s*"")
   reps <- vapply(individual_names, length, integer(1))
 
   setNames(rep.int(params, reps), unlist(individual_names))

---FILE: tests/testthat/test-param.R---
@@ -60,6 +60,18 @@ test_that(""multiple @inheritParam inherits from existing topics"", {
   expect_equal(sort(names(params)), c(""trim"", ""x""))
 })
 
+
+test_that(""@inheritParam can cope with multivariable argument definitions"", {
+  out <- roc_proc_text(rd_roclet(), ""
+                       #' My merge
+                       #'
+                       #' @inheritParams base::merge
+                       mymerge <- function(x, y) {}"")[[1]]
+  params <- get_tag(out, ""param"")$values
+  expect_equal(length(params), 2)
+  expect_equal(sort(names(params)), c(""x"", ""y""))
+})
+
 test_that(""@inheritParam understands compound docs"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' Title"
r-lib,roxygen2,848e5a34bd262e8a952a5d072f57b2df955c7e4f,hadley,h.wickham@gmail.com,2016-08-29T21:10:07Z,hadley,h.wickham@gmail.com,2016-08-29T21:10:07Z,"Re-add dropped trailing ANY signatures

Fixes #460",NEWS.md;R/topic-name.R;tests/testthat/test-s4.R,False,True,True,False,25,1,26,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 5.0.1.9000
 
+* The default alias for S4 method now re-addeds trailing ANY signatures
+  that are sometimes dropped (#460).
+
 * Changes to DESCRIPTION (i.e. `Collate:` and `RoxygenNote`) now use
   the desc package. This will minimise spurious changes (#430).
 

---FILE: R/topic-name.R---
@@ -2,7 +2,17 @@ default_topic_name <- function(x) UseMethod(""default_topic_name"")
 
 #' @export
 default_topic_name.s4method <- function(x) {
-  sig <- paste0(x$value@defined, collapse = "","")
+  sig <- x$value@defined
+
+  # Trailing ANY's are dropped from the signature and need to be
+  # re-added - see https://github.com/klutometis/roxygen/issues/460
+  g_nargs <- length(methods::getGeneric(x$value@generic)@signature)
+  m_nargs <- length(x$value@defined)
+  if (m_nargs < g_nargs) {
+    sig <- c(sig, rep(""ANY"", g_nargs - m_nargs))
+  }
+
+  sig <- paste0(sig, collapse = "","")
   paste0(x$value@generic, "","", sig, ""-method"")
 }
 

---FILE: tests/testthat/test-s4.R---
@@ -53,3 +53,14 @@ test_that(""setMethod equivalent to setReplaceMethod"", {
 
   expect_equal(out[[2]]$object, out[[3]]$object)
 })
+
+test_that(""trailing arguments get signature ANY"", {
+  out <- roc_proc_text(rd_roclet(), ""
+    setGeneric('foo', function(x, y) standardGeneric('foo'))
+
+    #' foo
+    setMethod('foo', c('numeric', 'ANY'), function(x, y) x)
+  "")[[1]]
+
+  expect_equal(out$get_tag(""alias"")$values, ""foo,numeric,ANY-method"")
+})"
r-lib,roxygen2,39a824c5944de99b8ee431b93b7ebcd3baf99ad4,hadley,h.wickham@gmail.com,2016-08-29T20:53:24Z,hadley,h.wickham@gmail.com,2016-08-29T20:53:24Z,"Use desc package to avoid mangling DESCRIPTION

Fixes #430",DESCRIPTION;NEWS.md;R/roclet-collate.R;R/safety.R,False,True,True,False,18,16,34,"---FILE: DESCRIPTION---
@@ -11,25 +11,26 @@ Authors@R: c(
     person(""Manuel"", ""Eugster"", role = c(""aut"", ""cph"")),
     person(""RStudio"", role = ""cph"")
     )
-Depends:
+Depends: 
     R (>= 3.0.2)
-Imports:
+Imports: 
     stringr (>= 0.5),
     stringi,
     brew,
     digest,
     methods,
     Rcpp (>= 0.11.0),
-    R6
-Suggests:
+    R6,
+    desc
+Suggests: 
     testthat (>= 0.8.0),
     knitr,
     devtools,
     rmarkdown,
     covr
 VignetteBuilder: knitr
 LinkingTo: Rcpp
-Collate:
+Collate: 
     'RcppExports.R'
     'RdTopic.R'
     'alias.R'

---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 5.0.1.9000
 
+* Changes to DESCRIPTION (i.e. `Collate:` and `RoxygenNote`) now use
+  the desc package. This will minimise spurious changes (#430).
+
 * `@family` see also are added in the same order they appear, not 
   alphabetically (#315).
 

---FILE: R/roclet-collate.R---
@@ -37,19 +37,18 @@ register_tags(
 #' }
 #' @export
 update_collate <- function(base_path) {
-  collate <- generate_collate(file.path(base_path, ""R""))
-  if (is.null(collate)) return()
+  new <- generate_collate(file.path(base_path, ""R""))
+  if (is.null(new)) return()
 
   desc_path <- file.path(base_path, ""DESCRIPTION"")
-  old <- read.description(desc_path)
-
-  new <- old
-  new$Collate <- paste0(""'"", collate, ""'"", collapse = ""\n"")
+  old <- desc::desc_get_collate(file = desc_path)
 
   if (!identical(old, new)) {
     cat('Updating collate directive in ', desc_path, ""\n"")
-    write.description(new, desc_path)
+    desc::desc_set_collate(new, file = desc_path)
   }
+
+  invisible()
 }
 
 generate_collate <- function(base_path) {

---FILE: R/safety.R---
@@ -38,13 +38,12 @@ made_by <- function(comment) {
 
 update_roxygen_version <- function(base_path) {
   desc_path <- file.path(base_path, ""DESCRIPTION"")
-  old <- read.description(desc_path)
 
-  new <- old
-  new$RoxygenNote <- as.character(utils::packageVersion(""roxygen2""))
+  new <- as.character(utils::packageVersion(""roxygen2""))
+  old <- desc::desc_get(""RoxygenNote"", file = desc_path)[[1]]
 
   if (!identical(old, new)) {
     cat('Updating roxygen version in ', desc_path, ""\n"")
-    write.description(new, desc_path)
+    desc::desc_set(RoxygenNote = new, file = desc_path)
   }
 }"
r-lib,roxygen2,d6e7d4ed5bd3a99800417fe1871189e2e6ac9ab5,hadley,h.wickham@gmail.com,2016-08-29T17:53:06Z,hadley,h.wickham@gmail.com,2016-08-29T17:53:06Z,"Provide block warning helper

And use consistently instead of throwing errors.",R/roclet-rd.R;R/utils.R;tests/testthat/test-rd.R,False,True,True,False,38,21,59,"---FILE: R/roclet-rd.R---
@@ -96,8 +96,10 @@ block_to_rd <- function(block, base_path, env) {
   rd <- new_rd_file()
 
   # Determine name
-  name <- block$name %||% default_topic_name(block$object) %||%
-    stop(""Missing name at "", srcref_location(block$srcref), call. = FALSE)
+  name <- block$name %||% default_topic_name(block$object)
+  if (is.null(name)) {
+    return(block_warning(block, ""Missing name""))
+  }
   add_tag(rd, new_tag(""name"", name))
 
   # Add backreference to source
@@ -233,12 +235,10 @@ process_examples <- function(block, base_path) {
     # Check that haven't accidentally used example instead of examples
     nl <- str_count(paths, ""\n"")
     if (any(nl) > 0) {
-      warning(
-        srcref_location(block$srcref), "": "",
-        ""@example spans multiple lines. Do you want @examples?"",
-        call. = FALSE
-      )
-      return(NULL)
+      return(block_warning(
+        block,
+        ""@example spans multiple lines. Do you want @examples?""
+      ))
     }
 
     examples <- unlist(lapply(paths, readLines))
@@ -253,8 +253,10 @@ process_section <- function(key, value) {
   pieces <- str_split_fixed(value, "":"", n = 2)[1, ]
 
   if (str_detect(pieces[1], ""\n"")) {
-    stop(""Section title spans multiple lines: \n"",
-      ""@section "", value, call. = FALSE)
+    return(block_warning(
+      block,
+      ""Section title spans multiple lines: \n"", ""@section "", value
+    ))
   }
 
   new_tag(""section"", list(list(name = pieces[1], content = pieces[2])))

---FILE: R/utils.R---
@@ -135,3 +135,13 @@ compact <- function(x) {
   null <- vapply(x, is.null, logical(1))
   x[!null]
 }
+
+block_warning <- function(block, ...) {
+  warning(
+    srcref_location(block$srcref), "": "", ...,
+    call. = FALSE,
+    immediate. = TRUE
+  )
+  NULL
+}
+

---FILE: tests/testthat/test-rd.R---
@@ -60,21 +60,26 @@ test_that(""deleted objects not documented"", {
 
 
 test_that(""documenting unknown function requires name"", {
-  expect_error(roc_proc_text(rd_roclet(), ""
-    #' Virtual Class To Enforce Max Slot Lenght
-    #'
-    #' @export
-    setClass('A')
+  expect_warning(
+    roc_proc_text(rd_roclet(), ""
+      #' Virtual Class To Enforce Max Slot Lenght
+      #'
+      #' @export
+      setClass('A')
 
-    #' Validity function.
-    setValidity('A', function(object) TRUE)
-    ""),
+      #' Validity function.
+      setValidity('A', function(object) TRUE)""
+    ),
     ""Missing name""
   )
 })
 
 test_that(""documenting NA gives useful error message (#194)"", {
-  expect_error(roc_proc_text(rd_roclet(), ""
-    #' Missing value
-    NA"")[[1]], ""Missing name"")
+  expect_warning(
+    roc_proc_text(rd_roclet(), ""
+      #' Missing value
+      NA""
+      ),
+    ""Missing name""
+  )
 })"
r-lib,roxygen2,52deebf5fd63a1b92357052e2de90cb3a4c7b475,hadley,h.wickham@gmail.com,2016-08-29T16:56:27Z,hadley,h.wickham@gmail.com,2016-08-29T16:56:27Z,"process_families: flip inner and outer loops

Preserves order of `@family` tags. Fixes #315",NEWS.md;R/family.R;tests/testthat/test-family.R,False,True,True,False,33,7,40,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 5.0.1.9000
 
+* `@family` see also are added in the same order they appear, not 
+  alphabetically (#315).
+
 * Special characters in `@describeIn` function names are escaped (#450).
 
 * Ensure that `functions` with S3 class are still treated as functions (#455).

---FILE: R/family.R---
@@ -2,19 +2,21 @@ process_family <- function(topics) {
   family_lookup <- invert(get_values(topics, ""family""))
   alias_lookup <- get_values(topics, ""alias"")
 
-  for(family in names(family_lookup)) {
-    related <- family_lookup[[family]]
+  for (topic_name in names(topics)) {
+    topic <- topics[[topic_name]]
+    families <- get_tag(topic, ""family"")$values
 
-    for(topic_name in related) {
-      topic <- topics[[topic_name]]
-      others <- setdiff(related, topic_name)
+    for (family in families) {
+      related <- family_lookup[[family]]
 
-      if (length(others) < 1) next;
+      others <- setdiff(related, topic_name)
+      if (length(others) < 1)
+        next
 
       by_file <- vapply(alias_lookup[others], function(x) {
         paste0(""\\code{\\link{"", escape(x[1]), ""}}"")
       }, FUN.VALUE = character(1))
-      links <- paste(sort_c(by_file), collapse ="", "")
+      links <- paste(sort_c(by_file), collapse = "", "")
 
       seealso <- paste(""Other "", family, "": "", sep = """")
       out <- strwrap(links, initial = seealso, width = 60, exdent = 2)

---FILE: tests/testthat/test-family.R---
@@ -63,3 +63,24 @@ test_that(""family links to name only, not all aliases"", {
   expect_equal(str_count(seealso, fixed(""\\code{\\link"")), 1)
 
 })
+
+test_that(""families listed in same order as input"", {
+  out <- roc_proc_text(rd_roclet(), ""
+    #' foo
+    #' @family a
+    foo <- function() {}
+
+    #' foo
+    #' @family b
+    #' @family a
+    bar <- function() {}
+
+    #' foo
+    #' @family b
+    baz <- function() {}
+  "")[[2]]
+
+  seealso <- get_tag(out, ""seealso"")$values
+  expect_match(seealso[1], ""^Other b"")
+  expect_match(seealso[2], ""^Other a"")
+})"
r-lib,roxygen2,d4a1a6faed2f1a2932c19d0a921d308ce73271f9,hadley,h.wickham@gmail.com,2016-08-29T16:43:59Z,hadley,h.wickham@gmail.com,2016-08-29T16:43:59Z,Fix typo,NEWS.md,False,False,False,False,1,1,2,"---FILE: NEWS.md---
@@ -1,6 +1,6 @@
 # roxygen2 5.0.1.9000
 
-* Specail characters in `@describeIn` function names are escaped (#450).
+* Special characters in `@describeIn` function names are escaped (#450).
 
 * Ensure that `functions` with S3 class are still treated as functions (#455).
 "
r-lib,roxygen2,fd7554cf044dc5b76e5f012923d97bcd4e748d3d,hadley,h.wickham@gmail.com,2016-08-29T16:32:08Z,hadley,h.wickham@gmail.com,2016-08-29T16:32:08Z,"Escape special chars in describeIn

Fixes #450",NEWS.md;R/rd-tag-api.R;tests/testthat/test-describein.R,False,True,True,False,14,1,15,"---FILE: NEWS.md---
@@ -1,5 +1,7 @@
 # roxygen2 5.0.1.9000
 
+* Specail characters in `@describeIn` function names are escaped (#450).
+
 * Ensure that `functions` with S3 class are still treated as functions (#455).
 
 * Roxygen will no longer write out topics that don't have a name or title,

---FILE: R/rd-tag-api.R---
@@ -246,7 +246,7 @@ format.minidesc_tag <- function(x, ...) {
   paste0(
     ""\\section{"", title, ""}{\n"",
     ""\\itemize{\n"",
-    paste0(""\\item \\code{"", x$values$label, ""}: "", x$values$desc,
+    paste0(""\\item \\code{"", escape(x$values$label), ""}: "", x$values$desc,
       collapse = ""\n\n""),
     ""\n}}\n""
   )

---FILE: tests/testthat/test-describein.R---
@@ -95,3 +95,14 @@ test_that(""@describeIn class captures function name with data"", {
 
   expect_equal(get_tag(out, ""minidesc"")$values$label, ""f2"")
 })
+
+test_that(""function names are escaped"", {
+  out <- roc_proc_text(rd_roclet(), ""
+    #' foo
+    foo <- 100
+
+    #' @describeIn foo shortcut for foo
+    `%foo%` <- function(x, y) foo(x, y)
+    "")[[1]]
+  expect_match(format(get_tag(out, ""minidesc"")), ""\\\\%foo\\\\%"")
+})"
r-lib,roxygen2,f18b396de64bcf85d72bfbdd9414a143bbec3ece,hadley,h.wickham@gmail.com,2016-08-29T16:24:27Z,hadley,h.wickham@gmail.com,2016-08-29T16:24:27Z,"Don't rely on S3 class for function detection

Fixes #455",NAMESPACE;NEWS.md;R/object.R;tests/testthat/test-object.R,False,True,True,False,14,4,18,"---FILE: NAMESPACE---
@@ -67,7 +67,6 @@ S3method(merge,rd_tag)
 S3method(merge,reexport_tag)
 S3method(merge,section_tag)
 S3method(names,rd_file)
-S3method(obj_type,""function"")
 S3method(obj_type,MethodDefinition)
 S3method(obj_type,classRepresentation)
 S3method(obj_type,default)

---FILE: NEWS.md---
@@ -1,5 +1,7 @@
 # roxygen2 5.0.1.9000
 
+* Ensure that `functions` with S3 class are still treated as functions (#455).
+
 * Roxygen will no longer write out topics that don't have a name or title,
   and will instead generate a warning. This makes it easier to detect if
   you've accidentally used `@rdname` with an incorrect value (#474).

---FILE: R/object.R---
@@ -108,9 +108,13 @@ obj_type.refClassRepresentation <- function(x) ""rcclass""
 #' @export
 obj_type.refMethodDef <- function(x) ""rcmethod""
 
-#' @export
-obj_type.function <- function(x) ""function""
 #' @export
 obj_type.package <- function(x) ""package""
 #' @export
-obj_type.default <- function(x) ""data""
+obj_type.default <- function(x) {
+  if (is.function(x)) {
+    ""function""
+  } else {
+    ""data""
+  }
+}

---FILE: tests/testthat/test-object.R---
@@ -41,6 +41,11 @@ test_that(""obj_type correctly classifies objects"", {
   expect_equal(obj_type(classA), ""rcclass"")
 })
 
+test_that(""functions with class are still functions"", {
+  foo <- structure(function() TRUE, class = ""foo"")
+  expect_equal(obj_type(foo), ""function"")
+})
+
 # Object standardisation -------------------------------------------------------
 
 test_that(""generators standardised to classes"", {"
r-lib,roxygen2,f3f4f90b4202d2a1236c9003c8dd7a9344ced9f3,hadley,h.wickham@gmail.com,2016-08-29T16:02:59Z,hadley,h.wickham@gmail.com,2016-08-29T16:02:59Z,"Don't write files without name/title

Fixes #474",NAMESPACE;NEWS.md;R/roclet-rd.R;tests/testthat/test-alias.R;tests/testthat/test-doctype.R;tests/testthat/test-examples.R;tests/testthat/test-keyword.R;tests/testthat/test-param.R;tests/testthat/test-raw.R;tests/testthat/test-rd.R;tests/testthat/test-srcref-comment.R;tests/testthat/test-topic-name.R;tests/testthat/test-usage.R,False,True,True,False,44,7,51,"---FILE: NAMESPACE---
@@ -93,7 +93,6 @@ S3method(roc_output,namespace)
 S3method(roc_output,rd_roclet)
 S3method(roc_output,vignette)
 S3method(roc_process,namespace)
-S3method(roc_process,rd_roclet)
 S3method(roc_process,vignette)
 export(default_data_format)
 export(is_s3_generic)

---FILE: NEWS.md---
@@ -1,5 +1,9 @@
 # roxygen2 5.0.1.9000
 
+* Roxygen will no longer write out topics that don't have a name or title,
+  and will instead generate a warning. This makes it easier to detect if
+  you've accidentally used `@rdname` with an incorrect value (#474).
+
 * The usage of replacement functions uses non-breaking spaces so that `<-`
   will never get put on its own line (#484).
 

---FILE: R/roclet-rd.R---
@@ -49,7 +49,7 @@ rd_roclet <- function() {
   new_roclet(list(), ""rd_roclet"")
 }
 
-#' @export
+#' @rdname blah
 roc_process.rd_roclet <- function(roclet, parsed, base_path, options = list()) {
   # Look at all blocks with roxygen comments
   blocks <- Filter(function(x) length(x) > 1, parsed$blocks)
@@ -63,6 +63,15 @@ roc_process.rd_roclet <- function(roclet, parsed, base_path, options = list()) {
     topics[[new$filename]] <- merge.rd_file(old, new$rd)
   }
 
+  # Drop any topics that don't have a title
+  for (topic in names(topics)) {
+    has_name_title <- c(""title"", ""name"") %in% names(topics[[topic]])
+    if (!all(has_name_title)) {
+      warning(topic, "" is missing name/title. Skipping"", call. = FALSE)
+      topics[[topic]] <- NULL
+    }
+  }
+
   topics <- process_family(topics)
   topics <- process_inherit_params(topics)
   fix_params_order(topics)

---FILE: tests/testthat/test-alias.R---
@@ -3,7 +3,7 @@ context(""Alias"")
 test_that(""aliases split into pieces"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' @aliases a b
-    #'
+    #' @title a
     #' @name a
     NULL"")[[1]]
 
@@ -14,10 +14,12 @@ test_that(""aliases split into pieces"", {
 test_that(""aliases escaped, not quoted"", {
   out1 <- roc_proc_text(rd_roclet(), ""
     #' @aliases a
+    #' @title a
     #' @name %a%
     NULL"")[[1]]
   out2 <- roc_proc_text(rd_roclet(), ""
     #' @aliases %a%
+    #' @title a
     #' @name a
     NULL"")[[1]]
   alias1 <- format(get_tag(out1, ""alias""))
@@ -29,6 +31,7 @@ test_that(""aliases escaped, not quoted"", {
 test_that(""can use NULL to suppress default aliases"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' @aliases NULL
+    #' @title a
     #' @name a
     NULL"")[[1]]
 

---FILE: tests/testthat/test-doctype.R---
@@ -5,12 +5,12 @@ context(""docType"")
 test_that(""@docType package automatically adds package alias when needed"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' @name a
-    #'
+    #' @title a
     #' @docType package
     NULL
 
     #' @name a-package
-    #'
+    #' @title a
     #' @docType package
     NULL"")
 

---FILE: tests/testthat/test-examples.R---
@@ -3,9 +3,9 @@ context(""Examples"")
 test_that(""@example loads from specified files"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' @name a
+    #' @title a
     #'
     #' @example Rd-example-1.R
-    #'
     #' @example Rd-example-2.R
     NULL"")[[1]]
 
@@ -17,6 +17,7 @@ test_that(""@example loads from specified files"", {
 test_that(""@examples captures examples"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' @name a
+    #' @title a
     #'
     #' @examples a <- 2
     #'
@@ -29,6 +30,7 @@ test_that(""@examples captures examples"", {
 test_that(""@examples and @example combine"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' @name a
+    #' @title a
     #' @example Rd-example-1.R
     #' @examples a <- 2
     NULL"")[[1]]
@@ -41,6 +43,7 @@ test_that(""@examples and @example combine"", {
 test_that(""@example does not introduce extra empty lines"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' @name a
+    #' @title a
     #' @example Rd-example-3.R
     NULL"")[[1]]
 
@@ -52,6 +55,7 @@ test_that(""@example gives warning if used instead of @examples"", {
   expect_warning(
     out <- roc_proc_text(rd_roclet(), ""
       #' @name a
+      #' @title a
       #' @example
       #' a <- 1
       #' a + b
@@ -66,6 +70,7 @@ test_that(""@example gives warning if used instead of @examples"", {
 test_that(""indentation in examples preserved"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' @name a
+    #' @title a
     #' @examples a <-
     #'     2
     NULL"")[[1]]
@@ -77,6 +82,7 @@ test_that(""indentation in examples preserved"", {
 test_that(""% and \\ in @example escaped"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' @name a
+    #' @title a
     #' @example Rd-example-4.R
     NULL"")[[1]]
 
@@ -87,6 +93,7 @@ test_that(""% and \\ in @example escaped"", {
 test_that(""\\dontrun in @example unescaped"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' @name a
+    #' @title a
     #' @example Rd-example-5.R
     NULL"")[[1]]
 
@@ -97,6 +104,7 @@ test_that(""\\dontrun in @example unescaped"", {
 test_that(""% in @examples escaped before matching braces test (#213)"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' @name a
+    #' @title a
     #' @examples
     #' {a %% b}
     NULL"")[[1]]
@@ -108,6 +116,7 @@ test_that(""% in @examples escaped before matching braces test (#213)"", {
 test_that(""multiple examples (#470)"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' @name a
+    #' @title a
     #' @examples
     #' TRUE
     #' @examples

---FILE: tests/testthat/test-keyword.R---
@@ -3,6 +3,7 @@ context(""Keyword"")
 test_that(""keywords split into pieces"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' @keywords a b
+    #' @title a
     #' @name a
     NULL"")[[1]]
 

---FILE: tests/testthat/test-param.R---
@@ -2,6 +2,7 @@ context(""Param"")
 
 test_that(""@param documents arguments"", {
   out <- roc_proc_text(rd_roclet(), ""
+    #' A
     #' @param a an incipit letter
     #' @param z a terminal letter
     a <- function(a=1, z=2) {}"")[[1]]
@@ -13,6 +14,7 @@ test_that(""@param documents arguments"", {
 
 test_that(""grouped args get spaces"", {
   out <- roc_proc_text(rd_roclet(), ""
+  #' A
   #' @param a,z Two arguments an incipit letter
   a <- function(a=1, z=2) {}"")[[1]]
 
@@ -79,6 +81,7 @@ test_that(""@inheritParam understands compound docs"", {
 
 test_that(""data objects don't get params"", {
   out <- roc_proc_text(rd_roclet(), ""
+    #' x
     #' @rdname xy
     x <- 'x'
   "")[[1]]

---FILE: tests/testthat/test-raw.R---
@@ -4,17 +4,19 @@ test_that(""rawRd inserted unchanged"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' @rawRd #this is a comment
     #' @name a
+    #' @title a
     NULL"")[[1]]
 
   lines <- strsplit(format(out), ""\n"")[[1]]
-  expect_equal(lines[[5]], ""#this is a comment"")
+  expect_equal(lines[[6]], ""#this is a comment"")
 })
 
 test_that(""evalRd must be valid code"", {
   expect_warning(
     roc_proc_text(rd_roclet(), ""
       #' @evalRd a +
       #' @name a
+      #' @title a
       NULL""),
     ""code failed to parse""
   )
@@ -25,6 +27,7 @@ test_that(""rawRd inserted unchanged"", {
     z <- 10
     #' @evalRd z * 2
     #' @name a
+    #' @title a
     NULL"")[[1]]
 
   args <- get_tag(out, ""rawRd"")$values

---FILE: tests/testthat/test-rd.R---
@@ -12,6 +12,7 @@ test_that(""NULL gives empty list"", {
 
 test_that(""generic keys produce expected output"", {
   out <- roc_proc_text(rd_roclet(), ""
+    #' @title a
     #' @references test
     #' @note test
     #' @author test

---FILE: tests/testthat/test-srcref-comment.R---
@@ -2,6 +2,7 @@ context(""srcref"")
 test_that(""Source reference is included as comment"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' @name a
+    #' @title a
     #' @docType package
     NULL"")
 
@@ -12,6 +13,7 @@ test_that(""Source reference is included as comment"", {
 test_that(""Explicit @backref is included as comment"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' @name a
+    #' @title a
     #' @backref back/ref.file
     #' @backref root.file
     #' @docType package

---FILE: tests/testthat/test-topic-name.R---
@@ -62,6 +62,7 @@ test_that(""quoted names captured from assignment"", {
 
 test_that(""@name overides default"", {
   out <- roc_proc_text(rd_roclet(), ""
+    #' A
     #' @name b
     a <- function() {}"")[[1]]
 

---FILE: tests/testthat/test-usage.R---
@@ -126,6 +126,7 @@ test_that(""backticks retained when needed"", {
 
 test_that(""@usage overrides default"", {
   out <- roc_proc_text(rd_roclet(), ""
+    #' A
     #' @usage a(a=2)
     a <- function(a=1) {}"")[[1]]
   expect_equal(get_tag(out, ""usage"")$values, rd(""a(a=2)""))
@@ -145,6 +146,7 @@ test_that(""@usage overrides default for @docType data"", {
 
 test_that(""@usage NULL suppresses default usage"", {
   out <- roc_proc_text(rd_roclet(), ""
+    #' A
     #' @usage NULL
     a <- function(a=1) {}"")[[1]]
 "
r-lib,roxygen2,7bcfb0986adbe29fee339b14c720854ac79467f7,hadley,h.wickham@gmail.com,2016-08-29T15:41:27Z,hadley,h.wickham@gmail.com,2016-08-29T15:41:27Z,"Use nbsp in replacement fun usage

Fixes #484",NEWS.md;R/usage.R;tests/testthat/test-usage.R,False,True,True,False,16,1,17,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 5.0.1.9000
 
+* The usage of replacement functions uses non-breaking spaces so that `<-`
+  will never get put on its own line (#484).
+
 * Give nice warning message if you accidentally use `@example` instead of 
   `@examples` (#494).
 

---FILE: R/usage.R---
@@ -88,7 +88,7 @@ function_usage <- function(name, formals, format_name = identity) {
     formals$value <- NULL
 
     arglist <- args_string(usage_args(formals))
-    build_rd(format_name(name), ""("", arglist, "") <- value"")
+    build_rd(format_name(name), ""("", arglist, "")\u{A0}<-\u{A0}value"")
   } else if (is_infix_fun(name) && identical(format_name, identity)) {
     # If infix, and regular function, munge format
     arg_names <- names(formals)

---FILE: tests/testthat/test-usage.R---
@@ -296,3 +296,15 @@ test_that(""breaking works after escapes (#265)"", {
   usage <- format(get_tag(out, ""usage""))
   expect_equal(str_count(usage, ""\n""), 5)
 })
+
+test_that(""replacement funs get non-breaking spaces"", {
+  out <- roc_proc_text(rd_roclet(), ""
+    #' Function long usage
+    `long_replacement_fun<-` <- function(x,
+        a = 'aaaaaaaaaaaaaaaa',
+        b = 'aaaaaaaaaaaaaaaa',
+        value) {}
+  "")[[1]]
+  usage <- format(get_tag(out, ""usage""))
+  expect_match(usage, "" <- "")
+})"
r-lib,roxygen2,a25c7f759190df4ddd2830789f56558f0309bb0e,hadley,h.wickham@gmail.com,2016-08-29T15:21:56Z,hadley,h.wickham@gmail.com,2016-08-29T15:21:56Z,"Warn on multline `@example`

Fixes #494",NEWS.md;R/roclet-rd.R;tests/testthat/test-examples.R,False,True,True,False,30,0,30,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 5.0.1.9000
 
+* Give nice warning message if you accidentally use `@example` instead of 
+  `@examples` (#494).
+
 * Fixed an issue where `.`s were sometimes added between words within
   a `@family` tag (#477, @kevinushey).
 

---FILE: R/roclet-rd.R---
@@ -220,6 +220,18 @@ process_examples <- function(block, base_path) {
   paths <- unlist(block[names(block) == ""example""])
   if (length(paths) > 0) {
     paths <- file.path(base_path, str_trim(paths))
+
+    # Check that haven't accidentally used example instead of examples
+    nl <- str_count(paths, ""\n"")
+    if (any(nl) > 0) {
+      warning(
+        srcref_location(block$srcref), "": "",
+        ""@example spans multiple lines. Do you want @examples?"",
+        call. = FALSE
+      )
+      return(NULL)
+    }
+
     examples <- unlist(lapply(paths, readLines))
     examples <- escape_examples(examples)
 

---FILE: tests/testthat/test-examples.R---
@@ -48,6 +48,21 @@ test_that(""@example does not introduce extra empty lines"", {
   expect_identical(length(examples), 2L)
 })
 
+test_that(""@example gives warning if used instead of @examples"", {
+  expect_warning(
+    out <- roc_proc_text(rd_roclet(), ""
+      #' @name a
+      #' @example
+      #' a <- 1
+      #' a + b
+      NULL"")[[1]],
+    ""@example spans multiple lines""
+  )
+
+  expect_null(get_tag(out, ""examples"")$values, NULL)
+})
+
+
 test_that(""indentation in examples preserved"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' @name a"
r-lib,roxygen2,ab0ed4dfb9ba98655bed03de11e647dbf737a037,Francois Michonneau,francois.michonneau@gmail.Com,2015-12-23T09:38:32Z,Francois Michonneau,francois.michonneau@gmail.Com,2015-12-23T09:38:32Z,fix typo: becuase --> because,man-roxygen/template.R,False,True,True,False,1,1,2,"---FILE: man-roxygen/template.R---
@@ -22,6 +22,6 @@
 #' \item Templates are not parsed recursively, so you can not include templates
 #' from within other templates. 
 #' 
-#' \item Templates must be composed of complete tags - becuase all roxygen tags
+#' \item Templates must be composed of complete tags - because all roxygen tags
 #' are current block tags, they can not be used for inline insertions.
 #' }"
r-lib,roxygen2,2ae8477df47eec88039caf4e9ce056362ef84d2f,Kirill M칲ller,kirill.mueller@ivt.baug.ethz.ch,2015-11-03T11:34:26Z,Kirill M칲ller,kirill.mueller@ivt.baug.ethz.ch,2015-11-03T11:34:26Z,print source location in error message about missing name,R/roclet-rd.R,False,True,True,False,1,1,2,"---FILE: R/roclet-rd.R---
@@ -88,7 +88,7 @@ block_to_rd <- function(block, base_path, env) {
 
   # Determine name
   name <- block$name %||% default_topic_name(block$object) %||%
-    stop(""Missing name"", call. = FALSE)
+    stop(""Missing name at "", srcref_location(block$srcref), call. = FALSE)
   add_tag(rd, new_tag(""name"", name))
 
   # Add backreference to source"
r-lib,roxygen2,e00c7ae444f521598c0469858cf0bec5f806360d,hadley,h.wickham@gmail.com,2015-11-03T11:25:56Z,hadley,h.wickham@gmail.com,2015-11-03T11:25:56Z,News for @kevinushey fix,NEWS.md,False,False,False,False,4,0,4,"---FILE: NEWS.md---
@@ -1,6 +1,10 @@
 # roxygen2 5.0.0.9000
 
+* Use `ls()`, not `names()` to list elements of environment: fixes R 3.1.0
+  incompatibility (#422, @kevinushey).
+
 * `@export` again allows trailing new line (#415).
+
 * Fixed bug in `@noRd`, where usage would cause error (#418).
 
 # roxygen2 5.0.0"
r-lib,roxygen2,d20b9c27aa585c173747a402d99fec468d35a7c2,Thomas Lin Pedersen,thomasp85@gmail.com,2015-10-30T14:07:40Z,Thomas Lin Pedersen,thomasp85@gmail.com,2015-10-30T14:07:40Z,Include fix to #418,NEWS.md,False,False,False,False,1,0,1,"---FILE: NEWS.md---
@@ -1,6 +1,7 @@
 # roxygen2 5.0.0.9000
 
 * `@export` again allows trailing new line (#415).
+* Fixed bug in `@noRd`, where usage would cause error (#418).
 
 # roxygen2 5.0.0
 "
r-lib,roxygen2,c8ad07edd48ae23da2530b738979a21a0a2af202,Thomas Lin Pedersen,thomasp85@gmail.com,2015-10-30T10:57:49Z,Thomas Lin Pedersen,thomasp85@gmail.com,2015-10-30T10:57:49Z,"Fix wrong call in tag_warning at parse.toggle

x should be passed as the first parameter",R/parse-preref.R,False,True,True,False,1,1,2,"---FILE: R/parse-preref.R---
@@ -180,7 +180,7 @@ parse.name <- function(x) {
 
 parse.toggle <- function(x) {
   if (x$val != """") {
-    tag_warning(""has no parameters"")
+    tag_warning(x, ""has no parameters"")
   } else {
     x
   }"
r-lib,roxygen2,361c84e920b7ffe4645a4d2769c5c2f59750e427,hadley,h.wickham@gmail.com,2015-10-29T13:18:47Z,hadley,h.wickham@gmail.com,2015-10-29T13:18:47Z,"Trim @export before checking for extra lines.

Fixes #415",NEWS.md;R/parse-preref.R;tests/testthat/test-namespace.R,False,True,True,False,17,1,18,"---FILE: NEWS.md---
@@ -1,5 +1,7 @@
 # roxygen2 5.0.0.9000
 
+* `@export` again allows trailing new line (#415).
+
 # roxygen2 5.0.0
 
 ## New features

---FILE: R/parse-preref.R---
@@ -135,12 +135,14 @@ words_parser <- function(min = 0, max = Inf) {
 }
 
 parse.words.line <- function(x) {
+  x$val <- str_trim(x$val)
+
   if (str_detect(x$val, ""\n"")) {
     tag_warning(x, ""may only span a single line"")
   } else if (!rdComplete(x$val)) {
     tag_warning(x, ""mismatched braces or quotes"")
   } else {
-    x$val <- str_split(str_trim(x$val), ""\\s+"")[[1]]
+    x$val <- str_split(x$val, ""\\s+"")[[1]]
     x
   }
 }

---FILE: tests/testthat/test-namespace.R---
@@ -1,5 +1,7 @@
 context(""Namespace"")
 
+# @export -----------------------------------------------------------------
+
 test_that(""export detects object name"", {
   out <- roc_proc_text(namespace_roclet(), ""#' @export\na <- function(){}"")
   expect_equal(out, 'export(a)')
@@ -35,6 +37,14 @@ test_that(""multiple export parameters generate multiple exports"", {
   expect_equal(out, c('export(a)', 'export(b)'))
 })
 
+test_that(""export trimmed before line test"", {
+  out <- roc_proc_text(namespace_roclet(), ""
+    #' @export
+    #'
+    a <- function(){}"")
+  expect_equal(out, 'export(a)')
+})
+
 
 test_that(""export detects S4 class"", {
   out <- roc_proc_text(namespace_roclet(), ""#' @export\nsetClass('a')"")
@@ -87,6 +97,8 @@ test_that(""export uses name if no object present"", {
 })
 
 
+
+
 test_that(""default export uses exportClass for RC objects"", {
   out <- roc_proc_text(namespace_roclet(), ""
     #' Title"
r-lib,roxygen2,da847a851352de25b58560efd488c823ed7ae322,hadley,h.wickham@gmail.com,2015-10-28T13:16:42Z,hadley,h.wickham@gmail.com,2015-10-28T13:16:42Z,Improve rdComplete error message,R/parse-preref.R,False,True,True,False,6,6,12,"---FILE: R/parse-preref.R---
@@ -82,7 +82,7 @@ parse.value <- function(x) {
   if (x$val == """") {
     tag_warning(x, ""requires a value"")
   } else if (!rdComplete(x$val)) {
-    tag_warning(x, ""mismatched braces"")
+    tag_warning(x, ""mismatched braces or quotes"")
   } else {
     x$val <- str_trim(x$val)
     x
@@ -110,7 +110,7 @@ parse.examples <- function(x) {
 
   x$val <- escape_examples(gsub(""^\n"", """", x$val))
   if (!rdComplete(x$val, TRUE)) {
-    tag_warning(x, ""mismatched braces"")
+    tag_warning(x, ""mismatched braces or quotes"")
   } else {
     x
   }
@@ -119,7 +119,7 @@ parse.examples <- function(x) {
 words_parser <- function(min = 0, max = Inf) {
   function(x) {
     if (!rdComplete(x$val)) {
-      return(tag_warning(x, ""mismatched braces""))
+      return(tag_warning(x, ""mismatched braces or quotes""))
     }
 
     words <- str_split(str_trim(x$val), ""\\s+"")[[1]]
@@ -138,7 +138,7 @@ parse.words.line <- function(x) {
   if (str_detect(x$val, ""\n"")) {
     tag_warning(x, ""may only span a single line"")
   } else if (!rdComplete(x$val)) {
-    tag_warning(x, ""mismatching braces"")
+    tag_warning(x, ""mismatched braces or quotes"")
   } else {
     x$val <- str_split(str_trim(x$val), ""\\s+"")[[1]]
     x
@@ -151,7 +151,7 @@ parse.name.description <- function(x) {
   } else if (!str_detect(x$val, ""[[:space:]]+"")) {
     tag_warning(x, ""requires name and description"")
   } else if (!rdComplete(x$val)) {
-    tag_warning(x, ""mismatched braces"")
+    tag_warning(x, ""mismatched braces or quotes"")
   } else {
     pieces <- str_split_fixed(str_trim(x$val), ""[[:space:]]+"", 2)
 
@@ -167,7 +167,7 @@ parse.name <- function(x) {
   if (x$val == """") {
     tag_warning(""requires a name"")
   } else if (!rdComplete(x$val)) {
-    tag_warning(""mismatched braces"")
+    tag_warning(""mismatched braces or quotes"")
   } else if (str_count(x$val, ""\\s+"") > 1) {
     tag_warning(""should have only a single argument"")
   } else {"
r-lib,roxygen2,71094ddb6d2209c08319228221e197ed59ddb7af,hadley,h.wickham@gmail.com,2015-10-27T21:51:48Z,hadley,h.wickham@gmail.com,2015-10-27T21:51:48Z,Fix reexport tests,tests/testthat/test-reexport.R,False,True,True,False,1,11,12,"---FILE: tests/testthat/test-reexport.R---
@@ -5,17 +5,7 @@ test_that(""exporting a call to :: produces re-exports documentation"", {
     #' @export
     testthat::auto_test"")[[1]]
 
-  expect_equal(get_tag(out, ""title"")$value, ""Re-exported functions"")
-  expect_equal(get_tag(out, ""reexport"")$value, list(pkg = ""testthat"", fun = ""auto_test""))
-  expect_equal(get_tag(out, ""keyword"")$value, ""internal"")
-})
-
-test_that(""can combine multiple rexports"", {
-  out <- roc_proc_text(rd_roclet(), ""
-    #' @export
-    testthat::auto_test"")[[1]]
-
-  expect_equal(get_tag(out, ""title"")$value, ""Re-exported functions"")
+  expect_equal(get_tag(out, ""title"")$value, ""Objects exported from other packages"")
   expect_equal(get_tag(out, ""reexport"")$value, list(pkg = ""testthat"", fun = ""auto_test""))
   expect_equal(get_tag(out, ""keyword"")$value, ""internal"")
 })"
r-lib,roxygen2,5b3681d96c2942430ab9d567a2aa20db323ed263,hadley,h.wickham@gmail.com,2015-10-27T21:44:20Z,hadley,h.wickham@gmail.com,2015-10-27T21:44:20Z,"Better display of rexported docs.

Fixes #408",NAMESPACE;R/object-defaults.R;R/rd-file-api.R;R/rd-tag-api.R;R/roclet-rd.R;tests/testthat/test-reexport.R,False,True,True,False,51,10,61,"---FILE: NAMESPACE---
@@ -51,6 +51,7 @@ S3method(format,rawRd_tag)
 S3method(format,rcmethods_tag)
 S3method(format,rd_file)
 S3method(format,rd_tag)
+S3method(format,reexport_tag)
 S3method(format,references_tag)
 S3method(format,section_tag)
 S3method(format,seealso_tag)
@@ -63,6 +64,7 @@ S3method(length,rd_file)
 S3method(merge,minidesc_tag)
 S3method(merge,rd_file)
 S3method(merge,rd_tag)
+S3method(merge,reexport_tag)
 S3method(merge,section_tag)
 S3method(names,rd_file)
 S3method(obj_type,""function"")

---FILE: R/object-defaults.R---
@@ -30,16 +30,11 @@ object_defaults.data <- function(x) {
 #' @export
 object_defaults.import <- function(x) {
   list(
+    docType = ""import"",
     name = ""reexports"",
     keywords = ""internal"",
-    title = ""Re-exported functions"",
-    description = paste0(
-      ""These functions have been imported from other packages, and reimported "",
-      ""by this package so that you can use them without having to attach "",
-      ""another package. See the original documentation, linked to below, for "",
-      ""more details""
-    ),
-    seealso = paste0(""\\code{\\link["", x$value$pkg, ""]{"", escape(x$value$fun), ""}}, "")
+    title = ""Objects exported from other packages"",
+    reexport = list(pkg = x$value$pkg, fun = x$value$fun)
   )
 }
 

---FILE: R/rd-file-api.R---
@@ -25,7 +25,7 @@ format.rd_file <- function(x, ...) {
   tags <- as.list(x[[1]])
   order <- c(""backref"", ""docType"", ""encoding"", ""name"", ""alias"", ""title"",
     ""format"", ""source"", ""usage"", ""param"", ""value"", ""description"",
-    ""details"", ""minidesc"", ""field"", ""slot"", ""rcmethods"", ""note"",
+    ""details"", ""minidesc"", ""reexport"", ""field"", ""slot"", ""rcmethods"", ""note"",
     ""section"", ""examples"", ""author"", ""references"", ""seealso"",
     ""concept"", ""keyword"", ""rawRd"")
 

---FILE: R/rd-tag-api.R---
@@ -76,6 +76,16 @@ merge.section_tag <- function(x, y, ...) {
   new_tag(""section"", values)
 }
 
+#' @export
+merge.reexport_tag <- function(x, y, ...) {
+  values <- list(
+    pkg = c(x$values$pkg, y$values$pkg),
+    fun = c(x$values$fun, y$values$fun)
+  )
+  new_tag(""reexport"", values)
+}
+
+
 # Comment tags -----------------------------------------------------------------------
 
 #' @export
@@ -246,3 +256,25 @@ format.minidesc_tag <- function(x, ...) {
 format.rawRd_tag <- function(x, ...) {
   paste(x$values, collapse = ""\n"")
 }
+
+
+#' @export
+format.reexport_tag <- function(x, ...) {
+  pkgs <- split(x$values$fun, x$values$pkg)
+  pkg_links <- Map(pkg = names(pkgs), funs = pkgs, function(pkg, funs) {
+    links <- paste0(""\\code{\\link["", pkg, ""]{"", escape(funs), ""}}"",
+      collapse = "", "")
+    paste0(""\\item{"", pkg, ""}{"", links, ""}"")
+  })
+
+  paste0(
+    ""\\description{\n"",
+    ""These objects are imported from other packages. Follow the links\n"",
+    ""below to see their documentation.\n"",
+    ""\n"",
+    ""\\describe{\n"",
+    paste0(""  "", unlist(pkg_links), collapse = ""\n\n""),
+    ""\n}}\n""
+  )
+
+}

---FILE: R/roclet-rd.R---
@@ -131,6 +131,7 @@ block_to_rd <- function(block, base_path, env) {
   add_tag(rd, process_tag(block, ""seealso""))
   add_tag(rd, process_tag(block, ""references""))
   add_tag(rd, process_tag(block, ""concept""))
+  add_tag(rd, process_tag(block, ""reexport""))
   add_tag(rd, process_tag(block, ""return"", function(tag, param) {
     new_tag(""value"", param)
   }))

---FILE: tests/testthat/test-reexport.R---
@@ -1,10 +1,21 @@
 context(""Re-export"")
 
-test_that(""@param documents arguments"", {
+test_that(""exporting a call to :: produces re-exports documentation"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' @export
     testthat::auto_test"")[[1]]
 
   expect_equal(get_tag(out, ""title"")$value, ""Re-exported functions"")
+  expect_equal(get_tag(out, ""reexport"")$value, list(pkg = ""testthat"", fun = ""auto_test""))
+  expect_equal(get_tag(out, ""keyword"")$value, ""internal"")
+})
+
+test_that(""can combine multiple rexports"", {
+  out <- roc_proc_text(rd_roclet(), ""
+    #' @export
+    testthat::auto_test"")[[1]]
+
+  expect_equal(get_tag(out, ""title"")$value, ""Re-exported functions"")
+  expect_equal(get_tag(out, ""reexport"")$value, list(pkg = ""testthat"", fun = ""auto_test""))
   expect_equal(get_tag(out, ""keyword"")$value, ""internal"")
 })"
r-lib,roxygen2,15b035b60256ad712bc8166a7a7616b3f90b1586,hadley,h.wickham@gmail.com,2015-10-27T19:21:48Z,hadley,h.wickham@gmail.com,2015-10-27T19:21:48Z,"More carefully trim whitespace.

Closes #411. Closes #414. Fixes #413.",R/parse-preref.R;man/default_data_format.Rd;man/is_s3_generic.Rd;man/roxygen2-package.Rd;tests/testthat/test-merge.R;tests/testthat/test-template.R,False,True,True,False,16,8,24,"---FILE: R/parse-preref.R---
@@ -80,6 +80,7 @@ parse.value <- function(x) {
   } else if (!rdComplete(x$val)) {
     tag_warning(x, ""mismatched braces"")
   } else {
+    x$val <- str_trim(x$val)
     x
   }
 }
@@ -166,6 +167,7 @@ parse.name <- function(x) {
   } else if (str_count(x$val, ""\\s+"") > 1) {
     tag_warning(""should have only a single argument"")
   } else {
+    x$val <- str_trim(x$val)
     x
   }
 }

---FILE: man/default_data_format.Rd---
@@ -11,7 +11,6 @@ default_data_format(x)
 }
 \value{
 A \code{character} value with valid \code{Rd} syntax, or \code{NULL}.
-
 }
 \description{
 This function is called to generate the default ""Format"" section for each

---FILE: man/is_s3_generic.Rd---
@@ -15,13 +15,11 @@ is_s3_method(name, env = parent.frame())
 \item{env}{Base environment in which to look for function defintion.}
 }
 \description{
-
 \code{is_s3_generic} compares name to \code{.knownS3Generics} and
 \code{.S3PrimitiveGenerics}, then looks at the function body to see if it
 calls \code{\link{UseMethod}}.
 
 \code{is_s3_method} builds names of all possible generics for that function
 and then checks if any of them actually is a generic.
-
 }
 

---FILE: man/roxygen2-package.Rd---
@@ -10,16 +10,13 @@ A 'Doxygen'-like in-source documentation system
 for Rd, collation, and 'NAMESPACE' files.
 }
 \details{
-
 If you have existing Rd files, check out the \code{Rd2roxygen} package
 for a convenient way of converting Rd files to roxygen comments.
-
 }
 \examples{
 \dontrun{roxygenize('pkg')}
 }
 \author{
-
 Hadley Wickham \email{h.wickham@gmail.com},
 Peter Danenberg \email{pcd@roxygen.org},
 Manuel Eugster \email{Manuel.Eugster@stat.uni-muenchen.de}

---FILE: tests/testthat/test-merge.R---
@@ -37,7 +37,7 @@ test_that(""@section-s with identical titles are merged"", {
 
   expect_equal(
     get_tag(out, ""section"")$values,
-    list(structure(list(name = ""Haz dox"", content = "" Here.\n\n\n\n  Got news."")),
+    list(structure(list(name = ""Haz dox"", content = "" Here.\n\n\n  Got news."")),
          structure(list(name = ""TL"", content = "" DR."")),
          structure(list(name = ""RT"", content = "" FM.""))))
 })
@@ -63,7 +63,7 @@ test_that(""@section-s with different titles are kept as they are"", {
 
   expect_equal(
     get_tag(out, ""section"")$values,
-    list(structure(list(name = ""Haz dox"", content = "" Here.\n"")),
+    list(structure(list(name = ""Haz dox"", content = "" Here."")),
          structure(list(name = ""TL"", content = "" DR."")),
          structure(list(name = ""OBTW"", content = ""\n  Got news."")),
          structure(list(name = ""MKAY"", content = "" kthxbye""))))

---FILE: tests/testthat/test-template.R---
@@ -29,3 +29,15 @@ test_that(""templates replace variables with their values"", {
   expect_equal(get_tag(out, ""title"")$values, ""a"")
   expect_equal(get_tag(out, ""param"")$values, c(b = ""c""))
 })
+
+test_that(""allow empty line after @template"", {
+  out <- roc_proc_text(rd_roclet(), ""
+    #' @template values
+    #'
+    #' @templateVar x a
+    #' @templateVar y b
+    #' @templateVar z c
+    x <- 10"")[[1]]
+
+  expect_equal(get_tag(out, ""title"")$values, ""a"")
+})"
r-lib,roxygen2,f8492c63d06d4f53a977170af96419ccb37b1ac4,hadley,h.wickham@gmail.com,2015-10-27T19:01:59Z,hadley,h.wickham@gmail.com,2015-10-27T19:01:59Z,More tweaks to rdComplete. Fixes #407,src/isComplete.cpp;tests/testthat/test-rdComplete.R,False,True,True,False,53,23,76,"---FILE: src/isComplete.cpp---
@@ -10,40 +10,54 @@ bool rdComplete(std::string string, bool is_code = false) {
 
   char in_string = '\0';
   bool in_escape = false;
-  bool in_comment = false;
-  int braces = 0;
+  bool in_r_comment = false;
+  bool in_latex_comment = false;
+  int braces = 0, r_braces = 0;
 
   for(int i = 0; i < n; i++) {
     char cur = string[i];
 
-    if (in_string != '\0') {
+    if (in_escape) {
+      // Swallow escaped characters
+      in_escape = false;
+    } else if (in_string != '\0') {
+      // Look for end of string
       if (cur == in_string) {
         in_string = false;
+      } else if (cur == '\\') {
+        in_escape = true;
       }
-      continue;
-    }
-
-    if (in_comment) {
+    } else if (in_r_comment) {
+      // Inside R comments, braces must match.
+      // R comments are terminated by newline or } not matched by {
       if (cur == '\n') {
-        in_comment = false;
+        in_r_comment = false;
+        r_braces = 0;
+      } else if (cur == '{') {
+        braces++;
+        r_braces++;
+      } else if (cur == '}') {
+        braces--;
+        r_braces--;
+        if (r_braces == 0)
+          in_r_comment = false;
+      }
+    } else if (in_latex_comment) {
+      if (cur == '\n') {
+        in_latex_comment = false;
+      }
+    } else {
+      switch(cur) {
+      case '{':  braces++; break;
+      case '}':  braces--; break;
+      case '\\': in_escape = true; break;
+      case '#':  if (is_code) in_r_comment = true; break;
+      case '%':  in_latex_comment = true; break;
+      case '\'': if (is_code) in_string = '\''; break;
+      case '""':  if (is_code) in_string = '""'; break;
       }
-      continue;
-    }
-
-    if (in_escape) {
-      in_escape = false;
-      continue;
     }
 
-    switch(cur) {
-    case '{':  braces++; break;
-    case '}':  braces--; break;
-    case '\\': in_escape = true; break;
-    case '#':  in_comment = true;
-    case '%':  in_comment = true; break;
-    case '\'': if (is_code) in_string = '\''; break;
-    case '""':  if (is_code) in_string = '""'; break;
-    }
   }
 
   return braces == 0 && !in_escape && !in_string;

---FILE: tests/testthat/test-rdComplete.R---
@@ -25,6 +25,10 @@ test_that(""brackets in comments are ignored"", {
   expect_true(rdComplete(""% }""))
 })
 
+test_that(""R comments don't close latex-like tags"", {
+  expect_true(rdComplete(""A comment \\code{#}.""))
+})
+
 test_that(""newline ends comment"", {
   expect_false(rdComplete(""%\n{""))
 })
@@ -38,6 +42,11 @@ test_that(""strings must be closed in code"", {
   expect_false(rdComplete('""', TRUE))
 })
 
+test_that(""strings respect escapes"", {
+  expect_false(rdComplete(""'\\'"", TRUE)) # '\'
+  expect_true(rdComplete(""'\\''"", TRUE)) # '\''
+})
+
 test_that(""braces in strings don't need to match in code"", {
   expect_true(rdComplete(""'{{'"", TRUE))
 })
@@ -46,6 +55,13 @@ test_that(""strings in code comments don't need to be closed"", {
   expect_true(rdComplete(""# '"", TRUE))
 })
 
+test_that(""braces in code must match"", {
+  expect_false(rdComplete(""# {"", TRUE))
+  expect_true(rdComplete(""# {}"", TRUE))
+})
+
+
+
 
 # Test that incomplete Rd is caught in Rd blocks -------------------------------
 "
r-lib,roxygen2,117adab4eb21f00872e1c5fbcf73d8f85824dd90,hadley,h.wickham@gmail.com,2015-10-21T21:29:33Z,hadley,h.wickham@gmail.com,2015-10-21T21:29:33Z,Trim whitespace. Fixes #406,R/parse-preref.R,False,True,True,False,3,3,6,"---FILE: R/parse-preref.R---
@@ -117,7 +117,7 @@ words_parser <- function(min = 0, max = Inf) {
       return(tag_warning(x, ""mismatched braces""))
     }
 
-    words <- str_split(x$val, ""\\s+"")[[1]]
+    words <- str_split(str_trim(x$val), ""\\s+"")[[1]]
     if (length(words) < min) {
       tag_warning(x,  "" needs at least "", min, "" words"")
     } else if (length(words) > max) {
@@ -135,7 +135,7 @@ parse.words.line <- function(x) {
   } else if (!rdComplete(x$val)) {
     tag_warning(x, ""mismatching braces"")
   } else {
-    x$val <- str_split(x$val, ""\\s+"")[[1]]
+    x$val <- str_split(str_trim(x$val), ""\\s+"")[[1]]
     x
   }
 }
@@ -148,7 +148,7 @@ parse.name.description <- function(x) {
   } else if (!rdComplete(x$val)) {
     tag_warning(x, ""mismatched braces"")
   } else {
-    pieces <- str_split_fixed(x$val, ""[[:space:]]+"", 2)
+    pieces <- str_split_fixed(str_trim(x$val), ""[[:space:]]+"", 2)
 
     x$val <- list(
       name = pieces[, 1],"
r-lib,roxygen2,9ee3413d4f014e472f1feb803c3901e7bcf20c8b,hadley,h.wickham@gmail.com,2015-10-21T15:38:00Z,hadley,h.wickham@gmail.com,2015-10-21T15:38:00Z,"Export functions from other packages

Fixes #376",DESCRIPTION;NAMESPACE;NEWS.md;R/object-defaults.R;R/object-from-call.R;R/object.R;man/object.Rd;tests/testthat/test-reexport.R,False,True,True,False,50,5,55,"---FILE: DESCRIPTION---
@@ -19,7 +19,8 @@ Imports:
     brew,
     digest,
     methods,
-    Rcpp (>= 0.11.0)
+    Rcpp (>= 0.11.0),
+    magrittr
 Suggests:
     testthat (>= 0.8.0),
     knitr,

---FILE: NAMESPACE---
@@ -76,6 +76,7 @@ S3method(obj_type,s3generic)
 S3method(obj_type,s3method)
 S3method(object_defaults,data)
 S3method(object_defaults,default)
+S3method(object_defaults,import)
 S3method(object_defaults,package)
 S3method(object_defaults,rcclass)
 S3method(object_defaults,s4class)

---FILE: NEWS.md---
@@ -1,5 +1,17 @@
 # roxygen2 4.1.1.9000
 
+*   You can now easily import and re-export functions from another package 
+    with:
+
+    ```R
+    #' @export
+    magrittr::`%>%`
+    ```
+    
+    All imported-and-re-exported functions will be documented in the same
+    file, containing a brief descrption and links to the original 
+    documentation (#376).
+
 * New tag `@rawRd` allows you to insert raw (unescaped) Rd code. `@evalRd()` is 
   similar, but instead of literal Rd, you give it R code that produces literal 
   Rd code when run. This should make it easier to experiment with new types of 

---FILE: R/object-defaults.R---
@@ -24,6 +24,22 @@ object_defaults.data <- function(x) {
   )
 }
 
+#' @export
+object_defaults.import <- function(x) {
+  list(
+    name = ""reexports"",
+    keywords = ""internal"",
+    title = ""Re-exported functions"",
+    description = paste0(
+      ""These functions have been imported from other packages, and reimported "",
+      ""by this package so that you can use them without having to attach "",
+      ""another package. See the original documentation, linked to below, for "",
+      ""more details""
+    ),
+    seealso = paste0(""\\code{\\link["", x$value$pkg, ""]{"", escape(x$value$fun), ""}}, "")
+  )
+}
+
 #' @export
 object_defaults.package <- function(x) {
   desc <- x$value$desc

---FILE: R/object-from-call.R---
@@ -129,3 +129,10 @@ parser_setReplaceMethod <- function(call, env, block) {
 
   object(value)
 }
+
+`parser_::` <- function(call, env, block) {
+  pkg <- as.character(call[[2]])
+  fun <- as.character(call[[3]])
+
+  object(list(pkg = pkg, fun = fun), alias = fun, type = ""import"")
+}

---FILE: R/object.R---
@@ -8,9 +8,7 @@
 #'   generator function with different name.
 #' @export
 #' @keywords internal
-object <- function(value, alias = NULL) {
-  type <- obj_type(value)
-
+object <- function(value, alias = NULL, type = obj_type(value)) {
   structure(
     list(
       alias = alias,

---FILE: man/object.Rd---
@@ -4,7 +4,7 @@
 \alias{object}
 \title{Constructors for S3 object to represent R objects.}
 \usage{
-object(value, alias = NULL)
+object(value, alias = NULL, type = obj_type(value))
 }
 \arguments{
 \item{value}{The object itself.}

---FILE: tests/testthat/test-reexport.R---
@@ -0,0 +1,10 @@
+context(""Re-export"")
+
+test_that(""@param documents arguments"", {
+  out <- roc_proc_text(rd_roclet(), ""
+    #' @export
+    testthat::auto_test"")[[1]]
+
+  expect_equal(get_tag(out, ""title"")$value, ""Re-exported functions"")
+  expect_equal(get_tag(out, ""keyword"")$value, ""internal"")
+})"
r-lib,roxygen2,4ed56d2dac05ef422bcede57f1c55c02c68b191a,Gabor Csardi,csardi.gabor@gmail.com,2015-10-21T12:44:32Z,Gabor Csardi,csardi.gabor@gmail.com,2015-10-21T12:44:32Z,"Fix, whitespace was detected as intro @details

This was added in be2d3ea70075f52de3c6b33471c00161d54c7b87",R/parse-preref.R;tests/testthat/test-introduction.R,False,True,True,False,19,0,19,"---FILE: R/parse-preref.R---
@@ -24,6 +24,7 @@ parse_description <- function(tags) {
   }
 
   intro <- tags[[1]]
+  intro$val <- str_trim(intro$val)
   tags <- tags[-1]
   tag_names <- tag_names[-1]
 

---FILE: tests/testthat/test-introduction.R---
@@ -88,3 +88,21 @@ test_that(""details are merged if needed"", {
   expect_equal(get_tag(out, ""details"")$values,
                ""Details1\n\nDetails2\n\nDetails3\n\nDetails4"")
 })
+
+test_that(""whitespace is not detected as details"", {
+  expect_silent(
+    out <- roc_proc_text(
+      rd_roclet(), ""
+        #' Title
+        #'
+        #'
+        #' Description
+        #'
+        #'
+        #'
+        foo <- function(x) {}""
+    )[[1]]
+  )
+
+  expect_null(get_tag(out, ""details""))
+})"
r-lib,roxygen2,08442dd181c03036b30b7715a1f046585a312a35,hadley,h.wickham@gmail.com,2015-10-20T15:35:24Z,hadley,h.wickham@gmail.com,2015-10-20T15:35:24Z,"Add rawNamespace.

Fixes #385",NEWS.md;R/parse-preref.R;R/roclet-namespace.R;R/roclet-rd.R;tests/testthat/test-raw.R,False,True,True,False,27,4,31,"---FILE: NEWS.md---
@@ -3,7 +3,8 @@
 * New tag `@rawRd` allows you to insert raw (unescaped) Rd code. `@evalRd()` is 
   similar, but instead of literal Rd, you give it R code that produces literal 
   Rd code when run. This should make it easier to experiment with new types of 
-  output (#385). 
+  output. `@rawNamespace` allows you to insert literal text in your namespace:
+  this can be useful for conditional imports (#385). 
 
 * `register.preref.parser()` and `register.preref.parsers()`  have been 
   deprecated - please use `register_tags()` instead.

---FILE: R/parse-preref.R---
@@ -88,7 +88,7 @@ parse.code <- function(x) {
     tag_warning(x, ""requires a value"")
   } else {
     tryCatch({
-      x$val <- parse(text = x$val)
+      parse(text = x$val)
       x
     }, error = function(e) {
       tag_warning(x, ""code failed to parse.\n"", e$message)

---FILE: R/roclet-namespace.R---
@@ -10,12 +10,13 @@ register_tags(
   importClassesFrom = words_parser(2),
   importFrom = words_parser(2),
   importMethodsFrom = words_parser(2),
+  rawNamespace = parse.code,
   S3method = words_parser(2, 2),
   useDynLib = words_parser(1)
 )
 
 ns_tags <- c('export', 'exportClass', 'exportMethod', 'exportPattern',
-  'S3method', 'import', 'importFrom', 'importClassesFrom',
+  'rawNamespace', 'S3method', 'import', 'importFrom', 'importClassesFrom',
   'importMethodsFrom', 'useDynLib')
 
 #' Roclet: make NAMESPACE.
@@ -121,6 +122,7 @@ ns_useDynLib         <- function(tag, part) {
     repeat_first(""useDynLib"", tag)
   }
 }
+ns_rawNamespace       <- function(tag, part) tag
 
 # Functions used by both default_export and ns_* functions
 export           <- function(x) one_per_line(""export"", x)

---FILE: R/roclet-rd.R---
@@ -115,7 +115,8 @@ block_to_rd <- function(block, base_path, env) {
   add_tag(rd, process_doc_type(block))
   add_tag(rd, process_tag(block, ""rawRd""))
   add_tag(rd, process_tag(block, ""evalRd"", function(tag, param) {
-    out <- eval(param, envir = env)
+    expr <- parse(text = param)
+    out <- eval(expr, envir = env)
     new_tag(""rawRd"", as.character(out))
   }))
   add_tag(rd, process_tag(block, ""title""))

---FILE: tests/testthat/test-raw.R---
@@ -30,3 +30,22 @@ test_that(""rawRd inserted unchanged"", {
   args <- get_tag(out, ""rawRd"")$values
   expect_equal(args, ""20"")
 })
+
+test_that(""rawNamespace must be valid code"", {
+  expect_warning(
+    roc_proc_text(namespace_roclet(), ""
+      #' @rawNamespace if() {
+      #' @name a
+      NULL""),
+    ""code failed to parse""
+  )
+})
+
+test_that(""rawNamespace inserted unchanged"", {
+  out <- roc_proc_text(namespace_roclet(), ""
+    #' @rawNamespace xyz
+    #'   abc
+    NULL"")
+
+  expect_equal(out, ""xyz\n  abc"")
+})"
r-lib,roxygen2,6487c93d482789fcf0a382b0da2c54b629623f05,hadley,h.wickham@gmail.com,2015-10-20T11:32:46Z,hadley,h.wickham@gmail.com,2015-10-20T11:32:46Z,"Replace find_includes with custom C++ parser.

Fixes #401",NEWS.md;R/RcppExports.R;R/roclet-collate.R;src/RcppExports.cpp;src/parser2.cpp,False,True,True,False,58,13,71,"---FILE: NEWS.md---
@@ -18,6 +18,10 @@
     
   * Unknown tags now emit a warning, rather than an error.
 
+* The special `@include` parser has also been rewritten in C++, giving
+  a performance boost for larger packages (#401). This is particularly 
+  important because it's also called from `devtools::load_all()`.
+
 * `@inheritParams foo::bar` ensures that `%` remains escaped (#313). 
 
 * Roxygen no longer complains about non-matching braces inside strings

---FILE: R/RcppExports.R---
@@ -13,6 +13,10 @@ tokenise_preref <- function(lines, file = """", offset = 0L) {
     .Call('roxygen2_tokenise_preref', PACKAGE = 'roxygen2', lines, file, offset)
 }
 
+find_includes <- function(path) {
+    .Call('roxygen2_find_includes', PACKAGE = 'roxygen2', path)
+}
+
 splitByWhitespace <- function(string) {
     .Call('roxygen2_splitByWhitespace', PACKAGE = 'roxygen2', string)
 }

---FILE: R/roclet-collate.R---
@@ -70,19 +70,6 @@ generate_collate <- function(base_path) {
   unique(topo$sort())
 }
 
-find_includes <- function(path) {
-  lines <- readLines(path, warn = FALSE)
-  re <- regexec(""^\\s*#+' ?@include (.*)$"", lines)
-  matches <- regmatches(lines, re)
-  matches <- Filter(function(x) length(x) == 2, matches)
-
-  if (length(matches) == 0) return()
-
-  includes <- vapply(matches, ""[["", 2, FUN.VALUE = character(1))
-  includes <- str_trim(includes)
-  sort_c(unlist(strsplit(includes, "" "", fixed = TRUE)))
-}
-
 base_path <- function(path, base) {
   path <- normalizePath(path, winslash = ""/"")
   base <- normalizePath(base, winslash = ""/"")

---FILE: src/RcppExports.cpp---
@@ -41,6 +41,17 @@ BEGIN_RCPP
     return __result;
 END_RCPP
 }
+// find_includes
+CharacterVector find_includes(std::string path);
+RcppExport SEXP roxygen2_find_includes(SEXP pathSEXP) {
+BEGIN_RCPP
+    Rcpp::RObject __result;
+    Rcpp::RNGScope __rngScope;
+    Rcpp::traits::input_parameter< std::string >::type path(pathSEXP);
+    __result = Rcpp::wrap(find_includes(path));
+    return __result;
+END_RCPP
+}
 // splitByWhitespace
 std::vector<std::string> splitByWhitespace(std::string string);
 RcppExport SEXP roxygen2_splitByWhitespace(SEXP stringSEXP) {

---FILE: src/parser2.cpp---
@@ -1,5 +1,7 @@
 #include <Rcpp.h>
 using namespace Rcpp;
+#include <fstream>
+#include <sstream>
 
 class RoxygenLine {
   std::string line_;
@@ -153,3 +155,40 @@ List tokenise_preref(CharacterVector lines, std::string file = """",
   }
   return out;
 }
+
+// [[Rcpp::export]]
+CharacterVector find_includes(std::string path) {
+  std::vector<std::string> includes;
+
+  std::ifstream file(path);
+  if (!file.good())
+    stop(""Failed to open %s"", path);
+
+  std::string rawline;
+  while (std::getline(file, rawline)) {
+    RoxygenLine line(rawline);
+    if (!line.consumeRoxygenComment())
+      continue;
+
+    std::string tag, value;
+    if (!line.consumeTag(&tag))
+      continue;
+    if (tag != ""include"")
+      continue;
+
+    line.consumeWhitespace(1);
+
+    // Split value by whitespace
+    // http://stackoverflow.com/questions/236129/split-a-string-in-c
+    line.consumeText(&value);
+
+    std::istringstream words(value);
+    copy(
+      std::istream_iterator<std::string>(words),
+      std::istream_iterator<std::string>(),
+      back_inserter(includes)
+    );
+  }
+
+  return wrap(includes);
+}"
r-lib,roxygen2,b621690c7ccf42864e07342268c01d5517b9a3cd,hadley,h.wickham@gmail.com,2015-10-19T22:01:59Z,hadley,h.wickham@gmail.com,2015-10-19T22:01:59Z,"Avoid class name overlaps in tests.

And cleanup more carefully. Fixes #400. Fixes #399",tests/testthat/test-alias.R;tests/testthat/test-object.R;tests/testthat/test-rc.R,False,True,True,False,14,10,24,"---FILE: tests/testthat/test-alias.R---
@@ -39,18 +39,18 @@ test_that(""can use NULL to suppress default aliases"", {
 test_that(""refclass with assignment gets both aliases"", {
   out <- roc_proc_text(roc, ""
     #' Title
-    B <- setRefClass('B')
+    B3 <- setRefClass('B3')
   "")[[1]]
 
-  expect_equal(get_tag(out, ""alias"")$value, c(""B-class"", ""B""))
+  expect_equal(get_tag(out, ""alias"")$value, c(""B3-class"", ""B3""))
 })
 
 
 test_that(""refclass gets -class alias"", {
   out <- roc_proc_text(roc, ""
     #' Title
-    setRefClass('B')
+    setRefClass('B2')
   "")[[1]]
 
-  expect_equal(get_tag(out, ""alias"")$value, ""B-class"")
+  expect_equal(get_tag(out, ""alias"")$value, ""B2-class"")
 })

---FILE: tests/testthat/test-object.R---
@@ -80,3 +80,7 @@ test_that(""refclasses get rc_methods listing"", {
   objA <- object(standardise_obj(""A"", A, env = env), ""genA"")
   expect_equal(names(objA$methods), ""f"")
 })
+
+removeClass(""A"", where = env)
+removeClass(""B"", where = env)
+removeClass(""C"", where = env)

---FILE: tests/testthat/test-rc.R---
@@ -27,7 +27,7 @@ test_that(""trim_docstring handles indentation correctly"", {
 
 env <- pkg_env()
 
-A <- setRefClass(""A"", methods = list(
+A1 <- setRefClass(""A1"", methods = list(
   f = function() {
     ""This function has a docstring""
     1
@@ -37,7 +37,7 @@ A <- setRefClass(""A"", methods = list(
   }
 ), where = env)
 
-B <- setRefClass(""B"", contains = ""A"", methods = list(
+B1 <- setRefClass(""B1"", contains = ""A1"", methods = list(
   f1 = function() {
     ""This function has a docstring""
     1
@@ -47,8 +47,8 @@ B <- setRefClass(""B"", contains = ""A"", methods = list(
   }
 ), where = env)
 
-classA <- getClass(""A"", where = env)
-classB <- getClass(""B"", where = env)
+classA <- getClass(""A1"", where = env)
+classB <- getClass(""B1"", where = env)
 
 test_that(""rc_methods only lists methods belong to class (not parents)"", {
   expect_equal(length(rc_methods(classA)), 2)
@@ -71,5 +71,5 @@ test_that(""RC methods included included in own section"", {
   expect_match(methods[[1]], ""This function has a docstring"")
 })
 
-removeClass(""B"", where = env)
-removeClass(""A"", where = env)
+removeClass(""B1"", where = env)
+removeClass(""A1"", where = env)"
r-lib,roxygen2,794cec3e3e33fbaad39847d844ad2f36ce46841c,hadley,h.wickham@gmail.com,2015-10-19T21:51:46Z,hadley,h.wickham@gmail.com,2015-10-19T21:51:46Z,"Also ignore code comments.

This is probably a bit simplistic, as (I think) it will cause problems with constructions like \dontrun{# comment} - fortunately that should be relatively rare.

Fixes #402",src/isComplete.cpp;tests/testthat/test-rdComplete.R,False,True,True,False,8,2,10,"---FILE: src/isComplete.cpp---
@@ -3,7 +3,7 @@ using namespace Rcpp;
 
 // From http://developer.r-project.org/parseRd.pdf:  The characters \, %, {,
 // and } have special meaning in almost all parts of an Rd file. In code,
-// strings must also match
+// strings must also match, except in comments.
 // [[Rcpp::export]]
 bool rdComplete(std::string string, bool is_code = false) {
   int n = string.length();
@@ -39,6 +39,7 @@ bool rdComplete(std::string string, bool is_code = false) {
     case '{':  braces++; break;
     case '}':  braces--; break;
     case '\\': in_escape = true; break;
+    case '#':  in_comment = true;
     case '%':  in_comment = true; break;
     case '\'': if (is_code) in_string = '\''; break;
     case '""':  if (is_code) in_string = '""'; break;

---FILE: tests/testthat/test-rdComplete.R---
@@ -33,7 +33,6 @@ test_that(""escape disables comment"", {
   expect_false(rdComplete(""\\%{""))
 })
 
-
 test_that(""strings must be closed in code"", {
   expect_false(rdComplete(""'"", TRUE))
   expect_false(rdComplete('""', TRUE))
@@ -43,6 +42,11 @@ test_that(""braces in strings don't need to match in code"", {
   expect_true(rdComplete(""'{{'"", TRUE))
 })
 
+test_that(""strings in code comments don't need to be closed"", {
+  expect_true(rdComplete(""# '"", TRUE))
+})
+
+
 # Test that incomplete Rd is caught in Rd blocks -------------------------------
 
 test_that(""incomplete rd in tag raises error"", {
@@ -57,3 +61,4 @@ test_that(""incomplete rd in prequel raises error"", {
     #' Title {
     x <- 1""), ""mismatched braces"")
 })
+"
r-lib,roxygen2,96d55156430e0265de0160253c55c696a26cdbc6,hadley,h.wickham@gmail.com,2015-10-10T14:49:32Z,hadley,h.wickham@gmail.com,2015-10-10T14:49:32Z,Allow multiple # in parser. Fixes #396,src/parser2.cpp;tests/testthat/test-tokenize-block.R,False,True,True,False,8,0,8,"---FILE: src/parser2.cpp---
@@ -39,6 +39,7 @@ class RoxygenLine {
 
     if (!consumeChar('#'))
       return false;
+    while (consumeChar('#'));
 
     if (!consumeChar('\''))
       return false;

---FILE: tests/testthat/test-tokenize-block.R---
@@ -45,6 +45,13 @@ test_that(""leading whitespace is ignored"", {
   expect_equal(tokenise_preref(""   #' abc""), ref)
 })
 
+test_that(""need one or more #"", {
+  ref <- tokenise_preref(""#' abc"")
+
+  expect_equal(tokenise_preref(""##' abc""), ref)
+  expect_equal(tokenise_preref(""###' abc""), ref)
+})
+
 test_that(""@@ becomes @"", {
   expect_equal(tokenise_preref(""#' @tag @@"")[[1]]$val, ""@"")
 })"
r-lib,roxygen2,cc1893f38070039a8f4d414ab2d1ccaa8f6a25ad,hadley,h.wickham@gmail.com,2015-10-09T17:01:11Z,hadley,h.wickham@gmail.com,2015-10-09T17:01:11Z,"Use vectorised replacement in nice_name.

Fixes #394",DESCRIPTION;R/utils.R,False,True,True,False,4,3,7,"---FILE: DESCRIPTION---
@@ -15,6 +15,7 @@ Depends:
     R (>= 3.0.2)
 Imports:
     stringr (>= 0.5),
+    stringi,
     brew,
     digest,
     methods,

---FILE: R/utils.R---
@@ -57,9 +57,9 @@ subs <- matrix(ncol = 2, byrow = T, c(
 subs[, 2] <- paste0(""-"", subs[, 2], ""-"")
 
 nice_name <- function(x) {
-  for(i in seq_len(nrow(subs))) {
-    x <- str_replace_all(x, fixed(subs[i, 1]), subs[i, 2])
-  }
+  x <- stringi::stri_replace_all_fixed(x, subs[, 1], subs[, 2],
+    vectorize_all = FALSE)
+
   # Clean up any remaining
   x <- str_replace_all(x, ""[^A-Za-z0-9_.-]+"", ""-"")
   x <- str_replace_all(x, ""-+"", ""-"")"
r-lib,roxygen2,36a726f797c10c7e6fb16875467a5ebc7039adea,hadley,h.wickham@gmail.com,2015-10-09T15:53:43Z,hadley,h.wickham@gmail.com,2015-10-09T15:53:43Z,"Plumb up new parser.

On roxygen itself, reduces runtime from 0.75 to 0.55s.

Fixes #295. Fixes #235.",DESCRIPTION;NAMESPACE;NEWS.md;R/RcppExports.R;R/parse-preref.R;R/parse.R;R/roxygen-tag.R;R/template.R;R/utils.R;man/is_s3_generic.Rd;man/roxygen.Rd;src/RcppExports.cpp;src/isComplete.cpp;src/parser2.cpp;tests/testthat/test-merge.R;tests/testthat/test-namespace.R;tests/testthat/test-preref.R;tests/testthat/test-rdComplete.R;tests/testthat/test-tokenize-block.R,False,True,True,False,249,195,444,"---FILE: DESCRIPTION---
@@ -49,6 +49,7 @@ Collate:
     'roclet-rd.R'
     'roclet-vignette.R'
     'roclet.R'
+    'roxygen-tag.R'
     'roxygen.R'
     'roxygenize.R'
     's3.R'

---FILE: NAMESPACE---
@@ -80,6 +80,7 @@ S3method(print,object)
 S3method(print,rd)
 S3method(print,rd_file)
 S3method(print,rd_tag)
+S3method(print,roxygen_tag)
 S3method(roc_output,had)
 S3method(roc_output,namespace)
 S3method(roc_output,vignette)

---FILE: NEWS.md---
@@ -1,5 +1,17 @@
 # roxygen2 4.1.1.9000
 
+* I have completely rewritten the block parser in C++ (#295). This gives a nice 
+  performance boost and gives:
+
+  * Better error messages: you now get the exact the line number of the 
+    tag, not just the start of the block.
+    
+  * The parser has been simplified a little: tag now must always start
+    on a new line. This is recommended practice anyway, and it means
+    that escaping inline `@` (with `@@`) is now optional. (#235)
+    
+  * Unknown tags now emit a warning, rather than an error.
+
 * `@inheritParams foo::bar` ensures that `%` remains escaped (#313). 
 
 * Roxygen no longer complains about non-matching braces inside strings

---FILE: R/RcppExports.R---
@@ -1,16 +1,16 @@
 # This file was generated by Rcpp::compileAttributes
 # Generator token: 10BE3573-1514-4C36-9D1C-5A225CD40393
 
-rdComplete <- function(string, is_code = TRUE) {
+rdComplete <- function(string, is_code = FALSE) {
     .Call('roxygen2_rdComplete', PACKAGE = 'roxygen2', string, is_code)
 }
 
 leadingSpaces <- function(lines) {
     .Call('roxygen2_leadingSpaces', PACKAGE = 'roxygen2', lines)
 }
 
-parse_block <- function(lines, offset = 0L) {
-    .Call('roxygen2_parse_block', PACKAGE = 'roxygen2', lines, offset)
+tokenise_preref <- function(lines, file = """", offset = 0L) {
+    .Call('roxygen2_tokenise_preref', PACKAGE = 'roxygen2', lines, file, offset)
 }
 
 splitByWhitespace <- function(string) {

---FILE: R/parse-preref.R---
@@ -1,193 +1,175 @@
-# Parse a preref
-parse.preref <- function(lines) {
-  delimited.lines <- lines[str_detect(lines, LINE.DELIMITER)]
-  trimmed.lines <- str_trim(str_replace(delimited.lines, LINE.DELIMITER, """"),
-    ""right"")
-
-  if (length(trimmed.lines) == 0) return(NULL)
-
-  joined.lines <- paste0(trimmed.lines, collapse = '\n')
-  ## Thanks to Fegis at #regex on Freenode for the
-  ## lookahead/lookbehind hack; as he notes, however, ""it's not
-  ## proper escaping though... it will not split a@@@b.""
-  elements <- strsplit(joined.lines, '(?<!@)@(?!@)', perl = TRUE)[[1]]
-
-  ## Compress the escaped delimeters.
-  elements <- str_replace_all(elements, fixed(""@@""), ""@"")
-
-  parse_elements(elements)
-}
-
-#' @export
-print.roxygen_tag <- function(x, ...) {
-  cat(""["", x$row, "", "", x$col, ""] @"", x$tag, "" "", encodeString(x$val), ""\n"",
-    sep = """")
+parse_preref <- function(x, file, offset = x[[1]]) {
+  tags <- tokenise_preref(as.character(x), file = basename(file), offset = offset)
+  if (length(tags) == 0)
+    return()
+
+  tags <- parse_description(tags)
+  tags <- compact(lapply(tags, parse_tag))
+
+  # Convert to existing named list format - this isn't ideal, but
+  # it's what roxygen already uses
+  vals <- lapply(tags, `[[`, ""val"")
+  names <- vapply(tags, `[[`, ""tag"", FUN.VALUE = character(1))
+  setNames(vals, names)
 }
 
-# Sequence that distinguishes roxygen comment from normal comment.
-LINE.DELIMITER <- '\\s*#+\' ?'
-
-parse_elements <- function(elements) {
-
-  pieces <- str_split_fixed(elements[-1], ""[[:space:]]+"", 2)
-  desc <- process_description(str_trim(elements[1]), pieces)
-  pieces <- rbind(desc, pieces, deparse.level = 0)
-
-  ## Merge multiple @details tags, one might have come from the intro
-  didx <- which(pieces[,1] == ""details"")
-  if (length(didx) > 1) {
-    pieces[didx[1], 2] <- paste(pieces[didx, 2], collapse = ""\n\n"")
-    pieces <- pieces[- didx[-1], , drop = FALSE]
+parse_description <- function(tags) {
+  if (length(tags) == 0) {
+    return(tags)
   }
 
-  parse_element <- function(tag, value) {
-    tag_parser <- preref.parsers[[tag]] %||% parse.unknown
-    tag_parser(tag, value)
+  tag_names <- vapply(tags, `[[`, ""tag"", FUN.VALUE = character(1))
+  if (tag_names[1] != """") {
+    return(tags)
   }
 
-  Map(parse_element, pieces[, 1], pieces[, 2])
-}
-
-# Process title, description and details.
-#
-# Split the introductory matter into its description followed
-# by details (separated by a blank line).
-process_description <- function(intro, other_pieces) {
+  intro <- tags[[1]]
+  tags <- tags[-1]
+  tag_names <- tag_names[-1]
 
-  if (length(intro) == 0 || intro == """") return(NULL)
-
-  paragraphs <- str_trim(str_split(intro, fixed('\n\n'))[[1]])
-
-  piece <- function(p) {
-    pc <- paste(other_pieces[other_pieces[,1] == p, 2], collapse = ""\n"")
-    if (length(pc) > 0 && !identical(pc, """")) pc else NULL
-  }
+  paragraphs <- str_trim(str_split(intro$val, fixed('\n\n'))[[1]])
 
   # 1st paragraph = title (unless has @title)
-  if (!is.null(piece(""title""))) {
+  if (""title"" %in% tag_names) {
     title <- NULL
   } else if (length(paragraphs) > 0) {
-    title <- c(""title"", paragraphs[1])
+    title <- roxygen_tag(""title"", paragraphs[1], intro$file, intro$line)
     paragraphs <- paragraphs[-1]
   } else {
-    title <- c(""title"", """")
+    title <- roxygen_tag(""title"", """", intro$file, intro$line)
   }
 
   # 2nd paragraph = description (unless has @description)
-  if (!is.null(piece(""description""))) {
+  if (""description"" %in% tag_names) {
     description <- NULL
   } else if (length(paragraphs) > 0) {
-    description <- c(""description"", paragraphs[1])
+    description <- roxygen_tag(""description"", paragraphs[1], intro$file, intro$line)
     paragraphs <- paragraphs[-1]
   } else {
     # Description is required, so if missing description, repeat title.
-    description <- c(""description"", title[2] %||% piece(""title""))
+    description <- roxygen_tag(""description"", title$val, intro$file, intro$line)
   }
 
-  # Every thing else = details, combined with @details, in parse_elements
-  if (length(paragraphs) == 0 || paragraphs == """") paragraphs <- NULL
+  # Every thing else = details, combined with @details
   if (length(paragraphs) > 0) {
-    details <- c(""details"", paste(paragraphs, collapse = ""\n\n""))
+    details_para <- paste(paragraphs, collapse = ""\n\n"")
+
+    # Find explicit @details tags
+    didx <- which(tag_names == ""details"")
+    if (length(didx) > 0) {
+      explicit_details <- vapply(tags[didx], `[[`, ""val"",
+        FUN.VALUE = character(1))
+      tags <- tags[-didx]
+      details_para <- paste(c(details_para, explicit_details), collapse = ""\n\n"")
+    }
+
+    details <- roxygen_tag(""details"", details_para, intro$file, intro$line)
   } else {
     details <- NULL
   }
 
-  rbind(title, description, details, deparse.level = 0)
+  c(compact(list(title, description, details)), tags)
 }
 
-parse.unknown <- function(key, rest) {
-  stop(""@"", key, "" is an unknown key"")
-}
+parse_tag <- function(x) {
+  stopifnot(is.roxygen_tag(x))
 
-parse.value <- function(key, rest) {
-  check_rd(key, rest)
-  if (is.null.string(rest)) {
-    stop(""@"", key, ' requires a value')
+  if ((!x$tag %in% names(preref.parsers))) {
+    return(tag_warning(x, ""unknown tag""))
   }
 
-  str_trim(rest)
+  preref.parsers[[x$tag]](x)
 }
 
-# Examples need special parsing because escaping rules are different
-parse.examples <- function(key, rest) {
-  rest <- str_trim(rest)
-  if (rest == """") {
-    stop(""@example requires a value"", call. = FALSE)
+# Individual tag parsers --------------------------------------------------
+
+parse.value <- function(x) {
+  if (x$val == """") {
+    tag_warning(x, ""requires a value"")
+  } else if (!rdComplete(x$val)) {
+    tag_warning(x, ""mismatched braces"")
+  } else {
+    x
   }
+}
 
-  rest <- escape_examples(rest)
-  check_rd(""example"", rest)
+# Examples need special parsing because escaping rules are different
+parse.examples <- function(x) {
+  if (x$val == """") {
+    return(tag_warning(x, ""requires a value""))
+  }
 
-  rest
+  x$val <- escape_examples(gsub(""^\n"", """", x$val))
+  if (!rdComplete(x$val, TRUE)) {
+    tag_warning(x, ""mismatched braces"")
+  } else {
+    x
+  }
 }
 
 words_parser <- function(min = 0, max = Inf) {
-  function(key, rest) {
-    check_rd(key, rest)
+  function(x) {
+    if (!rdComplete(x$val)) {
+      return(tag_warning(x, ""mismatched braces""))
+    }
 
-    words <- str_split(str_trim(rest), ""\\s+"")[[1]]
+    words <- str_split(x$val, ""\\s+"")[[1]]
     if (length(words) < min) {
-      stop(""@"", key, "" needs at least "", min, "" words"", call. = FALSE)
-    }
-    if (length(words) > max) {
-      stop(""@"", key, "" can have at most "", max, "" words"", call. = FALSE)
+      tag_warning(x,  "" needs at least "", min, "" words"")
+    } else if (length(words) > max) {
+      tag_warning(x,  "" can have at most "", max, "" words"")
     }
 
-    words
+    x$val <- words
+    x
   }
 }
 
-parse.words.line <- function(key, rest) {
-  check_rd(key, rest)
-  rest <- str_trim(rest)
-  if (str_detect(rest, ""\n"")) {
-    stop(""@"", key, "" may only span a single line"", call. = FALSE)
+parse.words.line <- function(x) {
+  if (str_detect(x$val, ""\n"")) {
+    tag_warning(x, ""may only span a single line"")
+  } else if (!rdComplete(x$val)) {
+    tag_warning(x, ""mismatching braces"")
+  } else {
+    x$val <- str_split(x$val, ""\\s+"")[[1]]
+    x
   }
-
-  str_split(rest, ""\\s+"")[[1]]
 }
 
+parse.name.description <- function(x) {
+  if (x$val == """") {
+    tag_warning(x, ""requires a value"")
+  } else if (!str_detect(x$val, ""[[:space:]]+"")) {
+    tag_warning(x, ""requires name and description"")
+  } else if (!rdComplete(x$val)) {
+    tag_warning(x, ""mismatched braces"")
+  } else {
+    pieces <- str_split_fixed(x$val, ""[[:space:]]+"", 2)
 
-parse.name.description <- function(key, rest) {
-  check_rd(key, rest)
-  pieces <- str_split_fixed(rest, ""[[:space:]]+"", 2)
-
-  name <- pieces[, 1]
-  rest <- trim_docstring(pieces[, 2])
-
-  if (is.null.string(name)) {
-    stop(""@"", key, ' requires a name and description')
+    x$val <- list(
+      name = pieces[, 1],
+      description = trim_docstring(pieces[, 2])
+    )
+    x
   }
-
-  list(name = name, description = rest)
 }
 
-parse.name <- function(key, name) {
-  check_rd(key, name)
-  name <- str_trim(name)
-
-  if (is.null.string(name)) {
-    stop(""@"", key, ' requires a name')
-  } else if (str_count(name, ""\\s+"") > 1) {
-    stop(""@"", key, ' should only have a single argument')
+parse.name <- function(x) {
+  if (x$val == """") {
+    tag_warning(""requires a name"")
+  } else if (!rdComplete(x$val)) {
+    tag_warning(""mismatched braces"")
+  } else if (str_count(x$val, ""\\s+"") > 1) {
+    tag_warning(""should have only a single argument"")
+  } else {
+    x
   }
-
-  word(name, 1)
 }
 
-parse.toggle <- function(key, rest) {
-  TRUE
-}
-
-
-check_rd <- function(key, text) {
-  if (rdComplete(text, key == ""examples"")) return(TRUE)
-
-  text <- str_trim(text)
-  if (!is.null(key)) {
-    stop(""Mismatched braces: \""@"", key, "" "", text, ""\"""", call. = FALSE)
+parse.toggle <- function(x) {
+  if (x$val != """") {
+    tag_warning(""has no parameters"")
   } else {
-    stop(""Mismatched braces: \"""", text, ""\"""", call. = FALSE)
+    x
   }
-
 }

---FILE: R/parse.R---
@@ -28,16 +28,12 @@ parse_file <- function(file, env) {
   comment_refs <- comments(refs)
 
   extract <- function(call, ref, comment_ref) {
-    comment_ref2 <- list(filename = file, lloc = as.vector(comment_ref))
+    preref <- parse_preref(comment_ref, file)
+    if (length(preref) == 0) return()
 
-    errors_with_srcref(comment_ref2, {
-      preref <- parse.preref(as.character(comment_ref))
-      if (is.null(preref)) return()
-
-      preref$object <- object_from_call(call, env, preref)
-      preref$srcref <- list(filename = file, lloc = as.vector(ref))
-      add_defaults(preref)
-    })
+    preref$object <- object_from_call(call, env, preref)
+    preref$srcref <- list(filename = file, lloc = as.vector(ref))
+    add_defaults(preref)
   }
 
   Map(extract, parsed, refs, comment_refs)

---FILE: R/roxygen-tag.R---
@@ -0,0 +1,37 @@
+
+# roxygen_tag datastructure -----------------------------------------------
+
+roxygen_tag <- function(tag, val, file = """", line = 0) {
+  structure(
+    list(
+      file = file,
+      line = line,
+      tag = tag,
+      val = val
+    ),
+    class = ""roxygen_tag""
+  )
+}
+
+is.roxygen_tag <- function(x) inherits(x, ""roxygen_tag"")
+
+#' @export
+print.roxygen_tag <- function(x, ...) {
+  cat(""["", x$file, "":"", x$line, ""] @"", x$tag, "" "", encodeString(x$val), ""\n"",
+    sep = """")
+}
+
+make_tag_message <- function(x, message) {
+  paste0(
+    ""@"",
+    x$tag,
+    if (x$file != """") paste0("" ["", x$file, ""#"", x$line, ""]""),
+    "": "",
+    message
+  )
+}
+
+tag_warning <- function(x, ...) {
+  warning(make_tag_message(x, paste0(...)), call. = FALSE)
+  NULL
+}

---FILE: R/template.R---
@@ -34,7 +34,7 @@ process_templates <- function(partitum, base_path) {
 
   # Insert templates back in the location where they came from
   partitum_pieces <- lapply(partitum, list)
-  partitum_pieces[template_locs] <- lapply(results, parse.preref)
+  partitum_pieces[template_locs] <- lapply(results, parse_preref, file = ""TEMPLATE"", offset = 0L)
   names(partitum_pieces)[template_locs] <- """"
 
   unlist(partitum_pieces, recursive = FALSE)

---FILE: R/utils.R---
@@ -130,3 +130,8 @@ r_files <- function(path) {
 dots <- function(...) {
   eval(substitute(alist(...)))
 }
+
+compact <- function(x) {
+  null <- vapply(x, is.null, logical(1))
+  x[!null]
+}

---FILE: man/is_s3_generic.Rd---
@@ -15,11 +15,13 @@ is_s3_method(name, env = parent.frame())
 \item{env}{Base environment in which to look for function defintion.}
 }
 \description{
+
 \code{is_s3_generic} compares name to \code{.knownS3Generics} and
 \code{.S3PrimitiveGenerics}, then looks at the function body to see if it
 calls \code{\link{UseMethod}}.
 
 \code{is_s3_method} builds names of all possible generics for that function
 and then checks if any of them actually is a generic.
+
 }
 

---FILE: man/roxygen.Rd---
@@ -18,6 +18,7 @@ for a convenient way of converting Rd files to roxygen comments.
 \dontrun{roxygenize('pkg')}
 }
 \author{
+
 Hadley Wickham \email{h.wickham@gmail.com},
 Peter Danenberg \email{pcd@roxygen.org},
 Manuel Eugster \email{Manuel.Eugster@stat.uni-muenchen.de}

---FILE: src/RcppExports.cpp---
@@ -28,15 +28,16 @@ BEGIN_RCPP
     return __result;
 END_RCPP
 }
-// parse_block
-List parse_block(CharacterVector lines, int offset);
-RcppExport SEXP roxygen2_parse_block(SEXP linesSEXP, SEXP offsetSEXP) {
+// tokenise_preref
+List tokenise_preref(CharacterVector lines, std::string file, int offset);
+RcppExport SEXP roxygen2_tokenise_preref(SEXP linesSEXP, SEXP fileSEXP, SEXP offsetSEXP) {
 BEGIN_RCPP
     Rcpp::RObject __result;
     Rcpp::RNGScope __rngScope;
     Rcpp::traits::input_parameter< CharacterVector >::type lines(linesSEXP);
+    Rcpp::traits::input_parameter< std::string >::type file(fileSEXP);
     Rcpp::traits::input_parameter< int >::type offset(offsetSEXP);
-    __result = Rcpp::wrap(parse_block(lines, offset));
+    __result = Rcpp::wrap(tokenise_preref(lines, file, offset));
     return __result;
 END_RCPP
 }

---FILE: src/isComplete.cpp---
@@ -5,7 +5,7 @@ using namespace Rcpp;
 // and } have special meaning in almost all parts of an Rd file. In code,
 // strings must also match
 // [[Rcpp::export]]
-bool rdComplete(std::string string, bool is_code = true) {
+bool rdComplete(std::string string, bool is_code = false) {
   int n = string.length();
 
   char in_string = '\0';

---FILE: src/parser2.cpp---
@@ -2,15 +2,16 @@
 using namespace Rcpp;
 
 class RoxygenLine {
+  std::string line_;
   const char* begin_;
   const char* end_;
   const char* cur_;
 
 public:
 
-  RoxygenLine(std::string line) {
-    begin_ = cur_ = line.data();
-    end_ = begin_ + line.size();
+  RoxygenLine(const std::string& line) : line_(line) {
+    begin_ = cur_ = line_.data();
+    end_ = begin_ + line_.size();
   }
 
   bool consumeChar(char c) {
@@ -21,11 +22,16 @@ class RoxygenLine {
     return true;
   }
 
-  bool consumeWhitespace() {
-    while (cur_ != end_ && std::isspace(*cur_))
+  int consumeWhitespace(int max = -1) {
+    int i = 0;
+    while (cur_ != end_ && std::isspace(*cur_)) {
       cur_++;
+      i++;
+      if (max > 0 && i >= max)
+        break;
+    }
 
-    return true;
+    return i;
   }
 
   bool consumeRoxygenComment() {
@@ -37,7 +43,7 @@ class RoxygenLine {
     if (!consumeChar('\''))
       return false;
 
-    consumeWhitespace();
+    consumeWhitespace(1);
 
     return true;
   }
@@ -46,7 +52,7 @@ class RoxygenLine {
     if (!consumeChar('@'))
       return false;
 
-    while(cur_ != end_ && std::isalpha(*cur_)) {
+    while(cur_ != end_ && std::isalnum(*cur_) ) {
       pOut->push_back(*cur_);
       cur_++;
     }
@@ -55,9 +61,6 @@ class RoxygenLine {
   }
 
   bool consumeText(std::string* pOut) {
-    if (cur_ == end_)
-      return false;
-
     while (cur_ != end_) {
       if (isEscapedAt()) {
         pOut->push_back('@');
@@ -86,8 +89,17 @@ class RoxygenLine {
 
 };
 
+std::string stripTrailingNewline(std::string x) {
+  if (x[x.size() - 1] == '\n') {
+    x.resize(x.size() - 1);
+  }
+
+  return x;
+}
+
 // [[Rcpp::export]]
-List parse_block(CharacterVector lines, int offset = 0) {
+List tokenise_preref(CharacterVector lines, std::string file = """",
+                     int offset = 0) {
   std::vector<std::string> tags, vals;
   std::vector<int> rows;
 
@@ -102,18 +114,19 @@ List parse_block(CharacterVector lines, int offset = 0) {
 
     std::string tag;
     if (line.consumeTag(&tag)) {
+      line.consumeWhitespace(1);
+
       if (curVal != """" || curTag != """") {
         rows.push_back(curRow);
         tags.push_back(curTag);
         vals.push_back(curVal);
       }
 
       curRow = i + offset;
-      curTag = tag;
-      curVal = """";
+      curTag.assign(tag);
+      curVal.assign("""");
     }
 
-    line.consumeWhitespace();
     line.consumeText(&curVal);
     curVal.push_back('\n');
   }
@@ -130,9 +143,10 @@ List parse_block(CharacterVector lines, int offset = 0) {
 
   for (int i = 0; i < n; ++i) {
     out[i] = List::create(
-      _[""row""] = rows[i],
+      _[""file""] = file,
+      _[""line""] = rows[i] + 1,
       _[""tag""] = tags[i],
-      _[""val""] = vals[i]
+      _[""val""] = stripTrailingNewline(vals[i])
     );
     out[i].attr(""class"") = ""roxygen_tag"";
   }

---FILE: tests/testthat/test-merge.R---
@@ -38,7 +38,7 @@ test_that(""@section-s with identical titles are merged"", {
 
   expect_equal(
     get_tag(out, ""section"")$values,
-    list(structure(list(name = ""Haz dox"", content = "" Here.\n\n\n  Got news."")),
+    list(structure(list(name = ""Haz dox"", content = "" Here.\n\n\n\n  Got news."")),
          structure(list(name = ""TL"", content = "" DR."")),
          structure(list(name = ""RT"", content = "" FM.""))))
 })
@@ -64,7 +64,7 @@ test_that(""@section-s with different titles are kept as they are"", {
 
   expect_equal(
     get_tag(out, ""section"")$values,
-    list(structure(list(name = ""Haz dox"", content = "" Here."")),
+    list(structure(list(name = ""Haz dox"", content = "" Here.\n"")),
          structure(list(name = ""TL"", content = "" DR."")),
          structure(list(name = ""OBTW"", content = ""\n  Got news."")),
          structure(list(name = ""MKAY"", content = "" kthxbye""))))

---FILE: tests/testthat/test-namespace.R---
@@ -127,7 +127,7 @@ test_that(""other namespace tags produce correct output"", {
 })
 
 test_that(""poorly formed importFrom throws error"", {
-  expect_error(roc_proc_text(namespace_roclet(), ""
+  expect_warning(roc_proc_text(namespace_roclet(), ""
     #' @importFrom test
     NULL
   ""), ""needs at least 2 words"")

---FILE: tests/testthat/test-preref.R---
@@ -42,7 +42,10 @@ check <- function(out) {
   )
 }
 
-preref_test <- function(key, rest) toupper(rest)
+preref_test <- function(x) {
+  x$val <- toupper(x$val)
+  x
+}
 
 test_that(""preref parsers are called for tags from intro"", {
 

---FILE: tests/testthat/test-rdComplete.R---
@@ -34,26 +34,26 @@ test_that(""escape disables comment"", {
 })
 
 
-test_that(""strings must be closed"", {
-  expect_false(rdComplete(""'""))
-  expect_false(rdComplete('""'))
+test_that(""strings must be closed in code"", {
+  expect_false(rdComplete(""'"", TRUE))
+  expect_false(rdComplete('""', TRUE))
 })
 
-test_that(""braces in strings don't need to match"", {
-  expect_true(rdComplete(""'{{'""))
+test_that(""braces in strings don't need to match in code"", {
+  expect_true(rdComplete(""'{{'"", TRUE))
 })
 
 # Test that incomplete Rd is caught in Rd blocks -------------------------------
 
 test_that(""incomplete rd in tag raises error"", {
-  expect_error(roc_proc_text(rd_roclet(), ""
+  expect_warning(roc_proc_text(rd_roclet(), ""
     #' Title
     #' @aliases title{
-    1""), ""Mismatched braces"")
+    x <- 1""), ""mismatched braces"")
 })
 
 test_that(""incomplete rd in prequel raises error"", {
-  expect_error(roc_proc_text(rd_roclet(), ""
+  expect_warning(roc_proc_text(rd_roclet(), ""
     #' Title {
-    1""), ""Mismatched braces"")
+    x <- 1""), ""mismatched braces"")
 })

---FILE: tests/testthat/test-tokenize-block.R---
@@ -1,51 +1,50 @@
-context(""parse_block"")
+context(""tokenize_block"")
 
 test_that(""parses into tag and value"", {
-  x <- parse_block(""#' @xyz abc"")
+  x <- tokenise_preref(""#' @xyz abc"")
   expect_equal(length(x), 1)
 
   expect_equal(x[[1]]$tag, ""xyz"")
-  expect_equal(x[[1]]$val, ""abc\n"")
+  expect_equal(x[[1]]$val, ""abc"")
 })
 
 test_that(""description block gets empty tag"", {
-  x <- parse_block(""#' abc"")
+  x <- tokenise_preref(""#' abc"")
   expect_equal(length(x), 1)
 
   expect_equal(x[[1]]$tag, """")
-  expect_equal(x[[1]]$val, ""abc\n"")
+  expect_equal(x[[1]]$val, ""abc"")
 })
 
 test_that(""multi line tags collapsed into one"", {
-  x <- parse_block(c(
+  x <- tokenise_preref(c(
     ""#' @tag abc"",
     ""#'   def""
   ))
   expect_equal(length(x), 1)
-  expect_equal(x[[1]]$val, ""abc\ndef\n"")
+  expect_equal(x[[1]]$val, ""abc\n  def"")
 })
 
 test_that(""description block gets empty tag when followed by tag"", {
-  x <- parse_block(c(
+  x <- tokenise_preref(c(
     ""#' abc"",
     ""#' @xyz abc""
   ))
   expect_equal(length(x), 2)
 
   expect_equal(x[[1]]$tag, """")
-  expect_equal(x[[1]]$val, ""abc\n"")
+  expect_equal(x[[1]]$val, ""abc"")
 
   expect_equal(x[[2]]$tag, ""xyz"")
-  expect_equal(x[[2]]$val, ""abc\n"")
+  expect_equal(x[[2]]$val, ""abc"")
 })
 
-test_that(""whitespace is ignored"", {
-  ref <- parse_block(""#' abc"")
+test_that(""leading whitespace is ignored"", {
+  ref <- tokenise_preref(""#' abc"")
 
-  expect_equal(parse_block(""   #' abc""), ref)
-  expect_equal(parse_block(""#'    abc""), ref)
+  expect_equal(tokenise_preref(""   #' abc""), ref)
 })
 
 test_that(""@@ becomes @"", {
-  expect_equal(parse_block(""#' @tag @@"")[[1]]$val, ""@\n"")
+  expect_equal(tokenise_preref(""#' @tag @@"")[[1]]$val, ""@"")
 })"
r-lib,roxygen2,a54906afa398ae4b9c877bf959999aa205dc3a67,hadley,h.wickham@gmail.com,2015-10-07T15:26:13Z,hadley,h.wickham@gmail.com,2015-10-07T15:26:13Z,"Escape % when importing params from other package.

Fixes #313",NEWS.md;R/rd-parse.R,False,True,True,False,7,3,10,"---FILE: NEWS.md---
@@ -1,5 +1,7 @@
 # roxygen2 4.1.1.9000
 
+* `@inheritParams foo::bar` ensures that `%` remains escaped (#313). 
+
 * Roxygen no longer complains about non-matching braces inside strings
   in examples (#329).
 

---FILE: R/rd-parse.R---
@@ -24,10 +24,12 @@ rd2rd <- function(x) {
 rd_arguments <- function(rd) {
   arguments <- get_tags(rd, ""\\arguments"")[[1]]
   items <- get_tags(arguments, ""\\item"")
-  
+
   values <- lapply(items, function(x) rd2rd(x[[2]]))
+  # Everything else seems to be escaped already, apart from comments
+  values <- lapply(values, function(x) gsub(""%"", ""\\%"", x, fixed = TRUE))
+
   params <- vapply(items, function(x) rd2rd(x[[1]]), character(1))
-  
+
   setNames(values, params)
 }
-"
r-lib,roxygen2,c610953da92d2ce6d57977dcb86f39babb4aeec7,hadley,h.wickham@gmail.com,2015-10-07T14:41:06Z,hadley,h.wickham@gmail.com,2015-10-07T14:41:06Z,"Teach rdComplete about strings.

Fixes #329",NEWS.md;R/RcppExports.R;R/parse-preref.R;src/RcppExports.cpp;src/isComplete.cpp;tests/testthat/test-complete.R,False,True,True,False,38,20,58,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 4.1.1.9000
 
+* Roxygen no longer complains about non-matching braces inside strings
+  in examples (#329).
+
 * Roxygen now records its version in a single place: the `RoxygenNote`
   field in the `DESCRIPTION` (#338).
 

---FILE: R/RcppExports.R---
@@ -1,8 +1,8 @@
 # This file was generated by Rcpp::compileAttributes
 # Generator token: 10BE3573-1514-4C36-9D1C-5A225CD40393
 
-rdComplete <- function(string) {
-    .Call('roxygen2_rdComplete', PACKAGE = 'roxygen2', string)
+rdComplete <- function(string, is_code = TRUE) {
+    .Call('roxygen2_rdComplete', PACKAGE = 'roxygen2', string, is_code)
 }
 
 leadingSpaces <- function(lines) {

---FILE: R/parse-preref.R---
@@ -175,7 +175,7 @@ parse.toggle <- function(key, rest) {
 
 
 check_rd <- function(key, text) {
-  if (rdComplete(text)) return(TRUE)
+  if (rdComplete(text, key == ""examples"")) return(TRUE)
 
   text <- str_trim(text)
   if (!is.null(key)) {

---FILE: src/RcppExports.cpp---
@@ -6,13 +6,14 @@
 using namespace Rcpp;
 
 // rdComplete
-bool rdComplete(std::string string);
-RcppExport SEXP roxygen2_rdComplete(SEXP stringSEXP) {
+bool rdComplete(std::string string, bool is_code);
+RcppExport SEXP roxygen2_rdComplete(SEXP stringSEXP, SEXP is_codeSEXP) {
 BEGIN_RCPP
     Rcpp::RObject __result;
     Rcpp::RNGScope __rngScope;
     Rcpp::traits::input_parameter< std::string >::type string(stringSEXP);
-    __result = Rcpp::wrap(rdComplete(string));
+    Rcpp::traits::input_parameter< bool >::type is_code(is_codeSEXP);
+    __result = Rcpp::wrap(rdComplete(string, is_code));
     return __result;
 END_RCPP
 }

---FILE: src/isComplete.cpp---
@@ -2,21 +2,27 @@
 using namespace Rcpp;
 
 // From http://developer.r-project.org/parseRd.pdf:  The characters \, %, {,
-// and } have special meaning in almost all parts of an Rd file.
-// The algorithm currently returns false for ""\\code{ '{' }"" when it should
-// return true. This seems like a rather unlikely edge cases so is ignored
-// for now.
+// and } have special meaning in almost all parts of an Rd file. In code,
+// strings must also match
 // [[Rcpp::export]]
-bool rdComplete(std::string string) {
+bool rdComplete(std::string string, bool is_code = true) {
   int n = string.length();
 
+  char in_string = '\0';
   bool in_escape = false;
   bool in_comment = false;
   int braces = 0;
 
   for(int i = 0; i < n; i++) {
     char cur = string[i];
 
+    if (in_string != '\0') {
+      if (cur == in_string) {
+        in_string = false;
+      }
+      continue;
+    }
+
     if (in_comment) {
       if (cur == '\n') {
         in_comment = false;
@@ -29,16 +35,15 @@ bool rdComplete(std::string string) {
       continue;
     }
 
-    if (cur == '{') {
-      braces++;
-    } else if (cur == '}') {
-      braces--;
-    } else if (cur == '\\') {
-      in_escape = true;
-    } else if (cur == '%') {
-      in_comment = true;
+    switch(cur) {
+    case '{':  braces++; break;
+    case '}':  braces--; break;
+    case '\\': in_escape = true; break;
+    case '%':  in_comment = true; break;
+    case '\'': if (is_code) in_string = '\''; break;
+    case '""':  if (is_code) in_string = '""'; break;
     }
   }
 
-  return braces == 0 && !in_escape;
+  return braces == 0 && !in_escape && !in_string;
 }

---FILE: tests/testthat/test-complete.R---
@@ -34,6 +34,15 @@ test_that(""escape disables comment"", {
 })
 
 
+test_that(""strings must be closed"", {
+  expect_false(rdComplete(""'""))
+  expect_false(rdComplete('""'))
+})
+
+test_that(""braces in strings don't need to match"", {
+  expect_true(rdComplete(""'{{'""))
+})
+
 # Test that incomplete Rd is caught in Rd blocks -------------------------------
 
 test_that(""incomplete rd in tag raises error"", {"
r-lib,roxygen2,cbbf8c7270d0d807bfee1d43cd43cef2d1b5dbee,hadley,h.wickham@gmail.com,2015-10-06T21:04:44Z,hadley,h.wickham@gmail.com,2015-10-06T21:04:44Z,"Save roxygen version in description.

Fixes #338",DESCRIPTION;NAMESPACE;NEWS.md;R/roxygenize.R;R/safety.R;man/is_s3_generic.Rd;man/namespace_roclet.Rd;man/new_roclet.Rd;man/object.Rd;man/rd_roclet.Rd;man/register-parser.Rd;man/roc_proc_text.Rd;man/roxygen.Rd;man/roxygenize.Rd;man/source_package.Rd;man/update_collate.Rd;man/vignette_roclet.Rd,False,True,True,False,32,15,47,"---FILE: DESCRIPTION---
@@ -59,3 +59,4 @@ Collate:
     'usage.R'
     'util-locale.R'
     'utils.R'
+RoxygenNote: 4.1.1.9000

---FILE: NAMESPACE---
@@ -1,4 +1,4 @@
-# Generated by roxygen2 (4.1.1.9000): do not edit by hand
+# Generated by roxygen2: do not edit by hand
 
 S3method(c,rd)
 S3method(clean,had)

---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 4.1.1.9000
 
+* Roxygen now records its version in a single place: the `RoxygenNote`
+  field in the `DESCRIPTION` (#338).
+
 * `\usage{}` is correctly generated for functions with string arguments 
   containing `""\""""` (#265).
 

---FILE: R/roxygenize.R---
@@ -40,6 +40,7 @@ roxygenize <- function(package.dir = ""."",
   base_path <- normalizePath(package.dir)
   man_path <- file.path(base_path, ""man"")
   dir.create(man_path, recursive = TRUE, showWarnings = FALSE)
+  update_roxygen_version(base_path)
 
   options <- load_options(base_path)
   roclets <- roclets %||% options$roclets

---FILE: R/safety.R---
@@ -33,6 +33,18 @@ check_made_by <- function(first) {
 }
 
 made_by <- function(comment) {
-  paste0(comment, "" Generated by roxygen2 ("", packageVersion(""roxygen2""),
-    ""): do not edit by hand\n"")
+  paste0(comment, "" Generated by roxygen2: do not edit by hand\n"")
+}
+
+update_roxygen_version <- function(base_path) {
+  desc_path <- file.path(base_path, ""DESCRIPTION"")
+  old <- read.description(desc_path)
+
+  new <- old
+  new$RoxygenNote <- packageVersion(""roxygen2"")
+
+  if (!identical(old, new)) {
+    cat('Updating roxygen version in ', desc_path, ""\n"")
+    write.description(new, desc_path)
+  }
 }

---FILE: man/is_s3_generic.Rd---
@@ -1,4 +1,4 @@
-% Generated by roxygen2 (4.1.1.9000): do not edit by hand
+% Generated by roxygen2: do not edit by hand
 % Please edit documentation in R/s3.R
 \name{is_s3_generic}
 \alias{is_s3_generic}

---FILE: man/namespace_roclet.Rd---
@@ -1,4 +1,4 @@
-% Generated by roxygen2 (4.1.1.9000): do not edit by hand
+% Generated by roxygen2: do not edit by hand
 % Please edit documentation in R/roclet-namespace.R
 \name{namespace_roclet}
 \alias{S3method}

---FILE: man/new_roclet.Rd---
@@ -1,4 +1,4 @@
-% Generated by roxygen2 (4.1.1.9000): do not edit by hand
+% Generated by roxygen2: do not edit by hand
 % Please edit documentation in R/roclet.R
 \name{new_roclet}
 \alias{new_roclet}

---FILE: man/object.Rd---
@@ -1,4 +1,4 @@
-% Generated by roxygen2 (4.1.1.9000): do not edit by hand
+% Generated by roxygen2: do not edit by hand
 % Please edit documentation in R/object.R
 \name{object}
 \alias{object}

---FILE: man/rd_roclet.Rd---
@@ -1,4 +1,4 @@
-% Generated by roxygen2 (4.1.1.9000): do not edit by hand
+% Generated by roxygen2: do not edit by hand
 % Please edit documentation in R/roclet-rd.R
 \name{rd_roclet}
 \alias{rd_roclet}

---FILE: man/register-parser.Rd---
@@ -1,4 +1,4 @@
-% Generated by roxygen2 (4.1.1.9000): do not edit by hand
+% Generated by roxygen2: do not edit by hand
 % Please edit documentation in R/parse-registry.R
 \name{register.preref.parser}
 \alias{register.preref.parser}

---FILE: man/roc_proc_text.Rd---
@@ -1,4 +1,4 @@
-% Generated by roxygen2 (4.1.1.9000): do not edit by hand
+% Generated by roxygen2: do not edit by hand
 % Please edit documentation in R/roclet.R
 \name{roc_proc_text}
 \alias{roc_proc_text}

---FILE: man/roxygen.Rd---
@@ -1,4 +1,4 @@
-% Generated by roxygen2 (4.1.1.9000): do not edit by hand
+% Generated by roxygen2: do not edit by hand
 % Please edit documentation in R/roxygen.R
 \docType{package}
 \name{roxygen}

---FILE: man/roxygenize.Rd---
@@ -1,4 +1,4 @@
-% Generated by roxygen2 (4.1.1.9000): do not edit by hand
+% Generated by roxygen2: do not edit by hand
 % Please edit documentation in R/roxygenize.R
 \name{roxygenize}
 \alias{roxygenise}

---FILE: man/source_package.Rd---
@@ -1,4 +1,4 @@
-% Generated by roxygen2 (4.1.1.9000): do not edit by hand
+% Generated by roxygen2: do not edit by hand
 % Please edit documentation in R/source.R
 \name{source_package}
 \alias{source_package}

---FILE: man/update_collate.Rd---
@@ -1,4 +1,4 @@
-% Generated by roxygen2 (4.1.1.9000): do not edit by hand
+% Generated by roxygen2: do not edit by hand
 % Please edit documentation in R/roclet-collate.R
 \name{update_collate}
 \alias{update_collate}

---FILE: man/vignette_roclet.Rd---
@@ -1,4 +1,4 @@
-% Generated by roxygen2 (4.1.1.9000): do not edit by hand
+% Generated by roxygen2: do not edit by hand
 % Please edit documentation in R/roclet-vignette.R
 \name{vignette_roclet}
 \alias{vignette_roclet}"
r-lib,roxygen2,e855309c72678ef1cbd7df353593f2b0f9225b1e,Kirill M칲ller,kirill.mueller@ivt.baug.ethz.ch,2015-05-27T07:46:14Z,Kirill M칲ller,kirill.mueller@ivt.baug.ethz.ch,2015-10-06T20:19:53Z,fix vignette builder,README.md,False,False,False,False,2,2,4,"---FILE: README.md---
@@ -94,9 +94,9 @@ If you have a simple package, you can use `roxygenise()`, but for anything more
   export with the `@export` tag
 
 * `rd_roclet`: produces Rd files by inspecting both function definitions and
-  roxygen2 comments in the source code.
+  roxygen2 comments in the source code
 
-* `vignette_roclet`: builds vignettes using `devtools::build_vignettes()`.
+* `vignette_roclet`: builds vignettes using `tools::buildVignette()`.
 
 By default, `roxygenise` will run the first three, but you can choose which ones to run using the `roclet` parameter, or field `Roxygen` in your `DESCRIPTION`:
 "
r-lib,roxygen2,612dae156b9c6a202b90d208b372e4be0265f158,hadley,h.wickham@gmail.com,2015-10-06T18:40:10Z,hadley,h.wickham@gmail.com,2015-10-06T18:40:10Z,"We're wrapping Rd, which uses \\ in strings.

Fixes #265",NEWS.md;src/wrapString.cpp;tests/testthat/test-usage.R,False,True,True,False,37,24,61,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 4.1.1.9000
 
+* `\usage{}` is correctly generated for functions with string arguments 
+  containing `""\""""` (#265).
+
 * If you document multiple arguments with one `@param`, (e.g. `@param a,b,c`)
   each parameter will get a space after it so it can be wrapped in the 
   generated Rd file (#373).

---FILE: src/wrapString.cpp---
@@ -3,45 +3,38 @@ using namespace Rcpp;
 
 // [[Rcpp::export]]
 std::vector<std::string> splitByWhitespace(std::string string) {
-  int n = string.length();
   std::vector<std::string> out;
 
   std::string acc = """";
   char in_string = '\0';
-  bool in_escape = false;
+  int in_escape = 0;
 
-  for(int i = 0; i < n; ++i) {
-    char cur = string[i];
+  std::string::const_iterator cur = string.begin(), end = string.end();
 
+  while(cur != end) {
     if (in_string != '\0') {
-      acc += cur;
+      acc += *cur;
 
       if (in_escape) {
-        in_escape = false;
-        continue;
-      }
-      if (cur == '\\') {
-        in_escape = true;
-        continue;
-      }
-      if (cur != in_string) {
-        continue;
+        in_escape--;
+      } else if (*cur == '\\' && cur + 1 != end && *(cur + 1) == '\\') {
+        in_escape = 2;
+      } else if (*cur == in_string) {
+        // String terminates
+        in_string = '\0';
       }
 
-      // String terminates
-      in_string = '\0';
-      continue;
-    }
-
-    if (cur == ' ' || cur == '\t' || cur == '\n') {
+    } else if (*cur == ' ' || *cur == '\t' || *cur == '\n') {
       out.push_back(acc);
       acc = """";
-    } else if (cur == '""' || cur == '\'') {
-      in_string = cur;
-      acc += cur;
+    } else if (*cur == '""' || *cur == '\'') {
+      in_string = *cur;
+      acc += *cur;
     } else {
-      acc += cur;
+      acc += *cur;
     }
+
+    cur++;
   }
 
   out.push_back(acc);

---FILE: tests/testthat/test-usage.R---
@@ -280,3 +280,20 @@ test_that(""long usages protected from incorrect breakage"", {
   expect_equal(str_count(usage, ""\n""), 6)
 })
 
+test_that(""breaking works after escapes (#265)"", {
+
+  out <- roc_proc_text(rd_roclet(), ""
+    #' Long args
+    f <- function(
+      xxxxxxxxxxxxxxxxxx1,
+      xxxxxxxxxxxxxxxxxx2,
+      xxxxxxxxxxxxxxxxxx3,
+      x = \""\\\""'\"",
+      xxxxxxxxxxxxxxxxxx4,
+      xxxxxxxxxxxxxxxxxx5,
+      xxxxxxxxxxxxxxxxxx6,
+      xxxxxxxxxxxxxxxxxx7
+  ){}"")[[1]]
+  usage <- format(get_tag(out, ""usage""))
+  expect_equal(str_count(usage, ""\n""), 5)
+})"
r-lib,roxygen2,9d314c6c4635996fa5bf12b55d37c3e48cc7faf3,hadley,h.wickham@gmail.com,2015-10-05T18:52:08Z,hadley,h.wickham@gmail.com,2015-10-05T18:52:08Z,"Make multi-arg params wrappable.

Fixes #373",NEWS.md;R/rd-tag-api.R;man/register-parser.Rd;tests/testthat/test-param.R,False,True,True,False,17,2,19,"---FILE: NEWS.md---
@@ -1,5 +1,9 @@
 # roxygen2 4.1.1.9000
 
+* If you document multiple arguments with one `@param`, (e.g. `@param a,b,c`)
+  each parameter will get a space after it so it can be wrapped in the 
+  generated Rd file (#373).
+
 * update_collate rewrites the `Collate` entry in the DESCRIPTION file only
   when changes generated by `@includes` are found.  Includes a testthat.
   (#325, resolves hadley/devtools#723).

---FILE: R/rd-tag-api.R---
@@ -143,7 +143,9 @@ format.usage_tag <- function(x, ...) {
 #' @export
 format.param_tag <- function(x, ..., wrap = TRUE) {
   names <- names(x$values)
-  dups <- duplicated(names)
+
+  # add space to multiple arguments so they can wrap
+  names <- gsub("","", "", "", names)
 
   items <- paste0(""\\item{"", names, ""}{"", x$values, ""}"", collapse = ""\n\n"")
   if (wrap) {

---FILE: man/register-parser.Rd---
@@ -10,7 +10,7 @@ register.preref.parser(key, parser)
 register.preref.parsers(parser, ...)
 }
 \arguments{
-\item{key,...}{Tag name(s).}
+\item{key, ...}{Tag name(s).}
 
 \item{parser}{Parser callback to register, a function with arguments
 \code{key} and \code{expression}.}

---FILE: tests/testthat/test-param.R---
@@ -12,6 +12,15 @@ test_that(""@param documents arguments"", {
   expect_equivalent(args[""z""], ""a terminal letter"")
 })
 
+test_that(""grouped args get spaces"", {
+  out <- roc_proc_text(rd_roclet(), ""
+  #' @param a,z Two arguments an incipit letter
+  a <- function(a=1, z=2) {}"")[[1]]
+
+  args <- get_tag(out, ""param"")
+  expect_match(format(args), ""a, z"")
+})
+
 test_that(""multiple @inheritParam tags gathers all params"", {
   out <- roc_proc_text(roc, ""
     #' A."
r-lib,roxygen2,8afb5e770c838e69626d65eb43c95a4a59b0912c,hadley,h.wickham@gmail.com,2015-10-05T13:45:02Z,hadley,h.wickham@gmail.com,2015-10-05T13:45:02Z,Bail out if no roclets. Fixes #358,R/roxygenize.R,False,True,True,False,3,0,3,"---FILE: R/roxygenize.R---
@@ -51,6 +51,9 @@ roxygenize <- function(package.dir = ""."",
     roclets <- setdiff(roclets, ""collate"")
   }
 
+  if (length(roclets) == 0)
+    return(invisible())
+
   parsed <- parse_package(base_path, load_code)
 
   roclets <- paste0(roclets, ""_roclet"", sep = """")"
r-lib,roxygen2,819902bc11f030d8bb00804377d351bffea79f6e,AugustT,tomaug@ceh.ac.uk,2015-10-05T10:47:51Z,AugustT,tomaug@ceh.ac.uk,2015-10-05T10:47:51Z,Fixed conflict with raster package,R/roclet-rd.R,False,True,True,False,1,1,2,"---FILE: R/roclet-rd.R---
@@ -86,7 +86,7 @@ roc_process.had <- function(roclet, parsed, base_path, options = list()) {
 
 invert <- function(x) {
   if (length(x) == 0) return()
-  unstack(rev(stack(x)))
+  utils::unstack(rev(utils::stack(x)))
 }
 get_values <- function(topics, tag) {
   tags <- lapply(topics, get_tag, tag)"
r-lib,roxygen2,fe92efa266c9c8eb43e3458409cc4040177be00d,Gabor Csardi,csardi.gabor@gmail.com,2015-09-16T07:40:10Z,Gabor Csardi,csardi.gabor@gmail.com,2015-09-16T07:40:10Z,Fix a comment about combining @details,R/parse-preref.R,False,True,True,False,1,1,2,"---FILE: R/parse-preref.R---
@@ -78,7 +78,7 @@ process_description <- function(intro, other_pieces) {
     description <- c(""description"", title[2] %||% piece(""title""))
   }
 
-  # Every thing else = details, combined with @details.
+  # Every thing else = details, combined with @details, in parse_elements
   if (length(paragraphs) == 0 || paragraphs == """") paragraphs <- NULL
   if (length(paragraphs) > 0) {
     details <- c(""details"", paste(paragraphs, collapse = ""\n\n""))"
r-lib,roxygen2,55990eb55e05cdd26b34a0b9e1c1cad4c5bba905,Alessandro Samuel-Rosa,samuel-rosa@users.noreply.github.com,2015-07-10T23:06:12Z,Alessandro Samuel-Rosa,samuel-rosa@users.noreply.github.com,2015-07-10T23:06:12Z,"Update rd.Rmd

Small correction in the description of how to include sections in the documentation.",vignettes/rd.Rmd,True,False,True,False,1,1,2,"---FILE: vignettes/rd.Rmd---
@@ -436,7 +436,7 @@ times <- function(x, y) x * y
 
 ## Sections
 
-You can add arbitrary sections to the documentation for any object with the `@section` tag. This is a useful way of breaking a long details section into multiple chunks with useful headings. Section titles should be in sentence case and must be followed a colon. Titles may only take one line.
+You can add arbitrary sections to the documentation for any object with the `@section` tag. This is a useful way of breaking a long details section into multiple chunks with useful headings. Section titles should be in sentence case and must be followed by a colon. Titles may only take one line.
 
 ```{r}
 #' @section Warning:"
r-lib,roxygen2,27ef48e3f41d8306952d2788f90c6d64d1a281b1,hadley,h.wickham@gmail.com,2015-06-05T15:04:56Z,hadley,h.wickham@gmail.com,2015-06-05T15:04:56Z,Fix indenting,NEWS.md,False,False,False,False,1,1,2,"---FILE: NEWS.md---
@@ -1,7 +1,7 @@
 # roxygen2 4.1.1
 
 * Formatting of the `Authors@R` field in the DESCRIPTION file is now retained 
-(@jranke, #330).
+  (@jranke, #330).
 
 * The collate roclet falls back to `base::strwrap()` when generating the
   collate field. This makes roxygen2 compatible with the next version of"
r-lib,roxygen2,d05e38e6d9ae85c2ec6cdcfb07a97918fa9f0487,Johannes Ranke,jranke@uni-bremen.de,2015-03-30T16:38:51Z,Johannes Ranke,jranke@uni-bremen.de,2015-03-30T16:38:51Z,"Added a test and fixed the bug it revealed

Keeping whitespace on reading the Authors@R field and not doing any
wrapping actually involves not to apply the function
wrap_field_if_necessary().",R/description.R;tests/testthat/test-wrapFieldIfNecessary.R,False,True,True,False,14,12,26,"---FILE: R/description.R---
@@ -27,12 +27,14 @@ cat.description <- function(field, value, file='') {
     if (field %in% c(""Collate"")) {
       # Individual lines
       width <- 0L
+      out <- wrap_field_if_necessary(field, value, wrap.threshold = width)
     } else if (field %in% c(""Authors@R"")) {
-      # No wrapping
-      width <- Inf
+      # No processing
+      out <- paste0(field, "": "", value)
+    } else {
+      out <- wrap_field_if_necessary(field, value, wrap.threshold = width)
     }
 
-    out <- wrap_field_if_necessary(field, value, wrap.threshold = width)
   }
 
   cat(out, sep='\n', file=file, append=TRUE)

---FILE: tests/testthat/test-wrapFieldIfNecessary.R---
@@ -67,15 +67,15 @@ test_that(""Infinity threshold turns off wrapping"", {
 test_that(""Whitespace in Authors@R field of DESCRIPTION is preserved"", {
     desc_2 <- read.description(""description-example_2.txt"")
     authors_at_R_raw <- ""Authors@R: c(
-    person('Alan Turing', role = c('auth', 'cre', 'cph'),
-           email = 'alan@turing.fake',
-           comment = c('As this is a fake package, as you may have guessed, authorship'
-                       'information should not be taken seriously either.'),
-    person('Alonzo Church', role = 'ctb',
-            email = 'alonzo@church.fake'),
-    person('Grace Murray Hopper', role = 'auth',
-            email = 'grace@murray-hopper.fake'))""
+    person(\""Alan Turing\"", role = c(\""auth\"", \""cre\"", \""cph\""),
+           email = \""alan@turing.fake\"",
+           comment = c(\""As this is a fake package, as you may have guessed, authorship\""
+                       \""information should not be taken seriously either.\""),
+    person(\""Alonzo Church\"", role = \""ctb\"",
+            email = \""alonzo@church.fake\""),
+    person(\""Grace Murray Hopper\"", role = \""auth\"",
+            email = \""grace@murray-hopper.fake\""))""
     authors_at_R_formatted <- capture.output(cat.description(""Authors@R"", desc_2[[""Authors@R""]], file = ''))
-    expect_equal(paste(authors_at_R_formatted, collapse = ""\n""), authors_at_R_formatted)
+    expect_equal(authors_at_R_raw, paste(authors_at_R_formatted, collapse = ""\n""))
   }
 )"
r-lib,roxygen2,3d29cb40b6a5aa6062339e6ecb4bab2dcae822d4,Renaud,renaud@tx.technion.ac.il,2015-02-25T10:55:03Z,Renaud,renaud@tx.technion.ac.il,2015-02-25T10:55:03Z,Fix unnecessary DESCRIPTION overwrite (+ unit test),R/roclet-collate.R;tests/testthat/test-collate.R;tests/testthat/testCollateOverwrite/DESCRIPTION;tests/testthat/testCollateOverwrite/R/a.r;tests/testthat/testCollateOverwrite/R/b.r,False,True,True,False,30,8,38,"---FILE: R/roclet-collate.R---
@@ -41,14 +41,7 @@ update_collate <- function(base_path) {
   old <- read.description(desc_path)
 
   new <- old
-  new$Collate <- paste0(""'"", collate, ""'"", collapse = "" "")
-
-  # Write new out and read it in again to get exactly the same formatting
-  # as old, so the comparison works
-  desc_tmp <- tempfile()
-  on.exit(unlink(desc_tmp))
-  write.description(new, desc_tmp)
-  new <- read.description(desc_tmp)
+  new$Collate <- paste0(""'"", collate, ""'"", collapse = ""\n"")
 
   if (!identical(old, new)) {
     cat('Updating collate directive in ', desc_path, ""\n"")

---FILE: tests/testthat/test-collate.R---
@@ -36,3 +36,20 @@ test_that(""Collate field unchanged when no @includes"", {
 
 })
 
+test_that(""DESCRIPTION file is re-written only if collate changes"", {
+  pkg_path <- ""testCollateOverwrite""
+  desc_path <- file.path(pkg_path, 'DESCRIPTION')
+  
+  # make backup copy of incomplete DESCRIPTION file (restored on exit)
+  file.copy(desc_path, tmp <- tempfile())
+  on.exit( file.copy(tmp, desc_path, overwrite = TRUE), add = TRUE)
+  
+  # load package: this should update the DESCRIPTION file (warning)
+  expect_output(update_collate(pkg_path), ""Updating collate directive"", info = ""update_collate on incomplete package: DESCRIPTION file is updated"")
+  
+  # should not update anymore
+  expect_true(!length(capture.output(update_collate(pkg_path))), info = ""update_collate on complete package: DESCRIPTION file is NOT updated"")
+      
+ })
+
+

---FILE: tests/testthat/testCollateOverwrite/DESCRIPTION---
@@ -0,0 +1,9 @@
+Package: testCollateMissing
+Title: Tools to make developing R code easier
+License: GPL-2
+Description: 
+Author: Hadley <h.wickham@gmail.com>
+Maintainer: Hadley <h.wickham@gmail.com>
+Version: 0.1
+Collate:
+    'b.r'

---FILE: tests/testthat/testCollateOverwrite/R/a.r---
@@ -0,0 +1,2 @@
+#' @include b.r
+a <- 1

---FILE: tests/testthat/testCollateOverwrite/R/b.r---
@@ -0,0 +1 @@
+b <- 2
\ No newline at end of file"
r-lib,roxygen2,ccff2e7851e22bcdb38b5d9acf3544903d065a95,Kevin Ushey,kevinushey@gmail.com,2014-12-14T19:30:04Z,Kevin Ushey,kevinushey@gmail.com,2014-12-14T19:51:47Z,fix OB1 error,src/parser.cpp,False,False,False,False,18,15,33,"---FILE: src/parser.cpp---
@@ -16,8 +16,8 @@ class BlockParser
   }
 
   BlockParser(std::string const& input,
-                     std::string const& filePath,
-                     int row)
+              std::string const& filePath,
+              int row)
   {
     stripRoxygenDelimitersAndStore(input);
     filePath_ = filePath;
@@ -174,31 +174,33 @@ class BlockParser
       start = end + 1;
       end = start;
     }
+
     n_ = content_.length();
     LOG(""Content after strip:\n"");
     LOG(content_);
   }
 
   int findNextTagOrEnd(int index)
   {
-
-    do {
+    while (index < n_ - 2)
+    {
       if (content_[index] == '\n')
       {
         if (content_[index + 1] == '@')
         {
           break;
         }
       }
-    } while (++index < n_ - 1);
+      ++index;
+    }
 
     return index + 1;
   }
 
   int findNextTagOrEnd(int index, int* row)
   {
-
-    do {
+    while (index < n_ - 2)
+    {
       if (content_[index] == '\n')
       {
         ++*row;
@@ -207,7 +209,8 @@ class BlockParser
           break;
         }
       }
-    } while (++index < n_ - 1);
+      ++index;
+    }
 
     return index + 1;
   }
@@ -225,8 +228,8 @@ class BlockParser
            content_[end - 1] == '\n')
       --end;
 
-    // If we moved back to / before start, just return empty string
-    if (end <= start)
+    // If we moved back to the start, just return empty string
+    if (end == start)
     {
       return std::string();
     }
@@ -309,11 +312,11 @@ class FileParser
         if (thisBlockString.length() > 0)
         {
           allBlocks.push_back(
-                BlockParser(
-                  thisBlockString,
-                  filePath,
-                  blockStartRow
-                ).parse()
+            BlockParser(
+              thisBlockString,
+              filePath,
+              blockStartRow
+            ).parse()
           );
         }
 "
r-lib,roxygen2,158ddac09812474ab82e9377fef778f1db3a9c29,hadley,h.wickham@gmail.com,2014-12-14T13:55:46Z,hadley,h.wickham@gmail.com,2014-12-14T13:55:46Z,Fix news since I missed backref in release,DESCRIPTION;NEWS.md,False,False,False,False,7,5,12,"---FILE: DESCRIPTION---
@@ -3,7 +3,7 @@ Title: In-source Documentation for R
 Description: A Doxygen-like in-source documentation system
     for Rd, collation, and NAMESPACE.
 URL: https://github.com/klutometis/roxygen
-Version: 4.1.0
+Version: 4.1.0.9000
 License: GPL (>= 2)
 Authors@R: c(
     person(""Hadley"", ""Wickham"",, ""h.wickham@gmail.com"", c(""aut"", ""cre"", ""cph"")),

---FILE: NEWS.md---
@@ -1,3 +1,9 @@
+# roxygen2 4.1.0.9000
+
+* The source of the documentation is added to autogenerated `.Rd` files.
+  The new `@backref` tag allows overriding this for R code generators such as
+  `Rcpp` (@krlmlr, #291, #294).
+
 # roxygen2 4.1.0
 
 * If there are no `@include` tags, roxygen2 leaves the collate field alone.
@@ -13,10 +19,6 @@
 
 * The `Authors@R` field in `DESCRIPTION` is now longer wrapped(@krlmlr, #284).
 
-* The source of the documentation is added to autogenerated `.Rd` files.
-  The new `@backref` tag allows overriding this for R code generators such as
-  `Rcpp` (@krlmlr, #291, #294).
-
 * `@describeIn` with plain functions now correctly includes the function name
   and can be applied to data documentation. (@jimhester, #285, #288).
 "
r-lib,roxygen2,bd9ba4660e8072b5df273340b95c4e58224b0e39,Kirill M칲ller,kirill.mueller@ivt.baug.ethz.ch,2014-12-10T20:41:49Z,Kirill M칲ller,kirill.mueller@ivt.baug.ethz.ch,2014-12-10T20:41:49Z,fix NAMESPACE,NAMESPACE,False,False,False,False,1,1,2,"---FILE: NAMESPACE---
@@ -28,6 +28,7 @@ S3method(escape,character)
 S3method(escape,rd)
 S3method(format,alias_tag)
 S3method(format,author_tag)
+S3method(format,backref_tag)
 S3method(format,concept_tag)
 S3method(format,description_tag)
 S3method(format,details_tag)
@@ -52,7 +53,6 @@ S3method(format,section_tag)
 S3method(format,seealso_tag)
 S3method(format,slot_tag)
 S3method(format,source_tag)
-S3method(format,srcref_tag)
 S3method(format,title_tag)
 S3method(format,usage_tag)
 S3method(format,value_tag)"
r-lib,roxygen2,0642a26b426a54974e172d88455295556451b834,hadley,h.wickham@gmail.com,2014-11-26T21:37:42Z,hadley,h.wickham@gmail.com,2014-11-26T21:37:42Z,Fix regex buglet.,R/roclet-namespace.R,False,True,True,False,1,1,2,"---FILE: R/roclet-namespace.R---
@@ -156,7 +156,7 @@ fun_args <- function(name, x) {
 
 quote_if_needed <- function(x) {
   needs_quotes <- !has.quotes(x) & !is.syntactic(x)
-  x[needs_quotes] <- paste0('""', str_replace_all(x[needs_quotes], '([""\\])', ""\\\\\\1""), '""')
+  x[needs_quotes] <- paste0('""', str_replace_all(x[needs_quotes], '([""\\\\])', ""\\\\\\1""), '""')
   x
 }
 is.syntactic <- function(x) make.names(x) == x"
r-lib,roxygen2,a1e382e38139bf73961cb9f2e7b3732c6725fd2f,Jim Hester,james.f.hester@gmail.com,2014-10-01T12:06:42Z,Jim Hester,james.f.hester@gmail.com,2014-10-01T12:06:42Z,"Allow describeIn to be used with data documentation

fixes #288",NEWS.md;R/minidesc.R;tests/testthat/test-describein.R,False,True,True,False,26,12,38,"---FILE: NEWS.md---
@@ -5,7 +5,8 @@
   was the cause of that.
 
 * Don't wrap `Authors@R` field in `DESCRIPTION` (@krlmlr, 284).
-* `@describeIn` with plain functions now correctly includes the function name. (@jimhester, #285).
+* `@describeIn` with plain functions now correctly includes the function name
+  and can be applied to data documentation. (@jimhester, #285, #288).
 
 # roxygen2 4.0.2
 

---FILE: R/minidesc.R---
@@ -70,7 +70,7 @@ build_label <- function(src, dest) {
     # Label S3 methods in generic with their class
     type <- ""generic""
     label <- attr(src$value, ""s3method"")[2]
-  } else if (dest_type == ""function"" && src_type == ""function"") {
+  } else if (dest_type %in% c(""function"", ""data"") && src_type == ""function"") {
     # Multiple functions in one Rd labelled with function names
     type <- ""function""
     label <- default_name(src)

---FILE: tests/testthat/test-describein.R---
@@ -51,6 +51,23 @@ test_that(""@describeIn class captures s4 generic name"", {
   expect_equal(get_tag(out, ""minidesc"")$values$label, ""mean"")
 })
 
+test_that(""Multiple @describeIn generic combined into one"", {
+  out <- roc_proc_text(rd_roclet(), ""
+    #' Title
+    f <- function(x) UseMethod('f')
+
+    #' @describeIn f A
+    f.a <- function(x) 1
+
+    #' @describeIn f B
+    f.b <- function(x) 1
+  "")[[1]]
+
+  expect_equal(get_tag(out, ""minidesc"")$values$type, ""generic"")
+  expect_equal(get_tag(out, ""minidesc"")$values$label, c(""a"", ""b""))
+  expect_equal(get_tag(out, ""minidesc"")$values$desc, c(""A"", ""B""))
+})
+
 test_that(""@describeIn class captures function name"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' Title
@@ -63,19 +80,15 @@ test_that(""@describeIn class captures function name"", {
   expect_equal(get_tag(out, ""minidesc"")$values$label, ""f2"")
 })
 
-test_that(""Multiple @describeIn generic combined into one"", {
+test_that(""@describeIn class captures function name with data"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' Title
-    f <- function(x) UseMethod('f')
+    #' @name f
+    NULL
 
     #' @describeIn f A
-    f.a <- function(x) 1
-
-    #' @describeIn f B
-    f.b <- function(x) 1
-  "")[[1]]
+    f2 <- function(x) 1
+    "")[[1]]
 
-  expect_equal(get_tag(out, ""minidesc"")$values$type, ""generic"")
-  expect_equal(get_tag(out, ""minidesc"")$values$label, c(""a"", ""b""))
-  expect_equal(get_tag(out, ""minidesc"")$values$desc, c(""A"", ""B""))
+  expect_equal(get_tag(out, ""minidesc"")$values$label, ""f2"")
 })"
r-lib,roxygen2,7b15194e72ea97db84083f0a6b8b6dc209f5b389,Jim Hester,james.f.hester@gmail.com,2014-09-30T00:24:15Z,Jim Hester,james.f.hester@gmail.com,2014-09-30T00:24:15Z,"Fix @describeIn with plain functions

Previously these did not include the function name in the list.
Fixes #285",NEWS.md;R/object.R;tests/testthat/test-describein.R,False,True,True,False,13,0,13,"---FILE: NEWS.md---
@@ -5,6 +5,7 @@
   was the cause of that.
 
 * Don't wrap `Authors@R` field in `DESCRIPTION` (@krlmlr, 284).
+* `@describeIn` with plain functions now correctly includes the function name. (@jimhester, #285).
 
 # roxygen2 4.0.2
 

---FILE: R/object.R---
@@ -28,6 +28,7 @@ default_name.rcclass <-   function(x) x$value@className
 default_name.rcmethod <-  function(x) x$value@name
 default_name.s3generic <- function(x) browser()
 default_name.s3method <-  function(x) attr(x$value, ""s3method"")
+default_name.function <-   function(x) x$alias
 default_name.default <-   function(x) NULL
 
 #' @export

---FILE: tests/testthat/test-describein.R---
@@ -51,6 +51,17 @@ test_that(""@describeIn class captures s4 generic name"", {
   expect_equal(get_tag(out, ""minidesc"")$values$label, ""mean"")
 })
 
+test_that(""@describeIn class captures function name"", {
+  out <- roc_proc_text(rd_roclet(), ""
+    #' Title
+    f <- function(x) 1
+
+    #' @describeIn f A
+    f2 <- function(x) 1
+    "")[[1]]
+
+  expect_equal(get_tag(out, ""minidesc"")$values$label, ""f2"")
+})
 
 test_that(""Multiple @describeIn generic combined into one"", {
   out <- roc_proc_text(rd_roclet(), """
r-lib,roxygen2,ed8175c8ceb32ae9e2c85409f1b54132b550a843,tobiaskley,tobias.kley@ruhr-uni-bochum.de,2014-08-21T14:14:43Z,tobiaskley,tobias.kley@ruhr-uni-bochum.de,2014-08-21T14:14:43Z,Fix suggested by eibanez on May 14.,R/safety.R,False,True,True,False,1,0,1,"---FILE: R/safety.R---
@@ -1,5 +1,6 @@
 first_time <- function(path) {
   generated <- dir(file.path(path, ""man""), full.names = TRUE)
+  generated <- generated[!file.info(generated)$isdir]
 
   namespace <- file.path(path, ""NAMESPACE"")
   if (file.exists(namespace)) {"
r-lib,roxygen2,a61f831ad6d23f4e6dfb865821fbfcd934f95074,Kirill M칲ller,kirill.mueller@ivt.baug.ethz.ch,2014-06-24T13:29:34Z,Kirill M칲ller,kirill.mueller@ivt.baug.ethz.ch,2014-06-24T13:29:34Z,fix indentation,tests/testthat/test-param.R,False,True,True,False,96,96,192,"---FILE: tests/testthat/test-param.R---
@@ -102,34 +102,34 @@ test_that(""find_params parses input"", {
 
 test_that(""argument order, also for incomplete documentation"", {
   out <- roc_proc_text(roc, ""
-                       #' A.
-                       #'
-                       #' @param y Y
-                       #' @param x X
-                       a <- function(x, y) {}
-
-                       #' B
-                       #'
-                       #' @param y Y
-                       b <- function(x, y) {}
-
-                       #' C
-                       #'
-                       #' @param x X
-                       c <- function(x, y) {}
-
-                       #' D
-                       #'
-                       #' @inheritParams b
-                       #' @param z Z
-                       d <- function(x, y, z) {}
-
-                       #' E
-                       #'
-                       #' @inheritParams c
-                       #' @param y Y
-                       e <- function(x, y, z) {}
-                       "")
+    #' A.
+    #'
+    #' @param y Y
+    #' @param x X
+    a <- function(x, y) {}
+
+    #' B
+    #'
+    #' @param y Y
+    b <- function(x, y) {}
+
+    #' C
+    #'
+    #' @param x X
+    c <- function(x, y) {}
+
+    #' D
+    #'
+    #' @inheritParams b
+    #' @param z Z
+    d <- function(x, y, z) {}
+
+    #' E
+    #'
+    #' @inheritParams c
+    #' @param y Y
+    e <- function(x, y, z) {}
+  "")
 
   expect_equal(get_tag(out[[""a.Rd""]], ""param"")$values, c(x=""X"", y=""Y""))
   expect_equal(get_tag(out[[""b.Rd""]], ""param"")$values, c(y=""Y""))
@@ -140,36 +140,36 @@ test_that(""argument order, also for incomplete documentation"", {
 
 test_that(""argument order with @inheritParam"", {
   out <- roc_proc_text(roc, ""
-                       #' A.
-                       #'
-                       #' @param x X
-                       #' @param y Y
-                       a <- function(x, y) {}
-
-                       #' B1
-                       #'
-                       #' @param y B
-                       #' @inheritParams a
-                       b1 <- function(x, y) {}
-
-                       #' B2
-                       #'
-                       #' @inheritParams a
-                       #' @param y B
-                       b2 <- function(x, y) {}
-
-                       #' C1
-                       #'
-                       #' @param x C
-                       #' @inheritParams a
-                       c1 <- function(x, y) {}
-
-                       #' C2
-                       #'
-                       #' @inheritParams a
-                       #' @param x C
-                       c2<- function(x, y) {}
-                       "")
+    #' A.
+    #'
+    #' @param x X
+    #' @param y Y
+    a <- function(x, y) {}
+
+    #' B1
+    #'
+    #' @param y B
+    #' @inheritParams a
+    b1 <- function(x, y) {}
+
+    #' B2
+    #'
+    #' @inheritParams a
+    #' @param y B
+    b2 <- function(x, y) {}
+
+    #' C1
+    #'
+    #' @param x C
+    #' @inheritParams a
+    c1 <- function(x, y) {}
+
+    #' C2
+    #'
+    #' @inheritParams a
+    #' @param x C
+    c2<- function(x, y) {}
+    "")
 
   expect_equal(get_tag(out[[""b1.Rd""]], ""param"")$values, c(x=""X"", y=""B""))
   expect_equal(get_tag(out[[""b2.Rd""]], ""param"")$values, c(x=""X"", y=""B""))
@@ -179,57 +179,57 @@ test_that(""argument order with @inheritParam"", {
 
 test_that(""argument order for multi-parameter documentation"", {
   out <- roc_proc_text(roc, ""
-                       #' A.
-                       #'
-                       #' @param x,y X,Y
-                       a <- function(x, y) {}
-
-                       #' B
-                       #'
-                       #' @param y Y
-                       #' @param x,z X,Z
-                       #' @param w W
-                       b <- function(x, y, z, w) {}
-                       "")
+    #' A.
+    #'
+    #' @param x,y X,Y
+    a <- function(x, y) {}
+
+    #' B
+    #'
+    #' @param y Y
+    #' @param x,z X,Z
+    #' @param w W
+    b <- function(x, y, z, w) {}
+    "")
 
   expect_equal(get_tag(out[[""a.Rd""]], ""param"")$values, c(`x,y`=""X,Y""))
   expect_equal(get_tag(out[[""b.Rd""]], ""param"")$values, c(`x,z`=""X,Z"", y=""Y"", w=""W""))
 })
 
 test_that(""argument order for multiple usage statements"", {
   out <- roc_proc_text(roc, ""
-                       #' A.
-                       #'
-                       #' @usage a(x, w)
-                       #' @usage a(x, y)
-                       #' @usage a(x, z)
-                       #' @param x X
-                       #' @param w W
-                       #' @param y Y
-                       #' @param z Z
-                       a <- function(x, y, z, w) {}
-                       "")
+    #' A.
+    #'
+    #' @usage a(x, w)
+    #' @usage a(x, y)
+    #' @usage a(x, z)
+    #' @param x X
+    #' @param w W
+    #' @param y Y
+    #' @param z Z
+    a <- function(x, y, z, w) {}
+    "")
 
   expect_equal(get_tag(out[[""a.Rd""]], ""param"")$values, c(x=""X"", y=""Y"", z=""Z"", w=""W""))
 })
 
 test_that(""argument order for @rdfile"", {
   out <- roc_proc_text(roc, ""
-                       #' A
-                       #'
-                       #' @param x X
-                       #' @param y Y
-                       #' @rdname rd
-                       a <- function(x, y) {
-                       }
-
-                       #' B
-                       #'
-                       #' @export
-                       #' @rdname rd
-                       b <- function(y, ...) {
-                       }
-                       "")
+    #' A
+    #'
+    #' @param x X
+    #' @param y Y
+    #' @rdname rd
+    a <- function(x, y) {
+    }
+
+    #' B
+    #'
+    #' @export
+    #' @rdname rd
+    b <- function(y, ...) {
+    }
+    "")
 
   expect_equal(get_tag(out[[""rd.Rd""]], ""param"")$values, c(x=""X"", y=""Y""))
 })"
r-lib,roxygen2,6fdd934e9a7ed3aa8aa69ac49076db4b43e5247e,Kevin Ushey,kevinushey@gmail.com,2014-05-09T16:21:48Z,Kevin Ushey,kevinushey@gmail.com,2014-05-09T16:21:48Z,"Clarify what @keywords internal will do

Re: https://github.com/ramhiser/sparsediscrim/issues/26",vignettes/rd.Rmd,True,False,True,False,3,2,5,"---FILE: vignettes/rd.Rmd---
@@ -131,8 +131,9 @@ Three other tags make it easier for the user to find documentation:
 * `@keywords keyword1 keyword2 ...` to add standardised keywords. Keywords are
   optional, but if present, must be taken from the predefined list replicated
   in the [keywords vignette](rdkeywords.html). Keywords are not very useful,
-  except for `@keywords internal`. Using the internal keyword removes the function
-  from the documentation index and disables some of its automated tests.
+  except for `@keywords internal`. Using the internal keyword removes all functions
+  in the associated `.Rd` file from the documentation index and disables some of
+  their automated tests.
   A common use case is to both export a function (using `@export`) and marking it as
   internal. That way, advanced users can access a function that new users would be confused
   about if they were to see it in the index."
r-lib,roxygen2,d2a24c15a1c70770e686a8fd9c3af885a31344e0,Peter Hickey,peter.hickey@gmail.com,2014-04-29T05:27:04Z,Peter Hickey,peter.hickey@gmail.com,2014-04-29T05:27:04Z,"Update roxygen2.Rmd

Fixed typo: s/roxygen::/roxygen2::/g",vignettes/roxygen2.Rmd,True,False,True,False,2,2,4,"---FILE: vignettes/roxygen2.Rmd---
@@ -43,10 +43,10 @@ This vignette provides a high-level description of roxygen2 and how the three ma
 
 There are three main ways to run roxygen:
 
-* `roxygen::roxygenise()`, or
+* `roxygen2::roxygenise()`, or
 
 * `devtools::document()`, if you're using devtools, or
 
 * `Ctrl + Shift + D`, if you're using RStudio.
 
-As of version 4.0.0, roxygen2 will never overwrite a file it didn't create. It does this by labelling every file it creates with a comment: ""Generated by roxygen2 (4.0.0): do not edit by hand"". To upgrade from a previous version of roxygen2, you'll need to first run `roxygen::upgradeRoxygen()`. This deletes all `.Rd` and labels the `NAMESPACE` as being created by roxygen2.
+As of version 4.0.0, roxygen2 will never overwrite a file it didn't create. It does this by labelling every file it creates with a comment: ""Generated by roxygen2 (4.0.0): do not edit by hand"". To upgrade from a previous version of roxygen2, you'll need to first run `roxygen2::upgradeRoxygen()`. This deletes all `.Rd` and labels the `NAMESPACE` as being created by roxygen2."
r-lib,roxygen2,be694edb8a11f2e7c90e1c4a4559773302f26caf,dougmitarotonda,dougmitarotonda@gmail.com,2014-03-28T20:12:06Z,dougmitarotonda,dougmitarotonda@gmail.com,2014-03-28T20:12:06Z,"Clarify rationale on @importFrom

Per discussion here: https://github.com/klutometis/roxygen/issues/233",vignettes/namespace.Rmd,True,False,True,False,1,1,2,"---FILE: vignettes/namespace.Rmd---
@@ -75,7 +75,7 @@ Use the following guidelines to decide what to export:
 
 The `NAMESPACE` also controls which functions from other packages are made available to your package. Only unique directives are saved to the `NAMESPACE` file, so you can repeat them as needed to maintain a close link between the functions where they are needed and the namespace file.
 
-If you are using just a few functions from another package, call them explicitly with `pkg::fun()`.  I no longer recommend using `@importFrom` for this use case.
+If you are using just a few functions from another package, the recommended option is to note the package name in the `Imports:` field of the `DESCRIPTION` file and call the function(s) explicitly using `::`, e.g., `pkg::fun()`.  Alternatively, though no longer recommended due to its poorer readability, use `@importFrom`, e.g., `@importFrom pgk fun`, and call the function(s) without `::`.
 
 If you are using many functions from another package, use `@import package` to import them all and make available without using `::`.
 "
r-lib,roxygen2,42a412b21f0a21cdbe6e0a22fc1ca98312f1dc7c,James Manton,ajd.manton@googlemail.com,2014-03-25T15:44:38Z,James Manton,ajd.manton@googlemail.com,2014-03-25T15:44:38Z,Fix typos,vignettes/rd.Rmd,True,False,True,False,7,7,14,"---FILE: vignettes/rd.Rmd---
@@ -132,8 +132,8 @@ Three other tags make it easier for the user to find documentation:
   optional, but if present, must be taken from the predefined list replicated
   in the [keywords vignette](rdkeywords.html). Keywords are not very useful,
   except for `@keywords internal`. Using the internal keyword removes the function
-  from the documentation index and disables some of its automated tests. 
-  A common use case is to both export a function (using `@export`) and marking it as 
+  from the documentation index and disables some of its automated tests.
+  A common use case is to both export a function (using `@export`) and marking it as
   internal. That way, advanced users can access a function that new users would be confused
   about if they were to see it in the index.
 
@@ -147,7 +147,7 @@ Functions are the mostly commonly documented objects. Most functions use three t
     The description should provide a succinct summary of the type of the
     parameter (e.g. a string, a numeric vector), and if not obvious from
     the name, what the parameter does. The description should start with a
-    captial letter and end with a full stop. It can span multiple lines (or
+    capital letter and end with a full stop. It can span multiple lines (or
     even paragraphs) if necessary. All parameters must be documented.
 
     You can document multiple arguments in one place by separating
@@ -237,7 +237,7 @@ Older versions of roxygen required explicit `@method generic class` tags for all
 
 Older versions of roxyen2 required explicit `@usage`, `@alias` and `@docType` to correctly document S4 objects, but from version 3.0.0 on roxygen2 generates correct metadata automatically. If you're upgrading from a previous version, make sure to remove these old tags.
 
-S4 __generics__ are also functions, so document them as such. Document __S4 classess__ by adding a roxygen block before `setClass()`. Use `@slot` to document the slots of the class. Here's a simple example:
+S4 __generics__ are also functions, so document them as such. Document __S4 classes__ by adding a roxygen block before `setClass()`. Use `@slot` to document the slots of the class. Here's a simple example:
 
 ```{r}
 #' An S4 class to represent a bank account.
@@ -256,7 +256,7 @@ S4 __methods__ are a little more complicated. Unlike S3, all S4 methods must be
 * In the generic. Most appropriate if the generic uses multiple dispatch
   and you control it.
 
-* In it's own file. Most appropriate if the method is complex. or the
+* In its own file. Most appropriate if the method is complex. or the
   either two options don't apply.
 
 Use either `@rdname` or `@describeIn` to control where method documentation goes. See the next section for more details.
@@ -294,7 +294,7 @@ There are two additional tags that are useful for documenting datasets:
 
 * `@source` where you got the data form, often a `\url{}`.
 
-To show how everything fits together, the example below is an exercept from the roxygen block used to document the diamonds dataset in ggplot2.
+To show how everything fits together, the example below is an excerpt from the roxygen block used to document the diamonds dataset in ggplot2.
 
 ```{r}
 #' Prices of 50,000 round cut diamonds.
@@ -384,7 +384,7 @@ You can document multiple functions in the same file by using either `@rdname` o
 * documenting methods in a class
 * documenting functions with the same (or similar arguments)
 
-It generates a new section, named either ""Methods (by class)"", ""Methods (by generic)"" or ""Functions"". The section contains a bulleted list describing each function, labelled so that you know what function or method its talking about. Here's an example, documenting an imaginary new generic:
+It generates a new section, named either ""Methods (by class)"", ""Methods (by generic)"" or ""Functions"". The section contains a bulleted list describing each function, labelled so that you know what function or method it's talking about. Here's an example, documenting an imaginary new generic:
 
 ```{r}
 #' Foo bar generic"
r-lib,roxygen2,b4b672a3bdc95409ea99247eb181d0aa0c4d9014,James Manton,ajd.manton@googlemail.com,2014-03-25T15:28:51Z,James Manton,ajd.manton@googlemail.com,2014-03-25T15:28:51Z,Fix link to keywords vignette,vignettes/rd.Rmd,True,False,True,False,1,1,2,"---FILE: vignettes/rd.Rmd---
@@ -130,7 +130,7 @@ Three other tags make it easier for the user to find documentation:
 
 * `@keywords keyword1 keyword2 ...` to add standardised keywords. Keywords are
   optional, but if present, must be taken from the predefined list replicated
-  in the [keywords vignette](rd-keywords.html). Keywords are not very useful,
+  in the [keywords vignette](rdkeywords.html). Keywords are not very useful,
   except for `@keywords internal`. Using the internal keyword removes the function
   from the documentation index and disables some of its automated tests. 
   A common use case is to both export a function (using `@export`) and marking it as "
r-lib,roxygen2,e68e45841956607070794e96153f7f79112b9280,James Manton,ajd.manton@googlemail.com,2014-03-25T15:04:35Z,James Manton,ajd.manton@googlemail.com,2014-03-25T15:04:35Z,Fix typos in vignette calls,R/roxygen.R;man/roxygen.Rd,False,True,True,False,6,6,12,"---FILE: R/roxygen.R---
@@ -19,8 +19,8 @@
 #' @importFrom Rcpp sourceCpp
 #' @examples
 #' \dontrun{roxygenize('pkg')}
-#' @seealso See \code{vignette(""rd"", package = ""roxygen"")} for an overview
-#'   of the package, \code{vignette(""rd"", package = ""roxygen"")} for generating
-#'   documenation, and \code{vignette(""namespace"", package = ""roxygen"")} for
+#' @seealso See \code{vignette(""roxygen2"", package = ""roxygen2"")} for an overview
+#'   of the package, \code{vignette(""rd"", package = ""roxygen2"")} for generating
+#'   documentation, and \code{vignette(""namespace"", package = ""roxygen2"")} for
 #'   generating the namespace specification.
 NULL

---FILE: man/roxygen.Rd---
@@ -24,9 +24,9 @@ Manuel Eugster \email{Manuel.Eugster@stat.uni-muenchen.de}
 Maintainer: Hadley Wickham \email{h.wickham@gmail.com}
 }
 \seealso{
-See \code{vignette(""rd"", package = ""roxygen"")} for an overview
-  of the package, \code{vignette(""rd"", package = ""roxygen"")} for generating
-  documenation, and \code{vignette(""namespace"", package = ""roxygen"")} for
+See \code{vignette(""roxygen2"", package = ""roxygen2"")} for an overview
+  of the package, \code{vignette(""rd"", package = ""roxygen2"")} for generating
+  documentation, and \code{vignette(""namespace"", package = ""roxygen2"")} for
   generating the namespace specification.
 }
 "
r-lib,roxygen2,e2b6c0985fc1ed3183519bd8d5b8583e48da1bda,hadley,h.wickham@gmail.com,2014-03-24T12:57:02Z,hadley,h.wickham@gmail.com,2014-03-24T12:57:02Z,Clarify error messages,R/utils.R,False,True,True,False,1,1,2,"---FILE: R/utils.R---
@@ -75,7 +75,7 @@ errors_with_srcref <- function(srcref, code) {
   withCallingHandlers(
     code,
     error = function(e) {
-      msg <- paste0(""Failure in roxygen block at "", loc, ""\n"", e$message)
+      msg <- paste0(""Failure in roxygen block beginning "", loc, ""\n"", e$message)
       stop(msg, call. = FALSE)
     }
   )"
r-lib,roxygen2,83ea997516fedf3bc747e10eabfce0b387589ea9,Thomas Kluyver,takowl@gmail.com,2014-03-21T18:28:33Z,Thomas Kluyver,takowl@gmail.com,2014-03-21T18:28:33Z,"Fix namespace of roxygenise

From trying to run it, the command suggested was slightly off.",README.md,False,False,False,False,1,1,2,"---FILE: README.md---
@@ -72,7 +72,7 @@ devtools::install_github(""klutometis/roxygen"")
 
 Roxygen does a live analysis of your source code: it loads all the code in your package, so it can create documentation using values in an R environment, not just source code. However, simulating package loading is rather tricky to do in general, so there are two ways to do it with roxygen:
 
-* `roxygen::roxygenise()` just sources all files in the `R/` directory
+* `roxygen2::roxygenise()` just sources all files in the `R/` directory
 
 * `devtools::document()` sources all files in the `R/` directory, compiles
   source code in the `src/` directory, loads data in the `data/` directory"
r-lib,roxygen2,1e3dee415d0a6ececb0012c0cac4737e5548c150,dougmitarotonda,dougmitarotonda@gmail.com,2014-03-20T20:32:38Z,dougmitarotonda,dougmitarotonda@gmail.com,2014-03-20T20:32:38Z,"Clarify @keywords documentation

In response to https://github.com/klutometis/roxygen/issues/226",vignettes/rd.Rmd,True,False,True,False,5,3,8,"---FILE: vignettes/rd.Rmd---
@@ -131,9 +131,11 @@ Three other tags make it easier for the user to find documentation:
 * `@keywords keyword1 keyword2 ...` to add standardised keywords. Keywords are
   optional, but if present, must be taken from the predefined list replicated
   in the [keywords vignette](rd-keywords.html). Keywords are not very useful,
-  except for `@keywords internal`. The internal keyword flags the function
-  as for developer use only, removing it from the documentation index and
-  disabling some of automated tests.
+  except for `@keywords internal`. Using the internal keyword removes the function
+  from the documentation index and disables some of its automated tests. 
+  A common use case is to both export a function (using `@export`) and marking it as 
+  internal. That way, advanced users can access a function that new users would be confused
+  about if they were to see it in the index.
 
 You use other tags based on the type of object that you're documenting. The following sections describe the most commonly used tags for functions, S3, S4 and RC objects and data.
 "
r-lib,roxygen2,83cb5293034ec72588a4d6fc4786cb663ddba2b1,dougmitarotonda,dougmitarotonda@gmail.com,2014-03-20T16:32:40Z,dougmitarotonda,dougmitarotonda@gmail.com,2014-03-20T16:32:40Z,Fix broken hyperlink,vignettes/rd.Rmd,True,False,True,False,1,1,2,"---FILE: vignettes/rd.Rmd---
@@ -130,7 +130,7 @@ Three other tags make it easier for the user to find documentation:
 
 * `@keywords keyword1 keyword2 ...` to add standardised keywords. Keywords are
   optional, but if present, must be taken from the predefined list replicated
-  in the [keywords vignette](keywords.html). Keywords are not very useful,
+  in the [keywords vignette](rd-keywords.html). Keywords are not very useful,
   except for `@keywords internal`. The internal keyword flags the function
   as for developer use only, removing it from the documentation index and
   disabling some of automated tests."
r-lib,roxygen2,95dc1c1b282be098db1cc7dc03ce6e4c91239e2f,hadley,h.wickham@gmail.com,2014-03-19T16:59:23Z,hadley,h.wickham@gmail.com,2014-03-19T16:59:23Z,More informative error messages. Closes #218,R/safety.R,False,True,True,False,4,2,6,"---FILE: R/safety.R---
@@ -9,7 +9,9 @@
 upgradeRoxygen <- function(path = ""."") {
   desc <- file.path(path, ""DESCRIPTION"")
   if (!file.exists(desc)) {
-    stop(""Doesn't look like a package"", call. = FALSE)
+    stop(""'"", path, ""' doesn't look like a package.\n"",
+      ""You probably need upgradeRoxygen('path/to/your/package')"",
+      call. = FALSE)
   }
 
   # Flag Rd files as ok
@@ -33,7 +35,7 @@ first_time_check <- function(path) {
   roxy <- vapply(rd, made_by_roxygen, logical(1))
   if (all(!roxy)) {
     stop(""Looks like this is your first time using roxygen2 > 4.0.0.\n"",
-      ""Please run roxygen2::upgradeRoxygen()."",
+      ""Please run roxygen2::upgradeRoxygen('"", path, ""')."",
       call. = FALSE)
   }
 }"
r-lib,roxygen2,9a429c533d67efad94ddb953c4c3aeea184f7d23,Will Beasley,wibeasley@hotmail.com,2014-03-13T18:48:23Z,Will Beasley,wibeasley@hotmail.com,2014-03-13T18:48:23Z,"Small corrections to `@examples` in Rd vignette

* The wording was modified in a few places

* The only real correction was removing the `x` from the cell at the intersection of `\donttest{}` and `R CMD check`.  Please verify that I correctly interpreting http://cran.r-project.org/doc/manuals/R-exts.html#Documenting-functions.

* I didn't update the actual vignettes (just the Rmd source code), because I was getting errors during the build process.  I didn't think it was worth figuring out for this vignette, but tell me if you'd like more details.",vignettes/rd.Rmd,True,False,True,False,5,5,10,"---FILE: vignettes/rd.Rmd---
@@ -158,20 +158,20 @@ Functions are the mostly commonly documented objects. Most functions use three t
     must work without errors as it is run automatically as part of `R CMD
     check`.
 
-    For the purpose of illustration, it's often useful to include code
+    However for the purpose of illustration, it's often useful to include code
     that causes an error. `\dontrun{}` allows you to include code in the
-    example that is never use. There are two other special commands
-    Code `\dontshow{}` is run, but not shown in the help page: this can
+    example that is never used. There are two other special commands.
+    `\dontshow{}` is run, but not shown in the help page: this can
     be useful for informal tests. `\donttest{}` is run in examples,
-    but not run automatically but `R CMD check`. This is useful if you
+    but not run automatically in `R CMD check`. This is useful if you
     have examples that take a long time to run. The options are summarised
     below.
 
     Command      | example   | help   | R CMD check
     ------------ | --------- | ------ | -----------
     `\dontrun{}` |           | x      |
     `\dontshow{}`| x         |        | x
-    `\donttest{}`| x         | x      | x
+    `\donttest{}`| x         | x      |
 
     Instead of including examples directly in the documentation, you can
     put them in separate files and use `@example path/relative/to/packge/root`"
r-lib,roxygen2,75fc1a4a535df24f4d2bcc715461309f8808604c,hadley,h.wickham@gmail.com,2014-03-04T17:17:43Z,hadley,h.wickham@gmail.com,2014-03-04T17:17:43Z,Fix typo in NEWS,NEWS.md,False,False,False,False,1,1,2,"---FILE: NEWS.md---
@@ -13,7 +13,7 @@ Roxygen2 4.0.0 is a major update to roxygen2 that makes provides enhanced error
   to document multiple related functions in one file (#185).
 
 * `@field` documents the fields on a reference class (#181). It works the
-  same way as `@slots` for S4 classes.
+  same way as `@slot` for S4 classes.
 
 * Roxygen2 now adds a comment to all generated files so that you know
   they've been generated, and should not be hand edited."
r-lib,roxygen2,d70ddb8ba7c2d583b59f0e87ee3093cbaba1b117,hadley,h.wickham@gmail.com,2014-03-02T16:31:03Z,hadley,h.wickham@gmail.com,2014-03-02T16:31:18Z,Fix news. Closes #201,NEWS.md,False,False,False,False,1,1,2,"---FILE: NEWS.md---
@@ -61,7 +61,7 @@ Roxygen2 4.0.0 is a major update to roxygen2 that makes provides enhanced error
   non-ASCII characters and will be wrapped if long (#180).
 
 * By default, reference classes now only document their own methods,
-  not their methods of parents (#)
+  not their methods of parents (#201).
 
 * Default aliases always include the original name of the object, even if
   overridden by `@name`. This also means that `A <- setClass(""A"")` will get"
r-lib,roxygen2,011501d1b59ec0e1d8d920ece94f12a9cc76735f,hadley,h.wickham@gmail.com,2014-02-13T15:10:51Z,hadley,h.wickham@gmail.com,2014-02-13T15:10:51Z,Fix broken test,inst/tests/test-usage.R,False,True,True,False,1,1,2,"---FILE: inst/tests/test-usage.R---
@@ -104,7 +104,7 @@ test_that(""backticks retained when needed"", {
   out <- roc_proc_text(rd_roclet(), ""
     #' Title.
     f <- function(`_x`) 1"")[[1]]
-  expect_equal(get_tag(out, ""usage"")$values, ""f(`_x`)"")
+  expect_equal(as.character(get_tag(out, ""usage"")$values), ""f(`_x`)"")
 })
 
 "
r-lib,roxygen2,7eaa6d7ca008dbcfb44cb4953f20c200a8cfbb74,dougmitarotonda,dougmitarotonda@gmail.com,2014-02-12T18:26:38Z,dougmitarotonda,dougmitarotonda@gmail.com,2014-02-12T18:26:38Z,"Add documentation for `@inheritParams`

Per discussion here: https://github.com/klutometis/roxygen/issues/189",vignettes/rd.Rmd,True,False,True,False,7,0,7,"---FILE: vignettes/rd.Rmd---
@@ -204,6 +204,13 @@ sum <- function(..., na.rm = TRUE) {}
 
 Indent the second and subsequent lines of a tag so that when scanning the documentation it's easy to see where one tag ends and the next begins. Tags that always span multiple lines (like `@example`) should start on a new line and don't need to be indented.
 
+## Inheriting parameters from other functions
+
+You can inherit parameter descriptions from other functions using `@inheritParams source_function`. This tag will bring in all documentation for parameters that are undocumented in the current function, but documented in the source function. The source can be a function in the current package, function, or another package using `package::function`.
+
+Note, however, that inheritance does not chain. In other words, the `source_function` must always be the function that defines the parameter using `@param`.
+
+
 ## Documenting multiple functions in the same file
 
 You can document multiple functions in the same file by using the `@rdname` tag. This overrides the default file name generated by roxygen and merges documentation for mulitple objects into one file. It's a technique best used with caution: documenting too many functions into one place leads to confusing documentation. It's best used when all functions have the same (or very similar) arguments."
r-lib,roxygen2,86e52e4f73383a59c18cd9be6ac41d2bdfb7dd5a,hadley,h.wickham@gmail.com,2014-02-11T22:30:29Z,hadley,h.wickham@gmail.com,2014-02-11T22:30:29Z,Fix install url,README.md,False,False,False,False,4,4,8,"---FILE: README.md---
@@ -13,7 +13,7 @@ The premise of `roxygen2` is simple: describe your functions in comments next to
 #' The length of a string (in characters).
 #'
 #' @param string input character vector
-#' @return numeric vector giving number of characters in each element of the 
+#' @return numeric vector giving number of characters in each element of the
 #'   character vector.  Missing strings have missing length.
 #' @seealso \code{\link{nchar}} which this function wraps
 #' @export
@@ -65,7 +65,7 @@ To get the current development version from github:
 
 ```R
 # install.packages(""devtools"")
-devtools::install_github(""roxygen/klutometis"")
+devtools::install_github(""klutometis/roxygen"")
 ```
 
 # Running
@@ -74,10 +74,10 @@ Roxygen does a live analysis of your source code: it loads all the code in your
 
 * `roxygen::roxygenise()` just sources all files in the `R/` directory
 
-* `devtools::document()` sources all files in the `R/` directory, compiles 
+* `devtools::document()` sources all files in the `R/` directory, compiles
   source code in the `src/` directory, loads data in the `data/` directory
   and generally does an accurate job of simulating package loading.
-  
+
 If you have a simple package, you can use `roxygenise()`, but for anything more complicated, I recommend that you use `document()`.
 
 # Roclets"
r-lib,roxygen2,4590b9c01e826a7992ef7488720cdcae73ed350c,hadley,h.wickham@gmail.com,2014-02-06T00:58:02Z,hadley,h.wickham@gmail.com,2014-02-06T00:58:02Z,Better error handling,NEWS.md;R/parse-preref.R;R/parse.R;R/roclet-rd.R;R/roxygen.R;R/utils.R;inst/tests/test-alias.R;inst/tests/test-complete.R;man/parsers.Rd,False,True,True,False,89,77,166,"---FILE: NEWS.md---
@@ -1,5 +1,9 @@
 # roxygen2 3.1.0.99
 
+* Parsing is stricter: many issues that were previously warnings are
+  now errors. All errors should now give you the line number of the
+  roxygen block associated with the error.
+
 * Every input is now checked to make sure that you have matching braces
   (e.g. every `{` has a matching `}`). This should prevent frustrating
   errors that require carefully reading of `.Rd` files. (#183)

---FILE: R/parse-preref.R---
@@ -1,9 +1,5 @@
 # Parse a preref
 parse.preref <- function(lines) {
-  # Extract srcrefs (needed for error messages)
-  srcrefs <- attr(lines, 'srcref')
-  srcrefs$lloc[1] <- srcrefs$lloc[1] + 1
-
   delimited.lines <- lines[str_detect(lines, LINE.DELIMITER)]
   trimmed.lines <- str_trim(str_replace(delimited.lines, LINE.DELIMITER, """"),
     ""right"")
@@ -19,22 +15,25 @@ parse.preref <- function(lines) {
   ## Compress the escaped delimeters.
   elements <- str_replace_all(elements, fixed(""@@""), ""@"")
 
-  parsed <- parse_elements(elements[-1], srcrefs)
+  parsed <- parse_elements(elements[-1])
+
   if (elements[[1]] != """") {
-    parsed$introduction <- check_rd(str_trim(elements[[1]]))
+    check_rd(NULL, elements[[1]])
+    parsed$introduction <- str_trim(elements[[1]])
   }
+
   parsed
 }
 
 # Sequence that distinguishes roxygen comment from normal comment.
 LINE.DELIMITER <- '\\s*#+\' ?'
 
-parse_elements <- function(elements, srcref) {
+parse_elements <- function(elements) {
   pieces <- str_split_fixed(elements, ""[[:space:]]+"", 2)
 
   parse_element <- function(tag, value) {
     tag_parser <- preref.parsers[[tag]] %||% parse.unknown
-    tag_parser(tag, value, srcref)
+    tag_parser(tag, value)
   }
 
   Map(parse_element, pieces[, 1], pieces[, 2])
@@ -46,70 +45,73 @@ parse_elements <- function(elements, srcref) {
 #'
 #' @param key the parsing key
 #' @param rest the expression to be parsed
-#' @param srcref srcref providing location of file name and line number
 #' @keywords internal
 #' @name parsers
 NULL
 
 #' @details \code{parse.default}: emit value unchanged.
 #' @export
 #' @rdname parsers
-parse.default <- function(key, rest, srcref) {
-  check_rd(str_trim(rest))
+parse.default <- function(key, rest) {
+  check_rd(key, rest)
+  str_trim(rest)
 }
 
-#' @details \code{parse.default}: warns about unknown tag.
+#' @details \code{parse.default}: throws errors about unknown tag.
 #' @export
 #' @rdname parsers
-parse.unknown <- function(key, rest, srcref) {
-  roxygen_warning(key, ' is an unknown key', srcref = srcref)
-  check_rd(str_trim(rest))
+parse.unknown <- function(key, rest) {
+  stop(""@"", key, "" is an unknown key"")
 }
 
 #' @details \code{parse.value}: fail if empty
 #' @export
 #' @rdname parsers
-parse.value <- function(key, rest, srcref) {
+parse.value <- function(key, rest) {
+  check_rd(key, rest)
   if (is.null.string(rest)) {
-    roxygen_stop(key, ' requires a value', srcref = srcref)
+    stop(""@"", key, ' requires a value')
   }
 
-  check_rd(str_trim(rest))
+  str_trim(rest)
 }
 
 #' @details \code{parse.words}: parse values into words separated by space
 #' @export
 #' @rdname parsers
-parse.words <- function(key, rest, srcref) {
-  str_split(check_rd(str_trim(rest)), ""\\s+"")[[1]]
+parse.words <- function(key, rest) {
+  check_rd(key, rest)
+  str_split(str_trim(rest), ""\\s+"")[[1]]
 }
 
 #' @details \code{parse.description}: parse mandatory name and description
 #' @export
 #' @rdname parsers
-parse.name.description <- function(key, rest, srcref) {
+parse.name.description <- function(key, rest) {
+  check_rd(key, rest)
   pieces <- str_split_fixed(rest, ""[[:space:]]+"", 2)
 
   name <- pieces[, 1]
   rest <- str_trim(pieces[, 2])
 
   if (is.null.string(name)) {
-    roxygen_stop(key, ' requires a name and description', srcref = srcref)
+    stop(""@"", key, ' requires a name and description')
   }
 
-  list(name = check_rd(name), description = check_rd(rest))
+  list(name = name, description = rest)
 }
 
 #' @details \code{parse.name}: one and only one word
 #' @export
 #' @rdname parsers
-parse.name <- function(key, name, srcref) {
-  name <- check_rd(str_trim(name))
+parse.name <- function(key, name) {
+  check_rd(key, name)
+  name <- str_trim(name)
 
   if (is.null.string(name)) {
-    roxygen_stop(key, ' requires a name', srcref = srcref)
+    stop(""@"", key, ' requires a name')
   } else if (str_count(name, ""\\s+"") > 1) {
-    roxygen_warning(key, ' ignoring extra arguments', srcref = srcref)
+    stop(""@"", key, ' should only have a single argument')
   }
 
   word(name, 1)
@@ -118,13 +120,18 @@ parse.name <- function(key, name, srcref) {
 #' @details \code{parse.toggle}: turn binary element on
 #' @export
 #' @rdname parsers
-parse.toggle <- function(key, rest, srcref) {
+parse.toggle <- function(key, rest) {
   TRUE
 }
 
-check_rd <- function(x) {
-  if (!rdComplete(x)) {
-    stop(""Incomplete rd in tag: "", x, call. = FALSE)
+check_rd <- function(key, text) {
+  if (rdComplete(text)) return(TRUE)
+
+  text <- str_trim(text)
+  if (!is.null(key)) {
+    stop(""Mismatched braces: \""@"", key, "" "", text, ""\"""", call. = FALSE)
+  } else {
+    stop(""Mismatched braces: \"""", text, ""\"""", call. = FALSE)
   }
-  x
+
 }

---FILE: R/parse.R---
@@ -1,7 +1,7 @@
 parse_package <- function(base_path, load_code) {
   env <- load_code(base_path)
   parsed <- lapply(r_files(base_path), parse_file, env = env)
-  
+
   unlist(parsed, recursive = FALSE)
 }
 
@@ -14,26 +14,29 @@ parse_text <- function(text) {
   env <- new.env(parent = parent.env(globalenv()))
   attr(env, ""hash"") <- suppressWarnings(digest(env))
   setPackageName(""roxygen_devtest"", env)
-  
+
   sys.source(file, envir = env)
   parse_file(file, env)
 }
 
 parse_file <- function(file, env, env_hash = attr(env, ""hash"")) {
   parsed <- parse(file = file, keep.source = TRUE)
   if (length(parsed) == 0) return()
-  
+
   refs <- getSrcref(parsed)
   comment_refs <- comments(refs)
-  
+
   extract <- function(call, ref, comment_ref) {
-    preref <- parse.preref(as.character(comment_ref))
-    if (is.null(preref)) return()
+    comment_ref2 <- list(filename = file, lloc = as.vector(comment_ref))
 
-    preref$object <- object_from_call(call, env, preref)
-    preref$srcref <- list(filename = file, lloc = as.vector(ref))
+    errors_with_srcref(comment_ref2, {
+      preref <- parse.preref(as.character(comment_ref))
+      if (is.null(preref)) return()
 
-    add_defaults(preref)
+      preref$object <- object_from_call(call, env, preref)
+      preref$srcref <- list(filename = file, lloc = as.vector(ref))
+      add_defaults(preref)
+    })
   }
 
   Map(extract, parsed, refs, comment_refs)
@@ -42,7 +45,7 @@ parse_file <- function(file, env, env_hash = attr(env, ""hash"")) {
 # For each src ref, find the comment block preceeding it
 comments <- function(refs) {
   srcfile <- attr(refs[[1]], ""srcfile"")
-  
+
   # first_line, first_byte, last_line, last_byte
   com <- vector(""list"", length(refs))
   for(i in seq_along(refs)) {
@@ -55,7 +58,7 @@ comments <- function(refs) {
       first_byte <- refs[[i - 1]][4] + 1
       first_line <- refs[[i - 1]][3]
     }
-    
+
     last_line <- refs[[i]][1]
     last_byte <- refs[[i]][2] - 1
     if (last_byte == 0) {
@@ -67,10 +70,10 @@ comments <- function(refs) {
         last_byte <- 1e3
       }
     }
-    
+
     lloc <- c(first_line, first_byte, last_line, last_byte)
     com[[i]] <- srcref(srcfile, lloc)
   }
-  
+
   com
 }

---FILE: R/roclet-rd.R---
@@ -197,13 +197,8 @@ roc_process.had <- function(roclet, partita, base_path, options = list()) {
 
   topics <- list()
   for (partitum in partita) {
-    withCallingHandlers({
+    errors_with_srcref(partitum$srcref, {
       new <- roclet_rd_one(partitum, base_path)
-    }, error = function(e) {
-      loc <- srcref_location(partitum$srcref)
-      msg <- paste0(""Roclet processing error"", loc, ""\n"", e$message)
-      call <- sys.call(-2)
-      stop(simpleError(msg, call))
     })
 
     if (is.null(new)) next
@@ -249,7 +244,7 @@ roclet_rd_one <- function(partitum, base_path) {
 
   # Figure out topic name
   name <- partitum$name %||% default_topic_name(partitum$object) %||%
-    roxygen_stop(""Missing name"", srcref = partitum$srcref)
+    stop(""Missing name"")
 
   # Work out file name and initialise Rd object
   filename <- str_c(partitum$merge %||% partitum$rdname %||% nice_name(name),

---FILE: R/roxygen.R---
@@ -1,5 +1,5 @@
 #' In-line documentation for R.
-#' 
+#'
 #' Roxygen is a Doxygen-like documentation system for R; allowing
 #' in-source specification of Rd files, collation and namespace
 #' directives.
@@ -18,6 +18,6 @@
 #' @useDynLib roxygen2
 #' @examples
 #' \dontrun{roxygenize('pkg')}
-#' @seealso See \code{\link{namespace_roclet}}, \code{\link{rd_roclet}}, 
+#' @seealso See \code{\link{namespace_roclet}}, \code{\link{rd_roclet}},
 #' for an overview of roxygen tags.
 NULL

---FILE: R/utils.R---
@@ -67,18 +67,24 @@ nice_name <- function(x) {
   x
 }
 
+errors_with_srcref <- function(srcref, code) {
+  if (isTRUE(getOption(""roxygen2.debug""))) return(force(code))
 
-roxygen_stop <- function(..., srcref = NULL) {
-  stop(..., srcref_location(srcref), call. = FALSE)
-}
+  loc <- srcref_location(srcref)
+
+  withCallingHandlers(
+    code,
+    error = function(e) {
+      msg <- paste0(""Failure in roxygen block at "", loc, ""\n"", e$message)
+      stop(msg, call. = FALSE)
+    }
+  )
 
-roxygen_warning <- function(..., srcref = NULL) {
-  warning(..., srcref_location(srcref), call. = FALSE)
 }
 
 srcref_location <- function(srcref = NULL) {
   if (is.null(srcref)) return()
-  str_c("" in block "", basename(srcref$filename), "":"", srcref$lloc[1])
+  str_c(basename(srcref$filename), "":"", srcref$lloc[1])
 }
 
 write_if_different <- function(path, contents) {

---FILE: inst/tests/test-alias.R---
@@ -6,7 +6,7 @@ test_that(""aliases split into pieces"", {
     #' @aliases a b
     #' @name a
     NULL"")[[1]]
-  
+
   expect_match(get_tag(out, ""alias"")$values, fixed(""a""), all = FALSE)
   expect_match(get_tag(out, ""alias"")$values, fixed(""b""), all = FALSE)
 })
@@ -31,7 +31,7 @@ test_that(""can use NULL to suppress default aliases"", {
     #' @aliases NULL
     #' @name a
     NULL"")[[1]]
-  
+
   expect_equal(get_tag(out, ""alias"")$values, character())
 })
 
@@ -41,6 +41,6 @@ test_that(""refclass gets -class alias"", {
     #' Title
     B <- setRefClass('B')
   "")[[1]]
-  
+
   expect_equal(get_tag(out, ""alias"")$value, ""B-class"")
-})
\ No newline at end of file
+})

---FILE: inst/tests/test-complete.R---
@@ -40,11 +40,11 @@ test_that(""incomplete rd in tag raises error"", {
   expect_error(roc_proc_text(rd_roclet(), ""
     #' Title
     #' @aliases title{
-    1""), ""Incomplete rd"")
+    1""), ""Mismatched braces"")
 })
 
 test_that(""incomplete rd in prequel raises error"", {
   expect_error(roc_proc_text(rd_roclet(), ""
     #' Title {
-    1""), ""Incomplete rd"")
+    1""), ""Mismatched braces"")
 })

---FILE: man/parsers.Rd---
@@ -10,35 +10,32 @@
 \alias{parsers}
 \title{Parsers.}
 \usage{
-parse.default(key, rest, srcref)
+parse.default(key, rest)
 
-parse.unknown(key, rest, srcref)
+parse.unknown(key, rest)
 
-parse.value(key, rest, srcref)
+parse.value(key, rest)
 
-parse.words(key, rest, srcref)
+parse.words(key, rest)
 
-parse.name.description(key, rest, srcref)
+parse.name.description(key, rest)
 
-parse.name(key, name, srcref)
+parse.name(key, name)
 
-parse.toggle(key, rest, srcref)
+parse.toggle(key, rest)
 }
 \arguments{
   \item{key}{the parsing key}
 
   \item{rest}{the expression to be parsed}
-
-  \item{srcref}{srcref providing location of file name and
-  line number}
 }
 \description{
 These function implement parsing different tag types.
 }
 \details{
 \code{parse.default}: emit value unchanged.
 
-\code{parse.default}: warns about unknown tag.
+\code{parse.default}: throws errors about unknown tag.
 
 \code{parse.value}: fail if empty
 "
r-lib,roxygen2,d0768c94c696a977e484be6387caee0479bd48d1,hadley,h.wickham@gmail.com,2014-02-06T00:25:05Z,hadley,h.wickham@gmail.com,2014-02-06T00:25:05Z,Check tags have matching parens. Fixes #183,NEWS.md;R/parse-preref.R;inst/tests/test-complete.R,False,True,True,False,43,15,58,"---FILE: NEWS.md---
@@ -1,9 +1,12 @@
 # roxygen2 3.1.0.99
 
+* Every input is now checked to make sure that you have matching braces
+  (e.g. every `{` has a matching `}`). This should prevent frustrating
+  errors that require carefully reading of `.Rd` files. (#183)
+
 * Roxygen2 will now never overwrite a file that was not generated by
   roxygen2. This means that the first time you use this version of
   roxygen, you'll need to delete all existing Rd files.
-
 * Roxygen2 now adds a comment to all generated files so that you know
   they've been generated, and should not be hand edited.
 

---FILE: R/parse-preref.R---
@@ -21,7 +21,7 @@ parse.preref <- function(lines) {
 
   parsed <- parse_elements(elements[-1], srcrefs)
   if (elements[[1]] != """") {
-    parsed$introduction <- str_trim(elements[[1]])
+    parsed$introduction <- check_rd(str_trim(elements[[1]]))
   }
   parsed
 }
@@ -31,19 +31,19 @@ LINE.DELIMITER <- '\\s*#+\' ?'
 
 parse_elements <- function(elements, srcref) {
   pieces <- str_split_fixed(elements, ""[[:space:]]+"", 2)
-  
+
   parse_element <- function(tag, value) {
     tag_parser <- preref.parsers[[tag]] %||% parse.unknown
     tag_parser(tag, value, srcref)
   }
-  
+
   Map(parse_element, pieces[, 1], pieces[, 2])
 }
 
 #' Parsers.
-#' 
+#'
 #' These function implement parsing different tag types.
-#' 
+#'
 #' @param key the parsing key
 #' @param rest the expression to be parsed
 #' @param srcref srcref providing location of file name and line number
@@ -55,15 +55,15 @@ NULL
 #' @export
 #' @rdname parsers
 parse.default <- function(key, rest, srcref) {
-  str_trim(rest)
+  check_rd(str_trim(rest))
 }
 
 #' @details \code{parse.default}: warns about unknown tag.
 #' @export
 #' @rdname parsers
 parse.unknown <- function(key, rest, srcref) {
   roxygen_warning(key, ' is an unknown key', srcref = srcref)
-  str_trim(rest)
+  check_rd(str_trim(rest))
 }
 
 #' @details \code{parse.value}: fail if empty
@@ -73,15 +73,15 @@ parse.value <- function(key, rest, srcref) {
   if (is.null.string(rest)) {
     roxygen_stop(key, ' requires a value', srcref = srcref)
   }
-  
-  str_trim(rest)
+
+  check_rd(str_trim(rest))
 }
 
 #' @details \code{parse.words}: parse values into words separated by space
 #' @export
 #' @rdname parsers
 parse.words <- function(key, rest, srcref) {
-  str_split(str_trim(rest), ""\\s+"")[[1]]
+  str_split(check_rd(str_trim(rest)), ""\\s+"")[[1]]
 }
 
 #' @details \code{parse.description}: parse mandatory name and description
@@ -96,22 +96,22 @@ parse.name.description <- function(key, rest, srcref) {
   if (is.null.string(name)) {
     roxygen_stop(key, ' requires a name and description', srcref = srcref)
   }
-  
-  list(name = name, description = rest)
+
+  list(name = check_rd(name), description = check_rd(rest))
 }
 
 #' @details \code{parse.name}: one and only one word
 #' @export
 #' @rdname parsers
 parse.name <- function(key, name, srcref) {
-  name <- str_trim(name)
+  name <- check_rd(str_trim(name))
 
   if (is.null.string(name)) {
     roxygen_stop(key, ' requires a name', srcref = srcref)
   } else if (str_count(name, ""\\s+"") > 1) {
     roxygen_warning(key, ' ignoring extra arguments', srcref = srcref)
   }
-  
+
   word(name, 1)
 }
 
@@ -121,3 +121,10 @@ parse.name <- function(key, name, srcref) {
 parse.toggle <- function(key, rest, srcref) {
   TRUE
 }
+
+check_rd <- function(x) {
+  if (!rdComplete(x)) {
+    stop(""Incomplete rd in tag: "", x, call. = FALSE)
+  }
+  x
+}

---FILE: inst/tests/test-complete.R---
@@ -1,5 +1,7 @@
 context(""rdComplete"")
 
+# Test low-level behaviour ----------------------------------------------------
+
 test_that(""braces must balance"", {
   expect_true(rdComplete(""{}""))
   expect_true(rdComplete(""{{}}""))
@@ -30,3 +32,19 @@ test_that(""newline ends comment"", {
 test_that(""escape disables comment"", {
   expect_false(rdComplete(""\\%{""))
 })
+
+
+# Test that incomplete Rd is caught in Rd blocks -------------------------------
+
+test_that(""incomplete rd in tag raises error"", {
+  expect_error(roc_proc_text(rd_roclet(), ""
+    #' Title
+    #' @aliases title{
+    1""), ""Incomplete rd"")
+})
+
+test_that(""incomplete rd in prequel raises error"", {
+  expect_error(roc_proc_text(rd_roclet(), ""
+    #' Title {
+    1""), ""Incomplete rd"")
+})"
r-lib,roxygen2,64d52d4af315836aa334a3ab9e1d60c93d2dfece,hadley,h.wickham@gmail.com,2014-02-05T21:02:07Z,hadley,h.wickham@gmail.com,2014-02-05T21:02:07Z,Fix yaml problem,.travis.yml,False,False,False,False,2,2,4,"---FILE: .travis.yml---
@@ -10,8 +10,8 @@ script: ./travis-tool.sh run_tests
 env:
   - global:
     - WARNINGS_ARE_ERRORS=1
-    -R_BUILD_ARGS=""--no-manual""
-    -R_CHECK_ARGS=""--no-manual --as-cran""
+    - R_BUILD_ARGS=""--no-manual""
+    - R_CHECK_ARGS=""--no-manual --as-cran""
 
 before_install:
   - curl -OL http://raw.github.com/craigcitro/r-travis/master/scripts/travis-tool.sh"
r-lib,roxygen2,64b9bf6c4134ea441e9e48a889e7dead336b1425,hadley,h.wickham@gmail.com,2014-02-05T17:30:05Z,hadley,h.wickham@gmail.com,2014-02-05T17:30:05Z,"Never overwrite non-roxygen files.
Fixes #174",NEWS.md;R/roxygenize.R;R/utils.R,False,True,True,False,44,15,59,"---FILE: NEWS.md---
@@ -1,5 +1,9 @@
 # roxygen2 3.1.0.99
 
+* Roxygen2 will now never overwrite a file that was not generated by
+  roxygen2. This means that the first time you use this version of
+  roxygen, you'll need to delete all existing Rd files.
+
 * Roxygen2 now adds a comment to all generated files so that you know
   they've been generated, and should not be hand edited.
 

---FILE: R/roxygenize.R---
@@ -8,9 +8,9 @@
 #'
 #' @param package.dir the package's top directory
 #' @param roxygen.dir,copy.package,overwrite,unlink.target deprecated
-#' @param roclets character vector of roclet names to apply to package. 
-#'   This defaults to \code{NULL}, which will use the \code{roclets} fields in 
-#'   the list provided in the \code{Roxygen} DESCRIPTION field. If none are 
+#' @param roclets character vector of roclet names to apply to package.
+#'   This defaults to \code{NULL}, which will use the \code{roclets} fields in
+#'   the list provided in the \code{Roxygen} DESCRIPTION field. If none are
 #'   specified, defaults to \code{c(""collate"", ""namespace"", ""rd"")}.
 #' @param load_code A function used to load all the R code in the package
 #'   directory. It is called with the path to the package, and it should return
@@ -27,11 +27,12 @@ roxygenize <- function(package.dir = ""."",
   if (copy.package) {
     stop(""Non-inplace roxygen no longer supported"")
   }
+  first_time_check(package.dir)
 
   base_path <- normalizePath(package.dir)
   man_path <- file.path(base_path, ""man"")
   dir.create(man_path, recursive = TRUE, showWarnings = FALSE)
-  
+
   options <- load_options(base_path)
   roclets <- roclets %||% options$roclets
 
@@ -48,7 +49,7 @@ roxygenize <- function(package.dir = ""."",
   roc_out <- function(roclet) {
     roc <- get(roclet, mode = ""function"")()
     results <- roc_process(roc, parsed, base_path, options = options)
-    roc_output(roc, results, base_path, options = options)    
+    roc_output(roc, results, base_path, options = options)
   }
   invisible(unlist(lapply(roclets, roc_out)))
 }
@@ -60,13 +61,13 @@ roxygenise <- roxygenize
 load_options <- function(base_path) {
   desc_path <- file.path(base_path, ""DESCRIPTION"")
   desc_opts <- read.dcf(desc_path, fields = ""Roxygen"")[[1, 1]]
-  
+
   if (is.na(desc_opts)) {
     opts <- list()
   } else {
     opts <- eval(parse(text = desc_opts))
   }
-  
+
   defaults <- list(
     wrap = TRUE,
     roclets = c(""collate"", ""namespace"", ""rd"")

---FILE: R/utils.R---
@@ -1,7 +1,7 @@
 internal_f <- function(p, f) {
   stopifnot(is.character(p), length(p) == 1)
   stopifnot(is.character(f), length(f) == 1)
-  
+
   get(f, envir = asNamespace(p))
 }
 
@@ -21,15 +21,15 @@ subs <- matrix(ncol = 2, byrow = T, c(
   '[<-', 'subset',
   '[', 'sub',
   '<-', 'set',
-  
+
   # Infix verbs
   '!', 'not',
   '&', 'and',
   '|', 'or',
   '*', 'times',
   '+', 'plus',
   '^', 'pow',
-  
+
   # Others
   '""', 'quote',
   '#', 'hash',
@@ -85,9 +85,15 @@ write_if_different <- function(path, contents) {
   if (!file.exists(dirname(path))) {
     dir.create(dirname(path), showWarnings = FALSE)
   }
-  
+
+  if (!made_by_roxygen(path)) {
+    warning(basename(path), "" not generated by roxygen2. Skipped."",
+      call. = FALSE)
+    return(FALSE)
+  }
+
   if (same_contents(path, contents)) return(FALSE)
-  
+
   name <- basename(path)
   if (!str_detect(name, ""^[a-zA-Z][a-zA-Z0-9_.-]*$"")) {
     cat(""Skipping invalid path: "", name, ""\n"")
@@ -99,14 +105,32 @@ write_if_different <- function(path, contents) {
   }
 }
 
+first_time_check <- function(path) {
+  rd <- dir(file.path(path, ""man""), full.names = TRUE)
+  if (length(rd) == 0) return()
+
+  roxy <- vapply(rd, made_by_roxygen, logical(1))
+  if (all(!roxy)) {
+    stop(""Looks like this is your first time using roxygen2 > 3.2.0."",
+      ""Please delete all existing Rd files"", call. = FALSE)
+  }
+}
+
+made_by_roxygen <- function(path) {
+  if (!file.exists(path)) return(TRUE)
+
+  first <- readLines(path, n = 1)
+  grepl(""^. Generated by roxygen2"", first)
+}
+
 same_contents <- function(path, contents) {
   if (!file.exists(path)) return(FALSE)
-  
+
   contents <- str_c(str_c(contents, collapse = ""\n""), ""\n"")
-  
+
   text_hash <- digest(contents, serialize = FALSE)
   file_hash <- digest(file = path)
-  
+
   identical(text_hash, file_hash)
 }
 "
r-lib,roxygen2,802515b038256f8694e60ae759f2c865ebe757a8,hadley,h.wickham@gmail.com,2014-02-05T17:06:57Z,hadley,h.wickham@gmail.com,2014-02-05T17:07:00Z,"Wrap usage statements of RC methods.
Fixes #180",NEWS.md;R/roclet-rd.R;inst/tests/test-rc.R;inst/tests/test-usage.R,False,True,True,False,46,27,73,"---FILE: NEWS.md---
@@ -1,5 +1,8 @@
 # roxygen2 3.1.0.99
 
+* Usage statements in generated roxygen statements non-longer contain
+  non-ASCII characters and will be wrapped if long. (#180)
+
 * New `@field` tag for documenting the fields on a reference class. (#181)
 
 # roxygen2 3.1.0

---FILE: R/roclet-rd.R---
@@ -367,7 +367,8 @@ process_methods <- function(block) {
     desc <- docstring(obj$value@.Data)
     if (is.null(desc)) return()
 
-    paste0(""\\code{"", function_usage(obj$name, formals(obj$value@.Data)),  ""}: "", desc)
+    usage <- function_usage(obj$name, formals(obj$value@.Data))
+    paste0(""\\code{"", wrap_string(usage),  ""}: "", desc)
   }
 
   descs <- unlist(lapply(methods, method_desc))

---FILE: inst/tests/test-rc.R---
@@ -60,7 +60,7 @@ test_that(""RC methods included included in own section"", {
       }
     ))
   "")[[1]]
-  
+
   methods <- get_tag(out, ""rcmethods"")$values
   expect_equal(names(methods), ""f"")
   expect_match(methods[[1]], ""This function has a docstring"")

---FILE: inst/tests/test-usage.R---
@@ -45,7 +45,7 @@ test_that(""default usage correct for S3 methods"", {
     #' Modify
     '[<-.foo' <- function(x, value) 'foo'
   "")
-  
+
   expect_equal(get_tag(out[[1]], ""usage"")$values, rd(""\\method{mean}{foo}(x)""))
   expect_equal(get_tag(out[[2]], ""usage"")$values, rd(""\\method{+}{foo}(x, b)""))
   expect_equal(get_tag(out[[3]], ""usage"")$values, rd(""\\method{[}{foo}(x) <- value""))
@@ -65,30 +65,30 @@ test_that(""default usage correct for S4 methods"", {
     #' Modify
     setMethod('[<-', 'foo', function(x, i, j, ..., value) 'foo')
   "")
-  
-  expect_equal(get_tag(out[[1]], ""usage"")$values, 
+
+  expect_equal(get_tag(out[[1]], ""usage"")$values,
     rd(""\\S4method{sum}{foo}(x, ..., na.rm = FALSE)""))
-  expect_equal(get_tag(out[[2]], ""usage"")$values, 
+  expect_equal(get_tag(out[[2]], ""usage"")$values,
     rd(""\\S4method{+}{foo,ANY}(e1, e2)""))
-  expect_equal(get_tag(out[[3]], ""usage"")$values, 
+  expect_equal(get_tag(out[[3]], ""usage"")$values,
     rd(""\\S4method{[}{foo}(x, i, j, ...) <- value""))
 })
 
 test_that(""default usage correct for S4 methods with different args to generic"", {
   out <- roc_proc_text(roc, ""
     #' Generic
-    #' 
+    #'
     #' @param x x
     #' @param ... arguments to methods
     setGeneric('testfun',function(x,...) standardGeneric('testfun'))
-    
+
     #' Method
-    #' 
+    #'
     #' @param add add
     setMethod('testfun','matrix',function(x, add = FALSE, ...){x - 1})
   "")
-  
-  expect_equal(get_tag(out[[2]], ""usage"")$value, 
+
+  expect_equal(get_tag(out[[2]], ""usage"")$value,
     rd(""\\S4method{testfun}{matrix}(x, add = FALSE, ...)""))
 })
 
@@ -119,30 +119,30 @@ test_that(""@usage overrides default for @docType data"", {
     #' @docType data
     #' @usage data(abc)
     NULL"")[[1]]
-  
+
   expect_equal(get_tag(out, ""usage"")$values, rd(""data(abc)""))
 })
 
 test_that(""@usage NULL suppresses default usage"", {
   out <- roc_proc_text(roc, ""
     #' @usage NULL
     a <- function(a=1) {}"")[[1]]
-  
-  expect_equal(get_tag(out, ""usage"")$values, NULL)  
+
+  expect_equal(get_tag(out, ""usage"")$values, NULL)
 })
 
 test_that(""quoted topics have usage statements"", {
   out <- roc_proc_text(roc, ""
     #' Title.
     \""f\"" <- function(a = 1, b = 2, c = a + b) {}"")[[1]]
-  
+
   expect_equal(get_tag(out, ""usage"")$values,
     rd(""f(a = 1, b = 2, c = a + b)""))
-  
+
   expect_equal(format(get_tag(out, ""usage"")),
     ""\\usage{\nf(a = 1, b = 2, c = a + b)\n}\n""
   )
-  
+
 })
 
 # Escaping --------------------------------------------------------------------
@@ -151,11 +151,11 @@ test_that(""usage escaping preserved when combined"", {
   out <- roc_proc_text(roc, ""
     #' Foo
     foo <- function(x = '%') x
-    
+
     #' @rdname foo
     bar <- function(y = '%') y
   "")[[1]]
-  
+
   expect_is(get_tag(out, ""usage"")$values, ""rd"")
 })
 
@@ -164,8 +164,8 @@ test_that(""default usage not double escaped"", {
     #' Regular
     mean.foo <- function(x) 'foo'
   "")[[1]]
-  
-  expect_equal(format(get_tag(out, ""usage"")), 
+
+  expect_equal(format(get_tag(out, ""usage"")),
     ""\\usage{\n\\method{mean}{foo}(x)\n}\n"")
 })
 
@@ -174,7 +174,7 @@ test_that(""% and \\ are escaped in usage"", {
     #' Title.
     a <- function(a='%\\\\') {}"")[[1]]
   expect_equal(get_tag(out, ""usage"")$values, escape('a(a = ""%\\\\"")'))
-  expect_equal(format(get_tag(out, ""usage"")), 
+  expect_equal(format(get_tag(out, ""usage"")),
     ""\\usage{\na(a = \""\\%\\\\\\\\\"")\n}\n"")
 })
 
@@ -189,15 +189,30 @@ test_that(""% and \\ not escaped in manual usage"", {
 })
 
 test_that(""non-syntactic names are quoted"", {
-  
+
   out <- roc_proc_text(roc, ""
     #' Title.
     'a b' <- function(x) x"")[[1]]
-  
+
   expect_equal(get_tag(out, ""usage"")$values, rd('""a b""(x)'))
 })
 
 
+test_that(""Special vars removed in rc methods usage"", {
+  out <- roc_proc_text(rd_roclet(), ""
+    #' Class Blob
+    ABCD <- setRefClass('ABC', methods = list(
+      draw = function(x = 1) {
+        \""2\""
+        x
+      })
+    )
+  "")[[1]]
+
+  methods <- get_tag(out, ""rcmethods"")$values
+  expect_equal(methods[[1]], ""\\code{draw(x = 1)}: 2"")
+})
+
 # Wrapping --------------------------------------------------------------------
 
 test_that(""long usages protected from incorrect breakage"", {
@@ -217,15 +232,15 @@ test_that(""argument vectors split on whitespace"", {
     #' Function long usage
     f <- function(a = c('abcdef', 'abcdef', 'abcdef', 'abcdef', 'abcdef',
                   'abcdef', 'abcdef', 'abcdef'))  1"")[[1]]
-  
+
   usage <- get_tag(out, ""usage"")[[2]]
   expect_equal(str_count(usage, ""\n""), 1)
 })
 
 test_that(""\\method not split inappropriately"", {
   out <- roc_proc_text(roc, ""
     #' Function long usage
-    mean.reallyratherquitelongclassname <- 
+    mean.reallyratherquitelongclassname <-
       function(reallyquitelongargument = 'reallyratherquitelongvalue') 1
   "")[[1]]
   usage <- format(get_tag(out, ""usage""))"
r-lib,roxygen2,93fe512416d815da79f23c352d14a04f782556c9,hadley,h.wickham@gmail.com,2013-12-09T15:27:57Z,hadley,h.wickham@gmail.com,2013-12-09T15:27:57Z,Better error message when roclet computation fails #164,R/roclet-rd.R,False,True,True,False,9,1,10,"---FILE: R/roclet-rd.R---
@@ -196,7 +196,15 @@ roc_process.had <- function(roclet, partita, base_path, options = list()) {
 
   topics <- list()
   for (partitum in partita) {
-    new <- roclet_rd_one(partitum, base_path)
+    withCallingHandlers({
+      new <- roclet_rd_one(partitum, base_path)
+    }, error = function(e) {
+      loc <- srcref_location(partitum$srcref)
+      msg <- paste0(""Roclet processing error"", loc, ""\n"", e$message)
+      call <- sys.call(-2)
+      stop(simpleError(msg, call))
+    })
+    
     if (is.null(new)) next
     
     old <- topics[[new$filename]]"
r-lib,roxygen2,ab1548a440a765e9dcfaa64e23b57ac478fe2005,hadley,h.wickham@gmail.com,2013-12-06T12:22:17Z,hadley,h.wickham@gmail.com,2013-12-06T12:22:23Z,Fix bug in objec_from_call. Closes #162,R/object-from-call.R;inst/tests/test-rd.R,False,True,True,False,16,2,18,"---FILE: R/object-from-call.R---
@@ -3,11 +3,12 @@ object_from_call <- function(call, env, block) {
   
   call <- standardise_call(call, env)
   name <- as.character(call[[1]])
-  if (length(name) > 1) return(srcref)
+  
+  if (length(name) > 1) return(NULL)
   
   # Dispatch to registered srcref parsers based on function name
   parser <- find_parser(name)
-  if (is.null(parser)) return(srcref)
+  if (is.null(parser)) return(NULL)
   
   parser(call, env, block)
 }

---FILE: inst/tests/test-rd.R---
@@ -59,3 +59,16 @@ test_that(""deleted objects not documented"", {
 })
 
 
+test_that(""documenting unknown function requires name"", {
+  expect_error(roc_proc_text(rd_roclet(), ""
+    #' Virtual Class To Enforce Max Slot Lenght
+    #' 
+    #' @export
+    setClass('A')
+    
+    #' Validity function.
+    setValidity('A', function(object) TRUE)  
+    ""),
+    ""Missing name""
+  )
+})"
r-lib,roxygen2,844363ffec22d23780b5468a302273f1f434d417,hadley,h.wickham@gmail.com,2013-12-04T17:22:35Z,hadley,h.wickham@gmail.com,2013-12-04T17:22:35Z,Fix typo in .Rbuildignore,.Rbuildignore,False,False,False,False,1,1,2,"---FILE: .Rbuildignore---
@@ -4,4 +4,4 @@
 ^.*\.Rproj$
 ^\.Rproj\.user$
 ^\.travis\.yml$
-^\.NEWS\.md$
+^\NEWS\.md$"
r-lib,roxygen2,6aba3425f46b001ba7fc7bb4932535f86f40eaaf,hadley,h.wickham@gmail.com,2013-12-04T15:46:28Z,hadley,h.wickham@gmail.com,2013-12-04T15:46:28Z,Fix markdown formatting buglet,NEWS.md,False,False,False,False,2,2,4,"---FILE: NEWS.md---
@@ -142,8 +142,8 @@
 * Objects that no longer exist are not documented (Fixes #42)
 
 * Errors now display file name and line number of roxygen block to help you
-  find the problem. Thanks to code contributions from Renaud Gaujoux. (Fixes
-  #13)
+  find the problem. Thanks to code contributions from Renaud Gaujoux. 
+  (Fixes #13)
 
 * Documentation with no untagged text but with `@title`, `@description` and
   `@details` tags now produces correct output."
r-lib,roxygen2,c1e1ac1671cb970f96cdf47057d27314855ee30f,hadley,h.wickham@gmail.com,2013-11-27T14:09:01Z,hadley,h.wickham@gmail.com,2013-11-27T14:09:01Z,"Suppress output when tag value is NULL.
Used to override defaults. Fixes #151",R/rd-tag-api.R;R/roclet-rd.R;R/usage.R;inst/tests/test-format.R;inst/tests/test-usage.R,False,True,True,False,23,1,24,"---FILE: R/rd-tag-api.R---
@@ -7,6 +7,8 @@
 #
 new_tag <- function(tag, values) {
   if (is.null(values)) return()
+  # NULL is special sentinel value that suppresses output of that tag
+  if (identical(values, ""NULL"")) return()
 
   subc <- str_c(tag, ""_tag"")
   list(structure(list(tag = tag, values = values), class = c(subc, ""rd_tag"")))

---FILE: R/roclet-rd.R---
@@ -427,7 +427,7 @@ process.docType <- function(partitum) {
 }
 
 process_had_tag <- function(partitum, tag, f = new_tag) {
-  matches <- partitum[names(partitum) == tag]
+  matches <- partitum[names(partitum) == tag]  
   if (length(matches) == 0) return()
 
   unlist(lapply(matches, function(p) f(tag, p)), recursive = FALSE)

---FILE: R/usage.R---
@@ -2,6 +2,8 @@
 usage_tag <- function(partitum) {
   if (is.null(partitum$usage)) {
     usage <- wrap_string(default_usage(partitum$object))
+  } else if (partitum$usage == ""NULL"") { 
+    usage <- NULL
   } else {
     # Treat user input as already escaped, otherwise they have no way
     # to enter \S4method etc.

---FILE: inst/tests/test-format.R---
@@ -20,6 +20,16 @@ test_that(""@format overrides defaults"", {
   expect_equal(get_tag(out, ""format"")$values, ""abc"")
 })
 
+test_that(""@format NULL suppresses default usage"", {
+  out <- roc_proc_text(roc, ""
+    #' Title
+    #' @format NULL
+    x <- list(a = 1, b = 2)"")[[1]]
+  
+  expect_equal(get_tag(out, ""format"")$values, NULL)  
+})
+
+
 test_that(""@format not escaped"", {
   out <- roc_proc_text(roc, ""
     #' Title

---FILE: inst/tests/test-usage.R---
@@ -114,6 +114,14 @@ test_that(""@usage overrides default for @docType data"", {
   expect_equal(get_tag(out, ""usage"")$values, rd(""data(abc)""))
 })
 
+test_that(""@usage NULL suppresses default usage"", {
+  out <- roc_proc_text(roc, ""
+    #' @usage NULL
+    a <- function(a=1) {}"")[[1]]
+  
+  expect_equal(get_tag(out, ""usage"")$values, NULL)  
+})
+
 test_that(""quoted topics have usage statements"", {
   out <- roc_proc_text(roc, ""
     #' Title."
r-lib,roxygen2,5d27512fd4ff0e21883e5a5798c3e6360fbd60fc,hadley,h.wickham@gmail.com,2013-11-27T13:39:36Z,hadley,h.wickham@gmail.com,2013-11-27T13:39:36Z,"Better usage for methods with more args than generic.
i.e. when the generic includes ...  Fixes #154",R/object-from-call.R;inst/tests/test-usage.R,False,True,True,False,24,0,24,"---FILE: R/object-from-call.R---
@@ -79,6 +79,11 @@ parser_setGeneric <- function(call, env, block) {
 parser_setMethod <- function(call, env, block) {
   name <- as.character(call$f)
   value <- getMethod(name, eval(call$signature), where = env)
+  # When a generic has ... and a method adds new arguments, the S4 method
+  # wraps the definition inside another function which has the same arguments
+  # as the generic. We replace it with the real definition so that formals etc
+  # are correct.
+  value@.Data <- eval(call$definition, env)
   
   object(""s4method"", name, value)
 }

---FILE: inst/tests/test-usage.R---
@@ -74,6 +74,25 @@ test_that(""default usage correct for S4 methods"", {
     rd(""\\S4method{[}{foo}(x, i, j, ...) <- value""))
 })
 
+test_that(""default usage correct for S4 methods with different args to generic"", {
+  out <- roc_proc_text(roc, ""
+    #' Generic
+    #' 
+    #' @param x x
+    #' @param ... arguments to methods
+    setGeneric('testfun',function(x,...) standardGeneric('testfun'))
+    
+    #' Method
+    #' 
+    #' @param add add
+    setMethod('testfun','matrix',function(x, add = FALSE, ...){x - 1})
+  "")
+  
+  expect_equal(get_tag(out[[2]], ""usage"")$value, 
+    rd(""\\S4method{testfun}{matrix}(x, add = FALSE, ...)""))
+})
+  
+  
 # @usage -----------------------------------------------------------------------
 
 test_that(""@usage overrides default"", {"
r-lib,roxygen2,76397052a6b97013d6d562813dcf44b1169d88eb,Kirill M칲ller,kirill.mueller@ivt.baug.ethz.ch,2013-11-25T23:11:16Z,Kirill M칲ller,kirill.mueller@ivt.baug.ethz.ch,2013-11-25T23:11:16Z,don't throw error if namespace is empty,R/roclet-namespace.R,False,True,True,False,1,1,2,"---FILE: R/roclet-namespace.R---
@@ -97,7 +97,7 @@ namespace_roclet <- function() {
 
 #' @export
 roc_process.namespace <- function(roclet, partita, base_path, options = list()) {
-  ns <- unlist(lapply(partita, ns_process_partitum))
+  ns <- unlist(lapply(partita, ns_process_partitum)) %||% character()
   sort_c(unique(ns))
 }
 "
r-lib,roxygen2,b07b0e6dadb791f573f69ff47d337ca04a025b69,hadley,h.wickham@gmail.com,2013-11-20T16:04:25Z,hadley,h.wickham@gmail.com,2013-11-20T16:04:25Z,Fix a test I forgot to save,inst/tests/test-usage.R,False,True,True,False,0,9,9,"---FILE: inst/tests/test-usage.R---
@@ -61,15 +61,6 @@ test_that(""usage escaping preserved when combined"", {
   expect_is(get_tag(out, ""usage"")$values, ""rd"")
 })
 
-test_that(""default usage not double escaped"", {
-  out <- roc_proc_text(roc, ""
-    #' Regular
-    mean.foo <- function(x) 'foo'
-  "")[[1]]
-  
-  expect_equal(format(get_tag(out, ""usage"")), rd(""\\\method{mean}{foo}(x)""))
-})
-
 test_that(""default usage correct for S4 methods"", {
   setClass(""foo"", where = environment())
   on.exit(removeClass(""foo""))"
r-lib,roxygen2,53fecd6a534bbef3edd285de684ab8fcd7bf3233,hadley,h.wickham@gmail.com,2013-11-20T15:54:52Z,hadley,h.wickham@gmail.com,2013-11-20T15:54:52Z,"Implement more consistent usage escaping.
Partial fix for #149",DESCRIPTION;NAMESPACE;R/object-defaults.R;R/rd-escape.R;R/rd-tag-api.R;R/roclet-rd.R;R/usage.R;R/utils.R;inst/tests/test-examples.R;inst/tests/test-format.R;inst/tests/test-usage.R,False,True,True,False,101,35,136,"---FILE: DESCRIPTION---
@@ -33,6 +33,7 @@ Collate:
     'parse-preref.R'
     'parse-registry.R'
     'parse.R'
+    'rd-escape.R'
     'rd-file-api.R'
     'rd-parse.R'
     'rd-tag-api.R'

---FILE: NAMESPACE---
@@ -16,6 +16,8 @@ S3method(default_usage,s3method)
 S3method(default_usage,s4class)
 S3method(default_usage,s4generic)
 S3method(default_usage,s4method)
+S3method(escape,character)
+S3method(escape,rd)
 S3method(format,alias_tag)
 S3method(format,arguments_tag)
 S3method(format,author_tag)
@@ -50,6 +52,7 @@ S3method(object_defaults,data)
 S3method(object_defaults,default)
 S3method(object_defaults,s4class)
 S3method(object_defaults,s4method)
+S3method(print,rd)
 S3method(print,rd_file)
 S3method(print,rd_tag)
 S3method(roc_output,had)

---FILE: R/object-defaults.R---
@@ -20,7 +20,7 @@ object_defaults.default <- function(x) list()
 object_defaults.data <- function(x) {
   list(
     docType = ""data"",
-    format = escape_rd(paste0(capture.output(str(x$value)), collapse = ""\n"")),
+    format = escape(paste0(capture.output(str(x$value)), collapse = ""\n"")),
     keywords = ""datasets""
   )
 }

---FILE: R/rd-escape.R---
@@ -0,0 +1,47 @@
+# A simple object to represent rd escaped text.
+rd <- function(x) {
+  structure(x, class = ""rd"")
+}
+
+#' @export
+c.rd <- function(...) {
+  rd(unlist(lapply(list(...), escape), use.names = FALSE))
+}
+
+#' @export
+print.rd <- function(x, ...) {
+  out <- paste0(""<rd> "", x, collapse = ""\n"")
+  cat(out)
+}
+
+escape <- function(x) UseMethod(""escape"")
+#' @export
+escape.rd <- function(x) x
+#' @export
+escape.character <- function(x) {
+  x1 <- gsub(""\\"", ""\\\\"", x, fixed = TRUE)
+  x2 <- gsub(""%"", ""\\%"", x1, fixed = TRUE)
+  
+  rd(x2)
+}
+
+# Works like escape, but unescapes special rd example commands
+escape_examples <- function(x) {
+  gsub(""\\\\dont"", ""\\dont"", escape(x))
+}
+
+# Works like paste, but automatically escapes all input variables,
+# but not literal strings
+build_rd <- function(..., collapse = NULL, sep = """") {
+  args <- dots(...)
+  env <- parent.frame()
+  
+  escaped <- lapply(args, function(arg) {
+    if (is.character(arg)) return(arg)
+    
+    escape(eval(arg, env))
+  })
+  
+  string <- do.call(""paste"", c(escaped, list(collapse = collapse, sep = sep)))
+  rd(string)
+}

---FILE: R/rd-tag-api.R---
@@ -27,8 +27,7 @@ rd_tag <- function(tag, ..., space = FALSE) {
   } else {
     values <- str_trim(c(...))
   }
-  # Turn non-breaking spaces back into regular spaces
-  values <- str_replace_all(values, fixed(""\u{A0}""), "" "")
+
   str_c(""\\"", tag, str_c(""{"", values, ""}"", collapse = """"), ""\n"")
 }
 
@@ -116,7 +115,7 @@ format.formals_tag <- format_null
 
 #' @export
 format.usage_tag <- function(x, ...) {
-  rd_tag(x$tag, paste0(escape_rd(x$values), collapse = ""\n\n""), space = TRUE)
+  rd_tag(x$tag, build_rd(x$values, collapse = ""\n\n""), space = TRUE)
 }
 
 #' @export

---FILE: R/roclet-rd.R---
@@ -387,10 +387,6 @@ process.slot <- function(partitum) {
 # If \code{@@examples} is provided, use that; otherwise, concatenate
 # the files pointed to by each \code{@@example}.
 process.examples <- function(partitum, base_path) {
-  escape_examples <- function(x) {
-    gsub(""\\\\dont"", ""\\dont"", escape_rd(x))
-  }
-  
   out <- list()
   if (!is.null(partitum$examples)) {
     ex <- escape_examples(partitum$examples)

---FILE: R/usage.R---
@@ -10,6 +10,7 @@ wrap_string <- function(x) {
   Encoding(y) <- Encoding(x)
   
   y <- str_replace_all(y, ""\u{A0}"", "" "")
+  class(y) <- class(x)
   y
 }
 
@@ -35,7 +36,7 @@ default_usage.s3generic <- default_usage.function
 default_usage.s3method <- function(x) {
   method <- attr(x$value, ""s3method"")
   s3method <- function(name) {
-    paste0(""\\method{"", name, ""}{"", method[2], ""}"")
+    build_rd(""\\method{"", name, ""}{"", method[2], ""}"")
   }
   function_usage(method[1], formals(x$value), s3method)
 }
@@ -47,7 +48,7 @@ default_usage.s4generic <- default_usage.function
 default_usage.s4method <- function(x) {
   s4method <- function(name) {
     signature <- str_c(as.character(x$value@defined), collapse = "","")
-    paste0(""\\S4method{"", name, ""}{"", signature, ""}"")
+    build_rd(""\\S4method{"", name, ""}{"", signature, ""}"")
   }
   function_usage(x$name, formals(x$value), s4method)
 }
@@ -66,20 +67,19 @@ function_usage <- function(name, formals, format_name = identity) {
     formals$value <- NULL
     
     arglist <- args_string(usage_args(formals))
-    str_c(format_name(name), ""("", arglist, "") <- value"")
+    build_rd(format_name(name), ""("", arglist, "") <- value"")
   } else if (is_infix_fun(name) && identical(format_name, identity)) {
     # If infix, and regular function, munge format
     arg_names <- names(formals)
-    name <- str_replace_all(name, fixed(""%""), ""\\%"")
     
-    str_c(arg_names[1], "" "", format_name(name), "" "", arg_names[2])
+    build_rd(arg_names[1], "" "", format_name(name), "" "", arg_names[2])
   } else {
     # Quote non-syntactic names if no special formatting
     if (identical(format_name, identity)) {
-      name <- quote_if_needed(name)  
+      name <- quote_if_needed(name) 
     }
     
-    str_c(format_name(name), ""("", arglist, "")"")
+    build_rd(format_name(name), ""("", arglist, "")"")
   }
   
 }

---FILE: R/utils.R---
@@ -107,7 +107,6 @@ r_files <- function(path) {
   dir(file.path(path, ""R""), ""[.Rr]$"", full.names = TRUE)
 }
 
-escape_rd <- function(x) {
-  x1 <- gsub(""\\"", ""\\\\"", x, fixed = TRUE)
-  gsub(""%"", ""\\%"", x1, fixed = TRUE)
-}
\ No newline at end of file
+dots <- function(...) {
+  eval(substitute(alist(...)))
+}

---FILE: inst/tests/test-examples.R---
@@ -63,7 +63,7 @@ test_that(""% and \\ in @example escaped"", {
     NULL"")[[1]]
 
   examples <- get_tag(out, ""examples"")$values
-  expect_equal(examples, ""x \\%*\\% y # \\\\x"")
+  expect_equal(examples, rd(""x \\%*\\% y # \\\\x""))
 })
 
 test_that(""\\dontrun in @example unescaped"", {
@@ -73,5 +73,5 @@ test_that(""\\dontrun in @example unescaped"", {
     NULL"")[[1]]
   
   examples <- get_tag(out, ""examples"")$values
-  expect_equal(examples, ""\\dontrun{x <- 1}"")
+  expect_equal(examples, rd(""\\dontrun{x <- 1}""))
 })

---FILE: inst/tests/test-format.R---
@@ -7,7 +7,7 @@ test_that(""format defaults to output from str"", {
     x <- list(a = 1, b = 2)"")[[1]]
   
   expect_equal(get_tag(out, ""format"")$values, 
-    ""List of 2\n $ a: num 1\n $ b: num 2""
+   rd(""List of 2\n $ a: num 1\n $ b: num 2"")
   )
 })
 

---FILE: inst/tests/test-usage.R---
@@ -5,31 +5,31 @@ test_that(""usage captured from formals"", {
   out <- roc_proc_text(roc, ""
     #' Title.
     a <- function(a=1) {}"")[[1]]
-  expect_equal(get_tag(out, ""usage"")$values, ""a(a = 1)"")
+  expect_equal(get_tag(out, ""usage"")$values, rd(""a(a = 1)""))
 })
 
 test_that(""usage correct for modification functions"", {
   out <- roc_proc_text(roc, ""
     #' Title.
     `foo<-` <- function(x, value) {}"")[[1]]
 
-  expect_equal(get_tag(out, ""usage"")$values, ""foo(x) <- value"")
+  expect_equal(get_tag(out, ""usage"")$values, rd(""foo(x) <- value""))
 })
 
 test_that(""usage correct for functions with no arguments"", {
   out <- roc_proc_text(roc, ""
       #' Function without parameters
       f <- function() 1"")[[1]]
 
-  expect_equal(get_tag(out, ""usage"")$values, ""f()"")
+  expect_equal(get_tag(out, ""usage"")$values, rd(""f()""))
 })
 
 test_that(""default usage correct for infix functions"", {
   out <- roc_proc_text(roc, ""
     #' Infix fun
     '%.%' <- function(a, b) 1"")[[1]]
 
-  expect_equal(get_tag(out, ""usage"")$values, ""a \\%.\\% b"")  
+  expect_equal(get_tag(out, ""usage"")$values, rd(""a \\%.\\% b""))
 })
 
 test_that(""default usage correct for S3 methods"", {
@@ -44,9 +44,30 @@ test_that(""default usage correct for S3 methods"", {
     '[<-.foo' <- function(x, value) 'foo'
   "")
   
-  expect_equal(get_tag(out[[1]], ""usage"")$values, ""\\method{mean}{foo}(x)"")
-  expect_equal(get_tag(out[[2]], ""usage"")$values, ""\\method{+}{foo}(x, b)"")
-  expect_equal(get_tag(out[[3]], ""usage"")$values, ""\\method{[}{foo}(x) <- value"")
+  expect_equal(get_tag(out[[1]], ""usage"")$values, rd(""\\method{mean}{foo}(x)""))
+  expect_equal(get_tag(out[[2]], ""usage"")$values, rd(""\\method{+}{foo}(x, b)""))
+  expect_equal(get_tag(out[[3]], ""usage"")$values, rd(""\\method{[}{foo}(x) <- value""))
+})
+
+test_that(""usage escaping preserved when combined"", {
+  out <- roc_proc_text(roc, ""
+    #' Foo
+    foo <- function(x = '%') x
+    
+    #' @rdname foo
+    bar <- function(y = '%') y
+  "")[[1]]
+  
+  expect_is(get_tag(out, ""usage"")$values, ""rd"")
+})
+
+test_that(""default usage not double escaped"", {
+  out <- roc_proc_text(roc, ""
+    #' Regular
+    mean.foo <- function(x) 'foo'
+  "")[[1]]
+  
+  expect_equal(format(get_tag(out, ""usage"")), rd(""\\\method{mean}{foo}(x)""))
 })
 
 test_that(""default usage correct for S4 methods"", {
@@ -64,19 +85,19 @@ test_that(""default usage correct for S4 methods"", {
   "")
   
   expect_equal(get_tag(out[[1]], ""usage"")$values, 
-    ""\\S4method{sum}{foo}(x, ..., na.rm = FALSE)"")
+    rd(""\\S4method{sum}{foo}(x, ..., na.rm = FALSE)""))
   expect_equal(get_tag(out[[2]], ""usage"")$values, 
-    ""\\S4method{+}{foo,ANY}(e1, e2)"")
+    rd(""\\S4method{+}{foo,ANY}(e1, e2)""))
   expect_equal(get_tag(out[[3]], ""usage"")$values, 
-    ""\\S4method{[}{foo}(x, i, j, ...) <- value"")
+    rd(""\\S4method{[}{foo}(x, i, j, ...) <- value""))
 })
 
 
 test_that(""% and \\ are escaped in usage"", {
   out <- roc_proc_text(roc, ""
     #' Title.
     a <- function(a='%\\\\') {}"")[[1]]
-  expect_equal(get_tag(out, ""usage"")$values, 'a(a = ""%\\\\"")')
+  expect_equal(get_tag(out, ""usage"")$values, escape('a(a = ""%\\\\"")'))
   expect_match(format(get_tag(out, ""usage"")), 'a(a = ""\\%\\\\\\\\"")', fixed = TRUE)
 })
 
@@ -147,7 +168,7 @@ test_that(""quoted topics have usage statements"", {
     \""f\"" <- function(a = 1, b = 2, c = a + b) {}"")[[1]]
 
   expect_equal(get_tag(out, ""usage"")$values,
-    ""f(a = 1, b = 2, c = a + b)"")
+    rd(""f(a = 1, b = 2, c = a + b)""))
 
   expect_equal(format(get_tag(out, ""usage"")),
     ""\\usage{\nf(a = 1, b = 2, c = a + b)\n}\n""
@@ -161,5 +182,5 @@ test_that(""non-syntactic names are quoted"", {
     #' Title.
     'a b' <- function(x) x"")[[1]]
   
-  expect_equal(get_tag(out, ""usage"")$values, '""a b""(x)')
+  expect_equal(get_tag(out, ""usage"")$values, rd('""a b""(x)'))
 })"
r-lib,roxygen2,fa327661f0958b16700eaf973aa35e4c666339e5,hadley,h.wickham@gmail.com,2013-11-20T14:49:36Z,hadley,h.wickham@gmail.com,2013-11-20T14:49:36Z,"Use @method to override s3 method autodetection.
Fixes #147",R/object-from-call.R;R/parse.R;R/s3.R;inst/tests/test-s3.R,False,True,True,False,35,13,48,"---FILE: R/object-from-call.R---
@@ -1,4 +1,4 @@
-object_from_call <- function(call, env) {
+object_from_call <- function(call, env, block) {
   if (is.null(call)) return()
   
   call <- standardise_call(call, env)
@@ -9,7 +9,7 @@ object_from_call <- function(call, env) {
   parser <- find_parser(name)
   if (is.null(parser)) return(srcref)
   
-  parser(call, env)
+  parser(call, env, block)
 }
 
 find_parser <- function(name) {
@@ -30,7 +30,7 @@ standardise_call <- function(call, env = parent.frame()) {
   match.call(f, call)
 }
 
-parser_assignment <- function(call, env) {
+parser_assignment <- function(call, env, block) {
   assignee <- as.character(call[[2]])
   
   # If it's a compound assignment like x[[2]] <- ignore it
@@ -41,7 +41,8 @@ parser_assignment <- function(call, env) {
   value <- get(assignee, env)
   
   if (is.function(value)) {
-    value <- add_s3_metadata(value, assignee, env)
+    method <- unlist(block$method, use.names = FALSE)
+    value <- add_s3_metadata(value, assignee, env, method)
     if (is.s3generic(value)) {
       objtype <- ""s3generic""
     } else if (is.s3method(value)) {
@@ -59,23 +60,23 @@ parser_assignment <- function(call, env) {
 }
 
 #' @importFrom methods getClass
-parser_setClass <- function(call, env) {
+parser_setClass <- function(call, env, block) {
   name <- as.character(call$Class)
   value <- getClass(name)
 
   object(""s4class"", name, value)
 }
 
 #' @importFrom methods getGeneric
-parser_setGeneric <- function(call, env) {
+parser_setGeneric <- function(call, env, block) {
   name <- as.character(call$name)
   value <- getGeneric(name, where = env)
   
   object(""s4generic"", name, value)
 }
 
 #' @importFrom methods getMethod
-parser_setMethod <- function(call, env) {
+parser_setMethod <- function(call, env, block) {
   name <- as.character(call$f)
   value <- getMethod(name, eval(call$signature), where = env)
   

---FILE: R/parse.R---
@@ -30,7 +30,7 @@ parse_file <- function(file, env, env_hash = attr(env, ""hash"")) {
     preref <- parse.preref(as.character(comment_ref))
     if (is.null(preref)) return()
 
-    preref$object <- object_from_call(call, env)    
+    preref$object <- object_from_call(call, env, preref)
     preref$srcref <- list(filename = file, lloc = as.vector(ref))
 
     add_defaults(preref)

---FILE: R/s3.R---
@@ -67,9 +67,14 @@ find_generic <- function(name, env = parent.frame()) {
   NULL
 }
 
-add_s3_metadata <- function(val, name, env) {
+# @param override Either NULL to use default, or a character vector of length 2
+add_s3_metadata <- function(val, name, env, override = NULL) {
   if (!is.function(val)) return(val)
   
+  if (!is.null(override)) {
+    return(s3_method(val, override, env))
+  }
+  
   if (is_s3_generic(name, env)) {
     class(val) <- ""s3generic""
     return(val)
@@ -78,11 +83,17 @@ add_s3_metadata <- function(val, name, env) {
   method <- find_generic(name, env)
   if (is.null(method)) return(val)
   
-  class(val) <- ""s3method""
-  attr(val, ""s3method"") <- method
-  attr(val, ""s3env"") <- env
+  s3_method(val, method, env)
+}
+
+s3_method <- function(f, method, env) {
+  stopifnot(length(method) == 2, is.character(method))
+
+  class(f) <- ""s3method""
+  attr(f, ""s3method"") <- method
+  attr(f, ""s3env"") <- env
   
-  val
+  f
 }
 
 s3_method_info <- function(x) {

---FILE: inst/tests/test-s3.R---
@@ -45,3 +45,13 @@ test_that(""user defined functions override primitives"", {
   expect_false(is_s3_generic(""c""))
   expect_false(is_s3_method(""c""))
 })
+
+test_that(""@method overrides auto-detection"", {
+  out <- parse_text(""
+    #' @export
+    #' @method all.equal data.frame
+    all.equal.data.frame <- function(...) 1
+  "")[[1]]
+  
+  expect_equal(s3_method_info(out$object$value), c(""all.equal"", ""data.frame""))
+})"
r-lib,roxygen2,5ab5a933a162a144ea453f83a4389738abb83efd,hadley,h.wickham@gmail.com,2013-11-20T14:13:18Z,hadley,h.wickham@gmail.com,2013-11-20T14:13:18Z,"Use block name if exporting NULL object.
Fixes #148",NAMESPACE;R/roclet-namespace.R;inst/tests/test-namespace.R,False,True,True,False,22,20,42,"---FILE: NAMESPACE---
@@ -1,10 +1,8 @@
-S3method(default_export,""function"")
-S3method(default_export,data)
+S3method(default_export,""NULL"")
+S3method(default_export,default)
 S3method(default_export,rcclass)
-S3method(default_export,s3generic)
 S3method(default_export,s3method)
 S3method(default_export,s4class)
-S3method(default_export,s4generic)
 S3method(default_export,s4method)
 S3method(default_topic_name,default)
 S3method(default_topic_name,rcclass)

---FILE: R/roclet-namespace.R---
@@ -130,27 +130,23 @@ ns_export <- function(tag, part) {
   if (!is.null.string(tag)) return(export(tag))
   # FIXME: check for empty exports (i.e. no name)
   
-  default_export(part$object)
+  default_export(part$object, part)
 }
-default_export <- function(x) UseMethod(""default_export"")
+default_export <- function(x, block) UseMethod(""default_export"")
 #' @export
-default_export.s4class   <- function(x) export_class(x$name)
+default_export.s4class   <- function(x, block) export_class(x$name)
 #' @export
-default_export.s4generic <- function(x) export(x$name)
+default_export.s4method  <- function(x, block) export_s4_method(x$name)
 #' @export
-default_export.s4method  <- function(x) export_s4_method(x$name)
+default_export.s3method  <- function(x, block) export_s3_method(attr(x$value, ""s3method""))
 #' @export
-default_export.s3generic <- function(x) export(x$name)
-#' @export
-default_export.s3method  <- function(x) export_s3_method(attr(x$value, ""s3method""))
-#' @export
-default_export.function  <- function(x) export(x$name)
-#' @export
-default_export.data      <- function(x) export(x$name)
-#' @export
-default_export.rcclass   <- function(x) {
+default_export.rcclass   <- function(x, block) {
   c(export(x$name), export_class(x$name))
 }
+#' @export
+default_export.default   <- function(x, block) export(x$name)
+#' @export
+default_export.NULL      <- function(x, block) export(block$name)
 
 ns_S3method          <- function(tag, part) export_s3_method(tag)
 ns_exportClass       <- function(tag, part) export_class(tag)

---FILE: inst/tests/test-namespace.R---
@@ -59,8 +59,6 @@ test_that(""export detects method name"", {
   expect_equal(out, 'exportMethods(max)')
 })
 
-
-
 test_that(""export method escapes if needed"", {
   out <- roc_proc_text(roc, ""
     setGeneric('x<-', function(x, value) standardGeneric('x<-'))
@@ -69,6 +67,16 @@ test_that(""export method escapes if needed"", {
   expect_equal(out, 'exportMethods(""x<-"")')
 })
 
+test_that(""export uses name if no object present"", {
+  out <- roc_proc_text(roc, ""
+    #' Title
+    #' 
+    #' @export
+    #' @name x
+    NULL
+  "")
+  expect_equal(out, 'export(x)')
+})
 
 test_that(""exportMethod overrides default method name"", {
   out <- roc_proc_text(roc, """
r-lib,roxygen2,0ac5fd00f61f697bb75038d70e2b03002396f690,hadley,h.wickham@gmail.com,2013-11-19T19:06:06Z,hadley,h.wickham@gmail.com,2013-11-19T19:06:06Z,"Switch escaping methods.
Not sure what's overriding fixed :/",inst/tests/test-usage.R,False,True,True,False,1,1,2,"---FILE: inst/tests/test-usage.R---
@@ -120,7 +120,7 @@ test_that(""\\method not split inappropriately"", {
       function(reallyquitelongargument = 'reallyratherquitelongvalue') 1
   "")[[1]]
   usage <- format(get_tag(out, ""usage""))
-  expect_match(usage, fixed(""{mean}{reallyratherquitelongclassname}""))
+  expect_match(usage, ""\\{mean\\}\\{reallyratherquitelongclassname\\}"")
 })
 
 test_that(""@usage overrides default"", {"
r-lib,roxygen2,35e2a5163a8e7e0f7cdb88856b040674f6ce4ee7,hadley,h.wickham@gmail.com,2013-11-19T12:56:28Z,hadley,h.wickham@gmail.com,2013-11-19T12:56:28Z,"Fix format bug and add tests.
Fixes #146",R/object-defaults.R;inst/tests/test-format.R,False,True,True,False,22,1,23,"---FILE: R/object-defaults.R---
@@ -20,7 +20,7 @@ object_defaults.default <- function(x) list()
 object_defaults.data <- function(x) {
   list(
     docType = ""data"",
-    format = capture.output(str(x$value)),
+    format = paste0(capture.output(str(x$value)), collapse = ""\n""),
     keywords = ""datasets""
   )
 }

---FILE: inst/tests/test-format.R---
@@ -0,0 +1,21 @@
+context(""Format"")
+roc <- rd_roclet()
+  
+test_that(""format defaults to output from str"", {
+  out <- roc_proc_text(roc, ""
+    #' Title
+    x <- list(a = 1, b = 2)"")[[1]]
+  
+  expect_equal(get_tag(out, ""format"")$values, 
+    ""List of 2\n $ a: num 1\n $ b: num 2""
+  )
+})
+
+test_that(""@format overrides defaults"", {
+  out <- roc_proc_text(roc, ""
+    #' Title
+    #' @format abc
+    x <- list(a = 1, b = 2)"")[[1]]
+  
+  expect_equal(get_tag(out, ""format"")$values, ""abc"")
+})
\ No newline at end of file"
r-lib,roxygen2,1860df350ae76a01f9379e1dc9b2e9f9c3c6abc5,hadley,h.wickham@gmail.com,2013-11-15T14:03:07Z,hadley,h.wickham@gmail.com,2013-11-15T17:14:38Z,Update docs. Fix thinko,R/roclet.R;man/roc_proc_text.Rd,False,True,True,False,6,1,7,"---FILE: R/roclet.R---
@@ -13,13 +13,15 @@ is.roclet <- function(x) inherits(x, ""roclet"")
 #'
 #' @param roclet to use for processing
 #' @param input source string
+#' @param options a list of options to control roxygen behaviour.
+#'   Currently only \code{wrap} is recognised.
 #' @export
 #' @keywords internal
 roc_proc_text <- function(roclet, input, options = list()) {
   stopifnot(is.roclet(roclet))
   
   parsed <- parse_text(input)
-  roc_process(roclet, parsed, base_path = ""."", options = list())
+  roc_process(roclet, parsed, base_path = ""."", options = options)
 } 
 
 # Internal methods for processing and output

---FILE: man/roc_proc_text.Rd---
@@ -9,6 +9,9 @@ roc_proc_text(roclet, input, options = list())
   \item{roclet}{to use for processing}
 
   \item{input}{source string}
+
+  \item{options}{a list of options to control roxygen
+  behaviour.  Currently only \code{wrap} is recognised.}
 }
 \description{
 Process roclet on string and capture results."
r-lib,roxygen2,f1656527f3c91831f2605d536711a6fa2651d1c8,hadley,h.wickham@gmail.com,2013-11-14T23:28:14Z,hadley,h.wickham@gmail.com,2013-11-14T23:28:14Z,"Better parsing for multi-line word tags.
Fixes #140",R/parse-preref.R;inst/tests/test-namespace.R,False,True,True,False,13,1,14,"---FILE: R/parse-preref.R---
@@ -81,7 +81,7 @@ parse.value <- function(key, rest, srcref) {
 #' @export
 #' @rdname parsers
 parse.words <- function(key, rest, srcref) {
-  str_trim(str_split(rest, fixed("" ""))[[1]])
+  str_split(str_trim(rest), ""\\s+"")[[1]]
 }
 
 #' @details \code{parse.description}: parse mandatory name and description

---FILE: inst/tests/test-namespace.R---
@@ -90,6 +90,18 @@ test_that(""other namespace tags produce correct output"", {
   )))
 })
 
+test_that(""multiline importFrom parsed correctly"", {
+  out <- roc_proc_text(roc, ""
+    #' @importFrom test test1
+    #'   test2
+    NULL
+  "")
+  expect_equal(sort(out), sort(c(
+    ""importFrom(test,test1)"",
+    ""importFrom(test,test2)""
+  )))
+})
+
 test_that(""useDynLib imports only selected functions"", {
   out <- roc_proc_text(roc, ""
     #' @useDynLib test"
r-lib,roxygen2,b319cc2604d98610e641766c25059f12116f1057,hadley,h.wickham@gmail.com,2013-11-14T20:56:48Z,hadley,h.wickham@gmail.com,2013-11-14T20:56:48Z,Fix dumb typo,R/usage.R,False,True,True,False,1,1,2,"---FILE: R/usage.R---
@@ -29,7 +29,7 @@ default_usage.function <- function(x) {
 }
 
 #' @export
-default_usage.s3generic <- function(x) default_usage.function
+default_usage.s3generic <- default_usage.function
 
 #' @export
 default_usage.s3method <- function(x) {"
r-lib,roxygen2,2dc0c5da92574a3f1df06b5c0ec1fa487be0dd0d,Kirill M칲ller,kirill.mueller@ivt.baug.ethz.ch,2013-11-13T09:09:25Z,Kirill M칲ller,kirill.mueller@ivt.baug.ethz.ch,2013-11-13T09:09:25Z,warning are errors,.travis.yml,False,False,False,False,5,0,5,"---FILE: .travis.yml---
@@ -6,6 +6,11 @@ language: c
 # To build on OSX, switch the previous line to
 # language: objective-c
 script: ./travis-tool.sh run_tests
+
+env:
+  - global:
+    - WARNINGS_ARE_ERRORS=1
+
 before_install:
   - curl -OL http://raw.github.com/craigcitro/r-travis/master/scripts/travis-tool.sh
   - chmod 755 ./travis-tool.sh"
r-lib,roxygen2,8c9ae3ef9e85f270b75542e280d6f8f7ad4ef9a5,hadley,h.wickham@gmail.com,2013-11-12T14:11:54Z,hadley,h.wickham@gmail.com,2013-11-12T14:11:54Z,"Manually incorporate namespace quoting fix.
Closes #111",NEWS;R/roclet-namespace.R;inst/tests/test-namespace.R,False,True,True,False,18,3,21,"---FILE: NEWS---
@@ -1,6 +1,9 @@
 roxygen2 3.0.0
 --------------
 
+* Infix functions now escaped correctly in NAMESPACE. (Thanks to Peter 
+  Meilstrup, #111)
+
 * `roxygenise()` now works more like `devtools::document()`, only ever working
   in the current directory. The arguments `roxygen.dir`, `overwrite`, 
   `copy.package` and `unlink.target` have been deprecated due to potential

---FILE: R/roclet-namespace.R---
@@ -202,8 +202,8 @@ fun_args <- function(name, x) {
 
 quote_if_needed <- function(x) {
   needs_quotes <- !has.quotes(x) & !is.syntactic(x)
-  x[needs_quotes] <- str_c('""', x[needs_quotes], '""')
+  x[needs_quotes] <- str_c('""', str_replace_all(x[needs_quotes], '([""\\])', ""\\\\\\1""), '""')
   x
 }
 is.syntactic <- function(x) make.names(x) == x
-has.quotes <- function(x) str_detect(x, ""'|\"""")
+has.quotes <- function(x) str_detect(x, ""^('|\"").*\\1$"")

---FILE: inst/tests/test-namespace.R---
@@ -6,12 +6,24 @@ test_that(""export detects object name"", {
   expect_equal(out, 'export(a)')
 })
 
-
 test_that(""export escapes quotes name if needed"", {
   out <- roc_proc_text(roc, ""#' @export\n'a<-' <- function(){}"")
   expect_equal(out, 'export(""a<-"")')
 })
 
+test_that(""export escapes tricky names"", {
+  out <- roc_proc_text(roc, ""#' @export\n`%||%` <- function(){}"")
+  expect_equal(out, 'export(""%||%"")')
+  out <- roc_proc_text(roc, ""#' @export\n`%'%` <- function(){}"")
+  expect_equal(out, 'export(""%\'%"")')
+  out <- roc_proc_text(roc, ""#' @export\n`%\""%` <- function(){}"")
+  expect_equal(out, 'export(""%\\""%"")')
+  out <- roc_proc_text(roc, ""#' @export\n`%\""%` <- function(){}"")
+  expect_equal(out, 'export(""%\\""%"")')
+  out <- roc_proc_text(roc, ""#' @export\n`%\\\\%` <- function(){}"")
+  expect_equal(out, 'export(""%\\\\%"")')
+})
+
 test_that(""export parameter overrides default"", {
   out <- roc_proc_text(roc, ""#' @export b\na <- function(){}"")
   expect_equal(out, 'export(b)')"
r-lib,roxygen2,af00f29f10a0c8af6dd24406b193e14344a08683,hadley,h.wickham@gmail.com,2013-11-11T10:16:51Z,hadley,h.wickham@gmail.com,2013-11-11T10:17:42Z,Fixes for data doctype,DESCRIPTION;NAMESPACE;R/doctype.R;R/roclet-rd.R,False,True,True,False,13,2,15,"---FILE: DESCRIPTION---
@@ -23,6 +23,7 @@ Suggests:
 Collate:
     'cache.R'
     'description.R'
+    'doctype.R'
     'object.R'
     'parse-preref.R'
     'parse-registry.R'

---FILE: NAMESPACE---
@@ -1,3 +1,5 @@
+S3method(default_doctype,data)
+S3method(default_doctype,default)
 S3method(default_export,""function"")
 S3method(default_export,data)
 S3method(default_export,rcclass)

---FILE: R/doctype.R---
@@ -0,0 +1,7 @@
+default_doctype <- function(x) UseMethod(""default_doctype"")
+
+#' @export
+default_doctype.data <- function(x) ""data""
+
+#' @export
+default_doctype.default <- function(x) NULL

---FILE: R/roclet-rd.R---
@@ -460,7 +460,7 @@ process.section <- function(key, value) {
 }
 
 process.docType <- function(partitum) {
-  doctype <- partitum$docType
+  doctype <- partitum$docType %||% default_doctype(partitum$object)
 
   if (is.null(doctype)) return()
   tags <- list(new_tag(""docType"", doctype))
@@ -472,7 +472,8 @@ process.docType <- function(partitum) {
     }
   } else if (doctype == ""data"") {
     if (is.null(partitum$format)) {
-      tags <- c(tags, new_tag(""format"", partitum$str))
+      str <- capture.output(str(partitum$object$value))
+      tags <- c(tags, new_tag(""format"", str))
     }
     tags <- c(tags, new_tag(""keyword"", ""datasets""))
   }"
r-lib,roxygen2,db8c154cfe737c838f0b9291a81de97b5828726e,hadley,h.wickham@gmail.com,2013-11-11T10:11:33Z,hadley,h.wickham@gmail.com,2013-11-11T10:11:33Z,Fix documentation for update_collate,R/roclet-collate.R;R/roxygen.R;R/roxygenize.R;man/collate_roclet.Rd;man/namespace_roclet.Rd;man/rd_roclet.Rd;man/roxygen.Rd;man/roxygenize.Rd;man/update_collate.Rd,False,True,True,False,37,72,109,"---FILE: R/roclet-collate.R---
@@ -3,15 +3,21 @@ NULL
 
 register.preref.parsers(parse.value, 'include')
 
-#' Roclet: make Collate field in DESCRIPTION.
+#' Update Collate field in DESCRIPTION.
 #'
-#' Topologically sort R files and record in Collate field.
+#' Topologically sort R files and record in Collate field. The topological 
+#' sort is based on the \code{@@include} tag, which should specify the filenames 
+#' (space separated) that should be loaded before the current file - these are
+#' typically necessary if you're using S4 or RC classes (because super classes
+#' must be defined before subclasses).  If there are no \code{@@include} tags
+#' Collate will be left blank, indicating that the order of loading does not
+#' matter.
 #'
-#' Each \code{@@include} tag should specify the filename of one intrapackage
-#' dependency; multiple \code{@@include} tags may be given.
+#' This is not a roclet because roclets need the values of objects in a package,
+#' and those values can not be generated unless you've sourced the files,
+#' and you can't source the files unless you know the correct order.
 #'
-#' @family roclets
-#' @return Rd roclet
+#' @param base_path Path to package directory
 #' @examples
 #' #' `example-a.R', `example-b.R' and `example-c.R' reside
 #' #' in the `example' directory, with dependencies
@@ -20,13 +26,10 @@ register.preref.parsers(parse.value, 'include')
 #' #' @@include example-c.R
 #' NULL
 #'
-#' roclet <- collate_roclet()
 #' \dontrun{
-#'   roc_proc(roclet, dir('example'))
-#'   roc_out(roclet, dir('example'), ""example"")
+#'   update_collate(""my_package"")
 #' }
 #' @export
-
 update_collate <- function(base_path) {
   collate <- generate_collate(file.path(base_path, ""R""))
   if (!is.null(collate)) {

---FILE: R/roxygen.R---
@@ -27,7 +27,6 @@
 #' @keywords package
 #' @examples
 #' \dontrun{roxygenize('pkg')}
-#' @seealso See \code{\link{namespace_roclet}}, 
-#' \code{\link{collate_roclet}}, 
+#' @seealso See \code{\link{namespace_roclet}}, \code{\link{rd_roclet}}, 
 #' for an overview of roxygen tags.
 NULL

---FILE: R/roxygenize.R---
@@ -3,8 +3,8 @@
 #' This is the workhorse function that uses roclets, the built-in document
 #' tranformation functions, to build all documentation for a package.  See
 #' the documentation for the individual roclets, \code{\link{rd_roclet}},
-#' \code{\link{namespace_roclet}} and \code{\link{collate_roclet}}, for
-#' documentation on how to use each one.
+#' \code{\link{namespace_roclet}}, and for \code{\link{update_collate}},
+#' for more details.
 #'
 #' @param package.dir the package's top directory
 #' @param roxygen.dir,copy.package,overwrite,unlink.target deprecated

---FILE: man/collate_roclet.Rd---
@@ -1,36 +0,0 @@
-\name{collate_roclet}
-\alias{collate_roclet}
-\title{Roclet: make Collate field in DESCRIPTION.}
-\usage{
-collate_roclet()
-}
-\value{
-  Rd roclet
-}
-\description{
-  Topologically sort R files and record in Collate field.
-}
-\details{
-  Each \code{@include} tag should specify the filename of
-  one intrapackage dependency; multiple \code{@include}
-  tags may be given.
-}
-\examples{
-#' `example-a.R', `example-b.R' and `example-c.R' reside
-#' in the `example' directory, with dependencies
-#' a -> {b, c}. This is `example-a.R'.
-#' @include example-b.R
-#' @include example-c.R
-NULL
-
-roclet <- collate_roclet()
-\dontrun{
-  roc_proc(roclet, dir('example'))
-  roc_out(roclet, dir('example'), ""example"")
-}
-}
-\seealso{
-  Other roclets: \code{\link{namespace_roclet}},
-  \code{\link{rd_roclet}}
-}
-

---FILE: man/namespace_roclet.Rd---
@@ -102,7 +102,6 @@ roclet <- namespace_roclet()
 \dontrun{roc_out(roclet, ""example.R"", ""."")}
 }
 \seealso{
-  Other roclets: \code{\link{rd_roclet}},
-  \code{\link{update_collate}}
+  Other roclets: \code{\link{rd_roclet}}
 }
 

---FILE: man/rd_roclet.Rd---
@@ -188,7 +188,6 @@ roclet <- rd_roclet()
 \dontrun{roc_out(roclet, ""example.R"", ""."")}
 }
 \seealso{
-  Other roclets: \code{\link{namespace_roclet}},
-  \code{\link{update_collate}}
+  Other roclets: \code{\link{namespace_roclet}}
 }
 

---FILE: man/roxygen.Rd---
@@ -31,8 +31,7 @@
 }
 \seealso{
   See \code{\link{namespace_roclet}},
-  \code{\link{collate_roclet}}, for an overview of roxygen
-  tags.
+  \code{\link{rd_roclet}}, for an overview of roxygen tags.
 }
 \keyword{package}
 

---FILE: man/roxygenize.Rd---
@@ -29,8 +29,7 @@ roxygenise(package.dir = ""."", roxygen.dir = package.dir,
   built-in document tranformation functions, to build all
   documentation for a package.  See the documentation for
   the individual roclets, \code{\link{rd_roclet}},
-  \code{\link{namespace_roclet}} and
-  \code{\link{collate_roclet}}, for documentation on how to
-  use each one.
+  \code{\link{namespace_roclet}}, and for
+  \code{\link{update_collate}}, for more details.
 }
 

---FILE: man/update_collate.Rd---
@@ -1,19 +1,28 @@
 \name{update_collate}
 \alias{update_collate}
-\title{Roclet: make Collate field in DESCRIPTION.}
+\title{Update Collate field in DESCRIPTION.}
 \usage{
 update_collate(base_path)
 }
-\value{
-  Rd roclet
+\arguments{
+  \item{base_path}{Path to package directory}
 }
 \description{
   Topologically sort R files and record in Collate field.
+  The topological sort is based on the \code{@include} tag,
+  which should specify the filenames (space separated) that
+  should be loaded before the current file - these are
+  typically necessary if you're using S4 or RC classes
+  (because super classes must be defined before
+  subclasses).  If there are no \code{@include} tags
+  Collate will be left blank, indicating that the order of
+  loading does not matter.
 }
 \details{
-  Each \code{@include} tag should specify the filename of
-  one intrapackage dependency; multiple \code{@include}
-  tags may be given.
+  This is not a roclet because roclets need the values of
+  objects in a package, and those values can not be
+  generated unless you've sourced the files, and you can't
+  source the files unless you know the correct order.
 }
 \examples{
 #' `example-a.R', `example-b.R' and `example-c.R' reside
@@ -23,14 +32,8 @@ update_collate(base_path)
 #' @include example-c.R
 NULL
 
-roclet <- collate_roclet()
 \dontrun{
-  roc_proc(roclet, dir('example'))
-  roc_out(roclet, dir('example'), ""example"")
+  update_collate(""my_package"")
 }
 }
-\seealso{
-  Other roclets: \code{\link{namespace_roclet}},
-  \code{\link{rd_roclet}}
-}
 "
r-lib,roxygen2,969358730eba7f7a12d901d19aa030ef94105dc0,hadley,h.wickham@gmail.com,2013-11-08T21:29:05Z,hadley,h.wickham@gmail.com,2013-11-08T21:29:05Z,Fix test on case insensitive filesystems,inst/tests/test-template.R,False,True,True,False,3,1,4,"---FILE: inst/tests/test-template.R---
@@ -13,5 +13,7 @@ test_that(""template_find finds files with .r and .R extension, and fails to find
   expect_equal(template_find(my.tempdir, ""reg.ex""), my.regex)
   expect_error(template_find(my.tempdir, ""reggex""))
   expect_error(template_find(my.tempdir, ""nada""))
-  expect_equal(template_find(my.tempdir, ""lcase""), my.lcase)
+  
+  # On case-insentive file systems, will find upper case version first
+  expect_equal(tolower(template_find(my.tempdir, ""lcase"")), tolower(my.lcase))
 })"
r-lib,roxygen2,a81ebf6aa0ff45d0315329c1640583c85c22ed97,hadley,h.wickham@gmail.com,2013-11-08T21:26:20Z,hadley,h.wickham@gmail.com,2013-11-08T21:26:20Z,Fix escaping fix I accidentally killed,R/usage.R;inst/tests/test-rd-usage.R,False,True,True,False,13,0,13,"---FILE: R/usage.R---
@@ -81,6 +81,7 @@ usage_args <- function(args) {
   arg_to_text <- function(arg) {
     if (is.missing.arg(arg)) return("""")
     text <- deparse(arg, backtick = TRUE, width.cutoff = 500L)
+    text <- str_replace_all(text, fixed(""\\""), ""\\\\"")
     text <- str_replace_all(text, fixed(""%""), ""\\%"")
     text <- str_replace_all(text, fixed("" ""), ""\u{A0}"")
     Encoding(text) <- ""UTF-8""

---FILE: inst/tests/test-rd-usage.R---
@@ -79,6 +79,18 @@ test_that(""% and \\ are escaped in usage"", {
   expect_equal(get_tag(out, ""usage"")$values, 'a(a\u{A0}=\u{A0}""\\%\\\\\\\\"")')
 })
 
+test_that(""\ is escaped in usage"", {
+  input <- ""
+    #' Title.
+    f <- function(a='\\\\') {}
+  ""
+  # cat(input)
+  out <- roc_proc_text(roc, input)[[1]]
+  
+  expected <- ""f(a\u{A0}=\u{A0}\""\\\\\\\\\"")""
+  expect_equal(get_tag(out, ""usage"")$values, expected)
+})
+
 test_that(""long usages protected from incorrect breakage"", {
   out <- roc_proc_text(roc, ""
       #' Function long usage"
r-lib,roxygen2,09119a5d863c8e0a92356ce8888afead477af902,Kirill M칲ller,kirill.mueller@ivt.baug.ethz.ch,2013-07-10T00:59:37Z,Kirill M칲ller,kirill.mueller@ivt.baug.ethz.ch,2013-10-28T16:09:35Z,"Sort tags in .Rd files in ""C"" locale. Fixes #127.",NEWS;R/rd-tag-api.R;R/util-locale.R,False,True,True,False,5,6,11,"---FILE: NEWS---
@@ -7,8 +7,8 @@
 
 * Now imports `digest` package instead of depending on it.
 
-* Always use C locale when sorting `NAMESPACE` file. This ensures a consistent
-  ordering across systems.
+* Always use C locale when sorting `NAMESPACE` file or tags in `.Rd` files.
+  This ensures a consistent ordering across systems.  (Fixes #127)
 
 roxygen2 2.2.2
 --------------

---FILE: R/rd-tag-api.R---
@@ -46,7 +46,7 @@ merge.rd_tag <- function(x, y, ...) {
 #' @S3method format keyword_tag
 #' @S3method format alias_tag
 format_rd <- function(x, ...) {
-  vapply(sort(unique(x$values)), rd_tag, tag = x$tag,
+  vapply(with_locale(""C"", sort(unique(x$values))), rd_tag, tag = x$tag,
     FUN.VALUE = character(1), USE.NAMES = FALSE)
 }
 format.keyword_tag <- format_rd

---FILE: R/util-locale.R---
@@ -1,7 +1,6 @@
 with_locale <- function(locale, code) {
   cur <- Sys.getlocale(category = ""LC_COLLATE"")
   Sys.setlocale(category = ""LC_COLLATE"", locale = locale)
-  res <- force(code)
-  Sys.setlocale(category = ""LC_COLLATE"", locale = cur)
-  res
+  on.exit(Sys.setlocale(category = ""LC_COLLATE"", locale = cur))
+  force(code)
 }"
r-lib,roxygen2,c2c17e4502da4dc970f1b31b481efaa26358389c,hadley,h.wickham@gmail.com,2013-03-26T16:57:33Z,hadley,h.wickham@gmail.com,2013-03-26T16:57:33Z,Fix failing test,R/roclet-rd.R,False,True,True,False,4,4,8,"---FILE: R/roclet-rd.R---
@@ -412,14 +412,14 @@ roc_output.had <- function(roclet, results, base_path) {
 
 # Prefer explicit \code{@@usage} to a \code{@@formals} list.
 process.usage <- function(partitum) {
-  if (is.null(partitum$fun) || !partitum$fun) {
-    return(new_tag(""usage"", NULL))
-  }
-
   if (!is.null(partitum$usage)) {
     return(new_tag(""usage"", partitum$usage))
   }
 
+  if (is.null(partitum$fun) || !partitum$fun) {
+    return(new_tag(""usage"", NULL))
+  }
+
   fun_name <- if (!is.null(partitum$method)) {
     rd_tag('method', partitum$method[[1]], partitum$method[[2]])
   } else {"
r-lib,roxygen2,179448a8e1230589cf2919157a2675ff3ab543ed,hadley,h.wickham@gmail.com,2012-01-21T17:58:39Z,hadley,h.wickham@gmail.com,2012-01-21T17:58:39Z,Don't create inst directory. Fixes #53,NEWS;R/roxygenize.R,False,True,True,False,3,1,4,"---FILE: NEWS---
@@ -1,3 +1,5 @@
+* `inst` directory not automatically created.  (Fixes #53)
+
 * Explicitly depends on `utils` and `methods` packages to make roxygen more
   compatible with `Rscript`.  Fixes #72
 

---FILE: R/roxygenize.R---
@@ -24,7 +24,7 @@ roxygenize <- function(package.dir,
                        unlink.target=FALSE,
                        roclets=c(""collate"", ""namespace"", ""rd"")) {
 
-  skeleton <- c(roxygen.dir, file.path(roxygen.dir, c(""man"", ""inst"")))
+  skeleton <- c(roxygen.dir, file.path(roxygen.dir, ""man""))
 
   if (copy.package) {
     copy.dir(package.dir, roxygen.dir, unlink.target = unlink.target,"
r-lib,roxygen2,c26882b7a1d158b1e5194bd53430f8b67cd2db37,hadley,h.wickham@gmail.com,2012-01-21T17:13:45Z,hadley,h.wickham@gmail.com,2012-01-21T17:13:45Z,Depend on utils and methods. Fixes #72,DESCRIPTION;NEWS,False,False,False,False,6,1,7,"---FILE: DESCRIPTION---
@@ -9,7 +9,9 @@ Author: Hadley Wickham <hadley@rice.edu>,
     Manuel Eugster <Manuel.Eugster@stat.uni-muenchen.de>
 Maintainer: Hadley Wickham <hadley@rice.edu>
 Depends:
-    R (>= 2.14)
+    R (>= 2.14),
+    stats,
+    methods
 Imports:
     stringr (>= 0.5),
     tools,

---FILE: NEWS---
@@ -1,3 +1,6 @@
+* Explicitly depends on `utils` and `methods` packages to make roxygen more
+  compatible with `Rscript`.  Fixes #72
+
 * Now imports `digest` package instead of depending on it.
 
 * Always use C locale when sorting `NAMESPACE` file. This ensures a consistent"
r-lib,roxygen2,d6eeffe262dbc1a90a8ed3b1a94212fb1880917c,hadley,h.wickham@gmail.com,2012-01-21T17:10:55Z,hadley,h.wickham@gmail.com,2012-01-21T17:10:55Z,Flag requirement for 2.14.  Fixes #71,DESCRIPTION,False,False,False,False,2,0,2,"---FILE: DESCRIPTION---
@@ -8,6 +8,8 @@ Author: Hadley Wickham <hadley@rice.edu>,
     Peter Danenberg <pcd@roxygen.org>,
     Manuel Eugster <Manuel.Eugster@stat.uni-muenchen.de>
 Maintainer: Hadley Wickham <hadley@rice.edu>
+Depends:
+    R (>= 2.14)
 Imports:
     stringr (>= 0.5),
     tools,"
r-lib,roxygen2,a962b69666fc5555cd40fbf3bea26f38d7d532bb,hadley,h.wickham@gmail.com,2012-01-21T17:05:50Z,hadley,h.wickham@gmail.com,2012-01-21T17:05:50Z,Better name for source environment. Fixes #73,R/parse.R,False,True,True,False,1,1,2,"---FILE: R/parse.R---
@@ -35,7 +35,7 @@ parse.files <- function(paths) {
   env <- new.env(parent = parent.env(globalenv()))
   env_hash <- suppressWarnings(digest(env))
   
-  setPackageName(""test"", env)
+  setPackageName(""roxygen-test"", env)
   lapply(paths, sys.source, chdir = TRUE, envir = env)
   
   unlist(lapply(paths, parse.file, env = env, env_hash = env_hash), "
r-lib,roxygen2,46b3cc46789f512c190857d799cb924e1f895f96,hadley,h.wickham@gmail.com,2012-01-21T17:03:49Z,hadley,h.wickham@gmail.com,2012-01-21T17:03:49Z,Sort NAMESPACE in C locale. Fixes #66,DESCRIPTION;NAMESPACE;NEWS;R/roclet-namespace.R;R/util-locale.R,False,True,True,False,40,29,69,"---FILE: DESCRIPTION---
@@ -4,8 +4,8 @@ License: GPL (>= 2)
 Description: A Doxygen-like in-source documentation system
     for Rd, collation, and NAMESPACE.
 Title: In-source documentation for R
-Author: Hadley Wickham <hadley@rice.edu>, 
-    Peter Danenberg <pcd@roxygen.org>, 
+Author: Hadley Wickham <hadley@rice.edu>,
+    Peter Danenberg <pcd@roxygen.org>,
     Manuel Eugster <Manuel.Eugster@stat.uni-muenchen.de>
 Maintainer: Hadley Wickham <hadley@rice.edu>
 Imports:
@@ -35,3 +35,4 @@ Collate:
     'utils.R'
     'template.R'
     'rd-parse.R'
+    'util-locale.R'

---FILE: NAMESPACE---
@@ -1,29 +1,3 @@
-export(clear_caches)
-export(collate_roclet)
-export(namespace_roclet)
-export(new_roclet)
-export(parse.default)
-export(parse.file)
-export(parse.files)
-export(parse.name.description)
-export(parse.name)
-export(parse.text)
-export(parse.toggle)
-export(parse.unknown)
-export(parse.value)
-export(rd_roclet)
-export(register.preref.parser)
-export(register.preref.parsers)
-export(register.srcref.parser)
-export(register.srcref.parsers)
-export(roc_out)
-export(roc_proc_text)
-export(roc_proc)
-export(roxygenise)
-export(roxygenize)
-import(stringr)
-importFrom(brew,brew)
-importFrom(tools,checkRd)
 S3method(format,alias_tag)
 S3method(format,arguments_tag)
 S3method(format,author_tag)
@@ -59,3 +33,29 @@ S3method(roc_output,namespace)
 S3method(roc_process,collate)
 S3method(roc_process,had)
 S3method(roc_process,namespace)
+export(clear_caches)
+export(collate_roclet)
+export(namespace_roclet)
+export(new_roclet)
+export(parse.default)
+export(parse.file)
+export(parse.files)
+export(parse.name)
+export(parse.name.description)
+export(parse.text)
+export(parse.toggle)
+export(parse.unknown)
+export(parse.value)
+export(rd_roclet)
+export(register.preref.parser)
+export(register.preref.parsers)
+export(register.srcref.parser)
+export(register.srcref.parsers)
+export(roc_out)
+export(roc_proc)
+export(roc_proc_text)
+export(roxygenise)
+export(roxygenize)
+import(stringr)
+importFrom(brew,brew)
+importFrom(tools,checkRd)

---FILE: NEWS---
@@ -1,3 +1,6 @@
+* Always use C locale when sorting `NAMESPACE` file. This ensures a consistent
+  ordering across systems.
+
 roxygen2 2.2.2
 --------------
 

---FILE: R/roclet-namespace.R---
@@ -111,7 +111,7 @@ roc_process.namespace <- function(roclet, partita, base_path) {
     )
     ns <- c(ns, ns_one)
   }
-  sort(unique(ns))
+  with_locale(""C"", sort(unique(ns)))
 }
 
 

---FILE: R/util-locale.R---
@@ -0,0 +1,7 @@
+with_locale <- function(locale, code) {
+  cur <- Sys.getlocale(category = ""LC_COLLATE"")
+  Sys.setlocale(category = ""LC_COLLATE"", locale = locale)
+  res <- force(code)
+  Sys.setlocale(category = ""LC_COLLATE"", locale = cur)
+  res
+}"
r-lib,roxygen2,ac767d5fb3496337652eec8cd7dcf60649bbdeee,hadley,h.wickham@gmail.com,2011-11-30T20:09:38Z,hadley,h.wickham@gmail.com,2011-11-30T20:09:38Z,Fix datasets keyword (Fixes #60),NEWS;R/roclet-rd.R;inst/tests/test-rd-doctype.R,False,True,True,False,4,2,6,"---FILE: NEWS---
@@ -1,3 +1,5 @@
+* Correctly use keyword `datasets` not `dataset` (Fixes #60)
+
 * Reference classes no longer given incorrect docType (data).
 
 roxygen2 2.2.1

---FILE: R/roclet-rd.R---
@@ -537,7 +537,7 @@ process.docType <- function(partitum) {
     if (is.null(partitum$usage)) {
       tags <- c(tags, new_tag(""usage"", partitum$assignee))
     }
-    tags <- c(tags, new_tag(""keyword"", ""dataset""))
+    tags <- c(tags, new_tag(""keyword"", ""datasets""))
   }
   
   tags

---FILE: inst/tests/test-rd-doctype.R---
@@ -31,7 +31,7 @@ test_that(""@docType data automatically adds sensible defaults"", {
     a <- data.frame(a = 1:10)"")[[1]]
   
   expect_equal(get_tag(out, ""usage"")$values, ""a"")
-  expect_equal(get_tag(out, ""keyword"")$values, ""dataset"")
+  expect_equal(get_tag(out, ""keyword"")$values, ""datasets"")
   expect_equal(is.null(get_tag(out, ""format"")$values), FALSE)
 })
 "
r-lib,roxygen2,e63ad7be49f19044bb02a5a16f2a0d1a873da199,hadley,h.wickham@gmail.com,2011-11-18T16:18:52Z,hadley,h.wickham@gmail.com,2011-11-18T16:18:52Z,Unicode fixes for non-UTF8 locales,DESCRIPTION;NEWS;R/rd-tag-api.R;R/utils.R;inst/tests/test-rd-usage.R,False,True,True,False,19,6,25,"---FILE: DESCRIPTION---
@@ -1,5 +1,5 @@
 Package: roxygen2
-Version: 2.2
+Version: 2.2.1
 License: GPL (>= 2)
 Description: A Doxygen-like in-source documentation system
     for Rd, collation, and NAMESPACE.

---FILE: NEWS---
@@ -1,3 +1,10 @@
+roxygen2 2.2.1
+--------------
+
+* Use unicode escapes in test files so tests pass on all platforms.
+
+* Work around bug in `gsub` in C locale by manually specifying `Encoding()`. 
+
 roxygen2 2.2
 ------------
 

---FILE: R/rd-tag-api.R---
@@ -28,7 +28,7 @@ rd_tag <- function(tag, ..., space = FALSE) {
     values <- str_trim(c(...))
   }
   # Turn non-breaking spaces back into regular spaces
-  values <- str_replace_all(values, fixed(""\uA0""), "" "")
+  values <- str_replace_all(values, fixed(""\u{A0}""), "" "")
   str_c(""\\"", tag, str_c(""{"", values, ""}"", collapse = """"), ""\n"")                         
 }
 

---FILE: R/utils.R---
@@ -16,9 +16,10 @@ usage <- function(args) {
     if (is.missing.arg(arg)) return("""")
     text <- deparse(arg, backtick = TRUE, width.cutoff = 500L)
     text <- str_replace_all(text, fixed(""%""), ""\\%"")
-    text <- str_replace_all(text, fixed("" ""), ""\uA0"")
+    text <- str_replace_all(text, fixed("" ""), ""\u{A0}"")
+    Encoding(text) <- ""UTF-8""    
     
-    paste(""\uA0=\uA0"", paste(text, collapse = ""\n""), sep = """")
+    str_c(""\u{A0}=\u{A0}"", paste(text, collapse = ""\n""))
   }
 
   arg_values <- vapply(args, arg_to_text, character(1))

---FILE: inst/tests/test-rd-usage.R---
@@ -53,8 +53,13 @@ test_that(""@usage overrides default"", {
 test_that(""quoted topics have usage statements"", {
   out <- roc_proc_text(roc, ""
     #' Title.
-    \""f\"" <- function(a = 1, b = 2) {}"")[[1]]
+    \""f\"" <- function(a = 1, b = 2, c = a + b) {}"")[[1]]
   
-  expect_equal(get_tag(out, ""usage"")$values, ""f(a=1, b=2)"")
+  expect_equal(get_tag(out, ""usage"")$values, 
+    ""f(a\u{A0}=\u{A0}1, b\u{A0}=\u{A0}2, c\u{A0}=\u{A0}a\u{A0}+\u{A0}b)"")
+  
+  expect_equal(format(get_tag(out, ""usage"")),
+    ""\\usage{\n  f(a = 1, b = 2, c = a + b)\n}\n""  
+  )
   
 })"
r-lib,roxygen2,4563f959fcee77e38aa51ae7b2a997ddb0e36e64,hadley,h.wickham@gmail.com,2011-11-10T16:37:14Z,hadley,h.wickham@gmail.com,2011-11-11T14:03:29Z,Fix bug when no-untagged docs,NEWS;R/roclet-rd.R;inst/tests/test-rd.R,False,True,True,False,20,2,22,"---FILE: NEWS---
@@ -66,6 +66,9 @@ BUG FIXES
   find the problem. Thanks to code contributions from Renaud Gaujoux. (Fixes
   #13)
 
+* Documentation with no untagged text but with `@title`, `@description` and
+  `@details` tags now produces correct output.
+
 roxygen2 2.1
 ------------
 

---FILE: R/roclet-rd.R---
@@ -438,8 +438,12 @@ process.usage <- function(partitum) {
 # by details (separated by a blank line).
 process_description <- function(partitum, base_path) {
   intro <- partitum$introduction
-  if (is.null(intro)) return()
-  paragraphs <- str_trim(strsplit(intro, '\n\n', fixed=TRUE)[[1]])
+  
+  if (!is.null(intro)) {
+    paragraphs <- str_trim(str_split(intro, fixed('\n\n'))[[1]])
+  } else {
+    paragraphs <- NULL
+  } 
 
   # 1st paragraph = title (unless has @title)
   if (!is.null(partitum$title)) {

---FILE: inst/tests/test-rd.R---
@@ -153,6 +153,17 @@ test_that(""@title overrides default title"", {
   expect_equal(get_tag(out, ""description"")$values, ""Would be title"")
 })
 
+test_that(""docs parsed correctly if no blank text"", {
+  out <- roc_proc_text(roc, ""
+    #' @title My title
+    #' @description My description
+    #' @param x value
+    a <- function(x) {}"")[[1]]
+  
+  expect_equal(get_tag(out, ""title"")$values, ""My title"")
+  expect_equal(get_tag(out, ""description"")$values, ""My description"")
+})
+
 test_that(""question mark ends sentence"", {
   out <- roc_proc_text(roc, ""
     #' Is a number odd?"
r-lib,roxygen2,82bb3d1097a7160fe6674f3333c9e9939fae0e48,Brian Danielak,briandk@umd.edu,2011-11-03T05:35:28Z,Brian Danielak,briandk@umd.edu,2011-11-03T20:46:40Z,"Call WrapFieldIfNecessary with wrap.threshold = width

Fixes a bug where the Collate: field wasn't wrapping properly.",R/description.R,False,True,True,False,2,2,4,"---FILE: R/description.R---
@@ -24,8 +24,8 @@ cat.description <- function(field, value, file='') {
     value_string <- paste(""    "", value, collapse = "",\n"", sep = """")
     out <- paste(field, "":\n"", value_string, sep = """")
   } else {
-    width <- if (individual_lines) 0 else 60
-    out <- WrapFieldIfNecessary(field, value, wrap.threshold = 80)    
+    width <- if (individual_lines) 0 else 80
+    out <- WrapFieldIfNecessary(field, value, wrap.threshold = width)    
   }
 
   cat(out, sep='\n', file=file, append=TRUE)"
r-lib,roxygen2,355dceed98662e096f631a50b9e80bd0398354e4,hadley,h.wickham@gmail.com,2011-10-26T22:28:08Z,hadley,h.wickham@gmail.com,2011-10-26T22:28:08Z,Features and bugs sections in news,NEWS,False,False,False,False,14,9,23,"---FILE: NEWS---
@@ -1,3 +1,17 @@
+NEW FEATURES
+
+* Package docType will automatically add package alias, if needed. (Fixes #4)
+
+* Data docType will automatically add `datasets` keyword, default usage, and
+  default format. (Fixes #5). Data docType automatically added to data
+  objects.
+
+* New `@encoding` tag for manually setting non-ASCII encodings when needed.
+  (Fixes #7)
+
+
+BUG FIXES
+
 * `@details` and `@description` now work correctly
 
 * `@useDynLib` now works correctly: 
@@ -48,15 +62,6 @@
   find the problem. Thanks to code contributions from Renaud Gaujoux. (Fixes
   #13)
 
-* Package docType will automatically add package alias, if needed. (Fixes #4)
-
-* Data docType will automatically add `datasets` keyword, default usage, and
-  default format. (Fixes #5). Data docType automatically added to data
-  objects.
-
-* New `@encoding` tag for manually setting non-ASCII encodings when needed.
-  (Fixes #7)
-
 roxygen2 2.1
 ------------
 "
r-lib,roxygen2,5b86c1786e4a188e69d519279cb20022b2daaf5e,hadley,h.wickham@gmail.com,2011-10-26T21:11:56Z,hadley,h.wickham@gmail.com,2011-10-26T21:11:56Z,Escape % in names (Fixes #50),NEWS;R/rd-tag-api.R;inst/tests/test-rd.R,False,True,True,False,13,2,15,"---FILE: NEWS---
@@ -22,7 +22,8 @@
   backslash in the Rd file. This behaviour was already in place for examples
   directly included with `@examples`.
 
-* Aliases are no longer quoted, and % is escaped with a backslash (Fixes #24)
+* Aliases are no longer quoted, and % is escaped with a backslash (Fixes #24).
+  Names also have % escaped (Fixes #50)
 
 * Replacement functions (e.g. `foo<-`) now get correct usage statements:
   `foo() <- value` instead of `foo()<-value`. (Fixes #38)

---FILE: R/rd-tag-api.R---
@@ -64,7 +64,10 @@ format_first <- function(x, ...) {
 #' @S3method format docType_tag
 #' @S3method format format_tag
 #' @S3method format encoding_tag
-format.name_tag <- format_first
+format.name_tag <- function(x, ...) {
+  x$values <- str_replace_all(x$values, fixed(""%""), ""\\%"")
+  format_first(x, ...)
+}
 format.title_tag <- format_first
 format.docType_tag <- format_first
 format.format_tag <- format_first

---FILE: inst/tests/test-rd.R---
@@ -23,6 +23,13 @@ test_that(""name also captured from assignment by ="", {
   expect_equal(get_tag(out, ""title"")$values, ""Title."")
 })
 
+test_that(""names escaped, not quoted"", {
+  out <- roc_proc_text(roc, ""
+    #' Title
+    '%a%' <- function(x, y) x + y"")[[1]]
+  expect_equal(format(get_tag(out, ""name"")), ""\\name{\\%a\\%}\n"")
+})
+
 test_that(""filename doesn't contain invalid characters"", {
   out <- roc_proc_text(roc, ""
     #' Title."
r-lib,roxygen2,d256c8891d9b155e130ac0091fa6c381e3dac836,hadley,h.wickham@gmail.com,2011-10-26T03:55:51Z,hadley,h.wickham@gmail.com,2011-10-26T03:55:51Z,Add pointer to Rd2roxygen (fixes #8),R/roxygen.R;man/roxygen.Rd,False,True,True,False,7,0,7,"---FILE: R/roxygen.R---
@@ -4,6 +4,9 @@
 #' in-source specification of Rd files, collation and namespace
 #' directives.
 #'
+#' If you have existing Rd files, check out the \code{Rd2roxygen} package
+#' for a convenient way of converting Rd files to roxygen comments.
+#'
 #' \tabular{ll}{
 #' Package: \tab Roxygen2\cr
 #' Type: \tab Package\cr

---FILE: man/roxygen.Rd---
@@ -11,6 +11,10 @@
   allowing in-source specification of Rd files, collation
   and namespace directives.
 
+  If you have existing Rd files, check out the
+  \code{Rd2roxygen} package for a convenient way of
+  converting Rd files to roxygen comments.
+
   \tabular{ll}{ Package: \tab Roxygen2\cr Type: \tab
   Package\cr Version: \tab 0.1-1\cr Date: \tab
   2008-08-25\cr License: \tab GPL (>= 2)\cr LazyLoad: \tab"
r-lib,roxygen2,96969f9fedf92b390fccd742e23316296b5137a8,hadley,h.wickham@gmail.com,2011-10-26T03:54:08Z,hadley,h.wickham@gmail.com,2011-10-26T03:54:08Z,Add encoding tag (Fixes #7),NAMESPACE;NEWS;R/rd-file-api.R;R/rd-tag-api.R;R/roclet-rd.R;inst/tests/test-rd.R,False,True,True,False,14,3,17,"---FILE: NAMESPACE---
@@ -31,6 +31,7 @@ S3method(format,concept_tag)
 S3method(format,description_tag)
 S3method(format,details_tag)
 S3method(format,docType_tag)
+S3method(format,encoding_tag)
 S3method(format,examples_tag)
 S3method(format,family_tag)
 S3method(format,format_tag)

---FILE: NEWS---
@@ -53,6 +53,9 @@
   default format. (Fixes #5). Data docType automatically added to data
   objects.
 
+* New `@encoding` tag for manually setting non-ASCII encodings when needed.
+  (Fixes #7)
+
 roxygen2 2.1
 ------------
 

---FILE: R/rd-file-api.R---
@@ -19,9 +19,10 @@ names.rd_file <- function(x) {
 #' @S3method format rd_file
 format.rd_file <- function(x, ...) {
   tags <- as.list(x[[1]])
-  order <- c(""docType"", ""name"", ""alias"", ""title"", ""format"", ""source"", ""usage"",
-    ""arguments"", ""value"", ""description"", ""details"", ""note"", ""section"",
-    ""examples"", ""author"", ""references"", ""seealso"", ""concept"", ""keyword"")
+  order <- c(""docType"", ""encoding"", ""name"", ""alias"", ""title"", ""format"",
+    ""source"", ""usage"", ""arguments"", ""value"", ""description"", ""details"", ""note"",
+    ""section"", ""examples"", ""author"", ""references"", ""seealso"", ""concept"",
+    ""keyword"")
     
   tags <- tags[intersect(order, names(tags))]
   

---FILE: R/rd-tag-api.R---
@@ -63,10 +63,12 @@ format_first <- function(x, ...) {
 #' @S3method format title_tag
 #' @S3method format docType_tag
 #' @S3method format format_tag
+#' @S3method format encoding_tag
 format.name_tag <- format_first
 format.title_tag <- format_first
 format.docType_tag <- format_first
 format.format_tag <- format_first
+format.encoding_tag <- format_first
 
 # Tags collapse their values into a single string ----------------------------
 

---FILE: R/roclet-rd.R---
@@ -22,6 +22,7 @@ register.preref.parsers(parse.value,
                         'inheritParams',
                         'format',
                         'source', 
+                        'encoding',
                         'description',
                         'details')
 
@@ -338,6 +339,7 @@ roclet_rd_one <- function(partitum, base_path) {
     "".Rd"")
     
   
+  add_tag(rd, new_tag(""encoding"", partitum$encoding))
   add_tag(rd, new_tag(""name"", name))
   add_tag(rd, new_tag(""alias"", name))
   add_tag(rd, new_tag(""formals"", names(partitum$formals)))

---FILE: inst/tests/test-rd.R---
@@ -212,12 +212,14 @@ test_that(""generic keys produce expected output"", {
     #' @author test
     #' @seealso test
     #' @concept test
+    #' @encoding test
     #' @name a
     NULL"")[[1]]
   expect_equal(get_tag(out, ""references"")$values, ""test"")
   expect_equal(get_tag(out, ""note"")$values, ""test"")
   expect_equal(get_tag(out, ""seealso"")$values, ""test"")
   expect_equal(get_tag(out, ""concept"")$values, ""test"")
+  expect_equal(get_tag(out, ""encoding"")$values, ""test"")
   expect_equal(get_tag(out, ""author"")$values, ""test"")
 })
 "
r-lib,roxygen2,d98e408974adc265cd1c4ee4fda587eeea4bfa7f,hadley,h.wickham@gmail.com,2011-10-26T03:47:11Z,hadley,h.wickham@gmail.com,2011-10-26T03:47:11Z,"Improvements to data docType features.
Automatically added to data objects, and sets up useful defaults.
Fixes #5",NEWS;R/roclet-rd.R;R/roxygen.R;inst/tests/test-rd-doctype.R;man/roxygen-package.Rd;man/roxygen.Rd,False,True,True,False,46,34,80,"---FILE: NEWS---
@@ -49,6 +49,10 @@
 
 * Package docType will automatically add package alias, if needed. (Fixes #4)
 
+* Data docType will automatically add `datasets` keyword, default usage, and
+  default format. (Fixes #5). Data docType automatically added to data
+  objects.
+
 roxygen2 2.1
 ------------
 

---FILE: R/roclet-rd.R---
@@ -48,6 +48,10 @@ register.srcref.parsers(function(call, env) {
   
   if (out$fun) {
     out$formals <- formals(value)
+  } else {
+    if (is.null(out$docType)) out$docType <- ""data""
+    out$str <- str_c(capture.output(str(value, max.level = 1)), 
+      collapse = ""\n"")
   }
   out
 }, '<-', '=')
@@ -314,7 +318,7 @@ roclet_rd_one <- function(partitum, base_path) {
   partitum <- process_templates(partitum, base_path)
   
   has_rd <- any(names(partitum) %in% c(""description"", ""param"", ""return"",
-    ""title"", ""example"", ""examples"", ""docType"", ""name"", ""rdname"", ""usage"",
+    ""title"", ""example"", ""examples"", ""name"", ""rdname"", ""usage"",
     ""details"", ""introduction""))
   if (!has_rd) return()
   
@@ -518,6 +522,14 @@ process.docType <- function(partitum) {
     if (!str_detect(name, ""-package"")) {
       tags <- c(tags, new_tag(""alias"", str_c(name, ""-package"")))
     }
+  } else if (doctype == ""data"") {
+    if (is.null(partitum$format)) {
+      tags <- c(tags, new_tag(""format"", partitum$str))
+    }
+    if (is.null(partitum$usage)) {
+      tags <- c(tags, new_tag(""usage"", partitum$assignee))
+    }
+    tags <- c(tags, new_tag(""keyword"", ""dataset""))
   }
   
   tags

---FILE: R/roxygen.R---
@@ -1,3 +1,5 @@
+#' In-line documentation for R.
+#' 
 #' Roxygen is a Doxygen-like documentation system for R; allowing
 #' in-source specification of Rd files, collation and namespace
 #' directives.

---FILE: inst/tests/test-rd-doctype.R---
@@ -19,3 +19,26 @@ test_that(""@docType package automatically adds package alias when needed"", {
   alias_2 <- get_tag(out[[2]], ""alias"")$values
   expect_equal(alias_2, c(""a-package""))
 })
+
+
+# Data --------------------------------------------------------------------
+
+test_that(""@docType data automatically adds sensible defaults"", {
+  out <- roc_proc_text(roc, ""
+    #' Title.
+    #'
+    #' @docType data
+    a <- data.frame(a = 1:10)"")[[1]]
+  
+  expect_equal(get_tag(out, ""usage"")$values, ""a"")
+  expect_equal(get_tag(out, ""keyword"")$values, ""dataset"")
+  expect_equal(is.null(get_tag(out, ""format"")$values), FALSE)
+})
+
+test_that(""@docType data automatically added to data objects"", {
+  out <- roc_proc_text(roc, ""
+    #' Title.
+    a <- data.frame(a = 1:10)"")[[1]]
+  
+  expect_equal(get_tag(out, ""docType"")$values, ""data"")  
+})
\ No newline at end of file

---FILE: man/roxygen-package.Rd---
@@ -1,31 +0,0 @@
-\docType{package}
-\name{roxygen-package}
-\alias{roxygen-package}
-\title{Literate Programming in R}
-\description{
-  Roxygen is a Doxygen-like documentation system for R;
-  allowing in-source specification of Rd files, collation
-  and namespace directives.
-}
-\details{
-  \tabular{ll}{ Package: \tab Roxygen2\cr Type: \tab
-  Package\cr Version: \tab 0.1-1\cr Date: \tab
-  2008-08-25\cr License: \tab GPL (>= 2)\cr LazyLoad: \tab
-  yes\cr }
-}
-\examples{
-\dontrun{roxygenize('pkg')}
-}
-\author{
-  Peter Danenberg \email{pcd@roxygen.org}, Manuel Eugster
-  \email{Manuel.Eugster@stat.uni-muenchen.de}
-
-  Maintainer: Peter Danenberg \email{pcd@roxygen.org}
-}
-\seealso{
-  See \code{\link{namespace_roclet}},
-  \code{\link{collate_roclet}}, for an overview of roxygen
-  tags.
-}
-\keyword{package}
-

---FILE: man/roxygen.Rd---
@@ -4,11 +4,13 @@
 \alias{roxygen-package}
 \title{Literate Programming in R}
 \description{
+  In-line documentation for R.
+}
+\details{
   Roxygen is a Doxygen-like documentation system for R;
   allowing in-source specification of Rd files, collation
   and namespace directives.
-}
-\details{
+
   \tabular{ll}{ Package: \tab Roxygen2\cr Type: \tab
   Package\cr Version: \tab 0.1-1\cr Date: \tab
   2008-08-25\cr License: \tab GPL (>= 2)\cr LazyLoad: \tab"
r-lib,roxygen2,de0e4fd69aaff73e3aeeb7d5c808586f8631e45e,hadley,h.wickham@gmail.com,2011-10-26T03:21:17Z,hadley,h.wickham@gmail.com,2011-10-26T03:21:17Z,Add package aliases. Fixes #4,NEWS;R/roclet-rd.R;R/roxygen.R;inst/tests/test-rd-doctype.R;man/rd_roclet.Rd;man/roxygen.Rd,False,True,True,False,78,4,82,"---FILE: NEWS---
@@ -47,6 +47,8 @@
   find the problem. Thanks to code contributions from Renaud Gaujoux. (Fixes
   #13)
 
+* Package docType will automatically add package alias, if needed. (Fixes #4)
+
 roxygen2 2.1
 ------------
 

---FILE: R/roclet-rd.R---
@@ -194,7 +194,8 @@ register.srcref.parser('setMethod', function(call, env) {
 #'    documenting datasets, and other non-function elements.}
 #'
 #'  \item{\code{@@docType type}}{Type of object being documented. Useful 
-#'    values are \code{data} and \code{package}. }
+#'    values are \code{data} and \code{package}. Package doc type will
+#'    automatically add a \code{package-} alias if needed.}
 #' 
 #'  \item{\code{@@format description}}{A textual description of the format
 #'    of the object.}
@@ -331,6 +332,7 @@ roclet_rd_one <- function(partitum, base_path) {
   # Work out file name and initialise Rd object
   filename <- str_c(partitum$merge %||% partitum$rdname %||% nice_name(name),
     "".Rd"")
+    
   
   add_tag(rd, new_tag(""name"", name))
   add_tag(rd, new_tag(""alias"", name))
@@ -343,7 +345,7 @@ roclet_rd_one <- function(partitum, base_path) {
   }))
   add_tag(rd, process.usage(partitum))
   add_tag(rd, process.arguments(partitum))
-  add_tag(rd, process_had_tag(partitum, 'docType'))
+  add_tag(rd, process.docType(partitum))
   add_tag(rd, process_had_tag(partitum, 'note'))
   add_tag(rd, process_had_tag(partitum, 'family'))
   add_tag(rd, process_had_tag(partitum, 'inheritParams'))
@@ -505,6 +507,22 @@ process.section <- function(key, value) {
   new_tag(""section"", list(list(name = pieces[1], content = pieces[2])))
 }
 
+process.docType <- function(partitum) {
+  doctype <- partitum$docType
+  
+  if (is.null(doctype)) return()
+  tags <- list(new_tag(""docType"", doctype))
+  
+  if (doctype == ""package"") {
+    name <- partitum$name
+    if (!str_detect(name, ""-package"")) {
+      tags <- c(tags, new_tag(""alias"", str_c(name, ""-package"")))
+    }
+  }
+  
+  tags
+}
+
 process_had_tag <- function(partitum, tag, f = new_tag) {
   matches <- partitum[names(partitum) == tag]
   if (length(matches) == 0) return()

---FILE: R/roxygen.R---
@@ -16,7 +16,7 @@
 #' Manuel Eugster \email{Manuel.Eugster@@stat.uni-muenchen.de}
 #'
 #' Maintainer: Peter Danenberg \email{pcd@@roxygen.org}
-#' @name roxygen-package
+#' @name roxygen
 #' @docType package
 #' @title Literate Programming in R
 #' @keywords package

---FILE: inst/tests/test-rd-doctype.R---
@@ -0,0 +1,21 @@
+context(""Rd - docTypes"")
+roc <- rd_roclet()
+
+# Package --------------------------------------------------------------------
+
+test_that(""@docType package automatically adds package alias when needed"", {
+  out <- roc_proc_text(roc, ""
+    #' @name a
+    #' @docType package
+    NULL
+
+    #' @name a-package
+    #' @docType package
+    NULL"")
+  
+  alias_1 <- get_tag(out[[1]], ""alias"")$values
+  expect_equal(alias_1, c(""a"", ""a-package""))
+  
+  alias_2 <- get_tag(out[[2]], ""alias"")$values
+  expect_equal(alias_2, c(""a-package""))
+})

---FILE: man/rd_roclet.Rd---
@@ -171,7 +171,8 @@
 
   \item{\code{@docType type}}{Type of object being
   documented. Useful values are \code{data} and
-  \code{package}. }
+  \code{package}. Package doc type will automatically add a
+  \code{package-} alias if needed.}
 
   \item{\code{@format description}}{A textual description
   of the format of the object.}

---FILE: man/roxygen.Rd---
@@ -0,0 +1,32 @@
+\docType{package}
+\name{roxygen}
+\alias{roxygen}
+\alias{roxygen-package}
+\title{Literate Programming in R}
+\description{
+  Roxygen is a Doxygen-like documentation system for R;
+  allowing in-source specification of Rd files, collation
+  and namespace directives.
+}
+\details{
+  \tabular{ll}{ Package: \tab Roxygen2\cr Type: \tab
+  Package\cr Version: \tab 0.1-1\cr Date: \tab
+  2008-08-25\cr License: \tab GPL (>= 2)\cr LazyLoad: \tab
+  yes\cr }
+}
+\examples{
+\dontrun{roxygenize('pkg')}
+}
+\author{
+  Peter Danenberg \email{pcd@roxygen.org}, Manuel Eugster
+  \email{Manuel.Eugster@stat.uni-muenchen.de}
+
+  Maintainer: Peter Danenberg \email{pcd@roxygen.org}
+}
+\seealso{
+  See \code{\link{namespace_roclet}},
+  \code{\link{collate_roclet}}, for an overview of roxygen
+  tags.
+}
+\keyword{package}
+"
r-lib,roxygen2,7ec00dbc03e8166ba82fbc5272c1566d2b3feed9,hadley,h.wickham@gmail.com,2011-10-26T03:01:23Z,hadley,h.wickham@gmail.com,2011-10-26T03:01:23Z,"More informative errors and warnings.
Fixes #13",NEWS;R/parse-preref.R;R/roclet-rd.R;R/utils.R;man/parse.default.Rd;man/parse.name.Rd;man/parse.name.description.Rd;man/parse.toggle.Rd;man/parse.unknown.Rd;man/parse.value.Rd,False,True,True,False,70,23,93,"---FILE: NEWS---
@@ -43,6 +43,10 @@
 
 * Objects that no longer exist are not documented (Fixes #42)
 
+* Errors now display file name and line number of roxygen block to help you
+  find the problem. Thanks to code contributions from Renaud Gaujoux. (Fixes
+  #13)
+
 roxygen2 2.1
 ------------
 

---FILE: R/parse-preref.R---
@@ -1,5 +1,9 @@
 # Parse a preref
 parse.preref <- function(lines) {
+  # Extract srcrefs
+  srcrefs <- attr(lines, 'srcref')
+  srcrefs$lloc[1] <- srcrefs$lloc[1] + 1 
+  
   delimited.lines <- lines[str_detect(lines, LINE.DELIMITER)]
   trimmed.lines <- str_trim(str_replace(delimited.lines, LINE.DELIMITER, """"),
     ""right"")
@@ -16,8 +20,8 @@ parse.preref <- function(lines) {
   elements <- str_replace_all(elements, fixed(""@@""), ""@"")
 
   parsed.introduction <- parse.introduction(elements[[1]])
-  parsed.elements <- unlist(lapply(elements[-1], parse.element), 
-    recursive = FALSE)
+  parsed.elements <- unlist(lapply(elements[-1], parse.element, 
+    srcref = srcrefs), recursive = FALSE)
   
   c(parsed.introduction, parsed.elements)
 } 
@@ -41,21 +45,27 @@ prerefs <- function(srcfile, srcrefs) {
   comments_end <- src_start
   
   src <- readLines(srcfile$filename, warn = FALSE)
-  Map(function(start, end) src[start:end], comments_start, comments_end)
+  
+  extract <- function(start, end) {
+    srcref <- list(filename = srcfile$filename, lloc = c(start, 0 , end, 0))
+    structure(src[start:end], srcref = srcref)
+  }
+  
+  Map(extract, comments_start, comments_end)
 }
 
 # Parse a raw string containing key and expressions.
 #
 # @param element the string containing key and expressions
 # @return A list containing the parsed constituents
-parse.element <- function(element) {
+parse.element <- function(element, srcref) {
   pieces <- str_split_fixed(element, ""[[:space:]]+"", 2)
   
   tag <- pieces[, 1]
   rest <- pieces[, 2]
   
   tag_parser <- preref.parsers[[tag]] %||% parse.unknown 
-  tag_parser(tag, rest)
+  tag_parser(tag, rest, srcref)
 }
 
 # Parse introduction: the premier part of a roxygen block
@@ -76,11 +86,12 @@ parse.introduction <- function(expression) {
 #'
 #' @param key the parsing key
 #' @param rest the expression to be parsed
+#' @param srcref srcref providing location of file name and line number
 #' @return A list containing the key and expression (possibly null)
 #' @keywords internal
 #' @family preref parsing functions
 #' @export
-parse.default <- function(key, rest)
+parse.default <- function(key, rest, srcref)
   as.list(structure(str_trim(rest), names=key))
 
 #' Parse an unknown tag.
@@ -93,8 +104,8 @@ parse.default <- function(key, rest)
 #' @family preref parsing functions
 #' @keywords internal
 #' @export
-parse.unknown <- function(key, rest) {
-  warning(key, ' is an unknown key', call. = FALSE)
+parse.unknown <- function(key, rest, srcref) {
+  roxygen_warning(key, ' is an unknown key', srcref = srcref)
   parse.default(key, rest)
 }
 
@@ -105,9 +116,9 @@ parse.unknown <- function(key, rest) {
 #' @family preref parsing functions
 #' @keywords internal
 #' @export
-parse.value <- function(key, rest) {
+parse.value <- function(key, rest, srcref) {
   if (is.null.string(rest))
-    stop(key, 'requires a value', call. = FALSE)
+    roxygen_stop(key, ' requires a value', srcref = srcref)
   else
     parse.default(key, rest)
 }
@@ -120,14 +131,14 @@ parse.value <- function(key, rest) {
 #' @family preref parsing functions
 #' @keywords internal
 #' @export
-parse.name.description <- function(key, rest) {
+parse.name.description <- function(key, rest, srcref) {
   pieces <- str_split_fixed(rest, ""[[:space:]]+"", 2)
   
   name <- pieces[, 1]
   rest <- str_trim(pieces[, 2])
 
   if (is.null.string(name))
-    stop(key, 'requires a name and description', call. = FALSE)
+    roxygen_stop(key, ' requires a name and description', srcref = srcref)
   else
     as.list(structure(list(list(name=name,
                                 description=rest)),
@@ -144,13 +155,13 @@ parse.name.description <- function(key, rest) {
 #' @family preref parsing functions
 #' @keywords internal
 #' @export
-parse.name <- function(key, name) {
+parse.name <- function(key, name, srcref) {
   name <- str_trim(name)
   
   if (is.null.string(name)) {
-    stop(key, ' requires a name', call. = FALSE)
+    roxygen_stop(key, ' requires a name', srcref = srcref)
   } else if (str_count(name, ""\\s+"") > 1) {
-    warning(key, ' ignoring extra arguments', call. = FALSE)
+    roxygen_warning(key, ' ignoring extra arguments', srcref = srcref)
   }
     
   parse.default(key, word(name, 1))
@@ -163,5 +174,5 @@ parse.name <- function(key, name) {
 #' @family preref parsing functions
 #' @keywords internal
 #' @export
-parse.toggle <- function(key, rest)
+parse.toggle <- function(key, rest, srcref)
   as.list(structure(TRUE, names=key))

---FILE: R/roclet-rd.R---
@@ -326,7 +326,7 @@ roclet_rd_one <- function(partitum, base_path) {
   if (is.null(name) && length(partitum$assignee) == 1) {
      name <- partitum$assignee
   }
-  if (is.null(name)) stop(""Missing name"")
+  if (is.null(name)) roxygen_stop(""Missing name"", srcref = partitum$srcref)
 
   # Work out file name and initialise Rd object
   filename <- str_c(partitum$merge %||% partitum$rdname %||% nice_name(name),

---FILE: R/utils.R---
@@ -76,3 +76,17 @@ nice_name <- function(x) {
   x <- str_replace(x, ""-+"", ""-"")
   x
 }
+
+
+roxygen_stop <- function(..., srcref = NULL) {
+  stop(..., srcref_location(srcref), call. = FALSE)
+}
+
+roxygen_warning <- function(..., srcref = NULL) {
+  warning(..., srcref_location(srcref), call. = FALSE)
+}
+
+srcref_location <- function(srcref = NULL) {
+  if (is.null(srcref)) return()
+  str_c("" in block "", basename(srcref$filename), "":"", srcref$lloc[1])
+}
\ No newline at end of file

---FILE: man/parse.default.Rd---
@@ -2,12 +2,15 @@
 \alias{parse.default}
 \title{Default parser which simply emits the key and expression.}
 \usage{
-  parse.default(key, rest)
+  parse.default(key, rest, srcref)
 }
 \arguments{
   \item{key}{the parsing key}
 
   \item{rest}{the expression to be parsed}
+
+  \item{srcref}{srcref providing location of file name and
+  line number}
 }
 \value{
   A list containing the key and expression (possibly null)

---FILE: man/parse.name.Rd---
@@ -2,12 +2,15 @@
 \alias{parse.name}
 \title{Parse an element containing a single name and only a name.}
 \usage{
-  parse.name(key, name)
+  parse.name(key, name, srcref)
 }
 \arguments{
   \item{name}{the name to be parsed}
 
   \item{key}{the parsing key}
+
+  \item{srcref}{srcref providing location of file name and
+  line number}
 }
 \value{
   A list containing key and name

---FILE: man/parse.name.description.Rd---
@@ -3,12 +3,15 @@
 \title{Parse an element containing a mandatory name
 and description (such as \code{@param}).}
 \usage{
-  parse.name.description(key, rest)
+  parse.name.description(key, rest, srcref)
 }
 \arguments{
   \item{key}{the parsing key}
 
   \item{rest}{the expression to be parsed}
+
+  \item{srcref}{srcref providing location of file name and
+  line number}
 }
 \value{
   A list containing the key, name and description

---FILE: man/parse.toggle.Rd---
@@ -2,12 +2,15 @@
 \alias{parse.toggle}
 \title{Turn a binary element on; parameters are ignored.}
 \usage{
-  parse.toggle(key, rest)
+  parse.toggle(key, rest, srcref)
 }
 \arguments{
   \item{key}{the parsing key}
 
   \item{rest}{the expression to be parsed}
+
+  \item{srcref}{srcref providing location of file name and
+  line number}
 }
 \value{
   A list with the key and \code{TRUE}

---FILE: man/parse.unknown.Rd---
@@ -2,12 +2,15 @@
 \alias{parse.unknown}
 \title{Parse an unknown tag.}
 \usage{
-  parse.unknown(key, rest)
+  parse.unknown(key, rest, srcref)
 }
 \arguments{
   \item{key}{the parsing key}
 
   \item{rest}{the expression to be parsed}
+
+  \item{srcref}{srcref providing location of file name and
+  line number}
 }
 \value{
   A list containing the key and expression (possibly null)

---FILE: man/parse.value.Rd---
@@ -2,12 +2,15 @@
 \alias{parse.value}
 \title{Parse an element with a mandatory value.}
 \usage{
-  parse.value(key, rest)
+  parse.value(key, rest, srcref)
 }
 \arguments{
   \item{key}{the parsing key}
 
   \item{rest}{the expression to be parsed}
+
+  \item{srcref}{srcref providing location of file name and
+  line number}
 }
 \value{
   A list containing the key and value"
r-lib,roxygen2,00d08f6116e415fa285b5bc8df46ae07170389cf,hadley,h.wickham@gmail.com,2011-10-25T21:02:24Z,hadley,h.wickham@gmail.com,2011-10-25T21:02:24Z,Don't document non-existant objects (Fixes #42),NEWS;R/roclet-rd.R;inst/tests/Rd-closure.R;inst/tests/test-had.R,False,True,True,False,25,3,28,"---FILE: NEWS---
@@ -41,6 +41,8 @@
 
 * Functions with quoted names now get correct usage statements (Fixes #41)
 
+* Objects that no longer exist are not documented (Fixes #42)
+
 roxygen2 2.1
 ------------
 

---FILE: R/roclet-rd.R---
@@ -37,8 +37,11 @@ register.preref.parsers(parse.default,
 
 
 register.srcref.parsers(function(call, env) {
-  assignee <- call[[2]]
-  value <- get(as.character(assignee), env)
+  assignee <- as.character(call[[2]])
+  
+  # If it doesn't exist (any more), don't document it.
+  if (!exists(assignee, env)) return()
+  value <- get(assignee, env)
   
   out <- list(assignee = as.character(assignee))
   out$fun <- is.function(value)

---FILE: inst/tests/Rd-closure.R---
@@ -0,0 +1,11 @@
+f <- function(){
+   .a <- 0
+   function(x = 1){
+     .a <<- .a + x
+     .a
+   }
+}
+
+#' Addition function.
+f2 <- f()
+rm(f)

---FILE: inst/tests/test-had.R---
@@ -1,7 +1,6 @@
 context(""Rd"")
 roc <- rd_roclet()
 
-
 test_that(""@example loads from specified files"", {
   out <- roc_proc_text(roc, ""
     #' @name a
@@ -142,6 +141,8 @@ test_that(""quoted topics have usage statements"", {
   
 })
 
+
+
 test_that(""@name overides default"", {
   out <- roc_proc_text(roc, ""
     #' @name b
@@ -356,4 +357,9 @@ test_that(""`$` not to be parsed as assignee in foo$bar(a = 1)"", {
     expect_equal(get_tag(out, ""name"")$values, ""foo"")
 })
 
+test_that(""documentation closure work"", {
+  out <- roc_process(roc, parse.files(""Rd-closure.R""), base_path = ""."")
+  expect_equal(names(out), ""f2.Rd"")
+})
+
 "
r-lib,roxygen2,665dd0d980bb7d3d0ebb31316248a450bdd4cefc,hadley,h.wickham@gmail.com,2011-10-25T19:39:51Z,hadley,h.wickham@gmail.com,2011-10-25T19:39:51Z,"Better retrieval of quoted assignments.
Fixes #41",NEWS;R/roclet-rd.R;inst/tests/Rd-filenames.R;inst/tests/test-had.R,False,True,True,False,99,1,100,"---FILE: NEWS---
@@ -39,6 +39,8 @@
   problems in the unlikely event that you have default value containing a
   non-breaking space (`""\uA0""')  (Fixes #21)
 
+* Functions with quoted names now get correct usage statements (Fixes #41)
+
 roxygen2 2.1
 ------------
 

---FILE: R/roclet-rd.R---
@@ -38,7 +38,7 @@ register.preref.parsers(parse.default,
 
 register.srcref.parsers(function(call, env) {
   assignee <- call[[2]]
-  value <- eval(assignee, env)
+  value <- get(as.character(assignee), env)
   
   out <- list(assignee = as.character(assignee))
   out$fun <- is.function(value)

---FILE: inst/tests/Rd-filenames.R---
@@ -0,0 +1,86 @@
+#' First letter
+a <- function() {}
+  
+#' Second letter
+""b"" <- function() {}
+
+#' Third letter
+`c` <- function() {}
+
+#' Extracts environmental covariate data for SMI Zc analysis
+#' : by extracting data from ACCESS database and creating a series of
+#' anomaly summaries for sea surface temperature(SST), upwelling index (UWI) and
+#' multivariate ENSO index (MEI).
+#'
+#' @export
+#' @import CIPinnipedAnalysis
+#' @param average.years years to use for average for anomaly creationccc
+#' @param fdir directory containing environmental.data.mdb
+#' @param sites SST sites to be used in SST averaging (from create.SST.anomalies)
+#'        1) ESB, 2)WSB, 3)PtArg, 4)PtSM, 5)PtSL, 6)CSM, 7)MB, 8)PtReyes
+#' @return dataframe with rows as years from 1987 to last year in data and the columns are:
+#'      time,OcttoJuneSSTAnomalies,ApriltoJuneSSTAnomalies,JulytoJuneSSTAnomalies,
+#'                      OcttoJuneUWI33Anomalies, ApriltoJuneUWI33Anomalies, JulytoJuneUWI33Anomalies,
+#'                      OcttoJuneUWI36Anomalies, ApriltoJuneUWI36Anomalies, JulytoJuneUWI36Anomalies,
+#'                      OcttoJuneMEI, ApriltoJuneMEI, JulytoJuneMEI
+#' @author Jeff Laake
+""EnvironCovariates""<-function(average.years=c(1994:1996,1998:2008),fdir="""",sites=1:5)
+{
+#   SST Anomalies
+       if(fdir=="""")fdir=system.file(package = ""CIPinnipedAnalysis"")
+       anomalies=create.SST.anomalies(average.years,fdir=fdir,store=FALSE)
+       fpath=file.path(fdir,""environmental.data.mdb"")
+       connection=odbcConnectAccess(fpath)
+       SSTAnomalies=t(apply(anomalies[,,sites],c(2,1),mean,na.rm=TRUE))
+       SSTAnomalies[is.nan(SSTAnomalies)]=NA
+       nyears=nrow(SSTAnomalies)
+       OcttoJuneSSTAnomalies=rowMeans(cbind(SSTAnomalies[1:(nyears-1),c(""Oct"",""Nov"",""Dec"")],SSTAnomalies[2:nyears,c(""Jan"",""Feb"",""Mar"",""Apr"",""May"",""June"")]),na.rm=TRUE)
+       ApriltoJuneSSTAnomalies=rowMeans(SSTAnomalies[,c(""Apr"",""May"",""June"")],na.rm=TRUE)
+       names(ApriltoJuneSSTAnomalies)=as.character(as.numeric(names(ApriltoJuneSSTAnomalies))-1)
+       JulytoJuneSSTAnomalies=rowMeans(cbind(SSTAnomalies[1:(nyears-1),c(""July"",""Aug"",""Sept"",""Oct"",""Nov"",""Dec"")],SSTAnomalies[2:nyears,c(""Jan"",""Feb"",""Mar"",""Apr"",""May"",""June"")]),na.rm=TRUE)
+#   UpwellingIndex for 33N & 36N
+       UWI=sqlFetch(connection,""UWIAnomaly"")
+       UWI=UWI[order(UWI$Year,UWI$Month),]
+       UWI=tapply(UWI$UWI,list(UWI$Year,UWI$Month,UWI$Location),unique)
+       minyear=min(as.numeric(dimnames(UWI)[[1]]))
+       maxyear=max(as.numeric(dimnames(UWI)[[1]]))
+       nyears=maxyear-minyear+1
+       OcttoJuneUWI33Anomalies=rowMeans(cbind(UWI[1:(nyears-1),as.character(10:12),1],UWI[2:nyears,as.character(1:6),1]),na.rm=TRUE)
+       ApriltoJuneUWI33Anomalies=rowMeans(UWI[,as.character(4:6),1],na.rm=TRUE)[1:nyears]
+       names(ApriltoJuneUWI33Anomalies)=as.character(as.numeric(names(ApriltoJuneUWI33Anomalies))-1)
+       JulytoJuneUWI33Anomalies=rowMeans(cbind(UWI[1:(nyears-1),as.character(7:12),1],UWI[2:nyears,as.character(1:6),1]),na.rm=TRUE)
+       OcttoJuneUWI36Anomalies=rowMeans(cbind(UWI[1:(nyears-1),as.character(10:12),2],UWI[2:nyears,as.character(1:6),2]),na.rm=TRUE)
+       ApriltoJuneUWI36Anomalies=rowMeans(UWI[,as.character(4:6),2],na.rm=TRUE)
+       names(ApriltoJuneUWI36Anomalies)=as.character(as.numeric(names(ApriltoJuneUWI36Anomalies))-1)
+       JulytoJuneUWI36Anomalies=rowMeans(cbind(UWI[1:(nyears-1),as.character(7:12),2],UWI[2:nyears,as.character(1:6),2]),na.rm=TRUE)
+#   Multivariate ENSO Index - lagged by 3 months
+       MEI=sqlFetch(connection,""MEI"")
+       minyear=min(MEI$Year)
+       maxyear=max(MEI$Year)
+       nyears=maxyear-minyear+1
+       MEI=tapply(MEI$MEI,list(MEI$Year,MEI$Month),unique)
+       OcttoJuneMEI=rowMeans(cbind(MEI[1:(nyears-1),as.character(7:12)],MEI[2:nyears,as.character(1:3)]),na.rm=TRUE)
+       ApriltoJuneMEI=rowMeans(MEI[,as.character(1:3)],na.rm=TRUE)
+       names(ApriltoJuneMEI)=as.character(as.numeric(names(ApriltoJuneMEI))-1)
+       JulytoJuneMEI=rowMeans(cbind(MEI[1:(nyears-1),as.character(4:12)],MEI[2:nyears,as.character(1:3)]),na.rm=TRUE)
+#   Create dataframe with values from 1987:2009
+       maxyear=max(as.numeric(names(JulytoJuneMEI)))
+#   time is meant to match the beginning year of a survival interval from time to time+1;  that is why the
+#   April-to-June is set as the previous year to model survival of pup cohort born in the previous year
+   envcovdf=data.frame(time=1987:maxyear,
+                       OcttoJuneSSTAnomalies=OcttoJuneSSTAnomalies[as.character(1987:maxyear)],
+                       ApriltoJuneSSTAnomalies=ApriltoJuneSSTAnomalies[as.character(1987:maxyear)],
+                       JulytoJuneSSTAnomalies=JulytoJuneSSTAnomalies[as.character(1987:maxyear)],
+                       OcttoJuneUWI33Anomalies=OcttoJuneUWI33Anomalies[as.character(1987:maxyear)],
+                       ApriltoJuneUWI33Anomalies=ApriltoJuneUWI33Anomalies[as.character(1987:maxyear)],
+                       JulytoJuneUWI33Anomalies=JulytoJuneUWI33Anomalies[as.character(1987:maxyear)],
+                       OcttoJuneUWI36Anomalies=OcttoJuneUWI36Anomalies[as.character(1987:maxyear)],
+                       ApriltoJuneUWI36Anomalies=ApriltoJuneUWI36Anomalies[as.character(1987:maxyear)],
+                       JulytoJuneUWI36Anomalies=JulytoJuneUWI36Anomalies[as.character(1987:maxyear)],
+                       OcttoJuneMEI=OcttoJuneMEI[as.character(1987:maxyear)],
+                       ApriltoJuneMEI=ApriltoJuneMEI[as.character(1987:maxyear)],
+                       JulytoJuneMEI=JulytoJuneMEI[as.character(1987:maxyear)]
+                       )
+       odbcClose(connection)
+   return(envcovdf)
+}
\ No newline at end of file

---FILE: inst/tests/test-had.R---
@@ -133,6 +133,15 @@ test_that(""quoted names captured from assignment"", {
   expect_equal(get_tag(out, ""alias"")$values, ""my function"")
 })
 
+test_that(""quoted topics have usage statements"", {
+  out <- roc_proc_text(roc, ""
+    #' Title.
+    \""f\"" <- function(a = 1, b = 2) {}"")[[1]]
+  
+  expect_equal(get_tag(out, ""usage"")$values, ""f(a=1, b=2)"")
+  
+})
+
 test_that(""@name overides default"", {
   out <- roc_proc_text(roc, ""
     #' @name b
@@ -347,3 +356,4 @@ test_that(""`$` not to be parsed as assignee in foo$bar(a = 1)"", {
     expect_equal(get_tag(out, ""name"")$values, ""foo"")
 })
 
+"
r-lib,roxygen2,190a9ba809b2b27d44edce1cb89ad8106beced5a,hadley,h.wickham@gmail.com,2011-10-25T19:25:05Z,hadley,h.wickham@gmail.com,2011-10-25T19:25:05Z,Fix poorly named file,inst/tests/Rd-params.R;inst/tests/test-had.R,False,True,True,False,1,1,2,"---FILE: inst/tests/test-had.R---
@@ -318,7 +318,7 @@ test_that(""no ending punctuation does not produce ellipsis"", {
 
 
 test_that(""multiple @inheritParam tags gathers all params"", {
-  out <- roc_process(roc, parse.files(""Rd-collate.R""), base_path = ""."")
+  out <- roc_process(roc, parse.files(""Rd-params.R""), base_path = ""."")
   
   params <- get_tag(out[[""c.Rd""]], ""arguments"")$values
   expect_equal(length(params), 2)"
r-lib,roxygen2,c3323a58a20ae5d0dca806eb2f972d1ebbdde78e,hadley,h.wickham@gmail.com,2011-10-25T10:16:23Z,hadley,h.wickham@gmail.com,2011-10-25T10:16:23Z,Correct wrapping of usage strings (fixes #21),NEWS;R/rd-tag-api.R;R/utils.R;inst/tests/test-had.R,False,True,True,False,27,6,33,"---FILE: NEWS---
@@ -34,6 +34,11 @@
 * roxygen2 will replace characters that are not valid in filenames with a
   character substitute, e.g. `[]` becomes `sub`, `<-` becomes `set` (Fixes #6)
 
+* Usage strings use non-breaking spaces to prevent string default values
+  containing whitespace to be split across multiple lines. This may cause
+  problems in the unlikely event that you have default value containing a
+  non-breaking space (`""\uA0""')  (Fixes #21)
+
 roxygen2 2.1
 ------------
 

---FILE: R/rd-tag-api.R---
@@ -27,6 +27,8 @@ rd_tag <- function(tag, ..., space = FALSE) {
   } else {
     values <- str_trim(c(...))
   }
+  # Turn non-breaking spaces back into regular spaces
+  values <- str_replace_all(values, fixed(""\uA0""), "" "")
   str_c(""\\"", tag, str_c(""{"", values, ""}"", collapse = """"), ""\n"")                         
 }
 
@@ -70,7 +72,8 @@ format.format_tag <- format_first
 
 format_collapse <- function(x, ...) {
   values <- str_c(x$values, collapse = ""\n\n"")
-  rd_tag(x$tag, str_wrap(values, width = 60, indent = 2, exdent = 2), space = TRUE)
+  rd_tag(x$tag, str_wrap(values, width = 60, indent = 2, exdent = 2), 
+    space = TRUE)
 } 
 #' @S3method format author_tag
 #' @S3method format concept_tag
@@ -111,7 +114,8 @@ format.arguments_tag <- function(x, ...) {
   dups <- duplicated(names)
   
   items <- str_c(""\\item{"", names, ""}{"", x$values, ""}"", collapse = ""\n\n"")
-  rd_tag(""arguments"", str_wrap(items, width = 60, exdent = 2, indent = 2), space = TRUE)
+  rd_tag(""arguments"", str_wrap(items, width = 60, exdent = 2, indent = 2),
+    space = TRUE)
 }
 
 #' @S3method format section_tag

---FILE: R/utils.R---
@@ -16,8 +16,9 @@ usage <- function(args) {
     if (is.missing.arg(arg)) return("""")
     text <- deparse(arg, backtick = TRUE, width.cutoff = 500L)
     text <- str_replace_all(text, fixed(""%""), ""\\%"")
+    text <- str_replace_all(text, fixed("" ""), ""\uA0"")
     
-    paste("" = "", paste(text, collapse = ""\n""), sep = """")
+    paste(""\uA0=\uA0"", paste(text, collapse = ""\n""), sep = """")
   }
 
   arg_values <- vapply(args, arg_to_text, character(1))

---FILE: inst/tests/test-had.R---
@@ -146,15 +146,15 @@ test_that(""usage captured from formals"", {
   out <- roc_proc_text(roc, ""
     #' Title.
     a <- function(a=1) {}"")[[1]]
-  expect_equal(get_tag(out, ""usage"")$values, ""a(a = 1)"")
+  expect_equal(get_tag(out, ""usage"")$values, ""a(a\u{A0}=\u{A0}1)"")
 })
 
 test_that(""usage correct for modification functions"", {
   out <- roc_proc_text(roc, ""
     #' Title.
     `foo<-` <- function(a=1) {}"")[[1]]
   
-  expect_equal(get_tag(out, ""usage"")$values, ""foo(a = 1) <- value"")
+  expect_equal(get_tag(out, ""usage"")$values, ""foo(a\u{A0}=\u{A0}1) <- value"")
 })
 
 test_that(""usage correct for functions with no arguments"", {
@@ -169,9 +169,20 @@ test_that(""% is escaped in usage"", {
   out <- roc_proc_text(roc, ""
     #' Title.
     a <- function(a='%') {}"")[[1]]
-  expect_equal(get_tag(out, ""usage"")$values, ""a(a = \""\\%\"")"")
+  expect_equal(get_tag(out, ""usage"")$values, ""a(a\u{A0}=\u{A0}\""\\%\"")"")
 })
 
+test_that(""long usages protected from incorrect breakage"", {
+  out <- roc_proc_text(roc, ""
+      #' Function long usage
+      f <- function(a = '                             a', 
+                    b = '                             b', 
+                    c = '                             c', 
+                    d = '                             ') 1"")[[1]]
+  
+  usage <- format(get_tag(out, ""usage""))
+  expect_equal(str_count(usage, ""\n""), 6)
+})
 
 test_that(""@usage overrides default"", {
   out <- roc_proc_text(roc, """
r-lib,roxygen2,9de69bdc9455bb2a537a01b4b29e1c8f766354ca,hadley,h.wickham@gmail.com,2011-10-25T06:48:32Z,hadley,h.wickham@gmail.com,2011-10-25T06:48:32Z,Replace non-alpha characters in file names (fixes #6),NEWS;R/roclet-rd.R;R/utils.R;inst/tests/test-had.R,False,True,True,False,61,1,62,"---FILE: NEWS---
@@ -31,6 +31,9 @@
 
 * Indentation in examples now preserved (Fixes #27)
 
+* roxygen2 will replace characters that are not valid in filenames with a
+  character substitute, e.g. `[]` becomes `sub`, `<-` becomes `set` (Fixes #6)
+
 roxygen2 2.1
 ------------
 

---FILE: R/roclet-rd.R---
@@ -326,7 +326,8 @@ roclet_rd_one <- function(partitum, base_path) {
   if (is.null(name)) stop(""Missing name"")
 
   # Work out file name and initialise Rd object
-  filename <- str_c(partitum$merge %||% partitum$rdname %||% name, "".Rd"")
+  filename <- str_c(partitum$merge %||% partitum$rdname %||% nice_name(name),
+    "".Rd"")
   
   add_tag(rd, new_tag(""name"", name))
   add_tag(rd, new_tag(""alias"", name))

---FILE: R/utils.R---
@@ -31,3 +31,47 @@ usage <- function(args) {
 is.null.string <- function(string) {
   str_length(str_trim(string)) == 0
 }
+
+
+subs <- matrix(ncol = 2, byrow = T, c(
+  '[]', 'sub',
+  '<-', 'set',
+  '!', 'not',
+  '""', 'quote',
+  '#', 'hash',
+  '$', 'cash',
+  '%', 'grapes',
+  '&', 'and',
+  '|', 'or',
+  ""'"", 'single-quote',
+  '(', 'open-paren',
+  ')', 'close-paren',
+  '*', 'star',
+  '+', 'plus',
+  ',', 'comma',
+  '/', 'slash',
+  ':', 'colon',
+  ';', 'semi-colon',
+  '<', 'less-than',
+  '=', 'equals',
+  '>', 'greater-than',
+  '?', 'p',
+  '@', 'at',
+  '[', 'open-brace',
+  '\\', 'backslash',
+  ']', 'close-brace',
+  '^', 'hat',
+  '`', 'tick',
+  '{', 'open-curly',
+  '}', 'close',
+  '~', 'twiddle'
+))
+subs[, 2] <- str_c(""-"", subs[, 2])
+
+nice_name <- function(x) {
+  for(i in seq_len(nrow(subs))) {
+    x <- str_replace_all(x, fixed(subs[i, 1]), subs[i, 2])
+  }
+  x <- str_replace(x, ""-+"", ""-"")
+  x
+}

---FILE: inst/tests/test-had.R---
@@ -99,6 +99,18 @@ test_that(""name also captured from assignment by ="", {
   expect_equal(get_tag(out, ""title"")$values, ""Title."")
 })
 
+test_that(""filename doesn't contain invalid characters"", {
+  out <- roc_proc_text(roc, ""
+    #' Title.
+    #' @name a<-
+    NULL
+    
+    #' Title.
+    #' @name a[]
+    NULL"")
+  expect_equal(names(out), c(""a-set.Rd"", ""a-sub.Rd""))
+})
+
 test_that(""quoted names captured from assignment"", {
   out <- roc_proc_text(roc, ""
     #' Title."
r-lib,roxygen2,5973ef2ed62a3d6395ca5a44c5c99e93e757e916,hadley,h.wickham@gmail.com,2011-10-25T04:49:09Z,hadley,h.wickham@gmail.com,2011-10-25T04:49:09Z,Preserve indentation in examples (Fixes #27),NEWS;R/parse-preref.R;inst/tests/test-had.R,False,True,True,False,16,2,18,"---FILE: NEWS---
@@ -29,6 +29,8 @@
 
 * Functions with no arguments now correctly get usage statements (Fixes #35)
 
+* Indentation in examples now preserved (Fixes #27)
+
 roxygen2 2.1
 ------------
 

---FILE: R/parse-preref.R---
@@ -1,7 +1,8 @@
 # Parse a preref
 parse.preref <- function(lines) {
   delimited.lines <- lines[str_detect(lines, LINE.DELIMITER)]
-  trimmed.lines <- str_trim(str_replace(delimited.lines, LINE.DELIMITER, """"))
+  trimmed.lines <- str_trim(str_replace(delimited.lines, LINE.DELIMITER, """"),
+    ""right"")
 
   if (length(trimmed.lines) == 0) return(list())
 
@@ -22,7 +23,7 @@ parse.preref <- function(lines) {
 } 
 
 # Sequence that distinguishes roxygen comment from normal comment.
-LINE.DELIMITER <- '#+\''
+LINE.DELIMITER <- '\\s*#+\' ?'
 
 # Comment blocks (possibly null) that precede a file's expressions.
 #

---FILE: inst/tests/test-had.R---
@@ -46,6 +46,17 @@ test_that(""@example does not introduce extra empty lines"", {
   expect_identical(length(examples), 2L)
 })
 
+test_that(""indentation in examples preserved"", {
+  out <- roc_proc_text(roc, ""
+    #' @name a
+    #' @examples a <-
+    #'     2
+    NULL"")[[1]]
+
+  examples <- get_tag(out, ""examples"")$values
+  expect_match(examples, fixed(""a <-\n    2""), all = FALSE)
+})
+
 test_that(""% in @example escaped"", {
   out <- roc_proc_text(roc, ""
     #' @name a"
r-lib,roxygen2,c6f633e1c59f913d687ecb08b099b52459d89407,hadley,h.wickham@gmail.com,2011-10-25T04:34:27Z,hadley,h.wickham@gmail.com,2011-10-25T04:34:27Z,Usage statements for argument-less functions (fixes #35),NEWS;R/roclet-rd.R;inst/tests/test-had.R,False,True,True,False,21,15,36,"---FILE: NEWS---
@@ -27,6 +27,8 @@
 * Replacement functions (e.g. `foo<-`) now get correct usage statements:
   `foo() <- value` instead of `foo()<-value`. (Fixes #38)
 
+* Functions with no arguments now correctly get usage statements (Fixes #35)
+
 roxygen2 2.1
 ------------
 

---FILE: R/roclet-rd.R---
@@ -40,11 +40,13 @@ register.srcref.parsers(function(call, env) {
   assignee <- call[[2]]
   value <- eval(assignee, env)
   
-  if (!is.function(value)) {
-    list(assignee = as.character(assignee))
-  } else {
-    list(assignee = as.character(assignee), formals = formals(value))
+  out <- list(assignee = as.character(assignee))
+  out$fun <- is.function(value)
+  
+  if (out$fun) {
+    out$formals <- formals(value)
   }
+  out
 }, '<-', '=')
 
 
@@ -393,32 +395,29 @@ roc_output.had <- function(roclet, results, base_path) {
 }
 
 
-
-
 # Prefer explicit \code{@@usage} to a \code{@@formals} list.
 process.usage <- function(partitum) {
+  if (is.null(partitum$fun) || !partitum$fun) {
+    return(new_tag(""usage"", NULL))
+  }
+  
   if (!is.null(partitum$usage)) {
     return(new_tag(""usage"", partitum$usage))
   }
-  
-  formals <- partitum$formals
-  if (length(formals) == 0) return()
-  
-  args <- usage(formals)
-  
+    
   fun_name <- if (!is.null(partitum$method)) {
     rd_tag('method', partitum$method[[1]], partitum$method[[2]])
   } else {
     partitum$assignee
   }
+  args <- usage(partitum$formals)
   
   if (str_detect(fun_name, fixed(""<-""))) {
     fun_name <- str_replace(fun_name, fixed(""<-""), """")
     new_tag(""usage"", str_c(fun_name, ""("", args, "") <- value""))
   } else {
     new_tag(""usage"", str_c(fun_name, ""("", args, "")""))
   }
-
 }
 
 # Process title, description and details. 

---FILE: inst/tests/test-had.R---
@@ -134,6 +134,13 @@ test_that(""usage correct for modification functions"", {
   expect_equal(get_tag(out, ""usage"")$values, ""foo(a = 1) <- value"")
 })
 
+test_that(""usage correct for functions with no arguments"", {
+  out <- roc_proc_text(roc, ""
+      #' Function without parameters
+      f <- function() 1"")[[1]]
+  
+  expect_equal(get_tag(out, ""usage"")$values, ""f()"")
+})
 
 test_that(""% is escaped in usage"", {
   out <- roc_proc_text(roc, ""
@@ -150,8 +157,6 @@ test_that(""@usage overrides default"", {
     expect_equal(get_tag(out, ""usage"")$values, ""a(a=2)"")
 })
 
-
-
 test_that(""@param documents arguments"", {
   out <- roc_proc_text(roc, ""
     #' @param a an incipit letter"
r-lib,roxygen2,aed1db529fc72f947981a57b8d935a6b44e9647c,hadley,h.wickham@gmail.com,2011-10-25T04:18:38Z,hadley,h.wickham@gmail.com,2011-10-25T04:18:38Z,Correct usage for replacement functions (fixes #38),NEWS;R/roclet-rd.R;inst/tests/test-had.R,False,True,True,False,20,3,23,"---FILE: NEWS---
@@ -24,6 +24,9 @@
 
 * Aliases are no longer quoted, and % is escaped with a backslash (Fixes #24)
 
+* Replacement functions (e.g. `foo<-`) now get correct usage statements:
+  `foo() <- value` instead of `foo()<-value`. (Fixes #38)
+
 roxygen2 2.1
 ------------
 

---FILE: R/roclet-rd.R---
@@ -411,9 +411,14 @@ process.usage <- function(partitum) {
   } else {
     partitum$assignee
   }
+  
+  if (str_detect(fun_name, fixed(""<-""))) {
+    fun_name <- str_replace(fun_name, fixed(""<-""), """")
+    new_tag(""usage"", str_c(fun_name, ""("", args, "") <- value""))
+  } else {
+    new_tag(""usage"", str_c(fun_name, ""("", args, "")""))
+  }
 
-  usage <- str_c(fun_name, ""("", args, "")"")
-  new_tag(""usage"", usage)
 }
 
 # Process title, description and details. 

---FILE: inst/tests/test-had.R---
@@ -108,7 +108,6 @@ test_that(""quoted names captured from assignment"", {
   
   expect_equal(get_tag(out, ""name"")$values, ""my function"")
   expect_equal(get_tag(out, ""alias"")$values, ""my function"")
-  
 })
 
 test_that(""@name overides default"", {
@@ -127,6 +126,15 @@ test_that(""usage captured from formals"", {
   expect_equal(get_tag(out, ""usage"")$values, ""a(a = 1)"")
 })
 
+test_that(""usage correct for modification functions"", {
+  out <- roc_proc_text(roc, ""
+    #' Title.
+    `foo<-` <- function(a=1) {}"")[[1]]
+  
+  expect_equal(get_tag(out, ""usage"")$values, ""foo(a = 1) <- value"")
+})
+
+
 test_that(""% is escaped in usage"", {
   out <- roc_proc_text(roc, ""
     #' Title.
@@ -143,6 +151,7 @@ test_that(""@usage overrides default"", {
 })
 
 
+
 test_that(""@param documents arguments"", {
   out <- roc_proc_text(roc, ""
     #' @param a an incipit letter"
r-lib,roxygen2,4070aeccc38ddfbbe863fb4e74b56de75cfa58a1,hadley,h.wickham@gmail.com,2011-10-25T03:36:42Z,hadley,h.wickham@gmail.com,2011-10-25T03:36:42Z,"Make all export directives consistent, and update documentation (fixes #45)",R/roclet-namespace.R;inst/tests/test-namespace.R,False,True,True,False,15,4,19,"---FILE: R/roclet-namespace.R---
@@ -40,7 +40,7 @@ register.preref.parsers(parse.value, 'exportClass', 'exportMethod',
 #'
 #' }
 #'
-#' There are four tags for importing objects into the package:
+#' There are five tags for importing objects into the package:
 #'
 #' \describe{
 #'
@@ -59,6 +59,13 @@ register.preref.parsers(parse.value, 'exportClass', 'exportMethod',
 #'   multiple \code{importMethodsFrom(package, method)} directives to import
 #'   selected methods from a package.}
 #'
+#' \item{\code{@@useDynLib package}}{produces a \code{useDynLib(package)}
+#'   directive to import all compiled routines from the shared objects in
+#'   the specified package}
+#'
+#' \item{\code{@@useDynLib paackage routinea routineb}}{produces multiple
+#'   \code{useDynLib(package,routine)} directions to import specified 
+#'   compiled routines from a package.}
 #' }
 #'
 #' Only unique directives are saved to the \file{NAMESPACE} file, so you can
@@ -129,10 +136,14 @@ ns_default <- function(tag, parms, all) {
   ns_directive(tag, words(parms))
 }
 ns_collapse <- function(tag, parms, all) {
-  ns_directive(tag, str_c(words(parms), collapse = "",""))
+  params <- words(parms)
+  if (length(params) == 1) {
+    ns_directive(tag, params)
+  } else {
+    ns_directive(tag, str_c(params[1], "","", params[-1]))
+  }
 }
 
-
 ns_exportClass <- function(tag, parms, all) {
   ns_directive('exportClasses', quote_if_needed(parms))
 }

---FILE: inst/tests/test-namespace.R---
@@ -73,5 +73,5 @@ test_that(""useDynLib imports only selected functions"", {
     NULL"")
   
     expect_equal(sort(out), sort(
-      c(""useDynLib(test)"", ""useDynLib(test,a)"", ""useDynLib(test,a,b)"")))
+      c(""useDynLib(test)"", ""useDynLib(test,a)"", ""useDynLib(test,b)"")))
 })
\ No newline at end of file"
r-lib,roxygen2,3e1f0e127f6f46db933a5a7d2215831743beb8fc,hadley,h.wickham@gmail.com,2011-10-25T03:05:37Z,hadley,h.wickham@gmail.com,2011-10-25T03:05:37Z,Correctly escape aliases (fixes #24),NEWS;R/rd-tag-api.R;R/roclet-rd.R;inst/tests/test-had.R,False,True,True,False,24,4,28,"---FILE: NEWS---
@@ -12,6 +12,8 @@
   backslash in the Rd file. This behaviour was already in place for examples
   directly included with `@examples`.
 
+* Aliases are no longer quoted, and % is escaped with a backslash (Fixes #24)
+
 roxygen2 2.1
 ------------
 

---FILE: R/rd-tag-api.R---
@@ -45,10 +45,13 @@ merge.rd_tag <- function(x, y, ...) {
 #' @S3method format alias_tag
 format_rd <- function(x, ...) {
   vapply(sort(unique(x$values)), rd_tag, tag = x$tag, 
-    FUN.VALUE = character(1))
+    FUN.VALUE = character(1), USE.NAMES = FALSE)
 }
 format.keyword_tag <- format_rd
-format.alias_tag <- format_rd
+format.alias_tag <- function(x, ...) {
+  x$values <- str_replace_all(x$values, fixed(""%""), ""\\%"")
+  format_rd(x, ...)
+}
 
 # Tags that keep the first occurence -----------------------------------------
 format_first <- function(x, ...) {

---FILE: R/roclet-rd.R---
@@ -333,8 +333,8 @@ roclet_rd_one <- function(partitum, base_path) {
   add_tag(rd, process_description(partitum, base_path))
 
   add_tag(rd, process_had_tag(partitum, 'aliases', function(tag, param) {
-      new_tag('alias', words(param))
-    }))
+    new_tag('alias', str_split(str_trim(param), ""\\s+"")[[1]])
+  }))
   add_tag(rd, process.usage(partitum))
   add_tag(rd, process.arguments(partitum))
   add_tag(rd, process_had_tag(partitum, 'docType'))

---FILE: inst/tests/test-had.R---
@@ -166,6 +166,21 @@ test_that(""keywords and aliases split into pieces"", {
   expect_match(get_tag(out, ""alias"")$values, fixed(""b""), all = FALSE)
 })
 
+test_that(""aliases escaped, not quoted"", {
+  out1 <- roc_proc_text(roc, ""
+    #' @aliases a
+    #' @name %a%
+    NULL"")[[1]]
+  out2 <- roc_proc_text(roc, ""
+    #' @aliases %a%
+    #' @name a
+    NULL"")[[1]]
+  alias1 <- format(get_tag(out1, ""alias""))
+  alias2 <- format(get_tag(out2, ""alias""))
+  expect_equal(alias1, c(""\\alias{\\%a\\%}\n"", ""\\alias{a}\n""))
+  expect_equal(alias2, c(""\\alias{\\%a\\%}\n"", ""\\alias{a}\n""))
+})
+
 test_that(""generic keys produce desired expected"", {
   out <- roc_proc_text(roc, ""
     #' @references test"
r-lib,roxygen2,eb1ffc6b3baa7d10bec0cd4772405258eb940a27,danielinteractive,daniel.sabanesbove@ifspm.uzh.ch,2011-10-04T15:13:55Z,danielinteractive,daniel.sabanesbove@ifspm.uzh.ch,2011-10-04T15:13:55Z,add bugfix for %-commands in example files,NEWS,False,False,False,False,7,1,8,"---FILE: NEWS---
@@ -4,7 +4,13 @@
    @useDynLib packageName routine1 routine2 
    produces
    useDynLib(packageName, routine1, routine2) 
-   in the NAMESPACE file, instead of separate (wrong) useDynLib statements as before.
+   in the NAMESPACE file, instead of separate (wrong) useDynLib 
+   statements as before.
+
+* In example files included with `@example` you can now use infix operators 
+  (e.g. %*%) or other things with %, because they will be preceded by a 
+  backslash in the Rd file. This behaviour was already in place for examples 
+  directly included with `@examples`.
 
 roxygen2 2.1
 ------------"
r-lib,roxygen2,f0d608dd52d68964244d227c95e544fd304de762,danielinteractive,daniel.sabanesbove@ifspm.uzh.ch,2011-09-22T16:15:20Z,danielinteractive,daniel.sabanesbove@ifspm.uzh.ch,2011-09-22T16:15:20Z,added bullet point for useDynLib fix,NEWS,False,False,False,False,6,0,6,"---FILE: NEWS---
@@ -1,5 +1,11 @@
 * `@details` and `@description` now work correctly
 
+* `@useDynLib` now works correctly: 
+   @useDynLib packageName routine1 routine2 
+   produces
+   useDynLib(packageName, routine1, routine2) 
+   in the NAMESPACE file, instead of separate (wrong) useDynLib statements as before.
+
 roxygen2 2.1
 ------------
 "
r-lib,roxygen2,0725a0b2e4584436f4320871cdd0c893f2b5aa92,Yihui Xie,xie@yihui.name,2011-07-26T22:11:24Z,Yihui Xie,xie@yihui.name,2011-07-26T22:11:24Z,a test case of parsing foo$bar() (issue #18),inst/tests/test-had.R,False,True,True,False,11,1,12,"---FILE: inst/tests/test-had.R---
@@ -230,4 +230,14 @@ test_that(""multiple @inheritParam inherits from existing topics"", {
   params <- get_tag(out, ""arguments"")$values
   expect_equal(length(params), 2)
   expect_equal(sort(names(params)), c(""trim"", ""x""))
-})
\ No newline at end of file
+})
+
+test_that(""`$` not to be parsed as assignee in foo$bar(a = 1)"", {
+  out <- roc_proc_text(roc, ""
+    #' foo object
+    foo <- list(bar = function(a) a)
+    foo$bar(a = 1)"")[[1]]
+    
+    expect_equal(get_tag(out, ""name"")$values, ""foo"")
+})
+"
r-lib,roxygen2,ab04ebc70a707857b6371b0c2bb23456d98c944f,Yihui Xie,xie@yihui.name,2011-07-26T22:09:43Z,Yihui Xie,xie@yihui.name,2011-07-26T22:09:43Z,probably fixes #18 (not very sure),R/parse-srcref.R,False,True,True,False,1,1,2,"---FILE: R/parse-srcref.R---
@@ -15,7 +15,7 @@ parse.srcref <- function(ref, env) {
 
   # Dispatch to registered srcref parsers based on call
   name <- as.character(call[[1]])
-  
+  if (length(name) > 1) return(srcref)
   parser <- srcref.parsers[[name]]
   if (is.null(parser)) return(srcref)
   "
r-lib,roxygen2,f0c343dee5c942cdd6c9f88a6e7dff925750af58,Yihui Xie,xie@yihui.name,2011-07-26T05:39:30Z,Yihui Xie,xie@yihui.name,2011-07-26T05:41:15Z,"the Collate field can be empty, which will cause an error in textConnection",R/roxygenize.R,False,True,True,False,3,2,5,"---FILE: R/roxygenize.R---
@@ -42,8 +42,9 @@ roxygenize <- function(package.dir,
   # (but still include them all, and silently remove missing)
   DESCRIPTION <- file.path(package.dir, ""DESCRIPTION"")
   if (file.exists(DESCRIPTION)) {
-    raw_collate <- read.description(DESCRIPTION)$Collate
-    
+    desc <- read.description(DESCRIPTION)
+    raw_collate <- desc$Collate
+    if (is.null(raw_collate)) raw_collate <- """"
     con <- textConnection(raw_collate)
     on.exit(close(con))
     collate <- scan(con, ""character"", sep = "" "", quiet = TRUE)"
r-lib,roxygen2,7e9d13fe03b19af726fac8c66342c700d9199df6,hadley,h.wickham@gmail.com,2011-07-26T00:36:07Z,Yihui Xie,xie@yihui.name,2011-07-26T05:36:47Z,Fix typo reported by Yihui,R/roxygenize.R;man/roxygenize.Rd,False,True,True,False,2,2,4,"---FILE: R/roxygenize.R---
@@ -8,7 +8,7 @@
 #'
 #' @param package.dir the package's top directory
 #' @param roxygen.dir where to create roxygen output; defaults to
-#'   \file{package.roxygen}.
+#'   \file{package.dir}.
 #' @param copy.package copies the package over before adding/manipulating
 #'    files.
 #' @param overwrite overwrite target files?

---FILE: man/roxygenize.Rd---
@@ -17,7 +17,7 @@
   \item{package.dir}{the package's top directory}
 
   \item{roxygen.dir}{where to create roxygen output;
-  defaults to \file{package.roxygen}.}
+  defaults to \file{package.dir}.}
 
   \item{copy.package}{copies the package over before
   adding/manipulating files.}"
r-lib,roxygen2,662b3c67c1a776ba909be03e1a744204ac135cf8,hadley,h.wickham@gmail.com,2011-07-26T00:36:07Z,hadley,h.wickham@gmail.com,2011-07-26T00:36:07Z,Fix typo reported by Yihui,R/roxygenize.R;man/roxygenize.Rd,False,True,True,False,2,2,4,"---FILE: R/roxygenize.R---
@@ -8,7 +8,7 @@
 #'
 #' @param package.dir the package's top directory
 #' @param roxygen.dir where to create roxygen output; defaults to
-#'   \file{package.roxygen}.
+#'   \file{package.dir}.
 #' @param copy.package copies the package over before adding/manipulating
 #'    files.
 #' @param overwrite overwrite target files?

---FILE: man/roxygenize.Rd---
@@ -17,7 +17,7 @@
   \item{package.dir}{the package's top directory}
 
   \item{roxygen.dir}{where to create roxygen output;
-  defaults to \file{package.roxygen}.}
+  defaults to \file{package.dir}.}
 
   \item{copy.package}{copies the package over before
   adding/manipulating files.}"
r-lib,roxygen2,ffc3ebf3a59aa3c59a8425f018aca7927122a03c,hadley,h.wickham@gmail.com,2011-07-14T14:54:21Z,hadley,h.wickham@gmail.com,2011-07-14T14:54:21Z,Fix caching problem,R/roclet-rd.R,False,True,True,False,2,0,2,"---FILE: R/roclet-rd.R---
@@ -219,6 +219,8 @@ roc_process.had <- function(roclet, partita, base_path) {
     key <- c(template_hash, digest(partitum))
     new <- rd_proc_cache$compute(key, roclet_rd_one(partitum, base_path)) 
     if (is.null(new)) next; 
+    # Clone output so cached object isn't modified
+    new$rd[[1]] <- list2env(as.list(new$rd[[1]]))
     
     old <- topics[[new$filename]]
     topics[[new$filename]] <- if (is.null(old)) new$rd else merge(old, new$rd)"
r-lib,roxygen2,9a593f6e4c740fa68a516c62b8dad33fd1f4297b,hadley,h.wickham@gmail.com,2011-07-13T14:43:17Z,hadley,h.wickham@gmail.com,2011-07-13T14:43:17Z,Add @noRd. Fixes #12,R/roclet-rd.R;inst/tests/test-had.R,False,True,True,False,16,0,16,"---FILE: R/roclet-rd.R---
@@ -32,6 +32,10 @@ register.preref.parsers(parse.name.description,
 register.preref.parsers(parse.name,
                         'docType')
 
+register.preref.parsers(parse.default,
+                        'noRd')
+
+
 register.srcref.parser('<-', function(call, env) {
   assignee <- call[[2]]
   value <- eval(assignee, env)
@@ -306,6 +310,8 @@ roclet_rd_one <- function(partitum, base_path) {
     ""details"", ""introduction""))
   if (!has_rd) return()
   
+  if (any(names(partitum) == ""noRd"")) return()
+  
   # Figure out topic name
   name <- partitum$name %||% partitum$S4class %||% partitum$S4method %||%
     partitum$S4generic

---FILE: inst/tests/test-had.R---
@@ -167,6 +167,16 @@ test_that(""@title overrides default title"", {
   expect_equal(get_tag(out, ""description"")$values, ""Would be title"")
 })
 
+test_that(""@noRd inhibits documentation"", {
+  out <- roc_proc_text(roc, ""
+    #' Would be title
+    #' @title Overridden title
+    #' @name a
+    #' @noRd
+    NULL"")
+  
+  expect_equal(length(out), 0)
+})
 
 test_that(""question mark ends sentence"", {
   out <- roc_proc_text(roc, """
r-lib,roxygen2,e76c0ba2048328edf157a780dd17075098472273,hadley,h.wickham@gmail.com,2011-07-13T14:15:03Z,hadley,h.wickham@gmail.com,2011-07-13T14:15:03Z,Fix bug in template merging,R/template.R,False,True,True,False,1,1,2,"---FILE: R/template.R---
@@ -32,7 +32,7 @@ process_templates <- function(partitum, base_path) {
   results <- lapply(paths, template_eval, vars = list2env(vars))
   
   # Insert templates back in the location where they came from
-  partitum_pieces <- as.list(partitum)
+  partitum_pieces <- lapply(partitum, list)
   partitum_pieces[template_locs] <- lapply(results, parse.preref)
   names(partitum_pieces)[template_locs] <- """"
   "
r-lib,roxygen2,cf16b24bf4e4c6dfa5c6304eea3c400056bf77f9,hadley,h.wickham@gmail.com,2011-07-13T02:34:31Z,hadley,h.wickham@gmail.com,2011-07-13T02:34:31Z,Move todos to github issues,README;TODO;TODO.md,False,False,False,False,0,337,337,"---FILE: README---
@@ -1,7 +1,6 @@
 all' hileth', Hephaiste; didou d'areten te kai olbon.*
 --Homer, 7th century BCE
 
-
 1. Roxygen
 
 1.1. Execution
@@ -33,46 +32,6 @@ all' hileth', Hephaiste; didou d'areten te kai olbon.*
 
   On Windows, however, you may need to rename the directory.
 
-1.2. TODO
-
-  * Create some automatic method for detecting S3 methods without
-    resorting to @method <generic> <class>.
-
-  * Edit the R emacs mode to identify roxygen delimiters when filling,
-    etc.
-
-    * The ESS team is working on it; loosened up the line-delimiter
-      to include ""#+'"".
-
-  * Find a reasonable way to document the inner functions of
-    make.roclet, etc.
-
-  * Move demos from `sandbox' to `demos'.
-
-  * @defunct, @deprecated, @internal
-
-  * Alias roclet-specific tags to make.*.roclet; and built-in tags
-    to an ad-hoc explanation.
-
-1.3. BUGS
-
-  * @import, @importFrom, @importClassesFrom, @importMethodsFrom should
-    update the `Depends' field in DESCRIPTION; or should we have separate
-    @depends, @suggests, @imports, @enhances?
-
-  * parse.formals doesn't distinguish between no default argument and
-    NULL; need a special value?
-
-  * Skeletal Rds are created for assignments without Roxygen-blocks;
-    desirable?
-
-  * first.sentence is fooled by infix periods, whereupon it resorts to
-    `...'.
-
-  * de.tex doesn't work recursively (i.e. de-TeXs only the top level).
-
-  * `<<' in titles produces a spurious box.
-
 1.4. THANKS
 
   * Tobias Verbeke, for catching an unadorned URL.

---FILE: TODO---
@@ -1,249 +0,0 @@
-# -*- mode: org; -*-
-* DONE merge hadley's code, create roxygen2.
-  CLOSED: [2011-07-06 Wed 19:40]
-  - CLOSING NOTE [2011-07-06 Wed 19:40] \\
-    Done on 2.0 branch; waiting for HEAD's word.
-* CANCELED replace questionable characters without =Curry=.
-  CLOSED: [2011-07-06 Wed 19:41]
-  #+BEGIN_SRC R :tangle replace-characters.R :shebang #!/usr/local/bin/R --vanilla --slave -f
-    library(gsubfn)
-    library(functional)
-    
-    ##' Substitutions of questionable characters with a hacker-joke to
-    ##' boot.
-    substitutions=c(
-      `!`='bang',
-      `""`='quote',
-      `#`='hash',
-      `$`='cash',                           # sigil
-      `%`='grapes',
-      `&`='and',
-      `'`='single-quote',
-      `(`='open-paren',
-      `)`='close-paren',
-      `*`='star',
-      `+`='plus',
-      `,`='comma',
-      `-`='dash',
-      `.`='dot',
-      `/`='slash',
-      `:`='colon',
-      `;`='semi-colon',
-      `<`='less-than',
-      `=`='equals',
-      `>`='greater-than',
-      `?`='p',
-      `@`='asperand',
-      `[`='open-brace',
-      `\\`='backslash',
-      `]`='close-brace',
-      `^`='hat',
-      `_`='sub',
-      '`'='backtick',                       # let's add another ` to
-                                            # rectify syntax highlighting
-                                            # in emacs; thanks.
-      `{`='open-curly',
-      `|`='pipe',
-      `}`='close',
-      `~`='not'
-      )
-    
-    ##' \code{NULL} if empty-string.
-    ##' @param string string to check
-    ##' @return \code{NULL} or identity
-    nil_if_lambda <- function(string)
-      if (nchar(string)) string else NULL
-    
-    ##' Translate file-system-questionable characters (i.e. punctuation
-    ##' within ASCII).
-    ##' @param filename the filename to translate
-    ##' @return the translated filename
-    translate_questionable_characters <- function(filename)
-      do.call(Curry(paste, collapse=""-""),
-              strapply(filename,
-                       pattern='([[:punct:]]|)([^[:punct:]]*|)',
-                       function(punctuation, letters)
-                       c(substitutions[nil_if_lambda(punctuation)],
-                         nil_if_lambda(letters))))
-    
-    translate_questionable_characters('%||%')
-    
-  #+END_SRC
-* TODO switch to =codetools=
-* TODO switch to the =exec= method of install an =R CMD=
-  see e.g. [[http://cran.r-project.org/web/packages/ant/index.html][ant]].
-* TODO how to convert an existing package at top of vignette
-* TODO distinguish between =arg=NULL= and no default arg
-* TODO document all tags
-  when using roxygen, i have to resort to reading code to get the full
-  list of tags; which should never have to be.
-
-* TODO @encoding tag
-* DONE named signature arg in =setMethod=
-  CLOSED: [2011-03-23 Wed 03:19]
-  - CLOSING NOTE [2011-03-23 Wed 03:19] \\
-    this was caused, apparently, by conflicting registrations of the
-    srcref parsers. solved, i believe, for the Rd case (but not the
-    Rd2 case).
-  #+BEGIN_SRC R :noweb yes :tangle test-named-signature.R
-    <<preamble>>
-    
-    capture.output(make.Rd.roclet()$parse('sandbox/example-S4-person.R'))
-    
-  #+END_SRC
-* DONE handling double-quotes in default args
-  CLOSED: [2011-03-21 Mon 02:53]
-  =read.table=; also, =NULL=.
-
-  #+BEGIN_SRC R :noweb yes :tangle test-default-args.R
-    <<preamble>>
-    
-    test_that(""double quotes are escaped appropriately"", {
-      expect.rd(c(""\\name{lambda}"",
-                  ""\\alias{lambda}"",
-                  ""\\title{lambda}"",
-                  ""\\usage{lambda(a=\""\\\""'\"", b)}""),
-                ""lambda <- function(a=\""\\\""'\"", b=NULL) NA"")
-    })
-    
-  #+END_SRC
-* DONE preamble for testing code
-  CLOSED: [2011-03-21 Mon 02:53]
-  hadley had some automatic way of doing this once; i think we had to
-  revert to manual sourcing because of collation, though.
-  
-  #+srcname: preamble
-  #+BEGIN_SRC R
-    library(gsubfn)
-    library(testthat)
-    
-    source('R/functional.R')
-    source('R/list.R')
-    source('R/roxygen.R')
-    source('R/string.R')
-    source('R/memoize.R')
-    source('R/parse.R')
-    source('R/parseS4.R')
-    source('R/roclet.R')
-    source('R/callgraph.R')
-    source('R/description.R')
-    source('R/collate.R')
-    source('R/namespace.R')
-    source('R/Rd.R')
-    source('R/Rdmerge.R')
-    source('R/Rdapi.R')
-    source('R/Rdtank.R')
-    source('R/Rd2.R')
-    source('R/roxygenize.R')
-    
-    capture.roclet.output <- function(roclet, ...)
-      capture.output(roclet$parse.parsed(parse.text(...)))
-    
-    expect.rd <- function(expected, ...)
-      expect_equal(expected, capture.roclet.output(make.Rd.roclet(), ...))
-    
-  #+END_SRC
-* DONE ignore *~
-  CLOSED: [2011-03-12 Sat 17:18]
-  - CLOSING NOTE [2011-03-12 Sat 17:18] \\
-    looks like this is already the case.
-* DONE translate filenames with non-alphabetic characters
-  CLOSED: [2011-03-10 Thu 18:58]
-  need translations for:
-
-  - =!=
-  - ""
-  - =#=
-  - =$=
-  - =%=
-  - =&=
-  - '
-  - =(=
-  - =)=
-  - =*=
-  - =+=
-  - ,
-  - =-=
-  - =.=
-  - =/=
-  - =:=
-  - =;=
-  - =<=
-  - =
-  - =>=
-  - =?=
-  - =@=
-  - =[=
-  - =\=
-  - =]=
-  - =^=
-  - =_=
-  - =`=
-  - ={=
-  - =|=
-  - =}=
-  - =~=
-
-  not going to touch unicode.
-
-  #+BEGIN_SRC R :tangle test-substitution.R :shebang #!/usr/bin/env Rscript
-    library(gsubfn)
-    library(functional)
-    library(RUnit)
-    
-    substitutions=c(
-      `!`='bang',
-      `""`='quote',
-      `#`='hash',
-      `$`='money',
-      `%`='grapes',
-      `&`='and',
-      `'`='single-quote',
-      `(`='open-paren',
-      `)`='close-paren',
-      `*`='star',
-      `+`='plus',
-      `,`='comma',
-      `-`='dash',
-      `.`='dot',
-      `/`='slash',
-      `:`='colon',
-      `;`='semi-colon',
-      `<`='less-than',
-      `=`='equals',
-      `>`='greater-than',
-      `?`='p',
-      `@`='asperand',
-      `[`='open-brace',
-      `\\`='backslash',
-      `]`='close-brace',
-      `^`='hat',
-      `_`='sub',
-      '`'='backtick',                       # let's add another ` to
-                                            # rectify syntax highlighting
-                                            # in emacs; thanks.
-      `{`='open-curly',
-      `|`='pipe',
-      `}`='close',
-      `~`='not'
-      )
-    
-    nil.if.lambda <- function(string)
-      if (nchar(string)) string else NULL
-    
-    translate.questionable.characters <- function(filename)
-      do.call(Curry(paste, collapse=""-""),
-              strapply(filename,
-                       pattern='([[:punct:]]|)([^[:punct:]]*|)',
-                       function(punctuation, letters)
-                       c(substitutions[nil.if.lambda(punctuation)],
-                         nil.if.lambda(letters))))
-    
-    checkEquals(translate.questionable.characters('ha@@o'),
-                'ha-asperand-asperand-o')
-    checkEquals(translate.questionable.characters('nonquestionable'),
-                'nonquestionable')
-    checkEquals(translate.questionable.characters(''),
-                '')
-    
-  #+END_SRC

---FILE: TODO.md---
@@ -1,47 +0,0 @@
-* Write S4 test cases:
-  generic documentation
-  class documentation
-  method documentation - individual, class, generic
-
-* In roxygenise, run roclets that don't need run time code first - that way
-  collate can be run first to figure out the order in which the files should
-  be loaded
-
-* @method should automatically inherit parameter documentation from generics
-  (if available)?
-
-* if @docType package, automatically create the correct aliases
-
-* if @docType data, automatically add dataset keyword, format and usage.
-
-# Reducing duplication
-
-* @family tag for automatically generating seealso for related functions?
-  Would create seealso that listed all functions except the current function
-  in that family.  Functions could belong to multiple families.
-  
-        @family a
-        @family b
-        ->
-        \seealso{Other related functions of family ""a"": \code{\link{x}}, y, z}
-        
-  Would require parse through all partitum (caching issues?)
-
-* Start with `@inheritParam package::functionname` or `@inheritParam topic`.  
-
-  Works either with roxygen topic in current package, or Rd for topic in
-  another package.  Determined based on whether :: used in the parameter name.
-  
-  For roxygen topic:
-    * need to topologically sort topics.
-    * requires that names be preprocessed
-    * (and adds another caching dependency)
-  
-  For Rd topic:
-    * need to find file for that topic
-    * need to parse file and extract list of arguments.
-  
-  Eventually need to do this automatically for methods: inherit from generic.
-
-* Suggests that we may want user specifiable plugins for rd_roclet (like there
-  were before!) that you can choose between."
r-lib,roxygen2,c31a95da9bef3faace49459cf13361bb011fded5,hadley,h.wickham@gmail.com,2011-07-13T00:38:57Z,hadley,h.wickham@gmail.com,2011-07-13T00:38:57Z,Fix for invert for zero length cases,R/roclet-rd.R,False,True,True,False,4,1,5,"---FILE: R/roclet-rd.R---
@@ -214,7 +214,10 @@ roc_process.had <- function(roclet, partita, base_path) {
   }
   
   # Second parse through to process @family
-  invert <- function(x) unstack(rev(stack(x)))
+  invert <- function(x) {
+    if (length(x) == 0) return()
+    unstack(rev(stack(x)))
+  }
   get_values <- function(topics, tag) {
     tags <- lapply(topics, get_tag, tag)
     tags <- Filter(Negate(is.null), tags)"
r-lib,roxygen2,a7cec2ba2862f3bc482b0da4fadb1c3007147be1,hadley,h.wickham@gmail.com,2011-07-12T00:28:56Z,hadley,h.wickham@gmail.com,2011-07-12T00:28:56Z,Try checkRd because it sometimes throws error,R/roclet-rd.R,False,True,True,False,1,1,2,"---FILE: R/roclet-rd.R---
@@ -272,7 +272,7 @@ roc_output.had <- function(roclet, results, base_path) {
     } else {
       cat(sprintf('Writing %s\n', name))
       writeLines(contents, filename)    
-      checkRd(filename)
+      try(checkRd(filename))
     }
     
   }"
r-lib,roxygen2,51b0a9b8f59585f84e5b484bedb642ad270cdf10,hadley,h.wickham@gmail.com,2011-07-05T18:20:45Z,hadley,h.wickham@gmail.com,2011-07-05T18:20:45Z,Fix typo,R/roclet-rd.R;R/template.R,False,True,True,False,2,2,4,"---FILE: R/roclet-rd.R---
@@ -190,7 +190,7 @@ rd_out_cache <- new_cache()
 roc_process.had <- function(roclet, partita, base_path) {
   # Remove srcrefs with no attached roxygen comments
   partita <- Filter(function(x) length(x) > 1, partita)
-  templates <- dir(file.path(base_path, ""roxygen-man""), full = TRUE)
+  templates <- dir(file.path(base_path, ""max-roxygen""), full = TRUE)
   template_hash <- digest(lapply(templates, readLines))
   
   topics <- list()

---FILE: R/template.R---
@@ -2,7 +2,7 @@ register.preref.parsers(parse.value, ""template"")
 register.preref.parsers(parse.name.description, ""templateVar"")
 
 template_find <- function(base_path, template_name) {
-  path <- file.path(base_path, ""roxygen-man"", str_c(template_name, "".R""))
+  path <- file.path(base_path, ""man-roxygen"", str_c(template_name, "".R""))
   if (!file.exists(path)) {
     stop(""Can not find template "", template_name, call. = FALSE)
   } "
r-lib,roxygen2,4d367091d124000ec3ddd9b8882677ffa802cdb0,hadley,h.wickham@gmail.com,2011-07-03T20:30:44Z,hadley,h.wickham@gmail.com,2011-07-03T20:30:44Z,Fix typo revealed by R CMD check,R/rd-file-api.R,False,True,True,False,1,1,2,"---FILE: R/rd-file-api.R---
@@ -25,7 +25,7 @@ format.rd_file <- function(x, ...) {
 }
 
 #' @S3method merge rd_file
-merge.rd_file <- function(x, y, ..) {
+merge.rd_file <- function(x, y, ...) {
   rd <- new_rd_file()
   for(tag_x in as.list(x[[1]])) {
     add_tag(rd, tag_x)"
r-lib,roxygen2,94526656178d3cf7dbd4fe5ef0e8e16c75d66d3b,hadley,h.wickham@gmail.com,2011-07-03T20:29:13Z,hadley,h.wickham@gmail.com,2011-07-03T20:29:13Z,Fix caching bugs,R/roclet-rd.R;R/topo-sort.R;inst/tests/collate/watch.R,False,True,True,False,4,3,7,"---FILE: R/roclet-rd.R---
@@ -114,7 +114,7 @@ roc_process.had <- function(roclet, partita, base_path) {
   
   topics <- list()
   for (partitum in partita) {
-    new <- rd_proc_cache$compute(partitum, roclet_rd_one(partitum))    
+    new <- rd_proc_cache$compute(partitum, roclet_rd_one(partitum, base_path))    
     if (is.null(new)) next; 
     
     old <- topics[[new$filename]]
@@ -123,7 +123,7 @@ roc_process.had <- function(roclet, partita, base_path) {
   topics
 }
 
-roclet_rd_one <- function(partitum) {
+roclet_rd_one <- function(partitum, base_path) {
   rd <- new_rd_file()
   
   has_rd <- any(names(partitum) %in% c(""description"", ""param"", ""return"",

---FILE: R/topo-sort.R---
@@ -49,7 +49,6 @@ topo_sort <- function() {
         visit(vertex)        
       }
     }
-
     vapply(sorted, function(x) x$file, character(1))
   }
   

---FILE: inst/tests/collate/watch.R---
@@ -1 +1,3 @@
 NULL
+
+x <- 2
\ No newline at end of file"
r-lib,roxygen2,c9c4a230c874a4d53cd509593b51a080329a5b75,hadley,h.wickham@gmail.com,2011-07-03T14:40:21Z,hadley,h.wickham@gmail.com,2011-07-03T14:40:21Z,Rearrange parse-preref and fix dumb bug,R/parse-preref.R;R/parse.R,False,True,True,False,30,26,56,"---FILE: R/parse-preref.R---
@@ -1,3 +1,28 @@
+# Parse a preref
+parse.preref <- function(ref) {
+  lines <- str_trim(getSrcLines(attributes(ref)$srcfile, ref[[1]], ref[[3]]))
+  
+  delimited.lines <- lines[str_detect(lines, LINE.DELIMITER)]
+  trimmed.lines <- str_trim(str_replace(delimited.lines, LINE.DELIMITER, """"))
+
+  if (length(trimmed.lines) == 0) return(list())
+
+  joined.lines <- str_c(trimmed.lines, collapse = '\n')
+  ## Thanks to Fegis at #regex on Freenode for the
+  ## lookahead/lookbehind hack; as he notes, however, ""it's not
+  ## proper escaping though... it will not split a@@@b.""
+  elements <- strsplit(joined.lines, '(?<!@)@(?!@)', perl = TRUE)[[1]]
+
+  ## Compress the escaped delimeters.
+  elements <- str_replace_all(elements, fixed(""@@""), ""@"")
+
+  parsed.description <- parse.description(elements[[1]])
+  parsed.elements <- unlist(lapply(elements[-1], parse.element), 
+    recursive = FALSE)
+  
+  c(parsed.description, parsed.elements)
+} 
+
 # Sequence that distinguishes roxygen comment from normal comment.
 LINE.DELIMITER <- '#+\''
 
@@ -37,7 +62,7 @@ parse.element <- function(element) {
   tag <- pieces[, 1]
   rest <- pieces[, 2]
   
-  tag_parser <- preref.parsers[[tag]] %||% parse.preref 
+  tag_parser <- preref.parsers[[tag]] %||% parse.unknown 
   tag_parser(tag, rest)
 }
 
@@ -72,7 +97,7 @@ parse.default <- function(key, rest)
 # @return A list containing the key and expression (possibly
 # null)
 # @seealso \code{\link{parse.default}}
-parse.preref <- function(key, rest) {
+parse.unknown <- function(key, rest) {
   warning(key, ' is an unknown key', call. = FALSE)
   parse.default(key, rest)
 }
@@ -142,27 +167,3 @@ parse.name <- function(key, name) {
 #' @export
 parse.toggle <- function(key, rest)
   as.list(structure(TRUE, names=key))
-
-# Parse a preref
-parse.preref <- function(ref) {
-  lines <- str_trim(getSrcLines(attributes(ref)$srcfile, ref[[1]], ref[[3]]))
-  delimited.lines <- lines[str_detect(lines, LINE.DELIMITER)]
-  trimmed.lines <- str_trim(str_replace(delimited.lines, LINE.DELIMITER, """"))
-
-  if (length(trimmed.lines) == 0) return(list())
-
-  joined.lines <- str_c(trimmed.lines, collapse = '\n')
-  ## Thanks to Fegis at #regex on Freenode for the
-  ## lookahead/lookbehind hack; as he notes, however, ""it's not
-  ## proper escaping though... it will not split a@@@b.""
-  elements <- strsplit(joined.lines, '(?<!@)@(?!@)', perl = TRUE)[[1]]
-
-  ## Compress the escaped delimeters.
-  elements <- str_replace_all(elements, fixed(""@@""), ""@"")
-
-  parsed.description <- parse.description(elements[[1]])
-  parsed.elements <- unlist(lapply(elements[-1], parse.element), 
-    recursive = FALSE)
-  
-  c(parsed.description, parsed.elements)
-} 

---FILE: R/parse.R---
@@ -14,6 +14,9 @@ parse.file <- function(file, env) {
   
   src_parsed <- lapply(src_refs, parse.srcref, env = env)
   pre_parsed <- lapply(pre_refs, parse.preref)
+  
+  stopifnot(length(src_parsed) == length(pre_parsed))
+  
   mapply(c, src_parsed, pre_parsed, SIMPLIFY = FALSE)
 }
 "
r-lib,roxygen2,39efc107ca9b5e3c8101f068bc8a2f082eaa575e,hadley,h.wickham@gmail.com,2011-07-02T15:08:31Z,hadley,h.wickham@gmail.com,2011-07-02T15:08:31Z,"Introduce @rdname test case in roxygen
And fix bugs",R/parse-registry.R;R/parse.R;R/rd-file-api.R;man/register-parser.Rd;man/register.srcref.parser.Rd,False,True,True,False,15,33,48,"---FILE: R/parse-registry.R---
@@ -5,26 +5,21 @@ if (!exists(""preref.parsers"")) {
   srcref.parsers <- new.env(parent=emptyenv())
 }
 
-#' Specifically register a preref parser
+#' Register parsers.
 #'
 #' @param key the key upon which to register
 #' @param parser the parser callback to register;
 #' a function taking \code{key} and \code{expression}
 #' @return \code{NULL}
 #' @export
 #' @keywords internal
+#' @rdname register-parser
 register.preref.parser <- function(key, parser) {
   preref.parsers[[key]] <- parser
 }
 
-#' Specifically register a srcref parser
-#'
-#' @param key the key upon which to register
-#' @param parser the parser callback to register;
-#' a function taking \code{key} and \code{expression}
-#' @return \code{NULL}
 #' @export
-#' @keywords internal
+#' @rdname register-parser
 register.srcref.parser <- function(key, parser) {
   srcref.parsers[[key]] <- parser
 }

---FILE: R/parse.R---
@@ -42,7 +42,7 @@ parse.element <- function(element) {
   
   tag <- pieces[, 1]
   rest <- pieces[, 2]
-
+  
   do.call(parser.preref(tag), list(tag, rest))
 }
 
@@ -149,7 +149,7 @@ parse.toggle <- function(key, rest)
 # Preref parser-lookup; defaults to \code{parse.preref}.
 # @param key the key upon which to look
 # @return The parser
-parser.preref <- function(key, default) {
+parser.preref <- function(key, default = parse.preref) {
   preref.parsers[[key]] %||% default
 }
 

---FILE: R/rd-file-api.R---
@@ -31,7 +31,11 @@ add_tag <- function(file, tag) {
   stopifnot(is.rd_tag(tag))
   
   existing <- file[[1]][[tag$tag]]
-  file[[1]][[tag$tag]] <- if (is.null(existing)) tag else merge(existing, tag)
+  if (is.null(existing)) {
+    file[[1]][[tag$tag]] <- tag 
+  } else {
+    file[[1]][[tag$tag]] <- merge(existing, tag)[[1]]
+  }
 
   invisible()
 }
\ No newline at end of file

---FILE: man/register-parser.Rd---
@@ -1,8 +1,11 @@
 \name{register.preref.parser}
 \alias{register.preref.parser}
-\title{Specifically register a preref parser...}
+\alias{register.srcref.parser}
+\title{Register parsers.}
 \usage{
   register.preref.parser(key, parser)
+
+  register.srcref.parser(key, parser)
 }
 \arguments{
   \item{key}{the key upon which to register}
@@ -14,7 +17,7 @@
   \code{NULL}
 }
 \description{
-  Specifically register a preref parser
+  Register parsers.
 }
 \keyword{internal}
 

---FILE: man/register.srcref.parser.Rd---
@@ -1,20 +0,0 @@
-\name{register.srcref.parser}
-\alias{register.srcref.parser}
-\title{Specifically register a srcref parser...}
-\usage{
-  register.srcref.parser(key, parser)
-}
-\arguments{
-  \item{key}{the key upon which to register}
-
-  \item{parser}{the parser callback to register; a function
-  taking \code{key} and \code{expression}}
-}
-\value{
-  \code{NULL}
-}
-\description{
-  Specifically register a srcref parser
-}
-\keyword{internal}
-"
r-lib,roxygen2,45fdb20084b814bc480d907b27f0b85cf70b4bde,hadley,h.wickham@gmail.com,2011-07-01T21:28:24Z,hadley,h.wickham@gmail.com,2011-07-01T21:28:24Z,Fixes for R CMD check,NAMESPACE;R/parse.R;R/roclet.R;man/roc_proc_text.Rd;tests/test-all.R,False,True,True,False,33,4,37,"---FILE: NAMESPACE---
@@ -16,6 +16,7 @@ export(register.preref.parsers)
 export(register.srcref.parser)
 export(register.srcref.parsers)
 export(roc_out)
+export(roc_proc_text)
 export(roc_proc)
 export(roxygenise)
 export(roxygenize)

---FILE: R/parse.R---
@@ -157,8 +157,7 @@ parser.preref <- Curry(parser.default,
 # @param key the key upon which to look
 # @return The parser
 parser.srcref <- Curry(parser.default,
-                       table=srcref.parsers,
-                       default=parse.srcref)
+                       table=srcref.parsers)
 
 #' Parse either srcrefs, prerefs or pairs of the same.
 #'

---FILE: R/roclet.R---
@@ -23,6 +23,21 @@ roc_proc <- function(roclet, paths, base_path) {
   roc_process(roclet, parsed, base_path)
 } 
 
+#' Process roclet on string and capture results.
+#' Useful for testing.
+#'
+#' @param roclet to use for processing
+#' @param input source string
+#' @export
+#' @keywords internal
+roc_proc_text <- function(roclet, input) {
+  stopifnot(is.roclet(roclet))
+  
+  parsed <- parse.text(input)
+  roc_process(roclet, parsed, base_path = ""."")
+} 
+
+
 #' Process roclet and output results.
 #' 
 #' @param roclet to use for processing

---FILE: man/roc_proc_text.Rd---
@@ -0,0 +1,14 @@
+\name{roc_proc_text}
+\alias{roc_proc_text}
+\title{Process roclet on string and capture results.}
+\usage{roc_proc_text(roclet, input)}
+\arguments{
+  \item{roclet}{to use for processing}
+  \item{input}{source string}
+}
+\description{
+  Process roclet on string and capture results. Useful for
+  testing.
+}
+\keyword{internal}
+

---FILE: tests/test-all.R---
@@ -1,4 +1,4 @@
 library(testthat)
-library(rxygen)
+library(rxygn)
 
-test_package(""rxygen"")
\ No newline at end of file
+test_package(""rxygn"")
\ No newline at end of file"
r-lib,roxygen2,559c13a839bce742fd77fa7465ff86cc1bbef78c,hadley,h.wickham@gmail.com,2011-07-01T19:02:25Z,hadley,h.wickham@gmail.com,2011-07-01T20:24:40Z,"Get collation tests working
And not conincidentally fix a few bugs",R/roclet-collate.R;R/roclet-had.R;R/roclet.R;inst/tests/test-collate.R,False,True,True,False,53,44,97,"---FILE: R/roclet-collate.R---
@@ -32,85 +32,92 @@ roc_process.collate <- function(roclet, partita, base_path) {
   vertices <- make_vertices()
   
   for (partitum in partita) {
-    file <- basename(partitum$srcref$filename)
+    file <- base_path(partitum$srcref$filename, base_path)
     vertex <- vertices$add(file)
-
-    if (!is.null(partitum$include)) {
-      file <- str_trim(file)
-      vertices$add(file)
-      vertices$add_ancestor(vertex, file)
+    
+    includes <- partitum[names(partitum) == ""include""]
+    if (length(includes) > 0) {
+      for (include in includes) {
+        vertices$add_ancestor(vertex, include)
+      }
     }
   }
 
   sorted <- vertices$topological_sort()
-  names <- basename(sapply(sorted, function(x) x$file))
-  paste(sprintf(""'%s'"", names), collapse = "" "")
+  unique(basename(sapply(sorted, function(x) x$file)))
 }
                                   
 #' @S3method roc_output collate
 roc_output.collate <- function(roclet, results, base_path) {
   DESCRIPTION <- file.path(base_path, ""DESCRIPTION"")
   old <- read.description(DESCRIPTION)
   new <- old
-  new$Collate <- results
+  new$Collate <- str_c(""'"", results, ""'"", collapse = "" "")
   write.description(new, DESCRIPTION)
   
   if (!identical(old, read.description(DESCRIPTION))) {
     cat('Updating collate directive in ', DESCRIPTION, ""\n"")
   }    
 }
 
+base_path <- function(path, base) {
+  path <- normalizePath(path)
+  base <- normalizePath(base)
+  
+  str_replace(path, fixed(str_c(base, ""/"")), """")
+}
+
 make_vertices <- function() {
   vertices <- NULL
 
   make.vertex <- function(file) {
-    vertex <- new.env(parent=emptyenv())
-    vertex$file <- str_trim(file)
+    vertex <- new.env(parent = emptyenv())
+    vertex$file <- file
     vertex$discovered <- FALSE
     vertex$ancestors <- NULL
     vertex
   }
 
   maybe.append.vertex <- function(file) {
     if (is.null(vertices[[file]])) {
-      vertices <<- append(vertices, 
-        as.list(structure(c(make.vertex(file)), names=file)))
+      vertices[[file]] <<- make.vertex(file)
     }
     vertices[[file]]
   }
 
   member <- function(ancestor, ancestors) {
     for (vertex in ancestors)
       if (identical(ancestor, vertex))
-        return(TRUE)
+        TRUE
     FALSE
   }
   
-  get_vertex <- function(file) {
-    vertices[[file]]
-  }
-
   maybe.append.ancestor <- function(predecessor, ancestor_name) {
-    ancestor <- vertices[[ancestor_name]]
+    ancestor <- maybe.append.vertex(ancestor_name)
     
-    if (!member(ancestor, predecessor$ancestors))
-      predecessor$ancestors <-
-        append(ancestor, predecessor$ancestors)
+    if (!member(ancestor, predecessor$ancestors)) {
+      predecessor$ancestors <- append(ancestor, predecessor$ancestors)
+    }
   }
 
 
   topological.sort <- function() {
     sorted <- NULL
     visit <- function(predecessor) {
       predecessor$discovered <- TRUE
-      for (ancestor in predecessor$ancestors)
-        if (!ancestor$discovered)
+      for (ancestor in predecessor$ancestors) {
+        if (!ancestor$discovered) {
           visit(ancestor)
+        }
+      }
       sorted <<- append(sorted, predecessor)
     }
-    for (vertex in vertices)
-      if (!vertex$discovered)
-        visit(vertex)
+    
+    for (vertex in vertices) {
+      if (!vertex$discovered) {
+        visit(vertex)        
+      }
+    }
 
     sorted
   }

---FILE: R/roclet-had.R---
@@ -53,6 +53,9 @@ had_roclet <- function() {
 
 #' @S3method roc_process had
 roc_process.had <- function(roclet, partita, base_path) {
+  # Remove srcrefs with no attached roxygen comments
+  partita <- Filter(function(x) length(x) > 1, partita)
+  
   topics <- list()
   for (partitum in partita) {
     has_rd <- any(names(partitum) %in% c(""description"", ""param"", ""return"",

---FILE: R/roclet.R---
@@ -20,9 +20,7 @@ roc_proc <- function(roclet, paths, base_path) {
   stopifnot(is.roclet(roclet))
   
   parsed <- parse.files(paths)
-  # Remove srcrefs with no attached roxygen comments
-  contents <- Filter(function(x) length(x) > 1, parsed)
-  roc_process(roclet, contents, base_path)
+  roc_process(roclet, parsed, base_path)
 } 
 
 #' Process roclet and output results.

---FILE: inst/tests/test-collate.R---
@@ -2,18 +2,19 @@ context(""Collation"")
 
 test_that(""collation as expected"", {
 
-  roclet <- collate_roclet()
-  collation <- capture.output(roclet$parse('collate/belt.R',
-                                           'collate/jacket.R',
-                                           'collate/pants.R',
-                                           'collate/shirt.R',
-                                           'collate/shoes.R',
-                                           'collate/socks.R',
-                                           'collate/tie.R',
-                                           'collate/undershorts.R',
-                                           'collate/watch.R'))
-                                           
-  collation <- gsub(""\\s +"", "" "", paste(collation, collapse = """"))
-  expect_equal(collation,
-    c(""Collate: 'collate/shirt.R' 'collate/undershorts.R' 'collate/pants.R' 'collate/belt.R' 'collate/tie.R' 'collate/jacket.R' 'collate/socks.R' 'collate/shoes.R' 'collate/watch.R'""))
+  results <- roc_proc(collate_roclet(), dir(""collate"", full = TRUE), ""."")
+  names <- str_replace(basename(results), ""\\..*$"", """")
+
+  before <- function(a, b) {
+    all(which(names %in% a) < which(names %in% b))
+  }
+
+  expect_true(before(""undershorts"", ""pants""))
+  expect_true(before(c(""tie"", ""belt""), ""jacket""))
+  expect_true(before(c(""socks"", ""undershorts"", ""pants""), ""shoes""))
+  
+  expected <- c('shirt.R', 'undershorts.R','pants.R', 'belt.R', 'tie.R',
+    'jacket.R', 'socks.R', 'shoes.R', 'watch.R')
+
+  expect_equal(results, expected)
 })
\ No newline at end of file"
r-lib,roxygen2,540211d1ff2d4af70bc849b6dc0b81d39d3267e8,hadley,h.wickham@gmail.com,2011-07-01T17:13:01Z,hadley,h.wickham@gmail.com,2011-07-01T17:13:01Z,Fixes for R CMD check,DESCRIPTION;R/roclet-collate.R;R/roclet-had.R;R/roclet-namespace.R;R/roclet.R;R/roxygen.R;R/roxygenize.R;man/make.roclet.Rd;man/roc_out.Rd;man/roc_proc.Rd;man/roxygen-package.Rd;man/roxygenize.Rd;tests/test-all.R,False,True,True,False,43,76,119,"---FILE: DESCRIPTION---
@@ -11,6 +11,8 @@ Maintainer: Hadley Wickham <hadley@rice.edu>
 Imports:
     stringr (>= 0.5),
     memoise
+Suggests:
+    testthat
 Depends:
     digest
 Collate:

---FILE: R/roclet-collate.R---
@@ -28,7 +28,7 @@ collate_roclet <- function() {
 }
 
 #' @S3method roc_process collate
-roc_process.collate <- function(roclet, partita) {
+roc_process.collate <- function(roclet, partita, base_path) {
   vertices <- make_vertices()
   
   for (partitum in partita) {
@@ -48,8 +48,8 @@ roc_process.collate <- function(roclet, partita) {
 }
                                   
 #' @S3method roc_output collate
-roc_output.collate <- function(roclet, results, path) {
-  DESCRIPTION <- file.path(path, ""DESCRIPTION"")
+roc_output.collate <- function(roclet, results, base_path) {
+  DESCRIPTION <- file.path(base_path, ""DESCRIPTION"")
   old <- read.description(DESCRIPTION)
   new <- old
   new$Collate <- results

---FILE: R/roclet-had.R---
@@ -52,7 +52,7 @@ had_roclet <- function() {
 }
 
 #' @S3method roc_process had
-roc_process.had <- function(roclet, partita) {
+roc_process.had <- function(roclet, partita, base_path) {
   topics <- list()
   for (partitum in partita) {
     has_rd <- any(names(partitum) %in% c(""description"", ""param"", ""return"",
@@ -101,16 +101,16 @@ roc_process.had <- function(roclet, partita) {
         process.split('keyword', param)
       }),
       process_had_tag(partitum, 'TODO', process.todo),
-      process.examples(partitum)
+      process.examples(partitum, base_path)
     )
     topics[[filename]] <- rd
   }
   topics
 }
 
 #' @S3method roc_output had
-roc_output.had <- function(roclet, results, path) { 
-  man <- normalizePath(file.path(path, ""man""))
+roc_output.had <- function(roclet, results, base_path) { 
+  man <- normalizePath(file.path(base_path, ""man""))
   contents <- vapply(results, paste, character(1), collapse = """")
   
   write_out <- function(filename, contents) {
@@ -206,7 +206,7 @@ process.arguments <- function(partitum) {
 
 # If \code{@@examples} is provided, use that; otherwise, concatenate
 # the files pointed to by each \code{@@example}.
-process.examples <- function(partitum) {
+process.examples <- function(partitum, base_path) {
   if (!is.null(partitum$examples)) {      
     ex <- partitum$examples
     ex <- gsub(""([%\\])"", ""\\\\\\1"", ex)
@@ -216,7 +216,7 @@ process.examples <- function(partitum) {
   
   paths <- partitum[names(partitum) == ""example""]
   if (length(paths) > 0) {
-    paths <- file.path(package.dir, str_trim(paths))
+    paths <- file.path(base_path, str_trim(paths))
     examples <- unlist(lapply(readLines, paths))
     
     return(rd_tag('examples', str_c(examples, collapse = ""\n"")))

---FILE: R/roclet-namespace.R---
@@ -75,7 +75,7 @@ namespace_roclet <- function() {
 }
 
 #' @S3method roc_process namespace
-roc_process.namespace <- function(roclet, partita) {
+roc_process.namespace <- function(roclet, partita, base_path) {
   ns <- character()
   for (partitum in partita) {
     ns_one <- c( 
@@ -98,8 +98,8 @@ roc_process.namespace <- function(roclet, partita) {
 
 
 #' @S3method roc_output namespace
-roc_output.namespace <- function(roclet, results, path) { 
-  NAMESPACE <- file.path(path, ""NAMESPACE"")
+roc_output.namespace <- function(roclet, results, base_path) { 
+  NAMESPACE <- file.path(base_path, ""NAMESPACE"")
   
   new <- sort(unique(results))
   old <- readLines(NAMESPACE)
@@ -116,17 +116,17 @@ ns_directive <- function(tag, parms) {
 }
 
 ns_default <- function(tag, parms, all) {
-  directive(tag, words(parms))
+  ns_directive(tag, words(parms))
 }
 ns_exportClass <- function(tag, parms, all) {
-  directive('exportClasses', parms)
+  ns_directive('exportClasses', parms)
 }
 ns_exportMethod <- function(tag, parms, all) {
-  directive('exportMethods', parms)
+  ns_directive('exportMethods', parms)
 }
 ns_export <- function(tag, parms, all) {
   if (!is.null.string(parms)) {
-    return(directive('export', words(parms)))
+    return(ns_directive('export', words(parms)))
   }
   
   if (!is.null(all$S4method)) {
@@ -142,7 +142,7 @@ ns_export <- function(tag, parms, all) {
     if (is.null(name)) {
       warning('Empty export directive')
     } else {
-      directive('export', quote_if_needed(name))
+      ns_directive('export', quote_if_needed(name))
     }
   }
 }
@@ -151,11 +151,11 @@ ns_S3method <- function(tag, parms, all) {
   if (length(params) != 2) {
     warning(""Invalid @S3method: "", parms, call. = FALSE)
   }
-  directive(""S3method"", str_c(quote_if_needed(params), collapse = "",""))
+  ns_directive(""S3method"", str_c(quote_if_needed(params), collapse = "",""))
 }
 ns_importFrom <- function(tag, parms, all) {
   params <- words(parms)
-  directive(tag, str_c(params[1], "","", params[-1]))
+  ns_directive(tag, str_c(params[1], "","", params[-1]))
 }
 
 

---FILE: R/roclet.R---
@@ -12,39 +12,40 @@ is.roclet <- function(x) inherits(x, ""roclet"")
 #' 
 #' @param roclet to use for processing
 #' @param input character vector of paths to files to process
+#' @param base_path base directory 
 #' @seealso \code{\link{roxygenise}} for user-friendly interface
 #' @keywords internal
 #' @export
-roc_proc <- function(roclet, paths) {
+roc_proc <- function(roclet, paths, base_path) {
   stopifnot(is.roclet(roclet))
   
   parsed <- parse.files(paths)
   # Remove srcrefs with no attached roxygen comments
   contents <- Filter(function(x) length(x) > 1, parsed)
-  roc_process(roclet, contents)
+  roc_process(roclet, contents, base_path)
 } 
 
 #' Process roclet and output results.
 #' 
 #' @param roclet to use for processing
 #' @param input character vector of paths to files to process
-#' @param output_path base directory in which to save output
+#' @param base_path base directory in which to save output
 #' @keywords internal
 #' @seealso \code{\link{roxygenise}} for user-friendly interface
 #' @export
-roc_out <- function(roclet, input, path) {
+roc_out <- function(roclet, input, base_path) {
   stopifnot(is.roclet(roclet))
 
-  results <- roc_proc(roclet, input)
-  roc_output(roclet, results, path)
+  results <- roc_proc(roclet, input, base_path)
+  roc_output(roclet, results, base_path)
 }
 
 # Internal methods for processing and output
 
-roc_output <- function(roclet, results, path) {
+roc_output <- function(roclet, results, base_path) {
   UseMethod(""roc_output"", roclet)
 }
 
-roc_process <- function(roclet, partita) {
+roc_process <- function(roclet, partita, base_path) {
   UseMethod(""roc_process"", roclet)
 }

---FILE: R/roxygen.R---
@@ -11,16 +11,6 @@
 #' LazyLoad: \tab yes\cr
 #' }
 #'
-#' Roxygen is run on a package (hereafter <package>) by
-#' \command{R CMD roxygen <package>} or \command{Rcmd roxygen.sh <package>}
-#' on Windows. By default, it creates a directory \file{<package>.roxygen}
-#' with the complete package cum populated Rd files, \file{NAMESPACE}, etc.;
-#' but can also operate descructively on the package itself with the
-#' \option{-d} option.
-#'
-#' See the vignette (\file{roxygen.pdf}) or manual (\file{roxygen-manual.pdf})
-#' for details.
-#'
 #' @author
 #' Peter Danenberg \email{pcd@@roxygen.org},
 #' Manuel Eugster \email{Manuel.Eugster@@stat.uni-muenchen.de}
@@ -31,13 +21,8 @@
 #' @title Literate Programming in R
 #' @keywords package
 #' @examples
-#' ## To process a package in `pkg', run `R CMD roxygen pkg'; or:
 #' \dontrun{roxygenize('pkg')}
-#' @seealso See \code{\link{make.Rd.roclet}}, 
-#' \code{\link{namespace_roclet}}, 
+#' @seealso See \code{\link{namespace_roclet}}, 
 #' \code{\link{collate_roclet}}, 
-#' \code{\link{make.callgraph.roclet}}
 #' for an overview of roxygen tags.
-#'
-#' See \code{\link{roxygenize}} for an alternative to `R CMD roxygen'.
 NULL

---FILE: R/roxygenize.R---
@@ -9,6 +9,7 @@
 #' @param unlink.target unlink target directory before processing files?
 #' @param roclets character vector of roclet names to apply to package
 #' @return \code{NULL}
+#' @aliases roxygenize roxygenise
 #' @export roxygenize roxygenise
 roxygenize <- function(package.dir,
                        roxygen.dir=package.dir,

---FILE: man/make.roclet.Rd---
@@ -1,8 +0,0 @@
-\name{make.roclet}
-\alias{make.roclet}
-\title{Abstract roclet that serves as a rudimentary API.}
-\usage{make.roclet(package.dir, process, output)}
-\description{
-  Abstract roclet that serves as a rudimentary API.
-}
-

---FILE: man/roc_out.Rd---
@@ -1,11 +1,11 @@
 \name{roc_out}
 \alias{roc_out}
 \title{Process roclet and output results.}
-\usage{roc_out(roclet, input, path)}
+\usage{roc_out(roclet, input, base_path)}
 \arguments{
   \item{roclet}{to use for processing}
   \item{input}{character vector of paths to files to process}
-  \item{output_path}{base directory in which to save output}
+  \item{base_path}{base directory in which to save output}
 }
 \description{
   Process roclet and output results.

---FILE: man/roc_proc.Rd---
@@ -1,10 +1,11 @@
 \name{roc_proc}
 \alias{roc_proc}
 \title{Process roclet and capture results.}
-\usage{roc_proc(roclet, paths)}
+\usage{roc_proc(roclet, paths, base_path)}
 \arguments{
   \item{roclet}{to use for processing}
   \item{input}{character vector of paths to files to process}
+  \item{base_path}{base directory}
 }
 \description{
   Process roclet and capture results.

---FILE: man/roxygen-package.Rd---
@@ -10,30 +10,14 @@
 \details{\tabular{ll}{ Package: \tab Roxygen\cr Type: \tab
   Package\cr Version: \tab 0.1-1\cr Date: \tab
   2008-08-25\cr License: \tab GPL (>= 2)\cr LazyLoad: \tab
-  yes\cr }
-
-  Roxygen is run on a package (hereafter <package>) by
-  \command{R CMD roxygen <package>} or \command{Rcmd
-  roxygen.sh <package>} on Windows. By default, it creates
-  a directory \file{<package>.roxygen} with the complete
-  package cum populated Rd files, \file{NAMESPACE}, etc.;
-  but can also operate descructively on the package itself
-  with the \option{-d} option.
-
-  See the vignette (\file{roxygen.pdf}) or manual
-  (\file{roxygen-manual.pdf}) for details.}
+  yes\cr }}
 \author{Peter Danenberg \email{pcd@roxygen.org},
 Manuel Eugster \email{Manuel.Eugster@stat.uni-muenchen.de}
 
 Maintainer: Peter Danenberg \email{pcd@roxygen.org}}
-\seealso{See \code{\link{make.Rd.roclet}},
-\code{\link{namespace_roclet}},
+\seealso{See \code{\link{namespace_roclet}},
 \code{\link{collate_roclet}},
-\code{\link{make.callgraph.roclet}}
-for an overview of roxygen tags.
-
-See \code{\link{roxygenize}} for an alternative to `R CMD roxygen'.}
+for an overview of roxygen tags.}
 \keyword{package}
-\examples{## To process a package in `pkg', run `R CMD roxygen pkg'; or:
-\dontrun{roxygenize('pkg')}}
+\examples{\dontrun{roxygenize('pkg')}}
 

---FILE: man/roxygenize.Rd---
@@ -1,5 +1,6 @@
 \name{roxygenize}
 \alias{roxygenize}
+\alias{roxygenise}
 \title{Process a package with the Rd, namespace and collate roclets.}
 \usage{roxygenize(package.dir, roxygen.dir = package.dir,
     copy.package = package.dir != roxygen.dir, overwrite =

---FILE: tests/test-all.R---
@@ -1,4 +1,4 @@
 library(testthat)
-library(roxygen)
+library(rxygen)
 
-test_package(""roxygen"")
\ No newline at end of file
+test_package(""rxygen"")
\ No newline at end of file"
r-lib,roxygen2,79d6b3640d6a2ebd22d23de85871bf0b7af27f0c,hadley,h.wickham@gmail.com,2011-07-01T17:06:24Z,hadley,h.wickham@gmail.com,2011-07-01T17:06:24Z,More bug fixing,R/roclet-namespace.R,False,True,True,False,5,5,10,"---FILE: R/roclet-namespace.R---
@@ -130,13 +130,13 @@ ns_export <- function(tag, parms, all) {
   }
   
   if (!is.null(all$S4method)) {
-    exportMethod(NULL, all$S4method)
+    ns_exportMethod(NULL, all$S4method)
   } else if (!is.null(all$S4class)) {
-    exportClass(NULL, all$S4class)
+    ns_exportClass(NULL, all$S4class)
   } else if (!is.null(all$S4generic)){
-    exportMethod(NULL, all$S4generic)
+    ns_exportMethod(NULL, all$S4generic)
   } else if (!is.null(all$method)) {
-    directive(""S3method"", str_c(unlist(all$method), collapse = "",""))
+    ns_S3method(parms = str_c(unlist(all$method), collapse = "" ""))
   } else {
     name <- all$name %||% all$assignee
     if (is.null(name)) {
@@ -151,7 +151,7 @@ ns_S3method <- function(tag, parms, all) {
   if (length(params) != 2) {
     warning(""Invalid @S3method: "", parms, call. = FALSE)
   }
-  directive(tag, str_c(params, collapse = "",""))
+  directive(""S3method"", str_c(quote_if_needed(params), collapse = "",""))
 }
 ns_importFrom <- function(tag, parms, all) {
   params <- words(parms)"
r-lib,roxygen2,62b9f7364084f758e14beede8b1da5c5d7b2ed8a,hadley,h.wickham@gmail.com,2011-07-01T16:57:38Z,hadley,h.wickham@gmail.com,2011-07-01T16:57:38Z,Bug fixing,R/roclet-had.R;R/roclet-namespace.R,False,True,True,False,8,9,17,"---FILE: R/roclet-had.R---
@@ -231,10 +231,10 @@ process.todo <- function(key, value) {
 }
 
 process_had_tag <- function(partitum, tag, f = rd_tag) {
-  params <- partitum[[tag]]
-  if (is.null(params)) return()
-  
-  f(tag, params)
+  matches <- partitum[names(partitum) == tag]
+  if (length(matches) == 0) return()
+
+  unlist(lapply(matches, function(p) f(tag, p)))
 }
 
 

---FILE: R/roclet-namespace.R---
@@ -153,20 +153,19 @@ ns_S3method <- function(tag, parms, all) {
   }
   directive(tag, str_c(params, collapse = "",""))
 }
-ns_importFrom <- function(tag, parms) {
+ns_importFrom <- function(tag, parms, all) {
   params <- words(parms)
   directive(tag, str_c(params[1], "","", params[-1]))
 }
 
 
 process_tag <- function(partitum, tag, f) {
-  params <- partitum[[tag]]
-  if (is.null(params)) return()
+  matches <- partitum[names(partitum) == tag]
+  if (length(matches) == 0) return()
   
-  f(tag, params, partitum)
+  unlist(lapply(matches, f, tag = tag, all = partitum))
 }
   
-  
 words <- function(x) {
   quote_if_needed(str_split(str_trim(x), ""\\s+"")[[1]])
 }"
r-lib,roxygen2,964757b4015c95c432b552a6a6a7c346fc5c9d39,hadley,h.wickham@gmail.com,2011-07-01T14:05:59Z,hadley,h.wickham@gmail.com,2011-07-01T14:05:59Z,Install and fix bugs,R/list.R;man/collate_roclet.Rd;man/had_roclet.Rd;man/make.roclet.Rd;man/namespace_roclet.Rd;man/parse.default.Rd;man/parse.file.Rd;man/parse.files.Rd;man/parse.name.Rd;man/parse.name.description.Rd;man/parse.ref.Rd;man/parse.ref.list.Rd;man/parse.ref.preref.Rd;man/parse.ref.srcref.Rd;man/parse.text.Rd;man/parse.toggle.Rd;man/parse.value.Rd;man/register.parser.Rd;man/register.parsers.Rd;man/register.preref.parser.Rd;man/register.preref.parsers.Rd;man/register.srcref.parser.Rd;man/register.srcref.parsers.Rd;man/roxygen-package.Rd;man/roxygenize.Rd,False,True,True,False,26,2,28,"---FILE: R/list.R---
@@ -25,10 +25,10 @@ pairwise <- function(list) {
   length <- length(list)
   if (length < 2)
     return(list())
-  length <- ifelse(is.odd(length),
+  length <- ifelse(length %% 2 == 1,
                    length - 1,
                    length)
   odds <- seq(1, length, 2)
   evens <- seq(2, length, 2)
-  zip.c(list[odds], list[evens])
+  zip(c, list[odds], list[evens])
 }

---FILE: man/collate_roclet.Rd---
@@ -40,3 +40,4 @@ NULL
 
 roclet <- collate_roclet()
 \dontrun{roclet$parse.dir('example')}}
+

---FILE: man/had_roclet.Rd---
@@ -8,3 +8,4 @@
   of this topic with contents of specific topic, silently
   dropping name and title components. }
 }
+

---FILE: man/make.roclet.Rd---
@@ -28,3 +28,4 @@ file has been parsed}
   \item{post.files}{a callback function with no arguments; called after every
 file has been parsed}
 }
+

---FILE: man/namespace_roclet.Rd---
@@ -76,3 +76,4 @@ fun <- function() {}
 
 roclet <- namespace_roclet()
 \dontrun{roclet$parse('example.R')}}
+

---FILE: man/parse.default.Rd---
@@ -15,3 +15,4 @@
   \item{key}{the parsing key}
   \item{rest}{the expression to be parsed}
 }
+

---FILE: man/parse.file.Rd---
@@ -11,3 +11,4 @@
 \arguments{
   \item{file}{string naming file to be parsed}
 }
+

---FILE: man/parse.files.Rd---
@@ -12,3 +12,4 @@
 \arguments{
   \item{\dots}{files to be parsed}
 }
+

---FILE: man/parse.name.Rd---
@@ -14,3 +14,4 @@
   \item{key}{parsing key}
   \item{name}{the name to be parsed}
 }
+

---FILE: man/parse.name.description.Rd---
@@ -13,3 +13,4 @@
   \item{key}{the parsing key}
   \item{rest}{the expression to be parsed}
 }
+

---FILE: man/parse.ref.Rd---
@@ -12,3 +12,4 @@
   \item{ref}{the srcref, preref or pair of the same}
   \item{\dots}{ignored}
 }
+

---FILE: man/parse.ref.list.Rd---
@@ -12,3 +12,4 @@
   \item{ref}{the preref/srcref pair}
   \item{\dots}{ignored}
 }
+

---FILE: man/parse.ref.preref.Rd---
@@ -12,3 +12,4 @@
   \item{ref}{the preref to be parsed}
   \item{\dots}{ignored}
 }
+

---FILE: man/parse.ref.srcref.Rd---
@@ -12,3 +12,4 @@
   \item{ref}{the srcref to be parsed}
   \item{\dots}{ignored}
 }
+

---FILE: man/parse.text.Rd---
@@ -11,3 +11,4 @@
 \arguments{
   \item{\dots}{lines of text to be parsed}
 }
+

---FILE: man/parse.toggle.Rd---
@@ -12,3 +12,4 @@
   \item{key}{parsing key}
   \item{rest}{the expression to be parsed}
 }
+

---FILE: man/parse.value.Rd---
@@ -12,3 +12,4 @@
   \item{key}{the parsing key}
   \item{rest}{the expression to be parsed}
 }
+

---FILE: man/register.parser.Rd---
@@ -14,3 +14,4 @@
   \item{parser}{the parser callback to register;
 a function taking \code{key} and \code{expression}}
 }
+

---FILE: man/register.parsers.Rd---
@@ -13,3 +13,4 @@
   \item{parser}{the parser to register}
   \item{\dots}{the keys upon which to register}
 }
+

---FILE: man/register.preref.parser.Rd---
@@ -13,3 +13,4 @@
   \item{parser}{the parser callback to register;
 a function taking \code{key} and \code{expression}}
 }
+

---FILE: man/register.preref.parsers.Rd---
@@ -11,3 +11,4 @@
   \item{parser}{the parser to register}
   \item{\dots}{the keys upon which to register}
 }
+

---FILE: man/register.srcref.parser.Rd---
@@ -13,3 +13,4 @@
   \item{parser}{the parser callback to register;
 a function taking \code{key} and \code{expression}}
 }
+

---FILE: man/register.srcref.parsers.Rd---
@@ -11,3 +11,4 @@
   \item{parser}{the parser to register}
   \item{\dots}{the keys upon which to register}
 }
+

---FILE: man/roxygen-package.Rd---
@@ -40,3 +40,4 @@ for an overview of roxygen tags.
 See \code{\link{roxygenize}} for an alternative to `R CMD roxygen'.}
 \examples{## To process a package in `pkg', run `R CMD roxygen pkg'; or:
 \dontrun{roxygenize('pkg')}}
+

---FILE: man/roxygenize.Rd---
@@ -21,3 +21,4 @@ files.}
   \item{unlink.target}{unlink target directory before processing files?}
   \item{roclets}{character vector of roclet names to apply to package}
 }
+"
r-lib,roxygen2,c1e09ae2a005528e1568e982959280db52f0fec7,hadley,h.wickham@gmail.com,2011-06-30T15:52:35Z,hadley,h.wickham@gmail.com,2011-06-30T15:52:35Z,Fix documentation bugs,NAMESPACE;R/Rd.R;R/Rd2.R;R/callgraph.R;R/had.R;R/namespace.R;R/roclet.R;R/roxygenize.R;man/make.Rd.roclet.Rd;man/make.Rd2.roclet.Rd;man/make.callgraph.roclet.Rd;man/make.namespace.roclet.Rd;man/make.roclet.Rd,False,True,True,False,148,150,298,"---FILE: NAMESPACE---
@@ -28,4 +28,4 @@ export(make.Rd2.roclet)
 export(make.roclet)
 export(expression.from.partitum)
 export(roxygen)
-export(roxygenize, roxyngenise)
+export(roxygenize, roxygenise)

---FILE: R/Rd.R---
@@ -74,52 +74,52 @@ register.srcref.parser('setMethod',
 #' }
 #'
 #' \enumerate{
-#' \item{\code{@@author}}{See \dQuote{2.1.1 Documenting functions} from
-#'                        \cite{Writing R Extensions}.}
-#' \item{\code{@@aliases}}{A default alias is plucked from the \code{@@name} or
+#' \item \code{@@author}: See \dQuote{2.1.1 Documenting functions} from
+#'                        \cite{Writing R Extensions}.
+#' \item \code{@@aliases}: A default alias is plucked from the \code{@@name} or
 #'                         assignee; otherwise, \code{@@alias a b ...} translates
 #'                         to \code{\\alias{a}}, \code{\\alias{b}}, &c.
-#'                         If you specify one alias, however, specify them all.}
-#' \item{\code{@@concept}}{See \dQuote{2.8 Indices} from
-#'                         \cite{Writing R Extensions}.}
-#' \item{\code{@@example}}{Each \code{@@example} tag specifies an example file
+#'                         If you specify one alias, however, specify them all.
+#' \item \code{@@concept}: See \dQuote{2.8 Indices} from
+#'                         \cite{Writing R Extensions}.
+#' \item \code{@@example}: Each \code{@@example} tag specifies an example file
 #'                         relative to the package head; if the file resides in
 #'                         \file{tests}, for instance, it will be checked with
 #'                         \command{R CMD check}.
 #'                         The contents of the file will
-#'                         be concatenated under \code{\\examples{...}}.}
-#' \item{\code{@@examples}}{Verbatim examples; see \dQuote{2.1.1
+#'                         be concatenated under \code{\\examples{...}}.
+#' \item \code{@@examples}: Verbatim examples; see \dQuote{2.1.1
 #'                          Documenting functions} from \cite{Writing R
-#'                          Extensions}.}
-#' \item{\code{@@format}}{See \dQuote{2.1.2 Documenting data sets} from
-#'                        \cite{Writing R Extensions}.}
-#' \item{\code{@@keywords}}{\code{@@keywords a b ...} translates to
-#'                          \code{\\keyword{a}}, \code{\\keyword{b}}, &c.}
-#' \item{\code{@@method}}{Use \code{@@method <generic> <class>} to document
-#'                        S3 functions.}
-#' \item{\code{@@name}}{In the absense of an explicit \code{@@name} tag, the
-#'                      name of an assignment is plucked from the assignee.}
-#' \item{\code{@@note}}{See \dQuote{2.1.1 Documenting functions} from
-#'                      \cite{Writing R Extensions}.}
-#' \item{\code{@@param}}{Each function variable should have a
-#'                       \code{@@param <variable> <description>} specified.}
-#' \item{\code{@@references}}{See \dQuote{2.1.1 Documenting functions} from
-#'                            \cite{Writing R Extensions}.}
-#' \item{\code{@@return}}{The return value of the function, or \code{NULL}.}
-#' \item{\code{@@seealso}}{See \dQuote{2.1.1 Documenting functions} from
-#'                         \cite{Writing R Extensions}.}
-#' \item{\code{@@source}}{See \dQuote{2.1.2 Documenting data sets} from
-#'                        \cite{Writing R Extensions}.}
-#' \item{\code{@@title}}{A default title is plucked from the first sentence
+#'                          Extensions}.
+#' \item \code{@@format}: See \dQuote{2.1.2 Documenting data sets} from
+#'                        \cite{Writing R Extensions}.
+#' \item \code{@@keywords}: \code{@@keywords a b ...} translates to
+#'                          \code{\\keyword{a}}, \code{\\keyword{b}}, &c.
+#' \item \code{@@method}: Use \code{@@method <generic> <class>} to document
+#'                        S3 functions.
+#' \item \code{@@name}: In the absense of an explicit \code{@@name} tag, the
+#'                      name of an assignment is plucked from the assignee.
+#' \item \code{@@note}: See \dQuote{2.1.1 Documenting functions} from
+#'                      \cite{Writing R Extensions}.
+#' \item \code{@@param}: Each function variable should have a
+#'                       \code{@@param <variable> <description>} specified.
+#' \item \code{@@references}: See \dQuote{2.1.1 Documenting functions} from
+#'                            \cite{Writing R Extensions}.
+#' \item \code{@@return}: The return value of the function, or \code{NULL}.
+#' \item \code{@@seealso}: See \dQuote{2.1.1 Documenting functions} from
+#'                         \cite{Writing R Extensions}.
+#' \item \code{@@source}: See \dQuote{2.1.2 Documenting data sets} from
+#'                        \cite{Writing R Extensions}.
+#' \item \code{@@title}: A default title is plucked from the first sentence
 #'                       of the description; that is, the first phrase ending
 #'                       with a period, question mark or newline.
 #'                       In the absence of a description, the title becomes
 #'                       the \code{@@name} or assignee; lastly, it can be
-#'                       overridden with \code{@@title}.}
-#' \item{\code{@@TODO}}{Note to developers to get off their asses.}
-#' \item{\code{@@usage}}{A default usage is construed from a function's formals,
+#'                       overridden with \code{@@title}.
+#' \item \code{@@TODO}: Note to developers to get off their asses.
+#' \item \code{@@usage}: A default usage is constructed from a function's formals,
 #'                       but can be overridden with \code{@@usage} (e.g. in the case
-#'                       of multiple functions in one Rd unit).}
+#'                       of multiple functions in one Rd unit).
 #' }
 #'
 #' @param package.dir the package's top directory

---FILE: R/Rd2.R---
@@ -62,11 +62,11 @@ register.srcref.parser('setMethod',
 #' tags are:
 #' 
 #' \enumerate{
-#' \item{\code{@@nord}}{Suppress Rd creation.}
-#' \item{\code{@@rdname}}{Definition of the Rd name; blocks with the same
-#'                        \code{@@rdname} are merged into one Rd file.}
-#' \item{\code{@@slot}}{Each S4 class slot should have a
-#'                      \code{@@slot <name> <description>} specified.}
+#' \item \code{@@nord}: Suppress Rd creation.
+#' \item \code{@@rdname}: Definition of the Rd name; blocks with the same
+#'                        \code{@@rdname} are merged into one Rd file.
+#' \item \code{@@slot}: Each S4 class slot should have a
+#'                      \code{@@slot <name> <description>} specified.
 #' }
 #'
 #' @param package.dir the package's top directory

---FILE: R/callgraph.R---
@@ -18,12 +18,12 @@ register.preref.parsers(parse.toggle,
 #' The callgraph roclet supports the following tags:
 #'
 #' \enumerate{
-#' \item{\code{@@callGraph}}{Create a call graph of the default
-#'   depth, excluding primitive functions.}
-#' \item{\code{@@callGraphPrimitives}}{Create a call graph of the
-#'   default depth, including primitive functions.}
-#' \item{\code{@@callGraphDepth}}{Change the depth of the callgraph
-#'   from the default of 2.}
+#' \item \code{@@callGraph}: Create a call graph of the default
+#'   depth, excluding primitive functions.
+#' \item \code{@@callGraphPrimitives}: Create a call graph of the
+#'   default depth, including primitive functions.
+#' \item \code{@@callGraphDepth}: Change the depth of the callgraph
+#'   from the default of 2.
 #' }
 #'
 #' The callgraph roclet is awkward in the sense that
@@ -42,10 +42,10 @@ register.preref.parsers(parse.toggle,
 #' @param verbose anounce what we're doing
 #' @export
 #' @TODO \itemize{
-#' \item{index.html}{\file{index.html} in \file{inst/doc} for
-#' callgraphs, possibly with thumbnails in png}
-#' \item{Text-only option}{Option for text-only callgraphs
-#' (which are clearer, in my opinion)}
+#' \item \code{index.html}: \file{index.html} in \file{inst/doc} for
+#' callgraphs, possibly with thumbnails in png
+#' \item Text-only option: Option for text-only callgraphs
+#' (which are clearer, in my opinion)
 #' }
 #' @aliases make.callgraph.roclet callGraph callGraphPrimitives
 #' callGraphDepth

---FILE: R/had.R---
@@ -220,10 +220,9 @@ make.had.roclet <- function(package.dir,
     if (length(formals) == 0) return()
     
     args <- usage(formals)
-    usage <- paste(parse.function.name(partitum), ""("", args, "")"", sep = """")
+    usage <- str_c(parse.function.name(partitum), ""("", args, "")"")
     
-    parse.expression('usage', 
-      paste(strwrap(usage, width = 60, exdent = 4), collapse = ""\n""))
+    parse.expression('usage', str_wrap(usage, width = 60, exdent = 4))
   }
 
   #' Prefer explicit \code{@@usage} to a \code{@@formals} list.

---FILE: R/namespace.R---
@@ -39,28 +39,28 @@ register.preref.parsers(parse.value,
 #' }
 #'
 #' \enumerate{
-#' \item{\code{@@export}}{May be specified with or without value;
+#' \item \code{@@export}: May be specified with or without value;
 #'                       if unadorned, roxygen will try to guess
 #'                       the exported value by assignee, \code{setMethod},
 #'                       \code{setClass}, etc. Otherwise,
 #'                       \code{@@export f g ...}
 #'                       translates to
-#'                       \code{export(f, g, ...)}.}
-#' \item{\code{@@exportClass}}{Overrides \code{setClass}.}
-#' \item{\code{@@exportMethod}}{Overrides \code{setMethod} or \code{setGeneric}.}
-#' \item{\code{@@exportPattern}}{See \dQuote{1.6.2 Registering S3 methods} from
-#'                               \cite{Writing R Extensions}.}
-#' \item{\code{@@S3method}}{Overrides the export of an S3 method.}
-#' \item{\code{@@import}}{See \dQuote{1.6.1 Specifying imports and exports}
-#'                        from \cite{Writing R Extensions}.}
-#' \item{\code{@@importFrom}}{See \dQuote{1.6.1 Specifying imports and exports}
-#'                            from \cite{Writing R Extensions}.}
-#' \item{\code{@@importClassesFrom}}{See \dQuote{1.6.6 Name spaces with formal
+#'                       \code{export(f, g, ...)}.
+#' \item \code{@@exportClass}: Overrides \code{setClass}.
+#' \item \code{@@exportMethod}: Overrides \code{setMethod} or \code{setGeneric}.
+#' \item \code{@@exportPattern}: See \dQuote{1.6.2 Registering S3 methods} from
+#'                               \cite{Writing R Extensions}.
+#' \item \code{@@S3method}: Overrides the export of an S3 method.
+#' \item \code{@@import}: See \dQuote{1.6.1 Specifying imports and exports}
+#'                        from \cite{Writing R Extensions}.
+#' \item \code{@@importFrom}: See \dQuote{1.6.1 Specifying imports and exports}
+#'                            from \cite{Writing R Extensions}.
+#' \item \code{@@importClassesFrom}: See \dQuote{1.6.6 Name spaces with formal
 #'                                   classes and methods} from \cite{Writing R
-#'                                   Extensions}.}
-#' \item{\code{@@importMethodsFrom}}{See \dQuote{1.6.6 Name spaces with formal
+#'                                   Extensions}.
+#' \item \code{@@importMethodsFrom}: See \dQuote{1.6.6 Name spaces with formal
 #'                                   classes and methods} from \cite{Writing R
-#'                                   Extensions}.}
+#'                                   Extensions}.
 #' }
 #'
 #' @param package.dir the package's top directory

---FILE: R/roclet.R---
@@ -6,11 +6,13 @@ roxygen()
 #' Abstract roclet that serves as a rudimentary API.
 #'
 #' Contains the following member functions:
-#' \itemize{\item{register.parser}{takes \code{key} and \code{parser}}
-#' \item{register.parsers}{takes \code{parser} and \code{keys}}
-#' \item{register.default.parser}{takes a \code{key}}
-#' \item{register.default.parsers}{take \code{parsers}}
-#' \item{parse}{parses material contained in files}}
+#' \itemize{
+#'   \item \code{register.parser}: takes \code{key} and \code{parser}
+#'   \item \code{register.parsers}: takes \code{parser} and \code{keys}
+#'   \item \code{register.default.parser}: takes a \code{key}
+#    \item \code{register.default.parsers}: take \code{parsers}
+#'   \item \code{parse} parses material contained in files
+#' }
 #'
 #' @param parse.default the default parser taking \code{key}
 #' and \code{value}

---FILE: R/roxygenize.R---
@@ -74,7 +74,7 @@ copy.dir <- function(source,
 #' @callGraphDepth 1
 #' @TODO Options to enable/disable specific roclet
 #' (\command{--no-callgraphs}, etc.)
-#' @export roxygenize roxyngenise
+#' @export roxygenize roxygenise
 roxygenize <- function(package.dir,
                        roxygen.dir=package.dir,
                        copy.package=package.dir != roxygen.dir,

---FILE: man/make.Rd.roclet.Rd---
@@ -34,51 +34,50 @@
   \code{@TODO} \tab \emph{n/a}\cr \code{@usage} \tab
   \code{\\usage}\cr }
 
-  \enumerate{ \item{\code{@author}}{See \dQuote{2.1.1
-  Documenting functions} from \cite{Writing R Extensions}.}
-  \item{\code{@aliases}}{A default alias is plucked from
+  \enumerate{ \item \code{@author}: See \dQuote{2.1.1
+  Documenting functions} from \cite{Writing R Extensions}.
+  \item \code{@aliases}: A default alias is plucked from
   the \code{@name} or assignee; otherwise, \code{@alias a b
   ...} translates to \code{\\alias{a}}, \code{\\alias{b}},
-  &c. If you specify one alias, however, specify them all.}
-  \item{\code{@concept}}{See \dQuote{2.8 Indices} from
-  \cite{Writing R Extensions}.} \item{\code{@example}}{Each
+  &c. If you specify one alias, however, specify them all.
+  \item \code{@concept}: See \dQuote{2.8 Indices} from
+  \cite{Writing R Extensions}. \item \code{@example}: Each
   \code{@example} tag specifies an example file relative to
   the package head; if the file resides in \file{tests},
   for instance, it will be checked with \command{R CMD
   check}. The contents of the file will be concatenated
-  under \code{\\examples{...}}.}
-  \item{\code{@examples}}{Verbatim examples; see
-  \dQuote{2.1.1 Documenting functions} from \cite{Writing R
-  Extensions}.} \item{\code{@format}}{See \dQuote{2.1.2
-  Documenting data sets} from \cite{Writing R Extensions}.}
-  \item{\code{@keywords}}{\code{@keywords a b ...}
-  translates to \code{\\keyword{a}}, \code{\\keyword{b}},
-  &c.} \item{\code{@method}}{Use \code{@method <generic>
-  <class>} to document S3 functions.}
-  \item{\code{@name}}{In the absense of an explicit
-  \code{@name} tag, the name of an assignment is plucked
-  from the assignee.} \item{\code{@note}}{See \dQuote{2.1.1
-  Documenting functions} from \cite{Writing R Extensions}.}
-  \item{\code{@param}}{Each function variable should have a
-  \code{@param <variable> <description>} specified.}
-  \item{\code{@references}}{See \dQuote{2.1.1 Documenting
-  functions} from \cite{Writing R Extensions}.}
-  \item{\code{@return}}{The return value of the function,
-  or \code{NULL}.} \item{\code{@seealso}}{See \dQuote{2.1.1
-  Documenting functions} from \cite{Writing R Extensions}.}
-  \item{\code{@source}}{See \dQuote{2.1.2 Documenting data
-  sets} from \cite{Writing R Extensions}.}
-  \item{\code{@title}}{A default title is plucked from the
-  first sentence of the description; that is, the first
-  phrase ending with a period, question mark or newline. In
-  the absence of a description, the title becomes the
+  under \code{\\examples{...}}. \item \code{@examples}:
+  Verbatim examples; see \dQuote{2.1.1 Documenting
+  functions} from \cite{Writing R Extensions}. \item
+  \code{@format}: See \dQuote{2.1.2 Documenting data sets}
+  from \cite{Writing R Extensions}. \item \code{@keywords}:
+  \code{@keywords a b ...} translates to
+  \code{\\keyword{a}}, \code{\\keyword{b}}, &c. \item
+  \code{@method}: Use \code{@method <generic> <class>} to
+  document S3 functions. \item \code{@name}: In the absense
+  of an explicit \code{@name} tag, the name of an
+  assignment is plucked from the assignee. \item
+  \code{@note}: See \dQuote{2.1.1 Documenting functions}
+  from \cite{Writing R Extensions}. \item \code{@param}:
+  Each function variable should have a \code{@param
+  <variable> <description>} specified. \item
+  \code{@references}: See \dQuote{2.1.1 Documenting
+  functions} from \cite{Writing R Extensions}. \item
+  \code{@return}: The return value of the function, or
+  \code{NULL}. \item \code{@seealso}: See \dQuote{2.1.1
+  Documenting functions} from \cite{Writing R Extensions}.
+  \item \code{@source}: See \dQuote{2.1.2 Documenting data
+  sets} from \cite{Writing R Extensions}. \item
+  \code{@title}: A default title is plucked from the first
+  sentence of the description; that is, the first phrase
+  ending with a period, question mark or newline. In the
+  absence of a description, the title becomes the
   \code{@name} or assignee; lastly, it can be overridden
-  with \code{@title}.} \item{\code{@TODO}}{Note to
-  developers to get off their asses.}
-  \item{\code{@usage}}{A default usage is construed from a
-  function's formals, but can be overridden with
-  \code{@usage} (e.g. in the case of multiple functions in
-  one Rd unit).} }
+  with \code{@title}. \item \code{@TODO}: Note to
+  developers to get off their asses. \item \code{@usage}: A
+  default usage is constructed from a function's formals,
+  but can be overridden with \code{@usage} (e.g. in the
+  case of multiple functions in one Rd unit). }
 }
 \value{Rd roclet}
 \alias{name}

---FILE: man/make.Rd2.roclet.Rd---
@@ -13,11 +13,11 @@
   See \code{\link{make.Rd.roclet}} for description and
   available tags; new tags are:
 
-  \enumerate{ \item{\code{@nord}}{Suppress Rd creation.}
-  \item{\code{@rdname}}{Definition of the Rd name; blocks
-  with the same \code{@rdname} are merged into one Rd
-  file.} \item{\code{@slot}}{Each S4 class slot should have
-  a \code{@slot <name> <description>} specified.} }
+  \enumerate{ \item \code{@nord}: Suppress Rd creation.
+  \item \code{@rdname}: Definition of the Rd name; blocks
+  with the same \code{@rdname} are merged into one Rd file.
+  \item \code{@slot}: Each S4 class slot should have a
+  \code{@slot <name> <description>} specified. }
 }
 \value{Rd roclet}
 \alias{nord}

---FILE: man/make.callgraph.roclet.Rd---
@@ -12,12 +12,12 @@
 \details{
   The callgraph roclet supports the following tags:
 
-  \enumerate{ \item{\code{@callGraph}}{Create a call graph
-  of the default depth, excluding primitive functions.}
-  \item{\code{@callGraphPrimitives}}{Create a call graph of
-  the default depth, including primitive functions.}
-  \item{\code{@callGraphDepth}}{Change the depth of the
-  callgraph from the default of 2.} }
+  \enumerate{ \item \code{@callGraph}: Create a call graph
+  of the default depth, excluding primitive functions.
+  \item \code{@callGraphPrimitives}: Create a call graph of
+  the default depth, including primitive functions. \item
+  \code{@callGraphDepth}: Change the depth of the callgraph
+  from the default of 2. }
 
   The callgraph roclet is awkward in the sense that it
   requires a function's package to be loadable; which
@@ -27,10 +27,10 @@
   again.
 }
 \section{TODO}{\itemize{
-\item{index.html}{\file{index.html} in \file{inst/doc} for
-callgraphs, possibly with thumbnails in png}
-\item{Text-only option}{Option for text-only callgraphs
-(which are clearer, in my opinion)}
+\item \code{index.html}: \file{index.html} in \file{inst/doc} for
+callgraphs, possibly with thumbnails in png
+\item Text-only option: Option for text-only callgraphs
+(which are clearer, in my opinion)
 }}
 \alias{make.callgraph.roclet}
 \alias{callGraph}

---FILE: man/make.namespace.roclet.Rd---
@@ -25,27 +25,26 @@
   \code{importClassesFrom}\cr \code{@importMethodsFrom}
   \tab \code{importMethodsFrom}\cr }
 
-  \enumerate{ \item{\code{@export}}{May be specified with
+  \enumerate{ \item \code{@export}: May be specified with
   or without value; if unadorned, roxygen will try to guess
   the exported value by assignee, \code{setMethod},
   \code{setClass}, etc. Otherwise, \code{@export f g ...}
-  translates to \code{export(f, g, ...)}.}
-  \item{\code{@exportClass}}{Overrides \code{setClass}.}
-  \item{\code{@exportMethod}}{Overrides \code{setMethod} or
-  \code{setGeneric}.} \item{\code{@exportPattern}}{See
+  translates to \code{export(f, g, ...)}. \item
+  \code{@exportClass}: Overrides \code{setClass}. \item
+  \code{@exportMethod}: Overrides \code{setMethod} or
+  \code{setGeneric}. \item \code{@exportPattern}: See
   \dQuote{1.6.2 Registering S3 methods} from \cite{Writing
-  R Extensions}.} \item{\code{@S3method}}{Overrides the
-  export of an S3 method.} \item{\code{@import}}{See
+  R Extensions}. \item \code{@S3method}: Overrides the
+  export of an S3 method. \item \code{@import}: See
   \dQuote{1.6.1 Specifying imports and exports} from
-  \cite{Writing R Extensions}.}
-  \item{\code{@importFrom}}{See \dQuote{1.6.1 Specifying
-  imports and exports} from \cite{Writing R Extensions}.}
-  \item{\code{@importClassesFrom}}{See \dQuote{1.6.6 Name
-  spaces with formal classes and methods} from
-  \cite{Writing R Extensions}.}
-  \item{\code{@importMethodsFrom}}{See \dQuote{1.6.6 Name
-  spaces with formal classes and methods} from
-  \cite{Writing R Extensions}.} }
+  \cite{Writing R Extensions}. \item \code{@importFrom}:
+  See \dQuote{1.6.1 Specifying imports and exports} from
+  \cite{Writing R Extensions}. \item
+  \code{@importClassesFrom}: See \dQuote{1.6.6 Name spaces
+  with formal classes and methods} from \cite{Writing R
+  Extensions}. \item \code{@importMethodsFrom}: See
+  \dQuote{1.6.6 Name spaces with formal classes and
+  methods} from \cite{Writing R Extensions}. }
 }
 \value{Namespace roclet}
 \alias{make.namespace.roclet}

---FILE: man/make.roclet.Rd---
@@ -10,13 +10,12 @@
 }
 
 \details{
-  Contains the following member functions:
-  \itemize{\item{register.parser}{takes \code{key} and
-  \code{parser}} \item{register.parsers}{takes
-  \code{parser} and \code{keys}}
-  \item{register.default.parser}{takes a \code{key}}
-  \item{register.default.parsers}{take \code{parsers}}
-  \item{parse}{parses material contained in files}}
+  Contains the following member functions: \itemize{ \item
+  \code{register.parser}: takes \code{key} and
+  \code{parser} \item \code{register.parsers}: takes
+  \code{parser} and \code{keys} \item
+  \code{register.default.parser}: takes a \code{key} \item
+  \code{parse} parses material contained in files }
 }
 \arguments{
   \item{parse.default}{the default parser taking \code{key}"
r-lib,roxygen2,157369e282e588e884449fd78c114b21e997f990,hadley,h.wickham@gmail.com,2011-06-30T15:20:21Z,hadley,h.wickham@gmail.com,2011-06-30T15:20:21Z,Fix long standing bug in collation order,DESCRIPTION;R/collate.R;R/had-utils.R;R/had.R;man/usage.Rd,False,True,True,False,35,26,61,"---FILE: DESCRIPTION---
@@ -15,37 +15,23 @@ Suggests:
     tools (>= 2.9.1)
 Collate:
     'functional.R'
-    'roclet.R'
+    'list.R'
     'roxygen.R'
-    'callgraph.R'
+    'string.R'
     'parse.R'
+    'roclet.R'
+    'callgraph.R'
     'description.R'
-    'string.R'
     'collate.R'
-    'list.R'
-    'description.R'
-    'functional.R'
     'had-utils.R'
     'had.R'
-    'list.R'
     'memoize.R'
     'namespace.R'
     'parse-cache.R'
-    'parse.R'
     'parseS4.R'
     'Rd.R'
     'Rdmerge.R'
     'Rdapi.R'
     'Rdtank.R'
-    'parseS4.R'
     'Rd2.R'
-    'Rdapi.R'
-    'Rdmerge.R'
-    'Rdtank.R'
-    'roclet.R'
-    'roxygen.R'
-    'collate.R'
-    'namespace.R'
-    'Rd.R'
     'roxygenize.R'
-    'string.R'

---FILE: R/collate.R---
@@ -99,7 +99,7 @@ make.collate.roclet <- function(package.dir,
   }
   
   pre.parse <- function(partitum) {
-    file <- partitum$srcref$filename
+    file <- basename(partitum$srcref$filename)
     maybe.append.vertex(file)
     vertex <- vertices[[file]]
     assign.parent('current.predecessor',

---FILE: R/had-utils.R---
@@ -0,0 +1,21 @@
+#' Given argument list, produce usage string for it.
+#' 
+#' Adapted from \code{\link{prompt}}.
+#'
+#' @param f function, or name of function, as string
+#' @return a string
+usage <- function(args) {
+  is.missing.arg <- function(arg) {
+    typeof(arg) == ""symbol"" && deparse(arg) == """"
+  }
+  arg_to_text <- function(arg) {
+    if (is.missing.arg(arg)) return("""")
+    text <- deparse(arg, backtick = TRUE, width.cutoff = 500L)
+    
+    paste("" = "", paste(text, collapse = ""\n""), sep = """")
+  }
+
+  arg_values <- vapply(args, arg_to_text, character(1))
+  
+  paste(names(args), arg_values, collapse = "", "", sep = """")
+}

---FILE: R/had.R---
@@ -215,9 +215,11 @@ make.had.roclet <- function(package.dir,
   #' @param partitum the pre-parsed elements
   #' @return \code{NULL}
   parse.formals <- function(partitum) {
-    
     formals <- partitum$formals
-    if (length(formals) > 0) {
+    if (length(formals) == 0) return()
+    
+    use <- usage(formals)
+      
       name.defaults <- zip.c(names(formals), formals)
       args <-
         do.call(paste, c(Map(function(name.default) {
@@ -242,7 +244,7 @@ make.had.roclet <- function(package.dir,
                                      args),
                              exdent=4, width = 60)),
                     sep='\n')))
-    }
+
   }
 
   #' Prefer explicit \code{@@usage} to a \code{@@formals} list.

---FILE: man/usage.Rd---
@@ -1,16 +1,16 @@
 \name{usage}
 \alias{usage}
-\title{Given function, produce usage string for it.}
-\usage{usage(name)}
+\title{Given argument list, produce usage string for it.}
+\usage{usage(args)}
 
 \description{
-  Given function, produce usage string for it.
+  Given argument list, produce usage string for it.
 }
 
 \details{
   Adapted from \code{\link{prompt}}.
 }
 \value{a string}
 \arguments{
-  \item{f}{name of function, as string}
+  \item{f}{function, or name of function, as string}
 }"
r-lib,roxygen2,8ea8c08dd884713bf6d4388b02d2217510b0e62b,hadley,h.wickham@gmail.com,2011-06-28T16:28:25Z,hadley,h.wickham@gmail.com,2011-06-28T16:28:25Z,Fix typo,R/parse.R,False,True,True,False,1,1,2,"---FILE: R/parse.R---
@@ -446,7 +446,7 @@ parse.file <- function(file) {
   
   res <- try(cached.parse.srcfile(srcfile), silent = TRUE)
   if (inherits(res, ""try-error"")) {
-    stop(""Can't pass"", file, ""\n"", res, call. = FALSE)
+    stop(""Can't parse "", file, ""\n"", res, call. = FALSE)
   }
   res
 }"
r-lib,roxygen2,f378ca6ee172cf59c6d24fc2b7e30ed5bb3721a2,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2010-08-05T17:15:36Z,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2010-08-05T17:15:36Z,"sd2-option patch

git-svn-id: svn+ssh://svn.r-forge.r-project.org/svnroot/roxygen@250 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",pkg/src/roxygen,False,False,False,False,10,3,13,"---FILE: pkg/src/roxygen---
@@ -19,20 +19,24 @@ the same or with -d (Destructive).
 Options:
   -d  (Destructive) operate in place on SOURCE
   -u       (Unlink) clean TARGET first
+  -s  (Rd2) enable parsing of S4 tags
 
   -h         (Help) print short help message and exit
   -v      (Version) print roxygen version info and exit
 
 Report bugs to <roxygen-devel@lists.r-forge.r-project.org>.""
 
-while getopts duhv OPT; do
+while getopts dushv OPT; do
     case $OPT in
         d|+d)
             destructive=""TRUE""
             ;;
         u|+u)
             unlink=""TRUE""
             ;;
+        s|+s)
+            rd2=""TRUE""
+            ;;
         h|+h)
             echo ${usage}
             exit 0
@@ -95,15 +99,18 @@ fi
 
 : ${unlink:=""FALSE""}
 : ${copy:=""TRUE""}
+: ${rd2:=""FALSE""}
 
 debug () {
-    echo source: ""${source}""\; target: ""${target}""\; copy: ""${copy}""\; unlink: ""${unlink}""
+    echo source: ""${source}""\; target: ""${target}""\; copy: ""${copy}""\; unlink: ""${unlink}""\; rd2: ""${rd2}""
 }
 
+
 R_EXE=""${R_HOME}/bin/R""
 echo ""library(roxygen)
       roxygenize(package.dir=${source},
                  roxygen.dir=${target},
                  copy.package=${copy},
-                 unlink.target=${unlink})"" | \
+                 unlink.target=${unlink},
+                 use.Rd2=${rd2})"" | \
     ""${R_EXE}"" --no-restore --slave"
r-lib,roxygen2,3dcc36a573028908c2de0911eb68c2ad30589e42,Peter Danenberg,pcd@roxygen.org,2010-08-05T17:15:36Z,Peter Danenberg,pcd@roxygen.org,2010-08-05T17:15:36Z,"sd2-option patch

git-svn-id: svn://svn.r-forge.r-project.org/svnroot/roxygen/pkg@250 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",src/roxygen,False,False,False,False,10,3,13,"---FILE: src/roxygen---
@@ -19,20 +19,24 @@ the same or with -d (Destructive).
 Options:
   -d  (Destructive) operate in place on SOURCE
   -u       (Unlink) clean TARGET first
+  -s  (Rd2) enable parsing of S4 tags
 
   -h         (Help) print short help message and exit
   -v      (Version) print roxygen version info and exit
 
 Report bugs to <roxygen-devel@lists.r-forge.r-project.org>.""
 
-while getopts duhv OPT; do
+while getopts dushv OPT; do
     case $OPT in
         d|+d)
             destructive=""TRUE""
             ;;
         u|+u)
             unlink=""TRUE""
             ;;
+        s|+s)
+            rd2=""TRUE""
+            ;;
         h|+h)
             echo ${usage}
             exit 0
@@ -95,15 +99,18 @@ fi
 
 : ${unlink:=""FALSE""}
 : ${copy:=""TRUE""}
+: ${rd2:=""FALSE""}
 
 debug () {
-    echo source: ""${source}""\; target: ""${target}""\; copy: ""${copy}""\; unlink: ""${unlink}""
+    echo source: ""${source}""\; target: ""${target}""\; copy: ""${copy}""\; unlink: ""${unlink}""\; rd2: ""${rd2}""
 }
 
+
 R_EXE=""${R_HOME}/bin/R""
 echo ""library(roxygen)
       roxygenize(package.dir=${source},
                  roxygen.dir=${target},
                  copy.package=${copy},
-                 unlink.target=${unlink})"" | \
+                 unlink.target=${unlink},
+                 use.Rd2=${rd2})"" | \
     ""${R_EXE}"" --no-restore --slave"
r-lib,roxygen2,d122daecbf831e10897e3f063ee6c3aeb82b5475,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2010-03-13T00:45:22Z,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2010-03-13T00:45:22Z,"otherwise, we get an error with closures

git-svn-id: svn+ssh://svn.r-forge.r-project.org/svnroot/roxygen@244 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",pkg/R/Rd.R,False,True,True,False,6,1,7,"---FILE: pkg/R/Rd.R---
@@ -299,7 +299,12 @@ make.Rd.roclet <- function(subdir=NULL,
   parse.formals <- function(partitum) {
     formals <- partitum$formals
     if (!is.null(formals)) {
-      name.defaults <- zip.c(names(formals), formals)
+      ## name.defaults <- zip.c(names(formals), formals)
+      name.defaults <-
+        zip.c(names(formals),
+              Map(function(formal) tryCatch(toString(formal),
+                                            error=function(e) '<closure>'),
+                  formals))
       args <-
         do.call(paste, c(Map(function(name.default) {
           name <- car(name.default)"
r-lib,roxygen2,f4edacea16a6479c7521f8fc19c2ba89c4be4e68,Peter Danenberg,pcd@roxygen.org,2010-03-13T00:45:22Z,Peter Danenberg,pcd@roxygen.org,2010-03-13T00:45:22Z,"otherwise, we get an error with closures

git-svn-id: svn://svn.r-forge.r-project.org/svnroot/roxygen/pkg@244 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",R/Rd.R,False,True,True,False,6,1,7,"---FILE: R/Rd.R---
@@ -299,7 +299,12 @@ make.Rd.roclet <- function(subdir=NULL,
   parse.formals <- function(partitum) {
     formals <- partitum$formals
     if (!is.null(formals)) {
-      name.defaults <- zip.c(names(formals), formals)
+      ## name.defaults <- zip.c(names(formals), formals)
+      name.defaults <-
+        zip.c(names(formals),
+              Map(function(formal) tryCatch(toString(formal),
+                                            error=function(e) '<closure>'),
+                  formals))
       args <-
         do.call(paste, c(Map(function(name.default) {
           name <- car(name.default)"
r-lib,roxygen2,79caa93eeaf60d9601ccb78fbfd273173a18e073,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2010-02-26T07:36:39Z,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2010-02-26T07:36:39Z,"TODO; which should really be in the bug tracker

git-svn-id: svn+ssh://svn.r-forge.r-project.org/svnroot/roxygen@243 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",pkg/TODO,False,False,False,False,4,0,4,"---FILE: pkg/TODO---
@@ -0,0 +1,4 @@
+# -*- mode: org; -*-
+* TODO document all tags
+  when using roxygen, i have to resort to reading code to get the full
+  list of tags; which should never have to be."
r-lib,roxygen2,37add414b62aae20eed76c34435e03afa3fcdcef,Peter Danenberg,pcd@roxygen.org,2010-02-26T07:36:39Z,Peter Danenberg,pcd@roxygen.org,2010-02-26T07:36:39Z,"TODO; which should really be in the bug tracker

git-svn-id: svn://svn.r-forge.r-project.org/svnroot/roxygen/pkg@243 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",TODO,False,False,False,False,4,0,4,"---FILE: TODO---
@@ -0,0 +1,4 @@
+# -*- mode: org; -*-
+* TODO document all tags
+  when using roxygen, i have to resort to reading code to get the full
+  list of tags; which should never have to be."
r-lib,roxygen2,cb74116bc90a3caaec8bc7ed9430af96787710c7,manuel,manuel@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2009-11-11T17:05:27Z,manuel,manuel@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2009-11-11T17:05:27Z,"Hadley's ""Cache parsing of srcrefs"" patch; Roxygen mailinglist 2009-09-10.

git-svn-id: svn+ssh://svn.r-forge.r-project.org/svnroot/roxygen@240 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",pkg/.Rbuildignore;pkg/DESCRIPTION;pkg/R/memoize.R;pkg/R/parse.R;pkg/man/parse.file.Rd;pkg/man/parse.ref.srcref.Rd,False,True,True,False,79,19,98,"---FILE: pkg/.Rbuildignore---
@@ -0,0 +1,2 @@
+sandbox
+patches
\ No newline at end of file

---FILE: pkg/DESCRIPTION---
@@ -5,11 +5,13 @@ Description: A Doxygen-like in-source documentation system for Rd,
     collation, namespace and callgraphs.
 Title: Literate Programming in R
 Author: Peter Danenberg <pcd@roxygen.org>, Manuel Eugster
-    <Manuel.Eugster@stat.uni-muenchen.de>
+    <Manuel.Eugster@stat.uni-muenchen.de> with contributions
+    from Hadley Wickham <hadley@rice.edu>
 Maintainer: Peter Danenberg <pcd@roxygen.org>
 URL: http://roxygen.org
+Depends: digest
 Suggests: Rgraphviz (>= 1.19.2), tools (>= 2.9.1)
-Collate: 'functional.R' 'list.R' 'roxygen.R' 'string.R' 'parse.R'
-    'parseS4.R' 'roclet.R' 'callgraph.R' 'description.R' 'collate.R' 
+Collate: 'functional.R' 'list.R' 'roxygen.R' 'string.R' 'memoize.R' 'parse.R'
+    'parseS4.R' 'roclet.R' 'callgraph.R' 'description.R' 'collate.R'
     'namespace.R' 'Rd.R' 'Rdmerge.R' 'Rdapi.R' 'Rdtank.R' 'Rd2.R'
     'roxygenize.R'

---FILE: pkg/R/memoize.R---
@@ -0,0 +1,46 @@
+library(digest)
+
+new_cache <- function() {
+  
+  cache <- NULL
+  cache_reset <- function() {
+    cache <<- new.env(TRUE, emptyenv())
+  }
+  
+  cache_set <- function(key, value) {
+    assign(key, value, env = cache)
+  }
+  
+  cache_get <- function(key) {
+    get(key, env = cache, inherits = FALSE)
+  }
+  
+  cache_has_key <- function(key) {
+    exists(key, env = cache, inherits = FALSE)
+  }
+  
+  cache_reset()
+  list(
+    reset = cache_reset, 
+    set = cache_set, 
+    get = cache_get,
+    has_key = cache_has_key,
+    keys = function() ls(cache)
+  )
+}
+
+memoize <- function(f) {
+  cache <- new_cache()
+  
+  function(...) {
+    hash <- digest(list(...))
+    
+    if (cache$has_key(hash)) {
+      cache$get(hash)
+    } else {
+      res <- f(...)
+      cache$set(hash, res)
+      res
+    }
+  }
+}
\ No newline at end of file

---FILE: pkg/R/parse.R---
@@ -2,6 +2,7 @@
 #' @include functional.R
 #' @include string.R
 #' @include list.R
+#' @include memoize.R
 roxygen()
 
 #' Sequence that distinguishes roxygen comment from normal comment.
@@ -80,7 +81,7 @@ register.parsers <- function(table, parser, ...) {
   for (key in c(...))
     register.parser(table, key, parser)
 }
-  
+
 #' Register many preref parsers at once.
 #' @param parser the parser to register
 #' @param \dots the keys upon which to register
@@ -170,7 +171,7 @@ parse.value <- function(key, rest) {
   else
     parse.default(key, rest)
 }
-  
+
 #' Parse an element containing a mandatory name
 #' and description (such as \code{@@param}).
 #' @param key the parsing key
@@ -300,7 +301,7 @@ parse.ref.preref <- function(ref, ...) {
                               if (is.null.string(description)) NULL
                               else parse.description(description))
   }
-} 
+}
 
 #' Recursively walk an expression (as returned by \code{parse}) in
 #' preorder.
@@ -398,13 +399,16 @@ parse.call <- function(expressions) {
   }
 }
 
-#' Parse a srcref
+#' Parse a srcref;
+#' with the help of memoization (by Hadley Wickham).
+#' param ref the srcref to be parsed
+#' param \dots ignored
 #' @method parse.ref srcref
-#' @param ref the srcref to be parsed
+#' @param ... the srcref to be parsed
 #' @param \dots ignored
 #' @return List containing the parsed srcref
 #' @export
-parse.ref.srcref <- function(ref, ...) {
+parse.ref.srcref <- memoize(function(ref, ...) {
   srcfile <- attributes(ref)$srcfile
   srcref <- list(srcref=list(filename=srcfile$filename,
                    lloc=as.vector(ref)))
@@ -414,29 +418,31 @@ parse.ref.srcref <- function(ref, ...) {
   if (is.call(car(expressions)))
     parsed <- parse.call(expressions)
   append(parsed, srcref)
-}
+})
 
 #' Parse each of a list of preref/srcref pairs.
 #' @param preref.srcrefs list of preref/srcref pairs
 #' @return List combining parsed preref/srcrefs
 parse.refs <- function(preref.srcrefs)
   Map(parse.ref, preref.srcrefs)
 
-#' Parse a source file containing roxygen directives.
-#' @param file string naming file to be parsed
+#' Parse a source file containing roxygen directives;
+#' with the help of memoization (by Hadley Wickham).
+#' param file string naming file to be parsed
+#' @param ... string naming file to be parsed
 #' @return List containing parsed directives
 #' @export
 #' @callGraph
 #' @callGraphDepth 3
-parse.file <- function(file) {
+parse.file <- memoize(function(file) {
   srcfile <- srcfile(file)
   srcrefs <- attributes(parse(srcfile$filename,
                               srcfile=srcfile))$srcref
   if (length(srcrefs) > 0)
     parse.refs(zip.list(prerefs(srcfile, srcrefs), srcrefs))
   else
     nil
-}
+})
 
 #' Parse many files at one.
 #' @param \dots files to be parsed

---FILE: pkg/man/parse.file.Rd---
@@ -1,7 +1,9 @@
 \name{parse.file}
 \alias{parse.file}
 \title{Parse a source file containing roxygen directives.}
-\usage{parse.file(file)}
+\usage{### parse.file(file)
+parse.file(...)
+}
 \description{Parse a source file containing roxygen directives.}
 \value{List containing parsed directives}
-\arguments{\item{file}{string naming file to be parsed}}
+\arguments{\item{...}{string naming file to be parsed}}

---FILE: pkg/man/parse.ref.srcref.Rd---
@@ -1,8 +1,10 @@
 \name{parse.ref.srcref}
 \alias{parse.ref.srcref}
 \title{Parse a srcref...}
-\usage{\method{parse.ref}{srcref} (ref, ...)}
+\usage{
+### parse.ref.srcref(ref, ...)
+parse.ref.srcref(...)
+}
 \description{Parse a srcref}
 \value{List containing the parsed srcref}
-\arguments{\item{ref}{the srcref to be parsed}
-\item{\dots}{ignored}}
+\arguments{\item{...}{the srcref to be parsed}}"
r-lib,roxygen2,af7bfb7b97de5e79e078519506871cca689c5003,Manuel J. A. Eugster,Manuel.Eugster@stat.uni-muenchen.de,2009-11-11T17:05:27Z,Manuel J. A. Eugster,Manuel.Eugster@stat.uni-muenchen.de,2009-11-11T17:05:27Z,"Hadley's ""Cache parsing of srcrefs"" patch; Roxygen mailinglist 2009-09-10.

git-svn-id: svn://svn.r-forge.r-project.org/svnroot/roxygen/pkg@240 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",.Rbuildignore;DESCRIPTION;R/memoize.R;R/parse.R;man/parse.file.Rd;man/parse.ref.srcref.Rd,False,True,True,False,79,19,98,"---FILE: .Rbuildignore---
@@ -0,0 +1,2 @@
+sandbox
+patches
\ No newline at end of file

---FILE: DESCRIPTION---
@@ -5,11 +5,13 @@ Description: A Doxygen-like in-source documentation system for Rd,
     collation, namespace and callgraphs.
 Title: Literate Programming in R
 Author: Peter Danenberg <pcd@roxygen.org>, Manuel Eugster
-    <Manuel.Eugster@stat.uni-muenchen.de>
+    <Manuel.Eugster@stat.uni-muenchen.de> with contributions
+    from Hadley Wickham <hadley@rice.edu>
 Maintainer: Peter Danenberg <pcd@roxygen.org>
 URL: http://roxygen.org
+Depends: digest
 Suggests: Rgraphviz (>= 1.19.2), tools (>= 2.9.1)
-Collate: 'functional.R' 'list.R' 'roxygen.R' 'string.R' 'parse.R'
-    'parseS4.R' 'roclet.R' 'callgraph.R' 'description.R' 'collate.R' 
+Collate: 'functional.R' 'list.R' 'roxygen.R' 'string.R' 'memoize.R' 'parse.R'
+    'parseS4.R' 'roclet.R' 'callgraph.R' 'description.R' 'collate.R'
     'namespace.R' 'Rd.R' 'Rdmerge.R' 'Rdapi.R' 'Rdtank.R' 'Rd2.R'
     'roxygenize.R'

---FILE: R/memoize.R---
@@ -0,0 +1,46 @@
+library(digest)
+
+new_cache <- function() {
+  
+  cache <- NULL
+  cache_reset <- function() {
+    cache <<- new.env(TRUE, emptyenv())
+  }
+  
+  cache_set <- function(key, value) {
+    assign(key, value, env = cache)
+  }
+  
+  cache_get <- function(key) {
+    get(key, env = cache, inherits = FALSE)
+  }
+  
+  cache_has_key <- function(key) {
+    exists(key, env = cache, inherits = FALSE)
+  }
+  
+  cache_reset()
+  list(
+    reset = cache_reset, 
+    set = cache_set, 
+    get = cache_get,
+    has_key = cache_has_key,
+    keys = function() ls(cache)
+  )
+}
+
+memoize <- function(f) {
+  cache <- new_cache()
+  
+  function(...) {
+    hash <- digest(list(...))
+    
+    if (cache$has_key(hash)) {
+      cache$get(hash)
+    } else {
+      res <- f(...)
+      cache$set(hash, res)
+      res
+    }
+  }
+}
\ No newline at end of file

---FILE: R/parse.R---
@@ -2,6 +2,7 @@
 #' @include functional.R
 #' @include string.R
 #' @include list.R
+#' @include memoize.R
 roxygen()
 
 #' Sequence that distinguishes roxygen comment from normal comment.
@@ -80,7 +81,7 @@ register.parsers <- function(table, parser, ...) {
   for (key in c(...))
     register.parser(table, key, parser)
 }
-  
+
 #' Register many preref parsers at once.
 #' @param parser the parser to register
 #' @param \dots the keys upon which to register
@@ -170,7 +171,7 @@ parse.value <- function(key, rest) {
   else
     parse.default(key, rest)
 }
-  
+
 #' Parse an element containing a mandatory name
 #' and description (such as \code{@@param}).
 #' @param key the parsing key
@@ -300,7 +301,7 @@ parse.ref.preref <- function(ref, ...) {
                               if (is.null.string(description)) NULL
                               else parse.description(description))
   }
-} 
+}
 
 #' Recursively walk an expression (as returned by \code{parse}) in
 #' preorder.
@@ -398,13 +399,16 @@ parse.call <- function(expressions) {
   }
 }
 
-#' Parse a srcref
+#' Parse a srcref;
+#' with the help of memoization (by Hadley Wickham).
+#' param ref the srcref to be parsed
+#' param \dots ignored
 #' @method parse.ref srcref
-#' @param ref the srcref to be parsed
+#' @param ... the srcref to be parsed
 #' @param \dots ignored
 #' @return List containing the parsed srcref
 #' @export
-parse.ref.srcref <- function(ref, ...) {
+parse.ref.srcref <- memoize(function(ref, ...) {
   srcfile <- attributes(ref)$srcfile
   srcref <- list(srcref=list(filename=srcfile$filename,
                    lloc=as.vector(ref)))
@@ -414,29 +418,31 @@ parse.ref.srcref <- function(ref, ...) {
   if (is.call(car(expressions)))
     parsed <- parse.call(expressions)
   append(parsed, srcref)
-}
+})
 
 #' Parse each of a list of preref/srcref pairs.
 #' @param preref.srcrefs list of preref/srcref pairs
 #' @return List combining parsed preref/srcrefs
 parse.refs <- function(preref.srcrefs)
   Map(parse.ref, preref.srcrefs)
 
-#' Parse a source file containing roxygen directives.
-#' @param file string naming file to be parsed
+#' Parse a source file containing roxygen directives;
+#' with the help of memoization (by Hadley Wickham).
+#' param file string naming file to be parsed
+#' @param ... string naming file to be parsed
 #' @return List containing parsed directives
 #' @export
 #' @callGraph
 #' @callGraphDepth 3
-parse.file <- function(file) {
+parse.file <- memoize(function(file) {
   srcfile <- srcfile(file)
   srcrefs <- attributes(parse(srcfile$filename,
                               srcfile=srcfile))$srcref
   if (length(srcrefs) > 0)
     parse.refs(zip.list(prerefs(srcfile, srcrefs), srcrefs))
   else
     nil
-}
+})
 
 #' Parse many files at one.
 #' @param \dots files to be parsed

---FILE: man/parse.file.Rd---
@@ -1,7 +1,9 @@
 \name{parse.file}
 \alias{parse.file}
 \title{Parse a source file containing roxygen directives.}
-\usage{parse.file(file)}
+\usage{### parse.file(file)
+parse.file(...)
+}
 \description{Parse a source file containing roxygen directives.}
 \value{List containing parsed directives}
-\arguments{\item{file}{string naming file to be parsed}}
+\arguments{\item{...}{string naming file to be parsed}}

---FILE: man/parse.ref.srcref.Rd---
@@ -1,8 +1,10 @@
 \name{parse.ref.srcref}
 \alias{parse.ref.srcref}
 \title{Parse a srcref...}
-\usage{\method{parse.ref}{srcref} (ref, ...)}
+\usage{
+### parse.ref.srcref(ref, ...)
+parse.ref.srcref(...)
+}
 \description{Parse a srcref}
 \value{List containing the parsed srcref}
-\arguments{\item{ref}{the srcref to be parsed}
-\item{\dots}{ignored}}
+\arguments{\item{...}{the srcref to be parsed}}"
r-lib,roxygen2,c9621732ff0b493300978c9adb7c726c133a8c27,Manuel J. A. Eugster,Manuel.Eugster@stat.uni-muenchen.de,2009-06-19T11:21:24Z,Manuel J. A. Eugster,Manuel.Eugster@stat.uni-muenchen.de,2009-06-19T11:21:24Z,"Fixed ""usage of for() return value"" in topological.sort(); [interesting that it originally worked (kind of tricky)].

git-svn-id: svn://svn.r-forge.r-project.org/svnroot/roxygen/pkg@226 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",R/collate.R,False,True,True,False,167,165,332,"---FILE: R/collate.R---
@@ -1,165 +1,167 @@
-#' @include roxygen.R
-#' @include string.R
-#' @include functional.R
-#' @include roclet.R
-#' @include description.R
-#' @include parse.R
-roxygen()
-
-#' Collate value parser
-#' @name include
-#' @seealso make.collate.roclet
-register.preref.parsers(parse.value,
-                        'include')
-
-#' Make collate roclet which parses the given files; topologically
-#' sorting \code{@@include}s, and either merging the \code{Collate:}
-#' directive with a pre-existing \file{DESCRIPTION} or writing to
-#' standard out.
-#'
-#' Each \code{@@include} tag should specify the filename of one intrapackage
-#' dependency; multiple \code{@@include} tags may be given.
-#'
-#' Contains the member function \code{parse} which parses an arbitrary number
-#' of files, and \code{parse.dir} which recursively parses a directory tree.
-#'
-#' @param merge.file \file{DESCRIPTION} file with which to merge directive;
-#' or \code{NULL} for none
-#' @param target.file whither to \code{cat} directive (whether merged or
-#' not); blank line is standard out
-#' @param verbose whether to describe what we're doing with the
-#' target.file
-#' @return Rd roclet
-#' @seealso \code{\link{make.roclet}}
-#' @examples
-#' #' `example-a.R', `example-b.R' and `example-c.R' reside
-#' #' in the `example' directory, with dependencies
-#' #' a -> {b, c}. This is `example-a.R'.
-#' #' @@include example-b.R
-#' #' @@include example-c.R
-#' roxygen()
-#'
-#' roclet <- make.collate.roclet()
-#' \dontrun{roclet$parse.dir('example')}
-#' @export
-make.collate.roclet <- function(merge.file=NULL,
-                                target.file='',
-                                verbose=TRUE) {
-  vertices <- NULL
-
-  make.vertex <- function(file) {
-    vertex <- new.env(parent=emptyenv())
-    vertex$file <- trim(file)
-    vertex$discovered <- FALSE
-    vertex$ancestors <- NULL
-    vertex
-  }
-
-  maybe.append.vertex <- function(file)
-    if (is.null(vertices[[file]]))
-      assign.parent('vertices',
-                    append(vertices,
-                           as.list(structure(c(make.vertex(file)),
-                                             names=file))),
-                    environment())
-
-  member <- function(ancestor, ancestors) {
-    for (vertex in ancestors)
-      if (identical(ancestor, vertex))
-        TRUE
-    FALSE
-  }
-
-  maybe.append.ancestor <- function(predecessor, ancestor)
-    if (!member(ancestor, predecessor$ancestors))
-      predecessor$ancestors <-
-        append(ancestor, predecessor$ancestors)
-
-  current.predecessor <- NULL
-
-  parse.include <- function(key, file) {
-    file <- trim(file)
-    maybe.append.vertex(file)
-    ancestor <- vertices[[file]]
-    maybe.append.ancestor(current.predecessor,
-                          ancestor)
-  }
-  
-  pre.parse <- function(partitum) {
-    file <- partitum$srcref$filename
-    maybe.append.vertex(file)
-    vertex <- vertices[[file]]
-    assign.parent('current.predecessor',
-                  vertex,
-                  environment())
-  }
-
-  topological.sort <- function(vertices) {
-    sorted <- NULL
-    visit <- function(predecessor) {
-      predecessor$discovered <- TRUE
-      for (ancestor in predecessor$ancestors)
-        if (!ancestor$discovered)
-          visit(ancestor)
-      assign.parent('sorted',
-                    append(sorted, predecessor),
-                    environment())
-    }
-    for (vertex in vertices)
-      if (!vertex$discovered)
-        visit(vertex)
-  }
-
-  COLLATE.FIELD <- 'Collate:'
-
-  merge <- function(files) {
-    if (verbose && !is.null.string(target.file))
-      cat(sprintf('Merging collate directive with %s to %s',
-                  merge.file,
-                  target.file), '\n')
-    pre.parse <- function(parsed.fields) unlink(target.file)
-    post.parse <- function(parsed.fields)
-      cat.description('Collate', files, file=target.file)
-    parse.default <- Curry(cat.description, file=target.file)
-    parser <- make.description.parser(parse.default,
-                                      pre.parse=pre.parse,
-                                      post.parse=post.parse)
-    parser$register.parser('Collate', noop.description)
-    ## Force parse.description.file to be evaluated before
-    ## parser$parser (applicative order).
-    parsed.file <- parse.description.file(merge.file)
-    parser$parse(parsed.file)
-  }
-
-  post.files <- function() {
-    files <- do.call(paste, Map(function(vertex)
-                                sprintf(""'%s'"", vertex$file),
-                                topological.sort(vertices)))
-    if (!is.null(cwd))
-      setwd(cwd)
-    assign.parent('cwd', NULL, environment())
-    if (!is.null(merge.file))
-      merge(files)
-    else
-      cat.description('Collate', files, file=target.file)
-  }
-
-  roclet <- make.roclet(parse.include,
-                        pre.parse=pre.parse,
-                        post.files=post.files)
-
-  roclet$register.default.parser('include')
-
-  cwd <- NULL
-
-  roclet$parse.dir <- function(dir) {
-    assign.parent('cwd', getwd(), environment())
-    setwd(dir)
-    do.call(roclet$parse,
-            as.list(list.files('.',
-                               recursive=TRUE,
-                               full.names=FALSE)))
-  }
-
-  roclet
-}
+#' @include roxygen.R
+#' @include string.R
+#' @include functional.R
+#' @include roclet.R
+#' @include description.R
+#' @include parse.R
+roxygen()
+
+#' Collate value parser
+#' @name include
+#' @seealso make.collate.roclet
+register.preref.parsers(parse.value,
+                        'include')
+
+#' Make collate roclet which parses the given files; topologically
+#' sorting \code{@@include}s, and either merging the \code{Collate:}
+#' directive with a pre-existing \file{DESCRIPTION} or writing to
+#' standard out.
+#'
+#' Each \code{@@include} tag should specify the filename of one intrapackage
+#' dependency; multiple \code{@@include} tags may be given.
+#'
+#' Contains the member function \code{parse} which parses an arbitrary number
+#' of files, and \code{parse.dir} which recursively parses a directory tree.
+#'
+#' @param merge.file \file{DESCRIPTION} file with which to merge directive;
+#' or \code{NULL} for none
+#' @param target.file whither to \code{cat} directive (whether merged or
+#' not); blank line is standard out
+#' @param verbose whether to describe what we're doing with the
+#' target.file
+#' @return Rd roclet
+#' @seealso \code{\link{make.roclet}}
+#' @examples
+#' #' `example-a.R', `example-b.R' and `example-c.R' reside
+#' #' in the `example' directory, with dependencies
+#' #' a -> {b, c}. This is `example-a.R'.
+#' #' @@include example-b.R
+#' #' @@include example-c.R
+#' roxygen()
+#'
+#' roclet <- make.collate.roclet()
+#' \dontrun{roclet$parse.dir('example')}
+#' @export
+make.collate.roclet <- function(merge.file=NULL,
+                                target.file='',
+                                verbose=TRUE) {
+  vertices <- NULL
+
+  make.vertex <- function(file) {
+    vertex <- new.env(parent=emptyenv())
+    vertex$file <- trim(file)
+    vertex$discovered <- FALSE
+    vertex$ancestors <- NULL
+    vertex
+  }
+
+  maybe.append.vertex <- function(file)
+    if (is.null(vertices[[file]]))
+      assign.parent('vertices',
+                    append(vertices,
+                           as.list(structure(c(make.vertex(file)),
+                                             names=file))),
+                    environment())
+
+  member <- function(ancestor, ancestors) {
+    for (vertex in ancestors)
+      if (identical(ancestor, vertex))
+        TRUE
+    FALSE
+  }
+
+  maybe.append.ancestor <- function(predecessor, ancestor)
+    if (!member(ancestor, predecessor$ancestors))
+      predecessor$ancestors <-
+        append(ancestor, predecessor$ancestors)
+
+  current.predecessor <- NULL
+
+  parse.include <- function(key, file) {
+    file <- trim(file)
+    maybe.append.vertex(file)
+    ancestor <- vertices[[file]]
+    maybe.append.ancestor(current.predecessor,
+                          ancestor)
+  }
+  
+  pre.parse <- function(partitum) {
+    file <- partitum$srcref$filename
+    maybe.append.vertex(file)
+    vertex <- vertices[[file]]
+    assign.parent('current.predecessor',
+                  vertex,
+                  environment())
+  }
+
+  topological.sort <- function(vertices) {
+    sorted <- NULL
+    visit <- function(predecessor) {
+      predecessor$discovered <- TRUE
+      for (ancestor in predecessor$ancestors)
+        if (!ancestor$discovered)
+          visit(ancestor)
+      assign.parent('sorted',
+                    append(sorted, predecessor),
+                    environment())
+    }
+    for (vertex in vertices)
+      if (!vertex$discovered)
+        visit(vertex)
+
+    sorted
+  }
+
+  COLLATE.FIELD <- 'Collate:'
+
+  merge <- function(files) {
+    if (verbose && !is.null.string(target.file))
+      cat(sprintf('Merging collate directive with %s to %s',
+                  merge.file,
+                  target.file), '\n')
+    pre.parse <- function(parsed.fields) unlink(target.file)
+    post.parse <- function(parsed.fields)
+      cat.description('Collate', files, file=target.file)
+    parse.default <- Curry(cat.description, file=target.file)
+    parser <- make.description.parser(parse.default,
+                                      pre.parse=pre.parse,
+                                      post.parse=post.parse)
+    parser$register.parser('Collate', noop.description)
+    ## Force parse.description.file to be evaluated before
+    ## parser$parser (applicative order).
+    parsed.file <- parse.description.file(merge.file)
+    parser$parse(parsed.file)
+  }
+
+  post.files <- function() {
+    files <- do.call(paste, Map(function(vertex)
+                                sprintf(""'%s'"", vertex$file),
+                                topological.sort(vertices)))
+    if (!is.null(cwd))
+      setwd(cwd)
+    assign.parent('cwd', NULL, environment())
+    if (!is.null(merge.file))
+      merge(files)
+    else
+      cat.description('Collate', files, file=target.file)
+  }
+
+  roclet <- make.roclet(parse.include,
+                        pre.parse=pre.parse,
+                        post.files=post.files)
+
+  roclet$register.default.parser('include')
+
+  cwd <- NULL
+
+  roclet$parse.dir <- function(dir) {
+    assign.parent('cwd', getwd(), environment())
+    setwd(dir)
+    do.call(roclet$parse,
+            as.list(list.files('.',
+                               recursive=TRUE,
+                               full.names=FALSE)))
+  }
+
+  roclet
+}"
r-lib,roxygen2,b43ec0f5df6f2173890f3095e494a565b98f2ee2,manuel,manuel@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2009-06-19T11:21:24Z,manuel,manuel@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2009-06-19T11:21:24Z,"Fixed ""usage of for() return value"" in topological.sort(); [interesting that it originally worked (kind of tricky)].

git-svn-id: svn://svn.r-forge.r-project.org/svnroot/roxygen/pkg@226 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",R/collate.R,False,True,True,False,167,165,332,"---FILE: R/collate.R---
@@ -1,165 +1,167 @@
-#' @include roxygen.R
-#' @include string.R
-#' @include functional.R
-#' @include roclet.R
-#' @include description.R
-#' @include parse.R
-roxygen()
-
-#' Collate value parser
-#' @name include
-#' @seealso make.collate.roclet
-register.preref.parsers(parse.value,
-                        'include')
-
-#' Make collate roclet which parses the given files; topologically
-#' sorting \code{@@include}s, and either merging the \code{Collate:}
-#' directive with a pre-existing \file{DESCRIPTION} or writing to
-#' standard out.
-#'
-#' Each \code{@@include} tag should specify the filename of one intrapackage
-#' dependency; multiple \code{@@include} tags may be given.
-#'
-#' Contains the member function \code{parse} which parses an arbitrary number
-#' of files, and \code{parse.dir} which recursively parses a directory tree.
-#'
-#' @param merge.file \file{DESCRIPTION} file with which to merge directive;
-#' or \code{NULL} for none
-#' @param target.file whither to \code{cat} directive (whether merged or
-#' not); blank line is standard out
-#' @param verbose whether to describe what we're doing with the
-#' target.file
-#' @return Rd roclet
-#' @seealso \code{\link{make.roclet}}
-#' @examples
-#' #' `example-a.R', `example-b.R' and `example-c.R' reside
-#' #' in the `example' directory, with dependencies
-#' #' a -> {b, c}. This is `example-a.R'.
-#' #' @@include example-b.R
-#' #' @@include example-c.R
-#' roxygen()
-#'
-#' roclet <- make.collate.roclet()
-#' \dontrun{roclet$parse.dir('example')}
-#' @export
-make.collate.roclet <- function(merge.file=NULL,
-                                target.file='',
-                                verbose=TRUE) {
-  vertices <- NULL
-
-  make.vertex <- function(file) {
-    vertex <- new.env(parent=emptyenv())
-    vertex$file <- trim(file)
-    vertex$discovered <- FALSE
-    vertex$ancestors <- NULL
-    vertex
-  }
-
-  maybe.append.vertex <- function(file)
-    if (is.null(vertices[[file]]))
-      assign.parent('vertices',
-                    append(vertices,
-                           as.list(structure(c(make.vertex(file)),
-                                             names=file))),
-                    environment())
-
-  member <- function(ancestor, ancestors) {
-    for (vertex in ancestors)
-      if (identical(ancestor, vertex))
-        TRUE
-    FALSE
-  }
-
-  maybe.append.ancestor <- function(predecessor, ancestor)
-    if (!member(ancestor, predecessor$ancestors))
-      predecessor$ancestors <-
-        append(ancestor, predecessor$ancestors)
-
-  current.predecessor <- NULL
-
-  parse.include <- function(key, file) {
-    file <- trim(file)
-    maybe.append.vertex(file)
-    ancestor <- vertices[[file]]
-    maybe.append.ancestor(current.predecessor,
-                          ancestor)
-  }
-  
-  pre.parse <- function(partitum) {
-    file <- partitum$srcref$filename
-    maybe.append.vertex(file)
-    vertex <- vertices[[file]]
-    assign.parent('current.predecessor',
-                  vertex,
-                  environment())
-  }
-
-  topological.sort <- function(vertices) {
-    sorted <- NULL
-    visit <- function(predecessor) {
-      predecessor$discovered <- TRUE
-      for (ancestor in predecessor$ancestors)
-        if (!ancestor$discovered)
-          visit(ancestor)
-      assign.parent('sorted',
-                    append(sorted, predecessor),
-                    environment())
-    }
-    for (vertex in vertices)
-      if (!vertex$discovered)
-        visit(vertex)
-  }
-
-  COLLATE.FIELD <- 'Collate:'
-
-  merge <- function(files) {
-    if (verbose && !is.null.string(target.file))
-      cat(sprintf('Merging collate directive with %s to %s',
-                  merge.file,
-                  target.file), '\n')
-    pre.parse <- function(parsed.fields) unlink(target.file)
-    post.parse <- function(parsed.fields)
-      cat.description('Collate', files, file=target.file)
-    parse.default <- Curry(cat.description, file=target.file)
-    parser <- make.description.parser(parse.default,
-                                      pre.parse=pre.parse,
-                                      post.parse=post.parse)
-    parser$register.parser('Collate', noop.description)
-    ## Force parse.description.file to be evaluated before
-    ## parser$parser (applicative order).
-    parsed.file <- parse.description.file(merge.file)
-    parser$parse(parsed.file)
-  }
-
-  post.files <- function() {
-    files <- do.call(paste, Map(function(vertex)
-                                sprintf(""'%s'"", vertex$file),
-                                topological.sort(vertices)))
-    if (!is.null(cwd))
-      setwd(cwd)
-    assign.parent('cwd', NULL, environment())
-    if (!is.null(merge.file))
-      merge(files)
-    else
-      cat.description('Collate', files, file=target.file)
-  }
-
-  roclet <- make.roclet(parse.include,
-                        pre.parse=pre.parse,
-                        post.files=post.files)
-
-  roclet$register.default.parser('include')
-
-  cwd <- NULL
-
-  roclet$parse.dir <- function(dir) {
-    assign.parent('cwd', getwd(), environment())
-    setwd(dir)
-    do.call(roclet$parse,
-            as.list(list.files('.',
-                               recursive=TRUE,
-                               full.names=FALSE)))
-  }
-
-  roclet
-}
+#' @include roxygen.R
+#' @include string.R
+#' @include functional.R
+#' @include roclet.R
+#' @include description.R
+#' @include parse.R
+roxygen()
+
+#' Collate value parser
+#' @name include
+#' @seealso make.collate.roclet
+register.preref.parsers(parse.value,
+                        'include')
+
+#' Make collate roclet which parses the given files; topologically
+#' sorting \code{@@include}s, and either merging the \code{Collate:}
+#' directive with a pre-existing \file{DESCRIPTION} or writing to
+#' standard out.
+#'
+#' Each \code{@@include} tag should specify the filename of one intrapackage
+#' dependency; multiple \code{@@include} tags may be given.
+#'
+#' Contains the member function \code{parse} which parses an arbitrary number
+#' of files, and \code{parse.dir} which recursively parses a directory tree.
+#'
+#' @param merge.file \file{DESCRIPTION} file with which to merge directive;
+#' or \code{NULL} for none
+#' @param target.file whither to \code{cat} directive (whether merged or
+#' not); blank line is standard out
+#' @param verbose whether to describe what we're doing with the
+#' target.file
+#' @return Rd roclet
+#' @seealso \code{\link{make.roclet}}
+#' @examples
+#' #' `example-a.R', `example-b.R' and `example-c.R' reside
+#' #' in the `example' directory, with dependencies
+#' #' a -> {b, c}. This is `example-a.R'.
+#' #' @@include example-b.R
+#' #' @@include example-c.R
+#' roxygen()
+#'
+#' roclet <- make.collate.roclet()
+#' \dontrun{roclet$parse.dir('example')}
+#' @export
+make.collate.roclet <- function(merge.file=NULL,
+                                target.file='',
+                                verbose=TRUE) {
+  vertices <- NULL
+
+  make.vertex <- function(file) {
+    vertex <- new.env(parent=emptyenv())
+    vertex$file <- trim(file)
+    vertex$discovered <- FALSE
+    vertex$ancestors <- NULL
+    vertex
+  }
+
+  maybe.append.vertex <- function(file)
+    if (is.null(vertices[[file]]))
+      assign.parent('vertices',
+                    append(vertices,
+                           as.list(structure(c(make.vertex(file)),
+                                             names=file))),
+                    environment())
+
+  member <- function(ancestor, ancestors) {
+    for (vertex in ancestors)
+      if (identical(ancestor, vertex))
+        TRUE
+    FALSE
+  }
+
+  maybe.append.ancestor <- function(predecessor, ancestor)
+    if (!member(ancestor, predecessor$ancestors))
+      predecessor$ancestors <-
+        append(ancestor, predecessor$ancestors)
+
+  current.predecessor <- NULL
+
+  parse.include <- function(key, file) {
+    file <- trim(file)
+    maybe.append.vertex(file)
+    ancestor <- vertices[[file]]
+    maybe.append.ancestor(current.predecessor,
+                          ancestor)
+  }
+  
+  pre.parse <- function(partitum) {
+    file <- partitum$srcref$filename
+    maybe.append.vertex(file)
+    vertex <- vertices[[file]]
+    assign.parent('current.predecessor',
+                  vertex,
+                  environment())
+  }
+
+  topological.sort <- function(vertices) {
+    sorted <- NULL
+    visit <- function(predecessor) {
+      predecessor$discovered <- TRUE
+      for (ancestor in predecessor$ancestors)
+        if (!ancestor$discovered)
+          visit(ancestor)
+      assign.parent('sorted',
+                    append(sorted, predecessor),
+                    environment())
+    }
+    for (vertex in vertices)
+      if (!vertex$discovered)
+        visit(vertex)
+
+    sorted
+  }
+
+  COLLATE.FIELD <- 'Collate:'
+
+  merge <- function(files) {
+    if (verbose && !is.null.string(target.file))
+      cat(sprintf('Merging collate directive with %s to %s',
+                  merge.file,
+                  target.file), '\n')
+    pre.parse <- function(parsed.fields) unlink(target.file)
+    post.parse <- function(parsed.fields)
+      cat.description('Collate', files, file=target.file)
+    parse.default <- Curry(cat.description, file=target.file)
+    parser <- make.description.parser(parse.default,
+                                      pre.parse=pre.parse,
+                                      post.parse=post.parse)
+    parser$register.parser('Collate', noop.description)
+    ## Force parse.description.file to be evaluated before
+    ## parser$parser (applicative order).
+    parsed.file <- parse.description.file(merge.file)
+    parser$parse(parsed.file)
+  }
+
+  post.files <- function() {
+    files <- do.call(paste, Map(function(vertex)
+                                sprintf(""'%s'"", vertex$file),
+                                topological.sort(vertices)))
+    if (!is.null(cwd))
+      setwd(cwd)
+    assign.parent('cwd', NULL, environment())
+    if (!is.null(merge.file))
+      merge(files)
+    else
+      cat.description('Collate', files, file=target.file)
+  }
+
+  roclet <- make.roclet(parse.include,
+                        pre.parse=pre.parse,
+                        post.files=post.files)
+
+  roclet$register.default.parser('include')
+
+  cwd <- NULL
+
+  roclet$parse.dir <- function(dir) {
+    assign.parent('cwd', getwd(), environment())
+    setwd(dir)
+    do.call(roclet$parse,
+            as.list(list.files('.',
+                               recursive=TRUE,
+                               full.names=FALSE)))
+  }
+
+  roclet
+}"
r-lib,roxygen2,c672cd144f4dea55046ebdf152dc29d299efef8a,manuel,manuel@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2009-06-19T11:21:24Z,manuel,manuel@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2009-06-19T11:21:24Z,"Fixed ""usage of for() return value"" in topological.sort(); [interesting that it originally worked (kind of tricky)].

git-svn-id: svn+ssh://svn.r-forge.r-project.org/svnroot/roxygen@226 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",pkg/R/collate.R,False,True,True,False,167,165,332,"---FILE: pkg/R/collate.R---
@@ -1,165 +1,167 @@
-#' @include roxygen.R
-#' @include string.R
-#' @include functional.R
-#' @include roclet.R
-#' @include description.R
-#' @include parse.R
-roxygen()
-
-#' Collate value parser
-#' @name include
-#' @seealso make.collate.roclet
-register.preref.parsers(parse.value,
-                        'include')
-
-#' Make collate roclet which parses the given files; topologically
-#' sorting \code{@@include}s, and either merging the \code{Collate:}
-#' directive with a pre-existing \file{DESCRIPTION} or writing to
-#' standard out.
-#'
-#' Each \code{@@include} tag should specify the filename of one intrapackage
-#' dependency; multiple \code{@@include} tags may be given.
-#'
-#' Contains the member function \code{parse} which parses an arbitrary number
-#' of files, and \code{parse.dir} which recursively parses a directory tree.
-#'
-#' @param merge.file \file{DESCRIPTION} file with which to merge directive;
-#' or \code{NULL} for none
-#' @param target.file whither to \code{cat} directive (whether merged or
-#' not); blank line is standard out
-#' @param verbose whether to describe what we're doing with the
-#' target.file
-#' @return Rd roclet
-#' @seealso \code{\link{make.roclet}}
-#' @examples
-#' #' `example-a.R', `example-b.R' and `example-c.R' reside
-#' #' in the `example' directory, with dependencies
-#' #' a -> {b, c}. This is `example-a.R'.
-#' #' @@include example-b.R
-#' #' @@include example-c.R
-#' roxygen()
-#'
-#' roclet <- make.collate.roclet()
-#' \dontrun{roclet$parse.dir('example')}
-#' @export
-make.collate.roclet <- function(merge.file=NULL,
-                                target.file='',
-                                verbose=TRUE) {
-  vertices <- NULL
-
-  make.vertex <- function(file) {
-    vertex <- new.env(parent=emptyenv())
-    vertex$file <- trim(file)
-    vertex$discovered <- FALSE
-    vertex$ancestors <- NULL
-    vertex
-  }
-
-  maybe.append.vertex <- function(file)
-    if (is.null(vertices[[file]]))
-      assign.parent('vertices',
-                    append(vertices,
-                           as.list(structure(c(make.vertex(file)),
-                                             names=file))),
-                    environment())
-
-  member <- function(ancestor, ancestors) {
-    for (vertex in ancestors)
-      if (identical(ancestor, vertex))
-        TRUE
-    FALSE
-  }
-
-  maybe.append.ancestor <- function(predecessor, ancestor)
-    if (!member(ancestor, predecessor$ancestors))
-      predecessor$ancestors <-
-        append(ancestor, predecessor$ancestors)
-
-  current.predecessor <- NULL
-
-  parse.include <- function(key, file) {
-    file <- trim(file)
-    maybe.append.vertex(file)
-    ancestor <- vertices[[file]]
-    maybe.append.ancestor(current.predecessor,
-                          ancestor)
-  }
-  
-  pre.parse <- function(partitum) {
-    file <- partitum$srcref$filename
-    maybe.append.vertex(file)
-    vertex <- vertices[[file]]
-    assign.parent('current.predecessor',
-                  vertex,
-                  environment())
-  }
-
-  topological.sort <- function(vertices) {
-    sorted <- NULL
-    visit <- function(predecessor) {
-      predecessor$discovered <- TRUE
-      for (ancestor in predecessor$ancestors)
-        if (!ancestor$discovered)
-          visit(ancestor)
-      assign.parent('sorted',
-                    append(sorted, predecessor),
-                    environment())
-    }
-    for (vertex in vertices)
-      if (!vertex$discovered)
-        visit(vertex)
-  }
-
-  COLLATE.FIELD <- 'Collate:'
-
-  merge <- function(files) {
-    if (verbose && !is.null.string(target.file))
-      cat(sprintf('Merging collate directive with %s to %s',
-                  merge.file,
-                  target.file), '\n')
-    pre.parse <- function(parsed.fields) unlink(target.file)
-    post.parse <- function(parsed.fields)
-      cat.description('Collate', files, file=target.file)
-    parse.default <- Curry(cat.description, file=target.file)
-    parser <- make.description.parser(parse.default,
-                                      pre.parse=pre.parse,
-                                      post.parse=post.parse)
-    parser$register.parser('Collate', noop.description)
-    ## Force parse.description.file to be evaluated before
-    ## parser$parser (applicative order).
-    parsed.file <- parse.description.file(merge.file)
-    parser$parse(parsed.file)
-  }
-
-  post.files <- function() {
-    files <- do.call(paste, Map(function(vertex)
-                                sprintf(""'%s'"", vertex$file),
-                                topological.sort(vertices)))
-    if (!is.null(cwd))
-      setwd(cwd)
-    assign.parent('cwd', NULL, environment())
-    if (!is.null(merge.file))
-      merge(files)
-    else
-      cat.description('Collate', files, file=target.file)
-  }
-
-  roclet <- make.roclet(parse.include,
-                        pre.parse=pre.parse,
-                        post.files=post.files)
-
-  roclet$register.default.parser('include')
-
-  cwd <- NULL
-
-  roclet$parse.dir <- function(dir) {
-    assign.parent('cwd', getwd(), environment())
-    setwd(dir)
-    do.call(roclet$parse,
-            as.list(list.files('.',
-                               recursive=TRUE,
-                               full.names=FALSE)))
-  }
-
-  roclet
-}
+#' @include roxygen.R
+#' @include string.R
+#' @include functional.R
+#' @include roclet.R
+#' @include description.R
+#' @include parse.R
+roxygen()
+
+#' Collate value parser
+#' @name include
+#' @seealso make.collate.roclet
+register.preref.parsers(parse.value,
+                        'include')
+
+#' Make collate roclet which parses the given files; topologically
+#' sorting \code{@@include}s, and either merging the \code{Collate:}
+#' directive with a pre-existing \file{DESCRIPTION} or writing to
+#' standard out.
+#'
+#' Each \code{@@include} tag should specify the filename of one intrapackage
+#' dependency; multiple \code{@@include} tags may be given.
+#'
+#' Contains the member function \code{parse} which parses an arbitrary number
+#' of files, and \code{parse.dir} which recursively parses a directory tree.
+#'
+#' @param merge.file \file{DESCRIPTION} file with which to merge directive;
+#' or \code{NULL} for none
+#' @param target.file whither to \code{cat} directive (whether merged or
+#' not); blank line is standard out
+#' @param verbose whether to describe what we're doing with the
+#' target.file
+#' @return Rd roclet
+#' @seealso \code{\link{make.roclet}}
+#' @examples
+#' #' `example-a.R', `example-b.R' and `example-c.R' reside
+#' #' in the `example' directory, with dependencies
+#' #' a -> {b, c}. This is `example-a.R'.
+#' #' @@include example-b.R
+#' #' @@include example-c.R
+#' roxygen()
+#'
+#' roclet <- make.collate.roclet()
+#' \dontrun{roclet$parse.dir('example')}
+#' @export
+make.collate.roclet <- function(merge.file=NULL,
+                                target.file='',
+                                verbose=TRUE) {
+  vertices <- NULL
+
+  make.vertex <- function(file) {
+    vertex <- new.env(parent=emptyenv())
+    vertex$file <- trim(file)
+    vertex$discovered <- FALSE
+    vertex$ancestors <- NULL
+    vertex
+  }
+
+  maybe.append.vertex <- function(file)
+    if (is.null(vertices[[file]]))
+      assign.parent('vertices',
+                    append(vertices,
+                           as.list(structure(c(make.vertex(file)),
+                                             names=file))),
+                    environment())
+
+  member <- function(ancestor, ancestors) {
+    for (vertex in ancestors)
+      if (identical(ancestor, vertex))
+        TRUE
+    FALSE
+  }
+
+  maybe.append.ancestor <- function(predecessor, ancestor)
+    if (!member(ancestor, predecessor$ancestors))
+      predecessor$ancestors <-
+        append(ancestor, predecessor$ancestors)
+
+  current.predecessor <- NULL
+
+  parse.include <- function(key, file) {
+    file <- trim(file)
+    maybe.append.vertex(file)
+    ancestor <- vertices[[file]]
+    maybe.append.ancestor(current.predecessor,
+                          ancestor)
+  }
+  
+  pre.parse <- function(partitum) {
+    file <- partitum$srcref$filename
+    maybe.append.vertex(file)
+    vertex <- vertices[[file]]
+    assign.parent('current.predecessor',
+                  vertex,
+                  environment())
+  }
+
+  topological.sort <- function(vertices) {
+    sorted <- NULL
+    visit <- function(predecessor) {
+      predecessor$discovered <- TRUE
+      for (ancestor in predecessor$ancestors)
+        if (!ancestor$discovered)
+          visit(ancestor)
+      assign.parent('sorted',
+                    append(sorted, predecessor),
+                    environment())
+    }
+    for (vertex in vertices)
+      if (!vertex$discovered)
+        visit(vertex)
+
+    sorted
+  }
+
+  COLLATE.FIELD <- 'Collate:'
+
+  merge <- function(files) {
+    if (verbose && !is.null.string(target.file))
+      cat(sprintf('Merging collate directive with %s to %s',
+                  merge.file,
+                  target.file), '\n')
+    pre.parse <- function(parsed.fields) unlink(target.file)
+    post.parse <- function(parsed.fields)
+      cat.description('Collate', files, file=target.file)
+    parse.default <- Curry(cat.description, file=target.file)
+    parser <- make.description.parser(parse.default,
+                                      pre.parse=pre.parse,
+                                      post.parse=post.parse)
+    parser$register.parser('Collate', noop.description)
+    ## Force parse.description.file to be evaluated before
+    ## parser$parser (applicative order).
+    parsed.file <- parse.description.file(merge.file)
+    parser$parse(parsed.file)
+  }
+
+  post.files <- function() {
+    files <- do.call(paste, Map(function(vertex)
+                                sprintf(""'%s'"", vertex$file),
+                                topological.sort(vertices)))
+    if (!is.null(cwd))
+      setwd(cwd)
+    assign.parent('cwd', NULL, environment())
+    if (!is.null(merge.file))
+      merge(files)
+    else
+      cat.description('Collate', files, file=target.file)
+  }
+
+  roclet <- make.roclet(parse.include,
+                        pre.parse=pre.parse,
+                        post.files=post.files)
+
+  roclet$register.default.parser('include')
+
+  cwd <- NULL
+
+  roclet$parse.dir <- function(dir) {
+    assign.parent('cwd', getwd(), environment())
+    setwd(dir)
+    do.call(roclet$parse,
+            as.list(list.files('.',
+                               recursive=TRUE,
+                               full.names=FALSE)))
+  }
+
+  roclet
+}"
r-lib,roxygen2,44be80cecfaf6c95c85e9de1ed6780938ae15277,Manuel J. A. Eugster,Manuel.Eugster@stat.uni-muenchen.de,2009-06-19T08:30:27Z,Manuel J. A. Eugster,Manuel.Eugster@stat.uni-muenchen.de,2009-06-19T08:30:27Z,"Solved ""Missing quotes in default arguments"" bug (reported on Roxygen-devel, 2009/06/17.

git-svn-id: svn://svn.r-forge.r-project.org/svnroot/roxygen/pkg@225 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",R/parse.R;R/string.R;sandbox/Rd.R,False,True,True,False,183,165,348,"---FILE: R/parse.R---
@@ -366,7 +366,7 @@ parse.formals <- function(expressions) {
   else list(formals=Map(function(formal)
               if (is.null(formal)) ''
               else if (is.call(formal)) capture.output(formal)
-              else as.character(formal), formals))
+              else as.character(maybe.quote(formal)), formals))
 }
 
 #' Find the assignee of the expression

---FILE: R/string.R---
@@ -1,164 +1,174 @@
-#' @include roxygen.R
-#' @include functional.R
-#' @include list.R
-roxygen()
-
-#' Absence of words
-SPACE <- '[[:space:]]+'
-
-#' Anti-anti-words
-MATTER <- '[^[:space:]]+'
-
-#' Analogue to the empty list
-NIL.STRING <- ''
-
-#' Trim [:space:] to the left of a string.
-#' @param string the string to be trimmed
-#' @return A left-trimmed string
-trim.left <- function(string)
-  gsub(sprintf('^%s', SPACE), NIL.STRING, string)
-
-#' Trim [:space:] to the right of a string.
-#' @param string the string to be trimmed
-#' @return A right-trimmed string
-trim.right <- function(string)
-  gsub(sprintf('%s$', SPACE), NIL.STRING, string)
-
-#' Trim [:space:] on both sides of a string.
-#' @param string the string to be trimmed
-#' @return A trimmed string
-trim <- function(string)
-  Compose(trim.left, trim.right)(string)
-
-#' Does the string contain no matter, but very well [:space:]?
-#' @param string the string to check
-#' @return TRUE if the string contains words, otherwise FALSE
-is.null.string <- function(string) {
-  if (is.na(string)) FALSE
-  else regexpr(MATTER, string) < 0
-}
-
-#' Number of words a string contains.
-#' @param string the string whose words to count
-#' @return Number of words in the string
-nwords <- function(string) {
-  if (is.null.string(string)) 0
-  else length(gregexpr(MATTER, string))
-}
-
-#' Find the nth word in a string.
-#' @param string the string to search in
-#' @param n the nth word to find
-#'
-#' @return A list containing:
-#'   \item{start}{the first letter of the word.}
-#'   \item{end}{the last letter of the word.}
-#' Undefined if no such word; though \code{end} may be less than
-#' \code{start} in such a case.
-word.ref <- function(string, n) {
-  continue <- function(string, n, init) {
-    word <- regexpr(MATTER, string)
-    start <- word[[1]]
-    length <- attributes(word)$match.length[[1]]
-    end <- start + length
-    if (n <= 1) list(start=start + init, end=end + init)
-    else continue(substr(string, end, nchar(string)), n - 1, init + length)
-  }
-  continue(string, n, 0)
-}
-
-#' First word in a string.
-#' @param string the string whose word to finde
-#' @return The first word
-strcar <- function(string) {
-  if (is.null.string(string))
-    stop('CARing null-string')
-  ref <- word.ref(string, 1)
-  substr(string, ref$start, ref$end - 1)
-}
-
-#' Words after first in a string.
-#' @param string the string whose words to find
-#' @return The words after first in the string
-strcdr <- function(string) {
-  if (is.null.string(string))
-    stop('CDRing null-string')
-  ref <- word.ref(string, 2)
-  if (ref$end < ref$start)
-    NIL.STRING
-  else
-    substr(string, ref$start, nchar(string))
-}
-
-#' Join two string.
-#' @param consor the joining string
-#' @param consee the joined string
-#' @param sep the intervening space
-#' @return The joined strings
-strcons <- function(consor, consee, sep) {
-  if (is.null.string(consee)) consor
-  else paste(consor, consee, sep=sep)
-}
-
-#' Map through the words in a string, joining the mapped
-#' words with a separator.
-#'
-#' General enough to be designated `map': isn't it closer to a
-#' specialized reduce?
-#' @param proc procedure to apply to each word
-#' @param sep the separator joining the mapped words
-#' @param string the string to be mapped
-#' @return Mapped words separated by \code{sep}
-strmap <- function(proc, sep, string) {
-  continue <- function(string)
-    if (is.null.string(string))
-      NIL.STRING
-    else
-      strcons(strcar(string),
-              continue(strcdr(string)),
-              sep=sep)
-  continue(string)
-}
-
-#' Convenience function to print variable-value pairs.
-#'
-#' @param \dots named variable of the form a=b, \dots
-#' @return NULL
-debug <- function(...) {
-  values <- list(...)
-  var.values <- zip.list(attributes(values)$names, values)
-  cat(Reduce.paste(function(var.value)
-                   sprintf('%s: %s; ', car(var.value), cadr(var.value)),
-                   var.values,
-                   NIL.STRING),
-      '\n')
-}
-
-#' Ad-hoc abstraction to paste processed list-elements together.
-#' @param proc the procedure to apply to the elements
-#' @param elts the elements to be processed
-#' @param sep the glue to joined the processed elements
-#' @return The processed elements as a glued string
-Reduce.paste <- function(proc, elts, sep)
-  Reduce(function(parsed, elt)
-         Curry(paste, sep=sep)
-         (parsed, proc(elt)),
-         elts,
-         NIL.STRING)
-
-#' Actually do the substring representation that
-#' regexpr should do; does not acknowledge groups,
-#' since \code{regexpr} doesn't.
-#' @param pattern the pattern to match
-#' @param text the text to match against
-#' @return The matched substring
-substr.regexpr <- function(pattern, text) {
-  matches <- regexpr(pattern, text, perl=TRUE)
-  if (length(match) < 1)
-    NULL
-  else {
-    start <- car(matches)
-    end <- car(attr(matches, 'match.length'))
-    substr(text, start, end)
-  }
-}
+#' @include roxygen.R
+#' @include functional.R
+#' @include list.R
+roxygen()
+
+#' Absence of words
+SPACE <- '[[:space:]]+'
+
+#' Anti-anti-words
+MATTER <- '[^[:space:]]+'
+
+#' Analogue to the empty list
+NIL.STRING <- ''
+
+#' Trim [:space:] to the left of a string.
+#' @param string the string to be trimmed
+#' @return A left-trimmed string
+trim.left <- function(string)
+  gsub(sprintf('^%s', SPACE), NIL.STRING, string)
+
+#' Trim [:space:] to the right of a string.
+#' @param string the string to be trimmed
+#' @return A right-trimmed string
+trim.right <- function(string)
+  gsub(sprintf('%s$', SPACE), NIL.STRING, string)
+
+#' Trim [:space:] on both sides of a string.
+#' @param string the string to be trimmed
+#' @return A trimmed string
+trim <- function(string)
+  Compose(trim.left, trim.right)(string)
+
+#' Does the string contain no matter, but very well [:space:]?
+#' @param string the string to check
+#' @return TRUE if the string contains words, otherwise FALSE
+is.null.string <- function(string) {
+  if (is.na(string)) FALSE
+  else regexpr(MATTER, string) < 0
+}
+
+#' Number of words a string contains.
+#' @param string the string whose words to count
+#' @return Number of words in the string
+nwords <- function(string) {
+  if (is.null.string(string)) 0
+  else length(gregexpr(MATTER, string))
+}
+
+#' Find the nth word in a string.
+#' @param string the string to search in
+#' @param n the nth word to find
+#'
+#' @return A list containing:
+#'   \item{start}{the first letter of the word.}
+#'   \item{end}{the last letter of the word.}
+#' Undefined if no such word; though \code{end} may be less than
+#' \code{start} in such a case.
+word.ref <- function(string, n) {
+  continue <- function(string, n, init) {
+    word <- regexpr(MATTER, string)
+    start <- word[[1]]
+    length <- attributes(word)$match.length[[1]]
+    end <- start + length
+    if (n <= 1) list(start=start + init, end=end + init)
+    else continue(substr(string, end, nchar(string)), n - 1, init + length)
+  }
+  continue(string, n, 0)
+}
+
+#' First word in a string.
+#' @param string the string whose word to finde
+#' @return The first word
+strcar <- function(string) {
+  if (is.null.string(string))
+    stop('CARing null-string')
+  ref <- word.ref(string, 1)
+  substr(string, ref$start, ref$end - 1)
+}
+
+#' Words after first in a string.
+#' @param string the string whose words to find
+#' @return The words after first in the string
+strcdr <- function(string) {
+  if (is.null.string(string))
+    stop('CDRing null-string')
+  ref <- word.ref(string, 2)
+  if (ref$end < ref$start)
+    NIL.STRING
+  else
+    substr(string, ref$start, nchar(string))
+}
+
+#' Join two string.
+#' @param consor the joining string
+#' @param consee the joined string
+#' @param sep the intervening space
+#' @return The joined strings
+strcons <- function(consor, consee, sep) {
+  if (is.null.string(consee)) consor
+  else paste(consor, consee, sep=sep)
+}
+
+#' Map through the words in a string, joining the mapped
+#' words with a separator.
+#'
+#' General enough to be designated `map': isn't it closer to a
+#' specialized reduce?
+#' @param proc procedure to apply to each word
+#' @param sep the separator joining the mapped words
+#' @param string the string to be mapped
+#' @return Mapped words separated by \code{sep}
+strmap <- function(proc, sep, string) {
+  continue <- function(string)
+    if (is.null.string(string))
+      NIL.STRING
+    else
+      strcons(strcar(string),
+              continue(strcdr(string)),
+              sep=sep)
+  continue(string)
+}
+
+#' Convenience function to print variable-value pairs.
+#'
+#' @param \dots named variable of the form a=b, \dots
+#' @return NULL
+debug <- function(...) {
+  values <- list(...)
+  var.values <- zip.list(attributes(values)$names, values)
+  cat(Reduce.paste(function(var.value)
+                   sprintf('%s: %s; ', car(var.value), cadr(var.value)),
+                   var.values,
+                   NIL.STRING),
+      '\n')
+}
+
+#' Ad-hoc abstraction to paste processed list-elements together.
+#' @param proc the procedure to apply to the elements
+#' @param elts the elements to be processed
+#' @param sep the glue to joined the processed elements
+#' @return The processed elements as a glued string
+Reduce.paste <- function(proc, elts, sep)
+  Reduce(function(parsed, elt)
+         Curry(paste, sep=sep)
+         (parsed, proc(elt)),
+         elts,
+         NIL.STRING)
+
+#' Actually do the substring representation that
+#' regexpr should do; does not acknowledge groups,
+#' since \code{regexpr} doesn't.
+#' @param pattern the pattern to match
+#' @param text the text to match against
+#' @return The matched substring
+substr.regexpr <- function(pattern, text) {
+  matches <- regexpr(pattern, text, perl=TRUE)
+  if (length(match) < 1)
+    NULL
+  else {
+    start <- car(matches)
+    end <- car(attr(matches, 'match.length'))
+    substr(text, start, end)
+  }
+}
+
+#' Quote characters and return all other types untouched.
+#' @param x the value to maybe quote
+#' @return The quoted character or the untouched value
+maybe.quote <- function(x) {
+  if ( is.character(x) )
+    dQuote(x)
+  else
+    x
+}

---FILE: sandbox/Rd.R---
@@ -17,3 +17,11 @@ files <- if (argc > 0) as.list(argv) else FILES
 
 roclet <- make.Rd.roclet()
 do.call(roclet$parse, files)
+
+
+### ""Missing quotes in default arguments"" bug:
+
+package.skeleton('helloRoxygen', code_files = 'hello-roxygen.R', force = TRUE)
+
+roclet <- make.Rd.roclet()
+roclet$parse('helloRoxygen/R/hello-roxygen.R')"
r-lib,roxygen2,8945475945778d930711848a53b52f82526b44f1,manuel,manuel@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2009-06-19T08:30:27Z,manuel,manuel@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2009-06-19T08:30:27Z,"Solved ""Missing quotes in default arguments"" bug (reported on Roxygen-devel, 2009/06/17.

git-svn-id: svn://svn.r-forge.r-project.org/svnroot/roxygen/pkg@225 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",R/parse.R;R/string.R;sandbox/Rd.R,False,True,True,False,183,165,348,"---FILE: R/parse.R---
@@ -366,7 +366,7 @@ parse.formals <- function(expressions) {
   else list(formals=Map(function(formal)
               if (is.null(formal)) ''
               else if (is.call(formal)) capture.output(formal)
-              else as.character(formal), formals))
+              else as.character(maybe.quote(formal)), formals))
 }
 
 #' Find the assignee of the expression

---FILE: R/string.R---
@@ -1,164 +1,174 @@
-#' @include roxygen.R
-#' @include functional.R
-#' @include list.R
-roxygen()
-
-#' Absence of words
-SPACE <- '[[:space:]]+'
-
-#' Anti-anti-words
-MATTER <- '[^[:space:]]+'
-
-#' Analogue to the empty list
-NIL.STRING <- ''
-
-#' Trim [:space:] to the left of a string.
-#' @param string the string to be trimmed
-#' @return A left-trimmed string
-trim.left <- function(string)
-  gsub(sprintf('^%s', SPACE), NIL.STRING, string)
-
-#' Trim [:space:] to the right of a string.
-#' @param string the string to be trimmed
-#' @return A right-trimmed string
-trim.right <- function(string)
-  gsub(sprintf('%s$', SPACE), NIL.STRING, string)
-
-#' Trim [:space:] on both sides of a string.
-#' @param string the string to be trimmed
-#' @return A trimmed string
-trim <- function(string)
-  Compose(trim.left, trim.right)(string)
-
-#' Does the string contain no matter, but very well [:space:]?
-#' @param string the string to check
-#' @return TRUE if the string contains words, otherwise FALSE
-is.null.string <- function(string) {
-  if (is.na(string)) FALSE
-  else regexpr(MATTER, string) < 0
-}
-
-#' Number of words a string contains.
-#' @param string the string whose words to count
-#' @return Number of words in the string
-nwords <- function(string) {
-  if (is.null.string(string)) 0
-  else length(gregexpr(MATTER, string))
-}
-
-#' Find the nth word in a string.
-#' @param string the string to search in
-#' @param n the nth word to find
-#'
-#' @return A list containing:
-#'   \item{start}{the first letter of the word.}
-#'   \item{end}{the last letter of the word.}
-#' Undefined if no such word; though \code{end} may be less than
-#' \code{start} in such a case.
-word.ref <- function(string, n) {
-  continue <- function(string, n, init) {
-    word <- regexpr(MATTER, string)
-    start <- word[[1]]
-    length <- attributes(word)$match.length[[1]]
-    end <- start + length
-    if (n <= 1) list(start=start + init, end=end + init)
-    else continue(substr(string, end, nchar(string)), n - 1, init + length)
-  }
-  continue(string, n, 0)
-}
-
-#' First word in a string.
-#' @param string the string whose word to finde
-#' @return The first word
-strcar <- function(string) {
-  if (is.null.string(string))
-    stop('CARing null-string')
-  ref <- word.ref(string, 1)
-  substr(string, ref$start, ref$end - 1)
-}
-
-#' Words after first in a string.
-#' @param string the string whose words to find
-#' @return The words after first in the string
-strcdr <- function(string) {
-  if (is.null.string(string))
-    stop('CDRing null-string')
-  ref <- word.ref(string, 2)
-  if (ref$end < ref$start)
-    NIL.STRING
-  else
-    substr(string, ref$start, nchar(string))
-}
-
-#' Join two string.
-#' @param consor the joining string
-#' @param consee the joined string
-#' @param sep the intervening space
-#' @return The joined strings
-strcons <- function(consor, consee, sep) {
-  if (is.null.string(consee)) consor
-  else paste(consor, consee, sep=sep)
-}
-
-#' Map through the words in a string, joining the mapped
-#' words with a separator.
-#'
-#' General enough to be designated `map': isn't it closer to a
-#' specialized reduce?
-#' @param proc procedure to apply to each word
-#' @param sep the separator joining the mapped words
-#' @param string the string to be mapped
-#' @return Mapped words separated by \code{sep}
-strmap <- function(proc, sep, string) {
-  continue <- function(string)
-    if (is.null.string(string))
-      NIL.STRING
-    else
-      strcons(strcar(string),
-              continue(strcdr(string)),
-              sep=sep)
-  continue(string)
-}
-
-#' Convenience function to print variable-value pairs.
-#'
-#' @param \dots named variable of the form a=b, \dots
-#' @return NULL
-debug <- function(...) {
-  values <- list(...)
-  var.values <- zip.list(attributes(values)$names, values)
-  cat(Reduce.paste(function(var.value)
-                   sprintf('%s: %s; ', car(var.value), cadr(var.value)),
-                   var.values,
-                   NIL.STRING),
-      '\n')
-}
-
-#' Ad-hoc abstraction to paste processed list-elements together.
-#' @param proc the procedure to apply to the elements
-#' @param elts the elements to be processed
-#' @param sep the glue to joined the processed elements
-#' @return The processed elements as a glued string
-Reduce.paste <- function(proc, elts, sep)
-  Reduce(function(parsed, elt)
-         Curry(paste, sep=sep)
-         (parsed, proc(elt)),
-         elts,
-         NIL.STRING)
-
-#' Actually do the substring representation that
-#' regexpr should do; does not acknowledge groups,
-#' since \code{regexpr} doesn't.
-#' @param pattern the pattern to match
-#' @param text the text to match against
-#' @return The matched substring
-substr.regexpr <- function(pattern, text) {
-  matches <- regexpr(pattern, text, perl=TRUE)
-  if (length(match) < 1)
-    NULL
-  else {
-    start <- car(matches)
-    end <- car(attr(matches, 'match.length'))
-    substr(text, start, end)
-  }
-}
+#' @include roxygen.R
+#' @include functional.R
+#' @include list.R
+roxygen()
+
+#' Absence of words
+SPACE <- '[[:space:]]+'
+
+#' Anti-anti-words
+MATTER <- '[^[:space:]]+'
+
+#' Analogue to the empty list
+NIL.STRING <- ''
+
+#' Trim [:space:] to the left of a string.
+#' @param string the string to be trimmed
+#' @return A left-trimmed string
+trim.left <- function(string)
+  gsub(sprintf('^%s', SPACE), NIL.STRING, string)
+
+#' Trim [:space:] to the right of a string.
+#' @param string the string to be trimmed
+#' @return A right-trimmed string
+trim.right <- function(string)
+  gsub(sprintf('%s$', SPACE), NIL.STRING, string)
+
+#' Trim [:space:] on both sides of a string.
+#' @param string the string to be trimmed
+#' @return A trimmed string
+trim <- function(string)
+  Compose(trim.left, trim.right)(string)
+
+#' Does the string contain no matter, but very well [:space:]?
+#' @param string the string to check
+#' @return TRUE if the string contains words, otherwise FALSE
+is.null.string <- function(string) {
+  if (is.na(string)) FALSE
+  else regexpr(MATTER, string) < 0
+}
+
+#' Number of words a string contains.
+#' @param string the string whose words to count
+#' @return Number of words in the string
+nwords <- function(string) {
+  if (is.null.string(string)) 0
+  else length(gregexpr(MATTER, string))
+}
+
+#' Find the nth word in a string.
+#' @param string the string to search in
+#' @param n the nth word to find
+#'
+#' @return A list containing:
+#'   \item{start}{the first letter of the word.}
+#'   \item{end}{the last letter of the word.}
+#' Undefined if no such word; though \code{end} may be less than
+#' \code{start} in such a case.
+word.ref <- function(string, n) {
+  continue <- function(string, n, init) {
+    word <- regexpr(MATTER, string)
+    start <- word[[1]]
+    length <- attributes(word)$match.length[[1]]
+    end <- start + length
+    if (n <= 1) list(start=start + init, end=end + init)
+    else continue(substr(string, end, nchar(string)), n - 1, init + length)
+  }
+  continue(string, n, 0)
+}
+
+#' First word in a string.
+#' @param string the string whose word to finde
+#' @return The first word
+strcar <- function(string) {
+  if (is.null.string(string))
+    stop('CARing null-string')
+  ref <- word.ref(string, 1)
+  substr(string, ref$start, ref$end - 1)
+}
+
+#' Words after first in a string.
+#' @param string the string whose words to find
+#' @return The words after first in the string
+strcdr <- function(string) {
+  if (is.null.string(string))
+    stop('CDRing null-string')
+  ref <- word.ref(string, 2)
+  if (ref$end < ref$start)
+    NIL.STRING
+  else
+    substr(string, ref$start, nchar(string))
+}
+
+#' Join two string.
+#' @param consor the joining string
+#' @param consee the joined string
+#' @param sep the intervening space
+#' @return The joined strings
+strcons <- function(consor, consee, sep) {
+  if (is.null.string(consee)) consor
+  else paste(consor, consee, sep=sep)
+}
+
+#' Map through the words in a string, joining the mapped
+#' words with a separator.
+#'
+#' General enough to be designated `map': isn't it closer to a
+#' specialized reduce?
+#' @param proc procedure to apply to each word
+#' @param sep the separator joining the mapped words
+#' @param string the string to be mapped
+#' @return Mapped words separated by \code{sep}
+strmap <- function(proc, sep, string) {
+  continue <- function(string)
+    if (is.null.string(string))
+      NIL.STRING
+    else
+      strcons(strcar(string),
+              continue(strcdr(string)),
+              sep=sep)
+  continue(string)
+}
+
+#' Convenience function to print variable-value pairs.
+#'
+#' @param \dots named variable of the form a=b, \dots
+#' @return NULL
+debug <- function(...) {
+  values <- list(...)
+  var.values <- zip.list(attributes(values)$names, values)
+  cat(Reduce.paste(function(var.value)
+                   sprintf('%s: %s; ', car(var.value), cadr(var.value)),
+                   var.values,
+                   NIL.STRING),
+      '\n')
+}
+
+#' Ad-hoc abstraction to paste processed list-elements together.
+#' @param proc the procedure to apply to the elements
+#' @param elts the elements to be processed
+#' @param sep the glue to joined the processed elements
+#' @return The processed elements as a glued string
+Reduce.paste <- function(proc, elts, sep)
+  Reduce(function(parsed, elt)
+         Curry(paste, sep=sep)
+         (parsed, proc(elt)),
+         elts,
+         NIL.STRING)
+
+#' Actually do the substring representation that
+#' regexpr should do; does not acknowledge groups,
+#' since \code{regexpr} doesn't.
+#' @param pattern the pattern to match
+#' @param text the text to match against
+#' @return The matched substring
+substr.regexpr <- function(pattern, text) {
+  matches <- regexpr(pattern, text, perl=TRUE)
+  if (length(match) < 1)
+    NULL
+  else {
+    start <- car(matches)
+    end <- car(attr(matches, 'match.length'))
+    substr(text, start, end)
+  }
+}
+
+#' Quote characters and return all other types untouched.
+#' @param x the value to maybe quote
+#' @return The quoted character or the untouched value
+maybe.quote <- function(x) {
+  if ( is.character(x) )
+    dQuote(x)
+  else
+    x
+}

---FILE: sandbox/Rd.R---
@@ -17,3 +17,11 @@ files <- if (argc > 0) as.list(argv) else FILES
 
 roclet <- make.Rd.roclet()
 do.call(roclet$parse, files)
+
+
+### ""Missing quotes in default arguments"" bug:
+
+package.skeleton('helloRoxygen', code_files = 'hello-roxygen.R', force = TRUE)
+
+roclet <- make.Rd.roclet()
+roclet$parse('helloRoxygen/R/hello-roxygen.R')"
r-lib,roxygen2,44d109a36e0478d39a5a5b43c92daa1330d8e4c3,manuel,manuel@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2009-06-19T08:30:27Z,manuel,manuel@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2009-06-19T08:30:27Z,"Solved ""Missing quotes in default arguments"" bug (reported on Roxygen-devel, 2009/06/17.

git-svn-id: svn+ssh://svn.r-forge.r-project.org/svnroot/roxygen@225 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",pkg/R/parse.R;pkg/R/string.R;pkg/sandbox/Rd.R,False,True,True,False,183,165,348,"---FILE: pkg/R/parse.R---
@@ -366,7 +366,7 @@ parse.formals <- function(expressions) {
   else list(formals=Map(function(formal)
               if (is.null(formal)) ''
               else if (is.call(formal)) capture.output(formal)
-              else as.character(formal), formals))
+              else as.character(maybe.quote(formal)), formals))
 }
 
 #' Find the assignee of the expression

---FILE: pkg/R/string.R---
@@ -1,164 +1,174 @@
-#' @include roxygen.R
-#' @include functional.R
-#' @include list.R
-roxygen()
-
-#' Absence of words
-SPACE <- '[[:space:]]+'
-
-#' Anti-anti-words
-MATTER <- '[^[:space:]]+'
-
-#' Analogue to the empty list
-NIL.STRING <- ''
-
-#' Trim [:space:] to the left of a string.
-#' @param string the string to be trimmed
-#' @return A left-trimmed string
-trim.left <- function(string)
-  gsub(sprintf('^%s', SPACE), NIL.STRING, string)
-
-#' Trim [:space:] to the right of a string.
-#' @param string the string to be trimmed
-#' @return A right-trimmed string
-trim.right <- function(string)
-  gsub(sprintf('%s$', SPACE), NIL.STRING, string)
-
-#' Trim [:space:] on both sides of a string.
-#' @param string the string to be trimmed
-#' @return A trimmed string
-trim <- function(string)
-  Compose(trim.left, trim.right)(string)
-
-#' Does the string contain no matter, but very well [:space:]?
-#' @param string the string to check
-#' @return TRUE if the string contains words, otherwise FALSE
-is.null.string <- function(string) {
-  if (is.na(string)) FALSE
-  else regexpr(MATTER, string) < 0
-}
-
-#' Number of words a string contains.
-#' @param string the string whose words to count
-#' @return Number of words in the string
-nwords <- function(string) {
-  if (is.null.string(string)) 0
-  else length(gregexpr(MATTER, string))
-}
-
-#' Find the nth word in a string.
-#' @param string the string to search in
-#' @param n the nth word to find
-#'
-#' @return A list containing:
-#'   \item{start}{the first letter of the word.}
-#'   \item{end}{the last letter of the word.}
-#' Undefined if no such word; though \code{end} may be less than
-#' \code{start} in such a case.
-word.ref <- function(string, n) {
-  continue <- function(string, n, init) {
-    word <- regexpr(MATTER, string)
-    start <- word[[1]]
-    length <- attributes(word)$match.length[[1]]
-    end <- start + length
-    if (n <= 1) list(start=start + init, end=end + init)
-    else continue(substr(string, end, nchar(string)), n - 1, init + length)
-  }
-  continue(string, n, 0)
-}
-
-#' First word in a string.
-#' @param string the string whose word to finde
-#' @return The first word
-strcar <- function(string) {
-  if (is.null.string(string))
-    stop('CARing null-string')
-  ref <- word.ref(string, 1)
-  substr(string, ref$start, ref$end - 1)
-}
-
-#' Words after first in a string.
-#' @param string the string whose words to find
-#' @return The words after first in the string
-strcdr <- function(string) {
-  if (is.null.string(string))
-    stop('CDRing null-string')
-  ref <- word.ref(string, 2)
-  if (ref$end < ref$start)
-    NIL.STRING
-  else
-    substr(string, ref$start, nchar(string))
-}
-
-#' Join two string.
-#' @param consor the joining string
-#' @param consee the joined string
-#' @param sep the intervening space
-#' @return The joined strings
-strcons <- function(consor, consee, sep) {
-  if (is.null.string(consee)) consor
-  else paste(consor, consee, sep=sep)
-}
-
-#' Map through the words in a string, joining the mapped
-#' words with a separator.
-#'
-#' General enough to be designated `map': isn't it closer to a
-#' specialized reduce?
-#' @param proc procedure to apply to each word
-#' @param sep the separator joining the mapped words
-#' @param string the string to be mapped
-#' @return Mapped words separated by \code{sep}
-strmap <- function(proc, sep, string) {
-  continue <- function(string)
-    if (is.null.string(string))
-      NIL.STRING
-    else
-      strcons(strcar(string),
-              continue(strcdr(string)),
-              sep=sep)
-  continue(string)
-}
-
-#' Convenience function to print variable-value pairs.
-#'
-#' @param \dots named variable of the form a=b, \dots
-#' @return NULL
-debug <- function(...) {
-  values <- list(...)
-  var.values <- zip.list(attributes(values)$names, values)
-  cat(Reduce.paste(function(var.value)
-                   sprintf('%s: %s; ', car(var.value), cadr(var.value)),
-                   var.values,
-                   NIL.STRING),
-      '\n')
-}
-
-#' Ad-hoc abstraction to paste processed list-elements together.
-#' @param proc the procedure to apply to the elements
-#' @param elts the elements to be processed
-#' @param sep the glue to joined the processed elements
-#' @return The processed elements as a glued string
-Reduce.paste <- function(proc, elts, sep)
-  Reduce(function(parsed, elt)
-         Curry(paste, sep=sep)
-         (parsed, proc(elt)),
-         elts,
-         NIL.STRING)
-
-#' Actually do the substring representation that
-#' regexpr should do; does not acknowledge groups,
-#' since \code{regexpr} doesn't.
-#' @param pattern the pattern to match
-#' @param text the text to match against
-#' @return The matched substring
-substr.regexpr <- function(pattern, text) {
-  matches <- regexpr(pattern, text, perl=TRUE)
-  if (length(match) < 1)
-    NULL
-  else {
-    start <- car(matches)
-    end <- car(attr(matches, 'match.length'))
-    substr(text, start, end)
-  }
-}
+#' @include roxygen.R
+#' @include functional.R
+#' @include list.R
+roxygen()
+
+#' Absence of words
+SPACE <- '[[:space:]]+'
+
+#' Anti-anti-words
+MATTER <- '[^[:space:]]+'
+
+#' Analogue to the empty list
+NIL.STRING <- ''
+
+#' Trim [:space:] to the left of a string.
+#' @param string the string to be trimmed
+#' @return A left-trimmed string
+trim.left <- function(string)
+  gsub(sprintf('^%s', SPACE), NIL.STRING, string)
+
+#' Trim [:space:] to the right of a string.
+#' @param string the string to be trimmed
+#' @return A right-trimmed string
+trim.right <- function(string)
+  gsub(sprintf('%s$', SPACE), NIL.STRING, string)
+
+#' Trim [:space:] on both sides of a string.
+#' @param string the string to be trimmed
+#' @return A trimmed string
+trim <- function(string)
+  Compose(trim.left, trim.right)(string)
+
+#' Does the string contain no matter, but very well [:space:]?
+#' @param string the string to check
+#' @return TRUE if the string contains words, otherwise FALSE
+is.null.string <- function(string) {
+  if (is.na(string)) FALSE
+  else regexpr(MATTER, string) < 0
+}
+
+#' Number of words a string contains.
+#' @param string the string whose words to count
+#' @return Number of words in the string
+nwords <- function(string) {
+  if (is.null.string(string)) 0
+  else length(gregexpr(MATTER, string))
+}
+
+#' Find the nth word in a string.
+#' @param string the string to search in
+#' @param n the nth word to find
+#'
+#' @return A list containing:
+#'   \item{start}{the first letter of the word.}
+#'   \item{end}{the last letter of the word.}
+#' Undefined if no such word; though \code{end} may be less than
+#' \code{start} in such a case.
+word.ref <- function(string, n) {
+  continue <- function(string, n, init) {
+    word <- regexpr(MATTER, string)
+    start <- word[[1]]
+    length <- attributes(word)$match.length[[1]]
+    end <- start + length
+    if (n <= 1) list(start=start + init, end=end + init)
+    else continue(substr(string, end, nchar(string)), n - 1, init + length)
+  }
+  continue(string, n, 0)
+}
+
+#' First word in a string.
+#' @param string the string whose word to finde
+#' @return The first word
+strcar <- function(string) {
+  if (is.null.string(string))
+    stop('CARing null-string')
+  ref <- word.ref(string, 1)
+  substr(string, ref$start, ref$end - 1)
+}
+
+#' Words after first in a string.
+#' @param string the string whose words to find
+#' @return The words after first in the string
+strcdr <- function(string) {
+  if (is.null.string(string))
+    stop('CDRing null-string')
+  ref <- word.ref(string, 2)
+  if (ref$end < ref$start)
+    NIL.STRING
+  else
+    substr(string, ref$start, nchar(string))
+}
+
+#' Join two string.
+#' @param consor the joining string
+#' @param consee the joined string
+#' @param sep the intervening space
+#' @return The joined strings
+strcons <- function(consor, consee, sep) {
+  if (is.null.string(consee)) consor
+  else paste(consor, consee, sep=sep)
+}
+
+#' Map through the words in a string, joining the mapped
+#' words with a separator.
+#'
+#' General enough to be designated `map': isn't it closer to a
+#' specialized reduce?
+#' @param proc procedure to apply to each word
+#' @param sep the separator joining the mapped words
+#' @param string the string to be mapped
+#' @return Mapped words separated by \code{sep}
+strmap <- function(proc, sep, string) {
+  continue <- function(string)
+    if (is.null.string(string))
+      NIL.STRING
+    else
+      strcons(strcar(string),
+              continue(strcdr(string)),
+              sep=sep)
+  continue(string)
+}
+
+#' Convenience function to print variable-value pairs.
+#'
+#' @param \dots named variable of the form a=b, \dots
+#' @return NULL
+debug <- function(...) {
+  values <- list(...)
+  var.values <- zip.list(attributes(values)$names, values)
+  cat(Reduce.paste(function(var.value)
+                   sprintf('%s: %s; ', car(var.value), cadr(var.value)),
+                   var.values,
+                   NIL.STRING),
+      '\n')
+}
+
+#' Ad-hoc abstraction to paste processed list-elements together.
+#' @param proc the procedure to apply to the elements
+#' @param elts the elements to be processed
+#' @param sep the glue to joined the processed elements
+#' @return The processed elements as a glued string
+Reduce.paste <- function(proc, elts, sep)
+  Reduce(function(parsed, elt)
+         Curry(paste, sep=sep)
+         (parsed, proc(elt)),
+         elts,
+         NIL.STRING)
+
+#' Actually do the substring representation that
+#' regexpr should do; does not acknowledge groups,
+#' since \code{regexpr} doesn't.
+#' @param pattern the pattern to match
+#' @param text the text to match against
+#' @return The matched substring
+substr.regexpr <- function(pattern, text) {
+  matches <- regexpr(pattern, text, perl=TRUE)
+  if (length(match) < 1)
+    NULL
+  else {
+    start <- car(matches)
+    end <- car(attr(matches, 'match.length'))
+    substr(text, start, end)
+  }
+}
+
+#' Quote characters and return all other types untouched.
+#' @param x the value to maybe quote
+#' @return The quoted character or the untouched value
+maybe.quote <- function(x) {
+  if ( is.character(x) )
+    dQuote(x)
+  else
+    x
+}

---FILE: pkg/sandbox/Rd.R---
@@ -17,3 +17,11 @@ files <- if (argc > 0) as.list(argv) else FILES
 
 roclet <- make.Rd.roclet()
 do.call(roclet$parse, files)
+
+
+### ""Missing quotes in default arguments"" bug:
+
+package.skeleton('helloRoxygen', code_files = 'hello-roxygen.R', force = TRUE)
+
+roclet <- make.Rd.roclet()
+roclet$parse('helloRoxygen/R/hello-roxygen.R')"
r-lib,roxygen2,d76a5add44ef30a7a85680ba7ca6d5756c8324f6,Peter Danenberg,pcd@roxygen.org,2009-01-29T18:34:12Z,Peter Danenberg,pcd@roxygen.org,2009-01-29T18:34:12Z,"change is.null.string to handle NA (bug?)


git-svn-id: svn://svn.r-forge.r-project.org/svnroot/roxygen/pkg@214 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",R/string.R,False,True,True,False,4,2,6,"---FILE: R/string.R---
@@ -33,8 +33,10 @@ trim <- function(string)
 #' Does the string contain no matter, but very well [:space:]?
 #' @param string the string to check
 #' @return TRUE if the string contains words, otherwise FALSE
-is.null.string <- function(string)
-  regexpr(MATTER, string) < 0
+is.null.string <- function(string) {
+  if (is.na(string)) FALSE
+  else regexpr(MATTER, string) < 0
+}
 
 #' Number of words a string contains.
 #' @param string the string whose words to count"
r-lib,roxygen2,307585c21e4d7e329ff71651463fffc6cc9f0d07,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2009-01-29T18:34:12Z,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2009-01-29T18:34:12Z,"change is.null.string to handle NA (bug?)


git-svn-id: svn://svn.r-forge.r-project.org/svnroot/roxygen/pkg@214 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",R/string.R,False,True,True,False,4,2,6,"---FILE: R/string.R---
@@ -33,8 +33,10 @@ trim <- function(string)
 #' Does the string contain no matter, but very well [:space:]?
 #' @param string the string to check
 #' @return TRUE if the string contains words, otherwise FALSE
-is.null.string <- function(string)
-  regexpr(MATTER, string) < 0
+is.null.string <- function(string) {
+  if (is.na(string)) FALSE
+  else regexpr(MATTER, string) < 0
+}
 
 #' Number of words a string contains.
 #' @param string the string whose words to count"
r-lib,roxygen2,b821288f5f669064e04656f6b3fd5e5c87dad9d4,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2009-01-29T18:34:12Z,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2009-01-29T18:34:12Z,"change is.null.string to handle NA (bug?)


git-svn-id: svn+ssh://svn.r-forge.r-project.org/svnroot/roxygen@214 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",pkg/R/string.R,False,True,True,False,4,2,6,"---FILE: pkg/R/string.R---
@@ -33,8 +33,10 @@ trim <- function(string)
 #' Does the string contain no matter, but very well [:space:]?
 #' @param string the string to check
 #' @return TRUE if the string contains words, otherwise FALSE
-is.null.string <- function(string)
-  regexpr(MATTER, string) < 0
+is.null.string <- function(string) {
+  if (is.na(string)) FALSE
+  else regexpr(MATTER, string) < 0
+}
 
 #' Number of words a string contains.
 #' @param string the string whose words to count"
r-lib,roxygen2,32bebc794d0680de6207ad2afec9b65f51d77d33,Peter Danenberg,pcd@roxygen.org,2008-09-03T19:01:27Z,Peter Danenberg,pcd@roxygen.org,2008-09-03T19:01:27Z,"URL fix; thanks, tobias


git-svn-id: svn://svn.r-forge.r-project.org/svnroot/roxygen/pkg@208 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",README;man/assign.parent.Rd;sandbox/example-function-mcpi.R,False,True,True,False,6,2,8,"---FILE: README---
@@ -73,5 +73,9 @@ all' hileth', Hephaiste; didou d'areten te kai olbon.*
 
   * `<<' in titles produces a spurious box.
 
+1.4. THANKS
+
+  * Tobias Verbeke, for catching an unadorned URL.
+
 -----------
 * Hail, Hephaistos! Grant skill and weal.

---FILE: man/assign.parent.Rd---
@@ -3,7 +3,7 @@
 \title{Assign a variable in the parent environment when <<-...}
 \usage{assign.parent(var, value, env)}
 \description{Assign a variable in the parent environment when \code{<<-}
-doesn't see to work.}
+doesn't seem to work.}
 \value{NULL}
 \arguments{\item{var}{string of the variable to assign}
 \item{value}{value to be assigned}

---FILE: sandbox/example-function-mcpi.R---
@@ -9,7 +9,7 @@
 #'
 #' @return The approximation of PI
 #'
-#' @references http://www.datastructures.info/the-monte-carlo-algorithmmethod/
+#' @references \url{http://www.datastructures.info/the-monte-carlo-algorithmmethod/}
 #' @author Manuel J. A. Eugster
 mcpi <- function(trials, verbose=FALSE) {
   hits <- 0                             #' Number of successfull trials"
r-lib,roxygen2,fb4f74c25502991d1732cf38bce9ae65a55288e5,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-09-03T19:01:27Z,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-09-03T19:01:27Z,"URL fix; thanks, tobias


git-svn-id: svn://svn.r-forge.r-project.org/svnroot/roxygen/pkg@208 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",README;man/assign.parent.Rd;sandbox/example-function-mcpi.R,False,True,True,False,6,2,8,"---FILE: README---
@@ -73,5 +73,9 @@ all' hileth', Hephaiste; didou d'areten te kai olbon.*
 
   * `<<' in titles produces a spurious box.
 
+1.4. THANKS
+
+  * Tobias Verbeke, for catching an unadorned URL.
+
 -----------
 * Hail, Hephaistos! Grant skill and weal.

---FILE: man/assign.parent.Rd---
@@ -3,7 +3,7 @@
 \title{Assign a variable in the parent environment when <<-...}
 \usage{assign.parent(var, value, env)}
 \description{Assign a variable in the parent environment when \code{<<-}
-doesn't see to work.}
+doesn't seem to work.}
 \value{NULL}
 \arguments{\item{var}{string of the variable to assign}
 \item{value}{value to be assigned}

---FILE: sandbox/example-function-mcpi.R---
@@ -9,7 +9,7 @@
 #'
 #' @return The approximation of PI
 #'
-#' @references http://www.datastructures.info/the-monte-carlo-algorithmmethod/
+#' @references \url{http://www.datastructures.info/the-monte-carlo-algorithmmethod/}
 #' @author Manuel J. A. Eugster
 mcpi <- function(trials, verbose=FALSE) {
   hits <- 0                             #' Number of successfull trials"
r-lib,roxygen2,a12a26d6d19e3a4805d1a700a1a6074b438cf992,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-09-03T19:01:27Z,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-09-03T19:01:27Z,"URL fix; thanks, tobias


git-svn-id: svn+ssh://svn.r-forge.r-project.org/svnroot/roxygen@208 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",pkg/README;pkg/man/assign.parent.Rd;pkg/sandbox/example-function-mcpi.R,False,True,True,False,6,2,8,"---FILE: pkg/README---
@@ -73,5 +73,9 @@ all' hileth', Hephaiste; didou d'areten te kai olbon.*
 
   * `<<' in titles produces a spurious box.
 
+1.4. THANKS
+
+  * Tobias Verbeke, for catching an unadorned URL.
+
 -----------
 * Hail, Hephaistos! Grant skill and weal.

---FILE: pkg/man/assign.parent.Rd---
@@ -3,7 +3,7 @@
 \title{Assign a variable in the parent environment when <<-...}
 \usage{assign.parent(var, value, env)}
 \description{Assign a variable in the parent environment when \code{<<-}
-doesn't see to work.}
+doesn't seem to work.}
 \value{NULL}
 \arguments{\item{var}{string of the variable to assign}
 \item{value}{value to be assigned}

---FILE: pkg/sandbox/example-function-mcpi.R---
@@ -9,7 +9,7 @@
 #'
 #' @return The approximation of PI
 #'
-#' @references http://www.datastructures.info/the-monte-carlo-algorithmmethod/
+#' @references \url{http://www.datastructures.info/the-monte-carlo-algorithmmethod/}
 #' @author Manuel J. A. Eugster
 mcpi <- function(trials, verbose=FALSE) {
   hits <- 0                             #' Number of successfull trials"
r-lib,roxygen2,83ff6288ca55ead3db60f62bd76958bc78780de4,Peter Danenberg,pcd@roxygen.org,2008-08-25T11:40:59Z,Peter Danenberg,pcd@roxygen.org,2008-08-25T11:40:59Z,"fix callgraph terminating }s; VignetteIndexEntry


git-svn-id: svn://svn.r-forge.r-project.org/svnroot/roxygen/pkg@183 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",R/callgraph.R;inst/doc/Makefile;inst/doc/roxygen.Rnw,False,True,True,False,7,2,9,"---FILE: R/callgraph.R---
@@ -19,10 +19,11 @@ register.preref.parsers(parse.toggle,
 #' \enumerate{
 #' \item{\code{@@callGraph}}{Create a call graph of the default
 #'   depth (currently 2), excluding primitive functions.}
-#' \item{\code{@@callGraphPrimitives}{Create a call graph of the
+#' \item{\code{@@callGraphPrimitives}}{Create a call graph of the
 #'   default depth (currently 2), including primitive functions.}
-#' \item{\code{@@callGraphDepth}{Change the depth of the callgraph
+#' \item{\code{@@callGraphDepth}}{Change the depth of the callgraph
 #'   from the default of 2.}
+#' }
 #'
 #' The callgraph roclet is awkward in the sense that
 #' it requires a function's package to be loadable;

---FILE: inst/doc/Makefile---
@@ -0,0 +1,3 @@
+roxygen.pdf: roxygen.tex
+	pdflatex roxygen && \
+	pdflatex roxygen

---FILE: inst/doc/roxygen.Rnw---
@@ -1,6 +1,7 @@
 \documentclass{article}
 \usepackage{fancyvrb}
 \usepackage{url}
+%% \VignetteIndexEntry{Roxygen Vignette}
 \newcommand{\Roxygen}{\texttt{Roxygen}}
 %% filename, caption, label
 \newcommand{\listing}[3]{        %"
r-lib,roxygen2,ebb8ecc55db4fff95b392c89e9fea9634c1bfa88,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-08-25T11:40:59Z,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-08-25T11:40:59Z,"fix callgraph terminating }s; VignetteIndexEntry


git-svn-id: svn://svn.r-forge.r-project.org/svnroot/roxygen/pkg@183 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",R/callgraph.R;inst/doc/Makefile;inst/doc/roxygen.Rnw,False,True,True,False,7,2,9,"---FILE: R/callgraph.R---
@@ -19,10 +19,11 @@ register.preref.parsers(parse.toggle,
 #' \enumerate{
 #' \item{\code{@@callGraph}}{Create a call graph of the default
 #'   depth (currently 2), excluding primitive functions.}
-#' \item{\code{@@callGraphPrimitives}{Create a call graph of the
+#' \item{\code{@@callGraphPrimitives}}{Create a call graph of the
 #'   default depth (currently 2), including primitive functions.}
-#' \item{\code{@@callGraphDepth}{Change the depth of the callgraph
+#' \item{\code{@@callGraphDepth}}{Change the depth of the callgraph
 #'   from the default of 2.}
+#' }
 #'
 #' The callgraph roclet is awkward in the sense that
 #' it requires a function's package to be loadable;

---FILE: inst/doc/Makefile---
@@ -0,0 +1,3 @@
+roxygen.pdf: roxygen.tex
+	pdflatex roxygen && \
+	pdflatex roxygen

---FILE: inst/doc/roxygen.Rnw---
@@ -1,6 +1,7 @@
 \documentclass{article}
 \usepackage{fancyvrb}
 \usepackage{url}
+%% \VignetteIndexEntry{Roxygen Vignette}
 \newcommand{\Roxygen}{\texttt{Roxygen}}
 %% filename, caption, label
 \newcommand{\listing}[3]{        %"
r-lib,roxygen2,ea46525e44df488556882794a4b0d3b2ad0f973f,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-08-25T11:40:59Z,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-08-25T11:40:59Z,"fix callgraph terminating }s; VignetteIndexEntry


git-svn-id: svn+ssh://svn.r-forge.r-project.org/svnroot/roxygen@183 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",pkg/R/callgraph.R;pkg/inst/doc/Makefile;pkg/inst/doc/roxygen.Rnw,False,True,True,False,7,2,9,"---FILE: pkg/R/callgraph.R---
@@ -19,10 +19,11 @@ register.preref.parsers(parse.toggle,
 #' \enumerate{
 #' \item{\code{@@callGraph}}{Create a call graph of the default
 #'   depth (currently 2), excluding primitive functions.}
-#' \item{\code{@@callGraphPrimitives}{Create a call graph of the
+#' \item{\code{@@callGraphPrimitives}}{Create a call graph of the
 #'   default depth (currently 2), including primitive functions.}
-#' \item{\code{@@callGraphDepth}{Change the depth of the callgraph
+#' \item{\code{@@callGraphDepth}}{Change the depth of the callgraph
 #'   from the default of 2.}
+#' }
 #'
 #' The callgraph roclet is awkward in the sense that
 #' it requires a function's package to be loadable;

---FILE: pkg/inst/doc/Makefile---
@@ -0,0 +1,3 @@
+roxygen.pdf: roxygen.tex
+	pdflatex roxygen && \
+	pdflatex roxygen

---FILE: pkg/inst/doc/roxygen.Rnw---
@@ -1,6 +1,7 @@
 \documentclass{article}
 \usepackage{fancyvrb}
 \usepackage{url}
+%% \VignetteIndexEntry{Roxygen Vignette}
 \newcommand{\Roxygen}{\texttt{Roxygen}}
 %% filename, caption, label
 \newcommand{\listing}[3]{        %"
r-lib,roxygen2,c6e5cfbdae693a3291848ff88c8b2b61798d1bd1,Peter Danenberg,pcd@roxygen.org,2008-08-03T01:30:53Z,Peter Danenberg,pcd@roxygen.org,2008-08-03T01:30:53Z,"abstract substr.regexpr; fix description.dependencies to deal with version; keep toFile-formals until 19.2 becomes mainstream


git-svn-id: svn://svn.r-forge.r-project.org/svnroot/roxygen/pkg@151 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",DESCRIPTION;R/callgraph.R;R/description.R;R/string.R;sandbox/description.R,False,True,True,False,26,16,42,"---FILE: DESCRIPTION---
@@ -7,4 +7,4 @@ Author: Peter Danenberg <pcd@roxygen.org>,
         Manuel Eugster <Manuel.Eugster@stat.uni-muenchen.de>
 Maintainer: Peter Danenberg <pcd@roxygen.org>
 URL: http://roxygen.org
-Suggests: Rgraphviz
+Suggests: Rgraphviz (>= 1.19.2)

---FILE: R/callgraph.R---
@@ -157,6 +157,8 @@ make.callgraph.roclet <- function(dependencies=NULL,
   graphviz <- function(subcalls) {
     FORMAT <- 'pdf'
     
+    ## This should be in here until the current Rgraphviz (19.2)
+    ## becomes mainstream.
     formals(toFile) <- alist(graph=,
                              layoutType=c(""dot"", ""neato"", ""twopi"",
                                ""circo"", ""fdp""),

---FILE: R/description.R---
@@ -1,5 +1,7 @@
 #' @include roxygen.R
 #' @include list.R
+#' @include string.R
+#' @include functional.R
 roxygen()
 
 #' Parse lines of text corresponding to a package DESCRIPTION file.
@@ -14,19 +16,8 @@ parse.description.text <- function(description) {
   contains.field <- function(line)
     length(grep(paste(FIELD, SEPARATOR, sep=''), line)) > 0
 
-  substr.regexp <- function(pattern, text) {
-    matches <- regexpr(pattern, text, perl=TRUE)
-    if (length(match) < 1)
-      NULL
-    else {
-      start <- car(matches)
-      end <- car(attr(matches, 'match.length'))
-      substr(text, start, end)
-    }
-  }
-
   field <- function(line)
-    substr.regexp(FIELD, line)
+    substr.regexpr(FIELD, line)
   
   rest <- function(line)
     substr(line, nchar(field(line)) + 2, nchar(line))
@@ -130,11 +121,12 @@ make.description.parser <- function(parse.default=cat.description,
 description.dependencies <- function(description.file) {
   dependencies <- NULL
   split.dependencies <- function(parsed.fields)
-    car(strsplit(dependencies, split='[[:space:]]+'))
+    Map(Curry(substr.regexpr, pattern='[^[:space:](]*'),
+        trim(car(strsplit(dependencies, split=',', fixed=TRUE))))
   parser <- make.description.parser(noop.description,
                                     post.parse=split.dependencies)
   augment.dependencies <- function(field, value)
-    dependencies <<- paste(value, dependencies)
+    dependencies <<- paste(value, dependencies, sep=',')
   
   parser$register.parsers(augment.dependencies,
                           'Package',

---FILE: R/string.R---
@@ -143,3 +143,20 @@ Reduce.paste <- function(proc, elts, sep)
          (parsed, proc(elt)),
          elts,
          NIL.STRING)
+
+#' Actually do the substring representation that
+#' regexpr should do; does not acknowledge groups,
+#' since \code{regexpr} doesn't.
+#' @param pattern the pattern to match
+#' @param text the text to match against
+#' @return The matched substring
+substr.regexpr <- function(pattern, text) {
+  matches <- regexpr(pattern, text, perl=TRUE)
+  if (length(match) < 1)
+    NULL
+  else {
+    start <- car(matches)
+    end <- car(attr(matches, 'match.length'))
+    substr(text, start, end)
+  }
+}

---FILE: sandbox/description.R---
@@ -5,5 +5,4 @@ source('../R/string.R')
 source('../R/description.R')
 
 parser <- make.description.parser()
-## parser$parse(parse.description.file('../DESCRIPTION'))
 description.dependencies('../DESCRIPTION')"
r-lib,roxygen2,be33f0e0dcc1a1d7efeaf1aed42af89b5b64dec6,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-08-03T01:30:53Z,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-08-03T01:30:53Z,"abstract substr.regexpr; fix description.dependencies to deal with version; keep toFile-formals until 19.2 becomes mainstream


git-svn-id: svn://svn.r-forge.r-project.org/svnroot/roxygen/pkg@151 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",DESCRIPTION;R/callgraph.R;R/description.R;R/string.R;sandbox/description.R,False,True,True,False,26,16,42,"---FILE: DESCRIPTION---
@@ -7,4 +7,4 @@ Author: Peter Danenberg <pcd@roxygen.org>,
         Manuel Eugster <Manuel.Eugster@stat.uni-muenchen.de>
 Maintainer: Peter Danenberg <pcd@roxygen.org>
 URL: http://roxygen.org
-Suggests: Rgraphviz
+Suggests: Rgraphviz (>= 1.19.2)

---FILE: R/callgraph.R---
@@ -157,6 +157,8 @@ make.callgraph.roclet <- function(dependencies=NULL,
   graphviz <- function(subcalls) {
     FORMAT <- 'pdf'
     
+    ## This should be in here until the current Rgraphviz (19.2)
+    ## becomes mainstream.
     formals(toFile) <- alist(graph=,
                              layoutType=c(""dot"", ""neato"", ""twopi"",
                                ""circo"", ""fdp""),

---FILE: R/description.R---
@@ -1,5 +1,7 @@
 #' @include roxygen.R
 #' @include list.R
+#' @include string.R
+#' @include functional.R
 roxygen()
 
 #' Parse lines of text corresponding to a package DESCRIPTION file.
@@ -14,19 +16,8 @@ parse.description.text <- function(description) {
   contains.field <- function(line)
     length(grep(paste(FIELD, SEPARATOR, sep=''), line)) > 0
 
-  substr.regexp <- function(pattern, text) {
-    matches <- regexpr(pattern, text, perl=TRUE)
-    if (length(match) < 1)
-      NULL
-    else {
-      start <- car(matches)
-      end <- car(attr(matches, 'match.length'))
-      substr(text, start, end)
-    }
-  }
-
   field <- function(line)
-    substr.regexp(FIELD, line)
+    substr.regexpr(FIELD, line)
   
   rest <- function(line)
     substr(line, nchar(field(line)) + 2, nchar(line))
@@ -130,11 +121,12 @@ make.description.parser <- function(parse.default=cat.description,
 description.dependencies <- function(description.file) {
   dependencies <- NULL
   split.dependencies <- function(parsed.fields)
-    car(strsplit(dependencies, split='[[:space:]]+'))
+    Map(Curry(substr.regexpr, pattern='[^[:space:](]*'),
+        trim(car(strsplit(dependencies, split=',', fixed=TRUE))))
   parser <- make.description.parser(noop.description,
                                     post.parse=split.dependencies)
   augment.dependencies <- function(field, value)
-    dependencies <<- paste(value, dependencies)
+    dependencies <<- paste(value, dependencies, sep=',')
   
   parser$register.parsers(augment.dependencies,
                           'Package',

---FILE: R/string.R---
@@ -143,3 +143,20 @@ Reduce.paste <- function(proc, elts, sep)
          (parsed, proc(elt)),
          elts,
          NIL.STRING)
+
+#' Actually do the substring representation that
+#' regexpr should do; does not acknowledge groups,
+#' since \code{regexpr} doesn't.
+#' @param pattern the pattern to match
+#' @param text the text to match against
+#' @return The matched substring
+substr.regexpr <- function(pattern, text) {
+  matches <- regexpr(pattern, text, perl=TRUE)
+  if (length(match) < 1)
+    NULL
+  else {
+    start <- car(matches)
+    end <- car(attr(matches, 'match.length'))
+    substr(text, start, end)
+  }
+}

---FILE: sandbox/description.R---
@@ -5,5 +5,4 @@ source('../R/string.R')
 source('../R/description.R')
 
 parser <- make.description.parser()
-## parser$parse(parse.description.file('../DESCRIPTION'))
 description.dependencies('../DESCRIPTION')"
r-lib,roxygen2,d9631437cda408d99012c640d04937d103963f81,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-08-03T01:30:53Z,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-08-03T01:30:53Z,"abstract substr.regexpr; fix description.dependencies to deal with version; keep toFile-formals until 19.2 becomes mainstream


git-svn-id: svn+ssh://svn.r-forge.r-project.org/svnroot/roxygen@151 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",pkg/DESCRIPTION;pkg/R/callgraph.R;pkg/R/description.R;pkg/R/string.R;pkg/sandbox/description.R,False,True,True,False,26,16,42,"---FILE: pkg/DESCRIPTION---
@@ -7,4 +7,4 @@ Author: Peter Danenberg <pcd@roxygen.org>,
         Manuel Eugster <Manuel.Eugster@stat.uni-muenchen.de>
 Maintainer: Peter Danenberg <pcd@roxygen.org>
 URL: http://roxygen.org
-Suggests: Rgraphviz
+Suggests: Rgraphviz (>= 1.19.2)

---FILE: pkg/R/callgraph.R---
@@ -157,6 +157,8 @@ make.callgraph.roclet <- function(dependencies=NULL,
   graphviz <- function(subcalls) {
     FORMAT <- 'pdf'
     
+    ## This should be in here until the current Rgraphviz (19.2)
+    ## becomes mainstream.
     formals(toFile) <- alist(graph=,
                              layoutType=c(""dot"", ""neato"", ""twopi"",
                                ""circo"", ""fdp""),

---FILE: pkg/R/description.R---
@@ -1,5 +1,7 @@
 #' @include roxygen.R
 #' @include list.R
+#' @include string.R
+#' @include functional.R
 roxygen()
 
 #' Parse lines of text corresponding to a package DESCRIPTION file.
@@ -14,19 +16,8 @@ parse.description.text <- function(description) {
   contains.field <- function(line)
     length(grep(paste(FIELD, SEPARATOR, sep=''), line)) > 0
 
-  substr.regexp <- function(pattern, text) {
-    matches <- regexpr(pattern, text, perl=TRUE)
-    if (length(match) < 1)
-      NULL
-    else {
-      start <- car(matches)
-      end <- car(attr(matches, 'match.length'))
-      substr(text, start, end)
-    }
-  }
-
   field <- function(line)
-    substr.regexp(FIELD, line)
+    substr.regexpr(FIELD, line)
   
   rest <- function(line)
     substr(line, nchar(field(line)) + 2, nchar(line))
@@ -130,11 +121,12 @@ make.description.parser <- function(parse.default=cat.description,
 description.dependencies <- function(description.file) {
   dependencies <- NULL
   split.dependencies <- function(parsed.fields)
-    car(strsplit(dependencies, split='[[:space:]]+'))
+    Map(Curry(substr.regexpr, pattern='[^[:space:](]*'),
+        trim(car(strsplit(dependencies, split=',', fixed=TRUE))))
   parser <- make.description.parser(noop.description,
                                     post.parse=split.dependencies)
   augment.dependencies <- function(field, value)
-    dependencies <<- paste(value, dependencies)
+    dependencies <<- paste(value, dependencies, sep=',')
   
   parser$register.parsers(augment.dependencies,
                           'Package',

---FILE: pkg/R/string.R---
@@ -143,3 +143,20 @@ Reduce.paste <- function(proc, elts, sep)
          (parsed, proc(elt)),
          elts,
          NIL.STRING)
+
+#' Actually do the substring representation that
+#' regexpr should do; does not acknowledge groups,
+#' since \code{regexpr} doesn't.
+#' @param pattern the pattern to match
+#' @param text the text to match against
+#' @return The matched substring
+substr.regexpr <- function(pattern, text) {
+  matches <- regexpr(pattern, text, perl=TRUE)
+  if (length(match) < 1)
+    NULL
+  else {
+    start <- car(matches)
+    end <- car(attr(matches, 'match.length'))
+    substr(text, start, end)
+  }
+}

---FILE: pkg/sandbox/description.R---
@@ -5,5 +5,4 @@ source('../R/string.R')
 source('../R/description.R')
 
 parser <- make.description.parser()
-## parser$parse(parse.description.file('../DESCRIPTION'))
 description.dependencies('../DESCRIPTION')"
r-lib,roxygen2,fc45ba538dc5237790d35c11ced95fef4cefc236,Peter Danenberg,pcd@roxygen.org,2008-08-02T07:21:27Z,Peter Danenberg,pcd@roxygen.org,2008-08-02T07:21:27Z,"sQuote wesen; supercalls with all.names (thank, Manuel); number parser?; export registration functions; fix lhs bug; export make.roclet; fix classGraph


git-svn-id: svn://svn.r-forge.r-project.org/svnroot/roxygen/pkg@144 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",R/callgraph.R;R/parse.R;R/roclet.R;sandbox/classGraph.R,False,True,True,False,31,27,58,"---FILE: R/callgraph.R---
@@ -41,8 +41,7 @@ make.callgraph.roclet <- function(dependencies=NULL,
       warning(sprintf(paste('Package(s) %s wouldn\'t load;',
                             'callgraphs might be incomplete.'),
                       do.call(Curry(paste, sep=', '),
-                              Map(Curry(sprintf, fmt='`%s\''),
-                                  dependencies[!successes]))))
+                              Map(sQuote, dependencies[!successes]))))
   }
   
   parse.default <- function(key, expression) NULL
@@ -150,10 +149,10 @@ make.callgraph.roclet <- function(dependencies=NULL,
   OUTFILE <- '%s-callgraph.pdf'
 
   graphviz <- function(subcalls) {
-    supercalls <- ls(subcalls)
+    supercalls <- ls(subcalls, all.names=TRUE)
     if (length(supercalls) < 1 || is.null(supercalls))
-      warning(sprintf('Omitting call-less call-graph for `%s\'.',
-                      name))
+      warning(sprintf('Omitting call-less call-graph for %s.',
+                      sQuote(name)))
     else {
       graph <- new('graphNEL',
                    nodes=unlist(Map(remove.edge.separators, supercalls)),
@@ -164,14 +163,14 @@ make.callgraph.roclet <- function(dependencies=NULL,
                                     remove.edge.separators(subsupercall),
                                     graph),
                    error=function(e)
-                   warning(sprintf('Unknown node %s', subsupercall)))
+                   warning(sprintf('Unknown node %s', sQuote(subsupercall))))
       ag <- agopenSimple(graph, 'roxygenize')
       graphDataDefaults(ag, 'ratio') <- PHI
       graphDataDefaults(ag, 'splines') <- 'true'
       nodeDataDefaults(ag, 'fontname') <- 'monospace'
       outfile <- file.path(dir, sprintf(OUTFILE, name))
       if (verbose)
-        cat(sprintf('Outputting call graph to %s\n', outfile))
+        cat(sprintf('Outputting call graph to %s\n', sQuote(outfile)))
       toFile(ag,
              layoutType='fdp',
              filename=outfile,

---FILE: R/parse.R---
@@ -2,6 +2,7 @@
 #' @include functional.R
 #' @include string.R
 #' @include list.R
+#' @TODO number parser?
 roxygen()
 
 #' Sequence that distinguishes roxygen comment from normal comment.
@@ -66,6 +67,7 @@ register.preref.parser <- Curry(register.parser,
 #' a function taking \code{key} and \code{expression}
 #' @return \code{NULL}
 #' @seealso \code{\link{register.parser}}
+#' @export
 register.srcref.parser <- Curry(register.parser,
                                 table=srcref.parsers)
 
@@ -83,13 +85,15 @@ register.parsers <- function(table, parser, ...) {
 #' @param parser the parser to register
 #' @param \dots the keys upon which to register
 #' @return \code{NULL}
+#' @export
 register.preref.parsers <- Curry(register.parsers,
                                  table=preref.parsers)
 
 #' Register many srcref parsers at once.
 #' @param parser the parser to register
 #' @param \dots the keys upon which to register
 #' @return \code{NULL}
+#' @export
 register.srcref.parsers <- Curry(register.parsers,
                                  table=srcref.parsers)
 
@@ -137,6 +141,7 @@ parse.description <- function(expression)
 #' @param rest the expression to be parsed
 #' @return A list containing the key and expression (possibly
 #' null)
+#' @export
 parse.default <- function(key, rest)
   as.list(structure(rest, names=key))
 
@@ -161,6 +166,7 @@ register.preref.parser('export', parse.default)
 #' @param key the parsing key
 #' @param rest the expression to be parsed
 #' @return A list containing the key and value
+#' @export
 parse.value <- function(key, rest) {
   if (is.null.string(rest))
     parse.error(key, 'requires a value')
@@ -207,6 +213,7 @@ register.preref.parsers(parse.value,
 #' @param rest the expression to be parsed
 #' @return A list containing the key, name and
 #' description
+#' @export
 parse.name.description <- function(key, rest) {
   name <- strcar(rest)
   rest <- strcdr(rest)
@@ -231,6 +238,7 @@ register.preref.parsers(parse.name.description,
 #' @param key parsing key
 #' @param name the name to be parsed
 #' @return A list containing key and name
+#' @export
 parse.name <- function(key, name) {
   if (is.null.string(name))
     parse.error(key, 'requires a name')
@@ -474,7 +482,7 @@ parse.call <- function(expressions) {
     formals <- parse.formals(cdddr(expressions))
     append(assignee, formals)
   } else {
-    lhs <- as.character(cadr(expressions))
+    lhs <- cadr(as.character(expressions))
     parser.srcref(lhs)(lhs, cddr(expressions))
   }
 }
@@ -506,6 +514,7 @@ parse.refs <- function(preref.srcrefs)
 #' Parse a source file containing roxygen directives.
 #' @param file string naming file to be parsed
 #' @return List containing parsed directives
+#' @export
 #' @callGraph
 #' @callGraphDepth 3
 parse.file <- function(file) {
@@ -522,6 +531,7 @@ parse.file <- function(file) {
 #' @param \dots files to be parsed
 #' @return List containing parsed directives
 #' @seealso \code{\link{parse.file}}
+#' @export
 parse.files <- function(...)
   Reduce(append, Map(parse.file, list(...)), NULL)
 

---FILE: R/roclet.R---
@@ -22,7 +22,8 @@ roxygen()
 #' called before any file has been parsed
 #' @param post.files a callback function with no arguments;
 #' called after every file has been parsed
-make.roclet <- function(parse.default,
+#' @export
+make.roclet <- function(parse.default=NULL,
                         pre.parse=NULL,
                         post.parse=NULL,
                         pre.files=NULL,

---FILE: sandbox/classGraph.R---
@@ -2,8 +2,6 @@
 
 require(roxygen)
 
-
-
 #' Exemplar class: the JAVA bicycle class.
 #' @classGraph
 setClass('Bicycle',
@@ -12,10 +10,7 @@ setClass('Bicycle',
            speed='numeric',
            gear='numeric'))
 
-
-
-#source('../R/parse.R')
-### Roclet:
+## Register tag with the main parser
 register.preref.parser('classGraph', parse.toggle)
 
 make.classGraph.roclet <- function(package, dir='.') {
@@ -24,39 +19,38 @@ make.classGraph.roclet <- function(package, dir='.') {
   
   if ( !require(classGraph) )
     stop('This roclet needs the ', sQuote('classGraph'), 'package!')
-
   
   ### Roclet parser:
   
   class <- NULL
   file <- NULL
   
   pre.parse <- function(partitum) {
-    if ( partitum$S4class != '' ) {
+    if ( !is.null(partitum$S4class) ) {
       class <<- partitum$S4class
       file <<- partitum$srcref$filename
     }
   }
 
+  ## parse.classGraph only called on @classGraph;
+  ## no need to check the key
   parse.classGraph <- function(key, value) {
-    if ( key == 'classGraph' )
-      if ( !is.null(class) )
-        create.callGraph()
-      else
-        warning('@classGraph set but no S4 class far and wide.')
+    if ( !is.null(class) )
+      create.callGraph()
+    else
+      warning('@classGraph set but no S4 class far and wide.')
   }
   
   post.parse <- function(partitum) {
     class <<- NULL
     file <<- NULL
   }
 
-  roclet <- roxygen:::make.roclet(parse.classGraph,
-                                  pre.parse,
-                                  post.parse)
-
-  roclet$register.default.parsers('classGraph')
+  ## No default parser
+  roclet <- roxygen:::make.roclet(pre.parse=pre.parse,
+                                  post.parse=post.parse)
 
+  roclet$register.parser('classGraph', parse.classGraph)
 
   ### Action:
 "
r-lib,roxygen2,fe3f4c487bc7716578f798a9e05e0b77cdb750a2,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-08-02T07:21:27Z,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-08-02T07:21:27Z,"sQuote wesen; supercalls with all.names (thank, Manuel); number parser?; export registration functions; fix lhs bug; export make.roclet; fix classGraph


git-svn-id: svn://svn.r-forge.r-project.org/svnroot/roxygen/pkg@144 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",R/callgraph.R;R/parse.R;R/roclet.R;sandbox/classGraph.R,False,True,True,False,31,27,58,"---FILE: R/callgraph.R---
@@ -41,8 +41,7 @@ make.callgraph.roclet <- function(dependencies=NULL,
       warning(sprintf(paste('Package(s) %s wouldn\'t load;',
                             'callgraphs might be incomplete.'),
                       do.call(Curry(paste, sep=', '),
-                              Map(Curry(sprintf, fmt='`%s\''),
-                                  dependencies[!successes]))))
+                              Map(sQuote, dependencies[!successes]))))
   }
   
   parse.default <- function(key, expression) NULL
@@ -150,10 +149,10 @@ make.callgraph.roclet <- function(dependencies=NULL,
   OUTFILE <- '%s-callgraph.pdf'
 
   graphviz <- function(subcalls) {
-    supercalls <- ls(subcalls)
+    supercalls <- ls(subcalls, all.names=TRUE)
     if (length(supercalls) < 1 || is.null(supercalls))
-      warning(sprintf('Omitting call-less call-graph for `%s\'.',
-                      name))
+      warning(sprintf('Omitting call-less call-graph for %s.',
+                      sQuote(name)))
     else {
       graph <- new('graphNEL',
                    nodes=unlist(Map(remove.edge.separators, supercalls)),
@@ -164,14 +163,14 @@ make.callgraph.roclet <- function(dependencies=NULL,
                                     remove.edge.separators(subsupercall),
                                     graph),
                    error=function(e)
-                   warning(sprintf('Unknown node %s', subsupercall)))
+                   warning(sprintf('Unknown node %s', sQuote(subsupercall))))
       ag <- agopenSimple(graph, 'roxygenize')
       graphDataDefaults(ag, 'ratio') <- PHI
       graphDataDefaults(ag, 'splines') <- 'true'
       nodeDataDefaults(ag, 'fontname') <- 'monospace'
       outfile <- file.path(dir, sprintf(OUTFILE, name))
       if (verbose)
-        cat(sprintf('Outputting call graph to %s\n', outfile))
+        cat(sprintf('Outputting call graph to %s\n', sQuote(outfile)))
       toFile(ag,
              layoutType='fdp',
              filename=outfile,

---FILE: R/parse.R---
@@ -2,6 +2,7 @@
 #' @include functional.R
 #' @include string.R
 #' @include list.R
+#' @TODO number parser?
 roxygen()
 
 #' Sequence that distinguishes roxygen comment from normal comment.
@@ -66,6 +67,7 @@ register.preref.parser <- Curry(register.parser,
 #' a function taking \code{key} and \code{expression}
 #' @return \code{NULL}
 #' @seealso \code{\link{register.parser}}
+#' @export
 register.srcref.parser <- Curry(register.parser,
                                 table=srcref.parsers)
 
@@ -83,13 +85,15 @@ register.parsers <- function(table, parser, ...) {
 #' @param parser the parser to register
 #' @param \dots the keys upon which to register
 #' @return \code{NULL}
+#' @export
 register.preref.parsers <- Curry(register.parsers,
                                  table=preref.parsers)
 
 #' Register many srcref parsers at once.
 #' @param parser the parser to register
 #' @param \dots the keys upon which to register
 #' @return \code{NULL}
+#' @export
 register.srcref.parsers <- Curry(register.parsers,
                                  table=srcref.parsers)
 
@@ -137,6 +141,7 @@ parse.description <- function(expression)
 #' @param rest the expression to be parsed
 #' @return A list containing the key and expression (possibly
 #' null)
+#' @export
 parse.default <- function(key, rest)
   as.list(structure(rest, names=key))
 
@@ -161,6 +166,7 @@ register.preref.parser('export', parse.default)
 #' @param key the parsing key
 #' @param rest the expression to be parsed
 #' @return A list containing the key and value
+#' @export
 parse.value <- function(key, rest) {
   if (is.null.string(rest))
     parse.error(key, 'requires a value')
@@ -207,6 +213,7 @@ register.preref.parsers(parse.value,
 #' @param rest the expression to be parsed
 #' @return A list containing the key, name and
 #' description
+#' @export
 parse.name.description <- function(key, rest) {
   name <- strcar(rest)
   rest <- strcdr(rest)
@@ -231,6 +238,7 @@ register.preref.parsers(parse.name.description,
 #' @param key parsing key
 #' @param name the name to be parsed
 #' @return A list containing key and name
+#' @export
 parse.name <- function(key, name) {
   if (is.null.string(name))
     parse.error(key, 'requires a name')
@@ -474,7 +482,7 @@ parse.call <- function(expressions) {
     formals <- parse.formals(cdddr(expressions))
     append(assignee, formals)
   } else {
-    lhs <- as.character(cadr(expressions))
+    lhs <- cadr(as.character(expressions))
     parser.srcref(lhs)(lhs, cddr(expressions))
   }
 }
@@ -506,6 +514,7 @@ parse.refs <- function(preref.srcrefs)
 #' Parse a source file containing roxygen directives.
 #' @param file string naming file to be parsed
 #' @return List containing parsed directives
+#' @export
 #' @callGraph
 #' @callGraphDepth 3
 parse.file <- function(file) {
@@ -522,6 +531,7 @@ parse.file <- function(file) {
 #' @param \dots files to be parsed
 #' @return List containing parsed directives
 #' @seealso \code{\link{parse.file}}
+#' @export
 parse.files <- function(...)
   Reduce(append, Map(parse.file, list(...)), NULL)
 

---FILE: R/roclet.R---
@@ -22,7 +22,8 @@ roxygen()
 #' called before any file has been parsed
 #' @param post.files a callback function with no arguments;
 #' called after every file has been parsed
-make.roclet <- function(parse.default,
+#' @export
+make.roclet <- function(parse.default=NULL,
                         pre.parse=NULL,
                         post.parse=NULL,
                         pre.files=NULL,

---FILE: sandbox/classGraph.R---
@@ -2,8 +2,6 @@
 
 require(roxygen)
 
-
-
 #' Exemplar class: the JAVA bicycle class.
 #' @classGraph
 setClass('Bicycle',
@@ -12,10 +10,7 @@ setClass('Bicycle',
            speed='numeric',
            gear='numeric'))
 
-
-
-#source('../R/parse.R')
-### Roclet:
+## Register tag with the main parser
 register.preref.parser('classGraph', parse.toggle)
 
 make.classGraph.roclet <- function(package, dir='.') {
@@ -24,39 +19,38 @@ make.classGraph.roclet <- function(package, dir='.') {
   
   if ( !require(classGraph) )
     stop('This roclet needs the ', sQuote('classGraph'), 'package!')
-
   
   ### Roclet parser:
   
   class <- NULL
   file <- NULL
   
   pre.parse <- function(partitum) {
-    if ( partitum$S4class != '' ) {
+    if ( !is.null(partitum$S4class) ) {
       class <<- partitum$S4class
       file <<- partitum$srcref$filename
     }
   }
 
+  ## parse.classGraph only called on @classGraph;
+  ## no need to check the key
   parse.classGraph <- function(key, value) {
-    if ( key == 'classGraph' )
-      if ( !is.null(class) )
-        create.callGraph()
-      else
-        warning('@classGraph set but no S4 class far and wide.')
+    if ( !is.null(class) )
+      create.callGraph()
+    else
+      warning('@classGraph set but no S4 class far and wide.')
   }
   
   post.parse <- function(partitum) {
     class <<- NULL
     file <<- NULL
   }
 
-  roclet <- roxygen:::make.roclet(parse.classGraph,
-                                  pre.parse,
-                                  post.parse)
-
-  roclet$register.default.parsers('classGraph')
+  ## No default parser
+  roclet <- roxygen:::make.roclet(pre.parse=pre.parse,
+                                  post.parse=post.parse)
 
+  roclet$register.parser('classGraph', parse.classGraph)
 
   ### Action:
 "
r-lib,roxygen2,dd25a485a627a4719eb54ef8712e96b28717b98f,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-08-02T07:21:27Z,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-08-02T07:21:27Z,"sQuote wesen; supercalls with all.names (thank, Manuel); number parser?; export registration functions; fix lhs bug; export make.roclet; fix classGraph


git-svn-id: svn+ssh://svn.r-forge.r-project.org/svnroot/roxygen@144 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",pkg/R/callgraph.R;pkg/R/parse.R;pkg/R/roclet.R;pkg/sandbox/classGraph.R,False,True,True,False,31,27,58,"---FILE: pkg/R/callgraph.R---
@@ -41,8 +41,7 @@ make.callgraph.roclet <- function(dependencies=NULL,
       warning(sprintf(paste('Package(s) %s wouldn\'t load;',
                             'callgraphs might be incomplete.'),
                       do.call(Curry(paste, sep=', '),
-                              Map(Curry(sprintf, fmt='`%s\''),
-                                  dependencies[!successes]))))
+                              Map(sQuote, dependencies[!successes]))))
   }
   
   parse.default <- function(key, expression) NULL
@@ -150,10 +149,10 @@ make.callgraph.roclet <- function(dependencies=NULL,
   OUTFILE <- '%s-callgraph.pdf'
 
   graphviz <- function(subcalls) {
-    supercalls <- ls(subcalls)
+    supercalls <- ls(subcalls, all.names=TRUE)
     if (length(supercalls) < 1 || is.null(supercalls))
-      warning(sprintf('Omitting call-less call-graph for `%s\'.',
-                      name))
+      warning(sprintf('Omitting call-less call-graph for %s.',
+                      sQuote(name)))
     else {
       graph <- new('graphNEL',
                    nodes=unlist(Map(remove.edge.separators, supercalls)),
@@ -164,14 +163,14 @@ make.callgraph.roclet <- function(dependencies=NULL,
                                     remove.edge.separators(subsupercall),
                                     graph),
                    error=function(e)
-                   warning(sprintf('Unknown node %s', subsupercall)))
+                   warning(sprintf('Unknown node %s', sQuote(subsupercall))))
       ag <- agopenSimple(graph, 'roxygenize')
       graphDataDefaults(ag, 'ratio') <- PHI
       graphDataDefaults(ag, 'splines') <- 'true'
       nodeDataDefaults(ag, 'fontname') <- 'monospace'
       outfile <- file.path(dir, sprintf(OUTFILE, name))
       if (verbose)
-        cat(sprintf('Outputting call graph to %s\n', outfile))
+        cat(sprintf('Outputting call graph to %s\n', sQuote(outfile)))
       toFile(ag,
              layoutType='fdp',
              filename=outfile,

---FILE: pkg/R/parse.R---
@@ -2,6 +2,7 @@
 #' @include functional.R
 #' @include string.R
 #' @include list.R
+#' @TODO number parser?
 roxygen()
 
 #' Sequence that distinguishes roxygen comment from normal comment.
@@ -66,6 +67,7 @@ register.preref.parser <- Curry(register.parser,
 #' a function taking \code{key} and \code{expression}
 #' @return \code{NULL}
 #' @seealso \code{\link{register.parser}}
+#' @export
 register.srcref.parser <- Curry(register.parser,
                                 table=srcref.parsers)
 
@@ -83,13 +85,15 @@ register.parsers <- function(table, parser, ...) {
 #' @param parser the parser to register
 #' @param \dots the keys upon which to register
 #' @return \code{NULL}
+#' @export
 register.preref.parsers <- Curry(register.parsers,
                                  table=preref.parsers)
 
 #' Register many srcref parsers at once.
 #' @param parser the parser to register
 #' @param \dots the keys upon which to register
 #' @return \code{NULL}
+#' @export
 register.srcref.parsers <- Curry(register.parsers,
                                  table=srcref.parsers)
 
@@ -137,6 +141,7 @@ parse.description <- function(expression)
 #' @param rest the expression to be parsed
 #' @return A list containing the key and expression (possibly
 #' null)
+#' @export
 parse.default <- function(key, rest)
   as.list(structure(rest, names=key))
 
@@ -161,6 +166,7 @@ register.preref.parser('export', parse.default)
 #' @param key the parsing key
 #' @param rest the expression to be parsed
 #' @return A list containing the key and value
+#' @export
 parse.value <- function(key, rest) {
   if (is.null.string(rest))
     parse.error(key, 'requires a value')
@@ -207,6 +213,7 @@ register.preref.parsers(parse.value,
 #' @param rest the expression to be parsed
 #' @return A list containing the key, name and
 #' description
+#' @export
 parse.name.description <- function(key, rest) {
   name <- strcar(rest)
   rest <- strcdr(rest)
@@ -231,6 +238,7 @@ register.preref.parsers(parse.name.description,
 #' @param key parsing key
 #' @param name the name to be parsed
 #' @return A list containing key and name
+#' @export
 parse.name <- function(key, name) {
   if (is.null.string(name))
     parse.error(key, 'requires a name')
@@ -474,7 +482,7 @@ parse.call <- function(expressions) {
     formals <- parse.formals(cdddr(expressions))
     append(assignee, formals)
   } else {
-    lhs <- as.character(cadr(expressions))
+    lhs <- cadr(as.character(expressions))
     parser.srcref(lhs)(lhs, cddr(expressions))
   }
 }
@@ -506,6 +514,7 @@ parse.refs <- function(preref.srcrefs)
 #' Parse a source file containing roxygen directives.
 #' @param file string naming file to be parsed
 #' @return List containing parsed directives
+#' @export
 #' @callGraph
 #' @callGraphDepth 3
 parse.file <- function(file) {
@@ -522,6 +531,7 @@ parse.file <- function(file) {
 #' @param \dots files to be parsed
 #' @return List containing parsed directives
 #' @seealso \code{\link{parse.file}}
+#' @export
 parse.files <- function(...)
   Reduce(append, Map(parse.file, list(...)), NULL)
 

---FILE: pkg/R/roclet.R---
@@ -22,7 +22,8 @@ roxygen()
 #' called before any file has been parsed
 #' @param post.files a callback function with no arguments;
 #' called after every file has been parsed
-make.roclet <- function(parse.default,
+#' @export
+make.roclet <- function(parse.default=NULL,
                         pre.parse=NULL,
                         post.parse=NULL,
                         pre.files=NULL,

---FILE: pkg/sandbox/classGraph.R---
@@ -2,8 +2,6 @@
 
 require(roxygen)
 
-
-
 #' Exemplar class: the JAVA bicycle class.
 #' @classGraph
 setClass('Bicycle',
@@ -12,10 +10,7 @@ setClass('Bicycle',
            speed='numeric',
            gear='numeric'))
 
-
-
-#source('../R/parse.R')
-### Roclet:
+## Register tag with the main parser
 register.preref.parser('classGraph', parse.toggle)
 
 make.classGraph.roclet <- function(package, dir='.') {
@@ -24,39 +19,38 @@ make.classGraph.roclet <- function(package, dir='.') {
   
   if ( !require(classGraph) )
     stop('This roclet needs the ', sQuote('classGraph'), 'package!')
-
   
   ### Roclet parser:
   
   class <- NULL
   file <- NULL
   
   pre.parse <- function(partitum) {
-    if ( partitum$S4class != '' ) {
+    if ( !is.null(partitum$S4class) ) {
       class <<- partitum$S4class
       file <<- partitum$srcref$filename
     }
   }
 
+  ## parse.classGraph only called on @classGraph;
+  ## no need to check the key
   parse.classGraph <- function(key, value) {
-    if ( key == 'classGraph' )
-      if ( !is.null(class) )
-        create.callGraph()
-      else
-        warning('@classGraph set but no S4 class far and wide.')
+    if ( !is.null(class) )
+      create.callGraph()
+    else
+      warning('@classGraph set but no S4 class far and wide.')
   }
   
   post.parse <- function(partitum) {
     class <<- NULL
     file <<- NULL
   }
 
-  roclet <- roxygen:::make.roclet(parse.classGraph,
-                                  pre.parse,
-                                  post.parse)
-
-  roclet$register.default.parsers('classGraph')
+  ## No default parser
+  roclet <- roxygen:::make.roclet(pre.parse=pre.parse,
+                                  post.parse=post.parse)
 
+  roclet$register.parser('classGraph', parse.classGraph)
 
   ### Action:
 "
r-lib,roxygen2,c4cac66a1918ed858a694bbb61b2edbc27f5068b,Peter Danenberg,pcd@roxygen.org,2008-07-29T03:49:45Z,Peter Danenberg,pcd@roxygen.org,2008-07-29T03:49:45Z,"failure to set size


git-svn-id: svn://svn.r-forge.r-project.org/svnroot/roxygen/pkg@125 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",sandbox/callgraph.R,False,True,True,False,28,13,41,"---FILE: sandbox/callgraph.R---
@@ -106,11 +106,20 @@ preorder.walk.expression(discover.subcalls, exprofundum)
 
 graphviz <- function(subcalls) {
   supercalls <- ls(subcalls)
-  graph <- new('graphNEL', nodes=supercalls)
-  attrs <- list(graph=list(size=NULL))
-  nodeAttrs <- makeNodeAttrs(graph,
-                             fixedsize=FALSE,
-                             shape='ellipse')
+  graph <- new('graphNEL',
+               nodes=supercalls,
+               edgemode='directed')
+  attrs <- list(graph=list(size='24.0,24.0'),
+                edge=list(arrowhead='normal',
+                  dir='forward'),
+                node=list(fixedsize=FALSE,
+                  shape='ellipse',
+                  fontname='monospace'),
+                cluster=list())
+###   nodeAttrs <- makeNodeAttrs(graph,
+###                              fixedsize=FALSE,
+###                              shape='ellipse',
+###                              fontname='monospace')
 ###   attrs <- list(node=list(shape='ellipse',
 ###                   fixedsize=FALSE))
   for (supercall in supercalls)
@@ -119,14 +128,20 @@ graphviz <- function(subcalls) {
 ###   plot(graph,
 ###        attrs=attrs
 ###        )
-  agraph <- agopenSimple(graph, 'roxygenize')
-  agraph <- agopen(graph,
-                   'roxygenize',
-                   nodeAttrs=nodeAttrs)
-###   graphDataDefaults(agraph, 'size') <- NULL
-  nodeDataDefaults(agraph, c('shape', 'fixedsize')) <-
-    c('ellipse', FALSE)
-  toFile(agraph,
+###   print(checkAttrs(attrs))
+  print(str(getDefaultAttrs(attrs)))
+###   agraph <- agopenSimple(graph, 'roxygenize')
+  ag <- agopen(graph,
+               'roxygenize',
+               attrs=getDefaultAttrs(attrs),
+               edgeMode='directed')
+###   print(graphData(ag))
+###   graphData(agraph, 'size') <- NULL
+###   print(graphData(agraph, 'size'))
+###   nodeDataDefaults(agraph, c('shape', 'fixedsize')) <-
+###     c('ellipse', FALSE)
+###   edgeDataDefaults(agraph, 'arrowhead') <- 'normal'
+  toFile(ag,
          layoutType='fdp',
          filename='test.ps',
          fileType='ps')"
r-lib,roxygen2,8a1e769b8b462ca74071dedc7f6776ce0ee584a2,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-07-29T03:49:45Z,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-07-29T03:49:45Z,"failure to set size


git-svn-id: svn://svn.r-forge.r-project.org/svnroot/roxygen/pkg@125 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",sandbox/callgraph.R,False,True,True,False,28,13,41,"---FILE: sandbox/callgraph.R---
@@ -106,11 +106,20 @@ preorder.walk.expression(discover.subcalls, exprofundum)
 
 graphviz <- function(subcalls) {
   supercalls <- ls(subcalls)
-  graph <- new('graphNEL', nodes=supercalls)
-  attrs <- list(graph=list(size=NULL))
-  nodeAttrs <- makeNodeAttrs(graph,
-                             fixedsize=FALSE,
-                             shape='ellipse')
+  graph <- new('graphNEL',
+               nodes=supercalls,
+               edgemode='directed')
+  attrs <- list(graph=list(size='24.0,24.0'),
+                edge=list(arrowhead='normal',
+                  dir='forward'),
+                node=list(fixedsize=FALSE,
+                  shape='ellipse',
+                  fontname='monospace'),
+                cluster=list())
+###   nodeAttrs <- makeNodeAttrs(graph,
+###                              fixedsize=FALSE,
+###                              shape='ellipse',
+###                              fontname='monospace')
 ###   attrs <- list(node=list(shape='ellipse',
 ###                   fixedsize=FALSE))
   for (supercall in supercalls)
@@ -119,14 +128,20 @@ graphviz <- function(subcalls) {
 ###   plot(graph,
 ###        attrs=attrs
 ###        )
-  agraph <- agopenSimple(graph, 'roxygenize')
-  agraph <- agopen(graph,
-                   'roxygenize',
-                   nodeAttrs=nodeAttrs)
-###   graphDataDefaults(agraph, 'size') <- NULL
-  nodeDataDefaults(agraph, c('shape', 'fixedsize')) <-
-    c('ellipse', FALSE)
-  toFile(agraph,
+###   print(checkAttrs(attrs))
+  print(str(getDefaultAttrs(attrs)))
+###   agraph <- agopenSimple(graph, 'roxygenize')
+  ag <- agopen(graph,
+               'roxygenize',
+               attrs=getDefaultAttrs(attrs),
+               edgeMode='directed')
+###   print(graphData(ag))
+###   graphData(agraph, 'size') <- NULL
+###   print(graphData(agraph, 'size'))
+###   nodeDataDefaults(agraph, c('shape', 'fixedsize')) <-
+###     c('ellipse', FALSE)
+###   edgeDataDefaults(agraph, 'arrowhead') <- 'normal'
+  toFile(ag,
          layoutType='fdp',
          filename='test.ps',
          fileType='ps')"
r-lib,roxygen2,7bafbda9bf70329be2278b0a12a691274297869c,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-07-29T03:49:45Z,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-07-29T03:49:45Z,"failure to set size


git-svn-id: svn+ssh://svn.r-forge.r-project.org/svnroot/roxygen@125 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",pkg/sandbox/callgraph.R,False,True,True,False,28,13,41,"---FILE: pkg/sandbox/callgraph.R---
@@ -106,11 +106,20 @@ preorder.walk.expression(discover.subcalls, exprofundum)
 
 graphviz <- function(subcalls) {
   supercalls <- ls(subcalls)
-  graph <- new('graphNEL', nodes=supercalls)
-  attrs <- list(graph=list(size=NULL))
-  nodeAttrs <- makeNodeAttrs(graph,
-                             fixedsize=FALSE,
-                             shape='ellipse')
+  graph <- new('graphNEL',
+               nodes=supercalls,
+               edgemode='directed')
+  attrs <- list(graph=list(size='24.0,24.0'),
+                edge=list(arrowhead='normal',
+                  dir='forward'),
+                node=list(fixedsize=FALSE,
+                  shape='ellipse',
+                  fontname='monospace'),
+                cluster=list())
+###   nodeAttrs <- makeNodeAttrs(graph,
+###                              fixedsize=FALSE,
+###                              shape='ellipse',
+###                              fontname='monospace')
 ###   attrs <- list(node=list(shape='ellipse',
 ###                   fixedsize=FALSE))
   for (supercall in supercalls)
@@ -119,14 +128,20 @@ graphviz <- function(subcalls) {
 ###   plot(graph,
 ###        attrs=attrs
 ###        )
-  agraph <- agopenSimple(graph, 'roxygenize')
-  agraph <- agopen(graph,
-                   'roxygenize',
-                   nodeAttrs=nodeAttrs)
-###   graphDataDefaults(agraph, 'size') <- NULL
-  nodeDataDefaults(agraph, c('shape', 'fixedsize')) <-
-    c('ellipse', FALSE)
-  toFile(agraph,
+###   print(checkAttrs(attrs))
+  print(str(getDefaultAttrs(attrs)))
+###   agraph <- agopenSimple(graph, 'roxygenize')
+  ag <- agopen(graph,
+               'roxygenize',
+               attrs=getDefaultAttrs(attrs),
+               edgeMode='directed')
+###   print(graphData(ag))
+###   graphData(agraph, 'size') <- NULL
+###   print(graphData(agraph, 'size'))
+###   nodeDataDefaults(agraph, c('shape', 'fixedsize')) <-
+###     c('ellipse', FALSE)
+###   edgeDataDefaults(agraph, 'arrowhead') <- 'normal'
+  toFile(ag,
          layoutType='fdp',
          filename='test.ps',
          fileType='ps')"
r-lib,roxygen2,a26e9028540b8687e520188a85f1aa6d29119c52,Peter Danenberg,pcd@roxygen.org,2008-07-27T04:29:08Z,Peter Danenberg,pcd@roxygen.org,2008-07-27T04:29:08Z,"fixed grave collate error: use member instead of %in%; merge for collate; outfile for namespace; optional verbosity; setwd() hack for roxygenizing collate; msg on test.collate


git-svn-id: svn://svn.r-forge.r-project.org/svnroot/roxygen/pkg@102 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",R/Rd.R;R/collate.R;R/namespace.R;R/parse.R;R/roxygenize.R;sandbox/collate.R;sandbox/roxygenize.R;tests/runit/runit.collate.R,False,True,True,False,91,35,126,"---FILE: R/Rd.R---
@@ -81,6 +81,8 @@ roxygen()
 #'
 #' @param subdir directory into which to place the Rd files; if
 #' \code{NULL}, standard out.
+#' @param verbose whether to declare what we're doing in the
+#' \var{subdir}
 #' @return Rd roclet
 #' @examples
 #' #' This sentence describes the function.
@@ -106,7 +108,8 @@ roxygen()
 #' roclet <- make.Rd.roclet('man')
 #' \dontrun{roclet$parse('example.R')}
 #' @export
-make.Rd.roclet <- function(subdir=NULL) {
+make.Rd.roclet <- function(subdir=NULL,
+                           verbose=TRUE) {
   #' Translate a key and expressions into an Rd expression;
   #' multiple expressions take their own braces.
   #' @param key the expression's key
@@ -224,7 +227,8 @@ make.Rd.roclet <- function(subdir=NULL) {
         assign.parent('filename',
                       file.path(subdir, sprintf('%s.Rd', name)),
                       environment())
-        cat(sprintf('Writing %s to %s\n', name, filename))
+        if (verbose)
+          cat(sprintf('Writing %s to %s\n', name, filename))
         unlink(filename)
       }
       parse.expression('name', name)

---FILE: R/collate.R---
@@ -1,7 +1,6 @@
 #' @include roxygen.R
-#' @include parse.R
-#' @include roclet.R
 #' @include string.R
+#' @include roclet.R
 roxygen()
 
 #' Make collate roclet which parses the given files; topologically
@@ -14,8 +13,14 @@ roxygen()
 #' Contains the member function \code{parse} which parses an arbitrary number
 #' of files.
 #'
-#' @seealso \code{\link{make.roclet}}
+#' @param merge.file \file{DESCRIPTION} file with which to merge directive;
+#' or \code{NULL} for none
+#' @param target.file whither to \code{cat} directive (whether merged or
+#' not); blank line is standard out
+#' @param verbose whether to describe what we're doing with the
+#' target.file
 #' @return Rd roclet
+#' @seealso \code{\link{make.roclet}}
 #' @examples
 #' #' An example source file, example.R
 #' #' @@include roxygen.R
@@ -25,7 +30,9 @@ roxygen()
 #' roclet <- make.collate.roclet()
 #' \dontrun{roclet$parse('example.R')}
 #' @export
-make.collate.roclet <- function() {
+make.collate.roclet <- function(merge.file=NULL,
+                                target.file='',
+                                verbose=TRUE) {
   vertices <- NULL
 
   make.vertex <- function(file) {
@@ -44,8 +51,15 @@ make.collate.roclet <- function() {
                                              names=file))),
                     environment())
 
+  member <- function(ancestor, ancestors) {
+    for (vertex in ancestors)
+      if (identical(ancestor, vertex))
+        TRUE
+    FALSE
+  }
+
   maybe.append.ancestor <- function(predecessor, ancestor)
-    if (!c(ancestor) %in% predecessor$ancestors)
+    if (!member(ancestor, predecessor$ancestors))
       predecessor$ancestors <-
         append(ancestor, predecessor$ancestors)
 
@@ -84,14 +98,33 @@ make.collate.roclet <- function() {
         visit(vertex)
   }
 
-  post.files <-
-    function() cat('Collate:',
-                   Reduce.paste(function(vertex)
-                                sprintf(""'%s'"", vertex$file),
-                                topological.sort(vertices),
-                                ' '),
-                   '\n',
-                   sep='')
+  COLLATE.FIELD <- 'Collate:'
+
+  merge <- function(directive) {
+    lines <- readLines(merge.file)
+    filtered.lines <- Filter(function(line)
+                             length(grep(sprintf('^%s', COLLATE.FIELD),
+                                         trim(line))) == 0,
+                             lines)
+    if (verbose && !is.null.string(target.file))
+      cat(sprintf('Merging `Collate:\' from %s to %s',
+                  merge.file,
+                  target.file), '\n')
+    cat(filtered.lines, directive, file=target.file, sep='\n')
+  }
+
+  post.files <- function() {
+    directive <-
+      sprintf('Collate:%s',
+              Reduce.paste(function(vertex)
+                           sprintf(""'%s'"", vertex$file),
+                           topological.sort(vertices),
+                           ' '))
+    if (!is.null(merge.file))
+      merge(directive)
+    else
+      cat(directive, '\n', file=target.file, sep='')
+  }
 
   roclet <- make.roclet(parse.include,
                         pre.parse=pre.parse,

---FILE: R/namespace.R---
@@ -49,6 +49,8 @@ roxygen()
 #' }
 #'
 #' @param outfile whither to send output; '' == standard out
+#' @param verbose whether to anounce what we're doing with
+#' the \var{outfile}
 #' @return Namespace roclet
 #' @examples
 #' #' An example file, example.R, which imports
@@ -63,7 +65,8 @@ roxygen()
 #' roclet <- make.namespace.roclet()
 #' \dontrun{roclet$parse('example.R')}
 #' @export
-make.namespace.roclet <- function(outfile='') {
+make.namespace.roclet <- function(outfile='',
+                                  verbose=TRUE) {
   parse.directive <- function(proc, parms)
     cat(sprintf('%s(%s)\n', proc, strmap(Identity, ', ', parms)),
         file=outfile,
@@ -78,8 +81,11 @@ make.namespace.roclet <- function(outfile='') {
                       S4generic=partitum$S4method,
                       S4class=partitum$S4class)
 
-  pre.files <- function()
+  pre.files <- function() {
+    if (verbose && !is.null.string(outfile))
+      cat(sprintf('Writing namespace directives to %s', outfile), '\n')
     unlink(outfile)
+  }
 
   roclet <- make.roclet(parse.directive,
                         pre.parse=pre.parse,

---FILE: R/parse.R---
@@ -1,7 +1,7 @@
 #' @include roxygen.R
+#' @include functional.R
 #' @include string.R
 #' @include list.R
-#' @include functional.R
 roxygen()
 
 #' Sequence that distinguishes roxygen comment from normal comment.

---FILE: R/roxygenize.R---
@@ -55,12 +55,14 @@ copy.dir <- function(source,
 #' @param copy.package if R.utils is present, copies the package
 #' over before adding/manipulating files.
 #' @return \code{NULL}
+#' @importFrom tools file_path_as_absolute
 roxygenize <- function(package.dir,
                        copy.package=TRUE) {
   roxygen.dir <- sprintf(ROXYGEN.DIR, package.dir)
   man.dir <- file.path(roxygen.dir, MAN.DIR)
   namespace.file <- file.path(roxygen.dir, NAMESPACE.FILE)
-  description.file <- file.path(roxygen.dir, DESCRIPTION.FILE)
+  package.description <- file_path_as_absolute(file.path(package.dir, DESCRIPTION.FILE))
+  roxygen.description <- file_path_as_absolute(file.path(roxygen.dir, DESCRIPTION.FILE))
   skeleton <- c(roxygen.dir, man.dir)
 
   if (copy.package)
@@ -72,9 +74,14 @@ roxygenize <- function(package.dir,
 
   for (dir in skeleton) dir.create(dir, showWarnings=FALSE)
   r.dir <- file.path(package.dir, R.DIR)
-  source.files <- as.list(list.files(r.dir, recursive=TRUE, full.names=TRUE))
+  files <- as.list(list.files(r.dir, recursive=TRUE, full.names=TRUE))
   Rd <- make.Rd.roclet(man.dir)
-  do.call(Rd$parse, source.files)
+  do.call(Rd$parse, files)
   namespace <- make.namespace.roclet(namespace.file)
-  do.call(namespace$parse, source.files)
+  do.call(namespace$parse, files)
+  setwd(r.dir)
+  files <- as.list(list.files('.', recursive=TRUE))
+  collate <- make.collate.roclet(merge.file=package.description,
+                                 target.file=roxygen.description)
+  do.call(collate$parse, files)
 }

---FILE: sandbox/collate.R---
@@ -1,3 +1,4 @@
+source('../R/roxygen.R')
 source('../R/functional.R')
 source('../R/list.R')
 source('../R/parse.R')

---FILE: sandbox/roxygenize.R---
@@ -1,3 +1,5 @@
+library(tools)
+
 if (!file.exists('pkg/R/parse.R'))
   stop('Run one directory above `pkg\'.')
 

---FILE: tests/runit/runit.collate.R---
@@ -1,17 +1,20 @@
+## TODO: merge test
 test.collate <- function() {
   roclet <- make.collate.roclet()
-  checkEquals(capture.output(roclet$parse('runit/collate/belt.R',
-                                          'runit/collate/jacket.R',
-                                          'runit/collate/pants.R',
-                                          'runit/collate/shirt.R',
-                                          'runit/collate/shoes.R',
-                                          'runit/collate/socks.R',
-                                          'runit/collate/tie.R',
-                                          'runit/collate/undershorts.R',
-                                          'runit/collate/watch.R')),
-              paste(""Collate: 'runit/collate/undershorts.R'"",
-                    ""'runit/collate/pants.R' 'runit/collate/belt.R'"",
-                    ""'runit/collate/shirt.R' 'runit/collate/tie.R'"",
+  collation <- capture.output(roclet$parse('runit/collate/belt.R',
+                                           'runit/collate/jacket.R',
+                                           'runit/collate/pants.R',
+                                           'runit/collate/shirt.R',
+                                           'runit/collate/shoes.R',
+                                           'runit/collate/socks.R',
+                                           'runit/collate/tie.R',
+                                           'runit/collate/undershorts.R',
+                                           'runit/collate/watch.R'))
+  checkEquals(collation,
+              paste(""Collate: 'runit/collate/shirt.R'"",
+                    ""'runit/collate/undershorts.R' 'runit/collate/pants.R'"",
+                    ""'runit/collate/belt.R' 'runit/collate/tie.R'"",
                     ""'runit/collate/jacket.R' 'runit/collate/socks.R'"",
-                    ""'runit/collate/shoes.R' 'runit/collate/watch.R'""))
+                    ""'runit/collate/shoes.R' 'runit/collate/watch.R'""),
+              msg=collation)
 }"
r-lib,roxygen2,ae64c06e4c6403580fe7fe615b62a98cbfbc5458,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-07-27T04:29:08Z,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-07-27T04:29:08Z,"fixed grave collate error: use member instead of %in%; merge for collate; outfile for namespace; optional verbosity; setwd() hack for roxygenizing collate; msg on test.collate


git-svn-id: svn://svn.r-forge.r-project.org/svnroot/roxygen/pkg@102 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",R/Rd.R;R/collate.R;R/namespace.R;R/parse.R;R/roxygenize.R;sandbox/collate.R;sandbox/roxygenize.R;tests/runit/runit.collate.R,False,True,True,False,91,35,126,"---FILE: R/Rd.R---
@@ -81,6 +81,8 @@ roxygen()
 #'
 #' @param subdir directory into which to place the Rd files; if
 #' \code{NULL}, standard out.
+#' @param verbose whether to declare what we're doing in the
+#' \var{subdir}
 #' @return Rd roclet
 #' @examples
 #' #' This sentence describes the function.
@@ -106,7 +108,8 @@ roxygen()
 #' roclet <- make.Rd.roclet('man')
 #' \dontrun{roclet$parse('example.R')}
 #' @export
-make.Rd.roclet <- function(subdir=NULL) {
+make.Rd.roclet <- function(subdir=NULL,
+                           verbose=TRUE) {
   #' Translate a key and expressions into an Rd expression;
   #' multiple expressions take their own braces.
   #' @param key the expression's key
@@ -224,7 +227,8 @@ make.Rd.roclet <- function(subdir=NULL) {
         assign.parent('filename',
                       file.path(subdir, sprintf('%s.Rd', name)),
                       environment())
-        cat(sprintf('Writing %s to %s\n', name, filename))
+        if (verbose)
+          cat(sprintf('Writing %s to %s\n', name, filename))
         unlink(filename)
       }
       parse.expression('name', name)

---FILE: R/collate.R---
@@ -1,7 +1,6 @@
 #' @include roxygen.R
-#' @include parse.R
-#' @include roclet.R
 #' @include string.R
+#' @include roclet.R
 roxygen()
 
 #' Make collate roclet which parses the given files; topologically
@@ -14,8 +13,14 @@ roxygen()
 #' Contains the member function \code{parse} which parses an arbitrary number
 #' of files.
 #'
-#' @seealso \code{\link{make.roclet}}
+#' @param merge.file \file{DESCRIPTION} file with which to merge directive;
+#' or \code{NULL} for none
+#' @param target.file whither to \code{cat} directive (whether merged or
+#' not); blank line is standard out
+#' @param verbose whether to describe what we're doing with the
+#' target.file
 #' @return Rd roclet
+#' @seealso \code{\link{make.roclet}}
 #' @examples
 #' #' An example source file, example.R
 #' #' @@include roxygen.R
@@ -25,7 +30,9 @@ roxygen()
 #' roclet <- make.collate.roclet()
 #' \dontrun{roclet$parse('example.R')}
 #' @export
-make.collate.roclet <- function() {
+make.collate.roclet <- function(merge.file=NULL,
+                                target.file='',
+                                verbose=TRUE) {
   vertices <- NULL
 
   make.vertex <- function(file) {
@@ -44,8 +51,15 @@ make.collate.roclet <- function() {
                                              names=file))),
                     environment())
 
+  member <- function(ancestor, ancestors) {
+    for (vertex in ancestors)
+      if (identical(ancestor, vertex))
+        TRUE
+    FALSE
+  }
+
   maybe.append.ancestor <- function(predecessor, ancestor)
-    if (!c(ancestor) %in% predecessor$ancestors)
+    if (!member(ancestor, predecessor$ancestors))
       predecessor$ancestors <-
         append(ancestor, predecessor$ancestors)
 
@@ -84,14 +98,33 @@ make.collate.roclet <- function() {
         visit(vertex)
   }
 
-  post.files <-
-    function() cat('Collate:',
-                   Reduce.paste(function(vertex)
-                                sprintf(""'%s'"", vertex$file),
-                                topological.sort(vertices),
-                                ' '),
-                   '\n',
-                   sep='')
+  COLLATE.FIELD <- 'Collate:'
+
+  merge <- function(directive) {
+    lines <- readLines(merge.file)
+    filtered.lines <- Filter(function(line)
+                             length(grep(sprintf('^%s', COLLATE.FIELD),
+                                         trim(line))) == 0,
+                             lines)
+    if (verbose && !is.null.string(target.file))
+      cat(sprintf('Merging `Collate:\' from %s to %s',
+                  merge.file,
+                  target.file), '\n')
+    cat(filtered.lines, directive, file=target.file, sep='\n')
+  }
+
+  post.files <- function() {
+    directive <-
+      sprintf('Collate:%s',
+              Reduce.paste(function(vertex)
+                           sprintf(""'%s'"", vertex$file),
+                           topological.sort(vertices),
+                           ' '))
+    if (!is.null(merge.file))
+      merge(directive)
+    else
+      cat(directive, '\n', file=target.file, sep='')
+  }
 
   roclet <- make.roclet(parse.include,
                         pre.parse=pre.parse,

---FILE: R/namespace.R---
@@ -49,6 +49,8 @@ roxygen()
 #' }
 #'
 #' @param outfile whither to send output; '' == standard out
+#' @param verbose whether to anounce what we're doing with
+#' the \var{outfile}
 #' @return Namespace roclet
 #' @examples
 #' #' An example file, example.R, which imports
@@ -63,7 +65,8 @@ roxygen()
 #' roclet <- make.namespace.roclet()
 #' \dontrun{roclet$parse('example.R')}
 #' @export
-make.namespace.roclet <- function(outfile='') {
+make.namespace.roclet <- function(outfile='',
+                                  verbose=TRUE) {
   parse.directive <- function(proc, parms)
     cat(sprintf('%s(%s)\n', proc, strmap(Identity, ', ', parms)),
         file=outfile,
@@ -78,8 +81,11 @@ make.namespace.roclet <- function(outfile='') {
                       S4generic=partitum$S4method,
                       S4class=partitum$S4class)
 
-  pre.files <- function()
+  pre.files <- function() {
+    if (verbose && !is.null.string(outfile))
+      cat(sprintf('Writing namespace directives to %s', outfile), '\n')
     unlink(outfile)
+  }
 
   roclet <- make.roclet(parse.directive,
                         pre.parse=pre.parse,

---FILE: R/parse.R---
@@ -1,7 +1,7 @@
 #' @include roxygen.R
+#' @include functional.R
 #' @include string.R
 #' @include list.R
-#' @include functional.R
 roxygen()
 
 #' Sequence that distinguishes roxygen comment from normal comment.

---FILE: R/roxygenize.R---
@@ -55,12 +55,14 @@ copy.dir <- function(source,
 #' @param copy.package if R.utils is present, copies the package
 #' over before adding/manipulating files.
 #' @return \code{NULL}
+#' @importFrom tools file_path_as_absolute
 roxygenize <- function(package.dir,
                        copy.package=TRUE) {
   roxygen.dir <- sprintf(ROXYGEN.DIR, package.dir)
   man.dir <- file.path(roxygen.dir, MAN.DIR)
   namespace.file <- file.path(roxygen.dir, NAMESPACE.FILE)
-  description.file <- file.path(roxygen.dir, DESCRIPTION.FILE)
+  package.description <- file_path_as_absolute(file.path(package.dir, DESCRIPTION.FILE))
+  roxygen.description <- file_path_as_absolute(file.path(roxygen.dir, DESCRIPTION.FILE))
   skeleton <- c(roxygen.dir, man.dir)
 
   if (copy.package)
@@ -72,9 +74,14 @@ roxygenize <- function(package.dir,
 
   for (dir in skeleton) dir.create(dir, showWarnings=FALSE)
   r.dir <- file.path(package.dir, R.DIR)
-  source.files <- as.list(list.files(r.dir, recursive=TRUE, full.names=TRUE))
+  files <- as.list(list.files(r.dir, recursive=TRUE, full.names=TRUE))
   Rd <- make.Rd.roclet(man.dir)
-  do.call(Rd$parse, source.files)
+  do.call(Rd$parse, files)
   namespace <- make.namespace.roclet(namespace.file)
-  do.call(namespace$parse, source.files)
+  do.call(namespace$parse, files)
+  setwd(r.dir)
+  files <- as.list(list.files('.', recursive=TRUE))
+  collate <- make.collate.roclet(merge.file=package.description,
+                                 target.file=roxygen.description)
+  do.call(collate$parse, files)
 }

---FILE: sandbox/collate.R---
@@ -1,3 +1,4 @@
+source('../R/roxygen.R')
 source('../R/functional.R')
 source('../R/list.R')
 source('../R/parse.R')

---FILE: sandbox/roxygenize.R---
@@ -1,3 +1,5 @@
+library(tools)
+
 if (!file.exists('pkg/R/parse.R'))
   stop('Run one directory above `pkg\'.')
 

---FILE: tests/runit/runit.collate.R---
@@ -1,17 +1,20 @@
+## TODO: merge test
 test.collate <- function() {
   roclet <- make.collate.roclet()
-  checkEquals(capture.output(roclet$parse('runit/collate/belt.R',
-                                          'runit/collate/jacket.R',
-                                          'runit/collate/pants.R',
-                                          'runit/collate/shirt.R',
-                                          'runit/collate/shoes.R',
-                                          'runit/collate/socks.R',
-                                          'runit/collate/tie.R',
-                                          'runit/collate/undershorts.R',
-                                          'runit/collate/watch.R')),
-              paste(""Collate: 'runit/collate/undershorts.R'"",
-                    ""'runit/collate/pants.R' 'runit/collate/belt.R'"",
-                    ""'runit/collate/shirt.R' 'runit/collate/tie.R'"",
+  collation <- capture.output(roclet$parse('runit/collate/belt.R',
+                                           'runit/collate/jacket.R',
+                                           'runit/collate/pants.R',
+                                           'runit/collate/shirt.R',
+                                           'runit/collate/shoes.R',
+                                           'runit/collate/socks.R',
+                                           'runit/collate/tie.R',
+                                           'runit/collate/undershorts.R',
+                                           'runit/collate/watch.R'))
+  checkEquals(collation,
+              paste(""Collate: 'runit/collate/shirt.R'"",
+                    ""'runit/collate/undershorts.R' 'runit/collate/pants.R'"",
+                    ""'runit/collate/belt.R' 'runit/collate/tie.R'"",
                     ""'runit/collate/jacket.R' 'runit/collate/socks.R'"",
-                    ""'runit/collate/shoes.R' 'runit/collate/watch.R'""))
+                    ""'runit/collate/shoes.R' 'runit/collate/watch.R'""),
+              msg=collation)
 }"
r-lib,roxygen2,3ed1fd233dfcecac1b23eb4a82d6b8555f99531a,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-07-27T04:29:08Z,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-07-27T04:29:08Z,"fixed grave collate error: use member instead of %in%; merge for collate; outfile for namespace; optional verbosity; setwd() hack for roxygenizing collate; msg on test.collate


git-svn-id: svn+ssh://svn.r-forge.r-project.org/svnroot/roxygen@102 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",pkg/R/Rd.R;pkg/R/collate.R;pkg/R/namespace.R;pkg/R/parse.R;pkg/R/roxygenize.R;pkg/sandbox/collate.R;pkg/sandbox/roxygenize.R;pkg/tests/runit/runit.collate.R,False,True,True,False,91,35,126,"---FILE: pkg/R/Rd.R---
@@ -81,6 +81,8 @@ roxygen()
 #'
 #' @param subdir directory into which to place the Rd files; if
 #' \code{NULL}, standard out.
+#' @param verbose whether to declare what we're doing in the
+#' \var{subdir}
 #' @return Rd roclet
 #' @examples
 #' #' This sentence describes the function.
@@ -106,7 +108,8 @@ roxygen()
 #' roclet <- make.Rd.roclet('man')
 #' \dontrun{roclet$parse('example.R')}
 #' @export
-make.Rd.roclet <- function(subdir=NULL) {
+make.Rd.roclet <- function(subdir=NULL,
+                           verbose=TRUE) {
   #' Translate a key and expressions into an Rd expression;
   #' multiple expressions take their own braces.
   #' @param key the expression's key
@@ -224,7 +227,8 @@ make.Rd.roclet <- function(subdir=NULL) {
         assign.parent('filename',
                       file.path(subdir, sprintf('%s.Rd', name)),
                       environment())
-        cat(sprintf('Writing %s to %s\n', name, filename))
+        if (verbose)
+          cat(sprintf('Writing %s to %s\n', name, filename))
         unlink(filename)
       }
       parse.expression('name', name)

---FILE: pkg/R/collate.R---
@@ -1,7 +1,6 @@
 #' @include roxygen.R
-#' @include parse.R
-#' @include roclet.R
 #' @include string.R
+#' @include roclet.R
 roxygen()
 
 #' Make collate roclet which parses the given files; topologically
@@ -14,8 +13,14 @@ roxygen()
 #' Contains the member function \code{parse} which parses an arbitrary number
 #' of files.
 #'
-#' @seealso \code{\link{make.roclet}}
+#' @param merge.file \file{DESCRIPTION} file with which to merge directive;
+#' or \code{NULL} for none
+#' @param target.file whither to \code{cat} directive (whether merged or
+#' not); blank line is standard out
+#' @param verbose whether to describe what we're doing with the
+#' target.file
 #' @return Rd roclet
+#' @seealso \code{\link{make.roclet}}
 #' @examples
 #' #' An example source file, example.R
 #' #' @@include roxygen.R
@@ -25,7 +30,9 @@ roxygen()
 #' roclet <- make.collate.roclet()
 #' \dontrun{roclet$parse('example.R')}
 #' @export
-make.collate.roclet <- function() {
+make.collate.roclet <- function(merge.file=NULL,
+                                target.file='',
+                                verbose=TRUE) {
   vertices <- NULL
 
   make.vertex <- function(file) {
@@ -44,8 +51,15 @@ make.collate.roclet <- function() {
                                              names=file))),
                     environment())
 
+  member <- function(ancestor, ancestors) {
+    for (vertex in ancestors)
+      if (identical(ancestor, vertex))
+        TRUE
+    FALSE
+  }
+
   maybe.append.ancestor <- function(predecessor, ancestor)
-    if (!c(ancestor) %in% predecessor$ancestors)
+    if (!member(ancestor, predecessor$ancestors))
       predecessor$ancestors <-
         append(ancestor, predecessor$ancestors)
 
@@ -84,14 +98,33 @@ make.collate.roclet <- function() {
         visit(vertex)
   }
 
-  post.files <-
-    function() cat('Collate:',
-                   Reduce.paste(function(vertex)
-                                sprintf(""'%s'"", vertex$file),
-                                topological.sort(vertices),
-                                ' '),
-                   '\n',
-                   sep='')
+  COLLATE.FIELD <- 'Collate:'
+
+  merge <- function(directive) {
+    lines <- readLines(merge.file)
+    filtered.lines <- Filter(function(line)
+                             length(grep(sprintf('^%s', COLLATE.FIELD),
+                                         trim(line))) == 0,
+                             lines)
+    if (verbose && !is.null.string(target.file))
+      cat(sprintf('Merging `Collate:\' from %s to %s',
+                  merge.file,
+                  target.file), '\n')
+    cat(filtered.lines, directive, file=target.file, sep='\n')
+  }
+
+  post.files <- function() {
+    directive <-
+      sprintf('Collate:%s',
+              Reduce.paste(function(vertex)
+                           sprintf(""'%s'"", vertex$file),
+                           topological.sort(vertices),
+                           ' '))
+    if (!is.null(merge.file))
+      merge(directive)
+    else
+      cat(directive, '\n', file=target.file, sep='')
+  }
 
   roclet <- make.roclet(parse.include,
                         pre.parse=pre.parse,

---FILE: pkg/R/namespace.R---
@@ -49,6 +49,8 @@ roxygen()
 #' }
 #'
 #' @param outfile whither to send output; '' == standard out
+#' @param verbose whether to anounce what we're doing with
+#' the \var{outfile}
 #' @return Namespace roclet
 #' @examples
 #' #' An example file, example.R, which imports
@@ -63,7 +65,8 @@ roxygen()
 #' roclet <- make.namespace.roclet()
 #' \dontrun{roclet$parse('example.R')}
 #' @export
-make.namespace.roclet <- function(outfile='') {
+make.namespace.roclet <- function(outfile='',
+                                  verbose=TRUE) {
   parse.directive <- function(proc, parms)
     cat(sprintf('%s(%s)\n', proc, strmap(Identity, ', ', parms)),
         file=outfile,
@@ -78,8 +81,11 @@ make.namespace.roclet <- function(outfile='') {
                       S4generic=partitum$S4method,
                       S4class=partitum$S4class)
 
-  pre.files <- function()
+  pre.files <- function() {
+    if (verbose && !is.null.string(outfile))
+      cat(sprintf('Writing namespace directives to %s', outfile), '\n')
     unlink(outfile)
+  }
 
   roclet <- make.roclet(parse.directive,
                         pre.parse=pre.parse,

---FILE: pkg/R/parse.R---
@@ -1,7 +1,7 @@
 #' @include roxygen.R
+#' @include functional.R
 #' @include string.R
 #' @include list.R
-#' @include functional.R
 roxygen()
 
 #' Sequence that distinguishes roxygen comment from normal comment.

---FILE: pkg/R/roxygenize.R---
@@ -55,12 +55,14 @@ copy.dir <- function(source,
 #' @param copy.package if R.utils is present, copies the package
 #' over before adding/manipulating files.
 #' @return \code{NULL}
+#' @importFrom tools file_path_as_absolute
 roxygenize <- function(package.dir,
                        copy.package=TRUE) {
   roxygen.dir <- sprintf(ROXYGEN.DIR, package.dir)
   man.dir <- file.path(roxygen.dir, MAN.DIR)
   namespace.file <- file.path(roxygen.dir, NAMESPACE.FILE)
-  description.file <- file.path(roxygen.dir, DESCRIPTION.FILE)
+  package.description <- file_path_as_absolute(file.path(package.dir, DESCRIPTION.FILE))
+  roxygen.description <- file_path_as_absolute(file.path(roxygen.dir, DESCRIPTION.FILE))
   skeleton <- c(roxygen.dir, man.dir)
 
   if (copy.package)
@@ -72,9 +74,14 @@ roxygenize <- function(package.dir,
 
   for (dir in skeleton) dir.create(dir, showWarnings=FALSE)
   r.dir <- file.path(package.dir, R.DIR)
-  source.files <- as.list(list.files(r.dir, recursive=TRUE, full.names=TRUE))
+  files <- as.list(list.files(r.dir, recursive=TRUE, full.names=TRUE))
   Rd <- make.Rd.roclet(man.dir)
-  do.call(Rd$parse, source.files)
+  do.call(Rd$parse, files)
   namespace <- make.namespace.roclet(namespace.file)
-  do.call(namespace$parse, source.files)
+  do.call(namespace$parse, files)
+  setwd(r.dir)
+  files <- as.list(list.files('.', recursive=TRUE))
+  collate <- make.collate.roclet(merge.file=package.description,
+                                 target.file=roxygen.description)
+  do.call(collate$parse, files)
 }

---FILE: pkg/sandbox/collate.R---
@@ -1,3 +1,4 @@
+source('../R/roxygen.R')
 source('../R/functional.R')
 source('../R/list.R')
 source('../R/parse.R')

---FILE: pkg/sandbox/roxygenize.R---
@@ -1,3 +1,5 @@
+library(tools)
+
 if (!file.exists('pkg/R/parse.R'))
   stop('Run one directory above `pkg\'.')
 

---FILE: pkg/tests/runit/runit.collate.R---
@@ -1,17 +1,20 @@
+## TODO: merge test
 test.collate <- function() {
   roclet <- make.collate.roclet()
-  checkEquals(capture.output(roclet$parse('runit/collate/belt.R',
-                                          'runit/collate/jacket.R',
-                                          'runit/collate/pants.R',
-                                          'runit/collate/shirt.R',
-                                          'runit/collate/shoes.R',
-                                          'runit/collate/socks.R',
-                                          'runit/collate/tie.R',
-                                          'runit/collate/undershorts.R',
-                                          'runit/collate/watch.R')),
-              paste(""Collate: 'runit/collate/undershorts.R'"",
-                    ""'runit/collate/pants.R' 'runit/collate/belt.R'"",
-                    ""'runit/collate/shirt.R' 'runit/collate/tie.R'"",
+  collation <- capture.output(roclet$parse('runit/collate/belt.R',
+                                           'runit/collate/jacket.R',
+                                           'runit/collate/pants.R',
+                                           'runit/collate/shirt.R',
+                                           'runit/collate/shoes.R',
+                                           'runit/collate/socks.R',
+                                           'runit/collate/tie.R',
+                                           'runit/collate/undershorts.R',
+                                           'runit/collate/watch.R'))
+  checkEquals(collation,
+              paste(""Collate: 'runit/collate/shirt.R'"",
+                    ""'runit/collate/undershorts.R' 'runit/collate/pants.R'"",
+                    ""'runit/collate/belt.R' 'runit/collate/tie.R'"",
                     ""'runit/collate/jacket.R' 'runit/collate/socks.R'"",
-                    ""'runit/collate/shoes.R' 'runit/collate/watch.R'""))
+                    ""'runit/collate/shoes.R' 'runit/collate/watch.R'""),
+              msg=collation)
 }"
r-lib,roxygen2,5f2e3d177aba5931f54a3e70d7541e321d7ce6f6,Peter Danenberg,pcd@roxygen.org,2008-07-26T03:19:39Z,Peter Danenberg,pcd@roxygen.org,2008-07-26T03:19:39Z,"add roxygenize to collation; fix infelicitous tags; de-TeXed, first-sentence titles; @method for S3; fix argument docs; BUGS


git-svn-id: svn://svn.r-forge.r-project.org/svnroot/roxygen/pkg@92 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",DESCRIPTION;R/Rd.R;R/list.R;R/parse.R;R/roclet.R;R/roxygenize.R;R/string.R;README;sandbox/Rd.R;tests/runit/runit.Rd.R,False,True,True,False,181,26,207,"---FILE: DESCRIPTION---
@@ -7,4 +7,5 @@ Author: Peter Danenberg <pcd@roxygen.org>,
         Manuel Eugster <Manuel.Eugster@stat.uni-muenchen.de>
 Maintainer: Peter Danenberg <pcd@roxygen.org>
 URL: http://roxygen.org
-Collate: 'functional.R' 'string.R' 'parse.R' 'collate.R' 'list.R' 'roclet.R' 'namespace.R' 'Rd.R'
+Collate: 'functional.R' 'string.R' 'parse.R' 'collate.R' 'list.R' 'roclet.R' 'namespace.R' 'Rd.R' 'roxygenize.R'
+Suggests: R.utils

---FILE: R/Rd.R---
@@ -6,12 +6,15 @@ roxygen()
 
 #' Make an Rd roclet which parses the given files and writes the Rd
 #' format to standard out (TODO: write to the file designated by
-#' \code{@@name}). Tries to guess \name and \usage unless explicitly
-#' given.
+#' \code{@@name}). Tries to guess \code{@@name} and \code{@@usage} unless
+#' explicitly given.
 #'
 #' Contains the member function \code{parse} which parses the result
 #' of \code{parse.files}.
 #'
+#' If \code{@@title} isn't present, substitutes \code{@@name} or
+#' equivalent.
+#'
 #' @param subdir directory into which to place the Rd files; if
 #' \code{NULL}, standard out.
 #' @return Rd roclet
@@ -36,7 +39,7 @@ make.Rd.roclet <- function(subdir=NULL) {
   #' @param \dots the arguments
   #' @return \code{NULL}
   parse.expression <- function(key, ...)
-    cat(Rd.expression(key, c(...)), file=filename, append=T)
+    cat(Rd.expression(key, c(...)), file=filename, append=TRUE)
 
   filename <- ''
 
@@ -49,11 +52,58 @@ make.Rd.roclet <- function(subdir=NULL) {
     getSrcLines(srcfile, first.line, first.line)
   }
 
-  NULL.STATEMENT <- 'roxygen()'
+  #' What does the noop look like?
+  NULL.STATEMENT <- 'roxygen[[:space:]]*()'
 
+  #' Does the statement contain a noop-like?
+  #' @param source.line the line of source code
+  #' @return Whether the statement contains a noop
   is.null.statement <- function(source.line)
     length(grep(NULL.STATEMENT, source.line) > 0)
 
+  de.tex <- function(string)
+    gsub('\\\\[^{]*\\{([^}]*)(}|)',
+         '\\1',
+         string,
+         perl=T)
+
+  #' First sentence of a string, defined as first
+  #' period, question mark or newline.
+  #' @param description the string to be first-sentenced
+  #' @return The first sentence
+  first.sentence <- function(description) {
+    description <- de.tex(description)
+    r <- regexpr('[^.?\n]*(\\.(?!\\w)|\\?|\n|)',
+                 description,
+                 perl=T)
+    sentence <- substr(description, r, attr(r, 'match.length'))
+    if (is.null.string(sentence))
+      NULL
+    else {
+      chars <- nchar(sentence)
+      last.char <- substr(sentence, chars, chars)
+      if (last.char == '.' || last.char == '?')
+        sentence
+      else
+        paste(trim(sentence), '\\dots', sep='')
+    }
+  }
+
+  #' If \code{@@title} is specified, use it; or
+  #' take the first sentence of the description;
+  #' or, lastly, take the name.
+  #' @param partitum the parsed elements
+  #' @param name the calculated name-fallback
+  #' @return The parsed title
+  parse.title <- function(partitum, name) {
+    if (!is.null(partitum$title))
+      partitum$title
+    else if (!is.null(partitum$description))
+      first.sentence(partitum$description)
+    else
+      name
+  }
+  
   #' Reconstruct the \name directive from amongst
   #' \code{@@name}, \code{@@setMethod}, \code{@@setClass},
   #' \code{@@setGeneric}, \code{@@assignee}, etc.
@@ -77,7 +127,7 @@ make.Rd.roclet <- function(subdir=NULL) {
                         filename,
                         first.line,
                         first.source.line),
-                immediate.=T)
+                immediate.=TRUE)
     } else if (!is.null(name)) {
       name <- trim(name)
       if (!is.null(subdir)) {
@@ -87,10 +137,22 @@ make.Rd.roclet <- function(subdir=NULL) {
         cat(sprintf('Writing %s to %s\n', name, filename))
         unlink(filename)
       }
+      parse.expression('title', parse.title(partitum, name))
       parse.expression('name', name)
+      if (is.null(partitum$aliases))
+        parse.expression('alias', name)
     }
   }
   
+  parse.function.name <- function(partitum) {
+    if (!is.null(partitum$method))
+      Rd.expression('method',
+          car(partitum$method),
+          cadr(partitum$method))
+    else
+      partitum$assignee
+  }
+
   #' Turn a list of formal arguments into a human-readable
   #' function-like.
   #' @param partitum the pre-parsed elements
@@ -112,10 +174,11 @@ make.Rd.roclet <- function(subdir=NULL) {
                          sep=', '))
       parse.expression('usage',
           do.call(paste,
-                  c(as.list(strwrap(sprintf('%s(%s)',
-                                            partitum$assignee,
-                                            args),
-                                    exdent=4)),
+                  c(as.list(strwrap
+                            (sprintf('%s(%s)',
+                                     parse.function.name(partitum),
+                                     args),
+                             exdent=4)),
                     sep='\n')))
     }
   }

---FILE: R/list.R---
@@ -86,7 +86,7 @@ is.odd <- function(a) {
 #' Zip \emph{n} lists together into tuplets of
 #' length \emph{n}.
 #' @param zipper the zipping function
-#' @param dots the lists to be zipped
+#' @param \dots the lists to be zipped
 #' @return A list of tuplets
 zip <- function(zipper, ...) {
   m <- mapply(zipper, ...)

---FILE: R/parse.R---
@@ -1,7 +1,12 @@
 #' @include string.R
 #' @include list.R
 #' @include functional.R
+NULL
+
+#' Sequence that distinguishes roxygen comment from normal comment.
 LINE.DELIMITER <- '#\''
+
+#' Symbol that delimits tags.
 TAG.DELIMITER <- '@'
 
 #' No-op for sourceless files
@@ -218,7 +223,8 @@ parse.name.description <- function(key, rest) {
 #' @aliases slot param
 register.preref.parsers(parse.name.description,
                         'slot',
-                        'param')
+                        'param',
+                        'method')
 
 #' Parse an element containing a single name and only a name;
 #' extra material will be ignored and a warning issued.
@@ -315,20 +321,25 @@ parser.srcref <- Curry(parser.default,
 
 #' Parse either srcrefs, prerefs or pairs of the same.
 #' @param ref the srcref, preref or pair of the same
+#' @param \dots ignored
 #' @return List containing the parsed srcref/preref
 parse.ref <- function(ref, ...)
   UseMethod('parse.ref')
 
 #' Parse a preref/srcrefs pair
+#' @method parse.ref list
 #' @param ref the preref/srcref pair
+#' @param \dots ignored
 #' @return List combining the parsed preref/srcref
 parse.ref.list <- function(ref, ...)
   append(parse.ref(car(ref)),
          parse.ref(cadr(ref)))
 
 
 #' Parse a preref
+#' @method parse.ref preref
 #' @param ref the preref to be parsed
+#' @param \dots ignored
 #' @return List containing the parsed preref
 parse.ref.preref <- function(ref, ...) {
   lines <- Map(trim.left, getSrcLines(attributes(ref)$srcfile,
@@ -461,7 +472,9 @@ parse.call <- function(expressions) {
 }
 
 #' Parse a srcref
+#' @method parse.ref srcref
 #' @param ref the srcref to be parsed
+#' @param \dots ignored
 #' @return List containing the parsed srcref
 parse.ref.srcref <- function(ref, ...) {
   srcfile <- attributes(ref)$srcfile

---FILE: R/roclet.R---
@@ -5,11 +5,11 @@ roxygen()
 #' Abstract roclet that serves as a rudimentary API.
 #'
 #' Contains the following member functions:
-#' \item{register.parser}{takes \code{key} and \code{parser}}
+#' \itemize{\item{register.parser}{takes \code{key} and \code{parser}}
 #' \item{register.parsers}{takes \code{parser} and \code{keys}}
 #' \item{register.default.parser}{takes a \code{key}}
 #' \item{register.default.parsers}{take \code{parsers}}
-#' \item{parse}{parses material contained in files}
+#' \item{parse}{parses material contained in files}}
 #'
 #' @param parse.default the default parser taking \code{key}
 #' and \code{value}
@@ -107,4 +107,3 @@ assign.parent <- function(var, value, env)
 #' @return The first non-null argument
 first.non.null <- function(...)
   append(NULL, c(...))[[1]]
-

---FILE: R/roxygenize.R---
@@ -1,17 +1,38 @@
 #' @include Rd.R
 #' @include namespace.R
 #' @include collate.R
+roxygen()
+
+#' Whither to copy package
 ROXYGEN.DIR <- '%s.roxygen'
+
+#' Whither to copy Rds
 MAN.DIR <- 'man'
+
+#' Whence to copy source code
 R.DIR <- 'R'
 
-roxygenize <- function(package.dir) {
+#' Process a package with the Rd, namespace and collate roclets.
+#' @param package.dir the package's top directory
+#' @param copy.package if R.utils is present, copies the package
+#' over before adding/manipulating files.
+#' @return \code{NULL}
+roxygenize <- function(package.dir,
+                       copy.package=TRUE) {
   roxygen.dir <- sprintf(ROXYGEN.DIR, package.dir)
   man.dir <- file.path(roxygen.dir, MAN.DIR)
   skeleton <- c(roxygen.dir, man.dir)
-  for (dir in skeleton) dir.create(dir, showWarnings=F)
+
+###   if (copy.package) {
+###     if (require('R.utils', quietly=T))
+###       copyDirectory(package.dir, roxygen.dir, overwrite=TRUE)
+###     else
+###       warning('`R.utils\' package not present; not copying package.')
+###   }
+
+  for (dir in skeleton) dir.create(dir, showWarnings=FALSE)
   r.dir <- file.path(package.dir, R.DIR)
-  source.files <- list.files(r.dir, recursive=T, full.names=T)
+  source.files <- list.files(r.dir, recursive=TRUE, full.names=TRUE)
   Rd <- make.Rd.roclet(man.dir)
   do.call(Rd$parse, as.list(source.files))
 }

---FILE: R/string.R---
@@ -1,7 +1,14 @@
 #' @include functional.R
 #' @include list.R
+NULL
+
+#' Absense of words
 SPACE <- '[[:space:]]+'
+
+#' Anti-anti-words
 MATTER <- '[^[:space:]]+'
+
+#' Analogue to the empty list
 NIL.STRING <- ''
 
 #' Trim [:space:] to the left of a string.

---FILE: README---
@@ -31,8 +31,20 @@ To test the Rd, namespace and collate roclets: there are similarly
 
 1.2. TODO
 
-Create a driver (possibly used by `R CMD roxygen') which farms out the
-results of each roclet to appropriate files in a package skeleton.
+* Create a driver (possibly used by `R CMD roxygen') which farms out
+  the results of each roclet to appropriate files in a package
+  skeleton.
+
+1.3. BUGS
+
+* parse.formals doesn't distinguish between no default argument and
+  NULL; need a special value?
+
+* Skeletal Rds are created for assignments without Roxygen-blocks;
+  desirable?
+
+* first.sentence is fooled by infix periods, whereupon it resorts to
+  \dots.
 
 -----------
 * Hail, Hephaistos! Grant skill and weal.

---FILE: sandbox/Rd.R---
@@ -13,4 +13,6 @@ argc <- length(argv)
 files <- if (argc > 0) as.list(argv) else FILES
 
 roclet <- make.Rd.roclet()
-do.call(roclet$parse, files)
+## do.call(roclet$parse, files)
+roclet$parse.parsed(parse.text(""#' Is a number odd?
+                   a <- 2""))

---FILE: tests/runit/runit.Rd.R---
@@ -33,29 +33,39 @@ test.naked.roxygen <- function()
 
 test.name.from.assignment <- function()
   check.Rd.output('a <- 2',
-                  output='\\name{a}')
+                  output=c('\\title{a}',
+                    '\\name{a}',
+                    '\\alias{a}'))
 
 test.name.overriding.assignment <- function()
   check.Rd.output(""#' @name b
                    a <- 2"",
-                  output='\\name{b}')
+                  output=c('\\title{b}',
+                    '\\name{b}',
+                    '\\alias{b}'))
 
 test.implicit.usage.from.formals <- function()
   check.Rd.output(""a <- function(a=1) {}"",
-                  output=c(""\\name{a}"",
+                  output=c(""\\title{a}"",
+                    ""\\name{a}"",
+                    ""\\alias{a}"",
                     ""\\usage{a(a=1)}""))
 
 test.explicit.usage <- function()
   check.Rd.output(""#' @usage a(a=2)
                    a <- function(a=1) {}"",
-                  output=c(""\\name{a}"",
+                  output=c(""\\title{a}"",
+                    ""\\name{a}"",
+                    ""\\alias{a}"",
                     ""\\usage{a(a=2)}""))
 
 test.params <- function()
   check.Rd.output(""#' @param a an incipit letter
                    #' @param z a terminal letter
                    a <- function(a=1, z=2) {}"",
-                  output=c(""\\name{a}"",
+                  output=c(""\\title{a}"",
+                    ""\\name{a}"",
+                    ""\\alias{a}"",
                     ""\\usage{a(a=1, z=2)}"",
                     ""\\arguments{\\item{a}{an incipit letter}"",
                     ""\\item{z}{a terminal letter}}""))
@@ -96,3 +106,30 @@ test.generic.keys <- function()
                     ""\\author{test}"",
                     ""\\seealso{test}"",
                     ""\\concept{test}""))
+
+test.title.from.description <- function()
+  check.Rd.output(""#' Description with sentence. That continueth.
+                   a <- 2"",
+                  output=c(""\\title{Description with sentence}"",
+                    ""\\name{a}"",
+                    ""\\alias{a}"",
+                    paste(""\\description{Description with sentence."",
+                          ""That continueth.}"")))
+
+test.question.mark.end.of.sentence <- function()
+  check.Rd.output(""#' Is a number odd?
+                   is.odd <- function(a) {}"",
+                  output=c('\\title{Is a number odd?}',
+                    '\\name{is.odd}',
+                    '\\alias{is.odd}',
+                    '\\usage{is.odd(a)}',
+                    '\\description{Is a number odd?}'))
+
+test.ellipsis.on.no.period <- function()
+  check.Rd.output(""#' Whether a number is odd
+                   is.odd <- function(a) {}"",
+                  output=c('\\title{Whether a number is odd\dots}',
+                    '\\name{is.odd}',
+                    '\\alias{is.odd}',
+                    '\\usage{is.odd(a)}',
+                    '\\description{Whether a number is odd}'))"
r-lib,roxygen2,afbaf6759de14e158d003f2c3b5cc6d54c4a8e29,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-07-26T03:19:39Z,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-07-26T03:19:39Z,"add roxygenize to collation; fix infelicitous tags; de-TeXed, first-sentence titles; @method for S3; fix argument docs; BUGS


git-svn-id: svn://svn.r-forge.r-project.org/svnroot/roxygen/pkg@92 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",DESCRIPTION;R/Rd.R;R/list.R;R/parse.R;R/roclet.R;R/roxygenize.R;R/string.R;README;sandbox/Rd.R;tests/runit/runit.Rd.R,False,True,True,False,181,26,207,"---FILE: DESCRIPTION---
@@ -7,4 +7,5 @@ Author: Peter Danenberg <pcd@roxygen.org>,
         Manuel Eugster <Manuel.Eugster@stat.uni-muenchen.de>
 Maintainer: Peter Danenberg <pcd@roxygen.org>
 URL: http://roxygen.org
-Collate: 'functional.R' 'string.R' 'parse.R' 'collate.R' 'list.R' 'roclet.R' 'namespace.R' 'Rd.R'
+Collate: 'functional.R' 'string.R' 'parse.R' 'collate.R' 'list.R' 'roclet.R' 'namespace.R' 'Rd.R' 'roxygenize.R'
+Suggests: R.utils

---FILE: R/Rd.R---
@@ -6,12 +6,15 @@ roxygen()
 
 #' Make an Rd roclet which parses the given files and writes the Rd
 #' format to standard out (TODO: write to the file designated by
-#' \code{@@name}). Tries to guess \name and \usage unless explicitly
-#' given.
+#' \code{@@name}). Tries to guess \code{@@name} and \code{@@usage} unless
+#' explicitly given.
 #'
 #' Contains the member function \code{parse} which parses the result
 #' of \code{parse.files}.
 #'
+#' If \code{@@title} isn't present, substitutes \code{@@name} or
+#' equivalent.
+#'
 #' @param subdir directory into which to place the Rd files; if
 #' \code{NULL}, standard out.
 #' @return Rd roclet
@@ -36,7 +39,7 @@ make.Rd.roclet <- function(subdir=NULL) {
   #' @param \dots the arguments
   #' @return \code{NULL}
   parse.expression <- function(key, ...)
-    cat(Rd.expression(key, c(...)), file=filename, append=T)
+    cat(Rd.expression(key, c(...)), file=filename, append=TRUE)
 
   filename <- ''
 
@@ -49,11 +52,58 @@ make.Rd.roclet <- function(subdir=NULL) {
     getSrcLines(srcfile, first.line, first.line)
   }
 
-  NULL.STATEMENT <- 'roxygen()'
+  #' What does the noop look like?
+  NULL.STATEMENT <- 'roxygen[[:space:]]*()'
 
+  #' Does the statement contain a noop-like?
+  #' @param source.line the line of source code
+  #' @return Whether the statement contains a noop
   is.null.statement <- function(source.line)
     length(grep(NULL.STATEMENT, source.line) > 0)
 
+  de.tex <- function(string)
+    gsub('\\\\[^{]*\\{([^}]*)(}|)',
+         '\\1',
+         string,
+         perl=T)
+
+  #' First sentence of a string, defined as first
+  #' period, question mark or newline.
+  #' @param description the string to be first-sentenced
+  #' @return The first sentence
+  first.sentence <- function(description) {
+    description <- de.tex(description)
+    r <- regexpr('[^.?\n]*(\\.(?!\\w)|\\?|\n|)',
+                 description,
+                 perl=T)
+    sentence <- substr(description, r, attr(r, 'match.length'))
+    if (is.null.string(sentence))
+      NULL
+    else {
+      chars <- nchar(sentence)
+      last.char <- substr(sentence, chars, chars)
+      if (last.char == '.' || last.char == '?')
+        sentence
+      else
+        paste(trim(sentence), '\\dots', sep='')
+    }
+  }
+
+  #' If \code{@@title} is specified, use it; or
+  #' take the first sentence of the description;
+  #' or, lastly, take the name.
+  #' @param partitum the parsed elements
+  #' @param name the calculated name-fallback
+  #' @return The parsed title
+  parse.title <- function(partitum, name) {
+    if (!is.null(partitum$title))
+      partitum$title
+    else if (!is.null(partitum$description))
+      first.sentence(partitum$description)
+    else
+      name
+  }
+  
   #' Reconstruct the \name directive from amongst
   #' \code{@@name}, \code{@@setMethod}, \code{@@setClass},
   #' \code{@@setGeneric}, \code{@@assignee}, etc.
@@ -77,7 +127,7 @@ make.Rd.roclet <- function(subdir=NULL) {
                         filename,
                         first.line,
                         first.source.line),
-                immediate.=T)
+                immediate.=TRUE)
     } else if (!is.null(name)) {
       name <- trim(name)
       if (!is.null(subdir)) {
@@ -87,10 +137,22 @@ make.Rd.roclet <- function(subdir=NULL) {
         cat(sprintf('Writing %s to %s\n', name, filename))
         unlink(filename)
       }
+      parse.expression('title', parse.title(partitum, name))
       parse.expression('name', name)
+      if (is.null(partitum$aliases))
+        parse.expression('alias', name)
     }
   }
   
+  parse.function.name <- function(partitum) {
+    if (!is.null(partitum$method))
+      Rd.expression('method',
+          car(partitum$method),
+          cadr(partitum$method))
+    else
+      partitum$assignee
+  }
+
   #' Turn a list of formal arguments into a human-readable
   #' function-like.
   #' @param partitum the pre-parsed elements
@@ -112,10 +174,11 @@ make.Rd.roclet <- function(subdir=NULL) {
                          sep=', '))
       parse.expression('usage',
           do.call(paste,
-                  c(as.list(strwrap(sprintf('%s(%s)',
-                                            partitum$assignee,
-                                            args),
-                                    exdent=4)),
+                  c(as.list(strwrap
+                            (sprintf('%s(%s)',
+                                     parse.function.name(partitum),
+                                     args),
+                             exdent=4)),
                     sep='\n')))
     }
   }

---FILE: R/list.R---
@@ -86,7 +86,7 @@ is.odd <- function(a) {
 #' Zip \emph{n} lists together into tuplets of
 #' length \emph{n}.
 #' @param zipper the zipping function
-#' @param dots the lists to be zipped
+#' @param \dots the lists to be zipped
 #' @return A list of tuplets
 zip <- function(zipper, ...) {
   m <- mapply(zipper, ...)

---FILE: R/parse.R---
@@ -1,7 +1,12 @@
 #' @include string.R
 #' @include list.R
 #' @include functional.R
+NULL
+
+#' Sequence that distinguishes roxygen comment from normal comment.
 LINE.DELIMITER <- '#\''
+
+#' Symbol that delimits tags.
 TAG.DELIMITER <- '@'
 
 #' No-op for sourceless files
@@ -218,7 +223,8 @@ parse.name.description <- function(key, rest) {
 #' @aliases slot param
 register.preref.parsers(parse.name.description,
                         'slot',
-                        'param')
+                        'param',
+                        'method')
 
 #' Parse an element containing a single name and only a name;
 #' extra material will be ignored and a warning issued.
@@ -315,20 +321,25 @@ parser.srcref <- Curry(parser.default,
 
 #' Parse either srcrefs, prerefs or pairs of the same.
 #' @param ref the srcref, preref or pair of the same
+#' @param \dots ignored
 #' @return List containing the parsed srcref/preref
 parse.ref <- function(ref, ...)
   UseMethod('parse.ref')
 
 #' Parse a preref/srcrefs pair
+#' @method parse.ref list
 #' @param ref the preref/srcref pair
+#' @param \dots ignored
 #' @return List combining the parsed preref/srcref
 parse.ref.list <- function(ref, ...)
   append(parse.ref(car(ref)),
          parse.ref(cadr(ref)))
 
 
 #' Parse a preref
+#' @method parse.ref preref
 #' @param ref the preref to be parsed
+#' @param \dots ignored
 #' @return List containing the parsed preref
 parse.ref.preref <- function(ref, ...) {
   lines <- Map(trim.left, getSrcLines(attributes(ref)$srcfile,
@@ -461,7 +472,9 @@ parse.call <- function(expressions) {
 }
 
 #' Parse a srcref
+#' @method parse.ref srcref
 #' @param ref the srcref to be parsed
+#' @param \dots ignored
 #' @return List containing the parsed srcref
 parse.ref.srcref <- function(ref, ...) {
   srcfile <- attributes(ref)$srcfile

---FILE: R/roclet.R---
@@ -5,11 +5,11 @@ roxygen()
 #' Abstract roclet that serves as a rudimentary API.
 #'
 #' Contains the following member functions:
-#' \item{register.parser}{takes \code{key} and \code{parser}}
+#' \itemize{\item{register.parser}{takes \code{key} and \code{parser}}
 #' \item{register.parsers}{takes \code{parser} and \code{keys}}
 #' \item{register.default.parser}{takes a \code{key}}
 #' \item{register.default.parsers}{take \code{parsers}}
-#' \item{parse}{parses material contained in files}
+#' \item{parse}{parses material contained in files}}
 #'
 #' @param parse.default the default parser taking \code{key}
 #' and \code{value}
@@ -107,4 +107,3 @@ assign.parent <- function(var, value, env)
 #' @return The first non-null argument
 first.non.null <- function(...)
   append(NULL, c(...))[[1]]
-

---FILE: R/roxygenize.R---
@@ -1,17 +1,38 @@
 #' @include Rd.R
 #' @include namespace.R
 #' @include collate.R
+roxygen()
+
+#' Whither to copy package
 ROXYGEN.DIR <- '%s.roxygen'
+
+#' Whither to copy Rds
 MAN.DIR <- 'man'
+
+#' Whence to copy source code
 R.DIR <- 'R'
 
-roxygenize <- function(package.dir) {
+#' Process a package with the Rd, namespace and collate roclets.
+#' @param package.dir the package's top directory
+#' @param copy.package if R.utils is present, copies the package
+#' over before adding/manipulating files.
+#' @return \code{NULL}
+roxygenize <- function(package.dir,
+                       copy.package=TRUE) {
   roxygen.dir <- sprintf(ROXYGEN.DIR, package.dir)
   man.dir <- file.path(roxygen.dir, MAN.DIR)
   skeleton <- c(roxygen.dir, man.dir)
-  for (dir in skeleton) dir.create(dir, showWarnings=F)
+
+###   if (copy.package) {
+###     if (require('R.utils', quietly=T))
+###       copyDirectory(package.dir, roxygen.dir, overwrite=TRUE)
+###     else
+###       warning('`R.utils\' package not present; not copying package.')
+###   }
+
+  for (dir in skeleton) dir.create(dir, showWarnings=FALSE)
   r.dir <- file.path(package.dir, R.DIR)
-  source.files <- list.files(r.dir, recursive=T, full.names=T)
+  source.files <- list.files(r.dir, recursive=TRUE, full.names=TRUE)
   Rd <- make.Rd.roclet(man.dir)
   do.call(Rd$parse, as.list(source.files))
 }

---FILE: R/string.R---
@@ -1,7 +1,14 @@
 #' @include functional.R
 #' @include list.R
+NULL
+
+#' Absense of words
 SPACE <- '[[:space:]]+'
+
+#' Anti-anti-words
 MATTER <- '[^[:space:]]+'
+
+#' Analogue to the empty list
 NIL.STRING <- ''
 
 #' Trim [:space:] to the left of a string.

---FILE: README---
@@ -31,8 +31,20 @@ To test the Rd, namespace and collate roclets: there are similarly
 
 1.2. TODO
 
-Create a driver (possibly used by `R CMD roxygen') which farms out the
-results of each roclet to appropriate files in a package skeleton.
+* Create a driver (possibly used by `R CMD roxygen') which farms out
+  the results of each roclet to appropriate files in a package
+  skeleton.
+
+1.3. BUGS
+
+* parse.formals doesn't distinguish between no default argument and
+  NULL; need a special value?
+
+* Skeletal Rds are created for assignments without Roxygen-blocks;
+  desirable?
+
+* first.sentence is fooled by infix periods, whereupon it resorts to
+  \dots.
 
 -----------
 * Hail, Hephaistos! Grant skill and weal.

---FILE: sandbox/Rd.R---
@@ -13,4 +13,6 @@ argc <- length(argv)
 files <- if (argc > 0) as.list(argv) else FILES
 
 roclet <- make.Rd.roclet()
-do.call(roclet$parse, files)
+## do.call(roclet$parse, files)
+roclet$parse.parsed(parse.text(""#' Is a number odd?
+                   a <- 2""))

---FILE: tests/runit/runit.Rd.R---
@@ -33,29 +33,39 @@ test.naked.roxygen <- function()
 
 test.name.from.assignment <- function()
   check.Rd.output('a <- 2',
-                  output='\\name{a}')
+                  output=c('\\title{a}',
+                    '\\name{a}',
+                    '\\alias{a}'))
 
 test.name.overriding.assignment <- function()
   check.Rd.output(""#' @name b
                    a <- 2"",
-                  output='\\name{b}')
+                  output=c('\\title{b}',
+                    '\\name{b}',
+                    '\\alias{b}'))
 
 test.implicit.usage.from.formals <- function()
   check.Rd.output(""a <- function(a=1) {}"",
-                  output=c(""\\name{a}"",
+                  output=c(""\\title{a}"",
+                    ""\\name{a}"",
+                    ""\\alias{a}"",
                     ""\\usage{a(a=1)}""))
 
 test.explicit.usage <- function()
   check.Rd.output(""#' @usage a(a=2)
                    a <- function(a=1) {}"",
-                  output=c(""\\name{a}"",
+                  output=c(""\\title{a}"",
+                    ""\\name{a}"",
+                    ""\\alias{a}"",
                     ""\\usage{a(a=2)}""))
 
 test.params <- function()
   check.Rd.output(""#' @param a an incipit letter
                    #' @param z a terminal letter
                    a <- function(a=1, z=2) {}"",
-                  output=c(""\\name{a}"",
+                  output=c(""\\title{a}"",
+                    ""\\name{a}"",
+                    ""\\alias{a}"",
                     ""\\usage{a(a=1, z=2)}"",
                     ""\\arguments{\\item{a}{an incipit letter}"",
                     ""\\item{z}{a terminal letter}}""))
@@ -96,3 +106,30 @@ test.generic.keys <- function()
                     ""\\author{test}"",
                     ""\\seealso{test}"",
                     ""\\concept{test}""))
+
+test.title.from.description <- function()
+  check.Rd.output(""#' Description with sentence. That continueth.
+                   a <- 2"",
+                  output=c(""\\title{Description with sentence}"",
+                    ""\\name{a}"",
+                    ""\\alias{a}"",
+                    paste(""\\description{Description with sentence."",
+                          ""That continueth.}"")))
+
+test.question.mark.end.of.sentence <- function()
+  check.Rd.output(""#' Is a number odd?
+                   is.odd <- function(a) {}"",
+                  output=c('\\title{Is a number odd?}',
+                    '\\name{is.odd}',
+                    '\\alias{is.odd}',
+                    '\\usage{is.odd(a)}',
+                    '\\description{Is a number odd?}'))
+
+test.ellipsis.on.no.period <- function()
+  check.Rd.output(""#' Whether a number is odd
+                   is.odd <- function(a) {}"",
+                  output=c('\\title{Whether a number is odd\dots}',
+                    '\\name{is.odd}',
+                    '\\alias{is.odd}',
+                    '\\usage{is.odd(a)}',
+                    '\\description{Whether a number is odd}'))"
r-lib,roxygen2,f09311617ab44c466b2f541a8e98f84019466c14,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-07-26T03:19:39Z,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-07-26T03:19:39Z,"add roxygenize to collation; fix infelicitous tags; de-TeXed, first-sentence titles; @method for S3; fix argument docs; BUGS


git-svn-id: svn+ssh://svn.r-forge.r-project.org/svnroot/roxygen@92 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",pkg/DESCRIPTION;pkg/R/Rd.R;pkg/R/list.R;pkg/R/parse.R;pkg/R/roclet.R;pkg/R/roxygenize.R;pkg/R/string.R;pkg/README;pkg/sandbox/Rd.R;pkg/tests/runit/runit.Rd.R,False,True,True,False,181,26,207,"---FILE: pkg/DESCRIPTION---
@@ -7,4 +7,5 @@ Author: Peter Danenberg <pcd@roxygen.org>,
         Manuel Eugster <Manuel.Eugster@stat.uni-muenchen.de>
 Maintainer: Peter Danenberg <pcd@roxygen.org>
 URL: http://roxygen.org
-Collate: 'functional.R' 'string.R' 'parse.R' 'collate.R' 'list.R' 'roclet.R' 'namespace.R' 'Rd.R'
+Collate: 'functional.R' 'string.R' 'parse.R' 'collate.R' 'list.R' 'roclet.R' 'namespace.R' 'Rd.R' 'roxygenize.R'
+Suggests: R.utils

---FILE: pkg/R/Rd.R---
@@ -6,12 +6,15 @@ roxygen()
 
 #' Make an Rd roclet which parses the given files and writes the Rd
 #' format to standard out (TODO: write to the file designated by
-#' \code{@@name}). Tries to guess \name and \usage unless explicitly
-#' given.
+#' \code{@@name}). Tries to guess \code{@@name} and \code{@@usage} unless
+#' explicitly given.
 #'
 #' Contains the member function \code{parse} which parses the result
 #' of \code{parse.files}.
 #'
+#' If \code{@@title} isn't present, substitutes \code{@@name} or
+#' equivalent.
+#'
 #' @param subdir directory into which to place the Rd files; if
 #' \code{NULL}, standard out.
 #' @return Rd roclet
@@ -36,7 +39,7 @@ make.Rd.roclet <- function(subdir=NULL) {
   #' @param \dots the arguments
   #' @return \code{NULL}
   parse.expression <- function(key, ...)
-    cat(Rd.expression(key, c(...)), file=filename, append=T)
+    cat(Rd.expression(key, c(...)), file=filename, append=TRUE)
 
   filename <- ''
 
@@ -49,11 +52,58 @@ make.Rd.roclet <- function(subdir=NULL) {
     getSrcLines(srcfile, first.line, first.line)
   }
 
-  NULL.STATEMENT <- 'roxygen()'
+  #' What does the noop look like?
+  NULL.STATEMENT <- 'roxygen[[:space:]]*()'
 
+  #' Does the statement contain a noop-like?
+  #' @param source.line the line of source code
+  #' @return Whether the statement contains a noop
   is.null.statement <- function(source.line)
     length(grep(NULL.STATEMENT, source.line) > 0)
 
+  de.tex <- function(string)
+    gsub('\\\\[^{]*\\{([^}]*)(}|)',
+         '\\1',
+         string,
+         perl=T)
+
+  #' First sentence of a string, defined as first
+  #' period, question mark or newline.
+  #' @param description the string to be first-sentenced
+  #' @return The first sentence
+  first.sentence <- function(description) {
+    description <- de.tex(description)
+    r <- regexpr('[^.?\n]*(\\.(?!\\w)|\\?|\n|)',
+                 description,
+                 perl=T)
+    sentence <- substr(description, r, attr(r, 'match.length'))
+    if (is.null.string(sentence))
+      NULL
+    else {
+      chars <- nchar(sentence)
+      last.char <- substr(sentence, chars, chars)
+      if (last.char == '.' || last.char == '?')
+        sentence
+      else
+        paste(trim(sentence), '\\dots', sep='')
+    }
+  }
+
+  #' If \code{@@title} is specified, use it; or
+  #' take the first sentence of the description;
+  #' or, lastly, take the name.
+  #' @param partitum the parsed elements
+  #' @param name the calculated name-fallback
+  #' @return The parsed title
+  parse.title <- function(partitum, name) {
+    if (!is.null(partitum$title))
+      partitum$title
+    else if (!is.null(partitum$description))
+      first.sentence(partitum$description)
+    else
+      name
+  }
+  
   #' Reconstruct the \name directive from amongst
   #' \code{@@name}, \code{@@setMethod}, \code{@@setClass},
   #' \code{@@setGeneric}, \code{@@assignee}, etc.
@@ -77,7 +127,7 @@ make.Rd.roclet <- function(subdir=NULL) {
                         filename,
                         first.line,
                         first.source.line),
-                immediate.=T)
+                immediate.=TRUE)
     } else if (!is.null(name)) {
       name <- trim(name)
       if (!is.null(subdir)) {
@@ -87,10 +137,22 @@ make.Rd.roclet <- function(subdir=NULL) {
         cat(sprintf('Writing %s to %s\n', name, filename))
         unlink(filename)
       }
+      parse.expression('title', parse.title(partitum, name))
       parse.expression('name', name)
+      if (is.null(partitum$aliases))
+        parse.expression('alias', name)
     }
   }
   
+  parse.function.name <- function(partitum) {
+    if (!is.null(partitum$method))
+      Rd.expression('method',
+          car(partitum$method),
+          cadr(partitum$method))
+    else
+      partitum$assignee
+  }
+
   #' Turn a list of formal arguments into a human-readable
   #' function-like.
   #' @param partitum the pre-parsed elements
@@ -112,10 +174,11 @@ make.Rd.roclet <- function(subdir=NULL) {
                          sep=', '))
       parse.expression('usage',
           do.call(paste,
-                  c(as.list(strwrap(sprintf('%s(%s)',
-                                            partitum$assignee,
-                                            args),
-                                    exdent=4)),
+                  c(as.list(strwrap
+                            (sprintf('%s(%s)',
+                                     parse.function.name(partitum),
+                                     args),
+                             exdent=4)),
                     sep='\n')))
     }
   }

---FILE: pkg/R/list.R---
@@ -86,7 +86,7 @@ is.odd <- function(a) {
 #' Zip \emph{n} lists together into tuplets of
 #' length \emph{n}.
 #' @param zipper the zipping function
-#' @param dots the lists to be zipped
+#' @param \dots the lists to be zipped
 #' @return A list of tuplets
 zip <- function(zipper, ...) {
   m <- mapply(zipper, ...)

---FILE: pkg/R/parse.R---
@@ -1,7 +1,12 @@
 #' @include string.R
 #' @include list.R
 #' @include functional.R
+NULL
+
+#' Sequence that distinguishes roxygen comment from normal comment.
 LINE.DELIMITER <- '#\''
+
+#' Symbol that delimits tags.
 TAG.DELIMITER <- '@'
 
 #' No-op for sourceless files
@@ -218,7 +223,8 @@ parse.name.description <- function(key, rest) {
 #' @aliases slot param
 register.preref.parsers(parse.name.description,
                         'slot',
-                        'param')
+                        'param',
+                        'method')
 
 #' Parse an element containing a single name and only a name;
 #' extra material will be ignored and a warning issued.
@@ -315,20 +321,25 @@ parser.srcref <- Curry(parser.default,
 
 #' Parse either srcrefs, prerefs or pairs of the same.
 #' @param ref the srcref, preref or pair of the same
+#' @param \dots ignored
 #' @return List containing the parsed srcref/preref
 parse.ref <- function(ref, ...)
   UseMethod('parse.ref')
 
 #' Parse a preref/srcrefs pair
+#' @method parse.ref list
 #' @param ref the preref/srcref pair
+#' @param \dots ignored
 #' @return List combining the parsed preref/srcref
 parse.ref.list <- function(ref, ...)
   append(parse.ref(car(ref)),
          parse.ref(cadr(ref)))
 
 
 #' Parse a preref
+#' @method parse.ref preref
 #' @param ref the preref to be parsed
+#' @param \dots ignored
 #' @return List containing the parsed preref
 parse.ref.preref <- function(ref, ...) {
   lines <- Map(trim.left, getSrcLines(attributes(ref)$srcfile,
@@ -461,7 +472,9 @@ parse.call <- function(expressions) {
 }
 
 #' Parse a srcref
+#' @method parse.ref srcref
 #' @param ref the srcref to be parsed
+#' @param \dots ignored
 #' @return List containing the parsed srcref
 parse.ref.srcref <- function(ref, ...) {
   srcfile <- attributes(ref)$srcfile

---FILE: pkg/R/roclet.R---
@@ -5,11 +5,11 @@ roxygen()
 #' Abstract roclet that serves as a rudimentary API.
 #'
 #' Contains the following member functions:
-#' \item{register.parser}{takes \code{key} and \code{parser}}
+#' \itemize{\item{register.parser}{takes \code{key} and \code{parser}}
 #' \item{register.parsers}{takes \code{parser} and \code{keys}}
 #' \item{register.default.parser}{takes a \code{key}}
 #' \item{register.default.parsers}{take \code{parsers}}
-#' \item{parse}{parses material contained in files}
+#' \item{parse}{parses material contained in files}}
 #'
 #' @param parse.default the default parser taking \code{key}
 #' and \code{value}
@@ -107,4 +107,3 @@ assign.parent <- function(var, value, env)
 #' @return The first non-null argument
 first.non.null <- function(...)
   append(NULL, c(...))[[1]]
-

---FILE: pkg/R/roxygenize.R---
@@ -1,17 +1,38 @@
 #' @include Rd.R
 #' @include namespace.R
 #' @include collate.R
+roxygen()
+
+#' Whither to copy package
 ROXYGEN.DIR <- '%s.roxygen'
+
+#' Whither to copy Rds
 MAN.DIR <- 'man'
+
+#' Whence to copy source code
 R.DIR <- 'R'
 
-roxygenize <- function(package.dir) {
+#' Process a package with the Rd, namespace and collate roclets.
+#' @param package.dir the package's top directory
+#' @param copy.package if R.utils is present, copies the package
+#' over before adding/manipulating files.
+#' @return \code{NULL}
+roxygenize <- function(package.dir,
+                       copy.package=TRUE) {
   roxygen.dir <- sprintf(ROXYGEN.DIR, package.dir)
   man.dir <- file.path(roxygen.dir, MAN.DIR)
   skeleton <- c(roxygen.dir, man.dir)
-  for (dir in skeleton) dir.create(dir, showWarnings=F)
+
+###   if (copy.package) {
+###     if (require('R.utils', quietly=T))
+###       copyDirectory(package.dir, roxygen.dir, overwrite=TRUE)
+###     else
+###       warning('`R.utils\' package not present; not copying package.')
+###   }
+
+  for (dir in skeleton) dir.create(dir, showWarnings=FALSE)
   r.dir <- file.path(package.dir, R.DIR)
-  source.files <- list.files(r.dir, recursive=T, full.names=T)
+  source.files <- list.files(r.dir, recursive=TRUE, full.names=TRUE)
   Rd <- make.Rd.roclet(man.dir)
   do.call(Rd$parse, as.list(source.files))
 }

---FILE: pkg/R/string.R---
@@ -1,7 +1,14 @@
 #' @include functional.R
 #' @include list.R
+NULL
+
+#' Absense of words
 SPACE <- '[[:space:]]+'
+
+#' Anti-anti-words
 MATTER <- '[^[:space:]]+'
+
+#' Analogue to the empty list
 NIL.STRING <- ''
 
 #' Trim [:space:] to the left of a string.

---FILE: pkg/README---
@@ -31,8 +31,20 @@ To test the Rd, namespace and collate roclets: there are similarly
 
 1.2. TODO
 
-Create a driver (possibly used by `R CMD roxygen') which farms out the
-results of each roclet to appropriate files in a package skeleton.
+* Create a driver (possibly used by `R CMD roxygen') which farms out
+  the results of each roclet to appropriate files in a package
+  skeleton.
+
+1.3. BUGS
+
+* parse.formals doesn't distinguish between no default argument and
+  NULL; need a special value?
+
+* Skeletal Rds are created for assignments without Roxygen-blocks;
+  desirable?
+
+* first.sentence is fooled by infix periods, whereupon it resorts to
+  \dots.
 
 -----------
 * Hail, Hephaistos! Grant skill and weal.

---FILE: pkg/sandbox/Rd.R---
@@ -13,4 +13,6 @@ argc <- length(argv)
 files <- if (argc > 0) as.list(argv) else FILES
 
 roclet <- make.Rd.roclet()
-do.call(roclet$parse, files)
+## do.call(roclet$parse, files)
+roclet$parse.parsed(parse.text(""#' Is a number odd?
+                   a <- 2""))

---FILE: pkg/tests/runit/runit.Rd.R---
@@ -33,29 +33,39 @@ test.naked.roxygen <- function()
 
 test.name.from.assignment <- function()
   check.Rd.output('a <- 2',
-                  output='\\name{a}')
+                  output=c('\\title{a}',
+                    '\\name{a}',
+                    '\\alias{a}'))
 
 test.name.overriding.assignment <- function()
   check.Rd.output(""#' @name b
                    a <- 2"",
-                  output='\\name{b}')
+                  output=c('\\title{b}',
+                    '\\name{b}',
+                    '\\alias{b}'))
 
 test.implicit.usage.from.formals <- function()
   check.Rd.output(""a <- function(a=1) {}"",
-                  output=c(""\\name{a}"",
+                  output=c(""\\title{a}"",
+                    ""\\name{a}"",
+                    ""\\alias{a}"",
                     ""\\usage{a(a=1)}""))
 
 test.explicit.usage <- function()
   check.Rd.output(""#' @usage a(a=2)
                    a <- function(a=1) {}"",
-                  output=c(""\\name{a}"",
+                  output=c(""\\title{a}"",
+                    ""\\name{a}"",
+                    ""\\alias{a}"",
                     ""\\usage{a(a=2)}""))
 
 test.params <- function()
   check.Rd.output(""#' @param a an incipit letter
                    #' @param z a terminal letter
                    a <- function(a=1, z=2) {}"",
-                  output=c(""\\name{a}"",
+                  output=c(""\\title{a}"",
+                    ""\\name{a}"",
+                    ""\\alias{a}"",
                     ""\\usage{a(a=1, z=2)}"",
                     ""\\arguments{\\item{a}{an incipit letter}"",
                     ""\\item{z}{a terminal letter}}""))
@@ -96,3 +106,30 @@ test.generic.keys <- function()
                     ""\\author{test}"",
                     ""\\seealso{test}"",
                     ""\\concept{test}""))
+
+test.title.from.description <- function()
+  check.Rd.output(""#' Description with sentence. That continueth.
+                   a <- 2"",
+                  output=c(""\\title{Description with sentence}"",
+                    ""\\name{a}"",
+                    ""\\alias{a}"",
+                    paste(""\\description{Description with sentence."",
+                          ""That continueth.}"")))
+
+test.question.mark.end.of.sentence <- function()
+  check.Rd.output(""#' Is a number odd?
+                   is.odd <- function(a) {}"",
+                  output=c('\\title{Is a number odd?}',
+                    '\\name{is.odd}',
+                    '\\alias{is.odd}',
+                    '\\usage{is.odd(a)}',
+                    '\\description{Is a number odd?}'))
+
+test.ellipsis.on.no.period <- function()
+  check.Rd.output(""#' Whether a number is odd
+                   is.odd <- function(a) {}"",
+                  output=c('\\title{Whether a number is odd\dots}',
+                    '\\name{is.odd}',
+                    '\\alias{is.odd}',
+                    '\\usage{is.odd(a)}',
+                    '\\description{Whether a number is odd}'))"
r-lib,roxygen2,5ff4a2d81becbb9805e6cd1c74986300171c9232,Peter Danenberg,pcd@roxygen.org,2008-07-21T02:35:33Z,Peter Danenberg,pcd@roxygen.org,2008-07-21T02:35:33Z,"fix abweichende roxygen-Rd relationships; tests


git-svn-id: svn://svn.r-forge.r-project.org/svnroot/roxygen/pkg@69 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",R/Rd.R;tests/Rd.R;tests/collate/belt.R;tests/collate/jacket.R;tests/collate/pants.R;tests/collate/shirt.R;tests/collate/shoes.R;tests/collate/socks.R;tests/collate/tie.R;tests/collate/undershorts.R;tests/collate/watch.R;tests/main.R;tests/namespace.R;tests/tests.R,False,True,True,False,124,4,128,"---FILE: R/Rd.R---
@@ -25,14 +25,17 @@ make.Rd.roclet <- function() {
   roclet$register.default.parsers('name',
                                   'title',
                                   'usage',
-                                  'value',
                                   'references',
                                   'note',
                                   'author',
                                   'seealso',
                                   'examples',
                                   'concept')
 
+  roclet$register.parser('return',
+                         function(key, expressions)
+                         parse.expression('value', expressions))
+
   parse.split <- function(key, expressions) {
     expression <- strcar(expressions)
     rest <- strcdr(expressions)
@@ -41,9 +44,13 @@ make.Rd.roclet <- function() {
       parse.split(key, rest)
   }
 
-  roclet$register.parsers(parse.split,
-                          'keyword',
-                          'alias')
+  roclet$register.parser('aliases',
+                         function(key, expressions)
+                         parse.split('alias', expressions))
+
+  roclet$register.parser('keywords',
+                         function(key, expressions)
+                         parse.split('keyword', expressions))
 
   parse.description <- function(key, expressions) {
     paragraphs <- car(strsplit(car(expressions), '\n\n', fixed=T))

---FILE: tests/Rd.R---
@@ -0,0 +1,19 @@
+#' description
+#'
+#' details
+#' @name test
+#' @title test
+#' @usage test
+#' @return test
+#' @references test
+#' @note test
+#' @author test@@example.com
+#' @seealso test
+#' @examples test
+#' @concept test
+#' @keywords test1 test2
+#' @aliases test1 test2
+#' @param p1 first param
+#' @param p2 second param
+#' @param p3 third param
+roxygen()

---FILE: tests/collate/belt.R---
@@ -0,0 +1,3 @@
+#' @include collate/pants.R
+#' @include collate/shirt.R
+roxygen()

---FILE: tests/collate/jacket.R---
@@ -0,0 +1,3 @@
+#' @include collate/tie.R
+#' @include collate/belt.R
+roxygen()

---FILE: tests/collate/pants.R---
@@ -0,0 +1,2 @@
+#' @include collate/undershorts.R
+roxygen()

---FILE: tests/collate/shirt.R---
@@ -0,0 +1 @@
+roxygen()

---FILE: tests/collate/shoes.R---
@@ -0,0 +1,4 @@
+#' @include collate/socks.R
+#' @include collate/undershorts.R
+#' @include collate/pants.R
+roxygen()

---FILE: tests/collate/socks.R---
@@ -0,0 +1 @@
+roxygen()

---FILE: tests/collate/tie.R---
@@ -0,0 +1,2 @@
+#' @include collate/shirt.R
+roxygen()

---FILE: tests/collate/undershorts.R---
@@ -0,0 +1 @@
+roxygen()

---FILE: tests/collate/watch.R---
@@ -0,0 +1 @@
+roxygen()

---FILE: tests/main.R---
@@ -0,0 +1,12 @@
+library(RUnit)
+
+source('../R/functional.R')
+source('../R/list.R')
+source('../R/string.R')
+source('../R/parse.R')
+source('../R/roclet.R')
+source('../R/collate.R')
+source('../R/namespace.R')
+source('../R/Rd.R')
+
+runTestFile('tests.R')

---FILE: tests/namespace.R---
@@ -0,0 +1,10 @@
+#' @exportClass test
+#' @exportMethod  test
+#' @export test
+#' @exportPattern test
+#' @S3method test
+#' @import test
+#' @importFrom test
+#' @importClassesFrom test
+#' @importMethodsFrom test
+roxygen()

---FILE: tests/tests.R---
@@ -0,0 +1,54 @@
+test.namespace <- function() {
+  roclet <- make.namespace.roclet()
+  checkEquals(capture.output(roclet$parse('namespace.R')),
+              c('exportClasses(test)',
+                'exportMethods(test)',
+                'export(test)',
+                'exportPattern(test)',
+                'S3method(test)',
+                'import(test)',
+                'importFrom(test)',
+                'importClassesFrom(test)',
+                'importMethodsFrom(test)'))
+}
+
+test.Rd <- function() {
+  roclet <- make.Rd.roclet()
+  checkEquals(capture.output(roclet$parse('Rd.R')),
+              c('\\description{description}',
+                '\\details{details}',
+                '\\name{test}',
+                '\\title{test}',
+                '\\usage{test}',
+                '\\value{test}',
+                '\\references{test}',
+                '\\note{test}',
+                '\\author{test@example.com}',
+                '\\seealso{test}',
+                '\\examples{test}',
+                '\\concept{test}',
+                '\\keyword{test1}',
+                '\\keyword{test2}',
+                '\\alias{test1}',
+                '\\alias{test2}',
+                '\\arguments{\\item{p1}{first param}',
+                '\\item{p2}{second param}',
+                '\\item{p3}{third param}}'))
+}
+
+test.collate <- function() {
+  roclet <- make.collate.roclet()
+  checkEquals(capture.output(roclet$parse('collate/belt.R',
+                                          'collate/jacket.R',
+                                          'collate/pants.R',
+                                          'collate/shirt.R',
+                                          'collate/shoes.R',
+                                          'collate/socks.R',
+                                          'collate/tie.R',
+                                          'collate/undershorts.R',
+                                          'collate/watch.R')),
+              paste('collate collate/undershorts.R collate/pants.R',
+                    'collate/belt.R collate/shirt.R collate/tie.R',
+                    'collate/jacket.R collate/socks.R collate/shoes.R',
+                    'collate/watch.R'))
+}"
r-lib,roxygen2,1bffef10008196512b8ac69831aa2369a5bb5377,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-07-21T02:35:33Z,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-07-21T02:35:33Z,"fix abweichende roxygen-Rd relationships; tests


git-svn-id: svn://svn.r-forge.r-project.org/svnroot/roxygen/pkg@69 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",R/Rd.R;tests/Rd.R;tests/collate/belt.R;tests/collate/jacket.R;tests/collate/pants.R;tests/collate/shirt.R;tests/collate/shoes.R;tests/collate/socks.R;tests/collate/tie.R;tests/collate/undershorts.R;tests/collate/watch.R;tests/main.R;tests/namespace.R;tests/tests.R,False,True,True,False,124,4,128,"---FILE: R/Rd.R---
@@ -25,14 +25,17 @@ make.Rd.roclet <- function() {
   roclet$register.default.parsers('name',
                                   'title',
                                   'usage',
-                                  'value',
                                   'references',
                                   'note',
                                   'author',
                                   'seealso',
                                   'examples',
                                   'concept')
 
+  roclet$register.parser('return',
+                         function(key, expressions)
+                         parse.expression('value', expressions))
+
   parse.split <- function(key, expressions) {
     expression <- strcar(expressions)
     rest <- strcdr(expressions)
@@ -41,9 +44,13 @@ make.Rd.roclet <- function() {
       parse.split(key, rest)
   }
 
-  roclet$register.parsers(parse.split,
-                          'keyword',
-                          'alias')
+  roclet$register.parser('aliases',
+                         function(key, expressions)
+                         parse.split('alias', expressions))
+
+  roclet$register.parser('keywords',
+                         function(key, expressions)
+                         parse.split('keyword', expressions))
 
   parse.description <- function(key, expressions) {
     paragraphs <- car(strsplit(car(expressions), '\n\n', fixed=T))

---FILE: tests/Rd.R---
@@ -0,0 +1,19 @@
+#' description
+#'
+#' details
+#' @name test
+#' @title test
+#' @usage test
+#' @return test
+#' @references test
+#' @note test
+#' @author test@@example.com
+#' @seealso test
+#' @examples test
+#' @concept test
+#' @keywords test1 test2
+#' @aliases test1 test2
+#' @param p1 first param
+#' @param p2 second param
+#' @param p3 third param
+roxygen()

---FILE: tests/collate/belt.R---
@@ -0,0 +1,3 @@
+#' @include collate/pants.R
+#' @include collate/shirt.R
+roxygen()

---FILE: tests/collate/jacket.R---
@@ -0,0 +1,3 @@
+#' @include collate/tie.R
+#' @include collate/belt.R
+roxygen()

---FILE: tests/collate/pants.R---
@@ -0,0 +1,2 @@
+#' @include collate/undershorts.R
+roxygen()

---FILE: tests/collate/shirt.R---
@@ -0,0 +1 @@
+roxygen()

---FILE: tests/collate/shoes.R---
@@ -0,0 +1,4 @@
+#' @include collate/socks.R
+#' @include collate/undershorts.R
+#' @include collate/pants.R
+roxygen()

---FILE: tests/collate/socks.R---
@@ -0,0 +1 @@
+roxygen()

---FILE: tests/collate/tie.R---
@@ -0,0 +1,2 @@
+#' @include collate/shirt.R
+roxygen()

---FILE: tests/collate/undershorts.R---
@@ -0,0 +1 @@
+roxygen()

---FILE: tests/collate/watch.R---
@@ -0,0 +1 @@
+roxygen()

---FILE: tests/main.R---
@@ -0,0 +1,12 @@
+library(RUnit)
+
+source('../R/functional.R')
+source('../R/list.R')
+source('../R/string.R')
+source('../R/parse.R')
+source('../R/roclet.R')
+source('../R/collate.R')
+source('../R/namespace.R')
+source('../R/Rd.R')
+
+runTestFile('tests.R')

---FILE: tests/namespace.R---
@@ -0,0 +1,10 @@
+#' @exportClass test
+#' @exportMethod  test
+#' @export test
+#' @exportPattern test
+#' @S3method test
+#' @import test
+#' @importFrom test
+#' @importClassesFrom test
+#' @importMethodsFrom test
+roxygen()

---FILE: tests/tests.R---
@@ -0,0 +1,54 @@
+test.namespace <- function() {
+  roclet <- make.namespace.roclet()
+  checkEquals(capture.output(roclet$parse('namespace.R')),
+              c('exportClasses(test)',
+                'exportMethods(test)',
+                'export(test)',
+                'exportPattern(test)',
+                'S3method(test)',
+                'import(test)',
+                'importFrom(test)',
+                'importClassesFrom(test)',
+                'importMethodsFrom(test)'))
+}
+
+test.Rd <- function() {
+  roclet <- make.Rd.roclet()
+  checkEquals(capture.output(roclet$parse('Rd.R')),
+              c('\\description{description}',
+                '\\details{details}',
+                '\\name{test}',
+                '\\title{test}',
+                '\\usage{test}',
+                '\\value{test}',
+                '\\references{test}',
+                '\\note{test}',
+                '\\author{test@example.com}',
+                '\\seealso{test}',
+                '\\examples{test}',
+                '\\concept{test}',
+                '\\keyword{test1}',
+                '\\keyword{test2}',
+                '\\alias{test1}',
+                '\\alias{test2}',
+                '\\arguments{\\item{p1}{first param}',
+                '\\item{p2}{second param}',
+                '\\item{p3}{third param}}'))
+}
+
+test.collate <- function() {
+  roclet <- make.collate.roclet()
+  checkEquals(capture.output(roclet$parse('collate/belt.R',
+                                          'collate/jacket.R',
+                                          'collate/pants.R',
+                                          'collate/shirt.R',
+                                          'collate/shoes.R',
+                                          'collate/socks.R',
+                                          'collate/tie.R',
+                                          'collate/undershorts.R',
+                                          'collate/watch.R')),
+              paste('collate collate/undershorts.R collate/pants.R',
+                    'collate/belt.R collate/shirt.R collate/tie.R',
+                    'collate/jacket.R collate/socks.R collate/shoes.R',
+                    'collate/watch.R'))
+}"
r-lib,roxygen2,0afd37783e9bb33a141d1f609b1452638b1d7157,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-07-21T02:35:33Z,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-07-21T02:35:33Z,"fix abweichende roxygen-Rd relationships; tests


git-svn-id: svn+ssh://svn.r-forge.r-project.org/svnroot/roxygen@69 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",pkg/R/Rd.R;pkg/tests/Rd.R;pkg/tests/collate/belt.R;pkg/tests/collate/jacket.R;pkg/tests/collate/pants.R;pkg/tests/collate/shirt.R;pkg/tests/collate/shoes.R;pkg/tests/collate/socks.R;pkg/tests/collate/tie.R;pkg/tests/collate/undershorts.R;pkg/tests/collate/watch.R;pkg/tests/main.R;pkg/tests/namespace.R;pkg/tests/tests.R,False,True,True,False,124,4,128,"---FILE: pkg/R/Rd.R---
@@ -25,14 +25,17 @@ make.Rd.roclet <- function() {
   roclet$register.default.parsers('name',
                                   'title',
                                   'usage',
-                                  'value',
                                   'references',
                                   'note',
                                   'author',
                                   'seealso',
                                   'examples',
                                   'concept')
 
+  roclet$register.parser('return',
+                         function(key, expressions)
+                         parse.expression('value', expressions))
+
   parse.split <- function(key, expressions) {
     expression <- strcar(expressions)
     rest <- strcdr(expressions)
@@ -41,9 +44,13 @@ make.Rd.roclet <- function() {
       parse.split(key, rest)
   }
 
-  roclet$register.parsers(parse.split,
-                          'keyword',
-                          'alias')
+  roclet$register.parser('aliases',
+                         function(key, expressions)
+                         parse.split('alias', expressions))
+
+  roclet$register.parser('keywords',
+                         function(key, expressions)
+                         parse.split('keyword', expressions))
 
   parse.description <- function(key, expressions) {
     paragraphs <- car(strsplit(car(expressions), '\n\n', fixed=T))

---FILE: pkg/tests/Rd.R---
@@ -0,0 +1,19 @@
+#' description
+#'
+#' details
+#' @name test
+#' @title test
+#' @usage test
+#' @return test
+#' @references test
+#' @note test
+#' @author test@@example.com
+#' @seealso test
+#' @examples test
+#' @concept test
+#' @keywords test1 test2
+#' @aliases test1 test2
+#' @param p1 first param
+#' @param p2 second param
+#' @param p3 third param
+roxygen()

---FILE: pkg/tests/collate/belt.R---
@@ -0,0 +1,3 @@
+#' @include collate/pants.R
+#' @include collate/shirt.R
+roxygen()

---FILE: pkg/tests/collate/jacket.R---
@@ -0,0 +1,3 @@
+#' @include collate/tie.R
+#' @include collate/belt.R
+roxygen()

---FILE: pkg/tests/collate/pants.R---
@@ -0,0 +1,2 @@
+#' @include collate/undershorts.R
+roxygen()

---FILE: pkg/tests/collate/shirt.R---
@@ -0,0 +1 @@
+roxygen()

---FILE: pkg/tests/collate/shoes.R---
@@ -0,0 +1,4 @@
+#' @include collate/socks.R
+#' @include collate/undershorts.R
+#' @include collate/pants.R
+roxygen()

---FILE: pkg/tests/collate/socks.R---
@@ -0,0 +1 @@
+roxygen()

---FILE: pkg/tests/collate/tie.R---
@@ -0,0 +1,2 @@
+#' @include collate/shirt.R
+roxygen()

---FILE: pkg/tests/collate/undershorts.R---
@@ -0,0 +1 @@
+roxygen()

---FILE: pkg/tests/collate/watch.R---
@@ -0,0 +1 @@
+roxygen()

---FILE: pkg/tests/main.R---
@@ -0,0 +1,12 @@
+library(RUnit)
+
+source('../R/functional.R')
+source('../R/list.R')
+source('../R/string.R')
+source('../R/parse.R')
+source('../R/roclet.R')
+source('../R/collate.R')
+source('../R/namespace.R')
+source('../R/Rd.R')
+
+runTestFile('tests.R')

---FILE: pkg/tests/namespace.R---
@@ -0,0 +1,10 @@
+#' @exportClass test
+#' @exportMethod  test
+#' @export test
+#' @exportPattern test
+#' @S3method test
+#' @import test
+#' @importFrom test
+#' @importClassesFrom test
+#' @importMethodsFrom test
+roxygen()

---FILE: pkg/tests/tests.R---
@@ -0,0 +1,54 @@
+test.namespace <- function() {
+  roclet <- make.namespace.roclet()
+  checkEquals(capture.output(roclet$parse('namespace.R')),
+              c('exportClasses(test)',
+                'exportMethods(test)',
+                'export(test)',
+                'exportPattern(test)',
+                'S3method(test)',
+                'import(test)',
+                'importFrom(test)',
+                'importClassesFrom(test)',
+                'importMethodsFrom(test)'))
+}
+
+test.Rd <- function() {
+  roclet <- make.Rd.roclet()
+  checkEquals(capture.output(roclet$parse('Rd.R')),
+              c('\\description{description}',
+                '\\details{details}',
+                '\\name{test}',
+                '\\title{test}',
+                '\\usage{test}',
+                '\\value{test}',
+                '\\references{test}',
+                '\\note{test}',
+                '\\author{test@example.com}',
+                '\\seealso{test}',
+                '\\examples{test}',
+                '\\concept{test}',
+                '\\keyword{test1}',
+                '\\keyword{test2}',
+                '\\alias{test1}',
+                '\\alias{test2}',
+                '\\arguments{\\item{p1}{first param}',
+                '\\item{p2}{second param}',
+                '\\item{p3}{third param}}'))
+}
+
+test.collate <- function() {
+  roclet <- make.collate.roclet()
+  checkEquals(capture.output(roclet$parse('collate/belt.R',
+                                          'collate/jacket.R',
+                                          'collate/pants.R',
+                                          'collate/shirt.R',
+                                          'collate/shoes.R',
+                                          'collate/socks.R',
+                                          'collate/tie.R',
+                                          'collate/undershorts.R',
+                                          'collate/watch.R')),
+              paste('collate collate/undershorts.R collate/pants.R',
+                    'collate/belt.R collate/shirt.R collate/tie.R',
+                    'collate/jacket.R collate/socks.R collate/shoes.R',
+                    'collate/watch.R'))
+}"
r-lib,roxygen2,84856466d26fbbffe51a55ca7a794aa6547c96a2,Peter Danenberg,pcd@roxygen.org,2008-06-18T23:23:11Z,Peter Danenberg,pcd@roxygen.org,2008-06-18T23:23:11Z,"S3class; warning; fix value


git-svn-id: svn://svn.r-forge.r-project.org/svnroot/roxygen/pkg@40 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",R/parse.R,False,True,True,False,23,9,32,"---FILE: R/parse.R---
@@ -31,8 +31,14 @@ prerefs <- function(srcfile, srcrefs) {
 
 ## preref parsers
 
+parse.message <- function(key, message)
+  sprintf('@%s %s.', key, message)
+
 parse.error <- function(key, message)
-  stop(sprintf('@%s %s.', key, message))
+  stop(parse.message(key, message))
+
+parse.warning <- function(key, message)
+  warning(parse.message(key, message))
 
 parse.preref <- function(...) {
   list(unknown=paste(...))
@@ -55,14 +61,16 @@ args.to.string <- function(...)
 parse.default <- function(key, ...)
   as.list(structure(args.to.string(...), names=key))
 
-## Possibly NA, for which the Roclets can do something more
+## Possibly NA; in which case, the Roclets can do something more
 ## sophisticated with the srcref.
 parse.export <- Curry(parse.default, key='export')
 
-parse.value <- function(key, ...)
-  ifelse(is.empty(...),
-         parse.error(key, 'requires a value'),
-         parse.default(key, ...))
+parse.value <- function(key, ...) {
+  if (is.empty(...))
+    parse.error(key, 'requires a value')
+  else
+    parse.default(key, ...)
+}
   
 parse.prototype <- Curry(parse.value, key='prototype')
 
@@ -96,9 +104,15 @@ parse.slot <- Curry(parse.name.description, key='slot')
 
 parse.param <- Curry(parse.name.description, key='param')
 
-## For S3 classes; single name only, and glean description from top
-## line of block?
-parse.class <- Curry(parse.name.description, key='class')
+parse.name <- function(key, name, ...) {
+  if (is.na(name))
+    parse.error(key, 'requires a name')
+  else if (Negate(is.empty)(...))
+    parse.warning(key, 'discards extra-nominal entries')
+  parse.default(key, name)
+}
+
+parse.S3class <- Curry(parse.name, key='S3class')
 
 parse.toggle <- function(key, ...)
   as.list(structure(T, names=key))"
r-lib,roxygen2,bcfff0317d0bce39f403c428fcfcd4d8b1dcd68d,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-06-18T23:23:11Z,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-06-18T23:23:11Z,"S3class; warning; fix value


git-svn-id: svn://svn.r-forge.r-project.org/svnroot/roxygen/pkg@40 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",R/parse.R,False,True,True,False,23,9,32,"---FILE: R/parse.R---
@@ -31,8 +31,14 @@ prerefs <- function(srcfile, srcrefs) {
 
 ## preref parsers
 
+parse.message <- function(key, message)
+  sprintf('@%s %s.', key, message)
+
 parse.error <- function(key, message)
-  stop(sprintf('@%s %s.', key, message))
+  stop(parse.message(key, message))
+
+parse.warning <- function(key, message)
+  warning(parse.message(key, message))
 
 parse.preref <- function(...) {
   list(unknown=paste(...))
@@ -55,14 +61,16 @@ args.to.string <- function(...)
 parse.default <- function(key, ...)
   as.list(structure(args.to.string(...), names=key))
 
-## Possibly NA, for which the Roclets can do something more
+## Possibly NA; in which case, the Roclets can do something more
 ## sophisticated with the srcref.
 parse.export <- Curry(parse.default, key='export')
 
-parse.value <- function(key, ...)
-  ifelse(is.empty(...),
-         parse.error(key, 'requires a value'),
-         parse.default(key, ...))
+parse.value <- function(key, ...) {
+  if (is.empty(...))
+    parse.error(key, 'requires a value')
+  else
+    parse.default(key, ...)
+}
   
 parse.prototype <- Curry(parse.value, key='prototype')
 
@@ -96,9 +104,15 @@ parse.slot <- Curry(parse.name.description, key='slot')
 
 parse.param <- Curry(parse.name.description, key='param')
 
-## For S3 classes; single name only, and glean description from top
-## line of block?
-parse.class <- Curry(parse.name.description, key='class')
+parse.name <- function(key, name, ...) {
+  if (is.na(name))
+    parse.error(key, 'requires a name')
+  else if (Negate(is.empty)(...))
+    parse.warning(key, 'discards extra-nominal entries')
+  parse.default(key, name)
+}
+
+parse.S3class <- Curry(parse.name, key='S3class')
 
 parse.toggle <- function(key, ...)
   as.list(structure(T, names=key))"
r-lib,roxygen2,65c5cfb43ffdcadf93b9b6c8397e70faf2e335a3,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-06-18T23:23:11Z,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-06-18T23:23:11Z,"S3class; warning; fix value


git-svn-id: svn+ssh://svn.r-forge.r-project.org/svnroot/roxygen@40 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",pkg/R/parse.R,False,True,True,False,23,9,32,"---FILE: pkg/R/parse.R---
@@ -31,8 +31,14 @@ prerefs <- function(srcfile, srcrefs) {
 
 ## preref parsers
 
+parse.message <- function(key, message)
+  sprintf('@%s %s.', key, message)
+
 parse.error <- function(key, message)
-  stop(sprintf('@%s %s.', key, message))
+  stop(parse.message(key, message))
+
+parse.warning <- function(key, message)
+  warning(parse.message(key, message))
 
 parse.preref <- function(...) {
   list(unknown=paste(...))
@@ -55,14 +61,16 @@ args.to.string <- function(...)
 parse.default <- function(key, ...)
   as.list(structure(args.to.string(...), names=key))
 
-## Possibly NA, for which the Roclets can do something more
+## Possibly NA; in which case, the Roclets can do something more
 ## sophisticated with the srcref.
 parse.export <- Curry(parse.default, key='export')
 
-parse.value <- function(key, ...)
-  ifelse(is.empty(...),
-         parse.error(key, 'requires a value'),
-         parse.default(key, ...))
+parse.value <- function(key, ...) {
+  if (is.empty(...))
+    parse.error(key, 'requires a value')
+  else
+    parse.default(key, ...)
+}
   
 parse.prototype <- Curry(parse.value, key='prototype')
 
@@ -96,9 +104,15 @@ parse.slot <- Curry(parse.name.description, key='slot')
 
 parse.param <- Curry(parse.name.description, key='param')
 
-## For S3 classes; single name only, and glean description from top
-## line of block?
-parse.class <- Curry(parse.name.description, key='class')
+parse.name <- function(key, name, ...) {
+  if (is.na(name))
+    parse.error(key, 'requires a name')
+  else if (Negate(is.empty)(...))
+    parse.warning(key, 'discards extra-nominal entries')
+  parse.default(key, name)
+}
+
+parse.S3class <- Curry(parse.name, key='S3class')
 
 parse.toggle <- function(key, ...)
   as.list(structure(T, names=key))"
r-lib,roxygen2,bea47bb02519801d51540e4f1bed04133e81494b,Peter Danenberg,pcd@roxygen.org,2008-06-18T11:20:40Z,Peter Danenberg,pcd@roxygen.org,2008-06-18T11:20:40Z,"fix name.description; class keyword for S3 classes; togglers for listObject, etc.


git-svn-id: svn://svn.r-forge.r-project.org/svnroot/roxygen/pkg@38 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",R/parse.R,False,True,True,False,22,7,29,"---FILE: R/parse.R---
@@ -85,18 +85,33 @@ parse.importClassesFrom <- Curry(parse.value, key='importClassesFrom')
 
 parse.importMethodsFrom <- Curry(parse.value, key='importMethodsFrom')
 
-parse.name.description <- function(key, name, ...)
-  ifelse(any(is.na(name),
-             is.empty(...)),
-         parse.error(key, 'requires a name and description'),
-         as.list(structure(list(list(name=name,
-                                     description=args.to.string(...))),
-                           names=key)))
+parse.name.description <- function(key, name, ...) {
+  if (any(is.na(name),
+          is.empty(...)))
+    parse.error(key, 'requires a name and description')
+  else
+    as.list(structure(list(list(name=name,
+                                description=args.to.string(...))),
+                      names=key))
+}
 
 parse.slot <- Curry(parse.name.description, key='slot')
 
 parse.param <- Curry(parse.name.description, key='param')
 
+## For S3 classes; single name only, and glean description from top
+## line of block?
+parse.class <- Curry(parse.name.description, key='class')
+
+parse.toggle <- function(key, ...)
+  as.list(structure(T, names=key))
+
+parse.listObject <- Curry(parse.toggle, key='listObject')
+
+parse.attributeObject <- Curry(parse.toggle, key='attributeObject')
+
+parse.environmentObject <- Curry(parse.toggle, key='environmentObject')
+
 ## srcref parsers
 
 parse.srcref <- function(...) nil"
r-lib,roxygen2,b98c5769cc5eeebcabae1d5c34104d37152151b9,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-06-18T11:20:40Z,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-06-18T11:20:40Z,"fix name.description; class keyword for S3 classes; togglers for listObject, etc.


git-svn-id: svn://svn.r-forge.r-project.org/svnroot/roxygen/pkg@38 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",R/parse.R,False,True,True,False,22,7,29,"---FILE: R/parse.R---
@@ -85,18 +85,33 @@ parse.importClassesFrom <- Curry(parse.value, key='importClassesFrom')
 
 parse.importMethodsFrom <- Curry(parse.value, key='importMethodsFrom')
 
-parse.name.description <- function(key, name, ...)
-  ifelse(any(is.na(name),
-             is.empty(...)),
-         parse.error(key, 'requires a name and description'),
-         as.list(structure(list(list(name=name,
-                                     description=args.to.string(...))),
-                           names=key)))
+parse.name.description <- function(key, name, ...) {
+  if (any(is.na(name),
+          is.empty(...)))
+    parse.error(key, 'requires a name and description')
+  else
+    as.list(structure(list(list(name=name,
+                                description=args.to.string(...))),
+                      names=key))
+}
 
 parse.slot <- Curry(parse.name.description, key='slot')
 
 parse.param <- Curry(parse.name.description, key='param')
 
+## For S3 classes; single name only, and glean description from top
+## line of block?
+parse.class <- Curry(parse.name.description, key='class')
+
+parse.toggle <- function(key, ...)
+  as.list(structure(T, names=key))
+
+parse.listObject <- Curry(parse.toggle, key='listObject')
+
+parse.attributeObject <- Curry(parse.toggle, key='attributeObject')
+
+parse.environmentObject <- Curry(parse.toggle, key='environmentObject')
+
 ## srcref parsers
 
 parse.srcref <- function(...) nil"
r-lib,roxygen2,1191751a82e44f0de597773990bc6a9bca05391f,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-06-18T11:20:40Z,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-06-18T11:20:40Z,"fix name.description; class keyword for S3 classes; togglers for listObject, etc.


git-svn-id: svn+ssh://svn.r-forge.r-project.org/svnroot/roxygen@38 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",pkg/R/parse.R,False,True,True,False,22,7,29,"---FILE: pkg/R/parse.R---
@@ -85,18 +85,33 @@ parse.importClassesFrom <- Curry(parse.value, key='importClassesFrom')
 
 parse.importMethodsFrom <- Curry(parse.value, key='importMethodsFrom')
 
-parse.name.description <- function(key, name, ...)
-  ifelse(any(is.na(name),
-             is.empty(...)),
-         parse.error(key, 'requires a name and description'),
-         as.list(structure(list(list(name=name,
-                                     description=args.to.string(...))),
-                           names=key)))
+parse.name.description <- function(key, name, ...) {
+  if (any(is.na(name),
+          is.empty(...)))
+    parse.error(key, 'requires a name and description')
+  else
+    as.list(structure(list(list(name=name,
+                                description=args.to.string(...))),
+                      names=key))
+}
 
 parse.slot <- Curry(parse.name.description, key='slot')
 
 parse.param <- Curry(parse.name.description, key='param')
 
+## For S3 classes; single name only, and glean description from top
+## line of block?
+parse.class <- Curry(parse.name.description, key='class')
+
+parse.toggle <- function(key, ...)
+  as.list(structure(T, names=key))
+
+parse.listObject <- Curry(parse.toggle, key='listObject')
+
+parse.attributeObject <- Curry(parse.toggle, key='attributeObject')
+
+parse.environmentObject <- Curry(parse.toggle, key='environmentObject')
+
 ## srcref parsers
 
 parse.srcref <- function(...) nil"
r-lib,roxygen2,cb85166296d05e0721d62c59959a51384b97f89e,Peter Danenberg,pcd@roxygen.org,2008-06-18T11:08:14Z,Peter Danenberg,pcd@roxygen.org,2008-06-18T11:08:14Z,"reintroduce Negate; error messages for parse; import/export keywords; param; clean up main


git-svn-id: svn://svn.r-forge.r-project.org/svnroot/roxygen/pkg@37 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",R/functional.R;R/list.R;R/parse.R;sandbox/example.R;sandbox/main.R,False,True,True,False,54,15,69,"---FILE: R/functional.R---
@@ -4,3 +4,7 @@ Curry <- function(FUN,...) {
   .orig = list(...);
   function(...) do.call(FUN,c(.orig,list(...)))
 }
+
+## Borrowed from src/library/base/R/funprog.R for pre-2.7 Rs.
+Negate <- function(f)
+  function(...) ! match.fun(f)(...)

---FILE: R/list.R---
@@ -1,3 +1,5 @@
+source('../R/functional.R')
+
 nil <- list()
 
 is.nil <- function(list)
@@ -36,8 +38,7 @@ is.even <- function(a) {
 }
 
 is.odd <- function(a) {
-  #Negate(is.even)(a)
-  !is.even(a)
+  Negate(is.even)(a)
 }
 
 zip <- function(zipper, ...) {

---FILE: R/parse.R---
@@ -34,6 +34,9 @@ prerefs <- function(srcfile, srcrefs) {
 
 ## preref parsers
 
+parse.error <- function(key, message)
+  stop(sprintf('@%s %s.', key, message))
+
 parse.preref <- function(...) {
   list(unknown=paste(...))
 }
@@ -47,18 +50,52 @@ parse.element <- function(element) {
 parse.description <- function(expression)
   list(description=expression)
 
-parse.prototype <- function(...)
-  list(prototype=paste(...))
+is.empty <- function(...) is.nil(c(...)) || is.na(car(as.list(...)))
+
+args.to.string <- function(...)
+  ifelse(is.empty(...), NA, paste(...))
+
+parse.default <- function(key, ...)
+  as.list(structure(args.to.string(...), names=key))
+
+## Possibly NA, for which the Roclets can do something more
+## sophisticated with the srcref.
+parse.export <- Curry(parse.default, key='export')
+
+parse.value <- function(key, ...)
+  ifelse(is.empty(...),
+         parse.error(key, 'requires a value'),
+         parse.default(key, ...))
+  
+parse.prototype <- Curry(parse.value, key='prototype')
+
+parse.exportClasses <- Curry(parse.value, key='exportClasses')
+
+parse.exportMethods <- Curry(parse.value, key='exportMethods')
+
+parse.exportPattern <- Curry(parse.value, key='exportPattern')
+
+parse.S3method <- Curry(parse.value, key='S3method')
+
+parse.import <- Curry(parse.value, key='import')
+
+parse.importFrom <- Curry(parse.value, key='importFrom')
+
+parse.importClassesFrom <- Curry(parse.value, key='importClassesFrom')
 
-parse.export <- function(...)
-  list(export=T)
+parse.importMethodsFrom <- Curry(parse.value, key='importMethodsFrom')
 
-parse.name.description <- function(name, ...)
-  list(slot=list(name=name, description=paste(...)))
+parse.name.description <- function(key, name, ...)
+  ifelse(any(is.na(name),
+             is.empty(...)),
+         parse.error(key, 'requires a name and description'),
+         as.list(structure(list(list(name=name,
+                                     description=args.to.string(...))),
+                           names=key)))
 
-parse.slot <- parse.name.description
+parse.slot <- Curry(parse.name.description, key='slot')
 
-parse.param <- parse.name.description
+parse.param <- Curry(parse.name.description, key='param')
 
 ## srcref parsers
 

---FILE: sandbox/example.R---
@@ -4,6 +4,7 @@
 #' @slot birthyear The year of birth
 #' @prototype Prototype person is named John Doe
 #'      and born in the year 1971
+#' @export
 setClass('person',
          representation=
          representation(fullname='character',

---FILE: sandbox/main.R---
@@ -7,8 +7,4 @@ argv <- commandArgs(trailingOnly=T)
 argc <- length(argv)
 file <- ifelse(argc > 0, car(argv), FILE)
 
-l <- parse.file(file)
-str(l)
-
-
-l1 <- parse.file('example-S4-person.R')
+str(parse.file(file))"
r-lib,roxygen2,faff6ac05a3d4d87f4a1c5793e68e0f3724197a0,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-06-18T11:08:14Z,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-06-18T11:08:14Z,"reintroduce Negate; error messages for parse; import/export keywords; param; clean up main


git-svn-id: svn://svn.r-forge.r-project.org/svnroot/roxygen/pkg@37 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",R/functional.R;R/list.R;R/parse.R;sandbox/example.R;sandbox/main.R,False,True,True,False,54,15,69,"---FILE: R/functional.R---
@@ -4,3 +4,7 @@ Curry <- function(FUN,...) {
   .orig = list(...);
   function(...) do.call(FUN,c(.orig,list(...)))
 }
+
+## Borrowed from src/library/base/R/funprog.R for pre-2.7 Rs.
+Negate <- function(f)
+  function(...) ! match.fun(f)(...)

---FILE: R/list.R---
@@ -1,3 +1,5 @@
+source('../R/functional.R')
+
 nil <- list()
 
 is.nil <- function(list)
@@ -36,8 +38,7 @@ is.even <- function(a) {
 }
 
 is.odd <- function(a) {
-  #Negate(is.even)(a)
-  !is.even(a)
+  Negate(is.even)(a)
 }
 
 zip <- function(zipper, ...) {

---FILE: R/parse.R---
@@ -34,6 +34,9 @@ prerefs <- function(srcfile, srcrefs) {
 
 ## preref parsers
 
+parse.error <- function(key, message)
+  stop(sprintf('@%s %s.', key, message))
+
 parse.preref <- function(...) {
   list(unknown=paste(...))
 }
@@ -47,18 +50,52 @@ parse.element <- function(element) {
 parse.description <- function(expression)
   list(description=expression)
 
-parse.prototype <- function(...)
-  list(prototype=paste(...))
+is.empty <- function(...) is.nil(c(...)) || is.na(car(as.list(...)))
+
+args.to.string <- function(...)
+  ifelse(is.empty(...), NA, paste(...))
+
+parse.default <- function(key, ...)
+  as.list(structure(args.to.string(...), names=key))
+
+## Possibly NA, for which the Roclets can do something more
+## sophisticated with the srcref.
+parse.export <- Curry(parse.default, key='export')
+
+parse.value <- function(key, ...)
+  ifelse(is.empty(...),
+         parse.error(key, 'requires a value'),
+         parse.default(key, ...))
+  
+parse.prototype <- Curry(parse.value, key='prototype')
+
+parse.exportClasses <- Curry(parse.value, key='exportClasses')
+
+parse.exportMethods <- Curry(parse.value, key='exportMethods')
+
+parse.exportPattern <- Curry(parse.value, key='exportPattern')
+
+parse.S3method <- Curry(parse.value, key='S3method')
+
+parse.import <- Curry(parse.value, key='import')
+
+parse.importFrom <- Curry(parse.value, key='importFrom')
+
+parse.importClassesFrom <- Curry(parse.value, key='importClassesFrom')
 
-parse.export <- function(...)
-  list(export=T)
+parse.importMethodsFrom <- Curry(parse.value, key='importMethodsFrom')
 
-parse.name.description <- function(name, ...)
-  list(slot=list(name=name, description=paste(...)))
+parse.name.description <- function(key, name, ...)
+  ifelse(any(is.na(name),
+             is.empty(...)),
+         parse.error(key, 'requires a name and description'),
+         as.list(structure(list(list(name=name,
+                                     description=args.to.string(...))),
+                           names=key)))
 
-parse.slot <- parse.name.description
+parse.slot <- Curry(parse.name.description, key='slot')
 
-parse.param <- parse.name.description
+parse.param <- Curry(parse.name.description, key='param')
 
 ## srcref parsers
 

---FILE: sandbox/example.R---
@@ -4,6 +4,7 @@
 #' @slot birthyear The year of birth
 #' @prototype Prototype person is named John Doe
 #'      and born in the year 1971
+#' @export
 setClass('person',
          representation=
          representation(fullname='character',

---FILE: sandbox/main.R---
@@ -7,8 +7,4 @@ argv <- commandArgs(trailingOnly=T)
 argc <- length(argv)
 file <- ifelse(argc > 0, car(argv), FILE)
 
-l <- parse.file(file)
-str(l)
-
-
-l1 <- parse.file('example-S4-person.R')
+str(parse.file(file))"
r-lib,roxygen2,2b5e8851f89495ce03c7664a33129c3079524825,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-06-18T11:08:14Z,pcd,pcd@edb9625f-4e0d-4859-8d74-9fd3b1da38cb,2008-06-18T11:08:14Z,"reintroduce Negate; error messages for parse; import/export keywords; param; clean up main


git-svn-id: svn+ssh://svn.r-forge.r-project.org/svnroot/roxygen@37 edb9625f-4e0d-4859-8d74-9fd3b1da38cb",pkg/R/functional.R;pkg/R/list.R;pkg/R/parse.R;pkg/sandbox/example.R;pkg/sandbox/main.R,False,True,True,False,54,15,69,"---FILE: pkg/R/functional.R---
@@ -4,3 +4,7 @@ Curry <- function(FUN,...) {
   .orig = list(...);
   function(...) do.call(FUN,c(.orig,list(...)))
 }
+
+## Borrowed from src/library/base/R/funprog.R for pre-2.7 Rs.
+Negate <- function(f)
+  function(...) ! match.fun(f)(...)

---FILE: pkg/R/list.R---
@@ -1,3 +1,5 @@
+source('../R/functional.R')
+
 nil <- list()
 
 is.nil <- function(list)
@@ -36,8 +38,7 @@ is.even <- function(a) {
 }
 
 is.odd <- function(a) {
-  #Negate(is.even)(a)
-  !is.even(a)
+  Negate(is.even)(a)
 }
 
 zip <- function(zipper, ...) {

---FILE: pkg/R/parse.R---
@@ -34,6 +34,9 @@ prerefs <- function(srcfile, srcrefs) {
 
 ## preref parsers
 
+parse.error <- function(key, message)
+  stop(sprintf('@%s %s.', key, message))
+
 parse.preref <- function(...) {
   list(unknown=paste(...))
 }
@@ -47,18 +50,52 @@ parse.element <- function(element) {
 parse.description <- function(expression)
   list(description=expression)
 
-parse.prototype <- function(...)
-  list(prototype=paste(...))
+is.empty <- function(...) is.nil(c(...)) || is.na(car(as.list(...)))
+
+args.to.string <- function(...)
+  ifelse(is.empty(...), NA, paste(...))
+
+parse.default <- function(key, ...)
+  as.list(structure(args.to.string(...), names=key))
+
+## Possibly NA, for which the Roclets can do something more
+## sophisticated with the srcref.
+parse.export <- Curry(parse.default, key='export')
+
+parse.value <- function(key, ...)
+  ifelse(is.empty(...),
+         parse.error(key, 'requires a value'),
+         parse.default(key, ...))
+  
+parse.prototype <- Curry(parse.value, key='prototype')
+
+parse.exportClasses <- Curry(parse.value, key='exportClasses')
+
+parse.exportMethods <- Curry(parse.value, key='exportMethods')
+
+parse.exportPattern <- Curry(parse.value, key='exportPattern')
+
+parse.S3method <- Curry(parse.value, key='S3method')
+
+parse.import <- Curry(parse.value, key='import')
+
+parse.importFrom <- Curry(parse.value, key='importFrom')
+
+parse.importClassesFrom <- Curry(parse.value, key='importClassesFrom')
 
-parse.export <- function(...)
-  list(export=T)
+parse.importMethodsFrom <- Curry(parse.value, key='importMethodsFrom')
 
-parse.name.description <- function(name, ...)
-  list(slot=list(name=name, description=paste(...)))
+parse.name.description <- function(key, name, ...)
+  ifelse(any(is.na(name),
+             is.empty(...)),
+         parse.error(key, 'requires a name and description'),
+         as.list(structure(list(list(name=name,
+                                     description=args.to.string(...))),
+                           names=key)))
 
-parse.slot <- parse.name.description
+parse.slot <- Curry(parse.name.description, key='slot')
 
-parse.param <- parse.name.description
+parse.param <- Curry(parse.name.description, key='param')
 
 ## srcref parsers
 

---FILE: pkg/sandbox/example.R---
@@ -4,6 +4,7 @@
 #' @slot birthyear The year of birth
 #' @prototype Prototype person is named John Doe
 #'      and born in the year 1971
+#' @export
 setClass('person',
          representation=
          representation(fullname='character',

---FILE: pkg/sandbox/main.R---
@@ -7,8 +7,4 @@ argv <- commandArgs(trailingOnly=T)
 argc <- length(argv)
 file <- ifelse(argc > 0, car(argv), FILE)
 
-l <- parse.file(file)
-str(l)
-
-
-l1 <- parse.file('example-S4-person.R')
+str(parse.file(file))"
